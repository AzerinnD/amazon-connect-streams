!function(){var m=function(){return m.cache.hasOwnProperty(arguments[0])||(m.cache[arguments[0]]=m.parse(arguments[0])),m.format.call(null,m.cache[arguments[0]],arguments)};m.format=function(I,g){for(var C,A,Z,l,b,G,c=1,d=I.length,B=[],W=0;W<d;W++)if("string"===(C=V(I[W])))B.push(I[W]);else if("array"===C){if((l=I[W])[2])for(A=g[c],Z=0;Z<l[2].length;Z++){if(!A.hasOwnProperty(l[2][Z]))throw m('[sprintf] property "%s" does not exist',l[2][Z]);A=A[l[2][Z]]}else A=l[1]?g[l[1]]:g[c++];if(/[^s]/.test(l[8])&&"number"!=V(A))throw m("[sprintf] expecting number but found %s",V(A));switch(l[8]){case"b":A=A.toString(2);break;case"c":A=String.fromCharCode(A);break;case"d":A=parseInt(A,10);break;case"e":A=l[7]?A.toExponential(l[7]):A.toExponential();break;case"f":A=l[7]?parseFloat(A).toFixed(l[7]):parseFloat(A);break;case"o":A=A.toString(8);break;case"s":A=(A=String(A))&&l[7]?A.substring(0,l[7]):A;break;case"u":A>>>=0;break;case"x":A=A.toString(16);break;case"X":A=A.toString(16).toUpperCase()}A=/[def]/.test(l[8])&&l[3]&&0<=A?"+"+A:A,b=l[4]?"0"==l[4]?"0":l[4].charAt(1):" ",G=l[6]-String(A).length,G=l[6]?function(I,g){for(var C=[];0<g;C[--g]=I);return C.join("")}(b,G):"",B.push(l[5]?A+G:G+A)}return B.join("")},m.cache={},m.parse=function(I){for(var g=I,C=[],A=[],Z=0;g;){if(null!==(C=/^[^\x25]+/.exec(g)))A.push(C[0]);else if(null!==(C=/^\x25{2}/.exec(g)))A.push("%");else{if(null===(C=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(g)))throw"[sprintf] huh?";if(C[2]){Z|=1;var l=[],b=C[2],G=[];if(null===(G=/^([a-z_][a-z_\d]*)/i.exec(b)))throw"[sprintf] huh?";for(l.push(G[1]);""!==(b=b.substring(G[0].length));)if(null!==(G=/^\.([a-z_][a-z_\d]*)/i.exec(b)))l.push(G[1]);else{if(null===(G=/^\[(\d+)\]/.exec(b)))throw"[sprintf] huh?";l.push(G[1])}C[2]=l}else Z|=2;if(3===Z)throw"[sprintf] mixing positional and named placeholders is not (yet) supported";A.push(C)}g=g.substring(C[0].length)}return A};function V(I){return Object.prototype.toString.call(I).slice(8,-1).toLowerCase()}this.sprintf=m,this.vsprintf=function(I,g,C){return(C=g.slice(0)).splice(0,0,I),m.apply(null,C)}}(),function(){var c=this;connect=c.connect||{},c.connect=connect,c.lily=connect;var g=navigator.userAgent;connect.sprintf=c.sprintf,connect.vsprintf=c.vsprintf,delete c.sprintf,delete c.vsprintf,connect.HTTP_STATUS_CODES={SUCCESS:200,TOO_MANY_REQUESTS:429,INTERNAL_SERVER_ERROR:500},connect.TRANSPORT_TYPES={CHAT_TOKEN:"chat_token",WEB_SOCKET:"web_socket"},connect.hitch=function(){var g=Array.prototype.slice.call(arguments),C=g.shift(),A=g.shift();return connect.assertNotNull(C,"scope"),connect.assertNotNull(A,"method"),connect.assertTrue(connect.isFunction(A),"method must be a function"),function(){var I=Array.prototype.slice.call(arguments);return A.apply(C,g.concat(I))}},connect.isFunction=function(I){return!!(I&&I.constructor&&I.call&&I.apply)},connect.isArray=function(I){return"[object Array]"===Object.prototype.toString.call(I)},connect.keys=function(I){var g,C=[];for(g in connect.assertNotNull(I,"map"),I)C.push(g);return C},connect.values=function(I){var g,C=[];for(g in connect.assertNotNull(I,"map"),I)C.push(I[g]);return C},connect.entries=function(I){var g,C=[];for(g in I)C.push({key:g,value:I[g]});return C},connect.merge=function(){var I=Array.prototype.slice.call(arguments,0),g={};return I.forEach(function(I){connect.entries(I).forEach(function(I){g[I.key]=I.value})}),g},connect.now=function(){return(new Date).getTime()},connect.find=function(I,g){for(var C=0;C<I.length;C++)if(g(I[C]))return I[C];return null},connect.contains=function(I,g){return I instanceof Array?null!=connect.find(I,function(I){return I===g}):g in I},connect.containsValue=function(I,g){return I instanceof Array?null!=connect.find(I,function(I){return I===g}):null!=connect.find(connect.values(I),function(I){return I===g})},connect.randomId=function(){return connect.sprintf("%s-%s",connect.now(),Math.random().toString(36).slice(2))},connect.makeEnum=function(I){var C={};return I.forEach(function(I){var g=I.replace(/\.?([a-z]+)_?/g,function(I,g){return g.toUpperCase()+"_"}).replace(/_$/,"");C[g]=I}),C},connect.makeNamespacedEnum=function(g,I){var C=connect.makeEnum(I);return connect.keys(C).forEach(function(I){C[I]=connect.sprintf("%s::%s",g,C[I])}),C},connect.isChromeBrowser=function(){return-1!==g.indexOf("Chrome")},connect.isFirefoxBrowser=function(){return-1!==g.indexOf("Firefox")},connect.isOperaBrowser=function(){return-1!==g.indexOf("Opera")},connect.getChromeBrowserVersion=function(){var I=g.substring(g.indexOf("Chrome")+7);return I?parseFloat(I):-1},connect.getFirefoxBrowserVersion=function(){var I=g.substring(g.indexOf("Firefox")+8);return I?parseFloat(I):-1},connect.getOperaBrowserVersion=function(){var I=g.indexOf("Opera"),I=-1!==g.indexOf("Version")?g.substring(I+8):g.substring(I+6);return I?parseFloat(I):-1},connect.index=function(I,g){var C={};return I.forEach(function(I){C[g(I)]=I}),C},connect.set=function(I){var g={};return I.forEach(function(I){g[I]=1}),g},connect.relativeComplement=function(g,C){var A={};return connect.keys(C).forEach(function(I){I in g||(A[I]=C[I])}),A},connect.assertTrue=function(I,g){if(!I)throw new connect.ValueError(g)},connect.assertNotNull=function(I,g){return connect.assertTrue(null!=I&&!0,connect.sprintf("%s must be provided",g||"A value")),I},connect.deepcopy=function(I){return JSON.parse(JSON.stringify(I))},connect.getBaseUrl=function(){var I=c.location;return connect.sprintf("%s//%s:%s",I.protocol,I.hostname,I.port)},connect.isFramed=function(){try{return window.self!==window.top}catch(I){return!0}},connect.fetch=function(I,l,b,g){return g=g||5,b=b||1e3,l=l||{},new Promise(function(A,Z){!function g(C){fetch(I,l).then(function(I){I.status===connect.HTTP_STATUS_CODES.SUCCESS?A(I.json()):1!==C&&(I.status>=connect.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR||I.status===connect.HTTP_STATUS_CODES.TOO_MANY_REQUESTS)?setTimeout(function(){g(--C)},b):Z(I)}).catch(function(I){Z(I)})}(g)})},connect.backoff=function(A,Z,l,b){connect.assertTrue(connect.isFunction(A),"func must be a Function");var G=this;A({success:function(I){b&&b.success&&b.success(I)},failure:function(I,g){var C;0<l?(C=2*Z*Math.random(),c.setTimeout(function(){G.backoff(A,2*C,--l,b)},C)):b&&b.failure&&b.failure(I,g)}})},connect.publishMetric=function(I){connect.core.getEventBus().trigger(connect.EventType.CLIENT_METRIC,I)},connect.publishSoftphoneStats=function(I){connect.core.getEventBus().trigger(connect.EventType.SOFTPHONE_STATS,I)},connect.publishSoftphoneReport=function(I){connect.core.getEventBus().trigger(connect.EventType.SOFTPHONE_REPORT,I)},connect.PopupManager=function(){},connect.PopupManager.prototype.open=function(I,g){var C=this._getLastOpenedTimestamp(g),A=(new Date).getTime(),Z=null;return 864e5<A-C&&((Z=window.open("",g)).location!==I&&(Z=window.open(I,g)),this._setLastOpenedTimestamp(g,A)),Z},connect.PopupManager.prototype.clear=function(I){I=this._getLocalStorageKey(I);c.localStorage.removeItem(I)},connect.PopupManager.prototype._getLastOpenedTimestamp=function(I){I=this._getLocalStorageKey(I),I=c.localStorage.getItem(I);return I?parseInt(I,10):0},connect.PopupManager.prototype._setLastOpenedTimestamp=function(I,g){I=this._getLocalStorageKey(I);c.localStorage.setItem(I,""+g)},connect.PopupManager.prototype._getLocalStorageKey=function(I){return"connectPopupManager::"+I};var C=connect.makeEnum(["granted","denied","default"]);connect.NotificationManager=function(){this.queue=[],this.permission=C.DEFAULT},connect.NotificationManager.prototype.requestPermission=function(){var g=this;"Notification"in c?c.Notification.permission===C.DENIED?(connect.getLog().warn("The user has requested to not receive notifications."),this.permission=C.DENIED):this.permission!==C.GRANTED&&c.Notification.requestPermission().then(function(I){(g.permission=I)===C.GRANTED?g._showQueued():g.queue=[]}):(connect.getLog().warn("This browser doesn't support notifications."),this.permission=C.DENIED)},connect.NotificationManager.prototype.show=function(I,g){if(this.permission===C.GRANTED)return this._showImpl({title:I,options:g});this.permission===C.DENIED?connect.getLog().warn("Unable to show notification.").withObject({title:I,options:g}):(g={title:I,options:g},connect.getLog().warn("Deferring notification until user decides to allow or deny.").withObject(g),this.queue.push(g))},connect.NotificationManager.prototype._showQueued=function(){var g=this,I=this.queue.map(function(I){return g._showImpl(I)});return this.queue=[],I},connect.NotificationManager.prototype._showImpl=function(I){var g=new c.Notification(I.title,I.options);return I.options.clicked&&(g.onclick=function(){I.options.clicked.call(g)}),g},connect.BaseError=function(I,g){c.Error.call(this,connect.vsprintf(I,g))},connect.BaseError.prototype=Object.create(Error.prototype),connect.BaseError.prototype.constructor=connect.BaseError,connect.ValueError=function(){var I=Array.prototype.slice.call(arguments,0),g=I.shift();connect.BaseError.call(this,g,I)},connect.ValueError.prototype=Object.create(connect.BaseError.prototype),connect.ValueError.prototype.constructor=connect.ValueError,connect.NotImplementedError=function(){var I=Array.prototype.slice.call(arguments,0),g=I.shift();connect.BaseError.call(this,g,I)},connect.NotImplementedError.prototype=Object.create(connect.BaseError.prototype),connect.NotImplementedError.prototype.constructor=connect.NotImplementedError,connect.StateError=function(){var I=Array.prototype.slice.call(arguments,0),g=I.shift();connect.BaseError.call(this,g,I)},connect.StateError.prototype=Object.create(connect.BaseError.prototype),connect.StateError.prototype.constructor=connect.StateError}(),function(){connect=this.connect||{},this.connect=connect,this.globalConnect={},this.lily=connect,globalConnect.Container=null;function I(I){this.region=I.region,this.id=this.region.replace(/-/g,"_"),this.height=I.height,this.style=I.iframe_style,this.ccp=this._createFramedCcp(JSON.stringify(I))}var g=window.atob("Ly8gQVdTIFNESyBmb3IgSmF2YVNjcmlwdCB2Mi41NTMuMAovLyBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KLy8gTGljZW5zZSBhdCBodHRwczovL3Nkay5hbWF6b25hd3MuY29tL2pzL0JVTkRMRV9MSUNFTlNFLnR4dAooZnVuY3Rpb24oKXtmdW5jdGlvbiByKGUsbix0KXtmdW5jdGlvbiBvKGksZil7aWYoIW5baV0pe2lmKCFlW2ldKXt2YXIgYz0iZnVuY3Rpb24iPT10eXBlb2YgcmVxdWlyZSYmcmVxdWlyZTtpZighZiYmYylyZXR1cm4gYyhpLCEwKTtpZih1KXJldHVybiB1KGksITApO3ZhciBhPW5ldyBFcnJvcigiQ2Fubm90IGZpbmQgbW9kdWxlICciK2krIiciKTt0aHJvdyBhLmNvZGU9Ik1PRFVMRV9OT1RfRk9VTkQiLGF9dmFyIHA9bltpXT17ZXhwb3J0czp7fX07ZVtpXVswXS5jYWxsKHAuZXhwb3J0cyxmdW5jdGlvbihyKXt2YXIgbj1lW2ldWzFdW3JdO3JldHVybiBvKG58fHIpfSxwLHAuZXhwb3J0cyxyLGUsbix0KX1yZXR1cm4gbltpXS5leHBvcnRzfWZvcih2YXIgdT0iZnVuY3Rpb24iPT10eXBlb2YgcmVxdWlyZSYmcmVxdWlyZSxpPTA7aTx0Lmxlbmd0aDtpKyspbyh0W2ldKTtyZXR1cm4gb31yZXR1cm4gcn0pKCkoezE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzPXsKICAgICJ2ZXJzaW9uIjogIjIuMCIsCiAgICAibWV0YWRhdGEiOiB7CiAgICAgICJhcGlWZXJzaW9uIjogIjIwMTQtMDYtMzAiLAogICAgICAiZW5kcG9pbnRQcmVmaXgiOiAiY29nbml0by1pZGVudGl0eSIsCiAgICAgICJqc29uVmVyc2lvbiI6ICIxLjEiLAogICAgICAicHJvdG9jb2wiOiAianNvbiIsCiAgICAgICJzZXJ2aWNlRnVsbE5hbWUiOiAiQW1hem9uIENvZ25pdG8gSWRlbnRpdHkiLAogICAgICAic2VydmljZUlkIjogIkNvZ25pdG8gSWRlbnRpdHkiLAogICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJ2NCIsCiAgICAgICJ0YXJnZXRQcmVmaXgiOiAiQVdTQ29nbml0b0lkZW50aXR5U2VydmljZSIsCiAgICAgICJ1aWQiOiAiY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwIgogICAgfSwKICAgICJvcGVyYXRpb25zIjogewogICAgICAiQ3JlYXRlSWRlbnRpdHlQb29sIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xOYW1lIiwKICAgICAgICAgICAgIkFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiOiB7fSwKICAgICAgICAgICAgIkFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiU3VwcG9ydGVkTG9naW5Qcm92aWRlcnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAgICJPcGVuSWRDb25uZWN0UHJvdmlkZXJBUk5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTOCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkNvZ25pdG9JZGVudGl0eVByb3ZpZGVycyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2EiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJTYW1sUHJvdmlkZXJBUk5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTZiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIklkZW50aXR5UG9vbFRhZ3MiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNnIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInNoYXBlIjogIlNqIgogICAgICAgIH0KICAgICAgfSwKICAgICAgIkRlbGV0ZUlkZW50aXRpZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWRzVG9EZWxldGUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkc1RvRGVsZXRlIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiVW5wcm9jZXNzZWRJZGVudGl0eUlkcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAgICAgICAiRXJyb3JDb2RlIjoge30KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJEZWxldGVJZGVudGl0eVBvb2wiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkRlc2NyaWJlSWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAic2hhcGUiOiAiU3UiCiAgICAgICAgfQogICAgICB9LAogICAgICAiRGVzY3JpYmVJZGVudGl0eVBvb2wiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTaiIKICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eUlkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTeiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkN1c3RvbVJvbGVBcm4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAiQWNjZXNzS2V5SWQiOiB7fSwKICAgICAgICAgICAgICAgICJTZWNyZXRLZXkiOiB7fSwKICAgICAgICAgICAgICAgICJTZXNzaW9uVG9rZW4iOiB7fSwKICAgICAgICAgICAgICAgICJFeHBpcmF0aW9uIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0SWQiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQWNjb3VudElkIjoge30sCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTeiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldElkZW50aXR5UG9vbFJvbGVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiUm9sZXMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMxYiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlJvbGVNYXBwaW5ncyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzFkIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0T3BlbklkVG9rZW4iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlN6IgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiVG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldE9wZW5JZFRva2VuRm9yRGV2ZWxvcGVySWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICAgIkxvZ2lucyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlN6IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiVG9rZW5EdXJhdGlvbiI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiVG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkxpc3RJZGVudGl0aWVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgICAgICJNYXhSZXN1bHRzIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICAgIk1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIk5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAiSGlkZURpc2FibGVkIjogewogICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiSWRlbnRpdGllcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlN1IgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTGlzdElkZW50aXR5UG9vbHMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIk1heFJlc3VsdHMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJNYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJOZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICAgICAgICJJZGVudGl0eVBvb2xOYW1lIjoge30KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJOZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkxpc3RUYWdzRm9yUmVzb3VyY2UiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJlc291cmNlQXJuIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUmVzb3VyY2VBcm4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlRhZ3MiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNnIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTG9va3VwRGV2ZWxvcGVySWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIkRldmVsb3BlclVzZXJJZGVudGlmaWVyIjoge30sCiAgICAgICAgICAgICJNYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJOZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIkRldmVsb3BlclVzZXJJZGVudGlmaWVyTGlzdCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTWVyZ2VEZXZlbG9wZXJJZGVudGl0aWVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJTb3VyY2VVc2VySWRlbnRpZmllciIsCiAgICAgICAgICAgICJEZXN0aW5hdGlvblVzZXJJZGVudGlmaWVyIiwKICAgICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSIsCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlNvdXJjZVVzZXJJZGVudGlmaWVyIjoge30sCiAgICAgICAgICAgICJEZXN0aW5hdGlvblVzZXJJZGVudGlmaWVyIjoge30sCiAgICAgICAgICAgICJEZXZlbG9wZXJQcm92aWRlck5hbWUiOiB7fSwKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTZXRJZGVudGl0eVBvb2xSb2xlcyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiLAogICAgICAgICAgICAiUm9sZXMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiUm9sZXMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMxYiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlJvbGVNYXBwaW5ncyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzFkIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVGFnUmVzb3VyY2UiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJlc291cmNlQXJuIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUmVzb3VyY2VBcm4iOiB7fSwKICAgICAgICAgICAgIlRhZ3MiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNnIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJVbmxpbmtEZXZlbG9wZXJJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlJZCIsCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgICAgICJEZXZlbG9wZXJQcm92aWRlck5hbWUiLAogICAgICAgICAgICAiRGV2ZWxvcGVyVXNlcklkZW50aWZpZXIiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAgICJEZXZlbG9wZXJVc2VySWRlbnRpZmllciI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVW5saW5rSWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWQiLAogICAgICAgICAgICAiTG9naW5zIiwKICAgICAgICAgICAgIkxvZ2luc1RvUmVtb3ZlIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTeiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkxvZ2luc1RvUmVtb3ZlIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTdiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlVudGFnUmVzb3VyY2UiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJlc291cmNlQXJuIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUmVzb3VyY2VBcm4iOiB7fSwKICAgICAgICAgICAgIlRhZ0tleXMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlVwZGF0ZUlkZW50aXR5UG9vbCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAic2hhcGUiOiAiU2oiCiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInNoYXBlIjogIlNqIgogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJzaGFwZXMiOiB7CiAgICAgICJTNCI6IHsKICAgICAgICAidHlwZSI6ICJtYXAiLAogICAgICAgICJrZXkiOiB7fSwKICAgICAgICAidmFsdWUiOiB7fQogICAgICB9LAogICAgICAiUzgiOiB7CiAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgIH0sCiAgICAgICJTYSI6IHsKICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAgICJDbGllbnRJZCI6IHt9LAogICAgICAgICAgICAiU2VydmVyU2lkZVRva2VuQ2hlY2siOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNmIjogewogICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICJtZW1iZXIiOiB7fQogICAgICB9LAogICAgICAiU2ciOiB7CiAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAia2V5Ijoge30sCiAgICAgICAgInZhbHVlIjoge30KICAgICAgfSwKICAgICAgIlNqIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICJJZGVudGl0eVBvb2xOYW1lIiwKICAgICAgICAgICJBbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiOiB7fSwKICAgICAgICAgICJBbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICB9LAogICAgICAgICAgIlN1cHBvcnRlZExvZ2luUHJvdmlkZXJzIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICB9LAogICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgIk9wZW5JZENvbm5lY3RQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTOCIKICAgICAgICAgIH0sCiAgICAgICAgICAiQ29nbml0b0lkZW50aXR5UHJvdmlkZXJzIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2EiCiAgICAgICAgICB9LAogICAgICAgICAgIlNhbWxQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTZiIKICAgICAgICAgIH0sCiAgICAgICAgICAiSWRlbnRpdHlQb29sVGFncyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNnIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlN1IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgIkxvZ2lucyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlN2IgogICAgICAgICAgfSwKICAgICAgICAgICJDcmVhdGlvbkRhdGUiOiB7CiAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgIH0sCiAgICAgICAgICAiTGFzdE1vZGlmaWVkRGF0ZSI6IHsKICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlN2IjogewogICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICJtZW1iZXIiOiB7fQogICAgICB9LAogICAgICAiU3oiOiB7CiAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAia2V5Ijoge30sCiAgICAgICAgInZhbHVlIjoge30KICAgICAgfSwKICAgICAgIlMxYiI6IHsKICAgICAgICAidHlwZSI6ICJtYXAiLAogICAgICAgICJrZXkiOiB7fSwKICAgICAgICAidmFsdWUiOiB7fQogICAgICB9LAogICAgICAiUzFkIjogewogICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgImtleSI6IHt9LAogICAgICAgICJ2YWx1ZSI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJUeXBlIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiVHlwZSI6IHt9LAogICAgICAgICAgICAiQW1iaWd1b3VzUm9sZVJlc29sdXRpb24iOiB7fSwKICAgICAgICAgICAgIlJ1bGVzQ29uZmlndXJhdGlvbiI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICJSdWxlcyIKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgIlJ1bGVzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICJDbGFpbSIsCiAgICAgICAgICAgICAgICAgICAgICAiTWF0Y2hUeXBlIiwKICAgICAgICAgICAgICAgICAgICAgICJWYWx1ZSIsCiAgICAgICAgICAgICAgICAgICAgICAiUm9sZUFSTiIKICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgIkNsYWltIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAiTWF0Y2hUeXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAiVmFsdWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJSb2xlQVJOIjoge30KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgfSx7fV0sMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHM9ewogICAgInBhZ2luYXRpb24iOiB7CiAgICB9CiAgfQogIAogIH0se31dLDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzPXsKICAgICJ2ZXJzaW9uIjogIjIuMCIsCiAgICAibWV0YWRhdGEiOiB7CiAgICAgICJhcGlWZXJzaW9uIjogIjIwMTctMDItMTUiLAogICAgICAiZW5kcG9pbnRQcmVmaXgiOiAiY29ubmVjdCIsCiAgICAgICJqc29uVmVyc2lvbiI6ICIxLjAiLAogICAgICAicHJvdG9jb2wiOiAianNvbiIsCiAgICAgICJzZXJ2aWNlQWJicmV2aWF0aW9uIjogIkNvbm5lY3QiLAogICAgICAic2VydmljZUZ1bGxOYW1lIjogIkFtYXpvbkNvbm5lY3RDVElTZXJ2aWNlIiwKICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAiIiwKICAgICAgInRhcmdldFByZWZpeCI6ICJBbWF6b25Db25uZWN0Q1RJU2VydmljZSIsCiAgICAgICJ1aWQiOiAiY29ubmVjdC0yMDE3LTAyLTE1IgogICAgfSwKICAgICJvcGVyYXRpb25zIjogewogICAgICAiQWNjZXB0Q29udGFjdCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNsZWFyQ29udGFjdCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiY29udGFjdElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNvbXBsZXRlQ29udGFjdCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiY29udGFjdElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNvbmZlcmVuY2VDb25uZWN0aW9ucyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNyZWF0ZUFkZGl0aW9uYWxDb25uZWN0aW9uIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiZW5kcG9pbnQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImVuZHBvaW50IjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQ3JlYXRlT3V0Ym91bmRDb250YWN0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJlbmRwb2ludCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImVuZHBvaW50IjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInF1ZXVlQVJOIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNyZWF0ZVRyYW5zcG9ydCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAidHJhbnNwb3J0VHlwZSIsCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgInRyYW5zcG9ydFR5cGUiOiB7fSwKICAgICAgICAgICAgInBhcnRpY2lwYW50SWQiOiB7fSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAic29mdHBob25lQ2xpZW50SWQiOiB7fSwKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIndlYlNvY2tldFRyYW5zcG9ydCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICJ1cmwiLAogICAgICAgICAgICAgICAgInRyYW5zcG9ydExpZmVUaW1lSW5TZWNvbmRzIgogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAidXJsIjoge30sCiAgICAgICAgICAgICAgICAidHJhbnNwb3J0TGlmZVRpbWVJblNlY29uZHMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImV4cGlyeSI6IHt9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAiY2hhdFRva2VuVHJhbnNwb3J0IjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgInBhcnRpY2lwYW50VG9rZW4iLAogICAgICAgICAgICAgICAgImV4cGlyeSIKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgInBhcnRpY2lwYW50VG9rZW4iOiB7fSwKICAgICAgICAgICAgICAgICJleHBpcnkiOiB7fQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgInNvZnRwaG9uZVRyYW5zcG9ydCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICJzb2Z0cGhvbmVNZWRpYUNvbm5lY3Rpb25zIgogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAic29mdHBob25lTWVkaWFDb25uZWN0aW9ucyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAidXNlcm5hbWUiLAogICAgICAgICAgICAgICAgICAgICAgImNyZWRlbnRpYWwiLAogICAgICAgICAgICAgICAgICAgICAgInVybHMiCiAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICJ1c2VybmFtZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgImNyZWRlbnRpYWwiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJ1cmxzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiRGVzdHJveUNvbm5lY3Rpb24iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRBZ2VudENvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImNvbmZpZ3VyYXRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJjb25maWd1cmF0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMWIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRBZ2VudFBlcm1pc3Npb25zIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgInBlcm1pc3Npb25zIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAicGVybWlzc2lvbnMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldEFnZW50U25hcHNob3QiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30sCiAgICAgICAgICAgICJ0aW1lb3V0IjogewogICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAic25hcHNob3QiLAogICAgICAgICAgICAibmV4dFRva2VuIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAic25hcHNob3QiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAic3RhdGUiLAogICAgICAgICAgICAgICAgImNvbnRhY3RzIiwKICAgICAgICAgICAgICAgICJzbmFwc2hvdFRpbWVzdGFtcCIKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgInN0YXRlIjogewogICAgICAgICAgICAgICAgICAic2hhcGUiOiAiUzF1IgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJhZ2VudEF2YWlsYWJpbGl0eVN0YXRlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAic3RhdGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAidGltZVN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJjb250YWN0cyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIiwKICAgICAgICAgICAgICAgICAgICAgICJzdGF0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAiY29ubmVjdGlvbnMiLAogICAgICAgICAgICAgICAgICAgICAgImF0dHJpYnV0ZXMiCiAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJpbml0aWFsQ29udGFjdElkIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgInN0YXRlIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAicXVldWUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTayIKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAicXVldWVUaW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAiY29ubmVjdGlvbnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25JZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImluaXRpYWwiCiAgICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJlbmRwb2ludCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInNoYXBlIjogIlNlIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpbml0aWFsIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzb2Z0cGhvbmVNZWRpYUluZm8iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjYWxsVHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJhdXRvQWNjZXB0IjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZWRpYUxlZ0NvbnRleHRUb2tlbiI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjYWxsQ29udGV4dFRva2VuIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNhbGxDb25maWdKc29uIjoge30KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjaGF0TWVkaWFJbmZvIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2hhdEF1dG9BY2NlcHQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25EYXRhIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImN1c3RvbWVyTmFtZSI6IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibW9uaXRvcmluZ0luZm8iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJhZ2VudCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImFnZW50TmFtZSI6IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiam9pblRpbWVTdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAiYXR0cmlidXRlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAgICAgICAgICAgICAgICAgImtleSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibmFtZSIKICAgICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgImNvbnRhY3REdXJhdGlvbiI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgInJlZmVyZW5jZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJrZXkiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgInZhbHVlIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgInZhbHVlIgogICAgICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICJjb250YWN0TWV0YWRhdGEiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAibmFtZSIKICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAicmVmZXJlbmNlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAia2V5Ijoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjoge30KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICJpbml0aWF0aW9uTWV0aG9kIjoge30KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic25hcHNob3RUaW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldEFnZW50U3RhdGVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgInN0YXRlcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgInN0YXRlcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlMxdSIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldERpYWxhYmxlQ291bnRyeUNvZGVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImNvdW50cnlDb2RlcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImNvdW50cnlDb2RlcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0RW5kcG9pbnRzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJxdWV1ZUFSTnMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJxdWV1ZUFSTnMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgIm1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImVuZHBvaW50cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlNlIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0TmV3QXV0aFRva2VuIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJyZWZyZXNoVG9rZW4iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJyZWZyZXNoVG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIm5ld0F1dGhUb2tlbiI6IHt9LAogICAgICAgICAgICAiZXhwaXJhdGlvbkRhdGVUaW1lIjogewogICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldFJvdXRpbmdQcm9maWxlUXVldWVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJyb3V0aW5nUHJvZmlsZUFSTiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInJvdXRpbmdQcm9maWxlQVJOIjoge30sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgIm1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJxdWV1ZXMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJxdWV1ZXMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTayIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkhvbGRDb25uZWN0aW9uIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTm90aWZ5Q29udGFjdElzc3VlIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImlzc3VlQ29kZSI6IHt9LAogICAgICAgICAgICAiZGVzY3JpcHRpb24iOiB7fSwKICAgICAgICAgICAgImNsaWVudExvZ3MiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiUHV0QWdlbnRTdGF0ZSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAic3RhdGUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJzdGF0ZSI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzF1IgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJSZWplY3RDb250YWN0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJjb250YWN0SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiUmVzdW1lQ29ubmVjdGlvbiI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNlbmRDbGllbnRMb2dzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJsb2dFdmVudHMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJsb2dFdmVudHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICJjb21wb25lbnQiOiB7fSwKICAgICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiB7fQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2VuZERpZ2l0cyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCIsCiAgICAgICAgICAgICJkaWdpdHMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9LAogICAgICAgICAgICAiZGlnaXRzIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNlbmRTb2Z0cGhvbmVDYWxsTWV0cmljcyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgInNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNjcFZlcnNpb24iOiB7fSwKICAgICAgICAgICAgInNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMzbiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2VuZFNvZnRwaG9uZUNhbGxSZXBvcnQiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJyZXBvcnQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNjcFZlcnNpb24iOiB7fSwKICAgICAgICAgICAgInJlcG9ydCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgImNhbGxTdGFydFRpbWUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiY2FsbEVuZFRpbWUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic29mdHBob25lU3RyZWFtU3RhdGlzdGljcyI6IHsKICAgICAgICAgICAgICAgICAgInNoYXBlIjogIlMzbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiZ3VtVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiaW5pdGlhbGl6YXRpb25UaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJpY2VDb2xsZWN0aW9uVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic2lnbmFsbGluZ0Nvbm5lY3RUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJoYW5kc2hha2VUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJwcmVUYWxrVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAidGFsa1RpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImNsZWFudXBUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJpY2VDb2xsZWN0aW9uRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic2lnbmFsbGluZ0Nvbm5lY3Rpb25GYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJoYW5kc2hha2VGYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJndW1PdGhlckZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImd1bVRpbWVvdXRGYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJjcmVhdGVPZmZlckZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgInNldExvY2FsRGVzY3JpcHRpb25GYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJ1c2VyQnVzeUZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImludmFsaWRSZW1vdGVTRFBGYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJub1JlbW90ZUljZUNhbmRpZGF0ZUZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgInNldFJlbW90ZURlc2NyaXB0aW9uRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlRvZ2dsZUFjdGl2ZUNvbm5lY3Rpb25zIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVXBkYXRlQWdlbnRDb25maWd1cmF0aW9uIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb25maWd1cmF0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29uZmlndXJhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzFiIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAic2hhcGVzIjogewogICAgICAiUzIiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhZ2VudEFSTiI6IHt9LAogICAgICAgICAgImF1dGhUb2tlbiI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2UiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAidHlwZSIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImVuZHBvaW50QVJOIjoge30sCiAgICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICJwaG9uZU51bWJlciI6IHt9LAogICAgICAgICAgImFnZW50TG9naW4iOiB7fSwKICAgICAgICAgICJxdWV1ZSI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNrIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNrIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAicXVldWVBUk4iOiB7fSwKICAgICAgICAgICJuYW1lIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTMWIiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAibmFtZSIsCiAgICAgICAgICAic29mdHBob25lRW5hYmxlZCIsCiAgICAgICAgICAic29mdHBob25lQXV0b0FjY2VwdCIsCiAgICAgICAgICAiZXh0ZW5zaW9uIiwKICAgICAgICAgICJyb3V0aW5nUHJvZmlsZSIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICJ1c2VybmFtZSI6IHt9LAogICAgICAgICAgInNvZnRwaG9uZUVuYWJsZWQiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICB9LAogICAgICAgICAgInNvZnRwaG9uZUF1dG9BY2NlcHQiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICB9LAogICAgICAgICAgImV4dGVuc2lvbiI6IHt9LAogICAgICAgICAgInJvdXRpbmdQcm9maWxlIjogewogICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICAgICAgICJyb3V0aW5nUHJvZmlsZUFSTiI6IHt9LAogICAgICAgICAgICAgICJkZWZhdWx0T3V0Ym91bmRRdWV1ZSI6IHsKICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTayIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJjaGFubmVsQ29uY3VycmVuY3lNYXAiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJtYXAiLAogICAgICAgICAgICAgICAgImtleSI6IHt9LAogICAgICAgICAgICAgICAgInZhbHVlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgICJhZ2VudFByZWZlcmVuY2VzIjogewogICAgICAgICAgICAidHlwZSI6ICJtYXAiLAogICAgICAgICAgICAia2V5Ijoge30sCiAgICAgICAgICAgICJ2YWx1ZSI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiUzF1IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgInR5cGUiLAogICAgICAgICAgIm5hbWUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhZ2VudFN0YXRlQVJOIjoge30sCiAgICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICJzdGFydFRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlMzbiI6IHsKICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAidGltZXN0YW1wIjogewogICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInNvZnRwaG9uZVN0cmVhbVR5cGUiOiB7fSwKICAgICAgICAgICAgInBhY2tldENvdW50IjogewogICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJwYWNrZXRzTG9zdCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiYXVkaW9MZXZlbCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJkb3VibGUiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJqaXR0ZXJCdWZmZXJNaWxsaXMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInJvdW5kVHJpcFRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICB9LHt9XSw0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBtb2R1bGUuZXhwb3J0cz17CiAgICAiYWNtIjogewogICAgICAibmFtZSI6ICJBQ00iLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiYXBpZ2F0ZXdheSI6IHsKICAgICAgIm5hbWUiOiAiQVBJR2F0ZXdheSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJhcHBsaWNhdGlvbmF1dG9zY2FsaW5nIjogewogICAgICAicHJlZml4IjogImFwcGxpY2F0aW9uLWF1dG9zY2FsaW5nIiwKICAgICAgIm5hbWUiOiAiQXBwbGljYXRpb25BdXRvU2NhbGluZyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJhcHBzdHJlYW0iOiB7CiAgICAgICJuYW1lIjogIkFwcFN0cmVhbSIKICAgIH0sCiAgICAiYXV0b3NjYWxpbmciOiB7CiAgICAgICJuYW1lIjogIkF1dG9TY2FsaW5nIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImJhdGNoIjogewogICAgICAibmFtZSI6ICJCYXRjaCIKICAgIH0sCiAgICAiYnVkZ2V0cyI6IHsKICAgICAgIm5hbWUiOiAiQnVkZ2V0cyIKICAgIH0sCiAgICAiY2xvdWRkaXJlY3RvcnkiOiB7CiAgICAgICJuYW1lIjogIkNsb3VkRGlyZWN0b3J5IiwKICAgICAgInZlcnNpb25zIjogWwogICAgICAgICIyMDE2LTA1LTEwKiIKICAgICAgXQogICAgfSwKICAgICJjbG91ZGZvcm1hdGlvbiI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWRGb3JtYXRpb24iLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY2xvdWRmcm9udCI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWRGcm9udCIsCiAgICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgICAiMjAxMy0wNS0xMioiLAogICAgICAgICIyMDEzLTExLTExKiIsCiAgICAgICAgIjIwMTQtMDUtMzEqIiwKICAgICAgICAiMjAxNC0xMC0yMSoiLAogICAgICAgICIyMDE0LTExLTA2KiIsCiAgICAgICAgIjIwMTUtMDQtMTcqIiwKICAgICAgICAiMjAxNS0wNy0yNyoiLAogICAgICAgICIyMDE1LTA5LTE3KiIsCiAgICAgICAgIjIwMTYtMDEtMTMqIiwKICAgICAgICAiMjAxNi0wMS0yOCoiLAogICAgICAgICIyMDE2LTA4LTAxKiIsCiAgICAgICAgIjIwMTYtMDgtMjAqIiwKICAgICAgICAiMjAxNi0wOS0wNyoiLAogICAgICAgICIyMDE2LTA5LTI5KiIsCiAgICAgICAgIjIwMTYtMTEtMjUqIiwKICAgICAgICAiMjAxNy0wMy0yNSoiLAogICAgICAgICIyMDE3LTEwLTMwKiIsCiAgICAgICAgIjIwMTgtMDYtMTgqIiwKICAgICAgICAiMjAxOC0xMS0wNSoiCiAgICAgIF0sCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjbG91ZGhzbSI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWRIU00iLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY2xvdWRzZWFyY2giOiB7CiAgICAgICJuYW1lIjogIkNsb3VkU2VhcmNoIgogICAgfSwKICAgICJjbG91ZHNlYXJjaGRvbWFpbiI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWRTZWFyY2hEb21haW4iCiAgICB9LAogICAgImNsb3VkdHJhaWwiOiB7CiAgICAgICJuYW1lIjogIkNsb3VkVHJhaWwiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY2xvdWR3YXRjaCI6IHsKICAgICAgInByZWZpeCI6ICJtb25pdG9yaW5nIiwKICAgICAgIm5hbWUiOiAiQ2xvdWRXYXRjaCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjbG91ZHdhdGNoZXZlbnRzIjogewogICAgICAicHJlZml4IjogImV2ZW50cyIsCiAgICAgICJuYW1lIjogIkNsb3VkV2F0Y2hFdmVudHMiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTQtMDItMDMqIgogICAgICBdLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY2xvdWR3YXRjaGxvZ3MiOiB7CiAgICAgICJwcmVmaXgiOiAibG9ncyIsCiAgICAgICJuYW1lIjogIkNsb3VkV2F0Y2hMb2dzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvZGVidWlsZCI6IHsKICAgICAgIm5hbWUiOiAiQ29kZUJ1aWxkIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvZGVjb21taXQiOiB7CiAgICAgICJuYW1lIjogIkNvZGVDb21taXQiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29kZWRlcGxveSI6IHsKICAgICAgIm5hbWUiOiAiQ29kZURlcGxveSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb2RlcGlwZWxpbmUiOiB7CiAgICAgICJuYW1lIjogIkNvZGVQaXBlbGluZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb2duaXRvaWRlbnRpdHkiOiB7CiAgICAgICJwcmVmaXgiOiAiY29nbml0by1pZGVudGl0eSIsCiAgICAgICJuYW1lIjogIkNvZ25pdG9JZGVudGl0eSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb2duaXRvaWRlbnRpdHlzZXJ2aWNlcHJvdmlkZXIiOiB7CiAgICAgICJwcmVmaXgiOiAiY29nbml0by1pZHAiLAogICAgICAibmFtZSI6ICJDb2duaXRvSWRlbnRpdHlTZXJ2aWNlUHJvdmlkZXIiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29nbml0b3N5bmMiOiB7CiAgICAgICJwcmVmaXgiOiAiY29nbml0by1zeW5jIiwKICAgICAgIm5hbWUiOiAiQ29nbml0b1N5bmMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29uZmlnc2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJjb25maWciLAogICAgICAibmFtZSI6ICJDb25maWdTZXJ2aWNlIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImN1ciI6IHsKICAgICAgIm5hbWUiOiAiQ1VSIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImRhdGFwaXBlbGluZSI6IHsKICAgICAgIm5hbWUiOiAiRGF0YVBpcGVsaW5lIgogICAgfSwKICAgICJkZXZpY2VmYXJtIjogewogICAgICAibmFtZSI6ICJEZXZpY2VGYXJtIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImRpcmVjdGNvbm5lY3QiOiB7CiAgICAgICJuYW1lIjogIkRpcmVjdENvbm5lY3QiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZGlyZWN0b3J5c2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJkcyIsCiAgICAgICJuYW1lIjogIkRpcmVjdG9yeVNlcnZpY2UiCiAgICB9LAogICAgImRpc2NvdmVyeSI6IHsKICAgICAgIm5hbWUiOiAiRGlzY292ZXJ5IgogICAgfSwKICAgICJkbXMiOiB7CiAgICAgICJuYW1lIjogIkRNUyIKICAgIH0sCiAgICAiZHluYW1vZGIiOiB7CiAgICAgICJuYW1lIjogIkR5bmFtb0RCIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImR5bmFtb2Ric3RyZWFtcyI6IHsKICAgICAgInByZWZpeCI6ICJzdHJlYW1zLmR5bmFtb2RiIiwKICAgICAgIm5hbWUiOiAiRHluYW1vREJTdHJlYW1zIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVjMiI6IHsKICAgICAgIm5hbWUiOiAiRUMyIiwKICAgICAgInZlcnNpb25zIjogWwogICAgICAgICIyMDEzLTA2LTE1KiIsCiAgICAgICAgIjIwMTMtMTAtMTUqIiwKICAgICAgICAiMjAxNC0wMi0wMSoiLAogICAgICAgICIyMDE0LTA1LTAxKiIsCiAgICAgICAgIjIwMTQtMDYtMTUqIiwKICAgICAgICAiMjAxNC0wOS0wMSoiLAogICAgICAgICIyMDE0LTEwLTAxKiIsCiAgICAgICAgIjIwMTUtMDMtMDEqIiwKICAgICAgICAiMjAxNS0wNC0xNSoiLAogICAgICAgICIyMDE1LTEwLTAxKiIsCiAgICAgICAgIjIwMTYtMDQtMDEqIiwKICAgICAgICAiMjAxNi0wOS0xNSoiCiAgICAgIF0sCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlY3IiOiB7CiAgICAgICJuYW1lIjogIkVDUiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlY3MiOiB7CiAgICAgICJuYW1lIjogIkVDUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlZnMiOiB7CiAgICAgICJwcmVmaXgiOiAiZWxhc3RpY2ZpbGVzeXN0ZW0iLAogICAgICAibmFtZSI6ICJFRlMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZWxhc3RpY2FjaGUiOiB7CiAgICAgICJuYW1lIjogIkVsYXN0aUNhY2hlIiwKICAgICAgInZlcnNpb25zIjogWwogICAgICAgICIyMDEyLTExLTE1KiIsCiAgICAgICAgIjIwMTQtMDMtMjQqIiwKICAgICAgICAiMjAxNC0wNy0xNSoiLAogICAgICAgICIyMDE0LTA5LTMwKiIKICAgICAgXSwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVsYXN0aWNiZWFuc3RhbGsiOiB7CiAgICAgICJuYW1lIjogIkVsYXN0aWNCZWFuc3RhbGsiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZWxiIjogewogICAgICAicHJlZml4IjogImVsYXN0aWNsb2FkYmFsYW5jaW5nIiwKICAgICAgIm5hbWUiOiAiRUxCIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVsYnYyIjogewogICAgICAicHJlZml4IjogImVsYXN0aWNsb2FkYmFsYW5jaW5ndjIiLAogICAgICAibmFtZSI6ICJFTEJ2MiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlbXIiOiB7CiAgICAgICJwcmVmaXgiOiAiZWxhc3RpY21hcHJlZHVjZSIsCiAgICAgICJuYW1lIjogIkVNUiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlcyI6IHsKICAgICAgIm5hbWUiOiAiRVMiCiAgICB9LAogICAgImVsYXN0aWN0cmFuc2NvZGVyIjogewogICAgICAibmFtZSI6ICJFbGFzdGljVHJhbnNjb2RlciIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJmaXJlaG9zZSI6IHsKICAgICAgIm5hbWUiOiAiRmlyZWhvc2UiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZ2FtZWxpZnQiOiB7CiAgICAgICJuYW1lIjogIkdhbWVMaWZ0IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImdsYWNpZXIiOiB7CiAgICAgICJuYW1lIjogIkdsYWNpZXIiCiAgICB9LAogICAgImhlYWx0aCI6IHsKICAgICAgIm5hbWUiOiAiSGVhbHRoIgogICAgfSwKICAgICJpYW0iOiB7CiAgICAgICJuYW1lIjogIklBTSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJpbXBvcnRleHBvcnQiOiB7CiAgICAgICJuYW1lIjogIkltcG9ydEV4cG9ydCIKICAgIH0sCiAgICAiaW5zcGVjdG9yIjogewogICAgICAibmFtZSI6ICJJbnNwZWN0b3IiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTUtMDgtMTgqIgogICAgICBdLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiaW90IjogewogICAgICAibmFtZSI6ICJJb3QiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiaW90ZGF0YSI6IHsKICAgICAgInByZWZpeCI6ICJpb3QtZGF0YSIsCiAgICAgICJuYW1lIjogIklvdERhdGEiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAia2luZXNpcyI6IHsKICAgICAgIm5hbWUiOiAiS2luZXNpcyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJraW5lc2lzYW5hbHl0aWNzIjogewogICAgICAibmFtZSI6ICJLaW5lc2lzQW5hbHl0aWNzIgogICAgfSwKICAgICJrbXMiOiB7CiAgICAgICJuYW1lIjogIktNUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJsYW1iZGEiOiB7CiAgICAgICJuYW1lIjogIkxhbWJkYSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJsZXhydW50aW1lIjogewogICAgICAicHJlZml4IjogInJ1bnRpbWUubGV4IiwKICAgICAgIm5hbWUiOiAiTGV4UnVudGltZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJsaWdodHNhaWwiOiB7CiAgICAgICJuYW1lIjogIkxpZ2h0c2FpbCIKICAgIH0sCiAgICAibWFjaGluZWxlYXJuaW5nIjogewogICAgICAibmFtZSI6ICJNYWNoaW5lTGVhcm5pbmciLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAibWFya2V0cGxhY2Vjb21tZXJjZWFuYWx5dGljcyI6IHsKICAgICAgIm5hbWUiOiAiTWFya2V0cGxhY2VDb21tZXJjZUFuYWx5dGljcyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJtYXJrZXRwbGFjZW1ldGVyaW5nIjogewogICAgICAicHJlZml4IjogIm1ldGVyaW5nbWFya2V0cGxhY2UiLAogICAgICAibmFtZSI6ICJNYXJrZXRwbGFjZU1ldGVyaW5nIgogICAgfSwKICAgICJtdHVyayI6IHsKICAgICAgInByZWZpeCI6ICJtdHVyay1yZXF1ZXN0ZXIiLAogICAgICAibmFtZSI6ICJNVHVyayIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJtb2JpbGVhbmFseXRpY3MiOiB7CiAgICAgICJuYW1lIjogIk1vYmlsZUFuYWx5dGljcyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJvcHN3b3JrcyI6IHsKICAgICAgIm5hbWUiOiAiT3BzV29ya3MiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAib3Bzd29ya3NjbSI6IHsKICAgICAgIm5hbWUiOiAiT3BzV29ya3NDTSIKICAgIH0sCiAgICAib3JnYW5pemF0aW9ucyI6IHsKICAgICAgIm5hbWUiOiAiT3JnYW5pemF0aW9ucyIKICAgIH0sCiAgICAicGlucG9pbnQiOiB7CiAgICAgICJuYW1lIjogIlBpbnBvaW50IgogICAgfSwKICAgICJwb2xseSI6IHsKICAgICAgIm5hbWUiOiAiUG9sbHkiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAicmRzIjogewogICAgICAibmFtZSI6ICJSRFMiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTQtMDktMDEqIgogICAgICBdLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAicmVkc2hpZnQiOiB7CiAgICAgICJuYW1lIjogIlJlZHNoaWZ0IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInJla29nbml0aW9uIjogewogICAgICAibmFtZSI6ICJSZWtvZ25pdGlvbiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJyZXNvdXJjZWdyb3Vwc3RhZ2dpbmdhcGkiOiB7CiAgICAgICJuYW1lIjogIlJlc291cmNlR3JvdXBzVGFnZ2luZ0FQSSIKICAgIH0sCiAgICAicm91dGU1MyI6IHsKICAgICAgIm5hbWUiOiAiUm91dGU1MyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJyb3V0ZTUzZG9tYWlucyI6IHsKICAgICAgIm5hbWUiOiAiUm91dGU1M0RvbWFpbnMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiczMiOiB7CiAgICAgICJuYW1lIjogIlMzIiwKICAgICAgImR1YWxzdGFja0F2YWlsYWJsZSI6IHRydWUsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzM2NvbnRyb2wiOiB7CiAgICAgICJuYW1lIjogIlMzQ29udHJvbCIsCiAgICAgICJkdWFsc3RhY2tBdmFpbGFibGUiOiB0cnVlCiAgICB9LAogICAgInNlcnZpY2VjYXRhbG9nIjogewogICAgICAibmFtZSI6ICJTZXJ2aWNlQ2F0YWxvZyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzZXMiOiB7CiAgICAgICJwcmVmaXgiOiAiZW1haWwiLAogICAgICAibmFtZSI6ICJTRVMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAic2hpZWxkIjogewogICAgICAibmFtZSI6ICJTaGllbGQiCiAgICB9LAogICAgInNpbXBsZWRiIjogewogICAgICAicHJlZml4IjogInNkYiIsCiAgICAgICJuYW1lIjogIlNpbXBsZURCIgogICAgfSwKICAgICJzbXMiOiB7CiAgICAgICJuYW1lIjogIlNNUyIKICAgIH0sCiAgICAic25vd2JhbGwiOiB7CiAgICAgICJuYW1lIjogIlNub3diYWxsIgogICAgfSwKICAgICJzbnMiOiB7CiAgICAgICJuYW1lIjogIlNOUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzcXMiOiB7CiAgICAgICJuYW1lIjogIlNRUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzc20iOiB7CiAgICAgICJuYW1lIjogIlNTTSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzdG9yYWdlZ2F0ZXdheSI6IHsKICAgICAgIm5hbWUiOiAiU3RvcmFnZUdhdGV3YXkiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAic3RlcGZ1bmN0aW9ucyI6IHsKICAgICAgInByZWZpeCI6ICJzdGF0ZXMiLAogICAgICAibmFtZSI6ICJTdGVwRnVuY3Rpb25zIgogICAgfSwKICAgICJzdHMiOiB7CiAgICAgICJuYW1lIjogIlNUUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzdXBwb3J0IjogewogICAgICAibmFtZSI6ICJTdXBwb3J0IgogICAgfSwKICAgICJzd2YiOiB7CiAgICAgICJuYW1lIjogIlNXRiIKICAgIH0sCiAgICAieHJheSI6IHsKICAgICAgIm5hbWUiOiAiWFJheSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJ3YWYiOiB7CiAgICAgICJuYW1lIjogIldBRiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJ3YWZyZWdpb25hbCI6IHsKICAgICAgInByZWZpeCI6ICJ3YWYtcmVnaW9uYWwiLAogICAgICAibmFtZSI6ICJXQUZSZWdpb25hbCIKICAgIH0sCiAgICAid29ya2RvY3MiOiB7CiAgICAgICJuYW1lIjogIldvcmtEb2NzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIndvcmtzcGFjZXMiOiB7CiAgICAgICJuYW1lIjogIldvcmtTcGFjZXMiCiAgICB9LAogICAgImNvZGVzdGFyIjogewogICAgICAibmFtZSI6ICJDb2RlU3RhciIKICAgIH0sCiAgICAibGV4bW9kZWxidWlsZGluZ3NlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAibGV4LW1vZGVscyIsCiAgICAgICJuYW1lIjogIkxleE1vZGVsQnVpbGRpbmdTZXJ2aWNlIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIm1hcmtldHBsYWNlZW50aXRsZW1lbnRzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogImVudGl0bGVtZW50Lm1hcmtldHBsYWNlIiwKICAgICAgIm5hbWUiOiAiTWFya2V0cGxhY2VFbnRpdGxlbWVudFNlcnZpY2UiCiAgICB9LAogICAgImF0aGVuYSI6IHsKICAgICAgIm5hbWUiOiAiQXRoZW5hIgogICAgfSwKICAgICJncmVlbmdyYXNzIjogewogICAgICAibmFtZSI6ICJHcmVlbmdyYXNzIgogICAgfSwKICAgICJkYXgiOiB7CiAgICAgICJuYW1lIjogIkRBWCIKICAgIH0sCiAgICAibWlncmF0aW9uaHViIjogewogICAgICAicHJlZml4IjogIkFXU01pZ3JhdGlvbkh1YiIsCiAgICAgICJuYW1lIjogIk1pZ3JhdGlvbkh1YiIKICAgIH0sCiAgICAiY2xvdWRoc212MiI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWRIU01WMiIKICAgIH0sCiAgICAiZ2x1ZSI6IHsKICAgICAgIm5hbWUiOiAiR2x1ZSIKICAgIH0sCiAgICAibW9iaWxlIjogewogICAgICAibmFtZSI6ICJNb2JpbGUiCiAgICB9LAogICAgInByaWNpbmciOiB7CiAgICAgICJuYW1lIjogIlByaWNpbmciLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29zdGV4cGxvcmVyIjogewogICAgICAicHJlZml4IjogImNlIiwKICAgICAgIm5hbWUiOiAiQ29zdEV4cGxvcmVyIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIm1lZGlhY29udmVydCI6IHsKICAgICAgIm5hbWUiOiAiTWVkaWFDb252ZXJ0IgogICAgfSwKICAgICJtZWRpYWxpdmUiOiB7CiAgICAgICJuYW1lIjogIk1lZGlhTGl2ZSIKICAgIH0sCiAgICAibWVkaWFwYWNrYWdlIjogewogICAgICAibmFtZSI6ICJNZWRpYVBhY2thZ2UiCiAgICB9LAogICAgIm1lZGlhc3RvcmUiOiB7CiAgICAgICJuYW1lIjogIk1lZGlhU3RvcmUiCiAgICB9LAogICAgIm1lZGlhc3RvcmVkYXRhIjogewogICAgICAicHJlZml4IjogIm1lZGlhc3RvcmUtZGF0YSIsCiAgICAgICJuYW1lIjogIk1lZGlhU3RvcmVEYXRhIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFwcHN5bmMiOiB7CiAgICAgICJuYW1lIjogIkFwcFN5bmMiCiAgICB9LAogICAgImd1YXJkZHV0eSI6IHsKICAgICAgIm5hbWUiOiAiR3VhcmREdXR5IgogICAgfSwKICAgICJtcSI6IHsKICAgICAgIm5hbWUiOiAiTVEiCiAgICB9LAogICAgImNvbXByZWhlbmQiOiB7CiAgICAgICJuYW1lIjogIkNvbXByZWhlbmQiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiaW90am9ic2RhdGFwbGFuZSI6IHsKICAgICAgInByZWZpeCI6ICJpb3Qtam9icy1kYXRhIiwKICAgICAgIm5hbWUiOiAiSW9USm9ic0RhdGFQbGFuZSIKICAgIH0sCiAgICAia2luZXNpc3ZpZGVvYXJjaGl2ZWRtZWRpYSI6IHsKICAgICAgInByZWZpeCI6ICJraW5lc2lzLXZpZGVvLWFyY2hpdmVkLW1lZGlhIiwKICAgICAgIm5hbWUiOiAiS2luZXNpc1ZpZGVvQXJjaGl2ZWRNZWRpYSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJraW5lc2lzdmlkZW9tZWRpYSI6IHsKICAgICAgInByZWZpeCI6ICJraW5lc2lzLXZpZGVvLW1lZGlhIiwKICAgICAgIm5hbWUiOiAiS2luZXNpc1ZpZGVvTWVkaWEiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAia2luZXNpc3ZpZGVvIjogewogICAgICAibmFtZSI6ICJLaW5lc2lzVmlkZW8iLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAic2FnZW1ha2VycnVudGltZSI6IHsKICAgICAgInByZWZpeCI6ICJydW50aW1lLnNhZ2VtYWtlciIsCiAgICAgICJuYW1lIjogIlNhZ2VNYWtlclJ1bnRpbWUiCiAgICB9LAogICAgInNhZ2VtYWtlciI6IHsKICAgICAgIm5hbWUiOiAiU2FnZU1ha2VyIgogICAgfSwKICAgICJ0cmFuc2xhdGUiOiB7CiAgICAgICJuYW1lIjogIlRyYW5zbGF0ZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJyZXNvdXJjZWdyb3VwcyI6IHsKICAgICAgInByZWZpeCI6ICJyZXNvdXJjZS1ncm91cHMiLAogICAgICAibmFtZSI6ICJSZXNvdXJjZUdyb3VwcyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJhbGV4YWZvcmJ1c2luZXNzIjogewogICAgICAibmFtZSI6ICJBbGV4YUZvckJ1c2luZXNzIgogICAgfSwKICAgICJjbG91ZDkiOiB7CiAgICAgICJuYW1lIjogIkNsb3VkOSIKICAgIH0sCiAgICAic2VydmVybGVzc2FwcGxpY2F0aW9ucmVwb3NpdG9yeSI6IHsKICAgICAgInByZWZpeCI6ICJzZXJ2ZXJsZXNzcmVwbyIsCiAgICAgICJuYW1lIjogIlNlcnZlcmxlc3NBcHBsaWNhdGlvblJlcG9zaXRvcnkiCiAgICB9LAogICAgInNlcnZpY2VkaXNjb3ZlcnkiOiB7CiAgICAgICJuYW1lIjogIlNlcnZpY2VEaXNjb3ZlcnkiCiAgICB9LAogICAgIndvcmttYWlsIjogewogICAgICAibmFtZSI6ICJXb3JrTWFpbCIKICAgIH0sCiAgICAiYXV0b3NjYWxpbmdwbGFucyI6IHsKICAgICAgInByZWZpeCI6ICJhdXRvc2NhbGluZy1wbGFucyIsCiAgICAgICJuYW1lIjogIkF1dG9TY2FsaW5nUGxhbnMiCiAgICB9LAogICAgInRyYW5zY3JpYmVzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogInRyYW5zY3JpYmUiLAogICAgICAibmFtZSI6ICJUcmFuc2NyaWJlU2VydmljZSIKICAgIH0sCiAgICAiY29ubmVjdCI6IHsKICAgICAgIm5hbWUiOiAiQ29ubmVjdCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJhY21wY2EiOiB7CiAgICAgICJwcmVmaXgiOiAiYWNtLXBjYSIsCiAgICAgICJuYW1lIjogIkFDTVBDQSIKICAgIH0sCiAgICAiZm1zIjogewogICAgICAibmFtZSI6ICJGTVMiCiAgICB9LAogICAgInNlY3JldHNtYW5hZ2VyIjogewogICAgICAibmFtZSI6ICJTZWNyZXRzTWFuYWdlciIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJpb3RhbmFseXRpY3MiOiB7CiAgICAgICJuYW1lIjogIklvVEFuYWx5dGljcyIsCiAgICAgICJjb3JzIjogdHJ1ZSAgCiAgICB9LAogICAgImlvdDFjbGlja2RldmljZXNzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogImlvdDFjbGljay1kZXZpY2VzIiwKICAgICAgIm5hbWUiOiAiSW9UMUNsaWNrRGV2aWNlc1NlcnZpY2UiCiAgICB9LAogICAgImlvdDFjbGlja3Byb2plY3RzIjogewogICAgICAicHJlZml4IjogImlvdDFjbGljay1wcm9qZWN0cyIsCiAgICAgICJuYW1lIjogIklvVDFDbGlja1Byb2plY3RzIgogICAgfSwKICAgICJwaSI6IHsKICAgICAgIm5hbWUiOiAiUEkiCiAgICB9LAogICAgIm5lcHR1bmUiOiB7CiAgICAgICJuYW1lIjogIk5lcHR1bmUiCiAgICB9LAogICAgIm1lZGlhdGFpbG9yIjogewogICAgICAibmFtZSI6ICJNZWRpYVRhaWxvciIKICAgIH0sCiAgICAiZWtzIjogewogICAgICAibmFtZSI6ICJFS1MiCiAgICB9LAogICAgIm1hY2llIjogewogICAgICAibmFtZSI6ICJNYWNpZSIKICAgIH0sCiAgICAiZGxtIjogewogICAgICAibmFtZSI6ICJETE0iCiAgICB9LAogICAgInNpZ25lciI6IHsKICAgICAgIm5hbWUiOiAiU2lnbmVyIgogICAgfSwKICAgICJjaGltZSI6IHsKICAgICAgIm5hbWUiOiAiQ2hpbWUiCiAgICB9LAogICAgInBpbnBvaW50ZW1haWwiOiB7CiAgICAgICJwcmVmaXgiOiAicGlucG9pbnQtZW1haWwiLAogICAgICAibmFtZSI6ICJQaW5wb2ludEVtYWlsIgogICAgfSwKICAgICJyYW0iOiB7CiAgICAgICJuYW1lIjogIlJBTSIKICAgIH0sCiAgICAicm91dGU1M3Jlc29sdmVyIjogewogICAgICAibmFtZSI6ICJSb3V0ZTUzUmVzb2x2ZXIiCiAgICB9LAogICAgInBpbnBvaW50c21zdm9pY2UiOiB7CiAgICAgICJwcmVmaXgiOiAic21zLXZvaWNlIiwKICAgICAgIm5hbWUiOiAiUGlucG9pbnRTTVNWb2ljZSIKICAgIH0sCiAgICAicXVpY2tzaWdodCI6IHsKICAgICAgIm5hbWUiOiAiUXVpY2tTaWdodCIKICAgIH0sCiAgICAicmRzZGF0YXNlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAicmRzLWRhdGEiLAogICAgICAibmFtZSI6ICJSRFNEYXRhU2VydmljZSIKICAgIH0sCiAgICAiYW1wbGlmeSI6IHsKICAgICAgIm5hbWUiOiAiQW1wbGlmeSIKICAgIH0sCiAgICAiZGF0YXN5bmMiOiB7CiAgICAgICJuYW1lIjogIkRhdGFTeW5jIgogICAgfSwKICAgICJyb2JvbWFrZXIiOiB7CiAgICAgICJuYW1lIjogIlJvYm9NYWtlciIKICAgIH0sCiAgICAidHJhbnNmZXIiOiB7CiAgICAgICJuYW1lIjogIlRyYW5zZmVyIgogICAgfSwKICAgICJnbG9iYWxhY2NlbGVyYXRvciI6IHsKICAgICAgIm5hbWUiOiAiR2xvYmFsQWNjZWxlcmF0b3IiCiAgICB9LAogICAgImNvbXByZWhlbmRtZWRpY2FsIjogewogICAgICAibmFtZSI6ICJDb21wcmVoZW5kTWVkaWNhbCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJraW5lc2lzYW5hbHl0aWNzdjIiOiB7CiAgICAgICJuYW1lIjogIktpbmVzaXNBbmFseXRpY3NWMiIKICAgIH0sCiAgICAibWVkaWFjb25uZWN0IjogewogICAgICAibmFtZSI6ICJNZWRpYUNvbm5lY3QiCiAgICB9LAogICAgImZzeCI6IHsKICAgICAgIm5hbWUiOiAiRlN4IgogICAgfSwKICAgICJzZWN1cml0eWh1YiI6IHsKICAgICAgIm5hbWUiOiAiU2VjdXJpdHlIdWIiCiAgICB9LAogICAgImFwcG1lc2giOiB7CiAgICAgICJuYW1lIjogIkFwcE1lc2giLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTgtMTAtMDEqIgogICAgICBdCiAgICB9LAogICAgImxpY2Vuc2VtYW5hZ2VyIjogewogICAgICAicHJlZml4IjogImxpY2Vuc2UtbWFuYWdlciIsCiAgICAgICJuYW1lIjogIkxpY2Vuc2VNYW5hZ2VyIgogICAgfSwKICAgICJrYWZrYSI6IHsKICAgICAgIm5hbWUiOiAiS2Fma2EiCiAgICB9LAogICAgImFwaWdhdGV3YXltYW5hZ2VtZW50YXBpIjogewogICAgICAibmFtZSI6ICJBcGlHYXRld2F5TWFuYWdlbWVudEFwaSIKICAgIH0sCiAgICAiYXBpZ2F0ZXdheXYyIjogewogICAgICAibmFtZSI6ICJBcGlHYXRld2F5VjIiCiAgICB9LAogICAgImRvY2RiIjogewogICAgICAibmFtZSI6ICJEb2NEQiIKICAgIH0sCiAgICAiYmFja3VwIjogewogICAgICAibmFtZSI6ICJCYWNrdXAiCiAgICB9LAogICAgIndvcmtsaW5rIjogewogICAgICAibmFtZSI6ICJXb3JrTGluayIKICAgIH0sCiAgICAidGV4dHJhY3QiOiB7CiAgICAgICJuYW1lIjogIlRleHRyYWN0IgogICAgfSwKICAgICJtYW5hZ2VkYmxvY2tjaGFpbiI6IHsKICAgICAgIm5hbWUiOiAiTWFuYWdlZEJsb2NrY2hhaW4iCiAgICB9LAogICAgIm1lZGlhcGFja2FnZXZvZCI6IHsKICAgICAgInByZWZpeCI6ICJtZWRpYXBhY2thZ2Utdm9kIiwKICAgICAgIm5hbWUiOiAiTWVkaWFQYWNrYWdlVm9kIgogICAgfSwKICAgICJncm91bmRzdGF0aW9uIjogewogICAgICAibmFtZSI6ICJHcm91bmRTdGF0aW9uIgogICAgfSwKICAgICJpb3R0aGluZ3NncmFwaCI6IHsKICAgICAgIm5hbWUiOiAiSW9UVGhpbmdzR3JhcGgiCiAgICB9LAogICAgImlvdGV2ZW50cyI6IHsKICAgICAgIm5hbWUiOiAiSW9URXZlbnRzIgogICAgfSwKICAgICJpb3RldmVudHNkYXRhIjogewogICAgICAicHJlZml4IjogImlvdGV2ZW50cy1kYXRhIiwKICAgICAgIm5hbWUiOiAiSW9URXZlbnRzRGF0YSIKICAgIH0sCiAgICAicGVyc29uYWxpemUiOiB7CiAgICAgICJuYW1lIjogIlBlcnNvbmFsaXplIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInBlcnNvbmFsaXplZXZlbnRzIjogewogICAgICAicHJlZml4IjogInBlcnNvbmFsaXplLWV2ZW50cyIsCiAgICAgICJuYW1lIjogIlBlcnNvbmFsaXplRXZlbnRzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInBlcnNvbmFsaXplcnVudGltZSI6IHsKICAgICAgInByZWZpeCI6ICJwZXJzb25hbGl6ZS1ydW50aW1lIiwKICAgICAgIm5hbWUiOiAiUGVyc29uYWxpemVSdW50aW1lIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFwcGxpY2F0aW9uaW5zaWdodHMiOiB7CiAgICAgICJwcmVmaXgiOiAiYXBwbGljYXRpb24taW5zaWdodHMiLAogICAgICAibmFtZSI6ICJBcHBsaWNhdGlvbkluc2lnaHRzIgogICAgfSwKICAgICJzZXJ2aWNlcXVvdGFzIjogewogICAgICAicHJlZml4IjogInNlcnZpY2UtcXVvdGFzIiwKICAgICAgIm5hbWUiOiAiU2VydmljZVF1b3RhcyIKICAgIH0sCiAgICAiZWMyaW5zdGFuY2Vjb25uZWN0IjogewogICAgICAicHJlZml4IjogImVjMi1pbnN0YW5jZS1jb25uZWN0IiwKICAgICAgIm5hbWUiOiAiRUMySW5zdGFuY2VDb25uZWN0IgogICAgfSwKICAgICJldmVudGJyaWRnZSI6IHsKICAgICAgIm5hbWUiOiAiRXZlbnRCcmlkZ2UiCiAgICB9LAogICAgImxha2Vmb3JtYXRpb24iOiB7CiAgICAgICJuYW1lIjogIkxha2VGb3JtYXRpb24iCiAgICB9LAogICAgImZvcmVjYXN0c2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJmb3JlY2FzdCIsCiAgICAgICJuYW1lIjogIkZvcmVjYXN0U2VydmljZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJmb3JlY2FzdHF1ZXJ5c2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJmb3JlY2FzdHF1ZXJ5IiwKICAgICAgIm5hbWUiOiAiRm9yZWNhc3RRdWVyeVNlcnZpY2UiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAicWxkYiI6IHsKICAgICAgIm5hbWUiOiAiUUxEQiIKICAgIH0sCiAgICAicWxkYnNlc3Npb24iOiB7CiAgICAgICJwcmVmaXgiOiAicWxkYi1zZXNzaW9uIiwKICAgICAgIm5hbWUiOiAiUUxEQlNlc3Npb24iCiAgICB9LAogICAgIndvcmttYWlsbWVzc2FnZWZsb3ciOiB7CiAgICAgICJuYW1lIjogIldvcmtNYWlsTWVzc2FnZUZsb3ciCiAgICB9CiAgfQogIAogIH0se31dLDU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzPXsKICAgICJ2ZXJzaW9uIjogIjIuMCIsCiAgICAibWV0YWRhdGEiOiB7CiAgICAgICJhcGlWZXJzaW9uIjogIjIwMTEtMDYtMTUiLAogICAgICAiZW5kcG9pbnRQcmVmaXgiOiAic3RzIiwKICAgICAgImdsb2JhbEVuZHBvaW50IjogInN0cy5hbWF6b25hd3MuY29tIiwKICAgICAgInByb3RvY29sIjogInF1ZXJ5IiwKICAgICAgInNlcnZpY2VBYmJyZXZpYXRpb24iOiAiQVdTIFNUUyIsCiAgICAgICJzZXJ2aWNlRnVsbE5hbWUiOiAiQVdTIFNlY3VyaXR5IFRva2VuIFNlcnZpY2UiLAogICAgICAic2VydmljZUlkIjogIlNUUyIsCiAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInY0IiwKICAgICAgInVpZCI6ICJzdHMtMjAxMS0wNi0xNSIsCiAgICAgICJ4bWxOYW1lc3BhY2UiOiAiaHR0cHM6Ly9zdHMuYW1hem9uYXdzLmNvbS9kb2MvMjAxMS0wNi0xNS8iCiAgICB9LAogICAgIm9wZXJhdGlvbnMiOiB7CiAgICAgICJBc3N1bWVSb2xlIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJSb2xlQXJuIiwKICAgICAgICAgICAgIlJvbGVTZXNzaW9uTmFtZSIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlJvbGVBcm4iOiB7fSwKICAgICAgICAgICAgIlJvbGVTZXNzaW9uTmFtZSI6IHt9LAogICAgICAgICAgICAiUG9saWN5QXJucyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQb2xpY3kiOiB7fSwKICAgICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiRXh0ZXJuYWxJZCI6IHt9LAogICAgICAgICAgICAiU2VyaWFsTnVtYmVyIjoge30sCiAgICAgICAgICAgICJUb2tlbkNvZGUiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkFzc3VtZVJvbGVSZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNjIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiQXNzdW1lZFJvbGVVc2VyIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTaCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlBhY2tlZFBvbGljeVNpemUiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkFzc3VtZVJvbGVXaXRoU0FNTCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiUm9sZUFybiIsCiAgICAgICAgICAgICJQcmluY2lwYWxBcm4iLAogICAgICAgICAgICAiU0FNTEFzc2VydGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlJvbGVBcm4iOiB7fSwKICAgICAgICAgICAgIlByaW5jaXBhbEFybiI6IHt9LAogICAgICAgICAgICAiU0FNTEFzc2VydGlvbiI6IHt9LAogICAgICAgICAgICAiUG9saWN5QXJucyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQb2xpY3kiOiB7fSwKICAgICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiQXNzdW1lUm9sZVdpdGhTQU1MUmVzdWx0IiwKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTYyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkFzc3VtZWRSb2xlVXNlciI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2giCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQYWNrZWRQb2xpY3lTaXplIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJTdWJqZWN0Ijoge30sCiAgICAgICAgICAgICJTdWJqZWN0VHlwZSI6IHt9LAogICAgICAgICAgICAiSXNzdWVyIjoge30sCiAgICAgICAgICAgICJBdWRpZW5jZSI6IHt9LAogICAgICAgICAgICAiTmFtZVF1YWxpZmllciI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiUm9sZUFybiIsCiAgICAgICAgICAgICJSb2xlU2Vzc2lvbk5hbWUiLAogICAgICAgICAgICAiV2ViSWRlbnRpdHlUb2tlbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlJvbGVBcm4iOiB7fSwKICAgICAgICAgICAgIlJvbGVTZXNzaW9uTmFtZSI6IHt9LAogICAgICAgICAgICAiV2ViSWRlbnRpdHlUb2tlbiI6IHt9LAogICAgICAgICAgICAiUHJvdmlkZXJJZCI6IHt9LAogICAgICAgICAgICAiUG9saWN5QXJucyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQb2xpY3kiOiB7fSwKICAgICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiQXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eVJlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJDcmVkZW50aWFscyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2MiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJTdWJqZWN0RnJvbVdlYklkZW50aXR5VG9rZW4iOiB7fSwKICAgICAgICAgICAgIkFzc3VtZWRSb2xlVXNlciI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2giCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQYWNrZWRQb2xpY3lTaXplIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQcm92aWRlciI6IHt9LAogICAgICAgICAgICAiQXVkaWVuY2UiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkRlY29kZUF1dGhvcml6YXRpb25NZXNzYWdlIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJFbmNvZGVkTWVzc2FnZSIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkVuY29kZWRNZXNzYWdlIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJEZWNvZGVBdXRob3JpemF0aW9uTWVzc2FnZVJlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJEZWNvZGVkTWVzc2FnZSI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0QWNjZXNzS2V5SW5mbyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiQWNjZXNzS2V5SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJBY2Nlc3NLZXlJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiR2V0QWNjZXNzS2V5SW5mb1Jlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJBY2NvdW50Ijoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRDYWxsZXJJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkdldENhbGxlcklkZW50aXR5UmVzdWx0IiwKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlVzZXJJZCI6IHt9LAogICAgICAgICAgICAiQWNjb3VudCI6IHt9LAogICAgICAgICAgICAiQXJuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRGZWRlcmF0aW9uVG9rZW4iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIk5hbWUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJOYW1lIjoge30sCiAgICAgICAgICAgICJQb2xpY3kiOiB7fSwKICAgICAgICAgICAgIlBvbGljeUFybnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiRHVyYXRpb25TZWNvbmRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJHZXRGZWRlcmF0aW9uVG9rZW5SZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNjIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiRmVkZXJhdGVkVXNlciI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICJGZWRlcmF0ZWRVc2VySWQiLAogICAgICAgICAgICAgICAgIkFybiIKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgIkZlZGVyYXRlZFVzZXJJZCI6IHt9LAogICAgICAgICAgICAgICAgIkFybiI6IHt9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAiUGFja2VkUG9saWN5U2l6ZSI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0U2Vzc2lvblRva2VuIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiU2VyaWFsTnVtYmVyIjoge30sCiAgICAgICAgICAgICJUb2tlbkNvZGUiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkdldFNlc3Npb25Ub2tlblJlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJDcmVkZW50aWFscyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2MiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAic2hhcGVzIjogewogICAgICAiUzQiOiB7CiAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImFybiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2MiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiQWNjZXNzS2V5SWQiLAogICAgICAgICAgIlNlY3JldEFjY2Vzc0tleSIsCiAgICAgICAgICAiU2Vzc2lvblRva2VuIiwKICAgICAgICAgICJFeHBpcmF0aW9uIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiQWNjZXNzS2V5SWQiOiB7fSwKICAgICAgICAgICJTZWNyZXRBY2Nlc3NLZXkiOiB7fSwKICAgICAgICAgICJTZXNzaW9uVG9rZW4iOiB7fSwKICAgICAgICAgICJFeHBpcmF0aW9uIjogewogICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2giOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiQXNzdW1lZFJvbGVJZCIsCiAgICAgICAgICAiQXJuIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiQXNzdW1lZFJvbGVJZCI6IHt9LAogICAgICAgICAgIkFybiI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIH0se31dLDY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIGFyZ3VtZW50c1s0XVsyXVswXS5hcHBseShleHBvcnRzLGFyZ3VtZW50cykKICB9LHsiZHVwIjoyfV0sNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgcmVxdWlyZSgnLi4vbGliL25vZGVfbG9hZGVyJyk7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2xpYi9jb3JlJyk7CiAgdmFyIFNlcnZpY2UgPSBBV1MuU2VydmljZTsKICB2YXIgYXBpTG9hZGVyID0gQVdTLmFwaUxvYWRlcjsKICAKICBhcGlMb2FkZXIuc2VydmljZXNbJ2NvZ25pdG9pZGVudGl0eSddID0ge307CiAgQVdTLkNvZ25pdG9JZGVudGl0eSA9IFNlcnZpY2UuZGVmaW5lU2VydmljZSgnY29nbml0b2lkZW50aXR5JywgWycyMDE0LTA2LTMwJ10pOwogIHJlcXVpcmUoJy4uL2xpYi9zZXJ2aWNlcy9jb2duaXRvaWRlbnRpdHknKTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYXBpTG9hZGVyLnNlcnZpY2VzWydjb2duaXRvaWRlbnRpdHknXSwgJzIwMTQtMDYtMzAnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgdmFyIG1vZGVsID0gcmVxdWlyZSgnLi4vYXBpcy9jb2duaXRvLWlkZW50aXR5LTIwMTQtMDYtMzAubWluLmpzb24nKTsKICAgICAgbW9kZWwucGFnaW5hdG9ycyA9IHJlcXVpcmUoJy4uL2FwaXMvY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwLnBhZ2luYXRvcnMuanNvbicpLnBhZ2luYXRpb247CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlCiAgfSk7CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuQ29nbml0b0lkZW50aXR5OwogIAogIH0seyIuLi9hcGlzL2NvZ25pdG8taWRlbnRpdHktMjAxNC0wNi0zMC5taW4uanNvbiI6MSwiLi4vYXBpcy9jb2duaXRvLWlkZW50aXR5LTIwMTQtMDYtMzAucGFnaW5hdG9ycy5qc29uIjoyLCIuLi9saWIvY29yZSI6MTgsIi4uL2xpYi9ub2RlX2xvYWRlciI6MTYsIi4uL2xpYi9zZXJ2aWNlcy9jb2duaXRvaWRlbnRpdHkiOjYwfV0sODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgcmVxdWlyZSgnLi4vbGliL25vZGVfbG9hZGVyJyk7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2xpYi9jb3JlJyk7CiAgdmFyIFNlcnZpY2UgPSBBV1MuU2VydmljZTsKICB2YXIgYXBpTG9hZGVyID0gQVdTLmFwaUxvYWRlcjsKICAKICBhcGlMb2FkZXIuc2VydmljZXNbJ3N0cyddID0ge307CiAgQVdTLlNUUyA9IFNlcnZpY2UuZGVmaW5lU2VydmljZSgnc3RzJywgWycyMDExLTA2LTE1J10pOwogIHJlcXVpcmUoJy4uL2xpYi9zZXJ2aWNlcy9zdHMnKTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYXBpTG9hZGVyLnNlcnZpY2VzWydzdHMnXSwgJzIwMTEtMDYtMTUnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgdmFyIG1vZGVsID0gcmVxdWlyZSgnLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5taW4uanNvbicpOwogICAgICBtb2RlbC5wYWdpbmF0b3JzID0gcmVxdWlyZSgnLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5wYWdpbmF0b3JzLmpzb24nKS5wYWdpbmF0aW9uOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogIH0pOwogIAogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNUUzsKICAKICB9LHsiLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5taW4uanNvbiI6NSwiLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5wYWdpbmF0b3JzLmpzb24iOjYsIi4uL2xpYi9jb3JlIjoxOCwiLi4vbGliL25vZGVfbG9hZGVyIjoxNiwiLi4vbGliL3NlcnZpY2VzL3N0cyI6NjF9XSw5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBmdW5jdGlvbiBhcGlMb2FkZXIoc3ZjLCB2ZXJzaW9uKSB7CiAgICBpZiAoIWFwaUxvYWRlci5zZXJ2aWNlcy5oYXNPd25Qcm9wZXJ0eShzdmMpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZFNlcnZpY2U6IEZhaWxlZCB0byBsb2FkIGFwaSBmb3IgJyArIHN2Yyk7CiAgICB9CiAgICByZXR1cm4gYXBpTG9hZGVyLnNlcnZpY2VzW3N2Y11bdmVyc2lvbl07CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqCiAgICogVGhpcyBtZW1iZXIgb2YgQVdTLmFwaUxvYWRlciBpcyBwcml2YXRlLCBidXQgY2hhbmdpbmcgaXQgd2lsbCBuZWNlc3NpdGF0ZSBhCiAgICogY2hhbmdlIHRvIC4uL3NjcmlwdHMvc2VydmljZXMtdGFibGUtZ2VuZXJhdG9yLnRzCiAgICovCiAgYXBpTG9hZGVyLnNlcnZpY2VzID0ge307CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBhcGlMb2FkZXI7CiAgCiAgfSx7fV0sMTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBIbWFjID0gcmVxdWlyZSgnLi9icm93c2VySG1hYycpOwogIHZhciBNZDUgPSByZXF1aXJlKCcuL2Jyb3dzZXJNZDUnKTsKICB2YXIgU2hhMSA9IHJlcXVpcmUoJy4vYnJvd3NlclNoYTEnKTsKICB2YXIgU2hhMjU2ID0gcmVxdWlyZSgnLi9icm93c2VyU2hhMjU2Jyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gewogICAgICBjcmVhdGVIYXNoOiBmdW5jdGlvbiBjcmVhdGVIYXNoKGFsZykgewogICAgICAgIGFsZyA9IGFsZy50b0xvd2VyQ2FzZSgpOwogICAgICAgIGlmIChhbGcgPT09ICdtZDUnKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1kNSgpOwogICAgICAgIH0gZWxzZSBpZiAoYWxnID09PSAnc2hhMjU2JykgewogICAgICAgICAgcmV0dXJuIG5ldyBTaGEyNTYoKTsKICAgICAgICB9IGVsc2UgaWYgKGFsZyA9PT0gJ3NoYTEnKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFNoYTEoKTsKICAgICAgICB9CiAgCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdIYXNoIGFsZ29yaXRobSAnICsgYWxnICsgJyBpcyBub3Qgc3VwcG9ydGVkIGluIHRoZSBicm93c2VyIFNESycpOwogICAgICB9LAogICAgICBjcmVhdGVIbWFjOiBmdW5jdGlvbiBjcmVhdGVIbWFjKGFsZywga2V5KSB7CiAgICAgICAgYWxnID0gYWxnLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgaWYgKGFsZyA9PT0gJ21kNScpIHsKICAgICAgICAgIHJldHVybiBuZXcgSG1hYyhNZDUsIGtleSk7CiAgICAgICAgfSBlbHNlIGlmIChhbGcgPT09ICdzaGEyNTYnKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEhtYWMoU2hhMjU2LCBrZXkpOwogICAgICAgIH0gZWxzZSBpZiAoYWxnID09PSAnc2hhMScpIHsKICAgICAgICAgIHJldHVybiBuZXcgSG1hYyhTaGExLCBrZXkpOwogICAgICAgIH0KICAKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0hNQUMgYWxnb3JpdGhtICcgKyBhbGcgKyAnIGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhlIGJyb3dzZXIgU0RLJyk7CiAgICAgIH0sCiAgICAgIGNyZWF0ZVNpZ246IGZ1bmN0aW9uKCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignY3JlYXRlU2lnbiBpcyBub3QgaW1wbGVtZW50ZWQgaW4gdGhlIGJyb3dzZXInKTsKICAgICAgfQogICAgfTsKICAKICB9LHsiLi9icm93c2VySG1hYyI6MTIsIi4vYnJvd3Nlck1kNSI6MTMsIi4vYnJvd3NlclNoYTEiOjE0LCIuL2Jyb3dzZXJTaGEyNTYiOjE1fV0sMTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwogIAogIC8qKgogICAqIFRoaXMgaXMgYSBwb2x5ZmlsbCBmb3IgdGhlIHN0YXRpYyBtZXRob2QgYGlzVmlld2Agb2YgYEFycmF5QnVmZmVyYCwgd2hpY2ggaXMKICAgKiBlLmcuIG1pc3NpbmcgaW4gSUUgMTAuCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBpZiAoCiAgICAgIHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gJ3VuZGVmaW5lZCcgJiYKICAgICAgdHlwZW9mIEFycmF5QnVmZmVyLmlzVmlldyA9PT0gJ3VuZGVmaW5lZCcKICApIHsKICAgICAgQXJyYXlCdWZmZXIuaXNWaWV3ID0gZnVuY3Rpb24oYXJnKSB7CiAgICAgICAgICByZXR1cm4gdmlld1N0cmluZ3MuaW5kZXhPZihPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoYXJnKSkgPiAtMTsKICAgICAgfTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIHZpZXdTdHJpbmdzID0gWwogICAgICAnW29iamVjdCBJbnQ4QXJyYXldJywKICAgICAgJ1tvYmplY3QgVWludDhBcnJheV0nLAogICAgICAnW29iamVjdCBVaW50OENsYW1wZWRBcnJheV0nLAogICAgICAnW29iamVjdCBJbnQxNkFycmF5XScsCiAgICAgICdbb2JqZWN0IFVpbnQxNkFycmF5XScsCiAgICAgICdbb2JqZWN0IEludDMyQXJyYXldJywKICAgICAgJ1tvYmplY3QgVWludDMyQXJyYXldJywKICAgICAgJ1tvYmplY3QgRmxvYXQzMkFycmF5XScsCiAgICAgICdbb2JqZWN0IEZsb2F0NjRBcnJheV0nLAogICAgICAnW29iamVjdCBEYXRhVmlld10nLAogIF07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gaXNFbXB0eURhdGEoZGF0YSkgewogICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICByZXR1cm4gZGF0YS5sZW5ndGggPT09IDA7CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGEuYnl0ZUxlbmd0aCA9PT0gMDsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gY29udmVydFRvQnVmZmVyKGRhdGEpIHsKICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgewogICAgICAgICAgZGF0YSA9IG5ldyBCdWZmZXIoZGF0YSwgJ3V0ZjgnKTsKICAgICAgfQogIAogICAgICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KGRhdGEpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCwgZGF0YS5ieXRlTGVuZ3RoIC8gVWludDhBcnJheS5CWVRFU19QRVJfRUxFTUVOVCk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGRhdGEpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSB7CiAgICAgIGlzRW1wdHlEYXRhOiBpc0VtcHR5RGF0YSwKICAgICAgY29udmVydFRvQnVmZmVyOiBjb252ZXJ0VG9CdWZmZXIsCiAgfTsKICAKICB9LHsiYnVmZmVyLyI6ODB9XSwxMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIGhhc2hVdGlscyA9IHJlcXVpcmUoJy4vYnJvd3Nlckhhc2hVdGlscycpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIEhtYWMoaGFzaEN0b3IsIHNlY3JldCkgewogICAgICB0aGlzLmhhc2ggPSBuZXcgaGFzaEN0b3IoKTsKICAgICAgdGhpcy5vdXRlciA9IG5ldyBoYXNoQ3RvcigpOwogIAogICAgICB2YXIgaW5uZXIgPSBidWZmZXJGcm9tU2VjcmV0KGhhc2hDdG9yLCBzZWNyZXQpOwogICAgICB2YXIgb3V0ZXIgPSBuZXcgVWludDhBcnJheShoYXNoQ3Rvci5CTE9DS19TSVpFKTsKICAgICAgb3V0ZXIuc2V0KGlubmVyKTsKICAKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoYXNoQ3Rvci5CTE9DS19TSVpFOyBpKyspIHsKICAgICAgICAgIGlubmVyW2ldIF49IDB4MzY7CiAgICAgICAgICBvdXRlcltpXSBePSAweDVjOwogICAgICB9CiAgCiAgICAgIHRoaXMuaGFzaC51cGRhdGUoaW5uZXIpOwogICAgICB0aGlzLm91dGVyLnVwZGF0ZShvdXRlcik7CiAgCiAgICAgIC8vIFplcm8gb3V0IHRoZSBjb3BpZWQga2V5IGJ1ZmZlci4KICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbm5lci5ieXRlTGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlubmVyW2ldID0gMDsKICAgICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBIbWFjOwogIAogIEhtYWMucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uICh0b0hhc2gpIHsKICAgICAgaWYgKGhhc2hVdGlscy5pc0VtcHR5RGF0YSh0b0hhc2gpIHx8IHRoaXMuZXJyb3IpIHsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgCiAgICAgIHRyeSB7CiAgICAgICAgICB0aGlzLmhhc2gudXBkYXRlKGhhc2hVdGlscy5jb252ZXJ0VG9CdWZmZXIodG9IYXNoKSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHRoaXMuZXJyb3IgPSBlOwogICAgICB9CiAgCiAgICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgSG1hYy5wcm90b3R5cGUuZGlnZXN0ID0gZnVuY3Rpb24gKGVuY29kaW5nKSB7CiAgICAgIGlmICghdGhpcy5vdXRlci5maW5pc2hlZCkgewogICAgICAgICAgdGhpcy5vdXRlci51cGRhdGUodGhpcy5oYXNoLmRpZ2VzdCgpKTsKICAgICAgfQogIAogICAgICByZXR1cm4gdGhpcy5vdXRlci5kaWdlc3QoZW5jb2RpbmcpOwogIH07CiAgCiAgZnVuY3Rpb24gYnVmZmVyRnJvbVNlY3JldChoYXNoQ3Rvciwgc2VjcmV0KSB7CiAgICAgIHZhciBpbnB1dCA9IGhhc2hVdGlscy5jb252ZXJ0VG9CdWZmZXIoc2VjcmV0KTsKICAgICAgaWYgKGlucHV0LmJ5dGVMZW5ndGggPiBoYXNoQ3Rvci5CTE9DS19TSVpFKSB7CiAgICAgICAgICB2YXIgYnVmZmVySGFzaCA9IG5ldyBoYXNoQ3RvcjsKICAgICAgICAgIGJ1ZmZlckhhc2gudXBkYXRlKGlucHV0KTsKICAgICAgICAgIGlucHV0ID0gYnVmZmVySGFzaC5kaWdlc3QoKTsKICAgICAgfQogICAgICB2YXIgYnVmZmVyID0gbmV3IFVpbnQ4QXJyYXkoaGFzaEN0b3IuQkxPQ0tfU0laRSk7CiAgICAgIGJ1ZmZlci5zZXQoaW5wdXQpOwogICAgICByZXR1cm4gYnVmZmVyOwogIH0KICAKICB9LHsiLi9icm93c2VySGFzaFV0aWxzIjoxMX1dLDEzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgaGFzaFV0aWxzID0gcmVxdWlyZSgnLi9icm93c2VySGFzaFV0aWxzJyk7CiAgdmFyIEJ1ZmZlciA9IHJlcXVpcmUoJ2J1ZmZlci8nKS5CdWZmZXI7CiAgCiAgdmFyIEJMT0NLX1NJWkUgPSA2NDsKICAKICB2YXIgRElHRVNUX0xFTkdUSCA9IDE2OwogIAogIHZhciBJTklUID0gWwogICAgICAweDY3NDUyMzAxLAogICAgICAweGVmY2RhYjg5LAogICAgICAweDk4YmFkY2ZlLAogICAgICAweDEwMzI1NDc2LAogIF07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gTWQ1KCkgewogICAgICB0aGlzLnN0YXRlID0gWwogICAgICAgICAgMHg2NzQ1MjMwMSwKICAgICAgICAgIDB4ZWZjZGFiODksCiAgICAgICAgICAweDk4YmFkY2ZlLAogICAgICAgICAgMHgxMDMyNTQ3NiwKICAgICAgXTsKICAgICAgdGhpcy5idWZmZXIgPSBuZXcgRGF0YVZpZXcobmV3IEFycmF5QnVmZmVyKEJMT0NLX1NJWkUpKTsKICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICB0aGlzLmJ5dGVzSGFzaGVkID0gMDsKICAgICAgdGhpcy5maW5pc2hlZCA9IGZhbHNlOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBNZDU7CiAgCiAgTWQ1LkJMT0NLX1NJWkUgPSBCTE9DS19TSVpFOwogIAogIE1kNS5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKHNvdXJjZURhdGEpIHsKICAgICAgaWYgKGhhc2hVdGlscy5pc0VtcHR5RGF0YShzb3VyY2VEYXRhKSkgewogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5maW5pc2hlZCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdHRlbXB0ZWQgdG8gdXBkYXRlIGFuIGFscmVhZHkgZmluaXNoZWQgaGFzaC4nKTsKICAgICAgfQogIAogICAgICB2YXIgZGF0YSA9IGhhc2hVdGlscy5jb252ZXJ0VG9CdWZmZXIoc291cmNlRGF0YSk7CiAgICAgIHZhciBwb3NpdGlvbiA9IDA7CiAgICAgIHZhciBieXRlTGVuZ3RoID0gZGF0YS5ieXRlTGVuZ3RoOwogICAgICB0aGlzLmJ5dGVzSGFzaGVkICs9IGJ5dGVMZW5ndGg7CiAgICAgIHdoaWxlIChieXRlTGVuZ3RoID4gMCkgewogICAgICAgICAgdGhpcy5idWZmZXIuc2V0VWludDgodGhpcy5idWZmZXJMZW5ndGgrKywgZGF0YVtwb3NpdGlvbisrXSk7CiAgICAgICAgICBieXRlTGVuZ3RoLS07CiAgICAgICAgICBpZiAodGhpcy5idWZmZXJMZW5ndGggPT09IEJMT0NLX1NJWkUpIHsKICAgICAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgICAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICAgICAgICB9CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBNZDUucHJvdG90eXBlLmRpZ2VzdCA9IGZ1bmN0aW9uIChlbmNvZGluZykgewogICAgICBpZiAoIXRoaXMuZmluaXNoZWQpIHsKICAgICAgICAgIHZhciBfYSA9IHRoaXMsIGJ1ZmZlciA9IF9hLmJ1ZmZlciwgdW5kZWNvcmF0ZWRMZW5ndGggPSBfYS5idWZmZXJMZW5ndGgsIGJ5dGVzSGFzaGVkID0gX2EuYnl0ZXNIYXNoZWQ7CiAgICAgICAgICB2YXIgYml0c0hhc2hlZCA9IGJ5dGVzSGFzaGVkICogODsKICAgICAgICAgIGJ1ZmZlci5zZXRVaW50OCh0aGlzLmJ1ZmZlckxlbmd0aCsrLCAxMjgpOwogICAgICAgICAgLy8gRW5zdXJlIHRoZSBmaW5hbCBibG9jayBoYXMgZW5vdWdoIHJvb20gZm9yIHRoZSBoYXNoZWQgbGVuZ3RoCiAgICAgICAgICBpZiAodW5kZWNvcmF0ZWRMZW5ndGggJSBCTE9DS19TSVpFID49IEJMT0NLX1NJWkUgLSA4KSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuYnVmZmVyTGVuZ3RoOyBpIDwgQkxPQ0tfU0laRTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlci5zZXRVaW50OChpLCAwKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICAgICAgfQogICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuYnVmZmVyTGVuZ3RoOyBpIDwgQkxPQ0tfU0laRSAtIDg7IGkrKykgewogICAgICAgICAgICAgIGJ1ZmZlci5zZXRVaW50OChpLCAwKTsKICAgICAgICAgIH0KICAgICAgICAgIGJ1ZmZlci5zZXRVaW50MzIoQkxPQ0tfU0laRSAtIDgsIGJpdHNIYXNoZWQgPj4+IDAsIHRydWUpOwogICAgICAgICAgYnVmZmVyLnNldFVpbnQzMihCTE9DS19TSVpFIC0gNCwgTWF0aC5mbG9vcihiaXRzSGFzaGVkIC8gMHgxMDAwMDAwMDApLCB0cnVlKTsKICAgICAgICAgIHRoaXMuaGFzaEJ1ZmZlcigpOwogICAgICAgICAgdGhpcy5maW5pc2hlZCA9IHRydWU7CiAgICAgIH0KICAgICAgdmFyIG91dCA9IG5ldyBEYXRhVmlldyhuZXcgQXJyYXlCdWZmZXIoRElHRVNUX0xFTkdUSCkpOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDQ7IGkrKykgewogICAgICAgICAgb3V0LnNldFVpbnQzMihpICogNCwgdGhpcy5zdGF0ZVtpXSwgdHJ1ZSk7CiAgICAgIH0KICAgICAgdmFyIGJ1ZmYgPSBuZXcgQnVmZmVyKG91dC5idWZmZXIsIG91dC5ieXRlT2Zmc2V0LCBvdXQuYnl0ZUxlbmd0aCk7CiAgICAgIHJldHVybiBlbmNvZGluZyA/IGJ1ZmYudG9TdHJpbmcoZW5jb2RpbmcpIDogYnVmZjsKICB9OwogIAogIE1kNS5wcm90b3R5cGUuaGFzaEJ1ZmZlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9hID0gdGhpcywgYnVmZmVyID0gX2EuYnVmZmVyLCBzdGF0ZSA9IF9hLnN0YXRlOwogICAgICB2YXIgYSA9IHN0YXRlWzBdLCBiID0gc3RhdGVbMV0sIGMgPSBzdGF0ZVsyXSwgZCA9IHN0YXRlWzNdOwogICAgICBhID0gZmYoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigwLCB0cnVlKSwgNywgMHhkNzZhYTQ3OCk7CiAgICAgIGQgPSBmZihkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDQsIHRydWUpLCAxMiwgMHhlOGM3Yjc1Nik7CiAgICAgIGMgPSBmZihjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDgsIHRydWUpLCAxNywgMHgyNDIwNzBkYik7CiAgICAgIGIgPSBmZihiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDEyLCB0cnVlKSwgMjIsIDB4YzFiZGNlZWUpOwogICAgICBhID0gZmYoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigxNiwgdHJ1ZSksIDcsIDB4ZjU3YzBmYWYpOwogICAgICBkID0gZmYoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigyMCwgdHJ1ZSksIDEyLCAweDQ3ODdjNjJhKTsKICAgICAgYyA9IGZmKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMjQsIHRydWUpLCAxNywgMHhhODMwNDYxMyk7CiAgICAgIGIgPSBmZihiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDI4LCB0cnVlKSwgMjIsIDB4ZmQ0Njk1MDEpOwogICAgICBhID0gZmYoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigzMiwgdHJ1ZSksIDcsIDB4Njk4MDk4ZDgpOwogICAgICBkID0gZmYoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigzNiwgdHJ1ZSksIDEyLCAweDhiNDRmN2FmKTsKICAgICAgYyA9IGZmKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNDAsIHRydWUpLCAxNywgMHhmZmZmNWJiMSk7CiAgICAgIGIgPSBmZihiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDQ0LCB0cnVlKSwgMjIsIDB4ODk1Y2Q3YmUpOwogICAgICBhID0gZmYoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMig0OCwgdHJ1ZSksIDcsIDB4NmI5MDExMjIpOwogICAgICBkID0gZmYoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig1MiwgdHJ1ZSksIDEyLCAweGZkOTg3MTkzKTsKICAgICAgYyA9IGZmKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNTYsIHRydWUpLCAxNywgMHhhNjc5NDM4ZSk7CiAgICAgIGIgPSBmZihiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDYwLCB0cnVlKSwgMjIsIDB4NDliNDA4MjEpOwogICAgICBhID0gZ2coYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMig0LCB0cnVlKSwgNSwgMHhmNjFlMjU2Mik7CiAgICAgIGQgPSBnZyhkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDI0LCB0cnVlKSwgOSwgMHhjMDQwYjM0MCk7CiAgICAgIGMgPSBnZyhjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDQ0LCB0cnVlKSwgMTQsIDB4MjY1ZTVhNTEpOwogICAgICBiID0gZ2coYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigwLCB0cnVlKSwgMjAsIDB4ZTliNmM3YWEpOwogICAgICBhID0gZ2coYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigyMCwgdHJ1ZSksIDUsIDB4ZDYyZjEwNWQpOwogICAgICBkID0gZ2coZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig0MCwgdHJ1ZSksIDksIDB4MDI0NDE0NTMpOwogICAgICBjID0gZ2coYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig2MCwgdHJ1ZSksIDE0LCAweGQ4YTFlNjgxKTsKICAgICAgYiA9IGdnKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMTYsIHRydWUpLCAyMCwgMHhlN2QzZmJjOCk7CiAgICAgIGEgPSBnZyhhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDM2LCB0cnVlKSwgNSwgMHgyMWUxY2RlNik7CiAgICAgIGQgPSBnZyhkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDU2LCB0cnVlKSwgOSwgMHhjMzM3MDdkNik7CiAgICAgIGMgPSBnZyhjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDEyLCB0cnVlKSwgMTQsIDB4ZjRkNTBkODcpOwogICAgICBiID0gZ2coYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigzMiwgdHJ1ZSksIDIwLCAweDQ1NWExNGVkKTsKICAgICAgYSA9IGdnKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNTIsIHRydWUpLCA1LCAweGE5ZTNlOTA1KTsKICAgICAgZCA9IGdnKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoOCwgdHJ1ZSksIDksIDB4ZmNlZmEzZjgpOwogICAgICBjID0gZ2coYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMigyOCwgdHJ1ZSksIDE0LCAweDY3NmYwMmQ5KTsKICAgICAgYiA9IGdnKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNDgsIHRydWUpLCAyMCwgMHg4ZDJhNGM4YSk7CiAgICAgIGEgPSBoaChhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDIwLCB0cnVlKSwgNCwgMHhmZmZhMzk0Mik7CiAgICAgIGQgPSBoaChkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDMyLCB0cnVlKSwgMTEsIDB4ODc3MWY2ODEpOwogICAgICBjID0gaGgoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig0NCwgdHJ1ZSksIDE2LCAweDZkOWQ2MTIyKTsKICAgICAgYiA9IGhoKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNTYsIHRydWUpLCAyMywgMHhmZGU1MzgwYyk7CiAgICAgIGEgPSBoaChhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDQsIHRydWUpLCA0LCAweGE0YmVlYTQ0KTsKICAgICAgZCA9IGhoKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMTYsIHRydWUpLCAxMSwgMHg0YmRlY2ZhOSk7CiAgICAgIGMgPSBoaChjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDI4LCB0cnVlKSwgMTYsIDB4ZjZiYjRiNjApOwogICAgICBiID0gaGgoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig0MCwgdHJ1ZSksIDIzLCAweGJlYmZiYzcwKTsKICAgICAgYSA9IGhoKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNTIsIHRydWUpLCA0LCAweDI4OWI3ZWM2KTsKICAgICAgZCA9IGhoKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMCwgdHJ1ZSksIDExLCAweGVhYTEyN2ZhKTsKICAgICAgYyA9IGhoKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMTIsIHRydWUpLCAxNiwgMHhkNGVmMzA4NSk7CiAgICAgIGIgPSBoaChiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDI0LCB0cnVlKSwgMjMsIDB4MDQ4ODFkMDUpOwogICAgICBhID0gaGgoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigzNiwgdHJ1ZSksIDQsIDB4ZDlkNGQwMzkpOwogICAgICBkID0gaGgoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig0OCwgdHJ1ZSksIDExLCAweGU2ZGI5OWU1KTsKICAgICAgYyA9IGhoKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNjAsIHRydWUpLCAxNiwgMHgxZmEyN2NmOCk7CiAgICAgIGIgPSBoaChiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDgsIHRydWUpLCAyMywgMHhjNGFjNTY2NSk7CiAgICAgIGEgPSBpaShhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDAsIHRydWUpLCA2LCAweGY0MjkyMjQ0KTsKICAgICAgZCA9IGlpKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMjgsIHRydWUpLCAxMCwgMHg0MzJhZmY5Nyk7CiAgICAgIGMgPSBpaShjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDU2LCB0cnVlKSwgMTUsIDB4YWI5NDIzYTcpOwogICAgICBiID0gaWkoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigyMCwgdHJ1ZSksIDIxLCAweGZjOTNhMDM5KTsKICAgICAgYSA9IGlpKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNDgsIHRydWUpLCA2LCAweDY1NWI1OWMzKTsKICAgICAgZCA9IGlpKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMTIsIHRydWUpLCAxMCwgMHg4ZjBjY2M5Mik7CiAgICAgIGMgPSBpaShjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDQwLCB0cnVlKSwgMTUsIDB4ZmZlZmY0N2QpOwogICAgICBiID0gaWkoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig0LCB0cnVlKSwgMjEsIDB4ODU4NDVkZDEpOwogICAgICBhID0gaWkoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigzMiwgdHJ1ZSksIDYsIDB4NmZhODdlNGYpOwogICAgICBkID0gaWkoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig2MCwgdHJ1ZSksIDEwLCAweGZlMmNlNmUwKTsKICAgICAgYyA9IGlpKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMjQsIHRydWUpLCAxNSwgMHhhMzAxNDMxNCk7CiAgICAgIGIgPSBpaShiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDUyLCB0cnVlKSwgMjEsIDB4NGUwODExYTEpOwogICAgICBhID0gaWkoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigxNiwgdHJ1ZSksIDYsIDB4Zjc1MzdlODIpOwogICAgICBkID0gaWkoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig0NCwgdHJ1ZSksIDEwLCAweGJkM2FmMjM1KTsKICAgICAgYyA9IGlpKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoOCwgdHJ1ZSksIDE1LCAweDJhZDdkMmJiKTsKICAgICAgYiA9IGlpKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMzYsIHRydWUpLCAyMSwgMHhlYjg2ZDM5MSk7CiAgICAgIHN0YXRlWzBdID0gKGEgKyBzdGF0ZVswXSkgJiAweEZGRkZGRkZGOwogICAgICBzdGF0ZVsxXSA9IChiICsgc3RhdGVbMV0pICYgMHhGRkZGRkZGRjsKICAgICAgc3RhdGVbMl0gPSAoYyArIHN0YXRlWzJdKSAmIDB4RkZGRkZGRkY7CiAgICAgIHN0YXRlWzNdID0gKGQgKyBzdGF0ZVszXSkgJiAweEZGRkZGRkZGOwogIH07CiAgCiAgZnVuY3Rpb24gY21uKHEsIGEsIGIsIHgsIHMsIHQpIHsKICAgICAgYSA9ICgoKGEgKyBxKSAmIDB4RkZGRkZGRkYpICsgKCh4ICsgdCkgJiAweEZGRkZGRkZGKSkgJiAweEZGRkZGRkZGOwogICAgICByZXR1cm4gKCgoYSA8PCBzKSB8IChhID4+PiAoMzIgLSBzKSkpICsgYikgJiAweEZGRkZGRkZGOwogIH0KICAKICBmdW5jdGlvbiBmZihhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICAgIHJldHVybiBjbW4oKGIgJiBjKSB8ICgofmIpICYgZCksIGEsIGIsIHgsIHMsIHQpOwogIH0KICAKICBmdW5jdGlvbiBnZyhhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICAgIHJldHVybiBjbW4oKGIgJiBkKSB8IChjICYgKH5kKSksIGEsIGIsIHgsIHMsIHQpOwogIH0KICAKICBmdW5jdGlvbiBoaChhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICAgIHJldHVybiBjbW4oYiBeIGMgXiBkLCBhLCBiLCB4LCBzLCB0KTsKICB9CiAgCiAgZnVuY3Rpb24gaWkoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICByZXR1cm4gY21uKGMgXiAoYiB8ICh+ZCkpLCBhLCBiLCB4LCBzLCB0KTsKICB9CiAgCiAgfSx7Ii4vYnJvd3Nlckhhc2hVdGlscyI6MTEsImJ1ZmZlci8iOjgwfV0sMTQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwogIHZhciBoYXNoVXRpbHMgPSByZXF1aXJlKCcuL2Jyb3dzZXJIYXNoVXRpbHMnKTsKICAKICB2YXIgQkxPQ0tfU0laRSA9IDY0OwogIAogIHZhciBESUdFU1RfTEVOR1RIID0gMjA7CiAgCiAgdmFyIEtFWSA9IG5ldyBVaW50MzJBcnJheShbCiAgICAgIDB4NWE4Mjc5OTksCiAgICAgIDB4NmVkOWViYTEsCiAgICAgIDB4OGYxYmJjZGMgfCAwLAogICAgICAweGNhNjJjMWQ2IHwgMAogIF0pOwogIAogIHZhciBJTklUID0gWwogICAgICAweDZhMDllNjY3LAogICAgICAweGJiNjdhZTg1LAogICAgICAweDNjNmVmMzcyLAogICAgICAweGE1NGZmNTNhLAogICAgICAweDUxMGU1MjdmLAogICAgICAweDliMDU2ODhjLAogICAgICAweDFmODNkOWFiLAogICAgICAweDViZTBjZDE5LAogIF07CiAgCiAgdmFyIE1BWF9IQVNIQUJMRV9MRU5HVEggPSBNYXRoLnBvdygyLCA1MykgLSAxOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIFNoYTEoKSB7CiAgICAgIHRoaXMuaDAgPSAweDY3NDUyMzAxOwogICAgICB0aGlzLmgxID0gMHhFRkNEQUI4OTsKICAgICAgdGhpcy5oMiA9IDB4OThCQURDRkU7CiAgICAgIHRoaXMuaDMgPSAweDEwMzI1NDc2OwogICAgICB0aGlzLmg0ID0gMHhDM0QyRTFGMDsKICAgICAgLy8gVGhlIGZpcnN0IDY0IGJ5dGVzICgxNiB3b3JkcykgaXMgdGhlIGRhdGEgY2h1bmsKICAgICAgdGhpcy5ibG9jayA9IG5ldyBVaW50MzJBcnJheSg4MCk7CiAgICAgIHRoaXMub2Zmc2V0ID0gMDsKICAgICAgdGhpcy5zaGlmdCA9IDI0OwogICAgICB0aGlzLnRvdGFsTGVuZ3RoID0gMDsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gU2hhMTsKICAKICBTaGExLkJMT0NLX1NJWkUgPSBCTE9DS19TSVpFOwogIAogIFNoYTEucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGlmICh0aGlzLmZpbmlzaGVkKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F0dGVtcHRlZCB0byB1cGRhdGUgYW4gYWxyZWFkeSBmaW5pc2hlZCBoYXNoLicpOwogICAgICB9CiAgCiAgICAgIGlmIChoYXNoVXRpbHMuaXNFbXB0eURhdGEoZGF0YSkpIHsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgCiAgICAgIGRhdGEgPSBoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKGRhdGEpOwogIAogICAgICB2YXIgbGVuZ3RoID0gZGF0YS5sZW5ndGg7CiAgICAgIHRoaXMudG90YWxMZW5ndGggKz0gbGVuZ3RoICogODsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgdGhpcy53cml0ZShkYXRhW2ldKTsKICAgICAgfQogIAogICAgICByZXR1cm4gdGhpczsKICB9OwogIAogIFNoYTEucHJvdG90eXBlLndyaXRlID0gZnVuY3Rpb24gd3JpdGUoYnl0ZSkgewogICAgICB0aGlzLmJsb2NrW3RoaXMub2Zmc2V0XSB8PSAoYnl0ZSAmIDB4ZmYpIDw8IHRoaXMuc2hpZnQ7CiAgICAgIGlmICh0aGlzLnNoaWZ0KSB7CiAgICAgICAgICB0aGlzLnNoaWZ0IC09IDg7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLm9mZnNldCsrOwogICAgICAgICAgdGhpcy5zaGlmdCA9IDI0OwogICAgICB9CiAgCiAgICAgIGlmICh0aGlzLm9mZnNldCA9PT0gMTYpIHRoaXMucHJvY2Vzc0Jsb2NrKCk7CiAgfTsKICAKICBTaGExLnByb3RvdHlwZS5kaWdlc3QgPSBmdW5jdGlvbiAoZW5jb2RpbmcpIHsKICAgICAgLy8gUGFkCiAgICAgIHRoaXMud3JpdGUoMHg4MCk7CiAgICAgIGlmICh0aGlzLm9mZnNldCA+IDE0IHx8ICh0aGlzLm9mZnNldCA9PT0gMTQgJiYgdGhpcy5zaGlmdCA8IDI0KSkgewogICAgICAgIHRoaXMucHJvY2Vzc0Jsb2NrKCk7CiAgICAgIH0KICAgICAgdGhpcy5vZmZzZXQgPSAxNDsKICAgICAgdGhpcy5zaGlmdCA9IDI0OwogIAogICAgICAvLyA2NC1iaXQgbGVuZ3RoIGJpZy1lbmRpYW4KICAgICAgdGhpcy53cml0ZSgweDAwKTsgLy8gbnVtYmVycyB0aGlzIGJpZyBhcmVuJ3QgYWNjdXJhdGUgaW4gamF2YXNjcmlwdCBhbnl3YXkKICAgICAgdGhpcy53cml0ZSgweDAwKTsgLy8gLi5TbyBqdXN0IGhhcmQtY29kZSB0byB6ZXJvLgogICAgICB0aGlzLndyaXRlKHRoaXMudG90YWxMZW5ndGggPiAweGZmZmZmZmZmZmYgPyB0aGlzLnRvdGFsTGVuZ3RoIC8gMHgxMDAwMDAwMDAwMCA6IDB4MDApOwogICAgICB0aGlzLndyaXRlKHRoaXMudG90YWxMZW5ndGggPiAweGZmZmZmZmZmID8gdGhpcy50b3RhbExlbmd0aCAvIDB4MTAwMDAwMDAwIDogMHgwMCk7CiAgICAgIGZvciAodmFyIHMgPSAyNDsgcyA+PSAwOyBzIC09IDgpIHsKICAgICAgICAgIHRoaXMud3JpdGUodGhpcy50b3RhbExlbmd0aCA+PiBzKTsKICAgICAgfQogICAgICAvLyBUaGUgdmFsdWUgaW4gc3RhdGUgaXMgbGl0dGxlLWVuZGlhbiByYXRoZXIgdGhhbiBiaWctZW5kaWFuLCBzbyBmbGlwCiAgICAgIC8vIGVhY2ggd29yZCBpbnRvIGEgbmV3IFVpbnQ4QXJyYXkKICAgICAgdmFyIG91dCA9IG5ldyBCdWZmZXIoRElHRVNUX0xFTkdUSCk7CiAgICAgIHZhciBvdXRWaWV3ID0gbmV3IERhdGFWaWV3KG91dC5idWZmZXIpOwogICAgICBvdXRWaWV3LnNldFVpbnQzMigwLCB0aGlzLmgwLCBmYWxzZSk7CiAgICAgIG91dFZpZXcuc2V0VWludDMyKDQsIHRoaXMuaDEsIGZhbHNlKTsKICAgICAgb3V0Vmlldy5zZXRVaW50MzIoOCwgdGhpcy5oMiwgZmFsc2UpOwogICAgICBvdXRWaWV3LnNldFVpbnQzMigxMiwgdGhpcy5oMywgZmFsc2UpOwogICAgICBvdXRWaWV3LnNldFVpbnQzMigxNiwgdGhpcy5oNCwgZmFsc2UpOwogIAogICAgICByZXR1cm4gZW5jb2RpbmcgPyBvdXQudG9TdHJpbmcoZW5jb2RpbmcpIDogb3V0OwogIH07CiAgCiAgU2hhMS5wcm90b3R5cGUucHJvY2Vzc0Jsb2NrID0gZnVuY3Rpb24gcHJvY2Vzc0Jsb2NrKCkgewogICAgICAvLyBFeHRlbmQgdGhlIHNpeHRlZW4gMzItYml0IHdvcmRzIGludG8gZWlnaHR5IDMyLWJpdCB3b3JkczoKICAgICAgZm9yICh2YXIgaSA9IDE2OyBpIDwgODA7IGkrKykgewogICAgICAgIHZhciB3ID0gdGhpcy5ibG9ja1tpIC0gM10gXiB0aGlzLmJsb2NrW2kgLSA4XSBeIHRoaXMuYmxvY2tbaSAtIDE0XSBeIHRoaXMuYmxvY2tbaSAtIDE2XTsKICAgICAgICB0aGlzLmJsb2NrW2ldID0gKHcgPDwgMSkgfCAodyA+Pj4gMzEpOwogICAgICB9CiAgCiAgICAgIC8vIEluaXRpYWxpemUgaGFzaCB2YWx1ZSBmb3IgdGhpcyBjaHVuazoKICAgICAgdmFyIGEgPSB0aGlzLmgwOwogICAgICB2YXIgYiA9IHRoaXMuaDE7CiAgICAgIHZhciBjID0gdGhpcy5oMjsKICAgICAgdmFyIGQgPSB0aGlzLmgzOwogICAgICB2YXIgZSA9IHRoaXMuaDQ7CiAgICAgIHZhciBmLCBrOwogIAogICAgICAvLyBNYWluIGxvb3A6CiAgICAgIGZvciAoaSA9IDA7IGkgPCA4MDsgaSsrKSB7CiAgICAgICAgaWYgKGkgPCAyMCkgewogICAgICAgICAgZiA9IGQgXiAoYiAmIChjIF4gZCkpOwogICAgICAgICAgayA9IDB4NUE4Mjc5OTk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGkgPCA0MCkgewogICAgICAgICAgZiA9IGIgXiBjIF4gZDsKICAgICAgICAgIGsgPSAweDZFRDlFQkExOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChpIDwgNjApIHsKICAgICAgICAgIGYgPSAoYiAmIGMpIHwgKGQgJiAoYiB8IGMpKTsKICAgICAgICAgIGsgPSAweDhGMUJCQ0RDOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgIGYgPSBiIF4gYyBeIGQ7CiAgICAgICAgICBrID0gMHhDQTYyQzFENjsKICAgICAgICB9CiAgICAgICAgdmFyIHRlbXAgPSAoYSA8PCA1IHwgYSA+Pj4gMjcpICsgZiArIGUgKyBrICsgKHRoaXMuYmxvY2tbaV18MCk7CiAgICAgICAgZSA9IGQ7CiAgICAgICAgZCA9IGM7CiAgICAgICAgYyA9IChiIDw8IDMwIHwgYiA+Pj4gMik7CiAgICAgICAgYiA9IGE7CiAgICAgICAgYSA9IHRlbXA7CiAgICAgIH0KICAKICAgICAgLy8gQWRkIHRoaXMgY2h1bmsncyBoYXNoIHRvIHJlc3VsdCBzbyBmYXI6CiAgICAgIHRoaXMuaDAgPSAodGhpcy5oMCArIGEpIHwgMDsKICAgICAgdGhpcy5oMSA9ICh0aGlzLmgxICsgYikgfCAwOwogICAgICB0aGlzLmgyID0gKHRoaXMuaDIgKyBjKSB8IDA7CiAgICAgIHRoaXMuaDMgPSAodGhpcy5oMyArIGQpIHwgMDsKICAgICAgdGhpcy5oNCA9ICh0aGlzLmg0ICsgZSkgfCAwOwogIAogICAgICAvLyBUaGUgYmxvY2sgaXMgbm93IHJldXNhYmxlLgogICAgICB0aGlzLm9mZnNldCA9IDA7CiAgICAgIGZvciAoaSA9IDA7IGkgPCAxNjsgaSsrKSB7CiAgICAgICAgICB0aGlzLmJsb2NrW2ldID0gMDsKICAgICAgfQogIH07CiAgCiAgfSx7Ii4vYnJvd3Nlckhhc2hVdGlscyI6MTEsImJ1ZmZlci8iOjgwfV0sMTU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwogIHZhciBoYXNoVXRpbHMgPSByZXF1aXJlKCcuL2Jyb3dzZXJIYXNoVXRpbHMnKTsKICAKICB2YXIgQkxPQ0tfU0laRSA9IDY0OwogIAogIHZhciBESUdFU1RfTEVOR1RIID0gMzI7CiAgCiAgdmFyIEtFWSA9IG5ldyBVaW50MzJBcnJheShbCiAgICAgIDB4NDI4YTJmOTgsCiAgICAgIDB4NzEzNzQ0OTEsCiAgICAgIDB4YjVjMGZiY2YsCiAgICAgIDB4ZTliNWRiYTUsCiAgICAgIDB4Mzk1NmMyNWIsCiAgICAgIDB4NTlmMTExZjEsCiAgICAgIDB4OTIzZjgyYTQsCiAgICAgIDB4YWIxYzVlZDUsCiAgICAgIDB4ZDgwN2FhOTgsCiAgICAgIDB4MTI4MzViMDEsCiAgICAgIDB4MjQzMTg1YmUsCiAgICAgIDB4NTUwYzdkYzMsCiAgICAgIDB4NzJiZTVkNzQsCiAgICAgIDB4ODBkZWIxZmUsCiAgICAgIDB4OWJkYzA2YTcsCiAgICAgIDB4YzE5YmYxNzQsCiAgICAgIDB4ZTQ5YjY5YzEsCiAgICAgIDB4ZWZiZTQ3ODYsCiAgICAgIDB4MGZjMTlkYzYsCiAgICAgIDB4MjQwY2ExY2MsCiAgICAgIDB4MmRlOTJjNmYsCiAgICAgIDB4NGE3NDg0YWEsCiAgICAgIDB4NWNiMGE5ZGMsCiAgICAgIDB4NzZmOTg4ZGEsCiAgICAgIDB4OTgzZTUxNTIsCiAgICAgIDB4YTgzMWM2NmQsCiAgICAgIDB4YjAwMzI3YzgsCiAgICAgIDB4YmY1OTdmYzcsCiAgICAgIDB4YzZlMDBiZjMsCiAgICAgIDB4ZDVhNzkxNDcsCiAgICAgIDB4MDZjYTYzNTEsCiAgICAgIDB4MTQyOTI5NjcsCiAgICAgIDB4MjdiNzBhODUsCiAgICAgIDB4MmUxYjIxMzgsCiAgICAgIDB4NGQyYzZkZmMsCiAgICAgIDB4NTMzODBkMTMsCiAgICAgIDB4NjUwYTczNTQsCiAgICAgIDB4NzY2YTBhYmIsCiAgICAgIDB4ODFjMmM5MmUsCiAgICAgIDB4OTI3MjJjODUsCiAgICAgIDB4YTJiZmU4YTEsCiAgICAgIDB4YTgxYTY2NGIsCiAgICAgIDB4YzI0YjhiNzAsCiAgICAgIDB4Yzc2YzUxYTMsCiAgICAgIDB4ZDE5MmU4MTksCiAgICAgIDB4ZDY5OTA2MjQsCiAgICAgIDB4ZjQwZTM1ODUsCiAgICAgIDB4MTA2YWEwNzAsCiAgICAgIDB4MTlhNGMxMTYsCiAgICAgIDB4MWUzNzZjMDgsCiAgICAgIDB4Mjc0ODc3NGMsCiAgICAgIDB4MzRiMGJjYjUsCiAgICAgIDB4MzkxYzBjYjMsCiAgICAgIDB4NGVkOGFhNGEsCiAgICAgIDB4NWI5Y2NhNGYsCiAgICAgIDB4NjgyZTZmZjMsCiAgICAgIDB4NzQ4ZjgyZWUsCiAgICAgIDB4NzhhNTYzNmYsCiAgICAgIDB4ODRjODc4MTQsCiAgICAgIDB4OGNjNzAyMDgsCiAgICAgIDB4OTBiZWZmZmEsCiAgICAgIDB4YTQ1MDZjZWIsCiAgICAgIDB4YmVmOWEzZjcsCiAgICAgIDB4YzY3MTc4ZjIKICBdKTsKICAKICB2YXIgSU5JVCA9IFsKICAgICAgMHg2YTA5ZTY2NywKICAgICAgMHhiYjY3YWU4NSwKICAgICAgMHgzYzZlZjM3MiwKICAgICAgMHhhNTRmZjUzYSwKICAgICAgMHg1MTBlNTI3ZiwKICAgICAgMHg5YjA1Njg4YywKICAgICAgMHgxZjgzZDlhYiwKICAgICAgMHg1YmUwY2QxOSwKICBdOwogIAogIHZhciBNQVhfSEFTSEFCTEVfTEVOR1RIID0gTWF0aC5wb3coMiwgNTMpIC0gMTsKICAKICAvKioKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIFNoYTI1NigpIHsKICAgICAgdGhpcy5zdGF0ZSA9IFsKICAgICAgICAgIDB4NmEwOWU2NjcsCiAgICAgICAgICAweGJiNjdhZTg1LAogICAgICAgICAgMHgzYzZlZjM3MiwKICAgICAgICAgIDB4YTU0ZmY1M2EsCiAgICAgICAgICAweDUxMGU1MjdmLAogICAgICAgICAgMHg5YjA1Njg4YywKICAgICAgICAgIDB4MWY4M2Q5YWIsCiAgICAgICAgICAweDViZTBjZDE5LAogICAgICBdOwogICAgICB0aGlzLnRlbXAgPSBuZXcgSW50MzJBcnJheSg2NCk7CiAgICAgIHRoaXMuYnVmZmVyID0gbmV3IFVpbnQ4QXJyYXkoNjQpOwogICAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICAgIHRoaXMuYnl0ZXNIYXNoZWQgPSAwOwogICAgICAvKioKICAgICAgICogQHByaXZhdGUKICAgICAgICovCiAgICAgIHRoaXMuZmluaXNoZWQgPSBmYWxzZTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gU2hhMjU2OwogIAogIFNoYTI1Ni5CTE9DS19TSVpFID0gQkxPQ0tfU0laRTsKICAKICBTaGEyNTYucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGlmICh0aGlzLmZpbmlzaGVkKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F0dGVtcHRlZCB0byB1cGRhdGUgYW4gYWxyZWFkeSBmaW5pc2hlZCBoYXNoLicpOwogICAgICB9CiAgCiAgICAgIGlmIChoYXNoVXRpbHMuaXNFbXB0eURhdGEoZGF0YSkpIHsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgCiAgICAgIGRhdGEgPSBoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKGRhdGEpOwogIAogICAgICB2YXIgcG9zaXRpb24gPSAwOwogICAgICB2YXIgYnl0ZUxlbmd0aCA9IGRhdGEuYnl0ZUxlbmd0aDsKICAgICAgdGhpcy5ieXRlc0hhc2hlZCArPSBieXRlTGVuZ3RoOwogICAgICBpZiAodGhpcy5ieXRlc0hhc2hlZCAqIDggPiBNQVhfSEFTSEFCTEVfTEVOR1RIKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBoYXNoIG1vcmUgdGhhbiAyXjUzIC0gMSBiaXRzJyk7CiAgICAgIH0KICAKICAgICAgd2hpbGUgKGJ5dGVMZW5ndGggPiAwKSB7CiAgICAgICAgICB0aGlzLmJ1ZmZlclt0aGlzLmJ1ZmZlckxlbmd0aCsrXSA9IGRhdGFbcG9zaXRpb24rK107CiAgICAgICAgICBieXRlTGVuZ3RoLS07CiAgICAgICAgICBpZiAodGhpcy5idWZmZXJMZW5ndGggPT09IEJMT0NLX1NJWkUpIHsKICAgICAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgICAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICAgICAgICB9CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBTaGEyNTYucHJvdG90eXBlLmRpZ2VzdCA9IGZ1bmN0aW9uIChlbmNvZGluZykgewogICAgICBpZiAoIXRoaXMuZmluaXNoZWQpIHsKICAgICAgICAgIHZhciBiaXRzSGFzaGVkID0gdGhpcy5ieXRlc0hhc2hlZCAqIDg7CiAgICAgICAgICB2YXIgYnVmZmVyVmlldyA9IG5ldyBEYXRhVmlldyh0aGlzLmJ1ZmZlci5idWZmZXIsIHRoaXMuYnVmZmVyLmJ5dGVPZmZzZXQsIHRoaXMuYnVmZmVyLmJ5dGVMZW5ndGgpOwogICAgICAgICAgdmFyIHVuZGVjb3JhdGVkTGVuZ3RoID0gdGhpcy5idWZmZXJMZW5ndGg7CiAgICAgICAgICBidWZmZXJWaWV3LnNldFVpbnQ4KHRoaXMuYnVmZmVyTGVuZ3RoKyssIDB4ODApOwogICAgICAgICAgLy8gRW5zdXJlIHRoZSBmaW5hbCBibG9jayBoYXMgZW5vdWdoIHJvb20gZm9yIHRoZSBoYXNoZWQgbGVuZ3RoCiAgICAgICAgICBpZiAodW5kZWNvcmF0ZWRMZW5ndGggJSBCTE9DS19TSVpFID49IEJMT0NLX1NJWkUgLSA4KSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuYnVmZmVyTGVuZ3RoOyBpIDwgQkxPQ0tfU0laRTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlclZpZXcuc2V0VWludDgoaSwgMCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuaGFzaEJ1ZmZlcigpOwogICAgICAgICAgICAgIHRoaXMuYnVmZmVyTGVuZ3RoID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmJ1ZmZlckxlbmd0aDsgaSA8IEJMT0NLX1NJWkUgLSA4OyBpKyspIHsKICAgICAgICAgICAgICBidWZmZXJWaWV3LnNldFVpbnQ4KGksIDApOwogICAgICAgICAgfQogICAgICAgICAgYnVmZmVyVmlldy5zZXRVaW50MzIoQkxPQ0tfU0laRSAtIDgsIE1hdGguZmxvb3IoYml0c0hhc2hlZCAvIDB4MTAwMDAwMDAwKSwgdHJ1ZSk7CiAgICAgICAgICBidWZmZXJWaWV3LnNldFVpbnQzMihCTE9DS19TSVpFIC0gNCwgYml0c0hhc2hlZCk7CiAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgIHRoaXMuZmluaXNoZWQgPSB0cnVlOwogICAgICB9CiAgICAgIC8vIFRoZSB2YWx1ZSBpbiBzdGF0ZSBpcyBsaXR0bGUtZW5kaWFuIHJhdGhlciB0aGFuIGJpZy1lbmRpYW4sIHNvIGZsaXAKICAgICAgLy8gZWFjaCB3b3JkIGludG8gYSBuZXcgVWludDhBcnJheQogICAgICB2YXIgb3V0ID0gbmV3IEJ1ZmZlcihESUdFU1RfTEVOR1RIKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCA4OyBpKyspIHsKICAgICAgICAgIG91dFtpICogNF0gPSAodGhpcy5zdGF0ZVtpXSA+Pj4gMjQpICYgMHhmZjsKICAgICAgICAgIG91dFtpICogNCArIDFdID0gKHRoaXMuc3RhdGVbaV0gPj4+IDE2KSAmIDB4ZmY7CiAgICAgICAgICBvdXRbaSAqIDQgKyAyXSA9ICh0aGlzLnN0YXRlW2ldID4+PiA4KSAmIDB4ZmY7CiAgICAgICAgICBvdXRbaSAqIDQgKyAzXSA9ICh0aGlzLnN0YXRlW2ldID4+PiAwKSAmIDB4ZmY7CiAgICAgIH0KICAgICAgcmV0dXJuIGVuY29kaW5nID8gb3V0LnRvU3RyaW5nKGVuY29kaW5nKSA6IG91dDsKICB9OwogIAogIFNoYTI1Ni5wcm90b3R5cGUuaGFzaEJ1ZmZlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9hID0gdGhpcywKICAgICAgICAgIGJ1ZmZlciA9IF9hLmJ1ZmZlciwKICAgICAgICAgIHN0YXRlID0gX2Euc3RhdGU7CiAgICAgIHZhciBzdGF0ZTAgPSBzdGF0ZVswXSwKICAgICAgICAgIHN0YXRlMSA9IHN0YXRlWzFdLAogICAgICAgICAgc3RhdGUyID0gc3RhdGVbMl0sCiAgICAgICAgICBzdGF0ZTMgPSBzdGF0ZVszXSwKICAgICAgICAgIHN0YXRlNCA9IHN0YXRlWzRdLAogICAgICAgICAgc3RhdGU1ID0gc3RhdGVbNV0sCiAgICAgICAgICBzdGF0ZTYgPSBzdGF0ZVs2XSwKICAgICAgICAgIHN0YXRlNyA9IHN0YXRlWzddOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IEJMT0NLX1NJWkU7IGkrKykgewogICAgICAgICAgaWYgKGkgPCAxNikgewogICAgICAgICAgICAgIHRoaXMudGVtcFtpXSA9ICgoKGJ1ZmZlcltpICogNF0gJiAweGZmKSA8PCAyNCkgfAogICAgICAgICAgICAgICAgICAoKGJ1ZmZlclsoaSAqIDQpICsgMV0gJiAweGZmKSA8PCAxNikgfAogICAgICAgICAgICAgICAgICAoKGJ1ZmZlclsoaSAqIDQpICsgMl0gJiAweGZmKSA8PCA4KSB8CiAgICAgICAgICAgICAgICAgIChidWZmZXJbKGkgKiA0KSArIDNdICYgMHhmZikpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHUgPSB0aGlzLnRlbXBbaSAtIDJdOwogICAgICAgICAgICAgIHZhciB0MV8xID0gKHUgPj4+IDE3IHwgdSA8PCAxNSkgXgogICAgICAgICAgICAgICAgICAodSA+Pj4gMTkgfCB1IDw8IDEzKSBeCiAgICAgICAgICAgICAgICAgICh1ID4+PiAxMCk7CiAgICAgICAgICAgICAgdSA9IHRoaXMudGVtcFtpIC0gMTVdOwogICAgICAgICAgICAgIHZhciB0Ml8xID0gKHUgPj4+IDcgfCB1IDw8IDI1KSBeCiAgICAgICAgICAgICAgICAgICh1ID4+PiAxOCB8IHUgPDwgMTQpIF4KICAgICAgICAgICAgICAgICAgKHUgPj4+IDMpOwogICAgICAgICAgICAgIHRoaXMudGVtcFtpXSA9ICh0MV8xICsgdGhpcy50ZW1wW2kgLSA3XSB8IDApICsKICAgICAgICAgICAgICAgICAgKHQyXzEgKyB0aGlzLnRlbXBbaSAtIDE2XSB8IDApOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHQxID0gKCgoKChzdGF0ZTQgPj4+IDYgfCBzdGF0ZTQgPDwgMjYpIF4KICAgICAgICAgICAgICAoc3RhdGU0ID4+PiAxMSB8IHN0YXRlNCA8PCAyMSkgXgogICAgICAgICAgICAgIChzdGF0ZTQgPj4+IDI1IHwgc3RhdGU0IDw8IDcpKQogICAgICAgICAgICAgICsgKChzdGF0ZTQgJiBzdGF0ZTUpIF4gKH5zdGF0ZTQgJiBzdGF0ZTYpKSkgfCAwKQogICAgICAgICAgICAgICsgKChzdGF0ZTcgKyAoKEtFWVtpXSArIHRoaXMudGVtcFtpXSkgfCAwKSkgfCAwKSkgfCAwOwogICAgICAgICAgdmFyIHQyID0gKCgoc3RhdGUwID4+PiAyIHwgc3RhdGUwIDw8IDMwKSBeCiAgICAgICAgICAgICAgKHN0YXRlMCA+Pj4gMTMgfCBzdGF0ZTAgPDwgMTkpIF4KICAgICAgICAgICAgICAoc3RhdGUwID4+PiAyMiB8IHN0YXRlMCA8PCAxMCkpICsgKChzdGF0ZTAgJiBzdGF0ZTEpIF4gKHN0YXRlMCAmIHN0YXRlMikgXiAoc3RhdGUxICYgc3RhdGUyKSkpIHwgMDsKICAgICAgICAgIHN0YXRlNyA9IHN0YXRlNjsKICAgICAgICAgIHN0YXRlNiA9IHN0YXRlNTsKICAgICAgICAgIHN0YXRlNSA9IHN0YXRlNDsKICAgICAgICAgIHN0YXRlNCA9IChzdGF0ZTMgKyB0MSkgfCAwOwogICAgICAgICAgc3RhdGUzID0gc3RhdGUyOwogICAgICAgICAgc3RhdGUyID0gc3RhdGUxOwogICAgICAgICAgc3RhdGUxID0gc3RhdGUwOwogICAgICAgICAgc3RhdGUwID0gKHQxICsgdDIpIHwgMDsKICAgICAgfQogICAgICBzdGF0ZVswXSArPSBzdGF0ZTA7CiAgICAgIHN0YXRlWzFdICs9IHN0YXRlMTsKICAgICAgc3RhdGVbMl0gKz0gc3RhdGUyOwogICAgICBzdGF0ZVszXSArPSBzdGF0ZTM7CiAgICAgIHN0YXRlWzRdICs9IHN0YXRlNDsKICAgICAgc3RhdGVbNV0gKz0gc3RhdGU1OwogICAgICBzdGF0ZVs2XSArPSBzdGF0ZTY7CiAgICAgIHN0YXRlWzddICs9IHN0YXRlNzsKICB9OwogIAogIH0seyIuL2Jyb3dzZXJIYXNoVXRpbHMiOjExLCJidWZmZXIvIjo4MH1dLDE2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKHByb2Nlc3MpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7CiAgCiAgLy8gYnJvd3NlciBzcGVjaWZpYyBtb2R1bGVzCiAgdXRpbC5jcnlwdG8ubGliID0gcmVxdWlyZSgnLi9icm93c2VyQ3J5cHRvTGliJyk7CiAgdXRpbC5CdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwogIHV0aWwudXJsID0gcmVxdWlyZSgndXJsLycpOwogIHV0aWwucXVlcnlzdHJpbmcgPSByZXF1aXJlKCdxdWVyeXN0cmluZy8nKTsKICB1dGlsLnJlYWxDbG9jayA9IHJlcXVpcmUoJy4vcmVhbGNsb2NrL2Jyb3dzZXJDbG9jaycpOwogIHV0aWwuZW52aXJvbm1lbnQgPSAnanMnOwogIHV0aWwuY3JlYXRlRXZlbnRTdHJlYW0gPSByZXF1aXJlKCcuL2V2ZW50LXN0cmVhbS9idWZmZXJlZC1jcmVhdGUtZXZlbnQtc3RyZWFtJykuY3JlYXRlRXZlbnRTdHJlYW07CiAgdXRpbC5pc0Jyb3dzZXIgPSBmdW5jdGlvbigpIHsgcmV0dXJuIHRydWU7IH07CiAgdXRpbC5pc05vZGUgPSBmdW5jdGlvbigpIHsgcmV0dXJuIGZhbHNlOyB9OwogIAogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUzsKICAKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscy9jcmVkZW50aWFsX3Byb3ZpZGVyX2NoYWluJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscy90ZW1wb3JhcnlfY3JlZGVudGlhbHMnKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzL2NoYWluYWJsZV90ZW1wb3JhcnlfY3JlZGVudGlhbHMnKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzL3dlYl9pZGVudGl0eV9jcmVkZW50aWFscycpOwogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMvY29nbml0b19pZGVudGl0eV9jcmVkZW50aWFscycpOwogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMvc2FtbF9jcmVkZW50aWFscycpOwogIAogIC8vIExvYWQgdGhlIERPTVBhcnNlciBYTUwgcGFyc2VyCiAgQVdTLlhNTC5QYXJzZXIgPSByZXF1aXJlKCcuL3htbC9icm93c2VyX3BhcnNlcicpOwogIAogIC8vIExvYWQgdGhlIFhIUiBIdHRwQ2xpZW50CiAgcmVxdWlyZSgnLi9odHRwL3hocicpOwogIAogIGlmICh0eXBlb2YgcHJvY2VzcyA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgIHZhciBwcm9jZXNzID0gewogICAgICBicm93c2VyOiB0cnVlCiAgICB9OwogIH0KICAKICB9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKICB9LHsiLi9icm93c2VyQ3J5cHRvTGliIjoxMCwiLi9jb3JlIjoxOCwiLi9jcmVkZW50aWFscyI6MTksIi4vY3JlZGVudGlhbHMvY2hhaW5hYmxlX3RlbXBvcmFyeV9jcmVkZW50aWFscyI6MjAsIi4vY3JlZGVudGlhbHMvY29nbml0b19pZGVudGl0eV9jcmVkZW50aWFscyI6MjEsIi4vY3JlZGVudGlhbHMvY3JlZGVudGlhbF9wcm92aWRlcl9jaGFpbiI6MjIsIi4vY3JlZGVudGlhbHMvc2FtbF9jcmVkZW50aWFscyI6MjMsIi4vY3JlZGVudGlhbHMvdGVtcG9yYXJ5X2NyZWRlbnRpYWxzIjoyNCwiLi9jcmVkZW50aWFscy93ZWJfaWRlbnRpdHlfY3JlZGVudGlhbHMiOjI1LCIuL2V2ZW50LXN0cmVhbS9idWZmZXJlZC1jcmVhdGUtZXZlbnQtc3RyZWFtIjoyNywiLi9odHRwL3hociI6MzUsIi4vcmVhbGNsb2NrL2Jyb3dzZXJDbG9jayI6NTIsIi4vdXRpbCI6NzEsIi4veG1sL2Jyb3dzZXJfcGFyc2VyIjo3MiwiX3Byb2Nlc3MiOjg1LCJidWZmZXIvIjo4MCwicXVlcnlzdHJpbmcvIjo5MiwidXJsLyI6OTR9XSwxNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMnKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzL2NyZWRlbnRpYWxfcHJvdmlkZXJfY2hhaW4nKTsKICB2YXIgUHJvbWlzZXNEZXBlbmRlbmN5OwogIAogIC8qKgogICAqIFRoZSBtYWluIGNvbmZpZ3VyYXRpb24gY2xhc3MgdXNlZCBieSBhbGwgc2VydmljZSBvYmplY3RzIHRvIHNldAogICAqIHRoZSByZWdpb24sIGNyZWRlbnRpYWxzLCBhbmQgb3RoZXIgb3B0aW9ucyBmb3IgcmVxdWVzdHMuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBjcmVkZW50aWFscyBhbmQgcmVnaW9uIHNldHRpbmdzIGFyZSBsZWZ0IHVuY29uZmlndXJlZC4KICAgKiBUaGlzIHNob3VsZCBiZSBjb25maWd1cmVkIGJ5IHRoZSBhcHBsaWNhdGlvbiBiZWZvcmUgdXNpbmcgYW55CiAgICogQVdTIHNlcnZpY2UgQVBJcy4KICAgKgogICAqIEluIG9yZGVyIHRvIHNldCBnbG9iYWwgY29uZmlndXJhdGlvbiBvcHRpb25zLCBwcm9wZXJ0aWVzIHNob3VsZAogICAqIGJlIGFzc2lnbmVkIHRvIHRoZSBnbG9iYWwge0FXUy5jb25maWd9IG9iamVjdC4KICAgKgogICAqIEBzZWUgQVdTLmNvbmZpZwogICAqCiAgICogQCFncm91cCBHZW5lcmFsIENvbmZpZ3VyYXRpb24gT3B0aW9ucwogICAqCiAgICogQCFhdHRyaWJ1dGUgY3JlZGVudGlhbHMKICAgKiAgIEByZXR1cm4gW0FXUy5DcmVkZW50aWFsc10gdGhlIEFXUyBjcmVkZW50aWFscyB0byBzaWduIHJlcXVlc3RzIHdpdGguCiAgICoKICAgKiBAIWF0dHJpYnV0ZSByZWdpb24KICAgKiAgIEBleGFtcGxlIFNldCB0aGUgZ2xvYmFsIHJlZ2lvbiBzZXR0aW5nIHRvIHVzLXdlc3QtMgogICAqICAgICBBV1MuY29uZmlnLnVwZGF0ZSh7cmVnaW9uOiAndXMtd2VzdC0yJ30pOwogICAqICAgQHJldHVybiBbQVdTLkNyZWRlbnRpYWxzXSBUaGUgcmVnaW9uIHRvIHNlbmQgc2VydmljZSByZXF1ZXN0cyB0by4KICAgKiAgIEBzZWUgaHR0cDovL2RvY3MuYW1hem9ud2Vic2VydmljZXMuY29tL2dlbmVyYWwvbGF0ZXN0L2dyL3JhbmRlLmh0bWwKICAgKiAgICAgQSBsaXN0IG9mIGF2YWlsYWJsZSBlbmRwb2ludHMgZm9yIGVhY2ggQVdTIHNlcnZpY2UKICAgKgogICAqIEAhYXR0cmlidXRlIG1heFJldHJpZXMKICAgKiAgIEByZXR1cm4gW0ludGVnZXJdIHRoZSBtYXhpbXVtIGFtb3VudCBvZiByZXRyaWVzIHRvIHBlcmZvcm0gZm9yIGEKICAgKiAgICAgc2VydmljZSByZXF1ZXN0LiBCeSBkZWZhdWx0IHRoaXMgdmFsdWUgaXMgY2FsY3VsYXRlZCBieSB0aGUgc3BlY2lmaWMKICAgKiAgICAgc2VydmljZSBvYmplY3QgdGhhdCB0aGUgcmVxdWVzdCBpcyBiZWluZyBtYWRlIHRvLgogICAqCiAgICogQCFhdHRyaWJ1dGUgbWF4UmVkaXJlY3RzCiAgICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbWF4aW11bSBhbW91bnQgb2YgcmVkaXJlY3RzIHRvIGZvbGxvdyBmb3IgYQogICAqICAgICBzZXJ2aWNlIHJlcXVlc3QuIERlZmF1bHRzIHRvIDEwLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcGFyYW1WYWxpZGF0aW9uCiAgICogICBAcmV0dXJuIFtCb29sZWFufG1hcF0gd2hldGhlciBpbnB1dCBwYXJhbWV0ZXJzIHNob3VsZCBiZSB2YWxpZGF0ZWQgYWdhaW5zdAogICAqICAgICB0aGUgb3BlcmF0aW9uIGRlc2NyaXB0aW9uIGJlZm9yZSBzZW5kaW5nIHRoZSByZXF1ZXN0LiBEZWZhdWx0cyB0byB0cnVlLgogICAqICAgICBQYXNzIGEgbWFwIHRvIGVuYWJsZSBhbnkgb2YgdGhlIGZvbGxvd2luZyBzcGVjaWZpYyB2YWxpZGF0aW9uIGZlYXR1cmVzOgogICAqCiAgICogICAgICogKiptaW4qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHZhbHVlIG1lZXRzIHRoZSBtaW4KICAgKiAgICAgICBjb25zdHJhaW50LiBUaGlzIGlzIGVuYWJsZWQgYnkgZGVmYXVsdCB3aGVuIHBhcmFtVmFsaWRhdGlvbiBpcyBzZXQKICAgKiAgICAgICB0byBgdHJ1ZWAuCiAgICogICAgICogKiptYXgqKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHZhbHVlIG1lZXRzIHRoZSBtYXgKICAgKiAgICAgICBjb25zdHJhaW50LgogICAqICAgICAqICoqcGF0dGVybioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgYQogICAqICAgICAgIHJlZ3VsYXIgZXhwcmVzc2lvbi4KICAgKiAgICAgKiAqKmVudW0qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIG9uZQogICAqICAgICAgIG9mIHRoZSBhbGxvd2FibGUgZW51bSB2YWx1ZXMuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBjb21wdXRlQ2hlY2tzdW1zCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIGNvbXB1dGUgY2hlY2tzdW1zIGZvciBwYXlsb2FkIGJvZGllcyB3aGVuCiAgICogICAgIHRoZSBzZXJ2aWNlIGFjY2VwdHMgaXQgKGN1cnJlbnRseSBzdXBwb3J0ZWQgaW4gUzMgb25seSkuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBjb252ZXJ0UmVzcG9uc2VUeXBlcwogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0eXBlcyBhcmUgY29udmVydGVkIHdoZW4gcGFyc2luZyByZXNwb25zZSBkYXRhLgogICAqICAgICBDdXJyZW50bHkgb25seSBzdXBwb3J0ZWQgZm9yIEpTT04gYmFzZWQgc2VydmljZXMuIFR1cm5pbmcgdGhpcyBvZmYgbWF5CiAgICogICAgIGltcHJvdmUgcGVyZm9ybWFuY2Ugb24gbGFyZ2UgcmVzcG9uc2UgcGF5bG9hZHMuIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgKgogICAqIEAhYXR0cmlidXRlIGNvcnJlY3RDbG9ja1NrZXcKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gYXBwbHkgYSBjbG9jayBza2V3IGNvcnJlY3Rpb24gYW5kIHJldHJ5CiAgICogICAgIHJlcXVlc3RzIHRoYXQgZmFpbCBiZWNhdXNlIG9mIGFuIHNrZXdlZCBjbGllbnQgY2xvY2suIERlZmF1bHRzIHRvCiAgICogICAgIGBmYWxzZWAuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzc2xFbmFibGVkCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIFNTTCBpcyBlbmFibGVkIGZvciByZXF1ZXN0cwogICAqCiAgICogQCFhdHRyaWJ1dGUgczNGb3JjZVBhdGhTdHlsZQogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBmb3JjZSBwYXRoIHN0eWxlIFVSTHMgZm9yIFMzIG9iamVjdHMKICAgKgogICAqIEAhYXR0cmlidXRlIHMzQnVja2V0RW5kcG9pbnQKICAgKiAgIEBub3RlIFNldHRpbmcgdGhpcyBjb25maWd1cmF0aW9uIG9wdGlvbiByZXF1aXJlcyBhbiBgZW5kcG9pbnRgIHRvIGJlCiAgICogICAgIHByb3ZpZGVkIGV4cGxpY2l0bHkgdG8gdGhlIHNlcnZpY2UgY29uc3RydWN0b3IuCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBwcm92aWRlZCBlbmRwb2ludCBhZGRyZXNzZXMgYW4gaW5kaXZpZHVhbAogICAqICAgICBidWNrZXQgKGZhbHNlIGlmIGl0IGFkZHJlc3NlcyB0aGUgcm9vdCBBUEkgZW5kcG9pbnQpLgogICAqCiAgICogQCFhdHRyaWJ1dGUgczNEaXNhYmxlQm9keVNpZ25pbmcKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gZGlzYWJsZSBTMyBib2R5IHNpZ25pbmcgd2hlbiB1c2luZyBzaWduYXR1cmUgdmVyc2lvbiBgdjRgLgogICAqICAgICBCb2R5IHNpZ25pbmcgY2FuIG9ubHkgYmUgZGlzYWJsZWQgd2hlbiB1c2luZyBodHRwcy4gRGVmYXVsdHMgdG8gYHRydWVgLgogICAqCiAgICogQCFhdHRyaWJ1dGUgdXNlQWNjZWxlcmF0ZUVuZHBvaW50CiAgICogICBAbm90ZSBUaGlzIGNvbmZpZ3VyYXRpb24gb3B0aW9uIGlzIG9ubHkgY29tcGF0aWJsZSB3aXRoIFMzIHdoaWxlIGFjY2Vzc2luZwogICAqICAgICBkbnMtY29tcGF0aWJsZSBidWNrZXRzLgogICAqICAgQHJldHVybiBbQm9vbGVhbl0gV2hldGhlciB0byB1c2UgdGhlIEFjY2VsZXJhdGUgZW5kcG9pbnQgd2l0aCB0aGUgUzMgc2VydmljZS4KICAgKiAgICAgRGVmYXVsdHMgdG8gYGZhbHNlYC4KICAgKgogICAqIEAhYXR0cmlidXRlIHJldHJ5RGVsYXlPcHRpb25zCiAgICogICBAZXhhbXBsZSBTZXQgdGhlIGJhc2UgcmV0cnkgZGVsYXkgZm9yIGFsbCBzZXJ2aWNlcyB0byAzMDAgbXMKICAgKiAgICAgQVdTLmNvbmZpZy51cGRhdGUoe3JldHJ5RGVsYXlPcHRpb25zOiB7YmFzZTogMzAwfX0pOwogICAqICAgICAvLyBEZWxheXMgd2l0aCBtYXhSZXRyaWVzID0gMzogMzAwLCA2MDAsIDEyMDAKICAgKiAgIEBleGFtcGxlIFNldCBhIGN1c3RvbSBiYWNrb2ZmIGZ1bmN0aW9uIHRvIHByb3ZpZGUgZGVsYXkgdmFsdWVzIG9uIHJldHJpZXMKICAgKiAgICAgQVdTLmNvbmZpZy51cGRhdGUoe3JldHJ5RGVsYXlPcHRpb25zOiB7Y3VzdG9tQmFja29mZjogZnVuY3Rpb24ocmV0cnlDb3VudCkgewogICAqICAgICAgIC8vIHJldHVybnMgZGVsYXkgaW4gbXMKICAgKiAgICAgfX19KTsKICAgKiAgIEByZXR1cm4gW21hcF0gQSBzZXQgb2Ygb3B0aW9ucyB0byBjb25maWd1cmUgdGhlIHJldHJ5IGRlbGF5IG9uIHJldHJ5YWJsZSBlcnJvcnMuCiAgICogICAgIEN1cnJlbnRseSBzdXBwb3J0ZWQgb3B0aW9ucyBhcmU6CiAgICoKICAgKiAgICAgKiAqKmJhc2UqKiBbSW50ZWdlcl0gJm1kYXNoOyBUaGUgYmFzZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHVzZSBpbiB0aGUKICAgKiAgICAgICBleHBvbmVudGlhbCBiYWNrb2ZmIGZvciBvcGVyYXRpb24gcmV0cmllcy4gRGVmYXVsdHMgdG8gMTAwIG1zIGZvciBhbGwgc2VydmljZXMgZXhjZXB0CiAgICogICAgICAgRHluYW1vREIsIHdoZXJlIGl0IGRlZmF1bHRzIHRvIDUwbXMuCiAgICogICAgICogKipjdXN0b21CYWNrb2ZmICoqIFtmdW5jdGlvbl0gJm1kYXNoOyBBIGN1c3RvbSBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgYSByZXRyeSBjb3VudAogICAqICAgICAgIGFuZCByZXR1cm5zIHRoZSBhbW91bnQgb2YgdGltZSB0byBkZWxheSBpbiBtaWxsaXNlY29uZHMuIFRoZSBgYmFzZWAgb3B0aW9uIHdpbGwgYmUKICAgKiAgICAgICBpZ25vcmVkIGlmIHRoaXMgb3B0aW9uIGlzIHN1cHBsaWVkLgogICAqCiAgICogQCFhdHRyaWJ1dGUgaHR0cE9wdGlvbnMKICAgKiAgIEByZXR1cm4gW21hcF0gQSBzZXQgb2Ygb3B0aW9ucyB0byBwYXNzIHRvIHRoZSBsb3ctbGV2ZWwgSFRUUCByZXF1ZXN0LgogICAqICAgICBDdXJyZW50bHkgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogICAqCiAgICogICAgICogKipwcm94eSoqIFtTdHJpbmddICZtZGFzaDsgdGhlIFVSTCB0byBwcm94eSByZXF1ZXN0cyB0aHJvdWdoCiAgICogICAgICogKiphZ2VudCoqIFtodHRwLkFnZW50LCBodHRwcy5BZ2VudF0gJm1kYXNoOyB0aGUgQWdlbnQgb2JqZWN0IHRvIHBlcmZvcm0KICAgKiAgICAgICBIVFRQIHJlcXVlc3RzIHdpdGguIFVzZWQgZm9yIGNvbm5lY3Rpb24gcG9vbGluZy4gTm90ZSB0aGF0IGZvcgogICAqICAgICAgIFNTTCBjb25uZWN0aW9ucywgYSBzcGVjaWFsIEFnZW50IG9iamVjdCBpcyB1c2VkIGluIG9yZGVyIHRvIGVuYWJsZQogICAqICAgICAgIHBlZXIgY2VydGlmaWNhdGUgdmVyaWZpY2F0aW9uLiBUaGlzIGZlYXR1cmUgaXMgb25seSBzdXBwb3J0ZWQgaW4gdGhlCiAgICogICAgICAgTm9kZS5qcyBlbnZpcm9ubWVudC4KICAgKiAgICAgKiAqKmNvbm5lY3RUaW1lb3V0KiogW0ludGVnZXJdICZtZGFzaDsgU2V0cyB0aGUgc29ja2V0IHRvIHRpbWVvdXQgYWZ0ZXIKICAgKiAgICAgICBmYWlsaW5nIHRvIGVzdGFibGlzaCBhIGNvbm5lY3Rpb24gd2l0aCB0aGUgc2VydmVyIGFmdGVyCiAgICogICAgICAgYGNvbm5lY3RUaW1lb3V0YCBtaWxsaXNlY29uZHMuIFRoaXMgdGltZW91dCBoYXMgbm8gZWZmZWN0IG9uY2UgYSBzb2NrZXQKICAgKiAgICAgICBjb25uZWN0aW9uIGhhcyBiZWVuIGVzdGFibGlzaGVkLgogICAqICAgICAqICoqdGltZW91dCoqIFtJbnRlZ2VyXSAmbWRhc2g7IFNldHMgdGhlIHNvY2tldCB0byB0aW1lb3V0IGFmdGVyIHRpbWVvdXQKICAgKiAgICAgICBtaWxsaXNlY29uZHMgb2YgaW5hY3Rpdml0eSBvbiB0aGUgc29ja2V0LiBEZWZhdWx0cyB0byB0d28gbWludXRlcwogICAqICAgICAgICgxMjAwMDApCiAgICogICAgICogKip4aHJBc3luYyoqIFtCb29sZWFuXSAmbWRhc2g7IFdoZXRoZXIgdGhlIFNESyB3aWxsIHNlbmQgYXN5bmNocm9ub3VzCiAgICogICAgICAgSFRUUCByZXF1ZXN0cy4gVXNlZCBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudCBvbmx5LiBTZXQgdG8gZmFsc2UgdG8KICAgKiAgICAgICBzZW5kIHJlcXVlc3RzIHN5bmNocm9ub3VzbHkuIERlZmF1bHRzIHRvIHRydWUgKGFzeW5jIG9uKS4KICAgKiAgICAgKiAqKnhocldpdGhDcmVkZW50aWFscyoqIFtCb29sZWFuXSAmbWRhc2g7IFNldHMgdGhlICJ3aXRoQ3JlZGVudGlhbHMiCiAgICogICAgICAgcHJvcGVydHkgb2YgYW4gWE1MSHR0cFJlcXVlc3Qgb2JqZWN0LiBVc2VkIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50CiAgICogICAgICAgb25seS4gRGVmYXVsdHMgdG8gZmFsc2UuCiAgICogQCFhdHRyaWJ1dGUgbG9nZ2VyCiAgICogICBAcmV0dXJuIFsjd3JpdGUsI2xvZ10gYW4gb2JqZWN0IHRoYXQgcmVzcG9uZHMgdG8gLndyaXRlKCkgKGxpa2UgYSBzdHJlYW0pCiAgICogICAgIG9yIC5sb2coKSAobGlrZSB0aGUgY29uc29sZSBvYmplY3QpIGluIG9yZGVyIHRvIGxvZyBpbmZvcm1hdGlvbiBhYm91dAogICAqICAgICByZXF1ZXN0cwogICAqCiAgICogQCFhdHRyaWJ1dGUgc3lzdGVtQ2xvY2tPZmZzZXQKICAgKiAgIEByZXR1cm4gW051bWJlcl0gYW4gb2Zmc2V0IHZhbHVlIGluIG1pbGxpc2Vjb25kcyB0byBhcHBseSB0byBhbGwgc2lnbmluZwogICAqICAgICB0aW1lcy4gVXNlIHRoaXMgdG8gY29tcGVuc2F0ZSBmb3IgY2xvY2sgc2tldyB3aGVuIHlvdXIgc3lzdGVtIG1heSBiZQogICAqICAgICBvdXQgb2Ygc3luYyB3aXRoIHRoZSBzZXJ2aWNlIHRpbWUuIE5vdGUgdGhhdCB0aGlzIGNvbmZpZ3VyYXRpb24gb3B0aW9uCiAgICogICAgIGNhbiBvbmx5IGJlIGFwcGxpZWQgdG8gdGhlIGdsb2JhbCBgQVdTLmNvbmZpZ2Agb2JqZWN0IGFuZCBjYW5ub3QgYmUKICAgKiAgICAgb3ZlcnJpZGRlbiBpbiBzZXJ2aWNlLXNwZWNpZmljIGNvbmZpZ3VyYXRpb24uIERlZmF1bHRzIHRvIDAgbWlsbGlzZWNvbmRzLgogICAqCiAgICogQCFhdHRyaWJ1dGUgc2lnbmF0dXJlVmVyc2lvbgogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgc2lnbmF0dXJlIHZlcnNpb24gdG8gc2lnbiByZXF1ZXN0cyB3aXRoIChvdmVycmlkaW5nCiAgICogICAgIHRoZSBBUEkgY29uZmlndXJhdGlvbikuIFBvc3NpYmxlIHZhbHVlcyBhcmU6ICd2MicsICd2MycsICd2NCcuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzaWduYXR1cmVDYWNoZQogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0aGUgc2lnbmF0dXJlIHRvIHNpZ24gcmVxdWVzdHMgd2l0aCAob3ZlcnJpZGluZwogICAqICAgICB0aGUgQVBJIGNvbmZpZ3VyYXRpb24pIGlzIGNhY2hlZC4gT25seSBhcHBsaWVzIHRvIHRoZSBzaWduYXR1cmUgdmVyc2lvbiAndjQnLgogICAqICAgICBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWQKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gZW5hYmxlIGVuZHBvaW50IGRpc2NvdmVyeSBmb3Igb3BlcmF0aW9ucyB0aGF0CiAgICogICAgIGFsbG93IG9wdGlvbmFsbHkgdXNpbmcgYW4gZW5kcG9pbnQgcmV0dXJuZWQgYnkgdGhlIHNlcnZpY2UuCiAgICogICAgIERlZmF1bHRzIHRvICdmYWxzZScKICAgKgogICAqIEAhYXR0cmlidXRlIGVuZHBvaW50Q2FjaGVTaXplCiAgICogICBAcmV0dXJuIFtOdW1iZXJdIHRoZSBzaXplIG9mIHRoZSBnbG9iYWwgY2FjaGUgc3RvcmluZyBlbmRwb2ludHMgZnJvbSBlbmRwb2ludAogICAqICAgICBkaXNjb3Zlcnkgb3BlcmF0aW9ucy4gT25jZSBlbmRwb2ludCBjYWNoZSBpcyBjcmVhdGVkLCB1cGRhdGluZyB0aGlzIHNldHRpbmcKICAgKiAgICAgY2Fubm90IGNoYW5nZSBleGlzdGluZyBjYWNoZSBzaXplLgogICAqICAgICBEZWZhdWx0cyB0byAxMDAwCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBob3N0UHJlZml4RW5hYmxlZAogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBtYXJzaGFsIHJlcXVlc3QgcGFyYW1ldGVycyB0byB0aGUgcHJlZml4IG9mCiAgICogICAgIGhvc3RuYW1lLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzdHNSZWdpb25hbEVuZHBvaW50cwogICAqICAgQHJldHVybiBbJ2xlZ2FjeSd8J3JlZ2lvbmFsJ10gd2hldGhlciB0byBzZW5kIHN0cyByZXF1ZXN0IHRvIGdsb2JhbCBlbmRwb2ludHMgb3IKICAgKiAgICAgcmVnaW9uYWwgZW5kcG9pbnRzLgogICAqICAgICBEZWZhdWx0cyB0byAnbGVnYWN5JwogICAqLwogIEFXUy5Db25maWcgPSBBV1MudXRpbC5pbmhlcml0KHsKICAgIC8qKgogICAgICogQCFlbmRncm91cAogICAgICovCiAgCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgY29uZmlndXJhdGlvbiBvYmplY3QuIFRoaXMgaXMgdGhlIG9iamVjdCB0aGF0IHBhc3NlcwogICAgICogb3B0aW9uIGRhdGEgYWxvbmcgdG8gc2VydmljZSByZXF1ZXN0cywgaW5jbHVkaW5nIGNyZWRlbnRpYWxzLCBzZWN1cml0eSwKICAgICAqIHJlZ2lvbiBpbmZvcm1hdGlvbiwgYW5kIHNvbWUgc2VydmljZSBzcGVjaWZpYyBzZXR0aW5ncy4KICAgICAqCiAgICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjb25maWd1cmF0aW9uIG9iamVjdCB3aXRoIGNyZWRlbnRpYWxzIGFuZCByZWdpb24KICAgICAqICAgdmFyIGNvbmZpZyA9IG5ldyBBV1MuQ29uZmlnKHsKICAgICAqICAgICBhY2Nlc3NLZXlJZDogJ0FLSUQnLCBzZWNyZXRBY2Nlc3NLZXk6ICdTRUNSRVQnLCByZWdpb246ICd1cy13ZXN0LTInCiAgICAgKiAgIH0pOwogICAgICogQG9wdGlvbiBvcHRpb25zIGFjY2Vzc0tleUlkIFtTdHJpbmddIHlvdXIgQVdTIGFjY2VzcyBrZXkgSUQuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgc2VjcmV0QWNjZXNzS2V5IFtTdHJpbmddIHlvdXIgQVdTIHNlY3JldCBhY2Nlc3Mga2V5LgogICAgICogQG9wdGlvbiBvcHRpb25zIHNlc3Npb25Ub2tlbiBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgb3B0aW9uYWwgQVdTCiAgICAgKiAgIHNlc3Npb24gdG9rZW4gdG8gc2lnbiByZXF1ZXN0cyB3aXRoLgogICAgICogQG9wdGlvbiBvcHRpb25zIGNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBBV1MgY3JlZGVudGlhbHMKICAgICAqICAgdG8gc2lnbiByZXF1ZXN0cyB3aXRoLiBZb3UgY2FuIGVpdGhlciBzcGVjaWZ5IHRoaXMgb2JqZWN0LCBvcgogICAgICogICBzcGVjaWZ5IHRoZSBhY2Nlc3NLZXlJZCBhbmQgc2VjcmV0QWNjZXNzS2V5IG9wdGlvbnMgZGlyZWN0bHkuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgY3JlZGVudGlhbFByb3ZpZGVyIFtBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW5dIHRoZQogICAgICogICBwcm92aWRlciBjaGFpbiB1c2VkIHRvIHJlc29sdmUgY3JlZGVudGlhbHMgaWYgbm8gc3RhdGljIGBjcmVkZW50aWFsc2AKICAgICAqICAgcHJvcGVydHkgaXMgc2V0LgogICAgICogQG9wdGlvbiBvcHRpb25zIHJlZ2lvbiBbU3RyaW5nXSB0aGUgcmVnaW9uIHRvIHNlbmQgc2VydmljZSByZXF1ZXN0cyB0by4KICAgICAqICAgU2VlIHtyZWdpb259IGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICogQG9wdGlvbiBvcHRpb25zIG1heFJldHJpZXMgW0ludGVnZXJdIHRoZSBtYXhpbXVtIGFtb3VudCBvZiByZXRyaWVzIHRvCiAgICAgKiAgIGF0dGVtcHQgd2l0aCBhIHJlcXVlc3QuIFNlZSB7bWF4UmV0cmllc30gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgbWF4UmVkaXJlY3RzIFtJbnRlZ2VyXSB0aGUgbWF4aW11bSBhbW91bnQgb2YgcmVkaXJlY3RzIHRvCiAgICAgKiAgIGZvbGxvdyB3aXRoIGEgcmVxdWVzdC4gU2VlIHttYXhSZWRpcmVjdHN9IGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICogQG9wdGlvbiBvcHRpb25zIHNzbEVuYWJsZWQgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gZW5hYmxlIFNTTCBmb3IKICAgICAqICAgcmVxdWVzdHMuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgcGFyYW1WYWxpZGF0aW9uIFtCb29sZWFufG1hcF0gd2hldGhlciBpbnB1dCBwYXJhbWV0ZXJzCiAgICAgKiAgIHNob3VsZCBiZSB2YWxpZGF0ZWQgYWdhaW5zdCB0aGUgb3BlcmF0aW9uIGRlc2NyaXB0aW9uIGJlZm9yZSBzZW5kaW5nCiAgICAgKiAgIHRoZSByZXF1ZXN0LiBEZWZhdWx0cyB0byB0cnVlLiBQYXNzIGEgbWFwIHRvIGVuYWJsZSBhbnkgb2YgdGhlCiAgICAgKiAgIGZvbGxvd2luZyBzcGVjaWZpYyB2YWxpZGF0aW9uIGZlYXR1cmVzOgogICAgICoKICAgICAqICAgKiAqKm1pbioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1pbgogICAgICogICAgIGNvbnN0cmFpbnQuIFRoaXMgaXMgZW5hYmxlZCBieSBkZWZhdWx0IHdoZW4gcGFyYW1WYWxpZGF0aW9uIGlzIHNldAogICAgICogICAgIHRvIGB0cnVlYC4KICAgICAqICAgKiAqKm1heCoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1heAogICAgICogICAgIGNvbnN0cmFpbnQuCiAgICAgKiAgICogKipwYXR0ZXJuKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBhCiAgICAgKiAgICAgcmVndWxhciBleHByZXNzaW9uLgogICAgICogICAqICoqZW51bSoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgb25lCiAgICAgKiAgICAgb2YgdGhlIGFsbG93YWJsZSBlbnVtIHZhbHVlcy4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBjb21wdXRlQ2hlY2tzdW1zIFtCb29sZWFuXSB3aGV0aGVyIHRvIGNvbXB1dGUgY2hlY2tzdW1zCiAgICAgKiAgIGZvciBwYXlsb2FkIGJvZGllcyB3aGVuIHRoZSBzZXJ2aWNlIGFjY2VwdHMgaXQgKGN1cnJlbnRseSBzdXBwb3J0ZWQKICAgICAqICAgaW4gUzMgb25seSkKICAgICAqIEBvcHRpb24gb3B0aW9ucyBjb252ZXJ0UmVzcG9uc2VUeXBlcyBbQm9vbGVhbl0gd2hldGhlciB0eXBlcyBhcmUgY29udmVydGVkCiAgICAgKiAgICAgd2hlbiBwYXJzaW5nIHJlc3BvbnNlIGRhdGEuIEN1cnJlbnRseSBvbmx5IHN1cHBvcnRlZCBmb3IgSlNPTiBiYXNlZAogICAgICogICAgIHNlcnZpY2VzLiBUdXJuaW5nIHRoaXMgb2ZmIG1heSBpbXByb3ZlIHBlcmZvcm1hbmNlIG9uIGxhcmdlIHJlc3BvbnNlCiAgICAgKiAgICAgcGF5bG9hZHMuIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBjb3JyZWN0Q2xvY2tTa2V3IFtCb29sZWFuXSB3aGV0aGVyIHRvIGFwcGx5IGEgY2xvY2sgc2tldwogICAgICogICAgIGNvcnJlY3Rpb24gYW5kIHJldHJ5IHJlcXVlc3RzIHRoYXQgZmFpbCBiZWNhdXNlIG9mIGFuIHNrZXdlZCBjbGllbnQKICAgICAqICAgICBjbG9jay4gRGVmYXVsdHMgdG8gYGZhbHNlYC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzM0ZvcmNlUGF0aFN0eWxlIFtCb29sZWFuXSB3aGV0aGVyIHRvIGZvcmNlIHBhdGgKICAgICAqICAgc3R5bGUgVVJMcyBmb3IgUzMgb2JqZWN0cy4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzM0J1Y2tldEVuZHBvaW50IFtCb29sZWFuXSB3aGV0aGVyIHRoZSBwcm92aWRlZCBlbmRwb2ludAogICAgICogICBhZGRyZXNzZXMgYW4gaW5kaXZpZHVhbCBidWNrZXQgKGZhbHNlIGlmIGl0IGFkZHJlc3NlcyB0aGUgcm9vdCBBUEkKICAgICAqICAgZW5kcG9pbnQpLiBOb3RlIHRoYXQgc2V0dGluZyB0aGlzIGNvbmZpZ3VyYXRpb24gb3B0aW9uIHJlcXVpcmVzIGFuCiAgICAgKiAgIGBlbmRwb2ludGAgdG8gYmUgcHJvdmlkZWQgZXhwbGljaXRseSB0byB0aGUgc2VydmljZSBjb25zdHJ1Y3Rvci4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzM0Rpc2FibGVCb2R5U2lnbmluZyBbQm9vbGVhbl0gd2hldGhlciBTMyBib2R5IHNpZ25pbmcKICAgICAqICAgc2hvdWxkIGJlIGRpc2FibGVkIHdoZW4gdXNpbmcgc2lnbmF0dXJlIHZlcnNpb24gYHY0YC4gQm9keSBzaWduaW5nCiAgICAgKiAgIGNhbiBvbmx5IGJlIGRpc2FibGVkIHdoZW4gdXNpbmcgaHR0cHMuIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgICAqCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgcmV0cnlEZWxheU9wdGlvbnMgW21hcF0gQSBzZXQgb2Ygb3B0aW9ucyB0byBjb25maWd1cmUKICAgICAqICAgdGhlIHJldHJ5IGRlbGF5IG9uIHJldHJ5YWJsZSBlcnJvcnMuIEN1cnJlbnRseSBzdXBwb3J0ZWQgb3B0aW9ucyBhcmU6CiAgICAgKgogICAgICogICAqICoqYmFzZSoqIFtJbnRlZ2VyXSAmbWRhc2g7IFRoZSBiYXNlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gdXNlIGluIHRoZQogICAgICogICAgIGV4cG9uZW50aWFsIGJhY2tvZmYgZm9yIG9wZXJhdGlvbiByZXRyaWVzLiBEZWZhdWx0cyB0byAxMDAgbXMgZm9yIGFsbAogICAgICogICAgIHNlcnZpY2VzIGV4Y2VwdCBEeW5hbW9EQiwgd2hlcmUgaXQgZGVmYXVsdHMgdG8gNTBtcy4KICAgICAqICAgKiAqKmN1c3RvbUJhY2tvZmYgKiogW2Z1bmN0aW9uXSAmbWRhc2g7IEEgY3VzdG9tIGZ1bmN0aW9uIHRoYXQgYWNjZXB0cyBhIHJldHJ5IGNvdW50CiAgICAgKiAgICAgYW5kIHJldHVybnMgdGhlIGFtb3VudCBvZiB0aW1lIHRvIGRlbGF5IGluIG1pbGxpc2Vjb25kcy4gVGhlIGBiYXNlYCBvcHRpb24gd2lsbCBiZQogICAgICogICAgIGlnbm9yZWQgaWYgdGhpcyBvcHRpb24gaXMgc3VwcGxpZWQuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgaHR0cE9wdGlvbnMgW21hcF0gQSBzZXQgb2Ygb3B0aW9ucyB0byBwYXNzIHRvIHRoZSBsb3ctbGV2ZWwKICAgICAqICAgSFRUUCByZXF1ZXN0LiBDdXJyZW50bHkgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogICAgICoKICAgICAqICAgKiAqKnByb3h5KiogW1N0cmluZ10gJm1kYXNoOyB0aGUgVVJMIHRvIHByb3h5IHJlcXVlc3RzIHRocm91Z2gKICAgICAqICAgKiAqKmFnZW50KiogW2h0dHAuQWdlbnQsIGh0dHBzLkFnZW50XSAmbWRhc2g7IHRoZSBBZ2VudCBvYmplY3QgdG8gcGVyZm9ybQogICAgICogICAgIEhUVFAgcmVxdWVzdHMgd2l0aC4gVXNlZCBmb3IgY29ubmVjdGlvbiBwb29saW5nLiBEZWZhdWx0cyB0byB0aGUgZ2xvYmFsCiAgICAgKiAgICAgYWdlbnQgKGBodHRwLmdsb2JhbEFnZW50YCkgZm9yIG5vbi1TU0wgY29ubmVjdGlvbnMuIE5vdGUgdGhhdCBmb3IKICAgICAqICAgICBTU0wgY29ubmVjdGlvbnMsIGEgc3BlY2lhbCBBZ2VudCBvYmplY3QgaXMgdXNlZCBpbiBvcmRlciB0byBlbmFibGUKICAgICAqICAgICBwZWVyIGNlcnRpZmljYXRlIHZlcmlmaWNhdGlvbi4gVGhpcyBmZWF0dXJlIGlzIG9ubHkgYXZhaWxhYmxlIGluIHRoZQogICAgICogICAgIE5vZGUuanMgZW52aXJvbm1lbnQuCiAgICAgKiAgICogKipjb25uZWN0VGltZW91dCoqIFtJbnRlZ2VyXSAmbWRhc2g7IFNldHMgdGhlIHNvY2tldCB0byB0aW1lb3V0IGFmdGVyCiAgICAgKiAgICAgZmFpbGluZyB0byBlc3RhYmxpc2ggYSBjb25uZWN0aW9uIHdpdGggdGhlIHNlcnZlciBhZnRlcgogICAgICogICAgIGBjb25uZWN0VGltZW91dGAgbWlsbGlzZWNvbmRzLiBUaGlzIHRpbWVvdXQgaGFzIG5vIGVmZmVjdCBvbmNlIGEgc29ja2V0CiAgICAgKiAgICAgY29ubmVjdGlvbiBoYXMgYmVlbiBlc3RhYmxpc2hlZC4KICAgICAqICAgKiAqKnRpbWVvdXQqKiBbSW50ZWdlcl0gJm1kYXNoOyBTZXRzIHRoZSBzb2NrZXQgdG8gdGltZW91dCBhZnRlciB0aW1lb3V0CiAgICAgKiAgICAgbWlsbGlzZWNvbmRzIG9mIGluYWN0aXZpdHkgb24gdGhlIHNvY2tldC4gRGVmYXVsdHMgdG8gdHdvIG1pbnV0ZXMKICAgICAqICAgICAoMTIwMDAwKS4KICAgICAqICAgKiAqKnhockFzeW5jKiogW0Jvb2xlYW5dICZtZGFzaDsgV2hldGhlciB0aGUgU0RLIHdpbGwgc2VuZCBhc3luY2hyb25vdXMKICAgICAqICAgICBIVFRQIHJlcXVlc3RzLiBVc2VkIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50IG9ubHkuIFNldCB0byBmYWxzZSB0bwogICAgICogICAgIHNlbmQgcmVxdWVzdHMgc3luY2hyb25vdXNseS4gRGVmYXVsdHMgdG8gdHJ1ZSAoYXN5bmMgb24pLgogICAgICogICAqICoqeGhyV2l0aENyZWRlbnRpYWxzKiogW0Jvb2xlYW5dICZtZGFzaDsgU2V0cyB0aGUgIndpdGhDcmVkZW50aWFscyIKICAgICAqICAgICBwcm9wZXJ0eSBvZiBhbiBYTUxIdHRwUmVxdWVzdCBvYmplY3QuIFVzZWQgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQKICAgICAqICAgICBvbmx5LiBEZWZhdWx0cyB0byBmYWxzZS4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBhcGlWZXJzaW9uIFtTdHJpbmcsIERhdGVdIGEgU3RyaW5nIGluIFlZWVktTU0tREQgZm9ybWF0CiAgICAgKiAgIChvciBhIGRhdGUpIHRoYXQgcmVwcmVzZW50cyB0aGUgbGF0ZXN0IHBvc3NpYmxlIEFQSSB2ZXJzaW9uIHRoYXQgY2FuIGJlCiAgICAgKiAgIHVzZWQgaW4gYWxsIHNlcnZpY2VzICh1bmxlc3Mgb3ZlcnJpZGRlbiBieSBgYXBpVmVyc2lvbnNgKS4gU3BlY2lmeQogICAgICogICAnbGF0ZXN0JyB0byB1c2UgdGhlIGxhdGVzdCBwb3NzaWJsZSB2ZXJzaW9uLgogICAgICogQG9wdGlvbiBvcHRpb25zIGFwaVZlcnNpb25zIFttYXA8U3RyaW5nLCBTdHJpbmd8RGF0ZT5dIGEgbWFwIG9mIHNlcnZpY2UKICAgICAqICAgaWRlbnRpZmllcnMgKHRoZSBsb3dlcmNhc2Ugc2VydmljZSBjbGFzcyBuYW1lKSB3aXRoIHRoZSBBUEkgdmVyc2lvbiB0bwogICAgICogICB1c2Ugd2hlbiBpbnN0YW50aWF0aW5nIGEgc2VydmljZS4gU3BlY2lmeSAnbGF0ZXN0JyBmb3IgZWFjaCBpbmRpdmlkdWFsCiAgICAgKiAgIHRoYXQgY2FuIHVzZSB0aGUgbGF0ZXN0IGF2YWlsYWJsZSB2ZXJzaW9uLgogICAgICogQG9wdGlvbiBvcHRpb25zIGxvZ2dlciBbI3dyaXRlLCNsb2ddIGFuIG9iamVjdCB0aGF0IHJlc3BvbmRzIHRvIC53cml0ZSgpCiAgICAgKiAgIChsaWtlIGEgc3RyZWFtKSBvciAubG9nKCkgKGxpa2UgdGhlIGNvbnNvbGUgb2JqZWN0KSBpbiBvcmRlciB0byBsb2cKICAgICAqICAgaW5mb3JtYXRpb24gYWJvdXQgcmVxdWVzdHMKICAgICAqIEBvcHRpb24gb3B0aW9ucyBzeXN0ZW1DbG9ja09mZnNldCBbTnVtYmVyXSBhbiBvZmZzZXQgdmFsdWUgaW4gbWlsbGlzZWNvbmRzCiAgICAgKiAgIHRvIGFwcGx5IHRvIGFsbCBzaWduaW5nIHRpbWVzLiBVc2UgdGhpcyB0byBjb21wZW5zYXRlIGZvciBjbG9jayBza2V3CiAgICAgKiAgIHdoZW4geW91ciBzeXN0ZW0gbWF5IGJlIG91dCBvZiBzeW5jIHdpdGggdGhlIHNlcnZpY2UgdGltZS4gTm90ZSB0aGF0CiAgICAgKiAgIHRoaXMgY29uZmlndXJhdGlvbiBvcHRpb24gY2FuIG9ubHkgYmUgYXBwbGllZCB0byB0aGUgZ2xvYmFsIGBBV1MuY29uZmlnYAogICAgICogICBvYmplY3QgYW5kIGNhbm5vdCBiZSBvdmVycmlkZGVuIGluIHNlcnZpY2Utc3BlY2lmaWMgY29uZmlndXJhdGlvbi4KICAgICAqICAgRGVmYXVsdHMgdG8gMCBtaWxsaXNlY29uZHMuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgc2lnbmF0dXJlVmVyc2lvbiBbU3RyaW5nXSB0aGUgc2lnbmF0dXJlIHZlcnNpb24gdG8gc2lnbgogICAgICogICByZXF1ZXN0cyB3aXRoIChvdmVycmlkaW5nIHRoZSBBUEkgY29uZmlndXJhdGlvbikuIFBvc3NpYmxlIHZhbHVlcyBhcmU6CiAgICAgKiAgICd2MicsICd2MycsICd2NCcuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgc2lnbmF0dXJlQ2FjaGUgW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIHNpZ25hdHVyZSB0byBzaWduCiAgICAgKiAgIHJlcXVlc3RzIHdpdGggKG92ZXJyaWRpbmcgdGhlIEFQSSBjb25maWd1cmF0aW9uKSBpcyBjYWNoZWQuIE9ubHkgYXBwbGllcwogICAgICogICB0byB0aGUgc2lnbmF0dXJlIHZlcnNpb24gJ3Y0Jy4gRGVmYXVsdHMgdG8gYHRydWVgLgogICAgICogQG9wdGlvbiBvcHRpb25zIGR5bmFtb0RiQ3JjMzIgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gdmFsaWRhdGUgdGhlIENSQzMyCiAgICAgKiAgIGNoZWNrc3VtIG9mIEhUVFAgcmVzcG9uc2UgYm9kaWVzIHJldHVybmVkIGJ5IER5bmFtb0RCLiBEZWZhdWx0OiBgdHJ1ZWAuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgdXNlQWNjZWxlcmF0ZUVuZHBvaW50IFtCb29sZWFuXSBXaGV0aGVyIHRvIHVzZSB0aGUKICAgICAqICAgUzMgVHJhbnNmZXIgQWNjZWxlcmF0aW9uIGVuZHBvaW50IHdpdGggdGhlIFMzIHNlcnZpY2UuIERlZmF1bHQ6IGBmYWxzZWAuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgY2xpZW50U2lkZU1vbml0b3JpbmcgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gY29sbGVjdCBhbmQKICAgICAqICAgcHVibGlzaCB0aGlzIGNsaWVudCdzIHBlcmZvcm1hbmNlIG1ldHJpY3Mgb2YgYWxsIGl0cyBBUEkgcmVxdWVzdHMuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkIFtCb29sZWFuXSB3aGV0aGVyIHRvIGVuYWJsZSBlbmRwb2ludAogICAgICogICBkaXNjb3ZlcnkgZm9yIG9wZXJhdGlvbnMgdGhhdCBhbGxvdyBvcHRpb25hbGx5IHVzaW5nIGFuIGVuZHBvaW50IHJldHVybmVkIGJ5CiAgICAgKiAgIHRoZSBzZXJ2aWNlLgogICAgICogICBEZWZhdWx0cyB0byAnZmFsc2UnCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgZW5kcG9pbnRDYWNoZVNpemUgW051bWJlcl0gdGhlIHNpemUgb2YgdGhlIGdsb2JhbCBjYWNoZSBzdG9yaW5nCiAgICAgKiAgIGVuZHBvaW50cyBmcm9tIGVuZHBvaW50IGRpc2NvdmVyeSBvcGVyYXRpb25zLiBPbmNlIGVuZHBvaW50IGNhY2hlIGlzIGNyZWF0ZWQsCiAgICAgKiAgIHVwZGF0aW5nIHRoaXMgc2V0dGluZyBjYW5ub3QgY2hhbmdlIGV4aXN0aW5nIGNhY2hlIHNpemUuCiAgICAgKiAgIERlZmF1bHRzIHRvIDEwMDAKICAgICAqIEBvcHRpb24gb3B0aW9ucyBob3N0UHJlZml4RW5hYmxlZCBbQm9vbGVhbl0gd2hldGhlciB0byBtYXJzaGFsIHJlcXVlc3QKICAgICAqICAgcGFyYW1ldGVycyB0byB0aGUgcHJlZml4IG9mIGhvc3RuYW1lLgogICAgICogICBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgc3RzUmVnaW9uYWxFbmRwb2ludHMgWydsZWdhY3knfCdyZWdpb25hbCddIHdoZXRoZXIgdG8gc2VuZCBzdHMgcmVxdWVzdAogICAgICogICB0byBnbG9iYWwgZW5kcG9pbnRzIG9yIHJlZ2lvbmFsIGVuZHBvaW50cy4KICAgICAqICAgRGVmYXVsdHMgdG8gJ2xlZ2FjeScuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDb25maWcob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdW5kZWZpbmVkKSBvcHRpb25zID0ge307CiAgICAgIG9wdGlvbnMgPSB0aGlzLmV4dHJhY3RDcmVkZW50aWFscyhvcHRpb25zKTsKICAKICAgICAgQVdTLnV0aWwuZWFjaC5jYWxsKHRoaXMsIHRoaXMua2V5cywgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICB0aGlzLnNldChrZXksIG9wdGlvbnNba2V5XSwgdmFsdWUpOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEAhZ3JvdXAgTWFuYWdpbmcgQ3JlZGVudGlhbHMKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBMb2FkcyBjcmVkZW50aWFscyBmcm9tIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdC4gVGhpcyBpcyB1c2VkIGludGVybmFsbHkKICAgICAqIGJ5IHRoZSBTREsgdG8gZW5zdXJlIHRoYXQgcmVmcmVzaGFibGUge0NyZWRlbnRpYWxzfSBvYmplY3RzIGFyZSBwcm9wZXJseQogICAgICogcmVmcmVzaGVkIGFuZCBsb2FkZWQgd2hlbiBzZW5kaW5nIGEgcmVxdWVzdC4gSWYgeW91IHdhbnQgdG8gZW5zdXJlIHRoYXQKICAgICAqIHlvdXIgY3JlZGVudGlhbHMgYXJlIGxvYWRlZCBwcmlvciB0byBhIHJlcXVlc3QsIHlvdSBjYW4gdXNlIHRoaXMgbWV0aG9kCiAgICAgKiBkaXJlY3RseSB0byBwcm92aWRlIGFjY3VyYXRlIGNyZWRlbnRpYWwgZGF0YSBzdG9yZWQgaW4gdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAbm90ZSBJZiB5b3UgY29uZmlndXJlIHRoZSBTREsgd2l0aCBzdGF0aWMgb3IgZW52aXJvbm1lbnQgY3JlZGVudGlhbHMsCiAgICAgKiAgIHRoZSBjcmVkZW50aWFsIGRhdGEgc2hvdWxkIGFscmVhZHkgYmUgcHJlc2VudCBpbiB7Y3JlZGVudGlhbHN9IGF0dHJpYnV0ZS4KICAgICAqICAgVGhpcyBtZXRob2QgaXMgcHJpbWFyaWx5IG5lY2Vzc2FyeSB0byBsb2FkIGNyZWRlbnRpYWxzIGZyb20gYXN5bmNocm9ub3VzCiAgICAgKiAgIHNvdXJjZXMsIG9yIHNvdXJjZXMgdGhhdCBjYW4gcmVmcmVzaCBjcmVkZW50aWFscyBwZXJpb2RpY2FsbHkuCiAgICAgKiBAZXhhbXBsZSBHZXR0aW5nIHlvdXIgYWNjZXNzIGtleQogICAgICogICBBV1MuY29uZmlnLmdldENyZWRlbnRpYWxzKGZ1bmN0aW9uKGVycikgewogICAgICogICAgIGlmIChlcnIpIGNvbnNvbGUubG9nKGVyci5zdGFjayk7IC8vIGNyZWRlbnRpYWxzIG5vdCBsb2FkZWQKICAgICAqICAgICBlbHNlIGNvbnNvbGUubG9nKCJBY2Nlc3MgS2V5OiIsIEFXUy5jb25maWcuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQpOwogICAgICogICB9KQogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgQ2FsbGVkIHdoZW4gdGhlIHtjcmVkZW50aWFsc30gaGF2ZSBiZWVuIHByb3Blcmx5IHNldCBvbiB0aGUgY29uZmlndXJhdGlvbgogICAgICogICBvYmplY3QuCiAgICAgKgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgdGhpcyBpcyBzZXQsIGNyZWRlbnRpYWxzIHdlcmUgbm90IHN1Y2Nlc3NmdWxseQogICAgICogICAgIGxvYWRlZCBhbmQgdGhpcyBlcnJvciBwcm92aWRlcyBpbmZvcm1hdGlvbiB3aHkuCiAgICAgKiBAc2VlIGNyZWRlbnRpYWxzCiAgICAgKiBAc2VlIENyZWRlbnRpYWxzCiAgICAgKi8KICAgIGdldENyZWRlbnRpYWxzOiBmdW5jdGlvbiBnZXRDcmVkZW50aWFscyhjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgCiAgICAgIGZ1bmN0aW9uIGZpbmlzaChlcnIpIHsKICAgICAgICBjYWxsYmFjayhlcnIsIGVyciA/IG51bGwgOiBzZWxmLmNyZWRlbnRpYWxzKTsKICAgICAgfQogIAogICAgICBmdW5jdGlvbiBjcmVkRXJyb3IobXNnLCBlcnIpIHsKICAgICAgICByZXR1cm4gbmV3IEFXUy51dGlsLmVycm9yKGVyciB8fCBuZXcgRXJyb3IoKSwgewogICAgICAgICAgY29kZTogJ0NyZWRlbnRpYWxzRXJyb3InLAogICAgICAgICAgbWVzc2FnZTogbXNnLAogICAgICAgICAgbmFtZTogJ0NyZWRlbnRpYWxzRXJyb3InCiAgICAgICAgfSk7CiAgICAgIH0KICAKICAgICAgZnVuY3Rpb24gZ2V0QXN5bmNDcmVkZW50aWFscygpIHsKICAgICAgICBzZWxmLmNyZWRlbnRpYWxzLmdldChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgdmFyIG1zZyA9ICdDb3VsZCBub3QgbG9hZCBjcmVkZW50aWFscyBmcm9tICcgKwogICAgICAgICAgICAgIHNlbGYuY3JlZGVudGlhbHMuY29uc3RydWN0b3IubmFtZTsKICAgICAgICAgICAgZXJyID0gY3JlZEVycm9yKG1zZywgZXJyKTsKICAgICAgICAgIH0KICAgICAgICAgIGZpbmlzaChlcnIpOwogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIGZ1bmN0aW9uIGdldFN0YXRpY0NyZWRlbnRpYWxzKCkgewogICAgICAgIHZhciBlcnIgPSBudWxsOwogICAgICAgIGlmICghc2VsZi5jcmVkZW50aWFscy5hY2Nlc3NLZXlJZCB8fCAhc2VsZi5jcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXkpIHsKICAgICAgICAgIGVyciA9IGNyZWRFcnJvcignTWlzc2luZyBjcmVkZW50aWFscycpOwogICAgICAgIH0KICAgICAgICBmaW5pc2goZXJyKTsKICAgICAgfQogIAogICAgICBpZiAoc2VsZi5jcmVkZW50aWFscykgewogICAgICAgIGlmICh0eXBlb2Ygc2VsZi5jcmVkZW50aWFscy5nZXQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGdldEFzeW5jQ3JlZGVudGlhbHMoKTsKICAgICAgICB9IGVsc2UgeyAvLyBzdGF0aWMgY3JlZGVudGlhbHMKICAgICAgICAgIGdldFN0YXRpY0NyZWRlbnRpYWxzKCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHNlbGYuY3JlZGVudGlhbFByb3ZpZGVyKSB7CiAgICAgICAgc2VsZi5jcmVkZW50aWFsUHJvdmlkZXIucmVzb2x2ZShmdW5jdGlvbihlcnIsIGNyZWRzKSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIGVyciA9IGNyZWRFcnJvcignQ291bGQgbm90IGxvYWQgY3JlZGVudGlhbHMgZnJvbSBhbnkgcHJvdmlkZXJzJywgZXJyKTsKICAgICAgICAgIH0KICAgICAgICAgIHNlbGYuY3JlZGVudGlhbHMgPSBjcmVkczsKICAgICAgICAgIGZpbmlzaChlcnIpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGZpbmlzaChjcmVkRXJyb3IoJ05vIGNyZWRlbnRpYWxzIHRvIGxvYWQnKSk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEAhZ3JvdXAgTG9hZGluZyBhbmQgU2V0dGluZyBDb25maWd1cmF0aW9uIE9wdGlvbnMKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBAb3ZlcmxvYWQgdXBkYXRlKG9wdGlvbnMsIGFsbG93VW5rbm93bktleXMgPSBmYWxzZSkKICAgICAqICAgVXBkYXRlcyB0aGUgY3VycmVudCBjb25maWd1cmF0aW9uIG9iamVjdCB3aXRoIG5ldyBvcHRpb25zLgogICAgICoKICAgICAqICAgQGV4YW1wbGUgVXBkYXRlIG1heFJldHJpZXMgcHJvcGVydHkgb2YgYSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICogICAgIGNvbmZpZy51cGRhdGUoe21heFJldHJpZXM6IDEwfSk7CiAgICAgKiAgIEBwYXJhbSBbT2JqZWN0XSBvcHRpb25zIGEgbWFwIG9mIG9wdGlvbiBrZXlzIGFuZCB2YWx1ZXMuCiAgICAgKiAgIEBwYXJhbSBbQm9vbGVhbl0gYWxsb3dVbmtub3duS2V5cyB3aGV0aGVyIHVua25vd24ga2V5cyBjYW4gYmUgc2V0IG9uCiAgICAgKiAgICAgdGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0LiBEZWZhdWx0cyB0byBgZmFsc2VgLgogICAgICogICBAc2VlIGNvbnN0cnVjdG9yCiAgICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKG9wdGlvbnMsIGFsbG93VW5rbm93bktleXMpIHsKICAgICAgYWxsb3dVbmtub3duS2V5cyA9IGFsbG93VW5rbm93bktleXMgfHwgZmFsc2U7CiAgICAgIG9wdGlvbnMgPSB0aGlzLmV4dHJhY3RDcmVkZW50aWFscyhvcHRpb25zKTsKICAgICAgQVdTLnV0aWwuZWFjaC5jYWxsKHRoaXMsIG9wdGlvbnMsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKGFsbG93VW5rbm93bktleXMgfHwgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMua2V5cywga2V5KSB8fAogICAgICAgICAgICBBV1MuU2VydmljZS5oYXNTZXJ2aWNlKGtleSkpIHsKICAgICAgICAgIHRoaXMuc2V0KGtleSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBMb2FkcyBjb25maWd1cmF0aW9uIGRhdGEgZnJvbSBhIEpTT04gZmlsZSBpbnRvIHRoaXMgY29uZmlnIG9iamVjdC4KICAgICAqIEBub3RlIExvYWRpbmcgY29uZmlndXJhdGlvbiB3aWxsIHJlc2V0IGFsbCBleGlzdGluZyBjb25maWd1cmF0aW9uCiAgICAgKiAgIG9uIHRoZSBvYmplY3QuCiAgICAgKiBAIW1hY3JvIG5vYnJvd3NlcgogICAgICogQHBhcmFtIHBhdGggW1N0cmluZ10gdGhlIHBhdGggcmVsYXRpdmUgdG8geW91ciBwcm9jZXNzJ3MgY3VycmVudAogICAgICogICAgd29ya2luZyBkaXJlY3RvcnkgdG8gbG9hZCBjb25maWd1cmF0aW9uIGZyb20uCiAgICAgKiBAcmV0dXJuIFtBV1MuQ29uZmlnXSB0aGUgc2FtZSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICovCiAgICBsb2FkRnJvbVBhdGg6IGZ1bmN0aW9uIGxvYWRGcm9tUGF0aChwYXRoKSB7CiAgICAgIHRoaXMuY2xlYXIoKTsKICAKICAgICAgdmFyIG9wdGlvbnMgPSBKU09OLnBhcnNlKEFXUy51dGlsLnJlYWRGaWxlU3luYyhwYXRoKSk7CiAgICAgIHZhciBmaWxlU3lzdGVtQ3JlZHMgPSBuZXcgQVdTLkZpbGVTeXN0ZW1DcmVkZW50aWFscyhwYXRoKTsKICAgICAgdmFyIGNoYWluID0gbmV3IEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbigpOwogICAgICBjaGFpbi5wcm92aWRlcnMudW5zaGlmdChmaWxlU3lzdGVtQ3JlZHMpOwogICAgICBjaGFpbi5yZXNvbHZlKGZ1bmN0aW9uIChlcnIsIGNyZWRzKSB7CiAgICAgICAgaWYgKGVycikgdGhyb3cgZXJyOwogICAgICAgIGVsc2Ugb3B0aW9ucy5jcmVkZW50aWFscyA9IGNyZWRzOwogICAgICB9KTsKICAKICAgICAgdGhpcy5jb25zdHJ1Y3RvcihvcHRpb25zKTsKICAKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBDbGVhcnMgY29uZmlndXJhdGlvbiBkYXRhIG9uIHRoaXMgb2JqZWN0CiAgICAgKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNsZWFyOiBmdW5jdGlvbiBjbGVhcigpIHsKICAgICAgLypqc2hpbnQgZm9yaW46ZmFsc2UgKi8KICAgICAgQVdTLnV0aWwuZWFjaC5jYWxsKHRoaXMsIHRoaXMua2V5cywgZnVuY3Rpb24gKGtleSkgewogICAgICAgIGRlbGV0ZSB0aGlzW2tleV07CiAgICAgIH0pOwogIAogICAgICAvLyByZXNldCBjcmVkZW50aWFsIHByb3ZpZGVyCiAgICAgIHRoaXMuc2V0KCdjcmVkZW50aWFscycsIHVuZGVmaW5lZCk7CiAgICAgIHRoaXMuc2V0KCdjcmVkZW50aWFsUHJvdmlkZXInLCB1bmRlZmluZWQpOwogICAgfSwKICAKICAgIC8qKgogICAgICogU2V0cyBhIHByb3BlcnR5IG9uIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdCwgYWxsb3dpbmcgZm9yIGEKICAgICAqIGRlZmF1bHQgdmFsdWUKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChwcm9wZXJ0eSwgdmFsdWUsIGRlZmF1bHRWYWx1ZSkgewogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGlmIChkZWZhdWx0VmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgZGVmYXVsdFZhbHVlID0gdGhpcy5rZXlzW3Byb3BlcnR5XTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBkZWZhdWx0VmFsdWUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHRoaXNbcHJvcGVydHldID0gZGVmYXVsdFZhbHVlLmNhbGwodGhpcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXNbcHJvcGVydHldID0gZGVmYXVsdFZhbHVlOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChwcm9wZXJ0eSA9PT0gJ2h0dHBPcHRpb25zJyAmJiB0aGlzW3Byb3BlcnR5XSkgewogICAgICAgIC8vIGRlZXAgbWVyZ2UgaHR0cE9wdGlvbnMKICAgICAgICB0aGlzW3Byb3BlcnR5XSA9IEFXUy51dGlsLm1lcmdlKHRoaXNbcHJvcGVydHldLCB2YWx1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpc1twcm9wZXJ0eV0gPSB2YWx1ZTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQWxsIG9mIHRoZSBrZXlzIHdpdGggdGhlaXIgZGVmYXVsdCB2YWx1ZXMuCiAgICAgKgogICAgICogQGNvbnN0YW50CiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAga2V5czogewogICAgICBjcmVkZW50aWFsczogbnVsbCwKICAgICAgY3JlZGVudGlhbFByb3ZpZGVyOiBudWxsLAogICAgICByZWdpb246IG51bGwsCiAgICAgIGxvZ2dlcjogbnVsbCwKICAgICAgYXBpVmVyc2lvbnM6IHt9LAogICAgICBhcGlWZXJzaW9uOiBudWxsLAogICAgICBlbmRwb2ludDogdW5kZWZpbmVkLAogICAgICBodHRwT3B0aW9uczogewogICAgICAgIHRpbWVvdXQ6IDEyMDAwMAogICAgICB9LAogICAgICBtYXhSZXRyaWVzOiB1bmRlZmluZWQsCiAgICAgIG1heFJlZGlyZWN0czogMTAsCiAgICAgIHBhcmFtVmFsaWRhdGlvbjogdHJ1ZSwKICAgICAgc3NsRW5hYmxlZDogdHJ1ZSwKICAgICAgczNGb3JjZVBhdGhTdHlsZTogZmFsc2UsCiAgICAgIHMzQnVja2V0RW5kcG9pbnQ6IGZhbHNlLAogICAgICBzM0Rpc2FibGVCb2R5U2lnbmluZzogdHJ1ZSwKICAgICAgY29tcHV0ZUNoZWNrc3VtczogdHJ1ZSwKICAgICAgY29udmVydFJlc3BvbnNlVHlwZXM6IHRydWUsCiAgICAgIGNvcnJlY3RDbG9ja1NrZXc6IGZhbHNlLAogICAgICBjdXN0b21Vc2VyQWdlbnQ6IG51bGwsCiAgICAgIGR5bmFtb0RiQ3JjMzI6IHRydWUsCiAgICAgIHN5c3RlbUNsb2NrT2Zmc2V0OiAwLAogICAgICBzaWduYXR1cmVWZXJzaW9uOiBudWxsLAogICAgICBzaWduYXR1cmVDYWNoZTogdHJ1ZSwKICAgICAgcmV0cnlEZWxheU9wdGlvbnM6IHt9LAogICAgICB1c2VBY2NlbGVyYXRlRW5kcG9pbnQ6IGZhbHNlLAogICAgICBjbGllbnRTaWRlTW9uaXRvcmluZzogZmFsc2UsCiAgICAgIGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZDogZmFsc2UsCiAgICAgIGVuZHBvaW50Q2FjaGVTaXplOiAxMDAwLAogICAgICBob3N0UHJlZml4RW5hYmxlZDogdHJ1ZSwKICAgICAgc3RzUmVnaW9uYWxFbmRwb2ludHM6IG51bGwKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEV4dHJhY3RzIGFjY2Vzc0tleUlkLCBzZWNyZXRBY2Nlc3NLZXkgYW5kIHNlc3Npb25Ub2tlbgogICAgICogZnJvbSBhIGNvbmZpZ3VyYXRpb24gaGFzaC4KICAgICAqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZXh0cmFjdENyZWRlbnRpYWxzOiBmdW5jdGlvbiBleHRyYWN0Q3JlZGVudGlhbHMob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucy5hY2Nlc3NLZXlJZCAmJiBvcHRpb25zLnNlY3JldEFjY2Vzc0tleSkgewogICAgICAgIG9wdGlvbnMgPSBBV1MudXRpbC5jb3B5KG9wdGlvbnMpOwogICAgICAgIG9wdGlvbnMuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKG9wdGlvbnMpOwogICAgICB9CiAgICAgIHJldHVybiBvcHRpb25zOwogICAgfSwKICAKICAgIC8qKgogICAgICogU2V0cyB0aGUgcHJvbWlzZSBkZXBlbmRlbmN5IHRoZSBTREsgd2lsbCB1c2Ugd2hlcmV2ZXIgUHJvbWlzZXMgYXJlIHJldHVybmVkLgogICAgICogUGFzc2luZyBgbnVsbGAgd2lsbCBmb3JjZSB0aGUgU0RLIHRvIHVzZSBuYXRpdmUgUHJvbWlzZXMgaWYgdGhleSBhcmUgYXZhaWxhYmxlLgogICAgICogSWYgbmF0aXZlIFByb21pc2VzIGFyZSBub3QgYXZhaWxhYmxlLCBwYXNzaW5nIGBudWxsYCB3aWxsIGhhdmUgbm8gZWZmZWN0LgogICAgICogQHBhcmFtIFtDb25zdHJ1Y3Rvcl0gZGVwIEEgcmVmZXJlbmNlIHRvIGEgUHJvbWlzZSBjb25zdHJ1Y3RvcgogICAgICovCiAgICBzZXRQcm9taXNlc0RlcGVuZGVuY3k6IGZ1bmN0aW9uIHNldFByb21pc2VzRGVwZW5kZW5jeShkZXApIHsKICAgICAgUHJvbWlzZXNEZXBlbmRlbmN5ID0gZGVwOwogICAgICAvLyBpZiBudWxsIHdhcyBwYXNzZWQgaW4sIHdlIHNob3VsZCB0cnkgdG8gdXNlIG5hdGl2ZSBwcm9taXNlcwogICAgICBpZiAoZGVwID09PSBudWxsICYmIHR5cGVvZiBQcm9taXNlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgUHJvbWlzZXNEZXBlbmRlbmN5ID0gUHJvbWlzZTsKICAgICAgfQogICAgICB2YXIgY29uc3RydWN0b3JzID0gW0FXUy5SZXF1ZXN0LCBBV1MuQ3JlZGVudGlhbHMsIEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbl07CiAgICAgIGlmIChBV1MuUzMpIHsKICAgICAgICBjb25zdHJ1Y3RvcnMucHVzaChBV1MuUzMpOwogICAgICAgIGlmIChBV1MuUzMuTWFuYWdlZFVwbG9hZCkgewogICAgICAgICAgY29uc3RydWN0b3JzLnB1c2goQVdTLlMzLk1hbmFnZWRVcGxvYWQpOwogICAgICAgIH0KICAgICAgfQogICAgICBBV1MudXRpbC5hZGRQcm9taXNlcyhjb25zdHJ1Y3RvcnMsIFByb21pc2VzRGVwZW5kZW5jeSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBwcm9taXNlIGRlcGVuZGVuY3kgc2V0IGJ5IGBBV1MuY29uZmlnLnNldFByb21pc2VzRGVwZW5kZW5jeWAuCiAgICAgKi8KICAgIGdldFByb21pc2VzRGVwZW5kZW5jeTogZnVuY3Rpb24gZ2V0UHJvbWlzZXNEZXBlbmRlbmN5KCkgewogICAgICByZXR1cm4gUHJvbWlzZXNEZXBlbmRlbmN5OwogICAgfQogIH0pOwogIAogIC8qKgogICAqIEByZXR1cm4gW0FXUy5Db25maWddIFRoZSBnbG9iYWwgY29uZmlndXJhdGlvbiBvYmplY3Qgc2luZ2xldG9uIGluc3RhbmNlCiAgICogQHJlYWRvbmx5CiAgICogQHNlZSBBV1MuQ29uZmlnCiAgICovCiAgQVdTLmNvbmZpZyA9IG5ldyBBV1MuQ29uZmlnKCk7CiAgCiAgfSx7Ii4vY29yZSI6MTgsIi4vY3JlZGVudGlhbHMiOjE5LCIuL2NyZWRlbnRpYWxzL2NyZWRlbnRpYWxfcHJvdmlkZXJfY2hhaW4iOjIyfV0sMTg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8qKgogICAqIFRoZSBtYWluIEFXUyBuYW1lc3BhY2UKICAgKi8KICB2YXIgQVdTID0geyB1dGlsOiByZXF1aXJlKCcuL3V0aWwnKSB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEAhbWFjcm8gW25ld10gbm9icm93c2VyCiAgICogICBAbm90ZSBUaGlzIGZlYXR1cmUgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudCBvZiB0aGUgU0RLLgogICAqLwogIHZhciBfaGlkZGVuID0ge307IF9oaWRkZW4udG9TdHJpbmcoKTsgLy8gaGFjayB0byBwYXJzZSBtYWNybwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTOwogIAogIEFXUy51dGlsLnVwZGF0ZShBV1MsIHsKICAKICAgIC8qKgogICAgICogQGNvbnN0YW50CiAgICAgKi8KICAgIFZFUlNJT046ICcyLjU1My4wJywKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIFNpZ25lcnM6IHt9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgUHJvdG9jb2w6IHsKICAgICAgSnNvbjogcmVxdWlyZSgnLi9wcm90b2NvbC9qc29uJyksCiAgICAgIFF1ZXJ5OiByZXF1aXJlKCcuL3Byb3RvY29sL3F1ZXJ5JyksCiAgICAgIFJlc3Q6IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdCcpLAogICAgICBSZXN0SnNvbjogcmVxdWlyZSgnLi9wcm90b2NvbC9yZXN0X2pzb24nKSwKICAgICAgUmVzdFhtbDogcmVxdWlyZSgnLi9wcm90b2NvbC9yZXN0X3htbCcpCiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgWE1MOiB7CiAgICAgIEJ1aWxkZXI6IHJlcXVpcmUoJy4veG1sL2J1aWxkZXInKSwKICAgICAgUGFyc2VyOiBudWxsIC8vIGNvbmRpdGlvbmFsbHkgc2V0IGJhc2VkIG9uIGVudmlyb25tZW50CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgSlNPTjogewogICAgICBCdWlsZGVyOiByZXF1aXJlKCcuL2pzb24vYnVpbGRlcicpLAogICAgICBQYXJzZXI6IHJlcXVpcmUoJy4vanNvbi9wYXJzZXInKQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIE1vZGVsOiB7CiAgICAgIEFwaTogcmVxdWlyZSgnLi9tb2RlbC9hcGknKSwKICAgICAgT3BlcmF0aW9uOiByZXF1aXJlKCcuL21vZGVsL29wZXJhdGlvbicpLAogICAgICBTaGFwZTogcmVxdWlyZSgnLi9tb2RlbC9zaGFwZScpLAogICAgICBQYWdpbmF0b3I6IHJlcXVpcmUoJy4vbW9kZWwvcGFnaW5hdG9yJyksCiAgICAgIFJlc291cmNlV2FpdGVyOiByZXF1aXJlKCcuL21vZGVsL3Jlc291cmNlX3dhaXRlcicpCiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXBpTG9hZGVyOiByZXF1aXJlKCcuL2FwaV9sb2FkZXInKSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIEVuZHBvaW50Q2FjaGU6IHJlcXVpcmUoJy4uL3ZlbmRvci9lbmRwb2ludC1jYWNoZScpLkVuZHBvaW50Q2FjaGUKICB9KTsKICByZXF1aXJlKCcuL3NlcXVlbnRpYWxfZXhlY3V0b3InKTsKICByZXF1aXJlKCcuL3NlcnZpY2UnKTsKICByZXF1aXJlKCcuL2NvbmZpZycpOwogIHJlcXVpcmUoJy4vaHR0cCcpOwogIHJlcXVpcmUoJy4vZXZlbnRfbGlzdGVuZXJzJyk7CiAgcmVxdWlyZSgnLi9yZXF1ZXN0Jyk7CiAgcmVxdWlyZSgnLi9yZXNwb25zZScpOwogIHJlcXVpcmUoJy4vcmVzb3VyY2Vfd2FpdGVyJyk7CiAgcmVxdWlyZSgnLi9zaWduZXJzL3JlcXVlc3Rfc2lnbmVyJyk7CiAgcmVxdWlyZSgnLi9wYXJhbV92YWxpZGF0b3InKTsKICAKICAvKioKICAgKiBAcmVhZG9ubHkKICAgKiBAcmV0dXJuIFtBV1MuU2VxdWVudGlhbEV4ZWN1dG9yXSBhIGNvbGxlY3Rpb24gb2YgZ2xvYmFsIGV2ZW50IGxpc3RlbmVycyB0aGF0CiAgICogICBhcmUgYXR0YWNoZWQgdG8gZXZlcnkgc2VudCByZXF1ZXN0LgogICAqIEBzZWUgQVdTLlJlcXVlc3QgQVdTLlJlcXVlc3QgZm9yIGEgbGlzdCBvZiBldmVudHMgdG8gbGlzdGVuIGZvcgogICAqIEBleGFtcGxlIExvZ2dpbmcgdGhlIHRpbWUgdGFrZW4gdG8gc2VuZCBhIHJlcXVlc3QKICAgKiAgIEFXUy5ldmVudHMub24oJ3NlbmQnLCBmdW5jdGlvbiBzdGFydFNlbmQocmVzcCkgewogICAqICAgICByZXNwLnN0YXJ0VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAqICAgfSkub24oJ2NvbXBsZXRlJywgZnVuY3Rpb24gY2FsY3VsYXRlVGltZShyZXNwKSB7CiAgICogICAgIHZhciB0aW1lID0gKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gcmVzcC5zdGFydFRpbWUpIC8gMTAwMDsKICAgKiAgICAgY29uc29sZS5sb2coJ1JlcXVlc3QgdG9vayAnICsgdGltZSArICcgc2Vjb25kcycpOwogICAqICAgfSk7CiAgICoKICAgKiAgIG5ldyBBV1MuUzMoKS5saXN0QnVja2V0cygpOyAvLyBwcmludHMgJ1JlcXVlc3QgdG9vayAwLjI4NSBzZWNvbmRzJwogICAqLwogIEFXUy5ldmVudHMgPSBuZXcgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcigpOwogIAogIC8vY3JlYXRlIGVuZHBvaW50IGNhY2hlIGxhemlseQogIEFXUy51dGlsLm1lbW9pemVkUHJvcGVydHkoQVdTLCAnZW5kcG9pbnRDYWNoZScsIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG5ldyBBV1MuRW5kcG9pbnRDYWNoZShBV1MuY29uZmlnLmVuZHBvaW50Q2FjaGVTaXplKTsKICB9LCB0cnVlKTsKICAKICB9LHsiLi4vdmVuZG9yL2VuZHBvaW50LWNhY2hlIjoxMDMsIi4vYXBpX2xvYWRlciI6OSwiLi9jb25maWciOjE3LCIuL2V2ZW50X2xpc3RlbmVycyI6MzMsIi4vaHR0cCI6MzQsIi4vanNvbi9idWlsZGVyIjozNiwiLi9qc29uL3BhcnNlciI6MzcsIi4vbW9kZWwvYXBpIjozOCwiLi9tb2RlbC9vcGVyYXRpb24iOjQwLCIuL21vZGVsL3BhZ2luYXRvciI6NDEsIi4vbW9kZWwvcmVzb3VyY2Vfd2FpdGVyIjo0MiwiLi9tb2RlbC9zaGFwZSI6NDMsIi4vcGFyYW1fdmFsaWRhdG9yIjo0NCwiLi9wcm90b2NvbC9qc29uIjo0NiwiLi9wcm90b2NvbC9xdWVyeSI6NDcsIi4vcHJvdG9jb2wvcmVzdCI6NDgsIi4vcHJvdG9jb2wvcmVzdF9qc29uIjo0OSwiLi9wcm90b2NvbC9yZXN0X3htbCI6NTAsIi4vcmVxdWVzdCI6NTUsIi4vcmVzb3VyY2Vfd2FpdGVyIjo1NiwiLi9yZXNwb25zZSI6NTcsIi4vc2VxdWVudGlhbF9leGVjdXRvciI6NTgsIi4vc2VydmljZSI6NTksIi4vc2lnbmVycy9yZXF1ZXN0X3NpZ25lciI6NjMsIi4vdXRpbCI6NzEsIi4veG1sL2J1aWxkZXIiOjczfV0sMTk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIHlvdXIgQVdTIHNlY3VyaXR5IGNyZWRlbnRpYWxzLCBzcGVjaWZpY2FsbHkgdGhlCiAgICoge2FjY2Vzc0tleUlkfSwge3NlY3JldEFjY2Vzc0tleX0sIGFuZCBvcHRpb25hbCB7c2Vzc2lvblRva2VufS4KICAgKiBDcmVhdGluZyBhIGBDcmVkZW50aWFsc2Agb2JqZWN0IGFsbG93cyB5b3UgdG8gcGFzcyBhcm91bmQgeW91cgogICAqIHNlY3VyaXR5IGluZm9ybWF0aW9uIHRvIGNvbmZpZ3VyYXRpb24gYW5kIHNlcnZpY2Ugb2JqZWN0cy4KICAgKgogICAqIE5vdGUgdGhhdCB0aGlzIGNsYXNzIHR5cGljYWxseSBkb2VzIG5vdCBuZWVkIHRvIGJlIGNvbnN0cnVjdGVkIG1hbnVhbGx5LAogICAqIGFzIHRoZSB7QVdTLkNvbmZpZ30gYW5kIHtBV1MuU2VydmljZX0gY2xhc3NlcyBib3RoIGFjY2VwdCBzaW1wbGUKICAgKiBvcHRpb25zIGhhc2hlcyB3aXRoIHRoZSB0aHJlZSBrZXlzLiBUaGVzZSBzdHJ1Y3R1cmVzIHdpbGwgYmUgY29udmVydGVkCiAgICogaW50byBDcmVkZW50aWFscyBvYmplY3RzIGF1dG9tYXRpY2FsbHkuCiAgICoKICAgKiAjIyBFeHBpcmluZyBhbmQgUmVmcmVzaGluZyBDcmVkZW50aWFscwogICAqCiAgICogT2NjYXNpb25hbGx5IGNyZWRlbnRpYWxzIGNhbiBleHBpcmUgaW4gdGhlIG1pZGRsZSBvZiBhIGxvbmctcnVubmluZwogICAqIGFwcGxpY2F0aW9uLiBJbiB0aGlzIGNhc2UsIHRoZSBTREsgd2lsbCBhdXRvbWF0aWNhbGx5IGF0dGVtcHQgdG8KICAgKiByZWZyZXNoIHRoZSBjcmVkZW50aWFscyBmcm9tIHRoZSBzdG9yYWdlIGxvY2F0aW9uIGlmIHRoZSBDcmVkZW50aWFscwogICAqIGNsYXNzIGltcGxlbWVudHMgdGhlIHtyZWZyZXNofSBtZXRob2QuCiAgICoKICAgKiBJZiB5b3UgYXJlIGltcGxlbWVudGluZyBhIGNyZWRlbnRpYWwgc3RvcmFnZSBsb2NhdGlvbiwgeW91CiAgICogd2lsbCB3YW50IHRvIGNyZWF0ZSBhIHN1YmNsYXNzIG9mIHRoZSBgQ3JlZGVudGlhbHNgIGNsYXNzIGFuZAogICAqIG92ZXJyaWRlIHRoZSB7cmVmcmVzaH0gbWV0aG9kLiBUaGlzIG1ldGhvZCBhbGxvd3MgY3JlZGVudGlhbHMgdG8gYmUKICAgKiByZXRyaWV2ZWQgZnJvbSB0aGUgYmFja2luZyBzdG9yZSwgYmUgaXQgYSBmaWxlIHN5c3RlbSwgZGF0YWJhc2UsIG9yCiAgICogc29tZSBuZXR3b3JrIHN0b3JhZ2UuIFRoZSBtZXRob2Qgc2hvdWxkIHJlc2V0IHRoZSBjcmVkZW50aWFsIGF0dHJpYnV0ZXMKICAgKiBvbiB0aGUgb2JqZWN0LgogICAqCiAgICogQCFhdHRyaWJ1dGUgZXhwaXJlZAogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0aGUgY3JlZGVudGlhbHMgaGF2ZSBiZWVuIGV4cGlyZWQgYW5kCiAgICogICAgIHJlcXVpcmUgYSByZWZyZXNoLiBVc2VkIGluIGNvbmp1bmN0aW9uIHdpdGgge2V4cGlyZVRpbWV9LgogICAqIEAhYXR0cmlidXRlIGV4cGlyZVRpbWUKICAgKiAgIEByZXR1cm4gW0RhdGVdIGEgdGltZSB3aGVuIGNyZWRlbnRpYWxzIHNob3VsZCBiZSBjb25zaWRlcmVkIGV4cGlyZWQuIFVzZWQKICAgKiAgICAgaW4gY29uanVuY3Rpb24gd2l0aCB7ZXhwaXJlZH0uCiAgICogQCFhdHRyaWJ1dGUgYWNjZXNzS2V5SWQKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIEFXUyBhY2Nlc3Mga2V5IElECiAgICogQCFhdHRyaWJ1dGUgc2VjcmV0QWNjZXNzS2V5CiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBBV1Mgc2VjcmV0IGFjY2VzcyBrZXkKICAgKiBAIWF0dHJpYnV0ZSBzZXNzaW9uVG9rZW4KICAgKiAgIEByZXR1cm4gW1N0cmluZ10gYW4gb3B0aW9uYWwgQVdTIHNlc3Npb24gdG9rZW4KICAgKi8KICBBV1MuQ3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KHsKICAgIC8qKgogICAgICogQSBjcmVkZW50aWFscyBvYmplY3QgY2FuIGJlIGNyZWF0ZWQgdXNpbmcgcG9zaXRpb25hbCBhcmd1bWVudHMgb3IgYW4gb3B0aW9ucwogICAgICogaGFzaC4KICAgICAqCiAgICAgKiBAb3ZlcmxvYWQgQVdTLkNyZWRlbnRpYWxzKGFjY2Vzc0tleUlkLCBzZWNyZXRBY2Nlc3NLZXksIHNlc3Npb25Ub2tlbj1udWxsKQogICAgICogICBDcmVhdGVzIGEgQ3JlZGVudGlhbHMgb2JqZWN0IHdpdGggYSBnaXZlbiBzZXQgb2YgY3JlZGVudGlhbCBpbmZvcm1hdGlvbgogICAgICogICBhcyBwb3NpdGlvbmFsIGFyZ3VtZW50cy4KICAgICAqICAgQHBhcmFtIGFjY2Vzc0tleUlkIFtTdHJpbmddIHRoZSBBV1MgYWNjZXNzIGtleSBJRAogICAgICogICBAcGFyYW0gc2VjcmV0QWNjZXNzS2V5IFtTdHJpbmddIHRoZSBBV1Mgc2VjcmV0IGFjY2VzcyBrZXkKICAgICAqICAgQHBhcmFtIHNlc3Npb25Ub2tlbiBbU3RyaW5nXSB0aGUgb3B0aW9uYWwgQVdTIHNlc3Npb24gdG9rZW4KICAgICAqICAgQGV4YW1wbGUgQ3JlYXRlIGEgY3JlZGVudGlhbHMgb2JqZWN0IHdpdGggQVdTIGNyZWRlbnRpYWxzCiAgICAgKiAgICAgdmFyIGNyZWRzID0gbmV3IEFXUy5DcmVkZW50aWFscygnYWtpZCcsICdzZWNyZXQnLCAnc2Vzc2lvbicpOwogICAgICogQG92ZXJsb2FkIEFXUy5DcmVkZW50aWFscyhvcHRpb25zKQogICAgICogICBDcmVhdGVzIGEgQ3JlZGVudGlhbHMgb2JqZWN0IHdpdGggYSBnaXZlbiBzZXQgb2YgY3JlZGVudGlhbCBpbmZvcm1hdGlvbgogICAgICogICBhcyBhbiBvcHRpb25zIGhhc2guCiAgICAgKiAgIEBvcHRpb24gb3B0aW9ucyBhY2Nlc3NLZXlJZCBbU3RyaW5nXSB0aGUgQVdTIGFjY2VzcyBrZXkgSUQKICAgICAqICAgQG9wdGlvbiBvcHRpb25zIHNlY3JldEFjY2Vzc0tleSBbU3RyaW5nXSB0aGUgQVdTIHNlY3JldCBhY2Nlc3Mga2V5CiAgICAgKiAgIEBvcHRpb24gb3B0aW9ucyBzZXNzaW9uVG9rZW4gW1N0cmluZ10gdGhlIG9wdGlvbmFsIEFXUyBzZXNzaW9uIHRva2VuCiAgICAgKiAgIEBleGFtcGxlIENyZWF0ZSBhIGNyZWRlbnRpYWxzIG9iamVjdCB3aXRoIEFXUyBjcmVkZW50aWFscwogICAgICogICAgIHZhciBjcmVkcyA9IG5ldyBBV1MuQ3JlZGVudGlhbHMoewogICAgICogICAgICAgYWNjZXNzS2V5SWQ6ICdha2lkJywgc2VjcmV0QWNjZXNzS2V5OiAnc2VjcmV0Jywgc2Vzc2lvblRva2VuOiAnc2Vzc2lvbicKICAgICAqICAgICB9KTsKICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIENyZWRlbnRpYWxzKCkgewogICAgICAvLyBoaWRlIHNlY3JldEFjY2Vzc0tleSBmcm9tIGJlaW5nIGRpc3BsYXllZCB3aXRoIHV0aWwuaW5zcGVjdAogICAgICBBV1MudXRpbC5oaWRlUHJvcGVydGllcyh0aGlzLCBbJ3NlY3JldEFjY2Vzc0tleSddKTsKICAKICAgICAgdGhpcy5leHBpcmVkID0gZmFsc2U7CiAgICAgIHRoaXMuZXhwaXJlVGltZSA9IG51bGw7CiAgICAgIHRoaXMucmVmcmVzaENhbGxiYWNrcyA9IFtdOwogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJiB0eXBlb2YgYXJndW1lbnRzWzBdID09PSAnb2JqZWN0JykgewogICAgICAgIHZhciBjcmVkcyA9IGFyZ3VtZW50c1swXS5jcmVkZW50aWFscyB8fCBhcmd1bWVudHNbMF07CiAgICAgICAgdGhpcy5hY2Nlc3NLZXlJZCA9IGNyZWRzLmFjY2Vzc0tleUlkOwogICAgICAgIHRoaXMuc2VjcmV0QWNjZXNzS2V5ID0gY3JlZHMuc2VjcmV0QWNjZXNzS2V5OwogICAgICAgIHRoaXMuc2Vzc2lvblRva2VuID0gY3JlZHMuc2Vzc2lvblRva2VuOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYWNjZXNzS2V5SWQgPSBhcmd1bWVudHNbMF07CiAgICAgICAgdGhpcy5zZWNyZXRBY2Nlc3NLZXkgPSBhcmd1bWVudHNbMV07CiAgICAgICAgdGhpcy5zZXNzaW9uVG9rZW4gPSBhcmd1bWVudHNbMl07CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEByZXR1cm4gW0ludGVnZXJdIHRoZSBudW1iZXIgb2Ygc2Vjb25kcyBiZWZvcmUge2V4cGlyZVRpbWV9IGR1cmluZyB3aGljaAogICAgICogICB0aGUgY3JlZGVudGlhbHMgd2lsbCBiZSBjb25zaWRlcmVkIGV4cGlyZWQuCiAgICAgKi8KICAgIGV4cGlyeVdpbmRvdzogMTUsCiAgCiAgICAvKioKICAgICAqIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIGNyZWRlbnRpYWxzIG9iamVjdCBzaG91bGQgY2FsbCB7cmVmcmVzaH0KICAgICAqIEBub3RlIFN1YmNsYXNzZXMgc2hvdWxkIG92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIHByb3ZpZGUgY3VzdG9tIHJlZnJlc2gKICAgICAqICAgbG9naWMuCiAgICAgKi8KICAgIG5lZWRzUmVmcmVzaDogZnVuY3Rpb24gbmVlZHNSZWZyZXNoKCkgewogICAgICB2YXIgY3VycmVudFRpbWUgPSBBV1MudXRpbC5kYXRlLmdldERhdGUoKS5nZXRUaW1lKCk7CiAgICAgIHZhciBhZGp1c3RlZFRpbWUgPSBuZXcgRGF0ZShjdXJyZW50VGltZSArIHRoaXMuZXhwaXJ5V2luZG93ICogMTAwMCk7CiAgCiAgICAgIGlmICh0aGlzLmV4cGlyZVRpbWUgJiYgYWRqdXN0ZWRUaW1lID4gdGhpcy5leHBpcmVUaW1lKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZXhwaXJlZCB8fCAhdGhpcy5hY2Nlc3NLZXlJZCB8fCAhdGhpcy5zZWNyZXRBY2Nlc3NLZXk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEdldHMgdGhlIGV4aXN0aW5nIGNyZWRlbnRpYWxzLCByZWZyZXNoaW5nIHRoZW0gaWYgdGhleSBhcmUgbm90IHlldCBsb2FkZWQKICAgICAqIG9yIGhhdmUgZXhwaXJlZC4gVXNlcnMgc2hvdWxkIGNhbGwgdGhpcyBtZXRob2QgYmVmb3JlIHVzaW5nIHtyZWZyZXNofSwKICAgICAqIGFzIHRoaXMgd2lsbCBub3QgYXR0ZW1wdCB0byByZWxvYWQgY3JlZGVudGlhbHMgd2hlbiB0aGV5IGFyZSBhbHJlYWR5CiAgICAgKiBsb2FkZWQgaW50byB0aGUgb2JqZWN0LgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIFdoZW4gdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgZWl0aGVyIGNyZWRlbnRpYWxzCiAgICAgKiAgIGRvIG5vdCBuZWVkIHRvIGJlIHJlZnJlc2hlZCBvciByZWZyZXNoZWQgY3JlZGVudGlhbHMgaW5mb3JtYXRpb24gaGFzCiAgICAgKiAgIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsIGBzZWNyZXRBY2Nlc3NLZXlgLAogICAgICogICBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICovCiAgICBnZXQ6IGZ1bmN0aW9uIGdldChjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmICh0aGlzLm5lZWRzUmVmcmVzaCgpKSB7CiAgICAgICAgdGhpcy5yZWZyZXNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgaWYgKCFlcnIpIHNlbGYuZXhwaXJlZCA9IGZhbHNlOyAvLyByZXNldCBleHBpcmVkIGZsYWcKICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soZXJyKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChjYWxsYmFjaykgewogICAgICAgIGNhbGxiYWNrKCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEAhbWV0aG9kICBnZXRQcm9taXNlKCkKICAgICAqICAgUmV0dXJucyBhICd0aGVuYWJsZScgcHJvbWlzZS4KICAgICAqICAgR2V0cyB0aGUgZXhpc3RpbmcgY3JlZGVudGlhbHMsIHJlZnJlc2hpbmcgdGhlbSBpZiB0aGV5IGFyZSBub3QgeWV0IGxvYWRlZAogICAgICogICBvciBoYXZlIGV4cGlyZWQuIFVzZXJzIHNob3VsZCBjYWxsIHRoaXMgbWV0aG9kIGJlZm9yZSB1c2luZyB7cmVmcmVzaH0sCiAgICAgKiAgIGFzIHRoaXMgd2lsbCBub3QgYXR0ZW1wdCB0byByZWxvYWQgY3JlZGVudGlhbHMgd2hlbiB0aGV5IGFyZSBhbHJlYWR5CiAgICAgKiAgIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogICBUd28gY2FsbGJhY2tzIGNhbiBiZSBwcm92aWRlZCB0byB0aGUgYHRoZW5gIG1ldGhvZCBvbiB0aGUgcmV0dXJuZWQgcHJvbWlzZS4KICAgICAqICAgVGhlIGZpcnN0IGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZCwgYW5kIHRoZSBzZWNvbmQKICAgICAqICAgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICAgKiAgIEBjYWxsYmFjayBmdWxmaWxsZWRDYWxsYmFjayBmdW5jdGlvbigpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZC4gV2hlbiB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCwgaXQKICAgICAqICAgICBtZWFucyBlaXRoZXIgY3JlZGVudGlhbHMgZG8gbm90IG5lZWQgdG8gYmUgcmVmcmVzaGVkIG9yIHJlZnJlc2hlZAogICAgICogICAgIGNyZWRlbnRpYWxzIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZQogICAgICogICAgIGBhY2Nlc3NLZXlJZGAsIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBjYWxsYmFjayByZWplY3RlZENhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICAgKiAgICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKiAgIEByZXR1cm4gW1Byb21pc2VdIEEgcHJvbWlzZSB0aGF0IHJlcHJlc2VudHMgdGhlIHN0YXRlIG9mIHRoZSBgZ2V0YCBjYWxsLgogICAgICogICBAZXhhbXBsZSBDYWxsaW5nIHRoZSBgZ2V0UHJvbWlzZWAgbWV0aG9kLgogICAgICogICAgIHZhciBwcm9taXNlID0gY3JlZFByb3ZpZGVyLmdldFByb21pc2UoKTsKICAgICAqICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24oKSB7IC4uLiB9LCBmdW5jdGlvbihlcnIpIHsgLi4uIH0pOwogICAgICovCiAgCiAgICAvKioKICAgICAqIEAhbWV0aG9kICByZWZyZXNoUHJvbWlzZSgpCiAgICAgKiAgIFJldHVybnMgYSAndGhlbmFibGUnIHByb21pc2UuCiAgICAgKiAgIFJlZnJlc2hlcyB0aGUgY3JlZGVudGlhbHMuIFVzZXJzIHNob3VsZCBjYWxsIHtnZXR9IGJlZm9yZSBhdHRlbXB0aW5nCiAgICAgKiAgIHRvIGZvcmNpYmx5IHJlZnJlc2ggY3JlZGVudGlhbHMuCiAgICAgKgogICAgICogICBUd28gY2FsbGJhY2tzIGNhbiBiZSBwcm92aWRlZCB0byB0aGUgYHRoZW5gIG1ldGhvZCBvbiB0aGUgcmV0dXJuZWQgcHJvbWlzZS4KICAgICAqICAgVGhlIGZpcnN0IGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZCwgYW5kIHRoZSBzZWNvbmQKICAgICAqICAgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICAgKiAgIEBjYWxsYmFjayBmdWxmaWxsZWRDYWxsYmFjayBmdW5jdGlvbigpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZC4gV2hlbiB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCwgaXQKICAgICAqICAgICBtZWFucyByZWZyZXNoZWQgY3JlZGVudGlhbHMgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdAogICAgICogICAgIChhcyB0aGUgYGFjY2Vzc0tleUlkYCwgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQGNhbGxiYWNrIHJlamVjdGVkQ2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAqICAgICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqICAgQHJldHVybiBbUHJvbWlzZV0gQSBwcm9taXNlIHRoYXQgcmVwcmVzZW50cyB0aGUgc3RhdGUgb2YgdGhlIGByZWZyZXNoYCBjYWxsLgogICAgICogICBAZXhhbXBsZSBDYWxsaW5nIHRoZSBgcmVmcmVzaFByb21pc2VgIG1ldGhvZC4KICAgICAqICAgICB2YXIgcHJvbWlzZSA9IGNyZWRQcm92aWRlci5yZWZyZXNoUHJvbWlzZSgpOwogICAgICogICAgIHByb21pc2UudGhlbihmdW5jdGlvbigpIHsgLi4uIH0sIGZ1bmN0aW9uKGVycikgeyAuLi4gfSk7CiAgICAgKi8KICAKICAgIC8qKgogICAgICogUmVmcmVzaGVzIHRoZSBjcmVkZW50aWFscy4gVXNlcnMgc2hvdWxkIGNhbGwge2dldH0gYmVmb3JlIGF0dGVtcHRpbmcKICAgICAqIHRvIGZvcmNpYmx5IHJlZnJlc2ggY3JlZGVudGlhbHMuCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgV2hlbiB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyByZWZyZXNoZWQKICAgICAqICAgY3JlZGVudGlhbHMgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlCiAgICAgKiAgIGBhY2Nlc3NLZXlJZGAsIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogQG5vdGUgU3ViY2xhc3NlcyBzaG91bGQgb3ZlcnJpZGUgdGhpcyBjbGFzcyB0byByZXNldCB0aGUKICAgICAqICAge2FjY2Vzc0tleUlkfSwge3NlY3JldEFjY2Vzc0tleX0gYW5kIG9wdGlvbmFsIHtzZXNzaW9uVG9rZW59CiAgICAgKiAgIG9uIHRoZSBjcmVkZW50aWFscyBvYmplY3QgYW5kIHRoZW4gY2FsbCB0aGUgY2FsbGJhY2sgd2l0aAogICAgICogICBhbnkgZXJyb3IgaW5mb3JtYXRpb24uCiAgICAgKiBAc2VlIGdldAogICAgICovCiAgICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuZXhwaXJlZCA9IGZhbHNlOwogICAgICBjYWxsYmFjaygpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgICAqLwogICAgY29hbGVzY2VSZWZyZXNoOiBmdW5jdGlvbiBjb2FsZXNjZVJlZnJlc2goY2FsbGJhY2ssIHN5bmMpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZiAoc2VsZi5yZWZyZXNoQ2FsbGJhY2tzLnB1c2goY2FsbGJhY2spID09PSAxKSB7CiAgICAgICAgc2VsZi5sb2FkKGZ1bmN0aW9uIG9uTG9hZChlcnIpIHsKICAgICAgICAgIEFXUy51dGlsLmFycmF5RWFjaChzZWxmLnJlZnJlc2hDYWxsYmFja3MsIGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGlmIChzeW5jKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyBjYWxsYmFjayBjb3VsZCB0aHJvdywgc28gZGVmZXIgdG8gZW5zdXJlIGFsbCBjYWxsYmFja3MgYXJlIG5vdGlmaWVkCiAgICAgICAgICAgICAgQVdTLnV0aWwuZGVmZXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBzZWxmLnJlZnJlc2hDYWxsYmFja3MubGVuZ3RoID0gMDsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgICAqLwogICAgbG9hZDogZnVuY3Rpb24gbG9hZChjYWxsYmFjaykgewogICAgICBjYWxsYmFjaygpOwogICAgfQogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5DcmVkZW50aWFscy5hZGRQcm9taXNlc1RvQ2xhc3MgPSBmdW5jdGlvbiBhZGRQcm9taXNlc1RvQ2xhc3MoUHJvbWlzZURlcGVuZGVuY3kpIHsKICAgIHRoaXMucHJvdG90eXBlLmdldFByb21pc2UgPSBBV1MudXRpbC5wcm9taXNpZnlNZXRob2QoJ2dldCcsIFByb21pc2VEZXBlbmRlbmN5KTsKICAgIHRoaXMucHJvdG90eXBlLnJlZnJlc2hQcm9taXNlID0gQVdTLnV0aWwucHJvbWlzaWZ5TWV0aG9kKCdyZWZyZXNoJywgUHJvbWlzZURlcGVuZGVuY3kpOwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLkNyZWRlbnRpYWxzLmRlbGV0ZVByb21pc2VzRnJvbUNsYXNzID0gZnVuY3Rpb24gZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MoKSB7CiAgICBkZWxldGUgdGhpcy5wcm90b3R5cGUuZ2V0UHJvbWlzZTsKICAgIGRlbGV0ZSB0aGlzLnByb3RvdHlwZS5yZWZyZXNoUHJvbWlzZTsKICB9OwogIAogIEFXUy51dGlsLmFkZFByb21pc2VzKEFXUy5DcmVkZW50aWFscyk7CiAgCiAgfSx7Ii4vY29yZSI6MTh9XSwyMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIHRlbXBvcmFyeSBjcmVkZW50aWFscyByZXRyaWV2ZWQgZnJvbSB7QVdTLlNUU30uIFdpdGhvdXQgYW55CiAgICogZXh0cmEgcGFyYW1ldGVycywgY3JlZGVudGlhbHMgd2lsbCBiZSBmZXRjaGVkIGZyb20gdGhlCiAgICoge0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSBvcGVyYXRpb24uIElmIGFuIElBTSByb2xlIGlzIHByb3ZpZGVkLCB0aGUKICAgKiB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvcGVyYXRpb24gd2lsbCBiZSB1c2VkIHRvIGZldGNoIGNyZWRlbnRpYWxzIGZvciB0aGUKICAgKiByb2xlIGluc3RlYWQuCiAgICoKICAgKiBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgZGlmZmVycyBmcm9tIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyBpbgogICAqIHRoZSB3YXkgbWFzdGVyQ3JlZGVudGlhbHMgYW5kIHJlZnJlc2hlcyBhcmUgaGFuZGxlZC4KICAgKiBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgcmVmcmVzaGVzIGV4cGlyZWQgY3JlZGVudGlhbHMgdXNpbmcgdGhlCiAgICogbWFzdGVyQ3JlZGVudGlhbHMgcGFzc2VkIGJ5IHRoZSB1c2VyIHRvIHN1cHBvcnQgY2hhaW5pbmcgb2YgU1RTIGNyZWRlbnRpYWxzLgogICAqIEhvd2V2ZXIsIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyByZWN1cnNpdmVseSBjb2xsYXBzZXMgdGhlIG1hc3RlckNyZWRlbnRpYWxzCiAgICogZHVyaW5nIGluc3RhbnRpYXRpb24sIHByZWNsdWRpbmcgdGhlIGFiaWxpdHkgdG8gcmVmcmVzaCBjcmVkZW50aWFscyB3aGljaAogICAqIHJlcXVpcmUgaW50ZXJtZWRpYXRlLCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMuCiAgICoKICAgKiBGb3IgZXhhbXBsZSwgaWYgdGhlIGFwcGxpY2F0aW9uIHNob3VsZCB1c2UgUm9sZUEsIHdoaWNoIG11c3QgYmUgYXNzdW1lZCBmcm9tCiAgICogUm9sZUIsIGFuZCB0aGUgZW52aXJvbm1lbnQgcHJvdmlkZXMgY3JlZGVudGlhbHMgd2hpY2ggY2FuIGFzc3VtZSBSb2xlQiwgdGhlbgogICAqIEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyBtdXN0IGJlIHVzZWQgdG8gc3VwcG9ydCByZWZyZXNoaW5nIHRoZQogICAqIHRlbXBvcmFyeSBjcmVkZW50aWFscyBmb3IgUm9sZUE6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogdmFyIHJvbGVBQ3JlZHMgPSBuZXcgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICAgKiAgIHBhcmFtczoge1JvbGVBcm46ICdSb2xlQSd9LAogICAqICAgbWFzdGVyQ3JlZGVudGlhbHM6IG5ldyBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogICAqICAgICBwYXJhbXM6IHtSb2xlQXJuOiAnUm9sZUInfSwKICAgKiAgICAgbWFzdGVyQ3JlZGVudGlhbHM6IG5ldyBBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFscygnQVdTJykKICAgKiAgIH0pCiAgICogfSk7CiAgICogYGBgCiAgICoKICAgKiBJZiBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgaGFkIGJlZW4gdXNlZCBpbiB0aGUgcHJldmlvdXMgZXhhbXBsZSwKICAgKiBgcm9sZUFDcmVkc2Agd291bGQgZmFpbCB0byByZWZyZXNoIGJlY2F1c2UgYHJvbGVBQ3JlZHNgIHdvdWxkCiAgICogdXNlIHRoZSBlbnZpcm9ubWVudCBjcmVkZW50aWFscyBmb3IgdGhlIEFzc3VtZVJvbGUgcmVxdWVzdC4KICAgKgogICAqIEFub3RoZXIgZGlmZmVyZW5jZSBpcyB0aGF0IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyBjcmVhdGVzIHRoZSBTVFMKICAgKiBzZXJ2aWNlIGluc3RhbmNlIGR1cmluZyBpbnN0YW50aWF0aW9uIHdoaWxlIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyBjcmVhdGVzCiAgICogdGhlIFNUUyBzZXJ2aWNlIGluc3RhbmNlIGR1cmluZyB0aGUgZmlyc3QgcmVmcmVzaC4gQ3JlYXRpbmcgdGhlIHNlcnZpY2UKICAgKiBpbnN0YW5jZSBkdXJpbmcgaW5zdGFudGlhdGlvbiBlZmZlY3RpdmVseSBjYXB0dXJlcyB0aGUgbWFzdGVyIGNyZWRlbnRpYWxzCiAgICogZnJvbSB0aGUgZ2xvYmFsIGNvbmZpZywgc28gdGhhdCBzdWJzZXF1ZW50IGNoYW5nZXMgdG8gdGhlIGdsb2JhbCBjb25maWcgZG8KICAgKiBub3QgYWZmZWN0IHRoZSBtYXN0ZXIgY3JlZGVudGlhbHMgdXNlZCB0byByZWZyZXNoIHRoZSB0ZW1wb3JhcnkgY3JlZGVudGlhbHMuCiAgICoKICAgKiBUaGlzIGFsbG93cyBhbiBpbnN0YW5jZSBvZiBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgdG8gYmUgYXNzaWduZWQKICAgKiB0byBBV1MuY29uZmlnLmNyZWRlbnRpYWxzOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIHZhciBlbnZDcmVkcyA9IG5ldyBBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFscygnQVdTJyk7CiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IGVudkNyZWRzOwogICAqIC8vIG1hc3RlckNyZWRlbnRpYWxzIHdpbGwgYmUgZW52Q3JlZHMKICAgKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyh7CiAgICogICBwYXJhbXM6IHtSb2xlQXJuOiAnLi4uJ30KICAgKiB9KTsKICAgKiBgYGAKICAgKgogICAqIFNpbWlsYXJseSwgdG8gdXNlIHRoZSBDcmVkZW50aWFsUHJvdmlkZXJDaGFpbidzIGRlZmF1bHQgcHJvdmlkZXJzIGFzIHRoZQogICAqIG1hc3RlciBjcmVkZW50aWFscywgc2ltcGx5IGNyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZgogICAqIEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFsczoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IENoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICAgKiAgIHBhcmFtczoge1JvbGVBcm46ICcuLi4nfQogICAqIH0pOwogICAqIGBgYAogICAqCiAgICogQCFhdHRyaWJ1dGUgc2VydmljZQogICAqICAgQHJldHVybiBbQVdTLlNUU10gdGhlIFNUUyBzZXJ2aWNlIGluc3RhbmNlIHVzZWQgdG8KICAgKiAgICAgZ2V0IGFuZCByZWZyZXNoIHRlbXBvcmFyeSBjcmVkZW50aWFscyBmcm9tIEFXUyBTVFMuCiAgICogQG5vdGUgKHNlZSBjb25zdHJ1Y3RvcikKICAgKi8KICBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IHRlbXBvcmFyeSBjcmVkZW50aWFscyBvYmplY3QuCiAgICAgKgogICAgICogQHBhcmFtIG9wdGlvbnMgW21hcF0gYSBzZXQgb2Ygb3B0aW9ucwogICAgICogQG9wdGlvbiBvcHRpb25zIHBhcmFtcyBbbWFwXSAoe30pIGEgbWFwIG9mIG9wdGlvbnMgdGhhdCBhcmUgcGFzc2VkIHRvIHRoZQogICAgICogICB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvciB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59IG9wZXJhdGlvbnMuCiAgICAgKiAgIElmIGEgYFJvbGVBcm5gIHBhcmFtZXRlciBpcyBwYXNzZWQgaW4sIGNyZWRlbnRpYWxzIHdpbGwgYmUgYmFzZWQgb24gdGhlCiAgICAgKiAgIElBTSByb2xlLiBJZiBhIGBTZXJpYWxOdW1iZXJgIHBhcmFtZXRlciBpcyBwYXNzZWQgaW4sIHt0b2tlbkNvZGVGbn0gbXVzdAogICAgICogICBhbHNvIGJlIHBhc3NlZCBpbiBvciBhbiBlcnJvciB3aWxsIGJlIHRocm93bi4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBtYXN0ZXJDcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgbWFzdGVyIGNyZWRlbnRpYWxzCiAgICAgKiAgIHVzZWQgdG8gZ2V0IGFuZCByZWZyZXNoIHRlbXBvcmFyeSBjcmVkZW50aWFscyBmcm9tIEFXUyBTVFMuIEJ5IGRlZmF1bHQsCiAgICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgb3IgQVdTLmNvbmZpZy5jcmVkZW50aWFsUHJvdmlkZXIgd2lsbCBiZSB1c2VkLgogICAgICogQG9wdGlvbiBvcHRpb25zIHRva2VuQ29kZUZuIFtGdW5jdGlvbl0gKG51bGwpIEZ1bmN0aW9uIHRvIHByb3ZpZGUKICAgICAqICAgYFRva2VuQ29kZWAsIGlmIGBTZXJpYWxOdW1iZXJgIGlzIHByb3ZpZGVkIGZvciBwcm9maWxlIGluIHtwYXJhbXN9LiBGdW5jdGlvbgogICAgICogICBpcyBjYWxsZWQgd2l0aCB2YWx1ZSBvZiBgU2VyaWFsTnVtYmVyYCBhbmQgYGNhbGxiYWNrYCwgYW5kIHNob3VsZCBwcm92aWRlCiAgICAgKiAgIHRoZSBgVG9rZW5Db2RlYCBvciBhbiBlcnJvciB0byB0aGUgY2FsbGJhY2sgaW4gdGhlIGZvcm1hdAogICAgICogICBgY2FsbGJhY2soZXJyLCB0b2tlbilgLgogICAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0IGZvciBnZW5lcmljIHRlbXBvcmFyeSBjcmVkZW50aWFscwogICAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscygpOwogICAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0IGZvciBhbiBJQU0gcm9sZQogICAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyh7CiAgICAgKiAgICAgcGFyYW1zOiB7CiAgICAgKiAgICAgICBSb2xlQXJuOiAnYXJuOmF3czppYW06OjEyMzQ1Njc4OTA6cm9sZS9UZW1wb3JhcnlDcmVkZW50aWFscycKICAgICAqICAgICB9CiAgICAgKiAgIH0pOwogICAgICogQHNlZSBBV1MuU1RTLmFzc3VtZVJvbGUKICAgICAqIEBzZWUgQVdTLlNUUy5nZXRTZXNzaW9uVG9rZW4KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIENoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKG9wdGlvbnMpIHsKICAgICAgQVdTLkNyZWRlbnRpYWxzLmNhbGwodGhpcyk7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB0aGlzLmVycm9yQ29kZSA9ICdDaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFsc1Byb3ZpZGVyRmFpbHVyZSc7CiAgICAgIHRoaXMuZXhwaXJlZCA9IHRydWU7CiAgICAgIHRoaXMudG9rZW5Db2RlRm4gPSBudWxsOwogIAogICAgICB2YXIgcGFyYW1zID0gQVdTLnV0aWwuY29weShvcHRpb25zLnBhcmFtcykgfHwge307CiAgICAgIGlmIChwYXJhbXMuUm9sZUFybikgewogICAgICAgIHBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgPSBwYXJhbXMuUm9sZVNlc3Npb25OYW1lIHx8ICd0ZW1wb3JhcnktY3JlZGVudGlhbHMnOwogICAgICB9CiAgICAgIGlmIChwYXJhbXMuU2VyaWFsTnVtYmVyKSB7CiAgICAgICAgaWYgKCFvcHRpb25zLnRva2VuQ29kZUZuIHx8ICh0eXBlb2Ygb3B0aW9ucy50b2tlbkNvZGVGbiAhPT0gJ2Z1bmN0aW9uJykpIHsKICAgICAgICAgIHRocm93IG5ldyBBV1MudXRpbC5lcnJvcigKICAgICAgICAgICAgbmV3IEVycm9yKCd0b2tlbkNvZGVGbiBtdXN0IGJlIGEgZnVuY3Rpb24gd2hlbiBwYXJhbXMuU2VyaWFsTnVtYmVyIGlzIGdpdmVuJyksCiAgICAgICAgICAgIHtjb2RlOiB0aGlzLmVycm9yQ29kZX0KICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMudG9rZW5Db2RlRm4gPSBvcHRpb25zLnRva2VuQ29kZUZuOwogICAgICAgIH0KICAgICAgfQogICAgICB2YXIgY29uZmlnID0gQVdTLnV0aWwubWVyZ2UoCiAgICAgICAgewogICAgICAgICAgcGFyYW1zOiBwYXJhbXMsCiAgICAgICAgICBjcmVkZW50aWFsczogb3B0aW9ucy5tYXN0ZXJDcmVkZW50aWFscyB8fCBBV1MuY29uZmlnLmNyZWRlbnRpYWxzCiAgICAgICAgfSwKICAgICAgICBvcHRpb25zLnN0c0NvbmZpZyB8fCB7fQogICAgICApOwogICAgICB0aGlzLnNlcnZpY2UgPSBuZXcgU1RTKGNvbmZpZyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBSZWZyZXNoZXMgY3JlZGVudGlhbHMgdXNpbmcge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3IKICAgICAqIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0sIGRlcGVuZGluZyBvbiB3aGV0aGVyIGFuIElBTSByb2xlIEFSTiB3YXMgcGFzc2VkCiAgICAgKiB0byB0aGUgY3JlZGVudGlhbHMge2NvbnN0cnVjdG9yfS4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICBDYWxsZWQgd2hlbiB0aGUgU1RTIHNlcnZpY2UgcmVzcG9uZHMgKG9yIGZhaWxzKS4gV2hlbgogICAgICogICB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyB0aGF0IHRoZSBjcmVkZW50aWFscwogICAgICogICBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwKICAgICAqICAgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKiBAc2VlIEFXUy5DcmVkZW50aWFscy5nZXQKICAgICAqLwogICAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaChjYWxsYmFjaykgewogICAgICB0aGlzLmNvYWxlc2NlUmVmcmVzaChjYWxsYmFjayB8fCBBV1MudXRpbC5mbi5jYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqIEBwYXJhbSBjYWxsYmFjawogICAgICovCiAgICBsb2FkOiBmdW5jdGlvbiBsb2FkKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIG9wZXJhdGlvbiA9IHNlbGYuc2VydmljZS5jb25maWcucGFyYW1zLlJvbGVBcm4gPyAnYXNzdW1lUm9sZScgOiAnZ2V0U2Vzc2lvblRva2VuJzsKICAgICAgdGhpcy5nZXRUb2tlbkNvZGUoZnVuY3Rpb24gKGVyciwgdG9rZW5Db2RlKSB7CiAgICAgICAgdmFyIHBhcmFtcyA9IHt9OwogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh0b2tlbkNvZGUpIHsKICAgICAgICAgIHBhcmFtcy5Ub2tlbkNvZGUgPSB0b2tlbkNvZGU7CiAgICAgICAgfQogICAgICAgIHNlbGYuc2VydmljZVtvcGVyYXRpb25dKHBhcmFtcywgZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgICAgc2VsZi5zZXJ2aWNlLmNyZWRlbnRpYWxzRnJvbShkYXRhLCBzZWxmKTsKICAgICAgICAgIH0KICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldFRva2VuQ29kZTogZnVuY3Rpb24gZ2V0VG9rZW5Db2RlKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgaWYgKHRoaXMudG9rZW5Db2RlRm4pIHsKICAgICAgICB0aGlzLnRva2VuQ29kZUZuKHRoaXMuc2VydmljZS5jb25maWcucGFyYW1zLlNlcmlhbE51bWJlciwgZnVuY3Rpb24gKGVyciwgdG9rZW4pIHsKICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBlcnI7CiAgICAgICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgICAgICAgIG1lc3NhZ2UgPSBlcnIubWVzc2FnZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYWxsYmFjaygKICAgICAgICAgICAgICBBV1MudXRpbC5lcnJvcigKICAgICAgICAgICAgICAgIG5ldyBFcnJvcignRXJyb3IgZmV0Y2hpbmcgTUZBIHRva2VuOiAnICsgbWVzc2FnZSksCiAgICAgICAgICAgICAgICB7IGNvZGU6IHNlbGYuZXJyb3JDb2RlfQogICAgICAgICAgICAgICkKICAgICAgICAgICAgKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgY2FsbGJhY2sobnVsbCwgdG9rZW4pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrKG51bGwpOwogICAgICB9CiAgICB9CiAgfSk7CiAgCiAgfSx7Ii4uLy4uL2NsaWVudHMvc3RzIjo4LCIuLi9jb3JlIjoxOH1dLDIxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBDb2duaXRvSWRlbnRpdHkgPSByZXF1aXJlKCcuLi8uLi9jbGllbnRzL2NvZ25pdG9pZGVudGl0eScpOwogIHZhciBTVFMgPSByZXF1aXJlKCcuLi8uLi9jbGllbnRzL3N0cycpOwogIAogIC8qKgogICAqIFJlcHJlc2VudHMgY3JlZGVudGlhbHMgcmV0cmlldmVkIGZyb20gU1RTIFdlYiBJZGVudGl0eSBGZWRlcmF0aW9uIHVzaW5nCiAgICogdGhlIEFtYXpvbiBDb2duaXRvIElkZW50aXR5IHNlcnZpY2UuCiAgICoKICAgKiBCeSBkZWZhdWx0IHRoaXMgcHJvdmlkZXIgZ2V0cyBjcmVkZW50aWFscyB1c2luZyB0aGUKICAgKiB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5fSBzZXJ2aWNlIG9wZXJhdGlvbiwgd2hpY2gKICAgKiByZXF1aXJlcyBlaXRoZXIgYW4gYElkZW50aXR5SWRgIG9yIGFuIGBJZGVudGl0eVBvb2xJZGAgKEFtYXpvbiBDb2duaXRvCiAgICogSWRlbnRpdHkgUG9vbCBJRCksIHdoaWNoIGlzIHVzZWQgdG8gY2FsbCB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRJZH0gdG8KICAgKiBvYnRhaW4gYW4gYElkZW50aXR5SWRgLiBJZiB0aGUgaWRlbnRpdHkgb3IgaWRlbnRpdHkgcG9vbCBpcyBub3QgY29uZmlndXJlZCBpbgogICAqIHRoZSBBbWF6b24gQ29nbml0byBDb25zb2xlIHRvIHVzZSBJQU0gcm9sZXMgd2l0aCB0aGUgYXBwcm9wcmlhdGUgcGVybWlzc2lvbnMsCiAgICogdGhlbiBhZGRpdGlvbmFsbHkgYSBgUm9sZUFybmAgaXMgcmVxdWlyZWQgY29udGFpbmluZyB0aGUgQVJOIG9mIHRoZSBJQU0gdHJ1c3QKICAgKiBwb2xpY3kgZm9yIHRoZSBBbWF6b24gQ29nbml0byByb2xlIHRoYXQgdGhlIHVzZXIgd2lsbCBsb2cgaW50by4gSWYgYSBgUm9sZUFybmAKICAgKiBpcyBwcm92aWRlZCwgdGhlbiB0aGlzIHByb3ZpZGVyIGdldHMgY3JlZGVudGlhbHMgdXNpbmcgdGhlCiAgICoge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0gc2VydmljZSBvcGVyYXRpb24sIGFmdGVyIGZpcnN0IGdldHRpbmcgYW4KICAgKiBPcGVuIElEIHRva2VuIGZyb20ge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0T3BlbklkVG9rZW59LgogICAqCiAgICogSW4gYWRkaXRpb24sIGlmIHRoaXMgY3JlZGVudGlhbCBwcm92aWRlciBpcyB1c2VkIHRvIHByb3ZpZGUgYXV0aGVudGljYXRlZAogICAqIGxvZ2luLCB0aGUgYExvZ2luc2AgbWFwIG1heSBiZSBzZXQgdG8gdGhlIHRva2VucyBwcm92aWRlZCBieSB0aGUgcmVzcGVjdGl2ZQogICAqIGlkZW50aXR5IHByb3ZpZGVycy4gU2VlIHtjb25zdHJ1Y3Rvcn0gZm9yIGFuIGV4YW1wbGUgb24gY3JlYXRpbmcgYSBjcmVkZW50aWFscwogICAqIG9iamVjdCB3aXRoIHByb3BlciBwcm9wZXJ0eSB2YWx1ZXMuCiAgICoKICAgKiAjIyBSZWZyZXNoaW5nIENyZWRlbnRpYWxzIGZyb20gSWRlbnRpdHkgU2VydmljZQogICAqCiAgICogSW4gYWRkaXRpb24gdG8gQVdTIGNyZWRlbnRpYWxzIGV4cGlyaW5nIGFmdGVyIGEgZ2l2ZW4gYW1vdW50IG9mIHRpbWUsIHRoZQogICAqIGxvZ2luIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyIHdpbGwgYWxzbyBleHBpcmUuIE9uY2UgdGhpcyB0b2tlbgogICAqIGV4cGlyZXMsIGl0IHdpbGwgbm90IGJlIHVzYWJsZSB0byByZWZyZXNoIEFXUyBjcmVkZW50aWFscywgYW5kIGFub3RoZXIKICAgKiB0b2tlbiB3aWxsIGJlIG5lZWRlZC4gVGhlIFNESyBkb2VzIG5vdCBtYW5hZ2UgcmVmcmVzaGluZyBvZiB0aGUgdG9rZW4gdmFsdWUsCiAgICogYnV0IHRoaXMgY2FuIGJlIGRvbmUgdGhyb3VnaCBhICJyZWZyZXNoIHRva2VuIiBzdXBwb3J0ZWQgYnkgbW9zdCBpZGVudGl0eQogICAqIHByb3ZpZGVycy4gQ29uc3VsdCB0aGUgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIGlkZW50aXR5IHByb3ZpZGVyIGZvciByZWZyZXNoaW5nCiAgICogdG9rZW5zLiBPbmNlIHRoZSByZWZyZXNoZWQgdG9rZW4gaXMgYWNxdWlyZWQsIHlvdSBzaG91bGQgbWFrZSBzdXJlIHRvIHVwZGF0ZQogICAqIHRoaXMgbmV3IHRva2VuIGluIHRoZSBjcmVkZW50aWFscyBvYmplY3QncyB7cGFyYW1zfSBwcm9wZXJ0eS4gVGhlIGZvbGxvd2luZwogICAqIGNvZGUgd2lsbCB1cGRhdGUgdGhlIFdlYklkZW50aXR5VG9rZW4sIGFzc3VtaW5nIHlvdSBoYXZlIHJldHJpZXZlZCBhbiB1cGRhdGVkCiAgICogdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXI6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscy5wYXJhbXMuTG9naW5zWydncmFwaC5mYWNlYm9vay5jb20nXSA9IHVwZGF0ZWRUb2tlbjsKICAgKiBgYGAKICAgKgogICAqIEZ1dHVyZSBjYWxscyB0byBgY3JlZGVudGlhbHMucmVmcmVzaCgpYCB3aWxsIG5vdyB1c2UgdGhlIG5ldyB0b2tlbi4KICAgKgogICAqIEAhYXR0cmlidXRlIHBhcmFtcwogICAqICAgQHJldHVybiBbbWFwXSB0aGUgbWFwIG9mIHBhcmFtcyBwYXNzZWQgdG8KICAgKiAgICAge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0SWR9LAogICAqICAgICB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRPcGVuSWRUb2tlbn0sIGFuZAogICAqICAgICB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4gVG8gdXBkYXRlIHRoZSB0b2tlbiwgc2V0IHRoZQogICAqICAgICBgcGFyYW1zLldlYklkZW50aXR5VG9rZW5gIHByb3BlcnR5LgogICAqIEAhYXR0cmlidXRlIGRhdGEKICAgKiAgIEByZXR1cm4gW21hcF0gdGhlIHJhdyBkYXRhIHJlc3BvbnNlIGZyb20gdGhlIGNhbGwgdG8KICAgKiAgICAge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eX0sIG9yCiAgICogICAgIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LiBVc2UgdGhpcyBpZiB5b3Ugd2FudCB0byBnZXQKICAgKiAgICAgYWNjZXNzIHRvIG90aGVyIHByb3BlcnRpZXMgZnJvbSB0aGUgcmVzcG9uc2UuCiAgICogQCFhdHRyaWJ1dGUgaWRlbnRpdHlJZAogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgQ29nbml0byBJRCByZXR1cm5lZCBieSB0aGUgbGFzdCBjYWxsIHRvCiAgICogICAgIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldE9wZW5JZFRva2VufS4gVGhpcyBJRCByZXByZXNlbnRzIHRoZSBhY3R1YWwKICAgKiAgICAgZmluYWwgcmVzb2x2ZWQgaWRlbnRpdHkgSUQgZnJvbSBBbWF6b24gQ29nbml0by4KICAgKi8KICBBV1MuQ29nbml0b0lkZW50aXR5Q3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9jYWxTdG9yYWdlS2V5OiB7CiAgICAgIGlkOiAnYXdzLmNvZ25pdG8uaWRlbnRpdHktaWQuJywKICAgICAgcHJvdmlkZXJzOiAnYXdzLmNvZ25pdG8uaWRlbnRpdHktcHJvdmlkZXJzLicKICAgIH0sCiAgCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0LgogICAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0CiAgICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNvZ25pdG9JZGVudGl0eUNyZWRlbnRpYWxzKHsKICAgICAqCiAgICAgKiAgICAgLy8gZWl0aGVyIElkZW50aXR5UG9vbElkIG9yIElkZW50aXR5SWQgaXMgcmVxdWlyZWQKICAgICAqICAgICAvLyBTZWUgdGhlIElkZW50aXR5UG9vbElkIHBhcmFtIGZvciBBV1MuQ29nbml0b0lkZW50aXR5LmdldElEIChsaW5rZWQgYmVsb3cpCiAgICAgKiAgICAgLy8gU2VlIHRoZSBJZGVudGl0eUlkIHBhcmFtIGZvciBBV1MuQ29nbml0b0lkZW50aXR5LmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkKICAgICAqICAgICAvLyBvciBBV1MuQ29nbml0b0lkZW50aXR5LmdldE9wZW5JZFRva2VuIChsaW5rZWQgYmVsb3cpCiAgICAgKiAgICAgSWRlbnRpdHlQb29sSWQ6ICd1cy1lYXN0LTE6MTY5OWViYzAtNzkwMC00MDk5LWI5MTAtMmRmOTRmNTJhMDMwJywKICAgICAqICAgICBJZGVudGl0eUlkOiAndXMtZWFzdC0xOjEyOGQwYTc0LWM4MmYtNDU1My05MTZkLTkwMDUzZTRhOGIwZicKICAgICAqCiAgICAgKiAgICAgLy8gb3B0aW9uYWwsIG9ubHkgbmVjZXNzYXJ5IHdoZW4gdGhlIGlkZW50aXR5IHBvb2wgaXMgbm90IGNvbmZpZ3VyZWQKICAgICAqICAgICAvLyB0byB1c2UgSUFNIHJvbGVzIGluIHRoZSBBbWF6b24gQ29nbml0byBDb25zb2xlCiAgICAgKiAgICAgLy8gU2VlIHRoZSBSb2xlQXJuIHBhcmFtIGZvciBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkgKGxpbmtlZCBiZWxvdykKICAgICAqICAgICBSb2xlQXJuOiAnYXJuOmF3czppYW06OjEyMzQ1Njc4OTA6cm9sZS9NWUFQUC1Db2duaXRvSWRlbnRpdHknLAogICAgICoKICAgICAqICAgICAvLyBvcHRpb25hbCB0b2tlbnMsIHVzZWQgZm9yIGF1dGhlbnRpY2F0ZWQgbG9naW4KICAgICAqICAgICAvLyBTZWUgdGhlIExvZ2lucyBwYXJhbSBmb3IgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRJRCAobGlua2VkIGJlbG93KQogICAgICogICAgIExvZ2luczogewogICAgICogICAgICAgJ2dyYXBoLmZhY2Vib29rLmNvbSc6ICdGQlRPS0VOJywKICAgICAqICAgICAgICd3d3cuYW1hem9uLmNvbSc6ICdBTUFaT05UT0tFTicsCiAgICAgKiAgICAgICAnYWNjb3VudHMuZ29vZ2xlLmNvbSc6ICdHT09HTEVUT0tFTicsCiAgICAgKiAgICAgICAnYXBpLnR3aXR0ZXIuY29tJzogJ1RXSVRURVJUT0tFTicsCiAgICAgKiAgICAgICAnd3d3LmRpZ2l0cy5jb20nOiAnRElHSVRTVE9LRU4nCiAgICAgKiAgICAgfSwKICAgICAqCiAgICAgKiAgICAgLy8gb3B0aW9uYWwgbmFtZSwgZGVmYXVsdHMgdG8gd2ViLWlkZW50aXR5CiAgICAgKiAgICAgLy8gU2VlIHRoZSBSb2xlU2Vzc2lvbk5hbWUgcGFyYW0gZm9yIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eSAobGlua2VkIGJlbG93KQogICAgICogICAgIFJvbGVTZXNzaW9uTmFtZTogJ3dlYicsCiAgICAgKgogICAgICogICAgIC8vIG9wdGlvbmFsLCBvbmx5IG5lY2Vzc2FyeSB3aGVuIGFwcGxpY2F0aW9uIHJ1bnMgaW4gYSBicm93c2VyCiAgICAgKiAgICAgLy8gYW5kIG11bHRpcGxlIHVzZXJzIGFyZSBzaWduZWQgaW4gYXQgb25jZSwgdXNlZCBmb3IgY2FjaGluZwogICAgICogICAgIExvZ2luSWQ6ICdleGFtcGxlQGdtYWlsLmNvbScKICAgICAqCiAgICAgKiAgIH0sIHsKICAgICAqICAgICAgLy8gb3B0aW9uYWxseSBwcm92aWRlIGNvbmZpZ3VyYXRpb24gdG8gYXBwbHkgdG8gdGhlIHVuZGVybHlpbmcgc2VydmljZSBjbGllbnRzCiAgICAgKiAgICAgIC8vIGlmIGNvbmZpZ3VyYXRpb24gaXMgbm90IHByb3ZpZGVkLCB0aGVuIGNvbmZpZ3VyYXRpb24gd2lsbCBiZSBwdWxsZWQgZnJvbSBBV1MuY29uZmlnCiAgICAgKgogICAgICogICAgICAvLyByZWdpb24gc2hvdWxkIG1hdGNoIHRoZSByZWdpb24geW91ciBpZGVudGl0eSBwb29sIGlzIGxvY2F0ZWQgaW4KICAgICAqICAgICAgcmVnaW9uOiAndXMtZWFzdC0xJywKICAgICAqCiAgICAgKiAgICAgIC8vIHNwZWNpZnkgdGltZW91dCBvcHRpb25zCiAgICAgKiAgICAgIGh0dHBPcHRpb25zOiB7CiAgICAgKiAgICAgICAgdGltZW91dDogMTAwCiAgICAgKiAgICAgIH0KICAgICAqICAgfSk7CiAgICAgKiBAc2VlIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0SWQKICAgICAqIEBzZWUgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5CiAgICAgKiBAc2VlIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eQogICAgICogQHNlZSBBV1MuQ29nbml0b0lkZW50aXR5LmdldE9wZW5JZFRva2VuCiAgICAgKiBAc2VlIEFXUy5Db25maWcKICAgICAqIEBub3RlIElmIGEgcmVnaW9uIGlzIG5vdCBwcm92aWRlZCBpbiB0aGUgZ2xvYmFsIEFXUy5jb25maWcsIG9yCiAgICAgKiAgIHNwZWNpZmllZCBpbiB0aGUgYGNsaWVudENvbmZpZ2AgdG8gdGhlIENvZ25pdG9JZGVudGl0eUNyZWRlbnRpYWxzCiAgICAgKiAgIGNvbnN0cnVjdG9yLCB5b3UgbWF5IGVuY291bnRlciBhICdNaXNzaW5nIGNyZWRlbnRpYWxzIGluIGNvbmZpZycgZXJyb3IKICAgICAqICAgd2hlbiBjYWxsaW5nIG1ha2luZyBhIHNlcnZpY2UgY2FsbC4KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIENvZ25pdG9JZGVudGl0eUNyZWRlbnRpYWxzKHBhcmFtcywgY2xpZW50Q29uZmlnKSB7CiAgICAgIEFXUy5DcmVkZW50aWFscy5jYWxsKHRoaXMpOwogICAgICB0aGlzLmV4cGlyZWQgPSB0cnVlOwogICAgICB0aGlzLnBhcmFtcyA9IHBhcmFtczsKICAgICAgdGhpcy5kYXRhID0gbnVsbDsKICAgICAgdGhpcy5faWRlbnRpdHlJZCA9IG51bGw7CiAgICAgIHRoaXMuX2NsaWVudENvbmZpZyA9IEFXUy51dGlsLmNvcHkoY2xpZW50Q29uZmlnIHx8IHt9KTsKICAgICAgdGhpcy5sb2FkQ2FjaGVkSWQoKTsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ2lkZW50aXR5SWQnLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHNlbGYubG9hZENhY2hlZElkKCk7CiAgICAgICAgICByZXR1cm4gc2VsZi5faWRlbnRpdHlJZCB8fCBzZWxmLnBhcmFtcy5JZGVudGl0eUlkOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbihpZGVudGl0eUlkKSB7CiAgICAgICAgICBzZWxmLl9pZGVudGl0eUlkID0gaWRlbnRpdHlJZDsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogUmVmcmVzaGVzIGNyZWRlbnRpYWxzIHVzaW5nIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHl9LAogICAgICogb3Ige0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgQ2FsbGVkIHdoZW4gdGhlIFNUUyBzZXJ2aWNlIHJlc3BvbmRzIChvciBmYWlscykuIFdoZW4KICAgICAqICAgdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgdGhhdCB0aGUgY3JlZGVudGlhbHMKICAgICAqICAgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsCiAgICAgKiAgIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogQHNlZSBBV1MuQ3JlZGVudGlhbHMuZ2V0CiAgICAgKi8KICAgIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2goY2FsbGJhY2spIHsKICAgICAgdGhpcy5jb2FsZXNjZVJlZnJlc2goY2FsbGJhY2sgfHwgQVdTLnV0aWwuZm4uY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgICAqLwogICAgbG9hZDogZnVuY3Rpb24gbG9hZChjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHNlbGYuY3JlYXRlQ2xpZW50cygpOwogICAgICBzZWxmLmRhdGEgPSBudWxsOwogICAgICBzZWxmLl9pZGVudGl0eUlkID0gbnVsbDsKICAgICAgc2VsZi5nZXRJZChmdW5jdGlvbihlcnIpIHsKICAgICAgICBpZiAoIWVycikgewogICAgICAgICAgaWYgKCFzZWxmLnBhcmFtcy5Sb2xlQXJuKSB7CiAgICAgICAgICAgIHNlbGYuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eShjYWxsYmFjayk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxmLmdldENyZWRlbnRpYWxzRnJvbVNUUyhjYWxsYmFjayk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYuY2xlYXJJZE9uTm90QXV0aG9yaXplZChlcnIpOwogICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQ2xlYXJzIHRoZSBjYWNoZWQgQ29nbml0byBJRCBhc3NvY2lhdGVkIHdpdGggdGhlIGN1cnJlbnRseSBjb25maWd1cmVkCiAgICAgKiBpZGVudGl0eSBwb29sIElELiBVc2UgdGhpcyB0byBtYW51YWxseSBpbnZhbGlkYXRlIHlvdXIgY2FjaGUgaWYKICAgICAqIHRoZSBpZGVudGl0eSBwb29sIElEIHdhcyBkZWxldGVkLgogICAgICovCiAgICBjbGVhckNhY2hlZElkOiBmdW5jdGlvbiBjbGVhckNhY2hlKCkgewogICAgICB0aGlzLl9pZGVudGl0eUlkID0gbnVsbDsKICAgICAgZGVsZXRlIHRoaXMucGFyYW1zLklkZW50aXR5SWQ7CiAgCiAgICAgIHZhciBwb29sSWQgPSB0aGlzLnBhcmFtcy5JZGVudGl0eVBvb2xJZDsKICAgICAgdmFyIGxvZ2luSWQgPSB0aGlzLnBhcmFtcy5Mb2dpbklkIHx8ICcnOwogICAgICBkZWxldGUgdGhpcy5zdG9yYWdlW3RoaXMubG9jYWxTdG9yYWdlS2V5LmlkICsgcG9vbElkICsgbG9naW5JZF07CiAgICAgIGRlbGV0ZSB0aGlzLnN0b3JhZ2VbdGhpcy5sb2NhbFN0b3JhZ2VLZXkucHJvdmlkZXJzICsgcG9vbElkICsgbG9naW5JZF07CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY2xlYXJJZE9uTm90QXV0aG9yaXplZDogZnVuY3Rpb24gY2xlYXJJZE9uTm90QXV0aG9yaXplZChlcnIpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZiAoZXJyLmNvZGUgPT0gJ05vdEF1dGhvcml6ZWRFeGNlcHRpb24nKSB7CiAgICAgICAgc2VsZi5jbGVhckNhY2hlZElkKCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIFJldHJpZXZlcyBhIENvZ25pdG8gSUQsIGxvYWRpbmcgZnJvbSBjYWNoZSBpZiBpdCB3YXMgYWxyZWFkeSByZXRyaWV2ZWQKICAgICAqIG9uIHRoaXMgZGV2aWNlLgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGlkZW50aXR5SWQpCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yLCBudWxsXSBhbiBlcnJvciBvYmplY3QgaWYgdGhlIGNhbGwgZmFpbGVkIG9yIG51bGwgaWYKICAgICAqICAgICBpdCBzdWNjZWVkZWQuCiAgICAgKiAgIEBwYXJhbSBpZGVudGl0eUlkIFtTdHJpbmcsIG51bGxdIGlmIHN1Y2Nlc3NmdWwsIHRoZSBjYWxsYmFjayB3aWxsIHJldHVybgogICAgICogICAgIHRoZSBDb2duaXRvIElELgogICAgICogQG5vdGUgSWYgbm90IGxvYWRlZCBleHBsaWNpdGx5LCB0aGUgQ29nbml0byBJRCBpcyBsb2FkZWQgYW5kIHN0b3JlZCBpbgogICAgICogICBsb2NhbFN0b3JhZ2UgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQgb2YgYSBkZXZpY2UuCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0SWQ6IGZ1bmN0aW9uIGdldElkKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgaWYgKHR5cGVvZiBzZWxmLnBhcmFtcy5JZGVudGl0eUlkID09PSAnc3RyaW5nJykgewogICAgICAgIHJldHVybiBjYWxsYmFjayhudWxsLCBzZWxmLnBhcmFtcy5JZGVudGl0eUlkKTsKICAgICAgfQogIAogICAgICBzZWxmLmNvZ25pdG8uZ2V0SWQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKCFlcnIgJiYgZGF0YS5JZGVudGl0eUlkKSB7CiAgICAgICAgICBzZWxmLnBhcmFtcy5JZGVudGl0eUlkID0gZGF0YS5JZGVudGl0eUlkOwogICAgICAgICAgY2FsbGJhY2sobnVsbCwgZGF0YS5JZGVudGl0eUlkKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxvYWRDcmVkZW50aWFsczogZnVuY3Rpb24gbG9hZENyZWRlbnRpYWxzKGRhdGEsIGNyZWRlbnRpYWxzKSB7CiAgICAgIGlmICghZGF0YSB8fCAhY3JlZGVudGlhbHMpIHJldHVybjsKICAgICAgY3JlZGVudGlhbHMuZXhwaXJlZCA9IGZhbHNlOwogICAgICBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCA9IGRhdGEuQ3JlZGVudGlhbHMuQWNjZXNzS2V5SWQ7CiAgICAgIGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSA9IGRhdGEuQ3JlZGVudGlhbHMuU2VjcmV0S2V5OwogICAgICBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4gPSBkYXRhLkNyZWRlbnRpYWxzLlNlc3Npb25Ub2tlbjsKICAgICAgY3JlZGVudGlhbHMuZXhwaXJlVGltZSA9IGRhdGEuQ3JlZGVudGlhbHMuRXhwaXJhdGlvbjsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5OiBmdW5jdGlvbiBnZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5KGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgc2VsZi5jb2duaXRvLmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgIHNlbGYuY2FjaGVJZChkYXRhKTsKICAgICAgICAgIHNlbGYuZGF0YSA9IGRhdGE7CiAgICAgICAgICBzZWxmLmxvYWRDcmVkZW50aWFscyhzZWxmLmRhdGEsIHNlbGYpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxmLmNsZWFySWRPbk5vdEF1dGhvcml6ZWQoZXJyKTsKICAgICAgICB9CiAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0Q3JlZGVudGlhbHNGcm9tU1RTOiBmdW5jdGlvbiBnZXRDcmVkZW50aWFsc0Zyb21TVFMoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzZWxmLmNvZ25pdG8uZ2V0T3BlbklkVG9rZW4oZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgIHNlbGYuY2FjaGVJZChkYXRhKTsKICAgICAgICAgIHNlbGYucGFyYW1zLldlYklkZW50aXR5VG9rZW4gPSBkYXRhLlRva2VuOwogICAgICAgICAgc2VsZi53ZWJJZGVudGl0eUNyZWRlbnRpYWxzLnJlZnJlc2goZnVuY3Rpb24od2ViRXJyKSB7CiAgICAgICAgICAgIGlmICghd2ViRXJyKSB7CiAgICAgICAgICAgICAgc2VsZi5kYXRhID0gc2VsZi53ZWJJZGVudGl0eUNyZWRlbnRpYWxzLmRhdGE7CiAgICAgICAgICAgICAgc2VsZi5zdHMuY3JlZGVudGlhbHNGcm9tKHNlbGYuZGF0YSwgc2VsZik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FsbGJhY2sod2ViRXJyKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxmLmNsZWFySWRPbk5vdEF1dGhvcml6ZWQoZXJyKTsKICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkQ2FjaGVkSWQ6IGZ1bmN0aW9uIGxvYWRDYWNoZWRJZCgpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogIAogICAgICAvLyBpbiB0aGUgYnJvd3NlciB3ZSBzb3VyY2UgZGVmYXVsdCBJZGVudGl0eUlkIGZyb20gbG9jYWxTdG9yYWdlCiAgICAgIGlmIChBV1MudXRpbC5pc0Jyb3dzZXIoKSAmJiAhc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCkgewogICAgICAgIHZhciBpZCA9IHNlbGYuZ2V0U3RvcmFnZSgnaWQnKTsKICAgICAgICBpZiAoaWQgJiYgc2VsZi5wYXJhbXMuTG9naW5zKSB7CiAgICAgICAgICB2YXIgYWN0dWFsUHJvdmlkZXJzID0gT2JqZWN0LmtleXMoc2VsZi5wYXJhbXMuTG9naW5zKTsKICAgICAgICAgIHZhciBjYWNoZWRQcm92aWRlcnMgPQogICAgICAgICAgICAoc2VsZi5nZXRTdG9yYWdlKCdwcm92aWRlcnMnKSB8fCAnJykuc3BsaXQoJywnKTsKICAKICAgICAgICAgIC8vIG9ubHkgbG9hZCBJRCBpZiBhdCBsZWFzdCBvbmUgcHJvdmlkZXIgdXNlZCB0aGlzIElEIGJlZm9yZQogICAgICAgICAgdmFyIGludGVyc2VjdCA9IGNhY2hlZFByb3ZpZGVycy5maWx0ZXIoZnVuY3Rpb24obikgewogICAgICAgICAgICByZXR1cm4gYWN0dWFsUHJvdmlkZXJzLmluZGV4T2YobikgIT09IC0xOwogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAoaW50ZXJzZWN0Lmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICBzZWxmLnBhcmFtcy5JZGVudGl0eUlkID0gaWQ7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChpZCkgewogICAgICAgICAgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCA9IGlkOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNyZWF0ZUNsaWVudHM6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgY2xpZW50Q29uZmlnID0gdGhpcy5fY2xpZW50Q29uZmlnOwogICAgICB0aGlzLndlYklkZW50aXR5Q3JlZGVudGlhbHMgPSB0aGlzLndlYklkZW50aXR5Q3JlZGVudGlhbHMgfHwKICAgICAgICBuZXcgQVdTLldlYklkZW50aXR5Q3JlZGVudGlhbHModGhpcy5wYXJhbXMsIGNsaWVudENvbmZpZyk7CiAgICAgIGlmICghdGhpcy5jb2duaXRvKSB7CiAgICAgICAgdmFyIGNvZ25pdG9Db25maWcgPSBBV1MudXRpbC5tZXJnZSh7fSwgY2xpZW50Q29uZmlnKTsKICAgICAgICBjb2duaXRvQ29uZmlnLnBhcmFtcyA9IHRoaXMucGFyYW1zOwogICAgICAgIHRoaXMuY29nbml0byA9IG5ldyBDb2duaXRvSWRlbnRpdHkoY29nbml0b0NvbmZpZyk7CiAgICAgIH0KICAgICAgdGhpcy5zdHMgPSB0aGlzLnN0cyB8fCBuZXcgU1RTKGNsaWVudENvbmZpZyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY2FjaGVJZDogZnVuY3Rpb24gY2FjaGVJZChkYXRhKSB7CiAgICAgIHRoaXMuX2lkZW50aXR5SWQgPSBkYXRhLklkZW50aXR5SWQ7CiAgICAgIHRoaXMucGFyYW1zLklkZW50aXR5SWQgPSB0aGlzLl9pZGVudGl0eUlkOwogIAogICAgICAvLyBjYWNoZSB0aGlzIElkZW50aXR5SWQgaW4gYnJvd3NlciBsb2NhbFN0b3JhZ2UgaWYgcG9zc2libGUKICAgICAgaWYgKEFXUy51dGlsLmlzQnJvd3NlcigpKSB7CiAgICAgICAgdGhpcy5zZXRTdG9yYWdlKCdpZCcsIGRhdGEuSWRlbnRpdHlJZCk7CiAgCiAgICAgICAgaWYgKHRoaXMucGFyYW1zLkxvZ2lucykgewogICAgICAgICAgdGhpcy5zZXRTdG9yYWdlKCdwcm92aWRlcnMnLCBPYmplY3Qua2V5cyh0aGlzLnBhcmFtcy5Mb2dpbnMpLmpvaW4oJywnKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0U3RvcmFnZTogZnVuY3Rpb24gZ2V0U3RvcmFnZShrZXkpIHsKICAgICAgcmV0dXJuIHRoaXMuc3RvcmFnZVt0aGlzLmxvY2FsU3RvcmFnZUtleVtrZXldICsgdGhpcy5wYXJhbXMuSWRlbnRpdHlQb29sSWQgKyAodGhpcy5wYXJhbXMuTG9naW5JZCB8fCAnJyldOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNldFN0b3JhZ2U6IGZ1bmN0aW9uIHNldFN0b3JhZ2Uoa2V5LCB2YWwpIHsKICAgICAgdHJ5IHsKICAgICAgICB0aGlzLnN0b3JhZ2VbdGhpcy5sb2NhbFN0b3JhZ2VLZXlba2V5XSArIHRoaXMucGFyYW1zLklkZW50aXR5UG9vbElkICsgKHRoaXMucGFyYW1zLkxvZ2luSWQgfHwgJycpXSA9IHZhbDsKICAgICAgfSBjYXRjaCAoXykge30KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzdG9yYWdlOiAoZnVuY3Rpb24oKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIHN0b3JhZ2UgPSBBV1MudXRpbC5pc0Jyb3dzZXIoKSAmJiB3aW5kb3cubG9jYWxTdG9yYWdlICE9PSBudWxsICYmIHR5cGVvZiB3aW5kb3cubG9jYWxTdG9yYWdlID09PSAnb2JqZWN0JyA/CiAgICAgICAgICAgIHdpbmRvdy5sb2NhbFN0b3JhZ2UgOiB7fTsKICAKICAgICAgICAvLyBUZXN0IHNldC9yZW1vdmUgd2hpY2ggd291bGQgdGhyb3cgYW4gZXJyb3IgaW4gU2FmYXJpJ3MgcHJpdmF0ZSBicm93c2luZwogICAgICAgIHN0b3JhZ2VbJ2F3cy50ZXN0LXN0b3JhZ2UnXSA9ICdmb29iYXInOwogICAgICAgIGRlbGV0ZSBzdG9yYWdlWydhd3MudGVzdC1zdG9yYWdlJ107CiAgCiAgICAgICAgcmV0dXJuIHN0b3JhZ2U7CiAgICAgIH0gY2F0Y2ggKF8pIHsKICAgICAgICByZXR1cm4ge307CiAgICAgIH0KICAgIH0pKCkKICB9KTsKICAKICB9LHsiLi4vLi4vY2xpZW50cy9jb2duaXRvaWRlbnRpdHkiOjcsIi4uLy4uL2NsaWVudHMvc3RzIjo4LCIuLi9jb3JlIjoxOH1dLDIyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIAogIC8qKgogICAqIENyZWF0ZXMgYSBjcmVkZW50aWFsIHByb3ZpZGVyIGNoYWluIHRoYXQgc2VhcmNoZXMgZm9yIEFXUyBjcmVkZW50aWFscwogICAqIGluIGEgbGlzdCBvZiBjcmVkZW50aWFsIHByb3ZpZGVycyBzcGVjaWZpZWQgYnkgdGhlIHtwcm92aWRlcnN9IHByb3BlcnR5LgogICAqCiAgICogQnkgZGVmYXVsdCwgdGhlIGNoYWluIHdpbGwgdXNlIHRoZSB7ZGVmYXVsdFByb3ZpZGVyc30gdG8gcmVzb2x2ZSBjcmVkZW50aWFscy4KICAgKiBUaGVzZSBwcm92aWRlcnMgd2lsbCBsb29rIGluIHRoZSBlbnZpcm9ubWVudCB1c2luZyB0aGUKICAgKiB7QVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHN9IGNsYXNzIHdpdGggdGhlICdBV1MnIGFuZCAnQU1BWk9OJyBwcmVmaXhlcy4KICAgKgogICAqICMjIFNldHRpbmcgUHJvdmlkZXJzCiAgICoKICAgKiBFYWNoIHByb3ZpZGVyIGluIHRoZSB7cHJvdmlkZXJzfSBsaXN0IHNob3VsZCBiZSBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucwogICAqIGEge0FXUy5DcmVkZW50aWFsc30gb2JqZWN0LCBvciBhIGhhcmRjb2RlZCBjcmVkZW50aWFscyBvYmplY3QuIFRoZSBmdW5jdGlvbgogICAqIGZvcm0gYWxsb3dzIGZvciBkZWxheWVkIGV4ZWN1dGlvbiBvZiB0aGUgY3JlZGVudGlhbCBjb25zdHJ1Y3Rpb24uCiAgICoKICAgKiAjIyBSZXNvbHZpbmcgQ3JlZGVudGlhbHMgZnJvbSBhIENoYWluCiAgICoKICAgKiBDYWxsIHtyZXNvbHZlfSB0byByZXR1cm4gdGhlIGZpcnN0IHZhbGlkIGNyZWRlbnRpYWwgb2JqZWN0IHRoYXQgY2FuIGJlCiAgICogbG9hZGVkIGJ5IHRoZSBwcm92aWRlciBjaGFpbi4KICAgKgogICAqIEZvciBleGFtcGxlLCB0byByZXNvbHZlIGEgY2hhaW4gd2l0aCBhIGN1c3RvbSBwcm92aWRlciB0aGF0IGNoZWNrcyBhIGZpbGUKICAgKiBvbiBkaXNrIGFmdGVyIHRoZSBzZXQgb2Yge2RlZmF1bHRQcm92aWRlcnN9OgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIHZhciBkaXNrUHJvdmlkZXIgPSBuZXcgQVdTLkZpbGVTeXN0ZW1DcmVkZW50aWFscygnLi9jcmVkcy5qc29uJyk7CiAgICogdmFyIGNoYWluID0gbmV3IEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbigpOwogICAqIGNoYWluLnByb3ZpZGVycy5wdXNoKGRpc2tQcm92aWRlcik7CiAgICogY2hhaW4ucmVzb2x2ZSgpOwogICAqIGBgYAogICAqCiAgICogVGhlIGFib3ZlIGNvZGUgd2lsbCByZXR1cm4gdGhlIGBkaXNrUHJvdmlkZXJgIG9iamVjdCBpZiB0aGUKICAgKiBmaWxlIGNvbnRhaW5zIGNyZWRlbnRpYWxzIGFuZCB0aGUgYGRlZmF1bHRQcm92aWRlcnNgIGRvIG5vdCBjb250YWluCiAgICogYW55IGNyZWRlbnRpYWwgc2V0dGluZ3MuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBwcm92aWRlcnMKICAgKiAgIEByZXR1cm4gW0FycmF5PEFXUy5DcmVkZW50aWFscywgRnVuY3Rpb24+XQogICAqICAgICBhIGxpc3Qgb2YgY3JlZGVudGlhbHMgb2JqZWN0cyBvciBmdW5jdGlvbnMgdGhhdCByZXR1cm4gY3JlZGVudGlhbHMKICAgKiAgICAgb2JqZWN0cy4gSWYgdGhlIHByb3ZpZGVyIGlzIGEgZnVuY3Rpb24sIHRoZSBmdW5jdGlvbiB3aWxsIGJlCiAgICogICAgIGV4ZWN1dGVkIGxhemlseSB3aGVuIHRoZSBwcm92aWRlciBuZWVkcyB0byBiZSBjaGVja2VkIGZvciB2YWxpZAogICAqICAgICBjcmVkZW50aWFscy4gQnkgZGVmYXVsdCwgdGhpcyBvYmplY3Qgd2lsbCBiZSBzZXQgdG8gdGhlCiAgICogICAgIHtkZWZhdWx0UHJvdmlkZXJzfS4KICAgKiAgIEBzZWUgZGVmYXVsdFByb3ZpZGVycwogICAqLwogIEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbiA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CiAgCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4gd2l0aCBhIGRlZmF1bHQgc2V0IG9mIHByb3ZpZGVycwogICAgICogc3BlY2lmaWVkIGJ5IHtkZWZhdWx0UHJvdmlkZXJzfS4KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIENyZWRlbnRpYWxQcm92aWRlckNoYWluKHByb3ZpZGVycykgewogICAgICBpZiAocHJvdmlkZXJzKSB7CiAgICAgICAgdGhpcy5wcm92aWRlcnMgPSBwcm92aWRlcnM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5wcm92aWRlcnMgPSBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uZGVmYXVsdFByb3ZpZGVycy5zbGljZSgwKTsKICAgICAgfQogICAgICB0aGlzLnJlc29sdmVDYWxsYmFja3MgPSBbXTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEAhbWV0aG9kICByZXNvbHZlUHJvbWlzZSgpCiAgICAgKiAgIFJldHVybnMgYSAndGhlbmFibGUnIHByb21pc2UuCiAgICAgKiAgIFJlc29sdmVzIHRoZSBwcm92aWRlciBjaGFpbiBieSBzZWFyY2hpbmcgZm9yIHRoZSBmaXJzdCBzZXQgb2YKICAgICAqICAgY3JlZGVudGlhbHMgaW4ge3Byb3ZpZGVyc30uCiAgICAgKgogICAgICogICBUd28gY2FsbGJhY2tzIGNhbiBiZSBwcm92aWRlZCB0byB0aGUgYHRoZW5gIG1ldGhvZCBvbiB0aGUgcmV0dXJuZWQgcHJvbWlzZS4KICAgICAqICAgVGhlIGZpcnN0IGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZCwgYW5kIHRoZSBzZWNvbmQKICAgICAqICAgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICAgKiAgIEBjYWxsYmFjayBmdWxmaWxsZWRDYWxsYmFjayBmdW5jdGlvbihjcmVkZW50aWFscykKICAgICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkIGFuZCB0aGUgcHJvdmlkZXIgcmVzb2x2ZXMgdGhlIGNoYWluCiAgICAgKiAgICAgdG8gYSBjcmVkZW50aWFscyBvYmplY3QKICAgICAqICAgICBAcGFyYW0gY3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCByZXNvbHZlZAogICAgICogICAgICAgYnkgdGhlIHByb3ZpZGVyIGNoYWluLgogICAgICogICBAY2FsbGJhY2sgcmVqZWN0ZWRDYWxsYmFjayBmdW5jdGlvbihlcnJvcikKICAgICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICAgKiAgICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgaWYgbm8gY3JlZGVudGlhbHMgYXJlIGZvdW5kLgogICAgICogICBAcmV0dXJuIFtQcm9taXNlXSBBIHByb21pc2UgdGhhdCByZXByZXNlbnRzIHRoZSBzdGF0ZSBvZiB0aGUgYHJlc29sdmVgIG1ldGhvZCBjYWxsLgogICAgICogICBAZXhhbXBsZSBDYWxsaW5nIHRoZSBgcmVzb2x2ZVByb21pc2VgIG1ldGhvZC4KICAgICAqICAgICB2YXIgcHJvbWlzZSA9IGNoYWluLnJlc29sdmVQcm9taXNlKCk7CiAgICAgKiAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGNyZWRlbnRpYWxzKSB7IC4uLiB9LCBmdW5jdGlvbihlcnIpIHsgLi4uIH0pOwogICAgICovCiAgCiAgICAvKioKICAgICAqIFJlc29sdmVzIHRoZSBwcm92aWRlciBjaGFpbiBieSBzZWFyY2hpbmcgZm9yIHRoZSBmaXJzdCBzZXQgb2YKICAgICAqIGNyZWRlbnRpYWxzIGluIHtwcm92aWRlcnN9LgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGNyZWRlbnRpYWxzKQogICAgICogICBDYWxsZWQgd2hlbiB0aGUgcHJvdmlkZXIgcmVzb2x2ZXMgdGhlIGNoYWluIHRvIGEgY3JlZGVudGlhbHMgb2JqZWN0CiAgICAgKiAgIG9yIG51bGwgaWYgbm8gY3JlZGVudGlhbHMgY2FuIGJlIGZvdW5kLgogICAgICoKICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgaWYgbm8gY3JlZGVudGlhbHMgYXJlCiAgICAgKiAgICAgZm91bmQuCiAgICAgKiAgIEBwYXJhbSBjcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgY3JlZGVudGlhbHMgb2JqZWN0IHJlc29sdmVkCiAgICAgKiAgICAgYnkgdGhlIHByb3ZpZGVyIGNoYWluLgogICAgICogQHJldHVybiBbQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluXSB0aGUgcHJvdmlkZXIsIGZvciBjaGFpbmluZy4KICAgICAqLwogICAgcmVzb2x2ZTogZnVuY3Rpb24gcmVzb2x2ZShjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmIChzZWxmLnByb3ZpZGVycy5sZW5ndGggPT09IDApIHsKICAgICAgICBjYWxsYmFjayhuZXcgRXJyb3IoJ05vIHByb3ZpZGVycycpKTsKICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgfQogIAogICAgICBpZiAoc2VsZi5yZXNvbHZlQ2FsbGJhY2tzLnB1c2goY2FsbGJhY2spID09PSAxKSB7CiAgICAgICAgdmFyIGluZGV4ID0gMDsKICAgICAgICB2YXIgcHJvdmlkZXJzID0gc2VsZi5wcm92aWRlcnMuc2xpY2UoMCk7CiAgCiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZU5leHQoZXJyLCBjcmVkcykgewogICAgICAgICAgaWYgKCghZXJyICYmIGNyZWRzKSB8fCBpbmRleCA9PT0gcHJvdmlkZXJzLmxlbmd0aCkgewogICAgICAgICAgICBBV1MudXRpbC5hcnJheUVhY2goc2VsZi5yZXNvbHZlQ2FsbGJhY2tzLCBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICBjYWxsYmFjayhlcnIsIGNyZWRzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHNlbGYucmVzb2x2ZUNhbGxiYWNrcy5sZW5ndGggPSAwOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgCiAgICAgICAgICB2YXIgcHJvdmlkZXIgPSBwcm92aWRlcnNbaW5kZXgrK107CiAgICAgICAgICBpZiAodHlwZW9mIHByb3ZpZGVyID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGNyZWRzID0gcHJvdmlkZXIuY2FsbCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY3JlZHMgPSBwcm92aWRlcjsKICAgICAgICAgIH0KICAKICAgICAgICAgIGlmIChjcmVkcy5nZXQpIHsKICAgICAgICAgICAgY3JlZHMuZ2V0KGZ1bmN0aW9uIChnZXRFcnIpIHsKICAgICAgICAgICAgICByZXNvbHZlTmV4dChnZXRFcnIsIGdldEVyciA/IG51bGwgOiBjcmVkcyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzb2x2ZU5leHQobnVsbCwgY3JlZHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAKICAgICAgICByZXNvbHZlTmV4dCgpOwogICAgICB9CiAgCiAgICAgIHJldHVybiBzZWxmOwogICAgfQogIH0pOwogIAogIC8qKgogICAqIFRoZSBkZWZhdWx0IHNldCBvZiBwcm92aWRlcnMgdXNlZCBieSBhIHZhbmlsbGEgQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uCiAgICoKICAgKiBJbiB0aGUgYnJvd3NlcjoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uZGVmYXVsdFByb3ZpZGVycyA9IFtdCiAgICogYGBgCiAgICoKICAgKiBJbiBOb2RlLmpzOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5kZWZhdWx0UHJvdmlkZXJzID0gWwogICAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzKCdBV1MnKTsgfSwKICAgKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFscygnQU1BWk9OJyk7IH0sCiAgICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLlNoYXJlZEluaUZpbGVDcmVkZW50aWFscygpOyB9LAogICAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5FQ1NDcmVkZW50aWFscygpOyB9LAogICAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5Qcm9jZXNzQ3JlZGVudGlhbHMoKTsgfSwKICAgKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuVG9rZW5GaWxlV2ViSWRlbnRpdHlDcmVkZW50aWFscygpOyB9LAogICAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5FQzJNZXRhZGF0YUNyZWRlbnRpYWxzKCkgfQogICAqIF0KICAgKiBgYGAKICAgKi8KICBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uZGVmYXVsdFByb3ZpZGVycyA9IFtdOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5hZGRQcm9taXNlc1RvQ2xhc3MgPSBmdW5jdGlvbiBhZGRQcm9taXNlc1RvQ2xhc3MoUHJvbWlzZURlcGVuZGVuY3kpIHsKICAgIHRoaXMucHJvdG90eXBlLnJlc29sdmVQcm9taXNlID0gQVdTLnV0aWwucHJvbWlzaWZ5TWV0aG9kKCdyZXNvbHZlJywgUHJvbWlzZURlcGVuZGVuY3kpOwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmRlbGV0ZVByb21pc2VzRnJvbUNsYXNzID0gZnVuY3Rpb24gZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MoKSB7CiAgICBkZWxldGUgdGhpcy5wcm90b3R5cGUucmVzb2x2ZVByb21pc2U7CiAgfTsKICAKICBBV1MudXRpbC5hZGRQcm9taXNlcyhBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4pOwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDIzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBTVFMgPSByZXF1aXJlKCcuLi8uLi9jbGllbnRzL3N0cycpOwogIAogIC8qKgogICAqIFJlcHJlc2VudHMgY3JlZGVudGlhbHMgcmV0cmlldmVkIGZyb20gU1RTIFNBTUwgc3VwcG9ydC4KICAgKgogICAqIEJ5IGRlZmF1bHQgdGhpcyBwcm92aWRlciBnZXRzIGNyZWRlbnRpYWxzIHVzaW5nIHRoZQogICAqIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoU0FNTH0gc2VydmljZSBvcGVyYXRpb24uIFRoaXMgb3BlcmF0aW9uCiAgICogcmVxdWlyZXMgYSBgUm9sZUFybmAgY29udGFpbmluZyB0aGUgQVJOIG9mIHRoZSBJQU0gdHJ1c3QgcG9saWN5IGZvciB0aGUKICAgKiBhcHBsaWNhdGlvbiBmb3Igd2hpY2ggY3JlZGVudGlhbHMgd2lsbCBiZSBnaXZlbiwgYXMgd2VsbCBhcyBhIGBQcmluY2lwYWxBcm5gCiAgICogcmVwcmVzZW50aW5nIHRoZSBBUk4gZm9yIHRoZSBTQU1MIGlkZW50aXR5IHByb3ZpZGVyLiBJbiBhZGRpdGlvbiwgdGhlCiAgICogYFNBTUxBc3NlcnRpb25gIG11c3QgYmUgc2V0IHRvIHRoZSB0b2tlbiBwcm92aWRlZCBieSB0aGUgaWRlbnRpdHkKICAgKiBwcm92aWRlci4gU2VlIHtjb25zdHJ1Y3Rvcn0gZm9yIGFuIGV4YW1wbGUgb24gY3JlYXRpbmcgYSBjcmVkZW50aWFscwogICAqIG9iamVjdCB3aXRoIHByb3BlciBgUm9sZUFybmAsIGBQcmluY2lwYWxBcm5gLCBhbmQgYFNBTUxBc3NlcnRpb25gIHZhbHVlcy4KICAgKgogICAqICMjIFJlZnJlc2hpbmcgQ3JlZGVudGlhbHMgZnJvbSBJZGVudGl0eSBTZXJ2aWNlCiAgICoKICAgKiBJbiBhZGRpdGlvbiB0byBBV1MgY3JlZGVudGlhbHMgZXhwaXJpbmcgYWZ0ZXIgYSBnaXZlbiBhbW91bnQgb2YgdGltZSwgdGhlCiAgICogbG9naW4gdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXIgd2lsbCBhbHNvIGV4cGlyZS4gT25jZSB0aGlzIHRva2VuCiAgICogZXhwaXJlcywgaXQgd2lsbCBub3QgYmUgdXNhYmxlIHRvIHJlZnJlc2ggQVdTIGNyZWRlbnRpYWxzLCBhbmQgYW5vdGhlcgogICAqIHRva2VuIHdpbGwgYmUgbmVlZGVkLiBUaGUgU0RLIGRvZXMgbm90IG1hbmFnZSByZWZyZXNoaW5nIG9mIHRoZSB0b2tlbiB2YWx1ZSwKICAgKiBidXQgdGhpcyBjYW4gYmUgZG9uZSB0aHJvdWdoIGEgInJlZnJlc2ggdG9rZW4iIHN1cHBvcnRlZCBieSBtb3N0IGlkZW50aXR5CiAgICogcHJvdmlkZXJzLiBDb25zdWx0IHRoZSBkb2N1bWVudGF0aW9uIGZvciB0aGUgaWRlbnRpdHkgcHJvdmlkZXIgZm9yIHJlZnJlc2hpbmcKICAgKiB0b2tlbnMuIE9uY2UgdGhlIHJlZnJlc2hlZCB0b2tlbiBpcyBhY3F1aXJlZCwgeW91IHNob3VsZCBtYWtlIHN1cmUgdG8gdXBkYXRlCiAgICogdGhpcyBuZXcgdG9rZW4gaW4gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCdzIHtwYXJhbXN9IHByb3BlcnR5LiBUaGUgZm9sbG93aW5nCiAgICogY29kZSB3aWxsIHVwZGF0ZSB0aGUgU0FNTEFzc2VydGlvbiwgYXNzdW1pbmcgeW91IGhhdmUgcmV0cmlldmVkIGFuIHVwZGF0ZWQKICAgKiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlcjoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzLnBhcmFtcy5TQU1MQXNzZXJ0aW9uID0gdXBkYXRlZFRva2VuOwogICAqIGBgYAogICAqCiAgICogRnV0dXJlIGNhbGxzIHRvIGBjcmVkZW50aWFscy5yZWZyZXNoKClgIHdpbGwgbm93IHVzZSB0aGUgbmV3IHRva2VuLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcGFyYW1zCiAgICogICBAcmV0dXJuIFttYXBdIHRoZSBtYXAgb2YgcGFyYW1zIHBhc3NlZCB0bwogICAqICAgICB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFNBTUx9LiBUbyB1cGRhdGUgdGhlIHRva2VuLCBzZXQgdGhlCiAgICogICAgIGBwYXJhbXMuU0FNTEFzc2VydGlvbmAgcHJvcGVydHkuCiAgICovCiAgQVdTLlNBTUxDcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0LgogICAgICogQHBhcmFtIChzZWUgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFNBTUwpCiAgICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuU0FNTENyZWRlbnRpYWxzKHsKICAgICAqICAgICBSb2xlQXJuOiAnYXJuOmF3czppYW06OjEyMzQ1Njc4OTA6cm9sZS9TQU1MUm9sZScsCiAgICAgKiAgICAgUHJpbmNpcGFsQXJuOiAnYXJuOmF3czppYW06OjEyMzQ1Njc4OTA6cm9sZS9TQU1MUHJpbmNpcGFsJywKICAgICAqICAgICBTQU1MQXNzZXJ0aW9uOiAnYmFzZTY0LXRva2VuJywgLy8gYmFzZTY0LWVuY29kZWQgdG9rZW4gZnJvbSBJZFAKICAgICAqICAgfSk7CiAgICAgKiBAc2VlIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhTQU1MCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBTQU1MQ3JlZGVudGlhbHMocGFyYW1zKSB7CiAgICAgIEFXUy5DcmVkZW50aWFscy5jYWxsKHRoaXMpOwogICAgICB0aGlzLmV4cGlyZWQgPSB0cnVlOwogICAgICB0aGlzLnBhcmFtcyA9IHBhcmFtczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFJlZnJlc2hlcyBjcmVkZW50aWFscyB1c2luZyB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFNBTUx9CiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgQ2FsbGVkIHdoZW4gdGhlIFNUUyBzZXJ2aWNlIHJlc3BvbmRzIChvciBmYWlscykuIFdoZW4KICAgICAqICAgdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgdGhhdCB0aGUgY3JlZGVudGlhbHMKICAgICAqICAgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsCiAgICAgKiAgIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogQHNlZSBnZXQKICAgICAqLwogICAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaChjYWxsYmFjaykgewogICAgICB0aGlzLmNvYWxlc2NlUmVmcmVzaChjYWxsYmFjayB8fCBBV1MudXRpbC5mbi5jYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZDogZnVuY3Rpb24gbG9hZChjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHNlbGYuY3JlYXRlQ2xpZW50cygpOwogICAgICBzZWxmLnNlcnZpY2UuYXNzdW1lUm9sZVdpdGhTQU1MKGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICBpZiAoIWVycikgewogICAgICAgICAgc2VsZi5zZXJ2aWNlLmNyZWRlbnRpYWxzRnJvbShkYXRhLCBzZWxmKTsKICAgICAgICB9CiAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY3JlYXRlQ2xpZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuc2VydmljZSA9IHRoaXMuc2VydmljZSB8fCBuZXcgU1RTKHtwYXJhbXM6IHRoaXMucGFyYW1zfSk7CiAgICB9CiAgCiAgfSk7CiAgCiAgfSx7Ii4uLy4uL2NsaWVudHMvc3RzIjo4LCIuLi9jb3JlIjoxOH1dLDI0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBTVFMgPSByZXF1aXJlKCcuLi8uLi9jbGllbnRzL3N0cycpOwogIAogIC8qKgogICAqIFJlcHJlc2VudHMgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIHJldHJpZXZlZCBmcm9tIHtBV1MuU1RTfS4gV2l0aG91dCBhbnkKICAgKiBleHRyYSBwYXJhbWV0ZXJzLCBjcmVkZW50aWFscyB3aWxsIGJlIGZldGNoZWQgZnJvbSB0aGUKICAgKiB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59IG9wZXJhdGlvbi4gSWYgYW4gSUFNIHJvbGUgaXMgcHJvdmlkZWQsIHRoZQogICAqIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9wZXJhdGlvbiB3aWxsIGJlIHVzZWQgdG8gZmV0Y2ggY3JlZGVudGlhbHMgZm9yIHRoZQogICAqIHJvbGUgaW5zdGVhZC4KICAgKgogICAqIEBub3RlIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyBpcyBkZXByZWNhdGVkLCBidXQgcmVtYWlucyBhdmFpbGFibGUgZm9yCiAgICogICBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4ge0FXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFsc30gaXMgdGhlCiAgICogICBwcmVmZXJyZWQgY2xhc3MgZm9yIHRlbXBvcmFyeSBjcmVkZW50aWFscy4KICAgKgogICAqIFRvIHNldHVwIHRlbXBvcmFyeSBjcmVkZW50aWFscywgY29uZmlndXJlIGEgc2V0IG9mIG1hc3RlciBjcmVkZW50aWFscwogICAqIHVzaW5nIHRoZSBzdGFuZGFyZCBjcmVkZW50aWFscyBwcm92aWRlcnMgKGVudmlyb25tZW50LCBFQzIgaW5zdGFuY2UgbWV0YWRhdGEsCiAgICogb3IgZnJvbSB0aGUgZmlsZXN5c3RlbSksIHRoZW4gc2V0IHRoZSBnbG9iYWwgY3JlZGVudGlhbHMgdG8gYSBuZXcKICAgKiB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgb2JqZWN0OgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIC8vIE5vdGUgdGhhdCBlbnZpcm9ubWVudCBjcmVkZW50aWFscyBhcmUgbG9hZGVkIGJ5IGRlZmF1bHQsCiAgICogLy8gdGhlIGZvbGxvd2luZyBsaW5lIGlzIHNob3duIGZvciBjbGFyaXR5OgogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FXUycpOwogICAqCiAgICogLy8gTm93IHNldCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgc2VlZGVkIGZyb20gdGhlIG1hc3RlciBjcmVkZW50aWFscwogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzKCk7CiAgICoKICAgKiAvLyBzdWJzZXF1ZW50IHJlcXVlc3RzIHdpbGwgbm93IHVzZSB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZnJvbSBBV1MgU1RTLgogICAqIG5ldyBBV1MuUzMoKS5saXN0QnVja2V0KGZ1bmN0aW9uKGVyciwgZGF0YSkgeyAuLi4gfSk7CiAgICogYGBgCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBtYXN0ZXJDcmVkZW50aWFscwogICAqICAgQHJldHVybiBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgbWFzdGVyIChub24tdGVtcG9yYXJ5KSBjcmVkZW50aWFscyB1c2VkIHRvCiAgICogICAgIGdldCBhbmQgcmVmcmVzaCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZnJvbSBBV1MgU1RTLgogICAqIEBub3RlIChzZWUgY29uc3RydWN0b3IpCiAgICovCiAgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgb2JqZWN0LgogICAgICoKICAgICAqIEBub3RlIEluIG9yZGVyIHRvIGNyZWF0ZSB0ZW1wb3JhcnkgY3JlZGVudGlhbHMsIHlvdSBmaXJzdCBuZWVkIHRvIGhhdmUKICAgICAqICAgIm1hc3RlciIgY3JlZGVudGlhbHMgY29uZmlndXJlZCBpbiB7QVdTLkNvbmZpZy5jcmVkZW50aWFsc30uIFRoZXNlCiAgICAgKiAgIG1hc3RlciBjcmVkZW50aWFscyBhcmUgbmVjZXNzYXJ5IHRvIHJldHJpZXZlIHRoZSB0ZW1wb3JhcnkgY3JlZGVudGlhbHMsCiAgICAgKiAgIGFzIHdlbGwgYXMgcmVmcmVzaCB0aGUgY3JlZGVudGlhbHMgd2hlbiB0aGV5IGV4cGlyZS4KICAgICAqIEBwYXJhbSBwYXJhbXMgW21hcF0gYSBtYXAgb2Ygb3B0aW9ucyB0aGF0IGFyZSBwYXNzZWQgdG8gdGhlCiAgICAgKiAgIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9yIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0gb3BlcmF0aW9ucy4KICAgICAqICAgSWYgYSBgUm9sZUFybmAgcGFyYW1ldGVyIGlzIHBhc3NlZCBpbiwgY3JlZGVudGlhbHMgd2lsbCBiZSBiYXNlZCBvbiB0aGUKICAgICAqICAgSUFNIHJvbGUuCiAgICAgKiBAcGFyYW0gbWFzdGVyQ3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gdGhlIG1hc3RlciAobm9uLXRlbXBvcmFyeSkgY3JlZGVudGlhbHMKICAgICAqICB1c2VkIHRvIGdldCBhbmQgcmVmcmVzaCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZnJvbSBBV1MgU1RTLgogICAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0IGZvciBnZW5lcmljIHRlbXBvcmFyeSBjcmVkZW50aWFscwogICAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscygpOwogICAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0IGZvciBhbiBJQU0gcm9sZQogICAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyh7CiAgICAgKiAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvVGVtcG9yYXJ5Q3JlZGVudGlhbHMnLAogICAgICogICB9KTsKICAgICAqIEBzZWUgQVdTLlNUUy5hc3N1bWVSb2xlCiAgICAgKiBAc2VlIEFXUy5TVFMuZ2V0U2Vzc2lvblRva2VuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBUZW1wb3JhcnlDcmVkZW50aWFscyhwYXJhbXMsIG1hc3RlckNyZWRlbnRpYWxzKSB7CiAgICAgIEFXUy5DcmVkZW50aWFscy5jYWxsKHRoaXMpOwogICAgICB0aGlzLmxvYWRNYXN0ZXJDcmVkZW50aWFscyhtYXN0ZXJDcmVkZW50aWFscyk7CiAgICAgIHRoaXMuZXhwaXJlZCA9IHRydWU7CiAgCiAgICAgIHRoaXMucGFyYW1zID0gcGFyYW1zIHx8IHt9OwogICAgICBpZiAodGhpcy5wYXJhbXMuUm9sZUFybikgewogICAgICAgIHRoaXMucGFyYW1zLlJvbGVTZXNzaW9uTmFtZSA9CiAgICAgICAgICB0aGlzLnBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgfHwgJ3RlbXBvcmFyeS1jcmVkZW50aWFscyc7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIFJlZnJlc2hlcyBjcmVkZW50aWFscyB1c2luZyB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvcgogICAgICoge0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSwgZGVwZW5kaW5nIG9uIHdoZXRoZXIgYW4gSUFNIHJvbGUgQVJOIHdhcyBwYXNzZWQKICAgICAqIHRvIHRoZSBjcmVkZW50aWFscyB7Y29uc3RydWN0b3J9LgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIENhbGxlZCB3aGVuIHRoZSBTVFMgc2VydmljZSByZXNwb25kcyAob3IgZmFpbHMpLiBXaGVuCiAgICAgKiAgIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHRoYXQgdGhlIGNyZWRlbnRpYWxzCiAgICAgKiAgIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLAogICAgICogICBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqIEBzZWUgZ2V0CiAgICAgKi8KICAgIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2ggKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrIHx8IEFXUy51dGlsLmZuLmNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkOiBmdW5jdGlvbiBsb2FkIChjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHNlbGYuY3JlYXRlQ2xpZW50cygpOwogICAgICBzZWxmLm1hc3RlckNyZWRlbnRpYWxzLmdldChmdW5jdGlvbiAoKSB7CiAgICAgICAgc2VsZi5zZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscyA9IHNlbGYubWFzdGVyQ3JlZGVudGlhbHM7CiAgICAgICAgdmFyIG9wZXJhdGlvbiA9IHNlbGYucGFyYW1zLlJvbGVBcm4gPwogICAgICAgICAgc2VsZi5zZXJ2aWNlLmFzc3VtZVJvbGUgOiBzZWxmLnNlcnZpY2UuZ2V0U2Vzc2lvblRva2VuOwogICAgICAgIG9wZXJhdGlvbi5jYWxsKHNlbGYuc2VydmljZSwgZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgICAgc2VsZi5zZXJ2aWNlLmNyZWRlbnRpYWxzRnJvbShkYXRhLCBzZWxmKTsKICAgICAgICAgIH0KICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxvYWRNYXN0ZXJDcmVkZW50aWFsczogZnVuY3Rpb24gbG9hZE1hc3RlckNyZWRlbnRpYWxzIChtYXN0ZXJDcmVkZW50aWFscykgewogICAgICB0aGlzLm1hc3RlckNyZWRlbnRpYWxzID0gbWFzdGVyQ3JlZGVudGlhbHMgfHwgQVdTLmNvbmZpZy5jcmVkZW50aWFsczsKICAgICAgd2hpbGUgKHRoaXMubWFzdGVyQ3JlZGVudGlhbHMubWFzdGVyQ3JlZGVudGlhbHMpIHsKICAgICAgICB0aGlzLm1hc3RlckNyZWRlbnRpYWxzID0gdGhpcy5tYXN0ZXJDcmVkZW50aWFscy5tYXN0ZXJDcmVkZW50aWFsczsKICAgICAgfQogIAogICAgICBpZiAodHlwZW9mIHRoaXMubWFzdGVyQ3JlZGVudGlhbHMuZ2V0ICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhpcy5tYXN0ZXJDcmVkZW50aWFscyA9IG5ldyBBV1MuQ3JlZGVudGlhbHModGhpcy5tYXN0ZXJDcmVkZW50aWFscyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjcmVhdGVDbGllbnRzOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuc2VydmljZSA9IHRoaXMuc2VydmljZSB8fCBuZXcgU1RTKHtwYXJhbXM6IHRoaXMucGFyYW1zfSk7CiAgICB9CiAgCiAgfSk7CiAgCiAgfSx7Ii4uLy4uL2NsaWVudHMvc3RzIjo4LCIuLi9jb3JlIjoxOH1dLDI1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBTVFMgPSByZXF1aXJlKCcuLi8uLi9jbGllbnRzL3N0cycpOwogIAogIC8qKgogICAqIFJlcHJlc2VudHMgY3JlZGVudGlhbHMgcmV0cmlldmVkIGZyb20gU1RTIFdlYiBJZGVudGl0eSBGZWRlcmF0aW9uIHN1cHBvcnQuCiAgICoKICAgKiBCeSBkZWZhdWx0IHRoaXMgcHJvdmlkZXIgZ2V0cyBjcmVkZW50aWFscyB1c2luZyB0aGUKICAgKiB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fSBzZXJ2aWNlIG9wZXJhdGlvbi4gVGhpcyBvcGVyYXRpb24KICAgKiByZXF1aXJlcyBhIGBSb2xlQXJuYCBjb250YWluaW5nIHRoZSBBUk4gb2YgdGhlIElBTSB0cnVzdCBwb2xpY3kgZm9yIHRoZQogICAqIGFwcGxpY2F0aW9uIGZvciB3aGljaCBjcmVkZW50aWFscyB3aWxsIGJlIGdpdmVuLiBJbiBhZGRpdGlvbiwgdGhlCiAgICogYFdlYklkZW50aXR5VG9rZW5gIG11c3QgYmUgc2V0IHRvIHRoZSB0b2tlbiBwcm92aWRlZCBieSB0aGUgaWRlbnRpdHkKICAgKiBwcm92aWRlci4gU2VlIHtjb25zdHJ1Y3Rvcn0gZm9yIGFuIGV4YW1wbGUgb24gY3JlYXRpbmcgYSBjcmVkZW50aWFscwogICAqIG9iamVjdCB3aXRoIHByb3BlciBgUm9sZUFybmAgYW5kIGBXZWJJZGVudGl0eVRva2VuYCB2YWx1ZXMuCiAgICoKICAgKiAjIyBSZWZyZXNoaW5nIENyZWRlbnRpYWxzIGZyb20gSWRlbnRpdHkgU2VydmljZQogICAqCiAgICogSW4gYWRkaXRpb24gdG8gQVdTIGNyZWRlbnRpYWxzIGV4cGlyaW5nIGFmdGVyIGEgZ2l2ZW4gYW1vdW50IG9mIHRpbWUsIHRoZQogICAqIGxvZ2luIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyIHdpbGwgYWxzbyBleHBpcmUuIE9uY2UgdGhpcyB0b2tlbgogICAqIGV4cGlyZXMsIGl0IHdpbGwgbm90IGJlIHVzYWJsZSB0byByZWZyZXNoIEFXUyBjcmVkZW50aWFscywgYW5kIGFub3RoZXIKICAgKiB0b2tlbiB3aWxsIGJlIG5lZWRlZC4gVGhlIFNESyBkb2VzIG5vdCBtYW5hZ2UgcmVmcmVzaGluZyBvZiB0aGUgdG9rZW4gdmFsdWUsCiAgICogYnV0IHRoaXMgY2FuIGJlIGRvbmUgdGhyb3VnaCBhICJyZWZyZXNoIHRva2VuIiBzdXBwb3J0ZWQgYnkgbW9zdCBpZGVudGl0eQogICAqIHByb3ZpZGVycy4gQ29uc3VsdCB0aGUgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIGlkZW50aXR5IHByb3ZpZGVyIGZvciByZWZyZXNoaW5nCiAgICogdG9rZW5zLiBPbmNlIHRoZSByZWZyZXNoZWQgdG9rZW4gaXMgYWNxdWlyZWQsIHlvdSBzaG91bGQgbWFrZSBzdXJlIHRvIHVwZGF0ZQogICAqIHRoaXMgbmV3IHRva2VuIGluIHRoZSBjcmVkZW50aWFscyBvYmplY3QncyB7cGFyYW1zfSBwcm9wZXJ0eS4gVGhlIGZvbGxvd2luZwogICAqIGNvZGUgd2lsbCB1cGRhdGUgdGhlIFdlYklkZW50aXR5VG9rZW4sIGFzc3VtaW5nIHlvdSBoYXZlIHJldHJpZXZlZCBhbiB1cGRhdGVkCiAgICogdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXI6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscy5wYXJhbXMuV2ViSWRlbnRpdHlUb2tlbiA9IHVwZGF0ZWRUb2tlbjsKICAgKiBgYGAKICAgKgogICAqIEZ1dHVyZSBjYWxscyB0byBgY3JlZGVudGlhbHMucmVmcmVzaCgpYCB3aWxsIG5vdyB1c2UgdGhlIG5ldyB0b2tlbi4KICAgKgogICAqIEAhYXR0cmlidXRlIHBhcmFtcwogICAqICAgQHJldHVybiBbbWFwXSB0aGUgbWFwIG9mIHBhcmFtcyBwYXNzZWQgdG8KICAgKiAgICAge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uIFRvIHVwZGF0ZSB0aGUgdG9rZW4sIHNldCB0aGUKICAgKiAgICAgYHBhcmFtcy5XZWJJZGVudGl0eVRva2VuYCBwcm9wZXJ0eS4KICAgKiBAIWF0dHJpYnV0ZSBkYXRhCiAgICogICBAcmV0dXJuIFttYXBdIHRoZSByYXcgZGF0YSByZXNwb25zZSBmcm9tIHRoZSBjYWxsIHRvCiAgICogICAgIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LiBVc2UgdGhpcyBpZiB5b3Ugd2FudCB0byBnZXQKICAgKiAgICAgYWNjZXNzIHRvIG90aGVyIHByb3BlcnRpZXMgZnJvbSB0aGUgcmVzcG9uc2UuCiAgICovCiAgQVdTLldlYklkZW50aXR5Q3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdC4KICAgICAqIEBwYXJhbSAoc2VlIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eSkKICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdAogICAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5XZWJJZGVudGl0eUNyZWRlbnRpYWxzKHsKICAgICAqICAgICBSb2xlQXJuOiAnYXJuOmF3czppYW06OjEyMzQ1Njc4OTA6cm9sZS9XZWJJZGVudGl0eScsCiAgICAgKiAgICAgV2ViSWRlbnRpdHlUb2tlbjogJ0FCQ0RFRkdISUpLTE1OT1AnLCAvLyB0b2tlbiBmcm9tIGlkZW50aXR5IHNlcnZpY2UKICAgICAqICAgICBSb2xlU2Vzc2lvbk5hbWU6ICd3ZWInIC8vIG9wdGlvbmFsIG5hbWUsIGRlZmF1bHRzIHRvIHdlYi1pZGVudGl0eQogICAgICogICB9LCB7CiAgICAgKiAgICAgLy8gb3B0aW9uYWxseSBwcm92aWRlIGNvbmZpZ3VyYXRpb24gdG8gYXBwbHkgdG8gdGhlIHVuZGVybHlpbmcgQVdTLlNUUyBzZXJ2aWNlIGNsaWVudAogICAgICogICAgIC8vIGlmIGNvbmZpZ3VyYXRpb24gaXMgbm90IHByb3ZpZGVkLCB0aGVuIGNvbmZpZ3VyYXRpb24gd2lsbCBiZSBwdWxsZWQgZnJvbSBBV1MuY29uZmlnCiAgICAgKgogICAgICogICAgIC8vIHNwZWNpZnkgdGltZW91dCBvcHRpb25zCiAgICAgKiAgICAgaHR0cE9wdGlvbnM6IHsKICAgICAqICAgICAgIHRpbWVvdXQ6IDEwMAogICAgICogICAgIH0KICAgICAqICAgfSk7CiAgICAgKiBAc2VlIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eQogICAgICogQHNlZSBBV1MuQ29uZmlnCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBXZWJJZGVudGl0eUNyZWRlbnRpYWxzKHBhcmFtcywgY2xpZW50Q29uZmlnKSB7CiAgICAgIEFXUy5DcmVkZW50aWFscy5jYWxsKHRoaXMpOwogICAgICB0aGlzLmV4cGlyZWQgPSB0cnVlOwogICAgICB0aGlzLnBhcmFtcyA9IHBhcmFtczsKICAgICAgdGhpcy5wYXJhbXMuUm9sZVNlc3Npb25OYW1lID0gdGhpcy5wYXJhbXMuUm9sZVNlc3Npb25OYW1lIHx8ICd3ZWItaWRlbnRpdHknOwogICAgICB0aGlzLmRhdGEgPSBudWxsOwogICAgICB0aGlzLl9jbGllbnRDb25maWcgPSBBV1MudXRpbC5jb3B5KGNsaWVudENvbmZpZyB8fCB7fSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBSZWZyZXNoZXMgY3JlZGVudGlhbHMgdXNpbmcge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICBDYWxsZWQgd2hlbiB0aGUgU1RTIHNlcnZpY2UgcmVzcG9uZHMgKG9yIGZhaWxzKS4gV2hlbgogICAgICogICB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyB0aGF0IHRoZSBjcmVkZW50aWFscwogICAgICogICBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwKICAgICAqICAgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKiBAc2VlIGdldAogICAgICovCiAgICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrIHx8IEFXUy51dGlsLmZuLmNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkOiBmdW5jdGlvbiBsb2FkKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgc2VsZi5jcmVhdGVDbGllbnRzKCk7CiAgICAgIHNlbGYuc2VydmljZS5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5KGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICBzZWxmLmRhdGEgPSBudWxsOwogICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICBzZWxmLmRhdGEgPSBkYXRhOwogICAgICAgICAgc2VsZi5zZXJ2aWNlLmNyZWRlbnRpYWxzRnJvbShkYXRhLCBzZWxmKTsKICAgICAgICB9CiAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY3JlYXRlQ2xpZW50czogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5zZXJ2aWNlKSB7CiAgICAgICAgdmFyIHN0c0NvbmZpZyA9IEFXUy51dGlsLm1lcmdlKHt9LCB0aGlzLl9jbGllbnRDb25maWcpOwogICAgICAgIHN0c0NvbmZpZy5wYXJhbXMgPSB0aGlzLnBhcmFtczsKICAgICAgICB0aGlzLnNlcnZpY2UgPSBuZXcgU1RTKHN0c0NvbmZpZyk7CiAgICAgIH0KICAgIH0KICAKICB9KTsKICAKICB9LHsiLi4vLi4vY2xpZW50cy9zdHMiOjgsIi4uL2NvcmUiOjE4fV0sMjY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAocHJvY2Vzcyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHZhciB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7CiAgdmFyIGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZEVudnMgPSBbJ0FXU19FTkFCTEVfRU5EUE9JTlRfRElTQ09WRVJZJywgJ0FXU19FTkRQT0lOVF9ESVNDT1ZFUllfRU5BQkxFRCddOwogIAogIC8qKgogICAqIEdlbmVyYXRlIGtleSAoZXhjZXB0IHJlc291cmNlcyBhbmQgb3BlcmF0aW9uIHBhcnQpIHRvIGluZGV4IHRoZSBlbmRwb2ludHMgaW4gdGhlIGNhY2hlCiAgICogSWYgaW5wdXQgc2hhcGUgaGFzIGVuZHBvaW50ZGlzY292ZXJ5aWQgdHJhaXQgdGhlbiB1c2UKICAgKiAgIGFjY2Vzc0tleSArIG9wZXJhdGlvbiArIHJlc291cmNlcyArIHJlZ2lvbiArIHNlcnZpY2UgYXMgY2FjaGUga2V5CiAgICogSWYgaW5wdXQgc2hhcGUgZG9lc24ndCBoYXZlIGVuZHBvaW50ZGlzY292ZXJ5aWQgdHJhaXQgdGhlbiB1c2UKICAgKiAgIGFjY2Vzc0tleSArIHJlZ2lvbiArIHNlcnZpY2UgYXMgY2FjaGUga2V5CiAgICogQHJldHVybiBbbWFwPFN0cmluZyxTdHJpbmc+XSBvYmplY3Qgd2l0aCBrZXlzIHRvIGluZGV4IGVuZHBvaW50cy4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBnZXRDYWNoZUtleShyZXF1ZXN0KSB7CiAgICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZTsKICAgIHZhciBhcGkgPSBzZXJ2aWNlLmFwaSB8fCB7fTsKICAgIHZhciBvcGVyYXRpb25zID0gYXBpLm9wZXJhdGlvbnM7CiAgICB2YXIgaWRlbnRpZmllcnMgPSB7fTsKICAgIGlmIChzZXJ2aWNlLmNvbmZpZy5yZWdpb24pIHsKICAgICAgaWRlbnRpZmllcnMucmVnaW9uID0gc2VydmljZS5jb25maWcucmVnaW9uOwogICAgfQogICAgaWYgKGFwaS5zZXJ2aWNlSWQpIHsKICAgICAgaWRlbnRpZmllcnMuc2VydmljZUlkID0gYXBpLnNlcnZpY2VJZDsKICAgIH0KICAgIGlmIChzZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscy5hY2Nlc3NLZXlJZCkgewogICAgICBpZGVudGlmaWVycy5hY2Nlc3NLZXlJZCA9IHNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkOwogICAgfQogICAgcmV0dXJuIGlkZW50aWZpZXJzOwogIH0KICAKICAvKioKICAgKiBSZWN1cnNpdmUgaGVscGVyIGZvciBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzKCkuCiAgICogTG9va3MgZm9yIHJlcXVpcmVkIHN0cmluZyBpbnB1dCBtZW1iZXJzIHRoYXQgaGF2ZSAnZW5kcG9pbnRkaXNjb3ZlcnlpZCcgdHJhaXQuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVyc0hlbHBlcihyZXN1bHQsIHBhcmFtcywgc2hhcGUpIHsKICAgIGlmICghc2hhcGUgfHwgcGFyYW1zID09PSB1bmRlZmluZWQgfHwgcGFyYW1zID09PSBudWxsKSByZXR1cm47CiAgICBpZiAoc2hhcGUudHlwZSA9PT0gJ3N0cnVjdHVyZScgJiYgc2hhcGUucmVxdWlyZWQgJiYgc2hhcGUucmVxdWlyZWQubGVuZ3RoID4gMCkgewogICAgICB1dGlsLmFycmF5RWFjaChzaGFwZS5yZXF1aXJlZCwgZnVuY3Rpb24obmFtZSkgewogICAgICAgIHZhciBtZW1iZXJTaGFwZSA9IHNoYXBlLm1lbWJlcnNbbmFtZV07CiAgICAgICAgaWYgKG1lbWJlclNoYXBlLmVuZHBvaW50RGlzY292ZXJ5SWQgPT09IHRydWUpIHsKICAgICAgICAgIHZhciBsb2NhdGlvbk5hbWUgPSBtZW1iZXJTaGFwZS5pc0xvY2F0aW9uTmFtZSA/IG1lbWJlclNoYXBlLm5hbWUgOiBuYW1lOwogICAgICAgICAgcmVzdWx0W2xvY2F0aW9uTmFtZV0gPSBTdHJpbmcocGFyYW1zW25hbWVdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWFyc2hhbGxDdXN0b21JZGVudGlmaWVyc0hlbHBlcihyZXN1bHQsIHBhcmFtc1tuYW1lXSwgbWVtYmVyU2hhcGUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIEdldCBjdXN0b20gaWRlbnRpZmllcnMgZm9yIGNhY2hlIGtleS4KICAgKiBJZGVudGlmaWVzIGN1c3RvbSBpZGVudGlmaWVycyBieSBjaGVja2luZyBlYWNoIHNoYXBlJ3MgYGVuZHBvaW50RGlzY292ZXJ5SWRgIHRyYWl0LgogICAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0IG9iamVjdAogICAqIEBwYXJhbSBbb2JqZWN0XSBpbnB1dCBzaGFwZSBvZiB0aGUgZ2l2ZW4gb3BlcmF0aW9uJ3MgYXBpCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycyhyZXF1ZXN0LCBzaGFwZSkgewogICAgdmFyIGlkZW50aWZpZXJzID0ge307CiAgICBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzSGVscGVyKGlkZW50aWZpZXJzLCByZXF1ZXN0LnBhcmFtcywgc2hhcGUpOwogICAgcmV0dXJuIGlkZW50aWZpZXJzOwogIH0KICAKICAvKioKICAgKiBDYWxsIGVuZHBvaW50IGRpc2NvdmVyeSBvcGVyYXRpb24gd2hlbiBpdCdzIG9wdGlvbmFsLgogICAqIFdoZW4gZW5kcG9pbnQgaXMgYXZhaWxhYmxlIGluIGNhY2hlIHRoZW4gdXNlIHRoZSBjYWNoZWQgZW5kcG9pbnRzLiBJZiBlbmRwb2ludHMKICAgKiBhcmUgdW5hdmFpbGFibGUgdGhlbiB1c2UgcmVnaW9uYWwgZW5kcG9pbnRzIGFuZCBjYWxsIGVuZHBvaW50IGRpc2NvdmVyeSBvcGVyYXRpb24KICAgKiBhc3luY2hyb25vdXNseS4gVGhpcyBpcyB0dXJuZWQgb2ZmIGJ5IGRlZmF1bHQuCiAgICogQHBhcmFtIFtvYmplY3RdIHJlcXVlc3Qgb2JqZWN0CiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gb3B0aW9uYWxEaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QpIHsKICAgIHZhciBzZXJ2aWNlID0gcmVxdWVzdC5zZXJ2aWNlOwogICAgdmFyIGFwaSA9IHNlcnZpY2UuYXBpOwogICAgdmFyIG9wZXJhdGlvbk1vZGVsID0gYXBpLm9wZXJhdGlvbnMgPyBhcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0gOiB1bmRlZmluZWQ7CiAgICB2YXIgaW5wdXRTaGFwZSA9IG9wZXJhdGlvbk1vZGVsID8gb3BlcmF0aW9uTW9kZWwuaW5wdXQgOiB1bmRlZmluZWQ7CiAgCiAgICB2YXIgaWRlbnRpZmllcnMgPSBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzKHJlcXVlc3QsIGlucHV0U2hhcGUpOwogICAgdmFyIGNhY2hlS2V5ID0gZ2V0Q2FjaGVLZXkocmVxdWVzdCk7CiAgICBpZiAoT2JqZWN0LmtleXMoaWRlbnRpZmllcnMpLmxlbmd0aCA+IDApIHsKICAgICAgY2FjaGVLZXkgPSB1dGlsLnVwZGF0ZShjYWNoZUtleSwgaWRlbnRpZmllcnMpOwogICAgICBpZiAob3BlcmF0aW9uTW9kZWwpIGNhY2hlS2V5Lm9wZXJhdGlvbiA9IG9wZXJhdGlvbk1vZGVsLm5hbWU7CiAgICB9CiAgICB2YXIgZW5kcG9pbnRzID0gQVdTLmVuZHBvaW50Q2FjaGUuZ2V0KGNhY2hlS2V5KTsKICAgIGlmIChlbmRwb2ludHMgJiYgZW5kcG9pbnRzLmxlbmd0aCA9PT0gMSAmJiBlbmRwb2ludHNbMF0uQWRkcmVzcyA9PT0gJycpIHsKICAgICAgLy9lbmRwb2ludCBvcGVyYXRpb24gaXMgYmVpbmcgbWFkZSBidXQgcmVzcG9uc2Ugbm90IHlldCByZWNlaXZlZAogICAgICAvL29yIGVuZHBvaW50IG9wZXJhdGlvbiBqdXN0IGZhaWxlZCBpbiAxIG1pbnV0ZQogICAgICByZXR1cm47CiAgICB9IGVsc2UgaWYgKGVuZHBvaW50cyAmJiBlbmRwb2ludHMubGVuZ3RoID4gMCkgewogICAgICAvL2ZvdW5kIGVuZHBvaW50IHJlY29yZCBmcm9tIGNhY2hlCiAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QudXBkYXRlRW5kcG9pbnQoZW5kcG9pbnRzWzBdLkFkZHJlc3MpOwogICAgfSBlbHNlIHsKICAgICAgLy9lbmRwb2ludCByZWNvcmQgbm90IGluIGNhY2hlIG9yIG91dGRhdGVkLiBtYWtlIGRpc2NvdmVyeSBvcGVyYXRpb24KICAgICAgdmFyIGVuZHBvaW50UmVxdWVzdCA9IHNlcnZpY2UubWFrZVJlcXVlc3QoYXBpLmVuZHBvaW50T3BlcmF0aW9uLCB7CiAgICAgICAgT3BlcmF0aW9uOiBvcGVyYXRpb25Nb2RlbC5uYW1lLAogICAgICAgIElkZW50aWZpZXJzOiBpZGVudGlmaWVycywKICAgICAgfSk7CiAgICAgIGFkZEFwaVZlcnNpb25IZWFkZXIoZW5kcG9pbnRSZXF1ZXN0KTsKICAgICAgZW5kcG9pbnRSZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1BBUkFNRVRFUlMpOwogICAgICBlbmRwb2ludFJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3JldHJ5JywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuUkVUUllfQ0hFQ0spOwogICAgICAvL3B1dCBpbiBhIHBsYWNlaG9sZGVyIGZvciBlbmRwb2ludHMgYWxyZWFkeSByZXF1ZXN0ZWQsIHByZXZlbnQKICAgICAgLy90b28gbXVjaCBpbi1mbGlnaHQgY2FsbHMKICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucHV0KGNhY2hlS2V5LCBbewogICAgICAgIEFkZHJlc3M6ICcnLAogICAgICAgIENhY2hlUGVyaW9kSW5NaW51dGVzOiAxCiAgICAgIH1dKTsKICAgICAgZW5kcG9pbnRSZXF1ZXN0LnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5FbmRwb2ludHMpIHsKICAgICAgICAgIEFXUy5lbmRwb2ludENhY2hlLnB1dChjYWNoZUtleSwgZGF0YS5FbmRwb2ludHMpOwogICAgICAgIH0gZWxzZSBpZiAoZXJyKSB7CiAgICAgICAgICBBV1MuZW5kcG9pbnRDYWNoZS5wdXQoY2FjaGVLZXksIFt7CiAgICAgICAgICAgIEFkZHJlc3M6ICcnLAogICAgICAgICAgICBDYWNoZVBlcmlvZEluTWludXRlczogMSAvL25vdCB0byBtYWtlIG1vcmUgZW5kcG9pbnQgb3BlcmF0aW9uIGluIG5leHQgMSBtaW51dGUKICAgICAgICAgIH1dKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KICAKICB2YXIgcmVxdWVzdFF1ZXVlID0ge307CiAgCiAgLyoqCiAgICogQ2FsbCBlbmRwb2ludCBkaXNjb3Zlcnkgb3BlcmF0aW9uIHdoZW4gaXQncyByZXF1aXJlZC4KICAgKiBXaGVuIGVuZHBvaW50IGlzIGF2YWlsYWJsZSBpbiBjYWNoZSB0aGVuIHVzZSBjYWNoZWQgb25lcy4gSWYgZW5kcG9pbnRzIGFyZQogICAqIHVuYXZhaWxhYmxlIHRoZW4gU0RLIHNob3VsZCBjYWxsIGVuZHBvaW50IG9wZXJhdGlvbiB0aGVuIHVzZSByZXR1cm5lZCBuZXcKICAgKiBlbmRwb2ludCBmb3IgdGhlIGFwaSBjYWxsLiBTREsgd2lsbCBhdXRvbWF0aWNhbGx5IGF0dGVtcHQgdG8gZG8gZW5kcG9pbnQKICAgKiBkaXNjb3ZlcnkuIFRoaXMgaXMgdHVybmVkIG9mZiBieSBkZWZhdWx0CiAgICogQHBhcmFtIFtvYmplY3RdIHJlcXVlc3Qgb2JqZWN0CiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gcmVxdWlyZWREaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QsIGRvbmUpIHsKICAgIHZhciBzZXJ2aWNlID0gcmVxdWVzdC5zZXJ2aWNlOwogICAgdmFyIGFwaSA9IHNlcnZpY2UuYXBpOwogICAgdmFyIG9wZXJhdGlvbk1vZGVsID0gYXBpLm9wZXJhdGlvbnMgPyBhcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0gOiB1bmRlZmluZWQ7CiAgICB2YXIgaW5wdXRTaGFwZSA9IG9wZXJhdGlvbk1vZGVsID8gb3BlcmF0aW9uTW9kZWwuaW5wdXQgOiB1bmRlZmluZWQ7CiAgCiAgICB2YXIgaWRlbnRpZmllcnMgPSBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzKHJlcXVlc3QsIGlucHV0U2hhcGUpOwogICAgdmFyIGNhY2hlS2V5ID0gZ2V0Q2FjaGVLZXkocmVxdWVzdCk7CiAgICBpZiAoT2JqZWN0LmtleXMoaWRlbnRpZmllcnMpLmxlbmd0aCA+IDApIHsKICAgICAgY2FjaGVLZXkgPSB1dGlsLnVwZGF0ZShjYWNoZUtleSwgaWRlbnRpZmllcnMpOwogICAgICBpZiAob3BlcmF0aW9uTW9kZWwpIGNhY2hlS2V5Lm9wZXJhdGlvbiA9IG9wZXJhdGlvbk1vZGVsLm5hbWU7CiAgICB9CiAgICB2YXIgY2FjaGVLZXlTdHIgPSBBV1MuRW5kcG9pbnRDYWNoZS5nZXRLZXlTdHJpbmcoY2FjaGVLZXkpOwogICAgdmFyIGVuZHBvaW50cyA9IEFXUy5lbmRwb2ludENhY2hlLmdldChjYWNoZUtleVN0cik7IC8vZW5kcG9pbnQgY2FjaGUgYWxzbyBhY2NlcHRzIHN0cmluZyBrZXlzCiAgICBpZiAoZW5kcG9pbnRzICYmIGVuZHBvaW50cy5sZW5ndGggPT09IDEgJiYgZW5kcG9pbnRzWzBdLkFkZHJlc3MgPT09ICcnKSB7CiAgICAgIC8vZW5kcG9pbnQgb3BlcmF0aW9uIGlzIGJlaW5nIG1hZGUgYnV0IHJlc3BvbnNlIG5vdCB5ZXQgcmVjZWl2ZWQKICAgICAgLy9wdXNoIHJlcXVlc3Qgb2JqZWN0IHRvIGEgcGVuZGluZyBxdWV1ZQogICAgICBpZiAoIXJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0pIHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0gPSBbXTsKICAgICAgcmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXS5wdXNoKHtyZXF1ZXN0OiByZXF1ZXN0LCBjYWxsYmFjazogZG9uZX0pOwogICAgICByZXR1cm47CiAgICB9IGVsc2UgaWYgKGVuZHBvaW50cyAmJiBlbmRwb2ludHMubGVuZ3RoID4gMCkgewogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnVwZGF0ZUVuZHBvaW50KGVuZHBvaW50c1swXS5BZGRyZXNzKTsKICAgICAgZG9uZSgpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGVuZHBvaW50UmVxdWVzdCA9IHNlcnZpY2UubWFrZVJlcXVlc3QoYXBpLmVuZHBvaW50T3BlcmF0aW9uLCB7CiAgICAgICAgT3BlcmF0aW9uOiBvcGVyYXRpb25Nb2RlbC5uYW1lLAogICAgICAgIElkZW50aWZpZXJzOiBpZGVudGlmaWVycywKICAgICAgfSk7CiAgICAgIGVuZHBvaW50UmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9QQVJBTUVURVJTKTsKICAgICAgYWRkQXBpVmVyc2lvbkhlYWRlcihlbmRwb2ludFJlcXVlc3QpOwogIAogICAgICAvL3B1dCBpbiBhIHBsYWNlaG9sZGVyIGZvciBlbmRwb2ludHMgYWxyZWFkeSByZXF1ZXN0ZWQsIHByZXZlbnQKICAgICAgLy90b28gbXVjaCBpbi1mbGlnaHQgY2FsbHMKICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucHV0KGNhY2hlS2V5U3RyLCBbewogICAgICAgIEFkZHJlc3M6ICcnLAogICAgICAgIENhY2hlUGVyaW9kSW5NaW51dGVzOiA2MCAvL2xvbmctbGl2ZSBjYWNoZQogICAgICB9XSk7CiAgICAgIGVuZHBvaW50UmVxdWVzdC5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIHZhciBlcnJvclBhcmFtcyA9IHsKICAgICAgICAgICAgY29kZTogJ0VuZHBvaW50RGlzY292ZXJ5RXhjZXB0aW9uJywKICAgICAgICAgICAgbWVzc2FnZTogJ1JlcXVlc3QgY2Fubm90IGJlIGZ1bGZpbGxlZCB3aXRob3V0IHNwZWNpZnlpbmcgYW4gZW5kcG9pbnQnLAogICAgICAgICAgICByZXRyeWFibGU6IGZhbHNlCiAgICAgICAgICB9OwogICAgICAgICAgcmVxdWVzdC5yZXNwb25zZS5lcnJvciA9IHV0aWwuZXJyb3IoZXJyLCBlcnJvclBhcmFtcyk7CiAgICAgICAgICBBV1MuZW5kcG9pbnRDYWNoZS5yZW1vdmUoY2FjaGVLZXkpOwogIAogICAgICAgICAgLy9mYWlsIGFsbCB0aGUgcGVuZGluZyByZXF1ZXN0cyBpbiBiYXRjaAogICAgICAgICAgaWYgKHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0pIHsKICAgICAgICAgICAgdmFyIHBlbmRpbmdSZXF1ZXN0cyA9IHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl07CiAgICAgICAgICAgIHV0aWwuYXJyYXlFYWNoKHBlbmRpbmdSZXF1ZXN0cywgZnVuY3Rpb24ocmVxdWVzdENvbnRleHQpIHsKICAgICAgICAgICAgICByZXF1ZXN0Q29udGV4dC5yZXF1ZXN0LnJlc3BvbnNlLmVycm9yID0gdXRpbC5lcnJvcihlcnIsIGVycm9yUGFyYW1zKTsKICAgICAgICAgICAgICByZXF1ZXN0Q29udGV4dC5jYWxsYmFjaygpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZGVsZXRlIHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl07CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChkYXRhKSB7CiAgICAgICAgICBBV1MuZW5kcG9pbnRDYWNoZS5wdXQoY2FjaGVLZXlTdHIsIGRhdGEuRW5kcG9pbnRzKTsKICAgICAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QudXBkYXRlRW5kcG9pbnQoZGF0YS5FbmRwb2ludHNbMF0uQWRkcmVzcyk7CiAgCiAgICAgICAgICAvL3VwZGF0ZSB0aGUgZW5kcG9pbnQgZm9yIGFsbCB0aGUgcGVuZGluZyByZXF1ZXN0cyBpbiBiYXRjaAogICAgICAgICAgaWYgKHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0pIHsKICAgICAgICAgICAgdmFyIHBlbmRpbmdSZXF1ZXN0cyA9IHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl07CiAgICAgICAgICAgIHV0aWwuYXJyYXlFYWNoKHBlbmRpbmdSZXF1ZXN0cywgZnVuY3Rpb24ocmVxdWVzdENvbnRleHQpIHsKICAgICAgICAgICAgICByZXF1ZXN0Q29udGV4dC5yZXF1ZXN0Lmh0dHBSZXF1ZXN0LnVwZGF0ZUVuZHBvaW50KGRhdGEuRW5kcG9pbnRzWzBdLkFkZHJlc3MpOwogICAgICAgICAgICAgIHJlcXVlc3RDb250ZXh0LmNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkZWxldGUgcmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZG9uZSgpOwogICAgICB9KTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogYWRkIGFwaSB2ZXJzaW9uIGhlYWRlciB0byBlbmRwb2ludCBvcGVyYXRpb24KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBhZGRBcGlWZXJzaW9uSGVhZGVyKGVuZHBvaW50UmVxdWVzdCkgewogICAgdmFyIGFwaSA9IGVuZHBvaW50UmVxdWVzdC5zZXJ2aWNlLmFwaTsKICAgIHZhciBhcGlWZXJzaW9uID0gYXBpLmFwaVZlcnNpb247CiAgICBpZiAoYXBpVmVyc2lvbiAmJiAhZW5kcG9pbnRSZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LWFwaS12ZXJzaW9uJ10pIHsKICAgICAgZW5kcG9pbnRSZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LWFwaS12ZXJzaW9uJ10gPSBhcGlWZXJzaW9uOwogICAgfQogIH0KICAKICAvKioKICAgKiBJZiBhcGkgY2FsbCBnZXRzIGludmFsaWQgZW5kcG9pbnQgZXhjZXB0aW9uLCBTREsgc2hvdWxkIGF0dGVtcHQgdG8gcmVtb3ZlIHRoZSBpbnZhbGlkCiAgICogZW5kcG9pbnQgZnJvbSBjYWNoZS4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBpbnZhbGlkYXRlQ2FjaGVkRW5kcG9pbnRzKHJlc3BvbnNlKSB7CiAgICB2YXIgZXJyb3IgPSByZXNwb25zZS5lcnJvcjsKICAgIHZhciBodHRwUmVzcG9uc2UgPSByZXNwb25zZS5odHRwUmVzcG9uc2U7CiAgICBpZiAoZXJyb3IgJiYKICAgICAgKGVycm9yLmNvZGUgPT09ICdJbnZhbGlkRW5kcG9pbnRFeGNlcHRpb24nIHx8IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlID09PSA0MjEpCiAgICApIHsKICAgICAgdmFyIHJlcXVlc3QgPSByZXNwb25zZS5yZXF1ZXN0OwogICAgICB2YXIgb3BlcmF0aW9ucyA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9ucyB8fCB7fTsKICAgICAgdmFyIGlucHV0U2hhcGUgPSBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXSA/IG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dLmlucHV0IDogdW5kZWZpbmVkOwogICAgICB2YXIgaWRlbnRpZmllcnMgPSBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzKHJlcXVlc3QsIGlucHV0U2hhcGUpOwogICAgICB2YXIgY2FjaGVLZXkgPSBnZXRDYWNoZUtleShyZXF1ZXN0KTsKICAgICAgaWYgKE9iamVjdC5rZXlzKGlkZW50aWZpZXJzKS5sZW5ndGggPiAwKSB7CiAgICAgICAgY2FjaGVLZXkgPSB1dGlsLnVwZGF0ZShjYWNoZUtleSwgaWRlbnRpZmllcnMpOwogICAgICAgIGlmIChvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXSkgY2FjaGVLZXkub3BlcmF0aW9uID0gb3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0ubmFtZTsKICAgICAgfQogICAgICBBV1MuZW5kcG9pbnRDYWNoZS5yZW1vdmUoY2FjaGVLZXkpOwogICAgfQogIH0KICAKICAvKioKICAgKiBJZiBlbmRwb2ludCBpcyBleHBsaWNpdGx5IGNvbmZpZ3VyZWQsIFNESyBzaG91bGQgbm90IGRvIGVuZHBvaW50IGRpc2NvdmVyeSBpbiBhbnl0aW1lLgogICAqIEBwYXJhbSBbb2JqZWN0XSBjbGllbnQgU2VydmljZSBjbGllbnQgb2JqZWN0LgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGhhc0N1c3RvbUVuZHBvaW50KGNsaWVudCkgewogICAgLy9pZiBzZXQgZW5kcG9pbnQgaXMgc2V0IGZvciBzcGVjaWZpYyBjbGllbnQsIGVuYWJsZSBlbmRwb2ludCBkaXNjb3Zlcnkgd2lsbCByYWlzZSBhbiBlcnJvci4KICAgIGlmIChjbGllbnQuX29yaWdpbmFsQ29uZmlnICYmIGNsaWVudC5fb3JpZ2luYWxDb25maWcuZW5kcG9pbnQgJiYgY2xpZW50Ll9vcmlnaW5hbENvbmZpZy5lbmRwb2ludERpc2NvdmVyeUVuYWJsZWQgPT09IHRydWUpIHsKICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgIGNvZGU6ICdDb25maWd1cmF0aW9uRXhjZXB0aW9uJywKICAgICAgICBtZXNzYWdlOiAnQ3VzdG9tIGVuZHBvaW50IGlzIHN1cHBsaWVkOyBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWQgbXVzdCBub3QgYmUgdHJ1ZS4nCiAgICAgIH0pOwogICAgfTsKICAgIHZhciBzdmNDb25maWcgPSBBV1MuY29uZmlnW2NsaWVudC5zZXJ2aWNlSWRlbnRpZmllcl0gfHwge307CiAgICByZXR1cm4gQm9vbGVhbihBV1MuY29uZmlnLmVuZHBvaW50IHx8IHN2Y0NvbmZpZy5lbmRwb2ludCB8fCAoY2xpZW50Ll9vcmlnaW5hbENvbmZpZyAmJiBjbGllbnQuX29yaWdpbmFsQ29uZmlnLmVuZHBvaW50KSk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGlzRmFsc3kodmFsdWUpIHsKICAgIHJldHVybiBbJ2ZhbHNlJywgJzAnXS5pbmRleE9mKHZhbHVlKSA+PSAwOwogIH0KICAKICAvKioKICAgKiBJZiBlbmRwb2ludCBkaXNjb3Zlcnkgc2hvdWxkIHBlcmZvcm0gZm9yIHRoaXMgcmVxdWVzdCB3aGVuIGVuZHBvaW50IGRpc2NvdmVyeSBpcyBvcHRpb25hbC4KICAgKiBTREsgcGVyZm9ybXMgY29uZmlnIHJlc29sdXRpb24gaW4gb3JkZXIgbGlrZSBiZWxvdzoKICAgKiAxLiBJZiB0dXJuZWQgb24gY2xpZW50IGNvbmZpZ3VyYXRpb24oZGVmYXVsdCB0byBvZmYpIHRoZW4gdHVybiBvbiBlbmRwb2ludCBkaXNjb3ZlcnkuCiAgICogMi4gSWYgdHVybmVkIG9uIGluIGVudiBBV1NfRU5BQkxFX0VORFBPSU5UX0RJU0NPVkVSWSB0aGVuIHR1cm4gb24gZW5kcG9pbnQgZGlzY292ZXJ5LgogICAqIDMuIElmIHR1cm5lZCBvbiBpbiBzaGFyZWQgaW5pIGNvbmZpZyBmaWxlIHdpdGgga2V5ICdlbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZCcsIHRoZW4KICAgKiAgIHR1cm4gb24gZW5kcG9pbnQgZGlzY292ZXJ5LgogICAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0IHJlcXVlc3Qgb2JqZWN0LgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGlzRW5kcG9pbnREaXNjb3ZlcnlBcHBsaWNhYmxlKHJlcXVlc3QpIHsKICAgIHZhciBzZXJ2aWNlID0gcmVxdWVzdC5zZXJ2aWNlIHx8IHt9OwogICAgaWYgKHNlcnZpY2UuY29uZmlnLmVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZCA9PT0gdHJ1ZSkgcmV0dXJuIHRydWU7CiAgCiAgICAvL3NoYXJlZCBpbmkgZmlsZSBpcyBvbmx5IGF2YWlsYWJsZSBpbiBOb2RlCiAgICAvL25vdCB0byBjaGVjayBlbnYgaW4gYnJvd3NlcgogICAgaWYgKHV0aWwuaXNCcm93c2VyKCkpIHJldHVybiBmYWxzZTsKICAKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkRW52cy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgZW52ID0gZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkRW52c1tpXTsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwcm9jZXNzLmVudiwgZW52KSkgewogICAgICAgIGlmIChwcm9jZXNzLmVudltlbnZdID09PSAnJyB8fCBwcm9jZXNzLmVudltlbnZdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICAgICAgY29kZTogJ0NvbmZpZ3VyYXRpb25FeGNlcHRpb24nLAogICAgICAgICAgICBtZXNzYWdlOiAnZW52aXJvbm1lbnRhbCB2YXJpYWJsZSAnICsgZW52ICsgJyBjYW5ub3QgYmUgc2V0IHRvIG5vdGhpbmcnCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKCFpc0ZhbHN5KHByb2Nlc3MuZW52W2Vudl0pKSByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogIAogICAgdmFyIGNvbmZpZ0ZpbGUgPSB7fTsKICAgIHRyeSB7CiAgICAgIGNvbmZpZ0ZpbGUgPSBBV1MudXRpbC5pbmlMb2FkZXIgPyBBV1MudXRpbC5pbmlMb2FkZXIubG9hZEZyb20oewogICAgICAgIGlzQ29uZmlnOiB0cnVlLAogICAgICAgIGZpbGVuYW1lOiBwcm9jZXNzLmVudltBV1MudXRpbC5zaGFyZWRDb25maWdGaWxlRW52XQogICAgICB9KSA6IHt9OwogICAgfSBjYXRjaCAoZSkge30KICAgIHZhciBzaGFyZWRGaWxlQ29uZmlnID0gY29uZmlnRmlsZVsKICAgICAgcHJvY2Vzcy5lbnYuQVdTX1BST0ZJTEUgfHwgQVdTLnV0aWwuZGVmYXVsdFByb2ZpbGUKICAgIF0gfHwge307CiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNoYXJlZEZpbGVDb25maWcsICdlbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZCcpKSB7CiAgICAgIGlmIChzaGFyZWRGaWxlQ29uZmlnLmVuZHBvaW50X2Rpc2NvdmVyeV9lbmFibGVkID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICBjb2RlOiAnQ29uZmlndXJhdGlvbkV4Y2VwdGlvbicsCiAgICAgICAgICBtZXNzYWdlOiAnY29uZmlnIGZpbGUgZW50cnkgXCdlbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZFwnIGNhbm5vdCBiZSBzZXQgdG8gbm90aGluZycKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoIWlzRmFsc3koc2hhcmVkRmlsZUNvbmZpZy5lbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZCkpIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICAKICAvKioKICAgKiBhdHRhY2ggZW5kcG9pbnQgZGlzY292ZXJ5IGxvZ2ljIHRvIHJlcXVlc3Qgb2JqZWN0CiAgICogQHBhcmFtIFtvYmplY3RdIHJlcXVlc3QKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBkaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QsIGRvbmUpIHsKICAgIHZhciBzZXJ2aWNlID0gcmVxdWVzdC5zZXJ2aWNlIHx8IHt9OwogICAgaWYgKGhhc0N1c3RvbUVuZHBvaW50KHNlcnZpY2UpIHx8IHJlcXVlc3QuaXNQcmVzaWduZWQoKSkgcmV0dXJuIGRvbmUoKTsKICAKICAgIGlmICghaXNFbmRwb2ludERpc2NvdmVyeUFwcGxpY2FibGUocmVxdWVzdCkpIHJldHVybiBkb25lKCk7CiAgCiAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmFwcGVuZFRvVXNlckFnZW50KCdlbmRwb2ludC1kaXNjb3ZlcnknKTsKICAKICAgIHZhciBvcGVyYXRpb25zID0gc2VydmljZS5hcGkub3BlcmF0aW9ucyB8fCB7fTsKICAgIHZhciBvcGVyYXRpb25Nb2RlbCA9IG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dOwogICAgdmFyIGlzRW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCA9IG9wZXJhdGlvbk1vZGVsID8gb3BlcmF0aW9uTW9kZWwuZW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCA6ICdOVUxMJzsKICAgIHN3aXRjaCAoaXNFbmRwb2ludERpc2NvdmVyeVJlcXVpcmVkKSB7CiAgICAgIGNhc2UgJ09QVElPTkFMJzoKICAgICAgICBvcHRpb25hbERpc2NvdmVyRW5kcG9pbnQocmVxdWVzdCk7CiAgICAgICAgcmVxdWVzdC5hZGROYW1lZExpc3RlbmVyKCdJTlZBTElEQVRFX0NBQ0hFRF9FTkRQT0lOVFMnLCAnZXh0cmFjdEVycm9yJywgaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50cyk7CiAgICAgICAgZG9uZSgpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdSRVFVSVJFRCc6CiAgICAgICAgcmVxdWVzdC5hZGROYW1lZExpc3RlbmVyKCdJTlZBTElEQVRFX0NBQ0hFRF9FTkRQT0lOVFMnLCAnZXh0cmFjdEVycm9yJywgaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50cyk7CiAgICAgICAgcmVxdWlyZWREaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QsIGRvbmUpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdOVUxMJzoKICAgICAgZGVmYXVsdDoKICAgICAgICBkb25lKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gewogICAgZGlzY292ZXJFbmRwb2ludDogZGlzY292ZXJFbmRwb2ludCwKICAgIHJlcXVpcmVkRGlzY292ZXJFbmRwb2ludDogcmVxdWlyZWREaXNjb3ZlckVuZHBvaW50LAogICAgb3B0aW9uYWxEaXNjb3ZlckVuZHBvaW50OiBvcHRpb25hbERpc2NvdmVyRW5kcG9pbnQsCiAgICBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzOiBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzLAogICAgZ2V0Q2FjaGVLZXk6IGdldENhY2hlS2V5LAogICAgaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50OiBpbnZhbGlkYXRlQ2FjaGVkRW5kcG9pbnRzLAogIH07CiAgCiAgfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCiAgfSx7Ii4vY29yZSI6MTgsIi4vdXRpbCI6NzEsIl9wcm9jZXNzIjo4NX1dLDI3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgZXZlbnRNZXNzYWdlQ2h1bmtlciA9IHJlcXVpcmUoJy4uL2V2ZW50LXN0cmVhbS9ldmVudC1tZXNzYWdlLWNodW5rZXInKS5ldmVudE1lc3NhZ2VDaHVua2VyOwogIHZhciBwYXJzZUV2ZW50ID0gcmVxdWlyZSgnLi9wYXJzZS1ldmVudCcpLnBhcnNlRXZlbnQ7CiAgCiAgZnVuY3Rpb24gY3JlYXRlRXZlbnRTdHJlYW0oYm9keSwgcGFyc2VyLCBtb2RlbCkgewogICAgICB2YXIgZXZlbnRNZXNzYWdlcyA9IGV2ZW50TWVzc2FnZUNodW5rZXIoYm9keSk7CiAgCiAgICAgIHZhciBldmVudHMgPSBbXTsKICAKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudE1lc3NhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBldmVudHMucHVzaChwYXJzZUV2ZW50KHBhcnNlciwgZXZlbnRNZXNzYWdlc1tpXSwgbW9kZWwpKTsKICAgICAgfQogIAogICAgICByZXR1cm4gZXZlbnRzOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgY3JlYXRlRXZlbnRTdHJlYW06IGNyZWF0ZUV2ZW50U3RyZWFtCiAgfTsKICAKICB9LHsiLi4vZXZlbnQtc3RyZWFtL2V2ZW50LW1lc3NhZ2UtY2h1bmtlciI6MjgsIi4vcGFyc2UtZXZlbnQiOjMwfV0sMjg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8qKgogICAqIFRha2VzIGluIGEgYnVmZmVyIG9mIGV2ZW50IG1lc3NhZ2VzIGFuZCBzcGxpdHMgdGhlbSBpbnRvIGluZGl2aWR1YWwgbWVzc2FnZXMuCiAgICogQHBhcmFtIHtCdWZmZXJ9IGJ1ZmZlcgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGV2ZW50TWVzc2FnZUNodW5rZXIoYnVmZmVyKSB7CiAgICAgIC8qKiBAdHlwZSBCdWZmZXJbXSAqLwogICAgICB2YXIgbWVzc2FnZXMgPSBbXTsKICAgICAgdmFyIG9mZnNldCA9IDA7CiAgCiAgICAgIHdoaWxlIChvZmZzZXQgPCBidWZmZXIubGVuZ3RoKSB7CiAgICAgICAgICB2YXIgdG90YWxMZW5ndGggPSBidWZmZXIucmVhZEludDMyQkUob2Zmc2V0KTsKICAKICAgICAgICAgIC8vIGNyZWF0ZSBuZXcgYnVmZmVyIGZvciBpbmRpdmlkdWFsIG1lc3NhZ2UgKHNoYXJlcyBtZW1vcnkgd2l0aCBvcmlnaW5hbCkKICAgICAgICAgIHZhciBtZXNzYWdlID0gYnVmZmVyLnNsaWNlKG9mZnNldCwgdG90YWxMZW5ndGggKyBvZmZzZXQpOwogICAgICAgICAgLy8gaW5jcmVtZW50IG9mZnNldCB0byBpdCBzdGFydHMgYXQgdGhlIG5leHQgbWVzc2FnZQogICAgICAgICAgb2Zmc2V0ICs9IHRvdGFsTGVuZ3RoOwogIAogICAgICAgICAgbWVzc2FnZXMucHVzaChtZXNzYWdlKTsKICAgICAgfQogIAogICAgICByZXR1cm4gbWVzc2FnZXM7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBldmVudE1lc3NhZ2VDaHVua2VyOiBldmVudE1lc3NhZ2VDaHVua2VyCiAgfTsKICAKICB9LHt9XSwyOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi9jb3JlJykudXRpbDsKICB2YXIgdG9CdWZmZXIgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcjsKICAKICAvKioKICAgKiBBIGxvc3NsZXNzIHJlcHJlc2VudGF0aW9uIG9mIGEgc2lnbmVkLCA2NC1iaXQgaW50ZWdlci4gSW5zdGFuY2VzIG9mIHRoaXMKICAgKiBjbGFzcyBtYXkgYmUgdXNlZCBpbiBhcml0aG1ldGljIGV4cHJlc3Npb25zIGFzIGlmIHRoZXkgd2VyZSBudW1lcmljCiAgICogcHJpbWl0aXZlcywgYnV0IHRoZSBiaW5hcnkgcmVwcmVzZW50YXRpb24gd2lsbCBiZSBwcmVzZXJ2ZWQgdW5jaGFuZ2VkIGFzIHRoZQogICAqIGBieXRlc2AgcHJvcGVydHkgb2YgdGhlIG9iamVjdC4gVGhlIGJ5dGVzIHNob3VsZCBiZSBlbmNvZGVkIGFzIGJpZy1lbmRpYW4sCiAgICogdHdvJ3MgY29tcGxlbWVudCBpbnRlZ2Vycy4KICAgKiBAcGFyYW0ge0J1ZmZlcn0gYnl0ZXMKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIEludDY0KGJ5dGVzKSB7CiAgICAgIGlmIChieXRlcy5sZW5ndGggIT09IDgpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW50NjQgYnVmZmVycyBtdXN0IGJlIGV4YWN0bHkgOCBieXRlcycpOwogICAgICB9CiAgICAgIGlmICghdXRpbC5CdWZmZXIuaXNCdWZmZXIoYnl0ZXMpKSBieXRlcyA9IHRvQnVmZmVyKGJ5dGVzKTsKICAKICAgICAgdGhpcy5ieXRlcyA9IGJ5dGVzOwogIH0KICAKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gbnVtYmVyCiAgICogQHJldHVybnMge0ludDY0fQogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgSW50NjQuZnJvbU51bWJlciA9IGZ1bmN0aW9uKG51bWJlcikgewogICAgICBpZiAobnVtYmVyID4gOTIyMzM3MjAzNjg1NDc3NTgwNyB8fCBudW1iZXIgPCAtOTIyMzM3MjAzNjg1NDc3NTgwOCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAgIG51bWJlciArICcgaXMgdG9vIGxhcmdlIChvciwgaWYgbmVnYXRpdmUsIHRvbyBzbWFsbCkgdG8gcmVwcmVzZW50IGFzIGFuIEludDY0JwogICAgICAgICAgKTsKICAgICAgfQogIAogICAgICB2YXIgYnl0ZXMgPSBuZXcgVWludDhBcnJheSg4KTsKICAgICAgZm9yICgKICAgICAgICAgIHZhciBpID0gNywgcmVtYWluaW5nID0gTWF0aC5hYnMoTWF0aC5yb3VuZChudW1iZXIpKTsKICAgICAgICAgIGkgPiAtMSAmJiByZW1haW5pbmcgPiAwOwogICAgICAgICAgaS0tLCByZW1haW5pbmcgLz0gMjU2CiAgICAgICkgewogICAgICAgICAgYnl0ZXNbaV0gPSByZW1haW5pbmc7CiAgICAgIH0KICAKICAgICAgaWYgKG51bWJlciA8IDApIHsKICAgICAgICAgIG5lZ2F0ZShieXRlcyk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIG5ldyBJbnQ2NChieXRlcyk7CiAgfTsKICAKICAvKioKICAgKiBAcmV0dXJucyB7bnVtYmVyfQogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgSW50NjQucHJvdG90eXBlLnZhbHVlT2YgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGJ5dGVzID0gdGhpcy5ieXRlcy5zbGljZSgwKTsKICAgICAgdmFyIG5lZ2F0aXZlID0gYnl0ZXNbMF0gJiAxMjg7CiAgICAgIGlmIChuZWdhdGl2ZSkgewogICAgICAgICAgbmVnYXRlKGJ5dGVzKTsKICAgICAgfQogIAogICAgICByZXR1cm4gcGFyc2VJbnQoYnl0ZXMudG9TdHJpbmcoJ2hleCcpLCAxNikgKiAobmVnYXRpdmUgPyAtMSA6IDEpOwogIH07CiAgCiAgSW50NjQucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBTdHJpbmcodGhpcy52YWx1ZU9mKCkpOwogIH07CiAgCiAgLyoqCiAgICogQHBhcmFtIHtCdWZmZXJ9IGJ5dGVzCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBuZWdhdGUoYnl0ZXMpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCA4OyBpKyspIHsKICAgICAgICAgIGJ5dGVzW2ldIF49IDB4RkY7CiAgICAgIH0KICAgICAgZm9yICh2YXIgaSA9IDc7IGkgPiAtMTsgaS0tKSB7CiAgICAgICAgICBieXRlc1tpXSsrOwogICAgICAgICAgaWYgKGJ5dGVzW2ldICE9PSAwKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIEludDY0OiBJbnQ2NAogIH07CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sMzA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBwYXJzZU1lc3NhZ2UgPSByZXF1aXJlKCcuL3BhcnNlLW1lc3NhZ2UnKS5wYXJzZU1lc3NhZ2U7CiAgCiAgLyoqCiAgICoKICAgKiBAcGFyYW0geyp9IHBhcnNlcgogICAqIEBwYXJhbSB7QnVmZmVyfSBtZXNzYWdlCiAgICogQHBhcmFtIHsqfSBzaGFwZQogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHBhcnNlRXZlbnQocGFyc2VyLCBtZXNzYWdlLCBzaGFwZSkgewogICAgICB2YXIgcGFyc2VkTWVzc2FnZSA9IHBhcnNlTWVzc2FnZShtZXNzYWdlKTsKICAKICAgICAgLy8gY2hlY2sgaWYgbWVzc2FnZSBpcyBhbiBldmVudCBvciBlcnJvcgogICAgICB2YXIgbWVzc2FnZVR5cGUgPSBwYXJzZWRNZXNzYWdlLmhlYWRlcnNbJzptZXNzYWdlLXR5cGUnXTsKICAgICAgaWYgKG1lc3NhZ2VUeXBlKSB7CiAgICAgICAgICBpZiAobWVzc2FnZVR5cGUudmFsdWUgPT09ICdlcnJvcicpIHsKICAgICAgICAgICAgICB0aHJvdyBwYXJzZUVycm9yKHBhcnNlZE1lc3NhZ2UpOwogICAgICAgICAgfSBlbHNlIGlmIChtZXNzYWdlVHlwZS52YWx1ZSAhPT0gJ2V2ZW50JykgewogICAgICAgICAgICAgIC8vIG5vdCBzdXJlIGhvdyB0byBwYXJzZSBub24tZXZlbnRzL25vbi1lcnJvcnMsIGlnbm9yZSBmb3Igbm93CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICB9CiAgCiAgICAgIC8vIGRldGVybWluZSBldmVudCB0eXBlCiAgICAgIHZhciBldmVudFR5cGUgPSBwYXJzZWRNZXNzYWdlLmhlYWRlcnNbJzpldmVudC10eXBlJ107CiAgICAgIC8vIGNoZWNrIHRoYXQgdGhlIGV2ZW50IHR5cGUgaXMgbW9kZWxlZAogICAgICB2YXIgZXZlbnRNb2RlbCA9IHNoYXBlLm1lbWJlcnNbZXZlbnRUeXBlLnZhbHVlXTsKICAgICAgaWYgKCFldmVudE1vZGVsKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgIH0KICAKICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICAvLyBjaGVjayBpZiBhbiBldmVudCBwYXlsb2FkIGV4aXN0cwogICAgICB2YXIgZXZlbnRQYXlsb2FkTWVtYmVyTmFtZSA9IGV2ZW50TW9kZWwuZXZlbnRQYXlsb2FkTWVtYmVyTmFtZTsKICAgICAgaWYgKGV2ZW50UGF5bG9hZE1lbWJlck5hbWUpIHsKICAgICAgICAgIHZhciBwYXlsb2FkU2hhcGUgPSBldmVudE1vZGVsLm1lbWJlcnNbZXZlbnRQYXlsb2FkTWVtYmVyTmFtZV07CiAgICAgICAgICAvLyBpZiB0aGUgc2hhcGUgaXMgYmluYXJ5LCByZXR1cm4gdGhlIGJ5dGUgYXJyYXkKICAgICAgICAgIGlmIChwYXlsb2FkU2hhcGUudHlwZSA9PT0gJ2JpbmFyeScpIHsKICAgICAgICAgICAgICByZXN1bHRbZXZlbnRQYXlsb2FkTWVtYmVyTmFtZV0gPSBwYXJzZWRNZXNzYWdlLmJvZHk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc3VsdFtldmVudFBheWxvYWRNZW1iZXJOYW1lXSA9IHBhcnNlci5wYXJzZShwYXJzZWRNZXNzYWdlLmJvZHkudG9TdHJpbmcoKSwgcGF5bG9hZFNoYXBlKTsKICAgICAgICAgIH0KICAgICAgfQogIAogICAgICAvLyByZWFkIGV2ZW50IGhlYWRlcnMKICAgICAgdmFyIGV2ZW50SGVhZGVyTmFtZXMgPSBldmVudE1vZGVsLmV2ZW50SGVhZGVyTWVtYmVyTmFtZXM7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnRIZWFkZXJOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIG5hbWUgPSBldmVudEhlYWRlck5hbWVzW2ldOwogICAgICAgICAgaWYgKHBhcnNlZE1lc3NhZ2UuaGVhZGVyc1tuYW1lXSkgewogICAgICAgICAgICAgIC8vIHBhcnNlIHRoZSBoZWFkZXIhCiAgICAgICAgICAgICAgcmVzdWx0W25hbWVdID0gZXZlbnRNb2RlbC5tZW1iZXJzW25hbWVdLnRvVHlwZShwYXJzZWRNZXNzYWdlLmhlYWRlcnNbbmFtZV0udmFsdWUpOwogICAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHZhciBvdXRwdXQgPSB7fTsKICAgICAgb3V0cHV0W2V2ZW50VHlwZS52YWx1ZV0gPSByZXN1bHQ7CiAgICAgIHJldHVybiBvdXRwdXQ7CiAgfQogIAogIGZ1bmN0aW9uIHBhcnNlRXJyb3IobWVzc2FnZSkgewogICAgICB2YXIgZXJyb3JDb2RlID0gbWVzc2FnZS5oZWFkZXJzWyc6ZXJyb3ItY29kZSddOwogICAgICB2YXIgZXJyb3JNZXNzYWdlID0gbWVzc2FnZS5oZWFkZXJzWyc6ZXJyb3ItbWVzc2FnZSddOwogICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoZXJyb3JNZXNzYWdlLnZhbHVlIHx8IGVycm9yTWVzc2FnZSk7CiAgICAgIGVycm9yLmNvZGUgPSBlcnJvci5uYW1lID0gZXJyb3JDb2RlLnZhbHVlIHx8IGVycm9yQ29kZTsKICAgICAgcmV0dXJuIGVycm9yOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgcGFyc2VFdmVudDogcGFyc2VFdmVudAogIH07CiAgCiAgfSx7Ii4vcGFyc2UtbWVzc2FnZSI6MzF9XSwzMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEludDY0ID0gcmVxdWlyZSgnLi9pbnQ2NCcpLkludDY0OwogIAogIHZhciBzcGxpdE1lc3NhZ2UgPSByZXF1aXJlKCcuL3NwbGl0LW1lc3NhZ2UnKS5zcGxpdE1lc3NhZ2U7CiAgCiAgdmFyIEJPT0xFQU5fVEFHID0gJ2Jvb2xlYW4nOwogIHZhciBCWVRFX1RBRyA9ICdieXRlJzsKICB2YXIgU0hPUlRfVEFHID0gJ3Nob3J0JzsKICB2YXIgSU5UX1RBRyA9ICdpbnRlZ2VyJzsKICB2YXIgTE9OR19UQUcgPSAnbG9uZyc7CiAgdmFyIEJJTkFSWV9UQUcgPSAnYmluYXJ5JzsKICB2YXIgU1RSSU5HX1RBRyA9ICdzdHJpbmcnOwogIHZhciBUSU1FU1RBTVBfVEFHID0gJ3RpbWVzdGFtcCc7CiAgdmFyIFVVSURfVEFHID0gJ3V1aWQnOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqCiAgICogQHBhcmFtIHtCdWZmZXJ9IGhlYWRlcnMKICAgKi8KICBmdW5jdGlvbiBwYXJzZUhlYWRlcnMoaGVhZGVycykgewogICAgICB2YXIgb3V0ID0ge307CiAgICAgIHZhciBwb3NpdGlvbiA9IDA7CiAgICAgIHdoaWxlIChwb3NpdGlvbiA8IGhlYWRlcnMubGVuZ3RoKSB7CiAgICAgICAgICB2YXIgbmFtZUxlbmd0aCA9IGhlYWRlcnMucmVhZFVJbnQ4KHBvc2l0aW9uKyspOwogICAgICAgICAgdmFyIG5hbWUgPSBoZWFkZXJzLnNsaWNlKHBvc2l0aW9uLCBwb3NpdGlvbiArIG5hbWVMZW5ndGgpLnRvU3RyaW5nKCk7CiAgICAgICAgICBwb3NpdGlvbiArPSBuYW1lTGVuZ3RoOwogICAgICAgICAgc3dpdGNoIChoZWFkZXJzLnJlYWRVSW50OChwb3NpdGlvbisrKSkgewogICAgICAgICAgICAgIGNhc2UgMCAvKiBib29sVHJ1ZSAqLzoKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogQk9PTEVBTl9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdHJ1ZQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDEgLyogYm9vbEZhbHNlICovOgogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBCT09MRUFOX1RBRywKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmYWxzZQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDIgLyogYnl0ZSAqLzoKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogQllURV9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5yZWFkSW50OChwb3NpdGlvbisrKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDMgLyogc2hvcnQgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFNIT1JUX1RBRywKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBoZWFkZXJzLnJlYWRJbnQxNkJFKHBvc2l0aW9uKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSAyOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDQgLyogaW50ZWdlciAqLzoKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogSU5UX1RBRywKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBoZWFkZXJzLnJlYWRJbnQzMkJFKHBvc2l0aW9uKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSA0OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDUgLyogbG9uZyAqLzoKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogTE9OR19UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbmV3IEludDY0KGhlYWRlcnMuc2xpY2UocG9zaXRpb24sIHBvc2l0aW9uICsgOCkpCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgNiAvKiBieXRlQXJyYXkgKi86CiAgICAgICAgICAgICAgICAgIHZhciBiaW5hcnlMZW5ndGggPSBoZWFkZXJzLnJlYWRVSW50MTZCRShwb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDI7CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IEJJTkFSWV9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyBiaW5hcnlMZW5ndGgpCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IGJpbmFyeUxlbmd0aDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA3IC8qIHN0cmluZyAqLzoKICAgICAgICAgICAgICAgICAgdmFyIHN0cmluZ0xlbmd0aCA9IGhlYWRlcnMucmVhZFVJbnQxNkJFKHBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gMjsKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogU1RSSU5HX1RBRywKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBoZWFkZXJzLnNsaWNlKAogICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICsgc3RyaW5nTGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgICApLnRvU3RyaW5nKCkKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gc3RyaW5nTGVuZ3RoOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDggLyogdGltZXN0YW1wICovOgogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBUSU1FU1RBTVBfVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG5ldyBEYXRlKAogICAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBJbnQ2NChoZWFkZXJzLnNsaWNlKHBvc2l0aW9uLCBwb3NpdGlvbiArIDgpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudmFsdWVPZigpCiAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgOSAvKiB1dWlkICovOgogICAgICAgICAgICAgICAgICB2YXIgdXVpZENoYXJzID0gaGVhZGVycy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyAxNikKICAgICAgICAgICAgICAgICAgICAgIC50b1N0cmluZygnaGV4Jyk7CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDE2OwogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBVVUlEX1RBRywKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiB1dWlkQ2hhcnMuc3Vic3RyKDAsIDgpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgICB1dWlkQ2hhcnMuc3Vic3RyKDgsIDQpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgICB1dWlkQ2hhcnMuc3Vic3RyKDEyLCA0KSArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgdXVpZENoYXJzLnN1YnN0cigxNiwgNCkgKyAnLScgKwogICAgICAgICAgICAgICAgICAgICAgICAgIHV1aWRDaGFycy5zdWJzdHIoMjApCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5yZWNvZ25pemVkIGhlYWRlciB0eXBlIHRhZycpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBvdXQ7CiAgfQogIAogIGZ1bmN0aW9uIHBhcnNlTWVzc2FnZShtZXNzYWdlKSB7CiAgICAgIHZhciBwYXJzZWQgPSBzcGxpdE1lc3NhZ2UobWVzc2FnZSk7CiAgICAgIHJldHVybiB7IGhlYWRlcnM6IHBhcnNlSGVhZGVycyhwYXJzZWQuaGVhZGVycyksIGJvZHk6IHBhcnNlZC5ib2R5IH07CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBwYXJzZU1lc3NhZ2U6IHBhcnNlTWVzc2FnZQogIH07CiAgCiAgfSx7Ii4vaW50NjQiOjI5LCIuL3NwbGl0LW1lc3NhZ2UiOjMyfV0sMzI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vY29yZScpLnV0aWw7CiAgdmFyIHRvQnVmZmVyID0gdXRpbC5idWZmZXIudG9CdWZmZXI7CiAgCiAgLy8gQWxsIHByZWx1ZGUgY29tcG9uZW50cyBhcmUgdW5zaWduZWQsIDMyLWJpdCBpbnRlZ2VycwogIHZhciBQUkVMVURFX01FTUJFUl9MRU5HVEggPSA0OwogIC8vIFRoZSBwcmVsdWRlIGNvbnNpc3RzIG9mIHR3byBjb21wb25lbnRzCiAgdmFyIFBSRUxVREVfTEVOR1RIID0gUFJFTFVERV9NRU1CRVJfTEVOR1RIICogMjsKICAvLyBDaGVja3N1bXMgYXJlIGFsd2F5cyBDUkMzMiBoYXNoZXMuCiAgdmFyIENIRUNLU1VNX0xFTkdUSCA9IDQ7CiAgLy8gTWVzc2FnZXMgbXVzdCBpbmNsdWRlIGEgZnVsbCBwcmVsdWRlLCBhIHByZWx1ZGUgY2hlY2tzdW0sIGFuZCBhIG1lc3NhZ2UgY2hlY2tzdW0KICB2YXIgTUlOSU1VTV9NRVNTQUdFX0xFTkdUSCA9IFBSRUxVREVfTEVOR1RIICsgQ0hFQ0tTVU1fTEVOR1RIICogMjsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKgogICAqIEBwYXJhbSB7QnVmZmVyfSBtZXNzYWdlCiAgICovCiAgZnVuY3Rpb24gc3BsaXRNZXNzYWdlKG1lc3NhZ2UpIHsKICAgICAgaWYgKCF1dGlsLkJ1ZmZlci5pc0J1ZmZlcihtZXNzYWdlKSkgbWVzc2FnZSA9IHRvQnVmZmVyKG1lc3NhZ2UpOwogIAogICAgICBpZiAobWVzc2FnZS5sZW5ndGggPCBNSU5JTVVNX01FU1NBR0VfTEVOR1RIKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Byb3ZpZGVkIG1lc3NhZ2UgdG9vIHNob3J0IHRvIGFjY29tbW9kYXRlIGV2ZW50IHN0cmVhbSBtZXNzYWdlIG92ZXJoZWFkJyk7CiAgICAgIH0KICAKICAgICAgaWYgKG1lc3NhZ2UubGVuZ3RoICE9PSBtZXNzYWdlLnJlYWRVSW50MzJCRSgwKSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZXBvcnRlZCBtZXNzYWdlIGxlbmd0aCBkb2VzIG5vdCBtYXRjaCByZWNlaXZlZCBtZXNzYWdlIGxlbmd0aCcpOwogICAgICB9CiAgCiAgICAgIHZhciBleHBlY3RlZFByZWx1ZGVDaGVja3N1bSA9IG1lc3NhZ2UucmVhZFVJbnQzMkJFKFBSRUxVREVfTEVOR1RIKTsKICAKICAgICAgaWYgKAogICAgICAgICAgZXhwZWN0ZWRQcmVsdWRlQ2hlY2tzdW0gIT09IHV0aWwuY3J5cHRvLmNyYzMyKAogICAgICAgICAgICAgIG1lc3NhZ2Uuc2xpY2UoMCwgUFJFTFVERV9MRU5HVEgpCiAgICAgICAgICApCiAgICAgICkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAgICdUaGUgcHJlbHVkZSBjaGVja3N1bSBzcGVjaWZpZWQgaW4gdGhlIG1lc3NhZ2UgKCcgKwogICAgICAgICAgICAgIGV4cGVjdGVkUHJlbHVkZUNoZWNrc3VtICsKICAgICAgICAgICAgICAnKSBkb2VzIG5vdCBtYXRjaCB0aGUgY2FsY3VsYXRlZCBDUkMzMiBjaGVja3N1bS4nCiAgICAgICAgICApOwogICAgICB9CiAgCiAgICAgIHZhciBleHBlY3RlZE1lc3NhZ2VDaGVja3N1bSA9IG1lc3NhZ2UucmVhZFVJbnQzMkJFKG1lc3NhZ2UubGVuZ3RoIC0gQ0hFQ0tTVU1fTEVOR1RIKTsKICAKICAgICAgaWYgKAogICAgICAgICAgZXhwZWN0ZWRNZXNzYWdlQ2hlY2tzdW0gIT09IHV0aWwuY3J5cHRvLmNyYzMyKAogICAgICAgICAgICAgIG1lc3NhZ2Uuc2xpY2UoMCwgbWVzc2FnZS5sZW5ndGggLSBDSEVDS1NVTV9MRU5HVEgpCiAgICAgICAgICApCiAgICAgICkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAgICdUaGUgbWVzc2FnZSBjaGVja3N1bSBkaWQgbm90IG1hdGNoIHRoZSBleHBlY3RlZCB2YWx1ZSBvZiAnICsKICAgICAgICAgICAgICAgICAgZXhwZWN0ZWRNZXNzYWdlQ2hlY2tzdW0KICAgICAgICAgICk7CiAgICAgIH0KICAKICAgICAgdmFyIGhlYWRlcnNTdGFydCA9IFBSRUxVREVfTEVOR1RIICsgQ0hFQ0tTVU1fTEVOR1RIOwogICAgICB2YXIgaGVhZGVyc0VuZCA9IGhlYWRlcnNTdGFydCArIG1lc3NhZ2UucmVhZFVJbnQzMkJFKFBSRUxVREVfTUVNQkVSX0xFTkdUSCk7CiAgCiAgICAgIHJldHVybiB7CiAgICAgICAgICBoZWFkZXJzOiBtZXNzYWdlLnNsaWNlKGhlYWRlcnNTdGFydCwgaGVhZGVyc0VuZCksCiAgICAgICAgICBib2R5OiBtZXNzYWdlLnNsaWNlKGhlYWRlcnNFbmQsIG1lc3NhZ2UubGVuZ3RoIC0gQ0hFQ0tTVU1fTEVOR1RIKSwKICAgICAgfTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIHNwbGl0TWVzc2FnZTogc3BsaXRNZXNzYWdlCiAgfTsKICAKICB9LHsiLi4vY29yZSI6MTh9XSwzMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHZhciBTZXF1ZW50aWFsRXhlY3V0b3IgPSByZXF1aXJlKCcuL3NlcXVlbnRpYWxfZXhlY3V0b3InKTsKICB2YXIgRElTQ09WRVJfRU5EUE9JTlQgPSByZXF1aXJlKCcuL2Rpc2NvdmVyX2VuZHBvaW50JykuZGlzY292ZXJFbmRwb2ludDsKICAvKioKICAgKiBUaGUgbmFtZXNwYWNlIHVzZWQgdG8gcmVnaXN0ZXIgZ2xvYmFsIGV2ZW50IGxpc3RlbmVycyBmb3IgcmVxdWVzdCBidWlsZGluZwogICAqIGFuZCBzZW5kaW5nLgogICAqLwogIEFXUy5FdmVudExpc3RlbmVycyA9IHsKICAgIC8qKgogICAgICogQCFhdHRyaWJ1dGUgVkFMSURBVEVfQ1JFREVOVElBTFMKICAgICAqICAgQSByZXF1ZXN0IGxpc3RlbmVyIHRoYXQgdmFsaWRhdGVzIHdoZXRoZXIgdGhlIHJlcXVlc3QgaXMgYmVpbmcKICAgICAqICAgc2VudCB3aXRoIGNyZWRlbnRpYWxzLgogICAgICogICBIYW5kbGVzIHRoZSB7QVdTLlJlcXVlc3R+dmFsaWRhdGUgJ3ZhbGlkYXRlJyBSZXF1ZXN0IGV2ZW50fQogICAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRob3V0IHZhbGlkYXRpbmcgY3JlZGVudGlhbHMKICAgICAqICAgICB2YXIgbGlzdGVuZXIgPSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9DUkVERU5USUFMUzsKICAgICAqICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsIGxpc3RlbmVyKTsKICAgICAqICAgQHJlYWRvbmx5CiAgICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAgICogQCFhdHRyaWJ1dGUgVkFMSURBVEVfUkVHSU9OCiAgICAgKiAgIEEgcmVxdWVzdCBsaXN0ZW5lciB0aGF0IHZhbGlkYXRlcyB3aGV0aGVyIHRoZSByZWdpb24gaXMgc2V0CiAgICAgKiAgIGZvciBhIHJlcXVlc3QuCiAgICAgKiAgIEhhbmRsZXMgdGhlIHtBV1MuUmVxdWVzdH52YWxpZGF0ZSAndmFsaWRhdGUnIFJlcXVlc3QgZXZlbnR9CiAgICAgKiAgIEBleGFtcGxlIFNlbmRpbmcgYSByZXF1ZXN0IHdpdGhvdXQgdmFsaWRhdGluZyByZWdpb24gY29uZmlndXJhdGlvbgogICAgICogICAgIHZhciBsaXN0ZW5lciA9IEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1JFR0lPTjsKICAgICAqICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsIGxpc3RlbmVyKTsKICAgICAqICAgQHJlYWRvbmx5CiAgICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAgICogQCFhdHRyaWJ1dGUgVkFMSURBVEVfUEFSQU1FVEVSUwogICAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCB2YWxpZGF0ZXMgaW5wdXQgcGFyYW1ldGVycyBpbiBhIHJlcXVlc3QuCiAgICAgKiAgIEhhbmRsZXMgdGhlIHtBV1MuUmVxdWVzdH52YWxpZGF0ZSAndmFsaWRhdGUnIFJlcXVlc3QgZXZlbnR9CiAgICAgKiAgIEBleGFtcGxlIFNlbmRpbmcgYSByZXF1ZXN0IHdpdGhvdXQgdmFsaWRhdGluZyBwYXJhbWV0ZXJzCiAgICAgKiAgICAgdmFyIGxpc3RlbmVyID0gQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUEFSQU1FVEVSUzsKICAgICAqICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsIGxpc3RlbmVyKTsKICAgICAqICAgQGV4YW1wbGUgRGlzYWJsZSBwYXJhbWV0ZXIgdmFsaWRhdGlvbiBnbG9iYWxseQogICAgICogICAgIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsCiAgICAgKiAgICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9SRUdJT04pOwogICAgICogICBAcmVhZG9ubHkKICAgICAqICAgQHJldHVybiBbRnVuY3Rpb25dCiAgICAgKiBAIWF0dHJpYnV0ZSBTRU5ECiAgICAgKiAgIEEgcmVxdWVzdCBsaXN0ZW5lciB0aGF0IGluaXRpYXRlcyB0aGUgSFRUUCBjb25uZWN0aW9uIGZvciBhCiAgICAgKiAgIHJlcXVlc3QgYmVpbmcgc2VudC4gSGFuZGxlcyB0aGUge0FXUy5SZXF1ZXN0fnNlbmQgJ3NlbmQnIFJlcXVlc3QgZXZlbnR9CiAgICAgKiAgIEBleGFtcGxlIFJlcGxhY2luZyB0aGUgSFRUUCBoYW5kbGVyCiAgICAgKiAgICAgdmFyIGxpc3RlbmVyID0gQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuU0VORDsKICAgICAqICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdzZW5kJywgbGlzdGVuZXIpOwogICAgICogICAgIHJlcXVlc3Qub24oJ3NlbmQnLCBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICogICAgICAgY3VzdG9tSGFuZGxlci5zZW5kKHJlc3BvbnNlKTsKICAgICAqICAgICB9KTsKICAgICAqICAgQHJldHVybiBbRnVuY3Rpb25dCiAgICAgKiAgIEByZWFkb25seQogICAgICogQCFhdHRyaWJ1dGUgSFRUUF9EQVRBCiAgICAgKiAgIEEgcmVxdWVzdCBsaXN0ZW5lciB0aGF0IHJlYWRzIGRhdGEgZnJvbSB0aGUgSFRUUCBjb25uZWN0aW9uIGluIG9yZGVyCiAgICAgKiAgIHRvIGJ1aWxkIHRoZSByZXNwb25zZSBkYXRhLgogICAgICogICBIYW5kbGVzIHRoZSB7QVdTLlJlcXVlc3R+aHR0cERhdGEgJ2h0dHBEYXRhJyBSZXF1ZXN0IGV2ZW50fS4KICAgICAqICAgUmVtb3ZlIHRoaXMgaGFuZGxlciBpZiB5b3UgYXJlIG92ZXJyaWRpbmcgdGhlICdodHRwRGF0YScgZXZlbnQgYW5kCiAgICAgKiAgIGRvIG5vdCB3YW50IGV4dHJhIGRhdGEgcHJvY2Vzc2luZyBhbmQgYnVmZmVyaW5nIG92ZXJoZWFkLgogICAgICogICBAZXhhbXBsZSBEaXNhYmxpbmcgZGVmYXVsdCBkYXRhIHByb2Nlc3NpbmcKICAgICAqICAgICB2YXIgbGlzdGVuZXIgPSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5IVFRQX0RBVEE7CiAgICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcignaHR0cERhdGEnLCBsaXN0ZW5lcik7CiAgICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAgICogICBAcmVhZG9ubHkKICAgICAqLwogICAgQ29yZToge30gLyogZG9jIGhhY2sgKi8KICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGdldE9wZXJhdGlvbkF1dGh0eXBlKHJlcSkgewogICAgaWYgKCFyZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucykgewogICAgICByZXR1cm4gJyc7CiAgICB9CiAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICByZXR1cm4gb3BlcmF0aW9uID8gb3BlcmF0aW9uLmF1dGh0eXBlIDogJyc7CiAgfQogIAogIEFXUy5FdmVudExpc3RlbmVycyA9IHsKICAgIENvcmU6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQsIGFkZEFzeW5jKSB7CiAgICAgIGFkZEFzeW5jKCdWQUxJREFURV9DUkVERU5USUFMUycsICd2YWxpZGF0ZScsCiAgICAgICAgICBmdW5jdGlvbiBWQUxJREFURV9DUkVERU5USUFMUyhyZXEsIGRvbmUpIHsKICAgICAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5zaWduYXR1cmVWZXJzaW9uICYmICFyZXEuc2VydmljZS5jb25maWcuc2lnbmF0dXJlVmVyc2lvbikgcmV0dXJuIGRvbmUoKTsgLy8gbm9uZQogICAgICAgIHJlcS5zZXJ2aWNlLmNvbmZpZy5nZXRDcmVkZW50aWFscyhmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgcmVxLnJlc3BvbnNlLmVycm9yID0gQVdTLnV0aWwuZXJyb3IoZXJyLAogICAgICAgICAgICAgIHtjb2RlOiAnQ3JlZGVudGlhbHNFcnJvcicsIG1lc3NhZ2U6ICdNaXNzaW5nIGNyZWRlbnRpYWxzIGluIGNvbmZpZyd9KTsKICAgICAgICAgIH0KICAgICAgICAgIGRvbmUoKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgCiAgICAgIGFkZCgnVkFMSURBVEVfUkVHSU9OJywgJ3ZhbGlkYXRlJywgZnVuY3Rpb24gVkFMSURBVEVfUkVHSU9OKHJlcSkgewogICAgICAgIGlmICghcmVxLnNlcnZpY2UuY29uZmlnLnJlZ2lvbiAmJiAhcmVxLnNlcnZpY2UuaXNHbG9iYWxFbmRwb2ludCkgewogICAgICAgICAgcmVxLnJlc3BvbnNlLmVycm9yID0gQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksCiAgICAgICAgICAgIHtjb2RlOiAnQ29uZmlnRXJyb3InLCBtZXNzYWdlOiAnTWlzc2luZyByZWdpb24gaW4gY29uZmlnJ30pOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnQlVJTERfSURFTVBPVEVOQ1lfVE9LRU5TJywgJ3ZhbGlkYXRlJywgZnVuY3Rpb24gQlVJTERfSURFTVBPVEVOQ1lfVE9LRU5TKHJlcSkgewogICAgICAgIGlmICghcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgICAgIGlmICghb3BlcmF0aW9uKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBpZGVtcG90ZW50TWVtYmVycyA9IG9wZXJhdGlvbi5pZGVtcG90ZW50TWVtYmVyczsKICAgICAgICBpZiAoIWlkZW1wb3RlbnRNZW1iZXJzLmxlbmd0aCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvLyBjcmVhdGVzIGEgY29weSBvZiBwYXJhbXMgc28gdXNlcidzIHBhcmFtIG9iamVjdCBpc24ndCBtdXRhdGVkCiAgICAgICAgdmFyIHBhcmFtcyA9IEFXUy51dGlsLmNvcHkocmVxLnBhcmFtcyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBpZGVtcG90ZW50TWVtYmVycy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgIGlmICghcGFyYW1zW2lkZW1wb3RlbnRNZW1iZXJzW2ldXSkgewogICAgICAgICAgICAvLyBhZGQgdGhlIG1lbWJlcgogICAgICAgICAgICBwYXJhbXNbaWRlbXBvdGVudE1lbWJlcnNbaV1dID0gQVdTLnV0aWwudXVpZC52NCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXEucGFyYW1zID0gcGFyYW1zOwogICAgICB9KTsKICAKICAgICAgYWRkKCdWQUxJREFURV9QQVJBTUVURVJTJywgJ3ZhbGlkYXRlJywgZnVuY3Rpb24gVkFMSURBVEVfUEFSQU1FVEVSUyhyZXEpIHsKICAgICAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBydWxlcyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmlucHV0OwogICAgICAgIHZhciB2YWxpZGF0aW9uID0gcmVxLnNlcnZpY2UuY29uZmlnLnBhcmFtVmFsaWRhdGlvbjsKICAgICAgICBuZXcgQVdTLlBhcmFtVmFsaWRhdG9yKHZhbGlkYXRpb24pLnZhbGlkYXRlKHJ1bGVzLCByZXEucGFyYW1zKTsKICAgICAgfSk7CiAgCiAgICAgIGFkZEFzeW5jKCdDT01QVVRFX1NIQTI1NicsICdhZnRlckJ1aWxkJywgZnVuY3Rpb24gQ09NUFVURV9TSEEyNTYocmVxLCBkb25lKSB7CiAgICAgICAgcmVxLmhhbHRIYW5kbGVyc09uRXJyb3IoKTsKICAgICAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgICAgICB2YXIgYXV0aHR5cGUgPSBvcGVyYXRpb24gPyBvcGVyYXRpb24uYXV0aHR5cGUgOiAnJzsKICAgICAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5zaWduYXR1cmVWZXJzaW9uICYmICFhdXRodHlwZSAmJiAhcmVxLnNlcnZpY2UuY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIHJldHVybiBkb25lKCk7IC8vIG5vbmUKICAgICAgICBpZiAocmVxLnNlcnZpY2UuZ2V0U2lnbmVyQ2xhc3MocmVxKSA9PT0gQVdTLlNpZ25lcnMuVjQpIHsKICAgICAgICAgIHZhciBib2R5ID0gcmVxLmh0dHBSZXF1ZXN0LmJvZHkgfHwgJyc7CiAgICAgICAgICBpZiAoYXV0aHR5cGUuaW5kZXhPZigndW5zaWduZWQtYm9keScpID49IDApIHsKICAgICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LUNvbnRlbnQtU2hhMjU2J10gPSAnVU5TSUdORUQtUEFZTE9BRCc7CiAgICAgICAgICAgIHJldHVybiBkb25lKCk7CiAgICAgICAgICB9CiAgICAgICAgICBBV1MudXRpbC5jb21wdXRlU2hhMjU2KGJvZHksIGZ1bmN0aW9uKGVyciwgc2hhKSB7CiAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICBkb25lKGVycik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LUNvbnRlbnQtU2hhMjU2J10gPSBzaGE7CiAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZG9uZSgpOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnU0VUX0NPTlRFTlRfTEVOR1RIJywgJ2FmdGVyQnVpbGQnLCBmdW5jdGlvbiBTRVRfQ09OVEVOVF9MRU5HVEgocmVxKSB7CiAgICAgICAgdmFyIGF1dGh0eXBlID0gZ2V0T3BlcmF0aW9uQXV0aHR5cGUocmVxKTsKICAgICAgICB2YXIgcGF5bG9hZE1lbWJlciA9IEFXUy51dGlsLmdldFJlcXVlc3RQYXlsb2FkU2hhcGUocmVxKTsKICAgICAgICBpZiAocmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtTGVuZ3RoJ10gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIGxlbmd0aCA9IEFXUy51dGlsLnN0cmluZy5ieXRlTGVuZ3RoKHJlcS5odHRwUmVxdWVzdC5ib2R5KTsKICAgICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtTGVuZ3RoJ10gPSBsZW5ndGg7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgaWYgKHBheWxvYWRNZW1iZXIgJiYgcGF5bG9hZE1lbWJlci5pc1N0cmVhbWluZykgewogICAgICAgICAgICAgIGlmIChwYXlsb2FkTWVtYmVyLnJlcXVpcmVzTGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAvL3N0cmVhbWluZyBwYXlsb2FkIHJlcXVpcmVzIGxlbmd0aChzMywgZ2xhY2llcikKICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGF1dGh0eXBlLmluZGV4T2YoJ3Vuc2lnbmVkLWJvZHknKSA+PSAwKSB7CiAgICAgICAgICAgICAgICAvL3VuYm91bmRlZCBzdHJlYW1pbmcgcGF5bG9hZChsZXgsIG1lZGlhc3RvcmUpCiAgICAgICAgICAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snVHJhbnNmZXItRW5jb2RpbmcnXSA9ICdjaHVua2VkJzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdTRVRfSFRUUF9IT1NUJywgJ2FmdGVyQnVpbGQnLCBmdW5jdGlvbiBTRVRfSFRUUF9IT1NUKHJlcSkgewogICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydIb3N0J10gPSByZXEuaHR0cFJlcXVlc3QuZW5kcG9pbnQuaG9zdDsKICAgICAgfSk7CiAgCiAgICAgIGFkZCgnUkVTVEFSVCcsICdyZXN0YXJ0JywgZnVuY3Rpb24gUkVTVEFSVCgpIHsKICAgICAgICB2YXIgZXJyID0gdGhpcy5yZXNwb25zZS5lcnJvcjsKICAgICAgICBpZiAoIWVyciB8fCAhZXJyLnJldHJ5YWJsZSkgcmV0dXJuOwogIAogICAgICAgIHRoaXMuaHR0cFJlcXVlc3QgPSBuZXcgQVdTLkh0dHBSZXF1ZXN0KAogICAgICAgICAgdGhpcy5zZXJ2aWNlLmVuZHBvaW50LAogICAgICAgICAgdGhpcy5zZXJ2aWNlLnJlZ2lvbgogICAgICAgICk7CiAgCiAgICAgICAgaWYgKHRoaXMucmVzcG9uc2UucmV0cnlDb3VudCA8IHRoaXMuc2VydmljZS5jb25maWcubWF4UmV0cmllcykgewogICAgICAgICAgdGhpcy5yZXNwb25zZS5yZXRyeUNvdW50Kys7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMucmVzcG9uc2UuZXJyb3IgPSBudWxsOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIHZhciBhZGRUb0hlYWQgPSB0cnVlOwogICAgICBhZGRBc3luYygnRElTQ09WRVJfRU5EUE9JTlQnLCAnc2lnbicsIERJU0NPVkVSX0VORFBPSU5ULCBhZGRUb0hlYWQpOwogIAogICAgICBhZGRBc3luYygnU0lHTicsICdzaWduJywgZnVuY3Rpb24gU0lHTihyZXEsIGRvbmUpIHsKICAgICAgICB2YXIgc2VydmljZSA9IHJlcS5zZXJ2aWNlOwogICAgICAgIHZhciBvcGVyYXRpb25zID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMgfHwge307CiAgICAgICAgdmFyIG9wZXJhdGlvbiA9IG9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICAgICAgdmFyIGF1dGh0eXBlID0gb3BlcmF0aW9uID8gb3BlcmF0aW9uLmF1dGh0eXBlIDogJyc7CiAgICAgICAgaWYgKCFzZXJ2aWNlLmFwaS5zaWduYXR1cmVWZXJzaW9uICYmICFhdXRodHlwZSAmJiAhc2VydmljZS5jb25maWcuc2lnbmF0dXJlVmVyc2lvbikgcmV0dXJuIGRvbmUoKTsgLy8gbm9uZQogIAogICAgICAgIHNlcnZpY2UuY29uZmlnLmdldENyZWRlbnRpYWxzKGZ1bmN0aW9uIChlcnIsIGNyZWRlbnRpYWxzKSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIHJlcS5yZXNwb25zZS5lcnJvciA9IGVycjsKICAgICAgICAgICAgcmV0dXJuIGRvbmUoKTsKICAgICAgICAgIH0KICAKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBkYXRlID0gc2VydmljZS5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpOwogICAgICAgICAgICB2YXIgU2lnbmVyQ2xhc3MgPSBzZXJ2aWNlLmdldFNpZ25lckNsYXNzKHJlcSk7CiAgICAgICAgICAgIHZhciBzaWduZXIgPSBuZXcgU2lnbmVyQ2xhc3MocmVxLmh0dHBSZXF1ZXN0LAogICAgICAgICAgICAgIHNlcnZpY2UuYXBpLnNpZ25pbmdOYW1lIHx8IHNlcnZpY2UuYXBpLmVuZHBvaW50UHJlZml4LAogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHNpZ25hdHVyZUNhY2hlOiBzZXJ2aWNlLmNvbmZpZy5zaWduYXR1cmVDYWNoZSwKICAgICAgICAgICAgICAgIG9wZXJhdGlvbjogb3BlcmF0aW9uLAogICAgICAgICAgICAgICAgc2lnbmF0dXJlVmVyc2lvbjogc2VydmljZS5hcGkuc2lnbmF0dXJlVmVyc2lvbgogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzaWduZXIuc2V0U2VydmljZUNsaWVudElkKHNlcnZpY2UuX2NsaWVudElkKTsKICAKICAgICAgICAgICAgLy8gY2xlYXIgb2xkIGF1dGhvcml6YXRpb24gaGVhZGVycwogICAgICAgICAgICBkZWxldGUgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXTsKICAgICAgICAgICAgZGVsZXRlIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydEYXRlJ107CiAgICAgICAgICAgIGRlbGV0ZSByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snWC1BbXotRGF0ZSddOwogIAogICAgICAgICAgICAvLyBhZGQgbmV3IGF1dGhvcml6YXRpb24KICAgICAgICAgICAgc2lnbmVyLmFkZEF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGUpOwogICAgICAgICAgICByZXEuc2lnbmVkQXQgPSBkYXRlOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXEucmVzcG9uc2UuZXJyb3IgPSBlOwogICAgICAgICAgfQogICAgICAgICAgZG9uZSgpOwogICAgICAgIH0pOwogICAgICB9KTsKICAKICAgICAgYWRkKCdWQUxJREFURV9SRVNQT05TRScsICd2YWxpZGF0ZVJlc3BvbnNlJywgZnVuY3Rpb24gVkFMSURBVEVfUkVTUE9OU0UocmVzcCkgewogICAgICAgIGlmICh0aGlzLnNlcnZpY2Uuc3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3AsIHRoaXMpKSB7CiAgICAgICAgICByZXNwLmRhdGEgPSB7fTsKICAgICAgICAgIHJlc3AuZXJyb3IgPSBudWxsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXNwLmRhdGEgPSBudWxsOwogICAgICAgICAgcmVzcC5lcnJvciA9IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAgICB7Y29kZTogJ1Vua25vd25FcnJvcicsIG1lc3NhZ2U6ICdBbiB1bmtub3duIGVycm9yIG9jY3VycmVkLid9KTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGRBc3luYygnU0VORCcsICdzZW5kJywgZnVuY3Rpb24gU0VORChyZXNwLCBkb25lKSB7CiAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UuX2Fib3J0Q2FsbGJhY2sgPSBkb25lOwogICAgICAgIHJlc3AuZXJyb3IgPSBudWxsOwogICAgICAgIHJlc3AuZGF0YSA9IG51bGw7CiAgCiAgICAgICAgZnVuY3Rpb24gY2FsbGJhY2soaHR0cFJlc3ApIHsKICAgICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLnN0cmVhbSA9IGh0dHBSZXNwOwogICAgICAgICAgdmFyIHN0cmVhbSA9IHJlc3AucmVxdWVzdC5odHRwUmVxdWVzdC5zdHJlYW07CiAgICAgICAgICB2YXIgc2VydmljZSA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlOwogICAgICAgICAgdmFyIGFwaSA9IHNlcnZpY2UuYXBpOwogICAgICAgICAgdmFyIG9wZXJhdGlvbk5hbWUgPSByZXNwLnJlcXVlc3Qub3BlcmF0aW9uOwogICAgICAgICAgdmFyIG9wZXJhdGlvbiA9IGFwaS5vcGVyYXRpb25zW29wZXJhdGlvbk5hbWVdIHx8IHt9OwogIAogICAgICAgICAgaHR0cFJlc3Aub24oJ2hlYWRlcnMnLCBmdW5jdGlvbiBvbkhlYWRlcnMoc3RhdHVzQ29kZSwgaGVhZGVycywgc3RhdHVzTWVzc2FnZSkgewogICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgKICAgICAgICAgICAgICAnaHR0cEhlYWRlcnMnLAogICAgICAgICAgICAgIFtzdGF0dXNDb2RlLCBoZWFkZXJzLCByZXNwLCBzdGF0dXNNZXNzYWdlXQogICAgICAgICAgICApOwogIAogICAgICAgICAgICBpZiAoIXJlc3AuaHR0cFJlc3BvbnNlLnN0cmVhbWluZykgewogICAgICAgICAgICAgIGlmIChBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMikgeyAvLyBzdHJlYW1zMiBBUEkgY2hlY2sKICAgICAgICAgICAgICAgIC8vIGlmIHdlIGRldGVjdCBldmVudCBzdHJlYW1zLCB3ZSdyZSBnb2luZyB0byBoYXZlIHRvCiAgICAgICAgICAgICAgICAvLyByZXR1cm4gdGhlIHN0cmVhbSBpbW1lZGlhdGVseQogICAgICAgICAgICAgICAgaWYgKG9wZXJhdGlvbi5oYXNFdmVudE91dHB1dCAmJiBzZXJ2aWNlLnN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwKSkgewogICAgICAgICAgICAgICAgICAvLyBza2lwIHJlYWRpbmcgdGhlIEluY29taW5nU3RyZWFtCiAgICAgICAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRG9uZScpOwogICAgICAgICAgICAgICAgICBkb25lKCk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAKICAgICAgICAgICAgICAgIGh0dHBSZXNwLm9uKCdyZWFkYWJsZScsIGZ1bmN0aW9uIG9uUmVhZGFibGUoKSB7CiAgICAgICAgICAgICAgICAgIHZhciBkYXRhID0gaHR0cFJlc3AucmVhZCgpOwogICAgICAgICAgICAgICAgICBpZiAoZGF0YSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRGF0YScsIFtkYXRhLCByZXNwXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7IC8vIGxlZ2FjeSBzdHJlYW1zIEFQSQogICAgICAgICAgICAgICAgaHR0cFJlc3Aub24oJ2RhdGEnLCBmdW5jdGlvbiBvbkRhdGEoZGF0YSkgewogICAgICAgICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERhdGEnLCBbZGF0YSwgcmVzcF0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAKICAgICAgICAgIGh0dHBSZXNwLm9uKCdlbmQnLCBmdW5jdGlvbiBvbkVuZCgpIHsKICAgICAgICAgICAgaWYgKCFzdHJlYW0gfHwgIXN0cmVhbS5kaWRDYWxsYmFjaykgewogICAgICAgICAgICAgIGlmIChBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMiAmJiAob3BlcmF0aW9uLmhhc0V2ZW50T3V0cHV0ICYmIHNlcnZpY2Uuc3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3ApKSkgewogICAgICAgICAgICAgICAgLy8gZG9uJ3QgY29uY2F0ZW5hdGUgcmVzcG9uc2UgY2h1bmtzIHdoZW4gc3RyZWFtaW5nIGV2ZW50IHN0cmVhbSBkYXRhIHdoZW4gcmVzcG9uc2UgaXMgc3VjY2Vzc2Z1bAogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERvbmUnKTsKICAgICAgICAgICAgICBkb25lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAKICAgICAgICBmdW5jdGlvbiBwcm9ncmVzcyhodHRwUmVzcCkgewogICAgICAgICAgaHR0cFJlc3Aub24oJ3NlbmRQcm9ncmVzcycsIGZ1bmN0aW9uIG9uU2VuZFByb2dyZXNzKHZhbHVlKSB7CiAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwVXBsb2FkUHJvZ3Jlc3MnLCBbdmFsdWUsIHJlc3BdKTsKICAgICAgICAgIH0pOwogIAogICAgICAgICAgaHR0cFJlc3Aub24oJ3JlY2VpdmVQcm9ncmVzcycsIGZ1bmN0aW9uIG9uUmVjZWl2ZVByb2dyZXNzKHZhbHVlKSB7CiAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRG93bmxvYWRQcm9ncmVzcycsIFt2YWx1ZSwgcmVzcF0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogIAogICAgICAgIGZ1bmN0aW9uIGVycm9yKGVycikgewogICAgICAgICAgaWYgKGVyci5jb2RlICE9PSAnUmVxdWVzdEFib3J0ZWRFcnJvcicpIHsKICAgICAgICAgICAgdmFyIGVyckNvZGUgPSBlcnIuY29kZSA9PT0gJ1RpbWVvdXRFcnJvcicgPyBlcnIuY29kZSA6ICdOZXR3b3JraW5nRXJyb3InOwogICAgICAgICAgICBlcnIgPSBBV1MudXRpbC5lcnJvcihlcnIsIHsKICAgICAgICAgICAgICBjb2RlOiBlcnJDb2RlLAogICAgICAgICAgICAgIHJlZ2lvbjogcmVzcC5yZXF1ZXN0Lmh0dHBSZXF1ZXN0LnJlZ2lvbiwKICAgICAgICAgICAgICBob3N0bmFtZTogcmVzcC5yZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50Lmhvc3RuYW1lLAogICAgICAgICAgICAgIHJldHJ5YWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3AuZXJyb3IgPSBlcnI7CiAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cEVycm9yJywgW3Jlc3AuZXJyb3IsIHJlc3BdLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogIAogICAgICAgIGZ1bmN0aW9uIGV4ZWN1dGVTZW5kKCkgewogICAgICAgICAgdmFyIGh0dHAgPSBBV1MuSHR0cENsaWVudC5nZXRJbnN0YW5jZSgpOwogICAgICAgICAgdmFyIGh0dHBPcHRpb25zID0gcmVzcC5yZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmh0dHBPcHRpb25zIHx8IHt9OwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIHN0cmVhbSA9IGh0dHAuaGFuZGxlUmVxdWVzdChyZXNwLnJlcXVlc3QuaHR0cFJlcXVlc3QsIGh0dHBPcHRpb25zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLCBlcnJvcik7CiAgICAgICAgICAgIHByb2dyZXNzKHN0cmVhbSk7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgZXJyb3IoZXJyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHRpbWVEaWZmID0gKHJlc3AucmVxdWVzdC5zZXJ2aWNlLmdldFNrZXdDb3JyZWN0ZWREYXRlKCkgLSB0aGlzLnNpZ25lZEF0KSAvIDEwMDA7CiAgICAgICAgaWYgKHRpbWVEaWZmID49IDYwICogMTApIHsgLy8gaWYgd2Ugc2lnbmVkIDEwbWluIGFnbywgcmUtc2lnbgogICAgICAgICAgdGhpcy5lbWl0KCdzaWduJywgW3RoaXNdLCBmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgaWYgKGVycikgZG9uZShlcnIpOwogICAgICAgICAgICBlbHNlIGV4ZWN1dGVTZW5kKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZXhlY3V0ZVNlbmQoKTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0hUVFBfSEVBREVSUycsICdodHRwSGVhZGVycycsCiAgICAgICAgICBmdW5jdGlvbiBIVFRQX0hFQURFUlMoc3RhdHVzQ29kZSwgaGVhZGVycywgcmVzcCwgc3RhdHVzTWVzc2FnZSkgewogICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUgPSBzdGF0dXNDb2RlOwogICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c01lc3NhZ2UgPSBzdGF0dXNNZXNzYWdlOwogICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnMgPSBoZWFkZXJzOwogICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkgPSBBV1MudXRpbC5idWZmZXIudG9CdWZmZXIoJycpOwogICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLmJ1ZmZlcnMgPSBbXTsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5udW1CeXRlcyA9IDA7CiAgICAgICAgdmFyIGRhdGVIZWFkZXIgPSBoZWFkZXJzLmRhdGUgfHwgaGVhZGVycy5EYXRlOwogICAgICAgIHZhciBzZXJ2aWNlID0gcmVzcC5yZXF1ZXN0LnNlcnZpY2U7CiAgICAgICAgaWYgKGRhdGVIZWFkZXIpIHsKICAgICAgICAgIHZhciBzZXJ2ZXJUaW1lID0gRGF0ZS5wYXJzZShkYXRlSGVhZGVyKTsKICAgICAgICAgIGlmIChzZXJ2aWNlLmNvbmZpZy5jb3JyZWN0Q2xvY2tTa2V3CiAgICAgICAgICAgICAgJiYgc2VydmljZS5pc0Nsb2NrU2tld2VkKHNlcnZlclRpbWUpKSB7CiAgICAgICAgICAgIHNlcnZpY2UuYXBwbHlDbG9ja09mZnNldChzZXJ2ZXJUaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0hUVFBfREFUQScsICdodHRwRGF0YScsIGZ1bmN0aW9uIEhUVFBfREFUQShjaHVuaywgcmVzcCkgewogICAgICAgIGlmIChjaHVuaykgewogICAgICAgICAgaWYgKEFXUy51dGlsLmlzTm9kZSgpKSB7CiAgICAgICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLm51bUJ5dGVzICs9IGNodW5rLmxlbmd0aDsKICAKICAgICAgICAgICAgdmFyIHRvdGFsID0gcmVzcC5odHRwUmVzcG9uc2UuaGVhZGVyc1snY29udGVudC1sZW5ndGgnXTsKICAgICAgICAgICAgdmFyIHByb2dyZXNzID0geyBsb2FkZWQ6IHJlc3AuaHR0cFJlc3BvbnNlLm51bUJ5dGVzLCB0b3RhbDogdG90YWwgfTsKICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEb3dubG9hZFByb2dyZXNzJywgW3Byb2dyZXNzLCByZXNwXSk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzLnB1c2goQVdTLnV0aWwuYnVmZmVyLnRvQnVmZmVyKGNodW5rKSk7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdIVFRQX0RPTkUnLCAnaHR0cERvbmUnLCBmdW5jdGlvbiBIVFRQX0RPTkUocmVzcCkgewogICAgICAgIC8vIGNvbnZlcnQgYnVmZmVycyBhcnJheSBpbnRvIHNpbmdsZSBidWZmZXIKICAgICAgICBpZiAocmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycyAmJiByZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHZhciBib2R5ID0gQVdTLnV0aWwuYnVmZmVyLmNvbmNhdChyZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzKTsKICAgICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkgPSBib2R5OwogICAgICAgIH0KICAgICAgICBkZWxldGUgcmVzcC5odHRwUmVzcG9uc2UubnVtQnl0ZXM7CiAgICAgICAgZGVsZXRlIHJlc3AuaHR0cFJlc3BvbnNlLmJ1ZmZlcnM7CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0ZJTkFMSVpFX0VSUk9SJywgJ3JldHJ5JywgZnVuY3Rpb24gRklOQUxJWkVfRVJST1IocmVzcCkgewogICAgICAgIGlmIChyZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlKSB7CiAgICAgICAgICByZXNwLmVycm9yLnN0YXR1c0NvZGUgPSByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICAgICAgaWYgKHJlc3AuZXJyb3IucmV0cnlhYmxlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmVzcC5lcnJvci5yZXRyeWFibGUgPSB0aGlzLnNlcnZpY2UucmV0cnlhYmxlRXJyb3IocmVzcC5lcnJvciwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdJTlZBTElEQVRFX0NSRURFTlRJQUxTJywgJ3JldHJ5JywgZnVuY3Rpb24gSU5WQUxJREFURV9DUkVERU5USUFMUyhyZXNwKSB7CiAgICAgICAgaWYgKCFyZXNwLmVycm9yKSByZXR1cm47CiAgICAgICAgc3dpdGNoIChyZXNwLmVycm9yLmNvZGUpIHsKICAgICAgICAgIGNhc2UgJ1JlcXVlc3RFeHBpcmVkJzogLy8gRUMyIG9ubHkKICAgICAgICAgIGNhc2UgJ0V4cGlyZWRUb2tlbkV4Y2VwdGlvbic6CiAgICAgICAgICBjYXNlICdFeHBpcmVkVG9rZW4nOgogICAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgICAgICAgIHJlc3AucmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscy5leHBpcmVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0VYUElSRURfU0lHTkFUVVJFJywgJ3JldHJ5JywgZnVuY3Rpb24gRVhQSVJFRF9TSUdOQVRVUkUocmVzcCkgewogICAgICAgIHZhciBlcnIgPSByZXNwLmVycm9yOwogICAgICAgIGlmICghZXJyKSByZXR1cm47CiAgICAgICAgaWYgKHR5cGVvZiBlcnIuY29kZSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIGVyci5tZXNzYWdlID09PSAnc3RyaW5nJykgewogICAgICAgICAgaWYgKGVyci5jb2RlLm1hdGNoKC9TaWduYXR1cmUvKSAmJiBlcnIubWVzc2FnZS5tYXRjaCgvZXhwaXJlZC8pKSB7CiAgICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0NMT0NLX1NLRVdFRCcsICdyZXRyeScsIGZ1bmN0aW9uIENMT0NLX1NLRVdFRChyZXNwKSB7CiAgICAgICAgaWYgKCFyZXNwLmVycm9yKSByZXR1cm47CiAgICAgICAgaWYgKHRoaXMuc2VydmljZS5jbG9ja1NrZXdFcnJvcihyZXNwLmVycm9yKQogICAgICAgICAgICAmJiB0aGlzLnNlcnZpY2UuY29uZmlnLmNvcnJlY3RDbG9ja1NrZXcpIHsKICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1JFRElSRUNUJywgJ3JldHJ5JywgZnVuY3Rpb24gUkVESVJFQ1QocmVzcCkgewogICAgICAgIGlmIChyZXNwLmVycm9yICYmIHJlc3AuZXJyb3Iuc3RhdHVzQ29kZSA+PSAzMDAgJiYKICAgICAgICAgICAgcmVzcC5lcnJvci5zdGF0dXNDb2RlIDwgNDAwICYmIHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ2xvY2F0aW9uJ10pIHsKICAgICAgICAgIHRoaXMuaHR0cFJlcXVlc3QuZW5kcG9pbnQgPQogICAgICAgICAgICBuZXcgQVdTLkVuZHBvaW50KHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ2xvY2F0aW9uJ10pOwogICAgICAgICAgdGhpcy5odHRwUmVxdWVzdC5oZWFkZXJzWydIb3N0J10gPSB0aGlzLmh0dHBSZXF1ZXN0LmVuZHBvaW50Lmhvc3Q7CiAgICAgICAgICByZXNwLmVycm9yLnJlZGlyZWN0ID0gdHJ1ZTsKICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1JFVFJZX0NIRUNLJywgJ3JldHJ5JywgZnVuY3Rpb24gUkVUUllfQ0hFQ0socmVzcCkgewogICAgICAgIGlmIChyZXNwLmVycm9yKSB7CiAgICAgICAgICBpZiAocmVzcC5lcnJvci5yZWRpcmVjdCAmJiByZXNwLnJlZGlyZWN0Q291bnQgPCByZXNwLm1heFJlZGlyZWN0cykgewogICAgICAgICAgICByZXNwLmVycm9yLnJldHJ5RGVsYXkgPSAwOwogICAgICAgICAgfSBlbHNlIGlmIChyZXNwLnJldHJ5Q291bnQgPCByZXNwLm1heFJldHJpZXMpIHsKICAgICAgICAgICAgcmVzcC5lcnJvci5yZXRyeURlbGF5ID0gdGhpcy5zZXJ2aWNlLnJldHJ5RGVsYXlzKHJlc3AucmV0cnlDb3VudCkgfHwgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGRBc3luYygnUkVTRVRfUkVUUllfU1RBVEUnLCAnYWZ0ZXJSZXRyeScsIGZ1bmN0aW9uIFJFU0VUX1JFVFJZX1NUQVRFKHJlc3AsIGRvbmUpIHsKICAgICAgICB2YXIgZGVsYXksIHdpbGxSZXRyeSA9IGZhbHNlOwogIAogICAgICAgIGlmIChyZXNwLmVycm9yKSB7CiAgICAgICAgICBkZWxheSA9IHJlc3AuZXJyb3IucmV0cnlEZWxheSB8fCAwOwogICAgICAgICAgaWYgKHJlc3AuZXJyb3IucmV0cnlhYmxlICYmIHJlc3AucmV0cnlDb3VudCA8IHJlc3AubWF4UmV0cmllcykgewogICAgICAgICAgICByZXNwLnJldHJ5Q291bnQrKzsKICAgICAgICAgICAgd2lsbFJldHJ5ID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAocmVzcC5lcnJvci5yZWRpcmVjdCAmJiByZXNwLnJlZGlyZWN0Q291bnQgPCByZXNwLm1heFJlZGlyZWN0cykgewogICAgICAgICAgICByZXNwLnJlZGlyZWN0Q291bnQrKzsKICAgICAgICAgICAgd2lsbFJldHJ5ID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgCiAgICAgICAgaWYgKHdpbGxSZXRyeSkgewogICAgICAgICAgcmVzcC5lcnJvciA9IG51bGw7CiAgICAgICAgICBzZXRUaW1lb3V0KGRvbmUsIGRlbGF5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZG9uZSgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KSwKICAKICAgIENvcmVQb3N0OiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICAgIGFkZCgnRVhUUkFDVF9SRVFVRVNUX0lEJywgJ2V4dHJhY3REYXRhJywgQVdTLnV0aWwuZXh0cmFjdFJlcXVlc3RJZCk7CiAgICAgIGFkZCgnRVhUUkFDVF9SRVFVRVNUX0lEJywgJ2V4dHJhY3RFcnJvcicsIEFXUy51dGlsLmV4dHJhY3RSZXF1ZXN0SWQpOwogIAogICAgICBhZGQoJ0VOT1RGT1VORF9FUlJPUicsICdodHRwRXJyb3InLCBmdW5jdGlvbiBFTk9URk9VTkRfRVJST1IoZXJyKSB7CiAgICAgICAgaWYgKGVyci5jb2RlID09PSAnTmV0d29ya2luZ0Vycm9yJyAmJiBlcnIuZXJybm8gPT09ICdFTk9URk9VTkQnKSB7CiAgICAgICAgICB2YXIgbWVzc2FnZSA9ICdJbmFjY2Vzc2libGUgaG9zdDogYCcgKyBlcnIuaG9zdG5hbWUgKwogICAgICAgICAgICAnXCcuIFRoaXMgc2VydmljZSBtYXkgbm90IGJlIGF2YWlsYWJsZSBpbiB0aGUgYCcgKyBlcnIucmVnaW9uICsKICAgICAgICAgICAgJ1wnIHJlZ2lvbi4nOwogICAgICAgICAgdGhpcy5yZXNwb25zZS5lcnJvciA9IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcihtZXNzYWdlKSwgewogICAgICAgICAgICBjb2RlOiAnVW5rbm93bkVuZHBvaW50JywKICAgICAgICAgICAgcmVnaW9uOiBlcnIucmVnaW9uLAogICAgICAgICAgICBob3N0bmFtZTogZXJyLmhvc3RuYW1lLAogICAgICAgICAgICByZXRyeWFibGU6IHRydWUsCiAgICAgICAgICAgIG9yaWdpbmFsRXJyb3I6IGVycgogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pLAogIAogICAgTG9nZ2VyOiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICAgIGFkZCgnTE9HX1JFUVVFU1QnLCAnY29tcGxldGUnLCBmdW5jdGlvbiBMT0dfUkVRVUVTVChyZXNwKSB7CiAgICAgICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgICAgICB2YXIgbG9nZ2VyID0gcmVxLnNlcnZpY2UuY29uZmlnLmxvZ2dlcjsKICAgICAgICBpZiAoIWxvZ2dlcikgcmV0dXJuOwogICAgICAgIGZ1bmN0aW9uIGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLCBzaGFwZSkgewogICAgICAgICAgaWYgKCFzaGFwZSkgewogICAgICAgICAgICByZXR1cm4gc2hhcGU7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKGlucHV0U2hhcGUudHlwZSkgewogICAgICAgICAgICBjYXNlICdzdHJ1Y3R1cmUnOgogICAgICAgICAgICAgIHZhciBzdHJ1Y3QgPSB7fTsKICAgICAgICAgICAgICBBV1MudXRpbC5lYWNoKHNoYXBlLCBmdW5jdGlvbihzdWJTaGFwZU5hbWUsIHN1YlNoYXBlKSB7CiAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGlucHV0U2hhcGUubWVtYmVycywgc3ViU2hhcGVOYW1lKSkgewogICAgICAgICAgICAgICAgICBzdHJ1Y3Rbc3ViU2hhcGVOYW1lXSA9IGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLm1lbWJlcnNbc3ViU2hhcGVOYW1lXSwgc3ViU2hhcGUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgc3RydWN0W3N1YlNoYXBlTmFtZV0gPSBzdWJTaGFwZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXR1cm4gc3RydWN0OwogICAgICAgICAgICBjYXNlICdsaXN0JzoKICAgICAgICAgICAgICB2YXIgbGlzdCA9IFtdOwogICAgICAgICAgICAgIEFXUy51dGlsLmFycmF5RWFjaChzaGFwZSwgZnVuY3Rpb24oc3ViU2hhcGUsIGluZGV4KSB7CiAgICAgICAgICAgICAgICBsaXN0LnB1c2goZmlsdGVyU2Vuc2l0aXZlTG9nKGlucHV0U2hhcGUubWVtYmVyLCBzdWJTaGFwZSkpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybiBsaXN0OwogICAgICAgICAgICBjYXNlICdtYXAnOgogICAgICAgICAgICAgIHZhciBtYXAgPSB7fTsKICAgICAgICAgICAgICBBV1MudXRpbC5lYWNoKHNoYXBlLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICAgICBtYXBba2V5XSA9IGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLnZhbHVlLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBpZiAoaW5wdXRTaGFwZS5pc1NlbnNpdGl2ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICcqKipTZW5zaXRpdmVJbmZvcm1hdGlvbioqKic7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBzaGFwZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogIAogICAgICAgIGZ1bmN0aW9uIGJ1aWxkTWVzc2FnZSgpIHsKICAgICAgICAgIHZhciB0aW1lID0gcmVzcC5yZXF1ZXN0LnNlcnZpY2UuZ2V0U2tld0NvcnJlY3RlZERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgICB2YXIgZGVsdGEgPSAodGltZSAtIHJlcS5zdGFydFRpbWUuZ2V0VGltZSgpKSAvIDEwMDA7CiAgICAgICAgICB2YXIgYW5zaSA9IGxvZ2dlci5pc1RUWSA/IHRydWUgOiBmYWxzZTsKICAgICAgICAgIHZhciBzdGF0dXMgPSByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICAgICAgdmFyIGNlbnNvcmVkUGFyYW1zID0gcmVxLnBhcmFtczsKICAgICAgICAgIGlmICgKICAgICAgICAgICAgcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMgJiYKICAgICAgICAgICAgICAgIHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dICYmCiAgICAgICAgICAgICAgICByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dAogICAgICAgICAgKSB7CiAgICAgICAgICAgIHZhciBpbnB1dFNoYXBlID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQ7CiAgICAgICAgICAgIGNlbnNvcmVkUGFyYW1zID0gZmlsdGVyU2Vuc2l0aXZlTG9nKGlucHV0U2hhcGUsIHJlcS5wYXJhbXMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBhcmFtcyA9IHJlcXVpcmUoJ3V0aWwnKS5pbnNwZWN0KGNlbnNvcmVkUGFyYW1zLCB0cnVlLCBudWxsKTsKICAgICAgICAgIHZhciBtZXNzYWdlID0gJyc7CiAgICAgICAgICBpZiAoYW5zaSkgbWVzc2FnZSArPSAnXHgxQlszM20nOwogICAgICAgICAgbWVzc2FnZSArPSAnW0FXUyAnICsgcmVxLnNlcnZpY2Uuc2VydmljZUlkZW50aWZpZXIgKyAnICcgKyBzdGF0dXM7CiAgICAgICAgICBtZXNzYWdlICs9ICcgJyArIGRlbHRhLnRvU3RyaW5nKCkgKyAncyAnICsgcmVzcC5yZXRyeUNvdW50ICsgJyByZXRyaWVzXSc7CiAgICAgICAgICBpZiAoYW5zaSkgbWVzc2FnZSArPSAnXHgxQlswOzFtJzsKICAgICAgICAgIG1lc3NhZ2UgKz0gJyAnICsgQVdTLnV0aWwuc3RyaW5nLmxvd2VyRmlyc3QocmVxLm9wZXJhdGlvbik7CiAgICAgICAgICBtZXNzYWdlICs9ICcoJyArIHBhcmFtcyArICcpJzsKICAgICAgICAgIGlmIChhbnNpKSBtZXNzYWdlICs9ICdceDFCWzBtJzsKICAgICAgICAgIHJldHVybiBtZXNzYWdlOwogICAgICAgIH0KICAKICAgICAgICB2YXIgbGluZSA9IGJ1aWxkTWVzc2FnZSgpOwogICAgICAgIGlmICh0eXBlb2YgbG9nZ2VyLmxvZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgbG9nZ2VyLmxvZyhsaW5lKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBsb2dnZXIud3JpdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGxvZ2dlci53cml0ZShsaW5lICsgJ1xuJyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pLAogIAogICAgSnNvbjogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICB2YXIgc3ZjID0gcmVxdWlyZSgnLi9wcm90b2NvbC9qc29uJyk7CiAgICAgIGFkZCgnQlVJTEQnLCAnYnVpbGQnLCBzdmMuYnVpbGRSZXF1ZXN0KTsKICAgICAgYWRkKCdFWFRSQUNUX0RBVEEnLCAnZXh0cmFjdERhdGEnLCBzdmMuZXh0cmFjdERhdGEpOwogICAgICBhZGQoJ0VYVFJBQ1RfRVJST1InLCAnZXh0cmFjdEVycm9yJywgc3ZjLmV4dHJhY3RFcnJvcik7CiAgICB9KSwKICAKICAgIFJlc3Q6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdCcpOwogICAgICBhZGQoJ0JVSUxEJywgJ2J1aWxkJywgc3ZjLmJ1aWxkUmVxdWVzdCk7CiAgICAgIGFkZCgnRVhUUkFDVF9EQVRBJywgJ2V4dHJhY3REYXRhJywgc3ZjLmV4dHJhY3REYXRhKTsKICAgICAgYWRkKCdFWFRSQUNUX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIHN2Yy5leHRyYWN0RXJyb3IpOwogICAgfSksCiAgCiAgICBSZXN0SnNvbjogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICB2YXIgc3ZjID0gcmVxdWlyZSgnLi9wcm90b2NvbC9yZXN0X2pzb24nKTsKICAgICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICAgIH0pLAogIAogICAgUmVzdFhtbDogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICB2YXIgc3ZjID0gcmVxdWlyZSgnLi9wcm90b2NvbC9yZXN0X3htbCcpOwogICAgICBhZGQoJ0JVSUxEJywgJ2J1aWxkJywgc3ZjLmJ1aWxkUmVxdWVzdCk7CiAgICAgIGFkZCgnRVhUUkFDVF9EQVRBJywgJ2V4dHJhY3REYXRhJywgc3ZjLmV4dHJhY3REYXRhKTsKICAgICAgYWRkKCdFWFRSQUNUX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIHN2Yy5leHRyYWN0RXJyb3IpOwogICAgfSksCiAgCiAgICBRdWVyeTogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICB2YXIgc3ZjID0gcmVxdWlyZSgnLi9wcm90b2NvbC9xdWVyeScpOwogICAgICBhZGQoJ0JVSUxEJywgJ2J1aWxkJywgc3ZjLmJ1aWxkUmVxdWVzdCk7CiAgICAgIGFkZCgnRVhUUkFDVF9EQVRBJywgJ2V4dHJhY3REYXRhJywgc3ZjLmV4dHJhY3REYXRhKTsKICAgICAgYWRkKCdFWFRSQUNUX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIHN2Yy5leHRyYWN0RXJyb3IpOwogICAgfSkKICB9OwogIAogIH0seyIuL2NvcmUiOjE4LCIuL2Rpc2NvdmVyX2VuZHBvaW50IjoyNiwiLi9wcm90b2NvbC9qc29uIjo0NiwiLi9wcm90b2NvbC9xdWVyeSI6NDcsIi4vcHJvdG9jb2wvcmVzdCI6NDgsIi4vcHJvdG9jb2wvcmVzdF9qc29uIjo0OSwiLi9wcm90b2NvbC9yZXN0X3htbCI6NTAsIi4vc2VxdWVudGlhbF9leGVjdXRvciI6NTgsInV0aWwiOjk3fV0sMzQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgLyoqCiAgICogVGhlIGVuZHBvaW50IHRoYXQgYSBzZXJ2aWNlIHdpbGwgdGFsayB0bywgZm9yIGV4YW1wbGUsCiAgICogYCdodHRwczovL2VjMi5hcC1zb3V0aGVhc3QtMS5hbWF6b25hd3MuY29tJ2AuIElmCiAgICogeW91IG5lZWQgdG8gb3ZlcnJpZGUgYW4gZW5kcG9pbnQgZm9yIGEgc2VydmljZSwgeW91IGNhbgogICAqIHNldCB0aGUgZW5kcG9pbnQgb24gYSBzZXJ2aWNlIGJ5IHBhc3NpbmcgdGhlIGVuZHBvaW50CiAgICogb2JqZWN0IHdpdGggdGhlIGBlbmRwb2ludGAgb3B0aW9uIGtleToKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiB2YXIgZXAgPSBuZXcgQVdTLkVuZHBvaW50KCdhd3Nwcm94eS5leGFtcGxlLmNvbScpOwogICAqIHZhciBzMyA9IG5ldyBBV1MuUzMoe2VuZHBvaW50OiBlcH0pOwogICAqIHMzLnNlcnZpY2UuZW5kcG9pbnQuaG9zdG5hbWUgPT0gJ2F3c3Byb3h5LmV4YW1wbGUuY29tJwogICAqIGBgYAogICAqCiAgICogTm90ZSB0aGF0IGlmIHlvdSBkbyBub3Qgc3BlY2lmeSBhIHByb3RvY29sLCB0aGUgcHJvdG9jb2wgd2lsbAogICAqIGJlIHNlbGVjdGVkIGJhc2VkIG9uIHlvdXIgY3VycmVudCB7QVdTLmNvbmZpZ30gY29uZmlndXJhdGlvbi4KICAgKgogICAqIEAhYXR0cmlidXRlIHByb3RvY29sCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBwcm90b2NvbCAoaHR0cCBvciBodHRwcykgb2YgdGhlIGVuZHBvaW50CiAgICogICAgIFVSTAogICAqIEAhYXR0cmlidXRlIGhvc3RuYW1lCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBob3N0IHBvcnRpb24gb2YgdGhlIGVuZHBvaW50LCBlLmcuLAogICAqICAgICBleGFtcGxlLmNvbQogICAqIEAhYXR0cmlidXRlIGhvc3QKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIGhvc3QgcG9ydGlvbiBvZiB0aGUgZW5kcG9pbnQgaW5jbHVkaW5nCiAgICogICAgIHRoZSBwb3J0LCBlLmcuLCBleGFtcGxlLmNvbTo4MAogICAqIEAhYXR0cmlidXRlIHBvcnQKICAgKiAgIEByZXR1cm4gW0ludGVnZXJdIHRoZSBwb3J0IG9mIHRoZSBlbmRwb2ludAogICAqIEAhYXR0cmlidXRlIGhyZWYKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIGZ1bGwgVVJMIG9mIHRoZSBlbmRwb2ludAogICAqLwogIEFXUy5FbmRwb2ludCA9IGluaGVyaXQoewogIAogICAgLyoqCiAgICAgKiBAb3ZlcmxvYWQgRW5kcG9pbnQoZW5kcG9pbnQpCiAgICAgKiAgIENvbnN0cnVjdHMgYSBuZXcgZW5kcG9pbnQgZ2l2ZW4gYW4gZW5kcG9pbnQgVVJMLiBJZiB0aGUKICAgICAqICAgVVJMIG9taXRzIGEgcHJvdG9jb2wgKGh0dHAgb3IgaHR0cHMpLCB0aGUgZGVmYXVsdCBwcm90b2NvbAogICAgICogICBzZXQgaW4gdGhlIGdsb2JhbCB7QVdTLmNvbmZpZ30gd2lsbCBiZSB1c2VkLgogICAgICogICBAcGFyYW0gZW5kcG9pbnQgW1N0cmluZ10gdGhlIFVSTCB0byBjb25zdHJ1Y3QgYW4gZW5kcG9pbnQgZnJvbQogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gRW5kcG9pbnQoZW5kcG9pbnQsIGNvbmZpZykgewogICAgICBBV1MudXRpbC5oaWRlUHJvcGVydGllcyh0aGlzLCBbJ3NsYXNoZXMnLCAnYXV0aCcsICdoYXNoJywgJ3NlYXJjaCcsICdxdWVyeSddKTsKICAKICAgICAgaWYgKHR5cGVvZiBlbmRwb2ludCA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5kcG9pbnQgPT09IG51bGwpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgZW5kcG9pbnQ6ICcgKyBlbmRwb2ludCk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGVuZHBvaW50ICE9PSAnc3RyaW5nJykgewogICAgICAgIHJldHVybiBBV1MudXRpbC5jb3B5KGVuZHBvaW50KTsKICAgICAgfQogIAogICAgICBpZiAoIWVuZHBvaW50Lm1hdGNoKC9eaHR0cC8pKSB7CiAgICAgICAgdmFyIHVzZVNTTCA9IGNvbmZpZyAmJiBjb25maWcuc3NsRW5hYmxlZCAhPT0gdW5kZWZpbmVkID8KICAgICAgICAgIGNvbmZpZy5zc2xFbmFibGVkIDogQVdTLmNvbmZpZy5zc2xFbmFibGVkOwogICAgICAgIGVuZHBvaW50ID0gKHVzZVNTTCA/ICdodHRwcycgOiAnaHR0cCcpICsgJzovLycgKyBlbmRwb2ludDsKICAgICAgfQogIAogICAgICBBV1MudXRpbC51cGRhdGUodGhpcywgQVdTLnV0aWwudXJsUGFyc2UoZW5kcG9pbnQpKTsKICAKICAgICAgLy8gRW5zdXJlIHRoZSBwb3J0IHByb3BlcnR5IGlzIHNldCBhcyBhbiBpbnRlZ2VyCiAgICAgIGlmICh0aGlzLnBvcnQpIHsKICAgICAgICB0aGlzLnBvcnQgPSBwYXJzZUludCh0aGlzLnBvcnQsIDEwKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnBvcnQgPSB0aGlzLnByb3RvY29sID09PSAnaHR0cHM6JyA/IDQ0MyA6IDgwOwogICAgICB9CiAgICB9CiAgCiAgfSk7CiAgCiAgLyoqCiAgICogVGhlIGxvdyBsZXZlbCBIVFRQIHJlcXVlc3Qgb2JqZWN0LCBlbmNhcHN1bGF0aW5nIGFsbCBIVFRQIGhlYWRlcgogICAqIGFuZCBib2R5IGRhdGEgc2VudCBieSBhIHNlcnZpY2UgcmVxdWVzdC4KICAgKgogICAqIEAhYXR0cmlidXRlIG1ldGhvZAogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgSFRUUCBtZXRob2Qgb2YgdGhlIHJlcXVlc3QKICAgKiBAIWF0dHJpYnV0ZSBwYXRoCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBwYXRoIHBvcnRpb24gb2YgdGhlIFVSSSwgZS5nLiwKICAgKiAgICAgIi9saXN0Lz9zdGFydD01Jm51bT0xMCIKICAgKiBAIWF0dHJpYnV0ZSBoZWFkZXJzCiAgICogICBAcmV0dXJuIFttYXA8U3RyaW5nLFN0cmluZz5dCiAgICogICAgIGEgbWFwIG9mIGhlYWRlciBrZXlzIGFuZCB0aGVpciByZXNwZWN0aXZlIHZhbHVlcwogICAqIEAhYXR0cmlidXRlIGJvZHkKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIHJlcXVlc3QgYm9keSBwYXlsb2FkCiAgICogQCFhdHRyaWJ1dGUgZW5kcG9pbnQKICAgKiAgIEByZXR1cm4gW0FXUy5FbmRwb2ludF0gdGhlIGVuZHBvaW50IGZvciB0aGUgcmVxdWVzdAogICAqIEAhYXR0cmlidXRlIHJlZ2lvbgogICAqICAgQGFwaSBwcml2YXRlCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSByZWdpb24sIGZvciBzaWduaW5nIHB1cnBvc2VzIG9ubHkuCiAgICovCiAgQVdTLkh0dHBSZXF1ZXN0ID0gaW5oZXJpdCh7CiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gSHR0cFJlcXVlc3QoZW5kcG9pbnQsIHJlZ2lvbikgewogICAgICBlbmRwb2ludCA9IG5ldyBBV1MuRW5kcG9pbnQoZW5kcG9pbnQpOwogICAgICB0aGlzLm1ldGhvZCA9ICdQT1NUJzsKICAgICAgdGhpcy5wYXRoID0gZW5kcG9pbnQucGF0aCB8fCAnLyc7CiAgICAgIHRoaXMuaGVhZGVycyA9IHt9OwogICAgICB0aGlzLmJvZHkgPSAnJzsKICAgICAgdGhpcy5lbmRwb2ludCA9IGVuZHBvaW50OwogICAgICB0aGlzLnJlZ2lvbiA9IHJlZ2lvbjsKICAgICAgdGhpcy5fdXNlckFnZW50ID0gJyc7CiAgICAgIHRoaXMuc2V0VXNlckFnZW50KCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc2V0VXNlckFnZW50OiBmdW5jdGlvbiBzZXRVc2VyQWdlbnQoKSB7CiAgICAgIHRoaXMuX3VzZXJBZ2VudCA9IHRoaXMuaGVhZGVyc1t0aGlzLmdldFVzZXJBZ2VudEhlYWRlck5hbWUoKV0gPSBBV1MudXRpbC51c2VyQWdlbnQoKTsKICAgIH0sCiAgCiAgICBnZXRVc2VyQWdlbnRIZWFkZXJOYW1lOiBmdW5jdGlvbiBnZXRVc2VyQWdlbnRIZWFkZXJOYW1lKCkgewogICAgICB2YXIgcHJlZml4ID0gQVdTLnV0aWwuaXNCcm93c2VyKCkgPyAnWC1BbXotJyA6ICcnOwogICAgICByZXR1cm4gcHJlZml4ICsgJ1VzZXItQWdlbnQnOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwcGVuZFRvVXNlckFnZW50OiBmdW5jdGlvbiBhcHBlbmRUb1VzZXJBZ2VudChhZ2VudFBhcnRpYWwpIHsKICAgICAgaWYgKHR5cGVvZiBhZ2VudFBhcnRpYWwgPT09ICdzdHJpbmcnICYmIGFnZW50UGFydGlhbCkgewogICAgICAgIHRoaXMuX3VzZXJBZ2VudCArPSAnICcgKyBhZ2VudFBhcnRpYWw7CiAgICAgIH0KICAgICAgdGhpcy5oZWFkZXJzW3RoaXMuZ2V0VXNlckFnZW50SGVhZGVyTmFtZSgpXSA9IHRoaXMuX3VzZXJBZ2VudDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRVc2VyQWdlbnQ6IGZ1bmN0aW9uIGdldFVzZXJBZ2VudCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3VzZXJBZ2VudDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEByZXR1cm4gW1N0cmluZ10gdGhlIHBhcnQgb2YgdGhlIHtwYXRofSBleGNsdWRpbmcgdGhlCiAgICAgKiAgIHF1ZXJ5IHN0cmluZwogICAgICovCiAgICBwYXRobmFtZTogZnVuY3Rpb24gcGF0aG5hbWUoKSB7CiAgICAgIHJldHVybiB0aGlzLnBhdGguc3BsaXQoJz8nLCAxKVswXTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEByZXR1cm4gW1N0cmluZ10gdGhlIHF1ZXJ5IHN0cmluZyBwb3J0aW9uIG9mIHRoZSB7cGF0aH0KICAgICAqLwogICAgc2VhcmNoOiBmdW5jdGlvbiBzZWFyY2goKSB7CiAgICAgIHZhciBxdWVyeSA9IHRoaXMucGF0aC5zcGxpdCgnPycsIDIpWzFdOwogICAgICBpZiAocXVlcnkpIHsKICAgICAgICBxdWVyeSA9IEFXUy51dGlsLnF1ZXJ5U3RyaW5nUGFyc2UocXVlcnkpOwogICAgICAgIHJldHVybiBBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHF1ZXJ5KTsKICAgICAgfQogICAgICByZXR1cm4gJyc7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqIHVwZGF0ZSBodHRwUmVxdWVzdCBlbmRwb2ludCB3aXRoIGVuZHBvaW50IHN0cmluZwogICAgICovCiAgICB1cGRhdGVFbmRwb2ludDogZnVuY3Rpb24gdXBkYXRlRW5kcG9pbnQoZW5kcG9pbnRTdHIpIHsKICAgICAgdmFyIG5ld0VuZHBvaW50ID0gbmV3IEFXUy5FbmRwb2ludChlbmRwb2ludFN0cik7CiAgICAgIHRoaXMuZW5kcG9pbnQgPSBuZXdFbmRwb2ludDsKICAgICAgdGhpcy5wYXRoID0gbmV3RW5kcG9pbnQucGF0aCB8fCAnLyc7CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICogVGhlIGxvdyBsZXZlbCBIVFRQIHJlc3BvbnNlIG9iamVjdCwgZW5jYXBzdWxhdGluZyBhbGwgSFRUUCBoZWFkZXIKICAgKiBhbmQgYm9keSBkYXRhIHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzdGF0dXNDb2RlCiAgICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgSFRUUCBzdGF0dXMgY29kZSBvZiB0aGUgcmVzcG9uc2UgKGUuZy4sIDIwMCwgNDA0KQogICAqIEAhYXR0cmlidXRlIGhlYWRlcnMKICAgKiAgIEByZXR1cm4gW21hcDxTdHJpbmcsU3RyaW5nPl0KICAgKiAgICAgIGEgbWFwIG9mIHJlc3BvbnNlIGhlYWRlciBrZXlzIGFuZCB0aGVpciByZXNwZWN0aXZlIHZhbHVlcwogICAqIEAhYXR0cmlidXRlIGJvZHkKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIHJlc3BvbnNlIGJvZHkgcGF5bG9hZAogICAqIEAhYXR0cmlidXRlIFtyXSBzdHJlYW1pbmcKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhpcyByZXNwb25zZSBpcyBiZWluZyBzdHJlYW1lZCBhdCBhIGxvdy1sZXZlbC4KICAgKiAgICAgRGVmYXVsdHMgdG8gYGZhbHNlYCAoYnVmZmVyZWQgcmVhZHMpLiBEbyBub3QgbW9kaWZ5IHRoaXMgbWFudWFsbHksIHVzZQogICAqICAgICB7Y3JlYXRlVW5idWZmZXJlZFN0cmVhbX0gdG8gY29udmVydCB0aGUgc3RyZWFtIHRvIHVuYnVmZmVyZWQgbW9kZQogICAqICAgICBpbnN0ZWFkLgogICAqLwogIEFXUy5IdHRwUmVzcG9uc2UgPSBpbmhlcml0KHsKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBIdHRwUmVzcG9uc2UoKSB7CiAgICAgIHRoaXMuc3RhdHVzQ29kZSA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5oZWFkZXJzID0ge307CiAgICAgIHRoaXMuYm9keSA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5zdHJlYW1pbmcgPSBmYWxzZTsKICAgICAgdGhpcy5zdHJlYW0gPSBudWxsOwogICAgfSwKICAKICAgIC8qKgogICAgICogRGlzYWJsZXMgYnVmZmVyaW5nIG9uIHRoZSBIVFRQIHJlc3BvbnNlIGFuZCByZXR1cm5zIHRoZSBzdHJlYW0gZm9yIHJlYWRpbmcuCiAgICAgKiBAcmV0dXJuIFtTdHJlYW0sIFhNTEh0dHBSZXF1ZXN0LCBudWxsXSB0aGUgdW5kZXJseWluZyBzdHJlYW0gb2JqZWN0LgogICAgICogICBVc2UgdGhpcyBvYmplY3QgdG8gZGlyZWN0bHkgcmVhZCBkYXRhIG9mZiBvZiB0aGUgc3RyZWFtLgogICAgICogQG5vdGUgVGhpcyBvYmplY3QgaXMgb25seSBhdmFpbGFibGUgYWZ0ZXIgdGhlIHtBV1MuUmVxdWVzdH5odHRwSGVhZGVyc30KICAgICAqICAgZXZlbnQgaGFzIGZpcmVkLiBUaGlzIG1ldGhvZCBtdXN0IGJlIGNhbGxlZCBwcmlvciB0bwogICAgICogICB7QVdTLlJlcXVlc3R+aHR0cERhdGF9LgogICAgICogQGV4YW1wbGUgVGFraW5nIGNvbnRyb2wgb2YgYSBzdHJlYW0KICAgICAqICAgcmVxdWVzdC5vbignaHR0cEhlYWRlcnMnLCBmdW5jdGlvbihzdGF0dXNDb2RlLCBoZWFkZXJzKSB7CiAgICAgKiAgICAgaWYgKHN0YXR1c0NvZGUgPCAzMDApIHsKICAgICAqICAgICAgIGlmIChoZWFkZXJzLmV0YWcgPT09ICd4eXonKSB7CiAgICAgKiAgICAgICAgIC8vIHBpcGUgdGhlIHN0cmVhbSwgZGlzYWJsaW5nIGJ1ZmZlcmluZwogICAgICogICAgICAgICB2YXIgc3RyZWFtID0gdGhpcy5yZXNwb25zZS5odHRwUmVzcG9uc2UuY3JlYXRlVW5idWZmZXJlZFN0cmVhbSgpOwogICAgICogICAgICAgICBzdHJlYW0ucGlwZShwcm9jZXNzLnN0ZG91dCk7CiAgICAgKiAgICAgICB9IGVsc2UgeyAvLyBhYm9ydCB0aGlzIHJlcXVlc3QgYW5kIHNldCBhIGJldHRlciBlcnJvciBtZXNzYWdlCiAgICAgKiAgICAgICAgIHRoaXMuYWJvcnQoKTsKICAgICAqICAgICAgICAgdGhpcy5yZXNwb25zZS5lcnJvciA9IG5ldyBFcnJvcignSW52YWxpZCBFVGFnJyk7CiAgICAgKiAgICAgICB9CiAgICAgKiAgICAgfQogICAgICogICB9KS5zZW5kKGNvbnNvbGUubG9nKTsKICAgICAqLwogICAgY3JlYXRlVW5idWZmZXJlZFN0cmVhbTogZnVuY3Rpb24gY3JlYXRlVW5idWZmZXJlZFN0cmVhbSgpIHsKICAgICAgdGhpcy5zdHJlYW1pbmcgPSB0cnVlOwogICAgICByZXR1cm4gdGhpcy5zdHJlYW07CiAgICB9CiAgfSk7CiAgCiAgCiAgQVdTLkh0dHBDbGllbnQgPSBpbmhlcml0KHt9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuSHR0cENsaWVudC5nZXRJbnN0YW5jZSA9IGZ1bmN0aW9uIGdldEluc3RhbmNlKCkgewogICAgaWYgKHRoaXMuc2luZ2xldG9uID09PSB1bmRlZmluZWQpIHsKICAgICAgdGhpcy5zaW5nbGV0b24gPSBuZXcgdGhpcygpOwogICAgfQogICAgcmV0dXJuIHRoaXMuc2luZ2xldG9uOwogIH07CiAgCiAgfSx7Ii4vY29yZSI6MTh9XSwzNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykuRXZlbnRFbWl0dGVyOwogIHJlcXVpcmUoJy4uL2h0dHAnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuWEhSQ2xpZW50ID0gQVdTLnV0aWwuaW5oZXJpdCh7CiAgICBoYW5kbGVSZXF1ZXN0OiBmdW5jdGlvbiBoYW5kbGVSZXF1ZXN0KGh0dHBSZXF1ZXN0LCBodHRwT3B0aW9ucywgY2FsbGJhY2ssIGVyckNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGVuZHBvaW50ID0gaHR0cFJlcXVlc3QuZW5kcG9pbnQ7CiAgICAgIHZhciBlbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcigpOwogICAgICB2YXIgaHJlZiA9IGVuZHBvaW50LnByb3RvY29sICsgJy8vJyArIGVuZHBvaW50Lmhvc3RuYW1lOwogICAgICBpZiAoZW5kcG9pbnQucG9ydCAhPT0gODAgJiYgZW5kcG9pbnQucG9ydCAhPT0gNDQzKSB7CiAgICAgICAgaHJlZiArPSAnOicgKyBlbmRwb2ludC5wb3J0OwogICAgICB9CiAgICAgIGhyZWYgKz0gaHR0cFJlcXVlc3QucGF0aDsKICAKICAgICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpLCBoZWFkZXJzRW1pdHRlZCA9IGZhbHNlOwogICAgICBodHRwUmVxdWVzdC5zdHJlYW0gPSB4aHI7CiAgCiAgICAgIHhoci5hZGRFdmVudExpc3RlbmVyKCdyZWFkeXN0YXRlY2hhbmdlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGlmICh4aHIuc3RhdHVzID09PSAwKSByZXR1cm47IC8vIDAgY29kZSBpcyBpbnZhbGlkCiAgICAgICAgfSBjYXRjaCAoZSkgeyByZXR1cm47IH0KICAKICAgICAgICBpZiAodGhpcy5yZWFkeVN0YXRlID49IHRoaXMuSEVBREVSU19SRUNFSVZFRCAmJiAhaGVhZGVyc0VtaXR0ZWQpIHsKICAgICAgICAgIGVtaXR0ZXIuc3RhdHVzQ29kZSA9IHhoci5zdGF0dXM7CiAgICAgICAgICBlbWl0dGVyLmhlYWRlcnMgPSBzZWxmLnBhcnNlSGVhZGVycyh4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkpOwogICAgICAgICAgZW1pdHRlci5lbWl0KAogICAgICAgICAgICAnaGVhZGVycycsCiAgICAgICAgICAgIGVtaXR0ZXIuc3RhdHVzQ29kZSwKICAgICAgICAgICAgZW1pdHRlci5oZWFkZXJzLAogICAgICAgICAgICB4aHIuc3RhdHVzVGV4dAogICAgICAgICAgKTsKICAgICAgICAgIGhlYWRlcnNFbWl0dGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA9PT0gdGhpcy5ET05FKSB7CiAgICAgICAgICBzZWxmLmZpbmlzaFJlcXVlc3QoeGhyLCBlbWl0dGVyKTsKICAgICAgICB9CiAgICAgIH0sIGZhbHNlKTsKICAgICAgeGhyLnVwbG9hZC5hZGRFdmVudExpc3RlbmVyKCdwcm9ncmVzcycsIGZ1bmN0aW9uIChldnQpIHsKICAgICAgICBlbWl0dGVyLmVtaXQoJ3NlbmRQcm9ncmVzcycsIGV2dCk7CiAgICAgIH0pOwogICAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcigncHJvZ3Jlc3MnLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgZW1pdHRlci5lbWl0KCdyZWNlaXZlUHJvZ3Jlc3MnLCBldnQpOwogICAgICB9LCBmYWxzZSk7CiAgICAgIHhoci5hZGRFdmVudExpc3RlbmVyKCd0aW1lb3V0JywgZnVuY3Rpb24gKCkgewogICAgICAgIGVyckNhbGxiYWNrKEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcignVGltZW91dCcpLCB7Y29kZTogJ1RpbWVvdXRFcnJvcid9KSk7CiAgICAgIH0sIGZhbHNlKTsKICAgICAgeGhyLmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgZnVuY3Rpb24gKCkgewogICAgICAgIGVyckNhbGxiYWNrKEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcignTmV0d29yayBGYWlsdXJlJyksIHsKICAgICAgICAgIGNvZGU6ICdOZXR3b3JraW5nRXJyb3InCiAgICAgICAgfSkpOwogICAgICB9LCBmYWxzZSk7CiAgICAgIHhoci5hZGRFdmVudExpc3RlbmVyKCdhYm9ydCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICBlcnJDYWxsYmFjayhBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ1JlcXVlc3QgYWJvcnRlZCcpLCB7CiAgICAgICAgICBjb2RlOiAnUmVxdWVzdEFib3J0ZWRFcnJvcicKICAgICAgICB9KSk7CiAgICAgIH0sIGZhbHNlKTsKICAKICAgICAgY2FsbGJhY2soZW1pdHRlcik7CiAgICAgIHhoci5vcGVuKGh0dHBSZXF1ZXN0Lm1ldGhvZCwgaHJlZiwgaHR0cE9wdGlvbnMueGhyQXN5bmMgIT09IGZhbHNlKTsKICAgICAgQVdTLnV0aWwuZWFjaChodHRwUmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgIGlmIChrZXkgIT09ICdDb250ZW50LUxlbmd0aCcgJiYga2V5ICE9PSAnVXNlci1BZ2VudCcgJiYga2V5ICE9PSAnSG9zdCcpIHsKICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGlmIChodHRwT3B0aW9ucy50aW1lb3V0ICYmIGh0dHBPcHRpb25zLnhockFzeW5jICE9PSBmYWxzZSkgewogICAgICAgIHhoci50aW1lb3V0ID0gaHR0cE9wdGlvbnMudGltZW91dDsKICAgICAgfQogIAogICAgICBpZiAoaHR0cE9wdGlvbnMueGhyV2l0aENyZWRlbnRpYWxzKSB7CiAgICAgICAgeGhyLndpdGhDcmVkZW50aWFscyA9IHRydWU7CiAgICAgIH0KICAgICAgdHJ5IHsgeGhyLnJlc3BvbnNlVHlwZSA9ICdhcnJheWJ1ZmZlcic7IH0gY2F0Y2ggKGUpIHt9CiAgCiAgICAgIHRyeSB7CiAgICAgICAgaWYgKGh0dHBSZXF1ZXN0LmJvZHkpIHsKICAgICAgICAgIHhoci5zZW5kKGh0dHBSZXF1ZXN0LmJvZHkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB4aHIuc2VuZCgpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgaWYgKGh0dHBSZXF1ZXN0LmJvZHkgJiYgdHlwZW9mIGh0dHBSZXF1ZXN0LmJvZHkuYnVmZmVyID09PSAnb2JqZWN0JykgewogICAgICAgICAgeGhyLnNlbmQoaHR0cFJlcXVlc3QuYm9keS5idWZmZXIpOyAvLyBzZW5kIEFycmF5QnVmZmVyIGRpcmVjdGx5CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IGVycjsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgcmV0dXJuIGVtaXR0ZXI7CiAgICB9LAogIAogICAgcGFyc2VIZWFkZXJzOiBmdW5jdGlvbiBwYXJzZUhlYWRlcnMocmF3SGVhZGVycykgewogICAgICB2YXIgaGVhZGVycyA9IHt9OwogICAgICBBV1MudXRpbC5hcnJheUVhY2gocmF3SGVhZGVycy5zcGxpdCgvXHI/XG4vKSwgZnVuY3Rpb24gKGxpbmUpIHsKICAgICAgICB2YXIga2V5ID0gbGluZS5zcGxpdCgnOicsIDEpWzBdOwogICAgICAgIHZhciB2YWx1ZSA9IGxpbmUuc3Vic3RyaW5nKGtleS5sZW5ndGggKyAyKTsKICAgICAgICBpZiAoa2V5Lmxlbmd0aCA+IDApIGhlYWRlcnNba2V5LnRvTG93ZXJDYXNlKCldID0gdmFsdWU7CiAgICAgIH0pOwogICAgICByZXR1cm4gaGVhZGVyczsKICAgIH0sCiAgCiAgICBmaW5pc2hSZXF1ZXN0OiBmdW5jdGlvbiBmaW5pc2hSZXF1ZXN0KHhociwgZW1pdHRlcikgewogICAgICB2YXIgYnVmZmVyOwogICAgICBpZiAoeGhyLnJlc3BvbnNlVHlwZSA9PT0gJ2FycmF5YnVmZmVyJyAmJiB4aHIucmVzcG9uc2UpIHsKICAgICAgICB2YXIgYWIgPSB4aHIucmVzcG9uc2U7CiAgICAgICAgYnVmZmVyID0gbmV3IEFXUy51dGlsLkJ1ZmZlcihhYi5ieXRlTGVuZ3RoKTsKICAgICAgICB2YXIgdmlldyA9IG5ldyBVaW50OEFycmF5KGFiKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGJ1ZmZlci5sZW5ndGg7ICsraSkgewogICAgICAgICAgYnVmZmVyW2ldID0gdmlld1tpXTsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgdHJ5IHsKICAgICAgICBpZiAoIWJ1ZmZlciAmJiB0eXBlb2YgeGhyLnJlc3BvbnNlVGV4dCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGJ1ZmZlciA9IG5ldyBBV1MudXRpbC5CdWZmZXIoeGhyLnJlc3BvbnNlVGV4dCk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7fQogIAogICAgICBpZiAoYnVmZmVyKSBlbWl0dGVyLmVtaXQoJ2RhdGEnLCBidWZmZXIpOwogICAgICBlbWl0dGVyLmVtaXQoJ2VuZCcpOwogICAgfQogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5IdHRwQ2xpZW50LnByb3RvdHlwZSA9IEFXUy5YSFJDbGllbnQucHJvdG90eXBlOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID0gMTsKICAKICB9LHsiLi4vY29yZSI6MTgsIi4uL2h0dHAiOjM0LCJldmVudHMiOjgxfV0sMzY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIAogIGZ1bmN0aW9uIEpzb25CdWlsZGVyKCkgeyB9CiAgCiAgSnNvbkJ1aWxkZXIucHJvdG90eXBlLmJ1aWxkID0gZnVuY3Rpb24odmFsdWUsIHNoYXBlKSB7CiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodHJhbnNsYXRlKHZhbHVlLCBzaGFwZSkpOwogIH07CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZSkgewogICAgaWYgKCFzaGFwZSB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogIAogICAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICAgIGNhc2UgJ3N0cnVjdHVyZSc6IHJldHVybiB0cmFuc2xhdGVTdHJ1Y3R1cmUodmFsdWUsIHNoYXBlKTsKICAgICAgY2FzZSAnbWFwJzogcmV0dXJuIHRyYW5zbGF0ZU1hcCh2YWx1ZSwgc2hhcGUpOwogICAgICBjYXNlICdsaXN0JzogcmV0dXJuIHRyYW5zbGF0ZUxpc3QodmFsdWUsIHNoYXBlKTsKICAgICAgZGVmYXVsdDogcmV0dXJuIHRyYW5zbGF0ZVNjYWxhcih2YWx1ZSwgc2hhcGUpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiB0cmFuc2xhdGVTdHJ1Y3R1cmUoc3RydWN0dXJlLCBzaGFwZSkgewogICAgdmFyIHN0cnVjdCA9IHt9OwogICAgdXRpbC5lYWNoKHN0cnVjdHVyZSwgZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgdmFyIG1lbWJlclNoYXBlID0gc2hhcGUubWVtYmVyc1tuYW1lXTsKICAgICAgaWYgKG1lbWJlclNoYXBlKSB7CiAgICAgICAgaWYgKG1lbWJlclNoYXBlLmxvY2F0aW9uICE9PSAnYm9keScpIHJldHVybjsKICAgICAgICB2YXIgbG9jYXRpb25OYW1lID0gbWVtYmVyU2hhcGUuaXNMb2NhdGlvbk5hbWUgPyBtZW1iZXJTaGFwZS5uYW1lIDogbmFtZTsKICAgICAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBtZW1iZXJTaGFwZSk7CiAgICAgICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSBzdHJ1Y3RbbG9jYXRpb25OYW1lXSA9IHJlc3VsdDsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gc3RydWN0OwogIH0KICAKICBmdW5jdGlvbiB0cmFuc2xhdGVMaXN0KGxpc3QsIHNoYXBlKSB7CiAgICB2YXIgb3V0ID0gW107CiAgICB1dGlsLmFycmF5RWFjaChsaXN0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZS5tZW1iZXIpOwogICAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIG91dC5wdXNoKHJlc3VsdCk7CiAgICB9KTsKICAgIHJldHVybiBvdXQ7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZU1hcChtYXAsIHNoYXBlKSB7CiAgICB2YXIgb3V0ID0ge307CiAgICB1dGlsLmVhY2gobWFwLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIHZhciByZXN1bHQgPSB0cmFuc2xhdGUodmFsdWUsIHNoYXBlLnZhbHVlKTsKICAgICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSBvdXRba2V5XSA9IHJlc3VsdDsKICAgIH0pOwogICAgcmV0dXJuIG91dDsKICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlU2NhbGFyKHZhbHVlLCBzaGFwZSkgewogICAgcmV0dXJuIHNoYXBlLnRvV2lyZUZvcm1hdCh2YWx1ZSk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gSnNvbkJ1aWxkZXI7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxfV0sMzc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIAogIGZ1bmN0aW9uIEpzb25QYXJzZXIoKSB7IH0KICAKICBKc29uUGFyc2VyLnByb3RvdHlwZS5wYXJzZSA9IGZ1bmN0aW9uKHZhbHVlLCBzaGFwZSkgewogICAgcmV0dXJuIHRyYW5zbGF0ZShKU09OLnBhcnNlKHZhbHVlKSwgc2hhcGUpOwogIH07CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZSkgewogICAgaWYgKCFzaGFwZSB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gdW5kZWZpbmVkOwogIAogICAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICAgIGNhc2UgJ3N0cnVjdHVyZSc6IHJldHVybiB0cmFuc2xhdGVTdHJ1Y3R1cmUodmFsdWUsIHNoYXBlKTsKICAgICAgY2FzZSAnbWFwJzogcmV0dXJuIHRyYW5zbGF0ZU1hcCh2YWx1ZSwgc2hhcGUpOwogICAgICBjYXNlICdsaXN0JzogcmV0dXJuIHRyYW5zbGF0ZUxpc3QodmFsdWUsIHNoYXBlKTsKICAgICAgZGVmYXVsdDogcmV0dXJuIHRyYW5zbGF0ZVNjYWxhcih2YWx1ZSwgc2hhcGUpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiB0cmFuc2xhdGVTdHJ1Y3R1cmUoc3RydWN0dXJlLCBzaGFwZSkgewogICAgaWYgKHN0cnVjdHVyZSA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogIAogICAgdmFyIHN0cnVjdCA9IHt9OwogICAgdmFyIHNoYXBlTWVtYmVycyA9IHNoYXBlLm1lbWJlcnM7CiAgICB1dGlsLmVhY2goc2hhcGVNZW1iZXJzLCBmdW5jdGlvbihuYW1lLCBtZW1iZXJTaGFwZSkgewogICAgICB2YXIgbG9jYXRpb25OYW1lID0gbWVtYmVyU2hhcGUuaXNMb2NhdGlvbk5hbWUgPyBtZW1iZXJTaGFwZS5uYW1lIDogbmFtZTsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzdHJ1Y3R1cmUsIGxvY2F0aW9uTmFtZSkpIHsKICAgICAgICB2YXIgdmFsdWUgPSBzdHJ1Y3R1cmVbbG9jYXRpb25OYW1lXTsKICAgICAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBtZW1iZXJTaGFwZSk7CiAgICAgICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSBzdHJ1Y3RbbmFtZV0gPSByZXN1bHQ7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHN0cnVjdDsKICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlTGlzdChsaXN0LCBzaGFwZSkgewogICAgaWYgKGxpc3QgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAKICAgIHZhciBvdXQgPSBbXTsKICAgIHV0aWwuYXJyYXlFYWNoKGxpc3QsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhciByZXN1bHQgPSB0cmFuc2xhdGUodmFsdWUsIHNoYXBlLm1lbWJlcik7CiAgICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkgb3V0LnB1c2gobnVsbCk7CiAgICAgIGVsc2Ugb3V0LnB1c2gocmVzdWx0KTsKICAgIH0pOwogICAgcmV0dXJuIG91dDsKICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlTWFwKG1hcCwgc2hhcGUpIHsKICAgIGlmIChtYXAgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAKICAgIHZhciBvdXQgPSB7fTsKICAgIHV0aWwuZWFjaChtYXAsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUudmFsdWUpOwogICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIG91dFtrZXldID0gbnVsbDsKICAgICAgZWxzZSBvdXRba2V5XSA9IHJlc3VsdDsKICAgIH0pOwogICAgcmV0dXJuIG91dDsKICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlU2NhbGFyKHZhbHVlLCBzaGFwZSkgewogICAgcmV0dXJuIHNoYXBlLnRvVHlwZSh2YWx1ZSk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gSnNvblBhcnNlcjsKICAKICB9LHsiLi4vdXRpbCI6NzF9XSwzODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIENvbGxlY3Rpb24gPSByZXF1aXJlKCcuL2NvbGxlY3Rpb24nKTsKICB2YXIgT3BlcmF0aW9uID0gcmVxdWlyZSgnLi9vcGVyYXRpb24nKTsKICB2YXIgU2hhcGUgPSByZXF1aXJlKCcuL3NoYXBlJyk7CiAgdmFyIFBhZ2luYXRvciA9IHJlcXVpcmUoJy4vcGFnaW5hdG9yJyk7CiAgdmFyIFJlc291cmNlV2FpdGVyID0gcmVxdWlyZSgnLi9yZXNvdXJjZV93YWl0ZXInKTsKICAKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgcHJvcGVydHkgPSB1dGlsLnByb3BlcnR5OwogIHZhciBtZW1vaXplZFByb3BlcnR5ID0gdXRpbC5tZW1vaXplZFByb3BlcnR5OwogIAogIGZ1bmN0aW9uIEFwaShhcGksIG9wdGlvbnMpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGFwaSA9IGFwaSB8fCB7fTsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgb3B0aW9ucy5hcGkgPSB0aGlzOwogIAogICAgYXBpLm1ldGFkYXRhID0gYXBpLm1ldGFkYXRhIHx8IHt9OwogIAogICAgcHJvcGVydHkodGhpcywgJ2lzQXBpJywgdHJ1ZSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2FwaVZlcnNpb24nLCBhcGkubWV0YWRhdGEuYXBpVmVyc2lvbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZW5kcG9pbnRQcmVmaXgnLCBhcGkubWV0YWRhdGEuZW5kcG9pbnRQcmVmaXgpOwogICAgcHJvcGVydHkodGhpcywgJ3NpZ25pbmdOYW1lJywgYXBpLm1ldGFkYXRhLnNpZ25pbmdOYW1lKTsKICAgIHByb3BlcnR5KHRoaXMsICdnbG9iYWxFbmRwb2ludCcsIGFwaS5tZXRhZGF0YS5nbG9iYWxFbmRwb2ludCk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnc2lnbmF0dXJlVmVyc2lvbicsIGFwaS5tZXRhZGF0YS5zaWduYXR1cmVWZXJzaW9uKTsKICAgIHByb3BlcnR5KHRoaXMsICdqc29uVmVyc2lvbicsIGFwaS5tZXRhZGF0YS5qc29uVmVyc2lvbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAndGFyZ2V0UHJlZml4JywgYXBpLm1ldGFkYXRhLnRhcmdldFByZWZpeCk7CiAgICBwcm9wZXJ0eSh0aGlzLCAncHJvdG9jb2wnLCBhcGkubWV0YWRhdGEucHJvdG9jb2wpOwogICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsIGFwaS5tZXRhZGF0YS50aW1lc3RhbXBGb3JtYXQpOwogICAgcHJvcGVydHkodGhpcywgJ3htbE5hbWVzcGFjZVVyaScsIGFwaS5tZXRhZGF0YS54bWxOYW1lc3BhY2UpOwogICAgcHJvcGVydHkodGhpcywgJ2FiYnJldmlhdGlvbicsIGFwaS5tZXRhZGF0YS5zZXJ2aWNlQWJicmV2aWF0aW9uKTsKICAgIHByb3BlcnR5KHRoaXMsICdmdWxsTmFtZScsIGFwaS5tZXRhZGF0YS5zZXJ2aWNlRnVsbE5hbWUpOwogICAgcHJvcGVydHkodGhpcywgJ3NlcnZpY2VJZCcsIGFwaS5tZXRhZGF0YS5zZXJ2aWNlSWQpOwogIAogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnY2xhc3NOYW1lJywgZnVuY3Rpb24oKSB7CiAgICAgIHZhciBuYW1lID0gYXBpLm1ldGFkYXRhLnNlcnZpY2VBYmJyZXZpYXRpb24gfHwgYXBpLm1ldGFkYXRhLnNlcnZpY2VGdWxsTmFtZTsKICAgICAgaWYgKCFuYW1lKSByZXR1cm4gbnVsbDsKICAKICAgICAgbmFtZSA9IG5hbWUucmVwbGFjZSgvXkFtYXpvbnxBV1Nccyp8XCguKnxccyt8XFcrL2csICcnKTsKICAgICAgaWYgKG5hbWUgPT09ICdFbGFzdGljTG9hZEJhbGFuY2luZycpIG5hbWUgPSAnRUxCJzsKICAgICAgcmV0dXJuIG5hbWU7CiAgICB9KTsKICAKICAgIGZ1bmN0aW9uIGFkZEVuZHBvaW50T3BlcmF0aW9uKG5hbWUsIG9wZXJhdGlvbikgewogICAgICBpZiAob3BlcmF0aW9uLmVuZHBvaW50b3BlcmF0aW9uID09PSB0cnVlKSB7CiAgICAgICAgcHJvcGVydHkoc2VsZiwgJ2VuZHBvaW50T3BlcmF0aW9uJywgdXRpbC5zdHJpbmcubG93ZXJGaXJzdChuYW1lKSk7CiAgICAgIH0KICAgIH0KICAKICAgIHByb3BlcnR5KHRoaXMsICdvcGVyYXRpb25zJywgbmV3IENvbGxlY3Rpb24oYXBpLm9wZXJhdGlvbnMsIG9wdGlvbnMsIGZ1bmN0aW9uKG5hbWUsIG9wZXJhdGlvbikgewogICAgICByZXR1cm4gbmV3IE9wZXJhdGlvbihuYW1lLCBvcGVyYXRpb24sIG9wdGlvbnMpOwogICAgfSwgdXRpbC5zdHJpbmcubG93ZXJGaXJzdCwgYWRkRW5kcG9pbnRPcGVyYXRpb24pKTsKICAKICAgIHByb3BlcnR5KHRoaXMsICdzaGFwZXMnLCBuZXcgQ29sbGVjdGlvbihhcGkuc2hhcGVzLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCBzaGFwZSkgewogICAgICByZXR1cm4gU2hhcGUuY3JlYXRlKHNoYXBlLCBvcHRpb25zKTsKICAgIH0pKTsKICAKICAgIHByb3BlcnR5KHRoaXMsICdwYWdpbmF0b3JzJywgbmV3IENvbGxlY3Rpb24oYXBpLnBhZ2luYXRvcnMsIG9wdGlvbnMsIGZ1bmN0aW9uKG5hbWUsIHBhZ2luYXRvcikgewogICAgICByZXR1cm4gbmV3IFBhZ2luYXRvcihuYW1lLCBwYWdpbmF0b3IsIG9wdGlvbnMpOwogICAgfSkpOwogIAogICAgcHJvcGVydHkodGhpcywgJ3dhaXRlcnMnLCBuZXcgQ29sbGVjdGlvbihhcGkud2FpdGVycywgb3B0aW9ucywgZnVuY3Rpb24obmFtZSwgd2FpdGVyKSB7CiAgICAgIHJldHVybiBuZXcgUmVzb3VyY2VXYWl0ZXIobmFtZSwgd2FpdGVyLCBvcHRpb25zKTsKICAgIH0sIHV0aWwuc3RyaW5nLmxvd2VyRmlyc3QpKTsKICAKICAgIGlmIChvcHRpb25zLmRvY3VtZW50YXRpb24pIHsKICAgICAgcHJvcGVydHkodGhpcywgJ2RvY3VtZW50YXRpb24nLCBhcGkuZG9jdW1lbnRhdGlvbik7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uVXJsJywgYXBpLmRvY3VtZW50YXRpb25VcmwpOwogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFwaTsKICAKICB9LHsiLi4vdXRpbCI6NzEsIi4vY29sbGVjdGlvbiI6MzksIi4vb3BlcmF0aW9uIjo0MCwiLi9wYWdpbmF0b3IiOjQxLCIuL3Jlc291cmNlX3dhaXRlciI6NDIsIi4vc2hhcGUiOjQzfV0sMzk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBtZW1vaXplZFByb3BlcnR5ID0gcmVxdWlyZSgnLi4vdXRpbCcpLm1lbW9pemVkUHJvcGVydHk7CiAgCiAgZnVuY3Rpb24gbWVtb2l6ZShuYW1lLCB2YWx1ZSwgZmFjdG9yeSwgbmFtZVRyKSB7CiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsIG5hbWVUcihuYW1lKSwgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBmYWN0b3J5KG5hbWUsIHZhbHVlKTsKICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBDb2xsZWN0aW9uKGl0ZXJhYmxlLCBvcHRpb25zLCBmYWN0b3J5LCBuYW1lVHIsIGNhbGxiYWNrKSB7CiAgICBuYW1lVHIgPSBuYW1lVHIgfHwgU3RyaW5nOwogICAgdmFyIHNlbGYgPSB0aGlzOwogIAogICAgZm9yICh2YXIgaWQgaW4gaXRlcmFibGUpIHsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChpdGVyYWJsZSwgaWQpKSB7CiAgICAgICAgbWVtb2l6ZS5jYWxsKHNlbGYsIGlkLCBpdGVyYWJsZVtpZF0sIGZhY3RvcnksIG5hbWVUcik7CiAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayhpZCwgaXRlcmFibGVbaWRdKTsKICAgICAgfQogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IENvbGxlY3Rpb247CiAgCiAgfSx7Ii4uL3V0aWwiOjcxfV0sNDA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBTaGFwZSA9IHJlcXVpcmUoJy4vc2hhcGUnKTsKICAKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgcHJvcGVydHkgPSB1dGlsLnByb3BlcnR5OwogIHZhciBtZW1vaXplZFByb3BlcnR5ID0gdXRpbC5tZW1vaXplZFByb3BlcnR5OwogIAogIGZ1bmN0aW9uIE9wZXJhdGlvbihuYW1lLCBvcGVyYXRpb24sIG9wdGlvbnMpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIAogICAgcHJvcGVydHkodGhpcywgJ25hbWUnLCBvcGVyYXRpb24ubmFtZSB8fCBuYW1lKTsKICAgIHByb3BlcnR5KHRoaXMsICdhcGknLCBvcHRpb25zLmFwaSwgZmFsc2UpOwogIAogICAgb3BlcmF0aW9uLmh0dHAgPSBvcGVyYXRpb24uaHR0cCB8fCB7fTsKICAgIHByb3BlcnR5KHRoaXMsICdlbmRwb2ludCcsIG9wZXJhdGlvbi5lbmRwb2ludCk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaHR0cE1ldGhvZCcsIG9wZXJhdGlvbi5odHRwLm1ldGhvZCB8fCAnUE9TVCcpOwogICAgcHJvcGVydHkodGhpcywgJ2h0dHBQYXRoJywgb3BlcmF0aW9uLmh0dHAucmVxdWVzdFVyaSB8fCAnLycpOwogICAgcHJvcGVydHkodGhpcywgJ2F1dGh0eXBlJywgb3BlcmF0aW9uLmF1dGh0eXBlIHx8ICcnKTsKICAgIHByb3BlcnR5KAogICAgICB0aGlzLAogICAgICAnZW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCcsCiAgICAgIG9wZXJhdGlvbi5lbmRwb2ludGRpc2NvdmVyeSA/CiAgICAgICAgKG9wZXJhdGlvbi5lbmRwb2ludGRpc2NvdmVyeS5yZXF1aXJlZCA/ICdSRVFVSVJFRCcgOiAnT1BUSU9OQUwnKSA6CiAgICAgICdOVUxMJwogICAgKTsKICAKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2lucHV0JywgZnVuY3Rpb24oKSB7CiAgICAgIGlmICghb3BlcmF0aW9uLmlucHV0KSB7CiAgICAgICAgcmV0dXJuIG5ldyBTaGFwZS5jcmVhdGUoe3R5cGU6ICdzdHJ1Y3R1cmUnfSwgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShvcGVyYXRpb24uaW5wdXQsIG9wdGlvbnMpOwogICAgfSk7CiAgCiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdvdXRwdXQnLCBmdW5jdGlvbigpIHsKICAgICAgaWYgKCFvcGVyYXRpb24ub3V0cHV0KSB7CiAgICAgICAgcmV0dXJuIG5ldyBTaGFwZS5jcmVhdGUoe3R5cGU6ICdzdHJ1Y3R1cmUnfSwgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShvcGVyYXRpb24ub3V0cHV0LCBvcHRpb25zKTsKICAgIH0pOwogIAogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnZXJyb3JzJywgZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsaXN0ID0gW107CiAgICAgIGlmICghb3BlcmF0aW9uLmVycm9ycykgcmV0dXJuIG51bGw7CiAgCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb3BlcmF0aW9uLmVycm9ycy5sZW5ndGg7IGkrKykgewogICAgICAgIGxpc3QucHVzaChTaGFwZS5jcmVhdGUob3BlcmF0aW9uLmVycm9yc1tpXSwgb3B0aW9ucykpOwogICAgICB9CiAgCiAgICAgIHJldHVybiBsaXN0OwogICAgfSk7CiAgCiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdwYWdpbmF0b3InLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG9wdGlvbnMuYXBpLnBhZ2luYXRvcnNbbmFtZV07CiAgICB9KTsKICAKICAgIGlmIChvcHRpb25zLmRvY3VtZW50YXRpb24pIHsKICAgICAgcHJvcGVydHkodGhpcywgJ2RvY3VtZW50YXRpb24nLCBvcGVyYXRpb24uZG9jdW1lbnRhdGlvbik7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uVXJsJywgb3BlcmF0aW9uLmRvY3VtZW50YXRpb25VcmwpOwogICAgfQogIAogICAgLy8gaWRlbXBvdGVudE1lbWJlcnMgb25seSB0cmFja3MgdG9wLWxldmVsIGlucHV0IHNoYXBlcwogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnaWRlbXBvdGVudE1lbWJlcnMnLCBmdW5jdGlvbigpIHsKICAgICAgdmFyIGlkZW1wb3RlbnRNZW1iZXJzID0gW107CiAgICAgIHZhciBpbnB1dCA9IHNlbGYuaW5wdXQ7CiAgICAgIHZhciBtZW1iZXJzID0gaW5wdXQubWVtYmVyczsKICAgICAgaWYgKCFpbnB1dC5tZW1iZXJzKSB7CiAgICAgICAgcmV0dXJuIGlkZW1wb3RlbnRNZW1iZXJzOwogICAgICB9CiAgICAgIGZvciAodmFyIG5hbWUgaW4gbWVtYmVycykgewogICAgICAgIGlmICghbWVtYmVycy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGlmIChtZW1iZXJzW25hbWVdLmlzSWRlbXBvdGVudCA9PT0gdHJ1ZSkgewogICAgICAgICAgaWRlbXBvdGVudE1lbWJlcnMucHVzaChuYW1lKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGlkZW1wb3RlbnRNZW1iZXJzOwogICAgfSk7CiAgCiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdoYXNFdmVudE91dHB1dCcsIGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3V0cHV0ID0gc2VsZi5vdXRwdXQ7CiAgICAgIHJldHVybiBoYXNFdmVudFN0cmVhbShvdXRwdXQpOwogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIGhhc0V2ZW50U3RyZWFtKHRvcExldmVsU2hhcGUpIHsKICAgIHZhciBtZW1iZXJzID0gdG9wTGV2ZWxTaGFwZS5tZW1iZXJzOwogICAgdmFyIHBheWxvYWQgPSB0b3BMZXZlbFNoYXBlLnBheWxvYWQ7CiAgCiAgICBpZiAoIXRvcExldmVsU2hhcGUubWVtYmVycykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgCiAgICBpZiAocGF5bG9hZCkgewogICAgICB2YXIgcGF5bG9hZE1lbWJlciA9IG1lbWJlcnNbcGF5bG9hZF07CiAgICAgIHJldHVybiBwYXlsb2FkTWVtYmVyLmlzRXZlbnRTdHJlYW07CiAgICB9CiAgCiAgICAvLyBjaGVjayBpZiBhbnkgbWVtYmVyIGlzIGFuIGV2ZW50IHN0cmVhbQogICAgZm9yICh2YXIgbmFtZSBpbiBtZW1iZXJzKSB7CiAgICAgIGlmICghbWVtYmVycy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgIGlmIChtZW1iZXJzW25hbWVdLmlzRXZlbnRTdHJlYW0gPT09IHRydWUpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IE9wZXJhdGlvbjsKICAKICB9LHsiLi4vdXRpbCI6NzEsIi4vc2hhcGUiOjQzfV0sNDE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBwcm9wZXJ0eSA9IHJlcXVpcmUoJy4uL3V0aWwnKS5wcm9wZXJ0eTsKICAKICBmdW5jdGlvbiBQYWdpbmF0b3IobmFtZSwgcGFnaW5hdG9yKSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaW5wdXRUb2tlbicsIHBhZ2luYXRvci5pbnB1dF90b2tlbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnbGltaXRLZXknLCBwYWdpbmF0b3IubGltaXRfa2V5KTsKICAgIHByb3BlcnR5KHRoaXMsICdtb3JlUmVzdWx0cycsIHBhZ2luYXRvci5tb3JlX3Jlc3VsdHMpOwogICAgcHJvcGVydHkodGhpcywgJ291dHB1dFRva2VuJywgcGFnaW5hdG9yLm91dHB1dF90b2tlbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAncmVzdWx0S2V5JywgcGFnaW5hdG9yLnJlc3VsdF9rZXkpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IFBhZ2luYXRvcjsKICAKICB9LHsiLi4vdXRpbCI6NzF9XSw0MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIHByb3BlcnR5ID0gdXRpbC5wcm9wZXJ0eTsKICAKICBmdW5jdGlvbiBSZXNvdXJjZVdhaXRlcihuYW1lLCB3YWl0ZXIsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgcHJvcGVydHkodGhpcywgJ25hbWUnLCBuYW1lKTsKICAgIHByb3BlcnR5KHRoaXMsICdhcGknLCBvcHRpb25zLmFwaSwgZmFsc2UpOwogIAogICAgaWYgKHdhaXRlci5vcGVyYXRpb24pIHsKICAgICAgcHJvcGVydHkodGhpcywgJ29wZXJhdGlvbicsIHV0aWwuc3RyaW5nLmxvd2VyRmlyc3Qod2FpdGVyLm9wZXJhdGlvbikpOwogICAgfQogIAogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGtleXMgPSBbCiAgICAgICd0eXBlJywKICAgICAgJ2Rlc2NyaXB0aW9uJywKICAgICAgJ2RlbGF5JywKICAgICAgJ21heEF0dGVtcHRzJywKICAgICAgJ2FjY2VwdG9ycycKICAgIF07CiAgCiAgICBrZXlzLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgIHZhciB2YWx1ZSA9IHdhaXRlcltrZXldOwogICAgICBpZiAodmFsdWUpIHsKICAgICAgICBwcm9wZXJ0eShzZWxmLCBrZXksIHZhbHVlKTsKICAgICAgfQogICAgfSk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gUmVzb3VyY2VXYWl0ZXI7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxfV0sNDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBDb2xsZWN0aW9uID0gcmVxdWlyZSgnLi9jb2xsZWN0aW9uJyk7CiAgCiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgCiAgZnVuY3Rpb24gcHJvcGVydHkob2JqLCBuYW1lLCB2YWx1ZSkgewogICAgaWYgKHZhbHVlICE9PSBudWxsICYmIHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgdXRpbC5wcm9wZXJ0eS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBtZW1vaXplZFByb3BlcnR5KG9iaiwgbmFtZSkgewogICAgaWYgKCFvYmouY29uc3RydWN0b3IucHJvdG90eXBlW25hbWVdKSB7CiAgICAgIHV0aWwubWVtb2l6ZWRQcm9wZXJ0eS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBTaGFwZShzaGFwZSwgb3B0aW9ucywgbWVtYmVyTmFtZSkgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAnc2hhcGUnLCBzaGFwZS5zaGFwZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnYXBpJywgb3B0aW9ucy5hcGksIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICd0eXBlJywgc2hhcGUudHlwZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZW51bScsIHNoYXBlLmVudW0pOwogICAgcHJvcGVydHkodGhpcywgJ21pbicsIHNoYXBlLm1pbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnbWF4Jywgc2hhcGUubWF4KTsKICAgIHByb3BlcnR5KHRoaXMsICdwYXR0ZXJuJywgc2hhcGUucGF0dGVybik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnbG9jYXRpb24nLCBzaGFwZS5sb2NhdGlvbiB8fCB0aGlzLmxvY2F0aW9uIHx8ICdib2R5Jyk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnbmFtZScsIHRoaXMubmFtZSB8fCBzaGFwZS54bWxOYW1lIHx8IHNoYXBlLnF1ZXJ5TmFtZSB8fAogICAgICBzaGFwZS5sb2NhdGlvbk5hbWUgfHwgbWVtYmVyTmFtZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNTdHJlYW1pbmcnLCBzaGFwZS5zdHJlYW1pbmcgfHwgdGhpcy5pc1N0cmVhbWluZyB8fCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAncmVxdWlyZXNMZW5ndGgnLCBzaGFwZS5yZXF1aXJlc0xlbmd0aCwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzQ29tcG9zaXRlJywgc2hhcGUuaXNDb21wb3NpdGUgfHwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzU2hhcGUnLCB0cnVlLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNRdWVyeU5hbWUnLCBCb29sZWFuKHNoYXBlLnF1ZXJ5TmFtZSksIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0xvY2F0aW9uTmFtZScsIEJvb2xlYW4oc2hhcGUubG9jYXRpb25OYW1lKSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzSWRlbXBvdGVudCcsIHNoYXBlLmlkZW1wb3RlbmN5VG9rZW4gPT09IHRydWUpOwogICAgcHJvcGVydHkodGhpcywgJ2lzSnNvblZhbHVlJywgc2hhcGUuanNvbnZhbHVlID09PSB0cnVlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc1NlbnNpdGl2ZScsIHNoYXBlLnNlbnNpdGl2ZSA9PT0gdHJ1ZSB8fCBzaGFwZS5wcm90b3R5cGUgJiYgc2hhcGUucHJvdG90eXBlLnNlbnNpdGl2ZSA9PT0gdHJ1ZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNFdmVudFN0cmVhbScsIEJvb2xlYW4oc2hhcGUuZXZlbnRzdHJlYW0pLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNFdmVudCcsIEJvb2xlYW4oc2hhcGUuZXZlbnQpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNFdmVudFBheWxvYWQnLCBCb29sZWFuKHNoYXBlLmV2ZW50cGF5bG9hZCksIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0V2ZW50SGVhZGVyJywgQm9vbGVhbihzaGFwZS5ldmVudGhlYWRlciksIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc1RpbWVzdGFtcEZvcm1hdFNldCcsIEJvb2xlYW4oc2hhcGUudGltZXN0YW1wRm9ybWF0KSB8fCBzaGFwZS5wcm90b3R5cGUgJiYgc2hhcGUucHJvdG90eXBlLmlzVGltZXN0YW1wRm9ybWF0U2V0ID09PSB0cnVlLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZW5kcG9pbnREaXNjb3ZlcnlJZCcsIEJvb2xlYW4oc2hhcGUuZW5kcG9pbnRkaXNjb3ZlcnlpZCksIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdob3N0TGFiZWwnLCBCb29sZWFuKHNoYXBlLmhvc3RMYWJlbCksIGZhbHNlKTsKICAKICAgIGlmIChvcHRpb25zLmRvY3VtZW50YXRpb24pIHsKICAgICAgcHJvcGVydHkodGhpcywgJ2RvY3VtZW50YXRpb24nLCBzaGFwZS5kb2N1bWVudGF0aW9uKTsKICAgICAgcHJvcGVydHkodGhpcywgJ2RvY3VtZW50YXRpb25VcmwnLCBzaGFwZS5kb2N1bWVudGF0aW9uVXJsKTsKICAgIH0KICAKICAgIGlmIChzaGFwZS54bWxBdHRyaWJ1dGUpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ2lzWG1sQXR0cmlidXRlJywgc2hhcGUueG1sQXR0cmlidXRlIHx8IGZhbHNlKTsKICAgIH0KICAKICAgIC8vIHR5cGUgY29udmVyc2lvbiBhbmQgcGFyc2luZwogICAgcHJvcGVydHkodGhpcywgJ2RlZmF1bHRWYWx1ZScsIG51bGwpOwogICAgdGhpcy50b1dpcmVGb3JtYXQgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuICcnOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9OwogICAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgeyByZXR1cm4gdmFsdWU7IH07CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIFNoYXBlLm5vcm1hbGl6ZWRUeXBlcyA9IHsKICAgIGNoYXJhY3RlcjogJ3N0cmluZycsCiAgICBkb3VibGU6ICdmbG9hdCcsCiAgICBsb25nOiAnaW50ZWdlcicsCiAgICBzaG9ydDogJ2ludGVnZXInLAogICAgYmlnaW50ZWdlcjogJ2ludGVnZXInLAogICAgYmlnZGVjaW1hbDogJ2Zsb2F0JywKICAgIGJsb2I6ICdiaW5hcnknCiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBTaGFwZS50eXBlcyA9IHsKICAgICdzdHJ1Y3R1cmUnOiBTdHJ1Y3R1cmVTaGFwZSwKICAgICdsaXN0JzogTGlzdFNoYXBlLAogICAgJ21hcCc6IE1hcFNoYXBlLAogICAgJ2Jvb2xlYW4nOiBCb29sZWFuU2hhcGUsCiAgICAndGltZXN0YW1wJzogVGltZXN0YW1wU2hhcGUsCiAgICAnZmxvYXQnOiBGbG9hdFNoYXBlLAogICAgJ2ludGVnZXInOiBJbnRlZ2VyU2hhcGUsCiAgICAnc3RyaW5nJzogU3RyaW5nU2hhcGUsCiAgICAnYmFzZTY0JzogQmFzZTY0U2hhcGUsCiAgICAnYmluYXJ5JzogQmluYXJ5U2hhcGUKICB9OwogIAogIFNoYXBlLnJlc29sdmUgPSBmdW5jdGlvbiByZXNvbHZlKHNoYXBlLCBvcHRpb25zKSB7CiAgICBpZiAoc2hhcGUuc2hhcGUpIHsKICAgICAgdmFyIHJlZlNoYXBlID0gb3B0aW9ucy5hcGkuc2hhcGVzW3NoYXBlLnNoYXBlXTsKICAgICAgaWYgKCFyZWZTaGFwZSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGZpbmQgc2hhcGUgcmVmZXJlbmNlOiAnICsgc2hhcGUuc2hhcGUpOwogICAgICB9CiAgCiAgICAgIHJldHVybiByZWZTaGFwZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogIH07CiAgCiAgU2hhcGUuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKHNoYXBlLCBvcHRpb25zLCBtZW1iZXJOYW1lKSB7CiAgICBpZiAoc2hhcGUuaXNTaGFwZSkgcmV0dXJuIHNoYXBlOwogIAogICAgdmFyIHJlZlNoYXBlID0gU2hhcGUucmVzb2x2ZShzaGFwZSwgb3B0aW9ucyk7CiAgICBpZiAocmVmU2hhcGUpIHsKICAgICAgdmFyIGZpbHRlcmVkS2V5cyA9IE9iamVjdC5rZXlzKHNoYXBlKTsKICAgICAgaWYgKCFvcHRpb25zLmRvY3VtZW50YXRpb24pIHsKICAgICAgICBmaWx0ZXJlZEtleXMgPSBmaWx0ZXJlZEtleXMuZmlsdGVyKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHJldHVybiAhbmFtZS5tYXRjaCgvZG9jdW1lbnRhdGlvbi8pOwogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIC8vIGNyZWF0ZSBhbiBpbmxpbmUgc2hhcGUgd2l0aCBleHRyYSBtZW1iZXJzCiAgICAgIHZhciBJbmxpbmVTaGFwZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJlZlNoYXBlLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgc2hhcGUsIG9wdGlvbnMsIG1lbWJlck5hbWUpOwogICAgICB9OwogICAgICBJbmxpbmVTaGFwZS5wcm90b3R5cGUgPSByZWZTaGFwZTsKICAgICAgcmV0dXJuIG5ldyBJbmxpbmVTaGFwZSgpOwogICAgfSBlbHNlIHsKICAgICAgLy8gc2V0IHR5cGUgaWYgbm90IHNldAogICAgICBpZiAoIXNoYXBlLnR5cGUpIHsKICAgICAgICBpZiAoc2hhcGUubWVtYmVycykgc2hhcGUudHlwZSA9ICdzdHJ1Y3R1cmUnOwogICAgICAgIGVsc2UgaWYgKHNoYXBlLm1lbWJlcikgc2hhcGUudHlwZSA9ICdsaXN0JzsKICAgICAgICBlbHNlIGlmIChzaGFwZS5rZXkpIHNoYXBlLnR5cGUgPSAnbWFwJzsKICAgICAgICBlbHNlIHNoYXBlLnR5cGUgPSAnc3RyaW5nJzsKICAgICAgfQogIAogICAgICAvLyBub3JtYWxpemUgdHlwZXMKICAgICAgdmFyIG9yaWdUeXBlID0gc2hhcGUudHlwZTsKICAgICAgaWYgKFNoYXBlLm5vcm1hbGl6ZWRUeXBlc1tzaGFwZS50eXBlXSkgewogICAgICAgIHNoYXBlLnR5cGUgPSBTaGFwZS5ub3JtYWxpemVkVHlwZXNbc2hhcGUudHlwZV07CiAgICAgIH0KICAKICAgICAgaWYgKFNoYXBlLnR5cGVzW3NoYXBlLnR5cGVdKSB7CiAgICAgICAgcmV0dXJuIG5ldyBTaGFwZS50eXBlc1tzaGFwZS50eXBlXShzaGFwZSwgb3B0aW9ucywgbWVtYmVyTmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnJlY29nbml6ZWQgc2hhcGUgdHlwZTogJyArIG9yaWdUeXBlKTsKICAgICAgfQogICAgfQogIH07CiAgCiAgZnVuY3Rpb24gQ29tcG9zaXRlU2hhcGUoc2hhcGUpIHsKICAgIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNDb21wb3NpdGUnLCB0cnVlKTsKICAKICAgIGlmIChzaGFwZS5mbGF0dGVuZWQpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ2ZsYXR0ZW5lZCcsIHNoYXBlLmZsYXR0ZW5lZCB8fCBmYWxzZSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIFN0cnVjdHVyZVNoYXBlKHNoYXBlLCBvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcmVxdWlyZWRNYXAgPSBudWxsLCBmaXJzdEluaXQgPSAhdGhpcy5pc1NoYXBlOwogIAogICAgQ29tcG9zaXRlU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAKICAgIGlmIChmaXJzdEluaXQpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ2RlZmF1bHRWYWx1ZScsIGZ1bmN0aW9uKCkgeyByZXR1cm4ge307IH0pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAnbWVtYmVycycsIHt9KTsKICAgICAgcHJvcGVydHkodGhpcywgJ21lbWJlck5hbWVzJywgW10pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAncmVxdWlyZWQnLCBbXSk7CiAgICAgIHByb3BlcnR5KHRoaXMsICdpc1JlcXVpcmVkJywgZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZTsgfSk7CiAgICB9CiAgCiAgICBpZiAoc2hhcGUubWVtYmVycykgewogICAgICBwcm9wZXJ0eSh0aGlzLCAnbWVtYmVycycsIG5ldyBDb2xsZWN0aW9uKHNoYXBlLm1lbWJlcnMsIG9wdGlvbnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlcikgewogICAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUobWVtYmVyLCBvcHRpb25zLCBuYW1lKTsKICAgICAgfSkpOwogICAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdtZW1iZXJOYW1lcycsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzaGFwZS54bWxPcmRlciB8fCBPYmplY3Qua2V5cyhzaGFwZS5tZW1iZXJzKTsKICAgICAgfSk7CiAgCiAgICAgIGlmIChzaGFwZS5ldmVudCkgewogICAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2V2ZW50UGF5bG9hZE1lbWJlck5hbWUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBtZW1iZXJzID0gc2VsZi5tZW1iZXJzOwogICAgICAgICAgdmFyIG1lbWJlck5hbWVzID0gc2VsZi5tZW1iZXJOYW1lczsKICAgICAgICAgIC8vIGl0ZXJhdGUgb3ZlciBtZW1iZXJzIHRvIGZpbmQgb25lcyB0aGF0IGFyZSBldmVudCBwYXlsb2FkcwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBtZW1iZXJOYW1lcy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgICAgaWYgKG1lbWJlcnNbbWVtYmVyTmFtZXNbaV1dLmlzRXZlbnRQYXlsb2FkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG1lbWJlck5hbWVzW2ldOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgCiAgICAgICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnZXZlbnRIZWFkZXJNZW1iZXJOYW1lcycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIG1lbWJlcnMgPSBzZWxmLm1lbWJlcnM7CiAgICAgICAgICB2YXIgbWVtYmVyTmFtZXMgPSBzZWxmLm1lbWJlck5hbWVzOwogICAgICAgICAgdmFyIGV2ZW50SGVhZGVyTWVtYmVyTmFtZXMgPSBbXTsKICAgICAgICAgIC8vIGl0ZXJhdGUgb3ZlciBtZW1iZXJzIHRvIGZpbmQgb25lcyB0aGF0IGFyZSBldmVudCBoZWFkZXJzCiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IG1lbWJlck5hbWVzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICBpZiAobWVtYmVyc1ttZW1iZXJOYW1lc1tpXV0uaXNFdmVudEhlYWRlcikgewogICAgICAgICAgICAgIGV2ZW50SGVhZGVyTWVtYmVyTmFtZXMucHVzaChtZW1iZXJOYW1lc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBldmVudEhlYWRlck1lbWJlck5hbWVzOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgCiAgICBpZiAoc2hhcGUucmVxdWlyZWQpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ3JlcXVpcmVkJywgc2hhcGUucmVxdWlyZWQpOwogICAgICBwcm9wZXJ0eSh0aGlzLCAnaXNSZXF1aXJlZCcsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICBpZiAoIXJlcXVpcmVkTWFwKSB7CiAgICAgICAgICByZXF1aXJlZE1hcCA9IHt9OwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzaGFwZS5yZXF1aXJlZC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICByZXF1aXJlZE1hcFtzaGFwZS5yZXF1aXJlZFtpXV0gPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAKICAgICAgICByZXR1cm4gcmVxdWlyZWRNYXBbbmFtZV07CiAgICAgIH0sIGZhbHNlLCB0cnVlKTsKICAgIH0KICAKICAgIHByb3BlcnR5KHRoaXMsICdyZXN1bHRXcmFwcGVyJywgc2hhcGUucmVzdWx0V3JhcHBlciB8fCBudWxsKTsKICAKICAgIGlmIChzaGFwZS5wYXlsb2FkKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdwYXlsb2FkJywgc2hhcGUucGF5bG9hZCk7CiAgICB9CiAgCiAgICBpZiAodHlwZW9mIHNoYXBlLnhtbE5hbWVzcGFjZSA9PT0gJ3N0cmluZycpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ3htbE5hbWVzcGFjZVVyaScsIHNoYXBlLnhtbE5hbWVzcGFjZSk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBzaGFwZS54bWxOYW1lc3BhY2UgPT09ICdvYmplY3QnKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd4bWxOYW1lc3BhY2VQcmVmaXgnLCBzaGFwZS54bWxOYW1lc3BhY2UucHJlZml4KTsKICAgICAgcHJvcGVydHkodGhpcywgJ3htbE5hbWVzcGFjZVVyaScsIHNoYXBlLnhtbE5hbWVzcGFjZS51cmkpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBMaXN0U2hhcGUoc2hhcGUsIG9wdGlvbnMpIHsKICAgIHZhciBzZWxmID0gdGhpcywgZmlyc3RJbml0ID0gIXRoaXMuaXNTaGFwZTsKICAgIENvbXBvc2l0ZVNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICBpZiAoZmlyc3RJbml0KSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkZWZhdWx0VmFsdWUnLCBmdW5jdGlvbigpIHsgcmV0dXJuIFtdOyB9KTsKICAgIH0KICAKICAgIGlmIChzaGFwZS5tZW1iZXIpIHsKICAgICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnbWVtYmVyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShzaGFwZS5tZW1iZXIsIG9wdGlvbnMpOwogICAgICB9KTsKICAgIH0KICAKICAgIGlmICh0aGlzLmZsYXR0ZW5lZCkgewogICAgICB2YXIgb2xkTmFtZSA9IHRoaXMubmFtZTsKICAgICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnbmFtZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzZWxmLm1lbWJlci5uYW1lIHx8IG9sZE5hbWU7CiAgICAgIH0pOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBNYXBTaGFwZShzaGFwZSwgb3B0aW9ucykgewogICAgdmFyIGZpcnN0SW5pdCA9ICF0aGlzLmlzU2hhcGU7CiAgICBDb21wb3NpdGVTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgaWYgKGZpcnN0SW5pdCkgewogICAgICBwcm9wZXJ0eSh0aGlzLCAnZGVmYXVsdFZhbHVlJywgZnVuY3Rpb24oKSB7IHJldHVybiB7fTsgfSk7CiAgICAgIHByb3BlcnR5KHRoaXMsICdrZXknLCBTaGFwZS5jcmVhdGUoe3R5cGU6ICdzdHJpbmcnfSwgb3B0aW9ucykpOwogICAgICBwcm9wZXJ0eSh0aGlzLCAndmFsdWUnLCBTaGFwZS5jcmVhdGUoe3R5cGU6ICdzdHJpbmcnfSwgb3B0aW9ucykpOwogICAgfQogIAogICAgaWYgKHNoYXBlLmtleSkgewogICAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdrZXknLCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gU2hhcGUuY3JlYXRlKHNoYXBlLmtleSwgb3B0aW9ucyk7CiAgICAgIH0pOwogICAgfQogICAgaWYgKHNoYXBlLnZhbHVlKSB7CiAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ3ZhbHVlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShzaGFwZS52YWx1ZSwgb3B0aW9ucyk7CiAgICAgIH0pOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBUaW1lc3RhbXBTaGFwZShzaGFwZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAKICAgIGlmIChzaGFwZS50aW1lc3RhbXBGb3JtYXQpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsIHNoYXBlLnRpbWVzdGFtcEZvcm1hdCk7CiAgICB9IGVsc2UgaWYgKHNlbGYuaXNUaW1lc3RhbXBGb3JtYXRTZXQgJiYgdGhpcy50aW1lc3RhbXBGb3JtYXQpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsIHRoaXMudGltZXN0YW1wRm9ybWF0KTsKICAgIH0gZWxzZSBpZiAodGhpcy5sb2NhdGlvbiA9PT0gJ2hlYWRlcicpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsICdyZmM4MjInKTsKICAgIH0gZWxzZSBpZiAodGhpcy5sb2NhdGlvbiA9PT0gJ3F1ZXJ5c3RyaW5nJykgewogICAgICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0JywgJ2lzbzg2MDEnKTsKICAgIH0gZWxzZSBpZiAodGhpcy5hcGkpIHsKICAgICAgc3dpdGNoICh0aGlzLmFwaS5wcm90b2NvbCkgewogICAgICAgIGNhc2UgJ2pzb24nOgogICAgICAgIGNhc2UgJ3Jlc3QtanNvbic6CiAgICAgICAgICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0JywgJ3VuaXhUaW1lc3RhbXAnKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ3Jlc3QteG1sJzoKICAgICAgICBjYXNlICdxdWVyeSc6CiAgICAgICAgY2FzZSAnZWMyJzoKICAgICAgICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCAnaXNvODYwMScpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAKICAgIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgICBpZiAodHlwZW9mIHZhbHVlLnRvVVRDU3RyaW5nID09PSAnZnVuY3Rpb24nKSByZXR1cm4gdmFsdWU7CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgPwogICAgICAgICAgICAgdXRpbC5kYXRlLnBhcnNlVGltZXN0YW1wKHZhbHVlKSA6IG51bGw7CiAgICB9OwogIAogICAgdGhpcy50b1dpcmVGb3JtYXQgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdXRpbC5kYXRlLmZvcm1hdCh2YWx1ZSwgc2VsZi50aW1lc3RhbXBGb3JtYXQpOwogICAgfTsKICB9CiAgCiAgZnVuY3Rpb24gU3RyaW5nU2hhcGUoKSB7CiAgICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgdmFyIG51bGxMZXNzUHJvdG9jb2xzID0gWydyZXN0LXhtbCcsICdxdWVyeScsICdlYzInXTsKICAgIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFsdWUgPSB0aGlzLmFwaSAmJiBudWxsTGVzc1Byb3RvY29scy5pbmRleE9mKHRoaXMuYXBpLnByb3RvY29sKSA+IC0xID8KICAgICAgICB2YWx1ZSB8fCAnJyA6IHZhbHVlOwogICAgICBpZiAodGhpcy5pc0pzb25WYWx1ZSkgewogICAgICAgIHJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKICAgICAgfQogIAogICAgICByZXR1cm4gdmFsdWUgJiYgdHlwZW9mIHZhbHVlLnRvU3RyaW5nID09PSAnZnVuY3Rpb24nID8KICAgICAgICB2YWx1ZS50b1N0cmluZygpIDogdmFsdWU7CiAgICB9OwogIAogICAgdGhpcy50b1dpcmVGb3JtYXQgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdGhpcy5pc0pzb25WYWx1ZSA/IEpTT04uc3RyaW5naWZ5KHZhbHVlKSA6IHZhbHVlOwogICAgfTsKICB9CiAgCiAgZnVuY3Rpb24gRmxvYXRTaGFwZSgpIHsKICAgIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHBhcnNlRmxvYXQodmFsdWUpOwogICAgfTsKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gdGhpcy50b1R5cGU7CiAgfQogIAogIGZ1bmN0aW9uIEludGVnZXJTaGFwZSgpIHsKICAgIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHBhcnNlSW50KHZhbHVlLCAxMCk7CiAgICB9OwogICAgdGhpcy50b1dpcmVGb3JtYXQgPSB0aGlzLnRvVHlwZTsKICB9CiAgCiAgZnVuY3Rpb24gQmluYXJ5U2hhcGUoKSB7CiAgICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICB2YXIgYnVmID0gdXRpbC5iYXNlNjQuZGVjb2RlKHZhbHVlKTsKICAgICAgaWYgKHRoaXMuaXNTZW5zaXRpdmUgJiYgdXRpbC5pc05vZGUoKSAmJiB0eXBlb2YgdXRpbC5CdWZmZXIuYWxsb2MgPT09ICdmdW5jdGlvbicpIHsKICAgIC8qIE5vZGUuanMgY2FuIGNyZWF0ZSBhIEJ1ZmZlciB0aGF0IGlzIG5vdCBpc29sYXRlZC4KICAgICAqIGkuZS4gYnVmLmJ5dGVMZW5ndGggIT09IGJ1Zi5idWZmZXIuYnl0ZUxlbmd0aAogICAgICogVGhpcyBtZWFucyB0aGF0IHRoZSBzZW5zaXRpdmUgZGF0YSBpcyBhY2Nlc3NpYmxlIHRvIGFueW9uZSB3aXRoIGFjY2VzcyB0byBidWYuYnVmZmVyLgogICAgICogSWYgdGhpcyBpcyB0aGUgbm9kZSBzaGFyZWQgQnVmZmVyLCB0aGVuIG90aGVyIGNvZGUgd2l0aGluIHRoaXMgcHJvY2VzcyBfY291bGRfIGZpbmQgdGhpcyBzZWNyZXQuCiAgICAgKiBDb3B5IHNlbnNpdGl2ZSBkYXRhIHRvIGFuIGlzb2xhdGVkIEJ1ZmZlciBhbmQgemVybyB0aGUgc2Vuc2l0aXZlIGRhdGEuCiAgICAgKiBXaGlsZSB0aGlzIGlzIHNhZmUgdG8gZG8gaGVyZSwgY29weWluZyB0aGlzIGNvZGUgc29tZXdoZXJlIGVsc2UgbWF5IHByb2R1Y2UgdW5leHBlY3RlZCByZXN1bHRzLgogICAgICovCiAgICAgICAgdmFyIHNlY3VyZUJ1ZiA9IHV0aWwuQnVmZmVyLmFsbG9jKGJ1Zi5sZW5ndGgsIGJ1Zik7CiAgICAgICAgYnVmLmZpbGwoMCk7CiAgICAgICAgYnVmID0gc2VjdXJlQnVmOwogICAgICB9CiAgICAgIHJldHVybiBidWY7CiAgICB9OwogICAgdGhpcy50b1dpcmVGb3JtYXQgPSB1dGlsLmJhc2U2NC5lbmNvZGU7CiAgfQogIAogIGZ1bmN0aW9uIEJhc2U2NFNoYXBlKCkgewogICAgQmluYXJ5U2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9CiAgCiAgZnVuY3Rpb24gQm9vbGVhblNoYXBlKCkgewogICAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAKICAgIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nKSByZXR1cm4gdmFsdWU7CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHZhbHVlID09PSAndHJ1ZSc7CiAgICB9OwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBTaGFwZS5zaGFwZXMgPSB7CiAgICBTdHJ1Y3R1cmVTaGFwZTogU3RydWN0dXJlU2hhcGUsCiAgICBMaXN0U2hhcGU6IExpc3RTaGFwZSwKICAgIE1hcFNoYXBlOiBNYXBTaGFwZSwKICAgIFN0cmluZ1NoYXBlOiBTdHJpbmdTaGFwZSwKICAgIEJvb2xlYW5TaGFwZTogQm9vbGVhblNoYXBlLAogICAgQmFzZTY0U2hhcGU6IEJhc2U2NFNoYXBlCiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IFNoYXBlOwogIAogIH0seyIuLi91dGlsIjo3MSwiLi9jb2xsZWN0aW9uIjozOX1dLDQ0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlBhcmFtVmFsaWRhdG9yID0gQVdTLnV0aWwuaW5oZXJpdCh7CiAgICAvKioKICAgICAqIENyZWF0ZSBhIG5ldyB2YWxpZGF0b3Igb2JqZWN0LgogICAgICoKICAgICAqIEBwYXJhbSB2YWxpZGF0aW9uIFtCb29sZWFufG1hcF0gd2hldGhlciBpbnB1dCBwYXJhbWV0ZXJzIHNob3VsZCBiZQogICAgICogICAgIHZhbGlkYXRlZCBhZ2FpbnN0IHRoZSBvcGVyYXRpb24gZGVzY3JpcHRpb24gYmVmb3JlIHNlbmRpbmcgdGhlCiAgICAgKiAgICAgcmVxdWVzdC4gUGFzcyBhIG1hcCB0byBlbmFibGUgYW55IG9mIHRoZSBmb2xsb3dpbmcgc3BlY2lmaWMKICAgICAqICAgICB2YWxpZGF0aW9uIGZlYXR1cmVzOgogICAgICoKICAgICAqICAgICAqICoqbWluKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWluCiAgICAgKiAgICAgICBjb25zdHJhaW50LiBUaGlzIGlzIGVuYWJsZWQgYnkgZGVmYXVsdCB3aGVuIHBhcmFtVmFsaWRhdGlvbiBpcyBzZXQKICAgICAqICAgICAgIHRvIGB0cnVlYC4KICAgICAqICAgICAqICoqbWF4KiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWF4CiAgICAgKiAgICAgICBjb25zdHJhaW50LgogICAgICogICAgICogKipwYXR0ZXJuKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBhCiAgICAgKiAgICAgICByZWd1bGFyIGV4cHJlc3Npb24uCiAgICAgKiAgICAgKiAqKmVudW0qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIG9uZQogICAgICogICAgICAgb2YgdGhlIGFsbG93YWJsZSBlbnVtIHZhbHVlcy4KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFBhcmFtVmFsaWRhdG9yKHZhbGlkYXRpb24pIHsKICAgICAgaWYgKHZhbGlkYXRpb24gPT09IHRydWUgfHwgdmFsaWRhdGlvbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdmFsaWRhdGlvbiA9IHsnbWluJzogdHJ1ZX07CiAgICAgIH0KICAgICAgdGhpcy52YWxpZGF0aW9uID0gdmFsaWRhdGlvbjsKICAgIH0sCiAgCiAgICB2YWxpZGF0ZTogZnVuY3Rpb24gdmFsaWRhdGUoc2hhcGUsIHBhcmFtcywgY29udGV4dCkgewogICAgICB0aGlzLmVycm9ycyA9IFtdOwogICAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKHNoYXBlLCBwYXJhbXMgfHwge30sIGNvbnRleHQgfHwgJ3BhcmFtcycpOwogIAogICAgICBpZiAodGhpcy5lcnJvcnMubGVuZ3RoID4gMSkgewogICAgICAgIHZhciBtc2cgPSB0aGlzLmVycm9ycy5qb2luKCdcbiogJyk7CiAgICAgICAgbXNnID0gJ1RoZXJlIHdlcmUgJyArIHRoaXMuZXJyb3JzLmxlbmd0aCArCiAgICAgICAgICAnIHZhbGlkYXRpb24gZXJyb3JzOlxuKiAnICsgbXNnOwogICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcihtc2cpLAogICAgICAgICAge2NvZGU6ICdNdWx0aXBsZVZhbGlkYXRpb25FcnJvcnMnLCBlcnJvcnM6IHRoaXMuZXJyb3JzfSk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5lcnJvcnMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdGhyb3cgdGhpcy5lcnJvcnNbMF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0sCiAgCiAgICBmYWlsOiBmdW5jdGlvbiBmYWlsKGNvZGUsIG1lc3NhZ2UpIHsKICAgICAgdGhpcy5lcnJvcnMucHVzaChBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IobWVzc2FnZSksIHtjb2RlOiBjb2RlfSkpOwogICAgfSwKICAKICAgIHZhbGlkYXRlU3RydWN0dXJlOiBmdW5jdGlvbiB2YWxpZGF0ZVN0cnVjdHVyZShzaGFwZSwgcGFyYW1zLCBjb250ZXh0KSB7CiAgICAgIHRoaXMudmFsaWRhdGVUeXBlKHBhcmFtcywgY29udGV4dCwgWydvYmplY3QnXSwgJ3N0cnVjdHVyZScpOwogIAogICAgICB2YXIgcGFyYW1OYW1lOwogICAgICBmb3IgKHZhciBpID0gMDsgc2hhcGUucmVxdWlyZWQgJiYgaSA8IHNoYXBlLnJlcXVpcmVkLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcGFyYW1OYW1lID0gc2hhcGUucmVxdWlyZWRbaV07CiAgICAgICAgdmFyIHZhbHVlID0gcGFyYW1zW3BhcmFtTmFtZV07CiAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgIHRoaXMuZmFpbCgnTWlzc2luZ1JlcXVpcmVkUGFyYW1ldGVyJywKICAgICAgICAgICAgJ01pc3NpbmcgcmVxdWlyZWQga2V5IFwnJyArIHBhcmFtTmFtZSArICdcJyBpbiAnICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIC8vIHZhbGlkYXRlIGhhc2ggbWVtYmVycwogICAgICBmb3IgKHBhcmFtTmFtZSBpbiBwYXJhbXMpIHsKICAgICAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwYXJhbXMsIHBhcmFtTmFtZSkpIGNvbnRpbnVlOwogIAogICAgICAgIHZhciBwYXJhbVZhbHVlID0gcGFyYW1zW3BhcmFtTmFtZV0sCiAgICAgICAgICAgIG1lbWJlclNoYXBlID0gc2hhcGUubWVtYmVyc1twYXJhbU5hbWVdOwogIAogICAgICAgIGlmIChtZW1iZXJTaGFwZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB2YXIgbWVtYmVyQ29udGV4dCA9IFtjb250ZXh0LCBwYXJhbU5hbWVdLmpvaW4oJy4nKTsKICAgICAgICAgIHRoaXMudmFsaWRhdGVNZW1iZXIobWVtYmVyU2hhcGUsIHBhcmFtVmFsdWUsIG1lbWJlckNvbnRleHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ1VuZXhwZWN0ZWRQYXJhbWV0ZXInLAogICAgICAgICAgICAnVW5leHBlY3RlZCBrZXkgXCcnICsgcGFyYW1OYW1lICsgJ1wnIGZvdW5kIGluICcgKyBjb250ZXh0KTsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogIAogICAgdmFsaWRhdGVNZW1iZXI6IGZ1bmN0aW9uIHZhbGlkYXRlTWVtYmVyKHNoYXBlLCBwYXJhbSwgY29udGV4dCkgewogICAgICBzd2l0Y2ggKHNoYXBlLnR5cGUpIHsKICAgICAgICBjYXNlICdzdHJ1Y3R1cmUnOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVTdHJ1Y3R1cmUoc2hhcGUsIHBhcmFtLCBjb250ZXh0KTsKICAgICAgICBjYXNlICdsaXN0JzoKICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlTGlzdChzaGFwZSwgcGFyYW0sIGNvbnRleHQpOwogICAgICAgIGNhc2UgJ21hcCc6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZU1hcChzaGFwZSwgcGFyYW0sIGNvbnRleHQpOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVNjYWxhcihzaGFwZSwgcGFyYW0sIGNvbnRleHQpOwogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVMaXN0OiBmdW5jdGlvbiB2YWxpZGF0ZUxpc3Qoc2hhcGUsIHBhcmFtcywgY29udGV4dCkgewogICAgICBpZiAodGhpcy52YWxpZGF0ZVR5cGUocGFyYW1zLCBjb250ZXh0LCBbQXJyYXldKSkgewogICAgICAgIHRoaXMudmFsaWRhdGVSYW5nZShzaGFwZSwgcGFyYW1zLmxlbmd0aCwgY29udGV4dCwgJ2xpc3QgbWVtYmVyIGNvdW50Jyk7CiAgICAgICAgLy8gdmFsaWRhdGUgYXJyYXkgbWVtYmVycwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFyYW1zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKHNoYXBlLm1lbWJlciwgcGFyYW1zW2ldLCBjb250ZXh0ICsgJ1snICsgaSArICddJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVNYXA6IGZ1bmN0aW9uIHZhbGlkYXRlTWFwKHNoYXBlLCBwYXJhbXMsIGNvbnRleHQpIHsKICAgICAgaWYgKHRoaXMudmFsaWRhdGVUeXBlKHBhcmFtcywgY29udGV4dCwgWydvYmplY3QnXSwgJ21hcCcpKSB7CiAgICAgICAgLy8gQnVpbGQgdXAgYSBjb3VudCBvZiBtYXAgbWVtYmVycyB0byB2YWxpZGF0ZSByYW5nZSB0cmFpdHMuCiAgICAgICAgdmFyIG1hcENvdW50ID0gMDsKICAgICAgICBmb3IgKHZhciBwYXJhbSBpbiBwYXJhbXMpIHsKICAgICAgICAgIGlmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHBhcmFtcywgcGFyYW0pKSBjb250aW51ZTsKICAgICAgICAgIC8vIFZhbGlkYXRlIGFueSBtYXAga2V5IHRyYWl0IGNvbnN0cmFpbnRzCiAgICAgICAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKHNoYXBlLmtleSwgcGFyYW0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQgKyAnW2tleT1cJycgKyBwYXJhbSArICdcJ10nKTsKICAgICAgICAgIHRoaXMudmFsaWRhdGVNZW1iZXIoc2hhcGUudmFsdWUsIHBhcmFtc1twYXJhbV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQgKyAnW1wnJyArIHBhcmFtICsgJ1wnXScpOwogICAgICAgICAgbWFwQ291bnQrKzsKICAgICAgICB9CiAgICAgICAgdGhpcy52YWxpZGF0ZVJhbmdlKHNoYXBlLCBtYXBDb3VudCwgY29udGV4dCwgJ21hcCBtZW1iZXIgY291bnQnKTsKICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlU2NhbGFyOiBmdW5jdGlvbiB2YWxpZGF0ZVNjYWxhcihzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICAgICAgY2FzZSBudWxsOgogICAgICAgIGNhc2UgdW5kZWZpbmVkOgogICAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVN0cmluZyhzaGFwZSwgdmFsdWUsIGNvbnRleHQpOwogICAgICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlUGF5bG9hZCh2YWx1ZSwgY29udGV4dCk7CiAgICAgICAgY2FzZSAnaW50ZWdlcic6CiAgICAgICAgY2FzZSAnZmxvYXQnOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVOdW1iZXIoc2hhcGUsIHZhbHVlLCBjb250ZXh0KTsKICAgICAgICBjYXNlICdib29sZWFuJzoKICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlVHlwZSh2YWx1ZSwgY29udGV4dCwgWydib29sZWFuJ10pOwogICAgICAgIGNhc2UgJ3RpbWVzdGFtcCc6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVR5cGUodmFsdWUsIGNvbnRleHQsIFtEYXRlLAogICAgICAgICAgICAvXlxkezR9LVxkezJ9LVxkezJ9VFxkezJ9OlxkezJ9OlxkezJ9KFwuXGQrKT9aJC8sICdudW1iZXInXSwKICAgICAgICAgICAgJ0RhdGUgb2JqZWN0LCBJU08tODYwMSBzdHJpbmcsIG9yIGEgVU5JWCB0aW1lc3RhbXAnKTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIHRoaXMuZmFpbCgnVW5rb3duVHlwZScsICdVbmhhbmRsZWQgdHlwZSAnICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcGUudHlwZSArICcgZm9yICcgKyBjb250ZXh0KTsKICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlU3RyaW5nOiBmdW5jdGlvbiB2YWxpZGF0ZVN0cmluZyhzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgdmFyIHZhbGlkVHlwZXMgPSBbJ3N0cmluZyddOwogICAgICBpZiAoc2hhcGUuaXNKc29uVmFsdWUpIHsKICAgICAgICB2YWxpZFR5cGVzID0gdmFsaWRUeXBlcy5jb25jYXQoWydudW1iZXInLCAnb2JqZWN0JywgJ2Jvb2xlYW4nXSk7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlICE9PSBudWxsICYmIHRoaXMudmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCB2YWxpZFR5cGVzKSkgewogICAgICAgIHRoaXMudmFsaWRhdGVFbnVtKHNoYXBlLCB2YWx1ZSwgY29udGV4dCk7CiAgICAgICAgdGhpcy52YWxpZGF0ZVJhbmdlKHNoYXBlLCB2YWx1ZS5sZW5ndGgsIGNvbnRleHQsICdzdHJpbmcgbGVuZ3RoJyk7CiAgICAgICAgdGhpcy52YWxpZGF0ZVBhdHRlcm4oc2hhcGUsIHZhbHVlLCBjb250ZXh0KTsKICAgICAgICB0aGlzLnZhbGlkYXRlVXJpKHNoYXBlLCB2YWx1ZSwgY29udGV4dCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVVyaTogZnVuY3Rpb24gdmFsaWRhdGVVcmkoc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIGlmIChzaGFwZVsnbG9jYXRpb24nXSA9PT0gJ3VyaScpIHsKICAgICAgICBpZiAodmFsdWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ1VyaVBhcmFtZXRlckVycm9yJywgJ0V4cGVjdGVkIHVyaSBwYXJhbWV0ZXIgdG8gaGF2ZSBsZW5ndGggPj0gMSwnCiAgICAgICAgICAgICsgJyBidXQgZm91bmQgIicgKyB2YWx1ZSArJyIgZm9yICcgKyBjb250ZXh0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVBhdHRlcm46IGZ1bmN0aW9uIHZhbGlkYXRlUGF0dGVybihzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgaWYgKHRoaXMudmFsaWRhdGlvblsncGF0dGVybiddICYmIHNoYXBlWydwYXR0ZXJuJ10gIT09IHVuZGVmaW5lZCkgewogICAgICAgIGlmICghKG5ldyBSZWdFeHAoc2hhcGVbJ3BhdHRlcm4nXSkpLnRlc3QodmFsdWUpKSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ1BhdHRlcm5NYXRjaEVycm9yJywgJ1Byb3ZpZGVkIHZhbHVlICInICsgdmFsdWUgKyAnIiAnCiAgICAgICAgICAgICsgJ2RvZXMgbm90IG1hdGNoIHJlZ2V4IHBhdHRlcm4gLycgKyBzaGFwZVsncGF0dGVybiddICsgJy8gZm9yICcKICAgICAgICAgICAgKyBjb250ZXh0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVJhbmdlOiBmdW5jdGlvbiB2YWxpZGF0ZVJhbmdlKHNoYXBlLCB2YWx1ZSwgY29udGV4dCwgZGVzY3JpcHRvcikgewogICAgICBpZiAodGhpcy52YWxpZGF0aW9uWydtaW4nXSkgewogICAgICAgIGlmIChzaGFwZVsnbWluJ10gIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSA8IHNoYXBlWydtaW4nXSkgewogICAgICAgICAgdGhpcy5mYWlsKCdNaW5SYW5nZUVycm9yJywgJ0V4cGVjdGVkICcgKyBkZXNjcmlwdG9yICsgJyA+PSAnCiAgICAgICAgICAgICsgc2hhcGVbJ21pbiddICsgJywgYnV0IGZvdW5kICcgKyB2YWx1ZSArICcgZm9yICcgKyBjb250ZXh0KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHRoaXMudmFsaWRhdGlvblsnbWF4J10pIHsKICAgICAgICBpZiAoc2hhcGVbJ21heCddICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgPiBzaGFwZVsnbWF4J10pIHsKICAgICAgICAgIHRoaXMuZmFpbCgnTWF4UmFuZ2VFcnJvcicsICdFeHBlY3RlZCAnICsgZGVzY3JpcHRvciArICcgPD0gJwogICAgICAgICAgICArIHNoYXBlWydtYXgnXSArICcsIGJ1dCBmb3VuZCAnICsgdmFsdWUgKyAnIGZvciAnICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVFbnVtOiBmdW5jdGlvbiB2YWxpZGF0ZVJhbmdlKHNoYXBlLCB2YWx1ZSwgY29udGV4dCkgewogICAgICBpZiAodGhpcy52YWxpZGF0aW9uWydlbnVtJ10gJiYgc2hhcGVbJ2VudW0nXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgLy8gRmFpbCBpZiB0aGUgc3RyaW5nIHZhbHVlIGlzIG5vdCBwcmVzZW50IGluIHRoZSBlbnVtIGxpc3QKICAgICAgICBpZiAoc2hhcGVbJ2VudW0nXS5pbmRleE9mKHZhbHVlKSA9PT0gLTEpIHsKICAgICAgICAgIHRoaXMuZmFpbCgnRW51bUVycm9yJywgJ0ZvdW5kIHN0cmluZyB2YWx1ZSBvZiAnICsgdmFsdWUgKyAnLCBidXQgJwogICAgICAgICAgICArICdleHBlY3RlZCAnICsgc2hhcGVbJ2VudW0nXS5qb2luKCd8JykgKyAnIGZvciAnICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVUeXBlOiBmdW5jdGlvbiB2YWxpZGF0ZVR5cGUodmFsdWUsIGNvbnRleHQsIGFjY2VwdGVkVHlwZXMsIHR5cGUpIHsKICAgICAgLy8gV2Ugd2lsbCBub3QgbG9nIGFuIGVycm9yIGZvciBudWxsIG9yIHVuZGVmaW5lZCwgYnV0IHdlIHdpbGwgcmV0dXJuCiAgICAgIC8vIGZhbHNlIHNvIHRoYXQgY2FsbGVycyBrbm93IHRoYXQgdGhlIGV4cGVjdGVkIHR5cGUgd2FzIG5vdCBzdHJpY3RseSBtZXQuCiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gZmFsc2U7CiAgCiAgICAgIHZhciBmb3VuZEludmFsaWRUeXBlID0gZmFsc2U7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYWNjZXB0ZWRUeXBlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICh0eXBlb2YgYWNjZXB0ZWRUeXBlc1tpXSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09IGFjY2VwdGVkVHlwZXNbaV0pIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAoYWNjZXB0ZWRUeXBlc1tpXSBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgICAgaWYgKCh2YWx1ZSB8fCAnJykudG9TdHJpbmcoKS5tYXRjaChhY2NlcHRlZFR5cGVzW2ldKSkgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIGFjY2VwdGVkVHlwZXNbaV0pIHJldHVybiB0cnVlOwogICAgICAgICAgaWYgKEFXUy51dGlsLmlzVHlwZSh2YWx1ZSwgYWNjZXB0ZWRUeXBlc1tpXSkpIHJldHVybiB0cnVlOwogICAgICAgICAgaWYgKCF0eXBlICYmICFmb3VuZEludmFsaWRUeXBlKSBhY2NlcHRlZFR5cGVzID0gYWNjZXB0ZWRUeXBlcy5zbGljZSgpOwogICAgICAgICAgYWNjZXB0ZWRUeXBlc1tpXSA9IEFXUy51dGlsLnR5cGVOYW1lKGFjY2VwdGVkVHlwZXNbaV0pOwogICAgICAgIH0KICAgICAgICBmb3VuZEludmFsaWRUeXBlID0gdHJ1ZTsKICAgICAgfQogIAogICAgICB2YXIgYWNjZXB0ZWRUeXBlID0gdHlwZTsKICAgICAgaWYgKCFhY2NlcHRlZFR5cGUpIHsKICAgICAgICBhY2NlcHRlZFR5cGUgPSBhY2NlcHRlZFR5cGVzLmpvaW4oJywgJykucmVwbGFjZSgvLChbXixdKykkLywgJywgb3IkMScpOwogICAgICB9CiAgCiAgICAgIHZhciB2b3dlbCA9IGFjY2VwdGVkVHlwZS5tYXRjaCgvXlthZWlvdV0vaSkgPyAnbicgOiAnJzsKICAgICAgdGhpcy5mYWlsKCdJbnZhbGlkUGFyYW1ldGVyVHlwZScsICdFeHBlY3RlZCAnICsgY29udGV4dCArICcgdG8gYmUgYScgKwogICAgICAgICAgICAgICAgdm93ZWwgKyAnICcgKyBhY2NlcHRlZFR5cGUpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAogIAogICAgdmFsaWRhdGVOdW1iZXI6IGZ1bmN0aW9uIHZhbGlkYXRlTnVtYmVyKHNoYXBlLCB2YWx1ZSwgY29udGV4dCkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgewogICAgICAgIHZhciBjYXN0ZWRWYWx1ZSA9IHBhcnNlRmxvYXQodmFsdWUpOwogICAgICAgIGlmIChjYXN0ZWRWYWx1ZS50b1N0cmluZygpID09PSB2YWx1ZSkgdmFsdWUgPSBjYXN0ZWRWYWx1ZTsKICAgICAgfQogICAgICBpZiAodGhpcy52YWxpZGF0ZVR5cGUodmFsdWUsIGNvbnRleHQsIFsnbnVtYmVyJ10pKSB7CiAgICAgICAgdGhpcy52YWxpZGF0ZVJhbmdlKHNoYXBlLCB2YWx1ZSwgY29udGV4dCwgJ251bWVyaWMgdmFsdWUnKTsKICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlUGF5bG9hZDogZnVuY3Rpb24gdmFsaWRhdGVQYXlsb2FkKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSByZXR1cm47CiAgICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUuYnl0ZUxlbmd0aCA9PT0gJ251bWJlcicpIHJldHVybjsgLy8gdHlwZWQgYXJyYXlzCiAgICAgIGlmIChBV1MudXRpbC5pc05vZGUoKSkgeyAvLyBzcGVjaWFsIGNoZWNrIGZvciBidWZmZXIvc3RyZWFtIGluIE5vZGUuanMKICAgICAgICB2YXIgU3RyZWFtID0gQVdTLnV0aWwuc3RyZWFtLlN0cmVhbTsKICAgICAgICBpZiAoQVdTLnV0aWwuQnVmZmVyLmlzQnVmZmVyKHZhbHVlKSB8fCB2YWx1ZSBpbnN0YW5jZW9mIFN0cmVhbSkgcmV0dXJuOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICh0eXBlb2YgQmxvYiAhPT0gdm9pZCAwICYmIHZhbHVlIGluc3RhbmNlb2YgQmxvYikgcmV0dXJuOwogICAgICB9CiAgCiAgICAgIHZhciB0eXBlcyA9IFsnQnVmZmVyJywgJ1N0cmVhbScsICdGaWxlJywgJ0Jsb2InLCAnQXJyYXlCdWZmZXInLCAnRGF0YVZpZXcnXTsKICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0eXBlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKEFXUy51dGlsLmlzVHlwZSh2YWx1ZSwgdHlwZXNbaV0pKSByZXR1cm47CiAgICAgICAgICBpZiAoQVdTLnV0aWwudHlwZU5hbWUodmFsdWUuY29uc3RydWN0b3IpID09PSB0eXBlc1tpXSkgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQogIAogICAgICB0aGlzLmZhaWwoJ0ludmFsaWRQYXJhbWV0ZXJUeXBlJywgJ0V4cGVjdGVkICcgKyBjb250ZXh0ICsgJyB0byBiZSBhICcgKwogICAgICAgICdzdHJpbmcsIEJ1ZmZlciwgU3RyZWFtLCBCbG9iLCBvciB0eXBlZCBhcnJheSBvYmplY3QnKTsKICAgIH0KICB9KTsKICAKICB9LHsiLi9jb3JlIjoxOH1dLDQ1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9ICByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICAKICAvKioKICAgKiBQcmVwZW5kIHByZWZpeCBkZWZpbmVkIGJ5IEFQSSBtb2RlbCB0byBlbmRwb2ludCB0aGF0J3MgYWxyZWFkeQogICAqIGNvbnN0cnVjdGVkLiBUaGlzIGZlYXR1cmUgZG9lcyBub3QgYXBwbHkgdG8gb3BlcmF0aW9ucyB1c2luZwogICAqIGVuZHBvaW50IGRpc2NvdmVyeSBhbmQgY2FuIGJlIGRpc2FibGVkLgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHBvcHVsYXRlSG9zdFByZWZpeChyZXF1ZXN0KSAgewogICAgdmFyIGVuYWJsZWQgPSByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmhvc3RQcmVmaXhFbmFibGVkOwogICAgaWYgKCFlbmFibGVkKSByZXR1cm4gcmVxdWVzdDsKICAgIHZhciBvcGVyYXRpb25Nb2RlbCA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICAvL2Rvbid0IG1hcnNoYWwgaG9zdCBwcmVmaXggd2hlbiBvcGVyYXRpb24gaGFzIGVuZHBvaW50IGRpc2NvdmVyeSB0cmFpdHMKICAgIGlmIChoYXNFbmRwb2ludERpc2NvdmVyKHJlcXVlc3QpKSByZXR1cm4gcmVxdWVzdDsKICAgIGlmIChvcGVyYXRpb25Nb2RlbC5lbmRwb2ludCAmJiBvcGVyYXRpb25Nb2RlbC5lbmRwb2ludC5ob3N0UHJlZml4KSB7CiAgICAgIHZhciBob3N0UHJlZml4Tm90YXRpb24gPSBvcGVyYXRpb25Nb2RlbC5lbmRwb2ludC5ob3N0UHJlZml4OwogICAgICB2YXIgaG9zdFByZWZpeCA9IGV4cGFuZEhvc3RQcmVmaXgoaG9zdFByZWZpeE5vdGF0aW9uLCByZXF1ZXN0LnBhcmFtcywgb3BlcmF0aW9uTW9kZWwuaW5wdXQpOwogICAgICBwcmVwZW5kRW5kcG9pbnRQcmVmaXgocmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludCwgaG9zdFByZWZpeCk7CiAgICAgIHZhbGlkYXRlSG9zdG5hbWUocmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludC5ob3N0bmFtZSk7CiAgICB9CiAgICByZXR1cm4gcmVxdWVzdDsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gaGFzRW5kcG9pbnREaXNjb3ZlcihyZXF1ZXN0KSB7CiAgICB2YXIgYXBpID0gcmVxdWVzdC5zZXJ2aWNlLmFwaTsKICAgIHZhciBvcGVyYXRpb25Nb2RlbCA9IGFwaS5vcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXTsKICAgIHZhciBpc0VuZHBvaW50T3BlcmF0aW9uID0gYXBpLmVuZHBvaW50T3BlcmF0aW9uICYmIChhcGkuZW5kcG9pbnRPcGVyYXRpb24gPT09IHV0aWwuc3RyaW5nLmxvd2VyRmlyc3Qob3BlcmF0aW9uTW9kZWwubmFtZSkpOwogICAgcmV0dXJuIChvcGVyYXRpb25Nb2RlbC5lbmRwb2ludERpc2NvdmVyeVJlcXVpcmVkICE9PSAnTlVMTCcgfHwgaXNFbmRwb2ludE9wZXJhdGlvbiA9PT0gdHJ1ZSk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGV4cGFuZEhvc3RQcmVmaXgoaG9zdFByZWZpeE5vdGF0aW9uLCBwYXJhbXMsIHNoYXBlKSB7CiAgICB1dGlsLmVhY2goc2hhcGUubWVtYmVycywgZnVuY3Rpb24obmFtZSwgbWVtYmVyKSB7CiAgICAgIGlmIChtZW1iZXIuaG9zdExhYmVsID09PSB0cnVlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBwYXJhbXNbbmFtZV0gIT09ICdzdHJpbmcnIHx8IHBhcmFtc1tuYW1lXSA9PT0gJycpIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICAgICAgbWVzc2FnZTogJ1BhcmFtZXRlciAnICsgbmFtZSArICcgc2hvdWxkIGJlIGEgbm9uLWVtcHR5IHN0cmluZy4nLAogICAgICAgICAgICBjb2RlOiAnSW52YWxpZFBhcmFtZXRlcicKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB2YXIgcmVnZXggPSBuZXcgUmVnRXhwKCdcXHsnICsgbmFtZSArICdcXH0nLCAnZycpOwogICAgICAgIGhvc3RQcmVmaXhOb3RhdGlvbiA9IGhvc3RQcmVmaXhOb3RhdGlvbi5yZXBsYWNlKHJlZ2V4LCBwYXJhbXNbbmFtZV0pOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBob3N0UHJlZml4Tm90YXRpb247CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHByZXBlbmRFbmRwb2ludFByZWZpeChlbmRwb2ludCwgcHJlZml4KSB7CiAgICBpZiAoZW5kcG9pbnQuaG9zdCkgewogICAgICBlbmRwb2ludC5ob3N0ID0gcHJlZml4ICsgZW5kcG9pbnQuaG9zdDsKICAgIH0KICAgIGlmIChlbmRwb2ludC5ob3N0bmFtZSkgewogICAgICBlbmRwb2ludC5ob3N0bmFtZSA9IHByZWZpeCArIGVuZHBvaW50Lmhvc3RuYW1lOwogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiB2YWxpZGF0ZUhvc3RuYW1lKGhvc3RuYW1lKSB7CiAgICB2YXIgbGFiZWxzID0gaG9zdG5hbWUuc3BsaXQoJy4nKTsKICAgIC8vUmVmZXJlbmNlOiBodHRwczovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMTEyMyNzZWN0aW9uLTIKICAgIHZhciBob3N0UGF0dGVybiA9IC9eW2EtekEtWjAtOV17MX0kfF5bYS16QS1aMC05XVthLXpBLVowLTlcLV0qW2EtekEtWjAtOV0kLzsKICAgIHV0aWwuYXJyYXlFYWNoKGxhYmVscywgZnVuY3Rpb24obGFiZWwpIHsKICAgICAgaWYgKCFsYWJlbC5sZW5ndGggfHwgbGFiZWwubGVuZ3RoIDwgMSB8fCBsYWJlbC5sZW5ndGggPiA2MykgewogICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICAgIGNvZGU6ICdWYWxpZGF0aW9uRXJyb3InLAogICAgICAgICAgbWVzc2FnZTogJ0hvc3RuYW1lIGxhYmVsIGxlbmd0aCBzaG91bGQgYmUgYmV0d2VlbiAxIHRvIDYzIGNoYXJhY3RlcnMsIGluY2x1c2l2ZS4nCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKCFob3N0UGF0dGVybi50ZXN0KGxhYmVsKSkgewogICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAge2NvZGU6ICdWYWxpZGF0aW9uRXJyb3InLCBtZXNzYWdlOiBsYWJlbCArICcgaXMgbm90IGhvc3RuYW1lIGNvbXBhdGlibGUuJ30pOwogICAgICB9CiAgICB9KTsKICB9CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBwb3B1bGF0ZUhvc3RQcmVmaXg6IHBvcHVsYXRlSG9zdFByZWZpeAogIH07CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuLi91dGlsIjo3MX1dLDQ2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgSnNvbkJ1aWxkZXIgPSByZXF1aXJlKCcuLi9qc29uL2J1aWxkZXInKTsKICB2YXIgSnNvblBhcnNlciA9IHJlcXVpcmUoJy4uL2pzb24vcGFyc2VyJyk7CiAgdmFyIHBvcHVsYXRlSG9zdFByZWZpeCA9IHJlcXVpcmUoJy4vaGVscGVycycpLnBvcHVsYXRlSG9zdFByZWZpeDsKICAKICBmdW5jdGlvbiBidWlsZFJlcXVlc3QocmVxKSB7CiAgICB2YXIgaHR0cFJlcXVlc3QgPSByZXEuaHR0cFJlcXVlc3Q7CiAgICB2YXIgYXBpID0gcmVxLnNlcnZpY2UuYXBpOwogICAgdmFyIHRhcmdldCA9IGFwaS50YXJnZXRQcmVmaXggKyAnLicgKyBhcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5uYW1lOwogICAgdmFyIHZlcnNpb24gPSBhcGkuanNvblZlcnNpb24gfHwgJzEuMCc7CiAgICB2YXIgaW5wdXQgPSBhcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dDsKICAgIHZhciBidWlsZGVyID0gbmV3IEpzb25CdWlsZGVyKCk7CiAgCiAgICBpZiAodmVyc2lvbiA9PT0gMSkgdmVyc2lvbiA9ICcxLjAnOwogICAgaHR0cFJlcXVlc3QuYm9keSA9IGJ1aWxkZXIuYnVpbGQocmVxLnBhcmFtcyB8fCB7fSwgaW5wdXQpOwogICAgaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ10gPSAnYXBwbGljYXRpb24veC1hbXotanNvbi0nICsgdmVyc2lvbjsKICAgIGh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LVRhcmdldCddID0gdGFyZ2V0OwogIAogICAgcG9wdWxhdGVIb3N0UHJlZml4KHJlcSk7CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3RFcnJvcihyZXNwKSB7CiAgICB2YXIgZXJyb3IgPSB7fTsKICAgIHZhciBodHRwUmVzcG9uc2UgPSByZXNwLmh0dHBSZXNwb25zZTsKICAKICAgIGVycm9yLmNvZGUgPSBodHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXpuLWVycm9ydHlwZSddIHx8ICdVbmtub3duRXJyb3InOwogICAgaWYgKHR5cGVvZiBlcnJvci5jb2RlID09PSAnc3RyaW5nJykgewogICAgICBlcnJvci5jb2RlID0gZXJyb3IuY29kZS5zcGxpdCgnOicpWzBdOwogICAgfQogIAogICAgaWYgKGh0dHBSZXNwb25zZS5ib2R5Lmxlbmd0aCA+IDApIHsKICAgICAgdHJ5IHsKICAgICAgICB2YXIgZSA9IEpTT04ucGFyc2UoaHR0cFJlc3BvbnNlLmJvZHkudG9TdHJpbmcoKSk7CiAgICAgICAgaWYgKGUuX190eXBlIHx8IGUuY29kZSkgewogICAgICAgICAgZXJyb3IuY29kZSA9IChlLl9fdHlwZSB8fCBlLmNvZGUpLnNwbGl0KCcjJykucG9wKCk7CiAgICAgICAgfQogICAgICAgIGlmIChlcnJvci5jb2RlID09PSAnUmVxdWVzdEVudGl0eVRvb0xhcmdlJykgewogICAgICAgICAgZXJyb3IubWVzc2FnZSA9ICdSZXF1ZXN0IGJvZHkgbXVzdCBiZSBsZXNzIHRoYW4gMSBNQic7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVycm9yLm1lc3NhZ2UgPSAoZS5tZXNzYWdlIHx8IGUuTWVzc2FnZSB8fCBudWxsKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBlcnJvci5zdGF0dXNDb2RlID0gaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgICAgZXJyb3IubWVzc2FnZSA9IGh0dHBSZXNwb25zZS5zdGF0dXNNZXNzYWdlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlcnJvci5zdGF0dXNDb2RlID0gaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgIGVycm9yLm1lc3NhZ2UgPSBodHRwUmVzcG9uc2Uuc3RhdHVzQ29kZS50b1N0cmluZygpOwogICAgfQogIAogICAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIGVycm9yKTsKICB9CiAgCiAgZnVuY3Rpb24gZXh0cmFjdERhdGEocmVzcCkgewogICAgdmFyIGJvZHkgPSByZXNwLmh0dHBSZXNwb25zZS5ib2R5LnRvU3RyaW5nKCkgfHwgJ3t9JzsKICAgIGlmIChyZXNwLnJlcXVlc3Quc2VydmljZS5jb25maWcuY29udmVydFJlc3BvbnNlVHlwZXMgPT09IGZhbHNlKSB7CiAgICAgIHJlc3AuZGF0YSA9IEpTT04ucGFyc2UoYm9keSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgb3BlcmF0aW9uID0gcmVzcC5yZXF1ZXN0LnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVzcC5yZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICAgIHZhciBzaGFwZSA9IG9wZXJhdGlvbi5vdXRwdXQgfHwge307CiAgICAgIHZhciBwYXJzZXIgPSBuZXcgSnNvblBhcnNlcigpOwogICAgICByZXNwLmRhdGEgPSBwYXJzZXIucGFyc2UoYm9keSwgc2hhcGUpOwogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIGJ1aWxkUmVxdWVzdDogYnVpbGRSZXF1ZXN0LAogICAgZXh0cmFjdEVycm9yOiBleHRyYWN0RXJyb3IsCiAgICBleHRyYWN0RGF0YTogZXh0cmFjdERhdGEKICB9OwogIAogIH0seyIuLi9qc29uL2J1aWxkZXIiOjM2LCIuLi9qc29uL3BhcnNlciI6MzcsIi4uL3V0aWwiOjcxLCIuL2hlbHBlcnMiOjQ1fV0sNDc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIFF1ZXJ5UGFyYW1TZXJpYWxpemVyID0gcmVxdWlyZSgnLi4vcXVlcnkvcXVlcnlfcGFyYW1fc2VyaWFsaXplcicpOwogIHZhciBTaGFwZSA9IHJlcXVpcmUoJy4uL21vZGVsL3NoYXBlJyk7CiAgdmFyIHBvcHVsYXRlSG9zdFByZWZpeCA9IHJlcXVpcmUoJy4vaGVscGVycycpLnBvcHVsYXRlSG9zdFByZWZpeDsKICAKICBmdW5jdGlvbiBidWlsZFJlcXVlc3QocmVxKSB7CiAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICB2YXIgaHR0cFJlcXVlc3QgPSByZXEuaHR0cFJlcXVlc3Q7CiAgICBodHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXSA9CiAgICAgICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7IGNoYXJzZXQ9dXRmLTgnOwogICAgaHR0cFJlcXVlc3QucGFyYW1zID0gewogICAgICBWZXJzaW9uOiByZXEuc2VydmljZS5hcGkuYXBpVmVyc2lvbiwKICAgICAgQWN0aW9uOiBvcGVyYXRpb24ubmFtZQogICAgfTsKICAKICAgIC8vIGNvbnZlcnQgdGhlIHJlcXVlc3QgcGFyYW1ldGVycyBpbnRvIGEgbGlzdCBvZiBxdWVyeSBwYXJhbXMsCiAgICAvLyBlLmcuIERlZXBseS5OZXN0ZWRQYXJhbS4wLk5hbWU9dmFsdWUKICAgIHZhciBidWlsZGVyID0gbmV3IFF1ZXJ5UGFyYW1TZXJpYWxpemVyKCk7CiAgICBidWlsZGVyLnNlcmlhbGl6ZShyZXEucGFyYW1zLCBvcGVyYXRpb24uaW5wdXQsIGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgIGh0dHBSZXF1ZXN0LnBhcmFtc1tuYW1lXSA9IHZhbHVlOwogICAgfSk7CiAgICBodHRwUmVxdWVzdC5ib2R5ID0gdXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKGh0dHBSZXF1ZXN0LnBhcmFtcyk7CiAgCiAgICBwb3B1bGF0ZUhvc3RQcmVmaXgocmVxKTsKICB9CiAgCiAgZnVuY3Rpb24gZXh0cmFjdEVycm9yKHJlc3ApIHsKICAgIHZhciBkYXRhLCBib2R5ID0gcmVzcC5odHRwUmVzcG9uc2UuYm9keS50b1N0cmluZygpOwogICAgaWYgKGJvZHkubWF0Y2goJzxVbmtub3duT3BlcmF0aW9uRXhjZXB0aW9uJykpIHsKICAgICAgZGF0YSA9IHsKICAgICAgICBDb2RlOiAnVW5rbm93bk9wZXJhdGlvbicsCiAgICAgICAgTWVzc2FnZTogJ1Vua25vd24gb3BlcmF0aW9uICcgKyByZXNwLnJlcXVlc3Qub3BlcmF0aW9uCiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICB0cnkgewogICAgICAgIGRhdGEgPSBuZXcgQVdTLlhNTC5QYXJzZXIoKS5wYXJzZShib2R5KTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGRhdGEgPSB7CiAgICAgICAgICBDb2RlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlLAogICAgICAgICAgTWVzc2FnZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzTWVzc2FnZQogICAgICAgIH07CiAgICAgIH0KICAgIH0KICAKICAgIGlmIChkYXRhLnJlcXVlc3RJZCAmJiAhcmVzcC5yZXF1ZXN0SWQpIHJlc3AucmVxdWVzdElkID0gZGF0YS5yZXF1ZXN0SWQ7CiAgICBpZiAoZGF0YS5FcnJvcnMpIGRhdGEgPSBkYXRhLkVycm9yczsKICAgIGlmIChkYXRhLkVycm9yKSBkYXRhID0gZGF0YS5FcnJvcjsKICAgIGlmIChkYXRhLkNvZGUpIHsKICAgICAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiBkYXRhLkNvZGUsCiAgICAgICAgbWVzc2FnZTogZGF0YS5NZXNzYWdlCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlLAogICAgICAgIG1lc3NhZ2U6IG51bGwKICAgICAgfSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICB2YXIgc2hhcGUgPSBvcGVyYXRpb24ub3V0cHV0IHx8IHt9OwogICAgdmFyIG9yaWdSdWxlcyA9IHNoYXBlOwogIAogICAgaWYgKG9yaWdSdWxlcy5yZXN1bHRXcmFwcGVyKSB7CiAgICAgIHZhciB0bXAgPSBTaGFwZS5jcmVhdGUoe3R5cGU6ICdzdHJ1Y3R1cmUnfSk7CiAgICAgIHRtcC5tZW1iZXJzW29yaWdSdWxlcy5yZXN1bHRXcmFwcGVyXSA9IHNoYXBlOwogICAgICB0bXAubWVtYmVyTmFtZXMgPSBbb3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXJdOwogICAgICB1dGlsLnByb3BlcnR5KHNoYXBlLCAnbmFtZScsIHNoYXBlLnJlc3VsdFdyYXBwZXIpOwogICAgICBzaGFwZSA9IHRtcDsKICAgIH0KICAKICAgIHZhciBwYXJzZXIgPSBuZXcgQVdTLlhNTC5QYXJzZXIoKTsKICAKICAgIC8vIFRPRE86IFJlZmFjdG9yIFhNTCBQYXJzZXIgdG8gcGFyc2UgUmVxdWVzdElkIGZyb20gcmVzcG9uc2UuCiAgICBpZiAoc2hhcGUgJiYgc2hhcGUubWVtYmVycyAmJiAhc2hhcGUubWVtYmVycy5fWEFNWlJlcXVlc3RJZCkgewogICAgICB2YXIgcmVxdWVzdElkU2hhcGUgPSBTaGFwZS5jcmVhdGUoCiAgICAgICAgeyB0eXBlOiAnc3RyaW5nJyB9LAogICAgICAgIHsgYXBpOiB7IHByb3RvY29sOiAncXVlcnknIH0gfSwKICAgICAgICAncmVxdWVzdElkJwogICAgICApOwogICAgICBzaGFwZS5tZW1iZXJzLl9YQU1aUmVxdWVzdElkID0gcmVxdWVzdElkU2hhcGU7CiAgICB9CiAgCiAgICB2YXIgZGF0YSA9IHBhcnNlci5wYXJzZShyZXNwLmh0dHBSZXNwb25zZS5ib2R5LnRvU3RyaW5nKCksIHNoYXBlKTsKICAgIHJlc3AucmVxdWVzdElkID0gZGF0YS5fWEFNWlJlcXVlc3RJZCB8fCBkYXRhLnJlcXVlc3RJZDsKICAKICAgIGlmIChkYXRhLl9YQU1aUmVxdWVzdElkKSBkZWxldGUgZGF0YS5fWEFNWlJlcXVlc3RJZDsKICAKICAgIGlmIChvcmlnUnVsZXMucmVzdWx0V3JhcHBlcikgewogICAgICBpZiAoZGF0YVtvcmlnUnVsZXMucmVzdWx0V3JhcHBlcl0pIHsKICAgICAgICB1dGlsLnVwZGF0ZShkYXRhLCBkYXRhW29yaWdSdWxlcy5yZXN1bHRXcmFwcGVyXSk7CiAgICAgICAgZGVsZXRlIGRhdGFbb3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXJdOwogICAgICB9CiAgICB9CiAgCiAgICByZXNwLmRhdGEgPSBkYXRhOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIGJ1aWxkUmVxdWVzdDogYnVpbGRSZXF1ZXN0LAogICAgZXh0cmFjdEVycm9yOiBleHRyYWN0RXJyb3IsCiAgICBleHRyYWN0RGF0YTogZXh0cmFjdERhdGEKICB9OwogIAogIH0seyIuLi9jb3JlIjoxOCwiLi4vbW9kZWwvc2hhcGUiOjQzLCIuLi9xdWVyeS9xdWVyeV9wYXJhbV9zZXJpYWxpemVyIjo1MSwiLi4vdXRpbCI6NzEsIi4vaGVscGVycyI6NDV9XSw0ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIHBvcHVsYXRlSG9zdFByZWZpeCA9IHJlcXVpcmUoJy4vaGVscGVycycpLnBvcHVsYXRlSG9zdFByZWZpeDsKICAKICBmdW5jdGlvbiBwb3B1bGF0ZU1ldGhvZChyZXEpIHsKICAgIHJlcS5odHRwUmVxdWVzdC5tZXRob2QgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5odHRwTWV0aG9kOwogIH0KICAKICBmdW5jdGlvbiBnZW5lcmF0ZVVSSShlbmRwb2ludFBhdGgsIG9wZXJhdGlvblBhdGgsIGlucHV0LCBwYXJhbXMpIHsKICAgIHZhciB1cmkgPSBbZW5kcG9pbnRQYXRoLCBvcGVyYXRpb25QYXRoXS5qb2luKCcvJyk7CiAgICB1cmkgPSB1cmkucmVwbGFjZSgvXC8rL2csICcvJyk7CiAgCiAgICB2YXIgcXVlcnlTdHJpbmcgPSB7fSwgcXVlcnlTdHJpbmdTZXQgPSBmYWxzZTsKICAgIHV0aWwuZWFjaChpbnB1dC5tZW1iZXJzLCBmdW5jdGlvbiAobmFtZSwgbWVtYmVyKSB7CiAgICAgIHZhciBwYXJhbVZhbHVlID0gcGFyYW1zW25hbWVdOwogICAgICBpZiAocGFyYW1WYWx1ZSA9PT0gbnVsbCB8fCBwYXJhbVZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ3VyaScpIHsKICAgICAgICB2YXIgcmVnZXggPSBuZXcgUmVnRXhwKCdcXHsnICsgbWVtYmVyLm5hbWUgKyAnKFxcKyk/XFx9Jyk7CiAgICAgICAgdXJpID0gdXJpLnJlcGxhY2UocmVnZXgsIGZ1bmN0aW9uKF8sIHBsdXMpIHsKICAgICAgICAgIHZhciBmbiA9IHBsdXMgPyB1dGlsLnVyaUVzY2FwZVBhdGggOiB1dGlsLnVyaUVzY2FwZTsKICAgICAgICAgIHJldHVybiBmbihTdHJpbmcocGFyYW1WYWx1ZSkpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ3F1ZXJ5c3RyaW5nJykgewogICAgICAgIHF1ZXJ5U3RyaW5nU2V0ID0gdHJ1ZTsKICAKICAgICAgICBpZiAobWVtYmVyLnR5cGUgPT09ICdsaXN0JykgewogICAgICAgICAgcXVlcnlTdHJpbmdbbWVtYmVyLm5hbWVdID0gcGFyYW1WYWx1ZS5tYXAoZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgIHJldHVybiB1dGlsLnVyaUVzY2FwZShtZW1iZXIubWVtYmVyLnRvV2lyZUZvcm1hdCh2YWwpLnRvU3RyaW5nKCkpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmIChtZW1iZXIudHlwZSA9PT0gJ21hcCcpIHsKICAgICAgICAgIHV0aWwuZWFjaChwYXJhbVZhbHVlLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgIHF1ZXJ5U3RyaW5nW2tleV0gPSB2YWx1ZS5tYXAoZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXRpbC51cmlFc2NhcGUoU3RyaW5nKHZhbCkpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHF1ZXJ5U3RyaW5nW2tleV0gPSB1dGlsLnVyaUVzY2FwZShTdHJpbmcodmFsdWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHF1ZXJ5U3RyaW5nW21lbWJlci5uYW1lXSA9IHV0aWwudXJpRXNjYXBlKG1lbWJlci50b1dpcmVGb3JtYXQocGFyYW1WYWx1ZSkudG9TdHJpbmcoKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAKICAgIGlmIChxdWVyeVN0cmluZ1NldCkgewogICAgICB1cmkgKz0gKHVyaS5pbmRleE9mKCc/JykgPj0gMCA/ICcmJyA6ICc/Jyk7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICB1dGlsLmFycmF5RWFjaChPYmplY3Qua2V5cyhxdWVyeVN0cmluZykuc29ydCgpLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkocXVlcnlTdHJpbmdba2V5XSkpIHsKICAgICAgICAgIHF1ZXJ5U3RyaW5nW2tleV0gPSBbcXVlcnlTdHJpbmdba2V5XV07CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVlcnlTdHJpbmdba2V5XS5sZW5ndGg7IGkrKykgewogICAgICAgICAgcGFydHMucHVzaCh1dGlsLnVyaUVzY2FwZShTdHJpbmcoa2V5KSkgKyAnPScgKyBxdWVyeVN0cmluZ1trZXldW2ldKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICB1cmkgKz0gcGFydHMuam9pbignJicpOwogICAgfQogIAogICAgcmV0dXJuIHVyaTsKICB9CiAgCiAgZnVuY3Rpb24gcG9wdWxhdGVVUkkocmVxKSB7CiAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICB2YXIgaW5wdXQgPSBvcGVyYXRpb24uaW5wdXQ7CiAgCiAgICB2YXIgdXJpID0gZ2VuZXJhdGVVUkkocmVxLmh0dHBSZXF1ZXN0LmVuZHBvaW50LnBhdGgsIG9wZXJhdGlvbi5odHRwUGF0aCwgaW5wdXQsIHJlcS5wYXJhbXMpOwogICAgcmVxLmh0dHBSZXF1ZXN0LnBhdGggPSB1cmk7CiAgfQogIAogIGZ1bmN0aW9uIHBvcHVsYXRlSGVhZGVycyhyZXEpIHsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHV0aWwuZWFjaChvcGVyYXRpb24uaW5wdXQubWVtYmVycywgZnVuY3Rpb24gKG5hbWUsIG1lbWJlcikgewogICAgICB2YXIgdmFsdWUgPSByZXEucGFyYW1zW25hbWVdOwogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogIAogICAgICBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAnaGVhZGVycycgJiYgbWVtYmVyLnR5cGUgPT09ICdtYXAnKSB7CiAgICAgICAgdXRpbC5lYWNoKHZhbHVlLCBmdW5jdGlvbihrZXksIG1lbWJlclZhbHVlKSB7CiAgICAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1ttZW1iZXIubmFtZSArIGtleV0gPSBtZW1iZXJWYWx1ZTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdoZWFkZXInKSB7CiAgICAgICAgdmFsdWUgPSBtZW1iZXIudG9XaXJlRm9ybWF0KHZhbHVlKS50b1N0cmluZygpOwogICAgICAgIGlmIChtZW1iZXIuaXNKc29uVmFsdWUpIHsKICAgICAgICAgIHZhbHVlID0gdXRpbC5iYXNlNjQuZW5jb2RlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbbWVtYmVyLm5hbWVdID0gdmFsdWU7CiAgICAgIH0KICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBidWlsZFJlcXVlc3QocmVxKSB7CiAgICBwb3B1bGF0ZU1ldGhvZChyZXEpOwogICAgcG9wdWxhdGVVUkkocmVxKTsKICAgIHBvcHVsYXRlSGVhZGVycyhyZXEpOwogICAgcG9wdWxhdGVIb3N0UHJlZml4KHJlcSk7CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3RFcnJvcigpIHsKICB9CiAgCiAgZnVuY3Rpb24gZXh0cmFjdERhdGEocmVzcCkgewogICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgIHZhciBkYXRhID0ge307CiAgICB2YXIgciA9IHJlc3AuaHR0cFJlc3BvbnNlOwogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIG91dHB1dCA9IG9wZXJhdGlvbi5vdXRwdXQ7CiAgCiAgICAvLyBub3JtYWxpemUgaGVhZGVycyBuYW1lcyB0byBsb3dlci1jYXNlZCBrZXlzIGZvciBtYXRjaGluZwogICAgdmFyIGhlYWRlcnMgPSB7fTsKICAgIHV0aWwuZWFjaChyLmhlYWRlcnMsIGZ1bmN0aW9uIChrLCB2KSB7CiAgICAgIGhlYWRlcnNbay50b0xvd2VyQ2FzZSgpXSA9IHY7CiAgICB9KTsKICAKICAgIHV0aWwuZWFjaChvdXRwdXQubWVtYmVycywgZnVuY3Rpb24obmFtZSwgbWVtYmVyKSB7CiAgICAgIHZhciBoZWFkZXIgPSAobWVtYmVyLm5hbWUgfHwgbmFtZSkudG9Mb3dlckNhc2UoKTsKICAgICAgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ2hlYWRlcnMnICYmIG1lbWJlci50eXBlID09PSAnbWFwJykgewogICAgICAgIGRhdGFbbmFtZV0gPSB7fTsKICAgICAgICB2YXIgbG9jYXRpb24gPSBtZW1iZXIuaXNMb2NhdGlvbk5hbWUgPyBtZW1iZXIubmFtZSA6ICcnOwogICAgICAgIHZhciBwYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXicgKyBsb2NhdGlvbiArICcoLispJywgJ2knKTsKICAgICAgICB1dGlsLmVhY2goci5oZWFkZXJzLCBmdW5jdGlvbiAoaywgdikgewogICAgICAgICAgdmFyIHJlc3VsdCA9IGsubWF0Y2gocGF0dGVybik7CiAgICAgICAgICBpZiAocmVzdWx0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIGRhdGFbbmFtZV1bcmVzdWx0WzFdXSA9IHY7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAnaGVhZGVyJykgewogICAgICAgIGlmIChoZWFkZXJzW2hlYWRlcl0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdmFyIHZhbHVlID0gbWVtYmVyLmlzSnNvblZhbHVlID8KICAgICAgICAgICAgdXRpbC5iYXNlNjQuZGVjb2RlKGhlYWRlcnNbaGVhZGVyXSkgOgogICAgICAgICAgICBoZWFkZXJzW2hlYWRlcl07CiAgICAgICAgICBkYXRhW25hbWVdID0gbWVtYmVyLnRvVHlwZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ3N0YXR1c0NvZGUnKSB7CiAgICAgICAgZGF0YVtuYW1lXSA9IHBhcnNlSW50KHIuc3RhdHVzQ29kZSwgMTApOwogICAgICB9CiAgICB9KTsKICAKICAgIHJlc3AuZGF0YSA9IGRhdGE7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgYnVpbGRSZXF1ZXN0OiBidWlsZFJlcXVlc3QsCiAgICBleHRyYWN0RXJyb3I6IGV4dHJhY3RFcnJvciwKICAgIGV4dHJhY3REYXRhOiBleHRyYWN0RGF0YSwKICAgIGdlbmVyYXRlVVJJOiBnZW5lcmF0ZVVSSQogIH07CiAgCiAgfSx7Ii4uL3V0aWwiOjcxLCIuL2hlbHBlcnMiOjQ1fV0sNDk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBSZXN0ID0gcmVxdWlyZSgnLi9yZXN0Jyk7CiAgdmFyIEpzb24gPSByZXF1aXJlKCcuL2pzb24nKTsKICB2YXIgSnNvbkJ1aWxkZXIgPSByZXF1aXJlKCcuLi9qc29uL2J1aWxkZXInKTsKICB2YXIgSnNvblBhcnNlciA9IHJlcXVpcmUoJy4uL2pzb24vcGFyc2VyJyk7CiAgCiAgZnVuY3Rpb24gcG9wdWxhdGVCb2R5KHJlcSkgewogICAgdmFyIGJ1aWxkZXIgPSBuZXcgSnNvbkJ1aWxkZXIoKTsKICAgIHZhciBpbnB1dCA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmlucHV0OwogIAogICAgaWYgKGlucHV0LnBheWxvYWQpIHsKICAgICAgdmFyIHBhcmFtcyA9IHt9OwogICAgICB2YXIgcGF5bG9hZFNoYXBlID0gaW5wdXQubWVtYmVyc1tpbnB1dC5wYXlsb2FkXTsKICAgICAgcGFyYW1zID0gcmVxLnBhcmFtc1tpbnB1dC5wYXlsb2FkXTsKICAgICAgaWYgKHBhcmFtcyA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgCiAgICAgIGlmIChwYXlsb2FkU2hhcGUudHlwZSA9PT0gJ3N0cnVjdHVyZScpIHsKICAgICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IGJ1aWxkZXIuYnVpbGQocGFyYW1zLCBwYXlsb2FkU2hhcGUpOwogICAgICAgIGFwcGx5Q29udGVudFR5cGVIZWFkZXIocmVxKTsKICAgICAgfSBlbHNlIHsgLy8gbm9uLUpTT04gcGF5bG9hZAogICAgICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gcGFyYW1zOwogICAgICAgIGlmIChwYXlsb2FkU2hhcGUudHlwZSA9PT0gJ2JpbmFyeScgfHwgcGF5bG9hZFNoYXBlLmlzU3RyZWFtaW5nKSB7CiAgICAgICAgICBhcHBseUNvbnRlbnRUeXBlSGVhZGVyKHJlcSwgdHJ1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgYm9keSA9IGJ1aWxkZXIuYnVpbGQocmVxLnBhcmFtcywgaW5wdXQpOwogICAgICBpZiAoYm9keSAhPT0gJ3t9JyB8fCByZXEuaHR0cFJlcXVlc3QubWV0aG9kICE9PSAnR0VUJykgeyAvL2Rvbid0IHNlbmQgZW1wdHkgYm9keSBmb3IgR0VUIG1ldGhvZAogICAgICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gYm9keTsKICAgICAgfQogICAgICBhcHBseUNvbnRlbnRUeXBlSGVhZGVyKHJlcSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGFwcGx5Q29udGVudFR5cGVIZWFkZXIocmVxLCBpc0JpbmFyeSkgewogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIGlucHV0ID0gb3BlcmF0aW9uLmlucHV0OwogIAogICAgaWYgKCFyZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ10pIHsKICAgICAgdmFyIHR5cGUgPSBpc0JpbmFyeSA/ICdiaW5hcnkvb2N0ZXQtc3RyZWFtJyA6ICdhcHBsaWNhdGlvbi9qc29uJzsKICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID0gdHlwZTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogICAgUmVzdC5idWlsZFJlcXVlc3QocmVxKTsKICAKICAgIC8vIG5ldmVyIHNlbmQgYm9keSBwYXlsb2FkIG9uIEhFQUQvREVMRVRFCiAgICBpZiAoWydIRUFEJywgJ0RFTEVURSddLmluZGV4T2YocmVxLmh0dHBSZXF1ZXN0Lm1ldGhvZCkgPCAwKSB7CiAgICAgIHBvcHVsYXRlQm9keShyZXEpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RXJyb3IocmVzcCkgewogICAgSnNvbi5leHRyYWN0RXJyb3IocmVzcCk7CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICAgIFJlc3QuZXh0cmFjdERhdGEocmVzcCk7CiAgCiAgICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIHJ1bGVzID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0ub3V0cHV0IHx8IHt9OwogICAgdmFyIHBhcnNlcjsKICAgIHZhciBoYXNFdmVudE91dHB1dCA9IG9wZXJhdGlvbi5oYXNFdmVudE91dHB1dDsKICAKICAgIGlmIChydWxlcy5wYXlsb2FkKSB7CiAgICAgIHZhciBwYXlsb2FkTWVtYmVyID0gcnVsZXMubWVtYmVyc1tydWxlcy5wYXlsb2FkXTsKICAgICAgdmFyIGJvZHkgPSByZXNwLmh0dHBSZXNwb25zZS5ib2R5OwogICAgICBpZiAocGF5bG9hZE1lbWJlci5pc0V2ZW50U3RyZWFtKSB7CiAgICAgICAgcGFyc2VyID0gbmV3IEpzb25QYXJzZXIoKTsKICAgICAgICByZXNwLmRhdGFbcGF5bG9hZF0gPSB1dGlsLmNyZWF0ZUV2ZW50U3RyZWFtKAogICAgICAgICAgQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIgPyByZXNwLmh0dHBSZXNwb25zZS5zdHJlYW0gOiBib2R5LAogICAgICAgICAgcGFyc2VyLAogICAgICAgICAgcGF5bG9hZE1lbWJlcgogICAgICAgICk7CiAgICAgIH0gZWxzZSBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnc3RydWN0dXJlJyB8fCBwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdsaXN0JykgewogICAgICAgIHZhciBwYXJzZXIgPSBuZXcgSnNvblBhcnNlcigpOwogICAgICAgIHJlc3AuZGF0YVtydWxlcy5wYXlsb2FkXSA9IHBhcnNlci5wYXJzZShib2R5LCBwYXlsb2FkTWVtYmVyKTsKICAgICAgfSBlbHNlIGlmIChwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdiaW5hcnknIHx8IHBheWxvYWRNZW1iZXIuaXNTdHJlYW1pbmcpIHsKICAgICAgICByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0gPSBib2R5OwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3AuZGF0YVtydWxlcy5wYXlsb2FkXSA9IHBheWxvYWRNZW1iZXIudG9UeXBlKGJvZHkpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgZGF0YSA9IHJlc3AuZGF0YTsKICAgICAgSnNvbi5leHRyYWN0RGF0YShyZXNwKTsKICAgICAgcmVzcC5kYXRhID0gdXRpbC5tZXJnZShkYXRhLCByZXNwLmRhdGEpOwogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIGJ1aWxkUmVxdWVzdDogYnVpbGRSZXF1ZXN0LAogICAgZXh0cmFjdEVycm9yOiBleHRyYWN0RXJyb3IsCiAgICBleHRyYWN0RGF0YTogZXh0cmFjdERhdGEKICB9OwogIAogIH0seyIuLi9qc29uL2J1aWxkZXIiOjM2LCIuLi9qc29uL3BhcnNlciI6MzcsIi4uL3V0aWwiOjcxLCIuL2pzb24iOjQ2LCIuL3Jlc3QiOjQ4fV0sNTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIFJlc3QgPSByZXF1aXJlKCcuL3Jlc3QnKTsKICAKICBmdW5jdGlvbiBwb3B1bGF0ZUJvZHkocmVxKSB7CiAgICB2YXIgaW5wdXQgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dDsKICAgIHZhciBidWlsZGVyID0gbmV3IEFXUy5YTUwuQnVpbGRlcigpOwogICAgdmFyIHBhcmFtcyA9IHJlcS5wYXJhbXM7CiAgCiAgICB2YXIgcGF5bG9hZCA9IGlucHV0LnBheWxvYWQ7CiAgICBpZiAocGF5bG9hZCkgewogICAgICB2YXIgcGF5bG9hZE1lbWJlciA9IGlucHV0Lm1lbWJlcnNbcGF5bG9hZF07CiAgICAgIHBhcmFtcyA9IHBhcmFtc1twYXlsb2FkXTsKICAgICAgaWYgKHBhcmFtcyA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgCiAgICAgIGlmIChwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgICAgdmFyIHJvb3RFbGVtZW50ID0gcGF5bG9hZE1lbWJlci5uYW1lOwogICAgICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gYnVpbGRlci50b1hNTChwYXJhbXMsIHBheWxvYWRNZW1iZXIsIHJvb3RFbGVtZW50LCB0cnVlKTsKICAgICAgfSBlbHNlIHsgLy8gbm9uLXhtbCBwYXlsb2FkCiAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmJvZHkgPSBwYXJhbXM7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gYnVpbGRlci50b1hNTChwYXJhbXMsIGlucHV0LCBpbnB1dC5uYW1lIHx8CiAgICAgICAgaW5wdXQuc2hhcGUgfHwgdXRpbC5zdHJpbmcudXBwZXJGaXJzdChyZXEub3BlcmF0aW9uKSArICdSZXF1ZXN0Jyk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGJ1aWxkUmVxdWVzdChyZXEpIHsKICAgIFJlc3QuYnVpbGRSZXF1ZXN0KHJlcSk7CiAgCiAgICAvLyBuZXZlciBzZW5kIGJvZHkgcGF5bG9hZCBvbiBHRVQvSEVBRAogICAgaWYgKFsnR0VUJywgJ0hFQUQnXS5pbmRleE9mKHJlcS5odHRwUmVxdWVzdC5tZXRob2QpIDwgMCkgewogICAgICBwb3B1bGF0ZUJvZHkocmVxKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gZXh0cmFjdEVycm9yKHJlc3ApIHsKICAgIFJlc3QuZXh0cmFjdEVycm9yKHJlc3ApOwogIAogICAgdmFyIGRhdGE7CiAgICB0cnkgewogICAgICBkYXRhID0gbmV3IEFXUy5YTUwuUGFyc2VyKCkucGFyc2UocmVzcC5odHRwUmVzcG9uc2UuYm9keS50b1N0cmluZygpKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZGF0YSA9IHsKICAgICAgICBDb2RlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlLAogICAgICAgIE1lc3NhZ2U6IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c01lc3NhZ2UKICAgICAgfTsKICAgIH0KICAKICAgIGlmIChkYXRhLkVycm9ycykgZGF0YSA9IGRhdGEuRXJyb3JzOwogICAgaWYgKGRhdGEuRXJyb3IpIGRhdGEgPSBkYXRhLkVycm9yOwogICAgaWYgKGRhdGEuQ29kZSkgewogICAgICByZXNwLmVycm9yID0gdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgIGNvZGU6IGRhdGEuQ29kZSwKICAgICAgICBtZXNzYWdlOiBkYXRhLk1lc3NhZ2UKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICByZXNwLmVycm9yID0gdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgIGNvZGU6IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUsCiAgICAgICAgbWVzc2FnZTogbnVsbAogICAgICB9KTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gZXh0cmFjdERhdGEocmVzcCkgewogICAgUmVzdC5leHRyYWN0RGF0YShyZXNwKTsKICAKICAgIHZhciBwYXJzZXI7CiAgICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogICAgdmFyIGJvZHkgPSByZXNwLmh0dHBSZXNwb25zZS5ib2R5OwogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIG91dHB1dCA9IG9wZXJhdGlvbi5vdXRwdXQ7CiAgCiAgICB2YXIgaGFzRXZlbnRPdXRwdXQgPSBvcGVyYXRpb24uaGFzRXZlbnRPdXRwdXQ7CiAgCiAgICB2YXIgcGF5bG9hZCA9IG91dHB1dC5wYXlsb2FkOwogICAgaWYgKHBheWxvYWQpIHsKICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBvdXRwdXQubWVtYmVyc1twYXlsb2FkXTsKICAgICAgaWYgKHBheWxvYWRNZW1iZXIuaXNFdmVudFN0cmVhbSkgewogICAgICAgIHBhcnNlciA9IG5ldyBBV1MuWE1MLlBhcnNlcigpOwogICAgICAgIHJlc3AuZGF0YVtwYXlsb2FkXSA9IHV0aWwuY3JlYXRlRXZlbnRTdHJlYW0oCiAgICAgICAgICBBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMiA/IHJlc3AuaHR0cFJlc3BvbnNlLnN0cmVhbSA6IHJlc3AuaHR0cFJlc3BvbnNlLmJvZHksCiAgICAgICAgICBwYXJzZXIsCiAgICAgICAgICBwYXlsb2FkTWVtYmVyCiAgICAgICAgKTsKICAgICAgfSBlbHNlIGlmIChwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgICAgcGFyc2VyID0gbmV3IEFXUy5YTUwuUGFyc2VyKCk7CiAgICAgICAgcmVzcC5kYXRhW3BheWxvYWRdID0gcGFyc2VyLnBhcnNlKGJvZHkudG9TdHJpbmcoKSwgcGF5bG9hZE1lbWJlcik7CiAgICAgIH0gZWxzZSBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnYmluYXJ5JyB8fCBwYXlsb2FkTWVtYmVyLmlzU3RyZWFtaW5nKSB7CiAgICAgICAgcmVzcC5kYXRhW3BheWxvYWRdID0gYm9keTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXNwLmRhdGFbcGF5bG9hZF0gPSBwYXlsb2FkTWVtYmVyLnRvVHlwZShib2R5KTsKICAgICAgfQogICAgfSBlbHNlIGlmIChib2R5Lmxlbmd0aCA+IDApIHsKICAgICAgcGFyc2VyID0gbmV3IEFXUy5YTUwuUGFyc2VyKCk7CiAgICAgIHZhciBkYXRhID0gcGFyc2VyLnBhcnNlKGJvZHkudG9TdHJpbmcoKSwgb3V0cHV0KTsKICAgICAgdXRpbC51cGRhdGUocmVzcC5kYXRhLCBkYXRhKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICAgIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogICAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhCiAgfTsKICAKICB9LHsiLi4vY29yZSI6MTgsIi4uL3V0aWwiOjcxLCIuL3Jlc3QiOjQ4fV0sNTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIAogIGZ1bmN0aW9uIFF1ZXJ5UGFyYW1TZXJpYWxpemVyKCkgewogIH0KICAKICBRdWVyeVBhcmFtU2VyaWFsaXplci5wcm90b3R5cGUuc2VyaWFsaXplID0gZnVuY3Rpb24ocGFyYW1zLCBzaGFwZSwgZm4pIHsKICAgIHNlcmlhbGl6ZVN0cnVjdHVyZSgnJywgcGFyYW1zLCBzaGFwZSwgZm4pOwogIH07CiAgCiAgZnVuY3Rpb24gdWNmaXJzdChzaGFwZSkgewogICAgaWYgKHNoYXBlLmlzUXVlcnlOYW1lIHx8IHNoYXBlLmFwaS5wcm90b2NvbCAhPT0gJ2VjMicpIHsKICAgICAgcmV0dXJuIHNoYXBlLm5hbWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gc2hhcGUubmFtZVswXS50b1VwcGVyQ2FzZSgpICsgc2hhcGUubmFtZS5zdWJzdHIoMSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZVN0cnVjdHVyZShwcmVmaXgsIHN0cnVjdCwgcnVsZXMsIGZuKSB7CiAgICB1dGlsLmVhY2gocnVsZXMubWVtYmVycywgZnVuY3Rpb24obmFtZSwgbWVtYmVyKSB7CiAgICAgIHZhciB2YWx1ZSA9IHN0cnVjdFtuYW1lXTsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAKICAgICAgdmFyIG1lbWJlck5hbWUgPSB1Y2ZpcnN0KG1lbWJlcik7CiAgICAgIG1lbWJlck5hbWUgPSBwcmVmaXggPyBwcmVmaXggKyAnLicgKyBtZW1iZXJOYW1lIDogbWVtYmVyTmFtZTsKICAgICAgc2VyaWFsaXplTWVtYmVyKG1lbWJlck5hbWUsIHZhbHVlLCBtZW1iZXIsIGZuKTsKICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVNYXAobmFtZSwgbWFwLCBydWxlcywgZm4pIHsKICAgIHZhciBpID0gMTsKICAgIHV0aWwuZWFjaChtYXAsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgIHZhciBwcmVmaXggPSBydWxlcy5mbGF0dGVuZWQgPyAnLicgOiAnLmVudHJ5Lic7CiAgICAgIHZhciBwb3NpdGlvbiA9IHByZWZpeCArIChpKyspICsgJy4nOwogICAgICB2YXIga2V5TmFtZSA9IHBvc2l0aW9uICsgKHJ1bGVzLmtleS5uYW1lIHx8ICdrZXknKTsKICAgICAgdmFyIHZhbHVlTmFtZSA9IHBvc2l0aW9uICsgKHJ1bGVzLnZhbHVlLm5hbWUgfHwgJ3ZhbHVlJyk7CiAgICAgIHNlcmlhbGl6ZU1lbWJlcihuYW1lICsga2V5TmFtZSwga2V5LCBydWxlcy5rZXksIGZuKTsKICAgICAgc2VyaWFsaXplTWVtYmVyKG5hbWUgKyB2YWx1ZU5hbWUsIHZhbHVlLCBydWxlcy52YWx1ZSwgZm4pOwogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZUxpc3QobmFtZSwgbGlzdCwgcnVsZXMsIGZuKSB7CiAgICB2YXIgbWVtYmVyUnVsZXMgPSBydWxlcy5tZW1iZXIgfHwge307CiAgCiAgICBpZiAobGlzdC5sZW5ndGggPT09IDApIHsKICAgICAgZm4uY2FsbCh0aGlzLCBuYW1lLCBudWxsKTsKICAgICAgcmV0dXJuOwogICAgfQogIAogICAgdXRpbC5hcnJheUVhY2gobGlzdCwgZnVuY3Rpb24gKHYsIG4pIHsKICAgICAgdmFyIHN1ZmZpeCA9ICcuJyArIChuICsgMSk7CiAgICAgIGlmIChydWxlcy5hcGkucHJvdG9jb2wgPT09ICdlYzInKSB7CiAgICAgICAgLy8gRG8gbm90aGluZyBmb3IgRUMyCiAgICAgICAgc3VmZml4ID0gc3VmZml4ICsgJyc7IC8vIG1ha2UgbGludGVyIGhhcHB5CiAgICAgIH0gZWxzZSBpZiAocnVsZXMuZmxhdHRlbmVkKSB7CiAgICAgICAgaWYgKG1lbWJlclJ1bGVzLm5hbWUpIHsKICAgICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJy4nKTsKICAgICAgICAgIHBhcnRzLnBvcCgpOwogICAgICAgICAgcGFydHMucHVzaCh1Y2ZpcnN0KG1lbWJlclJ1bGVzKSk7CiAgICAgICAgICBuYW1lID0gcGFydHMuam9pbignLicpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzdWZmaXggPSAnLicgKyAobWVtYmVyUnVsZXMubmFtZSA/IG1lbWJlclJ1bGVzLm5hbWUgOiAnbWVtYmVyJykgKyBzdWZmaXg7CiAgICAgIH0KICAgICAgc2VyaWFsaXplTWVtYmVyKG5hbWUgKyBzdWZmaXgsIHYsIG1lbWJlclJ1bGVzLCBmbik7CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplTWVtYmVyKG5hbWUsIHZhbHVlLCBydWxlcywgZm4pIHsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICBpZiAocnVsZXMudHlwZSA9PT0gJ3N0cnVjdHVyZScpIHsKICAgICAgc2VyaWFsaXplU3RydWN0dXJlKG5hbWUsIHZhbHVlLCBydWxlcywgZm4pOwogICAgfSBlbHNlIGlmIChydWxlcy50eXBlID09PSAnbGlzdCcpIHsKICAgICAgc2VyaWFsaXplTGlzdChuYW1lLCB2YWx1ZSwgcnVsZXMsIGZuKTsKICAgIH0gZWxzZSBpZiAocnVsZXMudHlwZSA9PT0gJ21hcCcpIHsKICAgICAgc2VyaWFsaXplTWFwKG5hbWUsIHZhbHVlLCBydWxlcywgZm4pOwogICAgfSBlbHNlIHsKICAgICAgZm4obmFtZSwgcnVsZXMudG9XaXJlRm9ybWF0KHZhbHVlKS50b1N0cmluZygpKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBRdWVyeVBhcmFtU2VyaWFsaXplcjsKICAKICB9LHsiLi4vdXRpbCI6NzF9XSw1MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAvL3Byb3ZpZGUgcmVhbHRpbWUgY2xvY2sgZm9yIHBlcmZvcm1hbmNlIG1lYXN1cmVtZW50CiAgICBub3c6IGZ1bmN0aW9uIG5vdygpIHsKICAgICAgaWYgKHR5cGVvZiBwZXJmb3JtYW5jZSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIHBlcmZvcm1hbmNlLm5vdyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJldHVybiBwZXJmb3JtYW5jZS5ub3coKTsKICAgICAgfQogICAgICByZXR1cm4gRGF0ZS5ub3coKTsKICAgIH0KICB9OwogIAogIH0se31dLDUzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4vdXRpbCcpOwogIHZhciByZWdpb25Db25maWcgPSByZXF1aXJlKCcuL3JlZ2lvbl9jb25maWdfZGF0YS5qc29uJyk7CiAgCiAgZnVuY3Rpb24gZ2VuZXJhdGVSZWdpb25QcmVmaXgocmVnaW9uKSB7CiAgICBpZiAoIXJlZ2lvbikgcmV0dXJuIG51bGw7CiAgCiAgICB2YXIgcGFydHMgPSByZWdpb24uc3BsaXQoJy0nKTsKICAgIGlmIChwYXJ0cy5sZW5ndGggPCAzKSByZXR1cm4gbnVsbDsKICAgIHJldHVybiBwYXJ0cy5zbGljZSgwLCBwYXJ0cy5sZW5ndGggLSAyKS5qb2luKCctJykgKyAnLSonOwogIH0KICAKICBmdW5jdGlvbiBkZXJpdmVkS2V5cyhzZXJ2aWNlKSB7CiAgICB2YXIgcmVnaW9uID0gc2VydmljZS5jb25maWcucmVnaW9uOwogICAgdmFyIHJlZ2lvblByZWZpeCA9IGdlbmVyYXRlUmVnaW9uUHJlZml4KHJlZ2lvbik7CiAgICB2YXIgZW5kcG9pbnRQcmVmaXggPSBzZXJ2aWNlLmFwaS5lbmRwb2ludFByZWZpeDsKICAKICAgIHJldHVybiBbCiAgICAgIFtyZWdpb24sIGVuZHBvaW50UHJlZml4XSwKICAgICAgW3JlZ2lvblByZWZpeCwgZW5kcG9pbnRQcmVmaXhdLAogICAgICBbcmVnaW9uLCAnKiddLAogICAgICBbcmVnaW9uUHJlZml4LCAnKiddLAogICAgICBbJyonLCBlbmRwb2ludFByZWZpeF0sCiAgICAgIFsnKicsICcqJ10KICAgIF0ubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgcmV0dXJuIGl0ZW1bMF0gJiYgaXRlbVsxXSA/IGl0ZW0uam9pbignLycpIDogbnVsbDsKICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBhcHBseUNvbmZpZyhzZXJ2aWNlLCBjb25maWcpIHsKICAgIHV0aWwuZWFjaChjb25maWcsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgaWYgKGtleSA9PT0gJ2dsb2JhbEVuZHBvaW50JykgcmV0dXJuOwogICAgICBpZiAoc2VydmljZS5jb25maWdba2V5XSA9PT0gdW5kZWZpbmVkIHx8IHNlcnZpY2UuY29uZmlnW2tleV0gPT09IG51bGwpIHsKICAgICAgICBzZXJ2aWNlLmNvbmZpZ1trZXldID0gdmFsdWU7CiAgICAgIH0KICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBjb25maWd1cmVFbmRwb2ludChzZXJ2aWNlKSB7CiAgICB2YXIga2V5cyA9IGRlcml2ZWRLZXlzKHNlcnZpY2UpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICBpZiAoIWtleSkgY29udGludWU7CiAgCiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocmVnaW9uQ29uZmlnLnJ1bGVzLCBrZXkpKSB7CiAgICAgICAgdmFyIGNvbmZpZyA9IHJlZ2lvbkNvbmZpZy5ydWxlc1trZXldOwogICAgICAgIGlmICh0eXBlb2YgY29uZmlnID09PSAnc3RyaW5nJykgewogICAgICAgICAgY29uZmlnID0gcmVnaW9uQ29uZmlnLnBhdHRlcm5zW2NvbmZpZ107CiAgICAgICAgfQogIAogICAgICAgIC8vIHNldCBkdWFsc3RhY2sgZW5kcG9pbnQKICAgICAgICBpZiAoc2VydmljZS5jb25maWcudXNlRHVhbHN0YWNrICYmIHV0aWwuaXNEdWFsc3RhY2tBdmFpbGFibGUoc2VydmljZSkpIHsKICAgICAgICAgIGNvbmZpZyA9IHV0aWwuY29weShjb25maWcpOwogICAgICAgICAgY29uZmlnLmVuZHBvaW50ID0gJ3tzZXJ2aWNlfS5kdWFsc3RhY2sue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSc7CiAgICAgICAgfQogIAogICAgICAgIC8vIHNldCBnbG9iYWwgZW5kcG9pbnQKICAgICAgICBzZXJ2aWNlLmlzR2xvYmFsRW5kcG9pbnQgPSAhIWNvbmZpZy5nbG9iYWxFbmRwb2ludDsKICAKICAgICAgICAvLyBzaWduYXR1cmUgdmVyc2lvbgogICAgICAgIGlmICghY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIGNvbmZpZy5zaWduYXR1cmVWZXJzaW9uID0gJ3Y0JzsKICAKICAgICAgICAvLyBtZXJnZSBjb25maWcKICAgICAgICBhcHBseUNvbmZpZyhzZXJ2aWNlLCBjb25maWcpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IGNvbmZpZ3VyZUVuZHBvaW50OwogIAogIH0seyIuL3JlZ2lvbl9jb25maWdfZGF0YS5qc29uIjo1NCwiLi91dGlsIjo3MX1dLDU0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBtb2R1bGUuZXhwb3J0cz17CiAgICAicnVsZXMiOiB7CiAgICAgICIqLyoiOiB7CiAgICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hbWF6b25hd3MuY29tIgogICAgICB9LAogICAgICAiY24tKi8qIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbS5jbiIKICAgICAgfSwKICAgICAgIiovYnVkZ2V0cyI6ICJnbG9iYWxTU0wiLAogICAgICAiKi9jbG91ZGZyb250IjogImdsb2JhbFNTTCIsCiAgICAgICIqL2lhbSI6ICJnbG9iYWxTU0wiLAogICAgICAiKi9zdHMiOiAiZ2xvYmFsU1NMIiwKICAgICAgIiovaW1wb3J0ZXhwb3J0IjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0uYW1hem9uYXdzLmNvbSIsCiAgICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAidjIiLAogICAgICAgICJnbG9iYWxFbmRwb2ludCI6IHRydWUKICAgICAgfSwKICAgICAgIiovcm91dGU1MyI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAiaHR0cHM6Ly97c2VydmljZX0uYW1hem9uYXdzLmNvbSIsCiAgICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAidjNodHRwcyIsCiAgICAgICAgImdsb2JhbEVuZHBvaW50IjogdHJ1ZQogICAgICB9LAogICAgICAiKi93YWYiOiAiZ2xvYmFsU1NMIiwKICAgICAgInVzLWdvdi0qL2lhbSI6ICJnbG9iYWxHb3ZDbG91ZCIsCiAgICAgICJ1cy1nb3YtKi9zdHMiOiB7CiAgICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hbWF6b25hd3MuY29tIgogICAgICB9LAogICAgICAidXMtZ292LXdlc3QtMS9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAgICJ1cy13ZXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAidXMtd2VzdC0yL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICAgImV1LXdlc3QtMS9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAgICJhcC1zb3V0aGVhc3QtMS9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAgICJhcC1zb3V0aGVhc3QtMi9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAgICJhcC1ub3J0aGVhc3QtMS9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAgICJzYS1lYXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAidXMtZWFzdC0xL3MzIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0uYW1hem9uYXdzLmNvbSIsCiAgICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAiczMiCiAgICAgIH0sCiAgICAgICJ1cy1lYXN0LTEvc2RiIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0uYW1hem9uYXdzLmNvbSIsCiAgICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAidjIiCiAgICAgIH0sCiAgICAgICIqL3NkYiI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInYyIgogICAgICB9CiAgICB9LAogIAogICAgInBhdHRlcm5zIjogewogICAgICAiZ2xvYmFsU1NMIjogewogICAgICAgICJlbmRwb2ludCI6ICJodHRwczovL3tzZXJ2aWNlfS5hbWF6b25hd3MuY29tIiwKICAgICAgICAiZ2xvYmFsRW5kcG9pbnQiOiB0cnVlCiAgICAgIH0sCiAgICAgICJnbG9iYWxHb3ZDbG91ZCI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LnVzLWdvdi5hbWF6b25hd3MuY29tIgogICAgICB9LAogICAgICAiczNzaWduYXR1cmUiOiB7CiAgICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hbWF6b25hd3MuY29tIiwKICAgICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJzMyIKICAgICAgfQogICAgfQogIH0KICAKICB9LHt9XSw1NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChwcm9jZXNzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgdmFyIEFjY2VwdG9yU3RhdGVNYWNoaW5lID0gcmVxdWlyZSgnLi9zdGF0ZV9tYWNoaW5lJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIHZhciBkb21haW4gPSBBV1MudXRpbC5kb21haW47CiAgdmFyIGptZXNwYXRoID0gcmVxdWlyZSgnam1lc3BhdGgnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgaGFyZEVycm9yU3RhdGVzID0ge3N1Y2Nlc3M6IDEsIGVycm9yOiAxLCBjb21wbGV0ZTogMX07CiAgCiAgZnVuY3Rpb24gaXNUZXJtaW5hbFN0YXRlKG1hY2hpbmUpIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoaGFyZEVycm9yU3RhdGVzLCBtYWNoaW5lLl9hc20uY3VycmVudFN0YXRlKTsKICB9CiAgCiAgdmFyIGZzbSA9IG5ldyBBY2NlcHRvclN0YXRlTWFjaGluZSgpOwogIGZzbS5zZXR1cFN0YXRlcyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHRyYW5zaXRpb24gPSBmdW5jdGlvbihfLCBkb25lKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgc2VsZi5faGFsdEhhbmRsZXJzT25FcnJvciA9IGZhbHNlOwogIAogICAgICBzZWxmLmVtaXQoc2VsZi5fYXNtLmN1cnJlbnRTdGF0ZSwgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgaWYgKGlzVGVybWluYWxTdGF0ZShzZWxmKSkgewogICAgICAgICAgICBpZiAoZG9tYWluICYmIHNlbGYuZG9tYWluIGluc3RhbmNlb2YgZG9tYWluLkRvbWFpbikgewogICAgICAgICAgICAgIGVyci5kb21haW5FbWl0dGVyID0gc2VsZjsKICAgICAgICAgICAgICBlcnIuZG9tYWluID0gc2VsZi5kb21haW47CiAgICAgICAgICAgICAgZXJyLmRvbWFpblRocm93biA9IGZhbHNlOwogICAgICAgICAgICAgIHNlbGYuZG9tYWluLmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGYucmVzcG9uc2UuZXJyb3IgPSBlcnI7CiAgICAgICAgICAgIGRvbmUoZXJyKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZG9uZShzZWxmLnJlc3BvbnNlLmVycm9yKTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgfTsKICAKICAgIHRoaXMuYWRkU3RhdGUoJ3ZhbGlkYXRlJywgJ2J1aWxkJywgJ2Vycm9yJywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdidWlsZCcsICdhZnRlckJ1aWxkJywgJ3Jlc3RhcnQnLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ2FmdGVyQnVpbGQnLCAnc2lnbicsICdyZXN0YXJ0JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdzaWduJywgJ3NlbmQnLCAncmV0cnknLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ3JldHJ5JywgJ2FmdGVyUmV0cnknLCAnYWZ0ZXJSZXRyeScsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnYWZ0ZXJSZXRyeScsICdzaWduJywgJ2Vycm9yJywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdzZW5kJywgJ3ZhbGlkYXRlUmVzcG9uc2UnLCAncmV0cnknLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ3ZhbGlkYXRlUmVzcG9uc2UnLCAnZXh0cmFjdERhdGEnLCAnZXh0cmFjdEVycm9yJywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdleHRyYWN0RXJyb3InLCAnZXh0cmFjdERhdGEnLCAncmV0cnknLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ2V4dHJhY3REYXRhJywgJ3N1Y2Nlc3MnLCAncmV0cnknLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ3Jlc3RhcnQnLCAnYnVpbGQnLCAnZXJyb3InLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ3N1Y2Nlc3MnLCAnY29tcGxldGUnLCAnY29tcGxldGUnLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ2Vycm9yJywgJ2NvbXBsZXRlJywgJ2NvbXBsZXRlJywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdjb21wbGV0ZScsIG51bGwsIG51bGwsIHRyYW5zaXRpb24pOwogIH07CiAgZnNtLnNldHVwU3RhdGVzKCk7CiAgCiAgLyoqCiAgICogIyMgQXN5bmNocm9ub3VzIFJlcXVlc3RzCiAgICoKICAgKiBBbGwgcmVxdWVzdHMgbWFkZSB0aHJvdWdoIHRoZSBTREsgYXJlIGFzeW5jaHJvbm91cyBhbmQgdXNlIGEKICAgKiBjYWxsYmFjayBpbnRlcmZhY2UuIEVhY2ggc2VydmljZSBtZXRob2QgdGhhdCBraWNrcyBvZmYgYSByZXF1ZXN0CiAgICogcmV0dXJucyBhbiBgQVdTLlJlcXVlc3RgIG9iamVjdCB0aGF0IHlvdSBjYW4gdXNlIHRvIHJlZ2lzdGVyCiAgICogY2FsbGJhY2tzLgogICAqCiAgICogRm9yIGV4YW1wbGUsIHRoZSBmb2xsb3dpbmcgc2VydmljZSBtZXRob2QgcmV0dXJucyB0aGUgcmVxdWVzdAogICAqIG9iamVjdCBhcyAicmVxdWVzdCIsIHdoaWNoIGNhbiBiZSB1c2VkIHRvIHJlZ2lzdGVyIGNhbGxiYWNrczoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiAvLyByZXF1ZXN0IGlzIGFuIEFXUy5SZXF1ZXN0IG9iamVjdAogICAqIHZhciByZXF1ZXN0ID0gZWMyLmRlc2NyaWJlSW5zdGFuY2VzKCk7CiAgICoKICAgKiAvLyByZWdpc3RlciBjYWxsYmFja3Mgb24gcmVxdWVzdCB0byByZXRyaWV2ZSByZXNwb25zZSBkYXRhCiAgICogcmVxdWVzdC5vbignc3VjY2VzcycsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICogICBjb25zb2xlLmxvZyhyZXNwb25zZS5kYXRhKTsKICAgKiB9KTsKICAgKiBgYGAKICAgKgogICAqIFdoZW4gYSByZXF1ZXN0IGlzIHJlYWR5IHRvIGJlIHNlbnQsIHRoZSB7c2VuZH0gbWV0aG9kIHNob3VsZAogICAqIGJlIGNhbGxlZDoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiByZXF1ZXN0LnNlbmQoKTsKICAgKiBgYGAKICAgKgogICAqIFNpbmNlIHJlZ2lzdGVyZWQgY2FsbGJhY2tzIG1heSBvciBtYXkgbm90IGJlIGlkZW1wb3RlbnQsIHJlcXVlc3RzIHNob3VsZCBvbmx5CiAgICogYmUgc2VudCBvbmNlLiBUbyBwZXJmb3JtIHRoZSBzYW1lIG9wZXJhdGlvbiBtdWx0aXBsZSB0aW1lcywgeW91IHdpbGwgbmVlZCB0bwogICAqIGNyZWF0ZSBtdWx0aXBsZSByZXF1ZXN0IG9iamVjdHMsIGVhY2ggd2l0aCBpdHMgb3duIHJlZ2lzdGVyZWQgY2FsbGJhY2tzLgogICAqCiAgICogIyMgUmVtb3ZpbmcgRGVmYXVsdCBMaXN0ZW5lcnMgZm9yIEV2ZW50cwogICAqCiAgICogUmVxdWVzdCBvYmplY3RzIGFyZSBidWlsdCB3aXRoIGRlZmF1bHQgbGlzdGVuZXJzIGZvciB0aGUgdmFyaW91cyBldmVudHMsCiAgICogZGVwZW5kaW5nIG9uIHRoZSBzZXJ2aWNlIHR5cGUuIEluIHNvbWUgY2FzZXMsIHlvdSBtYXkgd2FudCB0byByZW1vdmUKICAgKiBzb21lIGJ1aWx0LWluIGxpc3RlbmVycyB0byBjdXN0b21pemUgYmVoYXZpb3VyLiBEb2luZyB0aGlzIHJlcXVpcmVzCiAgICogYWNjZXNzIHRvIHRoZSBidWlsdC1pbiBsaXN0ZW5lciBmdW5jdGlvbnMsIHdoaWNoIGFyZSBleHBvc2VkIHRocm91Z2gKICAgKiB0aGUge0FXUy5FdmVudExpc3RlbmVycy5Db3JlfSBuYW1lc3BhY2UuIEZvciBpbnN0YW5jZSwgeW91IG1heQogICAqIHdhbnQgdG8gY3VzdG9taXplIHRoZSBIVFRQIGhhbmRsZXIgdXNlZCB3aGVuIHNlbmRpbmcgYSByZXF1ZXN0LiBJbiB0aGlzCiAgICogY2FzZSwgeW91IGNhbiByZW1vdmUgdGhlIGJ1aWx0LWluIGxpc3RlbmVyIGFzc29jaWF0ZWQgd2l0aCB0aGUgJ3NlbmQnCiAgICogZXZlbnQsIHRoZSB7QVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuU0VORH0gbGlzdGVuZXIgYW5kIGFkZCB5b3VyIG93bi4KICAgKgogICAqICMjIE11bHRpcGxlIENhbGxiYWNrcyBhbmQgQ2hhaW5pbmcKICAgKgogICAqIFlvdSBjYW4gcmVnaXN0ZXIgbXVsdGlwbGUgY2FsbGJhY2tzIG9uIGFueSByZXF1ZXN0IG9iamVjdC4gVGhlCiAgICogY2FsbGJhY2tzIGNhbiBiZSByZWdpc3RlcmVkIGZvciBkaWZmZXJlbnQgZXZlbnRzLCBvciBhbGwgZm9yIHRoZQogICAqIHNhbWUgZXZlbnQuIEluIGFkZGl0aW9uLCB5b3UgY2FuIGNoYWluIGNhbGxiYWNrIHJlZ2lzdHJhdGlvbiwgZm9yCiAgICogZXhhbXBsZToKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiByZXF1ZXN0LgogICAqICAgb24oJ3N1Y2Nlc3MnLCBmdW5jdGlvbihyZXNwb25zZSkgewogICAqICAgICBjb25zb2xlLmxvZygiU3VjY2VzcyEiKTsKICAgKiAgIH0pLgogICAqICAgb24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyb3IsIHJlc3BvbnNlKSB7CiAgICogICAgIGNvbnNvbGUubG9nKCJFcnJvciEiKTsKICAgKiAgIH0pLgogICAqICAgb24oJ2NvbXBsZXRlJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgKiAgICAgY29uc29sZS5sb2coIkFsd2F5cyEiKTsKICAgKiAgIH0pLgogICAqICAgc2VuZCgpOwogICAqIGBgYAogICAqCiAgICogVGhlIGFib3ZlIGV4YW1wbGUgd2lsbCBwcmludCBlaXRoZXIgIlN1Y2Nlc3MhIEFsd2F5cyEiLCBvciAiRXJyb3IhIEFsd2F5cyEiLAogICAqIGRlcGVuZGluZyBvbiB3aGV0aGVyIHRoZSByZXF1ZXN0IHN1Y2NlZWRlZCBvciBub3QuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBodHRwUmVxdWVzdAogICAqICAgQHJlYWRvbmx5CiAgICogICBAIWdyb3VwIEhUVFAgUHJvcGVydGllcwogICAqICAgQHJldHVybiBbQVdTLkh0dHBSZXF1ZXN0XSB0aGUgcmF3IEhUVFAgcmVxdWVzdCBvYmplY3QKICAgKiAgICAgY29udGFpbmluZyByZXF1ZXN0IGhlYWRlcnMgYW5kIGJvZHkgaW5mb3JtYXRpb24KICAgKiAgICAgc2VudCBieSB0aGUgc2VydmljZS4KICAgKgogICAqIEAhYXR0cmlidXRlIHN0YXJ0VGltZQogICAqICAgQHJlYWRvbmx5CiAgICogICBAIWdyb3VwIE9wZXJhdGlvbiBQcm9wZXJ0aWVzCiAgICogICBAcmV0dXJuIFtEYXRlXSB0aGUgdGltZSB0aGF0IHRoZSByZXF1ZXN0IHN0YXJ0ZWQKICAgKgogICAqIEAhZ3JvdXAgUmVxdWVzdCBCdWlsZGluZyBFdmVudHMKICAgKgogICAqIEAhZXZlbnQgdmFsaWRhdGUocmVxdWVzdCkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIGEgcmVxdWVzdCBpcyBiZWluZyB2YWxpZGF0ZWQuIExpc3RlbmVycwogICAqICAgc2hvdWxkIHRocm93IGFuIGVycm9yIGlmIHRoZSByZXF1ZXN0IHNob3VsZCBub3QgYmUgc2VudC4KICAgKiAgIEBwYXJhbSByZXF1ZXN0IFtSZXF1ZXN0XSB0aGUgcmVxdWVzdCBvYmplY3QgYmVpbmcgc2VudAogICAqICAgQHNlZSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9DUkVERU5USUFMUwogICAqICAgQHNlZSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9SRUdJT04KICAgKiAgIEBleGFtcGxlIEVuc3VyaW5nIHRoYXQgYSBjZXJ0YWluIHBhcmFtZXRlciBpcyBzZXQgYmVmb3JlIHNlbmRpbmcgYSByZXF1ZXN0CiAgICogICAgIHZhciByZXEgPSBzMy5wdXRPYmplY3QocGFyYW1zKTsKICAgKiAgICAgcmVxLm9uKCd2YWxpZGF0ZScsIGZ1bmN0aW9uKCkgewogICAqICAgICAgIGlmICghcmVxLnBhcmFtcy5Cb2R5Lm1hdGNoKC9eSGVsbG9ccy8pKSB7CiAgICogICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JvZHkgbXVzdCBzdGFydCB3aXRoICJIZWxsbyAiJyk7CiAgICogICAgICAgfQogICAqICAgICB9KTsKICAgKiAgICAgcmVxLnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7IC4uLiB9KTsKICAgKgogICAqIEAhZXZlbnQgYnVpbGQocmVxdWVzdCkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSByZXF1ZXN0IHBheWxvYWQgaXMgYmVpbmcgYnVpbHQuIExpc3RlbmVycwogICAqICAgc2hvdWxkIGZpbGwgdGhlIG5lY2Vzc2FyeSBpbmZvcm1hdGlvbiB0byBzZW5kIHRoZSByZXF1ZXN0CiAgICogICBvdmVyIEhUVFAuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH52YWxpZGF0ZSkKICAgKiAgIEBleGFtcGxlIEFkZCBhIGN1c3RvbSBIVFRQIGhlYWRlciB0byBhIHJlcXVlc3QKICAgKiAgICAgdmFyIHJlcSA9IHMzLnB1dE9iamVjdChwYXJhbXMpOwogICAqICAgICByZXEub24oJ2J1aWxkJywgZnVuY3Rpb24oKSB7CiAgICogICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0N1c3RvbS1IZWFkZXInXSA9ICd2YWx1ZSc7CiAgICogICAgIH0pOwogICAqICAgICByZXEuc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHsgLi4uIH0pOwogICAqCiAgICogQCFldmVudCBzaWduKHJlcXVlc3QpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgcmVxdWVzdCBpcyBiZWluZyBzaWduZWQuIExpc3RlbmVycyBzaG91bGQKICAgKiAgIGFkZCB0aGUgY29ycmVjdCBhdXRoZW50aWNhdGlvbiBoZWFkZXJzIGFuZC9vciBhZGp1c3QgdGhlIGJvZHksCiAgICogICBkZXBlbmRpbmcgb24gdGhlIGF1dGhlbnRpY2F0aW9uIG1lY2hhbmlzbSBiZWluZyB1c2VkLgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+dmFsaWRhdGUpCiAgICoKICAgKiBAIWdyb3VwIFJlcXVlc3QgU2VuZGluZyBFdmVudHMKICAgKgogICAqIEAhZXZlbnQgc2VuZChyZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSByZXF1ZXN0IGlzIHJlYWR5IHRvIGJlIHNlbnQuIExpc3RlbmVycwogICAqICAgc2hvdWxkIGNhbGwgdGhlIHVuZGVybHlpbmcgdHJhbnNwb3J0IGxheWVyIHRvIGluaXRpYXRlCiAgICogICB0aGUgc2VuZGluZyBvZiB0aGUgcmVxdWVzdC4KICAgKiAgIEBwYXJhbSByZXNwb25zZSBbUmVzcG9uc2VdIHRoZSByZXNwb25zZSBvYmplY3QKICAgKiAgIEBjb250ZXh0IFtSZXF1ZXN0XSB0aGUgcmVxdWVzdCBvYmplY3QgdGhhdCB3YXMgc2VudAogICAqICAgQHNlZSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5TRU5ECiAgICoKICAgKiBAIWV2ZW50IHJldHJ5KHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gYSByZXF1ZXN0IGZhaWxlZCBhbmQgbWlnaHQgbmVlZCB0byBiZSByZXRyaWVkIG9yIHJlZGlyZWN0ZWQuCiAgICogICBJZiB0aGUgcmVzcG9uc2UgaXMgcmV0cnlhYmxlLCB0aGUgbGlzdGVuZXIgc2hvdWxkIHNldCB0aGUKICAgKiAgIGByZXNwb25zZS5lcnJvci5yZXRyeWFibGVgIHByb3BlcnR5IHRvIGB0cnVlYCwgYW5kIG9wdGlvbmFsbHkgc2V0CiAgICogICBgcmVzcG9uc2UuZXJyb3IucmV0cnlEZWxheWAgdG8gdGhlIG1pbGxpc2Vjb25kIGRlbGF5IGZvciB0aGUgbmV4dCBhdHRlbXB0LgogICAqICAgSW4gdGhlIGNhc2Ugb2YgYSByZWRpcmVjdCwgYHJlc3BvbnNlLmVycm9yLnJlZGlyZWN0YCBzaG91bGQgYmUgc2V0IHRvCiAgICogICBgdHJ1ZWAgd2l0aCBgcmV0cnlEZWxheWAgc2V0IHRvIGFuIG9wdGlvbmFsIGRlbGF5IG9uIHRoZSBuZXh0IHJlcXVlc3QuCiAgICoKICAgKiAgIElmIGEgbGlzdGVuZXIgZGVjaWRlcyB0aGF0IGEgcmVxdWVzdCBzaG91bGQgbm90IGJlIHJldHJpZWQsCiAgICogICBpdCBzaG91bGQgc2V0IGJvdGggYHJldHJ5YWJsZWAgYW5kIGByZWRpcmVjdGAgdG8gZmFsc2UuCiAgICoKICAgKiAgIE5vdGUgdGhhdCBhIHJldHJ5YWJsZSBlcnJvciB3aWxsIGJlIHJldHJpZWQgYXQgbW9zdAogICAqICAge0FXUy5Db25maWcubWF4UmV0cmllc30gdGltZXMgKGJhc2VkIG9uIHRoZSBzZXJ2aWNlIG9iamVjdCdzIGNvbmZpZykuCiAgICogICBTaW1pbGFybHksIGEgcmVxdWVzdCB0aGF0IGlzIHJlZGlyZWN0ZWQgd2lsbCBvbmx5IHJlZGlyZWN0IGF0IG1vc3QKICAgKiAgIHtBV1MuQ29uZmlnLm1heFJlZGlyZWN0c30gdGltZXMuCiAgICoKICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAZXhhbXBsZSBBZGRpbmcgYSBjdXN0b20gcmV0cnkgZm9yIGEgNDA0IHJlc3BvbnNlCiAgICogICAgIHJlcXVlc3Qub24oJ3JldHJ5JywgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgKiAgICAgICAvLyB0aGlzIHJlc291cmNlIGlzIG5vdCB5ZXQgYXZhaWxhYmxlLCB3YWl0IDEwIHNlY29uZHMgdG8gZ2V0IGl0IGFnYWluCiAgICogICAgICAgaWYgKHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlID09PSA0MDQgJiYgcmVzcG9uc2UuZXJyb3IpIHsKICAgKiAgICAgICAgIHJlc3BvbnNlLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7ICAgLy8gcmV0cnkgdGhpcyBlcnJvcgogICAqICAgICAgICAgcmVzcG9uc2UuZXJyb3IucmV0cnlEZWxheSA9IDEwMDAwOyAvLyB3YWl0IDEwIHNlY29uZHMKICAgKiAgICAgICB9CiAgICogICAgIH0pOwogICAqCiAgICogQCFncm91cCBEYXRhIFBhcnNpbmcgRXZlbnRzCiAgICoKICAgKiBAIWV2ZW50IGV4dHJhY3RFcnJvcihyZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCBvbiBhbGwgbm9uLTJ4eCByZXF1ZXN0cyBzbyB0aGF0IGxpc3RlbmVycyBjYW4gZXh0cmFjdAogICAqICAgZXJyb3IgZGV0YWlscyBmcm9tIHRoZSByZXNwb25zZSBib2R5LiBMaXN0ZW5lcnMgdG8gdGhpcyBldmVudAogICAqICAgc2hvdWxkIHNldCB0aGUgYHJlc3BvbnNlLmVycm9yYCBwcm9wZXJ0eS4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICoKICAgKiBAIWV2ZW50IGV4dHJhY3REYXRhKHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIGluIHN1Y2Nlc3NmdWwgcmVxdWVzdHMgdG8gYWxsb3cgbGlzdGVuZXJzIHRvCiAgICogICBkZS1zZXJpYWxpemUgdGhlIHJlc3BvbnNlIGJvZHkgaW50byBgcmVzcG9uc2UuZGF0YWAuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQCFncm91cCBDb21wbGV0aW9uIEV2ZW50cwogICAqCiAgICogQCFldmVudCBzdWNjZXNzKHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIHJlcXVlc3QgY29tcGxldGVkIHN1Y2Nlc3NmdWxseS4KICAgKiAgIGByZXNwb25zZS5kYXRhYCB3aWxsIGNvbnRhaW4gdGhlIHJlc3BvbnNlIGRhdGEgYW5kCiAgICogICBgcmVzcG9uc2UuZXJyb3JgIHdpbGwgYmUgbnVsbC4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICoKICAgKiBAIWV2ZW50IGVycm9yKGVycm9yLCByZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIGFuIGVycm9yIG9jY3VycyBhdCBhbnkgcG9pbnQgZHVyaW5nIHRoZQogICAqICAgcmVxdWVzdC4gYHJlc3BvbnNlLmVycm9yYCB3aWxsIGNvbnRhaW4gZGV0YWlscyBhYm91dCB0aGUgZXJyb3IKICAgKiAgIHRoYXQgb2NjdXJyZWQuIGByZXNwb25zZS5kYXRhYCB3aWxsIGJlIG51bGwuCiAgICogICBAcGFyYW0gZXJyb3IgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IGNvbnRhaW5pbmcgZGV0YWlscyBhYm91dAogICAqICAgICB0aGUgZXJyb3IgdGhhdCBvY2N1cnJlZC4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICoKICAgKiBAIWV2ZW50IGNvbXBsZXRlKHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW5ldmVyIGEgcmVxdWVzdCBjeWNsZSBjb21wbGV0ZXMuIGByZXNwb25zZS5lcnJvcmAKICAgKiAgIHNob3VsZCBiZSBjaGVja2VkLCBzaW5jZSB0aGUgcmVxdWVzdCBtYXkgaGF2ZSBmYWlsZWQuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQCFncm91cCBIVFRQIEV2ZW50cwogICAqCiAgICogQCFldmVudCBodHRwSGVhZGVycyhzdGF0dXNDb2RlLCBoZWFkZXJzLCByZXNwb25zZSwgc3RhdHVzTWVzc2FnZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIGhlYWRlcnMgYXJlIHNlbnQgYnkgdGhlIHJlbW90ZSBzZXJ2ZXIKICAgKiAgIEBwYXJhbSBzdGF0dXNDb2RlIFtJbnRlZ2VyXSB0aGUgSFRUUCByZXNwb25zZSBjb2RlCiAgICogICBAcGFyYW0gaGVhZGVycyBbbWFwPFN0cmluZyxTdHJpbmc+XSB0aGUgcmVzcG9uc2UgaGVhZGVycwogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBwYXJhbSBzdGF0dXNNZXNzYWdlIFtTdHJpbmddIEEgc3RhdHVzIG1lc3NhZ2UgY29ycmVzcG9uZGluZyB0byB0aGUgSFRUUAogICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UgY29kZQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQCFldmVudCBodHRwRGF0YShjaHVuaywgcmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiBkYXRhIGlzIHNlbnQgYnkgdGhlIHJlbW90ZSBzZXJ2ZXIKICAgKiAgIEBwYXJhbSBjaHVuayBbQnVmZmVyXSB0aGUgYnVmZmVyIGRhdGEgY29udGFpbmluZyB0aGUgbmV4dCBkYXRhIGNodW5rCiAgICogICAgIGZyb20gdGhlIHNlcnZlcgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBzZWUgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuSFRUUF9EQVRBCiAgICoKICAgKiBAIWV2ZW50IGh0dHBVcGxvYWRQcm9ncmVzcyhwcm9ncmVzcywgcmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgSFRUUCByZXF1ZXN0IGhhcyB1cGxvYWRlZCBtb3JlIGRhdGEKICAgKiAgIEBwYXJhbSBwcm9ncmVzcyBbbWFwXSBBbiBvYmplY3QgY29udGFpbmluZyB0aGUgYGxvYWRlZGAgYW5kIGB0b3RhbGAgYnl0ZXMKICAgKiAgICAgb2YgdGhlIHJlcXVlc3QuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQG5vdGUgVGhpcyBldmVudCB3aWxsIG5vdCBiZSBlbWl0dGVkIGluIE5vZGUuanMgMC44LnguCiAgICoKICAgKiBAIWV2ZW50IGh0dHBEb3dubG9hZFByb2dyZXNzKHByb2dyZXNzLCByZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSBIVFRQIHJlcXVlc3QgaGFzIGRvd25sb2FkZWQgbW9yZSBkYXRhCiAgICogICBAcGFyYW0gcHJvZ3Jlc3MgW21hcF0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGBsb2FkZWRgIGFuZCBgdG90YWxgIGJ5dGVzCiAgICogICAgIG9mIHRoZSByZXF1ZXN0LgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBub3RlIFRoaXMgZXZlbnQgd2lsbCBub3QgYmUgZW1pdHRlZCBpbiBOb2RlLmpzIDAuOC54LgogICAqCiAgICogQCFldmVudCBodHRwRXJyb3IoZXJyb3IsIHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIEhUVFAgcmVxdWVzdCBmYWlsZWQKICAgKiAgIEBwYXJhbSBlcnJvciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgdGhhdCB3YXMgdGhyb3duCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQCFldmVudCBodHRwRG9uZShyZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSBzZXJ2ZXIgaXMgZmluaXNoZWQgc2VuZGluZyBkYXRhCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQHNlZSBBV1MuUmVzcG9uc2UKICAgKi8KICBBV1MuUmVxdWVzdCA9IGluaGVyaXQoewogIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgcmVxdWVzdCBmb3IgYW4gb3BlcmF0aW9uIG9uIGEgZ2l2ZW4gc2VydmljZSB3aXRoCiAgICAgKiBhIHNldCBvZiBpbnB1dCBwYXJhbWV0ZXJzLgogICAgICoKICAgICAqIEBwYXJhbSBzZXJ2aWNlIFtBV1MuU2VydmljZV0gdGhlIHNlcnZpY2UgdG8gcGVyZm9ybSB0aGUgb3BlcmF0aW9uIG9uCiAgICAgKiBAcGFyYW0gb3BlcmF0aW9uIFtTdHJpbmddIHRoZSBvcGVyYXRpb24gdG8gcGVyZm9ybSBvbiB0aGUgc2VydmljZQogICAgICogQHBhcmFtIHBhcmFtcyBbT2JqZWN0XSBwYXJhbWV0ZXJzIHRvIHNlbmQgdG8gdGhlIG9wZXJhdGlvbi4KICAgICAqICAgU2VlIHRoZSBvcGVyYXRpb24ncyBkb2N1bWVudGF0aW9uIGZvciB0aGUgZm9ybWF0IG9mIHRoZQogICAgICogICBwYXJhbWV0ZXJzLgogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gUmVxdWVzdChzZXJ2aWNlLCBvcGVyYXRpb24sIHBhcmFtcykgewogICAgICB2YXIgZW5kcG9pbnQgPSBzZXJ2aWNlLmVuZHBvaW50OwogICAgICB2YXIgcmVnaW9uID0gc2VydmljZS5jb25maWcucmVnaW9uOwogICAgICB2YXIgY3VzdG9tVXNlckFnZW50ID0gc2VydmljZS5jb25maWcuY3VzdG9tVXNlckFnZW50OwogIAogICAgICAvLyBnbG9iYWwgZW5kcG9pbnRzIHNpZ24gYXMgdXMtZWFzdC0xCiAgICAgIGlmIChzZXJ2aWNlLmlzR2xvYmFsRW5kcG9pbnQpIHJlZ2lvbiA9ICd1cy1lYXN0LTEnOwogIAogICAgICB0aGlzLmRvbWFpbiA9IGRvbWFpbiAmJiBkb21haW4uYWN0aXZlOwogICAgICB0aGlzLnNlcnZpY2UgPSBzZXJ2aWNlOwogICAgICB0aGlzLm9wZXJhdGlvbiA9IG9wZXJhdGlvbjsKICAgICAgdGhpcy5wYXJhbXMgPSBwYXJhbXMgfHwge307CiAgICAgIHRoaXMuaHR0cFJlcXVlc3QgPSBuZXcgQVdTLkh0dHBSZXF1ZXN0KGVuZHBvaW50LCByZWdpb24pOwogICAgICB0aGlzLmh0dHBSZXF1ZXN0LmFwcGVuZFRvVXNlckFnZW50KGN1c3RvbVVzZXJBZ2VudCk7CiAgICAgIHRoaXMuc3RhcnRUaW1lID0gc2VydmljZS5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpOwogIAogICAgICB0aGlzLnJlc3BvbnNlID0gbmV3IEFXUy5SZXNwb25zZSh0aGlzKTsKICAgICAgdGhpcy5fYXNtID0gbmV3IEFjY2VwdG9yU3RhdGVNYWNoaW5lKGZzbS5zdGF0ZXMsICd2YWxpZGF0ZScpOwogICAgICB0aGlzLl9oYWx0SGFuZGxlcnNPbkVycm9yID0gZmFsc2U7CiAgCiAgICAgIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5lbWl0ID0gdGhpcy5lbWl0RXZlbnQ7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAIWdyb3VwIFNlbmRpbmcgYSBSZXF1ZXN0CiAgICAgKi8KICAKICAgIC8qKgogICAgICogQG92ZXJsb2FkIHNlbmQoY2FsbGJhY2sgPSBudWxsKQogICAgICogICBTZW5kcyB0aGUgcmVxdWVzdCBvYmplY3QuCiAgICAgKgogICAgICogICBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBkYXRhKQogICAgICogICAgIElmIGEgY2FsbGJhY2sgaXMgc3VwcGxpZWQsIGl0IGlzIGNhbGxlZCB3aGVuIGEgcmVzcG9uc2UgaXMgcmV0dXJuZWQKICAgICAqICAgICBmcm9tIHRoZSBzZXJ2aWNlLgogICAgICogICAgIEBjb250ZXh0IFtBV1MuUmVxdWVzdF0gdGhlIHJlcXVlc3Qgb2JqZWN0IGJlaW5nIHNlbnQuCiAgICAgKiAgICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgICAqICAgICAgIFNldCB0byBgbnVsbGAgaWYgdGhlIHJlcXVlc3QgaXMgc3VjY2Vzc2Z1bC4KICAgICAqICAgICBAcGFyYW0gZGF0YSBbT2JqZWN0XSB0aGUgZGUtc2VyaWFsaXplZCBkYXRhIHJldHVybmVkIGZyb20KICAgICAqICAgICAgIHRoZSByZXF1ZXN0LiBTZXQgdG8gYG51bGxgIGlmIGEgcmVxdWVzdCBlcnJvciBvY2N1cnMuCiAgICAgKiAgIEBleGFtcGxlIFNlbmRpbmcgYSByZXF1ZXN0IHdpdGggYSBjYWxsYmFjawogICAgICogICAgIHJlcXVlc3QgPSBzMy5wdXRPYmplY3Qoe0J1Y2tldDogJ2J1Y2tldCcsIEtleTogJ2tleSd9KTsKICAgICAqICAgICByZXF1ZXN0LnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7IGNvbnNvbGUubG9nKGVyciwgZGF0YSk7IH0pOwogICAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRoIG5vIGNhbGxiYWNrICh1c2luZyBldmVudCBoYW5kbGVycykKICAgICAqICAgICByZXF1ZXN0ID0gczMucHV0T2JqZWN0KHtCdWNrZXQ6ICdidWNrZXQnLCBLZXk6ICdrZXknfSk7CiAgICAgKiAgICAgcmVxdWVzdC5vbignY29tcGxldGUnLCBmdW5jdGlvbihyZXNwb25zZSkgeyAuLi4gfSk7IC8vIHJlZ2lzdGVyIGEgY2FsbGJhY2sKICAgICAqICAgICByZXF1ZXN0LnNlbmQoKTsKICAgICAqLwogICAgc2VuZDogZnVuY3Rpb24gc2VuZChjYWxsYmFjaykgewogICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAvLyBhcHBlbmQgdG8gdXNlciBhZ2VudAogICAgICAgIHRoaXMuaHR0cFJlcXVlc3QuYXBwZW5kVG9Vc2VyQWdlbnQoJ2NhbGxiYWNrJyk7CiAgICAgICAgdGhpcy5vbignY29tcGxldGUnLCBmdW5jdGlvbiAocmVzcCkgewogICAgICAgICAgY2FsbGJhY2suY2FsbChyZXNwLCByZXNwLmVycm9yLCByZXNwLmRhdGEpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHRoaXMucnVuVG8oKTsKICAKICAgICAgcmV0dXJuIHRoaXMucmVzcG9uc2U7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAIW1ldGhvZCAgcHJvbWlzZSgpCiAgICAgKiAgIFNlbmRzIHRoZSByZXF1ZXN0IGFuZCByZXR1cm5zIGEgJ3RoZW5hYmxlJyBwcm9taXNlLgogICAgICoKICAgICAqICAgVHdvIGNhbGxiYWNrcyBjYW4gYmUgcHJvdmlkZWQgdG8gdGhlIGB0aGVuYCBtZXRob2Qgb24gdGhlIHJldHVybmVkIHByb21pc2UuCiAgICAgKiAgIFRoZSBmaXJzdCBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQsIGFuZCB0aGUgc2Vjb25kCiAgICAgKiAgIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICBAY2FsbGJhY2sgZnVsZmlsbGVkQ2FsbGJhY2sgZnVuY3Rpb24oZGF0YSkKICAgICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLgogICAgICogICAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIGRhdGEgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgICAqICAgQGNhbGxiYWNrIHJlamVjdGVkQ2FsbGJhY2sgZnVuY3Rpb24oZXJyb3IpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICAgIEBwYXJhbSBlcnJvciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgICAqICAgQHJldHVybiBbUHJvbWlzZV0gQSBwcm9taXNlIHRoYXQgcmVwcmVzZW50cyB0aGUgc3RhdGUgb2YgdGhlIHJlcXVlc3QuCiAgICAgKiAgIEBleGFtcGxlIFNlbmRpbmcgYSByZXF1ZXN0IHVzaW5nIHByb21pc2VzLgogICAgICogICAgIHZhciByZXF1ZXN0ID0gczMucHV0T2JqZWN0KHtCdWNrZXQ6ICdidWNrZXQnLCBLZXk6ICdrZXknfSk7CiAgICAgKiAgICAgdmFyIHJlc3VsdCA9IHJlcXVlc3QucHJvbWlzZSgpOwogICAgICogICAgIHJlc3VsdC50aGVuKGZ1bmN0aW9uKGRhdGEpIHsgLi4uIH0sIGZ1bmN0aW9uKGVycm9yKSB7IC4uLiB9KTsKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYnVpbGQ6IGZ1bmN0aW9uIGJ1aWxkKGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLnJ1blRvKCdzZW5kJywgY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHJ1blRvOiBmdW5jdGlvbiBydW5UbyhzdGF0ZSwgZG9uZSkgewogICAgICB0aGlzLl9hc20ucnVuVG8oc3RhdGUsIGRvbmUsIHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEFib3J0cyBhIHJlcXVlc3QsIGVtaXR0aW5nIHRoZSBlcnJvciBhbmQgY29tcGxldGUgZXZlbnRzLgogICAgICoKICAgICAqIEAhbWFjcm8gbm9icm93c2VyCiAgICAgKiBAZXhhbXBsZSBBYm9ydGluZyBhIHJlcXVlc3QgYWZ0ZXIgc2VuZGluZwogICAgICogICB2YXIgcGFyYW1zID0gewogICAgICogICAgIEJ1Y2tldDogJ2J1Y2tldCcsIEtleTogJ2tleScsCiAgICAgKiAgICAgQm9keTogQnVmZmVyLmFsbG9jKDEwMjQgKiAxMDI0ICogNSkgLy8gNU1CIHBheWxvYWQKICAgICAqICAgfTsKICAgICAqICAgdmFyIHJlcXVlc3QgPSBzMy5wdXRPYmplY3QocGFyYW1zKTsKICAgICAqICAgcmVxdWVzdC5zZW5kKGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAqICAgICBpZiAoZXJyKSBjb25zb2xlLmxvZygiRXJyb3I6IiwgZXJyLmNvZGUsIGVyci5tZXNzYWdlKTsKICAgICAqICAgICBlbHNlIGNvbnNvbGUubG9nKGRhdGEpOwogICAgICogICB9KTsKICAgICAqCiAgICAgKiAgIC8vIGFib3J0IHJlcXVlc3QgaW4gMSBzZWNvbmQKICAgICAqICAgc2V0VGltZW91dChyZXF1ZXN0LmFib3J0LmJpbmQocmVxdWVzdCksIDEwMDApOwogICAgICoKICAgICAqICAgLy8gcHJpbnRzICJFcnJvcjogUmVxdWVzdEFib3J0ZWRFcnJvciBSZXF1ZXN0IGFib3J0ZWQgYnkgdXNlciIKICAgICAqIEByZXR1cm4gW0FXUy5SZXF1ZXN0XSB0aGUgc2FtZSByZXF1ZXN0IG9iamVjdCwgZm9yIGNoYWluaW5nLgogICAgICogQHNpbmNlIHYxLjQuMAogICAgICovCiAgICBhYm9ydDogZnVuY3Rpb24gYWJvcnQoKSB7CiAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCd2YWxpZGF0ZVJlc3BvbnNlJyk7CiAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCdleHRyYWN0RXJyb3InKTsKICAgICAgdGhpcy5vbigndmFsaWRhdGVSZXNwb25zZScsIGZ1bmN0aW9uIGFkZEFib3J0ZWRFcnJvcihyZXNwKSB7CiAgICAgICAgcmVzcC5lcnJvciA9IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcignUmVxdWVzdCBhYm9ydGVkIGJ5IHVzZXInKSwgewogICAgICAgICAgIGNvZGU6ICdSZXF1ZXN0QWJvcnRlZEVycm9yJywgcmV0cnlhYmxlOiBmYWxzZQogICAgICAgIH0pOwogICAgICB9KTsKICAKICAgICAgaWYgKHRoaXMuaHR0cFJlcXVlc3Quc3RyZWFtICYmICF0aGlzLmh0dHBSZXF1ZXN0LnN0cmVhbS5kaWRDYWxsYmFjaykgeyAvLyBhYm9ydCBIVFRQIHN0cmVhbQogICAgICAgIHRoaXMuaHR0cFJlcXVlc3Quc3RyZWFtLmFib3J0KCk7CiAgICAgICAgaWYgKHRoaXMuaHR0cFJlcXVlc3QuX2Fib3J0Q2FsbGJhY2spIHsKICAgICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0Ll9hYm9ydENhbGxiYWNrKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCdzZW5kJyk7IC8vIGhhdmVuJ3Qgc2VudCB5ZXQsIHNvIGxldCdzIG5vdAogICAgICAgIH0KICAgICAgfQogIAogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEl0ZXJhdGVzIG92ZXIgZWFjaCBwYWdlIG9mIHJlc3VsdHMgZ2l2ZW4gYSBwYWdlYWJsZSByZXF1ZXN0LCBjYWxsaW5nCiAgICAgKiB0aGUgcHJvdmlkZWQgY2FsbGJhY2sgd2l0aCBlYWNoIHBhZ2Ugb2YgZGF0YS4gQWZ0ZXIgYWxsIHBhZ2VzIGhhdmUgYmVlbgogICAgICogcmV0cmlldmVkLCB0aGUgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggYG51bGxgIGRhdGEuCiAgICAgKgogICAgICogQG5vdGUgVGhpcyBvcGVyYXRpb24gY2FuIGdlbmVyYXRlIG11bHRpcGxlIHJlcXVlc3RzIHRvIGEgc2VydmljZS4KICAgICAqIEBleGFtcGxlIEl0ZXJhdGluZyBvdmVyIG11bHRpcGxlIHBhZ2VzIG9mIG9iamVjdHMgaW4gYW4gUzMgYnVja2V0CiAgICAgKiAgIHZhciBwYWdlcyA9IDE7CiAgICAgKiAgIHMzLmxpc3RPYmplY3RzKCkuZWFjaFBhZ2UoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgKiAgICAgaWYgKGVycikgcmV0dXJuOwogICAgICogICAgIGNvbnNvbGUubG9nKCJQYWdlIiwgcGFnZXMrKyk7CiAgICAgKiAgICAgY29uc29sZS5sb2coZGF0YSk7CiAgICAgKiAgIH0pOwogICAgICogQGV4YW1wbGUgSXRlcmF0aW5nIG92ZXIgbXVsdGlwbGUgcGFnZXMgd2l0aCBhbiBhc3luY2hyb25vdXMgY2FsbGJhY2sKICAgICAqICAgczMubGlzdE9iamVjdHMocGFyYW1zKS5lYWNoUGFnZShmdW5jdGlvbihlcnIsIGRhdGEsIGRvbmUpIHsKICAgICAqICAgICBkb1NvbWV0aGluZ0FzeW5jQW5kT3JFeHBlbnNpdmUoZnVuY3Rpb24oKSB7CiAgICAgKiAgICAgICAvLyBUaGUgbmV4dCBwYWdlIG9mIHJlc3VsdHMgaXNuJ3QgZmV0Y2hlZCB1bnRpbCBkb25lIGlzIGNhbGxlZAogICAgICogICAgICAgZG9uZSgpOwogICAgICogICAgIH0pOwogICAgICogICB9KTsKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEsIFtkb25lQ2FsbGJhY2tdKQogICAgICogICBDYWxsZWQgd2l0aCBlYWNoIHBhZ2Ugb2YgcmVzdWx0aW5nIGRhdGEgZnJvbSB0aGUgcmVxdWVzdC4gSWYgdGhlCiAgICAgKiAgIG9wdGlvbmFsIGBkb25lQ2FsbGJhY2tgIGlzIHByb3ZpZGVkIGluIHRoZSBmdW5jdGlvbiwgaXQgbXVzdCBiZSBjYWxsZWQKICAgICAqICAgd2hlbiB0aGUgY2FsbGJhY2sgaXMgY29tcGxldGUuCiAgICAgKgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gYW4gZXJyb3Igb2JqZWN0LCBpZiBhbiBlcnJvciBvY2N1cnJlZC4KICAgICAqICAgQHBhcmFtIGRhdGEgW09iamVjdF0gYSBzaW5nbGUgcGFnZSBvZiByZXNwb25zZSBkYXRhLiBJZiB0aGVyZSBpcyBubwogICAgICogICAgIG1vcmUgZGF0YSwgdGhpcyBvYmplY3Qgd2lsbCBiZSBgbnVsbGAuCiAgICAgKiAgIEBwYXJhbSBkb25lQ2FsbGJhY2sgW0Z1bmN0aW9uXSBhbiBvcHRpb25hbCBkb25lIGNhbGxiYWNrLiBJZiB0aGlzCiAgICAgKiAgICAgYXJndW1lbnQgaXMgZGVmaW5lZCBpbiB0aGUgZnVuY3Rpb24gZGVjbGFyYXRpb24sIGl0IHNob3VsZCBiZSBjYWxsZWQKICAgICAqICAgICB3aGVuIHRoZSBuZXh0IHBhZ2UgaXMgcmVhZHkgdG8gYmUgcmV0cmlldmVkLiBUaGlzIGlzIHVzZWZ1bCBmb3IKICAgICAqICAgICBjb250cm9sbGluZyBzZXJpYWwgcGFnaW5hdGlvbiBhY3Jvc3MgYXN5bmNocm9ub3VzIG9wZXJhdGlvbnMuCiAgICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIGlmIHRoZSBjYWxsYmFjayByZXR1cm5zIGBmYWxzZWAsIHBhZ2luYXRpb24gd2lsbAogICAgICogICAgIHN0b3AuCiAgICAgKgogICAgICogQHNlZSBBV1MuUmVxdWVzdC5lYWNoSXRlbQogICAgICogQHNlZSBBV1MuUmVzcG9uc2UubmV4dFBhZ2UKICAgICAqIEBzaW5jZSB2MS40LjAKICAgICAqLwogICAgZWFjaFBhZ2U6IGZ1bmN0aW9uIGVhY2hQYWdlKGNhbGxiYWNrKSB7CiAgICAgIC8vIE1ha2UgYWxsIGNhbGxiYWNrcyBhc3luYy1pc2gKICAgICAgY2FsbGJhY2sgPSBBV1MudXRpbC5mbi5tYWtlQXN5bmMoY2FsbGJhY2ssIDMpOwogIAogICAgICBmdW5jdGlvbiB3cmFwcGVkQ2FsbGJhY2socmVzcG9uc2UpIHsKICAgICAgICBjYWxsYmFjay5jYWxsKHJlc3BvbnNlLCByZXNwb25zZS5lcnJvciwgcmVzcG9uc2UuZGF0YSwgZnVuY3Rpb24gKHJlc3VsdCkgewogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIHJldHVybjsKICAKICAgICAgICAgIGlmIChyZXNwb25zZS5oYXNOZXh0UGFnZSgpKSB7CiAgICAgICAgICAgIHJlc3BvbnNlLm5leHRQYWdlKCkub24oJ2NvbXBsZXRlJywgd3JhcHBlZENhbGxiYWNrKS5zZW5kKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjYWxsYmFjay5jYWxsKHJlc3BvbnNlLCBudWxsLCBudWxsLCBBV1MudXRpbC5mbi5ub29wKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogIAogICAgICB0aGlzLm9uKCdjb21wbGV0ZScsIHdyYXBwZWRDYWxsYmFjaykuc2VuZCgpOwogICAgfSwKICAKICAgIC8qKgogICAgICogRW51bWVyYXRlcyBvdmVyIGluZGl2aWR1YWwgaXRlbXMgb2YgYSByZXF1ZXN0LCBwYWdpbmcgdGhlIHJlc3BvbnNlcyBpZgogICAgICogbmVjZXNzYXJ5LgogICAgICoKICAgICAqIEBhcGkgZXhwZXJpbWVudGFsCiAgICAgKiBAc2luY2UgdjEuNC4wCiAgICAgKi8KICAgIGVhY2hJdGVtOiBmdW5jdGlvbiBlYWNoSXRlbShjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGZ1bmN0aW9uIHdyYXBwZWRDYWxsYmFjayhlcnIsIGRhdGEpIHsKICAgICAgICBpZiAoZXJyKSByZXR1cm4gY2FsbGJhY2soZXJyLCBudWxsKTsKICAgICAgICBpZiAoZGF0YSA9PT0gbnVsbCkgcmV0dXJuIGNhbGxiYWNrKG51bGwsIG51bGwpOwogIAogICAgICAgIHZhciBjb25maWcgPSBzZWxmLnNlcnZpY2UucGFnaW5hdGlvbkNvbmZpZyhzZWxmLm9wZXJhdGlvbik7CiAgICAgICAgdmFyIHJlc3VsdEtleSA9IGNvbmZpZy5yZXN1bHRLZXk7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0S2V5KSkgcmVzdWx0S2V5ID0gcmVzdWx0S2V5WzBdOwogICAgICAgIHZhciBpdGVtcyA9IGptZXNwYXRoLnNlYXJjaChkYXRhLCByZXN1bHRLZXkpOwogICAgICAgIHZhciBjb250aW51ZUl0ZXJhdGlvbiA9IHRydWU7CiAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKGl0ZW1zLCBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICBjb250aW51ZUl0ZXJhdGlvbiA9IGNhbGxiYWNrKG51bGwsIGl0ZW0pOwogICAgICAgICAgaWYgKGNvbnRpbnVlSXRlcmF0aW9uID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gQVdTLnV0aWwuYWJvcnQ7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGNvbnRpbnVlSXRlcmF0aW9uOwogICAgICB9CiAgCiAgICAgIHRoaXMuZWFjaFBhZ2Uod3JhcHBlZENhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIG9wZXJhdGlvbiBjYW4gcmV0dXJuIG11bHRpcGxlIHBhZ2VzIG9mCiAgICAgKiAgIHJlc3BvbnNlIGRhdGEuCiAgICAgKiBAc2VlIEFXUy5SZXNwb25zZS5lYWNoUGFnZQogICAgICogQHNpbmNlIHYxLjQuMAogICAgICovCiAgICBpc1BhZ2VhYmxlOiBmdW5jdGlvbiBpc1BhZ2VhYmxlKCkgewogICAgICByZXR1cm4gdGhpcy5zZXJ2aWNlLnBhZ2luYXRpb25Db25maWcodGhpcy5vcGVyYXRpb24pID8gdHJ1ZSA6IGZhbHNlOwogICAgfSwKICAKICAgIC8qKgogICAgICogU2VuZHMgdGhlIHJlcXVlc3QgYW5kIGNvbnZlcnRzIHRoZSByZXF1ZXN0IG9iamVjdCBpbnRvIGEgcmVhZGFibGUgc3RyZWFtCiAgICAgKiB0aGF0IGNhbiBiZSByZWFkIGZyb20gb3IgcGlwZWQgaW50byBhIHdyaXRhYmxlIHN0cmVhbS4KICAgICAqCiAgICAgKiBAbm90ZSBUaGUgZGF0YSByZWFkIGZyb20gYSByZWFkYWJsZSBzdHJlYW0gY29udGFpbnMgb25seQogICAgICogICB0aGUgcmF3IEhUVFAgYm9keSBjb250ZW50cy4KICAgICAqIEBleGFtcGxlIE1hbnVhbGx5IHJlYWRpbmcgZnJvbSBhIHN0cmVhbQogICAgICogICByZXF1ZXN0LmNyZWF0ZVJlYWRTdHJlYW0oKS5vbignZGF0YScsIGZ1bmN0aW9uKGRhdGEpIHsKICAgICAqICAgICBjb25zb2xlLmxvZygiR290IGRhdGE6IiwgZGF0YS50b1N0cmluZygpKTsKICAgICAqICAgfSk7CiAgICAgKiBAZXhhbXBsZSBQaXBpbmcgYSByZXF1ZXN0IGJvZHkgaW50byBhIGZpbGUKICAgICAqICAgdmFyIG91dCA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKCcvcGF0aC90by9vdXRmaWxlLmpwZycpOwogICAgICogICBzMy5zZXJ2aWNlLmdldE9iamVjdChwYXJhbXMpLmNyZWF0ZVJlYWRTdHJlYW0oKS5waXBlKG91dCk7CiAgICAgKiBAcmV0dXJuIFtTdHJlYW1dIHRoZSByZWFkYWJsZSBzdHJlYW0gb2JqZWN0IHRoYXQgY2FuIGJlIHBpcGVkCiAgICAgKiAgIG9yIHJlYWQgZnJvbSAoYnkgcmVnaXN0ZXJpbmcgJ2RhdGEnIGV2ZW50IGxpc3RlbmVycykuCiAgICAgKiBAIW1hY3JvIG5vYnJvd3NlcgogICAgICovCiAgICBjcmVhdGVSZWFkU3RyZWFtOiBmdW5jdGlvbiBjcmVhdGVSZWFkU3RyZWFtKCkgewogICAgICB2YXIgc3RyZWFtcyA9IEFXUy51dGlsLnN0cmVhbTsKICAgICAgdmFyIHJlcSA9IHRoaXM7CiAgICAgIHZhciBzdHJlYW0gPSBudWxsOwogIAogICAgICBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIpIHsKICAgICAgICBzdHJlYW0gPSBuZXcgc3RyZWFtcy5QYXNzVGhyb3VnaCgpOwogICAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7IHJlcS5zZW5kKCk7IH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHN0cmVhbSA9IG5ldyBzdHJlYW1zLlN0cmVhbSgpOwogICAgICAgIHN0cmVhbS5yZWFkYWJsZSA9IHRydWU7CiAgCiAgICAgICAgc3RyZWFtLnNlbnQgPSBmYWxzZTsKICAgICAgICBzdHJlYW0ub24oJ25ld0xpc3RlbmVyJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIGlmICghc3RyZWFtLnNlbnQgJiYgZXZlbnQgPT09ICdkYXRhJykgewogICAgICAgICAgICBzdHJlYW0uc2VudCA9IHRydWU7CiAgICAgICAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7IHJlcS5zZW5kKCk7IH0pOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIHRoaXMub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgICAgfSk7CiAgCiAgICAgIHRoaXMub24oJ2h0dHBIZWFkZXJzJywgZnVuY3Rpb24gc3RyZWFtSGVhZGVycyhzdGF0dXNDb2RlLCBoZWFkZXJzLCByZXNwKSB7CiAgICAgICAgaWYgKHN0YXR1c0NvZGUgPCAzMDApIHsKICAgICAgICAgIHJlcS5yZW1vdmVMaXN0ZW5lcignaHR0cERhdGEnLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5IVFRQX0RBVEEpOwogICAgICAgICAgcmVxLnJlbW92ZUxpc3RlbmVyKCdodHRwRXJyb3InLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5IVFRQX0VSUk9SKTsKICAgICAgICAgIHJlcS5vbignaHR0cEVycm9yJywgZnVuY3Rpb24gc3RyZWFtSHR0cEVycm9yKGVycm9yKSB7CiAgICAgICAgICAgIHJlc3AuZXJyb3IgPSBlcnJvcjsKICAgICAgICAgICAgcmVzcC5lcnJvci5yZXRyeWFibGUgPSBmYWxzZTsKICAgICAgICAgIH0pOwogIAogICAgICAgICAgdmFyIHNob3VsZENoZWNrQ29udGVudExlbmd0aCA9IGZhbHNlOwogICAgICAgICAgdmFyIGV4cGVjdGVkTGVuOwogICAgICAgICAgaWYgKHJlcS5odHRwUmVxdWVzdC5tZXRob2QgIT09ICdIRUFEJykgewogICAgICAgICAgICBleHBlY3RlZExlbiA9IHBhcnNlSW50KGhlYWRlcnNbJ2NvbnRlbnQtbGVuZ3RoJ10sIDEwKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChleHBlY3RlZExlbiAhPT0gdW5kZWZpbmVkICYmICFpc05hTihleHBlY3RlZExlbikgJiYgZXhwZWN0ZWRMZW4gPj0gMCkgewogICAgICAgICAgICBzaG91bGRDaGVja0NvbnRlbnRMZW5ndGggPSB0cnVlOwogICAgICAgICAgICB2YXIgcmVjZWl2ZWRMZW4gPSAwOwogICAgICAgICAgfQogIAogICAgICAgICAgdmFyIGNoZWNrQ29udGVudExlbmd0aEFuZEVtaXQgPSBmdW5jdGlvbiBjaGVja0NvbnRlbnRMZW5ndGhBbmRFbWl0KCkgewogICAgICAgICAgICBpZiAoc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoICYmIHJlY2VpdmVkTGVuICE9PSBleHBlY3RlZExlbikgewogICAgICAgICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIEFXUy51dGlsLmVycm9yKAogICAgICAgICAgICAgICAgbmV3IEVycm9yKCdTdHJlYW0gY29udGVudCBsZW5ndGggbWlzbWF0Y2guIFJlY2VpdmVkICcgKwogICAgICAgICAgICAgICAgICByZWNlaXZlZExlbiArICcgb2YgJyArIGV4cGVjdGVkTGVuICsgJyBieXRlcy4nKSwKICAgICAgICAgICAgICAgIHsgY29kZTogJ1N0cmVhbUNvbnRlbnRMZW5ndGhNaXNtYXRjaCcgfQogICAgICAgICAgICAgICkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyKSB7CiAgICAgICAgICAgICAgc3RyZWFtLmVuZCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0cmVhbS5lbWl0KCdlbmQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAKICAgICAgICAgIHZhciBodHRwU3RyZWFtID0gcmVzcC5odHRwUmVzcG9uc2UuY3JlYXRlVW5idWZmZXJlZFN0cmVhbSgpOwogIAogICAgICAgICAgaWYgKEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDaGVja0NvbnRlbnRMZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgbGVuZ3RoQWNjdW11bGF0b3IgPSBuZXcgc3RyZWFtcy5QYXNzVGhyb3VnaCgpOwogICAgICAgICAgICAgIGxlbmd0aEFjY3VtdWxhdG9yLl93cml0ZSA9IGZ1bmN0aW9uKGNodW5rKSB7CiAgICAgICAgICAgICAgICBpZiAoY2h1bmsgJiYgY2h1bmsubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHJlY2VpdmVkTGVuICs9IGNodW5rLmxlbmd0aDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBzdHJlYW1zLlBhc3NUaHJvdWdoLnByb3RvdHlwZS5fd3JpdGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICB9OwogIAogICAgICAgICAgICAgIGxlbmd0aEFjY3VtdWxhdG9yLm9uKCdlbmQnLCBjaGVja0NvbnRlbnRMZW5ndGhBbmRFbWl0KTsKICAgICAgICAgICAgICBzdHJlYW0ub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgICBzaG91bGRDaGVja0NvbnRlbnRMZW5ndGggPSBmYWxzZTsKICAgICAgICAgICAgICAgIGh0dHBTdHJlYW0udW5waXBlKGxlbmd0aEFjY3VtdWxhdG9yKTsKICAgICAgICAgICAgICAgIGxlbmd0aEFjY3VtdWxhdG9yLmVtaXQoJ2VuZCcpOwogICAgICAgICAgICAgICAgbGVuZ3RoQWNjdW11bGF0b3IuZW5kKCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaHR0cFN0cmVhbS5waXBlKGxlbmd0aEFjY3VtdWxhdG9yKS5waXBlKHN0cmVhbSwgeyBlbmQ6IGZhbHNlIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGh0dHBTdHJlYW0ucGlwZShzdHJlYW0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogIAogICAgICAgICAgICBpZiAoc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoKSB7CiAgICAgICAgICAgICAgaHR0cFN0cmVhbS5vbignZGF0YScsIGZ1bmN0aW9uKGFyZykgewogICAgICAgICAgICAgICAgaWYgKGFyZyAmJiBhcmcubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHJlY2VpdmVkTGVuICs9IGFyZy5sZW5ndGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAKICAgICAgICAgICAgaHR0cFN0cmVhbS5vbignZGF0YScsIGZ1bmN0aW9uKGFyZykgewogICAgICAgICAgICAgIHN0cmVhbS5lbWl0KCdkYXRhJywgYXJnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGh0dHBTdHJlYW0ub24oJ2VuZCcsIGNoZWNrQ29udGVudExlbmd0aEFuZEVtaXQpOwogICAgICAgICAgfQogIAogICAgICAgICAgaHR0cFN0cmVhbS5vbignZXJyb3InLCBmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoID0gZmFsc2U7CiAgICAgICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICByZXR1cm4gc3RyZWFtOwogICAgfSwKICAKICAgIC8qKgogICAgICogQHBhcmFtIFtBcnJheSxSZXNwb25zZV0gYXJncyBUaGlzIHNob3VsZCBiZSB0aGUgcmVzcG9uc2Ugb2JqZWN0LAogICAgICogICBvciBhbiBhcnJheSBvZiBhcmdzIHRvIHNlbmQgdG8gdGhlIGV2ZW50LgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGVtaXRFdmVudDogZnVuY3Rpb24gZW1pdChldmVudE5hbWUsIGFyZ3MsIGRvbmUpIHsKICAgICAgaWYgKHR5cGVvZiBhcmdzID09PSAnZnVuY3Rpb24nKSB7IGRvbmUgPSBhcmdzOyBhcmdzID0gbnVsbDsgfQogICAgICBpZiAoIWRvbmUpIGRvbmUgPSBmdW5jdGlvbigpIHsgfTsKICAgICAgaWYgKCFhcmdzKSBhcmdzID0gdGhpcy5ldmVudFBhcmFtZXRlcnMoZXZlbnROYW1lLCB0aGlzLnJlc3BvbnNlKTsKICAKICAgICAgdmFyIG9yaWdFbWl0ID0gQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5wcm90b3R5cGUuZW1pdDsKICAgICAgb3JpZ0VtaXQuY2FsbCh0aGlzLCBldmVudE5hbWUsIGFyZ3MsIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICBpZiAoZXJyKSB0aGlzLnJlc3BvbnNlLmVycm9yID0gZXJyOwogICAgICAgIGRvbmUuY2FsbCh0aGlzLCBlcnIpOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBldmVudFBhcmFtZXRlcnM6IGZ1bmN0aW9uIGV2ZW50UGFyYW1ldGVycyhldmVudE5hbWUpIHsKICAgICAgc3dpdGNoIChldmVudE5hbWUpIHsKICAgICAgICBjYXNlICdyZXN0YXJ0JzoKICAgICAgICBjYXNlICd2YWxpZGF0ZSc6CiAgICAgICAgY2FzZSAnc2lnbic6CiAgICAgICAgY2FzZSAnYnVpbGQnOgogICAgICAgIGNhc2UgJ2FmdGVyVmFsaWRhdGUnOgogICAgICAgIGNhc2UgJ2FmdGVyQnVpbGQnOgogICAgICAgICAgcmV0dXJuIFt0aGlzXTsKICAgICAgICBjYXNlICdlcnJvcic6CiAgICAgICAgICByZXR1cm4gW3RoaXMucmVzcG9uc2UuZXJyb3IsIHRoaXMucmVzcG9uc2VdOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4gW3RoaXMucmVzcG9uc2VdOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgcHJlc2lnbjogZnVuY3Rpb24gcHJlc2lnbihleHBpcmVzLCBjYWxsYmFjaykgewogICAgICBpZiAoIWNhbGxiYWNrICYmIHR5cGVvZiBleHBpcmVzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2FsbGJhY2sgPSBleHBpcmVzOwogICAgICAgIGV4cGlyZXMgPSBudWxsOwogICAgICB9CiAgICAgIHJldHVybiBuZXcgQVdTLlNpZ25lcnMuUHJlc2lnbigpLnNpZ24odGhpcy50b0dldCgpLCBleHBpcmVzLCBjYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaXNQcmVzaWduZWQ6IGZ1bmN0aW9uIGlzUHJlc2lnbmVkKCkgewogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMuaHR0cFJlcXVlc3QuaGVhZGVycywgJ3ByZXNpZ25lZC1leHBpcmVzJyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdG9VbmF1dGhlbnRpY2F0ZWQ6IGZ1bmN0aW9uIHRvVW5hdXRoZW50aWNhdGVkKCkgewogICAgICB0aGlzLl91bkF1dGhlbnRpY2F0ZWQgPSB0cnVlOwogICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX0NSRURFTlRJQUxTKTsKICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcignc2lnbicsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlNJR04pOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICB0b0dldDogZnVuY3Rpb24gdG9HZXQoKSB7CiAgICAgIGlmICh0aGlzLnNlcnZpY2UuYXBpLnByb3RvY29sID09PSAncXVlcnknIHx8CiAgICAgICAgICB0aGlzLnNlcnZpY2UuYXBpLnByb3RvY29sID09PSAnZWMyJykgewogICAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ2J1aWxkJywgdGhpcy5idWlsZEFzR2V0KTsKICAgICAgICB0aGlzLmFkZExpc3RlbmVyKCdidWlsZCcsIHRoaXMuYnVpbGRBc0dldCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYnVpbGRBc0dldDogZnVuY3Rpb24gYnVpbGRBc0dldChyZXF1ZXN0KSB7CiAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QubWV0aG9kID0gJ0dFVCc7CiAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QucGF0aCA9IHJlcXVlc3Quc2VydmljZS5lbmRwb2ludC5wYXRoICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJz8nICsgcmVxdWVzdC5odHRwUmVxdWVzdC5ib2R5OwogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmJvZHkgPSAnJzsKICAKICAgICAgLy8gZG9uJ3QgbmVlZCB0aGVzZSBoZWFkZXJzIG9uIGEgR0VUIHJlcXVlc3QKICAgICAgZGVsZXRlIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1MZW5ndGgnXTsKICAgICAgZGVsZXRlIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ107CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaGFsdEhhbmRsZXJzT25FcnJvcjogZnVuY3Rpb24gaGFsdEhhbmRsZXJzT25FcnJvcigpIHsKICAgICAgdGhpcy5faGFsdEhhbmRsZXJzT25FcnJvciA9IHRydWU7CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlJlcXVlc3QuYWRkUHJvbWlzZXNUb0NsYXNzID0gZnVuY3Rpb24gYWRkUHJvbWlzZXNUb0NsYXNzKFByb21pc2VEZXBlbmRlbmN5KSB7CiAgICB0aGlzLnByb3RvdHlwZS5wcm9taXNlID0gZnVuY3Rpb24gcHJvbWlzZSgpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAvLyBhcHBlbmQgdG8gdXNlciBhZ2VudAogICAgICB0aGlzLmh0dHBSZXF1ZXN0LmFwcGVuZFRvVXNlckFnZW50KCdwcm9taXNlJyk7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZURlcGVuZGVuY3koZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgc2VsZi5vbignY29tcGxldGUnLCBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgICBpZiAocmVzcC5lcnJvcikgewogICAgICAgICAgICByZWplY3QocmVzcC5lcnJvcik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBkZWZpbmUgJHJlc3BvbnNlIHByb3BlcnR5IHNvIHRoYXQgaXQgaXMgbm90IGVudW1iZXJhYmxlCiAgICAgICAgICAgIC8vIHRoaXMgcHJldmVudHMgY2lyY3VsYXIgcmVmZXJlbmNlIGVycm9ycyB3aGVuIHN0cmluZ2lmeWluZyB0aGUgSlNPTiBvYmplY3QKICAgICAgICAgICAgcmVzb2x2ZShPYmplY3QuZGVmaW5lUHJvcGVydHkoCiAgICAgICAgICAgICAgcmVzcC5kYXRhIHx8IHt9LAogICAgICAgICAgICAgICckcmVzcG9uc2UnLAogICAgICAgICAgICAgIHt2YWx1ZTogcmVzcH0KICAgICAgICAgICAgKSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgc2VsZi5ydW5UbygpOwogICAgICB9KTsKICAgIH07CiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuUmVxdWVzdC5kZWxldGVQcm9taXNlc0Zyb21DbGFzcyA9IGZ1bmN0aW9uIGRlbGV0ZVByb21pc2VzRnJvbUNsYXNzKCkgewogICAgZGVsZXRlIHRoaXMucHJvdG90eXBlLnByb21pc2U7CiAgfTsKICAKICBBV1MudXRpbC5hZGRQcm9taXNlcyhBV1MuUmVxdWVzdCk7CiAgCiAgQVdTLnV0aWwubWl4aW4oQVdTLlJlcXVlc3QsIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IpOwogIAogIH0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQogIH0seyIuL2NvcmUiOjE4LCIuL3N0YXRlX21hY2hpbmUiOjcwLCJfcHJvY2VzcyI6ODUsImptZXNwYXRoIjo4NH1dLDU2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvKioKICAgKiBDb3B5cmlnaHQgMjAxMi0yMDEzIEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAgICoKICAgKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKS4gWW91CiAgICogbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZgogICAqIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXQKICAgKgogICAqICAgICBodHRwOi8vYXdzLmFtYXpvbi5jb20vYXBhY2hlMi4wLwogICAqCiAgICogb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcwogICAqIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GCiAgICogQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljCiAgICogbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICAgKi8KICAKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIHZhciBqbWVzcGF0aCA9IHJlcXVpcmUoJ2ptZXNwYXRoJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gQ0hFQ0tfQUNDRVBUT1JTKHJlc3ApIHsKICAgIHZhciB3YWl0ZXIgPSByZXNwLnJlcXVlc3QuX3dhaXRlcjsKICAgIHZhciBhY2NlcHRvcnMgPSB3YWl0ZXIuY29uZmlnLmFjY2VwdG9yczsKICAgIHZhciBhY2NlcHRvck1hdGNoZWQgPSBmYWxzZTsKICAgIHZhciBzdGF0ZSA9ICdyZXRyeSc7CiAgCiAgICBhY2NlcHRvcnMuZm9yRWFjaChmdW5jdGlvbihhY2NlcHRvcikgewogICAgICBpZiAoIWFjY2VwdG9yTWF0Y2hlZCkgewogICAgICAgIHZhciBtYXRjaGVyID0gd2FpdGVyLm1hdGNoZXJzW2FjY2VwdG9yLm1hdGNoZXJdOwogICAgICAgIGlmIChtYXRjaGVyICYmIG1hdGNoZXIocmVzcCwgYWNjZXB0b3IuZXhwZWN0ZWQsIGFjY2VwdG9yLmFyZ3VtZW50KSkgewogICAgICAgICAgYWNjZXB0b3JNYXRjaGVkID0gdHJ1ZTsKICAgICAgICAgIHN0YXRlID0gYWNjZXB0b3Iuc3RhdGU7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAKICAgIGlmICghYWNjZXB0b3JNYXRjaGVkICYmIHJlc3AuZXJyb3IpIHN0YXRlID0gJ2ZhaWx1cmUnOwogIAogICAgaWYgKHN0YXRlID09PSAnc3VjY2VzcycpIHsKICAgICAgd2FpdGVyLnNldFN1Y2Nlc3MocmVzcCk7CiAgICB9IGVsc2UgewogICAgICB3YWl0ZXIuc2V0RXJyb3IocmVzcCwgc3RhdGUgPT09ICdyZXRyeScpOwogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuUmVzb3VyY2VXYWl0ZXIgPSBpbmhlcml0KHsKICAgIC8qKgogICAgICogV2FpdHMgZm9yIGEgZ2l2ZW4gc3RhdGUgb24gYSBzZXJ2aWNlIG9iamVjdAogICAgICogQHBhcmFtIHNlcnZpY2UgW1NlcnZpY2VdIHRoZSBzZXJ2aWNlIG9iamVjdCB0byB3YWl0IG9uCiAgICAgKiBAcGFyYW0gc3RhdGUgW1N0cmluZ10gdGhlIHN0YXRlIChkZWZpbmVkIGluIHdhaXRlciBjb25maWd1cmF0aW9uKSB0byB3YWl0CiAgICAgKiAgIGZvci4KICAgICAqIEBleGFtcGxlIENyZWF0ZSBhIHdhaXRlciBmb3IgcnVubmluZyBFQzIgaW5zdGFuY2VzCiAgICAgKiAgIHZhciBlYzIgPSBuZXcgQVdTLkVDMjsKICAgICAqICAgdmFyIHdhaXRlciA9IG5ldyBBV1MuUmVzb3VyY2VXYWl0ZXIoZWMyLCAnaW5zdGFuY2VSdW5uaW5nJyk7CiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBjb25zdHJ1Y3RvcihzZXJ2aWNlLCBzdGF0ZSkgewogICAgICB0aGlzLnNlcnZpY2UgPSBzZXJ2aWNlOwogICAgICB0aGlzLnN0YXRlID0gc3RhdGU7CiAgICAgIHRoaXMubG9hZFdhaXRlckNvbmZpZyh0aGlzLnN0YXRlKTsKICAgIH0sCiAgCiAgICBzZXJ2aWNlOiBudWxsLAogIAogICAgc3RhdGU6IG51bGwsCiAgCiAgICBjb25maWc6IG51bGwsCiAgCiAgICBtYXRjaGVyczogewogICAgICBwYXRoOiBmdW5jdGlvbihyZXNwLCBleHBlY3RlZCwgYXJndW1lbnQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIHJlc3VsdCA9IGptZXNwYXRoLnNlYXJjaChyZXNwLmRhdGEsIGFyZ3VtZW50KTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgCiAgICAgICAgcmV0dXJuIGptZXNwYXRoLnN0cmljdERlZXBFcXVhbChyZXN1bHQsZXhwZWN0ZWQpOwogICAgICB9LAogIAogICAgICBwYXRoQWxsOiBmdW5jdGlvbihyZXNwLCBleHBlY3RlZCwgYXJndW1lbnQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIHJlc3VsdHMgPSBqbWVzcGF0aC5zZWFyY2gocmVzcC5kYXRhLCBhcmd1bWVudCk7CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogIAogICAgICAgIGlmICghQXJyYXkuaXNBcnJheShyZXN1bHRzKSkgcmVzdWx0cyA9IFtyZXN1bHRzXTsKICAgICAgICB2YXIgbnVtUmVzdWx0cyA9IHJlc3VsdHMubGVuZ3RoOwogICAgICAgIGlmICghbnVtUmVzdWx0cykgcmV0dXJuIGZhbHNlOwogICAgICAgIGZvciAodmFyIGluZCA9IDAgOyBpbmQgPCBudW1SZXN1bHRzOyBpbmQrKykgewogICAgICAgICAgaWYgKCFqbWVzcGF0aC5zdHJpY3REZWVwRXF1YWwocmVzdWx0c1tpbmRdLCBleHBlY3RlZCkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSwKICAKICAgICAgcGF0aEFueTogZnVuY3Rpb24ocmVzcCwgZXhwZWN0ZWQsIGFyZ3VtZW50KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciByZXN1bHRzID0gam1lc3BhdGguc2VhcmNoKHJlc3AuZGF0YSwgYXJndW1lbnQpOwogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAKICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkocmVzdWx0cykpIHJlc3VsdHMgPSBbcmVzdWx0c107CiAgICAgICAgdmFyIG51bVJlc3VsdHMgPSByZXN1bHRzLmxlbmd0aDsKICAgICAgICBmb3IgKHZhciBpbmQgPSAwIDsgaW5kIDwgbnVtUmVzdWx0czsgaW5kKyspIHsKICAgICAgICAgIGlmIChqbWVzcGF0aC5zdHJpY3REZWVwRXF1YWwocmVzdWx0c1tpbmRdLCBleHBlY3RlZCkpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAKICAgICAgc3RhdHVzOiBmdW5jdGlvbihyZXNwLCBleHBlY3RlZCkgewogICAgICAgIHZhciBzdGF0dXNDb2RlID0gcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICByZXR1cm4gKHR5cGVvZiBzdGF0dXNDb2RlID09PSAnbnVtYmVyJykgJiYgKHN0YXR1c0NvZGUgPT09IGV4cGVjdGVkKTsKICAgICAgfSwKICAKICAgICAgZXJyb3I6IGZ1bmN0aW9uKHJlc3AsIGV4cGVjdGVkKSB7CiAgICAgICAgaWYgKHR5cGVvZiBleHBlY3RlZCA9PT0gJ3N0cmluZycgJiYgcmVzcC5lcnJvcikgewogICAgICAgICAgcmV0dXJuIGV4cGVjdGVkID09PSByZXNwLmVycm9yLmNvZGU7CiAgICAgICAgfQogICAgICAgIC8vIGlmIGV4cGVjdGVkIGlzIG5vdCBzdHJpbmcsIGNhbiBiZSBib29sZWFuIGluZGljYXRpbmcgcHJlc2VuY2Ugb2YgZXJyb3IKICAgICAgICByZXR1cm4gZXhwZWN0ZWQgPT09ICEhcmVzcC5lcnJvcjsKICAgICAgfQogICAgfSwKICAKICAgIGxpc3RlbmVyczogbmV3IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgYWRkKCdSRVRSWV9DSEVDSycsICdyZXRyeScsIGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICB2YXIgd2FpdGVyID0gcmVzcC5yZXF1ZXN0Ll93YWl0ZXI7CiAgICAgICAgaWYgKHJlc3AuZXJyb3IgJiYgcmVzcC5lcnJvci5jb2RlID09PSAnUmVzb3VyY2VOb3RSZWFkeScpIHsKICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlEZWxheSA9ICh3YWl0ZXIuY29uZmlnLmRlbGF5IHx8IDApICogMTAwMDsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0NIRUNLX09VVFBVVCcsICdleHRyYWN0RGF0YScsIENIRUNLX0FDQ0VQVE9SUyk7CiAgCiAgICAgIGFkZCgnQ0hFQ0tfRVJST1InLCAnZXh0cmFjdEVycm9yJywgQ0hFQ0tfQUNDRVBUT1JTKTsKICAgIH0pLAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtBV1MuUmVxdWVzdF0KICAgICAqLwogICAgd2FpdDogZnVuY3Rpb24gd2FpdChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIGlmICh0eXBlb2YgcGFyYW1zID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2FsbGJhY2sgPSBwYXJhbXM7IHBhcmFtcyA9IHVuZGVmaW5lZDsKICAgICAgfQogIAogICAgICBpZiAocGFyYW1zICYmIHBhcmFtcy4kd2FpdGVyKSB7CiAgICAgICAgcGFyYW1zID0gQVdTLnV0aWwuY29weShwYXJhbXMpOwogICAgICAgIGlmICh0eXBlb2YgcGFyYW1zLiR3YWl0ZXIuZGVsYXkgPT09ICdudW1iZXInKSB7CiAgICAgICAgICB0aGlzLmNvbmZpZy5kZWxheSA9IHBhcmFtcy4kd2FpdGVyLmRlbGF5OwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIHBhcmFtcy4kd2FpdGVyLm1heEF0dGVtcHRzID09PSAnbnVtYmVyJykgewogICAgICAgICAgdGhpcy5jb25maWcubWF4QXR0ZW1wdHMgPSBwYXJhbXMuJHdhaXRlci5tYXhBdHRlbXB0czsKICAgICAgICB9CiAgICAgICAgZGVsZXRlIHBhcmFtcy4kd2FpdGVyOwogICAgICB9CiAgCiAgICAgIHZhciByZXF1ZXN0ID0gdGhpcy5zZXJ2aWNlLm1ha2VSZXF1ZXN0KHRoaXMuY29uZmlnLm9wZXJhdGlvbiwgcGFyYW1zKTsKICAgICAgcmVxdWVzdC5fd2FpdGVyID0gdGhpczsKICAgICAgcmVxdWVzdC5yZXNwb25zZS5tYXhSZXRyaWVzID0gdGhpcy5jb25maWcubWF4QXR0ZW1wdHM7CiAgICAgIHJlcXVlc3QuYWRkTGlzdGVuZXJzKHRoaXMubGlzdGVuZXJzKTsKICAKICAgICAgaWYgKGNhbGxiYWNrKSByZXF1ZXN0LnNlbmQoY2FsbGJhY2spOwogICAgICByZXR1cm4gcmVxdWVzdDsKICAgIH0sCiAgCiAgICBzZXRTdWNjZXNzOiBmdW5jdGlvbiBzZXRTdWNjZXNzKHJlc3ApIHsKICAgICAgcmVzcC5lcnJvciA9IG51bGw7CiAgICAgIHJlc3AuZGF0YSA9IHJlc3AuZGF0YSB8fCB7fTsKICAgICAgcmVzcC5yZXF1ZXN0LnJlbW92ZUFsbExpc3RlbmVycygnZXh0cmFjdERhdGEnKTsKICAgIH0sCiAgCiAgICBzZXRFcnJvcjogZnVuY3Rpb24gc2V0RXJyb3IocmVzcCwgcmV0cnlhYmxlKSB7CiAgICAgIHJlc3AuZGF0YSA9IG51bGw7CiAgICAgIHJlc3AuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihyZXNwLmVycm9yIHx8IG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogJ1Jlc291cmNlTm90UmVhZHknLAogICAgICAgIG1lc3NhZ2U6ICdSZXNvdXJjZSBpcyBub3QgaW4gdGhlIHN0YXRlICcgKyB0aGlzLnN0YXRlLAogICAgICAgIHJldHJ5YWJsZTogcmV0cnlhYmxlCiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogTG9hZHMgd2FpdGVyIGNvbmZpZ3VyYXRpb24gZnJvbSBBUEkgY29uZmlndXJhdGlvbgogICAgICoKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkV2FpdGVyQ29uZmlnOiBmdW5jdGlvbiBsb2FkV2FpdGVyQ29uZmlnKHN0YXRlKSB7CiAgICAgIGlmICghdGhpcy5zZXJ2aWNlLmFwaS53YWl0ZXJzW3N0YXRlXSkgewogICAgICAgIHRocm93IG5ldyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgICAgY29kZTogJ1N0YXRlTm90Rm91bmRFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnU3RhdGUgJyArIHN0YXRlICsgJyBub3QgZm91bmQuJwogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIHRoaXMuY29uZmlnID0gQVdTLnV0aWwuY29weSh0aGlzLnNlcnZpY2UuYXBpLndhaXRlcnNbc3RhdGVdKTsKICAgIH0KICB9KTsKICAKICB9LHsiLi9jb3JlIjoxOCwiam1lc3BhdGgiOjg0fV0sNTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgdmFyIGptZXNwYXRoID0gcmVxdWlyZSgnam1lc3BhdGgnKTsKICAKICAvKioKICAgKiBUaGlzIGNsYXNzIGVuY2Fwc3VsYXRlcyB0aGUgcmVzcG9uc2UgaW5mb3JtYXRpb24KICAgKiBmcm9tIGEgc2VydmljZSByZXF1ZXN0IG9wZXJhdGlvbiBzZW50IHRocm91Z2gge0FXUy5SZXF1ZXN0fS4KICAgKiBUaGUgcmVzcG9uc2Ugb2JqZWN0IGhhcyB0d28gbWFpbiBwcm9wZXJ0aWVzIGZvciBnZXR0aW5nIGluZm9ybWF0aW9uCiAgICogYmFjayBmcm9tIGEgcmVxdWVzdDoKICAgKgogICAqICMjIFRoZSBgZGF0YWAgcHJvcGVydHkKICAgKgogICAqIFRoZSBgcmVzcG9uc2UuZGF0YWAgcHJvcGVydHkgY29udGFpbnMgdGhlIHNlcmlhbGl6ZWQgb2JqZWN0IGRhdGEKICAgKiByZXRyaWV2ZWQgZnJvbSB0aGUgc2VydmljZSByZXF1ZXN0LiBGb3IgaW5zdGFuY2UsIGZvciBhbgogICAqIEFtYXpvbiBEeW5hbW9EQiBgbGlzdFRhYmxlc2AgbWV0aG9kIGNhbGwsIHRoZSByZXNwb25zZSBkYXRhIG1pZ2h0CiAgICogbG9vayBsaWtlOgogICAqCiAgICogYGBgCiAgICogPiByZXNwLmRhdGEKICAgKiB7IFRhYmxlTmFtZXM6CiAgICogICAgWyAndGFibGUxJywgJ3RhYmxlMicsIC4uLiBdIH0KICAgKiBgYGAKICAgKgogICAqIFRoZSBgZGF0YWAgcHJvcGVydHkgY2FuIGJlIG51bGwgaWYgYW4gZXJyb3Igb2NjdXJzIChzZWUgYmVsb3cpLgogICAqCiAgICogIyMgVGhlIGBlcnJvcmAgcHJvcGVydHkKICAgKgogICAqIEluIHRoZSBldmVudCBvZiBhIHNlcnZpY2UgZXJyb3IgKG9yIHRyYW5zZmVyIGVycm9yKSwgdGhlCiAgICogYHJlc3BvbnNlLmVycm9yYCBwcm9wZXJ0eSB3aWxsIGJlIGZpbGxlZCB3aXRoIHRoZSBnaXZlbgogICAqIGVycm9yIGRhdGEgaW4gdGhlIGZvcm06CiAgICoKICAgKiBgYGAKICAgKiB7IGNvZGU6ICdTSE9SVF9VTklRVUVfRVJST1JfQ09ERScsCiAgICogICBtZXNzYWdlOiAnU29tZSBodW1hbiByZWFkYWJsZSBlcnJvciBtZXNzYWdlJyB9CiAgICogYGBgCiAgICoKICAgKiBJbiB0aGUgY2FzZSBvZiBhbiBlcnJvciwgdGhlIGBkYXRhYCBwcm9wZXJ0eSB3aWxsIGJlIGBudWxsYC4KICAgKiBOb3RlIHRoYXQgaWYgeW91IGhhbmRsZSBldmVudHMgdGhhdCBjYW4gYmUgaW4gYSBmYWlsdXJlIHN0YXRlLAogICAqIHlvdSBzaG91bGQgYWx3YXlzIGNoZWNrIHdoZXRoZXIgYHJlc3BvbnNlLmVycm9yYCBpcyBzZXQKICAgKiBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgdGhlIGByZXNwb25zZS5kYXRhYCBwcm9wZXJ0eS4KICAgKgogICAqIEAhYXR0cmlidXRlIGRhdGEKICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBEYXRhIFByb3BlcnRpZXMKICAgKiAgIEBub3RlIEluc2lkZSBvZiBhIHtBV1MuUmVxdWVzdH5odHRwRGF0YX0gZXZlbnQsIHRoaXMKICAgKiAgICAgcHJvcGVydHkgY29udGFpbnMgYSBzaW5nbGUgcmF3IHBhY2tldCBpbnN0ZWFkIG9mIHRoZQogICAqICAgICBmdWxsIGRlLXNlcmlhbGl6ZWQgc2VydmljZSByZXNwb25zZS4KICAgKiAgIEByZXR1cm4gW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgcmVzcG9uc2UgZGF0YQogICAqICAgICBmcm9tIHRoZSBzZXJ2aWNlLgogICAqCiAgICogQCFhdHRyaWJ1dGUgZXJyb3IKICAgKiAgIEFuIHN0cnVjdHVyZSBjb250YWluaW5nIGluZm9ybWF0aW9uIGFib3V0IGEgc2VydmljZQogICAqICAgb3IgbmV0d29ya2luZyBlcnJvci4KICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBEYXRhIFByb3BlcnRpZXMKICAgKiAgIEBub3RlIFRoaXMgYXR0cmlidXRlIGlzIG9ubHkgZmlsbGVkIGlmIGEgc2VydmljZSBvcgogICAqICAgICBuZXR3b3JraW5nIGVycm9yIG9jY3Vycy4KICAgKiAgIEByZXR1cm4gW0Vycm9yXQogICAqICAgICAqIGNvZGUgW1N0cmluZ10gYSB1bmlxdWUgc2hvcnQgY29kZSByZXByZXNlbnRpbmcgdGhlCiAgICogICAgICAgZXJyb3IgdGhhdCB3YXMgZW1pdHRlZC4KICAgKiAgICAgKiBtZXNzYWdlIFtTdHJpbmddIGEgbG9uZ2VyIGh1bWFuIHJlYWRhYmxlIGVycm9yIG1lc3NhZ2UKICAgKiAgICAgKiByZXRyeWFibGUgW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIGVycm9yIG1lc3NhZ2UgaXMKICAgKiAgICAgICByZXRyeWFibGUuCiAgICogICAgICogc3RhdHVzQ29kZSBbTnVtZXJpY10gaW4gdGhlIGNhc2Ugb2YgYSByZXF1ZXN0IHRoYXQgcmVhY2hlZCB0aGUgc2VydmljZSwKICAgKiAgICAgICB0aGlzIHZhbHVlIGNvbnRhaW5zIHRoZSByZXNwb25zZSBzdGF0dXMgY29kZS4KICAgKiAgICAgKiB0aW1lIFtEYXRlXSB0aGUgZGF0ZSB0aW1lIG9iamVjdCB3aGVuIHRoZSBlcnJvciBvY2N1cnJlZC4KICAgKiAgICAgKiBob3N0bmFtZSBbU3RyaW5nXSBzZXQgd2hlbiBhIG5ldHdvcmtpbmcgZXJyb3Igb2NjdXJzIHRvIGVhc2lseQogICAqICAgICAgIGlkZW50aWZ5IHRoZSBlbmRwb2ludCBvZiB0aGUgcmVxdWVzdC4KICAgKiAgICAgKiByZWdpb24gW1N0cmluZ10gc2V0IHdoZW4gYSBuZXR3b3JraW5nIGVycm9yIG9jY3VycyB0byBlYXNpbHkKICAgKiAgICAgICBpZGVudGlmeSB0aGUgcmVnaW9uIG9mIHRoZSByZXF1ZXN0LgogICAqCiAgICogQCFhdHRyaWJ1dGUgcmVxdWVzdElkCiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgRGF0YSBQcm9wZXJ0aWVzCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSB1bmlxdWUgcmVxdWVzdCBJRCBhc3NvY2lhdGVkIHdpdGggdGhlIHJlc3BvbnNlLgogICAqICAgICBMb2cgdGhpcyB2YWx1ZSB3aGVuIGRlYnVnZ2luZyByZXF1ZXN0cyBmb3IgQVdTIHN1cHBvcnQuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSByZXRyeUNvdW50CiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgT3BlcmF0aW9uIFByb3BlcnRpZXMKICAgKiAgIEByZXR1cm4gW0ludGVnZXJdIHRoZSBudW1iZXIgb2YgcmV0cmllcyB0aGF0IHdlcmUKICAgKiAgICAgYXR0ZW1wdGVkIGJlZm9yZSB0aGUgcmVxdWVzdCB3YXMgY29tcGxldGVkLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcmVkaXJlY3RDb3VudAogICAqICAgQHJlYWRvbmx5CiAgICogICBAIWdyb3VwIE9wZXJhdGlvbiBQcm9wZXJ0aWVzCiAgICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbnVtYmVyIG9mIHJlZGlyZWN0cyB0aGF0IHdlcmUKICAgKiAgICAgZm9sbG93ZWQgYmVmb3JlIHRoZSByZXF1ZXN0IHdhcyBjb21wbGV0ZWQuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBodHRwUmVzcG9uc2UKICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBIVFRQIFByb3BlcnRpZXMKICAgKiAgIEByZXR1cm4gW0FXUy5IdHRwUmVzcG9uc2VdIHRoZSByYXcgSFRUUCByZXNwb25zZSBvYmplY3QKICAgKiAgICAgY29udGFpbmluZyB0aGUgcmVzcG9uc2UgaGVhZGVycyBhbmQgYm9keSBpbmZvcm1hdGlvbgogICAqICAgICBmcm9tIHRoZSBzZXJ2ZXIuCiAgICoKICAgKiBAc2VlIEFXUy5SZXF1ZXN0CiAgICovCiAgQVdTLlJlc3BvbnNlID0gaW5oZXJpdCh7CiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gUmVzcG9uc2UocmVxdWVzdCkgewogICAgICB0aGlzLnJlcXVlc3QgPSByZXF1ZXN0OwogICAgICB0aGlzLmRhdGEgPSBudWxsOwogICAgICB0aGlzLmVycm9yID0gbnVsbDsKICAgICAgdGhpcy5yZXRyeUNvdW50ID0gMDsKICAgICAgdGhpcy5yZWRpcmVjdENvdW50ID0gMDsKICAgICAgdGhpcy5odHRwUmVzcG9uc2UgPSBuZXcgQVdTLkh0dHBSZXNwb25zZSgpOwogICAgICBpZiAocmVxdWVzdCkgewogICAgICAgIHRoaXMubWF4UmV0cmllcyA9IHJlcXVlc3Quc2VydmljZS5udW1SZXRyaWVzKCk7CiAgICAgICAgdGhpcy5tYXhSZWRpcmVjdHMgPSByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLm1heFJlZGlyZWN0czsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyByZXF1ZXN0IGZvciB0aGUgbmV4dCBwYWdlIG9mIHJlc3BvbnNlIGRhdGEsIGNhbGxpbmcgdGhlCiAgICAgKiBjYWxsYmFjayB3aXRoIHRoZSBwYWdlIGRhdGEgaWYgYSBjYWxsYmFjayBpcyBwcm92aWRlZC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBkYXRhKQogICAgICogICBDYWxsZWQgd2hlbiBhIHBhZ2Ugb2YgZGF0YSBpcyByZXR1cm5lZCBmcm9tIHRoZSBuZXh0IHJlcXVlc3QuCiAgICAgKgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gYW4gZXJyb3Igb2JqZWN0LCBpZiBhbiBlcnJvciBvY2N1cnJlZCBpbiB0aGUgcmVxdWVzdAogICAgICogICBAcGFyYW0gZGF0YSBbT2JqZWN0XSB0aGUgbmV4dCBwYWdlIG9mIGRhdGEsIG9yIG51bGwsIGlmIHRoZXJlIGFyZSBubwogICAgICogICAgIG1vcmUgcGFnZXMgbGVmdC4KICAgICAqIEByZXR1cm4gW0FXUy5SZXF1ZXN0XSB0aGUgcmVxdWVzdCBvYmplY3QgZm9yIHRoZSBuZXh0IHBhZ2Ugb2YgZGF0YQogICAgICogQHJldHVybiBbbnVsbF0gaWYgbm8gY2FsbGJhY2sgaXMgcHJvdmlkZWQgYW5kIHRoZXJlIGFyZSBubyBwYWdlcyBsZWZ0CiAgICAgKiAgIHRvIHJldHJpZXZlLgogICAgICogQHNpbmNlIHYxLjQuMAogICAgICovCiAgICBuZXh0UGFnZTogZnVuY3Rpb24gbmV4dFBhZ2UoY2FsbGJhY2spIHsKICAgICAgdmFyIGNvbmZpZzsKICAgICAgdmFyIHNlcnZpY2UgPSB0aGlzLnJlcXVlc3Quc2VydmljZTsKICAgICAgdmFyIG9wZXJhdGlvbiA9IHRoaXMucmVxdWVzdC5vcGVyYXRpb247CiAgICAgIHRyeSB7CiAgICAgICAgY29uZmlnID0gc2VydmljZS5wYWdpbmF0aW9uQ29uZmlnKG9wZXJhdGlvbiwgdHJ1ZSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsgdGhpcy5lcnJvciA9IGU7IH0KICAKICAgICAgaWYgKCF0aGlzLmhhc05leHRQYWdlKCkpIHsKICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKHRoaXMuZXJyb3IsIG51bGwpOwogICAgICAgIGVsc2UgaWYgKHRoaXMuZXJyb3IpIHRocm93IHRoaXMuZXJyb3I7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAKICAgICAgdmFyIHBhcmFtcyA9IEFXUy51dGlsLmNvcHkodGhpcy5yZXF1ZXN0LnBhcmFtcyk7CiAgICAgIGlmICghdGhpcy5uZXh0UGFnZVRva2VucykgewogICAgICAgIHJldHVybiBjYWxsYmFjayA/IGNhbGxiYWNrKG51bGwsIG51bGwpIDogbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgaW5wdXRUb2tlbnMgPSBjb25maWcuaW5wdXRUb2tlbjsKICAgICAgICBpZiAodHlwZW9mIGlucHV0VG9rZW5zID09PSAnc3RyaW5nJykgaW5wdXRUb2tlbnMgPSBbaW5wdXRUb2tlbnNdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5wdXRUb2tlbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHBhcmFtc1tpbnB1dFRva2Vuc1tpXV0gPSB0aGlzLm5leHRQYWdlVG9rZW5zW2ldOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc2VydmljZS5tYWtlUmVxdWVzdCh0aGlzLnJlcXVlc3Qub3BlcmF0aW9uLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciBtb3JlIHBhZ2VzIG9mIGRhdGEgY2FuIGJlIHJldHVybmVkIGJ5IGZ1cnRoZXIKICAgICAqICAgcmVxdWVzdHMKICAgICAqIEBzaW5jZSB2MS40LjAKICAgICAqLwogICAgaGFzTmV4dFBhZ2U6IGZ1bmN0aW9uIGhhc05leHRQYWdlKCkgewogICAgICB0aGlzLmNhY2hlTmV4dFBhZ2VUb2tlbnMoKTsKICAgICAgaWYgKHRoaXMubmV4dFBhZ2VUb2tlbnMpIHJldHVybiB0cnVlOwogICAgICBpZiAodGhpcy5uZXh0UGFnZVRva2VucyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICBlbHNlIHJldHVybiBmYWxzZTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjYWNoZU5leHRQYWdlVG9rZW5zOiBmdW5jdGlvbiBjYWNoZU5leHRQYWdlVG9rZW5zKCkgewogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMsICduZXh0UGFnZVRva2VucycpKSByZXR1cm4gdGhpcy5uZXh0UGFnZVRva2VuczsKICAgICAgdGhpcy5uZXh0UGFnZVRva2VucyA9IHVuZGVmaW5lZDsKICAKICAgICAgdmFyIGNvbmZpZyA9IHRoaXMucmVxdWVzdC5zZXJ2aWNlLnBhZ2luYXRpb25Db25maWcodGhpcy5yZXF1ZXN0Lm9wZXJhdGlvbik7CiAgICAgIGlmICghY29uZmlnKSByZXR1cm4gdGhpcy5uZXh0UGFnZVRva2VuczsKICAKICAgICAgdGhpcy5uZXh0UGFnZVRva2VucyA9IG51bGw7CiAgICAgIGlmIChjb25maWcubW9yZVJlc3VsdHMpIHsKICAgICAgICBpZiAoIWptZXNwYXRoLnNlYXJjaCh0aGlzLmRhdGEsIGNvbmZpZy5tb3JlUmVzdWx0cykpIHsKICAgICAgICAgIHJldHVybiB0aGlzLm5leHRQYWdlVG9rZW5zOwogICAgICAgIH0KICAgICAgfQogIAogICAgICB2YXIgZXhwcnMgPSBjb25maWcub3V0cHV0VG9rZW47CiAgICAgIGlmICh0eXBlb2YgZXhwcnMgPT09ICdzdHJpbmcnKSBleHBycyA9IFtleHByc107CiAgICAgIEFXUy51dGlsLmFycmF5RWFjaC5jYWxsKHRoaXMsIGV4cHJzLCBmdW5jdGlvbiAoZXhwcikgewogICAgICAgIHZhciBvdXRwdXQgPSBqbWVzcGF0aC5zZWFyY2godGhpcy5kYXRhLCBleHByKTsKICAgICAgICBpZiAob3V0cHV0KSB7CiAgICAgICAgICB0aGlzLm5leHRQYWdlVG9rZW5zID0gdGhpcy5uZXh0UGFnZVRva2VucyB8fCBbXTsKICAgICAgICAgIHRoaXMubmV4dFBhZ2VUb2tlbnMucHVzaChvdXRwdXQpOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIHJldHVybiB0aGlzLm5leHRQYWdlVG9rZW5zOwogICAgfQogIAogIH0pOwogIAogIH0seyIuL2NvcmUiOjE4LCJqbWVzcGF0aCI6ODR9XSw1ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEAhbWV0aG9kIG9uKGV2ZW50TmFtZSwgY2FsbGJhY2spCiAgICogICBSZWdpc3RlcnMgYW4gZXZlbnQgbGlzdGVuZXIgY2FsbGJhY2sgZm9yIHRoZSBldmVudCBnaXZlbiBieSBgZXZlbnROYW1lYC4KICAgKiAgIFBhcmFtZXRlcnMgcGFzc2VkIHRvIHRoZSBjYWxsYmFjayBmdW5jdGlvbiBkZXBlbmQgb24gdGhlIGluZGl2aWR1YWwgZXZlbnQKICAgKiAgIGJlaW5nIHRyaWdnZXJlZC4gU2VlIHRoZSBldmVudCBkb2N1bWVudGF0aW9uIGZvciB0aG9zZSBwYXJhbWV0ZXJzLgogICAqCiAgICogICBAcGFyYW0gZXZlbnROYW1lIFtTdHJpbmddIHRoZSBldmVudCBuYW1lIHRvIHJlZ2lzdGVyIHRoZSBsaXN0ZW5lciBmb3IKICAgKiAgIEBwYXJhbSBjYWxsYmFjayBbRnVuY3Rpb25dIHRoZSBsaXN0ZW5lciBjYWxsYmFjayBmdW5jdGlvbgogICAqICAgQHBhcmFtIHRvSGVhZCBbQm9vbGVhbl0gYXR0YWNoIHRoZSBsaXN0ZW5lciBjYWxsYmFjayB0byB0aGUgaGVhZCBvZiBjYWxsYmFjayBhcnJheSBpZiBzZXQgdG8gdHJ1ZS4KICAgKiAgICAgRGVmYXVsdCB0byBiZSBmYWxzZS4KICAgKiAgIEByZXR1cm4gW0FXUy5TZXF1ZW50aWFsRXhlY3V0b3JdIHRoZSBzYW1lIG9iamVjdCBmb3IgY2hhaW5pbmcKICAgKi8KICBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yID0gQVdTLnV0aWwuaW5oZXJpdCh7CiAgCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gU2VxdWVudGlhbEV4ZWN1dG9yKCkgewogICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsaXN0ZW5lcnM6IGZ1bmN0aW9uIGxpc3RlbmVycyhldmVudE5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuX2V2ZW50c1tldmVudE5hbWVdID8gdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0uc2xpY2UoMCkgOiBbXTsKICAgIH0sCiAgCiAgICBvbjogZnVuY3Rpb24gb24oZXZlbnROYW1lLCBsaXN0ZW5lciwgdG9IZWFkKSB7CiAgICAgIGlmICh0aGlzLl9ldmVudHNbZXZlbnROYW1lXSkgewogICAgICAgIHRvSGVhZCA/CiAgICAgICAgICB0aGlzLl9ldmVudHNbZXZlbnROYW1lXS51bnNoaWZ0KGxpc3RlbmVyKSA6CiAgICAgICAgICB0aGlzLl9ldmVudHNbZXZlbnROYW1lXS5wdXNoKGxpc3RlbmVyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9ldmVudHNbZXZlbnROYW1lXSA9IFtsaXN0ZW5lcl07CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgb25Bc3luYzogZnVuY3Rpb24gb25Bc3luYyhldmVudE5hbWUsIGxpc3RlbmVyLCB0b0hlYWQpIHsKICAgICAgbGlzdGVuZXIuX2lzQXN5bmMgPSB0cnVlOwogICAgICByZXR1cm4gdGhpcy5vbihldmVudE5hbWUsIGxpc3RlbmVyLCB0b0hlYWQpOwogICAgfSwKICAKICAgIHJlbW92ZUxpc3RlbmVyOiBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcihldmVudE5hbWUsIGxpc3RlbmVyKSB7CiAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbZXZlbnROYW1lXTsKICAgICAgaWYgKGxpc3RlbmVycykgewogICAgICAgIHZhciBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoOwogICAgICAgIHZhciBwb3NpdGlvbiA9IC0xOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGlmIChsaXN0ZW5lcnNbaV0gPT09IGxpc3RlbmVyKSB7CiAgICAgICAgICAgIHBvc2l0aW9uID0gaTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHBvc2l0aW9uID4gLTEpIHsKICAgICAgICAgIGxpc3RlbmVycy5zcGxpY2UocG9zaXRpb24sIDEpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICByZW1vdmVBbGxMaXN0ZW5lcnM6IGZ1bmN0aW9uIHJlbW92ZUFsbExpc3RlbmVycyhldmVudE5hbWUpIHsKICAgICAgaWYgKGV2ZW50TmFtZSkgewogICAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbZXZlbnROYW1lXTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBlbWl0OiBmdW5jdGlvbiBlbWl0KGV2ZW50TmFtZSwgZXZlbnRBcmdzLCBkb25lQ2FsbGJhY2spIHsKICAgICAgaWYgKCFkb25lQ2FsbGJhY2spIGRvbmVDYWxsYmFjayA9IGZ1bmN0aW9uKCkgeyB9OwogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5saXN0ZW5lcnMoZXZlbnROYW1lKTsKICAgICAgdmFyIGNvdW50ID0gbGlzdGVuZXJzLmxlbmd0aDsKICAgICAgdGhpcy5jYWxsTGlzdGVuZXJzKGxpc3RlbmVycywgZXZlbnRBcmdzLCBkb25lQ2FsbGJhY2spOwogICAgICByZXR1cm4gY291bnQgPiAwOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNhbGxMaXN0ZW5lcnM6IGZ1bmN0aW9uIGNhbGxMaXN0ZW5lcnMobGlzdGVuZXJzLCBhcmdzLCBkb25lQ2FsbGJhY2ssIHByZXZFcnJvcikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBlcnJvciA9IHByZXZFcnJvciB8fCBudWxsOwogIAogICAgICBmdW5jdGlvbiBjYWxsTmV4dExpc3RlbmVyKGVycikgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIGVycm9yID0gQVdTLnV0aWwuZXJyb3IoZXJyb3IgfHwgbmV3IEVycm9yKCksIGVycik7CiAgICAgICAgICBpZiAoc2VsZi5faGFsdEhhbmRsZXJzT25FcnJvcikgewogICAgICAgICAgICByZXR1cm4gZG9uZUNhbGxiYWNrLmNhbGwoc2VsZiwgZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZWxmLmNhbGxMaXN0ZW5lcnMobGlzdGVuZXJzLCBhcmdzLCBkb25lQ2FsbGJhY2ssIGVycm9yKTsKICAgICAgfQogIAogICAgICB3aGlsZSAobGlzdGVuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgbGlzdGVuZXIgPSBsaXN0ZW5lcnMuc2hpZnQoKTsKICAgICAgICBpZiAobGlzdGVuZXIuX2lzQXN5bmMpIHsgLy8gYXN5bmNocm9ub3VzIGxpc3RlbmVyCiAgICAgICAgICBsaXN0ZW5lci5hcHBseShzZWxmLCBhcmdzLmNvbmNhdChbY2FsbE5leHRMaXN0ZW5lcl0pKTsKICAgICAgICAgIHJldHVybjsgLy8gc3RvcCBoZXJlLCBjYWxsTmV4dExpc3RlbmVyIHdpbGwgY29udGludWUKICAgICAgICB9IGVsc2UgeyAvLyBzeW5jaHJvbm91cyBsaXN0ZW5lcgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbGlzdGVuZXIuYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgZXJyb3IgPSBBV1MudXRpbC5lcnJvcihlcnJvciB8fCBuZXcgRXJyb3IoKSwgZXJyKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChlcnJvciAmJiBzZWxmLl9oYWx0SGFuZGxlcnNPbkVycm9yKSB7CiAgICAgICAgICAgIGRvbmVDYWxsYmFjay5jYWxsKHNlbGYsIGVycm9yKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBkb25lQ2FsbGJhY2suY2FsbChzZWxmLCBlcnJvcik7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBBZGRzIG9yIGNvcGllcyBhIHNldCBvZiBsaXN0ZW5lcnMgZnJvbSBhbm90aGVyIGxpc3Qgb2YKICAgICAqIGxpc3RlbmVycyBvciBTZXF1ZW50aWFsRXhlY3V0b3Igb2JqZWN0LgogICAgICoKICAgICAqIEBwYXJhbSBsaXN0ZW5lcnMgW21hcDxTdHJpbmcsQXJyYXk8RnVuY3Rpb24+PiwgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcl0KICAgICAqICAgYSBsaXN0IG9mIGV2ZW50cyBhbmQgY2FsbGJhY2tzLCBvciBhbiBldmVudCBlbWl0dGVyIG9iamVjdAogICAgICogICBjb250YWluaW5nIGxpc3RlbmVycyB0byBhZGQgdG8gdGhpcyBlbWl0dGVyIG9iamVjdC4KICAgICAqIEByZXR1cm4gW0FXUy5TZXF1ZW50aWFsRXhlY3V0b3JdIHRoZSBlbWl0dGVyIG9iamVjdCwgZm9yIGNoYWluaW5nLgogICAgICogQGV4YW1wbGUgQWRkaW5nIGxpc3RlbmVycyBmcm9tIGEgbWFwIG9mIGxpc3RlbmVycwogICAgICogICBlbWl0dGVyLmFkZExpc3RlbmVycyh7CiAgICAgKiAgICAgZXZlbnQxOiBbZnVuY3Rpb24oKSB7IC4uLiB9LCBmdW5jdGlvbigpIHsgLi4uIH1dLAogICAgICogICAgIGV2ZW50MjogW2Z1bmN0aW9uKCkgeyAuLi4gfV0KICAgICAqICAgfSk7CiAgICAgKiAgIGVtaXR0ZXIuZW1pdCgnZXZlbnQxJyk7IC8vIGVtaXR0ZXIgaGFzIGV2ZW50MQogICAgICogICBlbWl0dGVyLmVtaXQoJ2V2ZW50MicpOyAvLyBlbWl0dGVyIGhhcyBldmVudDIKICAgICAqIEBleGFtcGxlIEFkZGluZyBsaXN0ZW5lcnMgZnJvbSBhbm90aGVyIGVtaXR0ZXIgb2JqZWN0CiAgICAgKiAgIHZhciBlbWl0dGVyMSA9IG5ldyBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKCk7CiAgICAgKiAgIGVtaXR0ZXIxLm9uKCdldmVudDEnLCBmdW5jdGlvbigpIHsgLi4uIH0pOwogICAgICogICBlbWl0dGVyMS5vbignZXZlbnQyJywgZnVuY3Rpb24oKSB7IC4uLiB9KTsKICAgICAqICAgdmFyIGVtaXR0ZXIyID0gbmV3IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IoKTsKICAgICAqICAgZW1pdHRlcjIuYWRkTGlzdGVuZXJzKGVtaXR0ZXIxKTsKICAgICAqICAgZW1pdHRlcjIuZW1pdCgnZXZlbnQxJyk7IC8vIGVtaXR0ZXIyIGhhcyBldmVudDEKICAgICAqICAgZW1pdHRlcjIuZW1pdCgnZXZlbnQyJyk7IC8vIGVtaXR0ZXIyIGhhcyBldmVudDIKICAgICAqLwogICAgYWRkTGlzdGVuZXJzOiBmdW5jdGlvbiBhZGRMaXN0ZW5lcnMobGlzdGVuZXJzKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAKICAgICAgLy8gZXh0cmFjdCBsaXN0ZW5lcnMgaWYgcGFyYW1ldGVyIGlzIGFuIFNlcXVlbnRpYWxFeGVjdXRvciBvYmplY3QKICAgICAgaWYgKGxpc3RlbmVycy5fZXZlbnRzKSBsaXN0ZW5lcnMgPSBsaXN0ZW5lcnMuX2V2ZW50czsKICAKICAgICAgQVdTLnV0aWwuZWFjaChsaXN0ZW5lcnMsIGZ1bmN0aW9uKGV2ZW50LCBjYWxsYmFja3MpIHsKICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrcyA9PT0gJ2Z1bmN0aW9uJykgY2FsbGJhY2tzID0gW2NhbGxiYWNrc107CiAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKGNhbGxiYWNrcywgZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgIHNlbGYub24oZXZlbnQsIGNhbGxiYWNrKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgCiAgICAgIHJldHVybiBzZWxmOwogICAgfSwKICAKICAgIC8qKgogICAgICogUmVnaXN0ZXJzIGFuIGV2ZW50IHdpdGgge29ufSBhbmQgc2F2ZXMgdGhlIGNhbGxiYWNrIGhhbmRsZSBmdW5jdGlvbgogICAgICogYXMgYSBwcm9wZXJ0eSBvbiB0aGUgZW1pdHRlciBvYmplY3QgdXNpbmcgYSBnaXZlbiBgbmFtZWAuCiAgICAgKgogICAgICogQHBhcmFtIG5hbWUgW1N0cmluZ10gdGhlIHByb3BlcnR5IG5hbWUgdG8gc2V0IG9uIHRoaXMgb2JqZWN0IGNvbnRhaW5pbmcKICAgICAqICAgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIGhhbmRsZSBzbyB0aGF0IHRoZSBsaXN0ZW5lciBjYW4gYmUgcmVtb3ZlZCBpbgogICAgICogICB0aGUgZnV0dXJlLgogICAgICogQHBhcmFtIChzZWUgb24pCiAgICAgKiBAcmV0dXJuIChzZWUgb24pCiAgICAgKiBAZXhhbXBsZSBBZGRpbmcgYSBuYW1lZCBsaXN0ZW5lciBEQVRBX0NBTExCQUNLCiAgICAgKiAgIHZhciBsaXN0ZW5lciA9IGZ1bmN0aW9uKCkgeyBkb1NvbWV0aGluZygpOyB9OwogICAgICogICBlbWl0dGVyLmFkZE5hbWVkTGlzdGVuZXIoJ0RBVEFfQ0FMTEJBQ0snLCAnZGF0YScsIGxpc3RlbmVyKTsKICAgICAqCiAgICAgKiAgIC8vIHRoZSBmb2xsb3dpbmcgcHJpbnRzOiB0cnVlCiAgICAgKiAgIGNvbnNvbGUubG9nKGVtaXR0ZXIuREFUQV9DQUxMQkFDSyA9PSBsaXN0ZW5lcik7CiAgICAgKi8KICAgIGFkZE5hbWVkTGlzdGVuZXI6IGZ1bmN0aW9uIGFkZE5hbWVkTGlzdGVuZXIobmFtZSwgZXZlbnROYW1lLCBjYWxsYmFjaywgdG9IZWFkKSB7CiAgICAgIHRoaXNbbmFtZV0gPSBjYWxsYmFjazsKICAgICAgdGhpcy5hZGRMaXN0ZW5lcihldmVudE5hbWUsIGNhbGxiYWNrLCB0b0hlYWQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhZGROYW1lZEFzeW5jTGlzdGVuZXI6IGZ1bmN0aW9uIGFkZE5hbWVkQXN5bmNMaXN0ZW5lcihuYW1lLCBldmVudE5hbWUsIGNhbGxiYWNrLCB0b0hlYWQpIHsKICAgICAgY2FsbGJhY2suX2lzQXN5bmMgPSB0cnVlOwogICAgICByZXR1cm4gdGhpcy5hZGROYW1lZExpc3RlbmVyKG5hbWUsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIHRvSGVhZCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBIZWxwZXIgbWV0aG9kIHRvIGFkZCBhIHNldCBvZiBuYW1lZCBsaXN0ZW5lcnMgdXNpbmcKICAgICAqIHthZGROYW1lZExpc3RlbmVyfS4gVGhlIGNhbGxiYWNrIGNvbnRhaW5zIGEgcGFyYW1ldGVyCiAgICAgKiB3aXRoIGEgaGFuZGxlIHRvIHRoZSBgYWRkTmFtZWRMaXN0ZW5lcmAgbWV0aG9kLgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihhZGQpCiAgICAgKiAgIFRoZSBjYWxsYmFjayBmdW5jdGlvbiBpcyBjYWxsZWQgaW1tZWRpYXRlbHkgaW4gb3JkZXIgdG8gcHJvdmlkZQogICAgICogICB0aGUgYGFkZGAgZnVuY3Rpb24gdG8gdGhlIGJsb2NrLiBUaGlzIHNpbXBsaWZpZXMgdGhlIGFkZGl0aW9uIG9mCiAgICAgKiAgIGEgbGFyZ2UgZ3JvdXAgb2YgbmFtZWQgbGlzdGVuZXJzLgogICAgICogICBAcGFyYW0gYWRkIFtGdW5jdGlvbl0gdGhlIHthZGROYW1lZExpc3RlbmVyfSBmdW5jdGlvbiB0byBjYWxsCiAgICAgKiAgICAgd2hlbiByZWdpc3RlcmluZyBsaXN0ZW5lcnMuCiAgICAgKiBAZXhhbXBsZSBBZGRpbmcgYSBzZXQgb2YgbmFtZWQgbGlzdGVuZXJzCiAgICAgKiAgIGVtaXR0ZXIuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICAgKiAgICAgYWRkKCdEQVRBX0NBTExCQUNLJywgJ2RhdGEnLCBmdW5jdGlvbigpIHsgLi4uIH0pOwogICAgICogICAgIGFkZCgnT1RIRVInLCAnb3RoZXJFdmVudCcsIGZ1bmN0aW9uKCkgeyAuLi4gfSk7CiAgICAgKiAgICAgYWRkKCdMQVNUJywgJ2xhc3RFdmVudCcsIGZ1bmN0aW9uKCkgeyAuLi4gfSk7CiAgICAgKiAgIH0pOwogICAgICoKICAgICAqICAgLy8gdGhlc2UgcHJvcGVydGllcyBhcmUgbm93IHNldDoKICAgICAqICAgZW1pdHRlci5EQVRBX0NBTExCQUNLOwogICAgICogICBlbWl0dGVyLk9USEVSOwogICAgICogICBlbWl0dGVyLkxBU1Q7CiAgICAgKi8KICAgIGFkZE5hbWVkTGlzdGVuZXJzOiBmdW5jdGlvbiBhZGROYW1lZExpc3RlbmVycyhjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGNhbGxiYWNrKAogICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgc2VsZi5hZGROYW1lZExpc3RlbmVyLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CiAgICAgICAgfSwKICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgIHNlbGYuYWRkTmFtZWRBc3luY0xpc3RlbmVyLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgICApOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiB7b259IGlzIHRoZSBwcmVmZXJlZCBtZXRob2QuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5wcm90b3R5cGUuYWRkTGlzdGVuZXIgPSBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLnByb3RvdHlwZS5vbjsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3I7CiAgCiAgfSx7Ii4vY29yZSI6MTh9XSw1OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChwcm9jZXNzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgdmFyIEFwaSA9IHJlcXVpcmUoJy4vbW9kZWwvYXBpJyk7CiAgdmFyIHJlZ2lvbkNvbmZpZyA9IHJlcXVpcmUoJy4vcmVnaW9uX2NvbmZpZycpOwogIAogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICB2YXIgY2xpZW50Q291bnQgPSAwOwogIAogIC8qKgogICAqIFRoZSBzZXJ2aWNlIGNsYXNzIHJlcHJlc2VudGluZyBhbiBBV1Mgc2VydmljZS4KICAgKgogICAqIEBjbGFzc19hYnN0cmFjdCBUaGlzIGNsYXNzIGlzIGFuIGFic3RyYWN0IGNsYXNzLgogICAqCiAgICogQCFhdHRyaWJ1dGUgYXBpVmVyc2lvbnMKICAgKiAgIEByZXR1cm4gW0FycmF5PFN0cmluZz5dIHRoZSBsaXN0IG9mIEFQSSB2ZXJzaW9ucyBzdXBwb3J0ZWQgYnkgdGhpcyBzZXJ2aWNlLgogICAqICAgQHJlYWRvbmx5CiAgICovCiAgQVdTLlNlcnZpY2UgPSBpbmhlcml0KHsKICAgIC8qKgogICAgICogQ3JlYXRlIGEgbmV3IHNlcnZpY2Ugb2JqZWN0IHdpdGggYSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICoKICAgICAqIEBwYXJhbSBjb25maWcgW21hcF0gYSBtYXAgb2YgY29uZmlndXJhdGlvbiBvcHRpb25zCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBTZXJ2aWNlKGNvbmZpZykgewogICAgICBpZiAoIXRoaXMubG9hZFNlcnZpY2VDbGFzcykgewogICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAgJ1NlcnZpY2UgbXVzdCBiZSBjb25zdHJ1Y3RlZCB3aXRoIGBuZXdcJyBvcGVyYXRvcicpOwogICAgICB9CiAgICAgIHZhciBTZXJ2aWNlQ2xhc3MgPSB0aGlzLmxvYWRTZXJ2aWNlQ2xhc3MoY29uZmlnIHx8IHt9KTsKICAgICAgaWYgKFNlcnZpY2VDbGFzcykgewogICAgICAgIHZhciBvcmlnaW5hbENvbmZpZyA9IEFXUy51dGlsLmNvcHkoY29uZmlnKTsKICAgICAgICB2YXIgc3ZjID0gbmV3IFNlcnZpY2VDbGFzcyhjb25maWcpOwogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShzdmMsICdfb3JpZ2luYWxDb25maWcnLCB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gb3JpZ2luYWxDb25maWc7IH0sCiAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIHN2Yy5fY2xpZW50SWQgPSArK2NsaWVudENvdW50OwogICAgICAgIHJldHVybiBzdmM7CiAgICAgIH0KICAgICAgdGhpcy5pbml0aWFsaXplKGNvbmZpZyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gaW5pdGlhbGl6ZShjb25maWcpIHsKICAgICAgdmFyIHN2Y0NvbmZpZyA9IEFXUy5jb25maWdbdGhpcy5zZXJ2aWNlSWRlbnRpZmllcl07CiAgICAgIHRoaXMuY29uZmlnID0gbmV3IEFXUy5Db25maWcoQVdTLmNvbmZpZyk7CiAgICAgIGlmIChzdmNDb25maWcpIHRoaXMuY29uZmlnLnVwZGF0ZShzdmNDb25maWcsIHRydWUpOwogICAgICBpZiAoY29uZmlnKSB0aGlzLmNvbmZpZy51cGRhdGUoY29uZmlnLCB0cnVlKTsKICAKICAgICAgdGhpcy52YWxpZGF0ZVNlcnZpY2UoKTsKICAgICAgaWYgKCF0aGlzLmNvbmZpZy5lbmRwb2ludCkgcmVnaW9uQ29uZmlnKHRoaXMpOwogIAogICAgICB0aGlzLmNvbmZpZy5lbmRwb2ludCA9IHRoaXMuZW5kcG9pbnRGcm9tVGVtcGxhdGUodGhpcy5jb25maWcuZW5kcG9pbnQpOwogICAgICB0aGlzLnNldEVuZHBvaW50KHRoaXMuY29uZmlnLmVuZHBvaW50KTsKICAgICAgLy9lbmFibGUgYXR0YWNoaW5nIGxpc3RlbmVycyB0byBzZXJ2aWNlIGNsaWVudAogICAgICBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLmNhbGwodGhpcyk7CiAgICAgIEFXUy5TZXJ2aWNlLmFkZERlZmF1bHRNb25pdG9yaW5nTGlzdGVuZXJzKHRoaXMpOwogICAgICBpZiAoKHRoaXMuY29uZmlnLmNsaWVudFNpZGVNb25pdG9yaW5nIHx8IEFXUy5TZXJ2aWNlLl9jbGllbnRTaWRlTW9uaXRvcmluZykgJiYgdGhpcy5wdWJsaXNoZXIpIHsKICAgICAgICB2YXIgcHVibGlzaGVyID0gdGhpcy5wdWJsaXNoZXI7CiAgICAgICAgdGhpcy5hZGROYW1lZExpc3RlbmVyKCdQVUJMSVNIX0FQSV9DQUxMJywgJ2FwaUNhbGwnLCBmdW5jdGlvbiBQVUJMSVNIX0FQSV9DQUxMKGV2ZW50KSB7CiAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkge3B1Ymxpc2hlci5ldmVudEhhbmRsZXIoZXZlbnQpO30pOwogICAgICAgIH0pOwogICAgICAgIHRoaXMuYWRkTmFtZWRMaXN0ZW5lcignUFVCTElTSF9BUElfQVRURU1QVCcsICdhcGlDYWxsQXR0ZW1wdCcsIGZ1bmN0aW9uIFBVQkxJU0hfQVBJX0FUVEVNUFQoZXZlbnQpIHsKICAgICAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7cHVibGlzaGVyLmV2ZW50SGFuZGxlcihldmVudCk7fSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICB2YWxpZGF0ZVNlcnZpY2U6IGZ1bmN0aW9uIHZhbGlkYXRlU2VydmljZSgpIHsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkU2VydmljZUNsYXNzOiBmdW5jdGlvbiBsb2FkU2VydmljZUNsYXNzKHNlcnZpY2VDb25maWcpIHsKICAgICAgdmFyIGNvbmZpZyA9IHNlcnZpY2VDb25maWc7CiAgICAgIGlmICghQVdTLnV0aWwuaXNFbXB0eSh0aGlzLmFwaSkpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSBlbHNlIGlmIChjb25maWcuYXBpQ29uZmlnKSB7CiAgICAgICAgcmV0dXJuIEFXUy5TZXJ2aWNlLmRlZmluZVNlcnZpY2VBcGkodGhpcy5jb25zdHJ1Y3RvciwgY29uZmlnLmFwaUNvbmZpZyk7CiAgICAgIH0gZWxzZSBpZiAoIXRoaXMuY29uc3RydWN0b3Iuc2VydmljZXMpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25maWcgPSBuZXcgQVdTLkNvbmZpZyhBV1MuY29uZmlnKTsKICAgICAgICBjb25maWcudXBkYXRlKHNlcnZpY2VDb25maWcsIHRydWUpOwogICAgICAgIHZhciB2ZXJzaW9uID0gY29uZmlnLmFwaVZlcnNpb25zW3RoaXMuY29uc3RydWN0b3Iuc2VydmljZUlkZW50aWZpZXJdOwogICAgICAgIHZlcnNpb24gPSB2ZXJzaW9uIHx8IGNvbmZpZy5hcGlWZXJzaW9uOwogICAgICAgIHJldHVybiB0aGlzLmdldExhdGVzdFNlcnZpY2VDbGFzcyh2ZXJzaW9uKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldExhdGVzdFNlcnZpY2VDbGFzczogZnVuY3Rpb24gZ2V0TGF0ZXN0U2VydmljZUNsYXNzKHZlcnNpb24pIHsKICAgICAgdmVyc2lvbiA9IHRoaXMuZ2V0TGF0ZXN0U2VydmljZVZlcnNpb24odmVyc2lvbik7CiAgICAgIGlmICh0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzW3ZlcnNpb25dID09PSBudWxsKSB7CiAgICAgICAgQVdTLlNlcnZpY2UuZGVmaW5lU2VydmljZUFwaSh0aGlzLmNvbnN0cnVjdG9yLCB2ZXJzaW9uKTsKICAgICAgfQogIAogICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlc1t2ZXJzaW9uXTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRMYXRlc3RTZXJ2aWNlVmVyc2lvbjogZnVuY3Rpb24gZ2V0TGF0ZXN0U2VydmljZVZlcnNpb24odmVyc2lvbikgewogICAgICBpZiAoIXRoaXMuY29uc3RydWN0b3Iuc2VydmljZXMgfHwgdGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlcy5sZW5ndGggPT09IDApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHNlcnZpY2VzIGRlZmluZWQgb24gJyArCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3Iuc2VydmljZUlkZW50aWZpZXIpOwogICAgICB9CiAgCiAgICAgIGlmICghdmVyc2lvbikgewogICAgICAgIHZlcnNpb24gPSAnbGF0ZXN0JzsKICAgICAgfSBlbHNlIGlmIChBV1MudXRpbC5pc1R5cGUodmVyc2lvbiwgRGF0ZSkpIHsKICAgICAgICB2ZXJzaW9uID0gQVdTLnV0aWwuZGF0ZS5pc284NjAxKHZlcnNpb24pLnNwbGl0KCdUJylbMF07CiAgICAgIH0KICAKICAgICAgaWYgKE9iamVjdC5oYXNPd25Qcm9wZXJ0eSh0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzLCB2ZXJzaW9uKSkgewogICAgICAgIHJldHVybiB2ZXJzaW9uOwogICAgICB9CiAgCiAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXModGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlcykuc29ydCgpOwogICAgICB2YXIgc2VsZWN0ZWRWZXJzaW9uID0gbnVsbDsKICAgICAgZm9yICh2YXIgaSA9IGtleXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAvLyB2ZXJzaW9ucyB0aGF0IGVuZCBpbiAiKiIgYXJlIG5vdCBhdmFpbGFibGUgb24gZGlzayBhbmQgY2FuIGJlCiAgICAgICAgLy8gc2tpcHBlZCwgc28gZG8gbm90IGNob29zZSB0aGVzZSBhcyBzZWxlY3RlZFZlcnNpb25zCiAgICAgICAgaWYgKGtleXNbaV1ba2V5c1tpXS5sZW5ndGggLSAxXSAhPT0gJyonKSB7CiAgICAgICAgICBzZWxlY3RlZFZlcnNpb24gPSBrZXlzW2ldOwogICAgICAgIH0KICAgICAgICBpZiAoa2V5c1tpXS5zdWJzdHIoMCwgMTApIDw9IHZlcnNpb24pIHsKICAgICAgICAgIHJldHVybiBzZWxlY3RlZFZlcnNpb247CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGZpbmQgJyArIHRoaXMuY29uc3RydWN0b3Iuc2VydmljZUlkZW50aWZpZXIgKwogICAgICAgICAgICAgICAgICAgICAgJyBBUEkgdG8gc2F0aXNmeSB2ZXJzaW9uIGNvbnN0cmFpbnQgYCcgKyB2ZXJzaW9uICsgJ1wnJyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXBpOiB7fSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGRlZmF1bHRSZXRyeUNvdW50OiAzLAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY3VzdG9taXplUmVxdWVzdHM6IGZ1bmN0aW9uIGN1c3RvbWl6ZVJlcXVlc3RzKGNhbGxiYWNrKSB7CiAgICAgIGlmICghY2FsbGJhY2spIHsKICAgICAgICB0aGlzLmN1c3RvbVJlcXVlc3RIYW5kbGVyID0gbnVsbDsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0aGlzLmN1c3RvbVJlcXVlc3RIYW5kbGVyID0gY2FsbGJhY2s7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGNhbGxiYWNrIHR5cGUgXCcnICsgdHlwZW9mIGNhbGxiYWNrICsgJ1wnIHByb3ZpZGVkIGluIGN1c3RvbWl6ZVJlcXVlc3RzJyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIENhbGxzIGFuIG9wZXJhdGlvbiBvbiBhIHNlcnZpY2Ugd2l0aCB0aGUgZ2l2ZW4gaW5wdXQgcGFyYW1ldGVycy4KICAgICAqCiAgICAgKiBAcGFyYW0gb3BlcmF0aW9uIFtTdHJpbmddIHRoZSBuYW1lIG9mIHRoZSBvcGVyYXRpb24gdG8gY2FsbCBvbiB0aGUgc2VydmljZS4KICAgICAqIEBwYXJhbSBwYXJhbXMgW21hcF0gYSBtYXAgb2YgaW5wdXQgb3B0aW9ucyBmb3IgdGhlIG9wZXJhdGlvbgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgICAqICAgSWYgYSBjYWxsYmFjayBpcyBzdXBwbGllZCwgaXQgaXMgY2FsbGVkIHdoZW4gYSByZXNwb25zZSBpcyByZXR1cm5lZAogICAgICogICBmcm9tIHRoZSBzZXJ2aWNlLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAgICogICAgIFNldCB0byBgbnVsbGAgaWYgdGhlIHJlcXVlc3QgaXMgc3VjY2Vzc2Z1bC4KICAgICAqICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgZGF0YSByZXR1cm5lZCBmcm9tCiAgICAgKiAgICAgdGhlIHJlcXVlc3QuIFNldCB0byBgbnVsbGAgaWYgYSByZXF1ZXN0IGVycm9yIG9jY3Vycy4KICAgICAqLwogICAgbWFrZVJlcXVlc3Q6IGZ1bmN0aW9uIG1ha2VSZXF1ZXN0KG9wZXJhdGlvbiwgcGFyYW1zLCBjYWxsYmFjaykgewogICAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGNhbGxiYWNrID0gcGFyYW1zOwogICAgICAgIHBhcmFtcyA9IG51bGw7CiAgICAgIH0KICAKICAgICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9OwogICAgICBpZiAodGhpcy5jb25maWcucGFyYW1zKSB7IC8vIGNvcHkgb25seSB0b3BsZXZlbCBib3VuZCBwYXJhbXMKICAgICAgICB2YXIgcnVsZXMgPSB0aGlzLmFwaS5vcGVyYXRpb25zW29wZXJhdGlvbl07CiAgICAgICAgaWYgKHJ1bGVzKSB7CiAgICAgICAgICBwYXJhbXMgPSBBV1MudXRpbC5jb3B5KHBhcmFtcyk7CiAgICAgICAgICBBV1MudXRpbC5lYWNoKHRoaXMuY29uZmlnLnBhcmFtcywgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAocnVsZXMuaW5wdXQubWVtYmVyc1trZXldKSB7CiAgICAgICAgICAgICAgaWYgKHBhcmFtc1trZXldID09PSB1bmRlZmluZWQgfHwgcGFyYW1zW2tleV0gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHBhcmFtc1trZXldID0gdmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgdmFyIHJlcXVlc3QgPSBuZXcgQVdTLlJlcXVlc3QodGhpcywgb3BlcmF0aW9uLCBwYXJhbXMpOwogICAgICB0aGlzLmFkZEFsbFJlcXVlc3RMaXN0ZW5lcnMocmVxdWVzdCk7CiAgICAgIHRoaXMuYXR0YWNoTW9uaXRvcmluZ0VtaXR0ZXIocmVxdWVzdCk7CiAgICAgIGlmIChjYWxsYmFjaykgcmVxdWVzdC5zZW5kKGNhbGxiYWNrKTsKICAgICAgcmV0dXJuIHJlcXVlc3Q7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBDYWxscyBhbiBvcGVyYXRpb24gb24gYSBzZXJ2aWNlIHdpdGggdGhlIGdpdmVuIGlucHV0IHBhcmFtZXRlcnMsIHdpdGhvdXQKICAgICAqIGFueSBhdXRoZW50aWNhdGlvbiBkYXRhLiBUaGlzIG1ldGhvZCBpcyB1c2VmdWwgZm9yICJwdWJsaWMiIEFQSSBvcGVyYXRpb25zLgogICAgICoKICAgICAqIEBwYXJhbSBvcGVyYXRpb24gW1N0cmluZ10gdGhlIG5hbWUgb2YgdGhlIG9wZXJhdGlvbiB0byBjYWxsIG9uIHRoZSBzZXJ2aWNlLgogICAgICogQHBhcmFtIHBhcmFtcyBbbWFwXSBhIG1hcCBvZiBpbnB1dCBvcHRpb25zIGZvciB0aGUgb3BlcmF0aW9uCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBkYXRhKQogICAgICogICBJZiBhIGNhbGxiYWNrIGlzIHN1cHBsaWVkLCBpdCBpcyBjYWxsZWQgd2hlbiBhIHJlc3BvbnNlIGlzIHJldHVybmVkCiAgICAgKiAgIGZyb20gdGhlIHNlcnZpY2UuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICAgKiAgICAgU2V0IHRvIGBudWxsYCBpZiB0aGUgcmVxdWVzdCBpcyBzdWNjZXNzZnVsLgogICAgICogICBAcGFyYW0gZGF0YSBbT2JqZWN0XSB0aGUgZGUtc2VyaWFsaXplZCBkYXRhIHJldHVybmVkIGZyb20KICAgICAqICAgICB0aGUgcmVxdWVzdC4gU2V0IHRvIGBudWxsYCBpZiBhIHJlcXVlc3QgZXJyb3Igb2NjdXJzLgogICAgICovCiAgICBtYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdDogZnVuY3Rpb24gbWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3Qob3BlcmF0aW9uLCBwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIGlmICh0eXBlb2YgcGFyYW1zID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2FsbGJhY2sgPSBwYXJhbXM7CiAgICAgICAgcGFyYW1zID0ge307CiAgICAgIH0KICAKICAgICAgdmFyIHJlcXVlc3QgPSB0aGlzLm1ha2VSZXF1ZXN0KG9wZXJhdGlvbiwgcGFyYW1zKS50b1VuYXV0aGVudGljYXRlZCgpOwogICAgICByZXR1cm4gY2FsbGJhY2sgPyByZXF1ZXN0LnNlbmQoY2FsbGJhY2spIDogcmVxdWVzdDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFdhaXRzIGZvciBhIGdpdmVuIHN0YXRlCiAgICAgKgogICAgICogQHBhcmFtIHN0YXRlIFtTdHJpbmddIHRoZSBzdGF0ZSBvbiB0aGUgc2VydmljZSB0byB3YWl0IGZvcgogICAgICogQHBhcmFtIHBhcmFtcyBbbWFwXSBhIG1hcCBvZiBwYXJhbWV0ZXJzIHRvIHBhc3Mgd2l0aCBlYWNoIHJlcXVlc3QKICAgICAqIEBvcHRpb24gcGFyYW1zICR3YWl0ZXIgW21hcF0gYSBtYXAgb2YgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgd2FpdGVyCiAgICAgKiBAb3B0aW9uIHBhcmFtcyAkd2FpdGVyLmRlbGF5IFtOdW1iZXJdIFRoZSBudW1iZXIgb2Ygc2Vjb25kcyB0byB3YWl0IGJldHdlZW4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdHMKICAgICAqIEBvcHRpb24gcGFyYW1zICR3YWl0ZXIubWF4QXR0ZW1wdHMgW051bWJlcl0gVGhlIG1heGltdW0gbnVtYmVyIG9mIHJlcXVlc3RzCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIHNlbmQgd2hpbGUgd2FpdGluZwogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgICAqICAgSWYgYSBjYWxsYmFjayBpcyBzdXBwbGllZCwgaXQgaXMgY2FsbGVkIHdoZW4gYSByZXNwb25zZSBpcyByZXR1cm5lZAogICAgICogICBmcm9tIHRoZSBzZXJ2aWNlLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAgICogICAgIFNldCB0byBgbnVsbGAgaWYgdGhlIHJlcXVlc3QgaXMgc3VjY2Vzc2Z1bC4KICAgICAqICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgZGF0YSByZXR1cm5lZCBmcm9tCiAgICAgKiAgICAgdGhlIHJlcXVlc3QuIFNldCB0byBgbnVsbGAgaWYgYSByZXF1ZXN0IGVycm9yIG9jY3Vycy4KICAgICAqLwogICAgd2FpdEZvcjogZnVuY3Rpb24gd2FpdEZvcihzdGF0ZSwgcGFyYW1zLCBjYWxsYmFjaykgewogICAgICB2YXIgd2FpdGVyID0gbmV3IEFXUy5SZXNvdXJjZVdhaXRlcih0aGlzLCBzdGF0ZSk7CiAgICAgIHJldHVybiB3YWl0ZXIud2FpdChwYXJhbXMsIGNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhZGRBbGxSZXF1ZXN0TGlzdGVuZXJzOiBmdW5jdGlvbiBhZGRBbGxSZXF1ZXN0TGlzdGVuZXJzKHJlcXVlc3QpIHsKICAgICAgdmFyIGxpc3QgPSBbQVdTLmV2ZW50cywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUsIHRoaXMuc2VydmljZUludGVyZmFjZSgpLAogICAgICAgICAgICAgICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZVBvc3RdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAobGlzdFtpXSkgcmVxdWVzdC5hZGRMaXN0ZW5lcnMobGlzdFtpXSk7CiAgICAgIH0KICAKICAgICAgLy8gZGlzYWJsZSBwYXJhbWV0ZXIgdmFsaWRhdGlvbgogICAgICBpZiAoIXRoaXMuY29uZmlnLnBhcmFtVmFsaWRhdGlvbikgewogICAgICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywKICAgICAgICAgIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1BBUkFNRVRFUlMpOwogICAgICB9CiAgCiAgICAgIGlmICh0aGlzLmNvbmZpZy5sb2dnZXIpIHsgLy8gYWRkIGxvZ2dpbmcgZXZlbnRzCiAgICAgICAgcmVxdWVzdC5hZGRMaXN0ZW5lcnMoQVdTLkV2ZW50TGlzdGVuZXJzLkxvZ2dlcik7CiAgICAgIH0KICAKICAgICAgdGhpcy5zZXR1cFJlcXVlc3RMaXN0ZW5lcnMocmVxdWVzdCk7CiAgICAgIC8vIGNhbGwgcHJvdG90eXBlJ3MgY3VzdG9tUmVxdWVzdEhhbmRsZXIKICAgICAgaWYgKHR5cGVvZiB0aGlzLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5jdXN0b21SZXF1ZXN0SGFuZGxlciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRoaXMuY29uc3RydWN0b3IucHJvdG90eXBlLmN1c3RvbVJlcXVlc3RIYW5kbGVyKHJlcXVlc3QpOwogICAgICB9CiAgICAgIC8vIGNhbGwgaW5zdGFuY2UncyBjdXN0b21SZXF1ZXN0SGFuZGxlcgogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMsICdjdXN0b21SZXF1ZXN0SGFuZGxlcicpICYmIHR5cGVvZiB0aGlzLmN1c3RvbVJlcXVlc3RIYW5kbGVyID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhpcy5jdXN0b21SZXF1ZXN0SGFuZGxlcihyZXF1ZXN0KTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogRXZlbnQgcmVjb3JkaW5nIG1ldHJpY3MgZm9yIGEgd2hvbGUgQVBJIGNhbGwuCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBhIHN1YnNldCBvZiBhcGkgY2FsbCBtZXRyaWNzCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXBpQ2FsbEV2ZW50OiBmdW5jdGlvbiBhcGlDYWxsRXZlbnQocmVxdWVzdCkgewogICAgICB2YXIgYXBpID0gcmVxdWVzdC5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXTsKICAgICAgdmFyIG1vbml0b3JpbmdFdmVudCA9IHsKICAgICAgICBUeXBlOiAnQXBpQ2FsbCcsCiAgICAgICAgQXBpOiBhcGkgPyBhcGkubmFtZSA6IHJlcXVlc3Qub3BlcmF0aW9uLAogICAgICAgIFZlcnNpb246IDEsCiAgICAgICAgU2VydmljZTogcmVxdWVzdC5zZXJ2aWNlLmFwaS5zZXJ2aWNlSWQgfHwgcmVxdWVzdC5zZXJ2aWNlLmFwaS5lbmRwb2ludFByZWZpeCwKICAgICAgICBSZWdpb246IHJlcXVlc3QuaHR0cFJlcXVlc3QucmVnaW9uLAogICAgICAgIE1heFJldHJpZXNFeGNlZWRlZDogMCwKICAgICAgICBVc2VyQWdlbnQ6IHJlcXVlc3QuaHR0cFJlcXVlc3QuZ2V0VXNlckFnZW50KCksCiAgICAgIH07CiAgICAgIHZhciByZXNwb25zZSA9IHJlcXVlc3QucmVzcG9uc2U7CiAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5GaW5hbEh0dHBTdGF0dXNDb2RlID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgIH0KICAgICAgaWYgKHJlc3BvbnNlLmVycm9yKSB7CiAgICAgICAgdmFyIGVycm9yID0gcmVzcG9uc2UuZXJyb3I7CiAgICAgICAgdmFyIHN0YXR1c0NvZGUgPSByZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICBpZiAoc3RhdHVzQ29kZSA+IDI5OSkgewogICAgICAgICAgaWYgKGVycm9yLmNvZGUpIG1vbml0b3JpbmdFdmVudC5GaW5hbEF3c0V4Y2VwdGlvbiA9IGVycm9yLmNvZGU7CiAgICAgICAgICBpZiAoZXJyb3IubWVzc2FnZSkgbW9uaXRvcmluZ0V2ZW50LkZpbmFsQXdzRXhjZXB0aW9uTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChlcnJvci5jb2RlIHx8IGVycm9yLm5hbWUpIG1vbml0b3JpbmdFdmVudC5GaW5hbFNka0V4Y2VwdGlvbiA9IGVycm9yLmNvZGUgfHwgZXJyb3IubmFtZTsKICAgICAgICAgIGlmIChlcnJvci5tZXNzYWdlKSBtb25pdG9yaW5nRXZlbnQuRmluYWxTZGtFeGNlcHRpb25NZXNzYWdlID0gZXJyb3IubWVzc2FnZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG1vbml0b3JpbmdFdmVudDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEV2ZW50IHJlY29yZGluZyBtZXRyaWNzIGZvciBhbiBBUEkgY2FsbCBhdHRlbXB0LgogICAgICogQHJldHVybnMge29iamVjdH0gYSBzdWJzZXQgb2YgYXBpIGNhbGwgYXR0ZW1wdCBtZXRyaWNzCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXBpQXR0ZW1wdEV2ZW50OiBmdW5jdGlvbiBhcGlBdHRlbXB0RXZlbnQocmVxdWVzdCkgewogICAgICB2YXIgYXBpID0gcmVxdWVzdC5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXTsKICAgICAgdmFyIG1vbml0b3JpbmdFdmVudCA9IHsKICAgICAgICBUeXBlOiAnQXBpQ2FsbEF0dGVtcHQnLAogICAgICAgIEFwaTogYXBpID8gYXBpLm5hbWUgOiByZXF1ZXN0Lm9wZXJhdGlvbiwKICAgICAgICBWZXJzaW9uOiAxLAogICAgICAgIFNlcnZpY2U6IHJlcXVlc3Quc2VydmljZS5hcGkuc2VydmljZUlkIHx8IHJlcXVlc3Quc2VydmljZS5hcGkuZW5kcG9pbnRQcmVmaXgsCiAgICAgICAgRnFkbjogcmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludC5ob3N0bmFtZSwKICAgICAgICBVc2VyQWdlbnQ6IHJlcXVlc3QuaHR0cFJlcXVlc3QuZ2V0VXNlckFnZW50KCksCiAgICAgIH07CiAgICAgIHZhciByZXNwb25zZSA9IHJlcXVlc3QucmVzcG9uc2U7CiAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5IdHRwU3RhdHVzQ29kZSA9IHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICB9CiAgICAgIGlmICgKICAgICAgICAhcmVxdWVzdC5fdW5BdXRoZW50aWNhdGVkICYmCiAgICAgICAgcmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscyAmJgogICAgICAgIHJlcXVlc3Quc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQKICAgICAgKSB7CiAgICAgICAgbW9uaXRvcmluZ0V2ZW50LkFjY2Vzc0tleSA9IHJlcXVlc3Quc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQ7CiAgICAgIH0KICAgICAgaWYgKCFyZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVycykgcmV0dXJuIG1vbml0b3JpbmdFdmVudDsKICAgICAgaWYgKHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1sneC1hbXotc2VjdXJpdHktdG9rZW4nXSkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5TZXNzaW9uVG9rZW4gPSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LXNlY3VyaXR5LXRva2VuJ107CiAgICAgIH0KICAgICAgaWYgKHJlc3BvbnNlLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtem4tcmVxdWVzdGlkJ10pIHsKICAgICAgICBtb25pdG9yaW5nRXZlbnQuWEFtem5SZXF1ZXN0SWQgPSByZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXpuLXJlcXVlc3RpZCddOwogICAgICB9CiAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXotcmVxdWVzdC1pZCddKSB7CiAgICAgICAgbW9uaXRvcmluZ0V2ZW50LlhBbXpSZXF1ZXN0SWQgPSByZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXotcmVxdWVzdC1pZCddOwogICAgICB9CiAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXotaWQtMiddKSB7CiAgICAgICAgbW9uaXRvcmluZ0V2ZW50LlhBbXpJZDIgPSByZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXotaWQtMiddOwogICAgICB9CiAgICAgIHJldHVybiBtb25pdG9yaW5nRXZlbnQ7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBBZGQgbWV0cmljcyBvZiBmYWlsZWQgcmVxdWVzdC4KICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhdHRlbXB0RmFpbEV2ZW50OiBmdW5jdGlvbiBhdHRlbXB0RmFpbEV2ZW50KHJlcXVlc3QpIHsKICAgICAgdmFyIG1vbml0b3JpbmdFdmVudCA9IHRoaXMuYXBpQXR0ZW1wdEV2ZW50KHJlcXVlc3QpOwogICAgICB2YXIgcmVzcG9uc2UgPSByZXF1ZXN0LnJlc3BvbnNlOwogICAgICB2YXIgZXJyb3IgPSByZXNwb25zZS5lcnJvcjsKICAgICAgaWYgKHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlID4gMjk5ICkgewogICAgICAgIGlmIChlcnJvci5jb2RlKSBtb25pdG9yaW5nRXZlbnQuQXdzRXhjZXB0aW9uID0gZXJyb3IuY29kZTsKICAgICAgICBpZiAoZXJyb3IubWVzc2FnZSkgbW9uaXRvcmluZ0V2ZW50LkF3c0V4Y2VwdGlvbk1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChlcnJvci5jb2RlIHx8IGVycm9yLm5hbWUpIG1vbml0b3JpbmdFdmVudC5TZGtFeGNlcHRpb24gPSBlcnJvci5jb2RlIHx8IGVycm9yLm5hbWU7CiAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIG1vbml0b3JpbmdFdmVudC5TZGtFeGNlcHRpb25NZXNzYWdlID0gZXJyb3IubWVzc2FnZTsKICAgICAgfQogICAgICByZXR1cm4gbW9uaXRvcmluZ0V2ZW50OwogICAgfSwKICAKICAgIC8qKgogICAgICogQXR0YWNoIGxpc3RlbmVycyB0byByZXF1ZXN0IG9iamVjdCB0byBmZXRjaCBtZXRyaWNzIG9mIGVhY2ggcmVxdWVzdAogICAgICogYW5kIGVtaXQgZGF0YSBvYmplY3QgdGhyb3VnaCBcJ0FwaUNhbGxcJyBhbmQgXCdBcGlDYWxsQXR0ZW1wdFwnIGV2ZW50cy4KICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhdHRhY2hNb25pdG9yaW5nRW1pdHRlcjogZnVuY3Rpb24gYXR0YWNoTW9uaXRvcmluZ0VtaXR0ZXIocmVxdWVzdCkgewogICAgICB2YXIgYXR0ZW1wdFRpbWVzdGFtcDsgLy90aW1lc3RhbXAgbWFya2luZyB0aGUgYmVnaW5uaW5nIG9mIGEgcmVxdWVzdCBhdHRlbXB0CiAgICAgIHZhciBhdHRlbXB0U3RhcnRSZWFsVGltZTsgLy9TdGFydCB0aW1lIG9mIHJlcXVlc3QgYXR0ZW1wdC4gVXNlZCB0byBjYWxjdWxhdGluZyBhdHRlbXB0TGF0ZW5jeQogICAgICB2YXIgYXR0ZW1wdExhdGVuY3k7IC8vbGF0ZW5jeSBmcm9tIHJlcXVlc3Qgc2VudCBvdXQgdG8gaHR0cCByZXNwb25zZSByZWFjaGluZyBTREsKICAgICAgdmFyIGNhbGxTdGFydFJlYWxUaW1lOyAvL1N0YXJ0IHRpbWUgb2YgQVBJIGNhbGwuIFVzZWQgdG8gY2FsY3VsYXRpbmcgQVBJIGNhbGwgbGF0ZW5jeQogICAgICB2YXIgYXR0ZW1wdENvdW50ID0gMDsgLy9yZXF1ZXN0LnJldHJ5Q291bnQgaXMgbm90IHJlbGlhYmxlIGhlcmUKICAgICAgdmFyIHJlZ2lvbjsgLy9yZWdpb24gY2FjaGUgcmVnaW9uIGZvciBlYWNoIGF0dGVtcHQgc2luY2UgaXQgY2FuIGJlIHVwZGF0ZWQgaW4gcGxhc2UgKGUuZy4gczMpCiAgICAgIHZhciBjYWxsVGltZXN0YW1wOyAvL3RpbWVzdGFtcCB3aGVuIHRoZSByZXF1ZXN0IGlzIGNyZWF0ZWQKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgYWRkVG9IZWFkID0gdHJ1ZTsKICAKICAgICAgcmVxdWVzdC5vbigndmFsaWRhdGUnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgY2FsbFN0YXJ0UmVhbFRpbWUgPSBBV1MudXRpbC5yZWFsQ2xvY2subm93KCk7CiAgICAgICAgY2FsbFRpbWVzdGFtcCA9IERhdGUubm93KCk7CiAgICAgIH0sIGFkZFRvSGVhZCk7CiAgICAgIHJlcXVlc3Qub24oJ3NpZ24nLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgYXR0ZW1wdFN0YXJ0UmVhbFRpbWUgPSBBV1MudXRpbC5yZWFsQ2xvY2subm93KCk7CiAgICAgICAgYXR0ZW1wdFRpbWVzdGFtcCA9IERhdGUubm93KCk7CiAgICAgICAgcmVnaW9uID0gcmVxdWVzdC5odHRwUmVxdWVzdC5yZWdpb247CiAgICAgICAgYXR0ZW1wdENvdW50Kys7CiAgICAgIH0sIGFkZFRvSGVhZCk7CiAgICAgIHJlcXVlc3Qub24oJ3ZhbGlkYXRlUmVzcG9uc2UnLCBmdW5jdGlvbigpIHsKICAgICAgICBhdHRlbXB0TGF0ZW5jeSA9IE1hdGgucm91bmQoQVdTLnV0aWwucmVhbENsb2NrLm5vdygpIC0gYXR0ZW1wdFN0YXJ0UmVhbFRpbWUpOwogICAgICB9KTsKICAgICAgcmVxdWVzdC5hZGROYW1lZExpc3RlbmVyKCdBUElfQ0FMTF9BVFRFTVBUJywgJ3N1Y2Nlc3MnLCBmdW5jdGlvbiBBUElfQ0FMTF9BVFRFTVBUKCkgewogICAgICAgIHZhciBhcGlBdHRlbXB0RXZlbnQgPSBzZWxmLmFwaUF0dGVtcHRFdmVudChyZXF1ZXN0KTsKICAgICAgICBhcGlBdHRlbXB0RXZlbnQuVGltZXN0YW1wID0gYXR0ZW1wdFRpbWVzdGFtcDsKICAgICAgICBhcGlBdHRlbXB0RXZlbnQuQXR0ZW1wdExhdGVuY3kgPSBhdHRlbXB0TGF0ZW5jeSA+PSAwID8gYXR0ZW1wdExhdGVuY3kgOiAwOwogICAgICAgIGFwaUF0dGVtcHRFdmVudC5SZWdpb24gPSByZWdpb247CiAgICAgICAgc2VsZi5lbWl0KCdhcGlDYWxsQXR0ZW1wdCcsIFthcGlBdHRlbXB0RXZlbnRdKTsKICAgICAgfSk7CiAgICAgIHJlcXVlc3QuYWRkTmFtZWRMaXN0ZW5lcignQVBJX0NBTExfQVRURU1QVF9SRVRSWScsICdyZXRyeScsIGZ1bmN0aW9uIEFQSV9DQUxMX0FUVEVNUFRfUkVUUlkoKSB7CiAgICAgICAgdmFyIGFwaUF0dGVtcHRFdmVudCA9IHNlbGYuYXR0ZW1wdEZhaWxFdmVudChyZXF1ZXN0KTsKICAgICAgICBhcGlBdHRlbXB0RXZlbnQuVGltZXN0YW1wID0gYXR0ZW1wdFRpbWVzdGFtcDsKICAgICAgICAvL2F0dGVtcHRMYXRlbmN5IG1heSBub3QgYmUgYXZhaWxhYmxlIGlmIGZhaWwgYmVmb3JlIHJlc3BvbnNlCiAgICAgICAgYXR0ZW1wdExhdGVuY3kgPSBhdHRlbXB0TGF0ZW5jeSB8fAogICAgICAgICAgTWF0aC5yb3VuZChBV1MudXRpbC5yZWFsQ2xvY2subm93KCkgLSBhdHRlbXB0U3RhcnRSZWFsVGltZSk7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LkF0dGVtcHRMYXRlbmN5ID0gYXR0ZW1wdExhdGVuY3kgPj0gMCA/IGF0dGVtcHRMYXRlbmN5IDogMDsKICAgICAgICBhcGlBdHRlbXB0RXZlbnQuUmVnaW9uID0gcmVnaW9uOwogICAgICAgIHNlbGYuZW1pdCgnYXBpQ2FsbEF0dGVtcHQnLCBbYXBpQXR0ZW1wdEV2ZW50XSk7CiAgICAgIH0pOwogICAgICByZXF1ZXN0LmFkZE5hbWVkTGlzdGVuZXIoJ0FQSV9DQUxMJywgJ2NvbXBsZXRlJywgZnVuY3Rpb24gQVBJX0NBTEwoKSB7CiAgICAgICAgdmFyIGFwaUNhbGxFdmVudCA9IHNlbGYuYXBpQ2FsbEV2ZW50KHJlcXVlc3QpOwogICAgICAgIGFwaUNhbGxFdmVudC5BdHRlbXB0Q291bnQgPSBhdHRlbXB0Q291bnQ7CiAgICAgICAgaWYgKGFwaUNhbGxFdmVudC5BdHRlbXB0Q291bnQgPD0gMCkgcmV0dXJuOwogICAgICAgIGFwaUNhbGxFdmVudC5UaW1lc3RhbXAgPSBjYWxsVGltZXN0YW1wOwogICAgICAgIHZhciBsYXRlbmN5ID0gTWF0aC5yb3VuZChBV1MudXRpbC5yZWFsQ2xvY2subm93KCkgLSBjYWxsU3RhcnRSZWFsVGltZSk7CiAgICAgICAgYXBpQ2FsbEV2ZW50LkxhdGVuY3kgPSBsYXRlbmN5ID49IDAgPyBsYXRlbmN5IDogMDsKICAgICAgICB2YXIgcmVzcG9uc2UgPSByZXF1ZXN0LnJlc3BvbnNlOwogICAgICAgIGlmICgKICAgICAgICAgIHR5cGVvZiByZXNwb25zZS5yZXRyeUNvdW50ID09PSAnbnVtYmVyJyAmJgogICAgICAgICAgdHlwZW9mIHJlc3BvbnNlLm1heFJldHJpZXMgPT09ICdudW1iZXInICYmCiAgICAgICAgICAocmVzcG9uc2UucmV0cnlDb3VudCA+PSByZXNwb25zZS5tYXhSZXRyaWVzKQogICAgICAgICkgewogICAgICAgICAgYXBpQ2FsbEV2ZW50Lk1heFJldHJpZXNFeGNlZWRlZCA9IDE7CiAgICAgICAgfQogICAgICAgIHNlbGYuZW1pdCgnYXBpQ2FsbCcsIFthcGlDYWxsRXZlbnRdKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBzZXR1cCBhbnkgY3VzdG9tIHJlcXVlc3QgbGlzdGVuZXJzIGZvciBlYWNoCiAgICAgKiBuZXcgcmVxdWVzdCB0byB0aGUgc2VydmljZS4KICAgICAqCiAgICAgKiBAbWV0aG9kX2Fic3RyYWN0IFRoaXMgaXMgYW4gYWJzdHJhY3QgbWV0aG9kLgogICAgICovCiAgICBzZXR1cFJlcXVlc3RMaXN0ZW5lcnM6IGZ1bmN0aW9uIHNldHVwUmVxdWVzdExpc3RlbmVycyhyZXF1ZXN0KSB7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBzaWduZXIgY2xhc3MgZm9yIGEgZ2l2ZW4gcmVxdWVzdAogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldFNpZ25lckNsYXNzOiBmdW5jdGlvbiBnZXRTaWduZXJDbGFzcyhyZXF1ZXN0KSB7CiAgICAgIHZhciB2ZXJzaW9uOwogICAgICAvLyBnZXQgb3BlcmF0aW9uIGF1dGh0eXBlIGlmIHByZXNlbnQKICAgICAgdmFyIG9wZXJhdGlvbiA9IG51bGw7CiAgICAgIHZhciBhdXRodHlwZSA9ICcnOwogICAgICBpZiAocmVxdWVzdCkgewogICAgICAgIHZhciBvcGVyYXRpb25zID0gcmVxdWVzdC5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zIHx8IHt9OwogICAgICAgIG9wZXJhdGlvbiA9IG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dIHx8IG51bGw7CiAgICAgICAgYXV0aHR5cGUgPSBvcGVyYXRpb24gPyBvcGVyYXRpb24uYXV0aHR5cGUgOiAnJzsKICAgICAgfQogICAgICBpZiAodGhpcy5jb25maWcuc2lnbmF0dXJlVmVyc2lvbikgewogICAgICAgIHZlcnNpb24gPSB0aGlzLmNvbmZpZy5zaWduYXR1cmVWZXJzaW9uOwogICAgICB9IGVsc2UgaWYgKGF1dGh0eXBlID09PSAndjQnIHx8IGF1dGh0eXBlID09PSAndjQtdW5zaWduZWQtYm9keScpIHsKICAgICAgICB2ZXJzaW9uID0gJ3Y0JzsKICAgICAgfSBlbHNlIHsKICAgICAgICB2ZXJzaW9uID0gdGhpcy5hcGkuc2lnbmF0dXJlVmVyc2lvbjsKICAgICAgfQogICAgICByZXR1cm4gQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lci5nZXRWZXJzaW9uKHZlcnNpb24pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNlcnZpY2VJbnRlcmZhY2U6IGZ1bmN0aW9uIHNlcnZpY2VJbnRlcmZhY2UoKSB7CiAgICAgIHN3aXRjaCAodGhpcy5hcGkucHJvdG9jb2wpIHsKICAgICAgICBjYXNlICdlYzInOiByZXR1cm4gQVdTLkV2ZW50TGlzdGVuZXJzLlF1ZXJ5OwogICAgICAgIGNhc2UgJ3F1ZXJ5JzogcmV0dXJuIEFXUy5FdmVudExpc3RlbmVycy5RdWVyeTsKICAgICAgICBjYXNlICdqc29uJzogcmV0dXJuIEFXUy5FdmVudExpc3RlbmVycy5Kc29uOwogICAgICAgIGNhc2UgJ3Jlc3QtanNvbic6IHJldHVybiBBV1MuRXZlbnRMaXN0ZW5lcnMuUmVzdEpzb247CiAgICAgICAgY2FzZSAncmVzdC14bWwnOiByZXR1cm4gQVdTLkV2ZW50TGlzdGVuZXJzLlJlc3RYbWw7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuYXBpLnByb3RvY29sKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHNlcnZpY2UgYHByb3RvY29sXCcgJyArCiAgICAgICAgICB0aGlzLmFwaS5wcm90b2NvbCArICcgaW4gQVBJIGNvbmZpZycpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc3VjY2Vzc2Z1bFJlc3BvbnNlOiBmdW5jdGlvbiBzdWNjZXNzZnVsUmVzcG9uc2UocmVzcCkgewogICAgICByZXR1cm4gcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSA8IDMwMDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEhvdyBtYW55IHRpbWVzIGEgZmFpbGVkIHJlcXVlc3Qgc2hvdWxkIGJlIHJldHJpZWQgYmVmb3JlIGdpdmluZyB1cC4KICAgICAqIHRoZSBkZWZhdWx0UmV0cnlDb3VudCBjYW4gYmUgb3ZlcnJpZGVuIGJ5IHNlcnZpY2UgY2xhc3Nlcy4KICAgICAqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbnVtUmV0cmllczogZnVuY3Rpb24gbnVtUmV0cmllcygpIHsKICAgICAgaWYgKHRoaXMuY29uZmlnLm1heFJldHJpZXMgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiB0aGlzLmNvbmZpZy5tYXhSZXRyaWVzOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmRlZmF1bHRSZXRyeUNvdW50OwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgcmV0cnlEZWxheXM6IGZ1bmN0aW9uIHJldHJ5RGVsYXlzKHJldHJ5Q291bnQpIHsKICAgICAgcmV0dXJuIEFXUy51dGlsLmNhbGN1bGF0ZVJldHJ5RGVsYXkocmV0cnlDb3VudCwgdGhpcy5jb25maWcucmV0cnlEZWxheU9wdGlvbnMpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHJldHJ5YWJsZUVycm9yOiBmdW5jdGlvbiByZXRyeWFibGVFcnJvcihlcnJvcikgewogICAgICBpZiAodGhpcy50aW1lb3V0RXJyb3IoZXJyb3IpKSByZXR1cm4gdHJ1ZTsKICAgICAgaWYgKHRoaXMubmV0d29ya2luZ0Vycm9yKGVycm9yKSkgcmV0dXJuIHRydWU7CiAgICAgIGlmICh0aGlzLmV4cGlyZWRDcmVkZW50aWFsc0Vycm9yKGVycm9yKSkgcmV0dXJuIHRydWU7CiAgICAgIGlmICh0aGlzLnRocm90dGxlZEVycm9yKGVycm9yKSkgcmV0dXJuIHRydWU7CiAgICAgIGlmIChlcnJvci5zdGF0dXNDb2RlID49IDUwMCkgcmV0dXJuIHRydWU7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBuZXR3b3JraW5nRXJyb3I6IGZ1bmN0aW9uIG5ldHdvcmtpbmdFcnJvcihlcnJvcikgewogICAgICByZXR1cm4gZXJyb3IuY29kZSA9PT0gJ05ldHdvcmtpbmdFcnJvcic7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdGltZW91dEVycm9yOiBmdW5jdGlvbiB0aW1lb3V0RXJyb3IoZXJyb3IpIHsKICAgICAgcmV0dXJuIGVycm9yLmNvZGUgPT09ICdUaW1lb3V0RXJyb3InOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGV4cGlyZWRDcmVkZW50aWFsc0Vycm9yOiBmdW5jdGlvbiBleHBpcmVkQ3JlZGVudGlhbHNFcnJvcihlcnJvcikgewogICAgICAvLyBUT0RPIDogdGhpcyBvbmx5IGhhbmRsZXMgKm9uZSogb2YgdGhlIGV4cGlyZWQgY3JlZGVudGlhbCBjb2RlcwogICAgICByZXR1cm4gKGVycm9yLmNvZGUgPT09ICdFeHBpcmVkVG9rZW5FeGNlcHRpb24nKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjbG9ja1NrZXdFcnJvcjogZnVuY3Rpb24gY2xvY2tTa2V3RXJyb3IoZXJyb3IpIHsKICAgICAgc3dpdGNoIChlcnJvci5jb2RlKSB7CiAgICAgICAgY2FzZSAnUmVxdWVzdFRpbWVUb29Ta2V3ZWQnOgogICAgICAgIGNhc2UgJ1JlcXVlc3RFeHBpcmVkJzoKICAgICAgICBjYXNlICdJbnZhbGlkU2lnbmF0dXJlRXhjZXB0aW9uJzoKICAgICAgICBjYXNlICdTaWduYXR1cmVEb2VzTm90TWF0Y2gnOgogICAgICAgIGNhc2UgJ0F1dGhGYWlsdXJlJzoKICAgICAgICBjYXNlICdSZXF1ZXN0SW5UaGVGdXR1cmUnOgogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgZGVmYXVsdDogcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0U2tld0NvcnJlY3RlZERhdGU6IGZ1bmN0aW9uIGdldFNrZXdDb3JyZWN0ZWREYXRlKCkgewogICAgICByZXR1cm4gbmV3IERhdGUoRGF0ZS5ub3coKSArIHRoaXMuY29uZmlnLnN5c3RlbUNsb2NrT2Zmc2V0KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhcHBseUNsb2NrT2Zmc2V0OiBmdW5jdGlvbiBhcHBseUNsb2NrT2Zmc2V0KG5ld1NlcnZlclRpbWUpIHsKICAgICAgaWYgKG5ld1NlcnZlclRpbWUpIHsKICAgICAgICB0aGlzLmNvbmZpZy5zeXN0ZW1DbG9ja09mZnNldCA9IG5ld1NlcnZlclRpbWUgLSBEYXRlLm5vdygpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaXNDbG9ja1NrZXdlZDogZnVuY3Rpb24gaXNDbG9ja1NrZXdlZChuZXdTZXJ2ZXJUaW1lKSB7CiAgICAgIGlmIChuZXdTZXJ2ZXJUaW1lKSB7CiAgICAgICAgcmV0dXJuIE1hdGguYWJzKHRoaXMuZ2V0U2tld0NvcnJlY3RlZERhdGUoKS5nZXRUaW1lKCkgLSBuZXdTZXJ2ZXJUaW1lKSA+PSAzMDAwMDsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHRocm90dGxlZEVycm9yOiBmdW5jdGlvbiB0aHJvdHRsZWRFcnJvcihlcnJvcikgewogICAgICAvLyB0aGlzIGxvZ2ljIHZhcmllcyBiZXR3ZWVuIHNlcnZpY2VzCiAgICAgIGlmIChlcnJvci5zdGF0dXNDb2RlID09PSA0MjkpIHJldHVybiB0cnVlOwogICAgICBzd2l0Y2ggKGVycm9yLmNvZGUpIHsKICAgICAgICBjYXNlICdQcm92aXNpb25lZFRocm91Z2hwdXRFeGNlZWRlZEV4Y2VwdGlvbic6CiAgICAgICAgY2FzZSAnVGhyb3R0bGluZyc6CiAgICAgICAgY2FzZSAnVGhyb3R0bGluZ0V4Y2VwdGlvbic6CiAgICAgICAgY2FzZSAnUmVxdWVzdExpbWl0RXhjZWVkZWQnOgogICAgICAgIGNhc2UgJ1JlcXVlc3RUaHJvdHRsZWQnOgogICAgICAgIGNhc2UgJ1JlcXVlc3RUaHJvdHRsZWRFeGNlcHRpb24nOgogICAgICAgIGNhc2UgJ1Rvb01hbnlSZXF1ZXN0c0V4Y2VwdGlvbic6CiAgICAgICAgY2FzZSAnVHJhbnNhY3Rpb25JblByb2dyZXNzRXhjZXB0aW9uJzogLy9keW5hbW9kYgogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGVuZHBvaW50RnJvbVRlbXBsYXRlOiBmdW5jdGlvbiBlbmRwb2ludEZyb21UZW1wbGF0ZShlbmRwb2ludCkgewogICAgICBpZiAodHlwZW9mIGVuZHBvaW50ICE9PSAnc3RyaW5nJykgcmV0dXJuIGVuZHBvaW50OwogIAogICAgICB2YXIgZSA9IGVuZHBvaW50OwogICAgICBlID0gZS5yZXBsYWNlKC9ce3NlcnZpY2VcfS9nLCB0aGlzLmFwaS5lbmRwb2ludFByZWZpeCk7CiAgICAgIGUgPSBlLnJlcGxhY2UoL1x7cmVnaW9uXH0vZywgdGhpcy5jb25maWcucmVnaW9uKTsKICAgICAgZSA9IGUucmVwbGFjZSgvXHtzY2hlbWVcfS9nLCB0aGlzLmNvbmZpZy5zc2xFbmFibGVkID8gJ2h0dHBzJyA6ICdodHRwJyk7CiAgICAgIHJldHVybiBlOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNldEVuZHBvaW50OiBmdW5jdGlvbiBzZXRFbmRwb2ludChlbmRwb2ludCkgewogICAgICB0aGlzLmVuZHBvaW50ID0gbmV3IEFXUy5FbmRwb2ludChlbmRwb2ludCwgdGhpcy5jb25maWcpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHBhZ2luYXRpb25Db25maWc6IGZ1bmN0aW9uIHBhZ2luYXRpb25Db25maWcob3BlcmF0aW9uLCB0aHJvd0V4Y2VwdGlvbikgewogICAgICB2YXIgcGFnaW5hdG9yID0gdGhpcy5hcGkub3BlcmF0aW9uc1tvcGVyYXRpb25dLnBhZ2luYXRvcjsKICAgICAgaWYgKCFwYWdpbmF0b3IpIHsKICAgICAgICBpZiAodGhyb3dFeGNlcHRpb24pIHsKICAgICAgICAgIHZhciBlID0gbmV3IEVycm9yKCk7CiAgICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihlLCAnTm8gcGFnaW5hdGlvbiBjb25maWd1cmF0aW9uIGZvciAnICsgb3BlcmF0aW9uKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHBhZ2luYXRvcjsKICAgIH0KICB9KTsKICAKICBBV1MudXRpbC51cGRhdGUoQVdTLlNlcnZpY2UsIHsKICAKICAgIC8qKgogICAgICogQWRkcyBvbmUgbWV0aG9kIGZvciBlYWNoIG9wZXJhdGlvbiBkZXNjcmliZWQgaW4gdGhlIGFwaSBjb25maWd1cmF0aW9uCiAgICAgKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGRlZmluZU1ldGhvZHM6IGZ1bmN0aW9uIGRlZmluZU1ldGhvZHMoc3ZjKSB7CiAgICAgIEFXUy51dGlsLmVhY2goc3ZjLnByb3RvdHlwZS5hcGkub3BlcmF0aW9ucywgZnVuY3Rpb24gaXRlcmF0b3IobWV0aG9kKSB7CiAgICAgICAgaWYgKHN2Yy5wcm90b3R5cGVbbWV0aG9kXSkgcmV0dXJuOwogICAgICAgIHZhciBvcGVyYXRpb24gPSBzdmMucHJvdG90eXBlLmFwaS5vcGVyYXRpb25zW21ldGhvZF07CiAgICAgICAgaWYgKG9wZXJhdGlvbi5hdXRodHlwZSA9PT0gJ25vbmUnKSB7CiAgICAgICAgICBzdmMucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbiAocGFyYW1zLCBjYWxsYmFjaykgewogICAgICAgICAgICByZXR1cm4gdGhpcy5tYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdChtZXRob2QsIHBhcmFtcywgY2FsbGJhY2spOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3ZjLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24gKHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFrZVJlcXVlc3QobWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIERlZmluZXMgYSBuZXcgU2VydmljZSBjbGFzcyB1c2luZyBhIHNlcnZpY2UgaWRlbnRpZmllciBhbmQgbGlzdCBvZiB2ZXJzaW9ucwogICAgICogaW5jbHVkaW5nIGFuIG9wdGlvbmFsIHNldCBvZiBmZWF0dXJlcyAoZnVuY3Rpb25zKSB0byBhcHBseSB0byB0aGUgY2xhc3MKICAgICAqIHByb3RvdHlwZS4KICAgICAqCiAgICAgKiBAcGFyYW0gc2VydmljZUlkZW50aWZpZXIgW1N0cmluZ10gdGhlIGlkZW50aWZpZXIgZm9yIHRoZSBzZXJ2aWNlCiAgICAgKiBAcGFyYW0gdmVyc2lvbnMgW0FycmF5PFN0cmluZz5dIGEgbGlzdCBvZiB2ZXJzaW9ucyB0aGF0IHdvcmsgd2l0aCB0aGlzCiAgICAgKiAgIHNlcnZpY2UKICAgICAqIEBwYXJhbSBmZWF0dXJlcyBbT2JqZWN0XSBhbiBvYmplY3QgdG8gYXR0YWNoIHRvIHRoZSBwcm90b3R5cGUKICAgICAqIEByZXR1cm4gW0NsYXNzPFNlcnZpY2U+XSB0aGUgc2VydmljZSBjbGFzcyBkZWZpbmVkIGJ5IHRoaXMgZnVuY3Rpb24uCiAgICAgKi8KICAgIGRlZmluZVNlcnZpY2U6IGZ1bmN0aW9uIGRlZmluZVNlcnZpY2Uoc2VydmljZUlkZW50aWZpZXIsIHZlcnNpb25zLCBmZWF0dXJlcykgewogICAgICBBV1MuU2VydmljZS5fc2VydmljZU1hcFtzZXJ2aWNlSWRlbnRpZmllcl0gPSB0cnVlOwogICAgICBpZiAoIUFycmF5LmlzQXJyYXkodmVyc2lvbnMpKSB7CiAgICAgICAgZmVhdHVyZXMgPSB2ZXJzaW9uczsKICAgICAgICB2ZXJzaW9ucyA9IFtdOwogICAgICB9CiAgCiAgICAgIHZhciBzdmMgPSBpbmhlcml0KEFXUy5TZXJ2aWNlLCBmZWF0dXJlcyB8fCB7fSk7CiAgCiAgICAgIGlmICh0eXBlb2Ygc2VydmljZUlkZW50aWZpZXIgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgQVdTLlNlcnZpY2UuYWRkVmVyc2lvbnMoc3ZjLCB2ZXJzaW9ucyk7CiAgCiAgICAgICAgdmFyIGlkZW50aWZpZXIgPSBzdmMuc2VydmljZUlkZW50aWZpZXIgfHwgc2VydmljZUlkZW50aWZpZXI7CiAgICAgICAgc3ZjLnNlcnZpY2VJZGVudGlmaWVyID0gaWRlbnRpZmllcjsKICAgICAgfSBlbHNlIHsgLy8gZGVmaW5lU2VydmljZSBjYWxsZWQgd2l0aCBhbiBBUEkKICAgICAgICBzdmMucHJvdG90eXBlLmFwaSA9IHNlcnZpY2VJZGVudGlmaWVyOwogICAgICAgIEFXUy5TZXJ2aWNlLmRlZmluZU1ldGhvZHMoc3ZjKTsKICAgICAgfQogICAgICBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLmNhbGwodGhpcy5wcm90b3R5cGUpOwogICAgICAvL3V0aWwuY2xpZW50U2lkZU1vbml0b3JpbmcgaXMgb25seSBhdmFpbGFibGUgaW4gbm9kZQogICAgICBpZiAoIXRoaXMucHJvdG90eXBlLnB1Ymxpc2hlciAmJiBBV1MudXRpbC5jbGllbnRTaWRlTW9uaXRvcmluZykgewogICAgICAgIHZhciBQdWJsaXNoZXIgPSBBV1MudXRpbC5jbGllbnRTaWRlTW9uaXRvcmluZy5QdWJsaXNoZXI7CiAgICAgICAgdmFyIGNvbmZpZ1Byb3ZpZGVyID0gQVdTLnV0aWwuY2xpZW50U2lkZU1vbml0b3JpbmcuY29uZmlnUHJvdmlkZXI7CiAgICAgICAgdmFyIHB1Ymxpc2hlckNvbmZpZyA9IGNvbmZpZ1Byb3ZpZGVyKCk7CiAgICAgICAgdGhpcy5wcm90b3R5cGUucHVibGlzaGVyID0gbmV3IFB1Ymxpc2hlcihwdWJsaXNoZXJDb25maWcpOwogICAgICAgIGlmIChwdWJsaXNoZXJDb25maWcuZW5hYmxlZCkgewogICAgICAgICAgLy9pZiBjc20gaXMgZW5hYmxlZCBpbiBlbnZpcm9ubWVudCwgU0RLIHNob3VsZCBzZW5kIGFsbCBtZXRyaWNzCiAgICAgICAgICBBV1MuU2VydmljZS5fY2xpZW50U2lkZU1vbml0b3JpbmcgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLmNhbGwoc3ZjLnByb3RvdHlwZSk7CiAgICAgIEFXUy5TZXJ2aWNlLmFkZERlZmF1bHRNb25pdG9yaW5nTGlzdGVuZXJzKHN2Yy5wcm90b3R5cGUpOwogICAgICByZXR1cm4gc3ZjOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFkZFZlcnNpb25zOiBmdW5jdGlvbiBhZGRWZXJzaW9ucyhzdmMsIHZlcnNpb25zKSB7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheSh2ZXJzaW9ucykpIHZlcnNpb25zID0gW3ZlcnNpb25zXTsKICAKICAgICAgc3ZjLnNlcnZpY2VzID0gc3ZjLnNlcnZpY2VzIHx8IHt9OwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZlcnNpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHN2Yy5zZXJ2aWNlc1t2ZXJzaW9uc1tpXV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgc3ZjLnNlcnZpY2VzW3ZlcnNpb25zW2ldXSA9IG51bGw7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHN2Yy5hcGlWZXJzaW9ucyA9IE9iamVjdC5rZXlzKHN2Yy5zZXJ2aWNlcykuc29ydCgpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGRlZmluZVNlcnZpY2VBcGk6IGZ1bmN0aW9uIGRlZmluZVNlcnZpY2VBcGkoc3VwZXJjbGFzcywgdmVyc2lvbiwgYXBpQ29uZmlnKSB7CiAgICAgIHZhciBzdmMgPSBpbmhlcml0KHN1cGVyY2xhc3MsIHsKICAgICAgICBzZXJ2aWNlSWRlbnRpZmllcjogc3VwZXJjbGFzcy5zZXJ2aWNlSWRlbnRpZmllcgogICAgICB9KTsKICAKICAgICAgZnVuY3Rpb24gc2V0QXBpKGFwaSkgewogICAgICAgIGlmIChhcGkuaXNBcGkpIHsKICAgICAgICAgIHN2Yy5wcm90b3R5cGUuYXBpID0gYXBpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdmMucHJvdG90eXBlLmFwaSA9IG5ldyBBcGkoYXBpKTsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgaWYgKHR5cGVvZiB2ZXJzaW9uID09PSAnc3RyaW5nJykgewogICAgICAgIGlmIChhcGlDb25maWcpIHsKICAgICAgICAgIHNldEFwaShhcGlDb25maWcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZXRBcGkoQVdTLmFwaUxvYWRlcihzdXBlcmNsYXNzLnNlcnZpY2VJZGVudGlmaWVyLCB2ZXJzaW9uKSk7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IoZXJyLCB7CiAgICAgICAgICAgICAgbWVzc2FnZTogJ0NvdWxkIG5vdCBmaW5kIEFQSSBjb25maWd1cmF0aW9uICcgKwogICAgICAgICAgICAgICAgc3VwZXJjbGFzcy5zZXJ2aWNlSWRlbnRpZmllciArICctJyArIHZlcnNpb24KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHN1cGVyY2xhc3Muc2VydmljZXMsIHZlcnNpb24pKSB7CiAgICAgICAgICBzdXBlcmNsYXNzLmFwaVZlcnNpb25zID0gc3VwZXJjbGFzcy5hcGlWZXJzaW9ucy5jb25jYXQodmVyc2lvbikuc29ydCgpOwogICAgICAgIH0KICAgICAgICBzdXBlcmNsYXNzLnNlcnZpY2VzW3ZlcnNpb25dID0gc3ZjOwogICAgICB9IGVsc2UgewogICAgICAgIHNldEFwaSh2ZXJzaW9uKTsKICAgICAgfQogIAogICAgICBBV1MuU2VydmljZS5kZWZpbmVNZXRob2RzKHN2Yyk7CiAgICAgIHJldHVybiBzdmM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaGFzU2VydmljZTogZnVuY3Rpb24oaWRlbnRpZmllcikgewogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKEFXUy5TZXJ2aWNlLl9zZXJ2aWNlTWFwLCBpZGVudGlmaWVyKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBwYXJhbSBhdHRhY2hPbiBhdHRhY2ggZGVmYXVsdCBtb25pdG9yaW5nIGxpc3RlbmVycyB0byBvYmplY3QKICAgICAqCiAgICAgKiBFYWNoIG1vbml0b3JpbmcgZXZlbnQgc2hvdWxkIGJlIGVtaXR0ZWQgZnJvbSBzZXJ2aWNlIGNsaWVudCB0byBzZXJ2aWNlIGNvbnN0cnVjdG9yIHByb3RvdHlwZSBhbmQgdGhlbgogICAgICogdG8gZ2xvYmFsIHNlcnZpY2UgcHJvdG90eXBlIGxpa2UgYnViYmxpbmcgdXAuIFRoZXNlIGRlZmF1bHQgbW9uaXRvcmluZyBldmVudHMgbGlzdGVuZXIgd2lsbCB0cmFuc2ZlcgogICAgICogdGhlIG1vbml0b3JpbmcgZXZlbnRzIHRvIHRoZSB1cHBlciBsYXllci4KICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhZGREZWZhdWx0TW9uaXRvcmluZ0xpc3RlbmVyczogZnVuY3Rpb24gYWRkRGVmYXVsdE1vbml0b3JpbmdMaXN0ZW5lcnMoYXR0YWNoT24pIHsKICAgICAgYXR0YWNoT24uYWRkTmFtZWRMaXN0ZW5lcignTU9OSVRPUl9FVkVOVFNfQlVCQkxFJywgJ2FwaUNhbGxBdHRlbXB0JywgZnVuY3Rpb24gRVZFTlRTX0JVQkJMRShldmVudCkgewogICAgICAgIHZhciBiYXNlQ2xhc3MgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoYXR0YWNoT24pOwogICAgICAgIGlmIChiYXNlQ2xhc3MuX2V2ZW50cykgYmFzZUNsYXNzLmVtaXQoJ2FwaUNhbGxBdHRlbXB0JywgW2V2ZW50XSk7CiAgICAgIH0pOwogICAgICBhdHRhY2hPbi5hZGROYW1lZExpc3RlbmVyKCdDQUxMX0VWRU5UU19CVUJCTEUnLCAnYXBpQ2FsbCcsIGZ1bmN0aW9uIENBTExfRVZFTlRTX0JVQkJMRShldmVudCkgewogICAgICAgIHZhciBiYXNlQ2xhc3MgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoYXR0YWNoT24pOwogICAgICAgIGlmIChiYXNlQ2xhc3MuX2V2ZW50cykgYmFzZUNsYXNzLmVtaXQoJ2FwaUNhbGwnLCBbZXZlbnRdKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgX3NlcnZpY2VNYXA6IHt9CiAgfSk7CiAgCiAgQVdTLnV0aWwubWl4aW4oQVdTLlNlcnZpY2UsIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNlcnZpY2U7CiAgCiAgfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCiAgfSx7Ii4vY29yZSI6MTgsIi4vbW9kZWwvYXBpIjozOCwiLi9yZWdpb25fY29uZmlnIjo1MywiX3Byb2Nlc3MiOjg1fV0sNjA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgCiAgQVdTLnV0aWwudXBkYXRlKEFXUy5Db2duaXRvSWRlbnRpdHkucHJvdG90eXBlLCB7CiAgICBnZXRPcGVuSWRUb2tlbjogZnVuY3Rpb24gZ2V0T3BlbklkVG9rZW4ocGFyYW1zLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5tYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdCgnZ2V0T3BlbklkVG9rZW4nLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICBnZXRJZDogZnVuY3Rpb24gZ2V0SWQocGFyYW1zLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5tYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdCgnZ2V0SWQnLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICBnZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5OiBmdW5jdGlvbiBnZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5KHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHRoaXMubWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3QoJ2dldENyZWRlbnRpYWxzRm9ySWRlbnRpdHknLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgIH0KICB9KTsKICAKICB9LHsiLi4vY29yZSI6MTh9XSw2MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChwcm9jZXNzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciByZWdpb25Db25maWcgPSByZXF1aXJlKCcuLi9yZWdpb25fY29uZmlnJyk7CiAgdmFyIEVOVl9SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEID0gJ0FXU19TVFNfUkVHSU9OQUxfRU5EUE9JTlRTJzsKICB2YXIgQ09ORklHX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQgPSAnc3RzX3JlZ2lvbmFsX2VuZHBvaW50cyc7CiAgCiAgQVdTLnV0aWwudXBkYXRlKEFXUy5TVFMucHJvdG90eXBlLCB7CiAgICAvKioKICAgICAqIEBvdmVybG9hZCBjcmVkZW50aWFsc0Zyb20oZGF0YSwgY3JlZGVudGlhbHMgPSBudWxsKQogICAgICogICBDcmVhdGVzIGEgY3JlZGVudGlhbHMgb2JqZWN0IGZyb20gU1RTIHJlc3BvbnNlIGRhdGEgY29udGFpbmluZwogICAgICogICBjcmVkZW50aWFscyBpbmZvcm1hdGlvbi4gVXNlZnVsIGZvciBxdWlja2x5IHNldHRpbmcgQVdTIGNyZWRlbnRpYWxzLgogICAgICoKICAgICAqICAgQG5vdGUgVGhpcyBpcyBhIGxvdy1sZXZlbCB1dGlsaXR5IGZ1bmN0aW9uLiBJZiB5b3Ugd2FudCB0byBsb2FkIHRlbXBvcmFyeQogICAgICogICAgIGNyZWRlbnRpYWxzIGludG8geW91ciBwcm9jZXNzIGZvciBzdWJzZXF1ZW50IHJlcXVlc3RzIHRvIEFXUyByZXNvdXJjZXMsCiAgICAgKiAgICAgeW91IHNob3VsZCB1c2Uge0FXUy5UZW1wb3JhcnlDcmVkZW50aWFsc30gaW5zdGVhZC4KICAgICAqICAgQHBhcmFtIGRhdGEgW21hcF0gZGF0YSByZXRyaWV2ZWQgZnJvbSBhIGNhbGwgdG8ge2dldEZlZGVyYXRlZFRva2VufSwKICAgICAqICAgICB7Z2V0U2Vzc2lvblRva2VufSwge2Fzc3VtZVJvbGV9LCBvciB7YXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uCiAgICAgKiAgIEBwYXJhbSBjcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSBhbiBvcHRpb25hbCBjcmVkZW50aWFscyBvYmplY3QgdG8KICAgICAqICAgICBmaWxsIGluc3RlYWQgb2YgY3JlYXRpbmcgYSBuZXcgb2JqZWN0LiBVc2VmdWwgd2hlbiBtb2RpZnlpbmcgYW4KICAgICAqICAgICBleGlzdGluZyBjcmVkZW50aWFscyBvYmplY3QgZnJvbSBhIHJlZnJlc2ggY2FsbC4KICAgICAqICAgQHJldHVybiBbQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzXSB0aGUgc2V0IG9mIHRlbXBvcmFyeSBjcmVkZW50aWFscwogICAgICogICAgIGxvYWRlZCBmcm9tIGEgcmF3IFNUUyBvcGVyYXRpb24gcmVzcG9uc2UuCiAgICAgKiAgIEBleGFtcGxlIFVzaW5nIGNyZWRlbnRpYWxzRnJvbSB0byBsb2FkIGdsb2JhbCBBV1MgY3JlZGVudGlhbHMKICAgICAqICAgICB2YXIgc3RzID0gbmV3IEFXUy5TVFMoKTsKICAgICAqICAgICBzdHMuZ2V0U2Vzc2lvblRva2VuKGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAqICAgICAgIGlmIChlcnIpIGNvbnNvbGUubG9nKCJFcnJvciBnZXR0aW5nIGNyZWRlbnRpYWxzIik7CiAgICAgKiAgICAgICBlbHNlIHsKICAgICAqICAgICAgICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IHN0cy5jcmVkZW50aWFsc0Zyb20oZGF0YSk7CiAgICAgKiAgICAgICB9CiAgICAgKiAgICAgfSk7CiAgICAgKiAgIEBzZWUgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzCiAgICAgKi8KICAgIGNyZWRlbnRpYWxzRnJvbTogZnVuY3Rpb24gY3JlZGVudGlhbHNGcm9tKGRhdGEsIGNyZWRlbnRpYWxzKSB7CiAgICAgIGlmICghZGF0YSkgcmV0dXJuIG51bGw7CiAgICAgIGlmICghY3JlZGVudGlhbHMpIGNyZWRlbnRpYWxzID0gbmV3IEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscygpOwogICAgICBjcmVkZW50aWFscy5leHBpcmVkID0gZmFsc2U7CiAgICAgIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkID0gZGF0YS5DcmVkZW50aWFscy5BY2Nlc3NLZXlJZDsKICAgICAgY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5ID0gZGF0YS5DcmVkZW50aWFscy5TZWNyZXRBY2Nlc3NLZXk7CiAgICAgIGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbiA9IGRhdGEuQ3JlZGVudGlhbHMuU2Vzc2lvblRva2VuOwogICAgICBjcmVkZW50aWFscy5leHBpcmVUaW1lID0gZGF0YS5DcmVkZW50aWFscy5FeHBpcmF0aW9uOwogICAgICByZXR1cm4gY3JlZGVudGlhbHM7CiAgICB9LAogIAogICAgYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eTogZnVuY3Rpb24gYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eShwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLm1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KCdhc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5JywgcGFyYW1zLCBjYWxsYmFjayk7CiAgICB9LAogIAogICAgYXNzdW1lUm9sZVdpdGhTQU1MOiBmdW5jdGlvbiBhc3N1bWVSb2xlV2l0aFNBTUwocGFyYW1zLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5tYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdCgnYXNzdW1lUm9sZVdpdGhTQU1MJywgcGFyYW1zLCBjYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWdWYWx1ZTogZnVuY3Rpb24gdmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWdWYWx1ZShjb25maWdWYWx1ZSwgZXJyb3JPcHRpb25zKSB7CiAgICAgIGlmICh0eXBlb2YgY29uZmlnVmFsdWUgPT09ICdzdHJpbmcnICYmIFsnbGVnYWN5JywgJ3JlZ2lvbmFsJ10uaW5kZXhPZihjb25maWdWYWx1ZS50b0xvd2VyQ2FzZSgpKSA+PSAwKSB7CiAgICAgICAgdGhpcy5jb25maWcuc3RzUmVnaW9uYWxFbmRwb2ludHMgPSBjb25maWdWYWx1ZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgZXJyb3JPcHRpb25zKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnOiBmdW5jdGlvbiB2YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZygpIHsKICAgICAgLy92YWxpZGF0ZSBjb25maWcgdmFsdWUKICAgICAgdmFyIGNvbmZpZyA9IHRoaXMuY29uZmlnOwogICAgICBpZiAoY29uZmlnLnN0c1JlZ2lvbmFsRW5kcG9pbnRzKSB7CiAgICAgICAgdGhpcy52YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZ1ZhbHVlKGNvbmZpZy5zdHNSZWdpb25hbEVuZHBvaW50cywgewogICAgICAgICAgY29kZTogJ0ludmFsaWRDb25maWd1cmF0aW9uJywKICAgICAgICAgIG1lc3NhZ2U6ICdpbnZhbGlkICJzdHNSZWdpb25hbEVuZHBvaW50cyIgY29uZmlndXJhdGlvbi4gRXhwZWN0ICJsZWdhY3kiICcgKwogICAgICAgICAgJyBvciAicmVnaW9uYWwiLiBHb3QgIicgKyBjb25maWcuc3RzUmVnaW9uYWxFbmRwb2ludHMgKyAnIi4nCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKCFBV1MudXRpbC5pc05vZGUoKSkgcmV0dXJuOwogICAgICAvL3ZhbGlkYXRlIGVudmlyb25tZW50YWwgdmFyaWFibGUKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwcm9jZXNzLmVudiwgRU5WX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQpKSB7CiAgICAgICAgdmFyIGVudkZsYWcgPSBwcm9jZXNzLmVudltFTlZfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRF07CiAgICAgICAgdGhpcy52YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZ1ZhbHVlKGVudkZsYWcsIHsKICAgICAgICAgIGNvZGU6ICdJbnZhbGlkRW52aXJvbm1lbnRhbFZhcmlhYmxlJywKICAgICAgICAgIG1lc3NhZ2U6ICdpbnZhbGlkICcgKyBFTlZfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRCArICcgZW52aXJvbm1lbnRhbCB2YXJpYWJsZS4gRXhwZWN0ICJsZWdhY3kiICcgKwogICAgICAgICAgJyBvciAicmVnaW9uYWwiLiBHb3QgIicgKyBwcm9jZXNzLmVudltFTlZfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRF0gKyAnIi4nCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgLy92YWxpZGF0ZSBzaGFyZWQgY29uZmlnIGZpbGUKICAgICAgdmFyIHByb2ZpbGUgPSB7fTsKICAgICAgdHJ5IHsKICAgICAgICB2YXIgcHJvZmlsZXMgPSBBV1MudXRpbC5nZXRQcm9maWxlc0Zyb21TaGFyZWRDb25maWcoQVdTLnV0aWwuaW5pTG9hZGVyKTsKICAgICAgICBwcm9maWxlID0gcHJvZmlsZXNbcHJvY2Vzcy5lbnYuQVdTX1BST0ZJTEUgfHwgQVdTLnV0aWwuZGVmYXVsdFByb2ZpbGVdOwogICAgICB9IGNhdGNoIChlKSB7fTsKICAgICAgaWYgKHByb2ZpbGUgJiYgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHByb2ZpbGUsIENPTkZJR19SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEKSkgewogICAgICAgIHZhciBmaWxlRmxhZyA9IHByb2ZpbGVbQ09ORklHX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRURdOwogICAgICAgIHRoaXMudmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWdWYWx1ZShmaWxlRmxhZywgewogICAgICAgICAgY29kZTogJ0ludmFsaWRDb25maWd1cmF0aW9uJywKICAgICAgICAgIG1lc3NhZ2U6ICdpbnZhbGlkICcrQ09ORklHX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQrJyBwcm9maWxlIGNvbmZpZy4gRXhwZWN0ICJsZWdhY3kiICcgKwogICAgICAgICAgJyBvciAicmVnaW9uYWwiLiBHb3QgIicgKyBwcm9maWxlW0NPTkZJR19SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEXSArICciLicKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIG9wdEluUmVnaW9uYWxFbmRwb2ludDogZnVuY3Rpb24gb3B0SW5SZWdpb25hbEVuZHBvaW50KCkgewogICAgICB0aGlzLnZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnKCk7CiAgICAgIHZhciBjb25maWcgPSB0aGlzLmNvbmZpZzsKICAgICAgaWYgKGNvbmZpZy5zdHNSZWdpb25hbEVuZHBvaW50cyA9PT0gJ3JlZ2lvbmFsJykgewogICAgICAgIHJlZ2lvbkNvbmZpZyh0aGlzKTsKICAgICAgICBpZiAoIXRoaXMuaXNHbG9iYWxFbmRwb2ludCkgcmV0dXJuOwogICAgICAgIHRoaXMuaXNHbG9iYWxFbmRwb2ludCA9IGZhbHNlOwogICAgICAgIC8vY2xpZW50IHdpbGwgdGhyb3cgaWYgcmVnaW9uIGlzIG5vdCBzdXBwbGllZDsgcmVxdWVzdCB3aWxsIGJlIHNpZ25lZCB3aXRoIHNwZWNpZmllZCByZWdpb24KICAgICAgICBpZiAoIWNvbmZpZy5yZWdpb24pIHsKICAgICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAgICB7Y29kZTogJ0NvbmZpZ0Vycm9yJywgbWVzc2FnZTogJ01pc3NpbmcgcmVnaW9uIGluIGNvbmZpZyd9KTsKICAgICAgICB9CiAgICAgICAgdmFyIGluc2VydFBvaW50ID0gY29uZmlnLmVuZHBvaW50LmluZGV4T2YoJy5hbWF6b25hd3MuY29tJyk7CiAgICAgICAgY29uZmlnLmVuZHBvaW50ID0gY29uZmlnLmVuZHBvaW50LnN1YnN0cmluZygwLCBpbnNlcnRQb2ludCkgKwogICAgICAgICAgJy4nICsgY29uZmlnLnJlZ2lvbiArIGNvbmZpZy5lbmRwb2ludC5zdWJzdHJpbmcoaW5zZXJ0UG9pbnQpOwogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVTZXJ2aWNlOiBmdW5jdGlvbiB2YWxpZGF0ZVNlcnZpY2UoKSB7CiAgICAgIHRoaXMub3B0SW5SZWdpb25hbEVuZHBvaW50KCk7CiAgICB9CiAgCiAgfSk7CiAgCiAgfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCiAgfSx7Ii4uL2NvcmUiOjE4LCIuLi9yZWdpb25fY29uZmlnIjo1MywiX3Byb2Nlc3MiOjg1fV0sNjI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciBleHBpcmVzSGVhZGVyID0gJ3ByZXNpZ25lZC1leHBpcmVzJzsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBzaWduZWRVcmxCdWlsZGVyKHJlcXVlc3QpIHsKICAgIHZhciBleHBpcmVzID0gcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdOwogICAgdmFyIHNpZ25lckNsYXNzID0gcmVxdWVzdC5zZXJ2aWNlLmdldFNpZ25lckNsYXNzKHJlcXVlc3QpOwogIAogICAgZGVsZXRlIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snVXNlci1BZ2VudCddOwogICAgZGVsZXRlIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snWC1BbXotVXNlci1BZ2VudCddOwogIAogICAgaWYgKHNpZ25lckNsYXNzID09PSBBV1MuU2lnbmVycy5WNCkgewogICAgICBpZiAoZXhwaXJlcyA+IDYwNDgwMCkgeyAvLyBvbmUgd2VlayBleHBpcnkgaXMgaW52YWxpZAogICAgICAgIHZhciBtZXNzYWdlID0gJ1ByZXNpZ25pbmcgZG9lcyBub3Qgc3VwcG9ydCBleHBpcnkgdGltZSBncmVhdGVyICcgKwogICAgICAgICAgICAgICAgICAgICAgJ3RoYW4gYSB3ZWVrIHdpdGggU2lnVjQgc2lnbmluZy4nOwogICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICBjb2RlOiAnSW52YWxpZEV4cGlyeVRpbWUnLCBtZXNzYWdlOiBtZXNzYWdlLCByZXRyeWFibGU6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdID0gZXhwaXJlczsKICAgIH0gZWxzZSBpZiAoc2lnbmVyQ2xhc3MgPT09IEFXUy5TaWduZXJzLlMzKSB7CiAgICAgIHZhciBub3cgPSByZXF1ZXN0LnNlcnZpY2UgPyByZXF1ZXN0LnNlcnZpY2UuZ2V0U2tld0NvcnJlY3RlZERhdGUoKSA6IEFXUy51dGlsLmRhdGUuZ2V0RGF0ZSgpOwogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl0gPSBwYXJzZUludCgKICAgICAgICBBV1MudXRpbC5kYXRlLnVuaXhUaW1lc3RhbXAobm93KSArIGV4cGlyZXMsIDEwKS50b1N0cmluZygpOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBtZXNzYWdlOiAnUHJlc2lnbmluZyBvbmx5IHN1cHBvcnRzIFMzIG9yIFNpZ1Y0IHNpZ25pbmcuJywKICAgICAgICBjb2RlOiAnVW5zdXBwb3J0ZWRTaWduZXInLCByZXRyeWFibGU6IGZhbHNlCiAgICAgIH0pOwogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBzaWduZWRVcmxTaWduZXIocmVxdWVzdCkgewogICAgdmFyIGVuZHBvaW50ID0gcmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludDsKICAgIHZhciBwYXJzZWRVcmwgPSBBV1MudXRpbC51cmxQYXJzZShyZXF1ZXN0Lmh0dHBSZXF1ZXN0LnBhdGgpOwogICAgdmFyIHF1ZXJ5UGFyYW1zID0ge307CiAgCiAgICBpZiAocGFyc2VkVXJsLnNlYXJjaCkgewogICAgICBxdWVyeVBhcmFtcyA9IEFXUy51dGlsLnF1ZXJ5U3RyaW5nUGFyc2UocGFyc2VkVXJsLnNlYXJjaC5zdWJzdHIoMSkpOwogICAgfQogIAogICAgdmFyIGF1dGggPSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXS5zcGxpdCgnICcpOwogICAgaWYgKGF1dGhbMF0gPT09ICdBV1MnKSB7CiAgICAgIGF1dGggPSBhdXRoWzFdLnNwbGl0KCc6Jyk7CiAgICAgIHF1ZXJ5UGFyYW1zWydBV1NBY2Nlc3NLZXlJZCddID0gYXV0aFswXTsKICAgICAgcXVlcnlQYXJhbXNbJ1NpZ25hdHVyZSddID0gYXV0aFsxXTsKICAKICAgICAgQVdTLnV0aWwuZWFjaChyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKGtleSA9PT0gZXhwaXJlc0hlYWRlcikga2V5ID0gJ0V4cGlyZXMnOwogICAgICAgIGlmIChrZXkuaW5kZXhPZigneC1hbXotbWV0YS0nKSA9PT0gMCkgewogICAgICAgICAgLy8gRGVsZXRlIGV4aXN0aW5nLCBwb3RlbnRpYWxseSBub3Qgbm9ybWFsaXplZCBrZXkKICAgICAgICAgIGRlbGV0ZSBxdWVyeVBhcmFtc1trZXldOwogICAgICAgICAga2V5ID0ga2V5LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgfQogICAgICAgIHF1ZXJ5UGFyYW1zW2tleV0gPSB2YWx1ZTsKICAgICAgfSk7CiAgICAgIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl07CiAgICAgIGRlbGV0ZSBxdWVyeVBhcmFtc1snQXV0aG9yaXphdGlvbiddOwogICAgICBkZWxldGUgcXVlcnlQYXJhbXNbJ0hvc3QnXTsKICAgIH0gZWxzZSBpZiAoYXV0aFswXSA9PT0gJ0FXUzQtSE1BQy1TSEEyNTYnKSB7IC8vIFNpZ1Y0IHNpZ25pbmcKICAgICAgYXV0aC5zaGlmdCgpOwogICAgICB2YXIgcmVzdCA9IGF1dGguam9pbignICcpOwogICAgICB2YXIgc2lnbmF0dXJlID0gcmVzdC5tYXRjaCgvU2lnbmF0dXJlPSguKj8pKD86LHxcc3xccj9cbnwkKS8pWzFdOwogICAgICBxdWVyeVBhcmFtc1snWC1BbXotU2lnbmF0dXJlJ10gPSBzaWduYXR1cmU7CiAgICAgIGRlbGV0ZSBxdWVyeVBhcmFtc1snRXhwaXJlcyddOwogICAgfQogIAogICAgLy8gYnVpbGQgVVJMCiAgICBlbmRwb2ludC5wYXRobmFtZSA9IHBhcnNlZFVybC5wYXRobmFtZTsKICAgIGVuZHBvaW50LnNlYXJjaCA9IEFXUy51dGlsLnF1ZXJ5UGFyYW1zVG9TdHJpbmcocXVlcnlQYXJhbXMpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuU2lnbmVycy5QcmVzaWduID0gaW5oZXJpdCh7CiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzaWduOiBmdW5jdGlvbiBzaWduKHJlcXVlc3QsIGV4cGlyZVRpbWUsIGNhbGxiYWNrKSB7CiAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXSA9IGV4cGlyZVRpbWUgfHwgMzYwMDsKICAgICAgcmVxdWVzdC5vbignYnVpbGQnLCBzaWduZWRVcmxCdWlsZGVyKTsKICAgICAgcmVxdWVzdC5vbignc2lnbicsIHNpZ25lZFVybFNpZ25lcik7CiAgICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ2FmdGVyQnVpbGQnLAogICAgICAgIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlNFVF9DT05URU5UX0xFTkdUSCk7CiAgICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ2FmdGVyQnVpbGQnLAogICAgICAgIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLkNPTVBVVEVfU0hBMjU2KTsKICAKICAgICAgcmVxdWVzdC5lbWl0KCdiZWZvcmVQcmVzaWduJywgW3JlcXVlc3RdKTsKICAKICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgcmVxdWVzdC5idWlsZChmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICh0aGlzLnJlc3BvbnNlLmVycm9yKSBjYWxsYmFjayh0aGlzLnJlc3BvbnNlLmVycm9yKTsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICBjYWxsYmFjayhudWxsLCBBV1MudXRpbC51cmxGb3JtYXQocmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludCkpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHJlcXVlc3QuYnVpbGQoKTsKICAgICAgICBpZiAocmVxdWVzdC5yZXNwb25zZS5lcnJvcikgdGhyb3cgcmVxdWVzdC5yZXNwb25zZS5lcnJvcjsKICAgICAgICByZXR1cm4gQVdTLnV0aWwudXJsRm9ybWF0KHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQpOwogICAgICB9CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5QcmVzaWduOwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDYzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIAogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyID0gaW5oZXJpdCh7CiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gUmVxdWVzdFNpZ25lcihyZXF1ZXN0KSB7CiAgICAgIHRoaXMucmVxdWVzdCA9IHJlcXVlc3Q7CiAgICB9LAogIAogICAgc2V0U2VydmljZUNsaWVudElkOiBmdW5jdGlvbiBzZXRTZXJ2aWNlQ2xpZW50SWQoaWQpIHsKICAgICAgdGhpcy5zZXJ2aWNlQ2xpZW50SWQgPSBpZDsKICAgIH0sCiAgCiAgICBnZXRTZXJ2aWNlQ2xpZW50SWQ6IGZ1bmN0aW9uIGdldFNlcnZpY2VDbGllbnRJZCgpIHsKICAgICAgcmV0dXJuIHRoaXMuc2VydmljZUNsaWVudElkOwogICAgfQogIH0pOwogIAogIEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIuZ2V0VmVyc2lvbiA9IGZ1bmN0aW9uIGdldFZlcnNpb24odmVyc2lvbikgewogICAgc3dpdGNoICh2ZXJzaW9uKSB7CiAgICAgIGNhc2UgJ3YyJzogcmV0dXJuIEFXUy5TaWduZXJzLlYyOwogICAgICBjYXNlICd2Myc6IHJldHVybiBBV1MuU2lnbmVycy5WMzsKICAgICAgY2FzZSAnczN2NCc6IHJldHVybiBBV1MuU2lnbmVycy5WNDsKICAgICAgY2FzZSAndjQnOiByZXR1cm4gQVdTLlNpZ25lcnMuVjQ7CiAgICAgIGNhc2UgJ3MzJzogcmV0dXJuIEFXUy5TaWduZXJzLlMzOwogICAgICBjYXNlICd2M2h0dHBzJzogcmV0dXJuIEFXUy5TaWduZXJzLlYzSHR0cHM7CiAgICB9CiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gc2lnbmluZyB2ZXJzaW9uICcgKyB2ZXJzaW9uKTsKICB9OwogIAogIHJlcXVpcmUoJy4vdjInKTsKICByZXF1aXJlKCcuL3YzJyk7CiAgcmVxdWlyZSgnLi92M2h0dHBzJyk7CiAgcmVxdWlyZSgnLi92NCcpOwogIHJlcXVpcmUoJy4vczMnKTsKICByZXF1aXJlKCcuL3ByZXNpZ24nKTsKICAKICB9LHsiLi4vY29yZSI6MTgsIi4vcHJlc2lnbiI6NjIsIi4vczMiOjY0LCIuL3YyIjo2NSwiLi92MyI6NjYsIi4vdjNodHRwcyI6NjcsIi4vdjQiOjY4fV0sNjQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5TaWduZXJzLlMzID0gaW5oZXJpdChBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLCB7CiAgICAvKioKICAgICAqIFdoZW4gYnVpbGRpbmcgdGhlIHN0cmluZ1RvU2lnbiwgdGhlc2Ugc3ViIHJlc291cmNlIHBhcmFtcyBzaG91bGQgYmUKICAgICAqIHBhcnQgb2YgdGhlIGNhbm9uaWNhbCByZXNvdXJjZSBzdHJpbmcgd2l0aCB0aGVpciBOT04tZGVjb2RlZCB2YWx1ZXMKICAgICAqLwogICAgc3ViUmVzb3VyY2VzOiB7CiAgICAgICdhY2wnOiAxLAogICAgICAnYWNjZWxlcmF0ZSc6IDEsCiAgICAgICdhbmFseXRpY3MnOiAxLAogICAgICAnY29ycyc6IDEsCiAgICAgICdsaWZlY3ljbGUnOiAxLAogICAgICAnZGVsZXRlJzogMSwKICAgICAgJ2ludmVudG9yeSc6IDEsCiAgICAgICdsb2NhdGlvbic6IDEsCiAgICAgICdsb2dnaW5nJzogMSwKICAgICAgJ21ldHJpY3MnOiAxLAogICAgICAnbm90aWZpY2F0aW9uJzogMSwKICAgICAgJ3BhcnROdW1iZXInOiAxLAogICAgICAncG9saWN5JzogMSwKICAgICAgJ3JlcXVlc3RQYXltZW50JzogMSwKICAgICAgJ3JlcGxpY2F0aW9uJzogMSwKICAgICAgJ3Jlc3RvcmUnOiAxLAogICAgICAndGFnZ2luZyc6IDEsCiAgICAgICd0b3JyZW50JzogMSwKICAgICAgJ3VwbG9hZElkJzogMSwKICAgICAgJ3VwbG9hZHMnOiAxLAogICAgICAndmVyc2lvbklkJzogMSwKICAgICAgJ3ZlcnNpb25pbmcnOiAxLAogICAgICAndmVyc2lvbnMnOiAxLAogICAgICAnd2Vic2l0ZSc6IDEKICAgIH0sCiAgCiAgICAvLyB3aGVuIGJ1aWxkaW5nIHRoZSBzdHJpbmdUb1NpZ24sIHRoZXNlIHF1ZXJ5c3RyaW5nIHBhcmFtcyBzaG91bGQgYmUKICAgIC8vIHBhcnQgb2YgdGhlIGNhbm9uaWNhbCByZXNvdXJjZSBzdHJpbmcgd2l0aCB0aGVpciBOT04tZW5jb2RlZCB2YWx1ZXMKICAgIHJlc3BvbnNlSGVhZGVyczogewogICAgICAncmVzcG9uc2UtY29udGVudC10eXBlJzogMSwKICAgICAgJ3Jlc3BvbnNlLWNvbnRlbnQtbGFuZ3VhZ2UnOiAxLAogICAgICAncmVzcG9uc2UtZXhwaXJlcyc6IDEsCiAgICAgICdyZXNwb25zZS1jYWNoZS1jb250cm9sJzogMSwKICAgICAgJ3Jlc3BvbnNlLWNvbnRlbnQtZGlzcG9zaXRpb24nOiAxLAogICAgICAncmVzcG9uc2UtY29udGVudC1lbmNvZGluZyc6IDEKICAgIH0sCiAgCiAgICBhZGRBdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhZGRBdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRlKSB7CiAgICAgIGlmICghdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ3ByZXNpZ25lZC1leHBpcmVzJ10pIHsKICAgICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snWC1BbXotRGF0ZSddID0gQVdTLnV0aWwuZGF0ZS5yZmM4MjIoZGF0ZSk7CiAgICAgIH0KICAKICAgICAgaWYgKGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbikgewogICAgICAgIC8vIHByZXNpZ25lZCBVUkxzIHJlcXVpcmUgdGhpcyBoZWFkZXIgdG8gYmUgbG93ZXJjYXNlZAogICAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWyd4LWFtei1zZWN1cml0eS10b2tlbiddID0gY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuOwogICAgICB9CiAgCiAgICAgIHZhciBzaWduYXR1cmUgPSB0aGlzLnNpZ24oY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5LCB0aGlzLnN0cmluZ1RvU2lnbigpKTsKICAgICAgdmFyIGF1dGggPSAnQVdTICcgKyBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCArICc6JyArIHNpZ25hdHVyZTsKICAKICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXSA9IGF1dGg7CiAgICB9LAogIAogICAgc3RyaW5nVG9TaWduOiBmdW5jdGlvbiBzdHJpbmdUb1NpZ24oKSB7CiAgICAgIHZhciByID0gdGhpcy5yZXF1ZXN0OwogIAogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgcGFydHMucHVzaChyLm1ldGhvZCk7CiAgICAgIHBhcnRzLnB1c2goci5oZWFkZXJzWydDb250ZW50LU1ENSddIHx8ICcnKTsKICAgICAgcGFydHMucHVzaChyLmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddIHx8ICcnKTsKICAKICAgICAgLy8gVGhpcyBpcyB0aGUgIkRhdGUiIGhlYWRlciwgYnV0IHdlIHVzZSBYLUFtei1EYXRlLgogICAgICAvLyBUaGUgUzMgc2lnbmluZyBtZWNoYW5pc20gcmVxdWlyZXMgdXMgdG8gcGFzcyBhbiBlbXB0eQogICAgICAvLyBzdHJpbmcgZm9yIHRoaXMgRGF0ZSBoZWFkZXIgcmVnYXJkbGVzcy4KICAgICAgcGFydHMucHVzaChyLmhlYWRlcnNbJ3ByZXNpZ25lZC1leHBpcmVzJ10gfHwgJycpOwogIAogICAgICB2YXIgaGVhZGVycyA9IHRoaXMuY2Fub25pY2FsaXplZEFtekhlYWRlcnMoKTsKICAgICAgaWYgKGhlYWRlcnMpIHBhcnRzLnB1c2goaGVhZGVycyk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5jYW5vbmljYWxpemVkUmVzb3VyY2UoKSk7CiAgCiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogIAogICAgfSwKICAKICAgIGNhbm9uaWNhbGl6ZWRBbXpIZWFkZXJzOiBmdW5jdGlvbiBjYW5vbmljYWxpemVkQW16SGVhZGVycygpIHsKICAKICAgICAgdmFyIGFtekhlYWRlcnMgPSBbXTsKICAKICAgICAgQVdTLnV0aWwuZWFjaCh0aGlzLnJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICBpZiAobmFtZS5tYXRjaCgvXngtYW16LS9pKSkKICAgICAgICAgIGFtekhlYWRlcnMucHVzaChuYW1lKTsKICAgICAgfSk7CiAgCiAgICAgIGFtekhlYWRlcnMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICAgIHJldHVybiBhLnRvTG93ZXJDYXNlKCkgPCBiLnRvTG93ZXJDYXNlKCkgPyAtMSA6IDE7CiAgICAgIH0pOwogIAogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoLmNhbGwodGhpcywgYW16SGVhZGVycywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICBwYXJ0cy5wdXNoKG5hbWUudG9Mb3dlckNhc2UoKSArICc6JyArIFN0cmluZyh0aGlzLnJlcXVlc3QuaGVhZGVyc1tuYW1lXSkpOwogICAgICB9KTsKICAKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CiAgCiAgICB9LAogIAogICAgY2Fub25pY2FsaXplZFJlc291cmNlOiBmdW5jdGlvbiBjYW5vbmljYWxpemVkUmVzb3VyY2UoKSB7CiAgCiAgICAgIHZhciByID0gdGhpcy5yZXF1ZXN0OwogIAogICAgICB2YXIgcGFydHMgPSByLnBhdGguc3BsaXQoJz8nKTsKICAgICAgdmFyIHBhdGggPSBwYXJ0c1swXTsKICAgICAgdmFyIHF1ZXJ5c3RyaW5nID0gcGFydHNbMV07CiAgCiAgICAgIHZhciByZXNvdXJjZSA9ICcnOwogIAogICAgICBpZiAoci52aXJ0dWFsSG9zdGVkQnVja2V0KQogICAgICAgIHJlc291cmNlICs9ICcvJyArIHIudmlydHVhbEhvc3RlZEJ1Y2tldDsKICAKICAgICAgcmVzb3VyY2UgKz0gcGF0aDsKICAKICAgICAgaWYgKHF1ZXJ5c3RyaW5nKSB7CiAgCiAgICAgICAgLy8gY29sbGVjdCBhIGxpc3Qgb2Ygc3ViIHJlc291cmNlcyBhbmQgcXVlcnkgcGFyYW1zIHRoYXQgbmVlZCB0byBiZSBzaWduZWQKICAgICAgICB2YXIgcmVzb3VyY2VzID0gW107CiAgCiAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoLmNhbGwodGhpcywgcXVlcnlzdHJpbmcuc3BsaXQoJyYnKSwgZnVuY3Rpb24gKHBhcmFtKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IHBhcmFtLnNwbGl0KCc9JylbMF07CiAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJhbS5zcGxpdCgnPScpWzFdOwogICAgICAgICAgaWYgKHRoaXMuc3ViUmVzb3VyY2VzW25hbWVdIHx8IHRoaXMucmVzcG9uc2VIZWFkZXJzW25hbWVdKSB7CiAgICAgICAgICAgIHZhciBzdWJyZXNvdXJjZSA9IHsgbmFtZTogbmFtZSB9OwogICAgICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIGlmICh0aGlzLnN1YlJlc291cmNlc1tuYW1lXSkgewogICAgICAgICAgICAgICAgc3VicmVzb3VyY2UudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3VicmVzb3VyY2UudmFsdWUgPSBkZWNvZGVVUklDb21wb25lbnQodmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXNvdXJjZXMucHVzaChzdWJyZXNvdXJjZSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgCiAgICAgICAgcmVzb3VyY2VzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsgcmV0dXJuIGEubmFtZSA8IGIubmFtZSA/IC0xIDogMTsgfSk7CiAgCiAgICAgICAgaWYgKHJlc291cmNlcy5sZW5ndGgpIHsKICAKICAgICAgICAgIHF1ZXJ5c3RyaW5nID0gW107CiAgICAgICAgICBBV1MudXRpbC5hcnJheUVhY2gocmVzb3VyY2VzLCBmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgICAgIGlmIChyZXMudmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIHF1ZXJ5c3RyaW5nLnB1c2gocmVzLm5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHF1ZXJ5c3RyaW5nLnB1c2gocmVzLm5hbWUgKyAnPScgKyByZXMudmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAKICAgICAgICAgIHJlc291cmNlICs9ICc/JyArIHF1ZXJ5c3RyaW5nLmpvaW4oJyYnKTsKICAgICAgICB9CiAgCiAgICAgIH0KICAKICAgICAgcmV0dXJuIHJlc291cmNlOwogIAogICAgfSwKICAKICAgIHNpZ246IGZ1bmN0aW9uIHNpZ24oc2VjcmV0LCBzdHJpbmcpIHsKICAgICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5obWFjKHNlY3JldCwgc3RyaW5nLCAnYmFzZTY0JywgJ3NoYTEnKTsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlMzOwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDY1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuU2lnbmVycy5WMiA9IGluaGVyaXQoQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lciwgewogICAgYWRkQXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYWRkQXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZSkgewogIAogICAgICBpZiAoIWRhdGUpIGRhdGUgPSBBV1MudXRpbC5kYXRlLmdldERhdGUoKTsKICAKICAgICAgdmFyIHIgPSB0aGlzLnJlcXVlc3Q7CiAgCiAgICAgIHIucGFyYW1zLlRpbWVzdGFtcCA9IEFXUy51dGlsLmRhdGUuaXNvODYwMShkYXRlKTsKICAgICAgci5wYXJhbXMuU2lnbmF0dXJlVmVyc2lvbiA9ICcyJzsKICAgICAgci5wYXJhbXMuU2lnbmF0dXJlTWV0aG9kID0gJ0htYWNTSEEyNTYnOwogICAgICByLnBhcmFtcy5BV1NBY2Nlc3NLZXlJZCA9IGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkOwogIAogICAgICBpZiAoY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuKSB7CiAgICAgICAgci5wYXJhbXMuU2VjdXJpdHlUb2tlbiA9IGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbjsKICAgICAgfQogIAogICAgICBkZWxldGUgci5wYXJhbXMuU2lnbmF0dXJlOyAvLyBkZWxldGUgb2xkIFNpZ25hdHVyZSBmb3IgcmUtc2lnbmluZwogICAgICByLnBhcmFtcy5TaWduYXR1cmUgPSB0aGlzLnNpZ25hdHVyZShjcmVkZW50aWFscyk7CiAgCiAgICAgIHIuYm9keSA9IEFXUy51dGlsLnF1ZXJ5UGFyYW1zVG9TdHJpbmcoci5wYXJhbXMpOwogICAgICByLmhlYWRlcnNbJ0NvbnRlbnQtTGVuZ3RoJ10gPSByLmJvZHkubGVuZ3RoOwogICAgfSwKICAKICAgIHNpZ25hdHVyZTogZnVuY3Rpb24gc2lnbmF0dXJlKGNyZWRlbnRpYWxzKSB7CiAgICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uaG1hYyhjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXksIHRoaXMuc3RyaW5nVG9TaWduKCksICdiYXNlNjQnKTsKICAgIH0sCiAgCiAgICBzdHJpbmdUb1NpZ246IGZ1bmN0aW9uIHN0cmluZ1RvU2lnbigpIHsKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0Lm1ldGhvZCk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0LmVuZHBvaW50Lmhvc3QudG9Mb3dlckNhc2UoKSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0LnBhdGhuYW1lKCkpOwogICAgICBwYXJ0cy5wdXNoKEFXUy51dGlsLnF1ZXJ5UGFyYW1zVG9TdHJpbmcodGhpcy5yZXF1ZXN0LnBhcmFtcykpOwogICAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKICAgIH0KICAKICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlYyOwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDY2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuU2lnbmVycy5WMyA9IGluaGVyaXQoQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lciwgewogICAgYWRkQXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYWRkQXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZSkgewogIAogICAgICB2YXIgZGF0ZXRpbWUgPSBBV1MudXRpbC5kYXRlLnJmYzgyMihkYXRlKTsKICAKICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXSA9IGRhdGV0aW1lOwogIAogICAgICBpZiAoY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuKSB7CiAgICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LXNlY3VyaXR5LXRva2VuJ10gPSBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW47CiAgICAgIH0KICAKICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ1gtQW16bi1BdXRob3JpemF0aW9uJ10gPQogICAgICAgIHRoaXMuYXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZXRpbWUpOwogIAogICAgfSwKICAKICAgIGF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMpIHsKICAgICAgcmV0dXJuICdBV1MzICcgKwogICAgICAgICdBV1NBY2Nlc3NLZXlJZD0nICsgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgKyAnLCcgKwogICAgICAgICdBbGdvcml0aG09SG1hY1NIQTI1NiwnICsKICAgICAgICAnU2lnbmVkSGVhZGVycz0nICsgdGhpcy5zaWduZWRIZWFkZXJzKCkgKyAnLCcgKwogICAgICAgICdTaWduYXR1cmU9JyArIHRoaXMuc2lnbmF0dXJlKGNyZWRlbnRpYWxzKTsKICAgIH0sCiAgCiAgICBzaWduZWRIZWFkZXJzOiBmdW5jdGlvbiBzaWduZWRIZWFkZXJzKCkgewogICAgICB2YXIgaGVhZGVycyA9IFtdOwogICAgICBBV1MudXRpbC5hcnJheUVhY2godGhpcy5oZWFkZXJzVG9TaWduKCksIGZ1bmN0aW9uIGl0ZXJhdG9yKGgpIHsKICAgICAgICBoZWFkZXJzLnB1c2goaC50b0xvd2VyQ2FzZSgpKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBoZWFkZXJzLnNvcnQoKS5qb2luKCc7Jyk7CiAgICB9LAogIAogICAgY2Fub25pY2FsSGVhZGVyczogZnVuY3Rpb24gY2Fub25pY2FsSGVhZGVycygpIHsKICAgICAgdmFyIGhlYWRlcnMgPSB0aGlzLnJlcXVlc3QuaGVhZGVyczsKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIEFXUy51dGlsLmFycmF5RWFjaCh0aGlzLmhlYWRlcnNUb1NpZ24oKSwgZnVuY3Rpb24gaXRlcmF0b3IoaCkgewogICAgICAgIHBhcnRzLnB1c2goaC50b0xvd2VyQ2FzZSgpLnRyaW0oKSArICc6JyArIFN0cmluZyhoZWFkZXJzW2hdKS50cmltKCkpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHBhcnRzLnNvcnQoKS5qb2luKCdcbicpICsgJ1xuJzsKICAgIH0sCiAgCiAgICBoZWFkZXJzVG9TaWduOiBmdW5jdGlvbiBoZWFkZXJzVG9TaWduKCkgewogICAgICB2YXIgaGVhZGVycyA9IFtdOwogICAgICBBV1MudXRpbC5lYWNoKHRoaXMucmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiBpdGVyYXRvcihrKSB7CiAgICAgICAgaWYgKGsgPT09ICdIb3N0JyB8fCBrID09PSAnQ29udGVudC1FbmNvZGluZycgfHwgay5tYXRjaCgvXlgtQW16L2kpKSB7CiAgICAgICAgICBoZWFkZXJzLnB1c2goayk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIGhlYWRlcnM7CiAgICB9LAogIAogICAgc2lnbmF0dXJlOiBmdW5jdGlvbiBzaWduYXR1cmUoY3JlZGVudGlhbHMpIHsKICAgICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5obWFjKGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSwgdGhpcy5zdHJpbmdUb1NpZ24oKSwgJ2Jhc2U2NCcpOwogICAgfSwKICAKICAgIHN0cmluZ1RvU2lnbjogZnVuY3Rpb24gc3RyaW5nVG9TaWduKCkgewogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3QubWV0aG9kKTsKICAgICAgcGFydHMucHVzaCgnLycpOwogICAgICBwYXJ0cy5wdXNoKCcnKTsKICAgICAgcGFydHMucHVzaCh0aGlzLmNhbm9uaWNhbEhlYWRlcnMoKSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0LmJvZHkpOwogICAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLnNoYTI1NihwYXJ0cy5qb2luKCdcbicpKTsKICAgIH0KICAKICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlYzOwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDY3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICAKICByZXF1aXJlKCcuL3YzJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuVjNIdHRwcyA9IGluaGVyaXQoQVdTLlNpZ25lcnMuVjMsIHsKICAgIGF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMpIHsKICAgICAgcmV0dXJuICdBV1MzLUhUVFBTICcgKwogICAgICAgICdBV1NBY2Nlc3NLZXlJZD0nICsgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgKyAnLCcgKwogICAgICAgICdBbGdvcml0aG09SG1hY1NIQTI1NiwnICsKICAgICAgICAnU2lnbmF0dXJlPScgKyB0aGlzLnNpZ25hdHVyZShjcmVkZW50aWFscyk7CiAgICB9LAogIAogICAgc3RyaW5nVG9TaWduOiBmdW5jdGlvbiBzdHJpbmdUb1NpZ24oKSB7CiAgICAgIHJldHVybiB0aGlzLnJlcXVlc3QuaGVhZGVyc1snWC1BbXotRGF0ZSddOwogICAgfQogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuVjNIdHRwczsKICAKICB9LHsiLi4vY29yZSI6MTgsIi4vdjMiOjY2fV0sNjg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIHY0Q3JlZGVudGlhbHMgPSByZXF1aXJlKCcuL3Y0X2NyZWRlbnRpYWxzJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciBleHBpcmVzSGVhZGVyID0gJ3ByZXNpZ25lZC1leHBpcmVzJzsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuU2lnbmVycy5WNCA9IGluaGVyaXQoQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lciwgewogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFY0KHJlcXVlc3QsIHNlcnZpY2VOYW1lLCBvcHRpb25zKSB7CiAgICAgIEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIuY2FsbCh0aGlzLCByZXF1ZXN0KTsKICAgICAgdGhpcy5zZXJ2aWNlTmFtZSA9IHNlcnZpY2VOYW1lOwogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgdGhpcy5zaWduYXR1cmVDYWNoZSA9IHR5cGVvZiBvcHRpb25zLnNpZ25hdHVyZUNhY2hlID09PSAnYm9vbGVhbicgPyBvcHRpb25zLnNpZ25hdHVyZUNhY2hlIDogdHJ1ZTsKICAgICAgdGhpcy5vcGVyYXRpb24gPSBvcHRpb25zLm9wZXJhdGlvbjsKICAgICAgdGhpcy5zaWduYXR1cmVWZXJzaW9uID0gb3B0aW9ucy5zaWduYXR1cmVWZXJzaW9uOwogICAgfSwKICAKICAgIGFsZ29yaXRobTogJ0FXUzQtSE1BQy1TSEEyNTYnLAogIAogICAgYWRkQXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYWRkQXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZSkgewogICAgICB2YXIgZGF0ZXRpbWUgPSBBV1MudXRpbC5kYXRlLmlzbzg2MDEoZGF0ZSkucmVwbGFjZSgvWzpcLV18XC5cZHszfS9nLCAnJyk7CiAgCiAgICAgIGlmICh0aGlzLmlzUHJlc2lnbmVkKCkpIHsKICAgICAgICB0aGlzLnVwZGF0ZUZvclByZXNpZ25lZChjcmVkZW50aWFscywgZGF0ZXRpbWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYWRkSGVhZGVycyhjcmVkZW50aWFscywgZGF0ZXRpbWUpOwogICAgICB9CiAgCiAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydBdXRob3JpemF0aW9uJ10gPQogICAgICAgIHRoaXMuYXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZXRpbWUpOwogICAgfSwKICAKICAgIGFkZEhlYWRlcnM6IGZ1bmN0aW9uIGFkZEhlYWRlcnMoY3JlZGVudGlhbHMsIGRhdGV0aW1lKSB7CiAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydYLUFtei1EYXRlJ10gPSBkYXRldGltZTsKICAgICAgaWYgKGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbikgewogICAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWyd4LWFtei1zZWN1cml0eS10b2tlbiddID0gY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuOwogICAgICB9CiAgICB9LAogIAogICAgdXBkYXRlRm9yUHJlc2lnbmVkOiBmdW5jdGlvbiB1cGRhdGVGb3JQcmVzaWduZWQoY3JlZGVudGlhbHMsIGRhdGV0aW1lKSB7CiAgICAgIHZhciBjcmVkU3RyaW5nID0gdGhpcy5jcmVkZW50aWFsU3RyaW5nKGRhdGV0aW1lKTsKICAgICAgdmFyIHFzID0gewogICAgICAgICdYLUFtei1EYXRlJzogZGF0ZXRpbWUsCiAgICAgICAgJ1gtQW16LUFsZ29yaXRobSc6IHRoaXMuYWxnb3JpdGhtLAogICAgICAgICdYLUFtei1DcmVkZW50aWFsJzogY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgKyAnLycgKyBjcmVkU3RyaW5nLAogICAgICAgICdYLUFtei1FeHBpcmVzJzogdGhpcy5yZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl0sCiAgICAgICAgJ1gtQW16LVNpZ25lZEhlYWRlcnMnOiB0aGlzLnNpZ25lZEhlYWRlcnMoKQogICAgICB9OwogIAogICAgICBpZiAoY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuKSB7CiAgICAgICAgcXNbJ1gtQW16LVNlY3VyaXR5LVRva2VuJ10gPSBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW47CiAgICAgIH0KICAKICAgICAgaWYgKHRoaXMucmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXSkgewogICAgICAgIHFzWydDb250ZW50LVR5cGUnXSA9IHRoaXMucmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXTsKICAgICAgfQogICAgICBpZiAodGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtTUQ1J10pIHsKICAgICAgICBxc1snQ29udGVudC1NRDUnXSA9IHRoaXMucmVxdWVzdC5oZWFkZXJzWydDb250ZW50LU1ENSddOwogICAgICB9CiAgICAgIGlmICh0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ2FjaGUtQ29udHJvbCddKSB7CiAgICAgICAgcXNbJ0NhY2hlLUNvbnRyb2wnXSA9IHRoaXMucmVxdWVzdC5oZWFkZXJzWydDYWNoZS1Db250cm9sJ107CiAgICAgIH0KICAKICAgICAgLy8gbmVlZCB0byBwdWxsIGluIGFueSBvdGhlciBYLUFtei0qIGhlYWRlcnMKICAgICAgQVdTLnV0aWwuZWFjaC5jYWxsKHRoaXMsIHRoaXMucmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKGtleSA9PT0gZXhwaXJlc0hlYWRlcikgcmV0dXJuOwogICAgICAgIGlmICh0aGlzLmlzU2lnbmFibGVIZWFkZXIoa2V5KSkgewogICAgICAgICAgdmFyIGxvd2VyS2V5ID0ga2V5LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAvLyBNZXRhZGF0YSBzaG91bGQgYmUgbm9ybWFsaXplZAogICAgICAgICAgaWYgKGxvd2VyS2V5LmluZGV4T2YoJ3gtYW16LW1ldGEtJykgPT09IDApIHsKICAgICAgICAgICAgcXNbbG93ZXJLZXldID0gdmFsdWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGxvd2VyS2V5LmluZGV4T2YoJ3gtYW16LScpID09PSAwKSB7CiAgICAgICAgICAgIHFzW2tleV0gPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICB2YXIgc2VwID0gdGhpcy5yZXF1ZXN0LnBhdGguaW5kZXhPZignPycpID49IDAgPyAnJicgOiAnPyc7CiAgICAgIHRoaXMucmVxdWVzdC5wYXRoICs9IHNlcCArIEFXUy51dGlsLnF1ZXJ5UGFyYW1zVG9TdHJpbmcocXMpOwogICAgfSwKICAKICAgIGF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGV0aW1lKSB7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICB2YXIgY3JlZFN0cmluZyA9IHRoaXMuY3JlZGVudGlhbFN0cmluZyhkYXRldGltZSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5hbGdvcml0aG0gKyAnIENyZWRlbnRpYWw9JyArCiAgICAgICAgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgKyAnLycgKyBjcmVkU3RyaW5nKTsKICAgICAgcGFydHMucHVzaCgnU2lnbmVkSGVhZGVycz0nICsgdGhpcy5zaWduZWRIZWFkZXJzKCkpOwogICAgICBwYXJ0cy5wdXNoKCdTaWduYXR1cmU9JyArIHRoaXMuc2lnbmF0dXJlKGNyZWRlbnRpYWxzLCBkYXRldGltZSkpOwogICAgICByZXR1cm4gcGFydHMuam9pbignLCAnKTsKICAgIH0sCiAgCiAgICBzaWduYXR1cmU6IGZ1bmN0aW9uIHNpZ25hdHVyZShjcmVkZW50aWFscywgZGF0ZXRpbWUpIHsKICAgICAgdmFyIHNpZ25pbmdLZXkgPSB2NENyZWRlbnRpYWxzLmdldFNpZ25pbmdLZXkoCiAgICAgICAgY3JlZGVudGlhbHMsCiAgICAgICAgZGF0ZXRpbWUuc3Vic3RyKDAsIDgpLAogICAgICAgIHRoaXMucmVxdWVzdC5yZWdpb24sCiAgICAgICAgdGhpcy5zZXJ2aWNlTmFtZSwKICAgICAgICB0aGlzLnNpZ25hdHVyZUNhY2hlCiAgICAgICk7CiAgICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uaG1hYyhzaWduaW5nS2V5LCB0aGlzLnN0cmluZ1RvU2lnbihkYXRldGltZSksICdoZXgnKTsKICAgIH0sCiAgCiAgICBzdHJpbmdUb1NpZ246IGZ1bmN0aW9uIHN0cmluZ1RvU2lnbihkYXRldGltZSkgewogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgcGFydHMucHVzaCgnQVdTNC1ITUFDLVNIQTI1NicpOwogICAgICBwYXJ0cy5wdXNoKGRhdGV0aW1lKTsKICAgICAgcGFydHMucHVzaCh0aGlzLmNyZWRlbnRpYWxTdHJpbmcoZGF0ZXRpbWUpKTsKICAgICAgcGFydHMucHVzaCh0aGlzLmhleEVuY29kZWRIYXNoKHRoaXMuY2Fub25pY2FsU3RyaW5nKCkpKTsKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CiAgICB9LAogIAogICAgY2Fub25pY2FsU3RyaW5nOiBmdW5jdGlvbiBjYW5vbmljYWxTdHJpbmcoKSB7CiAgICAgIHZhciBwYXJ0cyA9IFtdLCBwYXRobmFtZSA9IHRoaXMucmVxdWVzdC5wYXRobmFtZSgpOwogICAgICBpZiAodGhpcy5zZXJ2aWNlTmFtZSAhPT0gJ3MzJyAmJiB0aGlzLnNpZ25hdHVyZVZlcnNpb24gIT09ICdzM3Y0JykgcGF0aG5hbWUgPSBBV1MudXRpbC51cmlFc2NhcGVQYXRoKHBhdGhuYW1lKTsKICAKICAgICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3QubWV0aG9kKTsKICAgICAgcGFydHMucHVzaChwYXRobmFtZSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0LnNlYXJjaCgpKTsKICAgICAgcGFydHMucHVzaCh0aGlzLmNhbm9uaWNhbEhlYWRlcnMoKSArICdcbicpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMuc2lnbmVkSGVhZGVycygpKTsKICAgICAgcGFydHMucHVzaCh0aGlzLmhleEVuY29kZWRCb2R5SGFzaCgpKTsKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CiAgICB9LAogIAogICAgY2Fub25pY2FsSGVhZGVyczogZnVuY3Rpb24gY2Fub25pY2FsSGVhZGVycygpIHsKICAgICAgdmFyIGhlYWRlcnMgPSBbXTsKICAgICAgQVdTLnV0aWwuZWFjaC5jYWxsKHRoaXMsIHRoaXMucmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiAoa2V5LCBpdGVtKSB7CiAgICAgICAgaGVhZGVycy5wdXNoKFtrZXksIGl0ZW1dKTsKICAgICAgfSk7CiAgICAgIGhlYWRlcnMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICAgIHJldHVybiBhWzBdLnRvTG93ZXJDYXNlKCkgPCBiWzBdLnRvTG93ZXJDYXNlKCkgPyAtMSA6IDE7CiAgICAgIH0pOwogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoLmNhbGwodGhpcywgaGVhZGVycywgZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICB2YXIga2V5ID0gaXRlbVswXS50b0xvd2VyQ2FzZSgpOwogICAgICAgIGlmICh0aGlzLmlzU2lnbmFibGVIZWFkZXIoa2V5KSkgewogICAgICAgICAgdmFyIHZhbHVlID0gaXRlbVsxXTsKICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnIHx8IHZhbHVlID09PSBudWxsIHx8IHR5cGVvZiB2YWx1ZS50b1N0cmluZyAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ0hlYWRlciAnICsga2V5ICsgJyBjb250YWlucyBpbnZhbGlkIHZhbHVlJyksIHsKICAgICAgICAgICAgICBjb2RlOiAnSW52YWxpZEhlYWRlcicKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBwYXJ0cy5wdXNoKGtleSArICc6JyArCiAgICAgICAgICAgIHRoaXMuY2Fub25pY2FsSGVhZGVyVmFsdWVzKHZhbHVlLnRvU3RyaW5nKCkpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKICAgIH0sCiAgCiAgICBjYW5vbmljYWxIZWFkZXJWYWx1ZXM6IGZ1bmN0aW9uIGNhbm9uaWNhbEhlYWRlclZhbHVlcyh2YWx1ZXMpIHsKICAgICAgcmV0dXJuIHZhbHVlcy5yZXBsYWNlKC9ccysvZywgJyAnKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpOwogICAgfSwKICAKICAgIHNpZ25lZEhlYWRlcnM6IGZ1bmN0aW9uIHNpZ25lZEhlYWRlcnMoKSB7CiAgICAgIHZhciBrZXlzID0gW107CiAgICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLnJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gKGtleSkgewogICAgICAgIGtleSA9IGtleS50b0xvd2VyQ2FzZSgpOwogICAgICAgIGlmICh0aGlzLmlzU2lnbmFibGVIZWFkZXIoa2V5KSkga2V5cy5wdXNoKGtleSk7CiAgICAgIH0pOwogICAgICByZXR1cm4ga2V5cy5zb3J0KCkuam9pbignOycpOwogICAgfSwKICAKICAgIGNyZWRlbnRpYWxTdHJpbmc6IGZ1bmN0aW9uIGNyZWRlbnRpYWxTdHJpbmcoZGF0ZXRpbWUpIHsKICAgICAgcmV0dXJuIHY0Q3JlZGVudGlhbHMuY3JlYXRlU2NvcGUoCiAgICAgICAgZGF0ZXRpbWUuc3Vic3RyKDAsIDgpLAogICAgICAgIHRoaXMucmVxdWVzdC5yZWdpb24sCiAgICAgICAgdGhpcy5zZXJ2aWNlTmFtZQogICAgICApOwogICAgfSwKICAKICAgIGhleEVuY29kZWRIYXNoOiBmdW5jdGlvbiBoYXNoKHN0cmluZykgewogICAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLnNoYTI1NihzdHJpbmcsICdoZXgnKTsKICAgIH0sCiAgCiAgICBoZXhFbmNvZGVkQm9keUhhc2g6IGZ1bmN0aW9uIGhleEVuY29kZWRCb2R5SGFzaCgpIHsKICAgICAgdmFyIHJlcXVlc3QgPSB0aGlzLnJlcXVlc3Q7CiAgICAgIGlmICh0aGlzLmlzUHJlc2lnbmVkKCkgJiYgdGhpcy5zZXJ2aWNlTmFtZSA9PT0gJ3MzJyAmJiAhcmVxdWVzdC5ib2R5KSB7CiAgICAgICAgcmV0dXJuICdVTlNJR05FRC1QQVlMT0FEJzsKICAgICAgfSBlbHNlIGlmIChyZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LUNvbnRlbnQtU2hhMjU2J10pIHsKICAgICAgICByZXR1cm4gcmVxdWVzdC5oZWFkZXJzWydYLUFtei1Db250ZW50LVNoYTI1NiddOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmhleEVuY29kZWRIYXNoKHRoaXMucmVxdWVzdC5ib2R5IHx8ICcnKTsKICAgICAgfQogICAgfSwKICAKICAgIHVuc2lnbmFibGVIZWFkZXJzOiBbCiAgICAgICdhdXRob3JpemF0aW9uJywKICAgICAgJ2NvbnRlbnQtdHlwZScsCiAgICAgICdjb250ZW50LWxlbmd0aCcsCiAgICAgICd1c2VyLWFnZW50JywKICAgICAgZXhwaXJlc0hlYWRlciwKICAgICAgJ2V4cGVjdCcsCiAgICAgICd4LWFtem4tdHJhY2UtaWQnCiAgICBdLAogIAogICAgaXNTaWduYWJsZUhlYWRlcjogZnVuY3Rpb24gaXNTaWduYWJsZUhlYWRlcihrZXkpIHsKICAgICAgaWYgKGtleS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJ3gtYW16LScpID09PSAwKSByZXR1cm4gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXMudW5zaWduYWJsZUhlYWRlcnMuaW5kZXhPZihrZXkpIDwgMDsKICAgIH0sCiAgCiAgICBpc1ByZXNpZ25lZDogZnVuY3Rpb24gaXNQcmVzaWduZWQoKSB7CiAgICAgIHJldHVybiB0aGlzLnJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXSA/IHRydWUgOiBmYWxzZTsKICAgIH0KICAKICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlY0OwogIAogIH0seyIuLi9jb3JlIjoxOCwiLi92NF9jcmVkZW50aWFscyI6Njl9XSw2OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgY2FjaGVkU2VjcmV0ID0ge307CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIGNhY2hlUXVldWUgPSBbXTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgbWF4Q2FjaGVFbnRyaWVzID0gNTA7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIHY0SWRlbnRpZmllciA9ICdhd3M0X3JlcXVlc3QnOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW0gZGF0ZSBbU3RyaW5nXQogICAgICogQHBhcmFtIHJlZ2lvbiBbU3RyaW5nXQogICAgICogQHBhcmFtIHNlcnZpY2VOYW1lIFtTdHJpbmddCiAgICAgKiBAcmV0dXJuIFtTdHJpbmddCiAgICAgKi8KICAgIGNyZWF0ZVNjb3BlOiBmdW5jdGlvbiBjcmVhdGVTY29wZShkYXRlLCByZWdpb24sIHNlcnZpY2VOYW1lKSB7CiAgICAgIHJldHVybiBbCiAgICAgICAgZGF0ZS5zdWJzdHIoMCwgOCksCiAgICAgICAgcmVnaW9uLAogICAgICAgIHNlcnZpY2VOYW1lLAogICAgICAgIHY0SWRlbnRpZmllcgogICAgICBdLmpvaW4oJy8nKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICoKICAgICAqIEBwYXJhbSBjcmVkZW50aWFscyBbQ3JlZGVudGlhbHNdCiAgICAgKiBAcGFyYW0gZGF0ZSBbU3RyaW5nXQogICAgICogQHBhcmFtIHJlZ2lvbiBbU3RyaW5nXQogICAgICogQHBhcmFtIHNlcnZpY2UgW1N0cmluZ10KICAgICAqIEBwYXJhbSBzaG91bGRDYWNoZSBbQm9vbGVhbl0KICAgICAqIEByZXR1cm4gW1N0cmluZ10KICAgICAqLwogICAgZ2V0U2lnbmluZ0tleTogZnVuY3Rpb24gZ2V0U2lnbmluZ0tleSgKICAgICAgY3JlZGVudGlhbHMsCiAgICAgIGRhdGUsCiAgICAgIHJlZ2lvbiwKICAgICAgc2VydmljZSwKICAgICAgc2hvdWxkQ2FjaGUKICAgICkgewogICAgICB2YXIgY3JlZHNJZGVudGlmaWVyID0gQVdTLnV0aWwuY3J5cHRvCiAgICAgICAgLmhtYWMoY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5LCBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCwgJ2Jhc2U2NCcpOwogICAgICB2YXIgY2FjaGVLZXkgPSBbY3JlZHNJZGVudGlmaWVyLCBkYXRlLCByZWdpb24sIHNlcnZpY2VdLmpvaW4oJ18nKTsKICAgICAgc2hvdWxkQ2FjaGUgPSBzaG91bGRDYWNoZSAhPT0gZmFsc2U7CiAgICAgIGlmIChzaG91bGRDYWNoZSAmJiAoY2FjaGVLZXkgaW4gY2FjaGVkU2VjcmV0KSkgewogICAgICAgIHJldHVybiBjYWNoZWRTZWNyZXRbY2FjaGVLZXldOwogICAgICB9CiAgCiAgICAgIHZhciBrRGF0ZSA9IEFXUy51dGlsLmNyeXB0by5obWFjKAogICAgICAgICdBV1M0JyArIGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSwKICAgICAgICBkYXRlLAogICAgICAgICdidWZmZXInCiAgICAgICk7CiAgICAgIHZhciBrUmVnaW9uID0gQVdTLnV0aWwuY3J5cHRvLmhtYWMoa0RhdGUsIHJlZ2lvbiwgJ2J1ZmZlcicpOwogICAgICB2YXIga1NlcnZpY2UgPSBBV1MudXRpbC5jcnlwdG8uaG1hYyhrUmVnaW9uLCBzZXJ2aWNlLCAnYnVmZmVyJyk7CiAgCiAgICAgIHZhciBzaWduaW5nS2V5ID0gQVdTLnV0aWwuY3J5cHRvLmhtYWMoa1NlcnZpY2UsIHY0SWRlbnRpZmllciwgJ2J1ZmZlcicpOwogICAgICBpZiAoc2hvdWxkQ2FjaGUpIHsKICAgICAgICBjYWNoZWRTZWNyZXRbY2FjaGVLZXldID0gc2lnbmluZ0tleTsKICAgICAgICBjYWNoZVF1ZXVlLnB1c2goY2FjaGVLZXkpOwogICAgICAgIGlmIChjYWNoZVF1ZXVlLmxlbmd0aCA+IG1heENhY2hlRW50cmllcykgewogICAgICAgICAgLy8gcmVtb3ZlIHRoZSBvbGRlc3QgZW50cnkgKG5vdCB0aGUgbGVhc3QgcmVjZW50bHkgdXNlZCkKICAgICAgICAgIGRlbGV0ZSBjYWNoZWRTZWNyZXRbY2FjaGVRdWV1ZS5zaGlmdCgpXTsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHNpZ25pbmdLZXk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqCiAgICAgKiBFbXB0aWVzIHRoZSBkZXJpdmVkIHNpZ25pbmcga2V5IGNhY2hlLiBNYWRlIGF2YWlsYWJsZSBmb3IgdGVzdGluZyBwdXJwb3NlcwogICAgICogb25seS4KICAgICAqLwogICAgZW1wdHlDYWNoZTogZnVuY3Rpb24gZW1wdHlDYWNoZSgpIHsKICAgICAgY2FjaGVkU2VjcmV0ID0ge307CiAgICAgIGNhY2hlUXVldWUgPSBbXTsKICAgIH0KICB9OwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDcwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBmdW5jdGlvbiBBY2NlcHRvclN0YXRlTWFjaGluZShzdGF0ZXMsIHN0YXRlKSB7CiAgICB0aGlzLmN1cnJlbnRTdGF0ZSA9IHN0YXRlIHx8IG51bGw7CiAgICB0aGlzLnN0YXRlcyA9IHN0YXRlcyB8fCB7fTsKICB9CiAgCiAgQWNjZXB0b3JTdGF0ZU1hY2hpbmUucHJvdG90eXBlLnJ1blRvID0gZnVuY3Rpb24gcnVuVG8oZmluYWxTdGF0ZSwgZG9uZSwgYmluZE9iamVjdCwgaW5wdXRFcnJvcikgewogICAgaWYgKHR5cGVvZiBmaW5hbFN0YXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGlucHV0RXJyb3IgPSBiaW5kT2JqZWN0OyBiaW5kT2JqZWN0ID0gZG9uZTsKICAgICAgZG9uZSA9IGZpbmFsU3RhdGU7IGZpbmFsU3RhdGUgPSBudWxsOwogICAgfQogIAogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHN0YXRlID0gc2VsZi5zdGF0ZXNbc2VsZi5jdXJyZW50U3RhdGVdOwogICAgc3RhdGUuZm4uY2FsbChiaW5kT2JqZWN0IHx8IHNlbGYsIGlucHV0RXJyb3IsIGZ1bmN0aW9uKGVycikgewogICAgICBpZiAoZXJyKSB7CiAgICAgICAgaWYgKHN0YXRlLmZhaWwpIHNlbGYuY3VycmVudFN0YXRlID0gc3RhdGUuZmFpbDsKICAgICAgICBlbHNlIHJldHVybiBkb25lID8gZG9uZS5jYWxsKGJpbmRPYmplY3QsIGVycikgOiBudWxsOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChzdGF0ZS5hY2NlcHQpIHNlbGYuY3VycmVudFN0YXRlID0gc3RhdGUuYWNjZXB0OwogICAgICAgIGVsc2UgcmV0dXJuIGRvbmUgPyBkb25lLmNhbGwoYmluZE9iamVjdCkgOiBudWxsOwogICAgICB9CiAgICAgIGlmIChzZWxmLmN1cnJlbnRTdGF0ZSA9PT0gZmluYWxTdGF0ZSkgewogICAgICAgIHJldHVybiBkb25lID8gZG9uZS5jYWxsKGJpbmRPYmplY3QsIGVycikgOiBudWxsOwogICAgICB9CiAgCiAgICAgIHNlbGYucnVuVG8oZmluYWxTdGF0ZSwgZG9uZSwgYmluZE9iamVjdCwgZXJyKTsKICAgIH0pOwogIH07CiAgCiAgQWNjZXB0b3JTdGF0ZU1hY2hpbmUucHJvdG90eXBlLmFkZFN0YXRlID0gZnVuY3Rpb24gYWRkU3RhdGUobmFtZSwgYWNjZXB0U3RhdGUsIGZhaWxTdGF0ZSwgZm4pIHsKICAgIGlmICh0eXBlb2YgYWNjZXB0U3RhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgZm4gPSBhY2NlcHRTdGF0ZTsgYWNjZXB0U3RhdGUgPSBudWxsOyBmYWlsU3RhdGUgPSBudWxsOwogICAgfSBlbHNlIGlmICh0eXBlb2YgZmFpbFN0YXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGZuID0gZmFpbFN0YXRlOyBmYWlsU3RhdGUgPSBudWxsOwogICAgfQogIAogICAgaWYgKCF0aGlzLmN1cnJlbnRTdGF0ZSkgdGhpcy5jdXJyZW50U3RhdGUgPSBuYW1lOwogICAgdGhpcy5zdGF0ZXNbbmFtZV0gPSB7IGFjY2VwdDogYWNjZXB0U3RhdGUsIGZhaWw6IGZhaWxTdGF0ZSwgZm46IGZuIH07CiAgICByZXR1cm4gdGhpczsKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQWNjZXB0b3JTdGF0ZU1hY2hpbmU7CiAgCiAgfSx7fV0sNzE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAocHJvY2VzcyxzZXRJbW1lZGlhdGUpewogIC8qIGVzbGludCBndWFyZC1mb3ItaW46MCAqLwogIHZhciBBV1M7CiAgCiAgLyoqCiAgICogQSBzZXQgb2YgdXRpbGl0eSBtZXRob2RzIGZvciB1c2Ugd2l0aCB0aGUgQVdTIFNESy4KICAgKgogICAqIEAhYXR0cmlidXRlIGFib3J0CiAgICogICBSZXR1cm4gdGhpcyB2YWx1ZSBmcm9tIGFuIGl0ZXJhdG9yIGZ1bmN0aW9uIHtlYWNofSBvciB7YXJyYXlFYWNofQogICAqICAgdG8gYnJlYWsgb3V0IG9mIHRoZSBpdGVyYXRpb24uCiAgICogICBAZXhhbXBsZSBCcmVha2luZyBvdXQgb2YgYW4gaXRlcmF0b3IgZnVuY3Rpb24KICAgKiAgICAgQVdTLnV0aWwuZWFjaCh7YTogMSwgYjogMiwgYzogM30sIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgKiAgICAgICBpZiAoa2V5ID09ICdiJykgcmV0dXJuIEFXUy51dGlsLmFib3J0OwogICAqICAgICB9KTsKICAgKiAgIEBzZWUgZWFjaAogICAqICAgQHNlZSBhcnJheUVhY2gKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgdXRpbCA9IHsKICAgIGVudmlyb25tZW50OiAnbm9kZWpzJywKICAgIGVuZ2luZTogZnVuY3Rpb24gZW5naW5lKCkgewogICAgICBpZiAodXRpbC5pc0Jyb3dzZXIoKSAmJiB0eXBlb2YgbmF2aWdhdG9yICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIHJldHVybiBuYXZpZ2F0b3IudXNlckFnZW50OwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBlbmdpbmUgPSBwcm9jZXNzLnBsYXRmb3JtICsgJy8nICsgcHJvY2Vzcy52ZXJzaW9uOwogICAgICAgIGlmIChwcm9jZXNzLmVudi5BV1NfRVhFQ1VUSU9OX0VOVikgewogICAgICAgICAgZW5naW5lICs9ICcgZXhlYy1lbnYvJyArIHByb2Nlc3MuZW52LkFXU19FWEVDVVRJT05fRU5WOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZW5naW5lOwogICAgICB9CiAgICB9LAogIAogICAgdXNlckFnZW50OiBmdW5jdGlvbiB1c2VyQWdlbnQoKSB7CiAgICAgIHZhciBuYW1lID0gdXRpbC5lbnZpcm9ubWVudDsKICAgICAgdmFyIGFnZW50ID0gJ2F3cy1zZGstJyArIG5hbWUgKyAnLycgKyByZXF1aXJlKCcuL2NvcmUnKS5WRVJTSU9OOwogICAgICBpZiAobmFtZSA9PT0gJ25vZGVqcycpIGFnZW50ICs9ICcgJyArIHV0aWwuZW5naW5lKCk7CiAgICAgIHJldHVybiBhZ2VudDsKICAgIH0sCiAgCiAgICB1cmlFc2NhcGU6IGZ1bmN0aW9uIHVyaUVzY2FwZShzdHJpbmcpIHsKICAgICAgdmFyIG91dHB1dCA9IGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmcpOwogICAgICBvdXRwdXQgPSBvdXRwdXQucmVwbGFjZSgvW15BLVphLXowLTlfLn5cLSVdKy9nLCBlc2NhcGUpOwogIAogICAgICAvLyBBV1MgcGVyY2VudC1lbmNvZGVzIHNvbWUgZXh0cmEgbm9uLXN0YW5kYXJkIGNoYXJhY3RlcnMgaW4gYSBVUkkKICAgICAgb3V0cHV0ID0gb3V0cHV0LnJlcGxhY2UoL1sqXS9nLCBmdW5jdGlvbihjaCkgewogICAgICAgIHJldHVybiAnJScgKyBjaC5jaGFyQ29kZUF0KDApLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpOwogICAgICB9KTsKICAKICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH0sCiAgCiAgICB1cmlFc2NhcGVQYXRoOiBmdW5jdGlvbiB1cmlFc2NhcGVQYXRoKHN0cmluZykgewogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgdXRpbC5hcnJheUVhY2goc3RyaW5nLnNwbGl0KCcvJyksIGZ1bmN0aW9uIChwYXJ0KSB7CiAgICAgICAgcGFydHMucHVzaCh1dGlsLnVyaUVzY2FwZShwYXJ0KSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gcGFydHMuam9pbignLycpOwogICAgfSwKICAKICAgIHVybFBhcnNlOiBmdW5jdGlvbiB1cmxQYXJzZSh1cmwpIHsKICAgICAgcmV0dXJuIHV0aWwudXJsLnBhcnNlKHVybCk7CiAgICB9LAogIAogICAgdXJsRm9ybWF0OiBmdW5jdGlvbiB1cmxGb3JtYXQodXJsKSB7CiAgICAgIHJldHVybiB1dGlsLnVybC5mb3JtYXQodXJsKTsKICAgIH0sCiAgCiAgICBxdWVyeVN0cmluZ1BhcnNlOiBmdW5jdGlvbiBxdWVyeVN0cmluZ1BhcnNlKHFzKSB7CiAgICAgIHJldHVybiB1dGlsLnF1ZXJ5c3RyaW5nLnBhcnNlKHFzKTsKICAgIH0sCiAgCiAgICBxdWVyeVBhcmFtc1RvU3RyaW5nOiBmdW5jdGlvbiBxdWVyeVBhcmFtc1RvU3RyaW5nKHBhcmFtcykgewogICAgICB2YXIgaXRlbXMgPSBbXTsKICAgICAgdmFyIGVzY2FwZSA9IHV0aWwudXJpRXNjYXBlOwogICAgICB2YXIgc29ydGVkS2V5cyA9IE9iamVjdC5rZXlzKHBhcmFtcykuc29ydCgpOwogIAogICAgICB1dGlsLmFycmF5RWFjaChzb3J0ZWRLZXlzLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgdmFyIHZhbHVlID0gcGFyYW1zW25hbWVdOwogICAgICAgIHZhciBlbmFtZSA9IGVzY2FwZShuYW1lKTsKICAgICAgICB2YXIgcmVzdWx0ID0gZW5hbWUgKyAnPSc7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICB2YXIgdmFscyA9IFtdOwogICAgICAgICAgdXRpbC5hcnJheUVhY2godmFsdWUsIGZ1bmN0aW9uKGl0ZW0pIHsgdmFscy5wdXNoKGVzY2FwZShpdGVtKSk7IH0pOwogICAgICAgICAgcmVzdWx0ID0gZW5hbWUgKyAnPScgKyB2YWxzLnNvcnQoKS5qb2luKCcmJyArIGVuYW1lICsgJz0nKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09IG51bGwpIHsKICAgICAgICAgIHJlc3VsdCA9IGVuYW1lICsgJz0nICsgZXNjYXBlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgaXRlbXMucHVzaChyZXN1bHQpOwogICAgICB9KTsKICAKICAgICAgcmV0dXJuIGl0ZW1zLmpvaW4oJyYnKTsKICAgIH0sCiAgCiAgICByZWFkRmlsZVN5bmM6IGZ1bmN0aW9uIHJlYWRGaWxlU3luYyhwYXRoKSB7CiAgICAgIGlmICh1dGlsLmlzQnJvd3NlcigpKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHJlcXVpcmUoJ2ZzJykucmVhZEZpbGVTeW5jKHBhdGgsICd1dGYtOCcpOwogICAgfSwKICAKICAgIGJhc2U2NDogewogICAgICBlbmNvZGU6IGZ1bmN0aW9uIGVuY29kZTY0KHN0cmluZykgewogICAgICAgIGlmICh0eXBlb2Ygc3RyaW5nID09PSAnbnVtYmVyJykgewogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBiYXNlNjQgZW5jb2RlIG51bWJlciAnICsgc3RyaW5nKSk7CiAgICAgICAgfQogICAgICAgIGlmIChzdHJpbmcgPT09IG51bGwgfHwgdHlwZW9mIHN0cmluZyA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIHJldHVybiBzdHJpbmc7CiAgICAgICAgfQogICAgICAgIHZhciBidWYgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcihzdHJpbmcpOwogICAgICAgIHJldHVybiBidWYudG9TdHJpbmcoJ2Jhc2U2NCcpOwogICAgICB9LAogIAogICAgICBkZWNvZGU6IGZ1bmN0aW9uIGRlY29kZTY0KHN0cmluZykgewogICAgICAgIGlmICh0eXBlb2Ygc3RyaW5nID09PSAnbnVtYmVyJykgewogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBiYXNlNjQgZGVjb2RlIG51bWJlciAnICsgc3RyaW5nKSk7CiAgICAgICAgfQogICAgICAgIGlmIChzdHJpbmcgPT09IG51bGwgfHwgdHlwZW9mIHN0cmluZyA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIHJldHVybiBzdHJpbmc7CiAgICAgICAgfQogICAgICAgIHJldHVybiB1dGlsLmJ1ZmZlci50b0J1ZmZlcihzdHJpbmcsICdiYXNlNjQnKTsKICAgICAgfQogIAogICAgfSwKICAKICAgIGJ1ZmZlcjogewogICAgICAvKioKICAgICAgICogQnVmZmVyIGNvbnN0cnVjdG9yIGZvciBOb2RlIGJ1ZmZlciBhbmQgYnVmZmVyIHBvbGx5ZmlsbAogICAgICAgKi8KICAgICAgdG9CdWZmZXI6IGZ1bmN0aW9uKGRhdGEsIGVuY29kaW5nKSB7CiAgICAgICAgcmV0dXJuICh0eXBlb2YgdXRpbC5CdWZmZXIuZnJvbSA9PT0gJ2Z1bmN0aW9uJyAmJiB1dGlsLkJ1ZmZlci5mcm9tICE9PSBVaW50OEFycmF5LmZyb20pID8KICAgICAgICAgIHV0aWwuQnVmZmVyLmZyb20oZGF0YSwgZW5jb2RpbmcpIDogbmV3IHV0aWwuQnVmZmVyKGRhdGEsIGVuY29kaW5nKTsKICAgICAgfSwKICAKICAgICAgYWxsb2M6IGZ1bmN0aW9uKHNpemUsIGZpbGwsIGVuY29kaW5nKSB7CiAgICAgICAgaWYgKHR5cGVvZiBzaXplICE9PSAnbnVtYmVyJykgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdzaXplIHBhc3NlZCB0byBhbGxvYyBtdXN0IGJlIGEgbnVtYmVyLicpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIHV0aWwuQnVmZmVyLmFsbG9jID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICByZXR1cm4gdXRpbC5CdWZmZXIuYWxsb2Moc2l6ZSwgZmlsbCwgZW5jb2RpbmcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgYnVmID0gbmV3IHV0aWwuQnVmZmVyKHNpemUpOwogICAgICAgICAgaWYgKGZpbGwgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgYnVmLmZpbGwgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgYnVmLmZpbGwoZmlsbCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGVuY29kaW5nKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBidWY7CiAgICAgICAgfQogICAgICB9LAogIAogICAgICB0b1N0cmVhbTogZnVuY3Rpb24gdG9TdHJlYW0oYnVmZmVyKSB7CiAgICAgICAgaWYgKCF1dGlsLkJ1ZmZlci5pc0J1ZmZlcihidWZmZXIpKSBidWZmZXIgPSAgdXRpbC5idWZmZXIudG9CdWZmZXIoYnVmZmVyKTsKICAKICAgICAgICB2YXIgcmVhZGFibGUgPSBuZXcgKHV0aWwuc3RyZWFtLlJlYWRhYmxlKSgpOwogICAgICAgIHZhciBwb3MgPSAwOwogICAgICAgIHJlYWRhYmxlLl9yZWFkID0gZnVuY3Rpb24oc2l6ZSkgewogICAgICAgICAgaWYgKHBvcyA+PSBidWZmZXIubGVuZ3RoKSByZXR1cm4gcmVhZGFibGUucHVzaChudWxsKTsKICAKICAgICAgICAgIHZhciBlbmQgPSBwb3MgKyBzaXplOwogICAgICAgICAgaWYgKGVuZCA+IGJ1ZmZlci5sZW5ndGgpIGVuZCA9IGJ1ZmZlci5sZW5ndGg7CiAgICAgICAgICByZWFkYWJsZS5wdXNoKGJ1ZmZlci5zbGljZShwb3MsIGVuZCkpOwogICAgICAgICAgcG9zID0gZW5kOwogICAgICAgIH07CiAgCiAgICAgICAgcmV0dXJuIHJlYWRhYmxlOwogICAgICB9LAogIAogICAgICAvKioKICAgICAgICogQ29uY2F0ZW5hdGVzIGEgbGlzdCBvZiBCdWZmZXIgb2JqZWN0cy4KICAgICAgICovCiAgICAgIGNvbmNhdDogZnVuY3Rpb24oYnVmZmVycykgewogICAgICAgIHZhciBsZW5ndGggPSAwLAogICAgICAgICAgICBvZmZzZXQgPSAwLAogICAgICAgICAgICBidWZmZXIgPSBudWxsLCBpOwogIAogICAgICAgIGZvciAoaSA9IDA7IGkgPCBidWZmZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBsZW5ndGggKz0gYnVmZmVyc1tpXS5sZW5ndGg7CiAgICAgICAgfQogIAogICAgICAgIGJ1ZmZlciA9IHV0aWwuYnVmZmVyLmFsbG9jKGxlbmd0aCk7CiAgCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGJ1ZmZlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGJ1ZmZlcnNbaV0uY29weShidWZmZXIsIG9mZnNldCk7CiAgICAgICAgICBvZmZzZXQgKz0gYnVmZmVyc1tpXS5sZW5ndGg7CiAgICAgICAgfQogIAogICAgICAgIHJldHVybiBidWZmZXI7CiAgICAgIH0KICAgIH0sCiAgCiAgICBzdHJpbmc6IHsKICAgICAgYnl0ZUxlbmd0aDogZnVuY3Rpb24gYnl0ZUxlbmd0aChzdHJpbmcpIHsKICAgICAgICBpZiAoc3RyaW5nID09PSBudWxsIHx8IHN0cmluZyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gMDsKICAgICAgICBpZiAodHlwZW9mIHN0cmluZyA9PT0gJ3N0cmluZycpIHN0cmluZyA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyKHN0cmluZyk7CiAgCiAgICAgICAgaWYgKHR5cGVvZiBzdHJpbmcuYnl0ZUxlbmd0aCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHJldHVybiBzdHJpbmcuYnl0ZUxlbmd0aDsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdHJpbmcubGVuZ3RoID09PSAnbnVtYmVyJykgewogICAgICAgICAgcmV0dXJuIHN0cmluZy5sZW5ndGg7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3RyaW5nLnNpemUgPT09ICdudW1iZXInKSB7CiAgICAgICAgICByZXR1cm4gc3RyaW5nLnNpemU7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3RyaW5nLnBhdGggPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICByZXR1cm4gcmVxdWlyZSgnZnMnKS5sc3RhdFN5bmMoc3RyaW5nLnBhdGgpLnNpemU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdDYW5ub3QgZGV0ZXJtaW5lIGxlbmd0aCBvZiAnICsgc3RyaW5nKSwKICAgICAgICAgICAgeyBvYmplY3Q6IHN0cmluZyB9KTsKICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIHVwcGVyRmlyc3Q6IGZ1bmN0aW9uIHVwcGVyRmlyc3Qoc3RyaW5nKSB7CiAgICAgICAgcmV0dXJuIHN0cmluZ1swXS50b1VwcGVyQ2FzZSgpICsgc3RyaW5nLnN1YnN0cigxKTsKICAgICAgfSwKICAKICAgICAgbG93ZXJGaXJzdDogZnVuY3Rpb24gbG93ZXJGaXJzdChzdHJpbmcpIHsKICAgICAgICByZXR1cm4gc3RyaW5nWzBdLnRvTG93ZXJDYXNlKCkgKyBzdHJpbmcuc3Vic3RyKDEpOwogICAgICB9CiAgICB9LAogIAogICAgaW5pOiB7CiAgICAgIHBhcnNlOiBmdW5jdGlvbiBzdHJpbmcoaW5pKSB7CiAgICAgICAgdmFyIGN1cnJlbnRTZWN0aW9uLCBtYXAgPSB7fTsKICAgICAgICB1dGlsLmFycmF5RWFjaChpbmkuc3BsaXQoL1xyP1xuLyksIGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgICAgIGxpbmUgPSBsaW5lLnNwbGl0KC8oXnxccylbOyNdLylbMF07IC8vIHJlbW92ZSBjb21tZW50cwogICAgICAgICAgdmFyIHNlY3Rpb24gPSBsaW5lLm1hdGNoKC9eXHMqXFsoW15cW1xdXSspXF1ccyokLyk7CiAgICAgICAgICBpZiAoc2VjdGlvbikgewogICAgICAgICAgICBjdXJyZW50U2VjdGlvbiA9IHNlY3Rpb25bMV07CiAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnRTZWN0aW9uKSB7CiAgICAgICAgICAgIHZhciBpdGVtID0gbGluZS5tYXRjaCgvXlxzKiguKz8pXHMqPVxzKiguKz8pXHMqJC8pOwogICAgICAgICAgICBpZiAoaXRlbSkgewogICAgICAgICAgICAgIG1hcFtjdXJyZW50U2VjdGlvbl0gPSBtYXBbY3VycmVudFNlY3Rpb25dIHx8IHt9OwogICAgICAgICAgICAgIG1hcFtjdXJyZW50U2VjdGlvbl1baXRlbVsxXV0gPSBpdGVtWzJdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgCiAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgfQogICAgfSwKICAKICAgIGZuOiB7CiAgICAgIG5vb3A6IGZ1bmN0aW9uKCkge30sCiAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbiAoZXJyKSB7IGlmIChlcnIpIHRocm93IGVycjsgfSwKICAKICAgICAgLyoqCiAgICAgICAqIFR1cm4gYSBzeW5jaHJvbm91cyBmdW5jdGlvbiBpbnRvIGFzICJhc3luYyIgZnVuY3Rpb24gYnkgbWFraW5nIGl0IGNhbGwKICAgICAgICogYSBjYWxsYmFjay4gVGhlIHVuZGVybHlpbmcgZnVuY3Rpb24gaXMgY2FsbGVkIHdpdGggYWxsIGJ1dCB0aGUgbGFzdCBhcmd1bWVudCwKICAgICAgICogd2hpY2ggaXMgdHJlYXRlZCBhcyB0aGUgY2FsbGJhY2suIFRoZSBjYWxsYmFjayBpcyBwYXNzZWQgcGFzc2VkIGEgZmlyc3QgYXJndW1lbnQKICAgICAgICogb2YgbnVsbCBvbiBzdWNjZXNzIHRvIG1pbWljayBzdGFuZGFyZCBub2RlIGNhbGxiYWNrcy4KICAgICAgICovCiAgICAgIG1ha2VBc3luYzogZnVuY3Rpb24gbWFrZUFzeW5jKGZuLCBleHBlY3RlZEFyZ3MpIHsKICAgICAgICBpZiAoZXhwZWN0ZWRBcmdzICYmIGV4cGVjdGVkQXJncyA8PSBmbi5sZW5ndGgpIHsKICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICB9CiAgCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgICAgICAgdmFyIGNhbGxiYWNrID0gYXJncy5wb3AoKTsKICAgICAgICAgIHZhciByZXN1bHQgPSBmbi5hcHBseShudWxsLCBhcmdzKTsKICAgICAgICAgIGNhbGxiYWNrKHJlc3VsdCk7CiAgICAgICAgfTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogRGF0ZSBhbmQgdGltZSB1dGlsaXR5IGZ1bmN0aW9ucy4KICAgICAqLwogICAgZGF0ZTogewogIAogICAgICAvKioKICAgICAgICogQHJldHVybiBbRGF0ZV0gdGhlIGN1cnJlbnQgSmF2YVNjcmlwdCBkYXRlIG9iamVjdC4gU2luY2UgYWxsCiAgICAgICAqICAgQVdTIHNlcnZpY2VzIHJlbHkgb24gdGhpcyBkYXRlIG9iamVjdCwgeW91IGNhbiBvdmVycmlkZQogICAgICAgKiAgIHRoaXMgZnVuY3Rpb24gdG8gcHJvdmlkZSBhIHNwZWNpYWwgdGltZSB2YWx1ZSB0byBBV1Mgc2VydmljZQogICAgICAgKiAgIHJlcXVlc3RzLgogICAgICAgKi8KICAgICAgZ2V0RGF0ZTogZnVuY3Rpb24gZ2V0RGF0ZSgpIHsKICAgICAgICBpZiAoIUFXUykgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgICAgICAgaWYgKEFXUy5jb25maWcuc3lzdGVtQ2xvY2tPZmZzZXQpIHsgLy8gdXNlIG9mZnNldCB3aGVuIG5vbi16ZXJvCiAgICAgICAgICByZXR1cm4gbmV3IERhdGUobmV3IERhdGUoKS5nZXRUaW1lKCkgKyBBV1MuY29uZmlnLnN5c3RlbUNsb2NrT2Zmc2V0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKCk7CiAgICAgICAgfQogICAgICB9LAogIAogICAgICAvKioKICAgICAgICogQHJldHVybiBbU3RyaW5nXSB0aGUgZGF0ZSBpbiBJU08tODYwMSBmb3JtYXQKICAgICAgICovCiAgICAgIGlzbzg2MDE6IGZ1bmN0aW9uIGlzbzg2MDEoZGF0ZSkgewogICAgICAgIGlmIChkYXRlID09PSB1bmRlZmluZWQpIHsgZGF0ZSA9IHV0aWwuZGF0ZS5nZXREYXRlKCk7IH0KICAgICAgICByZXR1cm4gZGF0ZS50b0lTT1N0cmluZygpLnJlcGxhY2UoL1wuXGR7M31aJC8sICdaJyk7CiAgICAgIH0sCiAgCiAgICAgIC8qKgogICAgICAgKiBAcmV0dXJuIFtTdHJpbmddIHRoZSBkYXRlIGluIFJGQyA4MjIgZm9ybWF0CiAgICAgICAqLwogICAgICByZmM4MjI6IGZ1bmN0aW9uIHJmYzgyMihkYXRlKSB7CiAgICAgICAgaWYgKGRhdGUgPT09IHVuZGVmaW5lZCkgeyBkYXRlID0gdXRpbC5kYXRlLmdldERhdGUoKTsgfQogICAgICAgIHJldHVybiBkYXRlLnRvVVRDU3RyaW5nKCk7CiAgICAgIH0sCiAgCiAgICAgIC8qKgogICAgICAgKiBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgVU5JWCB0aW1lc3RhbXAgdmFsdWUgZm9yIHRoZSBjdXJyZW50IHRpbWUKICAgICAgICovCiAgICAgIHVuaXhUaW1lc3RhbXA6IGZ1bmN0aW9uIHVuaXhUaW1lc3RhbXAoZGF0ZSkgewogICAgICAgIGlmIChkYXRlID09PSB1bmRlZmluZWQpIHsgZGF0ZSA9IHV0aWwuZGF0ZS5nZXREYXRlKCk7IH0KICAgICAgICByZXR1cm4gZGF0ZS5nZXRUaW1lKCkgLyAxMDAwOwogICAgICB9LAogIAogICAgICAvKioKICAgICAgICogQHBhcmFtIFtTdHJpbmcsbnVtYmVyLERhdGVdIGRhdGUKICAgICAgICogQHJldHVybiBbRGF0ZV0KICAgICAgICovCiAgICAgIGZyb206IGZ1bmN0aW9uIGZvcm1hdChkYXRlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBkYXRlID09PSAnbnVtYmVyJykgewogICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKGRhdGUgKiAxMDAwKTsgLy8gdW5peCB0aW1lc3RhbXAKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKGRhdGUpOwogICAgICAgIH0KICAgICAgfSwKICAKICAgICAgLyoqCiAgICAgICAqIEdpdmVuIGEgRGF0ZSBvciBkYXRlLWxpa2UgdmFsdWUsIHRoaXMgZnVuY3Rpb24gZm9ybWF0cyB0aGUKICAgICAgICogZGF0ZSBpbnRvIGEgc3RyaW5nIG9mIHRoZSByZXF1ZXN0ZWQgdmFsdWUuCiAgICAgICAqIEBwYXJhbSBbU3RyaW5nLG51bWJlcixEYXRlXSBkYXRlCiAgICAgICAqIEBwYXJhbSBbU3RyaW5nXSBmb3JtYXR0ZXIgVmFsaWQgZm9ybWF0cyBhcmU6CiAgICAgICAjICAgKiAnaXNvODYwMScKICAgICAgICMgICAqICdyZmM4MjInCiAgICAgICAjICAgKiAndW5peFRpbWVzdGFtcCcKICAgICAgICogQHJldHVybiBbU3RyaW5nXQogICAgICAgKi8KICAgICAgZm9ybWF0OiBmdW5jdGlvbiBmb3JtYXQoZGF0ZSwgZm9ybWF0dGVyKSB7CiAgICAgICAgaWYgKCFmb3JtYXR0ZXIpIGZvcm1hdHRlciA9ICdpc284NjAxJzsKICAgICAgICByZXR1cm4gdXRpbC5kYXRlW2Zvcm1hdHRlcl0odXRpbC5kYXRlLmZyb20oZGF0ZSkpOwogICAgICB9LAogIAogICAgICBwYXJzZVRpbWVzdGFtcDogZnVuY3Rpb24gcGFyc2VUaW1lc3RhbXAodmFsdWUpIHsKICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykgeyAvLyB1bml4IHRpbWVzdGFtcCAobnVtYmVyKQogICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHZhbHVlICogMTAwMCk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5tYXRjaCgvXlxkKyQvKSkgeyAvLyB1bml4IHRpbWVzdGFtcAogICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHZhbHVlICogMTAwMCk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5tYXRjaCgvXlxkezR9LykpIHsgLy8gaXNvODYwMQogICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLm1hdGNoKC9eXHd7M30sLykpIHsgLy8gcmZjODIyCiAgICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKAogICAgICAgICAgICBuZXcgRXJyb3IoJ3VuaGFuZGxlZCB0aW1lc3RhbXAgZm9ybWF0OiAnICsgdmFsdWUpLAogICAgICAgICAgICB7Y29kZTogJ1RpbWVzdGFtcFBhcnNlckVycm9yJ30pOwogICAgICAgIH0KICAgICAgfQogIAogICAgfSwKICAKICAgIGNyeXB0bzogewogICAgICBjcmMzMlRhYmxlOiBbCiAgICAgICAweDAwMDAwMDAwLCAweDc3MDczMDk2LCAweEVFMEU2MTJDLCAweDk5MDk1MUJBLCAweDA3NkRDNDE5LAogICAgICAgMHg3MDZBRjQ4RiwgMHhFOTYzQTUzNSwgMHg5RTY0OTVBMywgMHgwRURCODgzMiwgMHg3OURDQjhBNCwKICAgICAgIDB4RTBENUU5MUUsIDB4OTdEMkQ5ODgsIDB4MDlCNjRDMkIsIDB4N0VCMTdDQkQsIDB4RTdCODJEMDcsCiAgICAgICAweDkwQkYxRDkxLCAweDFEQjcxMDY0LCAweDZBQjAyMEYyLCAweEYzQjk3MTQ4LCAweDg0QkU0MURFLAogICAgICAgMHgxQURBRDQ3RCwgMHg2RERERTRFQiwgMHhGNEQ0QjU1MSwgMHg4M0QzODVDNywgMHgxMzZDOTg1NiwKICAgICAgIDB4NjQ2QkE4QzAsIDB4RkQ2MkY5N0EsIDB4OEE2NUM5RUMsIDB4MTQwMTVDNEYsIDB4NjMwNjZDRDksCiAgICAgICAweEZBMEYzRDYzLCAweDhEMDgwREY1LCAweDNCNkUyMEM4LCAweDRDNjkxMDVFLCAweEQ1NjA0MUU0LAogICAgICAgMHhBMjY3NzE3MiwgMHgzQzAzRTREMSwgMHg0QjA0RDQ0NywgMHhEMjBEODVGRCwgMHhBNTBBQjU2QiwKICAgICAgIDB4MzVCNUE4RkEsIDB4NDJCMjk4NkMsIDB4REJCQkM5RDYsIDB4QUNCQ0Y5NDAsIDB4MzJEODZDRTMsCiAgICAgICAweDQ1REY1Qzc1LCAweERDRDYwRENGLCAweEFCRDEzRDU5LCAweDI2RDkzMEFDLCAweDUxREUwMDNBLAogICAgICAgMHhDOEQ3NTE4MCwgMHhCRkQwNjExNiwgMHgyMUI0RjRCNSwgMHg1NkIzQzQyMywgMHhDRkJBOTU5OSwKICAgICAgIDB4QjhCREE1MEYsIDB4MjgwMkI4OUUsIDB4NUYwNTg4MDgsIDB4QzYwQ0Q5QjIsIDB4QjEwQkU5MjQsCiAgICAgICAweDJGNkY3Qzg3LCAweDU4Njg0QzExLCAweEMxNjExREFCLCAweEI2NjYyRDNELCAweDc2REM0MTkwLAogICAgICAgMHgwMURCNzEwNiwgMHg5OEQyMjBCQywgMHhFRkQ1MTAyQSwgMHg3MUIxODU4OSwgMHgwNkI2QjUxRiwKICAgICAgIDB4OUZCRkU0QTUsIDB4RThCOEQ0MzMsIDB4NzgwN0M5QTIsIDB4MEYwMEY5MzQsIDB4OTYwOUE4OEUsCiAgICAgICAweEUxMEU5ODE4LCAweDdGNkEwREJCLCAweDA4NkQzRDJELCAweDkxNjQ2Qzk3LCAweEU2NjM1QzAxLAogICAgICAgMHg2QjZCNTFGNCwgMHgxQzZDNjE2MiwgMHg4NTY1MzBEOCwgMHhGMjYyMDA0RSwgMHg2QzA2OTVFRCwKICAgICAgIDB4MUIwMUE1N0IsIDB4ODIwOEY0QzEsIDB4RjUwRkM0NTcsIDB4NjVCMEQ5QzYsIDB4MTJCN0U5NTAsCiAgICAgICAweDhCQkVCOEVBLCAweEZDQjk4ODdDLCAweDYyREQxRERGLCAweDE1REEyRDQ5LCAweDhDRDM3Q0YzLAogICAgICAgMHhGQkQ0NEM2NSwgMHg0REIyNjE1OCwgMHgzQUI1NTFDRSwgMHhBM0JDMDA3NCwgMHhENEJCMzBFMiwKICAgICAgIDB4NEFERkE1NDEsIDB4M0REODk1RDcsIDB4QTREMUM0NkQsIDB4RDNENkY0RkIsIDB4NDM2OUU5NkEsCiAgICAgICAweDM0NkVEOUZDLCAweEFENjc4ODQ2LCAweERBNjBCOEQwLCAweDQ0MDQyRDczLCAweDMzMDMxREU1LAogICAgICAgMHhBQTBBNEM1RiwgMHhERDBEN0NDOSwgMHg1MDA1NzEzQywgMHgyNzAyNDFBQSwgMHhCRTBCMTAxMCwKICAgICAgIDB4QzkwQzIwODYsIDB4NTc2OEI1MjUsIDB4MjA2Rjg1QjMsIDB4Qjk2NkQ0MDksIDB4Q0U2MUU0OUYsCiAgICAgICAweDVFREVGOTBFLCAweDI5RDlDOTk4LCAweEIwRDA5ODIyLCAweEM3RDdBOEI0LCAweDU5QjMzRDE3LAogICAgICAgMHgyRUI0MEQ4MSwgMHhCN0JENUMzQiwgMHhDMEJBNkNBRCwgMHhFREI4ODMyMCwgMHg5QUJGQjNCNiwKICAgICAgIDB4MDNCNkUyMEMsIDB4NzRCMUQyOUEsIDB4RUFENTQ3MzksIDB4OUREMjc3QUYsIDB4MDREQjI2MTUsCiAgICAgICAweDczREMxNjgzLCAweEUzNjMwQjEyLCAweDk0NjQzQjg0LCAweDBENkQ2QTNFLCAweDdBNkE1QUE4LAogICAgICAgMHhFNDBFQ0YwQiwgMHg5MzA5RkY5RCwgMHgwQTAwQUUyNywgMHg3RDA3OUVCMSwgMHhGMDBGOTM0NCwKICAgICAgIDB4ODcwOEEzRDIsIDB4MUUwMUYyNjgsIDB4NjkwNkMyRkUsIDB4Rjc2MjU3NUQsIDB4ODA2NTY3Q0IsCiAgICAgICAweDE5NkMzNjcxLCAweDZFNkIwNkU3LCAweEZFRDQxQjc2LCAweDg5RDMyQkUwLCAweDEwREE3QTVBLAogICAgICAgMHg2N0RENEFDQywgMHhGOUI5REY2RiwgMHg4RUJFRUZGOSwgMHgxN0I3QkU0MywgMHg2MEIwOEVENSwKICAgICAgIDB4RDZENkEzRTgsIDB4QTFEMTkzN0UsIDB4MzhEOEMyQzQsIDB4NEZERkYyNTIsIDB4RDFCQjY3RjEsCiAgICAgICAweEE2QkM1NzY3LCAweDNGQjUwNkRELCAweDQ4QjIzNjRCLCAweEQ4MEQyQkRBLCAweEFGMEExQjRDLAogICAgICAgMHgzNjAzNEFGNiwgMHg0MTA0N0E2MCwgMHhERjYwRUZDMywgMHhBODY3REY1NSwgMHgzMTZFOEVFRiwKICAgICAgIDB4NDY2OUJFNzksIDB4Q0I2MUIzOEMsIDB4QkM2NjgzMUEsIDB4MjU2RkQyQTAsIDB4NTI2OEUyMzYsCiAgICAgICAweENDMEM3Nzk1LCAweEJCMEI0NzAzLCAweDIyMDIxNkI5LCAweDU1MDUyNjJGLCAweEM1QkEzQkJFLAogICAgICAgMHhCMkJEMEIyOCwgMHgyQkI0NUE5MiwgMHg1Q0IzNkEwNCwgMHhDMkQ3RkZBNywgMHhCNUQwQ0YzMSwKICAgICAgIDB4MkNEOTlFOEIsIDB4NUJERUFFMUQsIDB4OUI2NEMyQjAsIDB4RUM2M0YyMjYsIDB4NzU2QUEzOUMsCiAgICAgICAweDAyNkQ5MzBBLCAweDlDMDkwNkE5LCAweEVCMEUzNjNGLCAweDcyMDc2Nzg1LCAweDA1MDA1NzEzLAogICAgICAgMHg5NUJGNEE4MiwgMHhFMkI4N0ExNCwgMHg3QkIxMkJBRSwgMHgwQ0I2MUIzOCwgMHg5MkQyOEU5QiwKICAgICAgIDB4RTVENUJFMEQsIDB4N0NEQ0VGQjcsIDB4MEJEQkRGMjEsIDB4ODZEM0QyRDQsIDB4RjFENEUyNDIsCiAgICAgICAweDY4RERCM0Y4LCAweDFGREE4MzZFLCAweDgxQkUxNkNELCAweEY2QjkyNjVCLCAweDZGQjA3N0UxLAogICAgICAgMHgxOEI3NDc3NywgMHg4ODA4NUFFNiwgMHhGRjBGNkE3MCwgMHg2NjA2M0JDQSwgMHgxMTAxMEI1QywKICAgICAgIDB4OEY2NTlFRkYsIDB4Rjg2MkFFNjksIDB4NjE2QkZGRDMsIDB4MTY2Q0NGNDUsIDB4QTAwQUUyNzgsCiAgICAgICAweEQ3MEREMkVFLCAweDRFMDQ4MzU0LCAweDM5MDNCM0MyLCAweEE3NjcyNjYxLCAweEQwNjAxNkY3LAogICAgICAgMHg0OTY5NDc0RCwgMHgzRTZFNzdEQiwgMHhBRUQxNkE0QSwgMHhEOUQ2NUFEQywgMHg0MERGMEI2NiwKICAgICAgIDB4MzdEODNCRjAsIDB4QTlCQ0FFNTMsIDB4REVCQjlFQzUsIDB4NDdCMkNGN0YsIDB4MzBCNUZGRTksCiAgICAgICAweEJEQkRGMjFDLCAweENBQkFDMjhBLCAweDUzQjM5MzMwLCAweDI0QjRBM0E2LCAweEJBRDAzNjA1LAogICAgICAgMHhDREQ3MDY5MywgMHg1NERFNTcyOSwgMHgyM0Q5NjdCRiwgMHhCMzY2N0EyRSwgMHhDNDYxNEFCOCwKICAgICAgIDB4NUQ2ODFCMDIsIDB4MkE2RjJCOTQsIDB4QjQwQkJFMzcsIDB4QzMwQzhFQTEsIDB4NUEwNURGMUIsCiAgICAgICAweDJEMDJFRjhEXSwKICAKICAgICAgY3JjMzI6IGZ1bmN0aW9uIGNyYzMyKGRhdGEpIHsKICAgICAgICB2YXIgdGJsID0gdXRpbC5jcnlwdG8uY3JjMzJUYWJsZTsKICAgICAgICB2YXIgY3JjID0gMCBeIC0xOwogIAogICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGRhdGEgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcihkYXRhKTsKICAgICAgICB9CiAgCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgY29kZSA9IGRhdGEucmVhZFVJbnQ4KGkpOwogICAgICAgICAgY3JjID0gKGNyYyA+Pj4gOCkgXiB0YmxbKGNyYyBeIGNvZGUpICYgMHhGRl07CiAgICAgICAgfQogICAgICAgIHJldHVybiAoY3JjIF4gLTEpID4+PiAwOwogICAgICB9LAogIAogICAgICBobWFjOiBmdW5jdGlvbiBobWFjKGtleSwgc3RyaW5nLCBkaWdlc3QsIGZuKSB7CiAgICAgICAgaWYgKCFkaWdlc3QpIGRpZ2VzdCA9ICdiaW5hcnknOwogICAgICAgIGlmIChkaWdlc3QgPT09ICdidWZmZXInKSB7IGRpZ2VzdCA9IHVuZGVmaW5lZDsgfQogICAgICAgIGlmICghZm4pIGZuID0gJ3NoYTI1Nic7CiAgICAgICAgaWYgKHR5cGVvZiBzdHJpbmcgPT09ICdzdHJpbmcnKSBzdHJpbmcgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcihzdHJpbmcpOwogICAgICAgIHJldHVybiB1dGlsLmNyeXB0by5saWIuY3JlYXRlSG1hYyhmbiwga2V5KS51cGRhdGUoc3RyaW5nKS5kaWdlc3QoZGlnZXN0KTsKICAgICAgfSwKICAKICAgICAgbWQ1OiBmdW5jdGlvbiBtZDUoZGF0YSwgZGlnZXN0LCBjYWxsYmFjaykgewogICAgICAgIHJldHVybiB1dGlsLmNyeXB0by5oYXNoKCdtZDUnLCBkYXRhLCBkaWdlc3QsIGNhbGxiYWNrKTsKICAgICAgfSwKICAKICAgICAgc2hhMjU2OiBmdW5jdGlvbiBzaGEyNTYoZGF0YSwgZGlnZXN0LCBjYWxsYmFjaykgewogICAgICAgIHJldHVybiB1dGlsLmNyeXB0by5oYXNoKCdzaGEyNTYnLCBkYXRhLCBkaWdlc3QsIGNhbGxiYWNrKTsKICAgICAgfSwKICAKICAgICAgaGFzaDogZnVuY3Rpb24oYWxnb3JpdGhtLCBkYXRhLCBkaWdlc3QsIGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIGhhc2ggPSB1dGlsLmNyeXB0by5jcmVhdGVIYXNoKGFsZ29yaXRobSk7CiAgICAgICAgaWYgKCFkaWdlc3QpIHsgZGlnZXN0ID0gJ2JpbmFyeSc7IH0KICAgICAgICBpZiAoZGlnZXN0ID09PSAnYnVmZmVyJykgeyBkaWdlc3QgPSB1bmRlZmluZWQ7IH0KICAgICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSBkYXRhID0gdXRpbC5idWZmZXIudG9CdWZmZXIoZGF0YSk7CiAgICAgICAgdmFyIHNsaWNlRm4gPSB1dGlsLmFycmF5U2xpY2VGbihkYXRhKTsKICAgICAgICB2YXIgaXNCdWZmZXIgPSB1dGlsLkJ1ZmZlci5pc0J1ZmZlcihkYXRhKTsKICAgICAgICAvL0lkZW50aWZ5aW5nIG9iamVjdHMgd2l0aCBhbiBBcnJheUJ1ZmZlciBhcyBidWZmZXJzCiAgICAgICAgaWYgKHV0aWwuaXNCcm93c2VyKCkgJiYgdHlwZW9mIEFycmF5QnVmZmVyICE9PSAndW5kZWZpbmVkJyAmJiBkYXRhICYmIGRhdGEuYnVmZmVyIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIGlzQnVmZmVyID0gdHJ1ZTsKICAKICAgICAgICBpZiAoY2FsbGJhY2sgJiYgdHlwZW9mIGRhdGEgPT09ICdvYmplY3QnICYmCiAgICAgICAgICAgIHR5cGVvZiBkYXRhLm9uID09PSAnZnVuY3Rpb24nICYmICFpc0J1ZmZlcikgewogICAgICAgICAgZGF0YS5vbignZGF0YScsIGZ1bmN0aW9uKGNodW5rKSB7IGhhc2gudXBkYXRlKGNodW5rKTsgfSk7CiAgICAgICAgICBkYXRhLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycikgeyBjYWxsYmFjayhlcnIpOyB9KTsKICAgICAgICAgIGRhdGEub24oJ2VuZCcsIGZ1bmN0aW9uKCkgeyBjYWxsYmFjayhudWxsLCBoYXNoLmRpZ2VzdChkaWdlc3QpKTsgfSk7CiAgICAgICAgfSBlbHNlIGlmIChjYWxsYmFjayAmJiBzbGljZUZuICYmICFpc0J1ZmZlciAmJgogICAgICAgICAgICAgICAgICAgdHlwZW9mIEZpbGVSZWFkZXIgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAvLyB0aGlzIG1pZ2h0IGJlIGEgRmlsZS9CbG9iCiAgICAgICAgICB2YXIgaW5kZXggPSAwLCBzaXplID0gMTAyNCAqIDUxMjsKICAgICAgICAgIHZhciByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpOwogICAgICAgICAgcmVhZGVyLm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgY2FsbGJhY2sobmV3IEVycm9yKCdGYWlsZWQgdG8gcmVhZCBkYXRhLicpKTsKICAgICAgICAgIH07CiAgICAgICAgICByZWFkZXIub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBidWYgPSBuZXcgdXRpbC5CdWZmZXIobmV3IFVpbnQ4QXJyYXkocmVhZGVyLnJlc3VsdCkpOwogICAgICAgICAgICBoYXNoLnVwZGF0ZShidWYpOwogICAgICAgICAgICBpbmRleCArPSBidWYubGVuZ3RoOwogICAgICAgICAgICByZWFkZXIuX2NvbnRpbnVlUmVhZGluZygpOwogICAgICAgICAgfTsKICAgICAgICAgIHJlYWRlci5fY29udGludWVSZWFkaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmIChpbmRleCA+PSBkYXRhLnNpemUpIHsKICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCBoYXNoLmRpZ2VzdChkaWdlc3QpKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAKICAgICAgICAgICAgdmFyIGJhY2sgPSBpbmRleCArIHNpemU7CiAgICAgICAgICAgIGlmIChiYWNrID4gZGF0YS5zaXplKSBiYWNrID0gZGF0YS5zaXplOwogICAgICAgICAgICByZWFkZXIucmVhZEFzQXJyYXlCdWZmZXIoc2xpY2VGbi5jYWxsKGRhdGEsIGluZGV4LCBiYWNrKSk7CiAgICAgICAgICB9OwogIAogICAgICAgICAgcmVhZGVyLl9jb250aW51ZVJlYWRpbmcoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHV0aWwuaXNCcm93c2VyKCkgJiYgdHlwZW9mIGRhdGEgPT09ICdvYmplY3QnICYmICFpc0J1ZmZlcikgewogICAgICAgICAgICBkYXRhID0gbmV3IHV0aWwuQnVmZmVyKG5ldyBVaW50OEFycmF5KGRhdGEpKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBvdXQgPSBoYXNoLnVwZGF0ZShkYXRhKS5kaWdlc3QoZGlnZXN0KTsKICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2sobnVsbCwgb3V0KTsKICAgICAgICAgIHJldHVybiBvdXQ7CiAgICAgICAgfQogICAgICB9LAogIAogICAgICB0b0hleDogZnVuY3Rpb24gdG9IZXgoZGF0YSkgewogICAgICAgIHZhciBvdXQgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIG91dC5wdXNoKCgnMCcgKyBkYXRhLmNoYXJDb2RlQXQoaSkudG9TdHJpbmcoMTYpKS5zdWJzdHIoLTIsIDIpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG91dC5qb2luKCcnKTsKICAgICAgfSwKICAKICAgICAgY3JlYXRlSGFzaDogZnVuY3Rpb24gY3JlYXRlSGFzaChhbGdvcml0aG0pIHsKICAgICAgICByZXR1cm4gdXRpbC5jcnlwdG8ubGliLmNyZWF0ZUhhc2goYWxnb3JpdGhtKTsKICAgICAgfQogIAogICAgfSwKICAKICAgIC8qKiBAIWlnbm9yZSAqLwogIAogICAgLyogQWJvcnQgY29uc3RhbnQgKi8KICAgIGFib3J0OiB7fSwKICAKICAgIGVhY2g6IGZ1bmN0aW9uIGVhY2gob2JqZWN0LCBpdGVyRnVuY3Rpb24pIHsKICAgICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgewogICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSB7CiAgICAgICAgICB2YXIgcmV0ID0gaXRlckZ1bmN0aW9uLmNhbGwodGhpcywga2V5LCBvYmplY3Rba2V5XSk7CiAgICAgICAgICBpZiAocmV0ID09PSB1dGlsLmFib3J0KSBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICBhcnJheUVhY2g6IGZ1bmN0aW9uIGFycmF5RWFjaChhcnJheSwgaXRlckZ1bmN0aW9uKSB7CiAgICAgIGZvciAodmFyIGlkeCBpbiBhcnJheSkgewogICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYXJyYXksIGlkeCkpIHsKICAgICAgICAgIHZhciByZXQgPSBpdGVyRnVuY3Rpb24uY2FsbCh0aGlzLCBhcnJheVtpZHhdLCBwYXJzZUludChpZHgsIDEwKSk7CiAgICAgICAgICBpZiAocmV0ID09PSB1dGlsLmFib3J0KSBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShvYmoxLCBvYmoyKSB7CiAgICAgIHV0aWwuZWFjaChvYmoyLCBmdW5jdGlvbiBpdGVyYXRvcihrZXksIGl0ZW0pIHsKICAgICAgICBvYmoxW2tleV0gPSBpdGVtOwogICAgICB9KTsKICAgICAgcmV0dXJuIG9iajE7CiAgICB9LAogIAogICAgbWVyZ2U6IGZ1bmN0aW9uIG1lcmdlKG9iajEsIG9iajIpIHsKICAgICAgcmV0dXJuIHV0aWwudXBkYXRlKHV0aWwuY29weShvYmoxKSwgb2JqMik7CiAgICB9LAogIAogICAgY29weTogZnVuY3Rpb24gY29weShvYmplY3QpIHsKICAgICAgaWYgKG9iamVjdCA9PT0gbnVsbCB8fCBvYmplY3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG9iamVjdDsKICAgICAgdmFyIGR1cGUgPSB7fTsKICAgICAgLy8ganNoaW50IGZvcmluOmZhbHNlCiAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgICBkdXBlW2tleV0gPSBvYmplY3Rba2V5XTsKICAgICAgfQogICAgICByZXR1cm4gZHVwZTsKICAgIH0sCiAgCiAgICBpc0VtcHR5OiBmdW5jdGlvbiBpc0VtcHR5KG9iaikgewogICAgICBmb3IgKHZhciBwcm9wIGluIG9iaikgewogICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBwcm9wKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCiAgCiAgICBhcnJheVNsaWNlRm46IGZ1bmN0aW9uIGFycmF5U2xpY2VGbihvYmopIHsKICAgICAgdmFyIGZuID0gb2JqLnNsaWNlIHx8IG9iai53ZWJraXRTbGljZSB8fCBvYmoubW96U2xpY2U7CiAgICAgIHJldHVybiB0eXBlb2YgZm4gPT09ICdmdW5jdGlvbicgPyBmbiA6IG51bGw7CiAgICB9LAogIAogICAgaXNUeXBlOiBmdW5jdGlvbiBpc1R5cGUob2JqLCB0eXBlKSB7CiAgICAgIC8vIGhhbmRsZSBjcm9zcy0iZnJhbWUiIG9iamVjdHMKICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAnZnVuY3Rpb24nKSB0eXBlID0gdXRpbC50eXBlTmFtZSh0eXBlKTsKICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCAnICsgdHlwZSArICddJzsKICAgIH0sCiAgCiAgICB0eXBlTmFtZTogZnVuY3Rpb24gdHlwZU5hbWUodHlwZSkgewogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHR5cGUsICduYW1lJykpIHJldHVybiB0eXBlLm5hbWU7CiAgICAgIHZhciBzdHIgPSB0eXBlLnRvU3RyaW5nKCk7CiAgICAgIHZhciBtYXRjaCA9IHN0ci5tYXRjaCgvXlxzKmZ1bmN0aW9uICguKylcKC8pOwogICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6IHN0cjsKICAgIH0sCiAgCiAgICBlcnJvcjogZnVuY3Rpb24gZXJyb3IoZXJyLCBvcHRpb25zKSB7CiAgICAgIHZhciBvcmlnaW5hbEVycm9yID0gbnVsbDsKICAgICAgaWYgKHR5cGVvZiBlcnIubWVzc2FnZSA9PT0gJ3N0cmluZycgJiYgZXJyLm1lc3NhZ2UgIT09ICcnKSB7CiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJyB8fCAob3B0aW9ucyAmJiBvcHRpb25zLm1lc3NhZ2UpKSB7CiAgICAgICAgICBvcmlnaW5hbEVycm9yID0gdXRpbC5jb3B5KGVycik7CiAgICAgICAgICBvcmlnaW5hbEVycm9yLm1lc3NhZ2UgPSBlcnIubWVzc2FnZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZXJyLm1lc3NhZ2UgPSBlcnIubWVzc2FnZSB8fCBudWxsOwogIAogICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgZXJyLm1lc3NhZ2UgPSBvcHRpb25zOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnb2JqZWN0JyAmJiBvcHRpb25zICE9PSBudWxsKSB7CiAgICAgICAgdXRpbC51cGRhdGUoZXJyLCBvcHRpb25zKTsKICAgICAgICBpZiAob3B0aW9ucy5tZXNzYWdlKQogICAgICAgICAgZXJyLm1lc3NhZ2UgPSBvcHRpb25zLm1lc3NhZ2U7CiAgICAgICAgaWYgKG9wdGlvbnMuY29kZSB8fCBvcHRpb25zLm5hbWUpCiAgICAgICAgICBlcnIuY29kZSA9IG9wdGlvbnMuY29kZSB8fCBvcHRpb25zLm5hbWU7CiAgICAgICAgaWYgKG9wdGlvbnMuc3RhY2spCiAgICAgICAgICBlcnIuc3RhY2sgPSBvcHRpb25zLnN0YWNrOwogICAgICB9CiAgCiAgICAgIGlmICh0eXBlb2YgT2JqZWN0LmRlZmluZVByb3BlcnR5ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVyciwgJ25hbWUnLCB7d3JpdGFibGU6IHRydWUsIGVudW1lcmFibGU6IGZhbHNlfSk7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVyciwgJ21lc3NhZ2UnLCB7ZW51bWVyYWJsZTogdHJ1ZX0pOwogICAgICB9CiAgCiAgICAgIGVyci5uYW1lID0gb3B0aW9ucyAmJiBvcHRpb25zLm5hbWUgfHwgZXJyLm5hbWUgfHwgZXJyLmNvZGUgfHwgJ0Vycm9yJzsKICAgICAgZXJyLnRpbWUgPSBuZXcgRGF0ZSgpOwogIAogICAgICBpZiAob3JpZ2luYWxFcnJvcikgZXJyLm9yaWdpbmFsRXJyb3IgPSBvcmlnaW5hbEVycm9yOwogIAogICAgICByZXR1cm4gZXJyOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGluaGVyaXQ6IGZ1bmN0aW9uIGluaGVyaXQoa2xhc3MsIGZlYXR1cmVzKSB7CiAgICAgIHZhciBuZXdPYmplY3QgPSBudWxsOwogICAgICBpZiAoZmVhdHVyZXMgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGZlYXR1cmVzID0ga2xhc3M7CiAgICAgICAga2xhc3MgPSBPYmplY3Q7CiAgICAgICAgbmV3T2JqZWN0ID0ge307CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGN0b3IgPSBmdW5jdGlvbiBDb25zdHJ1Y3RvcldyYXBwZXIoKSB7fTsKICAgICAgICBjdG9yLnByb3RvdHlwZSA9IGtsYXNzLnByb3RvdHlwZTsKICAgICAgICBuZXdPYmplY3QgPSBuZXcgY3RvcigpOwogICAgICB9CiAgCiAgICAgIC8vIGNvbnN0cnVjdG9yIG5vdCBzdXBwbGllZCwgY3JlYXRlIHBhc3MtdGhyb3VnaCBjdG9yCiAgICAgIGlmIChmZWF0dXJlcy5jb25zdHJ1Y3RvciA9PT0gT2JqZWN0KSB7CiAgICAgICAgZmVhdHVyZXMuY29uc3RydWN0b3IgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChrbGFzcyAhPT0gT2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiBrbGFzcy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAKICAgICAgZmVhdHVyZXMuY29uc3RydWN0b3IucHJvdG90eXBlID0gbmV3T2JqZWN0OwogICAgICB1dGlsLnVwZGF0ZShmZWF0dXJlcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUsIGZlYXR1cmVzKTsKICAgICAgZmVhdHVyZXMuY29uc3RydWN0b3IuX19zdXBlcl9fID0ga2xhc3M7CiAgICAgIHJldHVybiBmZWF0dXJlcy5jb25zdHJ1Y3RvcjsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBtaXhpbjogZnVuY3Rpb24gbWl4aW4oKSB7CiAgICAgIHZhciBrbGFzcyA9IGFyZ3VtZW50c1swXTsKICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAvLyBqc2hpbnQgZm9yaW46ZmFsc2UKICAgICAgICBmb3IgKHZhciBwcm9wIGluIGFyZ3VtZW50c1tpXS5wcm90b3R5cGUpIHsKICAgICAgICAgIHZhciBmbiA9IGFyZ3VtZW50c1tpXS5wcm90b3R5cGVbcHJvcF07CiAgICAgICAgICBpZiAocHJvcCAhPT0gJ2NvbnN0cnVjdG9yJykgewogICAgICAgICAgICBrbGFzcy5wcm90b3R5cGVbcHJvcF0gPSBmbjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGtsYXNzOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGhpZGVQcm9wZXJ0aWVzOiBmdW5jdGlvbiBoaWRlUHJvcGVydGllcyhvYmosIHByb3BzKSB7CiAgICAgIGlmICh0eXBlb2YgT2JqZWN0LmRlZmluZVByb3BlcnR5ICE9PSAnZnVuY3Rpb24nKSByZXR1cm47CiAgCiAgICAgIHV0aWwuYXJyYXlFYWNoKHByb3BzLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7CiAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9KTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgcHJvcGVydHk6IGZ1bmN0aW9uIHByb3BlcnR5KG9iaiwgbmFtZSwgdmFsdWUsIGVudW1lcmFibGUsIGlzVmFsdWUpIHsKICAgICAgdmFyIG9wdHMgPSB7CiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgIGVudW1lcmFibGU6IGVudW1lcmFibGUgIT09IHVuZGVmaW5lZCA/IGVudW1lcmFibGUgOiB0cnVlCiAgICAgIH07CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicgJiYgIWlzVmFsdWUpIHsKICAgICAgICBvcHRzLmdldCA9IHZhbHVlOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIG9wdHMudmFsdWUgPSB2YWx1ZTsgb3B0cy53cml0YWJsZSA9IHRydWU7CiAgICAgIH0KICAKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwgbmFtZSwgb3B0cyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbWVtb2l6ZWRQcm9wZXJ0eTogZnVuY3Rpb24gbWVtb2l6ZWRQcm9wZXJ0eShvYmosIG5hbWUsIGdldCwgZW51bWVyYWJsZSkgewogICAgICB2YXIgY2FjaGVkVmFsdWUgPSBudWxsOwogIAogICAgICAvLyBidWlsZCBlbnVtZXJhYmxlIGF0dHJpYnV0ZSBmb3IgZWFjaCB2YWx1ZSB3aXRoIGxhenkgYWNjZXNzb3IuCiAgICAgIHV0aWwucHJvcGVydHkob2JqLCBuYW1lLCBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoY2FjaGVkVmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgIGNhY2hlZFZhbHVlID0gZ2V0KCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjYWNoZWRWYWx1ZTsKICAgICAgfSwgZW51bWVyYWJsZSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBUT0RPIFJlbW92ZSBpbiBtYWpvciB2ZXJzaW9uIHJldmlzaW9uCiAgICAgKiBUaGlzIGJhY2tmaWxsIHBvcHVsYXRlcyByZXNwb25zZSBkYXRhIHdpdGhvdXQgdGhlCiAgICAgKiB0b3AtbGV2ZWwgcGF5bG9hZCBuYW1lLgogICAgICoKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBob2lzdFBheWxvYWRNZW1iZXI6IGZ1bmN0aW9uIGhvaXN0UGF5bG9hZE1lbWJlcihyZXNwKSB7CiAgICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICAgIHZhciBvcGVyYXRpb25OYW1lID0gcmVxLm9wZXJhdGlvbjsKICAgICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW29wZXJhdGlvbk5hbWVdOwogICAgICB2YXIgb3V0cHV0ID0gb3BlcmF0aW9uLm91dHB1dDsKICAgICAgaWYgKG91dHB1dC5wYXlsb2FkICYmICFvcGVyYXRpb24uaGFzRXZlbnRPdXRwdXQpIHsKICAgICAgICB2YXIgcGF5bG9hZE1lbWJlciA9IG91dHB1dC5tZW1iZXJzW291dHB1dC5wYXlsb2FkXTsKICAgICAgICB2YXIgcmVzcG9uc2VQYXlsb2FkID0gcmVzcC5kYXRhW291dHB1dC5wYXlsb2FkXTsKICAgICAgICBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnc3RydWN0dXJlJykgewogICAgICAgICAgdXRpbC5lYWNoKHJlc3BvbnNlUGF5bG9hZCwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICB1dGlsLnByb3BlcnR5KHJlc3AuZGF0YSwga2V5LCB2YWx1ZSwgZmFsc2UpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBDb21wdXRlIFNIQS0yNTYgY2hlY2tzdW1zIG9mIHN0cmVhbXMKICAgICAqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY29tcHV0ZVNoYTI1NjogZnVuY3Rpb24gY29tcHV0ZVNoYTI1Nihib2R5LCBkb25lKSB7CiAgICAgIGlmICh1dGlsLmlzTm9kZSgpKSB7CiAgICAgICAgdmFyIFN0cmVhbSA9IHV0aWwuc3RyZWFtLlN0cmVhbTsKICAgICAgICB2YXIgZnMgPSByZXF1aXJlKCdmcycpOwogICAgICAgIGlmICh0eXBlb2YgU3RyZWFtID09PSAnZnVuY3Rpb24nICYmIGJvZHkgaW5zdGFuY2VvZiBTdHJlYW0pIHsKICAgICAgICAgIGlmICh0eXBlb2YgYm9keS5wYXRoID09PSAnc3RyaW5nJykgeyAvLyBhc3N1bWUgZmlsZSBvYmplY3QKICAgICAgICAgICAgdmFyIHNldHRpbmdzID0ge307CiAgICAgICAgICAgIGlmICh0eXBlb2YgYm9keS5zdGFydCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICBzZXR0aW5ncy5zdGFydCA9IGJvZHkuc3RhcnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBib2R5LmVuZCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICBzZXR0aW5ncy5lbmQgPSBib2R5LmVuZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBib2R5ID0gZnMuY3JlYXRlUmVhZFN0cmVhbShib2R5LnBhdGgsIHNldHRpbmdzKTsKICAgICAgICAgIH0gZWxzZSB7IC8vIFRPRE8gc3VwcG9ydCBvdGhlciBzdHJlYW0gdHlwZXMKICAgICAgICAgICAgcmV0dXJuIGRvbmUobmV3IEVycm9yKCdOb24tZmlsZSBzdHJlYW0gb2JqZWN0cyBhcmUgJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbm90IHN1cHBvcnRlZCB3aXRoIFNpZ1Y0JykpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogIAogICAgICB1dGlsLmNyeXB0by5zaGEyNTYoYm9keSwgJ2hleCcsIGZ1bmN0aW9uKGVyciwgc2hhKSB7CiAgICAgICAgaWYgKGVycikgZG9uZShlcnIpOwogICAgICAgIGVsc2UgZG9uZShudWxsLCBzaGEpOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBpc0Nsb2NrU2tld2VkOiBmdW5jdGlvbiBpc0Nsb2NrU2tld2VkKHNlcnZlclRpbWUpIHsKICAgICAgaWYgKHNlcnZlclRpbWUpIHsKICAgICAgICB1dGlsLnByb3BlcnR5KEFXUy5jb25maWcsICdpc0Nsb2NrU2tld2VkJywKICAgICAgICAgIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gc2VydmVyVGltZSkgPj0gMzAwMDAwLCBmYWxzZSk7CiAgICAgICAgcmV0dXJuIEFXUy5jb25maWcuaXNDbG9ja1NrZXdlZDsKICAgICAgfQogICAgfSwKICAKICAgIGFwcGx5Q2xvY2tPZmZzZXQ6IGZ1bmN0aW9uIGFwcGx5Q2xvY2tPZmZzZXQoc2VydmVyVGltZSkgewogICAgICBpZiAoc2VydmVyVGltZSkKICAgICAgICBBV1MuY29uZmlnLnN5c3RlbUNsb2NrT2Zmc2V0ID0gc2VydmVyVGltZSAtIG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGV4dHJhY3RSZXF1ZXN0SWQ6IGZ1bmN0aW9uIGV4dHJhY3RSZXF1ZXN0SWQocmVzcCkgewogICAgICB2YXIgcmVxdWVzdElkID0gcmVzcC5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXotcmVxdWVzdC1pZCddIHx8CiAgICAgICAgICAgICAgICAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXpuLXJlcXVlc3RpZCddOwogIAogICAgICBpZiAoIXJlcXVlc3RJZCAmJiByZXNwLmRhdGEgJiYgcmVzcC5kYXRhLlJlc3BvbnNlTWV0YWRhdGEpIHsKICAgICAgICByZXF1ZXN0SWQgPSByZXNwLmRhdGEuUmVzcG9uc2VNZXRhZGF0YS5SZXF1ZXN0SWQ7CiAgICAgIH0KICAKICAgICAgaWYgKHJlcXVlc3RJZCkgewogICAgICAgIHJlc3AucmVxdWVzdElkID0gcmVxdWVzdElkOwogICAgICB9CiAgCiAgICAgIGlmIChyZXNwLmVycm9yKSB7CiAgICAgICAgcmVzcC5lcnJvci5yZXF1ZXN0SWQgPSByZXF1ZXN0SWQ7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhZGRQcm9taXNlczogZnVuY3Rpb24gYWRkUHJvbWlzZXMoY29uc3RydWN0b3JzLCBQcm9taXNlRGVwZW5kZW5jeSkgewogICAgICB2YXIgZGVsZXRlUHJvbWlzZXMgPSBmYWxzZTsKICAgICAgaWYgKFByb21pc2VEZXBlbmRlbmN5ID09PSB1bmRlZmluZWQgJiYgQVdTICYmIEFXUy5jb25maWcpIHsKICAgICAgICBQcm9taXNlRGVwZW5kZW5jeSA9IEFXUy5jb25maWcuZ2V0UHJvbWlzZXNEZXBlbmRlbmN5KCk7CiAgICAgIH0KICAgICAgaWYgKFByb21pc2VEZXBlbmRlbmN5ID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIFByb21pc2UgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgUHJvbWlzZURlcGVuZGVuY3kgPSBQcm9taXNlOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgUHJvbWlzZURlcGVuZGVuY3kgIT09ICdmdW5jdGlvbicpIGRlbGV0ZVByb21pc2VzID0gdHJ1ZTsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGNvbnN0cnVjdG9ycykpIGNvbnN0cnVjdG9ycyA9IFtjb25zdHJ1Y3RvcnNdOwogIAogICAgICBmb3IgKHZhciBpbmQgPSAwOyBpbmQgPCBjb25zdHJ1Y3RvcnMubGVuZ3RoOyBpbmQrKykgewogICAgICAgIHZhciBjb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yc1tpbmRdOwogICAgICAgIGlmIChkZWxldGVQcm9taXNlcykgewogICAgICAgICAgaWYgKGNvbnN0cnVjdG9yLmRlbGV0ZVByb21pc2VzRnJvbUNsYXNzKSB7CiAgICAgICAgICAgIGNvbnN0cnVjdG9yLmRlbGV0ZVByb21pc2VzRnJvbUNsYXNzKCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChjb25zdHJ1Y3Rvci5hZGRQcm9taXNlc1RvQ2xhc3MpIHsKICAgICAgICAgIGNvbnN0cnVjdG9yLmFkZFByb21pc2VzVG9DbGFzcyhQcm9taXNlRGVwZW5kZW5jeSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqIFJldHVybiBhIGZ1bmN0aW9uIHRoYXQgd2lsbCByZXR1cm4gYSBwcm9taXNlIHdob3NlIGZhdGUgaXMgZGVjaWRlZCBieSB0aGUKICAgICAqIGNhbGxiYWNrIGJlaGF2aW9yIG9mIHRoZSBnaXZlbiBtZXRob2Qgd2l0aCBgbWV0aG9kTmFtZWAuIFRoZSBtZXRob2QgdG8gYmUKICAgICAqIHByb21pc2lmaWVkIHNob3VsZCBjb25mb3JtIHRvIG5vZGUuanMgY29udmVudGlvbiBvZiBhY2NlcHRpbmcgYSBjYWxsYmFjayBhcwogICAgICogbGFzdCBhcmd1bWVudCBhbmQgY2FsbGluZyB0aGF0IGNhbGxiYWNrIHdpdGggZXJyb3IgYXMgdGhlIGZpcnN0IGFyZ3VtZW50CiAgICAgKiBhbmQgc3VjY2VzcyB2YWx1ZSBvbiB0aGUgc2Vjb25kIGFyZ3VtZW50LgogICAgICovCiAgICBwcm9taXNpZnlNZXRob2Q6IGZ1bmN0aW9uIHByb21pc2lmeU1ldGhvZChtZXRob2ROYW1lLCBQcm9taXNlRGVwZW5kZW5jeSkgewogICAgICByZXR1cm4gZnVuY3Rpb24gcHJvbWlzZSgpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZURlcGVuZGVuY3koZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICBhcmdzLnB1c2goZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIHNlbGZbbWV0aG9kTmFtZV0uYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaXNEdWFsc3RhY2tBdmFpbGFibGU6IGZ1bmN0aW9uIGlzRHVhbHN0YWNrQXZhaWxhYmxlKHNlcnZpY2UpIHsKICAgICAgaWYgKCFzZXJ2aWNlKSByZXR1cm4gZmFsc2U7CiAgICAgIHZhciBtZXRhZGF0YSA9IHJlcXVpcmUoJy4uL2FwaXMvbWV0YWRhdGEuanNvbicpOwogICAgICBpZiAodHlwZW9mIHNlcnZpY2UgIT09ICdzdHJpbmcnKSBzZXJ2aWNlID0gc2VydmljZS5zZXJ2aWNlSWRlbnRpZmllcjsKICAgICAgaWYgKHR5cGVvZiBzZXJ2aWNlICE9PSAnc3RyaW5nJyB8fCAhbWV0YWRhdGEuaGFzT3duUHJvcGVydHkoc2VydmljZSkpIHJldHVybiBmYWxzZTsKICAgICAgcmV0dXJuICEhbWV0YWRhdGFbc2VydmljZV0uZHVhbHN0YWNrQXZhaWxhYmxlOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNhbGN1bGF0ZVJldHJ5RGVsYXk6IGZ1bmN0aW9uIGNhbGN1bGF0ZVJldHJ5RGVsYXkocmV0cnlDb3VudCwgcmV0cnlEZWxheU9wdGlvbnMpIHsKICAgICAgaWYgKCFyZXRyeURlbGF5T3B0aW9ucykgcmV0cnlEZWxheU9wdGlvbnMgPSB7fTsKICAgICAgdmFyIGN1c3RvbUJhY2tvZmYgPSByZXRyeURlbGF5T3B0aW9ucy5jdXN0b21CYWNrb2ZmIHx8IG51bGw7CiAgICAgIGlmICh0eXBlb2YgY3VzdG9tQmFja29mZiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJldHVybiBjdXN0b21CYWNrb2ZmKHJldHJ5Q291bnQpOwogICAgICB9CiAgICAgIHZhciBiYXNlID0gdHlwZW9mIHJldHJ5RGVsYXlPcHRpb25zLmJhc2UgPT09ICdudW1iZXInID8gcmV0cnlEZWxheU9wdGlvbnMuYmFzZSA6IDEwMDsKICAgICAgdmFyIGRlbGF5ID0gTWF0aC5yYW5kb20oKSAqIChNYXRoLnBvdygyLCByZXRyeUNvdW50KSAqIGJhc2UpOwogICAgICByZXR1cm4gZGVsYXk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaGFuZGxlUmVxdWVzdFdpdGhSZXRyaWVzOiBmdW5jdGlvbiBoYW5kbGVSZXF1ZXN0V2l0aFJldHJpZXMoaHR0cFJlcXVlc3QsIG9wdGlvbnMsIGNiKSB7CiAgICAgIGlmICghb3B0aW9ucykgb3B0aW9ucyA9IHt9OwogICAgICB2YXIgaHR0cCA9IEFXUy5IdHRwQ2xpZW50LmdldEluc3RhbmNlKCk7CiAgICAgIHZhciBodHRwT3B0aW9ucyA9IG9wdGlvbnMuaHR0cE9wdGlvbnMgfHwge307CiAgICAgIHZhciByZXRyeUNvdW50ID0gMDsKICAKICAgICAgdmFyIGVyckNhbGxiYWNrID0gZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgdmFyIG1heFJldHJpZXMgPSBvcHRpb25zLm1heFJldHJpZXMgfHwgMDsKICAgICAgICBpZiAoZXJyICYmIGVyci5jb2RlID09PSAnVGltZW91dEVycm9yJykgZXJyLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgICAgaWYgKGVyciAmJiBlcnIucmV0cnlhYmxlICYmIHJldHJ5Q291bnQgPCBtYXhSZXRyaWVzKSB7CiAgICAgICAgICByZXRyeUNvdW50Kys7CiAgICAgICAgICB2YXIgZGVsYXkgPSB1dGlsLmNhbGN1bGF0ZVJldHJ5RGVsYXkocmV0cnlDb3VudCwgb3B0aW9ucy5yZXRyeURlbGF5T3B0aW9ucyk7CiAgICAgICAgICBzZXRUaW1lb3V0KHNlbmRSZXF1ZXN0LCBkZWxheSArIChlcnIucmV0cnlBZnRlciB8fCAwKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNiKGVycik7CiAgICAgICAgfQogICAgICB9OwogIAogICAgICB2YXIgc2VuZFJlcXVlc3QgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZGF0YSA9ICcnOwogICAgICAgIGh0dHAuaGFuZGxlUmVxdWVzdChodHRwUmVxdWVzdCwgaHR0cE9wdGlvbnMsIGZ1bmN0aW9uKGh0dHBSZXNwb25zZSkgewogICAgICAgICAgaHR0cFJlc3BvbnNlLm9uKCdkYXRhJywgZnVuY3Rpb24oY2h1bmspIHsgZGF0YSArPSBjaHVuay50b1N0cmluZygpOyB9KTsKICAgICAgICAgIGh0dHBSZXNwb25zZS5vbignZW5kJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzdGF0dXNDb2RlID0gaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgICAgICAgIGlmIChzdGF0dXNDb2RlIDwgMzAwKSB7CiAgICAgICAgICAgICAgY2IobnVsbCwgZGF0YSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHJldHJ5QWZ0ZXIgPSBwYXJzZUludChodHRwUmVzcG9uc2UuaGVhZGVyc1sncmV0cnktYWZ0ZXInXSwgMTApICogMTAwMCB8fCAwOwogICAgICAgICAgICAgIHZhciBlcnIgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAgICAgICAgeyByZXRyeWFibGU6IHN0YXR1c0NvZGUgPj0gNTAwIHx8IHN0YXR1c0NvZGUgPT09IDQyOSB9CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAocmV0cnlBZnRlciAmJiBlcnIucmV0cnlhYmxlKSBlcnIucmV0cnlBZnRlciA9IHJldHJ5QWZ0ZXI7CiAgICAgICAgICAgICAgZXJyQ2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSwgZXJyQ2FsbGJhY2spOwogICAgICB9OwogIAogICAgICBBV1MudXRpbC5kZWZlcihzZW5kUmVxdWVzdCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdXVpZDogewogICAgICB2NDogZnVuY3Rpb24gdXVpZFY0KCkgewogICAgICAgIHJldHVybiByZXF1aXJlKCd1dWlkJykudjQoKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNvbnZlcnRQYXlsb2FkVG9TdHJpbmc6IGZ1bmN0aW9uIGNvbnZlcnRQYXlsb2FkVG9TdHJpbmcocmVzcCkgewogICAgICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogICAgICB2YXIgb3BlcmF0aW9uID0gcmVxLm9wZXJhdGlvbjsKICAgICAgdmFyIHJ1bGVzID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbb3BlcmF0aW9uXS5vdXRwdXQgfHwge307CiAgICAgIGlmIChydWxlcy5wYXlsb2FkICYmIHJlc3AuZGF0YVtydWxlcy5wYXlsb2FkXSkgewogICAgICAgIHJlc3AuZGF0YVtydWxlcy5wYXlsb2FkXSA9IHJlc3AuZGF0YVtydWxlcy5wYXlsb2FkXS50b1N0cmluZygpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZGVmZXI6IGZ1bmN0aW9uIGRlZmVyKGNhbGxiYWNrKSB7CiAgICAgIGlmICh0eXBlb2YgcHJvY2VzcyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIHByb2Nlc3MubmV4dFRpY2sgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGNhbGxiYWNrKTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc2V0SW1tZWRpYXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgc2V0SW1tZWRpYXRlKGNhbGxiYWNrKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXRUaW1lb3V0KGNhbGxiYWNrLCAwKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldFJlcXVlc3RQYXlsb2FkU2hhcGU6IGZ1bmN0aW9uIGdldFJlcXVlc3RQYXlsb2FkU2hhcGUocmVxKSB7CiAgICAgIHZhciBvcGVyYXRpb25zID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnM7CiAgICAgIGlmICghb3BlcmF0aW9ucykgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgdmFyIG9wZXJhdGlvbiA9IChvcGVyYXRpb25zIHx8IHt9KVtyZXEub3BlcmF0aW9uXTsKICAgICAgaWYgKCFvcGVyYXRpb24gfHwgIW9wZXJhdGlvbi5pbnB1dCB8fCAhb3BlcmF0aW9uLmlucHV0LnBheWxvYWQpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIHJldHVybiBvcGVyYXRpb24uaW5wdXQubWVtYmVyc1tvcGVyYXRpb24uaW5wdXQucGF5bG9hZF07CiAgICB9LAogIAogICAgZ2V0UHJvZmlsZXNGcm9tU2hhcmVkQ29uZmlnOiBmdW5jdGlvbiBnZXRQcm9maWxlc0Zyb21TaGFyZWRDb25maWcoaW5pTG9hZGVyLCBmaWxlbmFtZSkgewogICAgICB2YXIgcHJvZmlsZXMgPSB7fTsKICAgICAgdmFyIHByb2ZpbGVzRnJvbUNvbmZpZyA9IHt9OwogICAgICBpZiAocHJvY2Vzcy5lbnZbdXRpbC5jb25maWdPcHRJbkVudl0pIHsKICAgICAgICB2YXIgcHJvZmlsZXNGcm9tQ29uZmlnID0gaW5pTG9hZGVyLmxvYWRGcm9tKHsKICAgICAgICAgIGlzQ29uZmlnOiB0cnVlLAogICAgICAgICAgZmlsZW5hbWU6IHByb2Nlc3MuZW52W3V0aWwuc2hhcmVkQ29uZmlnRmlsZUVudl0KICAgICAgICB9KTsKICAgICAgfQogICAgICB2YXIgcHJvZmlsZXNGcm9tQ3JlZHMgPSBpbmlMb2FkZXIubG9hZEZyb20oewogICAgICAgIGZpbGVuYW1lOiBmaWxlbmFtZSB8fAogICAgICAgICAgKHByb2Nlc3MuZW52W3V0aWwuY29uZmlnT3B0SW5FbnZdICYmIHByb2Nlc3MuZW52W3V0aWwuc2hhcmVkQ3JlZGVudGlhbHNGaWxlRW52XSkKICAgICAgfSk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBwcm9maWxlTmFtZXMgPSBPYmplY3Qua2V5cyhwcm9maWxlc0Zyb21Db25maWcpOyBpIDwgcHJvZmlsZU5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcHJvZmlsZXNbcHJvZmlsZU5hbWVzW2ldXSA9IHByb2ZpbGVzRnJvbUNvbmZpZ1twcm9maWxlTmFtZXNbaV1dOwogICAgICB9CiAgICAgIGZvciAodmFyIGkgPSAwLCBwcm9maWxlTmFtZXMgPSBPYmplY3Qua2V5cyhwcm9maWxlc0Zyb21DcmVkcyk7IGkgPCBwcm9maWxlTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBwcm9maWxlc1twcm9maWxlTmFtZXNbaV1dID0gcHJvZmlsZXNGcm9tQ3JlZHNbcHJvZmlsZU5hbWVzW2ldXTsKICAgICAgfQogICAgICByZXR1cm4gcHJvZmlsZXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZGVmYXVsdFByb2ZpbGU6ICdkZWZhdWx0JywKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNvbmZpZ09wdEluRW52OiAnQVdTX1NES19MT0FEX0NPTkZJRycsCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzaGFyZWRDcmVkZW50aWFsc0ZpbGVFbnY6ICdBV1NfU0hBUkVEX0NSRURFTlRJQUxTX0ZJTEUnLAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc2hhcmVkQ29uZmlnRmlsZUVudjogJ0FXU19DT05GSUdfRklMRScsCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBpbWRzRGlzYWJsZWRFbnY6ICdBV1NfRUMyX01FVEFEQVRBX0RJU0FCTEVEJwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB1dGlsOwogIAogIH0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpLHJlcXVpcmUoInRpbWVycyIpLnNldEltbWVkaWF0ZSkKICB9LHsiLi4vYXBpcy9tZXRhZGF0YS5qc29uIjo0LCIuL2NvcmUiOjE4LCJfcHJvY2VzcyI6ODUsImZzIjo3OSwidGltZXJzIjo5MywidXVpZCI6OTh9XSw3MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIFNoYXBlID0gcmVxdWlyZSgnLi4vbW9kZWwvc2hhcGUnKTsKICAKICBmdW5jdGlvbiBEb21YbWxQYXJzZXIoKSB7IH0KICAKICBEb21YbWxQYXJzZXIucHJvdG90eXBlLnBhcnNlID0gZnVuY3Rpb24oeG1sLCBzaGFwZSkgewogICAgaWYgKHhtbC5yZXBsYWNlKC9eXHMrLywgJycpID09PSAnJykgcmV0dXJuIHt9OwogIAogICAgdmFyIHJlc3VsdCwgZXJyb3I7CiAgICB0cnkgewogICAgICBpZiAod2luZG93LkRPTVBhcnNlcikgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgcGFyc2VyID0gbmV3IERPTVBhcnNlcigpOwogICAgICAgICAgcmVzdWx0ID0gcGFyc2VyLnBhcnNlRnJvbVN0cmluZyh4bWwsICd0ZXh0L3htbCcpOwogICAgICAgIH0gY2F0Y2ggKHN5bnRheEVycm9yKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignUGFyc2UgZXJyb3IgaW4gZG9jdW1lbnQnKSwKICAgICAgICAgICAgewogICAgICAgICAgICAgIG9yaWdpbmFsRXJyb3I6IHN5bnRheEVycm9yLAogICAgICAgICAgICAgIGNvZGU6ICdYTUxQYXJzZXJFcnJvcicsCiAgICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAKICAgICAgICBpZiAocmVzdWx0LmRvY3VtZW50RWxlbWVudCA9PT0gbnVsbCkgewogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBwYXJzZSBlbXB0eSBkb2N1bWVudC4nKSwKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNvZGU6ICdYTUxQYXJzZXJFcnJvcicsCiAgICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAKICAgICAgICB2YXIgaXNFcnJvciA9IHJlc3VsdC5nZXRFbGVtZW50c0J5VGFnTmFtZSgncGFyc2VyZXJyb3InKVswXTsKICAgICAgICBpZiAoaXNFcnJvciAmJiAoaXNFcnJvci5wYXJlbnROb2RlID09PSByZXN1bHQgfHwKICAgICAgICAgICAgaXNFcnJvci5wYXJlbnROb2RlLm5vZGVOYW1lID09PSAnYm9keScgfHwKICAgICAgICAgICAgaXNFcnJvci5wYXJlbnROb2RlLnBhcmVudE5vZGUgPT09IHJlc3VsdCB8fAogICAgICAgICAgICBpc0Vycm9yLnBhcmVudE5vZGUucGFyZW50Tm9kZS5ub2RlTmFtZSA9PT0gJ2JvZHknKSkgewogICAgICAgICAgdmFyIGVycm9yRWxlbWVudCA9IGlzRXJyb3IuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2RpdicpWzBdIHx8IGlzRXJyb3I7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcihlcnJvckVsZW1lbnQudGV4dENvbnRlbnQgfHwgJ1BhcnNlciBlcnJvciBpbiBkb2N1bWVudCcpLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29kZTogJ1hNTFBhcnNlckVycm9yJywKICAgICAgICAgICAgICByZXRyeWFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHdpbmRvdy5BY3RpdmVYT2JqZWN0KSB7CiAgICAgICAgcmVzdWx0ID0gbmV3IHdpbmRvdy5BY3RpdmVYT2JqZWN0KCdNaWNyb3NvZnQuWE1MRE9NJyk7CiAgICAgICAgcmVzdWx0LmFzeW5jID0gZmFsc2U7CiAgCiAgICAgICAgaWYgKCFyZXN1bHQubG9hZFhNTCh4bWwpKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignUGFyc2UgZXJyb3IgaW4gZG9jdW1lbnQnKSwKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNvZGU6ICdYTUxQYXJzZXJFcnJvcicsCiAgICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBsb2FkIFhNTCBwYXJzZXInKTsKICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBlcnJvciA9IGU7CiAgICB9CiAgCiAgICBpZiAocmVzdWx0ICYmIHJlc3VsdC5kb2N1bWVudEVsZW1lbnQgJiYgIWVycm9yKSB7CiAgICAgIHZhciBkYXRhID0gcGFyc2VYbWwocmVzdWx0LmRvY3VtZW50RWxlbWVudCwgc2hhcGUpOwogICAgICB2YXIgbWV0YWRhdGEgPSBnZXRFbGVtZW50QnlUYWdOYW1lKHJlc3VsdC5kb2N1bWVudEVsZW1lbnQsICdSZXNwb25zZU1ldGFkYXRhJyk7CiAgICAgIGlmIChtZXRhZGF0YSkgewogICAgICAgIGRhdGEuUmVzcG9uc2VNZXRhZGF0YSA9IHBhcnNlWG1sKG1ldGFkYXRhLCB7fSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGE7CiAgICB9IGVsc2UgaWYgKGVycm9yKSB7CiAgICAgIHRocm93IHV0aWwuZXJyb3IoZXJyb3IgfHwgbmV3IEVycm9yKCksIHtjb2RlOiAnWE1MUGFyc2VyRXJyb3InLCByZXRyeWFibGU6IHRydWV9KTsKICAgIH0gZWxzZSB7IC8vIGVtcHR5IHhtbCBkb2N1bWVudAogICAgICByZXR1cm4ge307CiAgICB9CiAgfTsKICAKICBmdW5jdGlvbiBnZXRFbGVtZW50QnlUYWdOYW1lKHhtbCwgdGFnKSB7CiAgICB2YXIgZWxlbWVudHMgPSB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnKTsKICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gZWxlbWVudHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgIGlmIChlbGVtZW50c1tpXS5wYXJlbnROb2RlID09PSB4bWwpIHsKICAgICAgICByZXR1cm4gZWxlbWVudHNbaV07CiAgICAgIH0KICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gcGFyc2VYbWwoeG1sLCBzaGFwZSkgewogICAgaWYgKCFzaGFwZSkgc2hhcGUgPSB7fTsKICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICBjYXNlICdzdHJ1Y3R1cmUnOiByZXR1cm4gcGFyc2VTdHJ1Y3R1cmUoeG1sLCBzaGFwZSk7CiAgICAgIGNhc2UgJ21hcCc6IHJldHVybiBwYXJzZU1hcCh4bWwsIHNoYXBlKTsKICAgICAgY2FzZSAnbGlzdCc6IHJldHVybiBwYXJzZUxpc3QoeG1sLCBzaGFwZSk7CiAgICAgIGNhc2UgdW5kZWZpbmVkOiBjYXNlIG51bGw6IHJldHVybiBwYXJzZVVua25vd24oeG1sKTsKICAgICAgZGVmYXVsdDogcmV0dXJuIHBhcnNlU2NhbGFyKHhtbCwgc2hhcGUpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBwYXJzZVN0cnVjdHVyZSh4bWwsIHNoYXBlKSB7CiAgICB2YXIgZGF0YSA9IHt9OwogICAgaWYgKHhtbCA9PT0gbnVsbCkgcmV0dXJuIGRhdGE7CiAgCiAgICB1dGlsLmVhY2goc2hhcGUubWVtYmVycywgZnVuY3Rpb24obWVtYmVyTmFtZSwgbWVtYmVyU2hhcGUpIHsKICAgICAgaWYgKG1lbWJlclNoYXBlLmlzWG1sQXR0cmlidXRlKSB7CiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh4bWwuYXR0cmlidXRlcywgbWVtYmVyU2hhcGUubmFtZSkpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IHhtbC5hdHRyaWJ1dGVzW21lbWJlclNoYXBlLm5hbWVdLnZhbHVlOwogICAgICAgICAgZGF0YVttZW1iZXJOYW1lXSA9IHBhcnNlWG1sKHt0ZXh0Q29udGVudDogdmFsdWV9LCBtZW1iZXJTaGFwZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHZhciB4bWxDaGlsZCA9IG1lbWJlclNoYXBlLmZsYXR0ZW5lZCA/IHhtbCA6CiAgICAgICAgICBnZXRFbGVtZW50QnlUYWdOYW1lKHhtbCwgbWVtYmVyU2hhcGUubmFtZSk7CiAgICAgICAgaWYgKHhtbENoaWxkKSB7CiAgICAgICAgICBkYXRhW21lbWJlck5hbWVdID0gcGFyc2VYbWwoeG1sQ2hpbGQsIG1lbWJlclNoYXBlKTsKICAgICAgICB9IGVsc2UgaWYgKCFtZW1iZXJTaGFwZS5mbGF0dGVuZWQgJiYgbWVtYmVyU2hhcGUudHlwZSA9PT0gJ2xpc3QnKSB7CiAgICAgICAgICBkYXRhW21lbWJlck5hbWVdID0gbWVtYmVyU2hhcGUuZGVmYXVsdFZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgCiAgICByZXR1cm4gZGF0YTsKICB9CiAgCiAgZnVuY3Rpb24gcGFyc2VNYXAoeG1sLCBzaGFwZSkgewogICAgdmFyIGRhdGEgPSB7fTsKICAgIHZhciB4bWxLZXkgPSBzaGFwZS5rZXkubmFtZSB8fCAna2V5JzsKICAgIHZhciB4bWxWYWx1ZSA9IHNoYXBlLnZhbHVlLm5hbWUgfHwgJ3ZhbHVlJzsKICAgIHZhciB0YWdOYW1lID0gc2hhcGUuZmxhdHRlbmVkID8gc2hhcGUubmFtZSA6ICdlbnRyeSc7CiAgCiAgICB2YXIgY2hpbGQgPSB4bWwuZmlyc3RFbGVtZW50Q2hpbGQ7CiAgICB3aGlsZSAoY2hpbGQpIHsKICAgICAgaWYgKGNoaWxkLm5vZGVOYW1lID09PSB0YWdOYW1lKSB7CiAgICAgICAgdmFyIGtleSA9IGdldEVsZW1lbnRCeVRhZ05hbWUoY2hpbGQsIHhtbEtleSkudGV4dENvbnRlbnQ7CiAgICAgICAgdmFyIHZhbHVlID0gZ2V0RWxlbWVudEJ5VGFnTmFtZShjaGlsZCwgeG1sVmFsdWUpOwogICAgICAgIGRhdGFba2V5XSA9IHBhcnNlWG1sKHZhbHVlLCBzaGFwZS52YWx1ZSk7CiAgICAgIH0KICAgICAgY2hpbGQgPSBjaGlsZC5uZXh0RWxlbWVudFNpYmxpbmc7CiAgICB9CiAgICByZXR1cm4gZGF0YTsKICB9CiAgCiAgZnVuY3Rpb24gcGFyc2VMaXN0KHhtbCwgc2hhcGUpIHsKICAgIHZhciBkYXRhID0gW107CiAgICB2YXIgdGFnTmFtZSA9IHNoYXBlLmZsYXR0ZW5lZCA/IHNoYXBlLm5hbWUgOiAoc2hhcGUubWVtYmVyLm5hbWUgfHwgJ21lbWJlcicpOwogIAogICAgdmFyIGNoaWxkID0geG1sLmZpcnN0RWxlbWVudENoaWxkOwogICAgd2hpbGUgKGNoaWxkKSB7CiAgICAgIGlmIChjaGlsZC5ub2RlTmFtZSA9PT0gdGFnTmFtZSkgewogICAgICAgIGRhdGEucHVzaChwYXJzZVhtbChjaGlsZCwgc2hhcGUubWVtYmVyKSk7CiAgICAgIH0KICAgICAgY2hpbGQgPSBjaGlsZC5uZXh0RWxlbWVudFNpYmxpbmc7CiAgICB9CiAgICByZXR1cm4gZGF0YTsKICB9CiAgCiAgZnVuY3Rpb24gcGFyc2VTY2FsYXIoeG1sLCBzaGFwZSkgewogICAgaWYgKHhtbC5nZXRBdHRyaWJ1dGUpIHsKICAgICAgdmFyIGVuY29kaW5nID0geG1sLmdldEF0dHJpYnV0ZSgnZW5jb2RpbmcnKTsKICAgICAgaWYgKGVuY29kaW5nID09PSAnYmFzZTY0JykgewogICAgICAgIHNoYXBlID0gbmV3IFNoYXBlLmNyZWF0ZSh7dHlwZTogZW5jb2Rpbmd9KTsKICAgICAgfQogICAgfQogIAogICAgdmFyIHRleHQgPSB4bWwudGV4dENvbnRlbnQ7CiAgICBpZiAodGV4dCA9PT0gJycpIHRleHQgPSBudWxsOwogICAgaWYgKHR5cGVvZiBzaGFwZS50b1R5cGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgcmV0dXJuIHNoYXBlLnRvVHlwZSh0ZXh0KTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0ZXh0OwogICAgfQogIH0KICAKICBmdW5jdGlvbiBwYXJzZVVua25vd24oeG1sKSB7CiAgICBpZiAoeG1sID09PSB1bmRlZmluZWQgfHwgeG1sID09PSBudWxsKSByZXR1cm4gJyc7CiAgCiAgICAvLyBlbXB0eSBvYmplY3QKICAgIGlmICgheG1sLmZpcnN0RWxlbWVudENoaWxkKSB7CiAgICAgIGlmICh4bWwucGFyZW50Tm9kZS5wYXJlbnROb2RlID09PSBudWxsKSByZXR1cm4ge307CiAgICAgIGlmICh4bWwuY2hpbGROb2Rlcy5sZW5ndGggPT09IDApIHJldHVybiAnJzsKICAgICAgZWxzZSByZXR1cm4geG1sLnRleHRDb250ZW50OwogICAgfQogIAogICAgLy8gb2JqZWN0LCBwYXJzZSBhcyBzdHJ1Y3R1cmUKICAgIHZhciBzaGFwZSA9IHt0eXBlOiAnc3RydWN0dXJlJywgbWVtYmVyczoge319OwogICAgdmFyIGNoaWxkID0geG1sLmZpcnN0RWxlbWVudENoaWxkOwogICAgd2hpbGUgKGNoaWxkKSB7CiAgICAgIHZhciB0YWcgPSBjaGlsZC5ub2RlTmFtZTsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzaGFwZS5tZW1iZXJzLCB0YWcpKSB7CiAgICAgICAgLy8gbXVsdGlwbGUgdGFncyBvZiB0aGUgc2FtZSBuYW1lIG1ha2VzIGl0IGEgbGlzdAogICAgICAgIHNoYXBlLm1lbWJlcnNbdGFnXS50eXBlID0gJ2xpc3QnOwogICAgICB9IGVsc2UgewogICAgICAgIHNoYXBlLm1lbWJlcnNbdGFnXSA9IHtuYW1lOiB0YWd9OwogICAgICB9CiAgICAgIGNoaWxkID0gY2hpbGQubmV4dEVsZW1lbnRTaWJsaW5nOwogICAgfQogICAgcmV0dXJuIHBhcnNlU3RydWN0dXJlKHhtbCwgc2hhcGUpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IERvbVhtbFBhcnNlcjsKICAKICB9LHsiLi4vbW9kZWwvc2hhcGUiOjQzLCIuLi91dGlsIjo3MX1dLDczOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgWG1sTm9kZSA9IHJlcXVpcmUoJy4veG1sLW5vZGUnKS5YbWxOb2RlOwogIHZhciBYbWxUZXh0ID0gcmVxdWlyZSgnLi94bWwtdGV4dCcpLlhtbFRleHQ7CiAgCiAgZnVuY3Rpb24gWG1sQnVpbGRlcigpIHsgfQogIAogIFhtbEJ1aWxkZXIucHJvdG90eXBlLnRvWE1MID0gZnVuY3Rpb24ocGFyYW1zLCBzaGFwZSwgcm9vdEVsZW1lbnQsIG5vRW1wdHkpIHsKICAgIHZhciB4bWwgPSBuZXcgWG1sTm9kZShyb290RWxlbWVudCk7CiAgICBhcHBseU5hbWVzcGFjZXMoeG1sLCBzaGFwZSwgdHJ1ZSk7CiAgICBzZXJpYWxpemUoeG1sLCBwYXJhbXMsIHNoYXBlKTsKICAgIHJldHVybiB4bWwuY2hpbGRyZW4ubGVuZ3RoID4gMCB8fCBub0VtcHR5ID8geG1sLnRvU3RyaW5nKCkgOiAnJzsKICB9OwogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZSh4bWwsIHZhbHVlLCBzaGFwZSkgewogICAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICAgIGNhc2UgJ3N0cnVjdHVyZSc6IHJldHVybiBzZXJpYWxpemVTdHJ1Y3R1cmUoeG1sLCB2YWx1ZSwgc2hhcGUpOwogICAgICBjYXNlICdtYXAnOiByZXR1cm4gc2VyaWFsaXplTWFwKHhtbCwgdmFsdWUsIHNoYXBlKTsKICAgICAgY2FzZSAnbGlzdCc6IHJldHVybiBzZXJpYWxpemVMaXN0KHhtbCwgdmFsdWUsIHNoYXBlKTsKICAgICAgZGVmYXVsdDogcmV0dXJuIHNlcmlhbGl6ZVNjYWxhcih4bWwsIHZhbHVlLCBzaGFwZSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZVN0cnVjdHVyZSh4bWwsIHBhcmFtcywgc2hhcGUpIHsKICAgIHV0aWwuYXJyYXlFYWNoKHNoYXBlLm1lbWJlck5hbWVzLCBmdW5jdGlvbihtZW1iZXJOYW1lKSB7CiAgICAgIHZhciBtZW1iZXJTaGFwZSA9IHNoYXBlLm1lbWJlcnNbbWVtYmVyTmFtZV07CiAgICAgIGlmIChtZW1iZXJTaGFwZS5sb2NhdGlvbiAhPT0gJ2JvZHknKSByZXR1cm47CiAgCiAgICAgIHZhciB2YWx1ZSA9IHBhcmFtc1ttZW1iZXJOYW1lXTsKICAgICAgdmFyIG5hbWUgPSBtZW1iZXJTaGFwZS5uYW1lOwogICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbCkgewogICAgICAgIGlmIChtZW1iZXJTaGFwZS5pc1htbEF0dHJpYnV0ZSkgewogICAgICAgICAgeG1sLmFkZEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmIChtZW1iZXJTaGFwZS5mbGF0dGVuZWQpIHsKICAgICAgICAgIHNlcmlhbGl6ZSh4bWwsIHZhbHVlLCBtZW1iZXJTaGFwZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBlbGVtZW50ID0gbmV3IFhtbE5vZGUobmFtZSk7CiAgICAgICAgICB4bWwuYWRkQ2hpbGROb2RlKGVsZW1lbnQpOwogICAgICAgICAgYXBwbHlOYW1lc3BhY2VzKGVsZW1lbnQsIG1lbWJlclNoYXBlKTsKICAgICAgICAgIHNlcmlhbGl6ZShlbGVtZW50LCB2YWx1ZSwgbWVtYmVyU2hhcGUpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZU1hcCh4bWwsIG1hcCwgc2hhcGUpIHsKICAgIHZhciB4bWxLZXkgPSBzaGFwZS5rZXkubmFtZSB8fCAna2V5JzsKICAgIHZhciB4bWxWYWx1ZSA9IHNoYXBlLnZhbHVlLm5hbWUgfHwgJ3ZhbHVlJzsKICAKICAgIHV0aWwuZWFjaChtYXAsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgdmFyIGVudHJ5ID0gbmV3IFhtbE5vZGUoc2hhcGUuZmxhdHRlbmVkID8gc2hhcGUubmFtZSA6ICdlbnRyeScpOwogICAgICB4bWwuYWRkQ2hpbGROb2RlKGVudHJ5KTsKICAKICAgICAgdmFyIGVudHJ5S2V5ID0gbmV3IFhtbE5vZGUoeG1sS2V5KTsKICAgICAgdmFyIGVudHJ5VmFsdWUgPSBuZXcgWG1sTm9kZSh4bWxWYWx1ZSk7CiAgICAgIGVudHJ5LmFkZENoaWxkTm9kZShlbnRyeUtleSk7CiAgICAgIGVudHJ5LmFkZENoaWxkTm9kZShlbnRyeVZhbHVlKTsKICAKICAgICAgc2VyaWFsaXplKGVudHJ5S2V5LCBrZXksIHNoYXBlLmtleSk7CiAgICAgIHNlcmlhbGl6ZShlbnRyeVZhbHVlLCB2YWx1ZSwgc2hhcGUudmFsdWUpOwogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZUxpc3QoeG1sLCBsaXN0LCBzaGFwZSkgewogICAgaWYgKHNoYXBlLmZsYXR0ZW5lZCkgewogICAgICB1dGlsLmFycmF5RWFjaChsaXN0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHZhciBuYW1lID0gc2hhcGUubWVtYmVyLm5hbWUgfHwgc2hhcGUubmFtZTsKICAgICAgICB2YXIgZWxlbWVudCA9IG5ldyBYbWxOb2RlKG5hbWUpOwogICAgICAgIHhtbC5hZGRDaGlsZE5vZGUoZWxlbWVudCk7CiAgICAgICAgc2VyaWFsaXplKGVsZW1lbnQsIHZhbHVlLCBzaGFwZS5tZW1iZXIpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHV0aWwuYXJyYXlFYWNoKGxpc3QsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIG5hbWUgPSBzaGFwZS5tZW1iZXIubmFtZSB8fCAnbWVtYmVyJzsKICAgICAgICB2YXIgZWxlbWVudCA9IG5ldyBYbWxOb2RlKG5hbWUpOwogICAgICAgIHhtbC5hZGRDaGlsZE5vZGUoZWxlbWVudCk7CiAgICAgICAgc2VyaWFsaXplKGVsZW1lbnQsIHZhbHVlLCBzaGFwZS5tZW1iZXIpOwogICAgICB9KTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplU2NhbGFyKHhtbCwgdmFsdWUsIHNoYXBlKSB7CiAgICB4bWwuYWRkQ2hpbGROb2RlKAogICAgICBuZXcgWG1sVGV4dChzaGFwZS50b1dpcmVGb3JtYXQodmFsdWUpKQogICAgKTsKICB9CiAgCiAgZnVuY3Rpb24gYXBwbHlOYW1lc3BhY2VzKHhtbCwgc2hhcGUsIGlzUm9vdCkgewogICAgdmFyIHVyaSwgcHJlZml4ID0gJ3htbG5zJzsKICAgIGlmIChzaGFwZS54bWxOYW1lc3BhY2VVcmkpIHsKICAgICAgdXJpID0gc2hhcGUueG1sTmFtZXNwYWNlVXJpOwogICAgICBpZiAoc2hhcGUueG1sTmFtZXNwYWNlUHJlZml4KSBwcmVmaXggKz0gJzonICsgc2hhcGUueG1sTmFtZXNwYWNlUHJlZml4OwogICAgfSBlbHNlIGlmIChpc1Jvb3QgJiYgc2hhcGUuYXBpLnhtbE5hbWVzcGFjZVVyaSkgewogICAgICB1cmkgPSBzaGFwZS5hcGkueG1sTmFtZXNwYWNlVXJpOwogICAgfQogIAogICAgaWYgKHVyaSkgeG1sLmFkZEF0dHJpYnV0ZShwcmVmaXgsIHVyaSk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gWG1sQnVpbGRlcjsKICAKICB9LHsiLi4vdXRpbCI6NzEsIi4veG1sLW5vZGUiOjc2LCIuL3htbC10ZXh0Ijo3N31dLDc0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvKioKICAgKiBFc2NhcGVzIGNoYXJhY3RlcnMgdGhhdCBjYW4gbm90IGJlIGluIGFuIFhNTCBhdHRyaWJ1dGUuCiAgICovCiAgZnVuY3Rpb24gZXNjYXBlQXR0cmlidXRlKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZS5yZXBsYWNlKC8mL2csICcmYW1wOycpLnJlcGxhY2UoLycvZywgJyZhcG9zOycpLnJlcGxhY2UoLzwvZywgJyZsdDsnKS5yZXBsYWNlKC8+L2csICcmZ3Q7JykucmVwbGFjZSgvIi9nLCAnJnF1b3Q7Jyk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBlc2NhcGVBdHRyaWJ1dGU6IGVzY2FwZUF0dHJpYnV0ZQogIH07CiAgCiAgfSx7fV0sNzU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8qKgogICAqIEVzY2FwZXMgY2hhcmFjdGVycyB0aGF0IGNhbiBub3QgYmUgaW4gYW4gWE1MIGVsZW1lbnQuCiAgICovCiAgZnVuY3Rpb24gZXNjYXBlRWxlbWVudCh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUucmVwbGFjZSgvJi9nLCAnJmFtcDsnKS5yZXBsYWNlKC88L2csICcmbHQ7JykucmVwbGFjZSgvPi9nLCAnJmd0OycpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgZXNjYXBlRWxlbWVudDogZXNjYXBlRWxlbWVudAogIH07CiAgCiAgfSx7fV0sNzY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBlc2NhcGVBdHRyaWJ1dGUgPSByZXF1aXJlKCcuL2VzY2FwZS1hdHRyaWJ1dGUnKS5lc2NhcGVBdHRyaWJ1dGU7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyBhbiBYTUwgbm9kZS4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBYbWxOb2RlKG5hbWUsIGNoaWxkcmVuKSB7CiAgICAgIGlmIChjaGlsZHJlbiA9PT0gdm9pZCAwKSB7IGNoaWxkcmVuID0gW107IH0KICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICB0aGlzLmF0dHJpYnV0ZXMgPSB7fTsKICB9CiAgWG1sTm9kZS5wcm90b3R5cGUuYWRkQXR0cmlidXRlID0gZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICAgIHRoaXMuYXR0cmlidXRlc1tuYW1lXSA9IHZhbHVlOwogICAgICByZXR1cm4gdGhpczsKICB9OwogIFhtbE5vZGUucHJvdG90eXBlLmFkZENoaWxkTm9kZSA9IGZ1bmN0aW9uIChjaGlsZCkgewogICAgICB0aGlzLmNoaWxkcmVuLnB1c2goY2hpbGQpOwogICAgICByZXR1cm4gdGhpczsKICB9OwogIFhtbE5vZGUucHJvdG90eXBlLnJlbW92ZUF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIGRlbGV0ZSB0aGlzLmF0dHJpYnV0ZXNbbmFtZV07CiAgICAgIHJldHVybiB0aGlzOwogIH07CiAgWG1sTm9kZS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBoYXNDaGlsZHJlbiA9IEJvb2xlYW4odGhpcy5jaGlsZHJlbi5sZW5ndGgpOwogICAgICB2YXIgeG1sVGV4dCA9ICc8JyArIHRoaXMubmFtZTsKICAgICAgLy8gYWRkIGF0dHJpYnV0ZXMKICAgICAgdmFyIGF0dHJpYnV0ZXMgPSB0aGlzLmF0dHJpYnV0ZXM7CiAgICAgIGZvciAodmFyIGkgPSAwLCBhdHRyaWJ1dGVOYW1lcyA9IE9iamVjdC5rZXlzKGF0dHJpYnV0ZXMpOyBpIDwgYXR0cmlidXRlTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBhdHRyaWJ1dGVOYW1lID0gYXR0cmlidXRlTmFtZXNbaV07CiAgICAgICAgICB2YXIgYXR0cmlidXRlID0gYXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXTsKICAgICAgICAgIGlmICh0eXBlb2YgYXR0cmlidXRlICE9PSAndW5kZWZpbmVkJyAmJiBhdHRyaWJ1dGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB4bWxUZXh0ICs9ICcgJyArIGF0dHJpYnV0ZU5hbWUgKyAnPVwiJyArIGVzY2FwZUF0dHJpYnV0ZSgnJyArIGF0dHJpYnV0ZSkgKyAnXCInOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB4bWxUZXh0ICs9ICFoYXNDaGlsZHJlbiA/ICcvPicgOiAnPicgKyB0aGlzLmNoaWxkcmVuLm1hcChmdW5jdGlvbiAoYykgeyByZXR1cm4gYy50b1N0cmluZygpOyB9KS5qb2luKCcnKSArICc8LycgKyB0aGlzLm5hbWUgKyAnPic7CiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgWG1sTm9kZTogWG1sTm9kZQogIH07CiAgCiAgfSx7Ii4vZXNjYXBlLWF0dHJpYnV0ZSI6NzR9XSw3NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIGVzY2FwZUVsZW1lbnQgPSByZXF1aXJlKCcuL2VzY2FwZS1lbGVtZW50JykuZXNjYXBlRWxlbWVudDsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIGFuIFhNTCB0ZXh0IHZhbHVlLgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIFhtbFRleHQodmFsdWUpIHsKICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogIH0KICAKICBYbWxUZXh0LnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGVzY2FwZUVsZW1lbnQoJycgKyB0aGlzLnZhbHVlKTsKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBYbWxUZXh0OiBYbWxUZXh0CiAgfTsKICAKICB9LHsiLi9lc2NhcGUtZWxlbWVudCI6NzV9XSw3ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgJ3VzZSBzdHJpY3QnCiAgCiAgZXhwb3J0cy5ieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aAogIGV4cG9ydHMudG9CeXRlQXJyYXkgPSB0b0J5dGVBcnJheQogIGV4cG9ydHMuZnJvbUJ5dGVBcnJheSA9IGZyb21CeXRlQXJyYXkKICAKICB2YXIgbG9va3VwID0gW10KICB2YXIgcmV2TG9va3VwID0gW10KICB2YXIgQXJyID0gdHlwZW9mIFVpbnQ4QXJyYXkgIT09ICd1bmRlZmluZWQnID8gVWludDhBcnJheSA6IEFycmF5CiAgCiAgdmFyIGNvZGUgPSAnQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ejAxMjM0NTY3ODkrLycKICBmb3IgKHZhciBpID0gMCwgbGVuID0gY29kZS5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgbG9va3VwW2ldID0gY29kZVtpXQogICAgcmV2TG9va3VwW2NvZGUuY2hhckNvZGVBdChpKV0gPSBpCiAgfQogIAogIC8vIFN1cHBvcnQgZGVjb2RpbmcgVVJMLXNhZmUgYmFzZTY0IHN0cmluZ3MsIGFzIE5vZGUuanMgZG9lcy4KICAvLyBTZWU6IGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Jhc2U2NCNVUkxfYXBwbGljYXRpb25zCiAgcmV2TG9va3VwWyctJy5jaGFyQ29kZUF0KDApXSA9IDYyCiAgcmV2TG9va3VwWydfJy5jaGFyQ29kZUF0KDApXSA9IDYzCiAgCiAgZnVuY3Rpb24gZ2V0TGVucyAoYjY0KSB7CiAgICB2YXIgbGVuID0gYjY0Lmxlbmd0aAogIAogICAgaWYgKGxlbiAlIDQgPiAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBzdHJpbmcuIExlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgNCcpCiAgICB9CiAgCiAgICAvLyBUcmltIG9mZiBleHRyYSBieXRlcyBhZnRlciBwbGFjZWhvbGRlciBieXRlcyBhcmUgZm91bmQKICAgIC8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2JlYXRnYW1taXQvYmFzZTY0LWpzL2lzc3Vlcy80MgogICAgdmFyIHZhbGlkTGVuID0gYjY0LmluZGV4T2YoJz0nKQogICAgaWYgKHZhbGlkTGVuID09PSAtMSkgdmFsaWRMZW4gPSBsZW4KICAKICAgIHZhciBwbGFjZUhvbGRlcnNMZW4gPSB2YWxpZExlbiA9PT0gbGVuCiAgICAgID8gMAogICAgICA6IDQgLSAodmFsaWRMZW4gJSA0KQogIAogICAgcmV0dXJuIFt2YWxpZExlbiwgcGxhY2VIb2xkZXJzTGVuXQogIH0KICAKICAvLyBiYXNlNjQgaXMgNC8zICsgdXAgdG8gdHdvIGNoYXJhY3RlcnMgb2YgdGhlIG9yaWdpbmFsIGRhdGEKICBmdW5jdGlvbiBieXRlTGVuZ3RoIChiNjQpIHsKICAgIHZhciBsZW5zID0gZ2V0TGVucyhiNjQpCiAgICB2YXIgdmFsaWRMZW4gPSBsZW5zWzBdCiAgICB2YXIgcGxhY2VIb2xkZXJzTGVuID0gbGVuc1sxXQogICAgcmV0dXJuICgodmFsaWRMZW4gKyBwbGFjZUhvbGRlcnNMZW4pICogMyAvIDQpIC0gcGxhY2VIb2xkZXJzTGVuCiAgfQogIAogIGZ1bmN0aW9uIF9ieXRlTGVuZ3RoIChiNjQsIHZhbGlkTGVuLCBwbGFjZUhvbGRlcnNMZW4pIHsKICAgIHJldHVybiAoKHZhbGlkTGVuICsgcGxhY2VIb2xkZXJzTGVuKSAqIDMgLyA0KSAtIHBsYWNlSG9sZGVyc0xlbgogIH0KICAKICBmdW5jdGlvbiB0b0J5dGVBcnJheSAoYjY0KSB7CiAgICB2YXIgdG1wCiAgICB2YXIgbGVucyA9IGdldExlbnMoYjY0KQogICAgdmFyIHZhbGlkTGVuID0gbGVuc1swXQogICAgdmFyIHBsYWNlSG9sZGVyc0xlbiA9IGxlbnNbMV0KICAKICAgIHZhciBhcnIgPSBuZXcgQXJyKF9ieXRlTGVuZ3RoKGI2NCwgdmFsaWRMZW4sIHBsYWNlSG9sZGVyc0xlbikpCiAgCiAgICB2YXIgY3VyQnl0ZSA9IDAKICAKICAgIC8vIGlmIHRoZXJlIGFyZSBwbGFjZWhvbGRlcnMsIG9ubHkgZ2V0IHVwIHRvIHRoZSBsYXN0IGNvbXBsZXRlIDQgY2hhcnMKICAgIHZhciBsZW4gPSBwbGFjZUhvbGRlcnNMZW4gPiAwCiAgICAgID8gdmFsaWRMZW4gLSA0CiAgICAgIDogdmFsaWRMZW4KICAKICAgIHZhciBpCiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpICs9IDQpIHsKICAgICAgdG1wID0KICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkpXSA8PCAxOCkgfAogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDEpXSA8PCAxMikgfAogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDIpXSA8PCA2KSB8CiAgICAgICAgcmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAzKV0KICAgICAgYXJyW2N1ckJ5dGUrK10gPSAodG1wID4+IDE2KSAmIDB4RkYKICAgICAgYXJyW2N1ckJ5dGUrK10gPSAodG1wID4+IDgpICYgMHhGRgogICAgICBhcnJbY3VyQnl0ZSsrXSA9IHRtcCAmIDB4RkYKICAgIH0KICAKICAgIGlmIChwbGFjZUhvbGRlcnNMZW4gPT09IDIpIHsKICAgICAgdG1wID0KICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkpXSA8PCAyKSB8CiAgICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMSldID4+IDQpCiAgICAgIGFycltjdXJCeXRlKytdID0gdG1wICYgMHhGRgogICAgfQogIAogICAgaWYgKHBsYWNlSG9sZGVyc0xlbiA9PT0gMSkgewogICAgICB0bXAgPQogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSldIDw8IDEwKSB8CiAgICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMSldIDw8IDQpIHwKICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAyKV0gPj4gMikKICAgICAgYXJyW2N1ckJ5dGUrK10gPSAodG1wID4+IDgpICYgMHhGRgogICAgICBhcnJbY3VyQnl0ZSsrXSA9IHRtcCAmIDB4RkYKICAgIH0KICAKICAgIHJldHVybiBhcnIKICB9CiAgCiAgZnVuY3Rpb24gdHJpcGxldFRvQmFzZTY0IChudW0pIHsKICAgIHJldHVybiBsb29rdXBbbnVtID4+IDE4ICYgMHgzRl0gKwogICAgICBsb29rdXBbbnVtID4+IDEyICYgMHgzRl0gKwogICAgICBsb29rdXBbbnVtID4+IDYgJiAweDNGXSArCiAgICAgIGxvb2t1cFtudW0gJiAweDNGXQogIH0KICAKICBmdW5jdGlvbiBlbmNvZGVDaHVuayAodWludDgsIHN0YXJ0LCBlbmQpIHsKICAgIHZhciB0bXAKICAgIHZhciBvdXRwdXQgPSBbXQogICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgZW5kOyBpICs9IDMpIHsKICAgICAgdG1wID0KICAgICAgICAoKHVpbnQ4W2ldIDw8IDE2KSAmIDB4RkYwMDAwKSArCiAgICAgICAgKCh1aW50OFtpICsgMV0gPDwgOCkgJiAweEZGMDApICsKICAgICAgICAodWludDhbaSArIDJdICYgMHhGRikKICAgICAgb3V0cHV0LnB1c2godHJpcGxldFRvQmFzZTY0KHRtcCkpCiAgICB9CiAgICByZXR1cm4gb3V0cHV0LmpvaW4oJycpCiAgfQogIAogIGZ1bmN0aW9uIGZyb21CeXRlQXJyYXkgKHVpbnQ4KSB7CiAgICB2YXIgdG1wCiAgICB2YXIgbGVuID0gdWludDgubGVuZ3RoCiAgICB2YXIgZXh0cmFCeXRlcyA9IGxlbiAlIDMgLy8gaWYgd2UgaGF2ZSAxIGJ5dGUgbGVmdCwgcGFkIDIgYnl0ZXMKICAgIHZhciBwYXJ0cyA9IFtdCiAgICB2YXIgbWF4Q2h1bmtMZW5ndGggPSAxNjM4MyAvLyBtdXN0IGJlIG11bHRpcGxlIG9mIDMKICAKICAgIC8vIGdvIHRocm91Z2ggdGhlIGFycmF5IGV2ZXJ5IHRocmVlIGJ5dGVzLCB3ZSdsbCBkZWFsIHdpdGggdHJhaWxpbmcgc3R1ZmYgbGF0ZXIKICAgIGZvciAodmFyIGkgPSAwLCBsZW4yID0gbGVuIC0gZXh0cmFCeXRlczsgaSA8IGxlbjI7IGkgKz0gbWF4Q2h1bmtMZW5ndGgpIHsKICAgICAgcGFydHMucHVzaChlbmNvZGVDaHVuaygKICAgICAgICB1aW50OCwgaSwgKGkgKyBtYXhDaHVua0xlbmd0aCkgPiBsZW4yID8gbGVuMiA6IChpICsgbWF4Q2h1bmtMZW5ndGgpCiAgICAgICkpCiAgICB9CiAgCiAgICAvLyBwYWQgdGhlIGVuZCB3aXRoIHplcm9zLCBidXQgbWFrZSBzdXJlIHRvIG5vdCBmb3JnZXQgdGhlIGV4dHJhIGJ5dGVzCiAgICBpZiAoZXh0cmFCeXRlcyA9PT0gMSkgewogICAgICB0bXAgPSB1aW50OFtsZW4gLSAxXQogICAgICBwYXJ0cy5wdXNoKAogICAgICAgIGxvb2t1cFt0bXAgPj4gMl0gKwogICAgICAgIGxvb2t1cFsodG1wIDw8IDQpICYgMHgzRl0gKwogICAgICAgICc9PScKICAgICAgKQogICAgfSBlbHNlIGlmIChleHRyYUJ5dGVzID09PSAyKSB7CiAgICAgIHRtcCA9ICh1aW50OFtsZW4gLSAyXSA8PCA4KSArIHVpbnQ4W2xlbiAtIDFdCiAgICAgIHBhcnRzLnB1c2goCiAgICAgICAgbG9va3VwW3RtcCA+PiAxMF0gKwogICAgICAgIGxvb2t1cFsodG1wID4+IDQpICYgMHgzRl0gKwogICAgICAgIGxvb2t1cFsodG1wIDw8IDIpICYgMHgzRl0gKwogICAgICAgICc9JwogICAgICApCiAgICB9CiAgCiAgICByZXR1cm4gcGFydHMuam9pbignJykKICB9CiAgCiAgfSx7fV0sNzk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIAogIH0se31dLDgwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKGdsb2JhbCxCdWZmZXIpewogIC8qIQogICAqIFRoZSBidWZmZXIgbW9kdWxlIGZyb20gbm9kZS5qcywgZm9yIHRoZSBicm93c2VyLgogICAqCiAgICogQGF1dGhvciAgIEZlcm9zcyBBYm91a2hhZGlqZWggPGZlcm9zc0BmZXJvc3Mub3JnPiA8aHR0cDovL2Zlcm9zcy5vcmc+CiAgICogQGxpY2Vuc2UgIE1JVAogICAqLwogIC8qIGVzbGludC1kaXNhYmxlIG5vLXByb3RvICovCiAgCiAgJ3VzZSBzdHJpY3QnCiAgCiAgdmFyIGJhc2U2NCA9IHJlcXVpcmUoJ2Jhc2U2NC1qcycpCiAgdmFyIGllZWU3NTQgPSByZXF1aXJlKCdpZWVlNzU0JykKICB2YXIgaXNBcnJheSA9IHJlcXVpcmUoJ2lzYXJyYXknKQogIAogIGV4cG9ydHMuQnVmZmVyID0gQnVmZmVyCiAgZXhwb3J0cy5TbG93QnVmZmVyID0gU2xvd0J1ZmZlcgogIGV4cG9ydHMuSU5TUEVDVF9NQVhfQllURVMgPSA1MAogIAogIC8qKgogICAqIElmIGBCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVGA6CiAgICogICA9PT0gdHJ1ZSAgICBVc2UgVWludDhBcnJheSBpbXBsZW1lbnRhdGlvbiAoZmFzdGVzdCkKICAgKiAgID09PSBmYWxzZSAgIFVzZSBPYmplY3QgaW1wbGVtZW50YXRpb24gKG1vc3QgY29tcGF0aWJsZSwgZXZlbiBJRTYpCiAgICoKICAgKiBCcm93c2VycyB0aGF0IHN1cHBvcnQgdHlwZWQgYXJyYXlzIGFyZSBJRSAxMCssIEZpcmVmb3ggNCssIENocm9tZSA3KywgU2FmYXJpIDUuMSssCiAgICogT3BlcmEgMTEuNissIGlPUyA0LjIrLgogICAqCiAgICogRHVlIHRvIHZhcmlvdXMgYnJvd3NlciBidWdzLCBzb21ldGltZXMgdGhlIE9iamVjdCBpbXBsZW1lbnRhdGlvbiB3aWxsIGJlIHVzZWQgZXZlbgogICAqIHdoZW4gdGhlIGJyb3dzZXIgc3VwcG9ydHMgdHlwZWQgYXJyYXlzLgogICAqCiAgICogTm90ZToKICAgKgogICAqICAgLSBGaXJlZm94IDQtMjkgbGFja3Mgc3VwcG9ydCBmb3IgYWRkaW5nIG5ldyBwcm9wZXJ0aWVzIHRvIGBVaW50OEFycmF5YCBpbnN0YW5jZXMsCiAgICogICAgIFNlZTogaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9Njk1NDM4LgogICAqCiAgICogICAtIENocm9tZSA5LTEwIGlzIG1pc3NpbmcgdGhlIGBUeXBlZEFycmF5LnByb3RvdHlwZS5zdWJhcnJheWAgZnVuY3Rpb24uCiAgICoKICAgKiAgIC0gSUUxMCBoYXMgYSBicm9rZW4gYFR5cGVkQXJyYXkucHJvdG90eXBlLnN1YmFycmF5YCBmdW5jdGlvbiB3aGljaCByZXR1cm5zIGFycmF5cyBvZgogICAqICAgICBpbmNvcnJlY3QgbGVuZ3RoIGluIHNvbWUgc2l0dWF0aW9ucy4KICAKICAgKiBXZSBkZXRlY3QgdGhlc2UgYnVnZ3kgYnJvd3NlcnMgYW5kIHNldCBgQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlRgIHRvIGBmYWxzZWAgc28gdGhleQogICAqIGdldCB0aGUgT2JqZWN0IGltcGxlbWVudGF0aW9uLCB3aGljaCBpcyBzbG93ZXIgYnV0IGJlaGF2ZXMgY29ycmVjdGx5LgogICAqLwogIEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUID0gZ2xvYmFsLlRZUEVEX0FSUkFZX1NVUFBPUlQgIT09IHVuZGVmaW5lZAogICAgPyBnbG9iYWwuVFlQRURfQVJSQVlfU1VQUE9SVAogICAgOiB0eXBlZEFycmF5U3VwcG9ydCgpCiAgCiAgLyoKICAgKiBFeHBvcnQga01heExlbmd0aCBhZnRlciB0eXBlZCBhcnJheSBzdXBwb3J0IGlzIGRldGVybWluZWQuCiAgICovCiAgZXhwb3J0cy5rTWF4TGVuZ3RoID0ga01heExlbmd0aCgpCiAgCiAgZnVuY3Rpb24gdHlwZWRBcnJheVN1cHBvcnQgKCkgewogICAgdHJ5IHsKICAgICAgdmFyIGFyciA9IG5ldyBVaW50OEFycmF5KDEpCiAgICAgIGFyci5fX3Byb3RvX18gPSB7X19wcm90b19fOiBVaW50OEFycmF5LnByb3RvdHlwZSwgZm9vOiBmdW5jdGlvbiAoKSB7IHJldHVybiA0MiB9fQogICAgICByZXR1cm4gYXJyLmZvbygpID09PSA0MiAmJiAvLyB0eXBlZCBhcnJheSBpbnN0YW5jZXMgY2FuIGJlIGF1Z21lbnRlZAogICAgICAgICAgdHlwZW9mIGFyci5zdWJhcnJheSA9PT0gJ2Z1bmN0aW9uJyAmJiAvLyBjaHJvbWUgOS0xMCBsYWNrIGBzdWJhcnJheWAKICAgICAgICAgIGFyci5zdWJhcnJheSgxLCAxKS5ieXRlTGVuZ3RoID09PSAwIC8vIGllMTAgaGFzIGJyb2tlbiBgc3ViYXJyYXlgCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0KICAKICBmdW5jdGlvbiBrTWF4TGVuZ3RoICgpIHsKICAgIHJldHVybiBCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVAogICAgICA/IDB4N2ZmZmZmZmYKICAgICAgOiAweDNmZmZmZmZmCiAgfQogIAogIGZ1bmN0aW9uIGNyZWF0ZUJ1ZmZlciAodGhhdCwgbGVuZ3RoKSB7CiAgICBpZiAoa01heExlbmd0aCgpIDwgbGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbnZhbGlkIHR5cGVkIGFycmF5IGxlbmd0aCcpCiAgICB9CiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgLy8gUmV0dXJuIGFuIGF1Z21lbnRlZCBgVWludDhBcnJheWAgaW5zdGFuY2UsIGZvciBiZXN0IHBlcmZvcm1hbmNlCiAgICAgIHRoYXQgPSBuZXcgVWludDhBcnJheShsZW5ndGgpCiAgICAgIHRoYXQuX19wcm90b19fID0gQnVmZmVyLnByb3RvdHlwZQogICAgfSBlbHNlIHsKICAgICAgLy8gRmFsbGJhY2s6IFJldHVybiBhbiBvYmplY3QgaW5zdGFuY2Ugb2YgdGhlIEJ1ZmZlciBjbGFzcwogICAgICBpZiAodGhhdCA9PT0gbnVsbCkgewogICAgICAgIHRoYXQgPSBuZXcgQnVmZmVyKGxlbmd0aCkKICAgICAgfQogICAgICB0aGF0Lmxlbmd0aCA9IGxlbmd0aAogICAgfQogIAogICAgcmV0dXJuIHRoYXQKICB9CiAgCiAgLyoqCiAgICogVGhlIEJ1ZmZlciBjb25zdHJ1Y3RvciByZXR1cm5zIGluc3RhbmNlcyBvZiBgVWludDhBcnJheWAgdGhhdCBoYXZlIHRoZWlyCiAgICogcHJvdG90eXBlIGNoYW5nZWQgdG8gYEJ1ZmZlci5wcm90b3R5cGVgLiBGdXJ0aGVybW9yZSwgYEJ1ZmZlcmAgaXMgYSBzdWJjbGFzcyBvZgogICAqIGBVaW50OEFycmF5YCwgc28gdGhlIHJldHVybmVkIGluc3RhbmNlcyB3aWxsIGhhdmUgYWxsIHRoZSBub2RlIGBCdWZmZXJgIG1ldGhvZHMKICAgKiBhbmQgdGhlIGBVaW50OEFycmF5YCBtZXRob2RzLiBTcXVhcmUgYnJhY2tldCBub3RhdGlvbiB3b3JrcyBhcyBleHBlY3RlZCAtLSBpdAogICAqIHJldHVybnMgYSBzaW5nbGUgb2N0ZXQuCiAgICoKICAgKiBUaGUgYFVpbnQ4QXJyYXlgIHByb3RvdHlwZSByZW1haW5zIHVubW9kaWZpZWQuCiAgICovCiAgCiAgZnVuY3Rpb24gQnVmZmVyIChhcmcsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkgewogICAgaWYgKCFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCAmJiAhKHRoaXMgaW5zdGFuY2VvZiBCdWZmZXIpKSB7CiAgICAgIHJldHVybiBuZXcgQnVmZmVyKGFyZywgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQogICAgfQogIAogICAgLy8gQ29tbW9uIGNhc2UuCiAgICBpZiAodHlwZW9mIGFyZyA9PT0gJ251bWJlcicpIHsKICAgICAgaWYgKHR5cGVvZiBlbmNvZGluZ09yT2Zmc2V0ID09PSAnc3RyaW5nJykgewogICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICdJZiBlbmNvZGluZyBpcyBzcGVjaWZpZWQgdGhlbiB0aGUgZmlyc3QgYXJndW1lbnQgbXVzdCBiZSBhIHN0cmluZycKICAgICAgICApCiAgICAgIH0KICAgICAgcmV0dXJuIGFsbG9jVW5zYWZlKHRoaXMsIGFyZykKICAgIH0KICAgIHJldHVybiBmcm9tKHRoaXMsIGFyZywgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQogIH0KICAKICBCdWZmZXIucG9vbFNpemUgPSA4MTkyIC8vIG5vdCB1c2VkIGJ5IHRoaXMgaW1wbGVtZW50YXRpb24KICAKICAvLyBUT0RPOiBMZWdhY3ksIG5vdCBuZWVkZWQgYW55bW9yZS4gUmVtb3ZlIGluIG5leHQgbWFqb3IgdmVyc2lvbi4KICBCdWZmZXIuX2F1Z21lbnQgPSBmdW5jdGlvbiAoYXJyKSB7CiAgICBhcnIuX19wcm90b19fID0gQnVmZmVyLnByb3RvdHlwZQogICAgcmV0dXJuIGFycgogIH0KICAKICBmdW5jdGlvbiBmcm9tICh0aGF0LCB2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKSB7CiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCcidmFsdWUiIGFyZ3VtZW50IG11c3Qgbm90IGJlIGEgbnVtYmVyJykKICAgIH0KICAKICAgIGlmICh0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmIHZhbHVlIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIHsKICAgICAgcmV0dXJuIGZyb21BcnJheUJ1ZmZlcih0aGF0LCB2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQogICAgfQogIAogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgcmV0dXJuIGZyb21TdHJpbmcodGhhdCwgdmFsdWUsIGVuY29kaW5nT3JPZmZzZXQpCiAgICB9CiAgCiAgICByZXR1cm4gZnJvbU9iamVjdCh0aGF0LCB2YWx1ZSkKICB9CiAgCiAgLyoqCiAgICogRnVuY3Rpb25hbGx5IGVxdWl2YWxlbnQgdG8gQnVmZmVyKGFyZywgZW5jb2RpbmcpIGJ1dCB0aHJvd3MgYSBUeXBlRXJyb3IKICAgKiBpZiB2YWx1ZSBpcyBhIG51bWJlci4KICAgKiBCdWZmZXIuZnJvbShzdHJbLCBlbmNvZGluZ10pCiAgICogQnVmZmVyLmZyb20oYXJyYXkpCiAgICogQnVmZmVyLmZyb20oYnVmZmVyKQogICAqIEJ1ZmZlci5mcm9tKGFycmF5QnVmZmVyWywgYnl0ZU9mZnNldFssIGxlbmd0aF1dKQogICAqKi8KICBCdWZmZXIuZnJvbSA9IGZ1bmN0aW9uICh2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gZnJvbShudWxsLCB2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQogIH0KICAKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIEJ1ZmZlci5wcm90b3R5cGUuX19wcm90b19fID0gVWludDhBcnJheS5wcm90b3R5cGUKICAgIEJ1ZmZlci5fX3Byb3RvX18gPSBVaW50OEFycmF5CiAgICBpZiAodHlwZW9mIFN5bWJvbCAhPT0gJ3VuZGVmaW5lZCcgJiYgU3ltYm9sLnNwZWNpZXMgJiYKICAgICAgICBCdWZmZXJbU3ltYm9sLnNwZWNpZXNdID09PSBCdWZmZXIpIHsKICAgICAgLy8gRml4IHN1YmFycmF5KCkgaW4gRVMyMDE2LiBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9mZXJvc3MvYnVmZmVyL3B1bGwvOTcKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEJ1ZmZlciwgU3ltYm9sLnNwZWNpZXMsIHsKICAgICAgICB2YWx1ZTogbnVsbCwKICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgfSkKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gYXNzZXJ0U2l6ZSAoc2l6ZSkgewogICAgaWYgKHR5cGVvZiBzaXplICE9PSAnbnVtYmVyJykgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCcic2l6ZSIgYXJndW1lbnQgbXVzdCBiZSBhIG51bWJlcicpCiAgICB9IGVsc2UgaWYgKHNpemUgPCAwKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCcic2l6ZSIgYXJndW1lbnQgbXVzdCBub3QgYmUgbmVnYXRpdmUnKQogICAgfQogIH0KICAKICBmdW5jdGlvbiBhbGxvYyAodGhhdCwgc2l6ZSwgZmlsbCwgZW5jb2RpbmcpIHsKICAgIGFzc2VydFNpemUoc2l6ZSkKICAgIGlmIChzaXplIDw9IDApIHsKICAgICAgcmV0dXJuIGNyZWF0ZUJ1ZmZlcih0aGF0LCBzaXplKQogICAgfQogICAgaWYgKGZpbGwgIT09IHVuZGVmaW5lZCkgewogICAgICAvLyBPbmx5IHBheSBhdHRlbnRpb24gdG8gZW5jb2RpbmcgaWYgaXQncyBhIHN0cmluZy4gVGhpcwogICAgICAvLyBwcmV2ZW50cyBhY2NpZGVudGFsbHkgc2VuZGluZyBpbiBhIG51bWJlciB0aGF0IHdvdWxkCiAgICAgIC8vIGJlIGludGVycHJldHRlZCBhcyBhIHN0YXJ0IG9mZnNldC4KICAgICAgcmV0dXJuIHR5cGVvZiBlbmNvZGluZyA9PT0gJ3N0cmluZycKICAgICAgICA/IGNyZWF0ZUJ1ZmZlcih0aGF0LCBzaXplKS5maWxsKGZpbGwsIGVuY29kaW5nKQogICAgICAgIDogY3JlYXRlQnVmZmVyKHRoYXQsIHNpemUpLmZpbGwoZmlsbCkKICAgIH0KICAgIHJldHVybiBjcmVhdGVCdWZmZXIodGhhdCwgc2l6ZSkKICB9CiAgCiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBmaWxsZWQgQnVmZmVyIGluc3RhbmNlLgogICAqIGFsbG9jKHNpemVbLCBmaWxsWywgZW5jb2RpbmddXSkKICAgKiovCiAgQnVmZmVyLmFsbG9jID0gZnVuY3Rpb24gKHNpemUsIGZpbGwsIGVuY29kaW5nKSB7CiAgICByZXR1cm4gYWxsb2MobnVsbCwgc2l6ZSwgZmlsbCwgZW5jb2RpbmcpCiAgfQogIAogIGZ1bmN0aW9uIGFsbG9jVW5zYWZlICh0aGF0LCBzaXplKSB7CiAgICBhc3NlcnRTaXplKHNpemUpCiAgICB0aGF0ID0gY3JlYXRlQnVmZmVyKHRoYXQsIHNpemUgPCAwID8gMCA6IGNoZWNrZWQoc2l6ZSkgfCAwKQogICAgaWYgKCFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNpemU7ICsraSkgewogICAgICAgIHRoYXRbaV0gPSAwCiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGF0CiAgfQogIAogIC8qKgogICAqIEVxdWl2YWxlbnQgdG8gQnVmZmVyKG51bSksIGJ5IGRlZmF1bHQgY3JlYXRlcyBhIG5vbi16ZXJvLWZpbGxlZCBCdWZmZXIgaW5zdGFuY2UuCiAgICogKi8KICBCdWZmZXIuYWxsb2NVbnNhZmUgPSBmdW5jdGlvbiAoc2l6ZSkgewogICAgcmV0dXJuIGFsbG9jVW5zYWZlKG51bGwsIHNpemUpCiAgfQogIC8qKgogICAqIEVxdWl2YWxlbnQgdG8gU2xvd0J1ZmZlcihudW0pLCBieSBkZWZhdWx0IGNyZWF0ZXMgYSBub24temVyby1maWxsZWQgQnVmZmVyIGluc3RhbmNlLgogICAqLwogIEJ1ZmZlci5hbGxvY1Vuc2FmZVNsb3cgPSBmdW5jdGlvbiAoc2l6ZSkgewogICAgcmV0dXJuIGFsbG9jVW5zYWZlKG51bGwsIHNpemUpCiAgfQogIAogIGZ1bmN0aW9uIGZyb21TdHJpbmcgKHRoYXQsIHN0cmluZywgZW5jb2RpbmcpIHsKICAgIGlmICh0eXBlb2YgZW5jb2RpbmcgIT09ICdzdHJpbmcnIHx8IGVuY29kaW5nID09PSAnJykgewogICAgICBlbmNvZGluZyA9ICd1dGY4JwogICAgfQogIAogICAgaWYgKCFCdWZmZXIuaXNFbmNvZGluZyhlbmNvZGluZykpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignImVuY29kaW5nIiBtdXN0IGJlIGEgdmFsaWQgc3RyaW5nIGVuY29kaW5nJykKICAgIH0KICAKICAgIHZhciBsZW5ndGggPSBieXRlTGVuZ3RoKHN0cmluZywgZW5jb2RpbmcpIHwgMAogICAgdGhhdCA9IGNyZWF0ZUJ1ZmZlcih0aGF0LCBsZW5ndGgpCiAgCiAgICB2YXIgYWN0dWFsID0gdGhhdC53cml0ZShzdHJpbmcsIGVuY29kaW5nKQogIAogICAgaWYgKGFjdHVhbCAhPT0gbGVuZ3RoKSB7CiAgICAgIC8vIFdyaXRpbmcgYSBoZXggc3RyaW5nLCBmb3IgZXhhbXBsZSwgdGhhdCBjb250YWlucyBpbnZhbGlkIGNoYXJhY3RlcnMgd2lsbAogICAgICAvLyBjYXVzZSBldmVyeXRoaW5nIGFmdGVyIHRoZSBmaXJzdCBpbnZhbGlkIGNoYXJhY3RlciB0byBiZSBpZ25vcmVkLiAoZS5nLgogICAgICAvLyAnYWJ4eGNkJyB3aWxsIGJlIHRyZWF0ZWQgYXMgJ2FiJykKICAgICAgdGhhdCA9IHRoYXQuc2xpY2UoMCwgYWN0dWFsKQogICAgfQogIAogICAgcmV0dXJuIHRoYXQKICB9CiAgCiAgZnVuY3Rpb24gZnJvbUFycmF5TGlrZSAodGhhdCwgYXJyYXkpIHsKICAgIHZhciBsZW5ndGggPSBhcnJheS5sZW5ndGggPCAwID8gMCA6IGNoZWNrZWQoYXJyYXkubGVuZ3RoKSB8IDAKICAgIHRoYXQgPSBjcmVhdGVCdWZmZXIodGhhdCwgbGVuZ3RoKQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMSkgewogICAgICB0aGF0W2ldID0gYXJyYXlbaV0gJiAyNTUKICAgIH0KICAgIHJldHVybiB0aGF0CiAgfQogIAogIGZ1bmN0aW9uIGZyb21BcnJheUJ1ZmZlciAodGhhdCwgYXJyYXksIGJ5dGVPZmZzZXQsIGxlbmd0aCkgewogICAgYXJyYXkuYnl0ZUxlbmd0aCAvLyB0aGlzIHRocm93cyBpZiBgYXJyYXlgIGlzIG5vdCBhIHZhbGlkIEFycmF5QnVmZmVyCiAgCiAgICBpZiAoYnl0ZU9mZnNldCA8IDAgfHwgYXJyYXkuYnl0ZUxlbmd0aCA8IGJ5dGVPZmZzZXQpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ1wnb2Zmc2V0XCcgaXMgb3V0IG9mIGJvdW5kcycpCiAgICB9CiAgCiAgICBpZiAoYXJyYXkuYnl0ZUxlbmd0aCA8IGJ5dGVPZmZzZXQgKyAobGVuZ3RoIHx8IDApKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdcJ2xlbmd0aFwnIGlzIG91dCBvZiBib3VuZHMnKQogICAgfQogIAogICAgaWYgKGJ5dGVPZmZzZXQgPT09IHVuZGVmaW5lZCAmJiBsZW5ndGggPT09IHVuZGVmaW5lZCkgewogICAgICBhcnJheSA9IG5ldyBVaW50OEFycmF5KGFycmF5KQogICAgfSBlbHNlIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCkgewogICAgICBhcnJheSA9IG5ldyBVaW50OEFycmF5KGFycmF5LCBieXRlT2Zmc2V0KQogICAgfSBlbHNlIHsKICAgICAgYXJyYXkgPSBuZXcgVWludDhBcnJheShhcnJheSwgYnl0ZU9mZnNldCwgbGVuZ3RoKQogICAgfQogIAogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIC8vIFJldHVybiBhbiBhdWdtZW50ZWQgYFVpbnQ4QXJyYXlgIGluc3RhbmNlLCBmb3IgYmVzdCBwZXJmb3JtYW5jZQogICAgICB0aGF0ID0gYXJyYXkKICAgICAgdGhhdC5fX3Byb3RvX18gPSBCdWZmZXIucHJvdG90eXBlCiAgICB9IGVsc2UgewogICAgICAvLyBGYWxsYmFjazogUmV0dXJuIGFuIG9iamVjdCBpbnN0YW5jZSBvZiB0aGUgQnVmZmVyIGNsYXNzCiAgICAgIHRoYXQgPSBmcm9tQXJyYXlMaWtlKHRoYXQsIGFycmF5KQogICAgfQogICAgcmV0dXJuIHRoYXQKICB9CiAgCiAgZnVuY3Rpb24gZnJvbU9iamVjdCAodGhhdCwgb2JqKSB7CiAgICBpZiAoQnVmZmVyLmlzQnVmZmVyKG9iaikpIHsKICAgICAgdmFyIGxlbiA9IGNoZWNrZWQob2JqLmxlbmd0aCkgfCAwCiAgICAgIHRoYXQgPSBjcmVhdGVCdWZmZXIodGhhdCwgbGVuKQogIAogICAgICBpZiAodGhhdC5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gdGhhdAogICAgICB9CiAgCiAgICAgIG9iai5jb3B5KHRoYXQsIDAsIDAsIGxlbikKICAgICAgcmV0dXJuIHRoYXQKICAgIH0KICAKICAgIGlmIChvYmopIHsKICAgICAgaWYgKCh0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmCiAgICAgICAgICBvYmouYnVmZmVyIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIHx8ICdsZW5ndGgnIGluIG9iaikgewogICAgICAgIGlmICh0eXBlb2Ygb2JqLmxlbmd0aCAhPT0gJ251bWJlcicgfHwgaXNuYW4ob2JqLmxlbmd0aCkpIHsKICAgICAgICAgIHJldHVybiBjcmVhdGVCdWZmZXIodGhhdCwgMCkKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZyb21BcnJheUxpa2UodGhhdCwgb2JqKQogICAgICB9CiAgCiAgICAgIGlmIChvYmoudHlwZSA9PT0gJ0J1ZmZlcicgJiYgaXNBcnJheShvYmouZGF0YSkpIHsKICAgICAgICByZXR1cm4gZnJvbUFycmF5TGlrZSh0aGF0LCBvYmouZGF0YSkKICAgICAgfQogICAgfQogIAogICAgdGhyb3cgbmV3IFR5cGVFcnJvcignRmlyc3QgYXJndW1lbnQgbXVzdCBiZSBhIHN0cmluZywgQnVmZmVyLCBBcnJheUJ1ZmZlciwgQXJyYXksIG9yIGFycmF5LWxpa2Ugb2JqZWN0LicpCiAgfQogIAogIGZ1bmN0aW9uIGNoZWNrZWQgKGxlbmd0aCkgewogICAgLy8gTm90ZTogY2Fubm90IHVzZSBgbGVuZ3RoIDwga01heExlbmd0aCgpYCBoZXJlIGJlY2F1c2UgdGhhdCBmYWlscyB3aGVuCiAgICAvLyBsZW5ndGggaXMgTmFOICh3aGljaCBpcyBvdGhlcndpc2UgY29lcmNlZCB0byB6ZXJvLikKICAgIGlmIChsZW5ndGggPj0ga01heExlbmd0aCgpKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdBdHRlbXB0IHRvIGFsbG9jYXRlIEJ1ZmZlciBsYXJnZXIgdGhhbiBtYXhpbXVtICcgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAnc2l6ZTogMHgnICsga01heExlbmd0aCgpLnRvU3RyaW5nKDE2KSArICcgYnl0ZXMnKQogICAgfQogICAgcmV0dXJuIGxlbmd0aCB8IDAKICB9CiAgCiAgZnVuY3Rpb24gU2xvd0J1ZmZlciAobGVuZ3RoKSB7CiAgICBpZiAoK2xlbmd0aCAhPSBsZW5ndGgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBlcWVxZXEKICAgICAgbGVuZ3RoID0gMAogICAgfQogICAgcmV0dXJuIEJ1ZmZlci5hbGxvYygrbGVuZ3RoKQogIH0KICAKICBCdWZmZXIuaXNCdWZmZXIgPSBmdW5jdGlvbiBpc0J1ZmZlciAoYikgewogICAgcmV0dXJuICEhKGIgIT0gbnVsbCAmJiBiLl9pc0J1ZmZlcikKICB9CiAgCiAgQnVmZmVyLmNvbXBhcmUgPSBmdW5jdGlvbiBjb21wYXJlIChhLCBiKSB7CiAgICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihhKSB8fCAhQnVmZmVyLmlzQnVmZmVyKGIpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FyZ3VtZW50cyBtdXN0IGJlIEJ1ZmZlcnMnKQogICAgfQogIAogICAgaWYgKGEgPT09IGIpIHJldHVybiAwCiAgCiAgICB2YXIgeCA9IGEubGVuZ3RoCiAgICB2YXIgeSA9IGIubGVuZ3RoCiAgCiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gTWF0aC5taW4oeCwgeSk7IGkgPCBsZW47ICsraSkgewogICAgICBpZiAoYVtpXSAhPT0gYltpXSkgewogICAgICAgIHggPSBhW2ldCiAgICAgICAgeSA9IGJbaV0KICAgICAgICBicmVhawogICAgICB9CiAgICB9CiAgCiAgICBpZiAoeCA8IHkpIHJldHVybiAtMQogICAgaWYgKHkgPCB4KSByZXR1cm4gMQogICAgcmV0dXJuIDAKICB9CiAgCiAgQnVmZmVyLmlzRW5jb2RpbmcgPSBmdW5jdGlvbiBpc0VuY29kaW5nIChlbmNvZGluZykgewogICAgc3dpdGNoIChTdHJpbmcoZW5jb2RpbmcpLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgY2FzZSAnaGV4JzoKICAgICAgY2FzZSAndXRmOCc6CiAgICAgIGNhc2UgJ3V0Zi04JzoKICAgICAgY2FzZSAnYXNjaWknOgogICAgICBjYXNlICdsYXRpbjEnOgogICAgICBjYXNlICdiaW5hcnknOgogICAgICBjYXNlICdiYXNlNjQnOgogICAgICBjYXNlICd1Y3MyJzoKICAgICAgY2FzZSAndWNzLTInOgogICAgICBjYXNlICd1dGYxNmxlJzoKICAgICAgY2FzZSAndXRmLTE2bGUnOgogICAgICAgIHJldHVybiB0cnVlCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQogIAogIEJ1ZmZlci5jb25jYXQgPSBmdW5jdGlvbiBjb25jYXQgKGxpc3QsIGxlbmd0aCkgewogICAgaWYgKCFpc0FycmF5KGxpc3QpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJsaXN0IiBhcmd1bWVudCBtdXN0IGJlIGFuIEFycmF5IG9mIEJ1ZmZlcnMnKQogICAgfQogIAogICAgaWYgKGxpc3QubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBCdWZmZXIuYWxsb2MoMCkKICAgIH0KICAKICAgIHZhciBpCiAgICBpZiAobGVuZ3RoID09PSB1bmRlZmluZWQpIHsKICAgICAgbGVuZ3RoID0gMAogICAgICBmb3IgKGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7ICsraSkgewogICAgICAgIGxlbmd0aCArPSBsaXN0W2ldLmxlbmd0aAogICAgICB9CiAgICB9CiAgCiAgICB2YXIgYnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKGxlbmd0aCkKICAgIHZhciBwb3MgPSAwCiAgICBmb3IgKGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7ICsraSkgewogICAgICB2YXIgYnVmID0gbGlzdFtpXQogICAgICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihidWYpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignImxpc3QiIGFyZ3VtZW50IG11c3QgYmUgYW4gQXJyYXkgb2YgQnVmZmVycycpCiAgICAgIH0KICAgICAgYnVmLmNvcHkoYnVmZmVyLCBwb3MpCiAgICAgIHBvcyArPSBidWYubGVuZ3RoCiAgICB9CiAgICByZXR1cm4gYnVmZmVyCiAgfQogIAogIGZ1bmN0aW9uIGJ5dGVMZW5ndGggKHN0cmluZywgZW5jb2RpbmcpIHsKICAgIGlmIChCdWZmZXIuaXNCdWZmZXIoc3RyaW5nKSkgewogICAgICByZXR1cm4gc3RyaW5nLmxlbmd0aAogICAgfQogICAgaWYgKHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIEFycmF5QnVmZmVyLmlzVmlldyA9PT0gJ2Z1bmN0aW9uJyAmJgogICAgICAgIChBcnJheUJ1ZmZlci5pc1ZpZXcoc3RyaW5nKSB8fCBzdHJpbmcgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikpIHsKICAgICAgcmV0dXJuIHN0cmluZy5ieXRlTGVuZ3RoCiAgICB9CiAgICBpZiAodHlwZW9mIHN0cmluZyAhPT0gJ3N0cmluZycpIHsKICAgICAgc3RyaW5nID0gJycgKyBzdHJpbmcKICAgIH0KICAKICAgIHZhciBsZW4gPSBzdHJpbmcubGVuZ3RoCiAgICBpZiAobGVuID09PSAwKSByZXR1cm4gMAogIAogICAgLy8gVXNlIGEgZm9yIGxvb3AgdG8gYXZvaWQgcmVjdXJzaW9uCiAgICB2YXIgbG93ZXJlZENhc2UgPSBmYWxzZQogICAgZm9yICg7OykgewogICAgICBzd2l0Y2ggKGVuY29kaW5nKSB7CiAgICAgICAgY2FzZSAnYXNjaWknOgogICAgICAgIGNhc2UgJ2xhdGluMSc6CiAgICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgICAgIHJldHVybiBsZW4KICAgICAgICBjYXNlICd1dGY4JzoKICAgICAgICBjYXNlICd1dGYtOCc6CiAgICAgICAgY2FzZSB1bmRlZmluZWQ6CiAgICAgICAgICByZXR1cm4gdXRmOFRvQnl0ZXMoc3RyaW5nKS5sZW5ndGgKICAgICAgICBjYXNlICd1Y3MyJzoKICAgICAgICBjYXNlICd1Y3MtMic6CiAgICAgICAgY2FzZSAndXRmMTZsZSc6CiAgICAgICAgY2FzZSAndXRmLTE2bGUnOgogICAgICAgICAgcmV0dXJuIGxlbiAqIDIKICAgICAgICBjYXNlICdoZXgnOgogICAgICAgICAgcmV0dXJuIGxlbiA+Pj4gMQogICAgICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgICAgICByZXR1cm4gYmFzZTY0VG9CeXRlcyhzdHJpbmcpLmxlbmd0aAogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBpZiAobG93ZXJlZENhc2UpIHJldHVybiB1dGY4VG9CeXRlcyhzdHJpbmcpLmxlbmd0aCAvLyBhc3N1bWUgdXRmOAogICAgICAgICAgZW5jb2RpbmcgPSAoJycgKyBlbmNvZGluZykudG9Mb3dlckNhc2UoKQogICAgICAgICAgbG93ZXJlZENhc2UgPSB0cnVlCiAgICAgIH0KICAgIH0KICB9CiAgQnVmZmVyLmJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoCiAgCiAgZnVuY3Rpb24gc2xvd1RvU3RyaW5nIChlbmNvZGluZywgc3RhcnQsIGVuZCkgewogICAgdmFyIGxvd2VyZWRDYXNlID0gZmFsc2UKICAKICAgIC8vIE5vIG5lZWQgdG8gdmVyaWZ5IHRoYXQgInRoaXMubGVuZ3RoIDw9IE1BWF9VSU5UMzIiIHNpbmNlIGl0J3MgYSByZWFkLW9ubHkKICAgIC8vIHByb3BlcnR5IG9mIGEgdHlwZWQgYXJyYXkuCiAgCiAgICAvLyBUaGlzIGJlaGF2ZXMgbmVpdGhlciBsaWtlIFN0cmluZyBub3IgVWludDhBcnJheSBpbiB0aGF0IHdlIHNldCBzdGFydC9lbmQKICAgIC8vIHRvIHRoZWlyIHVwcGVyL2xvd2VyIGJvdW5kcyBpZiB0aGUgdmFsdWUgcGFzc2VkIGlzIG91dCBvZiByYW5nZS4KICAgIC8vIHVuZGVmaW5lZCBpcyBoYW5kbGVkIHNwZWNpYWxseSBhcyBwZXIgRUNNQS0yNjIgNnRoIEVkaXRpb24sCiAgICAvLyBTZWN0aW9uIDEzLjMuMy43IFJ1bnRpbWUgU2VtYW50aWNzOiBLZXllZEJpbmRpbmdJbml0aWFsaXphdGlvbi4KICAgIGlmIChzdGFydCA9PT0gdW5kZWZpbmVkIHx8IHN0YXJ0IDwgMCkgewogICAgICBzdGFydCA9IDAKICAgIH0KICAgIC8vIFJldHVybiBlYXJseSBpZiBzdGFydCA+IHRoaXMubGVuZ3RoLiBEb25lIGhlcmUgdG8gcHJldmVudCBwb3RlbnRpYWwgdWludDMyCiAgICAvLyBjb2VyY2lvbiBmYWlsIGJlbG93LgogICAgaWYgKHN0YXJ0ID4gdGhpcy5sZW5ndGgpIHsKICAgICAgcmV0dXJuICcnCiAgICB9CiAgCiAgICBpZiAoZW5kID09PSB1bmRlZmluZWQgfHwgZW5kID4gdGhpcy5sZW5ndGgpIHsKICAgICAgZW5kID0gdGhpcy5sZW5ndGgKICAgIH0KICAKICAgIGlmIChlbmQgPD0gMCkgewogICAgICByZXR1cm4gJycKICAgIH0KICAKICAgIC8vIEZvcmNlIGNvZXJzaW9uIHRvIHVpbnQzMi4gVGhpcyB3aWxsIGFsc28gY29lcmNlIGZhbHNleS9OYU4gdmFsdWVzIHRvIDAuCiAgICBlbmQgPj4+PSAwCiAgICBzdGFydCA+Pj49IDAKICAKICAgIGlmIChlbmQgPD0gc3RhcnQpIHsKICAgICAgcmV0dXJuICcnCiAgICB9CiAgCiAgICBpZiAoIWVuY29kaW5nKSBlbmNvZGluZyA9ICd1dGY4JwogIAogICAgd2hpbGUgKHRydWUpIHsKICAgICAgc3dpdGNoIChlbmNvZGluZykgewogICAgICAgIGNhc2UgJ2hleCc6CiAgICAgICAgICByZXR1cm4gaGV4U2xpY2UodGhpcywgc3RhcnQsIGVuZCkKICAKICAgICAgICBjYXNlICd1dGY4JzoKICAgICAgICBjYXNlICd1dGYtOCc6CiAgICAgICAgICByZXR1cm4gdXRmOFNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCiAgCiAgICAgICAgY2FzZSAnYXNjaWknOgogICAgICAgICAgcmV0dXJuIGFzY2lpU2xpY2UodGhpcywgc3RhcnQsIGVuZCkKICAKICAgICAgICBjYXNlICdsYXRpbjEnOgogICAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgICByZXR1cm4gbGF0aW4xU2xpY2UodGhpcywgc3RhcnQsIGVuZCkKICAKICAgICAgICBjYXNlICdiYXNlNjQnOgogICAgICAgICAgcmV0dXJuIGJhc2U2NFNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCiAgCiAgICAgICAgY2FzZSAndWNzMic6CiAgICAgICAgY2FzZSAndWNzLTInOgogICAgICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgICAgIHJldHVybiB1dGYxNmxlU2xpY2UodGhpcywgc3RhcnQsIGVuZCkKICAKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgaWYgKGxvd2VyZWRDYXNlKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jb2RpbmcpCiAgICAgICAgICBlbmNvZGluZyA9IChlbmNvZGluZyArICcnKS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICBsb3dlcmVkQ2FzZSA9IHRydWUKICAgICAgfQogICAgfQogIH0KICAKICAvLyBUaGUgcHJvcGVydHkgaXMgdXNlZCBieSBgQnVmZmVyLmlzQnVmZmVyYCBhbmQgYGlzLWJ1ZmZlcmAgKGluIFNhZmFyaSA1LTcpIHRvIGRldGVjdAogIC8vIEJ1ZmZlciBpbnN0YW5jZXMuCiAgQnVmZmVyLnByb3RvdHlwZS5faXNCdWZmZXIgPSB0cnVlCiAgCiAgZnVuY3Rpb24gc3dhcCAoYiwgbiwgbSkgewogICAgdmFyIGkgPSBiW25dCiAgICBiW25dID0gYlttXQogICAgYlttXSA9IGkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5zd2FwMTYgPSBmdW5jdGlvbiBzd2FwMTYgKCkgewogICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoCiAgICBpZiAobGVuICUgMiAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2LWJpdHMnKQogICAgfQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkgKz0gMikgewogICAgICBzd2FwKHRoaXMsIGksIGkgKyAxKQogICAgfQogICAgcmV0dXJuIHRoaXMKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5zd2FwMzIgPSBmdW5jdGlvbiBzd2FwMzIgKCkgewogICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoCiAgICBpZiAobGVuICUgNCAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDMyLWJpdHMnKQogICAgfQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkgKz0gNCkgewogICAgICBzd2FwKHRoaXMsIGksIGkgKyAzKQogICAgICBzd2FwKHRoaXMsIGkgKyAxLCBpICsgMikKICAgIH0KICAgIHJldHVybiB0aGlzCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuc3dhcDY0ID0gZnVuY3Rpb24gc3dhcDY0ICgpIHsKICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aAogICAgaWYgKGxlbiAlIDggIT09IDApIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0J1ZmZlciBzaXplIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA2NC1iaXRzJykKICAgIH0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpICs9IDgpIHsKICAgICAgc3dhcCh0aGlzLCBpLCBpICsgNykKICAgICAgc3dhcCh0aGlzLCBpICsgMSwgaSArIDYpCiAgICAgIHN3YXAodGhpcywgaSArIDIsIGkgKyA1KQogICAgICBzd2FwKHRoaXMsIGkgKyAzLCBpICsgNCkKICAgIH0KICAgIHJldHVybiB0aGlzCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiB0b1N0cmluZyAoKSB7CiAgICB2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGggfCAwCiAgICBpZiAobGVuZ3RoID09PSAwKSByZXR1cm4gJycKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSByZXR1cm4gdXRmOFNsaWNlKHRoaXMsIDAsIGxlbmd0aCkKICAgIHJldHVybiBzbG93VG9TdHJpbmcuYXBwbHkodGhpcywgYXJndW1lbnRzKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uIGVxdWFscyAoYikgewogICAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYikpIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXInKQogICAgaWYgKHRoaXMgPT09IGIpIHJldHVybiB0cnVlCiAgICByZXR1cm4gQnVmZmVyLmNvbXBhcmUodGhpcywgYikgPT09IDAKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5pbnNwZWN0ID0gZnVuY3Rpb24gaW5zcGVjdCAoKSB7CiAgICB2YXIgc3RyID0gJycKICAgIHZhciBtYXggPSBleHBvcnRzLklOU1BFQ1RfTUFYX0JZVEVTCiAgICBpZiAodGhpcy5sZW5ndGggPiAwKSB7CiAgICAgIHN0ciA9IHRoaXMudG9TdHJpbmcoJ2hleCcsIDAsIG1heCkubWF0Y2goLy57Mn0vZykuam9pbignICcpCiAgICAgIGlmICh0aGlzLmxlbmd0aCA+IG1heCkgc3RyICs9ICcgLi4uICcKICAgIH0KICAgIHJldHVybiAnPEJ1ZmZlciAnICsgc3RyICsgJz4nCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuY29tcGFyZSA9IGZ1bmN0aW9uIGNvbXBhcmUgKHRhcmdldCwgc3RhcnQsIGVuZCwgdGhpc1N0YXJ0LCB0aGlzRW5kKSB7CiAgICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcih0YXJnZXQpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXInKQogICAgfQogIAogICAgaWYgKHN0YXJ0ID09PSB1bmRlZmluZWQpIHsKICAgICAgc3RhcnQgPSAwCiAgICB9CiAgICBpZiAoZW5kID09PSB1bmRlZmluZWQpIHsKICAgICAgZW5kID0gdGFyZ2V0ID8gdGFyZ2V0Lmxlbmd0aCA6IDAKICAgIH0KICAgIGlmICh0aGlzU3RhcnQgPT09IHVuZGVmaW5lZCkgewogICAgICB0aGlzU3RhcnQgPSAwCiAgICB9CiAgICBpZiAodGhpc0VuZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHRoaXNFbmQgPSB0aGlzLmxlbmd0aAogICAgfQogIAogICAgaWYgKHN0YXJ0IDwgMCB8fCBlbmQgPiB0YXJnZXQubGVuZ3RoIHx8IHRoaXNTdGFydCA8IDAgfHwgdGhpc0VuZCA+IHRoaXMubGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdvdXQgb2YgcmFuZ2UgaW5kZXgnKQogICAgfQogIAogICAgaWYgKHRoaXNTdGFydCA+PSB0aGlzRW5kICYmIHN0YXJ0ID49IGVuZCkgewogICAgICByZXR1cm4gMAogICAgfQogICAgaWYgKHRoaXNTdGFydCA+PSB0aGlzRW5kKSB7CiAgICAgIHJldHVybiAtMQogICAgfQogICAgaWYgKHN0YXJ0ID49IGVuZCkgewogICAgICByZXR1cm4gMQogICAgfQogIAogICAgc3RhcnQgPj4+PSAwCiAgICBlbmQgPj4+PSAwCiAgICB0aGlzU3RhcnQgPj4+PSAwCiAgICB0aGlzRW5kID4+Pj0gMAogIAogICAgaWYgKHRoaXMgPT09IHRhcmdldCkgcmV0dXJuIDAKICAKICAgIHZhciB4ID0gdGhpc0VuZCAtIHRoaXNTdGFydAogICAgdmFyIHkgPSBlbmQgLSBzdGFydAogICAgdmFyIGxlbiA9IE1hdGgubWluKHgsIHkpCiAgCiAgICB2YXIgdGhpc0NvcHkgPSB0aGlzLnNsaWNlKHRoaXNTdGFydCwgdGhpc0VuZCkKICAgIHZhciB0YXJnZXRDb3B5ID0gdGFyZ2V0LnNsaWNlKHN0YXJ0LCBlbmQpCiAgCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIGlmICh0aGlzQ29weVtpXSAhPT0gdGFyZ2V0Q29weVtpXSkgewogICAgICAgIHggPSB0aGlzQ29weVtpXQogICAgICAgIHkgPSB0YXJnZXRDb3B5W2ldCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQogIAogICAgaWYgKHggPCB5KSByZXR1cm4gLTEKICAgIGlmICh5IDwgeCkgcmV0dXJuIDEKICAgIHJldHVybiAwCiAgfQogIAogIC8vIEZpbmRzIGVpdGhlciB0aGUgZmlyc3QgaW5kZXggb2YgYHZhbGAgaW4gYGJ1ZmZlcmAgYXQgb2Zmc2V0ID49IGBieXRlT2Zmc2V0YCwKICAvLyBPUiB0aGUgbGFzdCBpbmRleCBvZiBgdmFsYCBpbiBgYnVmZmVyYCBhdCBvZmZzZXQgPD0gYGJ5dGVPZmZzZXRgLgogIC8vCiAgLy8gQXJndW1lbnRzOgogIC8vIC0gYnVmZmVyIC0gYSBCdWZmZXIgdG8gc2VhcmNoCiAgLy8gLSB2YWwgLSBhIHN0cmluZywgQnVmZmVyLCBvciBudW1iZXIKICAvLyAtIGJ5dGVPZmZzZXQgLSBhbiBpbmRleCBpbnRvIGBidWZmZXJgOyB3aWxsIGJlIGNsYW1wZWQgdG8gYW4gaW50MzIKICAvLyAtIGVuY29kaW5nIC0gYW4gb3B0aW9uYWwgZW5jb2RpbmcsIHJlbGV2YW50IGlzIHZhbCBpcyBhIHN0cmluZwogIC8vIC0gZGlyIC0gdHJ1ZSBmb3IgaW5kZXhPZiwgZmFsc2UgZm9yIGxhc3RJbmRleE9mCiAgZnVuY3Rpb24gYmlkaXJlY3Rpb25hbEluZGV4T2YgKGJ1ZmZlciwgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZGlyKSB7CiAgICAvLyBFbXB0eSBidWZmZXIgbWVhbnMgbm8gbWF0Y2gKICAgIGlmIChidWZmZXIubGVuZ3RoID09PSAwKSByZXR1cm4gLTEKICAKICAgIC8vIE5vcm1hbGl6ZSBieXRlT2Zmc2V0CiAgICBpZiAodHlwZW9mIGJ5dGVPZmZzZXQgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gYnl0ZU9mZnNldAogICAgICBieXRlT2Zmc2V0ID0gMAogICAgfSBlbHNlIGlmIChieXRlT2Zmc2V0ID4gMHg3ZmZmZmZmZikgewogICAgICBieXRlT2Zmc2V0ID0gMHg3ZmZmZmZmZgogICAgfSBlbHNlIGlmIChieXRlT2Zmc2V0IDwgLTB4ODAwMDAwMDApIHsKICAgICAgYnl0ZU9mZnNldCA9IC0weDgwMDAwMDAwCiAgICB9CiAgICBieXRlT2Zmc2V0ID0gK2J5dGVPZmZzZXQgIC8vIENvZXJjZSB0byBOdW1iZXIuCiAgICBpZiAoaXNOYU4oYnl0ZU9mZnNldCkpIHsKICAgICAgLy8gYnl0ZU9mZnNldDogaXQgaXQncyB1bmRlZmluZWQsIG51bGwsIE5hTiwgImZvbyIsIGV0Yywgc2VhcmNoIHdob2xlIGJ1ZmZlcgogICAgICBieXRlT2Zmc2V0ID0gZGlyID8gMCA6IChidWZmZXIubGVuZ3RoIC0gMSkKICAgIH0KICAKICAgIC8vIE5vcm1hbGl6ZSBieXRlT2Zmc2V0OiBuZWdhdGl2ZSBvZmZzZXRzIHN0YXJ0IGZyb20gdGhlIGVuZCBvZiB0aGUgYnVmZmVyCiAgICBpZiAoYnl0ZU9mZnNldCA8IDApIGJ5dGVPZmZzZXQgPSBidWZmZXIubGVuZ3RoICsgYnl0ZU9mZnNldAogICAgaWYgKGJ5dGVPZmZzZXQgPj0gYnVmZmVyLmxlbmd0aCkgewogICAgICBpZiAoZGlyKSByZXR1cm4gLTEKICAgICAgZWxzZSBieXRlT2Zmc2V0ID0gYnVmZmVyLmxlbmd0aCAtIDEKICAgIH0gZWxzZSBpZiAoYnl0ZU9mZnNldCA8IDApIHsKICAgICAgaWYgKGRpcikgYnl0ZU9mZnNldCA9IDAKICAgICAgZWxzZSByZXR1cm4gLTEKICAgIH0KICAKICAgIC8vIE5vcm1hbGl6ZSB2YWwKICAgIGlmICh0eXBlb2YgdmFsID09PSAnc3RyaW5nJykgewogICAgICB2YWwgPSBCdWZmZXIuZnJvbSh2YWwsIGVuY29kaW5nKQogICAgfQogIAogICAgLy8gRmluYWxseSwgc2VhcmNoIGVpdGhlciBpbmRleE9mIChpZiBkaXIgaXMgdHJ1ZSkgb3IgbGFzdEluZGV4T2YKICAgIGlmIChCdWZmZXIuaXNCdWZmZXIodmFsKSkgewogICAgICAvLyBTcGVjaWFsIGNhc2U6IGxvb2tpbmcgZm9yIGVtcHR5IHN0cmluZy9idWZmZXIgYWx3YXlzIGZhaWxzCiAgICAgIGlmICh2YWwubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIC0xCiAgICAgIH0KICAgICAgcmV0dXJuIGFycmF5SW5kZXhPZihidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGRpcikKICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpIHsKICAgICAgdmFsID0gdmFsICYgMHhGRiAvLyBTZWFyY2ggZm9yIGEgYnl0ZSB2YWx1ZSBbMC0yNTVdCiAgICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCAmJgogICAgICAgICAgdHlwZW9mIFVpbnQ4QXJyYXkucHJvdG90eXBlLmluZGV4T2YgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBpZiAoZGlyKSB7CiAgICAgICAgICByZXR1cm4gVWludDhBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGJ1ZmZlciwgdmFsLCBieXRlT2Zmc2V0KQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gVWludDhBcnJheS5wcm90b3R5cGUubGFzdEluZGV4T2YuY2FsbChidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCkKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGFycmF5SW5kZXhPZihidWZmZXIsIFsgdmFsIF0sIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCBkaXIpCiAgICB9CiAgCiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCd2YWwgbXVzdCBiZSBzdHJpbmcsIG51bWJlciBvciBCdWZmZXInKQogIH0KICAKICBmdW5jdGlvbiBhcnJheUluZGV4T2YgKGFyciwgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZGlyKSB7CiAgICB2YXIgaW5kZXhTaXplID0gMQogICAgdmFyIGFyckxlbmd0aCA9IGFyci5sZW5ndGgKICAgIHZhciB2YWxMZW5ndGggPSB2YWwubGVuZ3RoCiAgCiAgICBpZiAoZW5jb2RpbmcgIT09IHVuZGVmaW5lZCkgewogICAgICBlbmNvZGluZyA9IFN0cmluZyhlbmNvZGluZykudG9Mb3dlckNhc2UoKQogICAgICBpZiAoZW5jb2RpbmcgPT09ICd1Y3MyJyB8fCBlbmNvZGluZyA9PT0gJ3Vjcy0yJyB8fAogICAgICAgICAgZW5jb2RpbmcgPT09ICd1dGYxNmxlJyB8fCBlbmNvZGluZyA9PT0gJ3V0Zi0xNmxlJykgewogICAgICAgIGlmIChhcnIubGVuZ3RoIDwgMiB8fCB2YWwubGVuZ3RoIDwgMikgewogICAgICAgICAgcmV0dXJuIC0xCiAgICAgICAgfQogICAgICAgIGluZGV4U2l6ZSA9IDIKICAgICAgICBhcnJMZW5ndGggLz0gMgogICAgICAgIHZhbExlbmd0aCAvPSAyCiAgICAgICAgYnl0ZU9mZnNldCAvPSAyCiAgICAgIH0KICAgIH0KICAKICAgIGZ1bmN0aW9uIHJlYWQgKGJ1ZiwgaSkgewogICAgICBpZiAoaW5kZXhTaXplID09PSAxKSB7CiAgICAgICAgcmV0dXJuIGJ1ZltpXQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBidWYucmVhZFVJbnQxNkJFKGkgKiBpbmRleFNpemUpCiAgICAgIH0KICAgIH0KICAKICAgIHZhciBpCiAgICBpZiAoZGlyKSB7CiAgICAgIHZhciBmb3VuZEluZGV4ID0gLTEKICAgICAgZm9yIChpID0gYnl0ZU9mZnNldDsgaSA8IGFyckxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHJlYWQoYXJyLCBpKSA9PT0gcmVhZCh2YWwsIGZvdW5kSW5kZXggPT09IC0xID8gMCA6IGkgLSBmb3VuZEluZGV4KSkgewogICAgICAgICAgaWYgKGZvdW5kSW5kZXggPT09IC0xKSBmb3VuZEluZGV4ID0gaQogICAgICAgICAgaWYgKGkgLSBmb3VuZEluZGV4ICsgMSA9PT0gdmFsTGVuZ3RoKSByZXR1cm4gZm91bmRJbmRleCAqIGluZGV4U2l6ZQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoZm91bmRJbmRleCAhPT0gLTEpIGkgLT0gaSAtIGZvdW5kSW5kZXgKICAgICAgICAgIGZvdW5kSW5kZXggPSAtMQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGJ5dGVPZmZzZXQgKyB2YWxMZW5ndGggPiBhcnJMZW5ndGgpIGJ5dGVPZmZzZXQgPSBhcnJMZW5ndGggLSB2YWxMZW5ndGgKICAgICAgZm9yIChpID0gYnl0ZU9mZnNldDsgaSA+PSAwOyBpLS0pIHsKICAgICAgICB2YXIgZm91bmQgPSB0cnVlCiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB2YWxMZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKHJlYWQoYXJyLCBpICsgaikgIT09IHJlYWQodmFsLCBqKSkgewogICAgICAgICAgICBmb3VuZCA9IGZhbHNlCiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChmb3VuZCkgcmV0dXJuIGkKICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIC0xCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuaW5jbHVkZXMgPSBmdW5jdGlvbiBpbmNsdWRlcyAodmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgewogICAgcmV0dXJuIHRoaXMuaW5kZXhPZih2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKSAhPT0gLTEKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5pbmRleE9mID0gZnVuY3Rpb24gaW5kZXhPZiAodmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgewogICAgcmV0dXJuIGJpZGlyZWN0aW9uYWxJbmRleE9mKHRoaXMsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIHRydWUpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUubGFzdEluZGV4T2YgPSBmdW5jdGlvbiBsYXN0SW5kZXhPZiAodmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgewogICAgcmV0dXJuIGJpZGlyZWN0aW9uYWxJbmRleE9mKHRoaXMsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGZhbHNlKQogIH0KICAKICBmdW5jdGlvbiBoZXhXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgICBvZmZzZXQgPSBOdW1iZXIob2Zmc2V0KSB8fCAwCiAgICB2YXIgcmVtYWluaW5nID0gYnVmLmxlbmd0aCAtIG9mZnNldAogICAgaWYgKCFsZW5ndGgpIHsKICAgICAgbGVuZ3RoID0gcmVtYWluaW5nCiAgICB9IGVsc2UgewogICAgICBsZW5ndGggPSBOdW1iZXIobGVuZ3RoKQogICAgICBpZiAobGVuZ3RoID4gcmVtYWluaW5nKSB7CiAgICAgICAgbGVuZ3RoID0gcmVtYWluaW5nCiAgICAgIH0KICAgIH0KICAKICAgIC8vIG11c3QgYmUgYW4gZXZlbiBudW1iZXIgb2YgZGlnaXRzCiAgICB2YXIgc3RyTGVuID0gc3RyaW5nLmxlbmd0aAogICAgaWYgKHN0ckxlbiAlIDIgIT09IDApIHRocm93IG5ldyBUeXBlRXJyb3IoJ0ludmFsaWQgaGV4IHN0cmluZycpCiAgCiAgICBpZiAobGVuZ3RoID4gc3RyTGVuIC8gMikgewogICAgICBsZW5ndGggPSBzdHJMZW4gLyAyCiAgICB9CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBwYXJzZWQgPSBwYXJzZUludChzdHJpbmcuc3Vic3RyKGkgKiAyLCAyKSwgMTYpCiAgICAgIGlmIChpc05hTihwYXJzZWQpKSByZXR1cm4gaQogICAgICBidWZbb2Zmc2V0ICsgaV0gPSBwYXJzZWQKICAgIH0KICAgIHJldHVybiBpCiAgfQogIAogIGZ1bmN0aW9uIHV0ZjhXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gYmxpdEJ1ZmZlcih1dGY4VG9CeXRlcyhzdHJpbmcsIGJ1Zi5sZW5ndGggLSBvZmZzZXQpLCBidWYsIG9mZnNldCwgbGVuZ3RoKQogIH0KICAKICBmdW5jdGlvbiBhc2NpaVdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIHJldHVybiBibGl0QnVmZmVyKGFzY2lpVG9CeXRlcyhzdHJpbmcpLCBidWYsIG9mZnNldCwgbGVuZ3RoKQogIH0KICAKICBmdW5jdGlvbiBsYXRpbjFXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gYXNjaWlXcml0ZShidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgfQogIAogIGZ1bmN0aW9uIGJhc2U2NFdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIHJldHVybiBibGl0QnVmZmVyKGJhc2U2NFRvQnl0ZXMoc3RyaW5nKSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKICB9CiAgCiAgZnVuY3Rpb24gdWNzMldyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIHJldHVybiBibGl0QnVmZmVyKHV0ZjE2bGVUb0J5dGVzKHN0cmluZywgYnVmLmxlbmd0aCAtIG9mZnNldCksIGJ1Ziwgb2Zmc2V0LCBsZW5ndGgpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbiB3cml0ZSAoc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCwgZW5jb2RpbmcpIHsKICAgIC8vIEJ1ZmZlciN3cml0ZShzdHJpbmcpCiAgICBpZiAob2Zmc2V0ID09PSB1bmRlZmluZWQpIHsKICAgICAgZW5jb2RpbmcgPSAndXRmOCcKICAgICAgbGVuZ3RoID0gdGhpcy5sZW5ndGgKICAgICAgb2Zmc2V0ID0gMAogICAgLy8gQnVmZmVyI3dyaXRlKHN0cmluZywgZW5jb2RpbmcpCiAgICB9IGVsc2UgaWYgKGxlbmd0aCA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiBvZmZzZXQgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gb2Zmc2V0CiAgICAgIGxlbmd0aCA9IHRoaXMubGVuZ3RoCiAgICAgIG9mZnNldCA9IDAKICAgIC8vIEJ1ZmZlciN3cml0ZShzdHJpbmcsIG9mZnNldFssIGxlbmd0aF1bLCBlbmNvZGluZ10pCiAgICB9IGVsc2UgaWYgKGlzRmluaXRlKG9mZnNldCkpIHsKICAgICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgICBpZiAoaXNGaW5pdGUobGVuZ3RoKSkgewogICAgICAgIGxlbmd0aCA9IGxlbmd0aCB8IDAKICAgICAgICBpZiAoZW5jb2RpbmcgPT09IHVuZGVmaW5lZCkgZW5jb2RpbmcgPSAndXRmOCcKICAgICAgfSBlbHNlIHsKICAgICAgICBlbmNvZGluZyA9IGxlbmd0aAogICAgICAgIGxlbmd0aCA9IHVuZGVmaW5lZAogICAgICB9CiAgICAvLyBsZWdhY3kgd3JpdGUoc3RyaW5nLCBlbmNvZGluZywgb2Zmc2V0LCBsZW5ndGgpIC0gcmVtb3ZlIGluIHYwLjEzCiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgJ0J1ZmZlci53cml0ZShzdHJpbmcsIGVuY29kaW5nLCBvZmZzZXRbLCBsZW5ndGhdKSBpcyBubyBsb25nZXIgc3VwcG9ydGVkJwogICAgICApCiAgICB9CiAgCiAgICB2YXIgcmVtYWluaW5nID0gdGhpcy5sZW5ndGggLSBvZmZzZXQKICAgIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCB8fCBsZW5ndGggPiByZW1haW5pbmcpIGxlbmd0aCA9IHJlbWFpbmluZwogIAogICAgaWYgKChzdHJpbmcubGVuZ3RoID4gMCAmJiAobGVuZ3RoIDwgMCB8fCBvZmZzZXQgPCAwKSkgfHwgb2Zmc2V0ID4gdGhpcy5sZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0F0dGVtcHQgdG8gd3JpdGUgb3V0c2lkZSBidWZmZXIgYm91bmRzJykKICAgIH0KICAKICAgIGlmICghZW5jb2RpbmcpIGVuY29kaW5nID0gJ3V0ZjgnCiAgCiAgICB2YXIgbG93ZXJlZENhc2UgPSBmYWxzZQogICAgZm9yICg7OykgewogICAgICBzd2l0Y2ggKGVuY29kaW5nKSB7CiAgICAgICAgY2FzZSAnaGV4JzoKICAgICAgICAgIHJldHVybiBoZXhXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogIAogICAgICAgIGNhc2UgJ3V0ZjgnOgogICAgICAgIGNhc2UgJ3V0Zi04JzoKICAgICAgICAgIHJldHVybiB1dGY4V3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKICAKICAgICAgICBjYXNlICdhc2NpaSc6CiAgICAgICAgICByZXR1cm4gYXNjaWlXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogIAogICAgICAgIGNhc2UgJ2xhdGluMSc6CiAgICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgICAgIHJldHVybiBsYXRpbjFXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogIAogICAgICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgICAgICAvLyBXYXJuaW5nOiBtYXhMZW5ndGggbm90IHRha2VuIGludG8gYWNjb3VudCBpbiBiYXNlNjRXcml0ZQogICAgICAgICAgcmV0dXJuIGJhc2U2NFdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgCiAgICAgICAgY2FzZSAndWNzMic6CiAgICAgICAgY2FzZSAndWNzLTInOgogICAgICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgICAgIHJldHVybiB1Y3MyV3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKICAKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgaWYgKGxvd2VyZWRDYXNlKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jb2RpbmcpCiAgICAgICAgICBlbmNvZGluZyA9ICgnJyArIGVuY29kaW5nKS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICBsb3dlcmVkQ2FzZSA9IHRydWUKICAgICAgfQogICAgfQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uIHRvSlNPTiAoKSB7CiAgICByZXR1cm4gewogICAgICB0eXBlOiAnQnVmZmVyJywKICAgICAgZGF0YTogQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcy5fYXJyIHx8IHRoaXMsIDApCiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGJhc2U2NFNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICAgIGlmIChzdGFydCA9PT0gMCAmJiBlbmQgPT09IGJ1Zi5sZW5ndGgpIHsKICAgICAgcmV0dXJuIGJhc2U2NC5mcm9tQnl0ZUFycmF5KGJ1ZikKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBiYXNlNjQuZnJvbUJ5dGVBcnJheShidWYuc2xpY2Uoc3RhcnQsIGVuZCkpCiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIHV0ZjhTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgICBlbmQgPSBNYXRoLm1pbihidWYubGVuZ3RoLCBlbmQpCiAgICB2YXIgcmVzID0gW10KICAKICAgIHZhciBpID0gc3RhcnQKICAgIHdoaWxlIChpIDwgZW5kKSB7CiAgICAgIHZhciBmaXJzdEJ5dGUgPSBidWZbaV0KICAgICAgdmFyIGNvZGVQb2ludCA9IG51bGwKICAgICAgdmFyIGJ5dGVzUGVyU2VxdWVuY2UgPSAoZmlyc3RCeXRlID4gMHhFRikgPyA0CiAgICAgICAgOiAoZmlyc3RCeXRlID4gMHhERikgPyAzCiAgICAgICAgOiAoZmlyc3RCeXRlID4gMHhCRikgPyAyCiAgICAgICAgOiAxCiAgCiAgICAgIGlmIChpICsgYnl0ZXNQZXJTZXF1ZW5jZSA8PSBlbmQpIHsKICAgICAgICB2YXIgc2Vjb25kQnl0ZSwgdGhpcmRCeXRlLCBmb3VydGhCeXRlLCB0ZW1wQ29kZVBvaW50CiAgCiAgICAgICAgc3dpdGNoIChieXRlc1BlclNlcXVlbmNlKSB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIGlmIChmaXJzdEJ5dGUgPCAweDgwKSB7CiAgICAgICAgICAgICAgY29kZVBvaW50ID0gZmlyc3RCeXRlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgc2Vjb25kQnl0ZSA9IGJ1ZltpICsgMV0KICAgICAgICAgICAgaWYgKChzZWNvbmRCeXRlICYgMHhDMCkgPT09IDB4ODApIHsKICAgICAgICAgICAgICB0ZW1wQ29kZVBvaW50ID0gKGZpcnN0Qnl0ZSAmIDB4MUYpIDw8IDB4NiB8IChzZWNvbmRCeXRlICYgMHgzRikKICAgICAgICAgICAgICBpZiAodGVtcENvZGVQb2ludCA+IDB4N0YpIHsKICAgICAgICAgICAgICAgIGNvZGVQb2ludCA9IHRlbXBDb2RlUG9pbnQKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgc2Vjb25kQnl0ZSA9IGJ1ZltpICsgMV0KICAgICAgICAgICAgdGhpcmRCeXRlID0gYnVmW2kgKyAyXQogICAgICAgICAgICBpZiAoKHNlY29uZEJ5dGUgJiAweEMwKSA9PT0gMHg4MCAmJiAodGhpcmRCeXRlICYgMHhDMCkgPT09IDB4ODApIHsKICAgICAgICAgICAgICB0ZW1wQ29kZVBvaW50ID0gKGZpcnN0Qnl0ZSAmIDB4RikgPDwgMHhDIHwgKHNlY29uZEJ5dGUgJiAweDNGKSA8PCAweDYgfCAodGhpcmRCeXRlICYgMHgzRikKICAgICAgICAgICAgICBpZiAodGVtcENvZGVQb2ludCA+IDB4N0ZGICYmICh0ZW1wQ29kZVBvaW50IDwgMHhEODAwIHx8IHRlbXBDb2RlUG9pbnQgPiAweERGRkYpKSB7CiAgICAgICAgICAgICAgICBjb2RlUG9pbnQgPSB0ZW1wQ29kZVBvaW50CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgIHNlY29uZEJ5dGUgPSBidWZbaSArIDFdCiAgICAgICAgICAgIHRoaXJkQnl0ZSA9IGJ1ZltpICsgMl0KICAgICAgICAgICAgZm91cnRoQnl0ZSA9IGJ1ZltpICsgM10KICAgICAgICAgICAgaWYgKChzZWNvbmRCeXRlICYgMHhDMCkgPT09IDB4ODAgJiYgKHRoaXJkQnl0ZSAmIDB4QzApID09PSAweDgwICYmIChmb3VydGhCeXRlICYgMHhDMCkgPT09IDB4ODApIHsKICAgICAgICAgICAgICB0ZW1wQ29kZVBvaW50ID0gKGZpcnN0Qnl0ZSAmIDB4RikgPDwgMHgxMiB8IChzZWNvbmRCeXRlICYgMHgzRikgPDwgMHhDIHwgKHRoaXJkQnl0ZSAmIDB4M0YpIDw8IDB4NiB8IChmb3VydGhCeXRlICYgMHgzRikKICAgICAgICAgICAgICBpZiAodGVtcENvZGVQb2ludCA+IDB4RkZGRiAmJiB0ZW1wQ29kZVBvaW50IDwgMHgxMTAwMDApIHsKICAgICAgICAgICAgICAgIGNvZGVQb2ludCA9IHRlbXBDb2RlUG9pbnQKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAKICAgICAgaWYgKGNvZGVQb2ludCA9PT0gbnVsbCkgewogICAgICAgIC8vIHdlIGRpZCBub3QgZ2VuZXJhdGUgYSB2YWxpZCBjb2RlUG9pbnQgc28gaW5zZXJ0IGEKICAgICAgICAvLyByZXBsYWNlbWVudCBjaGFyIChVK0ZGRkQpIGFuZCBhZHZhbmNlIG9ubHkgMSBieXRlCiAgICAgICAgY29kZVBvaW50ID0gMHhGRkZECiAgICAgICAgYnl0ZXNQZXJTZXF1ZW5jZSA9IDEKICAgICAgfSBlbHNlIGlmIChjb2RlUG9pbnQgPiAweEZGRkYpIHsKICAgICAgICAvLyBlbmNvZGUgdG8gdXRmMTYgKHN1cnJvZ2F0ZSBwYWlyIGRhbmNlKQogICAgICAgIGNvZGVQb2ludCAtPSAweDEwMDAwCiAgICAgICAgcmVzLnB1c2goY29kZVBvaW50ID4+PiAxMCAmIDB4M0ZGIHwgMHhEODAwKQogICAgICAgIGNvZGVQb2ludCA9IDB4REMwMCB8IGNvZGVQb2ludCAmIDB4M0ZGCiAgICAgIH0KICAKICAgICAgcmVzLnB1c2goY29kZVBvaW50KQogICAgICBpICs9IGJ5dGVzUGVyU2VxdWVuY2UKICAgIH0KICAKICAgIHJldHVybiBkZWNvZGVDb2RlUG9pbnRzQXJyYXkocmVzKQogIH0KICAKICAvLyBCYXNlZCBvbiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS8yMjc0NzI3Mi82ODA3NDIsIHRoZSBicm93c2VyIHdpdGgKICAvLyB0aGUgbG93ZXN0IGxpbWl0IGlzIENocm9tZSwgd2l0aCAweDEwMDAwIGFyZ3MuCiAgLy8gV2UgZ28gMSBtYWduaXR1ZGUgbGVzcywgZm9yIHNhZmV0eQogIHZhciBNQVhfQVJHVU1FTlRTX0xFTkdUSCA9IDB4MTAwMAogIAogIGZ1bmN0aW9uIGRlY29kZUNvZGVQb2ludHNBcnJheSAoY29kZVBvaW50cykgewogICAgdmFyIGxlbiA9IGNvZGVQb2ludHMubGVuZ3RoCiAgICBpZiAobGVuIDw9IE1BWF9BUkdVTUVOVFNfTEVOR1RIKSB7CiAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZywgY29kZVBvaW50cykgLy8gYXZvaWQgZXh0cmEgc2xpY2UoKQogICAgfQogIAogICAgLy8gRGVjb2RlIGluIGNodW5rcyB0byBhdm9pZCAiY2FsbCBzdGFjayBzaXplIGV4Y2VlZGVkIi4KICAgIHZhciByZXMgPSAnJwogICAgdmFyIGkgPSAwCiAgICB3aGlsZSAoaSA8IGxlbikgewogICAgICByZXMgKz0gU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseSgKICAgICAgICBTdHJpbmcsCiAgICAgICAgY29kZVBvaW50cy5zbGljZShpLCBpICs9IE1BWF9BUkdVTUVOVFNfTEVOR1RIKQogICAgICApCiAgICB9CiAgICByZXR1cm4gcmVzCiAgfQogIAogIGZ1bmN0aW9uIGFzY2lpU2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogICAgdmFyIHJldCA9ICcnCiAgICBlbmQgPSBNYXRoLm1pbihidWYubGVuZ3RoLCBlbmQpCiAgCiAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7ICsraSkgewogICAgICByZXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShidWZbaV0gJiAweDdGKQogICAgfQogICAgcmV0dXJuIHJldAogIH0KICAKICBmdW5jdGlvbiBsYXRpbjFTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgICB2YXIgcmV0ID0gJycKICAgIGVuZCA9IE1hdGgubWluKGJ1Zi5sZW5ndGgsIGVuZCkKICAKICAgIGZvciAodmFyIGkgPSBzdGFydDsgaSA8IGVuZDsgKytpKSB7CiAgICAgIHJldCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ1ZltpXSkKICAgIH0KICAgIHJldHVybiByZXQKICB9CiAgCiAgZnVuY3Rpb24gaGV4U2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogICAgdmFyIGxlbiA9IGJ1Zi5sZW5ndGgKICAKICAgIGlmICghc3RhcnQgfHwgc3RhcnQgPCAwKSBzdGFydCA9IDAKICAgIGlmICghZW5kIHx8IGVuZCA8IDAgfHwgZW5kID4gbGVuKSBlbmQgPSBsZW4KICAKICAgIHZhciBvdXQgPSAnJwogICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgZW5kOyArK2kpIHsKICAgICAgb3V0ICs9IHRvSGV4KGJ1ZltpXSkKICAgIH0KICAgIHJldHVybiBvdXQKICB9CiAgCiAgZnVuY3Rpb24gdXRmMTZsZVNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICAgIHZhciBieXRlcyA9IGJ1Zi5zbGljZShzdGFydCwgZW5kKQogICAgdmFyIHJlcyA9ICcnCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGJ5dGVzLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgIHJlcyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ5dGVzW2ldICsgYnl0ZXNbaSArIDFdICogMjU2KQogICAgfQogICAgcmV0dXJuIHJlcwogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnNsaWNlID0gZnVuY3Rpb24gc2xpY2UgKHN0YXJ0LCBlbmQpIHsKICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aAogICAgc3RhcnQgPSB+fnN0YXJ0CiAgICBlbmQgPSBlbmQgPT09IHVuZGVmaW5lZCA/IGxlbiA6IH5+ZW5kCiAgCiAgICBpZiAoc3RhcnQgPCAwKSB7CiAgICAgIHN0YXJ0ICs9IGxlbgogICAgICBpZiAoc3RhcnQgPCAwKSBzdGFydCA9IDAKICAgIH0gZWxzZSBpZiAoc3RhcnQgPiBsZW4pIHsKICAgICAgc3RhcnQgPSBsZW4KICAgIH0KICAKICAgIGlmIChlbmQgPCAwKSB7CiAgICAgIGVuZCArPSBsZW4KICAgICAgaWYgKGVuZCA8IDApIGVuZCA9IDAKICAgIH0gZWxzZSBpZiAoZW5kID4gbGVuKSB7CiAgICAgIGVuZCA9IGxlbgogICAgfQogIAogICAgaWYgKGVuZCA8IHN0YXJ0KSBlbmQgPSBzdGFydAogIAogICAgdmFyIG5ld0J1ZgogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIG5ld0J1ZiA9IHRoaXMuc3ViYXJyYXkoc3RhcnQsIGVuZCkKICAgICAgbmV3QnVmLl9fcHJvdG9fXyA9IEJ1ZmZlci5wcm90b3R5cGUKICAgIH0gZWxzZSB7CiAgICAgIHZhciBzbGljZUxlbiA9IGVuZCAtIHN0YXJ0CiAgICAgIG5ld0J1ZiA9IG5ldyBCdWZmZXIoc2xpY2VMZW4sIHVuZGVmaW5lZCkKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzbGljZUxlbjsgKytpKSB7CiAgICAgICAgbmV3QnVmW2ldID0gdGhpc1tpICsgc3RhcnRdCiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiBuZXdCdWYKICB9CiAgCiAgLyoKICAgKiBOZWVkIHRvIG1ha2Ugc3VyZSB0aGF0IGJ1ZmZlciBpc24ndCB0cnlpbmcgdG8gd3JpdGUgb3V0IG9mIGJvdW5kcy4KICAgKi8KICBmdW5jdGlvbiBjaGVja09mZnNldCAob2Zmc2V0LCBleHQsIGxlbmd0aCkgewogICAgaWYgKChvZmZzZXQgJSAxKSAhPT0gMCB8fCBvZmZzZXQgPCAwKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignb2Zmc2V0IGlzIG5vdCB1aW50JykKICAgIGlmIChvZmZzZXQgKyBleHQgPiBsZW5ndGgpIHRocm93IG5ldyBSYW5nZUVycm9yKCdUcnlpbmcgdG8gYWNjZXNzIGJleW9uZCBidWZmZXIgbGVuZ3RoJykKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludExFID0gZnVuY3Rpb24gcmVhZFVJbnRMRSAob2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIGJ5dGVMZW5ndGgsIHRoaXMubGVuZ3RoKQogIAogICAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0XQogICAgdmFyIG11bCA9IDEKICAgIHZhciBpID0gMAogICAgd2hpbGUgKCsraSA8IGJ5dGVMZW5ndGggJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgdmFsICs9IHRoaXNbb2Zmc2V0ICsgaV0gKiBtdWwKICAgIH0KICAKICAgIHJldHVybiB2YWwKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludEJFID0gZnVuY3Rpb24gcmVhZFVJbnRCRSAob2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgYnl0ZUxlbmd0aCwgdGhpcy5sZW5ndGgpCiAgICB9CiAgCiAgICB2YXIgdmFsID0gdGhpc1tvZmZzZXQgKyAtLWJ5dGVMZW5ndGhdCiAgICB2YXIgbXVsID0gMQogICAgd2hpbGUgKGJ5dGVMZW5ndGggPiAwICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICAgIHZhbCArPSB0aGlzW29mZnNldCArIC0tYnl0ZUxlbmd0aF0gKiBtdWwKICAgIH0KICAKICAgIHJldHVybiB2YWwKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDggPSBmdW5jdGlvbiByZWFkVUludDggKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMSwgdGhpcy5sZW5ndGgpCiAgICByZXR1cm4gdGhpc1tvZmZzZXRdCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQxNkxFID0gZnVuY3Rpb24gcmVhZFVJbnQxNkxFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDIsIHRoaXMubGVuZ3RoKQogICAgcmV0dXJuIHRoaXNbb2Zmc2V0XSB8ICh0aGlzW29mZnNldCArIDFdIDw8IDgpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQxNkJFID0gZnVuY3Rpb24gcmVhZFVJbnQxNkJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDIsIHRoaXMubGVuZ3RoKQogICAgcmV0dXJuICh0aGlzW29mZnNldF0gPDwgOCkgfCB0aGlzW29mZnNldCArIDFdCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQzMkxFID0gZnVuY3Rpb24gcmVhZFVJbnQzMkxFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQogIAogICAgcmV0dXJuICgodGhpc1tvZmZzZXRdKSB8CiAgICAgICAgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCkgfAogICAgICAgICh0aGlzW29mZnNldCArIDJdIDw8IDE2KSkgKwogICAgICAgICh0aGlzW29mZnNldCArIDNdICogMHgxMDAwMDAwKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50MzJCRSA9IGZ1bmN0aW9uIHJlYWRVSW50MzJCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICAKICAgIHJldHVybiAodGhpc1tvZmZzZXRdICogMHgxMDAwMDAwKSArCiAgICAgICgodGhpc1tvZmZzZXQgKyAxXSA8PCAxNikgfAogICAgICAodGhpc1tvZmZzZXQgKyAyXSA8PCA4KSB8CiAgICAgIHRoaXNbb2Zmc2V0ICsgM10pCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludExFID0gZnVuY3Rpb24gcmVhZEludExFIChvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgYnl0ZUxlbmd0aCwgdGhpcy5sZW5ndGgpCiAgCiAgICB2YXIgdmFsID0gdGhpc1tvZmZzZXRdCiAgICB2YXIgbXVsID0gMQogICAgdmFyIGkgPSAwCiAgICB3aGlsZSAoKytpIDwgYnl0ZUxlbmd0aCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICB2YWwgKz0gdGhpc1tvZmZzZXQgKyBpXSAqIG11bAogICAgfQogICAgbXVsICo9IDB4ODAKICAKICAgIGlmICh2YWwgPj0gbXVsKSB2YWwgLT0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgpCiAgCiAgICByZXR1cm4gdmFsCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludEJFID0gZnVuY3Rpb24gcmVhZEludEJFIChvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgYnl0ZUxlbmd0aCwgdGhpcy5sZW5ndGgpCiAgCiAgICB2YXIgaSA9IGJ5dGVMZW5ndGgKICAgIHZhciBtdWwgPSAxCiAgICB2YXIgdmFsID0gdGhpc1tvZmZzZXQgKyAtLWldCiAgICB3aGlsZSAoaSA+IDAgJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgdmFsICs9IHRoaXNbb2Zmc2V0ICsgLS1pXSAqIG11bAogICAgfQogICAgbXVsICo9IDB4ODAKICAKICAgIGlmICh2YWwgPj0gbXVsKSB2YWwgLT0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgpCiAgCiAgICByZXR1cm4gdmFsCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludDggPSBmdW5jdGlvbiByZWFkSW50OCAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAxLCB0aGlzLmxlbmd0aCkKICAgIGlmICghKHRoaXNbb2Zmc2V0XSAmIDB4ODApKSByZXR1cm4gKHRoaXNbb2Zmc2V0XSkKICAgIHJldHVybiAoKDB4ZmYgLSB0aGlzW29mZnNldF0gKyAxKSAqIC0xKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQxNkxFID0gZnVuY3Rpb24gcmVhZEludDE2TEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpCiAgICB2YXIgdmFsID0gdGhpc1tvZmZzZXRdIHwgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCkKICAgIHJldHVybiAodmFsICYgMHg4MDAwKSA/IHZhbCB8IDB4RkZGRjAwMDAgOiB2YWwKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50MTZCRSA9IGZ1bmN0aW9uIHJlYWRJbnQxNkJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDIsIHRoaXMubGVuZ3RoKQogICAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0ICsgMV0gfCAodGhpc1tvZmZzZXRdIDw8IDgpCiAgICByZXR1cm4gKHZhbCAmIDB4ODAwMCkgPyB2YWwgfCAweEZGRkYwMDAwIDogdmFsCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludDMyTEUgPSBmdW5jdGlvbiByZWFkSW50MzJMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICAKICAgIHJldHVybiAodGhpc1tvZmZzZXRdKSB8CiAgICAgICh0aGlzW29mZnNldCArIDFdIDw8IDgpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMl0gPDwgMTYpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgM10gPDwgMjQpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludDMyQkUgPSBmdW5jdGlvbiByZWFkSW50MzJCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICAKICAgIHJldHVybiAodGhpc1tvZmZzZXRdIDw8IDI0KSB8CiAgICAgICh0aGlzW29mZnNldCArIDFdIDw8IDE2KSB8CiAgICAgICh0aGlzW29mZnNldCArIDJdIDw8IDgpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgM10pCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEZsb2F0TEUgPSBmdW5jdGlvbiByZWFkRmxvYXRMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICAgIHJldHVybiBpZWVlNzU0LnJlYWQodGhpcywgb2Zmc2V0LCB0cnVlLCAyMywgNCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkRmxvYXRCRSA9IGZ1bmN0aW9uIHJlYWRGbG9hdEJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQogICAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIGZhbHNlLCAyMywgNCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkRG91YmxlTEUgPSBmdW5jdGlvbiByZWFkRG91YmxlTEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgOCwgdGhpcy5sZW5ndGgpCiAgICByZXR1cm4gaWVlZTc1NC5yZWFkKHRoaXMsIG9mZnNldCwgdHJ1ZSwgNTIsIDgpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZERvdWJsZUJFID0gZnVuY3Rpb24gcmVhZERvdWJsZUJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDgsIHRoaXMubGVuZ3RoKQogICAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIGZhbHNlLCA1MiwgOCkKICB9CiAgCiAgZnVuY3Rpb24gY2hlY2tJbnQgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgZXh0LCBtYXgsIG1pbikgewogICAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYnVmKSkgdGhyb3cgbmV3IFR5cGVFcnJvcignImJ1ZmZlciIgYXJndW1lbnQgbXVzdCBiZSBhIEJ1ZmZlciBpbnN0YW5jZScpCiAgICBpZiAodmFsdWUgPiBtYXggfHwgdmFsdWUgPCBtaW4pIHRocm93IG5ldyBSYW5nZUVycm9yKCcidmFsdWUiIGFyZ3VtZW50IGlzIG91dCBvZiBib3VuZHMnKQogICAgaWYgKG9mZnNldCArIGV4dCA+IGJ1Zi5sZW5ndGgpIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbmRleCBvdXQgb2YgcmFuZ2UnKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlVUludExFID0gZnVuY3Rpb24gd3JpdGVVSW50TEUgKHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIHZhciBtYXhCeXRlcyA9IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoKSAtIDEKICAgICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbWF4Qnl0ZXMsIDApCiAgICB9CiAgCiAgICB2YXIgbXVsID0gMQogICAgdmFyIGkgPSAwCiAgICB0aGlzW29mZnNldF0gPSB2YWx1ZSAmIDB4RkYKICAgIHdoaWxlICgrK2kgPCBieXRlTGVuZ3RoICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSAodmFsdWUgLyBtdWwpICYgMHhGRgogICAgfQogIAogICAgcmV0dXJuIG9mZnNldCArIGJ5dGVMZW5ndGgKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnRCRSA9IGZ1bmN0aW9uIHdyaXRlVUludEJFICh2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogICAgaWYgKCFub0Fzc2VydCkgewogICAgICB2YXIgbWF4Qnl0ZXMgPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCkgLSAxCiAgICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG1heEJ5dGVzLCAwKQogICAgfQogIAogICAgdmFyIGkgPSBieXRlTGVuZ3RoIC0gMQogICAgdmFyIG11bCA9IDEKICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSB2YWx1ZSAmIDB4RkYKICAgIHdoaWxlICgtLWkgPj0gMCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICB0aGlzW29mZnNldCArIGldID0gKHZhbHVlIC8gbXVsKSAmIDB4RkYKICAgIH0KICAKICAgIHJldHVybiBvZmZzZXQgKyBieXRlTGVuZ3RoCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50OCA9IGZ1bmN0aW9uIHdyaXRlVUludDggKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMSwgMHhmZiwgMCkKICAgIGlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHZhbHVlID0gTWF0aC5mbG9vcih2YWx1ZSkKICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICByZXR1cm4gb2Zmc2V0ICsgMQogIH0KICAKICBmdW5jdGlvbiBvYmplY3RXcml0ZVVJbnQxNiAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4pIHsKICAgIGlmICh2YWx1ZSA8IDApIHZhbHVlID0gMHhmZmZmICsgdmFsdWUgKyAxCiAgICBmb3IgKHZhciBpID0gMCwgaiA9IE1hdGgubWluKGJ1Zi5sZW5ndGggLSBvZmZzZXQsIDIpOyBpIDwgajsgKytpKSB7CiAgICAgIGJ1ZltvZmZzZXQgKyBpXSA9ICh2YWx1ZSAmICgweGZmIDw8ICg4ICogKGxpdHRsZUVuZGlhbiA/IGkgOiAxIC0gaSkpKSkgPj4+CiAgICAgICAgKGxpdHRsZUVuZGlhbiA/IGkgOiAxIC0gaSkgKiA4CiAgICB9CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50MTZMRSA9IGZ1bmN0aW9uIHdyaXRlVUludDE2TEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMiwgMHhmZmZmLCAwKQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDgpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQxNih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDIKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnQxNkJFID0gZnVuY3Rpb24gd3JpdGVVSW50MTZCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweGZmZmYsIDApCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiA4KQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlICYgMHhmZikKICAgIH0gZWxzZSB7CiAgICAgIG9iamVjdFdyaXRlVUludDE2KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDIKICB9CiAgCiAgZnVuY3Rpb24gb2JqZWN0V3JpdGVVSW50MzIgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuKSB7CiAgICBpZiAodmFsdWUgPCAwKSB2YWx1ZSA9IDB4ZmZmZmZmZmYgKyB2YWx1ZSArIDEKICAgIGZvciAodmFyIGkgPSAwLCBqID0gTWF0aC5taW4oYnVmLmxlbmd0aCAtIG9mZnNldCwgNCk7IGkgPCBqOyArK2kpIHsKICAgICAgYnVmW29mZnNldCArIGldID0gKHZhbHVlID4+PiAobGl0dGxlRW5kaWFuID8gaSA6IDMgLSBpKSAqIDgpICYgMHhmZgogICAgfQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDMyTEUgPSBmdW5jdGlvbiB3cml0ZVVJbnQzMkxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDQsIDB4ZmZmZmZmZmYsIDApCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgdGhpc1tvZmZzZXQgKyAzXSA9ICh2YWx1ZSA+Pj4gMjQpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMl0gPSAodmFsdWUgPj4+IDE2KQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MzIodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyA0CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50MzJCRSA9IGZ1bmN0aW9uIHdyaXRlVUludDMyQkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgNCwgMHhmZmZmZmZmZiwgMCkKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDI0KQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiAxNikKICAgICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gOCkKICAgICAgdGhpc1tvZmZzZXQgKyAzXSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyA0CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnRMRSA9IGZ1bmN0aW9uIHdyaXRlSW50TEUgKHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgewogICAgICB2YXIgbGltaXQgPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCAtIDEpCiAgCiAgICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIGxpbWl0IC0gMSwgLWxpbWl0KQogICAgfQogIAogICAgdmFyIGkgPSAwCiAgICB2YXIgbXVsID0gMQogICAgdmFyIHN1YiA9IDAKICAgIHRoaXNbb2Zmc2V0XSA9IHZhbHVlICYgMHhGRgogICAgd2hpbGUgKCsraSA8IGJ5dGVMZW5ndGggJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgaWYgKHZhbHVlIDwgMCAmJiBzdWIgPT09IDAgJiYgdGhpc1tvZmZzZXQgKyBpIC0gMV0gIT09IDApIHsKICAgICAgICBzdWIgPSAxCiAgICAgIH0KICAgICAgdGhpc1tvZmZzZXQgKyBpXSA9ICgodmFsdWUgLyBtdWwpID4+IDApIC0gc3ViICYgMHhGRgogICAgfQogIAogICAgcmV0dXJuIG9mZnNldCArIGJ5dGVMZW5ndGgKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUludEJFID0gZnVuY3Rpb24gd3JpdGVJbnRCRSAodmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIHZhciBsaW1pdCA9IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoIC0gMSkKICAKICAgICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbGltaXQgLSAxLCAtbGltaXQpCiAgICB9CiAgCiAgICB2YXIgaSA9IGJ5dGVMZW5ndGggLSAxCiAgICB2YXIgbXVsID0gMQogICAgdmFyIHN1YiA9IDAKICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSB2YWx1ZSAmIDB4RkYKICAgIHdoaWxlICgtLWkgPj0gMCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICBpZiAodmFsdWUgPCAwICYmIHN1YiA9PT0gMCAmJiB0aGlzW29mZnNldCArIGkgKyAxXSAhPT0gMCkgewogICAgICAgIHN1YiA9IDEKICAgICAgfQogICAgICB0aGlzW29mZnNldCArIGldID0gKCh2YWx1ZSAvIG11bCkgPj4gMCkgLSBzdWIgJiAweEZGCiAgICB9CiAgCiAgICByZXR1cm4gb2Zmc2V0ICsgYnl0ZUxlbmd0aAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlSW50OCA9IGZ1bmN0aW9uIHdyaXRlSW50OCAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAxLCAweDdmLCAtMHg4MCkKICAgIGlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHZhbHVlID0gTWF0aC5mbG9vcih2YWx1ZSkKICAgIGlmICh2YWx1ZSA8IDApIHZhbHVlID0gMHhmZiArIHZhbHVlICsgMQogICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICAgIHJldHVybiBvZmZzZXQgKyAxCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQxNkxFID0gZnVuY3Rpb24gd3JpdGVJbnQxNkxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDIsIDB4N2ZmZiwgLTB4ODAwMCkKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyAyCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQxNkJFID0gZnVuY3Rpb24gd3JpdGVJbnQxNkJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDIsIDB4N2ZmZiwgLTB4ODAwMCkKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDgpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgJiAweGZmKQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UpCiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgMgogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlSW50MzJMRSA9IGZ1bmN0aW9uIHdyaXRlSW50MzJMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweDdmZmZmZmZmLCAtMHg4MDAwMDAwMCkKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogICAgICB0aGlzW29mZnNldCArIDJdID0gKHZhbHVlID4+PiAxNikKICAgICAgdGhpc1tvZmZzZXQgKyAzXSA9ICh2YWx1ZSA+Pj4gMjQpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDQKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDMyQkUgPSBmdW5jdGlvbiB3cml0ZUludDMyQkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgNCwgMHg3ZmZmZmZmZiwgLTB4ODAwMDAwMDApCiAgICBpZiAodmFsdWUgPCAwKSB2YWx1ZSA9IDB4ZmZmZmZmZmYgKyB2YWx1ZSArIDEKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDI0KQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiAxNikKICAgICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gOCkKICAgICAgdGhpc1tvZmZzZXQgKyAzXSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyA0CiAgfQogIAogIGZ1bmN0aW9uIGNoZWNrSUVFRTc1NCAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBleHQsIG1heCwgbWluKSB7CiAgICBpZiAob2Zmc2V0ICsgZXh0ID4gYnVmLmxlbmd0aCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0luZGV4IG91dCBvZiByYW5nZScpCiAgICBpZiAob2Zmc2V0IDwgMCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0luZGV4IG91dCBvZiByYW5nZScpCiAgfQogIAogIGZ1bmN0aW9uIHdyaXRlRmxvYXQgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgewogICAgICBjaGVja0lFRUU3NTQoYnVmLCB2YWx1ZSwgb2Zmc2V0LCA0LCAzLjQwMjgyMzQ2NjM4NTI4ODZlKzM4LCAtMy40MDI4MjM0NjYzODUyODg2ZSszOCkKICAgIH0KICAgIGllZWU3NTQud3JpdGUoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIDIzLCA0KQogICAgcmV0dXJuIG9mZnNldCArIDQKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUZsb2F0TEUgPSBmdW5jdGlvbiB3cml0ZUZsb2F0TEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICByZXR1cm4gd3JpdGVGbG9hdCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlLCBub0Fzc2VydCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUZsb2F0QkUgPSBmdW5jdGlvbiB3cml0ZUZsb2F0QkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICByZXR1cm4gd3JpdGVGbG9hdCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSwgbm9Bc3NlcnQpCiAgfQogIAogIGZ1bmN0aW9uIHdyaXRlRG91YmxlIChidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbiwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIHsKICAgICAgY2hlY2tJRUVFNzU0KGJ1ZiwgdmFsdWUsIG9mZnNldCwgOCwgMS43OTc2OTMxMzQ4NjIzMTU3RSszMDgsIC0xLjc5NzY5MzEzNDg2MjMxNTdFKzMwOCkKICAgIH0KICAgIGllZWU3NTQud3JpdGUoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIDUyLCA4KQogICAgcmV0dXJuIG9mZnNldCArIDgKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZURvdWJsZUxFID0gZnVuY3Rpb24gd3JpdGVEb3VibGVMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHJldHVybiB3cml0ZURvdWJsZSh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlLCBub0Fzc2VydCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZURvdWJsZUJFID0gZnVuY3Rpb24gd3JpdGVEb3VibGVCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHJldHVybiB3cml0ZURvdWJsZSh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSwgbm9Bc3NlcnQpCiAgfQogIAogIC8vIGNvcHkodGFyZ2V0QnVmZmVyLCB0YXJnZXRTdGFydD0wLCBzb3VyY2VTdGFydD0wLCBzb3VyY2VFbmQ9YnVmZmVyLmxlbmd0aCkKICBCdWZmZXIucHJvdG90eXBlLmNvcHkgPSBmdW5jdGlvbiBjb3B5ICh0YXJnZXQsIHRhcmdldFN0YXJ0LCBzdGFydCwgZW5kKSB7CiAgICBpZiAoIXN0YXJ0KSBzdGFydCA9IDAKICAgIGlmICghZW5kICYmIGVuZCAhPT0gMCkgZW5kID0gdGhpcy5sZW5ndGgKICAgIGlmICh0YXJnZXRTdGFydCA+PSB0YXJnZXQubGVuZ3RoKSB0YXJnZXRTdGFydCA9IHRhcmdldC5sZW5ndGgKICAgIGlmICghdGFyZ2V0U3RhcnQpIHRhcmdldFN0YXJ0ID0gMAogICAgaWYgKGVuZCA+IDAgJiYgZW5kIDwgc3RhcnQpIGVuZCA9IHN0YXJ0CiAgCiAgICAvLyBDb3B5IDAgYnl0ZXM7IHdlJ3JlIGRvbmUKICAgIGlmIChlbmQgPT09IHN0YXJ0KSByZXR1cm4gMAogICAgaWYgKHRhcmdldC5sZW5ndGggPT09IDAgfHwgdGhpcy5sZW5ndGggPT09IDApIHJldHVybiAwCiAgCiAgICAvLyBGYXRhbCBlcnJvciBjb25kaXRpb25zCiAgICBpZiAodGFyZ2V0U3RhcnQgPCAwKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCd0YXJnZXRTdGFydCBvdXQgb2YgYm91bmRzJykKICAgIH0KICAgIGlmIChzdGFydCA8IDAgfHwgc3RhcnQgPj0gdGhpcy5sZW5ndGgpIHRocm93IG5ldyBSYW5nZUVycm9yKCdzb3VyY2VTdGFydCBvdXQgb2YgYm91bmRzJykKICAgIGlmIChlbmQgPCAwKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignc291cmNlRW5kIG91dCBvZiBib3VuZHMnKQogIAogICAgLy8gQXJlIHdlIG9vYj8KICAgIGlmIChlbmQgPiB0aGlzLmxlbmd0aCkgZW5kID0gdGhpcy5sZW5ndGgKICAgIGlmICh0YXJnZXQubGVuZ3RoIC0gdGFyZ2V0U3RhcnQgPCBlbmQgLSBzdGFydCkgewogICAgICBlbmQgPSB0YXJnZXQubGVuZ3RoIC0gdGFyZ2V0U3RhcnQgKyBzdGFydAogICAgfQogIAogICAgdmFyIGxlbiA9IGVuZCAtIHN0YXJ0CiAgICB2YXIgaQogIAogICAgaWYgKHRoaXMgPT09IHRhcmdldCAmJiBzdGFydCA8IHRhcmdldFN0YXJ0ICYmIHRhcmdldFN0YXJ0IDwgZW5kKSB7CiAgICAgIC8vIGRlc2NlbmRpbmcgY29weSBmcm9tIGVuZAogICAgICBmb3IgKGkgPSBsZW4gLSAxOyBpID49IDA7IC0taSkgewogICAgICAgIHRhcmdldFtpICsgdGFyZ2V0U3RhcnRdID0gdGhpc1tpICsgc3RhcnRdCiAgICAgIH0KICAgIH0gZWxzZSBpZiAobGVuIDwgMTAwMCB8fCAhQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgLy8gYXNjZW5kaW5nIGNvcHkgZnJvbSBzdGFydAogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICB0YXJnZXRbaSArIHRhcmdldFN0YXJ0XSA9IHRoaXNbaSArIHN0YXJ0XQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBVaW50OEFycmF5LnByb3RvdHlwZS5zZXQuY2FsbCgKICAgICAgICB0YXJnZXQsCiAgICAgICAgdGhpcy5zdWJhcnJheShzdGFydCwgc3RhcnQgKyBsZW4pLAogICAgICAgIHRhcmdldFN0YXJ0CiAgICAgICkKICAgIH0KICAKICAgIHJldHVybiBsZW4KICB9CiAgCiAgLy8gVXNhZ2U6CiAgLy8gICAgYnVmZmVyLmZpbGwobnVtYmVyWywgb2Zmc2V0WywgZW5kXV0pCiAgLy8gICAgYnVmZmVyLmZpbGwoYnVmZmVyWywgb2Zmc2V0WywgZW5kXV0pCiAgLy8gICAgYnVmZmVyLmZpbGwoc3RyaW5nWywgb2Zmc2V0WywgZW5kXV1bLCBlbmNvZGluZ10pCiAgQnVmZmVyLnByb3RvdHlwZS5maWxsID0gZnVuY3Rpb24gZmlsbCAodmFsLCBzdGFydCwgZW5kLCBlbmNvZGluZykgewogICAgLy8gSGFuZGxlIHN0cmluZyBjYXNlczoKICAgIGlmICh0eXBlb2YgdmFsID09PSAnc3RyaW5nJykgewogICAgICBpZiAodHlwZW9mIHN0YXJ0ID09PSAnc3RyaW5nJykgewogICAgICAgIGVuY29kaW5nID0gc3RhcnQKICAgICAgICBzdGFydCA9IDAKICAgICAgICBlbmQgPSB0aGlzLmxlbmd0aAogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgZW5jb2RpbmcgPSBlbmQKICAgICAgICBlbmQgPSB0aGlzLmxlbmd0aAogICAgICB9CiAgICAgIGlmICh2YWwubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdmFyIGNvZGUgPSB2YWwuY2hhckNvZGVBdCgwKQogICAgICAgIGlmIChjb2RlIDwgMjU2KSB7CiAgICAgICAgICB2YWwgPSBjb2RlCiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChlbmNvZGluZyAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBlbmNvZGluZyAhPT0gJ3N0cmluZycpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdlbmNvZGluZyBtdXN0IGJlIGEgc3RyaW5nJykKICAgICAgfQogICAgICBpZiAodHlwZW9mIGVuY29kaW5nID09PSAnc3RyaW5nJyAmJiAhQnVmZmVyLmlzRW5jb2RpbmcoZW5jb2RpbmcpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVW5rbm93biBlbmNvZGluZzogJyArIGVuY29kaW5nKQogICAgICB9CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICdudW1iZXInKSB7CiAgICAgIHZhbCA9IHZhbCAmIDI1NQogICAgfQogIAogICAgLy8gSW52YWxpZCByYW5nZXMgYXJlIG5vdCBzZXQgdG8gYSBkZWZhdWx0LCBzbyBjYW4gcmFuZ2UgY2hlY2sgZWFybHkuCiAgICBpZiAoc3RhcnQgPCAwIHx8IHRoaXMubGVuZ3RoIDwgc3RhcnQgfHwgdGhpcy5sZW5ndGggPCBlbmQpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ091dCBvZiByYW5nZSBpbmRleCcpCiAgICB9CiAgCiAgICBpZiAoZW5kIDw9IHN0YXJ0KSB7CiAgICAgIHJldHVybiB0aGlzCiAgICB9CiAgCiAgICBzdGFydCA9IHN0YXJ0ID4+PiAwCiAgICBlbmQgPSBlbmQgPT09IHVuZGVmaW5lZCA/IHRoaXMubGVuZ3RoIDogZW5kID4+PiAwCiAgCiAgICBpZiAoIXZhbCkgdmFsID0gMAogIAogICAgdmFyIGkKICAgIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgICBmb3IgKGkgPSBzdGFydDsgaSA8IGVuZDsgKytpKSB7CiAgICAgICAgdGhpc1tpXSA9IHZhbAogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgYnl0ZXMgPSBCdWZmZXIuaXNCdWZmZXIodmFsKQogICAgICAgID8gdmFsCiAgICAgICAgOiB1dGY4VG9CeXRlcyhuZXcgQnVmZmVyKHZhbCwgZW5jb2RpbmcpLnRvU3RyaW5nKCkpCiAgICAgIHZhciBsZW4gPSBieXRlcy5sZW5ndGgKICAgICAgZm9yIChpID0gMDsgaSA8IGVuZCAtIHN0YXJ0OyArK2kpIHsKICAgICAgICB0aGlzW2kgKyBzdGFydF0gPSBieXRlc1tpICUgbGVuXQogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gdGhpcwogIH0KICAKICAvLyBIRUxQRVIgRlVOQ1RJT05TCiAgLy8gPT09PT09PT09PT09PT09PQogIAogIHZhciBJTlZBTElEX0JBU0U2NF9SRSA9IC9bXitcLzAtOUEtWmEtei1fXS9nCiAgCiAgZnVuY3Rpb24gYmFzZTY0Y2xlYW4gKHN0cikgewogICAgLy8gTm9kZSBzdHJpcHMgb3V0IGludmFsaWQgY2hhcmFjdGVycyBsaWtlIFxuIGFuZCBcdCBmcm9tIHRoZSBzdHJpbmcsIGJhc2U2NC1qcyBkb2VzIG5vdAogICAgc3RyID0gc3RyaW5ndHJpbShzdHIpLnJlcGxhY2UoSU5WQUxJRF9CQVNFNjRfUkUsICcnKQogICAgLy8gTm9kZSBjb252ZXJ0cyBzdHJpbmdzIHdpdGggbGVuZ3RoIDwgMiB0byAnJwogICAgaWYgKHN0ci5sZW5ndGggPCAyKSByZXR1cm4gJycKICAgIC8vIE5vZGUgYWxsb3dzIGZvciBub24tcGFkZGVkIGJhc2U2NCBzdHJpbmdzIChtaXNzaW5nIHRyYWlsaW5nID09PSksIGJhc2U2NC1qcyBkb2VzIG5vdAogICAgd2hpbGUgKHN0ci5sZW5ndGggJSA0ICE9PSAwKSB7CiAgICAgIHN0ciA9IHN0ciArICc9JwogICAgfQogICAgcmV0dXJuIHN0cgogIH0KICAKICBmdW5jdGlvbiBzdHJpbmd0cmltIChzdHIpIHsKICAgIGlmIChzdHIudHJpbSkgcmV0dXJuIHN0ci50cmltKCkKICAgIHJldHVybiBzdHIucmVwbGFjZSgvXlxzK3xccyskL2csICcnKQogIH0KICAKICBmdW5jdGlvbiB0b0hleCAobikgewogICAgaWYgKG4gPCAxNikgcmV0dXJuICcwJyArIG4udG9TdHJpbmcoMTYpCiAgICByZXR1cm4gbi50b1N0cmluZygxNikKICB9CiAgCiAgZnVuY3Rpb24gdXRmOFRvQnl0ZXMgKHN0cmluZywgdW5pdHMpIHsKICAgIHVuaXRzID0gdW5pdHMgfHwgSW5maW5pdHkKICAgIHZhciBjb2RlUG9pbnQKICAgIHZhciBsZW5ndGggPSBzdHJpbmcubGVuZ3RoCiAgICB2YXIgbGVhZFN1cnJvZ2F0ZSA9IG51bGwKICAgIHZhciBieXRlcyA9IFtdCiAgCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvZGVQb2ludCA9IHN0cmluZy5jaGFyQ29kZUF0KGkpCiAgCiAgICAgIC8vIGlzIHN1cnJvZ2F0ZSBjb21wb25lbnQKICAgICAgaWYgKGNvZGVQb2ludCA+IDB4RDdGRiAmJiBjb2RlUG9pbnQgPCAweEUwMDApIHsKICAgICAgICAvLyBsYXN0IGNoYXIgd2FzIGEgbGVhZAogICAgICAgIGlmICghbGVhZFN1cnJvZ2F0ZSkgewogICAgICAgICAgLy8gbm8gbGVhZCB5ZXQKICAgICAgICAgIGlmIChjb2RlUG9pbnQgPiAweERCRkYpIHsKICAgICAgICAgICAgLy8gdW5leHBlY3RlZCB0cmFpbAogICAgICAgICAgICBpZiAoKHVuaXRzIC09IDMpID4gLTEpIGJ5dGVzLnB1c2goMHhFRiwgMHhCRiwgMHhCRCkKICAgICAgICAgICAgY29udGludWUKICAgICAgICAgIH0gZWxzZSBpZiAoaSArIDEgPT09IGxlbmd0aCkgewogICAgICAgICAgICAvLyB1bnBhaXJlZCBsZWFkCiAgICAgICAgICAgIGlmICgodW5pdHMgLT0gMykgPiAtMSkgYnl0ZXMucHVzaCgweEVGLCAweEJGLCAweEJEKQogICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgfQogIAogICAgICAgICAgLy8gdmFsaWQgbGVhZAogICAgICAgICAgbGVhZFN1cnJvZ2F0ZSA9IGNvZGVQb2ludAogIAogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgCiAgICAgICAgLy8gMiBsZWFkcyBpbiBhIHJvdwogICAgICAgIGlmIChjb2RlUG9pbnQgPCAweERDMDApIHsKICAgICAgICAgIGlmICgodW5pdHMgLT0gMykgPiAtMSkgYnl0ZXMucHVzaCgweEVGLCAweEJGLCAweEJEKQogICAgICAgICAgbGVhZFN1cnJvZ2F0ZSA9IGNvZGVQb2ludAogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgCiAgICAgICAgLy8gdmFsaWQgc3Vycm9nYXRlIHBhaXIKICAgICAgICBjb2RlUG9pbnQgPSAobGVhZFN1cnJvZ2F0ZSAtIDB4RDgwMCA8PCAxMCB8IGNvZGVQb2ludCAtIDB4REMwMCkgKyAweDEwMDAwCiAgICAgIH0gZWxzZSBpZiAobGVhZFN1cnJvZ2F0ZSkgewogICAgICAgIC8vIHZhbGlkIGJtcCBjaGFyLCBidXQgbGFzdCBjaGFyIHdhcyBhIGxlYWQKICAgICAgICBpZiAoKHVuaXRzIC09IDMpID4gLTEpIGJ5dGVzLnB1c2goMHhFRiwgMHhCRiwgMHhCRCkKICAgICAgfQogIAogICAgICBsZWFkU3Vycm9nYXRlID0gbnVsbAogIAogICAgICAvLyBlbmNvZGUgdXRmOAogICAgICBpZiAoY29kZVBvaW50IDwgMHg4MCkgewogICAgICAgIGlmICgodW5pdHMgLT0gMSkgPCAwKSBicmVhawogICAgICAgIGJ5dGVzLnB1c2goY29kZVBvaW50KQogICAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA8IDB4ODAwKSB7CiAgICAgICAgaWYgKCh1bml0cyAtPSAyKSA8IDApIGJyZWFrCiAgICAgICAgYnl0ZXMucHVzaCgKICAgICAgICAgIGNvZGVQb2ludCA+PiAweDYgfCAweEMwLAogICAgICAgICAgY29kZVBvaW50ICYgMHgzRiB8IDB4ODAKICAgICAgICApCiAgICAgIH0gZWxzZSBpZiAoY29kZVBvaW50IDwgMHgxMDAwMCkgewogICAgICAgIGlmICgodW5pdHMgLT0gMykgPCAwKSBicmVhawogICAgICAgIGJ5dGVzLnB1c2goCiAgICAgICAgICBjb2RlUG9pbnQgPj4gMHhDIHwgMHhFMCwKICAgICAgICAgIGNvZGVQb2ludCA+PiAweDYgJiAweDNGIHwgMHg4MCwKICAgICAgICAgIGNvZGVQb2ludCAmIDB4M0YgfCAweDgwCiAgICAgICAgKQogICAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA8IDB4MTEwMDAwKSB7CiAgICAgICAgaWYgKCh1bml0cyAtPSA0KSA8IDApIGJyZWFrCiAgICAgICAgYnl0ZXMucHVzaCgKICAgICAgICAgIGNvZGVQb2ludCA+PiAweDEyIHwgMHhGMCwKICAgICAgICAgIGNvZGVQb2ludCA+PiAweEMgJiAweDNGIHwgMHg4MCwKICAgICAgICAgIGNvZGVQb2ludCA+PiAweDYgJiAweDNGIHwgMHg4MCwKICAgICAgICAgIGNvZGVQb2ludCAmIDB4M0YgfCAweDgwCiAgICAgICAgKQogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBjb2RlIHBvaW50JykKICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIGJ5dGVzCiAgfQogIAogIGZ1bmN0aW9uIGFzY2lpVG9CeXRlcyAoc3RyKSB7CiAgICB2YXIgYnl0ZUFycmF5ID0gW10KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgKytpKSB7CiAgICAgIC8vIE5vZGUncyBjb2RlIHNlZW1zIHRvIGJlIGRvaW5nIHRoaXMgYW5kIG5vdCAmIDB4N0YuLgogICAgICBieXRlQXJyYXkucHVzaChzdHIuY2hhckNvZGVBdChpKSAmIDB4RkYpCiAgICB9CiAgICByZXR1cm4gYnl0ZUFycmF5CiAgfQogIAogIGZ1bmN0aW9uIHV0ZjE2bGVUb0J5dGVzIChzdHIsIHVuaXRzKSB7CiAgICB2YXIgYywgaGksIGxvCiAgICB2YXIgYnl0ZUFycmF5ID0gW10KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgKytpKSB7CiAgICAgIGlmICgodW5pdHMgLT0gMikgPCAwKSBicmVhawogIAogICAgICBjID0gc3RyLmNoYXJDb2RlQXQoaSkKICAgICAgaGkgPSBjID4+IDgKICAgICAgbG8gPSBjICUgMjU2CiAgICAgIGJ5dGVBcnJheS5wdXNoKGxvKQogICAgICBieXRlQXJyYXkucHVzaChoaSkKICAgIH0KICAKICAgIHJldHVybiBieXRlQXJyYXkKICB9CiAgCiAgZnVuY3Rpb24gYmFzZTY0VG9CeXRlcyAoc3RyKSB7CiAgICByZXR1cm4gYmFzZTY0LnRvQnl0ZUFycmF5KGJhc2U2NGNsZWFuKHN0cikpCiAgfQogIAogIGZ1bmN0aW9uIGJsaXRCdWZmZXIgKHNyYywgZHN0LCBvZmZzZXQsIGxlbmd0aCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBpZiAoKGkgKyBvZmZzZXQgPj0gZHN0Lmxlbmd0aCkgfHwgKGkgPj0gc3JjLmxlbmd0aCkpIGJyZWFrCiAgICAgIGRzdFtpICsgb2Zmc2V0XSA9IHNyY1tpXQogICAgfQogICAgcmV0dXJuIGkKICB9CiAgCiAgZnVuY3Rpb24gaXNuYW4gKHZhbCkgewogICAgcmV0dXJuIHZhbCAhPT0gdmFsIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tc2VsZi1jb21wYXJlCiAgfQogIAogIH0pLmNhbGwodGhpcyx0eXBlb2YgZ2xvYmFsICE9PSAidW5kZWZpbmVkIiA/IGdsb2JhbCA6IHR5cGVvZiBzZWxmICE9PSAidW5kZWZpbmVkIiA/IHNlbGYgOiB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiA/IHdpbmRvdyA6IHt9LHJlcXVpcmUoImJ1ZmZlciIpLkJ1ZmZlcikKICB9LHsiYmFzZTY0LWpzIjo3OCwiYnVmZmVyIjo4MCwiaWVlZTc1NCI6ODIsImlzYXJyYXkiOjgzfV0sODE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgogIC8vCiAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKICAvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiAgLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwogIC8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKICAvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CiAgLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCiAgLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgLy8KICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAogIC8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogIC8vCiAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICAvLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiAgLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgogIC8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAogIC8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgogIC8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKICAvLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogIAogIGZ1bmN0aW9uIEV2ZW50RW1pdHRlcigpIHsKICAgIHRoaXMuX2V2ZW50cyA9IHRoaXMuX2V2ZW50cyB8fCB7fTsKICAgIHRoaXMuX21heExpc3RlbmVycyA9IHRoaXMuX21heExpc3RlbmVycyB8fCB1bmRlZmluZWQ7CiAgfQogIG1vZHVsZS5leHBvcnRzID0gRXZlbnRFbWl0dGVyOwogIAogIC8vIEJhY2t3YXJkcy1jb21wYXQgd2l0aCBub2RlIDAuMTAueAogIEV2ZW50RW1pdHRlci5FdmVudEVtaXR0ZXIgPSBFdmVudEVtaXR0ZXI7CiAgCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fZXZlbnRzID0gdW5kZWZpbmVkOwogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuX21heExpc3RlbmVycyA9IHVuZGVmaW5lZDsKICAKICAvLyBCeSBkZWZhdWx0IEV2ZW50RW1pdHRlcnMgd2lsbCBwcmludCBhIHdhcm5pbmcgaWYgbW9yZSB0aGFuIDEwIGxpc3RlbmVycyBhcmUKICAvLyBhZGRlZCB0byBpdC4gVGhpcyBpcyBhIHVzZWZ1bCBkZWZhdWx0IHdoaWNoIGhlbHBzIGZpbmRpbmcgbWVtb3J5IGxlYWtzLgogIEV2ZW50RW1pdHRlci5kZWZhdWx0TWF4TGlzdGVuZXJzID0gMTA7CiAgCiAgLy8gT2J2aW91c2x5IG5vdCBhbGwgRW1pdHRlcnMgc2hvdWxkIGJlIGxpbWl0ZWQgdG8gMTAuIFRoaXMgZnVuY3Rpb24gYWxsb3dzCiAgLy8gdGhhdCB0byBiZSBpbmNyZWFzZWQuIFNldCB0byB6ZXJvIGZvciB1bmxpbWl0ZWQuCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5zZXRNYXhMaXN0ZW5lcnMgPSBmdW5jdGlvbihuKSB7CiAgICBpZiAoIWlzTnVtYmVyKG4pIHx8IG4gPCAwIHx8IGlzTmFOKG4pKQogICAgICB0aHJvdyBUeXBlRXJyb3IoJ24gbXVzdCBiZSBhIHBvc2l0aXZlIG51bWJlcicpOwogICAgdGhpcy5fbWF4TGlzdGVuZXJzID0gbjsKICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5lbWl0ID0gZnVuY3Rpb24odHlwZSkgewogICAgdmFyIGVyLCBoYW5kbGVyLCBsZW4sIGFyZ3MsIGksIGxpc3RlbmVyczsKICAKICAgIGlmICghdGhpcy5fZXZlbnRzKQogICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAKICAgIC8vIElmIHRoZXJlIGlzIG5vICdlcnJvcicgZXZlbnQgbGlzdGVuZXIgdGhlbiB0aHJvdy4KICAgIGlmICh0eXBlID09PSAnZXJyb3InKSB7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzLmVycm9yIHx8CiAgICAgICAgICAoaXNPYmplY3QodGhpcy5fZXZlbnRzLmVycm9yKSAmJiAhdGhpcy5fZXZlbnRzLmVycm9yLmxlbmd0aCkpIHsKICAgICAgICBlciA9IGFyZ3VtZW50c1sxXTsKICAgICAgICBpZiAoZXIgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgICAgdGhyb3cgZXI7IC8vIFVuaGFuZGxlZCAnZXJyb3InIGV2ZW50CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIEF0IGxlYXN0IGdpdmUgc29tZSBraW5kIG9mIGNvbnRleHQgdG8gdGhlIHVzZXIKICAgICAgICAgIHZhciBlcnIgPSBuZXcgRXJyb3IoJ1VuY2F1Z2h0LCB1bnNwZWNpZmllZCAiZXJyb3IiIGV2ZW50LiAoJyArIGVyICsgJyknKTsKICAgICAgICAgIGVyci5jb250ZXh0ID0gZXI7CiAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgCiAgICBoYW5kbGVyID0gdGhpcy5fZXZlbnRzW3R5cGVdOwogIAogICAgaWYgKGlzVW5kZWZpbmVkKGhhbmRsZXIpKQogICAgICByZXR1cm4gZmFsc2U7CiAgCiAgICBpZiAoaXNGdW5jdGlvbihoYW5kbGVyKSkgewogICAgICBzd2l0Y2ggKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAvLyBmYXN0IGNhc2VzCiAgICAgICAgY2FzZSAxOgogICAgICAgICAgaGFuZGxlci5jYWxsKHRoaXMpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAyOgogICAgICAgICAgaGFuZGxlci5jYWxsKHRoaXMsIGFyZ3VtZW50c1sxXSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDM6CiAgICAgICAgICBoYW5kbGVyLmNhbGwodGhpcywgYXJndW1lbnRzWzFdLCBhcmd1bWVudHNbMl0pOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gc2xvd2VyCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgaGFuZGxlci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc09iamVjdChoYW5kbGVyKSkgewogICAgICBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgbGlzdGVuZXJzID0gaGFuZGxlci5zbGljZSgpOwogICAgICBsZW4gPSBsaXN0ZW5lcnMubGVuZ3RoOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspCiAgICAgICAgbGlzdGVuZXJzW2ldLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfQogIAogICAgcmV0dXJuIHRydWU7CiAgfTsKICAKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLmFkZExpc3RlbmVyID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIpIHsKICAgIHZhciBtOwogIAogICAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkKICAgICAgdGhyb3cgVHlwZUVycm9yKCdsaXN0ZW5lciBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAKICAgIGlmICghdGhpcy5fZXZlbnRzKQogICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAKICAgIC8vIFRvIGF2b2lkIHJlY3Vyc2lvbiBpbiB0aGUgY2FzZSB0aGF0IHR5cGUgPT09ICJuZXdMaXN0ZW5lciIhIEJlZm9yZQogICAgLy8gYWRkaW5nIGl0IHRvIHRoZSBsaXN0ZW5lcnMsIGZpcnN0IGVtaXQgIm5ld0xpc3RlbmVyIi4KICAgIGlmICh0aGlzLl9ldmVudHMubmV3TGlzdGVuZXIpCiAgICAgIHRoaXMuZW1pdCgnbmV3TGlzdGVuZXInLCB0eXBlLAogICAgICAgICAgICAgICAgaXNGdW5jdGlvbihsaXN0ZW5lci5saXN0ZW5lcikgPwogICAgICAgICAgICAgICAgbGlzdGVuZXIubGlzdGVuZXIgOiBsaXN0ZW5lcik7CiAgCiAgICBpZiAoIXRoaXMuX2V2ZW50c1t0eXBlXSkKICAgICAgLy8gT3B0aW1pemUgdGhlIGNhc2Ugb2Ygb25lIGxpc3RlbmVyLiBEb24ndCBuZWVkIHRoZSBleHRyYSBhcnJheSBvYmplY3QuCiAgICAgIHRoaXMuX2V2ZW50c1t0eXBlXSA9IGxpc3RlbmVyOwogICAgZWxzZSBpZiAoaXNPYmplY3QodGhpcy5fZXZlbnRzW3R5cGVdKSkKICAgICAgLy8gSWYgd2UndmUgYWxyZWFkeSBnb3QgYW4gYXJyYXksIGp1c3QgYXBwZW5kLgogICAgICB0aGlzLl9ldmVudHNbdHlwZV0ucHVzaChsaXN0ZW5lcik7CiAgICBlbHNlCiAgICAgIC8vIEFkZGluZyB0aGUgc2Vjb25kIGVsZW1lbnQsIG5lZWQgdG8gY2hhbmdlIHRvIGFycmF5LgogICAgICB0aGlzLl9ldmVudHNbdHlwZV0gPSBbdGhpcy5fZXZlbnRzW3R5cGVdLCBsaXN0ZW5lcl07CiAgCiAgICAvLyBDaGVjayBmb3IgbGlzdGVuZXIgbGVhawogICAgaWYgKGlzT2JqZWN0KHRoaXMuX2V2ZW50c1t0eXBlXSkgJiYgIXRoaXMuX2V2ZW50c1t0eXBlXS53YXJuZWQpIHsKICAgICAgaWYgKCFpc1VuZGVmaW5lZCh0aGlzLl9tYXhMaXN0ZW5lcnMpKSB7CiAgICAgICAgbSA9IHRoaXMuX21heExpc3RlbmVyczsKICAgICAgfSBlbHNlIHsKICAgICAgICBtID0gRXZlbnRFbWl0dGVyLmRlZmF1bHRNYXhMaXN0ZW5lcnM7CiAgICAgIH0KICAKICAgICAgaWYgKG0gJiYgbSA+IDAgJiYgdGhpcy5fZXZlbnRzW3R5cGVdLmxlbmd0aCA+IG0pIHsKICAgICAgICB0aGlzLl9ldmVudHNbdHlwZV0ud2FybmVkID0gdHJ1ZTsKICAgICAgICBjb25zb2xlLmVycm9yKCcobm9kZSkgd2FybmluZzogcG9zc2libGUgRXZlbnRFbWl0dGVyIG1lbW9yeSAnICsKICAgICAgICAgICAgICAgICAgICAgICdsZWFrIGRldGVjdGVkLiAlZCBsaXN0ZW5lcnMgYWRkZWQuICcgKwogICAgICAgICAgICAgICAgICAgICAgJ1VzZSBlbWl0dGVyLnNldE1heExpc3RlbmVycygpIHRvIGluY3JlYXNlIGxpbWl0LicsCiAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9ldmVudHNbdHlwZV0ubGVuZ3RoKTsKICAgICAgICBpZiAodHlwZW9mIGNvbnNvbGUudHJhY2UgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIC8vIG5vdCBzdXBwb3J0ZWQgaW4gSUUgMTAKICAgICAgICAgIGNvbnNvbGUudHJhY2UoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vbiA9IEV2ZW50RW1pdHRlci5wcm90b3R5cGUuYWRkTGlzdGVuZXI7CiAgCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIpIHsKICAgIGlmICghaXNGdW5jdGlvbihsaXN0ZW5lcikpCiAgICAgIHRocm93IFR5cGVFcnJvcignbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgCiAgICB2YXIgZmlyZWQgPSBmYWxzZTsKICAKICAgIGZ1bmN0aW9uIGcoKSB7CiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgZyk7CiAgCiAgICAgIGlmICghZmlyZWQpIHsKICAgICAgICBmaXJlZCA9IHRydWU7CiAgICAgICAgbGlzdGVuZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfQogIAogICAgZy5saXN0ZW5lciA9IGxpc3RlbmVyOwogICAgdGhpcy5vbih0eXBlLCBnKTsKICAKICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgLy8gZW1pdHMgYSAncmVtb3ZlTGlzdGVuZXInIGV2ZW50IGlmZiB0aGUgbGlzdGVuZXIgd2FzIHJlbW92ZWQKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLnJlbW92ZUxpc3RlbmVyID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIpIHsKICAgIHZhciBsaXN0LCBwb3NpdGlvbiwgbGVuZ3RoLCBpOwogIAogICAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkKICAgICAgdGhyb3cgVHlwZUVycm9yKCdsaXN0ZW5lciBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAKICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICF0aGlzLl9ldmVudHNbdHlwZV0pCiAgICAgIHJldHVybiB0aGlzOwogIAogICAgbGlzdCA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKICAgIGxlbmd0aCA9IGxpc3QubGVuZ3RoOwogICAgcG9zaXRpb24gPSAtMTsKICAKICAgIGlmIChsaXN0ID09PSBsaXN0ZW5lciB8fAogICAgICAgIChpc0Z1bmN0aW9uKGxpc3QubGlzdGVuZXIpICYmIGxpc3QubGlzdGVuZXIgPT09IGxpc3RlbmVyKSkgewogICAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwogICAgICBpZiAodGhpcy5fZXZlbnRzLnJlbW92ZUxpc3RlbmVyKQogICAgICAgIHRoaXMuZW1pdCgncmVtb3ZlTGlzdGVuZXInLCB0eXBlLCBsaXN0ZW5lcik7CiAgCiAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KGxpc3QpKSB7CiAgICAgIGZvciAoaSA9IGxlbmd0aDsgaS0tID4gMDspIHsKICAgICAgICBpZiAobGlzdFtpXSA9PT0gbGlzdGVuZXIgfHwKICAgICAgICAgICAgKGxpc3RbaV0ubGlzdGVuZXIgJiYgbGlzdFtpXS5saXN0ZW5lciA9PT0gbGlzdGVuZXIpKSB7CiAgICAgICAgICBwb3NpdGlvbiA9IGk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgaWYgKHBvc2l0aW9uIDwgMCkKICAgICAgICByZXR1cm4gdGhpczsKICAKICAgICAgaWYgKGxpc3QubGVuZ3RoID09PSAxKSB7CiAgICAgICAgbGlzdC5sZW5ndGggPSAwOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGlzdC5zcGxpY2UocG9zaXRpb24sIDEpOwogICAgICB9CiAgCiAgICAgIGlmICh0aGlzLl9ldmVudHMucmVtb3ZlTGlzdGVuZXIpCiAgICAgICAgdGhpcy5lbWl0KCdyZW1vdmVMaXN0ZW5lcicsIHR5cGUsIGxpc3RlbmVyKTsKICAgIH0KICAKICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVBbGxMaXN0ZW5lcnMgPSBmdW5jdGlvbih0eXBlKSB7CiAgICB2YXIga2V5LCBsaXN0ZW5lcnM7CiAgCiAgICBpZiAoIXRoaXMuX2V2ZW50cykKICAgICAgcmV0dXJuIHRoaXM7CiAgCiAgICAvLyBub3QgbGlzdGVuaW5nIGZvciByZW1vdmVMaXN0ZW5lciwgbm8gbmVlZCB0byBlbWl0CiAgICBpZiAoIXRoaXMuX2V2ZW50cy5yZW1vdmVMaXN0ZW5lcikgewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkKICAgICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgICAgZWxzZSBpZiAodGhpcy5fZXZlbnRzW3R5cGVdKQogICAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIAogICAgLy8gZW1pdCByZW1vdmVMaXN0ZW5lciBmb3IgYWxsIGxpc3RlbmVycyBvbiBhbGwgZXZlbnRzCiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICBmb3IgKGtleSBpbiB0aGlzLl9ldmVudHMpIHsKICAgICAgICBpZiAoa2V5ID09PSAncmVtb3ZlTGlzdGVuZXInKSBjb250aW51ZTsKICAgICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycyhrZXkpOwogICAgICB9CiAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCdyZW1vdmVMaXN0ZW5lcicpOwogICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgCiAgICBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbdHlwZV07CiAgCiAgICBpZiAoaXNGdW5jdGlvbihsaXN0ZW5lcnMpKSB7CiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgbGlzdGVuZXJzKTsKICAgIH0gZWxzZSBpZiAobGlzdGVuZXJzKSB7CiAgICAgIC8vIExJRk8gb3JkZXIKICAgICAgd2hpbGUgKGxpc3RlbmVycy5sZW5ndGgpCiAgICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcnNbbGlzdGVuZXJzLmxlbmd0aCAtIDFdKTsKICAgIH0KICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07CiAgCiAgICByZXR1cm4gdGhpczsKICB9OwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUubGlzdGVuZXJzID0gZnVuY3Rpb24odHlwZSkgewogICAgdmFyIHJldDsKICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICF0aGlzLl9ldmVudHNbdHlwZV0pCiAgICAgIHJldCA9IFtdOwogICAgZWxzZSBpZiAoaXNGdW5jdGlvbih0aGlzLl9ldmVudHNbdHlwZV0pKQogICAgICByZXQgPSBbdGhpcy5fZXZlbnRzW3R5cGVdXTsKICAgIGVsc2UKICAgICAgcmV0ID0gdGhpcy5fZXZlbnRzW3R5cGVdLnNsaWNlKCk7CiAgICByZXR1cm4gcmV0OwogIH07CiAgCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5saXN0ZW5lckNvdW50ID0gZnVuY3Rpb24odHlwZSkgewogICAgaWYgKHRoaXMuX2V2ZW50cykgewogICAgICB2YXIgZXZsaXN0ZW5lciA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKICAKICAgICAgaWYgKGlzRnVuY3Rpb24oZXZsaXN0ZW5lcikpCiAgICAgICAgcmV0dXJuIDE7CiAgICAgIGVsc2UgaWYgKGV2bGlzdGVuZXIpCiAgICAgICAgcmV0dXJuIGV2bGlzdGVuZXIubGVuZ3RoOwogICAgfQogICAgcmV0dXJuIDA7CiAgfTsKICAKICBFdmVudEVtaXR0ZXIubGlzdGVuZXJDb3VudCA9IGZ1bmN0aW9uKGVtaXR0ZXIsIHR5cGUpIHsKICAgIHJldHVybiBlbWl0dGVyLmxpc3RlbmVyQ291bnQodHlwZSk7CiAgfTsKICAKICBmdW5jdGlvbiBpc0Z1bmN0aW9uKGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdmdW5jdGlvbic7CiAgfQogIAogIGZ1bmN0aW9uIGlzTnVtYmVyKGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdudW1iZXInOwogIH0KICAKICBmdW5jdGlvbiBpc09iamVjdChhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JyAmJiBhcmcgIT09IG51bGw7CiAgfQogIAogIGZ1bmN0aW9uIGlzVW5kZWZpbmVkKGFyZykgewogICAgcmV0dXJuIGFyZyA9PT0gdm9pZCAwOwogIH0KICAKICB9LHt9XSw4MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgZXhwb3J0cy5yZWFkID0gZnVuY3Rpb24gKGJ1ZmZlciwgb2Zmc2V0LCBpc0xFLCBtTGVuLCBuQnl0ZXMpIHsKICAgIHZhciBlLCBtCiAgICB2YXIgZUxlbiA9IChuQnl0ZXMgKiA4KSAtIG1MZW4gLSAxCiAgICB2YXIgZU1heCA9ICgxIDw8IGVMZW4pIC0gMQogICAgdmFyIGVCaWFzID0gZU1heCA+PiAxCiAgICB2YXIgbkJpdHMgPSAtNwogICAgdmFyIGkgPSBpc0xFID8gKG5CeXRlcyAtIDEpIDogMAogICAgdmFyIGQgPSBpc0xFID8gLTEgOiAxCiAgICB2YXIgcyA9IGJ1ZmZlcltvZmZzZXQgKyBpXQogIAogICAgaSArPSBkCiAgCiAgICBlID0gcyAmICgoMSA8PCAoLW5CaXRzKSkgLSAxKQogICAgcyA+Pj0gKC1uQml0cykKICAgIG5CaXRzICs9IGVMZW4KICAgIGZvciAoOyBuQml0cyA+IDA7IGUgPSAoZSAqIDI1NikgKyBidWZmZXJbb2Zmc2V0ICsgaV0sIGkgKz0gZCwgbkJpdHMgLT0gOCkge30KICAKICAgIG0gPSBlICYgKCgxIDw8ICgtbkJpdHMpKSAtIDEpCiAgICBlID4+PSAoLW5CaXRzKQogICAgbkJpdHMgKz0gbUxlbgogICAgZm9yICg7IG5CaXRzID4gMDsgbSA9IChtICogMjU2KSArIGJ1ZmZlcltvZmZzZXQgKyBpXSwgaSArPSBkLCBuQml0cyAtPSA4KSB7fQogIAogICAgaWYgKGUgPT09IDApIHsKICAgICAgZSA9IDEgLSBlQmlhcwogICAgfSBlbHNlIGlmIChlID09PSBlTWF4KSB7CiAgICAgIHJldHVybiBtID8gTmFOIDogKChzID8gLTEgOiAxKSAqIEluZmluaXR5KQogICAgfSBlbHNlIHsKICAgICAgbSA9IG0gKyBNYXRoLnBvdygyLCBtTGVuKQogICAgICBlID0gZSAtIGVCaWFzCiAgICB9CiAgICByZXR1cm4gKHMgPyAtMSA6IDEpICogbSAqIE1hdGgucG93KDIsIGUgLSBtTGVuKQogIH0KICAKICBleHBvcnRzLndyaXRlID0gZnVuY3Rpb24gKGJ1ZmZlciwgdmFsdWUsIG9mZnNldCwgaXNMRSwgbUxlbiwgbkJ5dGVzKSB7CiAgICB2YXIgZSwgbSwgYwogICAgdmFyIGVMZW4gPSAobkJ5dGVzICogOCkgLSBtTGVuIC0gMQogICAgdmFyIGVNYXggPSAoMSA8PCBlTGVuKSAtIDEKICAgIHZhciBlQmlhcyA9IGVNYXggPj4gMQogICAgdmFyIHJ0ID0gKG1MZW4gPT09IDIzID8gTWF0aC5wb3coMiwgLTI0KSAtIE1hdGgucG93KDIsIC03NykgOiAwKQogICAgdmFyIGkgPSBpc0xFID8gMCA6IChuQnl0ZXMgLSAxKQogICAgdmFyIGQgPSBpc0xFID8gMSA6IC0xCiAgICB2YXIgcyA9IHZhbHVlIDwgMCB8fCAodmFsdWUgPT09IDAgJiYgMSAvIHZhbHVlIDwgMCkgPyAxIDogMAogIAogICAgdmFsdWUgPSBNYXRoLmFicyh2YWx1ZSkKICAKICAgIGlmIChpc05hTih2YWx1ZSkgfHwgdmFsdWUgPT09IEluZmluaXR5KSB7CiAgICAgIG0gPSBpc05hTih2YWx1ZSkgPyAxIDogMAogICAgICBlID0gZU1heAogICAgfSBlbHNlIHsKICAgICAgZSA9IE1hdGguZmxvb3IoTWF0aC5sb2codmFsdWUpIC8gTWF0aC5MTjIpCiAgICAgIGlmICh2YWx1ZSAqIChjID0gTWF0aC5wb3coMiwgLWUpKSA8IDEpIHsKICAgICAgICBlLS0KICAgICAgICBjICo9IDIKICAgICAgfQogICAgICBpZiAoZSArIGVCaWFzID49IDEpIHsKICAgICAgICB2YWx1ZSArPSBydCAvIGMKICAgICAgfSBlbHNlIHsKICAgICAgICB2YWx1ZSArPSBydCAqIE1hdGgucG93KDIsIDEgLSBlQmlhcykKICAgICAgfQogICAgICBpZiAodmFsdWUgKiBjID49IDIpIHsKICAgICAgICBlKysKICAgICAgICBjIC89IDIKICAgICAgfQogIAogICAgICBpZiAoZSArIGVCaWFzID49IGVNYXgpIHsKICAgICAgICBtID0gMAogICAgICAgIGUgPSBlTWF4CiAgICAgIH0gZWxzZSBpZiAoZSArIGVCaWFzID49IDEpIHsKICAgICAgICBtID0gKCh2YWx1ZSAqIGMpIC0gMSkgKiBNYXRoLnBvdygyLCBtTGVuKQogICAgICAgIGUgPSBlICsgZUJpYXMKICAgICAgfSBlbHNlIHsKICAgICAgICBtID0gdmFsdWUgKiBNYXRoLnBvdygyLCBlQmlhcyAtIDEpICogTWF0aC5wb3coMiwgbUxlbikKICAgICAgICBlID0gMAogICAgICB9CiAgICB9CiAgCiAgICBmb3IgKDsgbUxlbiA+PSA4OyBidWZmZXJbb2Zmc2V0ICsgaV0gPSBtICYgMHhmZiwgaSArPSBkLCBtIC89IDI1NiwgbUxlbiAtPSA4KSB7fQogIAogICAgZSA9IChlIDw8IG1MZW4pIHwgbQogICAgZUxlbiArPSBtTGVuCiAgICBmb3IgKDsgZUxlbiA+IDA7IGJ1ZmZlcltvZmZzZXQgKyBpXSA9IGUgJiAweGZmLCBpICs9IGQsIGUgLz0gMjU2LCBlTGVuIC09IDgpIHt9CiAgCiAgICBidWZmZXJbb2Zmc2V0ICsgaSAtIGRdIHw9IHMgKiAxMjgKICB9CiAgCiAgfSx7fV0sODM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB0b1N0cmluZyA9IHt9LnRvU3RyaW5nOwogIAogIG1vZHVsZS5leHBvcnRzID0gQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiAoYXJyKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChhcnIpID09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKICAKICB9LHt9XSw4NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAKICAgIGZ1bmN0aW9uIGlzQXJyYXkob2JqKSB7CiAgICAgIGlmIChvYmogIT09IG51bGwpIHsKICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICJbb2JqZWN0IEFycmF5XSI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgCiAgICBmdW5jdGlvbiBpc09iamVjdChvYmopIHsKICAgICAgaWYgKG9iaiAhPT0gbnVsbCkgewogICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gIltvYmplY3QgT2JqZWN0XSI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgCiAgICBmdW5jdGlvbiBzdHJpY3REZWVwRXF1YWwoZmlyc3QsIHNlY29uZCkgewogICAgICAvLyBDaGVjayB0aGUgc2NhbGFyIGNhc2UgZmlyc3QuCiAgICAgIGlmIChmaXJzdCA9PT0gc2Vjb25kKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAKICAgICAgLy8gQ2hlY2sgaWYgdGhleSBhcmUgdGhlIHNhbWUgdHlwZS4KICAgICAgdmFyIGZpcnN0VHlwZSA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChmaXJzdCk7CiAgICAgIGlmIChmaXJzdFR5cGUgIT09IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChzZWNvbmQpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8vIFdlIGtub3cgdGhhdCBmaXJzdCBhbmQgc2Vjb25kIGhhdmUgdGhlIHNhbWUgdHlwZSBzbyB3ZSBjYW4ganVzdCBjaGVjayB0aGUKICAgICAgLy8gZmlyc3QgdHlwZSBmcm9tIG5vdyBvbi4KICAgICAgaWYgKGlzQXJyYXkoZmlyc3QpID09PSB0cnVlKSB7CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiB0aGV5J3JlIG5vdCB0aGUgc2FtZSBsZW5ndGg7CiAgICAgICAgaWYgKGZpcnN0Lmxlbmd0aCAhPT0gc2Vjb25kLmxlbmd0aCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZpcnN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoc3RyaWN0RGVlcEVxdWFsKGZpcnN0W2ldLCBzZWNvbmRbaV0pID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmIChpc09iamVjdChmaXJzdCkgPT09IHRydWUpIHsKICAgICAgICAvLyBBbiBvYmplY3QgaXMgZXF1YWwgaWYgaXQgaGFzIHRoZSBzYW1lIGtleS92YWx1ZSBwYWlycy4KICAgICAgICB2YXIga2V5c1NlZW4gPSB7fTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZmlyc3QpIHsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGZpcnN0LCBrZXkpKSB7CiAgICAgICAgICAgIGlmIChzdHJpY3REZWVwRXF1YWwoZmlyc3Rba2V5XSwgc2Vjb25kW2tleV0pID09PSBmYWxzZSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBrZXlzU2VlbltrZXldID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gTm93IGNoZWNrIHRoYXQgdGhlcmUgYXJlbid0IGFueSBrZXlzIGluIHNlY29uZCB0aGF0IHdlcmVuJ3QKICAgICAgICAvLyBpbiBmaXJzdC4KICAgICAgICBmb3IgKHZhciBrZXkyIGluIHNlY29uZCkgewogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoc2Vjb25kLCBrZXkyKSkgewogICAgICAgICAgICBpZiAoa2V5c1NlZW5ba2V5Ml0gIT09IHRydWUpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIAogICAgZnVuY3Rpb24gaXNGYWxzZShvYmopIHsKICAgICAgLy8gRnJvbSB0aGUgc3BlYzoKICAgICAgLy8gQSBmYWxzZSB2YWx1ZSBjb3JyZXNwb25kcyB0byB0aGUgZm9sbG93aW5nIHZhbHVlczoKICAgICAgLy8gRW1wdHkgbGlzdAogICAgICAvLyBFbXB0eSBvYmplY3QKICAgICAgLy8gRW1wdHkgc3RyaW5nCiAgICAgIC8vIEZhbHNlIGJvb2xlYW4KICAgICAgLy8gbnVsbCB2YWx1ZQogIAogICAgICAvLyBGaXJzdCBjaGVjayB0aGUgc2NhbGFyIHZhbHVlcy4KICAgICAgaWYgKG9iaiA9PT0gIiIgfHwgb2JqID09PSBmYWxzZSB8fCBvYmogPT09IG51bGwpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgaWYgKGlzQXJyYXkob2JqKSAmJiBvYmoubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAvLyBDaGVjayBmb3IgYW4gZW1wdHkgYXJyYXkuCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmIChpc09iamVjdChvYmopKSB7CiAgICAgICAgICAvLyBDaGVjayBmb3IgYW4gZW1wdHkgb2JqZWN0LgogICAgICAgICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICAgICAgICAgIC8vIElmIHRoZXJlIGFyZSBhbnkga2V5cywgdGhlbgogICAgICAgICAgICAgIC8vIHRoZSBvYmplY3QgaXMgbm90IGVtcHR5IHNvIHRoZSBvYmplY3QKICAgICAgICAgICAgICAvLyBpcyBub3QgZmFsc2UuCiAgICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAKICAgIGZ1bmN0aW9uIG9ialZhbHVlcyhvYmopIHsKICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvYmopOwogICAgICB2YXIgdmFsdWVzID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhbHVlcy5wdXNoKG9ialtrZXlzW2ldXSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbHVlczsKICAgIH0KICAKICAgIGZ1bmN0aW9uIG1lcmdlKGEsIGIpIHsKICAgICAgICB2YXIgbWVyZ2VkID0ge307CiAgICAgICAgZm9yICh2YXIga2V5IGluIGEpIHsKICAgICAgICAgICAgbWVyZ2VkW2tleV0gPSBhW2tleV07CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGtleTIgaW4gYikgewogICAgICAgICAgICBtZXJnZWRba2V5Ml0gPSBiW2tleTJdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbWVyZ2VkOwogICAgfQogIAogICAgdmFyIHRyaW1MZWZ0OwogICAgaWYgKHR5cGVvZiBTdHJpbmcucHJvdG90eXBlLnRyaW1MZWZ0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRyaW1MZWZ0ID0gZnVuY3Rpb24oc3RyKSB7CiAgICAgICAgcmV0dXJuIHN0ci50cmltTGVmdCgpOwogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgdHJpbUxlZnQgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICByZXR1cm4gc3RyLm1hdGNoKC9eXHMqKC4qKS8pWzFdOwogICAgICB9OwogICAgfQogIAogICAgLy8gVHlwZSBjb25zdGFudHMgdXNlZCB0byBkZWZpbmUgZnVuY3Rpb25zLgogICAgdmFyIFRZUEVfTlVNQkVSID0gMDsKICAgIHZhciBUWVBFX0FOWSA9IDE7CiAgICB2YXIgVFlQRV9TVFJJTkcgPSAyOwogICAgdmFyIFRZUEVfQVJSQVkgPSAzOwogICAgdmFyIFRZUEVfT0JKRUNUID0gNDsKICAgIHZhciBUWVBFX0JPT0xFQU4gPSA1OwogICAgdmFyIFRZUEVfRVhQUkVGID0gNjsKICAgIHZhciBUWVBFX05VTEwgPSA3OwogICAgdmFyIFRZUEVfQVJSQVlfTlVNQkVSID0gODsKICAgIHZhciBUWVBFX0FSUkFZX1NUUklORyA9IDk7CiAgCiAgICB2YXIgVE9LX0VPRiA9ICJFT0YiOwogICAgdmFyIFRPS19VTlFVT1RFRElERU5USUZJRVIgPSAiVW5xdW90ZWRJZGVudGlmaWVyIjsKICAgIHZhciBUT0tfUVVPVEVESURFTlRJRklFUiA9ICJRdW90ZWRJZGVudGlmaWVyIjsKICAgIHZhciBUT0tfUkJSQUNLRVQgPSAiUmJyYWNrZXQiOwogICAgdmFyIFRPS19SUEFSRU4gPSAiUnBhcmVuIjsKICAgIHZhciBUT0tfQ09NTUEgPSAiQ29tbWEiOwogICAgdmFyIFRPS19DT0xPTiA9ICJDb2xvbiI7CiAgICB2YXIgVE9LX1JCUkFDRSA9ICJSYnJhY2UiOwogICAgdmFyIFRPS19OVU1CRVIgPSAiTnVtYmVyIjsKICAgIHZhciBUT0tfQ1VSUkVOVCA9ICJDdXJyZW50IjsKICAgIHZhciBUT0tfRVhQUkVGID0gIkV4cHJlZiI7CiAgICB2YXIgVE9LX1BJUEUgPSAiUGlwZSI7CiAgICB2YXIgVE9LX09SID0gIk9yIjsKICAgIHZhciBUT0tfQU5EID0gIkFuZCI7CiAgICB2YXIgVE9LX0VRID0gIkVRIjsKICAgIHZhciBUT0tfR1QgPSAiR1QiOwogICAgdmFyIFRPS19MVCA9ICJMVCI7CiAgICB2YXIgVE9LX0dURSA9ICJHVEUiOwogICAgdmFyIFRPS19MVEUgPSAiTFRFIjsKICAgIHZhciBUT0tfTkUgPSAiTkUiOwogICAgdmFyIFRPS19GTEFUVEVOID0gIkZsYXR0ZW4iOwogICAgdmFyIFRPS19TVEFSID0gIlN0YXIiOwogICAgdmFyIFRPS19GSUxURVIgPSAiRmlsdGVyIjsKICAgIHZhciBUT0tfRE9UID0gIkRvdCI7CiAgICB2YXIgVE9LX05PVCA9ICJOb3QiOwogICAgdmFyIFRPS19MQlJBQ0UgPSAiTGJyYWNlIjsKICAgIHZhciBUT0tfTEJSQUNLRVQgPSAiTGJyYWNrZXQiOwogICAgdmFyIFRPS19MUEFSRU49ICJMcGFyZW4iOwogICAgdmFyIFRPS19MSVRFUkFMPSAiTGl0ZXJhbCI7CiAgCiAgICAvLyBUaGUgIiYiLCAiWyIsICI8IiwgIj4iIHRva2VucwogICAgLy8gYXJlIG5vdCBpbiBiYXNpY1Rva2VuIGJlY2F1c2UKICAgIC8vIHRoZXJlIGFyZSB0d28gdG9rZW4gdmFyaWFudHMKICAgIC8vICgiJiYiLCAiWz8iLCAiPD0iLCAiPj0iKS4gIFRoaXMgaXMgc3BlY2lhbGx5IGhhbmRsZWQKICAgIC8vIGJlbG93LgogIAogICAgdmFyIGJhc2ljVG9rZW5zID0gewogICAgICAiLiI6IFRPS19ET1QsCiAgICAgICIqIjogVE9LX1NUQVIsCiAgICAgICIsIjogVE9LX0NPTU1BLAogICAgICAiOiI6IFRPS19DT0xPTiwKICAgICAgInsiOiBUT0tfTEJSQUNFLAogICAgICAifSI6IFRPS19SQlJBQ0UsCiAgICAgICJdIjogVE9LX1JCUkFDS0VULAogICAgICAiKCI6IFRPS19MUEFSRU4sCiAgICAgICIpIjogVE9LX1JQQVJFTiwKICAgICAgIkAiOiBUT0tfQ1VSUkVOVAogICAgfTsKICAKICAgIHZhciBvcGVyYXRvclN0YXJ0VG9rZW4gPSB7CiAgICAgICAgIjwiOiB0cnVlLAogICAgICAgICI+IjogdHJ1ZSwKICAgICAgICAiPSI6IHRydWUsCiAgICAgICAgIiEiOiB0cnVlCiAgICB9OwogIAogICAgdmFyIHNraXBDaGFycyA9IHsKICAgICAgICAiICI6IHRydWUsCiAgICAgICAgIlx0IjogdHJ1ZSwKICAgICAgICAiXG4iOiB0cnVlCiAgICB9OwogIAogIAogICAgZnVuY3Rpb24gaXNBbHBoYShjaCkgewogICAgICAgIHJldHVybiAoY2ggPj0gImEiICYmIGNoIDw9ICJ6IikgfHwKICAgICAgICAgICAgICAgKGNoID49ICJBIiAmJiBjaCA8PSAiWiIpIHx8CiAgICAgICAgICAgICAgIGNoID09PSAiXyI7CiAgICB9CiAgCiAgICBmdW5jdGlvbiBpc051bShjaCkgewogICAgICAgIHJldHVybiAoY2ggPj0gIjAiICYmIGNoIDw9ICI5IikgfHwKICAgICAgICAgICAgICAgY2ggPT09ICItIjsKICAgIH0KICAgIGZ1bmN0aW9uIGlzQWxwaGFOdW0oY2gpIHsKICAgICAgICByZXR1cm4gKGNoID49ICJhIiAmJiBjaCA8PSAieiIpIHx8CiAgICAgICAgICAgICAgIChjaCA+PSAiQSIgJiYgY2ggPD0gIloiKSB8fAogICAgICAgICAgICAgICAoY2ggPj0gIjAiICYmIGNoIDw9ICI5IikgfHwKICAgICAgICAgICAgICAgY2ggPT09ICJfIjsKICAgIH0KICAKICAgIGZ1bmN0aW9uIExleGVyKCkgewogICAgfQogICAgTGV4ZXIucHJvdG90eXBlID0gewogICAgICAgIHRva2VuaXplOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdmFyIHRva2VucyA9IFtdOwogICAgICAgICAgICB0aGlzLl9jdXJyZW50ID0gMDsKICAgICAgICAgICAgdmFyIHN0YXJ0OwogICAgICAgICAgICB2YXIgaWRlbnRpZmllcjsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICB3aGlsZSAodGhpcy5fY3VycmVudCA8IHN0cmVhbS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGlmIChpc0FscGhhKHN0cmVhbVt0aGlzLl9jdXJyZW50XSkpIHsKICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgaWRlbnRpZmllciA9IHRoaXMuX2NvbnN1bWVVbnF1b3RlZElkZW50aWZpZXIoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX1VOUVVPVEVESURFTlRJRklFUiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGlkZW50aWZpZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChiYXNpY1Rva2Vuc1tzdHJlYW1bdGhpcy5fY3VycmVudF1dICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogYmFzaWNUb2tlbnNbc3RyZWFtW3RoaXMuX2N1cnJlbnRdXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogc3RyZWFtW3RoaXMuX2N1cnJlbnRdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiB0aGlzLl9jdXJyZW50fSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc051bShzdHJlYW1bdGhpcy5fY3VycmVudF0pKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW4gPSB0aGlzLl9jb25zdW1lTnVtYmVyKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJbIikgewogICAgICAgICAgICAgICAgICAgIC8vIE5vIG5lZWQgdG8gaW5jcmVtZW50IHRoaXMuX2N1cnJlbnQuICBUaGlzIGhhcHBlbnMKICAgICAgICAgICAgICAgICAgICAvLyBpbiBfY29uc3VtZUxCcmFja2V0CiAgICAgICAgICAgICAgICAgICAgdG9rZW4gPSB0aGlzLl9jb25zdW1lTEJyYWNrZXQoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh0b2tlbik7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIlwiIikgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgICBpZGVudGlmaWVyID0gdGhpcy5fY29uc3VtZVF1b3RlZElkZW50aWZpZXIoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX1FVT1RFRElERU5USUZJRVIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpZGVudGlmaWVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiJyIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgaWRlbnRpZmllciA9IHRoaXMuX2NvbnN1bWVSYXdTdHJpbmdMaXRlcmFsKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19MSVRFUkFMLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaWRlbnRpZmllciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gImAiKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICAgIHZhciBsaXRlcmFsID0gdGhpcy5fY29uc3VtZUxpdGVyYWwoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX0xJVEVSQUwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBsaXRlcmFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3JTdGFydFRva2VuW3N0cmVhbVt0aGlzLl9jdXJyZW50XV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHRoaXMuX2NvbnN1bWVPcGVyYXRvcihzdHJlYW0pKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2tpcENoYXJzW3N0cmVhbVt0aGlzLl9jdXJyZW50XV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSB3aGl0ZXNwYWNlLgogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiJiIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICImIikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfQU5ELCB2YWx1ZTogIiYmIiwgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19FWFBSRUYsIHZhbHVlOiAiJiIsIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAifCIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJ8IikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfT1IsIHZhbHVlOiAifHwiLCBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX1BJUEUsIHZhbHVlOiAifCIsIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJVbmtub3duIGNoYXJhY3RlcjoiICsgc3RyZWFtW3RoaXMuX2N1cnJlbnRdKTsKICAgICAgICAgICAgICAgICAgICBlcnJvci5uYW1lID0gIkxleGVyRXJyb3IiOwogICAgICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0b2tlbnM7CiAgICAgICAgfSwKICAKICAgICAgICBfY29uc3VtZVVucXVvdGVkSWRlbnRpZmllcjogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2N1cnJlbnQgPCBzdHJlYW0ubGVuZ3RoICYmIGlzQWxwaGFOdW0oc3RyZWFtW3RoaXMuX2N1cnJlbnRdKSkgewogICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzdHJlYW0uc2xpY2Uoc3RhcnQsIHRoaXMuX2N1cnJlbnQpOwogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVRdW90ZWRJZGVudGlmaWVyOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICB2YXIgbWF4TGVuZ3RoID0gc3RyZWFtLmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSAhPT0gIlwiIiAmJiB0aGlzLl9jdXJyZW50IDwgbWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAvLyBZb3UgY2FuIGVzY2FwZSBhIGRvdWJsZSBxdW90ZSBhbmQgeW91IGNhbiBlc2NhcGUgYW4gZXNjYXBlLgogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgaWYgKHN0cmVhbVtjdXJyZW50XSA9PT0gIlxcIiAmJiAoc3RyZWFtW2N1cnJlbnQgKyAxXSA9PT0gIlxcIiB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtW2N1cnJlbnQgKyAxXSA9PT0gIlwiIikpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50ICs9IDI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQgPSBjdXJyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2Uoc3RyZWFtLnNsaWNlKHN0YXJ0LCB0aGlzLl9jdXJyZW50KSk7CiAgICAgICAgfSwKICAKICAgICAgICBfY29uc3VtZVJhd1N0cmluZ0xpdGVyYWw6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHZhciBtYXhMZW5ndGggPSBzdHJlYW0ubGVuZ3RoOwogICAgICAgICAgICB3aGlsZSAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdICE9PSAiJyIgJiYgdGhpcy5fY3VycmVudCA8IG1heExlbmd0aCkgewogICAgICAgICAgICAgICAgLy8gWW91IGNhbiBlc2NhcGUgYSBzaW5nbGUgcXVvdGUgYW5kIHlvdSBjYW4gZXNjYXBlIGFuIGVzY2FwZS4KICAgICAgICAgICAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bY3VycmVudF0gPT09ICJcXCIgJiYgKHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICJcXCIgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICInIikpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50ICs9IDI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQgPSBjdXJyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgdmFyIGxpdGVyYWwgPSBzdHJlYW0uc2xpY2Uoc3RhcnQgKyAxLCB0aGlzLl9jdXJyZW50IC0gMSk7CiAgICAgICAgICAgIHJldHVybiBsaXRlcmFsLnJlcGxhY2UoIlxcJyIsICInIik7CiAgICAgICAgfSwKICAKICAgICAgICBfY29uc3VtZU51bWJlcjogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgdmFyIG1heExlbmd0aCA9IHN0cmVhbS5sZW5ndGg7CiAgICAgICAgICAgIHdoaWxlIChpc051bShzdHJlYW1bdGhpcy5fY3VycmVudF0pICYmIHRoaXMuX2N1cnJlbnQgPCBtYXhMZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJzZUludChzdHJlYW0uc2xpY2Uoc3RhcnQsIHRoaXMuX2N1cnJlbnQpKTsKICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTlVNQkVSLCB2YWx1ZTogdmFsdWUsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgfSwKICAKICAgICAgICBfY29uc3VtZUxCcmFja2V0OiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiPyIpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0ZJTFRFUiwgdmFsdWU6ICJbPyIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiXSIpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0ZMQVRURU4sIHZhbHVlOiAiW10iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTEJSQUNLRVQsIHZhbHVlOiAiWyIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIF9jb25zdW1lT3BlcmF0b3I6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICB2YXIgc3RhcnRpbmdDaGFyID0gc3RyZWFtW3N0YXJ0XTsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICBpZiAoc3RhcnRpbmdDaGFyID09PSAiISIpIHsKICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICI9IikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19ORSwgdmFsdWU6ICIhPSIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19OT1QsIHZhbHVlOiAiISIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnRpbmdDaGFyID09PSAiPCIpIHsKICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICI9IikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19MVEUsIHZhbHVlOiAiPD0iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19MVCwgdmFsdWU6ICI8Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFydGluZ0NoYXIgPT09ICI+IikgewogICAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIj0iKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0dURSwgdmFsdWU6ICI+PSIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0dULCB2YWx1ZTogIj4iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0aW5nQ2hhciA9PT0gIj0iKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiPSIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfRVEsIHZhbHVlOiAiPT0iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBfY29uc3VtZUxpdGVyYWw6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgIHZhciBtYXhMZW5ndGggPSBzdHJlYW0ubGVuZ3RoOwogICAgICAgICAgICB2YXIgbGl0ZXJhbDsKICAgICAgICAgICAgd2hpbGUoc3RyZWFtW3RoaXMuX2N1cnJlbnRdICE9PSAiYCIgJiYgdGhpcy5fY3VycmVudCA8IG1heExlbmd0aCkgewogICAgICAgICAgICAgICAgLy8gWW91IGNhbiBlc2NhcGUgYSBsaXRlcmFsIGNoYXIgb3IgeW91IGNhbiBlc2NhcGUgdGhlIGVzY2FwZS4KICAgICAgICAgICAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bY3VycmVudF0gPT09ICJcXCIgJiYgKHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICJcXCIgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICJgIikpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50ICs9IDI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQgPSBjdXJyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBsaXRlcmFsU3RyaW5nID0gdHJpbUxlZnQoc3RyZWFtLnNsaWNlKHN0YXJ0LCB0aGlzLl9jdXJyZW50KSk7CiAgICAgICAgICAgIGxpdGVyYWxTdHJpbmcgPSBsaXRlcmFsU3RyaW5nLnJlcGxhY2UoIlxcYCIsICJgIik7CiAgICAgICAgICAgIGlmICh0aGlzLl9sb29rc0xpa2VKU09OKGxpdGVyYWxTdHJpbmcpKSB7CiAgICAgICAgICAgICAgICBsaXRlcmFsID0gSlNPTi5wYXJzZShsaXRlcmFsU3RyaW5nKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFRyeSB0byBKU09OIHBhcnNlIGl0IGFzICI8bGl0ZXJhbD4iCiAgICAgICAgICAgICAgICBsaXRlcmFsID0gSlNPTi5wYXJzZSgiXCIiICsgbGl0ZXJhbFN0cmluZyArICJcIiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vICsxIGdldHMgdXMgdG8gdGhlIGVuZGluZyAiYCIsICsxIHRvIG1vdmUgb24gdG8gdGhlIG5leHQgY2hhci4KICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICByZXR1cm4gbGl0ZXJhbDsKICAgICAgICB9LAogIAogICAgICAgIF9sb29rc0xpa2VKU09OOiBmdW5jdGlvbihsaXRlcmFsU3RyaW5nKSB7CiAgICAgICAgICAgIHZhciBzdGFydGluZ0NoYXJzID0gIlt7XCIiOwogICAgICAgICAgICB2YXIganNvbkxpdGVyYWxzID0gWyJ0cnVlIiwgImZhbHNlIiwgIm51bGwiXTsKICAgICAgICAgICAgdmFyIG51bWJlckxvb2tpbmcgPSAiLTAxMjM0NTY3ODkiOwogIAogICAgICAgICAgICBpZiAobGl0ZXJhbFN0cmluZyA9PT0gIiIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFydGluZ0NoYXJzLmluZGV4T2YobGl0ZXJhbFN0cmluZ1swXSkgPj0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoanNvbkxpdGVyYWxzLmluZGV4T2YobGl0ZXJhbFN0cmluZykgPj0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobnVtYmVyTG9va2luZy5pbmRleE9mKGxpdGVyYWxTdHJpbmdbMF0pID49IDApIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgSlNPTi5wYXJzZShsaXRlcmFsU3RyaW5nKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAKICAgICAgICB2YXIgYmluZGluZ1Bvd2VyID0ge307CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19FT0ZdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX1VOUVVPVEVESURFTlRJRklFUl0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfUVVPVEVESURFTlRJRklFUl0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfUkJSQUNLRVRdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX1JQQVJFTl0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfQ09NTUFdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX1JCUkFDRV0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfTlVNQkVSXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19DVVJSRU5UXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19FWFBSRUZdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX1BJUEVdID0gMTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX09SXSA9IDI7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19BTkRdID0gMzsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0VRXSA9IDU7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19HVF0gPSA1OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfTFRdID0gNTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0dURV0gPSA1OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfTFRFXSA9IDU7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19ORV0gPSA1OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfRkxBVFRFTl0gPSA5OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfU1RBUl0gPSAyMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0ZJTFRFUl0gPSAyMTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0RPVF0gPSA0MDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX05PVF0gPSA0NTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0xCUkFDRV0gPSA1MDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0xCUkFDS0VUXSA9IDU1OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfTFBBUkVOXSA9IDYwOwogIAogICAgZnVuY3Rpb24gUGFyc2VyKCkgewogICAgfQogIAogICAgUGFyc2VyLnByb3RvdHlwZSA9IHsKICAgICAgICBwYXJzZTogZnVuY3Rpb24oZXhwcmVzc2lvbikgewogICAgICAgICAgICB0aGlzLl9sb2FkVG9rZW5zKGV4cHJlc3Npb24pOwogICAgICAgICAgICB0aGlzLmluZGV4ID0gMDsKICAgICAgICAgICAgdmFyIGFzdCA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSAhPT0gVE9LX0VPRikgewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigKICAgICAgICAgICAgICAgICAgICAiVW5leHBlY3RlZCB0b2tlbiB0eXBlOiAiICsgdC50eXBlICsgIiwgdmFsdWU6ICIgKyB0LnZhbHVlKTsKICAgICAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiUGFyc2VyRXJyb3IiOwogICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFzdDsKICAgICAgICB9LAogIAogICAgICAgIF9sb2FkVG9rZW5zOiBmdW5jdGlvbihleHByZXNzaW9uKSB7CiAgICAgICAgICAgIHZhciBsZXhlciA9IG5ldyBMZXhlcigpOwogICAgICAgICAgICB2YXIgdG9rZW5zID0gbGV4ZXIudG9rZW5pemUoZXhwcmVzc2lvbik7CiAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfRU9GLCB2YWx1ZTogIiIsIHN0YXJ0OiBleHByZXNzaW9uLmxlbmd0aH0pOwogICAgICAgICAgICB0aGlzLnRva2VucyA9IHRva2VuczsKICAgICAgICB9LAogIAogICAgICAgIGV4cHJlc3Npb246IGZ1bmN0aW9uKHJicCkgewogICAgICAgICAgICB2YXIgbGVmdFRva2VuID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgdmFyIGxlZnQgPSB0aGlzLm51ZChsZWZ0VG9rZW4pOwogICAgICAgICAgICB2YXIgY3VycmVudFRva2VuID0gdGhpcy5fbG9va2FoZWFkKDApOwogICAgICAgICAgICB3aGlsZSAocmJwIDwgYmluZGluZ1Bvd2VyW2N1cnJlbnRUb2tlbl0pIHsKICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgIGxlZnQgPSB0aGlzLmxlZChjdXJyZW50VG9rZW4sIGxlZnQpOwogICAgICAgICAgICAgICAgY3VycmVudFRva2VuID0gdGhpcy5fbG9va2FoZWFkKDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgIH0sCiAgCiAgICAgICAgX2xvb2thaGVhZDogZnVuY3Rpb24obnVtYmVyKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRva2Vuc1t0aGlzLmluZGV4ICsgbnVtYmVyXS50eXBlOwogICAgICAgIH0sCiAgCiAgICAgICAgX2xvb2thaGVhZFRva2VuOiBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudG9rZW5zW3RoaXMuaW5kZXggKyBudW1iZXJdOwogICAgICAgIH0sCiAgCiAgICAgICAgX2FkdmFuY2U6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmluZGV4Kys7CiAgICAgICAgfSwKICAKICAgICAgICBudWQ6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgICB2YXIgbGVmdDsKICAgICAgICAgIHZhciByaWdodDsKICAgICAgICAgIHZhciBleHByZXNzaW9uOwogICAgICAgICAgc3dpdGNoICh0b2tlbi50eXBlKSB7CiAgICAgICAgICAgIGNhc2UgVE9LX0xJVEVSQUw6CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiTGl0ZXJhbCIsIHZhbHVlOiB0b2tlbi52YWx1ZX07CiAgICAgICAgICAgIGNhc2UgVE9LX1VOUVVPVEVESURFTlRJRklFUjoKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJGaWVsZCIsIG5hbWU6IHRva2VuLnZhbHVlfTsKICAgICAgICAgICAgY2FzZSBUT0tfUVVPVEVESURFTlRJRklFUjoKICAgICAgICAgICAgICB2YXIgbm9kZSA9IHt0eXBlOiAiRmllbGQiLCBuYW1lOiB0b2tlbi52YWx1ZX07CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0xQQVJFTikgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlF1b3RlZCBpZGVudGlmaWVyIG5vdCBhbGxvd2VkIGZvciBmdW5jdGlvbiBuYW1lcy4iKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVE9LX05PVDoKICAgICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihiaW5kaW5nUG93ZXIuTm90KTsKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJOb3RFeHByZXNzaW9uIiwgY2hpbGRyZW46IFtyaWdodF19OwogICAgICAgICAgICBjYXNlIFRPS19TVEFSOgogICAgICAgICAgICAgIGxlZnQgPSB7dHlwZTogIklkZW50aXR5In07CiAgICAgICAgICAgICAgcmlnaHQgPSBudWxsOwogICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19SQlJBQ0tFVCkgewogICAgICAgICAgICAgICAgICAvLyBUaGlzIGNhbiBoYXBwZW4gaW4gYSBtdWx0aXNlbGVjdCwKICAgICAgICAgICAgICAgICAgLy8gW2EsIGIsICpdCiAgICAgICAgICAgICAgICAgIHJpZ2h0ID0ge3R5cGU6ICJJZGVudGl0eSJ9OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5TdGFyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiVmFsdWVQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICBjYXNlIFRPS19GSUxURVI6CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubGVkKHRva2VuLnR5cGUsIHt0eXBlOiAiSWRlbnRpdHkifSk7CiAgICAgICAgICAgIGNhc2UgVE9LX0xCUkFDRToKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VNdWx0aXNlbGVjdEhhc2goKTsKICAgICAgICAgICAgY2FzZSBUT0tfRkxBVFRFTjoKICAgICAgICAgICAgICBsZWZ0ID0ge3R5cGU6IFRPS19GTEFUVEVOLCBjaGlsZHJlbjogW3t0eXBlOiAiSWRlbnRpdHkifV19OwogICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5GbGF0dGVuKTsKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICBjYXNlIFRPS19MQlJBQ0tFVDoKICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfTlVNQkVSIHx8IHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NPTE9OKSB7CiAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VJbmRleEV4cHJlc3Npb24oKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Byb2plY3RJZlNsaWNlKHt0eXBlOiAiSWRlbnRpdHkifSwgcmlnaHQpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfU1RBUiAmJgogICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9va2FoZWFkKDEpID09PSBUT0tfUkJSQUNLRVQpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5TdGFyKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiUHJvamVjdGlvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFt7dHlwZTogIklkZW50aXR5In0sIHJpZ2h0XX07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlTXVsdGlzZWxlY3RMaXN0KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRPS19DVVJSRU5UOgogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0NVUlJFTlR9OwogICAgICAgICAgICBjYXNlIFRPS19FWFBSRUY6CiAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHRoaXMuZXhwcmVzc2lvbihiaW5kaW5nUG93ZXIuRXhwcmVmKTsKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJFeHByZXNzaW9uUmVmZXJlbmNlIiwgY2hpbGRyZW46IFtleHByZXNzaW9uXX07CiAgICAgICAgICAgIGNhc2UgVE9LX0xQQVJFTjoKICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICAgIHdoaWxlICh0aGlzLl9sb29rYWhlYWQoMCkgIT09IFRPS19SUEFSRU4pIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DVVJSRU5UKSB7CiAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB7dHlwZTogVE9LX0NVUlJFTlR9OwogICAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBleHByZXNzaW9uID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXJncy5wdXNoKGV4cHJlc3Npb24pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUlBBUkVOKTsKICAgICAgICAgICAgICByZXR1cm4gYXJnc1swXTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aGlzLl9lcnJvclRva2VuKHRva2VuKTsKICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIGxlZDogZnVuY3Rpb24odG9rZW5OYW1lLCBsZWZ0KSB7CiAgICAgICAgICB2YXIgcmlnaHQ7CiAgICAgICAgICBzd2l0Y2godG9rZW5OYW1lKSB7CiAgICAgICAgICAgIGNhc2UgVE9LX0RPVDoKICAgICAgICAgICAgICB2YXIgcmJwID0gYmluZGluZ1Bvd2VyLkRvdDsKICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApICE9PSBUT0tfU1RBUikgewogICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlRG90UkhTKHJicCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlN1YmV4cHJlc3Npb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgLy8gQ3JlYXRpbmcgYSBwcm9qZWN0aW9uLgogICAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKHJicCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlZhbHVlUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVE9LX1BJUEU6CiAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyLlBpcGUpOwogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX1BJUEUsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgY2FzZSBUT0tfT1I6CiAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyLk9yKTsKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJPckV4cHJlc3Npb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgIGNhc2UgVE9LX0FORDoKICAgICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihiaW5kaW5nUG93ZXIuQW5kKTsKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJBbmRFeHByZXNzaW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICBjYXNlIFRPS19MUEFSRU46CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBsZWZ0Lm5hbWU7CiAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgICB2YXIgZXhwcmVzc2lvbiwgbm9kZTsKICAgICAgICAgICAgICB3aGlsZSAodGhpcy5fbG9va2FoZWFkKDApICE9PSBUT0tfUlBBUkVOKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ1VSUkVOVCkgewogICAgICAgICAgICAgICAgICBleHByZXNzaW9uID0ge3R5cGU6IFRPS19DVVJSRU5UfTsKICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DT01NQSkgewogICAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfQ09NTUEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXJncy5wdXNoKGV4cHJlc3Npb24pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUlBBUkVOKTsKICAgICAgICAgICAgICBub2RlID0ge3R5cGU6ICJGdW5jdGlvbiIsIG5hbWU6IG5hbWUsIGNoaWxkcmVuOiBhcmdzfTsKICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgY2FzZSBUT0tfRklMVEVSOgogICAgICAgICAgICAgIHZhciBjb25kaXRpb24gPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDS0VUKTsKICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfRkxBVFRFTikgewogICAgICAgICAgICAgICAgcmlnaHQgPSB7dHlwZTogIklkZW50aXR5In07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5GaWx0ZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJGaWx0ZXJQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodCwgY29uZGl0aW9uXX07CiAgICAgICAgICAgIGNhc2UgVE9LX0ZMQVRURU46CiAgICAgICAgICAgICAgdmFyIGxlZnROb2RlID0ge3R5cGU6IFRPS19GTEFUVEVOLCBjaGlsZHJlbjogW2xlZnRdfTsKICAgICAgICAgICAgICB2YXIgcmlnaHROb2RlID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5GbGF0dGVuKTsKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0Tm9kZSwgcmlnaHROb2RlXX07CiAgICAgICAgICAgIGNhc2UgVE9LX0VROgogICAgICAgICAgICBjYXNlIFRPS19ORToKICAgICAgICAgICAgY2FzZSBUT0tfR1Q6CiAgICAgICAgICAgIGNhc2UgVE9LX0dURToKICAgICAgICAgICAgY2FzZSBUT0tfTFQ6CiAgICAgICAgICAgIGNhc2UgVE9LX0xURToKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VDb21wYXJhdG9yKGxlZnQsIHRva2VuTmFtZSk7CiAgICAgICAgICAgIGNhc2UgVE9LX0xCUkFDS0VUOgogICAgICAgICAgICAgIHZhciB0b2tlbiA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgICAgIGlmICh0b2tlbi50eXBlID09PSBUT0tfTlVNQkVSIHx8IHRva2VuLnR5cGUgPT09IFRPS19DT0xPTikgewogICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlSW5kZXhFeHByZXNzaW9uKCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wcm9qZWN0SWZTbGljZShsZWZ0LCByaWdodCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1NUQVIpOwogICAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNLRVQpOwogICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuU3Rhcik7CiAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRoaXMuX2Vycm9yVG9rZW4odGhpcy5fbG9va2FoZWFkVG9rZW4oMCkpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgX21hdGNoOiBmdW5jdGlvbih0b2tlblR5cGUpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gdG9rZW5UeXBlKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJFeHBlY3RlZCAiICsgdG9rZW5UeXBlICsgIiwgZ290OiAiICsgdC50eXBlKTsKICAgICAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiUGFyc2VyRXJyb3IiOwogICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIF9lcnJvclRva2VuOiBmdW5jdGlvbih0b2tlbikgewogICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIkludmFsaWQgdG9rZW4gKCIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW4udHlwZSArICIpOiBcIiIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW4udmFsdWUgKyAiXCIiKTsKICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJQYXJzZXJFcnJvciI7CiAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgIH0sCiAgCiAgCiAgICAgICAgX3BhcnNlSW5kZXhFeHByZXNzaW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NPTE9OIHx8IHRoaXMuX2xvb2thaGVhZCgxKSA9PT0gVE9LX0NPTE9OKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VTbGljZUV4cHJlc3Npb24oKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBub2RlID0gewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJJbmRleCIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHRoaXMuX2xvb2thaGVhZFRva2VuKDApLnZhbHVlfTsKICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0tFVCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgX3Byb2plY3RJZlNsaWNlOiBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgICAgICB2YXIgaW5kZXhFeHByID0ge3R5cGU6ICJJbmRleEV4cHJlc3Npb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgIGlmIChyaWdodC50eXBlID09PSAiU2xpY2UiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJQcm9qZWN0aW9uIiwKICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogW2luZGV4RXhwciwgdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5TdGFyKV0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaW5kZXhFeHByOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBfcGFyc2VTbGljZUV4cHJlc3Npb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyBbc3RhcnQ6ZW5kOnN0ZXBdIHdoZXJlIGVhY2ggcGFydCBpcyBvcHRpb25hbCwgYXMgd2VsbCBhcyB0aGUgbGFzdAogICAgICAgICAgICAvLyBjb2xvbi4KICAgICAgICAgICAgdmFyIHBhcnRzID0gW251bGwsIG51bGwsIG51bGxdOwogICAgICAgICAgICB2YXIgaW5kZXggPSAwOwogICAgICAgICAgICB2YXIgY3VycmVudFRva2VuID0gdGhpcy5fbG9va2FoZWFkKDApOwogICAgICAgICAgICB3aGlsZSAoY3VycmVudFRva2VuICE9PSBUT0tfUkJSQUNLRVQgJiYgaW5kZXggPCAzKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFRva2VuID09PSBUT0tfQ09MT04pIHsKICAgICAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY3VycmVudFRva2VuID09PSBUT0tfTlVNQkVSKSB7CiAgICAgICAgICAgICAgICAgICAgcGFydHNbaW5kZXhdID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCkudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIlN5bnRheCBlcnJvciwgdW5leHBlY3RlZCB0b2tlbjogIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQudmFsdWUgKyAiKCIgKyB0LnR5cGUgKyAiKSIpOwogICAgICAgICAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiUGFyc2VyZXJyb3IiOwogICAgICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudFRva2VuID0gdGhpcy5fbG9va2FoZWFkKDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0tFVCk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICB0eXBlOiAiU2xpY2UiLAogICAgICAgICAgICAgICAgY2hpbGRyZW46IHBhcnRzCiAgICAgICAgICAgIH07CiAgICAgICAgfSwKICAKICAgICAgICBfcGFyc2VDb21wYXJhdG9yOiBmdW5jdGlvbihsZWZ0LCBjb21wYXJhdG9yKSB7CiAgICAgICAgICB2YXIgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyW2NvbXBhcmF0b3JdKTsKICAgICAgICAgIHJldHVybiB7dHlwZTogIkNvbXBhcmF0b3IiLCBuYW1lOiBjb21wYXJhdG9yLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgfSwKICAKICAgICAgICBfcGFyc2VEb3RSSFM6IGZ1bmN0aW9uKHJicCkgewogICAgICAgICAgICB2YXIgbG9va2FoZWFkID0gdGhpcy5fbG9va2FoZWFkKDApOwogICAgICAgICAgICB2YXIgZXhwclRva2VucyA9IFtUT0tfVU5RVU9URURJREVOVElGSUVSLCBUT0tfUVVPVEVESURFTlRJRklFUiwgVE9LX1NUQVJdOwogICAgICAgICAgICBpZiAoZXhwclRva2Vucy5pbmRleE9mKGxvb2thaGVhZCkgPj0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXhwcmVzc2lvbihyYnApOwogICAgICAgICAgICB9IGVsc2UgaWYgKGxvb2thaGVhZCA9PT0gVE9LX0xCUkFDS0VUKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfTEJSQUNLRVQpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlTXVsdGlzZWxlY3RMaXN0KCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobG9va2FoZWFkID09PSBUT0tfTEJSQUNFKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfTEJSQUNFKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZU11bHRpc2VsZWN0SGFzaCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBfcGFyc2VQcm9qZWN0aW9uUkhTOiBmdW5jdGlvbihyYnApIHsKICAgICAgICAgICAgdmFyIHJpZ2h0OwogICAgICAgICAgICBpZiAoYmluZGluZ1Bvd2VyW3RoaXMuX2xvb2thaGVhZCgwKV0gPCAxMCkgewogICAgICAgICAgICAgICAgcmlnaHQgPSB7dHlwZTogIklkZW50aXR5In07CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfTEJSQUNLRVQpIHsKICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKHJicCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfRklMVEVSKSB7CiAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihyYnApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0RPVCkgewogICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0RPVCk7CiAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlRG90UkhTKHJicCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJTeXRhbnggZXJyb3IsIHVuZXhwZWN0ZWQgdG9rZW46ICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQudmFsdWUgKyAiKCIgKyB0LnR5cGUgKyAiKSIpOwogICAgICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJQYXJzZXJFcnJvciI7CiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmlnaHQ7CiAgICAgICAgfSwKICAKICAgICAgICBfcGFyc2VNdWx0aXNlbGVjdExpc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgZXhwcmVzc2lvbnMgPSBbXTsKICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2xvb2thaGVhZCgwKSAhPT0gVE9LX1JCUkFDS0VUKSB7CiAgICAgICAgICAgICAgICB2YXIgZXhwcmVzc2lvbiA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgICAgICAgIGV4cHJlc3Npb25zLnB1c2goZXhwcmVzc2lvbik7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ09NTUEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfQ09NTUEpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19SQlJBQ0tFVCkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIHRva2VuIFJicmFja2V0Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0tFVCk7CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogIk11bHRpU2VsZWN0TGlzdCIsIGNoaWxkcmVuOiBleHByZXNzaW9uc307CiAgICAgICAgfSwKICAKICAgICAgICBfcGFyc2VNdWx0aXNlbGVjdEhhc2g6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHBhaXJzID0gW107CiAgICAgICAgICB2YXIgaWRlbnRpZmllclR5cGVzID0gW1RPS19VTlFVT1RFRElERU5USUZJRVIsIFRPS19RVU9URURJREVOVElGSUVSXTsKICAgICAgICAgIHZhciBrZXlUb2tlbiwga2V5TmFtZSwgdmFsdWUsIG5vZGU7CiAgICAgICAgICBmb3IgKDs7KSB7CiAgICAgICAgICAgIGtleVRva2VuID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICAgIGlmIChpZGVudGlmaWVyVHlwZXMuaW5kZXhPZihrZXlUb2tlbi50eXBlKSA8IDApIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGluZyBhbiBpZGVudGlmaWVyIHRva2VuLCBnb3Q6ICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXlUb2tlbi50eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBrZXlOYW1lID0ga2V5VG9rZW4udmFsdWU7CiAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0NPTE9OKTsKICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgIG5vZGUgPSB7dHlwZTogIktleVZhbHVlUGFpciIsIG5hbWU6IGtleU5hbWUsIHZhbHVlOiB2YWx1ZX07CiAgICAgICAgICAgIHBhaXJzLnB1c2gobm9kZSk7CiAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DT01NQSkgewogICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19DT01NQSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfUkJSQUNFKSB7CiAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDRSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB7dHlwZTogIk11bHRpU2VsZWN0SGFzaCIsIGNoaWxkcmVuOiBwYWlyc307CiAgICAgICAgfQogICAgfTsKICAKICAKICAgIGZ1bmN0aW9uIFRyZWVJbnRlcnByZXRlcihydW50aW1lKSB7CiAgICAgIHRoaXMucnVudGltZSA9IHJ1bnRpbWU7CiAgICB9CiAgCiAgICBUcmVlSW50ZXJwcmV0ZXIucHJvdG90eXBlID0gewogICAgICAgIHNlYXJjaDogZnVuY3Rpb24obm9kZSwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudmlzaXQobm9kZSwgdmFsdWUpOwogICAgICAgIH0sCiAgCiAgICAgICAgdmlzaXQ6IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBtYXRjaGVkLCBjdXJyZW50LCByZXN1bHQsIGZpcnN0LCBzZWNvbmQsIGZpZWxkLCBsZWZ0LCByaWdodCwgY29sbGVjdGVkLCBpOwogICAgICAgICAgICBzd2l0Y2ggKG5vZGUudHlwZSkgewogICAgICAgICAgICAgIGNhc2UgIkZpZWxkIjoKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgZmllbGQgPSB2YWx1ZVtub2RlLm5hbWVdOwogICAgICAgICAgICAgICAgICAgIGlmIChmaWVsZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWVsZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgIlN1YmV4cHJlc3Npb24iOgogICAgICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgcmVzdWx0KTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgICAgY2FzZSAiSW5kZXhFeHByZXNzaW9uIjoKICAgICAgICAgICAgICAgIGxlZnQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCBsZWZ0KTsKICAgICAgICAgICAgICAgIHJldHVybiByaWdodDsKICAgICAgICAgICAgICBjYXNlICJJbmRleCI6CiAgICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gbm9kZS52YWx1ZTsKICAgICAgICAgICAgICAgIGlmIChpbmRleCA8IDApIHsKICAgICAgICAgICAgICAgICAgaW5kZXggPSB2YWx1ZS5sZW5ndGggKyBpbmRleDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlc3VsdCA9IHZhbHVlW2luZGV4XTsKICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICByZXN1bHQgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICBjYXNlICJTbGljZSI6CiAgICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHNsaWNlUGFyYW1zID0gbm9kZS5jaGlsZHJlbi5zbGljZSgwKTsKICAgICAgICAgICAgICAgIHZhciBjb21wdXRlZCA9IHRoaXMuY29tcHV0ZVNsaWNlUGFyYW1zKHZhbHVlLmxlbmd0aCwgc2xpY2VQYXJhbXMpOwogICAgICAgICAgICAgICAgdmFyIHN0YXJ0ID0gY29tcHV0ZWRbMF07CiAgICAgICAgICAgICAgICB2YXIgc3RvcCA9IGNvbXB1dGVkWzFdOwogICAgICAgICAgICAgICAgdmFyIHN0ZXAgPSBjb21wdXRlZFsyXTsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgICAgICAgICAgaWYgKHN0ZXAgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gc3RhcnQ7IGkgPCBzdG9wOyBpICs9IHN0ZXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godmFsdWVbaV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gc3RhcnQ7IGkgPiBzdG9wOyBpICs9IHN0ZXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godmFsdWVbaV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgICAgY2FzZSAiUHJvamVjdGlvbiI6CiAgICAgICAgICAgICAgICAvLyBFdmFsdWF0ZSBsZWZ0IGNoaWxkLgogICAgICAgICAgICAgICAgdmFyIGJhc2UgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIGlmICghaXNBcnJheShiYXNlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbGxlY3RlZCA9IFtdOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGJhc2UubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgYmFzZVtpXSk7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29sbGVjdGVkLnB1c2goY3VycmVudCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBjb2xsZWN0ZWQ7CiAgICAgICAgICAgICAgY2FzZSAiVmFsdWVQcm9qZWN0aW9uIjoKICAgICAgICAgICAgICAgIC8vIEV2YWx1YXRlIGxlZnQgY2hpbGQuCiAgICAgICAgICAgICAgICBiYXNlID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBpZiAoIWlzT2JqZWN0KGJhc2UpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29sbGVjdGVkID0gW107CiAgICAgICAgICAgICAgICB2YXIgdmFsdWVzID0gb2JqVmFsdWVzKGJhc2UpOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBjdXJyZW50ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCB2YWx1ZXNbaV0pOwogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbGxlY3RlZC5wdXNoKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gY29sbGVjdGVkOwogICAgICAgICAgICAgIGNhc2UgIkZpbHRlclByb2plY3Rpb24iOgogICAgICAgICAgICAgICAgYmFzZSA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KGJhc2UpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGZpbHRlcmVkID0gW107CiAgICAgICAgICAgICAgICB2YXIgZmluYWxSZXN1bHRzID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYmFzZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBtYXRjaGVkID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzJdLCBiYXNlW2ldKTsKICAgICAgICAgICAgICAgICAgaWYgKCFpc0ZhbHNlKG1hdGNoZWQpKSB7CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyZWQucHVzaChiYXNlW2ldKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBmaWx0ZXJlZC5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgICBjdXJyZW50ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCBmaWx0ZXJlZFtqXSk7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZmluYWxSZXN1bHRzLnB1c2goY3VycmVudCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBmaW5hbFJlc3VsdHM7CiAgICAgICAgICAgICAgY2FzZSAiQ29tcGFyYXRvciI6CiAgICAgICAgICAgICAgICBmaXJzdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgc2Vjb25kID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBzd2l0Y2gobm9kZS5uYW1lKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgVE9LX0VROgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHN0cmljdERlZXBFcXVhbChmaXJzdCwgc2Vjb25kKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBUT0tfTkU6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gIXN0cmljdERlZXBFcXVhbChmaXJzdCwgc2Vjb25kKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBUT0tfR1Q6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZmlyc3QgPiBzZWNvbmQ7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgVE9LX0dURToKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBmaXJzdCA+PSBzZWNvbmQ7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgVE9LX0xUOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZpcnN0IDwgc2Vjb25kOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIFRPS19MVEU6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZmlyc3QgPD0gc2Vjb25kOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBjb21wYXJhdG9yOiAiICsgbm9kZS5uYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgICAgY2FzZSBUT0tfRkxBVFRFTjoKICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KG9yaWdpbmFsKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBtZXJnZWQgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBvcmlnaW5hbC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBjdXJyZW50ID0gb3JpZ2luYWxbaV07CiAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KGN1cnJlbnQpKSB7CiAgICAgICAgICAgICAgICAgICAgbWVyZ2VkLnB1c2guYXBwbHkobWVyZ2VkLCBjdXJyZW50KTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtZXJnZWQucHVzaChjdXJyZW50KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG1lcmdlZDsKICAgICAgICAgICAgICBjYXNlICJJZGVudGl0eSI6CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgY2FzZSAiTXVsdGlTZWxlY3RMaXN0IjoKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbGxlY3RlZCA9IFtdOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjb2xsZWN0ZWQucHVzaCh0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5baV0sIHZhbHVlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gY29sbGVjdGVkOwogICAgICAgICAgICAgIGNhc2UgIk11bHRpU2VsZWN0SGFzaCI6CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb2xsZWN0ZWQgPSB7fTsKICAgICAgICAgICAgICAgIHZhciBjaGlsZDsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGNoaWxkID0gbm9kZS5jaGlsZHJlbltpXTsKICAgICAgICAgICAgICAgICAgY29sbGVjdGVkW2NoaWxkLm5hbWVdID0gdGhpcy52aXNpdChjaGlsZC52YWx1ZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3RlZDsKICAgICAgICAgICAgICBjYXNlICJPckV4cHJlc3Npb24iOgogICAgICAgICAgICAgICAgbWF0Y2hlZCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKGlzRmFsc2UobWF0Y2hlZCkpIHsKICAgICAgICAgICAgICAgICAgICBtYXRjaGVkID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbWF0Y2hlZDsKICAgICAgICAgICAgICBjYXNlICJBbmRFeHByZXNzaW9uIjoKICAgICAgICAgICAgICAgIGZpcnN0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgCiAgICAgICAgICAgICAgICBpZiAoaXNGYWxzZShmaXJzdCkgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpcnN0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgdmFsdWUpOwogICAgICAgICAgICAgIGNhc2UgIk5vdEV4cHJlc3Npb24iOgogICAgICAgICAgICAgICAgZmlyc3QgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIHJldHVybiBpc0ZhbHNlKGZpcnN0KTsKICAgICAgICAgICAgICBjYXNlICJMaXRlcmFsIjoKICAgICAgICAgICAgICAgIHJldHVybiBub2RlLnZhbHVlOwogICAgICAgICAgICAgIGNhc2UgVE9LX1BJUEU6CiAgICAgICAgICAgICAgICBsZWZ0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCBsZWZ0KTsKICAgICAgICAgICAgICBjYXNlIFRPS19DVVJSRU5UOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgIGNhc2UgIkZ1bmN0aW9uIjoKICAgICAgICAgICAgICAgIHZhciByZXNvbHZlZEFyZ3MgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRBcmdzLnB1c2godGhpcy52aXNpdChub2RlLmNoaWxkcmVuW2ldLCB2YWx1ZSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucnVudGltZS5jYWxsRnVuY3Rpb24obm9kZS5uYW1lLCByZXNvbHZlZEFyZ3MpOwogICAgICAgICAgICAgIGNhc2UgIkV4cHJlc3Npb25SZWZlcmVuY2UiOgogICAgICAgICAgICAgICAgdmFyIHJlZk5vZGUgPSBub2RlLmNoaWxkcmVuWzBdOwogICAgICAgICAgICAgICAgLy8gVGFnIHRoZSBub2RlIHdpdGggYSBzcGVjaWZpYyBhdHRyaWJ1dGUgc28gdGhlIHR5cGUKICAgICAgICAgICAgICAgIC8vIGNoZWNrZXIgdmVyaWZ5IHRoZSB0eXBlLgogICAgICAgICAgICAgICAgcmVmTm9kZS5qbWVzcGF0aFR5cGUgPSBUT0tfRVhQUkVGOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlZk5vZGU7CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBub2RlIHR5cGU6ICIgKyBub2RlLnR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBjb21wdXRlU2xpY2VQYXJhbXM6IGZ1bmN0aW9uKGFycmF5TGVuZ3RoLCBzbGljZVBhcmFtcykgewogICAgICAgICAgdmFyIHN0YXJ0ID0gc2xpY2VQYXJhbXNbMF07CiAgICAgICAgICB2YXIgc3RvcCA9IHNsaWNlUGFyYW1zWzFdOwogICAgICAgICAgdmFyIHN0ZXAgPSBzbGljZVBhcmFtc1syXTsKICAgICAgICAgIHZhciBjb21wdXRlZCA9IFtudWxsLCBudWxsLCBudWxsXTsKICAgICAgICAgIGlmIChzdGVwID09PSBudWxsKSB7CiAgICAgICAgICAgIHN0ZXAgPSAxOwogICAgICAgICAgfSBlbHNlIGlmIChzdGVwID09PSAwKSB7CiAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiSW52YWxpZCBzbGljZSwgc3RlcCBjYW5ub3QgYmUgMCIpOwogICAgICAgICAgICBlcnJvci5uYW1lID0gIlJ1bnRpbWVFcnJvciI7CiAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHN0ZXBWYWx1ZU5lZ2F0aXZlID0gc3RlcCA8IDAgPyB0cnVlIDogZmFsc2U7CiAgCiAgICAgICAgICBpZiAoc3RhcnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICBzdGFydCA9IHN0ZXBWYWx1ZU5lZ2F0aXZlID8gYXJyYXlMZW5ndGggLSAxIDogMDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLmNhcFNsaWNlUmFuZ2UoYXJyYXlMZW5ndGgsIHN0YXJ0LCBzdGVwKTsKICAgICAgICAgIH0KICAKICAgICAgICAgIGlmIChzdG9wID09PSBudWxsKSB7CiAgICAgICAgICAgICAgc3RvcCA9IHN0ZXBWYWx1ZU5lZ2F0aXZlID8gLTEgOiBhcnJheUxlbmd0aDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RvcCA9IHRoaXMuY2FwU2xpY2VSYW5nZShhcnJheUxlbmd0aCwgc3RvcCwgc3RlcCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb21wdXRlZFswXSA9IHN0YXJ0OwogICAgICAgICAgY29tcHV0ZWRbMV0gPSBzdG9wOwogICAgICAgICAgY29tcHV0ZWRbMl0gPSBzdGVwOwogICAgICAgICAgcmV0dXJuIGNvbXB1dGVkOwogICAgICAgIH0sCiAgCiAgICAgICAgY2FwU2xpY2VSYW5nZTogZnVuY3Rpb24oYXJyYXlMZW5ndGgsIGFjdHVhbFZhbHVlLCBzdGVwKSB7CiAgICAgICAgICAgIGlmIChhY3R1YWxWYWx1ZSA8IDApIHsKICAgICAgICAgICAgICAgIGFjdHVhbFZhbHVlICs9IGFycmF5TGVuZ3RoOwogICAgICAgICAgICAgICAgaWYgKGFjdHVhbFZhbHVlIDwgMCkgewogICAgICAgICAgICAgICAgICAgIGFjdHVhbFZhbHVlID0gc3RlcCA8IDAgPyAtMSA6IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0dWFsVmFsdWUgPj0gYXJyYXlMZW5ndGgpIHsKICAgICAgICAgICAgICAgIGFjdHVhbFZhbHVlID0gc3RlcCA8IDAgPyBhcnJheUxlbmd0aCAtIDEgOiBhcnJheUxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYWN0dWFsVmFsdWU7CiAgICAgICAgfQogIAogICAgfTsKICAKICAgIGZ1bmN0aW9uIFJ1bnRpbWUoaW50ZXJwcmV0ZXIpIHsKICAgICAgdGhpcy5faW50ZXJwcmV0ZXIgPSBpbnRlcnByZXRlcjsKICAgICAgdGhpcy5mdW5jdGlvblRhYmxlID0gewogICAgICAgICAgLy8gbmFtZTogW2Z1bmN0aW9uLCA8c2lnbmF0dXJlPl0KICAgICAgICAgIC8vIFRoZSA8c2lnbmF0dXJlPiBjYW4gYmU6CiAgICAgICAgICAvLwogICAgICAgICAgLy8gewogICAgICAgICAgLy8gICBhcmdzOiBbW3R5cGUxLCB0eXBlMl0sIFt0eXBlMSwgdHlwZTJdXSwKICAgICAgICAgIC8vICAgdmFyaWFkaWM6IHRydWV8ZmFsc2UKICAgICAgICAgIC8vIH0KICAgICAgICAgIC8vCiAgICAgICAgICAvLyBFYWNoIGFyZyBpbiB0aGUgYXJnIGxpc3QgaXMgYSBsaXN0IG9mIHZhbGlkIHR5cGVzCiAgICAgICAgICAvLyAoaWYgdGhlIGZ1bmN0aW9uIGlzIG92ZXJsb2FkZWQgYW5kIHN1cHBvcnRzIG11bHRpcGxlCiAgICAgICAgICAvLyB0eXBlcy4gIElmIHRoZSB0eXBlIGlzICJhbnkiIHRoZW4gbm8gdHlwZSBjaGVja2luZwogICAgICAgICAgLy8gb2NjdXJzIG9uIHRoZSBhcmd1bWVudC4gIFZhcmlhZGljIGlzIG9wdGlvbmFsCiAgICAgICAgICAvLyBhbmQgaWYgbm90IHByb3ZpZGVkIGlzIGFzc3VtZWQgdG8gYmUgZmFsc2UuCiAgICAgICAgICBhYnM6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25BYnMsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX05VTUJFUl19XX0sCiAgICAgICAgICBhdmc6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25BdmcsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZX05VTUJFUl19XX0sCiAgICAgICAgICBjZWlsOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uQ2VpbCwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfTlVNQkVSXX1dfSwKICAgICAgICAgIGNvbnRhaW5zOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uQ29udGFpbnMsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfU1RSSU5HLCBUWVBFX0FSUkFZXX0sCiAgICAgICAgICAgICAgICAgICAgICAgICAge3R5cGVzOiBbVFlQRV9BTlldfV19LAogICAgICAgICAgImVuZHNfd2l0aCI6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25FbmRzV2l0aCwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9TVFJJTkddfSwge3R5cGVzOiBbVFlQRV9TVFJJTkddfV19LAogICAgICAgICAgZmxvb3I6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25GbG9vciwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfTlVNQkVSXX1dfSwKICAgICAgICAgIGxlbmd0aDogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbkxlbmd0aCwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9TVFJJTkcsIFRZUEVfQVJSQVksIFRZUEVfT0JKRUNUXX1dfSwKICAgICAgICAgIG1hcDogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1hcCwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9FWFBSRUZdfSwge3R5cGVzOiBbVFlQRV9BUlJBWV19XX0sCiAgICAgICAgICBtYXg6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NYXgsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVlfTlVNQkVSLCBUWVBFX0FSUkFZX1NUUklOR119XX0sCiAgICAgICAgICAibWVyZ2UiOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWVyZ2UsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfT0JKRUNUXSwgdmFyaWFkaWM6IHRydWV9XQogICAgICAgICAgfSwKICAgICAgICAgICJtYXhfYnkiOiB7CiAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1heEJ5LAogICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV19LCB7dHlwZXM6IFtUWVBFX0VYUFJFRl19XQogICAgICAgICAgfSwKICAgICAgICAgIHN1bToge19mdW5jOiB0aGlzLl9mdW5jdGlvblN1bSwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVlfTlVNQkVSXX1dfSwKICAgICAgICAgICJzdGFydHNfd2l0aCI6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25TdGFydHNXaXRoLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX1NUUklOR119LCB7dHlwZXM6IFtUWVBFX1NUUklOR119XX0sCiAgICAgICAgICBtaW46IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NaW4sCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVlfTlVNQkVSLCBUWVBFX0FSUkFZX1NUUklOR119XX0sCiAgICAgICAgICAibWluX2J5IjogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NaW5CeSwKICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVldfSwge3R5cGVzOiBbVFlQRV9FWFBSRUZdfV0KICAgICAgICAgIH0sCiAgICAgICAgICB0eXBlOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uVHlwZSwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQU5ZXX1dfSwKICAgICAgICAgIGtleXM6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25LZXlzLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9PQkpFQ1RdfV19LAogICAgICAgICAgdmFsdWVzOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uVmFsdWVzLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9PQkpFQ1RdfV19LAogICAgICAgICAgc29ydDoge19mdW5jOiB0aGlzLl9mdW5jdGlvblNvcnQsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZX1NUUklORywgVFlQRV9BUlJBWV9OVU1CRVJdfV19LAogICAgICAgICAgInNvcnRfYnkiOiB7CiAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvblNvcnRCeSwKICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVldfSwge3R5cGVzOiBbVFlQRV9FWFBSRUZdfV0KICAgICAgICAgIH0sCiAgICAgICAgICBqb2luOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uSm9pbiwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbCiAgICAgICAgICAgICAgICAgIHt0eXBlczogW1RZUEVfU1RSSU5HXX0sCiAgICAgICAgICAgICAgICAgIHt0eXBlczogW1RZUEVfQVJSQVlfU1RSSU5HXX0KICAgICAgICAgICAgICBdCiAgICAgICAgICB9LAogICAgICAgICAgcmV2ZXJzZTogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvblJldmVyc2UsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfU1RSSU5HLCBUWVBFX0FSUkFZXX1dfSwKICAgICAgICAgICJ0b19hcnJheSI6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25Ub0FycmF5LCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BTlldfV19LAogICAgICAgICAgInRvX3N0cmluZyI6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25Ub1N0cmluZywgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQU5ZXX1dfSwKICAgICAgICAgICJ0b19udW1iZXIiOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uVG9OdW1iZXIsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FOWV19XX0sCiAgICAgICAgICAibm90X251bGwiOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTm90TnVsbCwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BTlldLCB2YXJpYWRpYzogdHJ1ZX1dCiAgICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgCiAgICBSdW50aW1lLnByb3RvdHlwZSA9IHsKICAgICAgY2FsbEZ1bmN0aW9uOiBmdW5jdGlvbihuYW1lLCByZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgZnVuY3Rpb25FbnRyeSA9IHRoaXMuZnVuY3Rpb25UYWJsZVtuYW1lXTsKICAgICAgICBpZiAoZnVuY3Rpb25FbnRyeSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBmdW5jdGlvbjogIiArIG5hbWUgKyAiKCkiKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fdmFsaWRhdGVBcmdzKG5hbWUsIHJlc29sdmVkQXJncywgZnVuY3Rpb25FbnRyeS5fc2lnbmF0dXJlKTsKICAgICAgICByZXR1cm4gZnVuY3Rpb25FbnRyeS5fZnVuYy5jYWxsKHRoaXMsIHJlc29sdmVkQXJncyk7CiAgICAgIH0sCiAgCiAgICAgIF92YWxpZGF0ZUFyZ3M6IGZ1bmN0aW9uKG5hbWUsIGFyZ3MsIHNpZ25hdHVyZSkgewogICAgICAgICAgLy8gVmFsaWRhdGluZyB0aGUgYXJncyByZXF1aXJlcyB2YWxpZGF0aW5nCiAgICAgICAgICAvLyB0aGUgY29ycmVjdCBhcml0eSBhbmQgdGhlIGNvcnJlY3QgdHlwZSBvZiBlYWNoIGFyZy4KICAgICAgICAgIC8vIElmIHRoZSBsYXN0IGFyZ3VtZW50IGlzIGRlY2xhcmVkIGFzIHZhcmlhZGljLCB0aGVuIHdlIG5lZWQKICAgICAgICAgIC8vIGEgbWluaW11bSBudW1iZXIgb2YgYXJncyB0byBiZSByZXF1aXJlZC4gIE90aGVyd2lzZSBpdCBoYXMgdG8KICAgICAgICAgIC8vIGJlIGFuIGV4YWN0IGFtb3VudC4KICAgICAgICAgIHZhciBwbHVyYWxpemVkOwogICAgICAgICAgaWYgKHNpZ25hdHVyZVtzaWduYXR1cmUubGVuZ3RoIC0gMV0udmFyaWFkaWMpIHsKICAgICAgICAgICAgICBpZiAoYXJncy5sZW5ndGggPCBzaWduYXR1cmUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHBsdXJhbGl6ZWQgPSBzaWduYXR1cmUubGVuZ3RoID09PSAxID8gIiBhcmd1bWVudCIgOiAiIGFyZ3VtZW50cyI7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQXJndW1lbnRFcnJvcjogIiArIG5hbWUgKyAiKCkgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGFrZXMgYXQgbGVhc3QiICsgc2lnbmF0dXJlLmxlbmd0aCArIHBsdXJhbGl6ZWQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBidXQgcmVjZWl2ZWQgIiArIGFyZ3MubGVuZ3RoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGFyZ3MubGVuZ3RoICE9PSBzaWduYXR1cmUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgcGx1cmFsaXplZCA9IHNpZ25hdHVyZS5sZW5ndGggPT09IDEgPyAiIGFyZ3VtZW50IiA6ICIgYXJndW1lbnRzIjsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFyZ3VtZW50RXJyb3I6ICIgKyBuYW1lICsgIigpICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGFrZXMgIiArIHNpZ25hdHVyZS5sZW5ndGggKyBwbHVyYWxpemVkICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBidXQgcmVjZWl2ZWQgIiArIGFyZ3MubGVuZ3RoKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50U3BlYzsKICAgICAgICAgIHZhciBhY3R1YWxUeXBlOwogICAgICAgICAgdmFyIHR5cGVNYXRjaGVkOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzaWduYXR1cmUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB0eXBlTWF0Y2hlZCA9IGZhbHNlOwogICAgICAgICAgICAgIGN1cnJlbnRTcGVjID0gc2lnbmF0dXJlW2ldLnR5cGVzOwogICAgICAgICAgICAgIGFjdHVhbFR5cGUgPSB0aGlzLl9nZXRUeXBlTmFtZShhcmdzW2ldKTsKICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGN1cnJlbnRTcGVjLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl90eXBlTWF0Y2hlcyhhY3R1YWxUeXBlLCBjdXJyZW50U3BlY1tqXSwgYXJnc1tpXSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGVNYXRjaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghdHlwZU1hdGNoZWQpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUeXBlRXJyb3I6ICIgKyBuYW1lICsgIigpICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImV4cGVjdGVkIGFyZ3VtZW50ICIgKyAoaSArIDEpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgdG8gYmUgdHlwZSAiICsgY3VycmVudFNwZWMgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBidXQgcmVjZWl2ZWQgdHlwZSAiICsgYWN0dWFsVHlwZSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9LAogIAogICAgICBfdHlwZU1hdGNoZXM6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIGFyZ1ZhbHVlKSB7CiAgICAgICAgICBpZiAoZXhwZWN0ZWQgPT09IFRZUEVfQU5ZKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXhwZWN0ZWQgPT09IFRZUEVfQVJSQVlfU1RSSU5HIHx8CiAgICAgICAgICAgICAgZXhwZWN0ZWQgPT09IFRZUEVfQVJSQVlfTlVNQkVSIHx8CiAgICAgICAgICAgICAgZXhwZWN0ZWQgPT09IFRZUEVfQVJSQVkpIHsKICAgICAgICAgICAgICAvLyBUaGUgZXhwZWN0ZWQgdHlwZSBjYW4gZWl0aGVyIGp1c3QgYmUgYXJyYXksCiAgICAgICAgICAgICAgLy8gb3IgaXQgY2FuIHJlcXVpcmUgYSBzcGVjaWZpYyBzdWJ0eXBlIChhcnJheSBvZiBudW1iZXJzKS4KICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgIC8vIFRoZSBzaW1wbGVzdCBjYXNlIGlzIGlmICJhcnJheSIgd2l0aCBubyBzdWJ0eXBlIGlzIHNwZWNpZmllZC4KICAgICAgICAgICAgICBpZiAoZXhwZWN0ZWQgPT09IFRZUEVfQVJSQVkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjdHVhbCA9PT0gVFlQRV9BUlJBWTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFjdHVhbCA9PT0gVFlQRV9BUlJBWSkgewogICAgICAgICAgICAgICAgICAvLyBPdGhlcndpc2Ugd2UgbmVlZCB0byBjaGVjayBzdWJ0eXBlcy4KICAgICAgICAgICAgICAgICAgLy8gSSB0aGluayB0aGlzIGhhcyBwb3RlbnRpYWwgdG8gYmUgaW1wcm92ZWQuCiAgICAgICAgICAgICAgICAgIHZhciBzdWJ0eXBlOwogICAgICAgICAgICAgICAgICBpZiAoZXhwZWN0ZWQgPT09IFRZUEVfQVJSQVlfTlVNQkVSKSB7CiAgICAgICAgICAgICAgICAgICAgc3VidHlwZSA9IFRZUEVfTlVNQkVSOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FSUkFZX1NUUklORykgewogICAgICAgICAgICAgICAgICAgIHN1YnR5cGUgPSBUWVBFX1NUUklORzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ1ZhbHVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX3R5cGVNYXRjaGVzKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9nZXRUeXBlTmFtZShhcmdWYWx1ZVtpXSksIHN1YnR5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnVmFsdWVbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIGFjdHVhbCA9PT0gZXhwZWN0ZWQ7CiAgICAgICAgICB9CiAgICAgIH0sCiAgICAgIF9nZXRUeXBlTmFtZTogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICBzd2l0Y2ggKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopKSB7CiAgICAgICAgICAgICAgY2FzZSAiW29iamVjdCBTdHJpbmddIjoKICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX1NUUklORzsKICAgICAgICAgICAgICBjYXNlICJbb2JqZWN0IE51bWJlcl0iOgogICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfTlVNQkVSOwogICAgICAgICAgICAgIGNhc2UgIltvYmplY3QgQXJyYXldIjoKICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX0FSUkFZOwogICAgICAgICAgICAgIGNhc2UgIltvYmplY3QgQm9vbGVhbl0iOgogICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfQk9PTEVBTjsKICAgICAgICAgICAgICBjYXNlICJbb2JqZWN0IE51bGxdIjoKICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX05VTEw7CiAgICAgICAgICAgICAgY2FzZSAiW29iamVjdCBPYmplY3RdIjoKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGl0J3MgYW4gZXhwcmVmLiAgSWYgaXQgaGFzLCBpdCdzIGJlZW4KICAgICAgICAgICAgICAgIC8vIHRhZ2dlZCB3aXRoIGEgam1lc3BhdGhUeXBlIGF0dHIgb2YgJ0V4cHJlZic7CiAgICAgICAgICAgICAgICBpZiAob2JqLmptZXNwYXRoVHlwZSA9PT0gVE9LX0VYUFJFRikgewogICAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9FWFBSRUY7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9PQkpFQ1Q7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblN0YXJ0c1dpdGg6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXS5sYXN0SW5kZXhPZihyZXNvbHZlZEFyZ3NbMV0pID09PSAwOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25FbmRzV2l0aDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICB2YXIgc2VhcmNoU3RyID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgdmFyIHN1ZmZpeCA9IHJlc29sdmVkQXJnc1sxXTsKICAgICAgICAgIHJldHVybiBzZWFyY2hTdHIuaW5kZXhPZihzdWZmaXgsIHNlYXJjaFN0ci5sZW5ndGggLSBzdWZmaXgubGVuZ3RoKSAhPT0gLTE7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblJldmVyc2U6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIHR5cGVOYW1lID0gdGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgICAgIGlmICh0eXBlTmFtZSA9PT0gVFlQRV9TVFJJTkcpIHsKICAgICAgICAgICAgdmFyIG9yaWdpbmFsU3RyID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgICB2YXIgcmV2ZXJzZWRTdHIgPSAiIjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IG9yaWdpbmFsU3RyLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICByZXZlcnNlZFN0ciArPSBvcmlnaW5hbFN0cltpXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmV2ZXJzZWRTdHI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcmV2ZXJzZWRBcnJheSA9IHJlc29sdmVkQXJnc1swXS5zbGljZSgwKTsKICAgICAgICAgICAgcmV2ZXJzZWRBcnJheS5yZXZlcnNlKCk7CiAgICAgICAgICAgIHJldHVybiByZXZlcnNlZEFycmF5OwogICAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25BYnM6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHJldHVybiBNYXRoLmFicyhyZXNvbHZlZEFyZ3NbMF0pOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25DZWlsOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHJldHVybiBNYXRoLmNlaWwocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uQXZnOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciBzdW0gPSAwOwogICAgICAgICAgdmFyIGlucHV0QXJyYXkgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGlucHV0QXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBzdW0gKz0gaW5wdXRBcnJheVtpXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzdW0gLyBpbnB1dEFycmF5Lmxlbmd0aDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uQ29udGFpbnM6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXS5pbmRleE9mKHJlc29sdmVkQXJnc1sxXSkgPj0gMDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uRmxvb3I6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTGVuZ3RoOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgaWYgKCFpc09iamVjdChyZXNvbHZlZEFyZ3NbMF0pKSB7CiAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXS5sZW5ndGg7CiAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgLy8gQXMgZmFyIGFzIEkgY2FuIHRlbGwsIHRoZXJlJ3Mgbm8gd2F5IHRvIGdldCB0aGUgbGVuZ3RoCiAgICAgICAgICAgLy8gb2YgYW4gb2JqZWN0IHdpdGhvdXQgTyhuKSBpdGVyYXRpb24gdGhyb3VnaCB0aGUgb2JqZWN0LgogICAgICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhyZXNvbHZlZEFyZ3NbMF0pLmxlbmd0aDsKICAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25NYXA6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBtYXBwZWQgPSBbXTsKICAgICAgICB2YXIgaW50ZXJwcmV0ZXIgPSB0aGlzLl9pbnRlcnByZXRlcjsKICAgICAgICB2YXIgZXhwcmVmTm9kZSA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICB2YXIgZWxlbWVudHMgPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBtYXBwZWQucHVzaChpbnRlcnByZXRlci52aXNpdChleHByZWZOb2RlLCBlbGVtZW50c1tpXSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbWFwcGVkOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25NZXJnZTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIG1lcmdlZCA9IHt9OwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzb2x2ZWRBcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgY3VycmVudCA9IHJlc29sdmVkQXJnc1tpXTsKICAgICAgICAgIGZvciAodmFyIGtleSBpbiBjdXJyZW50KSB7CiAgICAgICAgICAgIG1lcmdlZFtrZXldID0gY3VycmVudFtrZXldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbWVyZ2VkOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25NYXg6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIGlmIChyZXNvbHZlZEFyZ3NbMF0ubGVuZ3RoID4gMCkgewogICAgICAgICAgdmFyIHR5cGVOYW1lID0gdGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdWzBdKTsKICAgICAgICAgIGlmICh0eXBlTmFtZSA9PT0gVFlQRV9OVU1CRVIpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGgubWF4LmFwcGx5KE1hdGgsIHJlc29sdmVkQXJnc1swXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZWxlbWVudHMgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICAgIHZhciBtYXhFbGVtZW50ID0gZWxlbWVudHNbMF07CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChtYXhFbGVtZW50LmxvY2FsZUNvbXBhcmUoZWxlbWVudHNbaV0pIDwgMCkgewogICAgICAgICAgICAgICAgICAgIG1heEVsZW1lbnQgPSBlbGVtZW50c1tpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWF4RWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbk1pbjogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgaWYgKHJlc29sdmVkQXJnc1swXS5sZW5ndGggPiAwKSB7CiAgICAgICAgICB2YXIgdHlwZU5hbWUgPSB0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF1bMF0pOwogICAgICAgICAgaWYgKHR5cGVOYW1lID09PSBUWVBFX05VTUJFUikgewogICAgICAgICAgICByZXR1cm4gTWF0aC5taW4uYXBwbHkoTWF0aCwgcmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50cyA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgICAgdmFyIG1pbkVsZW1lbnQgPSBlbGVtZW50c1swXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnRzW2ldLmxvY2FsZUNvbXBhcmUobWluRWxlbWVudCkgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgbWluRWxlbWVudCA9IGVsZW1lbnRzW2ldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtaW5FbGVtZW50OwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblN1bTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIHN1bSA9IDA7CiAgICAgICAgdmFyIGxpc3RUb1N1bSA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3RUb1N1bS5sZW5ndGg7IGkrKykgewogICAgICAgICAgc3VtICs9IGxpc3RUb1N1bVtpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN1bTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uVHlwZTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICBzd2l0Y2ggKHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXSkpIHsKICAgICAgICAgICAgY2FzZSBUWVBFX05VTUJFUjoKICAgICAgICAgICAgICByZXR1cm4gIm51bWJlciI7CiAgICAgICAgICAgIGNhc2UgVFlQRV9TVFJJTkc6CiAgICAgICAgICAgICAgcmV0dXJuICJzdHJpbmciOwogICAgICAgICAgICBjYXNlIFRZUEVfQVJSQVk6CiAgICAgICAgICAgICAgcmV0dXJuICJhcnJheSI7CiAgICAgICAgICAgIGNhc2UgVFlQRV9PQkpFQ1Q6CiAgICAgICAgICAgICAgcmV0dXJuICJvYmplY3QiOwogICAgICAgICAgICBjYXNlIFRZUEVfQk9PTEVBTjoKICAgICAgICAgICAgICByZXR1cm4gImJvb2xlYW4iOwogICAgICAgICAgICBjYXNlIFRZUEVfRVhQUkVGOgogICAgICAgICAgICAgIHJldHVybiAiZXhwcmVmIjsKICAgICAgICAgICAgY2FzZSBUWVBFX05VTEw6CiAgICAgICAgICAgICAgcmV0dXJuICJudWxsIjsKICAgICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uS2V5czogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uVmFsdWVzOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciBvYmogPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKG9iaik7CiAgICAgICAgICB2YXIgdmFsdWVzID0gW107CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YWx1ZXMucHVzaChvYmpba2V5c1tpXV0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uSm9pbjogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICB2YXIgam9pbkNoYXIgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICB2YXIgbGlzdEpvaW4gPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgICAgICByZXR1cm4gbGlzdEpvaW4uam9pbihqb2luQ2hhcik7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblRvQXJyYXk6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgaWYgKHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXSkgPT09IFRZUEVfQVJSQVkpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gW3Jlc29sdmVkQXJnc1swXV07CiAgICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblRvU3RyaW5nOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIGlmICh0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF0pID09PSBUWVBFX1NUUklORykgewogICAgICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShyZXNvbHZlZEFyZ3NbMF0pOwogICAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Ub051bWJlcjogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICB2YXIgdHlwZU5hbWUgPSB0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF0pOwogICAgICAgICAgdmFyIGNvbnZlcnRlZFZhbHVlOwogICAgICAgICAgaWYgKHR5cGVOYW1lID09PSBUWVBFX05VTUJFUikgewogICAgICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVOYW1lID09PSBUWVBFX1NUUklORykgewogICAgICAgICAgICAgIGNvbnZlcnRlZFZhbHVlID0gK3Jlc29sdmVkQXJnc1swXTsKICAgICAgICAgICAgICBpZiAoIWlzTmFOKGNvbnZlcnRlZFZhbHVlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udmVydGVkVmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbk5vdE51bGw6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvbHZlZEFyZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBpZiAodGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzW2ldKSAhPT0gVFlQRV9OVUxMKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbaV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblNvcnQ6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIHNvcnRlZEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdLnNsaWNlKDApOwogICAgICAgICAgc29ydGVkQXJyYXkuc29ydCgpOwogICAgICAgICAgcmV0dXJuIHNvcnRlZEFycmF5OwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Tb3J0Qnk6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIHNvcnRlZEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdLnNsaWNlKDApOwogICAgICAgICAgaWYgKHNvcnRlZEFycmF5Lmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgIHJldHVybiBzb3J0ZWRBcnJheTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnRlcnByZXRlciA9IHRoaXMuX2ludGVycHJldGVyOwogICAgICAgICAgdmFyIGV4cHJlZk5vZGUgPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgICAgICB2YXIgcmVxdWlyZWRUeXBlID0gdGhpcy5fZ2V0VHlwZU5hbWUoCiAgICAgICAgICAgICAgaW50ZXJwcmV0ZXIudmlzaXQoZXhwcmVmTm9kZSwgc29ydGVkQXJyYXlbMF0pKTsKICAgICAgICAgIGlmIChbVFlQRV9OVU1CRVIsIFRZUEVfU1RSSU5HXS5pbmRleE9mKHJlcXVpcmVkVHlwZSkgPCAwKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUeXBlRXJyb3IiKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgIC8vIEluIG9yZGVyIHRvIGdldCBhIHN0YWJsZSBzb3J0IG91dCBvZiBhbiB1bnN0YWJsZQogICAgICAgICAgLy8gc29ydCBhbGdvcml0aG0sIHdlIGRlY29yYXRlL3NvcnQvdW5kZWNvcmF0ZSAoRFNVKQogICAgICAgICAgLy8gYnkgY3JlYXRpbmcgYSBuZXcgbGlzdCBvZiBbaW5kZXgsIGVsZW1lbnRdIHBhaXJzLgogICAgICAgICAgLy8gSW4gdGhlIGNtcCBmdW5jdGlvbiwgaWYgdGhlIGV2YWx1YXRlZCBlbGVtZW50cyBhcmUKICAgICAgICAgIC8vIGVxdWFsLCB0aGVuIHRoZSBpbmRleCB3aWxsIGJlIHVzZWQgYXMgdGhlIHRpZWJyZWFrZXIuCiAgICAgICAgICAvLyBBZnRlciB0aGUgZGVjb3JhdGVkIGxpc3QgaGFzIGJlZW4gc29ydGVkLCBpdCB3aWxsIGJlCiAgICAgICAgICAvLyB1bmRlY29yYXRlZCB0byBleHRyYWN0IHRoZSBvcmlnaW5hbCBlbGVtZW50cy4KICAgICAgICAgIHZhciBkZWNvcmF0ZWQgPSBbXTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc29ydGVkQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgZGVjb3JhdGVkLnB1c2goW2ksIHNvcnRlZEFycmF5W2ldXSk7CiAgICAgICAgICB9CiAgICAgICAgICBkZWNvcmF0ZWQuc29ydChmdW5jdGlvbihhLCBiKSB7CiAgICAgICAgICAgIHZhciBleHByQSA9IGludGVycHJldGVyLnZpc2l0KGV4cHJlZk5vZGUsIGFbMV0pOwogICAgICAgICAgICB2YXIgZXhwckIgPSBpbnRlcnByZXRlci52aXNpdChleHByZWZOb2RlLCBiWzFdKTsKICAgICAgICAgICAgaWYgKHRoYXQuX2dldFR5cGVOYW1lKGV4cHJBKSAhPT0gcmVxdWlyZWRUeXBlKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgICAgICAgICAgIlR5cGVFcnJvcjogZXhwZWN0ZWQgIiArIHJlcXVpcmVkVHlwZSArICIsIHJlY2VpdmVkICIgKwogICAgICAgICAgICAgICAgICAgIHRoYXQuX2dldFR5cGVOYW1lKGV4cHJBKSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhhdC5fZ2V0VHlwZU5hbWUoZXhwckIpICE9PSByZXF1aXJlZFR5cGUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAgICAgICAiVHlwZUVycm9yOiBleHBlY3RlZCAiICsgcmVxdWlyZWRUeXBlICsgIiwgcmVjZWl2ZWQgIiArCiAgICAgICAgICAgICAgICAgICAgdGhhdC5fZ2V0VHlwZU5hbWUoZXhwckIpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXhwckEgPiBleHByQikgewogICAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cHJBIDwgZXhwckIpIHsKICAgICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gSWYgdGhleSdyZSBlcXVhbCBjb21wYXJlIHRoZSBpdGVtcyBieSB0aGVpcgogICAgICAgICAgICAgIC8vIG9yZGVyIHRvIG1haW50YWluIHJlbGF0aXZlIG9yZGVyIG9mIGVxdWFsIGtleXMKICAgICAgICAgICAgICAvLyAoaS5lLiB0byBnZXQgYSBzdGFibGUgc29ydCkuCiAgICAgICAgICAgICAgcmV0dXJuIGFbMF0gLSBiWzBdOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIC8vIFVuZGVjb3JhdGU6IGV4dHJhY3Qgb3V0IHRoZSBvcmlnaW5hbCBsaXN0IGVsZW1lbnRzLgogICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBkZWNvcmF0ZWQubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgc29ydGVkQXJyYXlbal0gPSBkZWNvcmF0ZWRbal1bMV07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc29ydGVkQXJyYXk7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbk1heEJ5OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgZXhwcmVmTm9kZSA9IHJlc29sdmVkQXJnc1sxXTsKICAgICAgICB2YXIgcmVzb2x2ZWRBcnJheSA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICB2YXIga2V5RnVuY3Rpb24gPSB0aGlzLmNyZWF0ZUtleUZ1bmN0aW9uKGV4cHJlZk5vZGUsIFtUWVBFX05VTUJFUiwgVFlQRV9TVFJJTkddKTsKICAgICAgICB2YXIgbWF4TnVtYmVyID0gLUluZmluaXR5OwogICAgICAgIHZhciBtYXhSZWNvcmQ7CiAgICAgICAgdmFyIGN1cnJlbnQ7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvbHZlZEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjdXJyZW50ID0ga2V5RnVuY3Rpb24ocmVzb2x2ZWRBcnJheVtpXSk7CiAgICAgICAgICBpZiAoY3VycmVudCA+IG1heE51bWJlcikgewogICAgICAgICAgICBtYXhOdW1iZXIgPSBjdXJyZW50OwogICAgICAgICAgICBtYXhSZWNvcmQgPSByZXNvbHZlZEFycmF5W2ldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbWF4UmVjb3JkOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25NaW5CeTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIGV4cHJlZk5vZGUgPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgICAgdmFyIHJlc29sdmVkQXJyYXkgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgdmFyIGtleUZ1bmN0aW9uID0gdGhpcy5jcmVhdGVLZXlGdW5jdGlvbihleHByZWZOb2RlLCBbVFlQRV9OVU1CRVIsIFRZUEVfU1RSSU5HXSk7CiAgICAgICAgdmFyIG1pbk51bWJlciA9IEluZmluaXR5OwogICAgICAgIHZhciBtaW5SZWNvcmQ7CiAgICAgICAgdmFyIGN1cnJlbnQ7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvbHZlZEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjdXJyZW50ID0ga2V5RnVuY3Rpb24ocmVzb2x2ZWRBcnJheVtpXSk7CiAgICAgICAgICBpZiAoY3VycmVudCA8IG1pbk51bWJlcikgewogICAgICAgICAgICBtaW5OdW1iZXIgPSBjdXJyZW50OwogICAgICAgICAgICBtaW5SZWNvcmQgPSByZXNvbHZlZEFycmF5W2ldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbWluUmVjb3JkOwogICAgICB9LAogIAogICAgICBjcmVhdGVLZXlGdW5jdGlvbjogZnVuY3Rpb24oZXhwcmVmTm9kZSwgYWxsb3dlZFR5cGVzKSB7CiAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgIHZhciBpbnRlcnByZXRlciA9IHRoaXMuX2ludGVycHJldGVyOwogICAgICAgIHZhciBrZXlGdW5jID0gZnVuY3Rpb24oeCkgewogICAgICAgICAgdmFyIGN1cnJlbnQgPSBpbnRlcnByZXRlci52aXNpdChleHByZWZOb2RlLCB4KTsKICAgICAgICAgIGlmIChhbGxvd2VkVHlwZXMuaW5kZXhPZih0aGF0Ll9nZXRUeXBlTmFtZShjdXJyZW50KSkgPCAwKSB7CiAgICAgICAgICAgIHZhciBtc2cgPSAiVHlwZUVycm9yOiBleHBlY3RlZCBvbmUgb2YgIiArIGFsbG93ZWRUeXBlcyArCiAgICAgICAgICAgICAgICAgICAgICAiLCByZWNlaXZlZCAiICsgdGhhdC5fZ2V0VHlwZU5hbWUoY3VycmVudCk7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihtc2cpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGN1cnJlbnQ7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4ga2V5RnVuYzsKICAgICAgfQogIAogICAgfTsKICAKICAgIGZ1bmN0aW9uIGNvbXBpbGUoc3RyZWFtKSB7CiAgICAgIHZhciBwYXJzZXIgPSBuZXcgUGFyc2VyKCk7CiAgICAgIHZhciBhc3QgPSBwYXJzZXIucGFyc2Uoc3RyZWFtKTsKICAgICAgcmV0dXJuIGFzdDsKICAgIH0KICAKICAgIGZ1bmN0aW9uIHRva2VuaXplKHN0cmVhbSkgewogICAgICAgIHZhciBsZXhlciA9IG5ldyBMZXhlcigpOwogICAgICAgIHJldHVybiBsZXhlci50b2tlbml6ZShzdHJlYW0pOwogICAgfQogIAogICAgZnVuY3Rpb24gc2VhcmNoKGRhdGEsIGV4cHJlc3Npb24pIHsKICAgICAgICB2YXIgcGFyc2VyID0gbmV3IFBhcnNlcigpOwogICAgICAgIC8vIFRoaXMgbmVlZHMgdG8gYmUgaW1wcm92ZWQuICBCb3RoIHRoZSBpbnRlcnByZXRlciBhbmQgcnVudGltZSBkZXBlbmQgb24KICAgICAgICAvLyBlYWNoIG90aGVyLiAgVGhlIHJ1bnRpbWUgbmVlZHMgdGhlIGludGVycHJldGVyIHRvIHN1cHBvcnQgZXhwcmVmcy4KICAgICAgICAvLyBUaGVyZSdzIGxpa2VseSBhIGNsZWFuIHdheSB0byBhdm9pZCB0aGUgY3ljbGljIGRlcGVuZGVuY3kuCiAgICAgICAgdmFyIHJ1bnRpbWUgPSBuZXcgUnVudGltZSgpOwogICAgICAgIHZhciBpbnRlcnByZXRlciA9IG5ldyBUcmVlSW50ZXJwcmV0ZXIocnVudGltZSk7CiAgICAgICAgcnVudGltZS5faW50ZXJwcmV0ZXIgPSBpbnRlcnByZXRlcjsKICAgICAgICB2YXIgbm9kZSA9IHBhcnNlci5wYXJzZShleHByZXNzaW9uKTsKICAgICAgICByZXR1cm4gaW50ZXJwcmV0ZXIuc2VhcmNoKG5vZGUsIGRhdGEpOwogICAgfQogIAogICAgZXhwb3J0cy50b2tlbml6ZSA9IHRva2VuaXplOwogICAgZXhwb3J0cy5jb21waWxlID0gY29tcGlsZTsKICAgIGV4cG9ydHMuc2VhcmNoID0gc2VhcmNoOwogICAgZXhwb3J0cy5zdHJpY3REZWVwRXF1YWwgPSBzdHJpY3REZWVwRXF1YWw7CiAgfSkodHlwZW9mIGV4cG9ydHMgPT09ICJ1bmRlZmluZWQiID8gdGhpcy5qbWVzcGF0aCA9IHt9IDogZXhwb3J0cyk7CiAgCiAgfSx7fV0sODU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIHNoaW0gZm9yIHVzaW5nIHByb2Nlc3MgaW4gYnJvd3NlcgogIHZhciBwcm9jZXNzID0gbW9kdWxlLmV4cG9ydHMgPSB7fTsKICAKICAvLyBjYWNoZWQgZnJvbSB3aGF0ZXZlciBnbG9iYWwgaXMgcHJlc2VudCBzbyB0aGF0IHRlc3QgcnVubmVycyB0aGF0IHN0dWIgaXQKICAvLyBkb24ndCBicmVhayB0aGluZ3MuICBCdXQgd2UgbmVlZCB0byB3cmFwIGl0IGluIGEgdHJ5IGNhdGNoIGluIGNhc2UgaXQgaXMKICAvLyB3cmFwcGVkIGluIHN0cmljdCBtb2RlIGNvZGUgd2hpY2ggZG9lc24ndCBkZWZpbmUgYW55IGdsb2JhbHMuICBJdCdzIGluc2lkZSBhCiAgLy8gZnVuY3Rpb24gYmVjYXVzZSB0cnkvY2F0Y2hlcyBkZW9wdGltaXplIGluIGNlcnRhaW4gZW5naW5lcy4KICAKICB2YXIgY2FjaGVkU2V0VGltZW91dDsKICB2YXIgY2FjaGVkQ2xlYXJUaW1lb3V0OwogIAogIGZ1bmN0aW9uIGRlZmF1bHRTZXRUaW1vdXQoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignc2V0VGltZW91dCBoYXMgbm90IGJlZW4gZGVmaW5lZCcpOwogIH0KICBmdW5jdGlvbiBkZWZhdWx0Q2xlYXJUaW1lb3V0ICgpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdjbGVhclRpbWVvdXQgaGFzIG5vdCBiZWVuIGRlZmluZWQnKTsKICB9CiAgKGZ1bmN0aW9uICgpIHsKICAgICAgdHJ5IHsKICAgICAgICAgIGlmICh0eXBlb2Ygc2V0VGltZW91dCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgIGNhY2hlZFNldFRpbWVvdXQgPSBzZXRUaW1lb3V0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjYWNoZWRTZXRUaW1lb3V0ID0gZGVmYXVsdFNldFRpbW91dDsKICAgICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY2FjaGVkU2V0VGltZW91dCA9IGRlZmF1bHRTZXRUaW1vdXQ7CiAgICAgIH0KICAgICAgdHJ5IHsKICAgICAgICAgIGlmICh0eXBlb2YgY2xlYXJUaW1lb3V0ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgY2FjaGVkQ2xlYXJUaW1lb3V0ID0gY2xlYXJUaW1lb3V0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjYWNoZWRDbGVhclRpbWVvdXQgPSBkZWZhdWx0Q2xlYXJUaW1lb3V0OwogICAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjYWNoZWRDbGVhclRpbWVvdXQgPSBkZWZhdWx0Q2xlYXJUaW1lb3V0OwogICAgICB9CiAgfSAoKSkKICBmdW5jdGlvbiBydW5UaW1lb3V0KGZ1bikgewogICAgICBpZiAoY2FjaGVkU2V0VGltZW91dCA9PT0gc2V0VGltZW91dCkgewogICAgICAgICAgLy9ub3JtYWwgZW52aXJvbWVudHMgaW4gc2FuZSBzaXR1YXRpb25zCiAgICAgICAgICByZXR1cm4gc2V0VGltZW91dChmdW4sIDApOwogICAgICB9CiAgICAgIC8vIGlmIHNldFRpbWVvdXQgd2Fzbid0IGF2YWlsYWJsZSBidXQgd2FzIGxhdHRlciBkZWZpbmVkCiAgICAgIGlmICgoY2FjaGVkU2V0VGltZW91dCA9PT0gZGVmYXVsdFNldFRpbW91dCB8fCAhY2FjaGVkU2V0VGltZW91dCkgJiYgc2V0VGltZW91dCkgewogICAgICAgICAgY2FjaGVkU2V0VGltZW91dCA9IHNldFRpbWVvdXQ7CiAgICAgICAgICByZXR1cm4gc2V0VGltZW91dChmdW4sIDApOwogICAgICB9CiAgICAgIHRyeSB7CiAgICAgICAgICAvLyB3aGVuIHdoZW4gc29tZWJvZHkgaGFzIHNjcmV3ZWQgd2l0aCBzZXRUaW1lb3V0IGJ1dCBubyBJLkUuIG1hZGRuZXNzCiAgICAgICAgICByZXR1cm4gY2FjaGVkU2V0VGltZW91dChmdW4sIDApOwogICAgICB9IGNhdGNoKGUpewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAvLyBXaGVuIHdlIGFyZSBpbiBJLkUuIGJ1dCB0aGUgc2NyaXB0IGhhcyBiZWVuIGV2YWxlZCBzbyBJLkUuIGRvZXNuJ3QgdHJ1c3QgdGhlIGdsb2JhbCBvYmplY3Qgd2hlbiBjYWxsZWQgbm9ybWFsbHkKICAgICAgICAgICAgICByZXR1cm4gY2FjaGVkU2V0VGltZW91dC5jYWxsKG51bGwsIGZ1biwgMCk7CiAgICAgICAgICB9IGNhdGNoKGUpewogICAgICAgICAgICAgIC8vIHNhbWUgYXMgYWJvdmUgYnV0IHdoZW4gaXQncyBhIHZlcnNpb24gb2YgSS5FLiB0aGF0IG11c3QgaGF2ZSB0aGUgZ2xvYmFsIG9iamVjdCBmb3IgJ3RoaXMnLCBob3BmdWxseSBvdXIgY29udGV4dCBjb3JyZWN0IG90aGVyd2lzZSBpdCB3aWxsIHRocm93IGEgZ2xvYmFsIGVycm9yCiAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlZFNldFRpbWVvdXQuY2FsbCh0aGlzLCBmdW4sIDApOwogICAgICAgICAgfQogICAgICB9CiAgCiAgCiAgfQogIGZ1bmN0aW9uIHJ1bkNsZWFyVGltZW91dChtYXJrZXIpIHsKICAgICAgaWYgKGNhY2hlZENsZWFyVGltZW91dCA9PT0gY2xlYXJUaW1lb3V0KSB7CiAgICAgICAgICAvL25vcm1hbCBlbnZpcm9tZW50cyBpbiBzYW5lIHNpdHVhdGlvbnMKICAgICAgICAgIHJldHVybiBjbGVhclRpbWVvdXQobWFya2VyKTsKICAgICAgfQogICAgICAvLyBpZiBjbGVhclRpbWVvdXQgd2Fzbid0IGF2YWlsYWJsZSBidXQgd2FzIGxhdHRlciBkZWZpbmVkCiAgICAgIGlmICgoY2FjaGVkQ2xlYXJUaW1lb3V0ID09PSBkZWZhdWx0Q2xlYXJUaW1lb3V0IHx8ICFjYWNoZWRDbGVhclRpbWVvdXQpICYmIGNsZWFyVGltZW91dCkgewogICAgICAgICAgY2FjaGVkQ2xlYXJUaW1lb3V0ID0gY2xlYXJUaW1lb3V0OwogICAgICAgICAgcmV0dXJuIGNsZWFyVGltZW91dChtYXJrZXIpOwogICAgICB9CiAgICAgIHRyeSB7CiAgICAgICAgICAvLyB3aGVuIHdoZW4gc29tZWJvZHkgaGFzIHNjcmV3ZWQgd2l0aCBzZXRUaW1lb3V0IGJ1dCBubyBJLkUuIG1hZGRuZXNzCiAgICAgICAgICByZXR1cm4gY2FjaGVkQ2xlYXJUaW1lb3V0KG1hcmtlcik7CiAgICAgIH0gY2F0Y2ggKGUpewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAvLyBXaGVuIHdlIGFyZSBpbiBJLkUuIGJ1dCB0aGUgc2NyaXB0IGhhcyBiZWVuIGV2YWxlZCBzbyBJLkUuIGRvZXNuJ3QgIHRydXN0IHRoZSBnbG9iYWwgb2JqZWN0IHdoZW4gY2FsbGVkIG5vcm1hbGx5CiAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlZENsZWFyVGltZW91dC5jYWxsKG51bGwsIG1hcmtlcik7CiAgICAgICAgICB9IGNhdGNoIChlKXsKICAgICAgICAgICAgICAvLyBzYW1lIGFzIGFib3ZlIGJ1dCB3aGVuIGl0J3MgYSB2ZXJzaW9uIG9mIEkuRS4gdGhhdCBtdXN0IGhhdmUgdGhlIGdsb2JhbCBvYmplY3QgZm9yICd0aGlzJywgaG9wZnVsbHkgb3VyIGNvbnRleHQgY29ycmVjdCBvdGhlcndpc2UgaXQgd2lsbCB0aHJvdyBhIGdsb2JhbCBlcnJvci4KICAgICAgICAgICAgICAvLyBTb21lIHZlcnNpb25zIG9mIEkuRS4gaGF2ZSBkaWZmZXJlbnQgcnVsZXMgZm9yIGNsZWFyVGltZW91dCB2cyBzZXRUaW1lb3V0CiAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlZENsZWFyVGltZW91dC5jYWxsKHRoaXMsIG1hcmtlcik7CiAgICAgICAgICB9CiAgICAgIH0KICAKICAKICAKICB9CiAgdmFyIHF1ZXVlID0gW107CiAgdmFyIGRyYWluaW5nID0gZmFsc2U7CiAgdmFyIGN1cnJlbnRRdWV1ZTsKICB2YXIgcXVldWVJbmRleCA9IC0xOwogIAogIGZ1bmN0aW9uIGNsZWFuVXBOZXh0VGljaygpIHsKICAgICAgaWYgKCFkcmFpbmluZyB8fCAhY3VycmVudFF1ZXVlKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgZHJhaW5pbmcgPSBmYWxzZTsKICAgICAgaWYgKGN1cnJlbnRRdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgIHF1ZXVlID0gY3VycmVudFF1ZXVlLmNvbmNhdChxdWV1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgICBxdWV1ZUluZGV4ID0gLTE7CiAgICAgIH0KICAgICAgaWYgKHF1ZXVlLmxlbmd0aCkgewogICAgICAgICAgZHJhaW5RdWV1ZSgpOwogICAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGRyYWluUXVldWUoKSB7CiAgICAgIGlmIChkcmFpbmluZykgewogICAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciB0aW1lb3V0ID0gcnVuVGltZW91dChjbGVhblVwTmV4dFRpY2spOwogICAgICBkcmFpbmluZyA9IHRydWU7CiAgCiAgICAgIHZhciBsZW4gPSBxdWV1ZS5sZW5ndGg7CiAgICAgIHdoaWxlKGxlbikgewogICAgICAgICAgY3VycmVudFF1ZXVlID0gcXVldWU7CiAgICAgICAgICBxdWV1ZSA9IFtdOwogICAgICAgICAgd2hpbGUgKCsrcXVldWVJbmRleCA8IGxlbikgewogICAgICAgICAgICAgIGlmIChjdXJyZW50UXVldWUpIHsKICAgICAgICAgICAgICAgICAgY3VycmVudFF1ZXVlW3F1ZXVlSW5kZXhdLnJ1bigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlSW5kZXggPSAtMTsKICAgICAgICAgIGxlbiA9IHF1ZXVlLmxlbmd0aDsKICAgICAgfQogICAgICBjdXJyZW50UXVldWUgPSBudWxsOwogICAgICBkcmFpbmluZyA9IGZhbHNlOwogICAgICBydW5DbGVhclRpbWVvdXQodGltZW91dCk7CiAgfQogIAogIHByb2Nlc3MubmV4dFRpY2sgPSBmdW5jdGlvbiAoZnVuKSB7CiAgICAgIHZhciBhcmdzID0gbmV3IEFycmF5KGFyZ3VtZW50cy5sZW5ndGggLSAxKTsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGFyZ3NbaSAtIDFdID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHF1ZXVlLnB1c2gobmV3IEl0ZW0oZnVuLCBhcmdzKSk7CiAgICAgIGlmIChxdWV1ZS5sZW5ndGggPT09IDEgJiYgIWRyYWluaW5nKSB7CiAgICAgICAgICBydW5UaW1lb3V0KGRyYWluUXVldWUpOwogICAgICB9CiAgfTsKICAKICAvLyB2OCBsaWtlcyBwcmVkaWN0aWJsZSBvYmplY3RzCiAgZnVuY3Rpb24gSXRlbShmdW4sIGFycmF5KSB7CiAgICAgIHRoaXMuZnVuID0gZnVuOwogICAgICB0aGlzLmFycmF5ID0gYXJyYXk7CiAgfQogIEl0ZW0ucHJvdG90eXBlLnJ1biA9IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5mdW4uYXBwbHkobnVsbCwgdGhpcy5hcnJheSk7CiAgfTsKICBwcm9jZXNzLnRpdGxlID0gJ2Jyb3dzZXInOwogIHByb2Nlc3MuYnJvd3NlciA9IHRydWU7CiAgcHJvY2Vzcy5lbnYgPSB7fTsKICBwcm9jZXNzLmFyZ3YgPSBbXTsKICBwcm9jZXNzLnZlcnNpb24gPSAnJzsgLy8gZW1wdHkgc3RyaW5nIHRvIGF2b2lkIHJlZ2V4cCBpc3N1ZXMKICBwcm9jZXNzLnZlcnNpb25zID0ge307CiAgCiAgZnVuY3Rpb24gbm9vcCgpIHt9CiAgCiAgcHJvY2Vzcy5vbiA9IG5vb3A7CiAgcHJvY2Vzcy5hZGRMaXN0ZW5lciA9IG5vb3A7CiAgcHJvY2Vzcy5vbmNlID0gbm9vcDsKICBwcm9jZXNzLm9mZiA9IG5vb3A7CiAgcHJvY2Vzcy5yZW1vdmVMaXN0ZW5lciA9IG5vb3A7CiAgcHJvY2Vzcy5yZW1vdmVBbGxMaXN0ZW5lcnMgPSBub29wOwogIHByb2Nlc3MuZW1pdCA9IG5vb3A7CiAgcHJvY2Vzcy5wcmVwZW5kTGlzdGVuZXIgPSBub29wOwogIHByb2Nlc3MucHJlcGVuZE9uY2VMaXN0ZW5lciA9IG5vb3A7CiAgCiAgcHJvY2Vzcy5saXN0ZW5lcnMgPSBmdW5jdGlvbiAobmFtZSkgeyByZXR1cm4gW10gfQogIAogIHByb2Nlc3MuYmluZGluZyA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigncHJvY2Vzcy5iaW5kaW5nIGlzIG5vdCBzdXBwb3J0ZWQnKTsKICB9OwogIAogIHByb2Nlc3MuY3dkID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gJy8nIH07CiAgcHJvY2Vzcy5jaGRpciA9IGZ1bmN0aW9uIChkaXIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdwcm9jZXNzLmNoZGlyIGlzIG5vdCBzdXBwb3J0ZWQnKTsKICB9OwogIHByb2Nlc3MudW1hc2sgPSBmdW5jdGlvbigpIHsgcmV0dXJuIDA7IH07CiAgCiAgfSx7fV0sODY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAoZ2xvYmFsKXsKICAvKiEgaHR0cHM6Ly9tdGhzLmJlL3B1bnljb2RlIHYxLjMuMiBieSBAbWF0aGlhcyAqLwogIDsoZnVuY3Rpb24ocm9vdCkgewogIAogICAgLyoqIERldGVjdCBmcmVlIHZhcmlhYmxlcyAqLwogICAgdmFyIGZyZWVFeHBvcnRzID0gdHlwZW9mIGV4cG9ydHMgPT0gJ29iamVjdCcgJiYgZXhwb3J0cyAmJgogICAgICAhZXhwb3J0cy5ub2RlVHlwZSAmJiBleHBvcnRzOwogICAgdmFyIGZyZWVNb2R1bGUgPSB0eXBlb2YgbW9kdWxlID09ICdvYmplY3QnICYmIG1vZHVsZSAmJgogICAgICAhbW9kdWxlLm5vZGVUeXBlICYmIG1vZHVsZTsKICAgIHZhciBmcmVlR2xvYmFsID0gdHlwZW9mIGdsb2JhbCA9PSAnb2JqZWN0JyAmJiBnbG9iYWw7CiAgICBpZiAoCiAgICAgIGZyZWVHbG9iYWwuZ2xvYmFsID09PSBmcmVlR2xvYmFsIHx8CiAgICAgIGZyZWVHbG9iYWwud2luZG93ID09PSBmcmVlR2xvYmFsIHx8CiAgICAgIGZyZWVHbG9iYWwuc2VsZiA9PT0gZnJlZUdsb2JhbAogICAgKSB7CiAgICAgIHJvb3QgPSBmcmVlR2xvYmFsOwogICAgfQogIAogICAgLyoqCiAgICAgKiBUaGUgYHB1bnljb2RlYCBvYmplY3QuCiAgICAgKiBAbmFtZSBwdW55Y29kZQogICAgICogQHR5cGUgT2JqZWN0CiAgICAgKi8KICAgIHZhciBwdW55Y29kZSwKICAKICAgIC8qKiBIaWdoZXN0IHBvc2l0aXZlIHNpZ25lZCAzMi1iaXQgZmxvYXQgdmFsdWUgKi8KICAgIG1heEludCA9IDIxNDc0ODM2NDcsIC8vIGFrYS4gMHg3RkZGRkZGRiBvciAyXjMxLTEKICAKICAgIC8qKiBCb290c3RyaW5nIHBhcmFtZXRlcnMgKi8KICAgIGJhc2UgPSAzNiwKICAgIHRNaW4gPSAxLAogICAgdE1heCA9IDI2LAogICAgc2tldyA9IDM4LAogICAgZGFtcCA9IDcwMCwKICAgIGluaXRpYWxCaWFzID0gNzIsCiAgICBpbml0aWFsTiA9IDEyOCwgLy8gMHg4MAogICAgZGVsaW1pdGVyID0gJy0nLCAvLyAnXHgyRCcKICAKICAgIC8qKiBSZWd1bGFyIGV4cHJlc3Npb25zICovCiAgICByZWdleFB1bnljb2RlID0gL154bi0tLywKICAgIHJlZ2V4Tm9uQVNDSUkgPSAvW15ceDIwLVx4N0VdLywgLy8gdW5wcmludGFibGUgQVNDSUkgY2hhcnMgKyBub24tQVNDSUkgY2hhcnMKICAgIHJlZ2V4U2VwYXJhdG9ycyA9IC9bXHgyRVx1MzAwMlx1RkYwRVx1RkY2MV0vZywgLy8gUkZDIDM0OTAgc2VwYXJhdG9ycwogIAogICAgLyoqIEVycm9yIG1lc3NhZ2VzICovCiAgICBlcnJvcnMgPSB7CiAgICAgICdvdmVyZmxvdyc6ICdPdmVyZmxvdzogaW5wdXQgbmVlZHMgd2lkZXIgaW50ZWdlcnMgdG8gcHJvY2VzcycsCiAgICAgICdub3QtYmFzaWMnOiAnSWxsZWdhbCBpbnB1dCA+PSAweDgwIChub3QgYSBiYXNpYyBjb2RlIHBvaW50KScsCiAgICAgICdpbnZhbGlkLWlucHV0JzogJ0ludmFsaWQgaW5wdXQnCiAgICB9LAogIAogICAgLyoqIENvbnZlbmllbmNlIHNob3J0Y3V0cyAqLwogICAgYmFzZU1pbnVzVE1pbiA9IGJhc2UgLSB0TWluLAogICAgZmxvb3IgPSBNYXRoLmZsb29yLAogICAgc3RyaW5nRnJvbUNoYXJDb2RlID0gU3RyaW5nLmZyb21DaGFyQ29kZSwKICAKICAgIC8qKiBUZW1wb3JhcnkgdmFyaWFibGUgKi8KICAgIGtleTsKICAKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIAogICAgLyoqCiAgICAgKiBBIGdlbmVyaWMgZXJyb3IgdXRpbGl0eSBmdW5jdGlvbi4KICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgZXJyb3IgdHlwZS4KICAgICAqIEByZXR1cm5zIHtFcnJvcn0gVGhyb3dzIGEgYFJhbmdlRXJyb3JgIHdpdGggdGhlIGFwcGxpY2FibGUgZXJyb3IgbWVzc2FnZS4KICAgICAqLwogICAgZnVuY3Rpb24gZXJyb3IodHlwZSkgewogICAgICB0aHJvdyBSYW5nZUVycm9yKGVycm9yc1t0eXBlXSk7CiAgICB9CiAgCiAgICAvKioKICAgICAqIEEgZ2VuZXJpYyBgQXJyYXkjbWFwYCB1dGlsaXR5IGZ1bmN0aW9uLgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdGhhdCBnZXRzIGNhbGxlZCBmb3IgZXZlcnkgYXJyYXkKICAgICAqIGl0ZW0uCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IEEgbmV3IGFycmF5IG9mIHZhbHVlcyByZXR1cm5lZCBieSB0aGUgY2FsbGJhY2sgZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1hcChhcnJheSwgZm4pIHsKICAgICAgdmFyIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICByZXN1bHRbbGVuZ3RoXSA9IGZuKGFycmF5W2xlbmd0aF0pOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgCiAgICAvKioKICAgICAqIEEgc2ltcGxlIGBBcnJheSNtYXBgLWxpa2Ugd3JhcHBlciB0byB3b3JrIHdpdGggZG9tYWluIG5hbWUgc3RyaW5ncyBvciBlbWFpbAogICAgICogYWRkcmVzc2VzLgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBkb21haW4gVGhlIGRvbWFpbiBuYW1lIG9yIGVtYWlsIGFkZHJlc3MuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdGhhdCBnZXRzIGNhbGxlZCBmb3IgZXZlcnkKICAgICAqIGNoYXJhY3Rlci4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gQSBuZXcgc3RyaW5nIG9mIGNoYXJhY3RlcnMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrCiAgICAgKiBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gbWFwRG9tYWluKHN0cmluZywgZm4pIHsKICAgICAgdmFyIHBhcnRzID0gc3RyaW5nLnNwbGl0KCdAJyk7CiAgICAgIHZhciByZXN1bHQgPSAnJzsKICAgICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEpIHsKICAgICAgICAvLyBJbiBlbWFpbCBhZGRyZXNzZXMsIG9ubHkgdGhlIGRvbWFpbiBuYW1lIHNob3VsZCBiZSBwdW55Y29kZWQuIExlYXZlCiAgICAgICAgLy8gdGhlIGxvY2FsIHBhcnQgKGkuZS4gZXZlcnl0aGluZyB1cCB0byBgQGApIGludGFjdC4KICAgICAgICByZXN1bHQgPSBwYXJ0c1swXSArICdAJzsKICAgICAgICBzdHJpbmcgPSBwYXJ0c1sxXTsKICAgICAgfQogICAgICAvLyBBdm9pZCBgc3BsaXQocmVnZXgpYCBmb3IgSUU4IGNvbXBhdGliaWxpdHkuIFNlZSAjMTcuCiAgICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKHJlZ2V4U2VwYXJhdG9ycywgJ1x4MkUnKTsKICAgICAgdmFyIGxhYmVscyA9IHN0cmluZy5zcGxpdCgnLicpOwogICAgICB2YXIgZW5jb2RlZCA9IG1hcChsYWJlbHMsIGZuKS5qb2luKCcuJyk7CiAgICAgIHJldHVybiByZXN1bHQgKyBlbmNvZGVkOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IGNvbnRhaW5pbmcgdGhlIG51bWVyaWMgY29kZSBwb2ludHMgb2YgZWFjaCBVbmljb2RlCiAgICAgKiBjaGFyYWN0ZXIgaW4gdGhlIHN0cmluZy4gV2hpbGUgSmF2YVNjcmlwdCB1c2VzIFVDUy0yIGludGVybmFsbHksCiAgICAgKiB0aGlzIGZ1bmN0aW9uIHdpbGwgY29udmVydCBhIHBhaXIgb2Ygc3Vycm9nYXRlIGhhbHZlcyAoZWFjaCBvZiB3aGljaAogICAgICogVUNTLTIgZXhwb3NlcyBhcyBzZXBhcmF0ZSBjaGFyYWN0ZXJzKSBpbnRvIGEgc2luZ2xlIGNvZGUgcG9pbnQsCiAgICAgKiBtYXRjaGluZyBVVEYtMTYuCiAgICAgKiBAc2VlIGBwdW55Y29kZS51Y3MyLmVuY29kZWAKICAgICAqIEBzZWUgPGh0dHBzOi8vbWF0aGlhc2J5bmVucy5iZS9ub3Rlcy9qYXZhc2NyaXB0LWVuY29kaW5nPgogICAgICogQG1lbWJlck9mIHB1bnljb2RlLnVjczIKICAgICAqIEBuYW1lIGRlY29kZQogICAgICogQHBhcmFtIHtTdHJpbmd9IHN0cmluZyBUaGUgVW5pY29kZSBpbnB1dCBzdHJpbmcgKFVDUy0yKS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gVGhlIG5ldyBhcnJheSBvZiBjb2RlIHBvaW50cy4KICAgICAqLwogICAgZnVuY3Rpb24gdWNzMmRlY29kZShzdHJpbmcpIHsKICAgICAgdmFyIG91dHB1dCA9IFtdLAogICAgICAgICAgY291bnRlciA9IDAsCiAgICAgICAgICBsZW5ndGggPSBzdHJpbmcubGVuZ3RoLAogICAgICAgICAgdmFsdWUsCiAgICAgICAgICBleHRyYTsKICAgICAgd2hpbGUgKGNvdW50ZXIgPCBsZW5ndGgpIHsKICAgICAgICB2YWx1ZSA9IHN0cmluZy5jaGFyQ29kZUF0KGNvdW50ZXIrKyk7CiAgICAgICAgaWYgKHZhbHVlID49IDB4RDgwMCAmJiB2YWx1ZSA8PSAweERCRkYgJiYgY291bnRlciA8IGxlbmd0aCkgewogICAgICAgICAgLy8gaGlnaCBzdXJyb2dhdGUsIGFuZCB0aGVyZSBpcyBhIG5leHQgY2hhcmFjdGVyCiAgICAgICAgICBleHRyYSA9IHN0cmluZy5jaGFyQ29kZUF0KGNvdW50ZXIrKyk7CiAgICAgICAgICBpZiAoKGV4dHJhICYgMHhGQzAwKSA9PSAweERDMDApIHsgLy8gbG93IHN1cnJvZ2F0ZQogICAgICAgICAgICBvdXRwdXQucHVzaCgoKHZhbHVlICYgMHgzRkYpIDw8IDEwKSArIChleHRyYSAmIDB4M0ZGKSArIDB4MTAwMDApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gdW5tYXRjaGVkIHN1cnJvZ2F0ZTsgb25seSBhcHBlbmQgdGhpcyBjb2RlIHVuaXQsIGluIGNhc2UgdGhlIG5leHQKICAgICAgICAgICAgLy8gY29kZSB1bml0IGlzIHRoZSBoaWdoIHN1cnJvZ2F0ZSBvZiBhIHN1cnJvZ2F0ZSBwYWlyCiAgICAgICAgICAgIG91dHB1dC5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgY291bnRlci0tOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBvdXRwdXQ7CiAgICB9CiAgCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBzdHJpbmcgYmFzZWQgb24gYW4gYXJyYXkgb2YgbnVtZXJpYyBjb2RlIHBvaW50cy4KICAgICAqIEBzZWUgYHB1bnljb2RlLnVjczIuZGVjb2RlYAogICAgICogQG1lbWJlck9mIHB1bnljb2RlLnVjczIKICAgICAqIEBuYW1lIGVuY29kZQogICAgICogQHBhcmFtIHtBcnJheX0gY29kZVBvaW50cyBUaGUgYXJyYXkgb2YgbnVtZXJpYyBjb2RlIHBvaW50cy4KICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IFRoZSBuZXcgVW5pY29kZSBzdHJpbmcgKFVDUy0yKS4KICAgICAqLwogICAgZnVuY3Rpb24gdWNzMmVuY29kZShhcnJheSkgewogICAgICByZXR1cm4gbWFwKGFycmF5LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHZhciBvdXRwdXQgPSAnJzsKICAgICAgICBpZiAodmFsdWUgPiAweEZGRkYpIHsKICAgICAgICAgIHZhbHVlIC09IDB4MTAwMDA7CiAgICAgICAgICBvdXRwdXQgKz0gc3RyaW5nRnJvbUNoYXJDb2RlKHZhbHVlID4+PiAxMCAmIDB4M0ZGIHwgMHhEODAwKTsKICAgICAgICAgIHZhbHVlID0gMHhEQzAwIHwgdmFsdWUgJiAweDNGRjsKICAgICAgICB9CiAgICAgICAgb3V0cHV0ICs9IHN0cmluZ0Zyb21DaGFyQ29kZSh2YWx1ZSk7CiAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgfSkuam9pbignJyk7CiAgICB9CiAgCiAgICAvKioKICAgICAqIENvbnZlcnRzIGEgYmFzaWMgY29kZSBwb2ludCBpbnRvIGEgZGlnaXQvaW50ZWdlci4KICAgICAqIEBzZWUgYGRpZ2l0VG9CYXNpYygpYAogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBjb2RlUG9pbnQgVGhlIGJhc2ljIG51bWVyaWMgY29kZSBwb2ludCB2YWx1ZS4KICAgICAqIEByZXR1cm5zIHtOdW1iZXJ9IFRoZSBudW1lcmljIHZhbHVlIG9mIGEgYmFzaWMgY29kZSBwb2ludCAoZm9yIHVzZSBpbgogICAgICogcmVwcmVzZW50aW5nIGludGVnZXJzKSBpbiB0aGUgcmFuZ2UgYDBgIHRvIGBiYXNlIC0gMWAsIG9yIGBiYXNlYCBpZgogICAgICogdGhlIGNvZGUgcG9pbnQgZG9lcyBub3QgcmVwcmVzZW50IGEgdmFsdWUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2ljVG9EaWdpdChjb2RlUG9pbnQpIHsKICAgICAgaWYgKGNvZGVQb2ludCAtIDQ4IDwgMTApIHsKICAgICAgICByZXR1cm4gY29kZVBvaW50IC0gMjI7CiAgICAgIH0KICAgICAgaWYgKGNvZGVQb2ludCAtIDY1IDwgMjYpIHsKICAgICAgICByZXR1cm4gY29kZVBvaW50IC0gNjU7CiAgICAgIH0KICAgICAgaWYgKGNvZGVQb2ludCAtIDk3IDwgMjYpIHsKICAgICAgICByZXR1cm4gY29kZVBvaW50IC0gOTc7CiAgICAgIH0KICAgICAgcmV0dXJuIGJhc2U7CiAgICB9CiAgCiAgICAvKioKICAgICAqIENvbnZlcnRzIGEgZGlnaXQvaW50ZWdlciBpbnRvIGEgYmFzaWMgY29kZSBwb2ludC4KICAgICAqIEBzZWUgYGJhc2ljVG9EaWdpdCgpYAogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBkaWdpdCBUaGUgbnVtZXJpYyB2YWx1ZSBvZiBhIGJhc2ljIGNvZGUgcG9pbnQuCiAgICAgKiBAcmV0dXJucyB7TnVtYmVyfSBUaGUgYmFzaWMgY29kZSBwb2ludCB3aG9zZSB2YWx1ZSAod2hlbiB1c2VkIGZvcgogICAgICogcmVwcmVzZW50aW5nIGludGVnZXJzKSBpcyBgZGlnaXRgLCB3aGljaCBuZWVkcyB0byBiZSBpbiB0aGUgcmFuZ2UKICAgICAqIGAwYCB0byBgYmFzZSAtIDFgLiBJZiBgZmxhZ2AgaXMgbm9uLXplcm8sIHRoZSB1cHBlcmNhc2UgZm9ybSBpcwogICAgICogdXNlZDsgZWxzZSwgdGhlIGxvd2VyY2FzZSBmb3JtIGlzIHVzZWQuIFRoZSBiZWhhdmlvciBpcyB1bmRlZmluZWQKICAgICAqIGlmIGBmbGFnYCBpcyBub24temVybyBhbmQgYGRpZ2l0YCBoYXMgbm8gdXBwZXJjYXNlIGZvcm0uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRpZ2l0VG9CYXNpYyhkaWdpdCwgZmxhZykgewogICAgICAvLyAgMC4uMjUgbWFwIHRvIEFTQ0lJIGEuLnogb3IgQS4uWgogICAgICAvLyAyNi4uMzUgbWFwIHRvIEFTQ0lJIDAuLjkKICAgICAgcmV0dXJuIGRpZ2l0ICsgMjIgKyA3NSAqIChkaWdpdCA8IDI2KSAtICgoZmxhZyAhPSAwKSA8PCA1KTsKICAgIH0KICAKICAgIC8qKgogICAgICogQmlhcyBhZGFwdGF0aW9uIGZ1bmN0aW9uIGFzIHBlciBzZWN0aW9uIDMuNCBvZiBSRkMgMzQ5Mi4KICAgICAqIGh0dHA6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzM0OTIjc2VjdGlvbi0zLjQKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFkYXB0KGRlbHRhLCBudW1Qb2ludHMsIGZpcnN0VGltZSkgewogICAgICB2YXIgayA9IDA7CiAgICAgIGRlbHRhID0gZmlyc3RUaW1lID8gZmxvb3IoZGVsdGEgLyBkYW1wKSA6IGRlbHRhID4+IDE7CiAgICAgIGRlbHRhICs9IGZsb29yKGRlbHRhIC8gbnVtUG9pbnRzKTsKICAgICAgZm9yICgvKiBubyBpbml0aWFsaXphdGlvbiAqLzsgZGVsdGEgPiBiYXNlTWludXNUTWluICogdE1heCA+PiAxOyBrICs9IGJhc2UpIHsKICAgICAgICBkZWx0YSA9IGZsb29yKGRlbHRhIC8gYmFzZU1pbnVzVE1pbik7CiAgICAgIH0KICAgICAgcmV0dXJuIGZsb29yKGsgKyAoYmFzZU1pbnVzVE1pbiArIDEpICogZGVsdGEgLyAoZGVsdGEgKyBza2V3KSk7CiAgICB9CiAgCiAgICAvKioKICAgICAqIENvbnZlcnRzIGEgUHVueWNvZGUgc3RyaW5nIG9mIEFTQ0lJLW9ubHkgc3ltYm9scyB0byBhIHN0cmluZyBvZiBVbmljb2RlCiAgICAgKiBzeW1ib2xzLgogICAgICogQG1lbWJlck9mIHB1bnljb2RlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gaW5wdXQgVGhlIFB1bnljb2RlIHN0cmluZyBvZiBBU0NJSS1vbmx5IHN5bWJvbHMuCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBUaGUgcmVzdWx0aW5nIHN0cmluZyBvZiBVbmljb2RlIHN5bWJvbHMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRlY29kZShpbnB1dCkgewogICAgICAvLyBEb24ndCB1c2UgVUNTLTIKICAgICAgdmFyIG91dHB1dCA9IFtdLAogICAgICAgICAgaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGgsCiAgICAgICAgICBvdXQsCiAgICAgICAgICBpID0gMCwKICAgICAgICAgIG4gPSBpbml0aWFsTiwKICAgICAgICAgIGJpYXMgPSBpbml0aWFsQmlhcywKICAgICAgICAgIGJhc2ljLAogICAgICAgICAgaiwKICAgICAgICAgIGluZGV4LAogICAgICAgICAgb2xkaSwKICAgICAgICAgIHcsCiAgICAgICAgICBrLAogICAgICAgICAgZGlnaXQsCiAgICAgICAgICB0LAogICAgICAgICAgLyoqIENhY2hlZCBjYWxjdWxhdGlvbiByZXN1bHRzICovCiAgICAgICAgICBiYXNlTWludXNUOwogIAogICAgICAvLyBIYW5kbGUgdGhlIGJhc2ljIGNvZGUgcG9pbnRzOiBsZXQgYGJhc2ljYCBiZSB0aGUgbnVtYmVyIG9mIGlucHV0IGNvZGUKICAgICAgLy8gcG9pbnRzIGJlZm9yZSB0aGUgbGFzdCBkZWxpbWl0ZXIsIG9yIGAwYCBpZiB0aGVyZSBpcyBub25lLCB0aGVuIGNvcHkKICAgICAgLy8gdGhlIGZpcnN0IGJhc2ljIGNvZGUgcG9pbnRzIHRvIHRoZSBvdXRwdXQuCiAgCiAgICAgIGJhc2ljID0gaW5wdXQubGFzdEluZGV4T2YoZGVsaW1pdGVyKTsKICAgICAgaWYgKGJhc2ljIDwgMCkgewogICAgICAgIGJhc2ljID0gMDsKICAgICAgfQogIAogICAgICBmb3IgKGogPSAwOyBqIDwgYmFzaWM7ICsraikgewogICAgICAgIC8vIGlmIGl0J3Mgbm90IGEgYmFzaWMgY29kZSBwb2ludAogICAgICAgIGlmIChpbnB1dC5jaGFyQ29kZUF0KGopID49IDB4ODApIHsKICAgICAgICAgIGVycm9yKCdub3QtYmFzaWMnKTsKICAgICAgICB9CiAgICAgICAgb3V0cHV0LnB1c2goaW5wdXQuY2hhckNvZGVBdChqKSk7CiAgICAgIH0KICAKICAgICAgLy8gTWFpbiBkZWNvZGluZyBsb29wOiBzdGFydCBqdXN0IGFmdGVyIHRoZSBsYXN0IGRlbGltaXRlciBpZiBhbnkgYmFzaWMgY29kZQogICAgICAvLyBwb2ludHMgd2VyZSBjb3BpZWQ7IHN0YXJ0IGF0IHRoZSBiZWdpbm5pbmcgb3RoZXJ3aXNlLgogIAogICAgICBmb3IgKGluZGV4ID0gYmFzaWMgPiAwID8gYmFzaWMgKyAxIDogMDsgaW5kZXggPCBpbnB1dExlbmd0aDsgLyogbm8gZmluYWwgZXhwcmVzc2lvbiAqLykgewogIAogICAgICAgIC8vIGBpbmRleGAgaXMgdGhlIGluZGV4IG9mIHRoZSBuZXh0IGNoYXJhY3RlciB0byBiZSBjb25zdW1lZC4KICAgICAgICAvLyBEZWNvZGUgYSBnZW5lcmFsaXplZCB2YXJpYWJsZS1sZW5ndGggaW50ZWdlciBpbnRvIGBkZWx0YWAsCiAgICAgICAgLy8gd2hpY2ggZ2V0cyBhZGRlZCB0byBgaWAuIFRoZSBvdmVyZmxvdyBjaGVja2luZyBpcyBlYXNpZXIKICAgICAgICAvLyBpZiB3ZSBpbmNyZWFzZSBgaWAgYXMgd2UgZ28sIHRoZW4gc3VidHJhY3Qgb2ZmIGl0cyBzdGFydGluZwogICAgICAgIC8vIHZhbHVlIGF0IHRoZSBlbmQgdG8gb2J0YWluIGBkZWx0YWAuCiAgICAgICAgZm9yIChvbGRpID0gaSwgdyA9IDEsIGsgPSBiYXNlOyAvKiBubyBjb25kaXRpb24gKi87IGsgKz0gYmFzZSkgewogIAogICAgICAgICAgaWYgKGluZGV4ID49IGlucHV0TGVuZ3RoKSB7CiAgICAgICAgICAgIGVycm9yKCdpbnZhbGlkLWlucHV0Jyk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBkaWdpdCA9IGJhc2ljVG9EaWdpdChpbnB1dC5jaGFyQ29kZUF0KGluZGV4KyspKTsKICAKICAgICAgICAgIGlmIChkaWdpdCA+PSBiYXNlIHx8IGRpZ2l0ID4gZmxvb3IoKG1heEludCAtIGkpIC8gdykpIHsKICAgICAgICAgICAgZXJyb3IoJ292ZXJmbG93Jyk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBpICs9IGRpZ2l0ICogdzsKICAgICAgICAgIHQgPSBrIDw9IGJpYXMgPyB0TWluIDogKGsgPj0gYmlhcyArIHRNYXggPyB0TWF4IDogayAtIGJpYXMpOwogIAogICAgICAgICAgaWYgKGRpZ2l0IDwgdCkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAKICAgICAgICAgIGJhc2VNaW51c1QgPSBiYXNlIC0gdDsKICAgICAgICAgIGlmICh3ID4gZmxvb3IobWF4SW50IC8gYmFzZU1pbnVzVCkpIHsKICAgICAgICAgICAgZXJyb3IoJ292ZXJmbG93Jyk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICB3ICo9IGJhc2VNaW51c1Q7CiAgCiAgICAgICAgfQogIAogICAgICAgIG91dCA9IG91dHB1dC5sZW5ndGggKyAxOwogICAgICAgIGJpYXMgPSBhZGFwdChpIC0gb2xkaSwgb3V0LCBvbGRpID09IDApOwogIAogICAgICAgIC8vIGBpYCB3YXMgc3VwcG9zZWQgdG8gd3JhcCBhcm91bmQgZnJvbSBgb3V0YCB0byBgMGAsCiAgICAgICAgLy8gaW5jcmVtZW50aW5nIGBuYCBlYWNoIHRpbWUsIHNvIHdlJ2xsIGZpeCB0aGF0IG5vdzoKICAgICAgICBpZiAoZmxvb3IoaSAvIG91dCkgPiBtYXhJbnQgLSBuKSB7CiAgICAgICAgICBlcnJvcignb3ZlcmZsb3cnKTsKICAgICAgICB9CiAgCiAgICAgICAgbiArPSBmbG9vcihpIC8gb3V0KTsKICAgICAgICBpICU9IG91dDsKICAKICAgICAgICAvLyBJbnNlcnQgYG5gIGF0IHBvc2l0aW9uIGBpYCBvZiB0aGUgb3V0cHV0CiAgICAgICAgb3V0cHV0LnNwbGljZShpKyssIDAsIG4pOwogIAogICAgICB9CiAgCiAgICAgIHJldHVybiB1Y3MyZW5jb2RlKG91dHB1dCk7CiAgICB9CiAgCiAgICAvKioKICAgICAqIENvbnZlcnRzIGEgc3RyaW5nIG9mIFVuaWNvZGUgc3ltYm9scyAoZS5nLiBhIGRvbWFpbiBuYW1lIGxhYmVsKSB0byBhCiAgICAgKiBQdW55Y29kZSBzdHJpbmcgb2YgQVNDSUktb25seSBzeW1ib2xzLgogICAgICogQG1lbWJlck9mIHB1bnljb2RlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gaW5wdXQgVGhlIHN0cmluZyBvZiBVbmljb2RlIHN5bWJvbHMuCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBUaGUgcmVzdWx0aW5nIFB1bnljb2RlIHN0cmluZyBvZiBBU0NJSS1vbmx5IHN5bWJvbHMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVuY29kZShpbnB1dCkgewogICAgICB2YXIgbiwKICAgICAgICAgIGRlbHRhLAogICAgICAgICAgaGFuZGxlZENQQ291bnQsCiAgICAgICAgICBiYXNpY0xlbmd0aCwKICAgICAgICAgIGJpYXMsCiAgICAgICAgICBqLAogICAgICAgICAgbSwKICAgICAgICAgIHEsCiAgICAgICAgICBrLAogICAgICAgICAgdCwKICAgICAgICAgIGN1cnJlbnRWYWx1ZSwKICAgICAgICAgIG91dHB1dCA9IFtdLAogICAgICAgICAgLyoqIGBpbnB1dExlbmd0aGAgd2lsbCBob2xkIHRoZSBudW1iZXIgb2YgY29kZSBwb2ludHMgaW4gYGlucHV0YC4gKi8KICAgICAgICAgIGlucHV0TGVuZ3RoLAogICAgICAgICAgLyoqIENhY2hlZCBjYWxjdWxhdGlvbiByZXN1bHRzICovCiAgICAgICAgICBoYW5kbGVkQ1BDb3VudFBsdXNPbmUsCiAgICAgICAgICBiYXNlTWludXNULAogICAgICAgICAgcU1pbnVzVDsKICAKICAgICAgLy8gQ29udmVydCB0aGUgaW5wdXQgaW4gVUNTLTIgdG8gVW5pY29kZQogICAgICBpbnB1dCA9IHVjczJkZWNvZGUoaW5wdXQpOwogIAogICAgICAvLyBDYWNoZSB0aGUgbGVuZ3RoCiAgICAgIGlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoOwogIAogICAgICAvLyBJbml0aWFsaXplIHRoZSBzdGF0ZQogICAgICBuID0gaW5pdGlhbE47CiAgICAgIGRlbHRhID0gMDsKICAgICAgYmlhcyA9IGluaXRpYWxCaWFzOwogIAogICAgICAvLyBIYW5kbGUgdGhlIGJhc2ljIGNvZGUgcG9pbnRzCiAgICAgIGZvciAoaiA9IDA7IGogPCBpbnB1dExlbmd0aDsgKytqKSB7CiAgICAgICAgY3VycmVudFZhbHVlID0gaW5wdXRbal07CiAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSA8IDB4ODApIHsKICAgICAgICAgIG91dHB1dC5wdXNoKHN0cmluZ0Zyb21DaGFyQ29kZShjdXJyZW50VmFsdWUpKTsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgaGFuZGxlZENQQ291bnQgPSBiYXNpY0xlbmd0aCA9IG91dHB1dC5sZW5ndGg7CiAgCiAgICAgIC8vIGBoYW5kbGVkQ1BDb3VudGAgaXMgdGhlIG51bWJlciBvZiBjb2RlIHBvaW50cyB0aGF0IGhhdmUgYmVlbiBoYW5kbGVkOwogICAgICAvLyBgYmFzaWNMZW5ndGhgIGlzIHRoZSBudW1iZXIgb2YgYmFzaWMgY29kZSBwb2ludHMuCiAgCiAgICAgIC8vIEZpbmlzaCB0aGUgYmFzaWMgc3RyaW5nIC0gaWYgaXQgaXMgbm90IGVtcHR5IC0gd2l0aCBhIGRlbGltaXRlcgogICAgICBpZiAoYmFzaWNMZW5ndGgpIHsKICAgICAgICBvdXRwdXQucHVzaChkZWxpbWl0ZXIpOwogICAgICB9CiAgCiAgICAgIC8vIE1haW4gZW5jb2RpbmcgbG9vcDoKICAgICAgd2hpbGUgKGhhbmRsZWRDUENvdW50IDwgaW5wdXRMZW5ndGgpIHsKICAKICAgICAgICAvLyBBbGwgbm9uLWJhc2ljIGNvZGUgcG9pbnRzIDwgbiBoYXZlIGJlZW4gaGFuZGxlZCBhbHJlYWR5LiBGaW5kIHRoZSBuZXh0CiAgICAgICAgLy8gbGFyZ2VyIG9uZToKICAgICAgICBmb3IgKG0gPSBtYXhJbnQsIGogPSAwOyBqIDwgaW5wdXRMZW5ndGg7ICsraikgewogICAgICAgICAgY3VycmVudFZhbHVlID0gaW5wdXRbal07CiAgICAgICAgICBpZiAoY3VycmVudFZhbHVlID49IG4gJiYgY3VycmVudFZhbHVlIDwgbSkgewogICAgICAgICAgICBtID0gY3VycmVudFZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAKICAgICAgICAvLyBJbmNyZWFzZSBgZGVsdGFgIGVub3VnaCB0byBhZHZhbmNlIHRoZSBkZWNvZGVyJ3MgPG4saT4gc3RhdGUgdG8gPG0sMD4sCiAgICAgICAgLy8gYnV0IGd1YXJkIGFnYWluc3Qgb3ZlcmZsb3cKICAgICAgICBoYW5kbGVkQ1BDb3VudFBsdXNPbmUgPSBoYW5kbGVkQ1BDb3VudCArIDE7CiAgICAgICAgaWYgKG0gLSBuID4gZmxvb3IoKG1heEludCAtIGRlbHRhKSAvIGhhbmRsZWRDUENvdW50UGx1c09uZSkpIHsKICAgICAgICAgIGVycm9yKCdvdmVyZmxvdycpOwogICAgICAgIH0KICAKICAgICAgICBkZWx0YSArPSAobSAtIG4pICogaGFuZGxlZENQQ291bnRQbHVzT25lOwogICAgICAgIG4gPSBtOwogIAogICAgICAgIGZvciAoaiA9IDA7IGogPCBpbnB1dExlbmd0aDsgKytqKSB7CiAgICAgICAgICBjdXJyZW50VmFsdWUgPSBpbnB1dFtqXTsKICAKICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgPCBuICYmICsrZGVsdGEgPiBtYXhJbnQpIHsKICAgICAgICAgICAgZXJyb3IoJ292ZXJmbG93Jyk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBpZiAoY3VycmVudFZhbHVlID09IG4pIHsKICAgICAgICAgICAgLy8gUmVwcmVzZW50IGRlbHRhIGFzIGEgZ2VuZXJhbGl6ZWQgdmFyaWFibGUtbGVuZ3RoIGludGVnZXIKICAgICAgICAgICAgZm9yIChxID0gZGVsdGEsIGsgPSBiYXNlOyAvKiBubyBjb25kaXRpb24gKi87IGsgKz0gYmFzZSkgewogICAgICAgICAgICAgIHQgPSBrIDw9IGJpYXMgPyB0TWluIDogKGsgPj0gYmlhcyArIHRNYXggPyB0TWF4IDogayAtIGJpYXMpOwogICAgICAgICAgICAgIGlmIChxIDwgdCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHFNaW51c1QgPSBxIC0gdDsKICAgICAgICAgICAgICBiYXNlTWludXNUID0gYmFzZSAtIHQ7CiAgICAgICAgICAgICAgb3V0cHV0LnB1c2goCiAgICAgICAgICAgICAgICBzdHJpbmdGcm9tQ2hhckNvZGUoZGlnaXRUb0Jhc2ljKHQgKyBxTWludXNUICUgYmFzZU1pbnVzVCwgMCkpCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBxID0gZmxvb3IocU1pbnVzVCAvIGJhc2VNaW51c1QpOwogICAgICAgICAgICB9CiAgCiAgICAgICAgICAgIG91dHB1dC5wdXNoKHN0cmluZ0Zyb21DaGFyQ29kZShkaWdpdFRvQmFzaWMocSwgMCkpKTsKICAgICAgICAgICAgYmlhcyA9IGFkYXB0KGRlbHRhLCBoYW5kbGVkQ1BDb3VudFBsdXNPbmUsIGhhbmRsZWRDUENvdW50ID09IGJhc2ljTGVuZ3RoKTsKICAgICAgICAgICAgZGVsdGEgPSAwOwogICAgICAgICAgICArK2hhbmRsZWRDUENvdW50OwogICAgICAgICAgfQogICAgICAgIH0KICAKICAgICAgICArK2RlbHRhOwogICAgICAgICsrbjsKICAKICAgICAgfQogICAgICByZXR1cm4gb3V0cHV0LmpvaW4oJycpOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhIFB1bnljb2RlIHN0cmluZyByZXByZXNlbnRpbmcgYSBkb21haW4gbmFtZSBvciBhbiBlbWFpbCBhZGRyZXNzCiAgICAgKiB0byBVbmljb2RlLiBPbmx5IHRoZSBQdW55Y29kZWQgcGFydHMgb2YgdGhlIGlucHV0IHdpbGwgYmUgY29udmVydGVkLCBpLmUuCiAgICAgKiBpdCBkb2Vzbid0IG1hdHRlciBpZiB5b3UgY2FsbCBpdCBvbiBhIHN0cmluZyB0aGF0IGhhcyBhbHJlYWR5IGJlZW4KICAgICAqIGNvbnZlcnRlZCB0byBVbmljb2RlLgogICAgICogQG1lbWJlck9mIHB1bnljb2RlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gaW5wdXQgVGhlIFB1bnljb2RlZCBkb21haW4gbmFtZSBvciBlbWFpbCBhZGRyZXNzIHRvCiAgICAgKiBjb252ZXJ0IHRvIFVuaWNvZGUuCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBUaGUgVW5pY29kZSByZXByZXNlbnRhdGlvbiBvZiB0aGUgZ2l2ZW4gUHVueWNvZGUKICAgICAqIHN0cmluZy4KICAgICAqLwogICAgZnVuY3Rpb24gdG9Vbmljb2RlKGlucHV0KSB7CiAgICAgIHJldHVybiBtYXBEb21haW4oaW5wdXQsIGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgIHJldHVybiByZWdleFB1bnljb2RlLnRlc3Qoc3RyaW5nKQogICAgICAgICAgPyBkZWNvZGUoc3RyaW5nLnNsaWNlKDQpLnRvTG93ZXJDYXNlKCkpCiAgICAgICAgICA6IHN0cmluZzsKICAgICAgfSk7CiAgICB9CiAgCiAgICAvKioKICAgICAqIENvbnZlcnRzIGEgVW5pY29kZSBzdHJpbmcgcmVwcmVzZW50aW5nIGEgZG9tYWluIG5hbWUgb3IgYW4gZW1haWwgYWRkcmVzcyB0bwogICAgICogUHVueWNvZGUuIE9ubHkgdGhlIG5vbi1BU0NJSSBwYXJ0cyBvZiB0aGUgZG9tYWluIG5hbWUgd2lsbCBiZSBjb252ZXJ0ZWQsCiAgICAgKiBpLmUuIGl0IGRvZXNuJ3QgbWF0dGVyIGlmIHlvdSBjYWxsIGl0IHdpdGggYSBkb21haW4gdGhhdCdzIGFscmVhZHkgaW4KICAgICAqIEFTQ0lJLgogICAgICogQG1lbWJlck9mIHB1bnljb2RlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gaW5wdXQgVGhlIGRvbWFpbiBuYW1lIG9yIGVtYWlsIGFkZHJlc3MgdG8gY29udmVydCwgYXMgYQogICAgICogVW5pY29kZSBzdHJpbmcuCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBUaGUgUHVueWNvZGUgcmVwcmVzZW50YXRpb24gb2YgdGhlIGdpdmVuIGRvbWFpbiBuYW1lIG9yCiAgICAgKiBlbWFpbCBhZGRyZXNzLgogICAgICovCiAgICBmdW5jdGlvbiB0b0FTQ0lJKGlucHV0KSB7CiAgICAgIHJldHVybiBtYXBEb21haW4oaW5wdXQsIGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgIHJldHVybiByZWdleE5vbkFTQ0lJLnRlc3Qoc3RyaW5nKQogICAgICAgICAgPyAneG4tLScgKyBlbmNvZGUoc3RyaW5nKQogICAgICAgICAgOiBzdHJpbmc7CiAgICAgIH0pOwogICAgfQogIAogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgCiAgICAvKiogRGVmaW5lIHRoZSBwdWJsaWMgQVBJICovCiAgICBwdW55Y29kZSA9IHsKICAgICAgLyoqCiAgICAgICAqIEEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgY3VycmVudCBQdW55Y29kZS5qcyB2ZXJzaW9uIG51bWJlci4KICAgICAgICogQG1lbWJlck9mIHB1bnljb2RlCiAgICAgICAqIEB0eXBlIFN0cmluZwogICAgICAgKi8KICAgICAgJ3ZlcnNpb24nOiAnMS4zLjInLAogICAgICAvKioKICAgICAgICogQW4gb2JqZWN0IG9mIG1ldGhvZHMgdG8gY29udmVydCBmcm9tIEphdmFTY3JpcHQncyBpbnRlcm5hbCBjaGFyYWN0ZXIKICAgICAgICogcmVwcmVzZW50YXRpb24gKFVDUy0yKSB0byBVbmljb2RlIGNvZGUgcG9pbnRzLCBhbmQgYmFjay4KICAgICAgICogQHNlZSA8aHR0cHM6Ly9tYXRoaWFzYnluZW5zLmJlL25vdGVzL2phdmFzY3JpcHQtZW5jb2Rpbmc+CiAgICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZQogICAgICAgKiBAdHlwZSBPYmplY3QKICAgICAgICovCiAgICAgICd1Y3MyJzogewogICAgICAgICdkZWNvZGUnOiB1Y3MyZGVjb2RlLAogICAgICAgICdlbmNvZGUnOiB1Y3MyZW5jb2RlCiAgICAgIH0sCiAgICAgICdkZWNvZGUnOiBkZWNvZGUsCiAgICAgICdlbmNvZGUnOiBlbmNvZGUsCiAgICAgICd0b0FTQ0lJJzogdG9BU0NJSSwKICAgICAgJ3RvVW5pY29kZSc6IHRvVW5pY29kZQogICAgfTsKICAKICAgIC8qKiBFeHBvc2UgYHB1bnljb2RlYCAqLwogICAgLy8gU29tZSBBTUQgYnVpbGQgb3B0aW1pemVycywgbGlrZSByLmpzLCBjaGVjayBmb3Igc3BlY2lmaWMgY29uZGl0aW9uIHBhdHRlcm5zCiAgICAvLyBsaWtlIHRoZSBmb2xsb3dpbmc6CiAgICBpZiAoCiAgICAgIHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJgogICAgICB0eXBlb2YgZGVmaW5lLmFtZCA9PSAnb2JqZWN0JyAmJgogICAgICBkZWZpbmUuYW1kCiAgICApIHsKICAgICAgZGVmaW5lKCdwdW55Y29kZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBwdW55Y29kZTsKICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKGZyZWVFeHBvcnRzICYmIGZyZWVNb2R1bGUpIHsKICAgICAgaWYgKG1vZHVsZS5leHBvcnRzID09IGZyZWVFeHBvcnRzKSB7IC8vIGluIE5vZGUuanMgb3IgUmluZ29KUyB2MC44LjArCiAgICAgICAgZnJlZU1vZHVsZS5leHBvcnRzID0gcHVueWNvZGU7CiAgICAgIH0gZWxzZSB7IC8vIGluIE5hcndoYWwgb3IgUmluZ29KUyB2MC43LjAtCiAgICAgICAgZm9yIChrZXkgaW4gcHVueWNvZGUpIHsKICAgICAgICAgIHB1bnljb2RlLmhhc093blByb3BlcnR5KGtleSkgJiYgKGZyZWVFeHBvcnRzW2tleV0gPSBwdW55Y29kZVtrZXldKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7IC8vIGluIFJoaW5vIG9yIGEgd2ViIGJyb3dzZXIKICAgICAgcm9vdC5wdW55Y29kZSA9IHB1bnljb2RlOwogICAgfQogIAogIH0odGhpcykpOwogIAogIH0pLmNhbGwodGhpcyx0eXBlb2YgZ2xvYmFsICE9PSAidW5kZWZpbmVkIiA/IGdsb2JhbCA6IHR5cGVvZiBzZWxmICE9PSAidW5kZWZpbmVkIiA/IHNlbGYgOiB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiA/IHdpbmRvdyA6IHt9KQogIH0se31dLDg3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KICAvLwogIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCiAgLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQogIC8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKICAvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCiAgLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAogIC8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQogIC8vIGZvbGxvd2luZyBjb25kaXRpb25zOgogIC8vCiAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKICAvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAvLwogIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAgLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogIC8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KICAvLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKICAvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKICAvLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCiAgLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICAKICAndXNlIHN0cmljdCc7CiAgCiAgLy8gSWYgb2JqLmhhc093blByb3BlcnR5IGhhcyBiZWVuIG92ZXJyaWRkZW4sIHRoZW4gY2FsbGluZwogIC8vIG9iai5oYXNPd25Qcm9wZXJ0eShwcm9wKSB3aWxsIGJyZWFrLgogIC8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2pveWVudC9ub2RlL2lzc3Vlcy8xNzA3CiAgZnVuY3Rpb24gaGFzT3duUHJvcGVydHkob2JqLCBwcm9wKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCk7CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ocXMsIHNlcCwgZXEsIG9wdGlvbnMpIHsKICAgIHNlcCA9IHNlcCB8fCAnJic7CiAgICBlcSA9IGVxIHx8ICc9JzsKICAgIHZhciBvYmogPSB7fTsKICAKICAgIGlmICh0eXBlb2YgcXMgIT09ICdzdHJpbmcnIHx8IHFzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gb2JqOwogICAgfQogIAogICAgdmFyIHJlZ2V4cCA9IC9cKy9nOwogICAgcXMgPSBxcy5zcGxpdChzZXApOwogIAogICAgdmFyIG1heEtleXMgPSAxMDAwOwogICAgaWYgKG9wdGlvbnMgJiYgdHlwZW9mIG9wdGlvbnMubWF4S2V5cyA9PT0gJ251bWJlcicpIHsKICAgICAgbWF4S2V5cyA9IG9wdGlvbnMubWF4S2V5czsKICAgIH0KICAKICAgIHZhciBsZW4gPSBxcy5sZW5ndGg7CiAgICAvLyBtYXhLZXlzIDw9IDAgbWVhbnMgdGhhdCB3ZSBzaG91bGQgbm90IGxpbWl0IGtleXMgY291bnQKICAgIGlmIChtYXhLZXlzID4gMCAmJiBsZW4gPiBtYXhLZXlzKSB7CiAgICAgIGxlbiA9IG1heEtleXM7CiAgICB9CiAgCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIHZhciB4ID0gcXNbaV0ucmVwbGFjZShyZWdleHAsICclMjAnKSwKICAgICAgICAgIGlkeCA9IHguaW5kZXhPZihlcSksCiAgICAgICAgICBrc3RyLCB2c3RyLCBrLCB2OwogIAogICAgICBpZiAoaWR4ID49IDApIHsKICAgICAgICBrc3RyID0geC5zdWJzdHIoMCwgaWR4KTsKICAgICAgICB2c3RyID0geC5zdWJzdHIoaWR4ICsgMSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAga3N0ciA9IHg7CiAgICAgICAgdnN0ciA9ICcnOwogICAgICB9CiAgCiAgICAgIGsgPSBkZWNvZGVVUklDb21wb25lbnQoa3N0cik7CiAgICAgIHYgPSBkZWNvZGVVUklDb21wb25lbnQodnN0cik7CiAgCiAgICAgIGlmICghaGFzT3duUHJvcGVydHkob2JqLCBrKSkgewogICAgICAgIG9ialtrXSA9IHY7CiAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShvYmpba10pKSB7CiAgICAgICAgb2JqW2tdLnB1c2godik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb2JqW2tdID0gW29ialtrXSwgdl07CiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiBvYmo7CiAgfTsKICAKICB2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24gKHhzKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHhzKSA9PT0gJ1tvYmplY3QgQXJyYXldJzsKICB9OwogIAogIH0se31dLDg4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KICAvLwogIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCiAgLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQogIC8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKICAvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCiAgLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAogIC8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQogIC8vIGZvbGxvd2luZyBjb25kaXRpb25zOgogIC8vCiAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKICAvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAvLwogIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAgLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogIC8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KICAvLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKICAvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKICAvLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCiAgLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICAKICAndXNlIHN0cmljdCc7CiAgCiAgdmFyIHN0cmluZ2lmeVByaW1pdGl2ZSA9IGZ1bmN0aW9uKHYpIHsKICAgIHN3aXRjaCAodHlwZW9mIHYpIHsKICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICByZXR1cm4gdjsKICAKICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgICAgcmV0dXJuIHYgPyAndHJ1ZScgOiAnZmFsc2UnOwogIAogICAgICBjYXNlICdudW1iZXInOgogICAgICAgIHJldHVybiBpc0Zpbml0ZSh2KSA/IHYgOiAnJzsKICAKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gJyc7CiAgICB9CiAgfTsKICAKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKG9iaiwgc2VwLCBlcSwgbmFtZSkgewogICAgc2VwID0gc2VwIHx8ICcmJzsKICAgIGVxID0gZXEgfHwgJz0nOwogICAgaWYgKG9iaiA9PT0gbnVsbCkgewogICAgICBvYmogPSB1bmRlZmluZWQ7CiAgICB9CiAgCiAgICBpZiAodHlwZW9mIG9iaiA9PT0gJ29iamVjdCcpIHsKICAgICAgcmV0dXJuIG1hcChvYmplY3RLZXlzKG9iaiksIGZ1bmN0aW9uKGspIHsKICAgICAgICB2YXIga3MgPSBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKGspKSArIGVxOwogICAgICAgIGlmIChpc0FycmF5KG9ialtrXSkpIHsKICAgICAgICAgIHJldHVybiBtYXAob2JqW2tdLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgIHJldHVybiBrcyArIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUodikpOwogICAgICAgICAgfSkuam9pbihzZXApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4ga3MgKyBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG9ialtrXSkpOwogICAgICAgIH0KICAgICAgfSkuam9pbihzZXApOwogIAogICAgfQogIAogICAgaWYgKCFuYW1lKSByZXR1cm4gJyc7CiAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShuYW1lKSkgKyBlcSArCiAgICAgICAgICAgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShvYmopKTsKICB9OwogIAogIHZhciBpc0FycmF5ID0gQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiAoeHMpIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoeHMpID09PSAnW29iamVjdCBBcnJheV0nOwogIH07CiAgCiAgZnVuY3Rpb24gbWFwICh4cywgZikgewogICAgaWYgKHhzLm1hcCkgcmV0dXJuIHhzLm1hcChmKTsKICAgIHZhciByZXMgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgeHMubGVuZ3RoOyBpKyspIHsKICAgICAgcmVzLnB1c2goZih4c1tpXSwgaSkpOwogICAgfQogICAgcmV0dXJuIHJlczsKICB9CiAgCiAgdmFyIG9iamVjdEtleXMgPSBPYmplY3Qua2V5cyB8fCBmdW5jdGlvbiAob2JqKSB7CiAgICB2YXIgcmVzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSByZXMucHVzaChrZXkpOwogICAgfQogICAgcmV0dXJuIHJlczsKICB9OwogIAogIH0se31dLDg5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAndXNlIHN0cmljdCc7CiAgCiAgZXhwb3J0cy5kZWNvZGUgPSBleHBvcnRzLnBhcnNlID0gcmVxdWlyZSgnLi9kZWNvZGUnKTsKICBleHBvcnRzLmVuY29kZSA9IGV4cG9ydHMuc3RyaW5naWZ5ID0gcmVxdWlyZSgnLi9lbmNvZGUnKTsKICAKICB9LHsiLi9kZWNvZGUiOjg3LCIuL2VuY29kZSI6ODh9XSw5MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCiAgLy8KICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQogIC8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKICAvLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCiAgLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAogIC8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKICAvLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKICAvLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAvLwogIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCiAgLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgLy8KICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwogIC8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICAvLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCiAgLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCiAgLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCiAgLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQogIC8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiAgCiAgJ3VzZSBzdHJpY3QnOwogIAogIC8vIElmIG9iai5oYXNPd25Qcm9wZXJ0eSBoYXMgYmVlbiBvdmVycmlkZGVuLCB0aGVuIGNhbGxpbmcKICAvLyBvYmouaGFzT3duUHJvcGVydHkocHJvcCkgd2lsbCBicmVhay4KICAvLyBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9qb3llbnQvbm9kZS9pc3N1ZXMvMTcwNwogIGZ1bmN0aW9uIGhhc093blByb3BlcnR5KG9iaiwgcHJvcCkgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApOwogIH0KICAKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKHFzLCBzZXAsIGVxLCBvcHRpb25zKSB7CiAgICBzZXAgPSBzZXAgfHwgJyYnOwogICAgZXEgPSBlcSB8fCAnPSc7CiAgICB2YXIgb2JqID0ge307CiAgCiAgICBpZiAodHlwZW9mIHFzICE9PSAnc3RyaW5nJyB8fCBxcy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIG9iajsKICAgIH0KICAKICAgIHZhciByZWdleHAgPSAvXCsvZzsKICAgIHFzID0gcXMuc3BsaXQoc2VwKTsKICAKICAgIHZhciBtYXhLZXlzID0gMTAwMDsKICAgIGlmIChvcHRpb25zICYmIHR5cGVvZiBvcHRpb25zLm1heEtleXMgPT09ICdudW1iZXInKSB7CiAgICAgIG1heEtleXMgPSBvcHRpb25zLm1heEtleXM7CiAgICB9CiAgCiAgICB2YXIgbGVuID0gcXMubGVuZ3RoOwogICAgLy8gbWF4S2V5cyA8PSAwIG1lYW5zIHRoYXQgd2Ugc2hvdWxkIG5vdCBsaW1pdCBrZXlzIGNvdW50CiAgICBpZiAobWF4S2V5cyA+IDAgJiYgbGVuID4gbWF4S2V5cykgewogICAgICBsZW4gPSBtYXhLZXlzOwogICAgfQogIAogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICB2YXIgeCA9IHFzW2ldLnJlcGxhY2UocmVnZXhwLCAnJTIwJyksCiAgICAgICAgICBpZHggPSB4LmluZGV4T2YoZXEpLAogICAgICAgICAga3N0ciwgdnN0ciwgaywgdjsKICAKICAgICAgaWYgKGlkeCA+PSAwKSB7CiAgICAgICAga3N0ciA9IHguc3Vic3RyKDAsIGlkeCk7CiAgICAgICAgdnN0ciA9IHguc3Vic3RyKGlkeCArIDEpOwogICAgICB9IGVsc2UgewogICAgICAgIGtzdHIgPSB4OwogICAgICAgIHZzdHIgPSAnJzsKICAgICAgfQogIAogICAgICBrID0gZGVjb2RlVVJJQ29tcG9uZW50KGtzdHIpOwogICAgICB2ID0gZGVjb2RlVVJJQ29tcG9uZW50KHZzdHIpOwogIAogICAgICBpZiAoIWhhc093blByb3BlcnR5KG9iaiwgaykpIHsKICAgICAgICBvYmpba10gPSB2OwogICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkob2JqW2tdKSkgewogICAgICAgIG9ialtrXS5wdXNoKHYpOwogICAgICB9IGVsc2UgewogICAgICAgIG9ialtrXSA9IFtvYmpba10sIHZdOwogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gb2JqOwogIH07CiAgCiAgfSx7fV0sOTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgogIC8vCiAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKICAvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiAgLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwogIC8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKICAvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CiAgLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCiAgLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgLy8KICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAogIC8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogIC8vCiAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICAvLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiAgLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgogIC8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAogIC8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgogIC8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKICAvLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogIAogICd1c2Ugc3RyaWN0JzsKICAKICB2YXIgc3RyaW5naWZ5UHJpbWl0aXZlID0gZnVuY3Rpb24odikgewogICAgc3dpdGNoICh0eXBlb2YgdikgewogICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgIHJldHVybiB2OwogIAogICAgICBjYXNlICdib29sZWFuJzoKICAgICAgICByZXR1cm4gdiA/ICd0cnVlJyA6ICdmYWxzZSc7CiAgCiAgICAgIGNhc2UgJ251bWJlcic6CiAgICAgICAgcmV0dXJuIGlzRmluaXRlKHYpID8gdiA6ICcnOwogIAogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiAnJzsKICAgIH0KICB9OwogIAogIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ob2JqLCBzZXAsIGVxLCBuYW1lKSB7CiAgICBzZXAgPSBzZXAgfHwgJyYnOwogICAgZXEgPSBlcSB8fCAnPSc7CiAgICBpZiAob2JqID09PSBudWxsKSB7CiAgICAgIG9iaiA9IHVuZGVmaW5lZDsKICAgIH0KICAKICAgIGlmICh0eXBlb2Ygb2JqID09PSAnb2JqZWN0JykgewogICAgICByZXR1cm4gT2JqZWN0LmtleXMob2JqKS5tYXAoZnVuY3Rpb24oaykgewogICAgICAgIHZhciBrcyA9IGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUoaykpICsgZXE7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkob2JqW2tdKSkgewogICAgICAgICAgcmV0dXJuIG9ialtrXS5tYXAoZnVuY3Rpb24odikgewogICAgICAgICAgICByZXR1cm4ga3MgKyBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKHYpKTsKICAgICAgICAgIH0pLmpvaW4oc2VwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGtzICsgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShvYmpba10pKTsKICAgICAgICB9CiAgICAgIH0pLmpvaW4oc2VwKTsKICAKICAgIH0KICAKICAgIGlmICghbmFtZSkgcmV0dXJuICcnOwogICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUobmFtZSkpICsgZXEgKwogICAgICAgICAgIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUob2JqKSk7CiAgfTsKICAKICB9LHt9XSw5MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgYXJndW1lbnRzWzRdWzg5XVswXS5hcHBseShleHBvcnRzLGFyZ3VtZW50cykKICB9LHsiLi9kZWNvZGUiOjkwLCIuL2VuY29kZSI6OTEsImR1cCI6ODl9XSw5MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChzZXRJbW1lZGlhdGUsY2xlYXJJbW1lZGlhdGUpewogIHZhciBuZXh0VGljayA9IHJlcXVpcmUoJ3Byb2Nlc3MvYnJvd3Nlci5qcycpLm5leHRUaWNrOwogIHZhciBhcHBseSA9IEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseTsKICB2YXIgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CiAgdmFyIGltbWVkaWF0ZUlkcyA9IHt9OwogIHZhciBuZXh0SW1tZWRpYXRlSWQgPSAwOwogIAogIC8vIERPTSBBUElzLCBmb3IgY29tcGxldGVuZXNzCiAgCiAgZXhwb3J0cy5zZXRUaW1lb3V0ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbmV3IFRpbWVvdXQoYXBwbHkuY2FsbChzZXRUaW1lb3V0LCB3aW5kb3csIGFyZ3VtZW50cyksIGNsZWFyVGltZW91dCk7CiAgfTsKICBleHBvcnRzLnNldEludGVydmFsID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbmV3IFRpbWVvdXQoYXBwbHkuY2FsbChzZXRJbnRlcnZhbCwgd2luZG93LCBhcmd1bWVudHMpLCBjbGVhckludGVydmFsKTsKICB9OwogIGV4cG9ydHMuY2xlYXJUaW1lb3V0ID0KICBleHBvcnRzLmNsZWFySW50ZXJ2YWwgPSBmdW5jdGlvbih0aW1lb3V0KSB7IHRpbWVvdXQuY2xvc2UoKTsgfTsKICAKICBmdW5jdGlvbiBUaW1lb3V0KGlkLCBjbGVhckZuKSB7CiAgICB0aGlzLl9pZCA9IGlkOwogICAgdGhpcy5fY2xlYXJGbiA9IGNsZWFyRm47CiAgfQogIFRpbWVvdXQucHJvdG90eXBlLnVucmVmID0gVGltZW91dC5wcm90b3R5cGUucmVmID0gZnVuY3Rpb24oKSB7fTsKICBUaW1lb3V0LnByb3RvdHlwZS5jbG9zZSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fY2xlYXJGbi5jYWxsKHdpbmRvdywgdGhpcy5faWQpOwogIH07CiAgCiAgLy8gRG9lcyBub3Qgc3RhcnQgdGhlIHRpbWUsIGp1c3Qgc2V0cyB1cCB0aGUgbWVtYmVycyBuZWVkZWQuCiAgZXhwb3J0cy5lbnJvbGwgPSBmdW5jdGlvbihpdGVtLCBtc2VjcykgewogICAgY2xlYXJUaW1lb3V0KGl0ZW0uX2lkbGVUaW1lb3V0SWQpOwogICAgaXRlbS5faWRsZVRpbWVvdXQgPSBtc2VjczsKICB9OwogIAogIGV4cG9ydHMudW5lbnJvbGwgPSBmdW5jdGlvbihpdGVtKSB7CiAgICBjbGVhclRpbWVvdXQoaXRlbS5faWRsZVRpbWVvdXRJZCk7CiAgICBpdGVtLl9pZGxlVGltZW91dCA9IC0xOwogIH07CiAgCiAgZXhwb3J0cy5fdW5yZWZBY3RpdmUgPSBleHBvcnRzLmFjdGl2ZSA9IGZ1bmN0aW9uKGl0ZW0pIHsKICAgIGNsZWFyVGltZW91dChpdGVtLl9pZGxlVGltZW91dElkKTsKICAKICAgIHZhciBtc2VjcyA9IGl0ZW0uX2lkbGVUaW1lb3V0OwogICAgaWYgKG1zZWNzID49IDApIHsKICAgICAgaXRlbS5faWRsZVRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gb25UaW1lb3V0KCkgewogICAgICAgIGlmIChpdGVtLl9vblRpbWVvdXQpCiAgICAgICAgICBpdGVtLl9vblRpbWVvdXQoKTsKICAgICAgfSwgbXNlY3MpOwogICAgfQogIH07CiAgCiAgLy8gVGhhdCdzIG5vdCBob3cgbm9kZS5qcyBpbXBsZW1lbnRzIGl0IGJ1dCB0aGUgZXhwb3NlZCBhcGkgaXMgdGhlIHNhbWUuCiAgZXhwb3J0cy5zZXRJbW1lZGlhdGUgPSB0eXBlb2Ygc2V0SW1tZWRpYXRlID09PSAiZnVuY3Rpb24iID8gc2V0SW1tZWRpYXRlIDogZnVuY3Rpb24oZm4pIHsKICAgIHZhciBpZCA9IG5leHRJbW1lZGlhdGVJZCsrOwogICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMubGVuZ3RoIDwgMiA/IGZhbHNlIDogc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogIAogICAgaW1tZWRpYXRlSWRzW2lkXSA9IHRydWU7CiAgCiAgICBuZXh0VGljayhmdW5jdGlvbiBvbk5leHRUaWNrKCkgewogICAgICBpZiAoaW1tZWRpYXRlSWRzW2lkXSkgewogICAgICAgIC8vIGZuLmNhbGwoKSBpcyBmYXN0ZXIgc28gd2Ugb3B0aW1pemUgZm9yIHRoZSBjb21tb24gdXNlLWNhc2UKICAgICAgICAvLyBAc2VlIGh0dHA6Ly9qc3BlcmYuY29tL2NhbGwtYXBwbHktc2VndQogICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICBmbi5hcHBseShudWxsLCBhcmdzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm4uY2FsbChudWxsKTsKICAgICAgICB9CiAgICAgICAgLy8gUHJldmVudCBpZHMgZnJvbSBsZWFraW5nCiAgICAgICAgZXhwb3J0cy5jbGVhckltbWVkaWF0ZShpZCk7CiAgICAgIH0KICAgIH0pOwogIAogICAgcmV0dXJuIGlkOwogIH07CiAgCiAgZXhwb3J0cy5jbGVhckltbWVkaWF0ZSA9IHR5cGVvZiBjbGVhckltbWVkaWF0ZSA9PT0gImZ1bmN0aW9uIiA/IGNsZWFySW1tZWRpYXRlIDogZnVuY3Rpb24oaWQpIHsKICAgIGRlbGV0ZSBpbW1lZGlhdGVJZHNbaWRdOwogIH07CiAgfSkuY2FsbCh0aGlzLHJlcXVpcmUoInRpbWVycyIpLnNldEltbWVkaWF0ZSxyZXF1aXJlKCJ0aW1lcnMiKS5jbGVhckltbWVkaWF0ZSkKICB9LHsicHJvY2Vzcy9icm93c2VyLmpzIjo4NSwidGltZXJzIjo5M31dLDk0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KICAvLwogIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCiAgLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQogIC8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKICAvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCiAgLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAogIC8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQogIC8vIGZvbGxvd2luZyBjb25kaXRpb25zOgogIC8vCiAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKICAvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAvLwogIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAgLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogIC8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KICAvLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKICAvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKICAvLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCiAgLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICAKICB2YXIgcHVueWNvZGUgPSByZXF1aXJlKCdwdW55Y29kZScpOwogIAogIGV4cG9ydHMucGFyc2UgPSB1cmxQYXJzZTsKICBleHBvcnRzLnJlc29sdmUgPSB1cmxSZXNvbHZlOwogIGV4cG9ydHMucmVzb2x2ZU9iamVjdCA9IHVybFJlc29sdmVPYmplY3Q7CiAgZXhwb3J0cy5mb3JtYXQgPSB1cmxGb3JtYXQ7CiAgCiAgZXhwb3J0cy5VcmwgPSBVcmw7CiAgCiAgZnVuY3Rpb24gVXJsKCkgewogICAgdGhpcy5wcm90b2NvbCA9IG51bGw7CiAgICB0aGlzLnNsYXNoZXMgPSBudWxsOwogICAgdGhpcy5hdXRoID0gbnVsbDsKICAgIHRoaXMuaG9zdCA9IG51bGw7CiAgICB0aGlzLnBvcnQgPSBudWxsOwogICAgdGhpcy5ob3N0bmFtZSA9IG51bGw7CiAgICB0aGlzLmhhc2ggPSBudWxsOwogICAgdGhpcy5zZWFyY2ggPSBudWxsOwogICAgdGhpcy5xdWVyeSA9IG51bGw7CiAgICB0aGlzLnBhdGhuYW1lID0gbnVsbDsKICAgIHRoaXMucGF0aCA9IG51bGw7CiAgICB0aGlzLmhyZWYgPSBudWxsOwogIH0KICAKICAvLyBSZWZlcmVuY2U6IFJGQyAzOTg2LCBSRkMgMTgwOCwgUkZDIDIzOTYKICAKICAvLyBkZWZpbmUgdGhlc2UgaGVyZSBzbyBhdCBsZWFzdCB0aGV5IG9ubHkgaGF2ZSB0byBiZQogIC8vIGNvbXBpbGVkIG9uY2Ugb24gdGhlIGZpcnN0IG1vZHVsZSBsb2FkLgogIHZhciBwcm90b2NvbFBhdHRlcm4gPSAvXihbYS16MC05ListXSs6KS9pLAogICAgICBwb3J0UGF0dGVybiA9IC86WzAtOV0qJC8sCiAgCiAgICAgIC8vIFJGQyAyMzk2OiBjaGFyYWN0ZXJzIHJlc2VydmVkIGZvciBkZWxpbWl0aW5nIFVSTHMuCiAgICAgIC8vIFdlIGFjdHVhbGx5IGp1c3QgYXV0by1lc2NhcGUgdGhlc2UuCiAgICAgIGRlbGltcyA9IFsnPCcsICc+JywgJyInLCAnYCcsICcgJywgJ1xyJywgJ1xuJywgJ1x0J10sCiAgCiAgICAgIC8vIFJGQyAyMzk2OiBjaGFyYWN0ZXJzIG5vdCBhbGxvd2VkIGZvciB2YXJpb3VzIHJlYXNvbnMuCiAgICAgIHVud2lzZSA9IFsneycsICd9JywgJ3wnLCAnXFwnLCAnXicsICdgJ10uY29uY2F0KGRlbGltcyksCiAgCiAgICAgIC8vIEFsbG93ZWQgYnkgUkZDcywgYnV0IGNhdXNlIG9mIFhTUyBhdHRhY2tzLiAgQWx3YXlzIGVzY2FwZSB0aGVzZS4KICAgICAgYXV0b0VzY2FwZSA9IFsnXCcnXS5jb25jYXQodW53aXNlKSwKICAgICAgLy8gQ2hhcmFjdGVycyB0aGF0IGFyZSBuZXZlciBldmVyIGFsbG93ZWQgaW4gYSBob3N0bmFtZS4KICAgICAgLy8gTm90ZSB0aGF0IGFueSBpbnZhbGlkIGNoYXJzIGFyZSBhbHNvIGhhbmRsZWQsIGJ1dCB0aGVzZQogICAgICAvLyBhcmUgdGhlIG9uZXMgdGhhdCBhcmUgKmV4cGVjdGVkKiB0byBiZSBzZWVuLCBzbyB3ZSBmYXN0LXBhdGgKICAgICAgLy8gdGhlbS4KICAgICAgbm9uSG9zdENoYXJzID0gWyclJywgJy8nLCAnPycsICc7JywgJyMnXS5jb25jYXQoYXV0b0VzY2FwZSksCiAgICAgIGhvc3RFbmRpbmdDaGFycyA9IFsnLycsICc/JywgJyMnXSwKICAgICAgaG9zdG5hbWVNYXhMZW4gPSAyNTUsCiAgICAgIGhvc3RuYW1lUGFydFBhdHRlcm4gPSAvXlthLXowLTlBLVpfLV17MCw2M30kLywKICAgICAgaG9zdG5hbWVQYXJ0U3RhcnQgPSAvXihbYS16MC05QS1aXy1dezAsNjN9KSguKikkLywKICAgICAgLy8gcHJvdG9jb2xzIHRoYXQgY2FuIGFsbG93ICJ1bnNhZmUiIGFuZCAidW53aXNlIiBjaGFycy4KICAgICAgdW5zYWZlUHJvdG9jb2wgPSB7CiAgICAgICAgJ2phdmFzY3JpcHQnOiB0cnVlLAogICAgICAgICdqYXZhc2NyaXB0Oic6IHRydWUKICAgICAgfSwKICAgICAgLy8gcHJvdG9jb2xzIHRoYXQgbmV2ZXIgaGF2ZSBhIGhvc3RuYW1lLgogICAgICBob3N0bGVzc1Byb3RvY29sID0gewogICAgICAgICdqYXZhc2NyaXB0JzogdHJ1ZSwKICAgICAgICAnamF2YXNjcmlwdDonOiB0cnVlCiAgICAgIH0sCiAgICAgIC8vIHByb3RvY29scyB0aGF0IGFsd2F5cyBjb250YWluIGEgLy8gYml0LgogICAgICBzbGFzaGVkUHJvdG9jb2wgPSB7CiAgICAgICAgJ2h0dHAnOiB0cnVlLAogICAgICAgICdodHRwcyc6IHRydWUsCiAgICAgICAgJ2Z0cCc6IHRydWUsCiAgICAgICAgJ2dvcGhlcic6IHRydWUsCiAgICAgICAgJ2ZpbGUnOiB0cnVlLAogICAgICAgICdodHRwOic6IHRydWUsCiAgICAgICAgJ2h0dHBzOic6IHRydWUsCiAgICAgICAgJ2Z0cDonOiB0cnVlLAogICAgICAgICdnb3BoZXI6JzogdHJ1ZSwKICAgICAgICAnZmlsZTonOiB0cnVlCiAgICAgIH0sCiAgICAgIHF1ZXJ5c3RyaW5nID0gcmVxdWlyZSgncXVlcnlzdHJpbmcnKTsKICAKICBmdW5jdGlvbiB1cmxQYXJzZSh1cmwsIHBhcnNlUXVlcnlTdHJpbmcsIHNsYXNoZXNEZW5vdGVIb3N0KSB7CiAgICBpZiAodXJsICYmIGlzT2JqZWN0KHVybCkgJiYgdXJsIGluc3RhbmNlb2YgVXJsKSByZXR1cm4gdXJsOwogIAogICAgdmFyIHUgPSBuZXcgVXJsOwogICAgdS5wYXJzZSh1cmwsIHBhcnNlUXVlcnlTdHJpbmcsIHNsYXNoZXNEZW5vdGVIb3N0KTsKICAgIHJldHVybiB1OwogIH0KICAKICBVcmwucHJvdG90eXBlLnBhcnNlID0gZnVuY3Rpb24odXJsLCBwYXJzZVF1ZXJ5U3RyaW5nLCBzbGFzaGVzRGVub3RlSG9zdCkgewogICAgaWYgKCFpc1N0cmluZyh1cmwpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlBhcmFtZXRlciAndXJsJyBtdXN0IGJlIGEgc3RyaW5nLCBub3QgIiArIHR5cGVvZiB1cmwpOwogICAgfQogIAogICAgdmFyIHJlc3QgPSB1cmw7CiAgCiAgICAvLyB0cmltIGJlZm9yZSBwcm9jZWVkaW5nLgogICAgLy8gVGhpcyBpcyB0byBzdXBwb3J0IHBhcnNlIHN0dWZmIGxpa2UgIiAgaHR0cDovL2Zvby5jb20gIFxuIgogICAgcmVzdCA9IHJlc3QudHJpbSgpOwogIAogICAgdmFyIHByb3RvID0gcHJvdG9jb2xQYXR0ZXJuLmV4ZWMocmVzdCk7CiAgICBpZiAocHJvdG8pIHsKICAgICAgcHJvdG8gPSBwcm90b1swXTsKICAgICAgdmFyIGxvd2VyUHJvdG8gPSBwcm90by50b0xvd2VyQ2FzZSgpOwogICAgICB0aGlzLnByb3RvY29sID0gbG93ZXJQcm90bzsKICAgICAgcmVzdCA9IHJlc3Quc3Vic3RyKHByb3RvLmxlbmd0aCk7CiAgICB9CiAgCiAgICAvLyBmaWd1cmUgb3V0IGlmIGl0J3MgZ290IGEgaG9zdAogICAgLy8gdXNlckBzZXJ2ZXIgaXMgKmFsd2F5cyogaW50ZXJwcmV0ZWQgYXMgYSBob3N0bmFtZSwgYW5kIHVybAogICAgLy8gcmVzb2x1dGlvbiB3aWxsIHRyZWF0IC8vZm9vL2JhciBhcyBob3N0PWZvbyxwYXRoPWJhciBiZWNhdXNlIHRoYXQncwogICAgLy8gaG93IHRoZSBicm93c2VyIHJlc29sdmVzIHJlbGF0aXZlIFVSTHMuCiAgICBpZiAoc2xhc2hlc0Rlbm90ZUhvc3QgfHwgcHJvdG8gfHwgcmVzdC5tYXRjaCgvXlwvXC9bXkBcL10rQFteQFwvXSsvKSkgewogICAgICB2YXIgc2xhc2hlcyA9IHJlc3Quc3Vic3RyKDAsIDIpID09PSAnLy8nOwogICAgICBpZiAoc2xhc2hlcyAmJiAhKHByb3RvICYmIGhvc3RsZXNzUHJvdG9jb2xbcHJvdG9dKSkgewogICAgICAgIHJlc3QgPSByZXN0LnN1YnN0cigyKTsKICAgICAgICB0aGlzLnNsYXNoZXMgPSB0cnVlOwogICAgICB9CiAgICB9CiAgCiAgICBpZiAoIWhvc3RsZXNzUHJvdG9jb2xbcHJvdG9dICYmCiAgICAgICAgKHNsYXNoZXMgfHwgKHByb3RvICYmICFzbGFzaGVkUHJvdG9jb2xbcHJvdG9dKSkpIHsKICAKICAgICAgLy8gdGhlcmUncyBhIGhvc3RuYW1lLgogICAgICAvLyB0aGUgZmlyc3QgaW5zdGFuY2Ugb2YgLywgPywgOywgb3IgIyBlbmRzIHRoZSBob3N0LgogICAgICAvLwogICAgICAvLyBJZiB0aGVyZSBpcyBhbiBAIGluIHRoZSBob3N0bmFtZSwgdGhlbiBub24taG9zdCBjaGFycyAqYXJlKiBhbGxvd2VkCiAgICAgIC8vIHRvIHRoZSBsZWZ0IG9mIHRoZSBsYXN0IEAgc2lnbiwgdW5sZXNzIHNvbWUgaG9zdC1lbmRpbmcgY2hhcmFjdGVyCiAgICAgIC8vIGNvbWVzICpiZWZvcmUqIHRoZSBALXNpZ24uCiAgICAgIC8vIFVSTHMgYXJlIG9ibm94aW91cy4KICAgICAgLy8KICAgICAgLy8gZXg6CiAgICAgIC8vIGh0dHA6Ly9hQGJAYy8gPT4gdXNlcjphQGIgaG9zdDpjCiAgICAgIC8vIGh0dHA6Ly9hQGI/QGMgPT4gdXNlcjphIGhvc3Q6YyBwYXRoOi8/QGMKICAKICAgICAgLy8gdjAuMTIgVE9ETyhpc2FhY3MpOiBUaGlzIGlzIG5vdCBxdWl0ZSBob3cgQ2hyb21lIGRvZXMgdGhpbmdzLgogICAgICAvLyBSZXZpZXcgb3VyIHRlc3QgY2FzZSBhZ2FpbnN0IGJyb3dzZXJzIG1vcmUgY29tcHJlaGVuc2l2ZWx5LgogIAogICAgICAvLyBmaW5kIHRoZSBmaXJzdCBpbnN0YW5jZSBvZiBhbnkgaG9zdEVuZGluZ0NoYXJzCiAgICAgIHZhciBob3N0RW5kID0gLTE7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaG9zdEVuZGluZ0NoYXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGhlYyA9IHJlc3QuaW5kZXhPZihob3N0RW5kaW5nQ2hhcnNbaV0pOwogICAgICAgIGlmIChoZWMgIT09IC0xICYmIChob3N0RW5kID09PSAtMSB8fCBoZWMgPCBob3N0RW5kKSkKICAgICAgICAgIGhvc3RFbmQgPSBoZWM7CiAgICAgIH0KICAKICAgICAgLy8gYXQgdGhpcyBwb2ludCwgZWl0aGVyIHdlIGhhdmUgYW4gZXhwbGljaXQgcG9pbnQgd2hlcmUgdGhlCiAgICAgIC8vIGF1dGggcG9ydGlvbiBjYW5ub3QgZ28gcGFzdCwgb3IgdGhlIGxhc3QgQCBjaGFyIGlzIHRoZSBkZWNpZGVyLgogICAgICB2YXIgYXV0aCwgYXRTaWduOwogICAgICBpZiAoaG9zdEVuZCA9PT0gLTEpIHsKICAgICAgICAvLyBhdFNpZ24gY2FuIGJlIGFueXdoZXJlLgogICAgICAgIGF0U2lnbiA9IHJlc3QubGFzdEluZGV4T2YoJ0AnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBhdFNpZ24gbXVzdCBiZSBpbiBhdXRoIHBvcnRpb24uCiAgICAgICAgLy8gaHR0cDovL2FAYi9jQGQgPT4gaG9zdDpiIGF1dGg6YSBwYXRoOi9jQGQKICAgICAgICBhdFNpZ24gPSByZXN0Lmxhc3RJbmRleE9mKCdAJywgaG9zdEVuZCk7CiAgICAgIH0KICAKICAgICAgLy8gTm93IHdlIGhhdmUgYSBwb3J0aW9uIHdoaWNoIGlzIGRlZmluaXRlbHkgdGhlIGF1dGguCiAgICAgIC8vIFB1bGwgdGhhdCBvZmYuCiAgICAgIGlmIChhdFNpZ24gIT09IC0xKSB7CiAgICAgICAgYXV0aCA9IHJlc3Quc2xpY2UoMCwgYXRTaWduKTsKICAgICAgICByZXN0ID0gcmVzdC5zbGljZShhdFNpZ24gKyAxKTsKICAgICAgICB0aGlzLmF1dGggPSBkZWNvZGVVUklDb21wb25lbnQoYXV0aCk7CiAgICAgIH0KICAKICAgICAgLy8gdGhlIGhvc3QgaXMgdGhlIHJlbWFpbmluZyB0byB0aGUgbGVmdCBvZiB0aGUgZmlyc3Qgbm9uLWhvc3QgY2hhcgogICAgICBob3N0RW5kID0gLTE7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9uSG9zdENoYXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGhlYyA9IHJlc3QuaW5kZXhPZihub25Ib3N0Q2hhcnNbaV0pOwogICAgICAgIGlmIChoZWMgIT09IC0xICYmIChob3N0RW5kID09PSAtMSB8fCBoZWMgPCBob3N0RW5kKSkKICAgICAgICAgIGhvc3RFbmQgPSBoZWM7CiAgICAgIH0KICAgICAgLy8gaWYgd2Ugc3RpbGwgaGF2ZSBub3QgaGl0IGl0LCB0aGVuIHRoZSBlbnRpcmUgdGhpbmcgaXMgYSBob3N0LgogICAgICBpZiAoaG9zdEVuZCA9PT0gLTEpCiAgICAgICAgaG9zdEVuZCA9IHJlc3QubGVuZ3RoOwogIAogICAgICB0aGlzLmhvc3QgPSByZXN0LnNsaWNlKDAsIGhvc3RFbmQpOwogICAgICByZXN0ID0gcmVzdC5zbGljZShob3N0RW5kKTsKICAKICAgICAgLy8gcHVsbCBvdXQgcG9ydC4KICAgICAgdGhpcy5wYXJzZUhvc3QoKTsKICAKICAgICAgLy8gd2UndmUgaW5kaWNhdGVkIHRoYXQgdGhlcmUgaXMgYSBob3N0bmFtZSwKICAgICAgLy8gc28gZXZlbiBpZiBpdCdzIGVtcHR5LCBpdCBoYXMgdG8gYmUgcHJlc2VudC4KICAgICAgdGhpcy5ob3N0bmFtZSA9IHRoaXMuaG9zdG5hbWUgfHwgJyc7CiAgCiAgICAgIC8vIGlmIGhvc3RuYW1lIGJlZ2lucyB3aXRoIFsgYW5kIGVuZHMgd2l0aCBdCiAgICAgIC8vIGFzc3VtZSB0aGF0IGl0J3MgYW4gSVB2NiBhZGRyZXNzLgogICAgICB2YXIgaXB2Nkhvc3RuYW1lID0gdGhpcy5ob3N0bmFtZVswXSA9PT0gJ1snICYmCiAgICAgICAgICB0aGlzLmhvc3RuYW1lW3RoaXMuaG9zdG5hbWUubGVuZ3RoIC0gMV0gPT09ICddJzsKICAKICAgICAgLy8gdmFsaWRhdGUgYSBsaXR0bGUuCiAgICAgIGlmICghaXB2Nkhvc3RuYW1lKSB7CiAgICAgICAgdmFyIGhvc3RwYXJ0cyA9IHRoaXMuaG9zdG5hbWUuc3BsaXQoL1wuLyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBob3N0cGFydHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICB2YXIgcGFydCA9IGhvc3RwYXJ0c1tpXTsKICAgICAgICAgIGlmICghcGFydCkgY29udGludWU7CiAgICAgICAgICBpZiAoIXBhcnQubWF0Y2goaG9zdG5hbWVQYXJ0UGF0dGVybikpIHsKICAgICAgICAgICAgdmFyIG5ld3BhcnQgPSAnJzsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGsgPSBwYXJ0Lmxlbmd0aDsgaiA8IGs7IGorKykgewogICAgICAgICAgICAgIGlmIChwYXJ0LmNoYXJDb2RlQXQoaikgPiAxMjcpIHsKICAgICAgICAgICAgICAgIC8vIHdlIHJlcGxhY2Ugbm9uLUFTQ0lJIGNoYXIgd2l0aCBhIHRlbXBvcmFyeSBwbGFjZWhvbGRlcgogICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0aGlzIHRvIG1ha2Ugc3VyZSBzaXplIG9mIGhvc3RuYW1lIGlzIG5vdAogICAgICAgICAgICAgICAgLy8gYnJva2VuIGJ5IHJlcGxhY2luZyBub24tQVNDSUkgYnkgbm90aGluZwogICAgICAgICAgICAgICAgbmV3cGFydCArPSAneCc7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5ld3BhcnQgKz0gcGFydFtqXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gd2UgdGVzdCBhZ2FpbiB3aXRoIEFTQ0lJIGNoYXIgb25seQogICAgICAgICAgICBpZiAoIW5ld3BhcnQubWF0Y2goaG9zdG5hbWVQYXJ0UGF0dGVybikpIHsKICAgICAgICAgICAgICB2YXIgdmFsaWRQYXJ0cyA9IGhvc3RwYXJ0cy5zbGljZSgwLCBpKTsKICAgICAgICAgICAgICB2YXIgbm90SG9zdCA9IGhvc3RwYXJ0cy5zbGljZShpICsgMSk7CiAgICAgICAgICAgICAgdmFyIGJpdCA9IHBhcnQubWF0Y2goaG9zdG5hbWVQYXJ0U3RhcnQpOwogICAgICAgICAgICAgIGlmIChiaXQpIHsKICAgICAgICAgICAgICAgIHZhbGlkUGFydHMucHVzaChiaXRbMV0pOwogICAgICAgICAgICAgICAgbm90SG9zdC51bnNoaWZ0KGJpdFsyXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub3RIb3N0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgcmVzdCA9ICcvJyArIG5vdEhvc3Quam9pbignLicpICsgcmVzdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5ob3N0bmFtZSA9IHZhbGlkUGFydHMuam9pbignLicpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIGlmICh0aGlzLmhvc3RuYW1lLmxlbmd0aCA+IGhvc3RuYW1lTWF4TGVuKSB7CiAgICAgICAgdGhpcy5ob3N0bmFtZSA9ICcnOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGhvc3RuYW1lcyBhcmUgYWx3YXlzIGxvd2VyIGNhc2UuCiAgICAgICAgdGhpcy5ob3N0bmFtZSA9IHRoaXMuaG9zdG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgfQogIAogICAgICBpZiAoIWlwdjZIb3N0bmFtZSkgewogICAgICAgIC8vIElETkEgU3VwcG9ydDogUmV0dXJucyBhIHB1bnkgY29kZWQgcmVwcmVzZW50YXRpb24gb2YgImRvbWFpbiIuCiAgICAgICAgLy8gSXQgb25seSBjb252ZXJ0cyB0aGUgcGFydCBvZiB0aGUgZG9tYWluIG5hbWUgdGhhdAogICAgICAgIC8vIGhhcyBub24gQVNDSUkgY2hhcmFjdGVycy4gSS5lLiBpdCBkb3NlbnQgbWF0dGVyIGlmCiAgICAgICAgLy8geW91IGNhbGwgaXQgd2l0aCBhIGRvbWFpbiB0aGF0IGFscmVhZHkgaXMgaW4gQVNDSUkuCiAgICAgICAgdmFyIGRvbWFpbkFycmF5ID0gdGhpcy5ob3N0bmFtZS5zcGxpdCgnLicpOwogICAgICAgIHZhciBuZXdPdXQgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRvbWFpbkFycmF5Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgICB2YXIgcyA9IGRvbWFpbkFycmF5W2ldOwogICAgICAgICAgbmV3T3V0LnB1c2gocy5tYXRjaCgvW15BLVphLXowLTlfLV0vKSA/CiAgICAgICAgICAgICAgJ3huLS0nICsgcHVueWNvZGUuZW5jb2RlKHMpIDogcyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuaG9zdG5hbWUgPSBuZXdPdXQuam9pbignLicpOwogICAgICB9CiAgCiAgICAgIHZhciBwID0gdGhpcy5wb3J0ID8gJzonICsgdGhpcy5wb3J0IDogJyc7CiAgICAgIHZhciBoID0gdGhpcy5ob3N0bmFtZSB8fCAnJzsKICAgICAgdGhpcy5ob3N0ID0gaCArIHA7CiAgICAgIHRoaXMuaHJlZiArPSB0aGlzLmhvc3Q7CiAgCiAgICAgIC8vIHN0cmlwIFsgYW5kIF0gZnJvbSB0aGUgaG9zdG5hbWUKICAgICAgLy8gdGhlIGhvc3QgZmllbGQgc3RpbGwgcmV0YWlucyB0aGVtLCB0aG91Z2gKICAgICAgaWYgKGlwdjZIb3N0bmFtZSkgewogICAgICAgIHRoaXMuaG9zdG5hbWUgPSB0aGlzLmhvc3RuYW1lLnN1YnN0cigxLCB0aGlzLmhvc3RuYW1lLmxlbmd0aCAtIDIpOwogICAgICAgIGlmIChyZXN0WzBdICE9PSAnLycpIHsKICAgICAgICAgIHJlc3QgPSAnLycgKyByZXN0OwogICAgICAgIH0KICAgICAgfQogICAgfQogIAogICAgLy8gbm93IHJlc3QgaXMgc2V0IHRvIHRoZSBwb3N0LWhvc3Qgc3R1ZmYuCiAgICAvLyBjaG9wIG9mZiBhbnkgZGVsaW0gY2hhcnMuCiAgICBpZiAoIXVuc2FmZVByb3RvY29sW2xvd2VyUHJvdG9dKSB7CiAgCiAgICAgIC8vIEZpcnN0LCBtYWtlIDEwMCUgc3VyZSB0aGF0IGFueSAiYXV0b0VzY2FwZSIgY2hhcnMgZ2V0CiAgICAgIC8vIGVzY2FwZWQsIGV2ZW4gaWYgZW5jb2RlVVJJQ29tcG9uZW50IGRvZXNuJ3QgdGhpbmsgdGhleQogICAgICAvLyBuZWVkIHRvIGJlLgogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGF1dG9Fc2NhcGUubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdmFyIGFlID0gYXV0b0VzY2FwZVtpXTsKICAgICAgICB2YXIgZXNjID0gZW5jb2RlVVJJQ29tcG9uZW50KGFlKTsKICAgICAgICBpZiAoZXNjID09PSBhZSkgewogICAgICAgICAgZXNjID0gZXNjYXBlKGFlKTsKICAgICAgICB9CiAgICAgICAgcmVzdCA9IHJlc3Quc3BsaXQoYWUpLmpvaW4oZXNjKTsKICAgICAgfQogICAgfQogIAogIAogICAgLy8gY2hvcCBvZmYgZnJvbSB0aGUgdGFpbCBmaXJzdC4KICAgIHZhciBoYXNoID0gcmVzdC5pbmRleE9mKCcjJyk7CiAgICBpZiAoaGFzaCAhPT0gLTEpIHsKICAgICAgLy8gZ290IGEgZnJhZ21lbnQgc3RyaW5nLgogICAgICB0aGlzLmhhc2ggPSByZXN0LnN1YnN0cihoYXNoKTsKICAgICAgcmVzdCA9IHJlc3Quc2xpY2UoMCwgaGFzaCk7CiAgICB9CiAgICB2YXIgcW0gPSByZXN0LmluZGV4T2YoJz8nKTsKICAgIGlmIChxbSAhPT0gLTEpIHsKICAgICAgdGhpcy5zZWFyY2ggPSByZXN0LnN1YnN0cihxbSk7CiAgICAgIHRoaXMucXVlcnkgPSByZXN0LnN1YnN0cihxbSArIDEpOwogICAgICBpZiAocGFyc2VRdWVyeVN0cmluZykgewogICAgICAgIHRoaXMucXVlcnkgPSBxdWVyeXN0cmluZy5wYXJzZSh0aGlzLnF1ZXJ5KTsKICAgICAgfQogICAgICByZXN0ID0gcmVzdC5zbGljZSgwLCBxbSk7CiAgICB9IGVsc2UgaWYgKHBhcnNlUXVlcnlTdHJpbmcpIHsKICAgICAgLy8gbm8gcXVlcnkgc3RyaW5nLCBidXQgcGFyc2VRdWVyeVN0cmluZyBzdGlsbCByZXF1ZXN0ZWQKICAgICAgdGhpcy5zZWFyY2ggPSAnJzsKICAgICAgdGhpcy5xdWVyeSA9IHt9OwogICAgfQogICAgaWYgKHJlc3QpIHRoaXMucGF0aG5hbWUgPSByZXN0OwogICAgaWYgKHNsYXNoZWRQcm90b2NvbFtsb3dlclByb3RvXSAmJgogICAgICAgIHRoaXMuaG9zdG5hbWUgJiYgIXRoaXMucGF0aG5hbWUpIHsKICAgICAgdGhpcy5wYXRobmFtZSA9ICcvJzsKICAgIH0KICAKICAgIC8vdG8gc3VwcG9ydCBodHRwLnJlcXVlc3QKICAgIGlmICh0aGlzLnBhdGhuYW1lIHx8IHRoaXMuc2VhcmNoKSB7CiAgICAgIHZhciBwID0gdGhpcy5wYXRobmFtZSB8fCAnJzsKICAgICAgdmFyIHMgPSB0aGlzLnNlYXJjaCB8fCAnJzsKICAgICAgdGhpcy5wYXRoID0gcCArIHM7CiAgICB9CiAgCiAgICAvLyBmaW5hbGx5LCByZWNvbnN0cnVjdCB0aGUgaHJlZiBiYXNlZCBvbiB3aGF0IGhhcyBiZWVuIHZhbGlkYXRlZC4KICAgIHRoaXMuaHJlZiA9IHRoaXMuZm9ybWF0KCk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIAogIC8vIGZvcm1hdCBhIHBhcnNlZCBvYmplY3QgaW50byBhIHVybCBzdHJpbmcKICBmdW5jdGlvbiB1cmxGb3JtYXQob2JqKSB7CiAgICAvLyBlbnN1cmUgaXQncyBhbiBvYmplY3QsIGFuZCBub3QgYSBzdHJpbmcgdXJsLgogICAgLy8gSWYgaXQncyBhbiBvYmosIHRoaXMgaXMgYSBuby1vcC4KICAgIC8vIHRoaXMgd2F5LCB5b3UgY2FuIGNhbGwgdXJsX2Zvcm1hdCgpIG9uIHN0cmluZ3MKICAgIC8vIHRvIGNsZWFuIHVwIHBvdGVudGlhbGx5IHdvbmt5IHVybHMuCiAgICBpZiAoaXNTdHJpbmcob2JqKSkgb2JqID0gdXJsUGFyc2Uob2JqKTsKICAgIGlmICghKG9iaiBpbnN0YW5jZW9mIFVybCkpIHJldHVybiBVcmwucHJvdG90eXBlLmZvcm1hdC5jYWxsKG9iaik7CiAgICByZXR1cm4gb2JqLmZvcm1hdCgpOwogIH0KICAKICBVcmwucHJvdG90eXBlLmZvcm1hdCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGF1dGggPSB0aGlzLmF1dGggfHwgJyc7CiAgICBpZiAoYXV0aCkgewogICAgICBhdXRoID0gZW5jb2RlVVJJQ29tcG9uZW50KGF1dGgpOwogICAgICBhdXRoID0gYXV0aC5yZXBsYWNlKC8lM0EvaSwgJzonKTsKICAgICAgYXV0aCArPSAnQCc7CiAgICB9CiAgCiAgICB2YXIgcHJvdG9jb2wgPSB0aGlzLnByb3RvY29sIHx8ICcnLAogICAgICAgIHBhdGhuYW1lID0gdGhpcy5wYXRobmFtZSB8fCAnJywKICAgICAgICBoYXNoID0gdGhpcy5oYXNoIHx8ICcnLAogICAgICAgIGhvc3QgPSBmYWxzZSwKICAgICAgICBxdWVyeSA9ICcnOwogIAogICAgaWYgKHRoaXMuaG9zdCkgewogICAgICBob3N0ID0gYXV0aCArIHRoaXMuaG9zdDsKICAgIH0gZWxzZSBpZiAodGhpcy5ob3N0bmFtZSkgewogICAgICBob3N0ID0gYXV0aCArICh0aGlzLmhvc3RuYW1lLmluZGV4T2YoJzonKSA9PT0gLTEgPwogICAgICAgICAgdGhpcy5ob3N0bmFtZSA6CiAgICAgICAgICAnWycgKyB0aGlzLmhvc3RuYW1lICsgJ10nKTsKICAgICAgaWYgKHRoaXMucG9ydCkgewogICAgICAgIGhvc3QgKz0gJzonICsgdGhpcy5wb3J0OwogICAgICB9CiAgICB9CiAgCiAgICBpZiAodGhpcy5xdWVyeSAmJgogICAgICAgIGlzT2JqZWN0KHRoaXMucXVlcnkpICYmCiAgICAgICAgT2JqZWN0LmtleXModGhpcy5xdWVyeSkubGVuZ3RoKSB7CiAgICAgIHF1ZXJ5ID0gcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHRoaXMucXVlcnkpOwogICAgfQogIAogICAgdmFyIHNlYXJjaCA9IHRoaXMuc2VhcmNoIHx8IChxdWVyeSAmJiAoJz8nICsgcXVlcnkpKSB8fCAnJzsKICAKICAgIGlmIChwcm90b2NvbCAmJiBwcm90b2NvbC5zdWJzdHIoLTEpICE9PSAnOicpIHByb3RvY29sICs9ICc6JzsKICAKICAgIC8vIG9ubHkgdGhlIHNsYXNoZWRQcm90b2NvbHMgZ2V0IHRoZSAvLy4gIE5vdCBtYWlsdG86LCB4bXBwOiwgZXRjLgogICAgLy8gdW5sZXNzIHRoZXkgaGFkIHRoZW0gdG8gYmVnaW4gd2l0aC4KICAgIGlmICh0aGlzLnNsYXNoZXMgfHwKICAgICAgICAoIXByb3RvY29sIHx8IHNsYXNoZWRQcm90b2NvbFtwcm90b2NvbF0pICYmIGhvc3QgIT09IGZhbHNlKSB7CiAgICAgIGhvc3QgPSAnLy8nICsgKGhvc3QgfHwgJycpOwogICAgICBpZiAocGF0aG5hbWUgJiYgcGF0aG5hbWUuY2hhckF0KDApICE9PSAnLycpIHBhdGhuYW1lID0gJy8nICsgcGF0aG5hbWU7CiAgICB9IGVsc2UgaWYgKCFob3N0KSB7CiAgICAgIGhvc3QgPSAnJzsKICAgIH0KICAKICAgIGlmIChoYXNoICYmIGhhc2guY2hhckF0KDApICE9PSAnIycpIGhhc2ggPSAnIycgKyBoYXNoOwogICAgaWYgKHNlYXJjaCAmJiBzZWFyY2guY2hhckF0KDApICE9PSAnPycpIHNlYXJjaCA9ICc/JyArIHNlYXJjaDsKICAKICAgIHBhdGhuYW1lID0gcGF0aG5hbWUucmVwbGFjZSgvWz8jXS9nLCBmdW5jdGlvbihtYXRjaCkgewogICAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KG1hdGNoKTsKICAgIH0pOwogICAgc2VhcmNoID0gc2VhcmNoLnJlcGxhY2UoJyMnLCAnJTIzJyk7CiAgCiAgICByZXR1cm4gcHJvdG9jb2wgKyBob3N0ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwogIH07CiAgCiAgZnVuY3Rpb24gdXJsUmVzb2x2ZShzb3VyY2UsIHJlbGF0aXZlKSB7CiAgICByZXR1cm4gdXJsUGFyc2Uoc291cmNlLCBmYWxzZSwgdHJ1ZSkucmVzb2x2ZShyZWxhdGl2ZSk7CiAgfQogIAogIFVybC5wcm90b3R5cGUucmVzb2x2ZSA9IGZ1bmN0aW9uKHJlbGF0aXZlKSB7CiAgICByZXR1cm4gdGhpcy5yZXNvbHZlT2JqZWN0KHVybFBhcnNlKHJlbGF0aXZlLCBmYWxzZSwgdHJ1ZSkpLmZvcm1hdCgpOwogIH07CiAgCiAgZnVuY3Rpb24gdXJsUmVzb2x2ZU9iamVjdChzb3VyY2UsIHJlbGF0aXZlKSB7CiAgICBpZiAoIXNvdXJjZSkgcmV0dXJuIHJlbGF0aXZlOwogICAgcmV0dXJuIHVybFBhcnNlKHNvdXJjZSwgZmFsc2UsIHRydWUpLnJlc29sdmVPYmplY3QocmVsYXRpdmUpOwogIH0KICAKICBVcmwucHJvdG90eXBlLnJlc29sdmVPYmplY3QgPSBmdW5jdGlvbihyZWxhdGl2ZSkgewogICAgaWYgKGlzU3RyaW5nKHJlbGF0aXZlKSkgewogICAgICB2YXIgcmVsID0gbmV3IFVybCgpOwogICAgICByZWwucGFyc2UocmVsYXRpdmUsIGZhbHNlLCB0cnVlKTsKICAgICAgcmVsYXRpdmUgPSByZWw7CiAgICB9CiAgCiAgICB2YXIgcmVzdWx0ID0gbmV3IFVybCgpOwogICAgT2JqZWN0LmtleXModGhpcykuZm9yRWFjaChmdW5jdGlvbihrKSB7CiAgICAgIHJlc3VsdFtrXSA9IHRoaXNba107CiAgICB9LCB0aGlzKTsKICAKICAgIC8vIGhhc2ggaXMgYWx3YXlzIG92ZXJyaWRkZW4sIG5vIG1hdHRlciB3aGF0LgogICAgLy8gZXZlbiBocmVmPSIiIHdpbGwgcmVtb3ZlIGl0LgogICAgcmVzdWx0Lmhhc2ggPSByZWxhdGl2ZS5oYXNoOwogIAogICAgLy8gaWYgdGhlIHJlbGF0aXZlIHVybCBpcyBlbXB0eSwgdGhlbiB0aGVyZSdzIG5vdGhpbmcgbGVmdCB0byBkbyBoZXJlLgogICAgaWYgKHJlbGF0aXZlLmhyZWYgPT09ICcnKSB7CiAgICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIAogICAgLy8gaHJlZnMgbGlrZSAvL2Zvby9iYXIgYWx3YXlzIGN1dCB0byB0aGUgcHJvdG9jb2wuCiAgICBpZiAocmVsYXRpdmUuc2xhc2hlcyAmJiAhcmVsYXRpdmUucHJvdG9jb2wpIHsKICAgICAgLy8gdGFrZSBldmVyeXRoaW5nIGV4Y2VwdCB0aGUgcHJvdG9jb2wgZnJvbSByZWxhdGl2ZQogICAgICBPYmplY3Qua2V5cyhyZWxhdGl2ZSkuZm9yRWFjaChmdW5jdGlvbihrKSB7CiAgICAgICAgaWYgKGsgIT09ICdwcm90b2NvbCcpCiAgICAgICAgICByZXN1bHRba10gPSByZWxhdGl2ZVtrXTsKICAgICAgfSk7CiAgCiAgICAgIC8vdXJsUGFyc2UgYXBwZW5kcyB0cmFpbGluZyAvIHRvIHVybHMgbGlrZSBodHRwOi8vd3d3LmV4YW1wbGUuY29tCiAgICAgIGlmIChzbGFzaGVkUHJvdG9jb2xbcmVzdWx0LnByb3RvY29sXSAmJgogICAgICAgICAgcmVzdWx0Lmhvc3RuYW1lICYmICFyZXN1bHQucGF0aG5hbWUpIHsKICAgICAgICByZXN1bHQucGF0aCA9IHJlc3VsdC5wYXRobmFtZSA9ICcvJzsKICAgICAgfQogIAogICAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAKICAgIGlmIChyZWxhdGl2ZS5wcm90b2NvbCAmJiByZWxhdGl2ZS5wcm90b2NvbCAhPT0gcmVzdWx0LnByb3RvY29sKSB7CiAgICAgIC8vIGlmIGl0J3MgYSBrbm93biB1cmwgcHJvdG9jb2wsIHRoZW4gY2hhbmdpbmcKICAgICAgLy8gdGhlIHByb3RvY29sIGRvZXMgd2VpcmQgdGhpbmdzCiAgICAgIC8vIGZpcnN0LCBpZiBpdCdzIG5vdCBmaWxlOiwgdGhlbiB3ZSBNVVNUIGhhdmUgYSBob3N0LAogICAgICAvLyBhbmQgaWYgdGhlcmUgd2FzIGEgcGF0aAogICAgICAvLyB0byBiZWdpbiB3aXRoLCB0aGVuIHdlIE1VU1QgaGF2ZSBhIHBhdGguCiAgICAgIC8vIGlmIGl0IGlzIGZpbGU6LCB0aGVuIHRoZSBob3N0IGlzIGRyb3BwZWQsCiAgICAgIC8vIGJlY2F1c2UgdGhhdCdzIGtub3duIHRvIGJlIGhvc3RsZXNzLgogICAgICAvLyBhbnl0aGluZyBlbHNlIGlzIGFzc3VtZWQgdG8gYmUgYWJzb2x1dGUuCiAgICAgIGlmICghc2xhc2hlZFByb3RvY29sW3JlbGF0aXZlLnByb3RvY29sXSkgewogICAgICAgIE9iamVjdC5rZXlzKHJlbGF0aXZlKS5mb3JFYWNoKGZ1bmN0aW9uKGspIHsKICAgICAgICAgIHJlc3VsdFtrXSA9IHJlbGF0aXZlW2tdOwogICAgICAgIH0pOwogICAgICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAKICAgICAgcmVzdWx0LnByb3RvY29sID0gcmVsYXRpdmUucHJvdG9jb2w7CiAgICAgIGlmICghcmVsYXRpdmUuaG9zdCAmJiAhaG9zdGxlc3NQcm90b2NvbFtyZWxhdGl2ZS5wcm90b2NvbF0pIHsKICAgICAgICB2YXIgcmVsUGF0aCA9IChyZWxhdGl2ZS5wYXRobmFtZSB8fCAnJykuc3BsaXQoJy8nKTsKICAgICAgICB3aGlsZSAocmVsUGF0aC5sZW5ndGggJiYgIShyZWxhdGl2ZS5ob3N0ID0gcmVsUGF0aC5zaGlmdCgpKSk7CiAgICAgICAgaWYgKCFyZWxhdGl2ZS5ob3N0KSByZWxhdGl2ZS5ob3N0ID0gJyc7CiAgICAgICAgaWYgKCFyZWxhdGl2ZS5ob3N0bmFtZSkgcmVsYXRpdmUuaG9zdG5hbWUgPSAnJzsKICAgICAgICBpZiAocmVsUGF0aFswXSAhPT0gJycpIHJlbFBhdGgudW5zaGlmdCgnJyk7CiAgICAgICAgaWYgKHJlbFBhdGgubGVuZ3RoIDwgMikgcmVsUGF0aC51bnNoaWZ0KCcnKTsKICAgICAgICByZXN1bHQucGF0aG5hbWUgPSByZWxQYXRoLmpvaW4oJy8nKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHQucGF0aG5hbWUgPSByZWxhdGl2ZS5wYXRobmFtZTsKICAgICAgfQogICAgICByZXN1bHQuc2VhcmNoID0gcmVsYXRpdmUuc2VhcmNoOwogICAgICByZXN1bHQucXVlcnkgPSByZWxhdGl2ZS5xdWVyeTsKICAgICAgcmVzdWx0Lmhvc3QgPSByZWxhdGl2ZS5ob3N0IHx8ICcnOwogICAgICByZXN1bHQuYXV0aCA9IHJlbGF0aXZlLmF1dGg7CiAgICAgIHJlc3VsdC5ob3N0bmFtZSA9IHJlbGF0aXZlLmhvc3RuYW1lIHx8IHJlbGF0aXZlLmhvc3Q7CiAgICAgIHJlc3VsdC5wb3J0ID0gcmVsYXRpdmUucG9ydDsKICAgICAgLy8gdG8gc3VwcG9ydCBodHRwLnJlcXVlc3QKICAgICAgaWYgKHJlc3VsdC5wYXRobmFtZSB8fCByZXN1bHQuc2VhcmNoKSB7CiAgICAgICAgdmFyIHAgPSByZXN1bHQucGF0aG5hbWUgfHwgJyc7CiAgICAgICAgdmFyIHMgPSByZXN1bHQuc2VhcmNoIHx8ICcnOwogICAgICAgIHJlc3VsdC5wYXRoID0gcCArIHM7CiAgICAgIH0KICAgICAgcmVzdWx0LnNsYXNoZXMgPSByZXN1bHQuc2xhc2hlcyB8fCByZWxhdGl2ZS5zbGFzaGVzOwogICAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAKICAgIHZhciBpc1NvdXJjZUFicyA9IChyZXN1bHQucGF0aG5hbWUgJiYgcmVzdWx0LnBhdGhuYW1lLmNoYXJBdCgwKSA9PT0gJy8nKSwKICAgICAgICBpc1JlbEFicyA9ICgKICAgICAgICAgICAgcmVsYXRpdmUuaG9zdCB8fAogICAgICAgICAgICByZWxhdGl2ZS5wYXRobmFtZSAmJiByZWxhdGl2ZS5wYXRobmFtZS5jaGFyQXQoMCkgPT09ICcvJwogICAgICAgICksCiAgICAgICAgbXVzdEVuZEFicyA9IChpc1JlbEFicyB8fCBpc1NvdXJjZUFicyB8fAogICAgICAgICAgICAgICAgICAgICAgKHJlc3VsdC5ob3N0ICYmIHJlbGF0aXZlLnBhdGhuYW1lKSksCiAgICAgICAgcmVtb3ZlQWxsRG90cyA9IG11c3RFbmRBYnMsCiAgICAgICAgc3JjUGF0aCA9IHJlc3VsdC5wYXRobmFtZSAmJiByZXN1bHQucGF0aG5hbWUuc3BsaXQoJy8nKSB8fCBbXSwKICAgICAgICByZWxQYXRoID0gcmVsYXRpdmUucGF0aG5hbWUgJiYgcmVsYXRpdmUucGF0aG5hbWUuc3BsaXQoJy8nKSB8fCBbXSwKICAgICAgICBwc3ljaG90aWMgPSByZXN1bHQucHJvdG9jb2wgJiYgIXNsYXNoZWRQcm90b2NvbFtyZXN1bHQucHJvdG9jb2xdOwogIAogICAgLy8gaWYgdGhlIHVybCBpcyBhIG5vbi1zbGFzaGVkIHVybCwgdGhlbiByZWxhdGl2ZQogICAgLy8gbGlua3MgbGlrZSAuLi8uLiBzaG91bGQgYmUgYWJsZQogICAgLy8gdG8gY3Jhd2wgdXAgdG8gdGhlIGhvc3RuYW1lLCBhcyB3ZWxsLiAgVGhpcyBpcyBzdHJhbmdlLgogICAgLy8gcmVzdWx0LnByb3RvY29sIGhhcyBhbHJlYWR5IGJlZW4gc2V0IGJ5IG5vdy4KICAgIC8vIExhdGVyIG9uLCBwdXQgdGhlIGZpcnN0IHBhdGggcGFydCBpbnRvIHRoZSBob3N0IGZpZWxkLgogICAgaWYgKHBzeWNob3RpYykgewogICAgICByZXN1bHQuaG9zdG5hbWUgPSAnJzsKICAgICAgcmVzdWx0LnBvcnQgPSBudWxsOwogICAgICBpZiAocmVzdWx0Lmhvc3QpIHsKICAgICAgICBpZiAoc3JjUGF0aFswXSA9PT0gJycpIHNyY1BhdGhbMF0gPSByZXN1bHQuaG9zdDsKICAgICAgICBlbHNlIHNyY1BhdGgudW5zaGlmdChyZXN1bHQuaG9zdCk7CiAgICAgIH0KICAgICAgcmVzdWx0Lmhvc3QgPSAnJzsKICAgICAgaWYgKHJlbGF0aXZlLnByb3RvY29sKSB7CiAgICAgICAgcmVsYXRpdmUuaG9zdG5hbWUgPSBudWxsOwogICAgICAgIHJlbGF0aXZlLnBvcnQgPSBudWxsOwogICAgICAgIGlmIChyZWxhdGl2ZS5ob3N0KSB7CiAgICAgICAgICBpZiAocmVsUGF0aFswXSA9PT0gJycpIHJlbFBhdGhbMF0gPSByZWxhdGl2ZS5ob3N0OwogICAgICAgICAgZWxzZSByZWxQYXRoLnVuc2hpZnQocmVsYXRpdmUuaG9zdCk7CiAgICAgICAgfQogICAgICAgIHJlbGF0aXZlLmhvc3QgPSBudWxsOwogICAgICB9CiAgICAgIG11c3RFbmRBYnMgPSBtdXN0RW5kQWJzICYmIChyZWxQYXRoWzBdID09PSAnJyB8fCBzcmNQYXRoWzBdID09PSAnJyk7CiAgICB9CiAgCiAgICBpZiAoaXNSZWxBYnMpIHsKICAgICAgLy8gaXQncyBhYnNvbHV0ZS4KICAgICAgcmVzdWx0Lmhvc3QgPSAocmVsYXRpdmUuaG9zdCB8fCByZWxhdGl2ZS5ob3N0ID09PSAnJykgPwogICAgICAgICAgICAgICAgICAgIHJlbGF0aXZlLmhvc3QgOiByZXN1bHQuaG9zdDsKICAgICAgcmVzdWx0Lmhvc3RuYW1lID0gKHJlbGF0aXZlLmhvc3RuYW1lIHx8IHJlbGF0aXZlLmhvc3RuYW1lID09PSAnJykgPwogICAgICAgICAgICAgICAgICAgICAgICByZWxhdGl2ZS5ob3N0bmFtZSA6IHJlc3VsdC5ob3N0bmFtZTsKICAgICAgcmVzdWx0LnNlYXJjaCA9IHJlbGF0aXZlLnNlYXJjaDsKICAgICAgcmVzdWx0LnF1ZXJ5ID0gcmVsYXRpdmUucXVlcnk7CiAgICAgIHNyY1BhdGggPSByZWxQYXRoOwogICAgICAvLyBmYWxsIHRocm91Z2ggdG8gdGhlIGRvdC1oYW5kbGluZyBiZWxvdy4KICAgIH0gZWxzZSBpZiAocmVsUGF0aC5sZW5ndGgpIHsKICAgICAgLy8gaXQncyByZWxhdGl2ZQogICAgICAvLyB0aHJvdyBhd2F5IHRoZSBleGlzdGluZyBmaWxlLCBhbmQgdGFrZSB0aGUgbmV3IHBhdGggaW5zdGVhZC4KICAgICAgaWYgKCFzcmNQYXRoKSBzcmNQYXRoID0gW107CiAgICAgIHNyY1BhdGgucG9wKCk7CiAgICAgIHNyY1BhdGggPSBzcmNQYXRoLmNvbmNhdChyZWxQYXRoKTsKICAgICAgcmVzdWx0LnNlYXJjaCA9IHJlbGF0aXZlLnNlYXJjaDsKICAgICAgcmVzdWx0LnF1ZXJ5ID0gcmVsYXRpdmUucXVlcnk7CiAgICB9IGVsc2UgaWYgKCFpc051bGxPclVuZGVmaW5lZChyZWxhdGl2ZS5zZWFyY2gpKSB7CiAgICAgIC8vIGp1c3QgcHVsbCBvdXQgdGhlIHNlYXJjaC4KICAgICAgLy8gbGlrZSBocmVmPSc/Zm9vJy4KICAgICAgLy8gUHV0IHRoaXMgYWZ0ZXIgdGhlIG90aGVyIHR3byBjYXNlcyBiZWNhdXNlIGl0IHNpbXBsaWZpZXMgdGhlIGJvb2xlYW5zCiAgICAgIGlmIChwc3ljaG90aWMpIHsKICAgICAgICByZXN1bHQuaG9zdG5hbWUgPSByZXN1bHQuaG9zdCA9IHNyY1BhdGguc2hpZnQoKTsKICAgICAgICAvL29jY2F0aW9uYWx5IHRoZSBhdXRoIGNhbiBnZXQgc3R1Y2sgb25seSBpbiBob3N0CiAgICAgICAgLy90aGlzIGVzcGVjaWFseSBoYXBwZW5zIGluIGNhc2VzIGxpa2UKICAgICAgICAvL3VybC5yZXNvbHZlT2JqZWN0KCdtYWlsdG86bG9jYWwxQGRvbWFpbjEnLCAnbG9jYWwyQGRvbWFpbjInKQogICAgICAgIHZhciBhdXRoSW5Ib3N0ID0gcmVzdWx0Lmhvc3QgJiYgcmVzdWx0Lmhvc3QuaW5kZXhPZignQCcpID4gMCA/CiAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQuaG9zdC5zcGxpdCgnQCcpIDogZmFsc2U7CiAgICAgICAgaWYgKGF1dGhJbkhvc3QpIHsKICAgICAgICAgIHJlc3VsdC5hdXRoID0gYXV0aEluSG9zdC5zaGlmdCgpOwogICAgICAgICAgcmVzdWx0Lmhvc3QgPSByZXN1bHQuaG9zdG5hbWUgPSBhdXRoSW5Ib3N0LnNoaWZ0KCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJlc3VsdC5zZWFyY2ggPSByZWxhdGl2ZS5zZWFyY2g7CiAgICAgIHJlc3VsdC5xdWVyeSA9IHJlbGF0aXZlLnF1ZXJ5OwogICAgICAvL3RvIHN1cHBvcnQgaHR0cC5yZXF1ZXN0CiAgICAgIGlmICghaXNOdWxsKHJlc3VsdC5wYXRobmFtZSkgfHwgIWlzTnVsbChyZXN1bHQuc2VhcmNoKSkgewogICAgICAgIHJlc3VsdC5wYXRoID0gKHJlc3VsdC5wYXRobmFtZSA/IHJlc3VsdC5wYXRobmFtZSA6ICcnKSArCiAgICAgICAgICAgICAgICAgICAgICAocmVzdWx0LnNlYXJjaCA/IHJlc3VsdC5zZWFyY2ggOiAnJyk7CiAgICAgIH0KICAgICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgCiAgICBpZiAoIXNyY1BhdGgubGVuZ3RoKSB7CiAgICAgIC8vIG5vIHBhdGggYXQgYWxsLiAgZWFzeS4KICAgICAgLy8gd2UndmUgYWxyZWFkeSBoYW5kbGVkIHRoZSBvdGhlciBzdHVmZiBhYm92ZS4KICAgICAgcmVzdWx0LnBhdGhuYW1lID0gbnVsbDsKICAgICAgLy90byBzdXBwb3J0IGh0dHAucmVxdWVzdAogICAgICBpZiAocmVzdWx0LnNlYXJjaCkgewogICAgICAgIHJlc3VsdC5wYXRoID0gJy8nICsgcmVzdWx0LnNlYXJjaDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHQucGF0aCA9IG51bGw7CiAgICAgIH0KICAgICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgCiAgICAvLyBpZiBhIHVybCBFTkRzIGluIC4gb3IgLi4sIHRoZW4gaXQgbXVzdCBnZXQgYSB0cmFpbGluZyBzbGFzaC4KICAgIC8vIGhvd2V2ZXIsIGlmIGl0IGVuZHMgaW4gYW55dGhpbmcgZWxzZSBub24tc2xhc2h5LAogICAgLy8gdGhlbiBpdCBtdXN0IE5PVCBnZXQgYSB0cmFpbGluZyBzbGFzaC4KICAgIHZhciBsYXN0ID0gc3JjUGF0aC5zbGljZSgtMSlbMF07CiAgICB2YXIgaGFzVHJhaWxpbmdTbGFzaCA9ICgKICAgICAgICAocmVzdWx0Lmhvc3QgfHwgcmVsYXRpdmUuaG9zdCkgJiYgKGxhc3QgPT09ICcuJyB8fCBsYXN0ID09PSAnLi4nKSB8fAogICAgICAgIGxhc3QgPT09ICcnKTsKICAKICAgIC8vIHN0cmlwIHNpbmdsZSBkb3RzLCByZXNvbHZlIGRvdWJsZSBkb3RzIHRvIHBhcmVudCBkaXIKICAgIC8vIGlmIHRoZSBwYXRoIHRyaWVzIHRvIGdvIGFib3ZlIHRoZSByb290LCBgdXBgIGVuZHMgdXAgPiAwCiAgICB2YXIgdXAgPSAwOwogICAgZm9yICh2YXIgaSA9IHNyY1BhdGgubGVuZ3RoOyBpID49IDA7IGktLSkgewogICAgICBsYXN0ID0gc3JjUGF0aFtpXTsKICAgICAgaWYgKGxhc3QgPT0gJy4nKSB7CiAgICAgICAgc3JjUGF0aC5zcGxpY2UoaSwgMSk7CiAgICAgIH0gZWxzZSBpZiAobGFzdCA9PT0gJy4uJykgewogICAgICAgIHNyY1BhdGguc3BsaWNlKGksIDEpOwogICAgICAgIHVwKys7CiAgICAgIH0gZWxzZSBpZiAodXApIHsKICAgICAgICBzcmNQYXRoLnNwbGljZShpLCAxKTsKICAgICAgICB1cC0tOwogICAgICB9CiAgICB9CiAgCiAgICAvLyBpZiB0aGUgcGF0aCBpcyBhbGxvd2VkIHRvIGdvIGFib3ZlIHRoZSByb290LCByZXN0b3JlIGxlYWRpbmcgLi5zCiAgICBpZiAoIW11c3RFbmRBYnMgJiYgIXJlbW92ZUFsbERvdHMpIHsKICAgICAgZm9yICg7IHVwLS07IHVwKSB7CiAgICAgICAgc3JjUGF0aC51bnNoaWZ0KCcuLicpOwogICAgICB9CiAgICB9CiAgCiAgICBpZiAobXVzdEVuZEFicyAmJiBzcmNQYXRoWzBdICE9PSAnJyAmJgogICAgICAgICghc3JjUGF0aFswXSB8fCBzcmNQYXRoWzBdLmNoYXJBdCgwKSAhPT0gJy8nKSkgewogICAgICBzcmNQYXRoLnVuc2hpZnQoJycpOwogICAgfQogIAogICAgaWYgKGhhc1RyYWlsaW5nU2xhc2ggJiYgKHNyY1BhdGguam9pbignLycpLnN1YnN0cigtMSkgIT09ICcvJykpIHsKICAgICAgc3JjUGF0aC5wdXNoKCcnKTsKICAgIH0KICAKICAgIHZhciBpc0Fic29sdXRlID0gc3JjUGF0aFswXSA9PT0gJycgfHwKICAgICAgICAoc3JjUGF0aFswXSAmJiBzcmNQYXRoWzBdLmNoYXJBdCgwKSA9PT0gJy8nKTsKICAKICAgIC8vIHB1dCB0aGUgaG9zdCBiYWNrCiAgICBpZiAocHN5Y2hvdGljKSB7CiAgICAgIHJlc3VsdC5ob3N0bmFtZSA9IHJlc3VsdC5ob3N0ID0gaXNBYnNvbHV0ZSA/ICcnIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcmNQYXRoLmxlbmd0aCA/IHNyY1BhdGguc2hpZnQoKSA6ICcnOwogICAgICAvL29jY2F0aW9uYWx5IHRoZSBhdXRoIGNhbiBnZXQgc3R1Y2sgb25seSBpbiBob3N0CiAgICAgIC8vdGhpcyBlc3BlY2lhbHkgaGFwcGVucyBpbiBjYXNlcyBsaWtlCiAgICAgIC8vdXJsLnJlc29sdmVPYmplY3QoJ21haWx0bzpsb2NhbDFAZG9tYWluMScsICdsb2NhbDJAZG9tYWluMicpCiAgICAgIHZhciBhdXRoSW5Ib3N0ID0gcmVzdWx0Lmhvc3QgJiYgcmVzdWx0Lmhvc3QuaW5kZXhPZignQCcpID4gMCA/CiAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lmhvc3Quc3BsaXQoJ0AnKSA6IGZhbHNlOwogICAgICBpZiAoYXV0aEluSG9zdCkgewogICAgICAgIHJlc3VsdC5hdXRoID0gYXV0aEluSG9zdC5zaGlmdCgpOwogICAgICAgIHJlc3VsdC5ob3N0ID0gcmVzdWx0Lmhvc3RuYW1lID0gYXV0aEluSG9zdC5zaGlmdCgpOwogICAgICB9CiAgICB9CiAgCiAgICBtdXN0RW5kQWJzID0gbXVzdEVuZEFicyB8fCAocmVzdWx0Lmhvc3QgJiYgc3JjUGF0aC5sZW5ndGgpOwogIAogICAgaWYgKG11c3RFbmRBYnMgJiYgIWlzQWJzb2x1dGUpIHsKICAgICAgc3JjUGF0aC51bnNoaWZ0KCcnKTsKICAgIH0KICAKICAgIGlmICghc3JjUGF0aC5sZW5ndGgpIHsKICAgICAgcmVzdWx0LnBhdGhuYW1lID0gbnVsbDsKICAgICAgcmVzdWx0LnBhdGggPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgcmVzdWx0LnBhdGhuYW1lID0gc3JjUGF0aC5qb2luKCcvJyk7CiAgICB9CiAgCiAgICAvL3RvIHN1cHBvcnQgcmVxdWVzdC5odHRwCiAgICBpZiAoIWlzTnVsbChyZXN1bHQucGF0aG5hbWUpIHx8ICFpc051bGwocmVzdWx0LnNlYXJjaCkpIHsKICAgICAgcmVzdWx0LnBhdGggPSAocmVzdWx0LnBhdGhuYW1lID8gcmVzdWx0LnBhdGhuYW1lIDogJycpICsKICAgICAgICAgICAgICAgICAgICAocmVzdWx0LnNlYXJjaCA/IHJlc3VsdC5zZWFyY2ggOiAnJyk7CiAgICB9CiAgICByZXN1bHQuYXV0aCA9IHJlbGF0aXZlLmF1dGggfHwgcmVzdWx0LmF1dGg7CiAgICByZXN1bHQuc2xhc2hlcyA9IHJlc3VsdC5zbGFzaGVzIHx8IHJlbGF0aXZlLnNsYXNoZXM7CiAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICAKICBVcmwucHJvdG90eXBlLnBhcnNlSG9zdCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGhvc3QgPSB0aGlzLmhvc3Q7CiAgICB2YXIgcG9ydCA9IHBvcnRQYXR0ZXJuLmV4ZWMoaG9zdCk7CiAgICBpZiAocG9ydCkgewogICAgICBwb3J0ID0gcG9ydFswXTsKICAgICAgaWYgKHBvcnQgIT09ICc6JykgewogICAgICAgIHRoaXMucG9ydCA9IHBvcnQuc3Vic3RyKDEpOwogICAgICB9CiAgICAgIGhvc3QgPSBob3N0LnN1YnN0cigwLCBob3N0Lmxlbmd0aCAtIHBvcnQubGVuZ3RoKTsKICAgIH0KICAgIGlmIChob3N0KSB0aGlzLmhvc3RuYW1lID0gaG9zdDsKICB9OwogIAogIGZ1bmN0aW9uIGlzU3RyaW5nKGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICJzdHJpbmciOwogIH0KICAKICBmdW5jdGlvbiBpc09iamVjdChhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JyAmJiBhcmcgIT09IG51bGw7CiAgfQogIAogIGZ1bmN0aW9uIGlzTnVsbChhcmcpIHsKICAgIHJldHVybiBhcmcgPT09IG51bGw7CiAgfQogIGZ1bmN0aW9uIGlzTnVsbE9yVW5kZWZpbmVkKGFyZykgewogICAgcmV0dXJuICBhcmcgPT0gbnVsbDsKICB9CiAgCiAgfSx7InB1bnljb2RlIjo4NiwicXVlcnlzdHJpbmciOjg5fV0sOTU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIGlmICh0eXBlb2YgT2JqZWN0LmNyZWF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgLy8gaW1wbGVtZW50YXRpb24gZnJvbSBzdGFuZGFyZCBub2RlLmpzICd1dGlsJyBtb2R1bGUKICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gaW5oZXJpdHMoY3Rvciwgc3VwZXJDdG9yKSB7CiAgICAgIGN0b3Iuc3VwZXJfID0gc3VwZXJDdG9yCiAgICAgIGN0b3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckN0b3IucHJvdG90eXBlLCB7CiAgICAgICAgY29uc3RydWN0b3I6IHsKICAgICAgICAgIHZhbHVlOiBjdG9yLAogICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgIH0KICAgICAgfSk7CiAgICB9OwogIH0gZWxzZSB7CiAgICAvLyBvbGQgc2Nob29sIHNoaW0gZm9yIG9sZCBicm93c2VycwogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpbmhlcml0cyhjdG9yLCBzdXBlckN0b3IpIHsKICAgICAgY3Rvci5zdXBlcl8gPSBzdXBlckN0b3IKICAgICAgdmFyIFRlbXBDdG9yID0gZnVuY3Rpb24gKCkge30KICAgICAgVGVtcEN0b3IucHJvdG90eXBlID0gc3VwZXJDdG9yLnByb3RvdHlwZQogICAgICBjdG9yLnByb3RvdHlwZSA9IG5ldyBUZW1wQ3RvcigpCiAgICAgIGN0b3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gY3RvcgogICAgfQogIH0KICAKICB9LHt9XSw5NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpc0J1ZmZlcihhcmcpIHsKICAgIHJldHVybiBhcmcgJiYgdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcKICAgICAgJiYgdHlwZW9mIGFyZy5jb3B5ID09PSAnZnVuY3Rpb24nCiAgICAgICYmIHR5cGVvZiBhcmcuZmlsbCA9PT0gJ2Z1bmN0aW9uJwogICAgICAmJiB0eXBlb2YgYXJnLnJlYWRVSW50OCA9PT0gJ2Z1bmN0aW9uJzsKICB9CiAgfSx7fV0sOTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAocHJvY2VzcyxnbG9iYWwpewogIC8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgogIC8vCiAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKICAvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiAgLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwogIC8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKICAvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CiAgLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCiAgLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgLy8KICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAogIC8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogIC8vCiAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICAvLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiAgLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgogIC8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAogIC8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgogIC8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKICAvLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogIAogIHZhciBmb3JtYXRSZWdFeHAgPSAvJVtzZGolXS9nOwogIGV4cG9ydHMuZm9ybWF0ID0gZnVuY3Rpb24oZikgewogICAgaWYgKCFpc1N0cmluZyhmKSkgewogICAgICB2YXIgb2JqZWN0cyA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIG9iamVjdHMucHVzaChpbnNwZWN0KGFyZ3VtZW50c1tpXSkpOwogICAgICB9CiAgICAgIHJldHVybiBvYmplY3RzLmpvaW4oJyAnKTsKICAgIH0KICAKICAgIHZhciBpID0gMTsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgdmFyIGxlbiA9IGFyZ3MubGVuZ3RoOwogICAgdmFyIHN0ciA9IFN0cmluZyhmKS5yZXBsYWNlKGZvcm1hdFJlZ0V4cCwgZnVuY3Rpb24oeCkgewogICAgICBpZiAoeCA9PT0gJyUlJykgcmV0dXJuICclJzsKICAgICAgaWYgKGkgPj0gbGVuKSByZXR1cm4geDsKICAgICAgc3dpdGNoICh4KSB7CiAgICAgICAgY2FzZSAnJXMnOiByZXR1cm4gU3RyaW5nKGFyZ3NbaSsrXSk7CiAgICAgICAgY2FzZSAnJWQnOiByZXR1cm4gTnVtYmVyKGFyZ3NbaSsrXSk7CiAgICAgICAgY2FzZSAnJWonOgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGFyZ3NbaSsrXSk7CiAgICAgICAgICB9IGNhdGNoIChfKSB7CiAgICAgICAgICAgIHJldHVybiAnW0NpcmN1bGFyXSc7CiAgICAgICAgICB9CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiB4OwogICAgICB9CiAgICB9KTsKICAgIGZvciAodmFyIHggPSBhcmdzW2ldOyBpIDwgbGVuOyB4ID0gYXJnc1srK2ldKSB7CiAgICAgIGlmIChpc051bGwoeCkgfHwgIWlzT2JqZWN0KHgpKSB7CiAgICAgICAgc3RyICs9ICcgJyArIHg7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RyICs9ICcgJyArIGluc3BlY3QoeCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBzdHI7CiAgfTsKICAKICAKICAvLyBNYXJrIHRoYXQgYSBtZXRob2Qgc2hvdWxkIG5vdCBiZSB1c2VkLgogIC8vIFJldHVybnMgYSBtb2RpZmllZCBmdW5jdGlvbiB3aGljaCB3YXJucyBvbmNlIGJ5IGRlZmF1bHQuCiAgLy8gSWYgLS1uby1kZXByZWNhdGlvbiBpcyBzZXQsIHRoZW4gaXQgaXMgYSBuby1vcC4KICBleHBvcnRzLmRlcHJlY2F0ZSA9IGZ1bmN0aW9uKGZuLCBtc2cpIHsKICAgIC8vIEFsbG93IGZvciBkZXByZWNhdGluZyB0aGluZ3MgaW4gdGhlIHByb2Nlc3Mgb2Ygc3RhcnRpbmcgdXAuCiAgICBpZiAoaXNVbmRlZmluZWQoZ2xvYmFsLnByb2Nlc3MpKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZXhwb3J0cy5kZXByZWNhdGUoZm4sIG1zZykuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KICAKICAgIGlmIChwcm9jZXNzLm5vRGVwcmVjYXRpb24gPT09IHRydWUpIHsKICAgICAgcmV0dXJuIGZuOwogICAgfQogIAogICAgdmFyIHdhcm5lZCA9IGZhbHNlOwogICAgZnVuY3Rpb24gZGVwcmVjYXRlZCgpIHsKICAgICAgaWYgKCF3YXJuZWQpIHsKICAgICAgICBpZiAocHJvY2Vzcy50aHJvd0RlcHJlY2F0aW9uKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTsKICAgICAgICB9IGVsc2UgaWYgKHByb2Nlc3MudHJhY2VEZXByZWNhdGlvbikgewogICAgICAgICAgY29uc29sZS50cmFjZShtc2cpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKG1zZyk7CiAgICAgICAgfQogICAgICAgIHdhcm5lZCA9IHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgCiAgICByZXR1cm4gZGVwcmVjYXRlZDsKICB9OwogIAogIAogIHZhciBkZWJ1Z3MgPSB7fTsKICB2YXIgZGVidWdFbnZpcm9uOwogIGV4cG9ydHMuZGVidWdsb2cgPSBmdW5jdGlvbihzZXQpIHsKICAgIGlmIChpc1VuZGVmaW5lZChkZWJ1Z0Vudmlyb24pKQogICAgICBkZWJ1Z0Vudmlyb24gPSBwcm9jZXNzLmVudi5OT0RFX0RFQlVHIHx8ICcnOwogICAgc2V0ID0gc2V0LnRvVXBwZXJDYXNlKCk7CiAgICBpZiAoIWRlYnVnc1tzZXRdKSB7CiAgICAgIGlmIChuZXcgUmVnRXhwKCdcXGInICsgc2V0ICsgJ1xcYicsICdpJykudGVzdChkZWJ1Z0Vudmlyb24pKSB7CiAgICAgICAgdmFyIHBpZCA9IHByb2Nlc3MucGlkOwogICAgICAgIGRlYnVnc1tzZXRdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgbXNnID0gZXhwb3J0cy5mb3JtYXQuYXBwbHkoZXhwb3J0cywgYXJndW1lbnRzKTsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJyVzICVkOiAlcycsIHNldCwgcGlkLCBtc2cpOwogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGVidWdzW3NldF0gPSBmdW5jdGlvbigpIHt9OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZGVidWdzW3NldF07CiAgfTsKICAKICAKICAvKioKICAgKiBFY2hvcyB0aGUgdmFsdWUgb2YgYSB2YWx1ZS4gVHJ5cyB0byBwcmludCB0aGUgdmFsdWUgb3V0CiAgICogaW4gdGhlIGJlc3Qgd2F5IHBvc3NpYmxlIGdpdmVuIHRoZSBkaWZmZXJlbnQgdHlwZXMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gcHJpbnQgb3V0LgogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzIE9wdGlvbmFsIG9wdGlvbnMgb2JqZWN0IHRoYXQgYWx0ZXJzIHRoZSBvdXRwdXQuCiAgICovCiAgLyogbGVnYWN5OiBvYmosIHNob3dIaWRkZW4sIGRlcHRoLCBjb2xvcnMqLwogIGZ1bmN0aW9uIGluc3BlY3Qob2JqLCBvcHRzKSB7CiAgICAvLyBkZWZhdWx0IG9wdGlvbnMKICAgIHZhciBjdHggPSB7CiAgICAgIHNlZW46IFtdLAogICAgICBzdHlsaXplOiBzdHlsaXplTm9Db2xvcgogICAgfTsKICAgIC8vIGxlZ2FjeS4uLgogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPj0gMykgY3R4LmRlcHRoID0gYXJndW1lbnRzWzJdOwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPj0gNCkgY3R4LmNvbG9ycyA9IGFyZ3VtZW50c1szXTsKICAgIGlmIChpc0Jvb2xlYW4ob3B0cykpIHsKICAgICAgLy8gbGVnYWN5Li4uCiAgICAgIGN0eC5zaG93SGlkZGVuID0gb3B0czsKICAgIH0gZWxzZSBpZiAob3B0cykgewogICAgICAvLyBnb3QgYW4gIm9wdGlvbnMiIG9iamVjdAogICAgICBleHBvcnRzLl9leHRlbmQoY3R4LCBvcHRzKTsKICAgIH0KICAgIC8vIHNldCBkZWZhdWx0IG9wdGlvbnMKICAgIGlmIChpc1VuZGVmaW5lZChjdHguc2hvd0hpZGRlbikpIGN0eC5zaG93SGlkZGVuID0gZmFsc2U7CiAgICBpZiAoaXNVbmRlZmluZWQoY3R4LmRlcHRoKSkgY3R4LmRlcHRoID0gMjsKICAgIGlmIChpc1VuZGVmaW5lZChjdHguY29sb3JzKSkgY3R4LmNvbG9ycyA9IGZhbHNlOwogICAgaWYgKGlzVW5kZWZpbmVkKGN0eC5jdXN0b21JbnNwZWN0KSkgY3R4LmN1c3RvbUluc3BlY3QgPSB0cnVlOwogICAgaWYgKGN0eC5jb2xvcnMpIGN0eC5zdHlsaXplID0gc3R5bGl6ZVdpdGhDb2xvcjsKICAgIHJldHVybiBmb3JtYXRWYWx1ZShjdHgsIG9iaiwgY3R4LmRlcHRoKTsKICB9CiAgZXhwb3J0cy5pbnNwZWN0ID0gaW5zcGVjdDsKICAKICAKICAvLyBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0FOU0lfZXNjYXBlX2NvZGUjZ3JhcGhpY3MKICBpbnNwZWN0LmNvbG9ycyA9IHsKICAgICdib2xkJyA6IFsxLCAyMl0sCiAgICAnaXRhbGljJyA6IFszLCAyM10sCiAgICAndW5kZXJsaW5lJyA6IFs0LCAyNF0sCiAgICAnaW52ZXJzZScgOiBbNywgMjddLAogICAgJ3doaXRlJyA6IFszNywgMzldLAogICAgJ2dyZXknIDogWzkwLCAzOV0sCiAgICAnYmxhY2snIDogWzMwLCAzOV0sCiAgICAnYmx1ZScgOiBbMzQsIDM5XSwKICAgICdjeWFuJyA6IFszNiwgMzldLAogICAgJ2dyZWVuJyA6IFszMiwgMzldLAogICAgJ21hZ2VudGEnIDogWzM1LCAzOV0sCiAgICAncmVkJyA6IFszMSwgMzldLAogICAgJ3llbGxvdycgOiBbMzMsIDM5XQogIH07CiAgCiAgLy8gRG9uJ3QgdXNlICdibHVlJyBub3QgdmlzaWJsZSBvbiBjbWQuZXhlCiAgaW5zcGVjdC5zdHlsZXMgPSB7CiAgICAnc3BlY2lhbCc6ICdjeWFuJywKICAgICdudW1iZXInOiAneWVsbG93JywKICAgICdib29sZWFuJzogJ3llbGxvdycsCiAgICAndW5kZWZpbmVkJzogJ2dyZXknLAogICAgJ251bGwnOiAnYm9sZCcsCiAgICAnc3RyaW5nJzogJ2dyZWVuJywKICAgICdkYXRlJzogJ21hZ2VudGEnLAogICAgLy8gIm5hbWUiOiBpbnRlbnRpb25hbGx5IG5vdCBzdHlsaW5nCiAgICAncmVnZXhwJzogJ3JlZCcKICB9OwogIAogIAogIGZ1bmN0aW9uIHN0eWxpemVXaXRoQ29sb3Ioc3RyLCBzdHlsZVR5cGUpIHsKICAgIHZhciBzdHlsZSA9IGluc3BlY3Quc3R5bGVzW3N0eWxlVHlwZV07CiAgCiAgICBpZiAoc3R5bGUpIHsKICAgICAgcmV0dXJuICdcdTAwMWJbJyArIGluc3BlY3QuY29sb3JzW3N0eWxlXVswXSArICdtJyArIHN0ciArCiAgICAgICAgICAgICAnXHUwMDFiWycgKyBpbnNwZWN0LmNvbG9yc1tzdHlsZV1bMV0gKyAnbSc7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gc3RyOwogICAgfQogIH0KICAKICAKICBmdW5jdGlvbiBzdHlsaXplTm9Db2xvcihzdHIsIHN0eWxlVHlwZSkgewogICAgcmV0dXJuIHN0cjsKICB9CiAgCiAgCiAgZnVuY3Rpb24gYXJyYXlUb0hhc2goYXJyYXkpIHsKICAgIHZhciBoYXNoID0ge307CiAgCiAgICBhcnJheS5mb3JFYWNoKGZ1bmN0aW9uKHZhbCwgaWR4KSB7CiAgICAgIGhhc2hbdmFsXSA9IHRydWU7CiAgICB9KTsKICAKICAgIHJldHVybiBoYXNoOwogIH0KICAKICAKICBmdW5jdGlvbiBmb3JtYXRWYWx1ZShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMpIHsKICAgIC8vIFByb3ZpZGUgYSBob29rIGZvciB1c2VyLXNwZWNpZmllZCBpbnNwZWN0IGZ1bmN0aW9ucy4KICAgIC8vIENoZWNrIHRoYXQgdmFsdWUgaXMgYW4gb2JqZWN0IHdpdGggYW4gaW5zcGVjdCBmdW5jdGlvbiBvbiBpdAogICAgaWYgKGN0eC5jdXN0b21JbnNwZWN0ICYmCiAgICAgICAgdmFsdWUgJiYKICAgICAgICBpc0Z1bmN0aW9uKHZhbHVlLmluc3BlY3QpICYmCiAgICAgICAgLy8gRmlsdGVyIG91dCB0aGUgdXRpbCBtb2R1bGUsIGl0J3MgaW5zcGVjdCBmdW5jdGlvbiBpcyBzcGVjaWFsCiAgICAgICAgdmFsdWUuaW5zcGVjdCAhPT0gZXhwb3J0cy5pbnNwZWN0ICYmCiAgICAgICAgLy8gQWxzbyBmaWx0ZXIgb3V0IGFueSBwcm90b3R5cGUgb2JqZWN0cyB1c2luZyB0aGUgY2lyY3VsYXIgY2hlY2suCiAgICAgICAgISh2YWx1ZS5jb25zdHJ1Y3RvciAmJiB2YWx1ZS5jb25zdHJ1Y3Rvci5wcm90b3R5cGUgPT09IHZhbHVlKSkgewogICAgICB2YXIgcmV0ID0gdmFsdWUuaW5zcGVjdChyZWN1cnNlVGltZXMsIGN0eCk7CiAgICAgIGlmICghaXNTdHJpbmcocmV0KSkgewogICAgICAgIHJldCA9IGZvcm1hdFZhbHVlKGN0eCwgcmV0LCByZWN1cnNlVGltZXMpOwogICAgICB9CiAgICAgIHJldHVybiByZXQ7CiAgICB9CiAgCiAgICAvLyBQcmltaXRpdmUgdHlwZXMgY2Fubm90IGhhdmUgcHJvcGVydGllcwogICAgdmFyIHByaW1pdGl2ZSA9IGZvcm1hdFByaW1pdGl2ZShjdHgsIHZhbHVlKTsKICAgIGlmIChwcmltaXRpdmUpIHsKICAgICAgcmV0dXJuIHByaW1pdGl2ZTsKICAgIH0KICAKICAgIC8vIExvb2sgdXAgdGhlIGtleXMgb2YgdGhlIG9iamVjdC4KICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXModmFsdWUpOwogICAgdmFyIHZpc2libGVLZXlzID0gYXJyYXlUb0hhc2goa2V5cyk7CiAgCiAgICBpZiAoY3R4LnNob3dIaWRkZW4pIHsKICAgICAga2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHZhbHVlKTsKICAgIH0KICAKICAgIC8vIElFIGRvZXNuJ3QgbWFrZSBlcnJvciBmaWVsZHMgbm9uLWVudW1lcmFibGUKICAgIC8vIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9pZS9kd3c1MnNidCh2PXZzLjk0KS5hc3B4CiAgICBpZiAoaXNFcnJvcih2YWx1ZSkKICAgICAgICAmJiAoa2V5cy5pbmRleE9mKCdtZXNzYWdlJykgPj0gMCB8fCBrZXlzLmluZGV4T2YoJ2Rlc2NyaXB0aW9uJykgPj0gMCkpIHsKICAgICAgcmV0dXJuIGZvcm1hdEVycm9yKHZhbHVlKTsKICAgIH0KICAKICAgIC8vIFNvbWUgdHlwZSBvZiBvYmplY3Qgd2l0aG91dCBwcm9wZXJ0aWVzIGNhbiBiZSBzaG9ydGN1dHRlZC4KICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgewogICAgICBpZiAoaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICB2YXIgbmFtZSA9IHZhbHVlLm5hbWUgPyAnOiAnICsgdmFsdWUubmFtZSA6ICcnOwogICAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgnW0Z1bmN0aW9uJyArIG5hbWUgKyAnXScsICdzcGVjaWFsJyk7CiAgICAgIH0KICAgICAgaWYgKGlzUmVnRXhwKHZhbHVlKSkgewogICAgICAgIHJldHVybiBjdHguc3R5bGl6ZShSZWdFeHAucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpLCAncmVnZXhwJyk7CiAgICAgIH0KICAgICAgaWYgKGlzRGF0ZSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gY3R4LnN0eWxpemUoRGF0ZS5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSksICdkYXRlJyk7CiAgICAgIH0KICAgICAgaWYgKGlzRXJyb3IodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIGZvcm1hdEVycm9yKHZhbHVlKTsKICAgICAgfQogICAgfQogIAogICAgdmFyIGJhc2UgPSAnJywgYXJyYXkgPSBmYWxzZSwgYnJhY2VzID0gWyd7JywgJ30nXTsKICAKICAgIC8vIE1ha2UgQXJyYXkgc2F5IHRoYXQgdGhleSBhcmUgQXJyYXkKICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICBhcnJheSA9IHRydWU7CiAgICAgIGJyYWNlcyA9IFsnWycsICddJ107CiAgICB9CiAgCiAgICAvLyBNYWtlIGZ1bmN0aW9ucyBzYXkgdGhhdCB0aGV5IGFyZSBmdW5jdGlvbnMKICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICB2YXIgbiA9IHZhbHVlLm5hbWUgPyAnOiAnICsgdmFsdWUubmFtZSA6ICcnOwogICAgICBiYXNlID0gJyBbRnVuY3Rpb24nICsgbiArICddJzsKICAgIH0KICAKICAgIC8vIE1ha2UgUmVnRXhwcyBzYXkgdGhhdCB0aGV5IGFyZSBSZWdFeHBzCiAgICBpZiAoaXNSZWdFeHAodmFsdWUpKSB7CiAgICAgIGJhc2UgPSAnICcgKyBSZWdFeHAucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpOwogICAgfQogIAogICAgLy8gTWFrZSBkYXRlcyB3aXRoIHByb3BlcnRpZXMgZmlyc3Qgc2F5IHRoZSBkYXRlCiAgICBpZiAoaXNEYXRlKHZhbHVlKSkgewogICAgICBiYXNlID0gJyAnICsgRGF0ZS5wcm90b3R5cGUudG9VVENTdHJpbmcuY2FsbCh2YWx1ZSk7CiAgICB9CiAgCiAgICAvLyBNYWtlIGVycm9yIHdpdGggbWVzc2FnZSBmaXJzdCBzYXkgdGhlIGVycm9yCiAgICBpZiAoaXNFcnJvcih2YWx1ZSkpIHsKICAgICAgYmFzZSA9ICcgJyArIGZvcm1hdEVycm9yKHZhbHVlKTsKICAgIH0KICAKICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCAmJiAoIWFycmF5IHx8IHZhbHVlLmxlbmd0aCA9PSAwKSkgewogICAgICByZXR1cm4gYnJhY2VzWzBdICsgYmFzZSArIGJyYWNlc1sxXTsKICAgIH0KICAKICAgIGlmIChyZWN1cnNlVGltZXMgPCAwKSB7CiAgICAgIGlmIChpc1JlZ0V4cCh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gY3R4LnN0eWxpemUoUmVnRXhwLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSwgJ3JlZ2V4cCcpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgnW09iamVjdF0nLCAnc3BlY2lhbCcpOwogICAgICB9CiAgICB9CiAgCiAgICBjdHguc2Vlbi5wdXNoKHZhbHVlKTsKICAKICAgIHZhciBvdXRwdXQ7CiAgICBpZiAoYXJyYXkpIHsKICAgICAgb3V0cHV0ID0gZm9ybWF0QXJyYXkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywga2V5cyk7CiAgICB9IGVsc2UgewogICAgICBvdXRwdXQgPSBrZXlzLm1hcChmdW5jdGlvbihrZXkpIHsKICAgICAgICByZXR1cm4gZm9ybWF0UHJvcGVydHkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywga2V5LCBhcnJheSk7CiAgICAgIH0pOwogICAgfQogIAogICAgY3R4LnNlZW4ucG9wKCk7CiAgCiAgICByZXR1cm4gcmVkdWNlVG9TaW5nbGVTdHJpbmcob3V0cHV0LCBiYXNlLCBicmFjZXMpOwogIH0KICAKICAKICBmdW5jdGlvbiBmb3JtYXRQcmltaXRpdmUoY3R4LCB2YWx1ZSkgewogICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkKICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKCd1bmRlZmluZWQnLCAndW5kZWZpbmVkJyk7CiAgICBpZiAoaXNTdHJpbmcodmFsdWUpKSB7CiAgICAgIHZhciBzaW1wbGUgPSAnXCcnICsgSlNPTi5zdHJpbmdpZnkodmFsdWUpLnJlcGxhY2UoL14ifCIkL2csICcnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8nL2csICJcXCciKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXCIvZywgJyInKSArICdcJyc7CiAgICAgIHJldHVybiBjdHguc3R5bGl6ZShzaW1wbGUsICdzdHJpbmcnKTsKICAgIH0KICAgIGlmIChpc051bWJlcih2YWx1ZSkpCiAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgnJyArIHZhbHVlLCAnbnVtYmVyJyk7CiAgICBpZiAoaXNCb29sZWFuKHZhbHVlKSkKICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKCcnICsgdmFsdWUsICdib29sZWFuJyk7CiAgICAvLyBGb3Igc29tZSByZWFzb24gdHlwZW9mIG51bGwgaXMgIm9iamVjdCIsIHNvIHNwZWNpYWwgY2FzZSBoZXJlLgogICAgaWYgKGlzTnVsbCh2YWx1ZSkpCiAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgnbnVsbCcsICdudWxsJyk7CiAgfQogIAogIAogIGZ1bmN0aW9uIGZvcm1hdEVycm9yKHZhbHVlKSB7CiAgICByZXR1cm4gJ1snICsgRXJyb3IucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpICsgJ10nOwogIH0KICAKICAKICBmdW5jdGlvbiBmb3JtYXRBcnJheShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLCBrZXlzKSB7CiAgICB2YXIgb3V0cHV0ID0gW107CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHZhbHVlLmxlbmd0aDsgaSA8IGw7ICsraSkgewogICAgICBpZiAoaGFzT3duUHJvcGVydHkodmFsdWUsIFN0cmluZyhpKSkpIHsKICAgICAgICBvdXRwdXQucHVzaChmb3JtYXRQcm9wZXJ0eShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLAogICAgICAgICAgICBTdHJpbmcoaSksIHRydWUpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvdXRwdXQucHVzaCgnJyk7CiAgICAgIH0KICAgIH0KICAgIGtleXMuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAgaWYgKCFrZXkubWF0Y2goL15cZCskLykpIHsKICAgICAgICBvdXRwdXQucHVzaChmb3JtYXRQcm9wZXJ0eShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLAogICAgICAgICAgICBrZXksIHRydWUpKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb3V0cHV0OwogIH0KICAKICAKICBmdW5jdGlvbiBmb3JtYXRQcm9wZXJ0eShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLCBrZXksIGFycmF5KSB7CiAgICB2YXIgbmFtZSwgc3RyLCBkZXNjOwogICAgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodmFsdWUsIGtleSkgfHwgeyB2YWx1ZTogdmFsdWVba2V5XSB9OwogICAgaWYgKGRlc2MuZ2V0KSB7CiAgICAgIGlmIChkZXNjLnNldCkgewogICAgICAgIHN0ciA9IGN0eC5zdHlsaXplKCdbR2V0dGVyL1NldHRlcl0nLCAnc3BlY2lhbCcpOwogICAgICB9IGVsc2UgewogICAgICAgIHN0ciA9IGN0eC5zdHlsaXplKCdbR2V0dGVyXScsICdzcGVjaWFsJyk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChkZXNjLnNldCkgewogICAgICAgIHN0ciA9IGN0eC5zdHlsaXplKCdbU2V0dGVyXScsICdzcGVjaWFsJyk7CiAgICAgIH0KICAgIH0KICAgIGlmICghaGFzT3duUHJvcGVydHkodmlzaWJsZUtleXMsIGtleSkpIHsKICAgICAgbmFtZSA9ICdbJyArIGtleSArICddJzsKICAgIH0KICAgIGlmICghc3RyKSB7CiAgICAgIGlmIChjdHguc2Vlbi5pbmRleE9mKGRlc2MudmFsdWUpIDwgMCkgewogICAgICAgIGlmIChpc051bGwocmVjdXJzZVRpbWVzKSkgewogICAgICAgICAgc3RyID0gZm9ybWF0VmFsdWUoY3R4LCBkZXNjLnZhbHVlLCBudWxsKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RyID0gZm9ybWF0VmFsdWUoY3R4LCBkZXNjLnZhbHVlLCByZWN1cnNlVGltZXMgLSAxKTsKICAgICAgICB9CiAgICAgICAgaWYgKHN0ci5pbmRleE9mKCdcbicpID4gLTEpIHsKICAgICAgICAgIGlmIChhcnJheSkgewogICAgICAgICAgICBzdHIgPSBzdHIuc3BsaXQoJ1xuJykubWFwKGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gJyAgJyArIGxpbmU7CiAgICAgICAgICAgIH0pLmpvaW4oJ1xuJykuc3Vic3RyKDIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RyID0gJ1xuJyArIHN0ci5zcGxpdCgnXG4nKS5tYXAoZnVuY3Rpb24obGluZSkgewogICAgICAgICAgICAgIHJldHVybiAnICAgJyArIGxpbmU7CiAgICAgICAgICAgIH0pLmpvaW4oJ1xuJyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHN0ciA9IGN0eC5zdHlsaXplKCdbQ2lyY3VsYXJdJywgJ3NwZWNpYWwnKTsKICAgICAgfQogICAgfQogICAgaWYgKGlzVW5kZWZpbmVkKG5hbWUpKSB7CiAgICAgIGlmIChhcnJheSAmJiBrZXkubWF0Y2goL15cZCskLykpIHsKICAgICAgICByZXR1cm4gc3RyOwogICAgICB9CiAgICAgIG5hbWUgPSBKU09OLnN0cmluZ2lmeSgnJyArIGtleSk7CiAgICAgIGlmIChuYW1lLm1hdGNoKC9eIihbYS16QS1aX11bYS16QS1aXzAtOV0qKSIkLykpIHsKICAgICAgICBuYW1lID0gbmFtZS5zdWJzdHIoMSwgbmFtZS5sZW5ndGggLSAyKTsKICAgICAgICBuYW1lID0gY3R4LnN0eWxpemUobmFtZSwgJ25hbWUnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKC8nL2csICJcXCciKQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcIi9nLCAnIicpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvKF4ifCIkKS9nLCAiJyIpOwogICAgICAgIG5hbWUgPSBjdHguc3R5bGl6ZShuYW1lLCAnc3RyaW5nJyk7CiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiBuYW1lICsgJzogJyArIHN0cjsKICB9CiAgCiAgCiAgZnVuY3Rpb24gcmVkdWNlVG9TaW5nbGVTdHJpbmcob3V0cHV0LCBiYXNlLCBicmFjZXMpIHsKICAgIHZhciBudW1MaW5lc0VzdCA9IDA7CiAgICB2YXIgbGVuZ3RoID0gb3V0cHV0LnJlZHVjZShmdW5jdGlvbihwcmV2LCBjdXIpIHsKICAgICAgbnVtTGluZXNFc3QrKzsKICAgICAgaWYgKGN1ci5pbmRleE9mKCdcbicpID49IDApIG51bUxpbmVzRXN0Kys7CiAgICAgIHJldHVybiBwcmV2ICsgY3VyLnJlcGxhY2UoL1x1MDAxYlxbXGRcZD9tL2csICcnKS5sZW5ndGggKyAxOwogICAgfSwgMCk7CiAgCiAgICBpZiAobGVuZ3RoID4gNjApIHsKICAgICAgcmV0dXJuIGJyYWNlc1swXSArCiAgICAgICAgICAgICAoYmFzZSA9PT0gJycgPyAnJyA6IGJhc2UgKyAnXG4gJykgKwogICAgICAgICAgICAgJyAnICsKICAgICAgICAgICAgIG91dHB1dC5qb2luKCcsXG4gICcpICsKICAgICAgICAgICAgICcgJyArCiAgICAgICAgICAgICBicmFjZXNbMV07CiAgICB9CiAgCiAgICByZXR1cm4gYnJhY2VzWzBdICsgYmFzZSArICcgJyArIG91dHB1dC5qb2luKCcsICcpICsgJyAnICsgYnJhY2VzWzFdOwogIH0KICAKICAKICAvLyBOT1RFOiBUaGVzZSB0eXBlIGNoZWNraW5nIGZ1bmN0aW9ucyBpbnRlbnRpb25hbGx5IGRvbid0IHVzZSBgaW5zdGFuY2VvZmAKICAvLyBiZWNhdXNlIGl0IGlzIGZyYWdpbGUgYW5kIGNhbiBiZSBlYXNpbHkgZmFrZWQgd2l0aCBgT2JqZWN0LmNyZWF0ZSgpYC4KICBmdW5jdGlvbiBpc0FycmF5KGFyKSB7CiAgICByZXR1cm4gQXJyYXkuaXNBcnJheShhcik7CiAgfQogIGV4cG9ydHMuaXNBcnJheSA9IGlzQXJyYXk7CiAgCiAgZnVuY3Rpb24gaXNCb29sZWFuKGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdib29sZWFuJzsKICB9CiAgZXhwb3J0cy5pc0Jvb2xlYW4gPSBpc0Jvb2xlYW47CiAgCiAgZnVuY3Rpb24gaXNOdWxsKGFyZykgewogICAgcmV0dXJuIGFyZyA9PT0gbnVsbDsKICB9CiAgZXhwb3J0cy5pc051bGwgPSBpc051bGw7CiAgCiAgZnVuY3Rpb24gaXNOdWxsT3JVbmRlZmluZWQoYXJnKSB7CiAgICByZXR1cm4gYXJnID09IG51bGw7CiAgfQogIGV4cG9ydHMuaXNOdWxsT3JVbmRlZmluZWQgPSBpc051bGxPclVuZGVmaW5lZDsKICAKICBmdW5jdGlvbiBpc051bWJlcihhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnbnVtYmVyJzsKICB9CiAgZXhwb3J0cy5pc051bWJlciA9IGlzTnVtYmVyOwogIAogIGZ1bmN0aW9uIGlzU3RyaW5nKGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdzdHJpbmcnOwogIH0KICBleHBvcnRzLmlzU3RyaW5nID0gaXNTdHJpbmc7CiAgCiAgZnVuY3Rpb24gaXNTeW1ib2woYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ3N5bWJvbCc7CiAgfQogIGV4cG9ydHMuaXNTeW1ib2wgPSBpc1N5bWJvbDsKICAKICBmdW5jdGlvbiBpc1VuZGVmaW5lZChhcmcpIHsKICAgIHJldHVybiBhcmcgPT09IHZvaWQgMDsKICB9CiAgZXhwb3J0cy5pc1VuZGVmaW5lZCA9IGlzVW5kZWZpbmVkOwogIAogIGZ1bmN0aW9uIGlzUmVnRXhwKHJlKSB7CiAgICByZXR1cm4gaXNPYmplY3QocmUpICYmIG9iamVjdFRvU3RyaW5nKHJlKSA9PT0gJ1tvYmplY3QgUmVnRXhwXSc7CiAgfQogIGV4cG9ydHMuaXNSZWdFeHAgPSBpc1JlZ0V4cDsKICAKICBmdW5jdGlvbiBpc09iamVjdChhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JyAmJiBhcmcgIT09IG51bGw7CiAgfQogIGV4cG9ydHMuaXNPYmplY3QgPSBpc09iamVjdDsKICAKICBmdW5jdGlvbiBpc0RhdGUoZCkgewogICAgcmV0dXJuIGlzT2JqZWN0KGQpICYmIG9iamVjdFRvU3RyaW5nKGQpID09PSAnW29iamVjdCBEYXRlXSc7CiAgfQogIGV4cG9ydHMuaXNEYXRlID0gaXNEYXRlOwogIAogIGZ1bmN0aW9uIGlzRXJyb3IoZSkgewogICAgcmV0dXJuIGlzT2JqZWN0KGUpICYmCiAgICAgICAgKG9iamVjdFRvU3RyaW5nKGUpID09PSAnW29iamVjdCBFcnJvcl0nIHx8IGUgaW5zdGFuY2VvZiBFcnJvcik7CiAgfQogIGV4cG9ydHMuaXNFcnJvciA9IGlzRXJyb3I7CiAgCiAgZnVuY3Rpb24gaXNGdW5jdGlvbihhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnZnVuY3Rpb24nOwogIH0KICBleHBvcnRzLmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uOwogIAogIGZ1bmN0aW9uIGlzUHJpbWl0aXZlKGFyZykgewogICAgcmV0dXJuIGFyZyA9PT0gbnVsbCB8fAogICAgICAgICAgIHR5cGVvZiBhcmcgPT09ICdib29sZWFuJyB8fAogICAgICAgICAgIHR5cGVvZiBhcmcgPT09ICdudW1iZXInIHx8CiAgICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ3N0cmluZycgfHwKICAgICAgICAgICB0eXBlb2YgYXJnID09PSAnc3ltYm9sJyB8fCAgLy8gRVM2IHN5bWJvbAogICAgICAgICAgIHR5cGVvZiBhcmcgPT09ICd1bmRlZmluZWQnOwogIH0KICBleHBvcnRzLmlzUHJpbWl0aXZlID0gaXNQcmltaXRpdmU7CiAgCiAgZXhwb3J0cy5pc0J1ZmZlciA9IHJlcXVpcmUoJy4vc3VwcG9ydC9pc0J1ZmZlcicpOwogIAogIGZ1bmN0aW9uIG9iamVjdFRvU3RyaW5nKG8pIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobyk7CiAgfQogIAogIAogIGZ1bmN0aW9uIHBhZChuKSB7CiAgICByZXR1cm4gbiA8IDEwID8gJzAnICsgbi50b1N0cmluZygxMCkgOiBuLnRvU3RyaW5nKDEwKTsKICB9CiAgCiAgCiAgdmFyIG1vbnRocyA9IFsnSmFuJywgJ0ZlYicsICdNYXInLCAnQXByJywgJ01heScsICdKdW4nLCAnSnVsJywgJ0F1ZycsICdTZXAnLAogICAgICAgICAgICAgICAgJ09jdCcsICdOb3YnLCAnRGVjJ107CiAgCiAgLy8gMjYgRmViIDE2OjE5OjM0CiAgZnVuY3Rpb24gdGltZXN0YW1wKCkgewogICAgdmFyIGQgPSBuZXcgRGF0ZSgpOwogICAgdmFyIHRpbWUgPSBbcGFkKGQuZ2V0SG91cnMoKSksCiAgICAgICAgICAgICAgICBwYWQoZC5nZXRNaW51dGVzKCkpLAogICAgICAgICAgICAgICAgcGFkKGQuZ2V0U2Vjb25kcygpKV0uam9pbignOicpOwogICAgcmV0dXJuIFtkLmdldERhdGUoKSwgbW9udGhzW2QuZ2V0TW9udGgoKV0sIHRpbWVdLmpvaW4oJyAnKTsKICB9CiAgCiAgCiAgLy8gbG9nIGlzIGp1c3QgYSB0aGluIHdyYXBwZXIgdG8gY29uc29sZS5sb2cgdGhhdCBwcmVwZW5kcyBhIHRpbWVzdGFtcAogIGV4cG9ydHMubG9nID0gZnVuY3Rpb24oKSB7CiAgICBjb25zb2xlLmxvZygnJXMgLSAlcycsIHRpbWVzdGFtcCgpLCBleHBvcnRzLmZvcm1hdC5hcHBseShleHBvcnRzLCBhcmd1bWVudHMpKTsKICB9OwogIAogIAogIC8qKgogICAqIEluaGVyaXQgdGhlIHByb3RvdHlwZSBtZXRob2RzIGZyb20gb25lIGNvbnN0cnVjdG9yIGludG8gYW5vdGhlci4KICAgKgogICAqIFRoZSBGdW5jdGlvbi5wcm90b3R5cGUuaW5oZXJpdHMgZnJvbSBsYW5nLmpzIHJld3JpdHRlbiBhcyBhIHN0YW5kYWxvbmUKICAgKiBmdW5jdGlvbiAobm90IG9uIEZ1bmN0aW9uLnByb3RvdHlwZSkuIE5PVEU6IElmIHRoaXMgZmlsZSBpcyB0byBiZSBsb2FkZWQKICAgKiBkdXJpbmcgYm9vdHN0cmFwcGluZyB0aGlzIGZ1bmN0aW9uIG5lZWRzIHRvIGJlIHJld3JpdHRlbiB1c2luZyBzb21lIG5hdGl2ZQogICAqIGZ1bmN0aW9ucyBhcyBwcm90b3R5cGUgc2V0dXAgdXNpbmcgbm9ybWFsIEphdmFTY3JpcHQgZG9lcyBub3Qgd29yayBhcwogICAqIGV4cGVjdGVkIGR1cmluZyBib290c3RyYXBwaW5nIChzZWUgbWlycm9yLmpzIGluIHIxMTQ5MDMpLgogICAqCiAgICogQHBhcmFtIHtmdW5jdGlvbn0gY3RvciBDb25zdHJ1Y3RvciBmdW5jdGlvbiB3aGljaCBuZWVkcyB0byBpbmhlcml0IHRoZQogICAqICAgICBwcm90b3R5cGUuCiAgICogQHBhcmFtIHtmdW5jdGlvbn0gc3VwZXJDdG9yIENvbnN0cnVjdG9yIGZ1bmN0aW9uIHRvIGluaGVyaXQgcHJvdG90eXBlIGZyb20uCiAgICovCiAgZXhwb3J0cy5pbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CiAgCiAgZXhwb3J0cy5fZXh0ZW5kID0gZnVuY3Rpb24ob3JpZ2luLCBhZGQpIHsKICAgIC8vIERvbid0IGRvIGFueXRoaW5nIGlmIGFkZCBpc24ndCBhbiBvYmplY3QKICAgIGlmICghYWRkIHx8ICFpc09iamVjdChhZGQpKSByZXR1cm4gb3JpZ2luOwogIAogICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhhZGQpOwogICAgdmFyIGkgPSBrZXlzLmxlbmd0aDsKICAgIHdoaWxlIChpLS0pIHsKICAgICAgb3JpZ2luW2tleXNbaV1dID0gYWRkW2tleXNbaV1dOwogICAgfQogICAgcmV0dXJuIG9yaWdpbjsKICB9OwogIAogIGZ1bmN0aW9uIGhhc093blByb3BlcnR5KG9iaiwgcHJvcCkgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApOwogIH0KICAKICB9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSx0eXBlb2YgZ2xvYmFsICE9PSAidW5kZWZpbmVkIiA/IGdsb2JhbCA6IHR5cGVvZiBzZWxmICE9PSAidW5kZWZpbmVkIiA/IHNlbGYgOiB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiA/IHdpbmRvdyA6IHt9KQogIH0seyIuL3N1cHBvcnQvaXNCdWZmZXIiOjk2LCJfcHJvY2VzcyI6ODUsImluaGVyaXRzIjo5NX1dLDk4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdjEgPSByZXF1aXJlKCcuL3YxJyk7CiAgdmFyIHY0ID0gcmVxdWlyZSgnLi92NCcpOwogIAogIHZhciB1dWlkID0gdjQ7CiAgdXVpZC52MSA9IHYxOwogIHV1aWQudjQgPSB2NDsKICAKICBtb2R1bGUuZXhwb3J0cyA9IHV1aWQ7CiAgCiAgfSx7Ii4vdjEiOjEwMSwiLi92NCI6MTAyfV0sOTk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8qKgogICAqIENvbnZlcnQgYXJyYXkgb2YgMTYgYnl0ZSB2YWx1ZXMgdG8gVVVJRCBzdHJpbmcgZm9ybWF0IG9mIHRoZSBmb3JtOgogICAqIFhYWFhYWFhYLVhYWFgtWFhYWC1YWFhYLVhYWFhYWFhYWFhYWAogICAqLwogIHZhciBieXRlVG9IZXggPSBbXTsKICBmb3IgKHZhciBpID0gMDsgaSA8IDI1NjsgKytpKSB7CiAgICBieXRlVG9IZXhbaV0gPSAoaSArIDB4MTAwKS50b1N0cmluZygxNikuc3Vic3RyKDEpOwogIH0KICAKICBmdW5jdGlvbiBieXRlc1RvVXVpZChidWYsIG9mZnNldCkgewogICAgdmFyIGkgPSBvZmZzZXQgfHwgMDsKICAgIHZhciBidGggPSBieXRlVG9IZXg7CiAgICAvLyBqb2luIHVzZWQgdG8gZml4IG1lbW9yeSBpc3N1ZSBjYXVzZWQgYnkgY29uY2F0ZW5hdGlvbjogaHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL3Y4L2lzc3Vlcy9kZXRhaWw/aWQ9MzE3NSNjNAogICAgcmV0dXJuIChbYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgCiAgICBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLCAnLScsCiAgICBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLCAnLScsCiAgICBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLCAnLScsCiAgICBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLCAnLScsCiAgICBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwKICAgIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV1dKS5qb2luKCcnKTsKICB9CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSBieXRlc1RvVXVpZDsKICAKICB9LHt9XSwxMDA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIFVuaXF1ZSBJRCBjcmVhdGlvbiByZXF1aXJlcyBhIGhpZ2ggcXVhbGl0eSByYW5kb20gIyBnZW5lcmF0b3IuICBJbiB0aGUKICAvLyBicm93c2VyIHRoaXMgaXMgYSBsaXR0bGUgY29tcGxpY2F0ZWQgZHVlIHRvIHVua25vd24gcXVhbGl0eSBvZiBNYXRoLnJhbmRvbSgpCiAgLy8gYW5kIGluY29uc2lzdGVudCBzdXBwb3J0IGZvciB0aGUgYGNyeXB0b2AgQVBJLiAgV2UgZG8gdGhlIGJlc3Qgd2UgY2FuIHZpYQogIC8vIGZlYXR1cmUtZGV0ZWN0aW9uCiAgCiAgLy8gZ2V0UmFuZG9tVmFsdWVzIG5lZWRzIHRvIGJlIGludm9rZWQgaW4gYSBjb250ZXh0IHdoZXJlICJ0aGlzIiBpcyBhIENyeXB0bwogIC8vIGltcGxlbWVudGF0aW9uLiBBbHNvLCBmaW5kIHRoZSBjb21wbGV0ZSBpbXBsZW1lbnRhdGlvbiBvZiBjcnlwdG8gb24gSUUxMS4KICB2YXIgZ2V0UmFuZG9tVmFsdWVzID0gKHR5cGVvZihjcnlwdG8pICE9ICd1bmRlZmluZWQnICYmIGNyeXB0by5nZXRSYW5kb21WYWx1ZXMgJiYgY3J5cHRvLmdldFJhbmRvbVZhbHVlcy5iaW5kKGNyeXB0bykpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICh0eXBlb2YobXNDcnlwdG8pICE9ICd1bmRlZmluZWQnICYmIHR5cGVvZiB3aW5kb3cubXNDcnlwdG8uZ2V0UmFuZG9tVmFsdWVzID09ICdmdW5jdGlvbicgJiYgbXNDcnlwdG8uZ2V0UmFuZG9tVmFsdWVzLmJpbmQobXNDcnlwdG8pKTsKICAKICBpZiAoZ2V0UmFuZG9tVmFsdWVzKSB7CiAgICAvLyBXSEFUV0cgY3J5cHRvIFJORyAtIGh0dHA6Ly93aWtpLndoYXR3Zy5vcmcvd2lraS9DcnlwdG8KICAgIHZhciBybmRzOCA9IG5ldyBVaW50OEFycmF5KDE2KTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby11bmRlZgogIAogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiB3aGF0d2dSTkcoKSB7CiAgICAgIGdldFJhbmRvbVZhbHVlcyhybmRzOCk7CiAgICAgIHJldHVybiBybmRzODsKICAgIH07CiAgfSBlbHNlIHsKICAgIC8vIE1hdGgucmFuZG9tKCktYmFzZWQgKFJORykKICAgIC8vCiAgICAvLyBJZiBhbGwgZWxzZSBmYWlscywgdXNlIE1hdGgucmFuZG9tKCkuICBJdCdzIGZhc3QsIGJ1dCBpcyBvZiB1bnNwZWNpZmllZAogICAgLy8gcXVhbGl0eS4KICAgIHZhciBybmRzID0gbmV3IEFycmF5KDE2KTsKICAKICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gbWF0aFJORygpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIHI7IGkgPCAxNjsgaSsrKSB7CiAgICAgICAgaWYgKChpICYgMHgwMykgPT09IDApIHIgPSBNYXRoLnJhbmRvbSgpICogMHgxMDAwMDAwMDA7CiAgICAgICAgcm5kc1tpXSA9IHIgPj4+ICgoaSAmIDB4MDMpIDw8IDMpICYgMHhmZjsKICAgICAgfQogIAogICAgICByZXR1cm4gcm5kczsKICAgIH07CiAgfQogIAogIH0se31dLDEwMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHJuZyA9IHJlcXVpcmUoJy4vbGliL3JuZycpOwogIHZhciBieXRlc1RvVXVpZCA9IHJlcXVpcmUoJy4vbGliL2J5dGVzVG9VdWlkJyk7CiAgCiAgLy8gKipgdjEoKWAgLSBHZW5lcmF0ZSB0aW1lLWJhc2VkIFVVSUQqKgogIC8vCiAgLy8gSW5zcGlyZWQgYnkgaHR0cHM6Ly9naXRodWIuY29tL0xpb3NLL1VVSUQuanMKICAvLyBhbmQgaHR0cDovL2RvY3MucHl0aG9uLm9yZy9saWJyYXJ5L3V1aWQuaHRtbAogIAogIHZhciBfbm9kZUlkOwogIHZhciBfY2xvY2tzZXE7CiAgCiAgLy8gUHJldmlvdXMgdXVpZCBjcmVhdGlvbiB0aW1lCiAgdmFyIF9sYXN0TVNlY3MgPSAwOwogIHZhciBfbGFzdE5TZWNzID0gMDsKICAKICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2Jyb29mYS9ub2RlLXV1aWQgZm9yIEFQSSBkZXRhaWxzCiAgZnVuY3Rpb24gdjEob3B0aW9ucywgYnVmLCBvZmZzZXQpIHsKICAgIHZhciBpID0gYnVmICYmIG9mZnNldCB8fCAwOwogICAgdmFyIGIgPSBidWYgfHwgW107CiAgCiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHZhciBub2RlID0gb3B0aW9ucy5ub2RlIHx8IF9ub2RlSWQ7CiAgICB2YXIgY2xvY2tzZXEgPSBvcHRpb25zLmNsb2Nrc2VxICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNsb2Nrc2VxIDogX2Nsb2Nrc2VxOwogIAogICAgLy8gbm9kZSBhbmQgY2xvY2tzZXEgbmVlZCB0byBiZSBpbml0aWFsaXplZCB0byByYW5kb20gdmFsdWVzIGlmIHRoZXkncmUgbm90CiAgICAvLyBzcGVjaWZpZWQuICBXZSBkbyB0aGlzIGxhemlseSB0byBtaW5pbWl6ZSBpc3N1ZXMgcmVsYXRlZCB0byBpbnN1ZmZpY2llbnQKICAgIC8vIHN5c3RlbSBlbnRyb3B5LiAgU2VlICMxODkKICAgIGlmIChub2RlID09IG51bGwgfHwgY2xvY2tzZXEgPT0gbnVsbCkgewogICAgICB2YXIgc2VlZEJ5dGVzID0gcm5nKCk7CiAgICAgIGlmIChub2RlID09IG51bGwpIHsKICAgICAgICAvLyBQZXIgNC41LCBjcmVhdGUgYW5kIDQ4LWJpdCBub2RlIGlkLCAoNDcgcmFuZG9tIGJpdHMgKyBtdWx0aWNhc3QgYml0ID0gMSkKICAgICAgICBub2RlID0gX25vZGVJZCA9IFsKICAgICAgICAgIHNlZWRCeXRlc1swXSB8IDB4MDEsCiAgICAgICAgICBzZWVkQnl0ZXNbMV0sIHNlZWRCeXRlc1syXSwgc2VlZEJ5dGVzWzNdLCBzZWVkQnl0ZXNbNF0sIHNlZWRCeXRlc1s1XQogICAgICAgIF07CiAgICAgIH0KICAgICAgaWYgKGNsb2Nrc2VxID09IG51bGwpIHsKICAgICAgICAvLyBQZXIgNC4yLjIsIHJhbmRvbWl6ZSAoMTQgYml0KSBjbG9ja3NlcQogICAgICAgIGNsb2Nrc2VxID0gX2Nsb2Nrc2VxID0gKHNlZWRCeXRlc1s2XSA8PCA4IHwgc2VlZEJ5dGVzWzddKSAmIDB4M2ZmZjsKICAgICAgfQogICAgfQogIAogICAgLy8gVVVJRCB0aW1lc3RhbXBzIGFyZSAxMDAgbmFuby1zZWNvbmQgdW5pdHMgc2luY2UgdGhlIEdyZWdvcmlhbiBlcG9jaCwKICAgIC8vICgxNTgyLTEwLTE1IDAwOjAwKS4gIEpTTnVtYmVycyBhcmVuJ3QgcHJlY2lzZSBlbm91Z2ggZm9yIHRoaXMsIHNvCiAgICAvLyB0aW1lIGlzIGhhbmRsZWQgaW50ZXJuYWxseSBhcyAnbXNlY3MnIChpbnRlZ2VyIG1pbGxpc2Vjb25kcykgYW5kICduc2VjcycKICAgIC8vICgxMDAtbmFub3NlY29uZHMgb2Zmc2V0IGZyb20gbXNlY3MpIHNpbmNlIHVuaXggZXBvY2gsIDE5NzAtMDEtMDEgMDA6MDAuCiAgICB2YXIgbXNlY3MgPSBvcHRpb25zLm1zZWNzICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLm1zZWNzIDogbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgCiAgICAvLyBQZXIgNC4yLjEuMiwgdXNlIGNvdW50IG9mIHV1aWQncyBnZW5lcmF0ZWQgZHVyaW5nIHRoZSBjdXJyZW50IGNsb2NrCiAgICAvLyBjeWNsZSB0byBzaW11bGF0ZSBoaWdoZXIgcmVzb2x1dGlvbiBjbG9jawogICAgdmFyIG5zZWNzID0gb3B0aW9ucy5uc2VjcyAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5uc2VjcyA6IF9sYXN0TlNlY3MgKyAxOwogIAogICAgLy8gVGltZSBzaW5jZSBsYXN0IHV1aWQgY3JlYXRpb24gKGluIG1zZWNzKQogICAgdmFyIGR0ID0gKG1zZWNzIC0gX2xhc3RNU2VjcykgKyAobnNlY3MgLSBfbGFzdE5TZWNzKS8xMDAwMDsKICAKICAgIC8vIFBlciA0LjIuMS4yLCBCdW1wIGNsb2Nrc2VxIG9uIGNsb2NrIHJlZ3Jlc3Npb24KICAgIGlmIChkdCA8IDAgJiYgb3B0aW9ucy5jbG9ja3NlcSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGNsb2Nrc2VxID0gY2xvY2tzZXEgKyAxICYgMHgzZmZmOwogICAgfQogIAogICAgLy8gUmVzZXQgbnNlY3MgaWYgY2xvY2sgcmVncmVzc2VzIChuZXcgY2xvY2tzZXEpIG9yIHdlJ3ZlIG1vdmVkIG9udG8gYSBuZXcKICAgIC8vIHRpbWUgaW50ZXJ2YWwKICAgIGlmICgoZHQgPCAwIHx8IG1zZWNzID4gX2xhc3RNU2VjcykgJiYgb3B0aW9ucy5uc2VjcyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIG5zZWNzID0gMDsKICAgIH0KICAKICAgIC8vIFBlciA0LjIuMS4yIFRocm93IGVycm9yIGlmIHRvbyBtYW55IHV1aWRzIGFyZSByZXF1ZXN0ZWQKICAgIGlmIChuc2VjcyA+PSAxMDAwMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ3V1aWQudjEoKTogQ2FuXCd0IGNyZWF0ZSBtb3JlIHRoYW4gMTBNIHV1aWRzL3NlYycpOwogICAgfQogIAogICAgX2xhc3RNU2VjcyA9IG1zZWNzOwogICAgX2xhc3ROU2VjcyA9IG5zZWNzOwogICAgX2Nsb2Nrc2VxID0gY2xvY2tzZXE7CiAgCiAgICAvLyBQZXIgNC4xLjQgLSBDb252ZXJ0IGZyb20gdW5peCBlcG9jaCB0byBHcmVnb3JpYW4gZXBvY2gKICAgIG1zZWNzICs9IDEyMjE5MjkyODAwMDAwOwogIAogICAgLy8gYHRpbWVfbG93YAogICAgdmFyIHRsID0gKChtc2VjcyAmIDB4ZmZmZmZmZikgKiAxMDAwMCArIG5zZWNzKSAlIDB4MTAwMDAwMDAwOwogICAgYltpKytdID0gdGwgPj4+IDI0ICYgMHhmZjsKICAgIGJbaSsrXSA9IHRsID4+PiAxNiAmIDB4ZmY7CiAgICBiW2krK10gPSB0bCA+Pj4gOCAmIDB4ZmY7CiAgICBiW2krK10gPSB0bCAmIDB4ZmY7CiAgCiAgICAvLyBgdGltZV9taWRgCiAgICB2YXIgdG1oID0gKG1zZWNzIC8gMHgxMDAwMDAwMDAgKiAxMDAwMCkgJiAweGZmZmZmZmY7CiAgICBiW2krK10gPSB0bWggPj4+IDggJiAweGZmOwogICAgYltpKytdID0gdG1oICYgMHhmZjsKICAKICAgIC8vIGB0aW1lX2hpZ2hfYW5kX3ZlcnNpb25gCiAgICBiW2krK10gPSB0bWggPj4+IDI0ICYgMHhmIHwgMHgxMDsgLy8gaW5jbHVkZSB2ZXJzaW9uCiAgICBiW2krK10gPSB0bWggPj4+IDE2ICYgMHhmZjsKICAKICAgIC8vIGBjbG9ja19zZXFfaGlfYW5kX3Jlc2VydmVkYCAoUGVyIDQuMi4yIC0gaW5jbHVkZSB2YXJpYW50KQogICAgYltpKytdID0gY2xvY2tzZXEgPj4+IDggfCAweDgwOwogIAogICAgLy8gYGNsb2NrX3NlcV9sb3dgCiAgICBiW2krK10gPSBjbG9ja3NlcSAmIDB4ZmY7CiAgCiAgICAvLyBgbm9kZWAKICAgIGZvciAodmFyIG4gPSAwOyBuIDwgNjsgKytuKSB7CiAgICAgIGJbaSArIG5dID0gbm9kZVtuXTsKICAgIH0KICAKICAgIHJldHVybiBidWYgPyBidWYgOiBieXRlc1RvVXVpZChiKTsKICB9CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSB2MTsKICAKICB9LHsiLi9saWIvYnl0ZXNUb1V1aWQiOjk5LCIuL2xpYi9ybmciOjEwMH1dLDEwMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHJuZyA9IHJlcXVpcmUoJy4vbGliL3JuZycpOwogIHZhciBieXRlc1RvVXVpZCA9IHJlcXVpcmUoJy4vbGliL2J5dGVzVG9VdWlkJyk7CiAgCiAgZnVuY3Rpb24gdjQob3B0aW9ucywgYnVmLCBvZmZzZXQpIHsKICAgIHZhciBpID0gYnVmICYmIG9mZnNldCB8fCAwOwogIAogICAgaWYgKHR5cGVvZihvcHRpb25zKSA9PSAnc3RyaW5nJykgewogICAgICBidWYgPSBvcHRpb25zID09PSAnYmluYXJ5JyA/IG5ldyBBcnJheSgxNikgOiBudWxsOwogICAgICBvcHRpb25zID0gbnVsbDsKICAgIH0KICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIAogICAgdmFyIHJuZHMgPSBvcHRpb25zLnJhbmRvbSB8fCAob3B0aW9ucy5ybmcgfHwgcm5nKSgpOwogIAogICAgLy8gUGVyIDQuNCwgc2V0IGJpdHMgZm9yIHZlcnNpb24gYW5kIGBjbG9ja19zZXFfaGlfYW5kX3Jlc2VydmVkYAogICAgcm5kc1s2XSA9IChybmRzWzZdICYgMHgwZikgfCAweDQwOwogICAgcm5kc1s4XSA9IChybmRzWzhdICYgMHgzZikgfCAweDgwOwogIAogICAgLy8gQ29weSBieXRlcyB0byBidWZmZXIsIGlmIHByb3ZpZGVkCiAgICBpZiAoYnVmKSB7CiAgICAgIGZvciAodmFyIGlpID0gMDsgaWkgPCAxNjsgKytpaSkgewogICAgICAgIGJ1ZltpICsgaWldID0gcm5kc1tpaV07CiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiBidWYgfHwgYnl0ZXNUb1V1aWQocm5kcyk7CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gdjQ7CiAgCiAgfSx7Ii4vbGliL2J5dGVzVG9VdWlkIjo5OSwiLi9saWIvcm5nIjoxMDB9XSwxMDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogICJ1c2Ugc3RyaWN0IjsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOwogIHZhciBMUlVfMSA9IHJlcXVpcmUoIi4vdXRpbHMvTFJVIik7CiAgdmFyIENBQ0hFX1NJWkUgPSAxMDAwOwogIC8qKgogICAqIEluc3BpcmVkIG5vZGUtbHJ1LWNhY2hlW2h0dHBzOi8vZ2l0aHViLmNvbS9pc2FhY3Mvbm9kZS1scnUtY2FjaGVdCiAgICovCiAgdmFyIEVuZHBvaW50Q2FjaGUgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7CiAgICAgIGZ1bmN0aW9uIEVuZHBvaW50Q2FjaGUobWF4U2l6ZSkgewogICAgICAgICAgaWYgKG1heFNpemUgPT09IHZvaWQgMCkgeyBtYXhTaXplID0gQ0FDSEVfU0laRTsgfQogICAgICAgICAgdGhpcy5tYXhTaXplID0gbWF4U2l6ZTsKICAgICAgICAgIHRoaXMuY2FjaGUgPSBuZXcgTFJVXzEuTFJVQ2FjaGUobWF4U2l6ZSk7CiAgICAgIH0KICAgICAgOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUsICJzaXplIiwgewogICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2FjaGUubGVuZ3RoOwogICAgICAgICAgfSwKICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgfSk7CiAgICAgIEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLnB1dCA9IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgdmFyIGtleVN0cmluZyA9IHR5cGVvZiBrZXkgIT09ICdzdHJpbmcnID8gRW5kcG9pbnRDYWNoZS5nZXRLZXlTdHJpbmcoa2V5KSA6IGtleTsKICAgICAgICAgIHZhciBlbmRwb2ludFJlY29yZCA9IHRoaXMucG9wdWxhdGVWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICB0aGlzLmNhY2hlLnB1dChrZXlTdHJpbmcsIGVuZHBvaW50UmVjb3JkKTsKICAgICAgfTsKICAgICAgRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKGtleSkgewogICAgICAgIHZhciBrZXlTdHJpbmcgPSB0eXBlb2Yga2V5ICE9PSAnc3RyaW5nJyA/IEVuZHBvaW50Q2FjaGUuZ2V0S2V5U3RyaW5nKGtleSkgOiBrZXk7CiAgICAgICAgICB2YXIgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgICAgIHZhciByZWNvcmRzID0gdGhpcy5jYWNoZS5nZXQoa2V5U3RyaW5nKTsKICAgICAgICAgIGlmIChyZWNvcmRzKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWNvcmRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHZhciByZWNvcmQgPSByZWNvcmRzW2ldOwogICAgICAgICAgICAgICAgICBpZiAocmVjb3JkLkV4cGlyZSA8IG5vdykgewogICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYWNoZS5yZW1vdmUoa2V5U3RyaW5nKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVjb3JkczsKICAgICAgfTsKICAgICAgRW5kcG9pbnRDYWNoZS5nZXRLZXlTdHJpbmcgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICB2YXIgaWRlbnRpZmllcnMgPSBbXTsKICAgICAgICAgIHZhciBpZGVudGlmaWVyTmFtZXMgPSBPYmplY3Qua2V5cyhrZXkpLnNvcnQoKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaWRlbnRpZmllck5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGlkZW50aWZpZXJOYW1lID0gaWRlbnRpZmllck5hbWVzW2ldOwogICAgICAgICAgICAgIGlmIChrZXlbaWRlbnRpZmllck5hbWVdID09PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIGlkZW50aWZpZXJzLnB1c2goa2V5W2lkZW50aWZpZXJOYW1lXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaWRlbnRpZmllcnMuam9pbignICcpOwogICAgICB9OwogICAgICBFbmRwb2ludENhY2hlLnByb3RvdHlwZS5wb3B1bGF0ZVZhbHVlID0gZnVuY3Rpb24gKGVuZHBvaW50cykgewogICAgICAgICAgdmFyIG5vdyA9IERhdGUubm93KCk7CiAgICAgICAgICByZXR1cm4gZW5kcG9pbnRzLm1hcChmdW5jdGlvbiAoZW5kcG9pbnQpIHsgcmV0dXJuICh7CiAgICAgICAgICAgICAgQWRkcmVzczogZW5kcG9pbnQuQWRkcmVzcyB8fCAnJywKICAgICAgICAgICAgICBFeHBpcmU6IG5vdyArIChlbmRwb2ludC5DYWNoZVBlcmlvZEluTWludXRlcyB8fCAxKSAqIDYwICogMTAwMAogICAgICAgICAgfSk7IH0pOwogICAgICB9OwogICAgICBFbmRwb2ludENhY2hlLnByb3RvdHlwZS5lbXB0eSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHRoaXMuY2FjaGUuZW1wdHkoKTsKICAgICAgfTsKICAgICAgRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUucmVtb3ZlID0gZnVuY3Rpb24gKGtleSkgewogICAgICAgIHZhciBrZXlTdHJpbmcgPSB0eXBlb2Yga2V5ICE9PSAnc3RyaW5nJyA/IEVuZHBvaW50Q2FjaGUuZ2V0S2V5U3RyaW5nKGtleSkgOiBrZXk7CiAgICAgICAgICB0aGlzLmNhY2hlLnJlbW92ZShrZXlTdHJpbmcpOwogICAgICB9OwogICAgICByZXR1cm4gRW5kcG9pbnRDYWNoZTsKICB9KCkpOwogIGV4cG9ydHMuRW5kcG9pbnRDYWNoZSA9IEVuZHBvaW50Q2FjaGU7CiAgfSx7Ii4vdXRpbHMvTFJVIjoxMDR9XSwxMDQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogICJ1c2Ugc3RyaWN0IjsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOwogIHZhciBMaW5rZWRMaXN0Tm9kZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsKICAgICAgZnVuY3Rpb24gTGlua2VkTGlzdE5vZGUoa2V5LCB2YWx1ZSkgewogICAgICAgICAgdGhpcy5rZXkgPSBrZXk7CiAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIExpbmtlZExpc3ROb2RlOwogIH0oKSk7CiAgdmFyIExSVUNhY2hlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgewogICAgICBmdW5jdGlvbiBMUlVDYWNoZShzaXplKSB7CiAgICAgICAgICB0aGlzLm5vZGVNYXAgPSB7fTsKICAgICAgICAgIHRoaXMuc2l6ZSA9IDA7CiAgICAgICAgICBpZiAodHlwZW9mIHNpemUgIT09ICdudW1iZXInIHx8IHNpemUgPCAxKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYWNoZSBzaXplIGNhbiBvbmx5IGJlIHBvc2l0aXZlIG51bWJlcicpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5zaXplTGltaXQgPSBzaXplOwogICAgICB9CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShMUlVDYWNoZS5wcm90b3R5cGUsICJsZW5ndGgiLCB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zaXplOwogICAgICAgICAgfSwKICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgfSk7CiAgICAgIExSVUNhY2hlLnByb3RvdHlwZS5wcmVwZW5kVG9MaXN0ID0gZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICAgIGlmICghdGhpcy5oZWFkZXJOb2RlKSB7CiAgICAgICAgICAgICAgdGhpcy50YWlsTm9kZSA9IG5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLmhlYWRlck5vZGUucHJldiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZS5uZXh0ID0gdGhpcy5oZWFkZXJOb2RlOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5oZWFkZXJOb2RlID0gbm9kZTsKICAgICAgICAgIHRoaXMuc2l6ZSsrOwogICAgICB9OwogICAgICBMUlVDYWNoZS5wcm90b3R5cGUucmVtb3ZlRnJvbVRhaWwgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoIXRoaXMudGFpbE5vZGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5vZGUgPSB0aGlzLnRhaWxOb2RlOwogICAgICAgICAgdmFyIHByZXZOb2RlID0gbm9kZS5wcmV2OwogICAgICAgICAgaWYgKHByZXZOb2RlKSB7CiAgICAgICAgICAgICAgcHJldk5vZGUubmV4dCA9IHVuZGVmaW5lZDsKICAgICAgICAgIH0KICAgICAgICAgIG5vZGUucHJldiA9IHVuZGVmaW5lZDsKICAgICAgICAgIHRoaXMudGFpbE5vZGUgPSBwcmV2Tm9kZTsKICAgICAgICAgIHRoaXMuc2l6ZS0tOwogICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgIH07CiAgICAgIExSVUNhY2hlLnByb3RvdHlwZS5kZXRhY2hGcm9tTGlzdCA9IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICBpZiAodGhpcy5oZWFkZXJOb2RlID09PSBub2RlKSB7CiAgICAgICAgICAgICAgdGhpcy5oZWFkZXJOb2RlID0gbm9kZS5uZXh0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMudGFpbE5vZGUgPT09IG5vZGUpIHsKICAgICAgICAgICAgICB0aGlzLnRhaWxOb2RlID0gbm9kZS5wcmV2OwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vZGUucHJldikgewogICAgICAgICAgICAgIG5vZGUucHJldi5uZXh0ID0gbm9kZS5uZXh0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vZGUubmV4dCkgewogICAgICAgICAgICAgIG5vZGUubmV4dC5wcmV2ID0gbm9kZS5wcmV2OwogICAgICAgICAgfQogICAgICAgICAgbm9kZS5uZXh0ID0gdW5kZWZpbmVkOwogICAgICAgICAgbm9kZS5wcmV2ID0gdW5kZWZpbmVkOwogICAgICAgICAgdGhpcy5zaXplLS07CiAgICAgIH07CiAgICAgIExSVUNhY2hlLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICBpZiAodGhpcy5ub2RlTWFwW2tleV0pIHsKICAgICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXMubm9kZU1hcFtrZXldOwogICAgICAgICAgICAgIHRoaXMuZGV0YWNoRnJvbUxpc3Qobm9kZSk7CiAgICAgICAgICAgICAgdGhpcy5wcmVwZW5kVG9MaXN0KG5vZGUpOwogICAgICAgICAgICAgIHJldHVybiBub2RlLnZhbHVlOwogICAgICAgICAgfQogICAgICB9OwogICAgICBMUlVDYWNoZS5wcm90b3R5cGUucmVtb3ZlID0gZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgaWYgKHRoaXMubm9kZU1hcFtrZXldKSB7CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzLm5vZGVNYXBba2V5XTsKICAgICAgICAgICAgICB0aGlzLmRldGFjaEZyb21MaXN0KG5vZGUpOwogICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm5vZGVNYXBba2V5XTsKICAgICAgICAgIH0KICAgICAgfTsKICAgICAgTFJVQ2FjaGUucHJvdG90eXBlLnB1dCA9IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgICBpZiAodGhpcy5ub2RlTWFwW2tleV0pIHsKICAgICAgICAgICAgICB0aGlzLnJlbW92ZShrZXkpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAodGhpcy5zaXplID09PSB0aGlzLnNpemVMaW1pdCkgewogICAgICAgICAgICAgIHZhciB0YWlsTm9kZSA9IHRoaXMucmVtb3ZlRnJvbVRhaWwoKTsKICAgICAgICAgICAgICB2YXIga2V5XzEgPSB0YWlsTm9kZS5rZXk7CiAgICAgICAgICAgICAgZGVsZXRlIHRoaXMubm9kZU1hcFtrZXlfMV07CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Tm9kZSA9IG5ldyBMaW5rZWRMaXN0Tm9kZShrZXksIHZhbHVlKTsKICAgICAgICAgIHRoaXMubm9kZU1hcFtrZXldID0gbmV3Tm9kZTsKICAgICAgICAgIHRoaXMucHJlcGVuZFRvTGlzdChuZXdOb2RlKTsKICAgICAgfTsKICAgICAgTFJVQ2FjaGUucHJvdG90eXBlLmVtcHR5ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh0aGlzLm5vZGVNYXApOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzLm5vZGVNYXBba2V5XTsKICAgICAgICAgICAgICB0aGlzLmRldGFjaEZyb21MaXN0KG5vZGUpOwogICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm5vZGVNYXBba2V5XTsKICAgICAgICAgIH0KICAgICAgfTsKICAgICAgcmV0dXJuIExSVUNhY2hlOwogIH0oKSk7CiAgZXhwb3J0cy5MUlVDYWNoZSA9IExSVUNhY2hlOwogIH0se31dLDEwNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gQVdTIFNESyBmb3IgSmF2YVNjcmlwdCB2Mi41NTMuMAogIC8vIENvcHlyaWdodCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogIC8vIExpY2Vuc2UgYXQgaHR0cHM6Ly9zZGsuYW1hem9uYXdzLmNvbS9qcy9CVU5ETEVfTElDRU5TRS50eHQKICByZXF1aXJlKCcuL2Jyb3dzZXJfbG9hZGVyJyk7CiAgCiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIAogIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgd2luZG93LkFXUyA9IEFXUzsKICBpZiAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgLyoqCiAgICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICAgKi8KICAgICAgbW9kdWxlLmV4cG9ydHMgPSBBV1M7CiAgfQogIGlmICh0eXBlb2Ygc2VsZiAhPT0gJ3VuZGVmaW5lZCcpIHNlbGYuQVdTID0gQVdTOwogIAogIC8qKgogICAqIEBwcml2YXRlCiAgICogRE8gTk9UIFJFTU9WRQogICAqIGJyb3dzZXIgYnVpbGRlciB3aWxsIHN0cmlwIG91dCB0aGlzIGxpbmUgaWYgc2VydmljZXMgYXJlIHN1cHBsaWVkIG9uIHRoZSBjb21tYW5kIGxpbmUuCiAgICovaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoQVdTLCAnQ29ubmVjdCcpKSB7CiAgICBBV1MuYXBpTG9hZGVyLnNlcnZpY2VzWydjb25uZWN0J10gPSB7fTsKICAgIEFXUy5Db25uZWN0ID0gQVdTLlNlcnZpY2UuZGVmaW5lU2VydmljZSgnY29ubmVjdCcsIFsgJzIwMTctMDItMTUnIF0pOwogIH0KICBBV1MuYXBpTG9hZGVyLnNlcnZpY2VzWydjb25uZWN0J11bJzIwMTctMDItMTUnXSA9IHJlcXVpcmUoJy4uL2FwaXMvY29ubmVjdC0yMDE3LTAyLTE1Lm1pbicpOwogIAogIGlmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKEFXUywgJ1NUUycpKSB7CiAgICBBV1MuYXBpTG9hZGVyLnNlcnZpY2VzWydzdHMnXSA9IHt9OwogICAgQVdTLlNUUyA9IEFXUy5TZXJ2aWNlLmRlZmluZVNlcnZpY2UoJ3N0cycsIFsgJzIwMTEtMDYtMTUnIF0pOwogICAgcmVxdWlyZSgnLi9zZXJ2aWNlcy9zdHMnKTsKICB9CiAgQVdTLmFwaUxvYWRlci5zZXJ2aWNlc1snc3RzJ11bJzIwMTEtMDYtMTUnXSA9IHJlcXVpcmUoJy4uL2FwaXMvc3RzLTIwMTEtMDYtMTUubWluJyk7CiAgCiAgCiAgfSx7Ii4uL2FwaXMvY29ubmVjdC0yMDE3LTAyLTE1Lm1pbiI6MywiLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5taW4iOjUsIi4vYnJvd3Nlcl9sb2FkZXIiOjE2LCIuL2NvcmUiOjE4LCIuL3NlcnZpY2VzL3N0cyI6NjF9XX0se30sWzEwNV0pOwogIAogIAovKiEgQGxpY2Vuc2Ugc3ByaW50Zi5qcyB8IENvcHlyaWdodCAoYykgMjAwNy0yMDEzIEFsZXhhbmRydSBNYXJhc3RlYW51IDxoZWxsbyBhdCBhbGV4ZWkgZG90IHJvPiB8IDMgY2xhdXNlIEJTRCBsaWNlbnNlICovCgooZnVuY3Rpb24oKSB7CiAgIHZhciBjdHggPSB0aGlzOwoKCXZhciBzcHJpbnRmID0gZnVuY3Rpb24oKSB7CgkJaWYgKCFzcHJpbnRmLmNhY2hlLmhhc093blByb3BlcnR5KGFyZ3VtZW50c1swXSkpIHsKCQkJc3ByaW50Zi5jYWNoZVthcmd1bWVudHNbMF1dID0gc3ByaW50Zi5wYXJzZShhcmd1bWVudHNbMF0pOwoJCX0KCQlyZXR1cm4gc3ByaW50Zi5mb3JtYXQuY2FsbChudWxsLCBzcHJpbnRmLmNhY2hlW2FyZ3VtZW50c1swXV0sIGFyZ3VtZW50cyk7Cgl9OwoKCXNwcmludGYuZm9ybWF0ID0gZnVuY3Rpb24ocGFyc2VfdHJlZSwgYXJndikgewoJCXZhciBjdXJzb3IgPSAxLCB0cmVlX2xlbmd0aCA9IHBhcnNlX3RyZWUubGVuZ3RoLCBub2RlX3R5cGUgPSAnJywgYXJnLCBvdXRwdXQgPSBbXSwgaSwgaywgbWF0Y2gsIHBhZCwgcGFkX2NoYXJhY3RlciwgcGFkX2xlbmd0aDsKCQlmb3IgKGkgPSAwOyBpIDwgdHJlZV9sZW5ndGg7IGkrKykgewoJCQlub2RlX3R5cGUgPSBnZXRfdHlwZShwYXJzZV90cmVlW2ldKTsKCQkJaWYgKG5vZGVfdHlwZSA9PT0gJ3N0cmluZycpIHsKCQkJCW91dHB1dC5wdXNoKHBhcnNlX3RyZWVbaV0pOwoJCQl9CgkJCWVsc2UgaWYgKG5vZGVfdHlwZSA9PT0gJ2FycmF5JykgewoJCQkJbWF0Y2ggPSBwYXJzZV90cmVlW2ldOyAvLyBjb252ZW5pZW5jZSBwdXJwb3NlcyBvbmx5CgkJCQlpZiAobWF0Y2hbMl0pIHsgLy8ga2V5d29yZCBhcmd1bWVudAoJCQkJCWFyZyA9IGFyZ3ZbY3Vyc29yXTsKCQkJCQlmb3IgKGsgPSAwOyBrIDwgbWF0Y2hbMl0ubGVuZ3RoOyBrKyspIHsKCQkJCQkJaWYgKCFhcmcuaGFzT3duUHJvcGVydHkobWF0Y2hbMl1ba10pKSB7CgkJCQkJCQl0aHJvdyhzcHJpbnRmKCdbc3ByaW50Zl0gcHJvcGVydHkgIiVzIiBkb2VzIG5vdCBleGlzdCcsIG1hdGNoWzJdW2tdKSk7CgkJCQkJCX0KCQkJCQkJYXJnID0gYXJnW21hdGNoWzJdW2tdXTsKCQkJCQl9CgkJCQl9CgkJCQllbHNlIGlmIChtYXRjaFsxXSkgeyAvLyBwb3NpdGlvbmFsIGFyZ3VtZW50IChleHBsaWNpdCkKCQkJCQlhcmcgPSBhcmd2W21hdGNoWzFdXTsKCQkJCX0KCQkJCWVsc2UgeyAvLyBwb3NpdGlvbmFsIGFyZ3VtZW50IChpbXBsaWNpdCkKCQkJCQlhcmcgPSBhcmd2W2N1cnNvcisrXTsKCQkJCX0KCgkJCQlpZiAoL1tec10vLnRlc3QobWF0Y2hbOF0pICYmIChnZXRfdHlwZShhcmcpICE9ICdudW1iZXInKSkgewoJCQkJCXRocm93KHNwcmludGYoJ1tzcHJpbnRmXSBleHBlY3RpbmcgbnVtYmVyIGJ1dCBmb3VuZCAlcycsIGdldF90eXBlKGFyZykpKTsKCQkJCX0KCQkJCXN3aXRjaCAobWF0Y2hbOF0pIHsKCQkJCQljYXNlICdiJzogYXJnID0gYXJnLnRvU3RyaW5nKDIpOyBicmVhazsKCQkJCQljYXNlICdjJzogYXJnID0gU3RyaW5nLmZyb21DaGFyQ29kZShhcmcpOyBicmVhazsKCQkJCQljYXNlICdkJzogYXJnID0gcGFyc2VJbnQoYXJnLCAxMCk7IGJyZWFrOwoJCQkJCWNhc2UgJ2UnOiBhcmcgPSBtYXRjaFs3XSA/IGFyZy50b0V4cG9uZW50aWFsKG1hdGNoWzddKSA6IGFyZy50b0V4cG9uZW50aWFsKCk7IGJyZWFrOwoJCQkJCWNhc2UgJ2YnOiBhcmcgPSBtYXRjaFs3XSA/IHBhcnNlRmxvYXQoYXJnKS50b0ZpeGVkKG1hdGNoWzddKSA6IHBhcnNlRmxvYXQoYXJnKTsgYnJlYWs7CgkJCQkJY2FzZSAnbyc6IGFyZyA9IGFyZy50b1N0cmluZyg4KTsgYnJlYWs7CgkJCQkJY2FzZSAncyc6IGFyZyA9ICgoYXJnID0gU3RyaW5nKGFyZykpICYmIG1hdGNoWzddID8gYXJnLnN1YnN0cmluZygwLCBtYXRjaFs3XSkgOiBhcmcpOyBicmVhazsKCQkJCQljYXNlICd1JzogYXJnID0gYXJnID4+PiAwOyBicmVhazsKCQkJCQljYXNlICd4JzogYXJnID0gYXJnLnRvU3RyaW5nKDE2KTsgYnJlYWs7CgkJCQkJY2FzZSAnWCc6IGFyZyA9IGFyZy50b1N0cmluZygxNikudG9VcHBlckNhc2UoKTsgYnJlYWs7CgkJCQl9CgkJCQlhcmcgPSAoL1tkZWZdLy50ZXN0KG1hdGNoWzhdKSAmJiBtYXRjaFszXSAmJiBhcmcgPj0gMCA/ICcrJysgYXJnIDogYXJnKTsKCQkJCXBhZF9jaGFyYWN0ZXIgPSBtYXRjaFs0XSA/IG1hdGNoWzRdID09ICcwJyA/ICcwJyA6IG1hdGNoWzRdLmNoYXJBdCgxKSA6ICcgJzsKCQkJCXBhZF9sZW5ndGggPSBtYXRjaFs2XSAtIFN0cmluZyhhcmcpLmxlbmd0aDsKCQkJCXBhZCA9IG1hdGNoWzZdID8gc3RyX3JlcGVhdChwYWRfY2hhcmFjdGVyLCBwYWRfbGVuZ3RoKSA6ICcnOwoJCQkJb3V0cHV0LnB1c2gobWF0Y2hbNV0gPyBhcmcgKyBwYWQgOiBwYWQgKyBhcmcpOwoJCQl9CgkJfQoJCXJldHVybiBvdXRwdXQuam9pbignJyk7Cgl9OwoKCXNwcmludGYuY2FjaGUgPSB7fTsKCglzcHJpbnRmLnBhcnNlID0gZnVuY3Rpb24oZm10KSB7CgkJdmFyIF9mbXQgPSBmbXQsIG1hdGNoID0gW10sIHBhcnNlX3RyZWUgPSBbXSwgYXJnX25hbWVzID0gMDsKCQl3aGlsZSAoX2ZtdCkgewoJCQlpZiAoKG1hdGNoID0gL15bXlx4MjVdKy8uZXhlYyhfZm10KSkgIT09IG51bGwpIHsKCQkJCXBhcnNlX3RyZWUucHVzaChtYXRjaFswXSk7CgkJCX0KCQkJZWxzZSBpZiAoKG1hdGNoID0gL15ceDI1ezJ9Ly5leGVjKF9mbXQpKSAhPT0gbnVsbCkgewoJCQkJcGFyc2VfdHJlZS5wdXNoKCclJyk7CgkJCX0KCQkJZWxzZSBpZiAoKG1hdGNoID0gL15ceDI1KD86KFsxLTldXGQqKVwkfFwoKFteXCldKylcKSk/KFwrKT8oMHwnW14kXSk/KC0pPyhcZCspPyg/OlwuKFxkKykpPyhbYi1mb3N1eFhdKS8uZXhlYyhfZm10KSkgIT09IG51bGwpIHsKCQkJCWlmIChtYXRjaFsyXSkgewoJCQkJCWFyZ19uYW1lcyB8PSAxOwoJCQkJCXZhciBmaWVsZF9saXN0ID0gW10sIHJlcGxhY2VtZW50X2ZpZWxkID0gbWF0Y2hbMl0sIGZpZWxkX21hdGNoID0gW107CgkJCQkJaWYgKChmaWVsZF9tYXRjaCA9IC9eKFthLXpfXVthLXpfXGRdKikvaS5leGVjKHJlcGxhY2VtZW50X2ZpZWxkKSkgIT09IG51bGwpIHsKCQkJCQkJZmllbGRfbGlzdC5wdXNoKGZpZWxkX21hdGNoWzFdKTsKCQkJCQkJd2hpbGUgKChyZXBsYWNlbWVudF9maWVsZCA9IHJlcGxhY2VtZW50X2ZpZWxkLnN1YnN0cmluZyhmaWVsZF9tYXRjaFswXS5sZW5ndGgpKSAhPT0gJycpIHsKCQkJCQkJCWlmICgoZmllbGRfbWF0Y2ggPSAvXlwuKFthLXpfXVthLXpfXGRdKikvaS5leGVjKHJlcGxhY2VtZW50X2ZpZWxkKSkgIT09IG51bGwpIHsKCQkJCQkJCQlmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwoJCQkJCQkJfQoJCQkJCQkJZWxzZSBpZiAoKGZpZWxkX21hdGNoID0gL15cWyhcZCspXF0vLmV4ZWMocmVwbGFjZW1lbnRfZmllbGQpKSAhPT0gbnVsbCkgewoJCQkJCQkJCWZpZWxkX2xpc3QucHVzaChmaWVsZF9tYXRjaFsxXSk7CgkJCQkJCQl9CgkJCQkJCQllbHNlIHsKCQkJCQkJCQl0aHJvdygnW3NwcmludGZdIGh1aD8nKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCQllbHNlIHsKCQkJCQkJdGhyb3coJ1tzcHJpbnRmXSBodWg/Jyk7CgkJCQkJfQoJCQkJCW1hdGNoWzJdID0gZmllbGRfbGlzdDsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCWFyZ19uYW1lcyB8PSAyOwoJCQkJfQoJCQkJaWYgKGFyZ19uYW1lcyA9PT0gMykgewoJCQkJCXRocm93KCdbc3ByaW50Zl0gbWl4aW5nIHBvc2l0aW9uYWwgYW5kIG5hbWVkIHBsYWNlaG9sZGVycyBpcyBub3QgKHlldCkgc3VwcG9ydGVkJyk7CgkJCQl9CgkJCQlwYXJzZV90cmVlLnB1c2gobWF0Y2gpOwoJCQl9CgkJCWVsc2UgewoJCQkJdGhyb3coJ1tzcHJpbnRmXSBodWg/Jyk7CgkJCX0KCQkJX2ZtdCA9IF9mbXQuc3Vic3RyaW5nKG1hdGNoWzBdLmxlbmd0aCk7CgkJfQoJCXJldHVybiBwYXJzZV90cmVlOwoJfTsKCgl2YXIgdnNwcmludGYgPSBmdW5jdGlvbihmbXQsIGFyZ3YsIF9hcmd2KSB7CgkJX2FyZ3YgPSBhcmd2LnNsaWNlKDApOwoJCV9hcmd2LnNwbGljZSgwLCAwLCBmbXQpOwoJCXJldHVybiBzcHJpbnRmLmFwcGx5KG51bGwsIF9hcmd2KTsKCX07CgoJLyoqCgkgKiBoZWxwZXJzCgkgKi8KCWZ1bmN0aW9uIGdldF90eXBlKHZhcmlhYmxlKSB7CgkJcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YXJpYWJsZSkuc2xpY2UoOCwgLTEpLnRvTG93ZXJDYXNlKCk7Cgl9CgoJZnVuY3Rpb24gc3RyX3JlcGVhdChpbnB1dCwgbXVsdGlwbGllcikgewoJCWZvciAodmFyIG91dHB1dCA9IFtdOyBtdWx0aXBsaWVyID4gMDsgb3V0cHV0Wy0tbXVsdGlwbGllcl0gPSBpbnB1dCkgey8qIGRvIG5vdGhpbmcgKi99CgkJcmV0dXJuIG91dHB1dC5qb2luKCcnKTsKCX0KCgkvKioKCSAqIGV4cG9ydCB0byBlaXRoZXIgYnJvd3NlciBvciBub2RlLmpzCgkgKi8KCWN0eC5zcHJpbnRmID0gc3ByaW50ZjsKCWN0eC52c3ByaW50ZiA9IHZzcHJpbnRmOwp9KSgpOwoKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogIC8vIEhvdyBmcmVxdWVudGx5IGxvZ3Mgc2hvdWxkIGJlIGNvbGxlY3RlZCBhbmQgcmVwb3J0ZWQgdG8gc2hhcmVkIHdvcmtlci4KICB2YXIgTE9HX1JFUE9SVF9JTlRFUlZBTF9NSUxMSVMgPSA1MDAwOwoKICAvLyBUaGUgZGVmYXVsdCBsb2cgcm9sbCBpbnRlcnZhbCAoMzBtaW4pCiAgdmFyIERFRkFVTFRfTE9HX1JPTExfSU5URVJWQUwgPSAxODAwMDAwOwoKICAvKioKICAgKiBBbiBlbnVtZXJhdGlvbiBvZiBjb21tb24gbG9nZ2luZyBsZXZlbHMuCiAgICovCiAgdmFyIExvZ0xldmVsID0gewogICAgVEVTVDogIlRFU1QiLAogICAgVFJBQ0U6ICJUUkFDRSIsCiAgICBERUJVRzogIkRFQlVHIiwKICAgIElORk86ICJJTkZPIiwKICAgIExPRzogIkxPRyIsCiAgICBXQVJOOiAiV0FSTiIsCiAgICBFUlJPUjogIkVSUk9SIiwKICAgIENSSVRJQ0FMOiAiQ1JJVElDQUwiCiAgfTsKCiAgLyoqCiAgICogQW4gZW51bWVyYXRpb24gb2YgY29tbW9uIGxvZ2dpbmcgY29tcG9uZW50cy4KICAgKi8KICB2YXIgTG9nQ29tcG9uZW50ID0gewogICAgQ0NQOiAiY2NwIiwKICAgIFNPRlRQSE9ORTogInNvZnRwaG9uZSIsCiAgICBDSEFUOiAiY2hhdCIsCiAgICBUQVNLOiAidGFzayIKICB9OwoKICAvKioKICAgKiBUaGUgbnVtZXJpYyBvcmRlciBvZiB0aGUgbG9nZ2luZyBsZXZlbHMgYWJvdmUuCiAgICogVGhleSBhcmUgc3BhY2VkIHRvIGFsbG93IHRoZSBhZGRpdGlvbiBvZiBvdGhlciBsb2cKICAgKiBsZXZlbHMgYXQgYSBsYXRlciB0aW1lLgogICAqLwogIHZhciBMb2dMZXZlbE9yZGVyID0gewogICAgVEVTVDogMCwKICAgIFRSQUNFOiAxMCwKICAgIERFQlVHOiAyMCwKICAgIElORk86IDMwLAogICAgTE9HOiA0MCwKICAgIFdBUk46IDUwLAogICAgRVJST1I6IDEwMCwKICAgIENSSVRJQ0FMOiAyMDAKCiAgfTsKCiAgLyoqCiAgICogQSBtYXAgZnJvbSBsb2cgbGV2ZWwgdG8gY29uc29sZSBsb2dnZXIgZnVuY3Rpb24uCiAgICovCiAgdmFyIENPTlNPTEVfTE9HR0VSX01BUCA9IHsKICAgIFRSQUNFOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmluZm8odGV4dCk7IH0sCiAgICBERUJVRzogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5pbmZvKHRleHQpOyB9LAogICAgSU5GTzogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5pbmZvKHRleHQpOyB9LAogICAgTE9HOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmxvZyh0ZXh0KTsgfSwKICAgIFRFU1Q6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUubG9nKHRleHQpOyB9LAogICAgV0FSTjogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS53YXJuKHRleHQpOyB9LAogICAgRVJST1I6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuZXJyb3IodGV4dCk7IH0sCiAgICBDUklUSUNBTDogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5lcnJvcih0ZXh0KTsgfQogIH07CgogIC8qKgogICogQ2hlY2tzIGlmIGl0IGlzIGEgdmFsaWQgbG9nIGNvbXBvbmVudCBlbnVtCiAgKi8KCiAgdmFyIGlzVmFsaWRMb2dDb21wb25lbnQgPSBmdW5jdGlvbiAoY29tcG9uZW50KSB7CiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyhMb2dDb21wb25lbnQpLmluZGV4T2YoY29tcG9uZW50KSAhPT0gLTE7CiAgfTsKCiAgLyoqCiAgKiBFeHRyYWN0IHRoZSBjdXN0b20gYXJndW1lbnRzIGFzIHJlcXVpcmVkIGJ5IHRoZSBsb2dnZXIKICAqLwogIHZhciBleHRyYWN0TG9nZ2VyQXJncyA9IGZ1bmN0aW9uIChsb2dnZXJBcmdzKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGxvZ2dlckFyZ3MsIDApOwogICAgdmFyIGZpcnN0QXJnID0gYXJncy5zaGlmdCgpOwogICAgdmFyIGZvcm1hdDsKICAgIHZhciBjb21wb25lbnQ7CiAgICBpZiAoaXNWYWxpZExvZ0NvbXBvbmVudChmaXJzdEFyZykpIHsKICAgICAgY29tcG9uZW50ID0gZmlyc3RBcmc7CiAgICAgIGZvcm1hdCA9IGFyZ3Muc2hpZnQoKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vZGVmYXVsdCB0byBDQ1AgY29tcG9uZW50CiAgICAgIGZvcm1hdCA9IGZpcnN0QXJnOwogICAgICBjb21wb25lbnQgPSBMb2dDb21wb25lbnQuQ0NQOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgZm9ybWF0OiBmb3JtYXQsCiAgICAgIGNvbXBvbmVudDogY29tcG9uZW50LAogICAgICBhcmdzOiBhcmdzCiAgICB9OwogIH07CgogIC8qKgogICAqIEEgbG9nIGVudHJ5LgogICAqCiAgICogQHBhcmFtIGNvbXBvbmVudCBUaGUgbG9nZ2luZyBjb21wb25lbnQuCiAgICogQHBhcmFtIGxldmVsIFRoZSBsb2cgbGV2ZWwgb2YgdGhpcyBsb2cgZW50cnkuCiAgICogQHBhcmFtIHRleHQgVGhlIHRleHQgY29udGFpbmVkIGluIHRoZSBsb2cgZW50cnkuCiAgICogQHBhcmFtIGxvZ2dlcklkIFRoZSByb290IGxvZ2dlciBpZC4KICAgKgogICAqIExvZyBlbnRyaWVzIGFyZSBhd2FyZSBvZiB0aGVpciB0aW1lc3RhbXAsIG9yZGVyLAogICAqIGFuZCBjYW4gY29udGFpbiBvYmplY3RzIGFuZCBleGNlcHRpb24gc3RhY2sgdHJhY2VzLgogICAqLwogIHZhciBMb2dFbnRyeSA9IGZ1bmN0aW9uIChjb21wb25lbnQsIGxldmVsLCB0ZXh0LCBsb2dnZXJJZCkgewogICAgdGhpcy5jb21wb25lbnQgPSBjb21wb25lbnQ7CiAgICB0aGlzLmxldmVsID0gbGV2ZWw7CiAgICB0aGlzLnRleHQgPSB0ZXh0OwogICAgdGhpcy50aW1lID0gbmV3IERhdGUoKTsKICAgIHRoaXMuZXhjZXB0aW9uID0gbnVsbDsKICAgIHRoaXMub2JqZWN0cyA9IFtdOwogICAgdGhpcy5saW5lID0gMDsKICAgIHRoaXMubG9nZ2VySWQgPSBsb2dnZXJJZDsKICB9OwoKICBMb2dFbnRyeS5mcm9tT2JqZWN0ID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIGVudHJ5ID0gbmV3IExvZ0VudHJ5KExvZ0NvbXBvbmVudC5DQ1AsIG9iai5sZXZlbCwgb2JqLnRleHQsIG9iai5sb2dnZXJJZCk7CgogICAgLy8gUmVxdWlyZWQgdG8gY2hlY2sgZm9yIERhdGUgb2JqZWN0cyBzZW50IGFjcm9zcyBmcmFtZSBib3VuZGFyaWVzCiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iai50aW1lKSA9PT0gJ1tvYmplY3QgRGF0ZV0nKSB7CiAgICAgIGVudHJ5LnRpbWUgPSBuZXcgRGF0ZShvYmoudGltZS5nZXRUaW1lKCkpOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygb2JqLnRpbWUgPT09ICdudW1iZXInKSB7CiAgICAgIGVudHJ5LnRpbWUgPSBuZXcgRGF0ZShvYmoudGltZSk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBvYmoudGltZSA9PT0gJ3N0cmluZycpIHsKICAgICAgZW50cnkudGltZSA9IERhdGUucGFyc2Uob2JqLnRpbWUpOwogICAgfSBlbHNlIHsKICAgICAgZW50cnkudGltZSA9IG5ldyBEYXRlKCk7CiAgICB9CiAgICBlbnRyeS5leGNlcHRpb24gPSBvYmouZXhjZXB0aW9uOwogICAgZW50cnkub2JqZWN0cyA9IG9iai5vYmplY3RzOwogICAgcmV0dXJuIGVudHJ5OwogIH07CgogIC8qKgogICAqIFB1bGxzIHRoZSB0eXBlLCBtZXNzYWdlLCBhbmQgc3RhY2sgdHJhY2UKICAgKiBvdXQgb2YgdGhlIGdpdmVuIGV4Y2VwdGlvbiBmb3IgSlNPTiBzZXJpYWxpemF0aW9uLgogICAqLwogIHZhciBMb2dnZWRFeGNlcHRpb24gPSBmdW5jdGlvbiAoZSkgewogICAgdGhpcy50eXBlID0gKGUgaW5zdGFuY2VvZiBFcnJvcikgPyBlLm5hbWUgOiBlLmNvZGUgfHwgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGUpOwogICAgdGhpcy5tZXNzYWdlID0gZS5tZXNzYWdlOwogICAgdGhpcy5zdGFjayA9IGUuc3RhY2sgPyBlLnN0YWNrLnNwbGl0KCdcbicpIDogW107CiAgfTsKCiAgLyoqCiAgICogTWluaW1hbGx5IHN0cmluZ2lmeSB0aGlzIGxvZyBlbnRyeSBmb3IgcHJpbnRpbmcKICAgKiB0byB0aGUgY29uc29sZS4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5zcHJpbnRmKCJbJXNdIFslc106ICVzIiwKICAgICAgdGhpcy5nZXRUaW1lKCkgJiYgdGhpcy5nZXRUaW1lKCkudG9JU09TdHJpbmcgPyB0aGlzLmdldFRpbWUoKS50b0lTT1N0cmluZygpIDogIj8/PyIsCiAgICAgIHRoaXMuZ2V0TGV2ZWwoKSwKICAgICAgdGhpcy5nZXRUZXh0KCkpOwogIH07CgogIC8qKgogICAqIEdldCB0aGUgbG9nIGVudHJ5IHRpbWVzdGFtcC4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUuZ2V0VGltZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLnRpbWU7CiAgfTsKCiAgLyoqCiAgICogR2V0IHRoZSBsZXZlbCBvZiB0aGUgbG9nIGVudHJ5LgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS5nZXRMZXZlbCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmxldmVsOwogIH07CgogIC8qKgogICAqIEdldCB0aGUgbG9nIGVudHJ5IHRleHQuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLmdldFRleHQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy50ZXh0OwogIH07CgogIC8qKgogICAqIEdldCB0aGUgbG9nIGVudHJ5IGNvbXBvbmVudC4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUuZ2V0Q29tcG9uZW50ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29tcG9uZW50OwogIH07CgogIC8qKgogICAqIEFkZCBhbiBleGNlcHRpb24gc3RhY2sgdHJhY2UgdG8gdGhpcyBsb2cgZW50cnkuCiAgICogQSBsb2cgZW50cnkgbWF5IGNvbnRhaW4gb25seSBvbmUgZXhjZXB0aW9uIHN0YWNrIHRyYWNlLgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS53aXRoRXhjZXB0aW9uID0gZnVuY3Rpb24gKGUpIHsKICAgIHRoaXMuZXhjZXB0aW9uID0gbmV3IExvZ2dlZEV4Y2VwdGlvbihlKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8qKgogICAqIEFkZCBhbiBhcmJpdHJhcnkgb2JqZWN0IHRvIHRoZSBsb2cgZW50cnkuICBBIGxvZyBlbnRyeQogICAqIG1heSBjb250YWluIGFueSBudW1iZXIgb2Ygb2JqZWN0cy4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUud2l0aE9iamVjdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHRoaXMub2JqZWN0cy5wdXNoKGNvbm5lY3QuZGVlcGNvcHkob2JqKSk7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvKioKICAgKiBUaGUgbG9nZ2VyIGluc3RhbmNlLgogICAqLwogIHZhciBMb2dnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLl9sb2dzID0gW107CiAgICB0aGlzLl9yb2xsZWRMb2dzID0gW107CiAgICB0aGlzLl9sb2dzVG9QdXNoID0gW107CiAgICB0aGlzLl9lY2hvTGV2ZWwgPSBMb2dMZXZlbE9yZGVyLklORk87CiAgICB0aGlzLl9sb2dMZXZlbCA9IExvZ0xldmVsT3JkZXIuSU5GTzsKICAgIHRoaXMuX2xpbmVDb3VudCA9IDA7CiAgICB0aGlzLl9sb2dSb2xsSW50ZXJ2YWwgPSAwOwogICAgdGhpcy5fbG9nUm9sbFRpbWVyID0gbnVsbDsKICAgIHRoaXMuX2xvZ2dlcklkID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgKyAiLSIgKyBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyKTsKICAgIHRoaXMuc2V0TG9nUm9sbEludGVydmFsKERFRkFVTFRfTE9HX1JPTExfSU5URVJWQUwpOwogIH07CgogIC8qKgogICAqIFNldHMgdGhlIGludGVydmFsIGluIG1pbGxpc2Vjb25kcyB0aGF0IHRoZSBsb2dzIHdpbGwgYmUgcm90YXRlZC4KICAgKiBMb2dzIGFyZSByb3RhdGVkIG91dCBjb21wbGV0ZWx5IGF0IHRoZSBlbmQgb2YgdGhlIHNlY29uZCByb2xsCiAgICogYW5kIHdpbGwgZXZlbnR1YWxseSBiZSBnYXJiYWdlIGNvbGxlY3RlZC4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLnNldExvZ1JvbGxJbnRlcnZhbCA9IGZ1bmN0aW9uIChpbnRlcnZhbCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIGlmICghKHRoaXMuX2xvZ1JvbGxUaW1lcikgfHwgaW50ZXJ2YWwgIT09IHRoaXMuX2xvZ1JvbGxJbnRlcnZhbCkgewogICAgICBpZiAodGhpcy5fbG9nUm9sbFRpbWVyKSB7CiAgICAgICAgZ2xvYmFsLmNsZWFySW50ZXJ2YWwodGhpcy5fbG9nUm9sbFRpbWVyKTsKICAgICAgfQogICAgICB0aGlzLl9sb2dSb2xsSW50ZXJ2YWwgPSBpbnRlcnZhbDsKICAgICAgdGhpcy5fbG9nUm9sbFRpbWVyID0gZ2xvYmFsLnNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGlzLl9yb2xsZWRMb2dzID0gdGhpcy5fbG9nczsKICAgICAgICB0aGlzLl9sb2dzID0gW107CiAgICAgICAgc2VsZi5pbmZvKCJMb2cgcm9sbCBpbnRlcnZhbCBvY2N1cnJlZC4iKTsKICAgICAgfSwgdGhpcy5fbG9nUm9sbEludGVydmFsKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMud2FybigiTG9nZ2VyIGlzIGFscmVhZHkgc2V0IHRvIHRoZSBnaXZlbiBpbnRlcnZhbDogJWQiLCB0aGlzLl9sb2dSb2xsSW50ZXJ2YWwpOwogICAgfQogIH07CgogIC8qKgogICAqIFNldCB0aGUgbG9nIGxldmVsLiAgVGhpcyBpcyB0aGUgbWluaW11bSBsZXZlbCBhdCB3aGljaCBsb2dzIHdpbGwKICAgKiBiZSBrZXB0IGZvciBsYXRlciBhcmNoaXZpbmcuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5zZXRMb2dMZXZlbCA9IGZ1bmN0aW9uIChsZXZlbCkgewogICAgaWYgKGxldmVsIGluIExvZ0xldmVsT3JkZXIpIHsKICAgICAgdGhpcy5fbG9nTGV2ZWwgPSBMb2dMZXZlbE9yZGVyW2xldmVsXTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBsb2dnaW5nIGxldmVsOiAiICsgbGV2ZWwpOwogICAgfQogIH07CgogIC8qKgogICAqIFNldCB0aGUgZWNobyBsZXZlbC4gIFRoaXMgaXMgdGhlIG1pbmltdW0gbGV2ZWwgYXQgd2hpY2ggbG9ncyB3aWxsCiAgICogYmUgcHJpbnRlZCB0byB0aGUgamF2YXNjcmlwdCBjb25zb2xlLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUuc2V0RWNob0xldmVsID0gZnVuY3Rpb24gKGxldmVsKSB7CiAgICBpZiAobGV2ZWwgaW4gTG9nTGV2ZWxPcmRlcikgewogICAgICB0aGlzLl9lY2hvTGV2ZWwgPSBMb2dMZXZlbE9yZGVyW2xldmVsXTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBsb2dnaW5nIGxldmVsOiAiICsgbGV2ZWwpOwogICAgfQogIH07CgogIC8qKgogICAqIFdyaXRlIGEgcGFydGljdWxhciBsb2cgZW50cnkuCiAgICoKICAgKiBAcGFyYW0gbGV2ZWwgVGhlIGxvZ2dpbmcgbGV2ZWwgb2YgdGhlIGVudHJ5LgogICAqIEBwYXJhbSB0ZXh0IFRoZSB0ZXh0IGNvbnRlbnRzIG9mIHRoZSBlbnRyeS4KICAgKgogICAqIEByZXR1cm5zIFRoZSBuZXcgbG9nIGVudHJ5LgogICAqLwogIExvZ2dlci5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbiAoY29tcG9uZW50LCBsZXZlbCwgdGV4dCkgewogICAgdmFyIGxvZ0VudHJ5ID0gbmV3IExvZ0VudHJ5KGNvbXBvbmVudCwgbGV2ZWwsIHRleHQsIHRoaXMuZ2V0TG9nZ2VySWQoKSk7CiAgICB0aGlzLmFkZExvZ0VudHJ5KGxvZ0VudHJ5KTsKICAgIHJldHVybiBsb2dFbnRyeTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmFkZExvZ0VudHJ5ID0gZnVuY3Rpb24gKGxvZ0VudHJ5KSB7CiAgICB0aGlzLl9sb2dzLnB1c2gobG9nRW50cnkpOwogICAgLy9Gb3Igbm93IG9ubHkgc2VuZCBzb2Z0cGhvbmUgbG9ncyBvbmx5LgogICAgLy9UT0RPIGFkZCBDQ1AgbG9ncyBvbmNlIHdlIGFyZSBzdXJlIHRoYXQgbm8gc2Vuc2l0aXZlIGRhdGEgaXMgYmVpbmcgbG9nZ2VkLgogICAgaWYgKExvZ0NvbXBvbmVudC5TT0ZUUEhPTkUgPT09IGxvZ0VudHJ5LmNvbXBvbmVudCkgewogICAgICB0aGlzLl9sb2dzVG9QdXNoLnB1c2gobG9nRW50cnkpOwogICAgfQoKICAgIGlmIChsb2dFbnRyeS5sZXZlbCBpbiBMb2dMZXZlbE9yZGVyICYmCiAgICAgIExvZ0xldmVsT3JkZXJbbG9nRW50cnkubGV2ZWxdID49IHRoaXMuX2xvZ0xldmVsKSB7CgogICAgICBpZiAoTG9nTGV2ZWxPcmRlcltsb2dFbnRyeS5sZXZlbF0gPj0gdGhpcy5fZWNob0xldmVsKSB7CiAgICAgICAgQ09OU09MRV9MT0dHRVJfTUFQW2xvZ0VudHJ5LmdldExldmVsKCldKGxvZ0VudHJ5LnRvU3RyaW5nKCkpOwogICAgICB9CgogICAgICBsb2dFbnRyeS5saW5lID0gdGhpcy5fbGluZUNvdW50Kys7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogUmVtb3ZlIGFsbCBvYmplY3RzIGZyb20gYWxsIGxvZyBlbnRyaWVzLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUuY2xlYXJPYmplY3RzID0gZnVuY3Rpb24gKCkgewogICAgZm9yICh2YXIgeCA9IDA7IHggPCB0aGlzLl9sb2dzLmxlbmd0aDsgeCsrKSB7CiAgICAgIGlmICh0aGlzLl9sb2dzW3hdLm9iamVjdHMpIHsKICAgICAgICBkZWxldGUgdGhpcy5fbG9nc1t4XS5vYmplY3RzOwogICAgICB9CiAgICB9CiAgfTsKCiAgLyoqCiAgICogUmVtb3ZlIGFsbCBleGNlcHRpb24gc3RhY2sgdHJhY2VzIGZyb20gdGhlIGxvZyBlbnRyaWVzLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUuY2xlYXJFeGNlcHRpb25zID0gZnVuY3Rpb24gKCkgewogICAgZm9yICh2YXIgeCA9IDA7IHggPCB0aGlzLl9sb2dzLmxlbmd0aDsgeCsrKSB7CiAgICAgIGlmICh0aGlzLl9sb2dzW3hdLmV4Y2VwdGlvbikgewogICAgICAgIGRlbGV0ZSB0aGlzLl9sb2dzW3hdLmV4Y2VwdGlvbjsKICAgICAgfQogICAgfQogIH07CgogIExvZ2dlci5wcm90b3R5cGUudHJhY2UgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuVFJBQ0UsIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuZGVidWcgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuREVCVUcsIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuaW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5JTkZPLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmxvZyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5MT0csIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUudGVzdCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5URVNULCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLndhcm4gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuV0FSTiwgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5FUlJPUiwgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5jcml0aWNhbCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5FUlJPUiwgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgLyoqCiAgICogQ3JlYXRlIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBsb2dnZXIgY29udGVudHMuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsaW5lcyA9IFtdOwogICAgZm9yICh2YXIgeCA9IDA7IHggPCB0aGlzLl9sb2dzLmxlbmd0aDsgeCsrKSB7CiAgICAgIGxpbmVzLnB1c2godGhpcy5fbG9nc1t4XS50b1N0cmluZygpKTsKICAgIH0KCiAgICByZXR1cm4gbGluZXMuam9pbigiXG4iKTsKICB9OwogIAogIC8qKgogICAqIERvd25sb2FkL0FyY2hpdmUgbG9ncyB0byBhIGZpbGUsIAogICAqIEJ5IGRlZmF1bHQsIGl0IHJldHVybnMgYWxsIGxvZ3MuCiAgICogVG8gZmlsdGVyIGxvZ3MgYnkgdGhlIG1pbmltdW0gbG9nIGxldmVsIHNldCBieSBzZXRMb2dMZXZlbCBvciB0aGUgZGVmYXVsdCBzZXQgaW4gX2xvZ0xldmVsLCAKICAgKiBwYXNzIGluIGZpbHRlckJ5TG9nTGV2ZWwgdG8gdHJ1ZSBpbiBvcHRpb25zCiAgICogCiAgICogQHBhcmFtIG9wdGlvbnMgZG93bmxvYWQgb3B0aW9ucyBbT2JqZWN0fFN0cmluZ10uIAogICAqIC0gb2YgdHlwZSBPYmplY3Q6IAogICAqICAgeyBsb2dOYW1lOiAnbXktbG9nLW5hbWUnLAogICAqICAgICBmaWx0ZXJCeUxvZ0xldmVsOiBmYWxzZSwgLy9kb3dubG9hZCBhbGwgbG9ncwogICAqICAgfQogICAqIC0gb2YgdHlwZSBTdHJpbmcgKGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5KSwgdGhlIGZpbGUncyBuYW1lCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5kb3dubG9hZCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHZhciBsb2dOYW1lID0gJ2FnZW50LWxvZyc7CiAgICB2YXIgZmlsdGVyQnlMb2dMZXZlbCA9IGZhbHNlOwoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ29iamVjdCcpIHsKICAgICAgbG9nTmFtZSA9IG9wdGlvbnMubG9nTmFtZSB8fCBsb2dOYW1lOwogICAgICBmaWx0ZXJCeUxvZ0xldmVsID0gb3B0aW9ucy5maWx0ZXJCeUxvZ0xldmVsIHx8IGZpbHRlckJ5TG9nTGV2ZWw7CiAgICB9CiAgICBlbHNlIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHsKICAgICAgbG9nTmFtZSA9IG9wdGlvbnMgfHwgbG9nTmFtZTsgCiAgICB9CgogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGxvZ3MgPSB0aGlzLl9yb2xsZWRMb2dzLmNvbmNhdCh0aGlzLl9sb2dzKTsKICAgIGlmIChmaWx0ZXJCeUxvZ0xldmVsKSB7CiAgICAgIGxvZ3MgPSBsb2dzLmZpbHRlcihmdW5jdGlvbihlbnRyeSkgewogICAgICAgIHJldHVybiBMb2dMZXZlbE9yZGVyW2VudHJ5LmxldmVsXSA+PSBzZWxmLl9sb2dMZXZlbDsKICAgICAgfSk7CiAgICB9CgogICAgdmFyIGxvZ0Jsb2IgPSBuZXcgZ2xvYmFsLkJsb2IoW0pTT04uc3RyaW5naWZ5KGxvZ3MsIHVuZGVmaW5lZCwgNCldLCBbJ3RleHQvcGxhaW4nXSk7CiAgICB2YXIgZG93bmxvYWRMaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgdmFyIGxvZ05hbWUgPSBsb2dOYW1lIHx8ICdhZ2VudC1sb2cnOwogICAgZG93bmxvYWRMaW5rLmhyZWYgPSBnbG9iYWwuVVJMLmNyZWF0ZU9iamVjdFVSTChsb2dCbG9iKTsKICAgIGRvd25sb2FkTGluay5kb3dubG9hZCA9IGxvZ05hbWUgKyAnLnR4dCc7CiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGRvd25sb2FkTGluayk7CiAgICBkb3dubG9hZExpbmsuY2xpY2soKTsKICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoZG93bmxvYWRMaW5rKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnNjaGVkdWxlVXBzdHJlYW1Mb2dQdXNoID0gZnVuY3Rpb24gKGNvbmR1aXQpIHsKICAgIGlmICghY29ubmVjdC51cHN0cmVhbUxvZ1B1c2hTY2hlZHVsZWQpIHsKICAgICAgY29ubmVjdC51cHN0cmVhbUxvZ1B1c2hTY2hlZHVsZWQgPSB0cnVlOwogICAgICAvKiogU2NoZWR1bGUgcHVzaGluZyBsb2dzIGZyZXF1ZW50bHkgdG8gc2hhcmVkd29ya2VyIHVwc3RyZWFtLCBzaGFyZWR3b3JrZXIgd2lsbCByZXBvcnQgdG8gTEFSUyovCiAgICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMucmVwb3J0TWFzdGVyTG9nc1VwU3RyZWFtLCBjb25kdWl0KSwgTE9HX1JFUE9SVF9JTlRFUlZBTF9NSUxMSVMpOwogICAgfQogIH07CgogIExvZ2dlci5wcm90b3R5cGUucmVwb3J0TWFzdGVyTG9nc1VwU3RyZWFtID0gZnVuY3Rpb24gKGNvbmR1aXQpIHsKICAgIHZhciBsb2dzVG9QdXNoID0gdGhpcy5fbG9nc1RvUHVzaC5zbGljZSgpOwogICAgdGhpcy5fbG9nc1RvUHVzaCA9IFtdOwogICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TRU5EX0xPR1MsIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGxvZ3NUb1B1c2gubGVuZ3RoID4gMCkgewogICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNFTkRfTE9HUywgbG9nc1RvUHVzaCk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuZ2V0TG9nZ2VySWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fbG9nZ2VySWQ7CiAgfTsKCiAgdmFyIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyID0gZnVuY3Rpb24gKGNvbmR1aXQpIHsKICAgIExvZ2dlci5jYWxsKHRoaXMpOwogICAgdGhpcy5jb25kdWl0ID0gY29uZHVpdDsKICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMuX3B1c2hMb2dzRG93bnN0cmVhbSksCiAgICAgIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLkxPR19QVVNIX0lOVEVSVkFMKTsKCiAgICAvLyBEaXNhYmxlIGxvZyByb2xsaW5nLCB3ZSB3aWxsIHB1cmdlIG91ciBvd24gbG9ncyBvbmNlIHRoZXkgaGF2ZQogICAgLy8gYmVlbiBwdXNoZWQgZG93bnN0cmVhbS4KICAgIGdsb2JhbC5jbGVhckludGVydmFsKHRoaXMuX2xvZ1JvbGxUaW1lcik7CiAgICB0aGlzLl9sb2dSb2xsVGltZXIgPSBudWxsOwogIH07CiAgLy8gSG93IGZyZXF1ZW50bHkgbG9ncyBzaG91bGQgYmUgY29sbGVjdGVkIGFuZCBkZWxpdmVyZWQgZG93bnN0cmVhbS4KICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5MT0dfUFVTSF9JTlRFUlZBTCA9IDEwMDA7CiAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShMb2dnZXIucHJvdG90eXBlKTsKICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBEb3duc3RyZWFtQ29uZHVpdExvZ2dlcjsKCiAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIucHJvdG90eXBlLnB1c2hMb2dzRG93bnN0cmVhbSA9IGZ1bmN0aW9uIChsb2dzKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBsb2dzLmZvckVhY2goZnVuY3Rpb24gKGxvZykgewogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTE9HLCBsb2cpOwogICAgfSk7CiAgfTsKCiAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIucHJvdG90eXBlLl9wdXNoTG9nc0Rvd25zdHJlYW0gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0aGlzLl9sb2dzLmZvckVhY2goZnVuY3Rpb24gKGxvZykgewogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTE9HLCBsb2cpOwogICAgfSk7CiAgICB0aGlzLl9sb2dzID0gW107CiAgfTsKCiAgLyoqIENyZWF0ZSB0aGUgc2luZ2xldG9uIGxvZ2dlciBpbnN0YW5jZS4gKi8KICBjb25uZWN0LnJvb3RMb2dnZXIgPSBuZXcgTG9nZ2VyKCk7CgogIC8qKiBGZXRjaCB0aGUgc2luZ2xldG9uIGxvZ2dlciBpbnN0YW5jZS4gKi8KICB2YXIgZ2V0TG9nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Qucm9vdExvZ2dlcjsKICB9OwoKICBjb25uZWN0ID0gY29ubmVjdCB8fCB7fTsKICBjb25uZWN0LmdldExvZyA9IGdldExvZzsKICBjb25uZWN0LkxvZ0VudHJ5ID0gTG9nRW50cnk7CiAgY29ubmVjdC5Mb2dnZXIgPSBMb2dnZXI7CiAgY29ubmVjdC5Mb2dMZXZlbCA9IExvZ0xldmVsOwogIGNvbm5lY3QuTG9nQ29tcG9uZW50ID0gTG9nQ29tcG9uZW50OwogIGNvbm5lY3QuRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIgPSBEb3duc3RyZWFtQ29uZHVpdExvZ2dlcjsKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogIHZhciB1c2VyQWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50OwogIHZhciBPTkVfREFZX01JTExJUyA9IDI0ICogNjAgKiA2MCAqIDEwMDA7CgogIC8qKgogICAqIFVucG9sbHV0ZSBzcHJpbnRmIGZ1bmN0aW9ucyBmcm9tIHRoZSBnbG9iYWwgbmFtZXNwYWNlLgogICAqLwogIGNvbm5lY3Quc3ByaW50ZiA9IGdsb2JhbC5zcHJpbnRmOwogIGNvbm5lY3QudnNwcmludGYgPSBnbG9iYWwudnNwcmludGY7CiAgZGVsZXRlIGdsb2JhbC5zcHJpbnRmOwogIGRlbGV0ZSBnbG9iYWwudnNwcmludGY7CgogIGNvbm5lY3QuSFRUUF9TVEFUVVNfQ09ERVMgPSB7CiAgICBTVUNDRVNTOiAyMDAsCiAgICBUT09fTUFOWV9SRVFVRVNUUzogNDI5LAogICAgSU5URVJOQUxfU0VSVkVSX0VSUk9SOiA1MDAKICB9OwoKICBjb25uZWN0LlRSQU5TUE9SVF9UWVBFUyA9IHsKICAgIENIQVRfVE9LRU46ICJjaGF0X3Rva2VuIiwKICAgIFdFQl9TT0NLRVQ6ICJ3ZWJfc29ja2V0IgogIH07CgogIC8qKgogICAqIEJpbmRzIHRoZSBnaXZlbiBpbnN0YW5jZSBvYmplY3QgYXMgdGhlIGNvbnRleHQgZm9yCiAgICogdGhlIG1ldGhvZCBwcm92aWRlZC4KICAgKgogICAqIEBwYXJhbSBzY29wZSBUaGUgaW5zdGFuY2Ugb2JqZWN0IHRvIGJlIHNldCBhcyB0aGUgc2NvcGUKICAgKiAgICBvZiB0aGUgZnVuY3Rpb24uCiAgICogQHBhcmFtIG1ldGhvZCBUaGUgbWV0aG9kIHRvIGJlIGVuY2Fwc3VsYXRlZC4KICAgKgogICAqIEFsbCBvdGhlciBhcmd1bWVudHMsIGlmIGFueSwgYXJlIGJvdW5kIHRvIHRoZSBtZXRob2QKICAgKiBpbnZvY2F0aW9uIGluc2lkZSB0aGUgY2xvc3VyZS4KICAgKgogICAqIEByZXR1cm4gQSBjbG9zdXJlIGVuY2Fwc3VsYXRpbmcgdGhlIGludm9jYXRpb24gb2YgdGhlCiAgICogICAgbWV0aG9kIHByb3ZpZGVkIGluIGNvbnRleHQgb2YgdGhlIGdpdmVuIGluc3RhbmNlLgogICAqLwogIGNvbm5lY3QuaGl0Y2ggPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICB2YXIgc2NvcGUgPSBhcmdzLnNoaWZ0KCk7CiAgICB2YXIgbWV0aG9kID0gYXJncy5zaGlmdCgpOwoKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChzY29wZSwgJ3Njb3BlJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwobWV0aG9kLCAnbWV0aG9kJyk7CiAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKG1ldGhvZCksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CgogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNsb3N1cmVBcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIG1ldGhvZC5hcHBseShzY29wZSwgYXJncy5jb25jYXQoY2xvc3VyZUFyZ3MpKTsKICAgIH07CiAgfTsKCiAgLyoqCiAgICogRGV0ZXJtaW5lIGlmIHRoZSBnaXZlbiB2YWx1ZSBpcyBhIGNhbGxhYmxlIGZ1bmN0aW9uIHR5cGUuCiAgICogQm9ycm93ZWQgZnJvbSBVbmRlcnNjb3JlLmpzLgogICAqLwogIGNvbm5lY3QuaXNGdW5jdGlvbiA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiAhIShvYmogJiYgb2JqLmNvbnN0cnVjdG9yICYmIG9iai5jYWxsICYmIG9iai5hcHBseSk7CiAgfTsKCiAgLyoqCiAgICogRGV0ZXJtaW5lIGlmIHRoZSBnaXZlbiB2YWx1ZSBpcyBhbiBhcnJheS4KICAgKi8KICBjb25uZWN0LmlzQXJyYXkgPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKCiAgLyoqCiAgICogR2V0IGEgbGlzdCBvZiBrZXlzIGZyb20gYSBKYXZhc2NyaXB0IG9iamVjdCB1c2VkCiAgICogYXMgYSBoYXNoIG1hcC4KICAgKi8KICBjb25uZWN0LmtleXMgPSBmdW5jdGlvbiAobWFwKSB7CiAgICB2YXIga2V5cyA9IFtdOwoKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChtYXAsICdtYXAnKTsKCiAgICBmb3IgKHZhciBrIGluIG1hcCkgewogICAgICBrZXlzLnB1c2goayk7CiAgICB9CgogICAgcmV0dXJuIGtleXM7CiAgfTsKCiAgLyoqCiAgICogR2V0IGEgbGlzdCBvZiB2YWx1ZXMgZnJvbSBhIEphdmFzY3JpcHQgb2JqZWN0IHVzZWQKICAgKiBhcyBhIGhhc2ggbWFwLgogICAqLwogIGNvbm5lY3QudmFsdWVzID0gZnVuY3Rpb24gKG1hcCkgewogICAgdmFyIHZhbHVlcyA9IFtdOwoKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChtYXAsICdtYXAnKTsKCiAgICBmb3IgKHZhciBrIGluIG1hcCkgewogICAgICB2YWx1ZXMucHVzaChtYXBba10pOwogICAgfQoKICAgIHJldHVybiB2YWx1ZXM7CiAgfTsKCiAgLyoqCiAgICogR2V0IGEgbGlzdCBvZiBrZXkvdmFsdWUgcGFpcnMgZnJvbSB0aGUgZ2l2ZW4gbWFwLgogICAqLwogIGNvbm5lY3QuZW50cmllcyA9IGZ1bmN0aW9uIChtYXApIHsKICAgIHZhciBlbnRyaWVzID0gW107CgogICAgZm9yICh2YXIgayBpbiBtYXApIHsKICAgICAgZW50cmllcy5wdXNoKHsga2V5OiBrLCB2YWx1ZTogbWFwW2tdIH0pOwogICAgfQoKICAgIHJldHVybiBlbnRyaWVzOwogIH07CgogIC8qKgogICAqIE1lcmdlIHR3byBvciBtb3JlIG1hcHMgdG9nZXRoZXIgaW50byBhIG5ldyBtYXAsCiAgICogb3Igc2ltcGx5IGNvcHkgYSBzaW5nbGUgbWFwLgogICAqLwogIGNvbm5lY3QubWVyZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYXJnTWFwcyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICB2YXIgcmVzdWx0TWFwID0ge307CgogICAgYXJnTWFwcy5mb3JFYWNoKGZ1bmN0aW9uIChtYXApIHsKICAgICAgY29ubmVjdC5lbnRyaWVzKG1hcCkuZm9yRWFjaChmdW5jdGlvbiAoa3YpIHsKICAgICAgICByZXN1bHRNYXBba3Yua2V5XSA9IGt2LnZhbHVlOwogICAgICB9KTsKICAgIH0pOwoKICAgIHJldHVybiByZXN1bHRNYXA7CiAgfTsKCiAgY29ubmVjdC5ub3cgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgfTsKCiAgY29ubmVjdC5maW5kID0gZnVuY3Rpb24gKGFycmF5LCBwcmVkaWNhdGUpIHsKICAgIGZvciAodmFyIHggPSAwOyB4IDwgYXJyYXkubGVuZ3RoOyB4KyspIHsKICAgICAgaWYgKHByZWRpY2F0ZShhcnJheVt4XSkpIHsKICAgICAgICByZXR1cm4gYXJyYXlbeF07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbnVsbDsKICB9OwoKICBjb25uZWN0LmNvbnRhaW5zID0gZnVuY3Rpb24gKG9iaiwgdmFsdWUpIHsKICAgIGlmIChvYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICByZXR1cm4gY29ubmVjdC5maW5kKG9iaiwgZnVuY3Rpb24gKHYpIHsgcmV0dXJuIHYgPT09IHZhbHVlOyB9KSAhPSBudWxsOwoKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAodmFsdWUgaW4gb2JqKTsKICAgIH0KICB9OwoKICBjb25uZWN0LmNvbnRhaW5zVmFsdWUgPSBmdW5jdGlvbiAob2JqLCB2YWx1ZSkgewogICAgaWYgKG9iaiBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgIHJldHVybiBjb25uZWN0LmZpbmQob2JqLCBmdW5jdGlvbiAodikgeyByZXR1cm4gdiA9PT0gdmFsdWU7IH0pICE9IG51bGw7CgogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGNvbm5lY3QuZmluZChjb25uZWN0LnZhbHVlcyhvYmopLCBmdW5jdGlvbiAodikgeyByZXR1cm4gdiA9PT0gdmFsdWU7IH0pICE9IG51bGw7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogR2VuZXJhdGUgYSByYW5kb20gSUQgY29uc2lzdGluZyBvZiB0aGUgY3VycmVudCB0aW1lc3RhbXAKICAgKiBhbmQgYSByYW5kb20gYmFzZS0zNiBudW1iZXIgYmFzZWQgb24gTWF0aC5yYW5kb20oKS4KICAgKi8KICBjb25uZWN0LnJhbmRvbUlkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Quc3ByaW50ZigiJXMtJXMiLCBjb25uZWN0Lm5vdygpLCBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyKSk7CiAgfTsKCiAgLyoqCiAgICogR2VuZXJhdGUgYW4gZW51bSBmcm9tIHRoZSBnaXZlbiBsaXN0IG9mIGxvd2VyLWNhc2UgZW51bSB2YWx1ZXMsCiAgICogd2hlcmUgdGhlIGVudW0ga2V5cyB3aWxsIGJlIHVwcGVyIGNhc2UuCiAgICoKICAgKiBDb252ZXJzaW9uIGZyb20gcGFzY2FsIGNhc2UgYmFzZWQgb24gY29kZSBmcm9tIGhlcmU6CiAgICogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8zMDUyMTIyNAogICAqLwogIGNvbm5lY3QubWFrZUVudW0gPSBmdW5jdGlvbiAodmFsdWVzKSB7CiAgICB2YXIgZW51bU9iaiA9IHt9OwoKICAgIHZhbHVlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICB2YXIga2V5ID0gdmFsdWUucmVwbGFjZSgvXC4/KFthLXpdKylfPy9nLCBmdW5jdGlvbiAoeCwgeSkgeyByZXR1cm4geS50b1VwcGVyQ2FzZSgpICsgIl8iOyB9KQogICAgICAgIC5yZXBsYWNlKC9fJC8sICIiKTsKCiAgICAgIGVudW1PYmpba2V5XSA9IHZhbHVlOwogICAgfSk7CgogICAgcmV0dXJuIGVudW1PYmo7CiAgfTsKCiAgY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0gPSBmdW5jdGlvbiAocHJlZml4LCB2YWx1ZXMpIHsKICAgIHZhciBlbnVtT2JqID0gY29ubmVjdC5tYWtlRW51bSh2YWx1ZXMpOwogICAgY29ubmVjdC5rZXlzKGVudW1PYmopLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICBlbnVtT2JqW2tleV0gPSBjb25uZWN0LnNwcmludGYoIiVzOjolcyIsIHByZWZpeCwgZW51bU9ialtrZXldKTsKICAgIH0pOwogICAgcmV0dXJuIGVudW1PYmo7CiAgfTsKCiAgLyoqCiAgKiBNZXRob2RzIHRvIGRldGVybWluZSBicm93c2VyIHR5cGUgYW5kIHZlcnNpb25zLCB1c2VkIGZvciBzb2Z0cGhvbmUgaW5pdGlhbGl6YXRpb24uCiAgKi8KICBjb25uZWN0LmlzQ2hyb21lQnJvd3NlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB1c2VyQWdlbnQuaW5kZXhPZigiQ2hyb21lIikgIT09IC0xOwogIH07CgogIGNvbm5lY3QuaXNGaXJlZm94QnJvd3NlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB1c2VyQWdlbnQuaW5kZXhPZigiRmlyZWZveCIpICE9PSAtMTsKICB9OwoKICBjb25uZWN0LmlzT3BlcmFCcm93c2VyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHVzZXJBZ2VudC5pbmRleE9mKCJPcGVyYSIpICE9PSAtMTsKICB9OwoKICBjb25uZWN0LmdldENocm9tZUJyb3dzZXJWZXJzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNocm9tZVZlcnNpb24gPSB1c2VyQWdlbnQuc3Vic3RyaW5nKHVzZXJBZ2VudC5pbmRleE9mKCJDaHJvbWUiKSArIDcpOwogICAgaWYgKGNocm9tZVZlcnNpb24pIHsKICAgICAgcmV0dXJuIHBhcnNlRmxvYXQoY2hyb21lVmVyc2lvbik7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gLTE7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5nZXRGaXJlZm94QnJvd3NlclZlcnNpb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZmlyZWZveFZlcnNpb24gPSB1c2VyQWdlbnQuc3Vic3RyaW5nKHVzZXJBZ2VudC5pbmRleE9mKCJGaXJlZm94IikgKyA4KTsKICAgIGlmIChmaXJlZm94VmVyc2lvbikgewogICAgICByZXR1cm4gcGFyc2VGbG9hdChmaXJlZm94VmVyc2lvbik7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gLTE7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5nZXRPcGVyYUJyb3dzZXJWZXJzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHZlcnNpb25PZmZzZXQgPSB1c2VyQWdlbnQuaW5kZXhPZigiT3BlcmEiKTsKICAgIHZhciBvcGVyYVZlcnNpb24gPSAodXNlckFnZW50LmluZGV4T2YoIlZlcnNpb24iKSAhPT0gLTEpID8gdXNlckFnZW50LnN1YnN0cmluZyh2ZXJzaW9uT2Zmc2V0ICsgOCkgOiB1c2VyQWdlbnQuc3Vic3RyaW5nKHZlcnNpb25PZmZzZXQgKyA2KTsKICAgIGlmIChvcGVyYVZlcnNpb24pIHsKICAgICAgcmV0dXJuIHBhcnNlRmxvYXQob3BlcmFWZXJzaW9uKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAtMTsKICAgIH0KICB9OwoKICAvKioKICAgKiBSZXR1cm4gYSBtYXAgb2YgaXRlbXMgaW4gdGhlIGdpdmVuIGxpc3QgaW5kZXhlZCBieQogICAqIGtleXMgZGV0ZXJtaW5lZCBieSB0aGUgY2xvc3VyZSBwcm92aWRlZC4KICAgKgogICAqIEBwYXJhbSBpdGVyYWJsZSBBIGxpc3QtbGlrZSBvYmplY3QuCiAgICogQHBhcmFtIGNsb3N1cmUgQSBjbG9zdXJlIHRvIGRldGVybWluZSB0aGUgaW5kZXggZm9yIHRoZQogICAqICAgIGl0ZW1zIGluIHRoZSBpdGVyYWJsZS4KICAgKiBAcmV0dXJuIEEgbWFwIGZyb20gaW5kZXggdG8gaXRlbSBmb3IgZWFjaCBpdGVtIGluIHRoZSBpdGVyYWJsZS4KICAgKi8KICBjb25uZWN0LmluZGV4ID0gZnVuY3Rpb24gKGl0ZXJhYmxlLCBjbG9zdXJlKSB7CiAgICB2YXIgbWFwID0ge307CgogICAgaXRlcmFibGUuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgewogICAgICBtYXBbY2xvc3VyZShpdGVtKV0gPSBpdGVtOwogICAgfSk7CgogICAgcmV0dXJuIG1hcDsKICB9OwoKICAvKioKICAgKiBDb252ZXJ0cyB0aGUgZ2l2ZW4gYXJyYXkgaW50byBhIG1hcCBhcyBhIHNldCwKICAgKiB3aGVyZSBlbGVtZW50cyBpbiB0aGUgYXJyYXkgYXJlIG1hcHBlZCB0byAxLgogICAqLwogIGNvbm5lY3Quc2V0ID0gZnVuY3Rpb24gKGFycmF5SW4pIHsKICAgIHZhciBzZXRNYXAgPSB7fTsKCiAgICBhcnJheUluLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICBzZXRNYXBba2V5XSA9IDE7CiAgICB9KTsKCiAgICByZXR1cm4gc2V0TWFwOwogIH07CgogIC8qKgogICAqIFJldHVybnMgYSBtYXAgZm9yIGVhY2gga2V5IGluIG1hcEIgd2hpY2gKICAgKiBpcyBOT1QgaW4gbWFwQS4KICAgKi8KICBjb25uZWN0LnJlbGF0aXZlQ29tcGxlbWVudCA9IGZ1bmN0aW9uIChtYXBBLCBtYXBCKSB7CiAgICB2YXIgY29tcE1hcCA9IHt9OwoKICAgIGNvbm5lY3Qua2V5cyhtYXBCKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgaWYgKCEoa2V5IGluIG1hcEEpKSB7CiAgICAgICAgY29tcE1hcFtrZXldID0gbWFwQltrZXldOwogICAgICB9CiAgICB9KTsKCiAgICByZXR1cm4gY29tcE1hcDsKICB9OwoKICAvKioKICAgKiBBc3NlcnRzIHRoYXQgYSBwcmVtaXNlIGlzIHRydWUuCiAgICovCiAgY29ubmVjdC5hc3NlcnRUcnVlID0gZnVuY3Rpb24gKHByZW1pc2UsIG1lc3NhZ2UpIHsKICAgIGlmICghcHJlbWlzZSkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5WYWx1ZUVycm9yKG1lc3NhZ2UpOwogICAgfQogIH07CgogIC8qKgogICAqIEFzc2VydHMgdGhhdCBhIHZhbHVlIGlzIG5vdCBudWxsIG9yIHVuZGVmaW5lZC4KICAgKi8KICBjb25uZWN0LmFzc2VydE5vdE51bGwgPSBmdW5jdGlvbiAodmFsdWUsIG5hbWUpIHsKICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZSh2YWx1ZSAhPSBudWxsICYmIHR5cGVvZiB2YWx1ZSAhPT0gdW5kZWZpbmVkLAogICAgICBjb25uZWN0LnNwcmludGYoIiVzIG11c3QgYmUgcHJvdmlkZWQiLCBuYW1lIHx8ICdBIHZhbHVlJykpOwogICAgcmV0dXJuIHZhbHVlOwogIH07CgogIGNvbm5lY3QuZGVlcGNvcHkgPSBmdW5jdGlvbiAoc3JjKSB7CiAgICByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShzcmMpKTsKICB9OwoKICAvKioKICAgKiBHZXQgdGhlIGN1cnJlbnQgYmFzZSB1cmwgb2YgdGhlIG9wZW4gcGFnZSwgZS5nLiBpZiB0aGUgcGFnZSBpcwogICAqIGh0dHBzOi8vZXhhbXBsZS5jb206OTQ5NC9vcmFuZ2VzLCB0aGlzIHdpbGwgYmUgImh0dHBzOi8vZXhhbXBsZS5jb206OTQ5NCIuCiAgICovCiAgY29ubmVjdC5nZXRCYXNlVXJsID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvY2F0aW9uID0gZ2xvYmFsLmxvY2F0aW9uOwogICAgcmV0dXJuIGNvbm5lY3Quc3ByaW50ZigiJXMvLyVzOiVzIiwgbG9jYXRpb24ucHJvdG9jb2wsIGxvY2F0aW9uLmhvc3RuYW1lLCBsb2NhdGlvbi5wb3J0KTsKICB9OwoKICAvKioKICAgKiBEZXRlcm1pbmUgaWYgdGhlIGN1cnJlbnQgd2luZG93IGlzIGluIGFuIGlmcmFtZS4KICAgKiBDb3VydGVzeTogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8zMjYwNjkvCiAgICovCiAgY29ubmVjdC5pc0ZyYW1lZCA9IGZ1bmN0aW9uICgpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiB3aW5kb3cuc2VsZiAhPT0gd2luZG93LnRvcDsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5mZXRjaCA9IGZ1bmN0aW9uIChlbmRwb2ludCwgb3B0aW9ucywgbWlsbGlJbnRlcnZhbCwgbWF4UmV0cnkpIHsKICAgIG1heFJldHJ5ID0gbWF4UmV0cnkgfHwgNTsKICAgIG1pbGxpSW50ZXJ2YWwgPSBtaWxsaUludGVydmFsIHx8IDEwMDA7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGZ1bmN0aW9uIGZldGNoRGF0YShtYXhSZXRyeSkgewogICAgICAgIGZldGNoKGVuZHBvaW50LCBvcHRpb25zKS50aGVuKGZ1bmN0aW9uIChyZXMpIHsKICAgICAgICAgIGlmIChyZXMuc3RhdHVzID09PSBjb25uZWN0LkhUVFBfU1RBVFVTX0NPREVTLlNVQ0NFU1MpIHsKICAgICAgICAgICAgcmVzb2x2ZShyZXMuanNvbigpKTsKICAgICAgICAgIH0gZWxzZSBpZiAobWF4UmV0cnkgIT09IDEgJiYgKHJlcy5zdGF0dXMgPj0gY29ubmVjdC5IVFRQX1NUQVRVU19DT0RFUy5JTlRFUk5BTF9TRVJWRVJfRVJST1IgfHwgcmVzLnN0YXR1cyA9PT0gY29ubmVjdC5IVFRQX1NUQVRVU19DT0RFUy5UT09fTUFOWV9SRVFVRVNUUykpIHsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgZmV0Y2hEYXRhKC0tbWF4UmV0cnkpOwogICAgICAgICAgICB9LCBtaWxsaUludGVydmFsKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlamVjdChyZXMpOwogICAgICAgICAgfQogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICByZWplY3QoZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgZmV0Y2hEYXRhKG1heFJldHJ5KTsKICAgIH0pOwogIH07CgogIC8qKgogICAqIENhbGxpbmcgYSBmdW5jdGlvbiB3aXRoIGV4cG9uZW50aWFsIGJhY2tvZmYgd2l0aCBmdWxsIGppdHRlciByZXRyeSBzdHJhdGVneQogICAqIEl0IHdpbGwgcmV0cnkgY2FsbGluZyB0aGUgZnVuY3Rpb24gZm9yIG1heGltdW0gbWF4UmV0cnkgdGltZXMgaWYgaXQgZmFpbHMuCiAgICogU3VjY2VzcyBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgZnVuY3Rpb24gc3VjY2VlZGVkLgogICAqIEZhaWx1cmUgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgb25seSBpZiB0aGUgbGFzdCB0cnkgZmFpbGVkLgogICAqLwogIGNvbm5lY3QuYmFja29mZiA9IGZ1bmN0aW9uIChmdW5jLCBtaWxsaUludGVydmFsLCBtYXhSZXRyeSwgY2FsbGJhY2tzKSB7CiAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGZ1bmMpLCAiZnVuYyBtdXN0IGJlIGEgRnVuY3Rpb24iKTsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciByYXRpbyA9IDI7CgogICAgZnVuYyh7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3Muc3VjY2VzcykgewogICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKG1heFJldHJ5ID4gMCkgewogICAgICAgICAgdmFyIGludGVydmFsID0gbWlsbGlJbnRlcnZhbCAqIDIgKiBNYXRoLnJhbmRvbSgpOwogICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzZWxmLmJhY2tvZmYoZnVuYywgaW50ZXJ2YWwgKiByYXRpbywgLS1tYXhSZXRyeSwgY2FsbGJhY2tzKTsKICAgICAgICAgIH0sIGludGVydmFsKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3MuZmFpbHVyZSkgewogICAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnIsIGRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5wdWJsaXNoTWV0cmljID0gZnVuY3Rpb24gKG1ldHJpY0RhdGEpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLkNMSUVOVF9NRVRSSUMsIG1ldHJpY0RhdGEpOwogIH07CgogIGNvbm5lY3QucHVibGlzaFNvZnRwaG9uZVN0YXRzID0gZnVuY3Rpb24oc3RhdHMpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLlNPRlRQSE9ORV9TVEFUUywgc3RhdHMpOwogIH07CgogIGNvbm5lY3QucHVibGlzaFNvZnRwaG9uZVJlcG9ydCA9IGZ1bmN0aW9uKHJlcG9ydCkgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuU09GVFBIT05FX1JFUE9SVCwgcmVwb3J0KTsKICB9OwoKICAvKioKICAgKiBBIHdyYXBwZXIgYXJvdW5kIFdpbmRvdy5vcGVuKCkgZm9yIG1hbmFnaW5nIHNpbmdsZSBpbnN0YW5jZSBwb3B1cHMuCiAgICovCiAgY29ubmVjdC5Qb3B1cE1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7IH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5vcGVuID0gZnVuY3Rpb24odXJsLCBuYW1lKSB7CiAgICB2YXIgdGhlbiA9IHRoaXMuX2dldExhc3RPcGVuZWRUaW1lc3RhbXAobmFtZSk7CiAgICB2YXIgbm93ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICB2YXIgd2luID0gbnVsbDsgICAgICAKICAgIGlmIChub3cgLSB0aGVuID4gT05FX0RBWV9NSUxMSVMpIHsKICAgICAgIHdpbiA9IHdpbmRvdy5vcGVuKCcnLCBuYW1lKTsKICAgICAgIGlmICh3aW4ubG9jYXRpb24gIT09IHVybCkgewogICAgICAgICAgd2luID0gd2luZG93Lm9wZW4odXJsLCBuYW1lKTsKICAgICAgIH0KICAgICAgIHRoaXMuX3NldExhc3RPcGVuZWRUaW1lc3RhbXAobmFtZSwgbm93KTsKICAgIH0KICAgIHJldHVybiB3aW47CiB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAobmFtZSkgewogICAgdmFyIGtleSA9IHRoaXMuX2dldExvY2FsU3RvcmFnZUtleShuYW1lKTsKICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShrZXkpOwogIH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5fZ2V0TGFzdE9wZW5lZFRpbWVzdGFtcCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICB2YXIga2V5ID0gdGhpcy5fZ2V0TG9jYWxTdG9yYWdlS2V5KG5hbWUpOwogICAgdmFyIHZhbHVlID0gZ2xvYmFsLmxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSk7CgogICAgaWYgKHZhbHVlKSB7CiAgICAgIHJldHVybiBwYXJzZUludCh2YWx1ZSwgMTApOwoKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAwOwogICAgfQogIH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5fc2V0TGFzdE9wZW5lZFRpbWVzdGFtcCA9IGZ1bmN0aW9uIChuYW1lLCB0cykgewogICAgdmFyIGtleSA9IHRoaXMuX2dldExvY2FsU3RvcmFnZUtleShuYW1lKTsKICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXksICcnICsgdHMpOwogIH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5fZ2V0TG9jYWxTdG9yYWdlS2V5ID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgIHJldHVybiAiY29ubmVjdFBvcHVwTWFuYWdlcjo6IiArIG5hbWU7CiAgfTsKCiAgLyoqCiAgICogQW4gZW51bWVyYXRpb24gb2YgdGhlIEhUTUw1IG5vdGlmaWNhdGlvbiBwZXJtaXNzaW9uIHZhbHVlcy4KICAgKi8KICB2YXIgTm90aWZpY2F0aW9uUGVybWlzc2lvbiA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2dyYW50ZWQnLAogICAgJ2RlbmllZCcsCiAgICAnZGVmYXVsdCcKICBdKTsKCiAgLyoqCiAgICogQSBzaW1wbGUgZW5naW5lIGZvciBzaG93aW5nIG5vdGlmaWNhdGlvbiBwb3B1cHMuCiAgICovCiAgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5xdWV1ZSA9IFtdOwogICAgdGhpcy5wZXJtaXNzaW9uID0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5ERUZBVUxUOwogIH07CgogIGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlci5wcm90b3R5cGUucmVxdWVzdFBlcm1pc3Npb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZiAoISgiTm90aWZpY2F0aW9uIiBpbiBnbG9iYWwpKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiVGhpcyBicm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBub3RpZmljYXRpb25zLiIpOwogICAgICB0aGlzLnBlcm1pc3Npb24gPSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkRFTklFRDsKCiAgICB9IGVsc2UgaWYgKGdsb2JhbC5Ob3RpZmljYXRpb24ucGVybWlzc2lvbiA9PT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5ERU5JRUQpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJUaGUgdXNlciBoYXMgcmVxdWVzdGVkIHRvIG5vdCByZWNlaXZlIG5vdGlmaWNhdGlvbnMuIik7CiAgICAgIHRoaXMucGVybWlzc2lvbiA9IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uREVOSUVEOwoKICAgIH0gZWxzZSBpZiAodGhpcy5wZXJtaXNzaW9uICE9PSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkdSQU5URUQpIHsKICAgICAgZ2xvYmFsLk5vdGlmaWNhdGlvbi5yZXF1ZXN0UGVybWlzc2lvbigpLnRoZW4oZnVuY3Rpb24gKHBlcm1pc3Npb24pIHsKICAgICAgICBzZWxmLnBlcm1pc3Npb24gPSBwZXJtaXNzaW9uOwogICAgICAgIGlmIChwZXJtaXNzaW9uID09PSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkdSQU5URUQpIHsKICAgICAgICAgIHNlbGYuX3Nob3dRdWV1ZWQoKTsKCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYucXVldWUgPSBbXTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH07CgogIGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlci5wcm90b3R5cGUuc2hvdyA9IGZ1bmN0aW9uICh0aXRsZSwgb3B0aW9ucykgewogICAgaWYgKHRoaXMucGVybWlzc2lvbiA9PT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5HUkFOVEVEKSB7CiAgICAgIHJldHVybiB0aGlzLl9zaG93SW1wbCh7IHRpdGxlOiB0aXRsZSwgb3B0aW9uczogb3B0aW9ucyB9KTsKCiAgICB9IGVsc2UgaWYgKHRoaXMucGVybWlzc2lvbiA9PT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5ERU5JRUQpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJVbmFibGUgdG8gc2hvdyBub3RpZmljYXRpb24uIikud2l0aE9iamVjdCh7CiAgICAgICAgdGl0bGU6IHRpdGxlLAogICAgICAgIG9wdGlvbnM6IG9wdGlvbnMKICAgICAgfSk7CgogICAgfSBlbHNlIHsKICAgICAgdmFyIHBhcmFtcyA9IHsgdGl0bGU6IHRpdGxlLCBvcHRpb25zOiBvcHRpb25zIH07CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiRGVmZXJyaW5nIG5vdGlmaWNhdGlvbiB1bnRpbCB1c2VyIGRlY2lkZXMgdG8gYWxsb3cgb3IgZGVueS4iKQogICAgICAgIC53aXRoT2JqZWN0KHBhcmFtcyk7CiAgICAgIHRoaXMucXVldWUucHVzaChwYXJhbXMpOwogICAgfQogIH07CgogIGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlci5wcm90b3R5cGUuX3Nob3dRdWV1ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgbm90aWZpY2F0aW9ucyA9IHRoaXMucXVldWUubWFwKGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgICAgcmV0dXJuIHNlbGYuX3Nob3dJbXBsKHBhcmFtcyk7CiAgICB9KTsKICAgIHRoaXMucXVldWUgPSBbXTsKICAgIHJldHVybiBub3RpZmljYXRpb25zOwogIH07CgogIGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlci5wcm90b3R5cGUuX3Nob3dJbXBsID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgdmFyIG5vdGlmaWNhdGlvbiA9IG5ldyBnbG9iYWwuTm90aWZpY2F0aW9uKHBhcmFtcy50aXRsZSwgcGFyYW1zLm9wdGlvbnMpOwogICAgaWYgKHBhcmFtcy5vcHRpb25zLmNsaWNrZWQpIHsKICAgICAgbm90aWZpY2F0aW9uLm9uY2xpY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcGFyYW1zLm9wdGlvbnMuY2xpY2tlZC5jYWxsKG5vdGlmaWNhdGlvbik7CiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gbm90aWZpY2F0aW9uOwogIH07CgogIGNvbm5lY3QuQmFzZUVycm9yID0gZnVuY3Rpb24gKGZvcm1hdCwgYXJncykgewogICAgZ2xvYmFsLkVycm9yLmNhbGwodGhpcywgY29ubmVjdC52c3ByaW50Zihmb3JtYXQsIGFyZ3MpKTsKICB9OwogIGNvbm5lY3QuQmFzZUVycm9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoRXJyb3IucHJvdG90eXBlKTsKICBjb25uZWN0LkJhc2VFcnJvci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjb25uZWN0LkJhc2VFcnJvcjsKCiAgY29ubmVjdC5WYWx1ZUVycm9yID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgdmFyIGZvcm1hdCA9IGFyZ3Muc2hpZnQoKTsKICAgIGNvbm5lY3QuQmFzZUVycm9yLmNhbGwodGhpcywgZm9ybWF0LCBhcmdzKTsKICB9OwogIGNvbm5lY3QuVmFsdWVFcnJvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKGNvbm5lY3QuQmFzZUVycm9yLnByb3RvdHlwZSk7CiAgY29ubmVjdC5WYWx1ZUVycm9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGNvbm5lY3QuVmFsdWVFcnJvcjsKCiAgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgdmFyIGZvcm1hdCA9IGFyZ3Muc2hpZnQoKTsKICAgIGNvbm5lY3QuQmFzZUVycm9yLmNhbGwodGhpcywgZm9ybWF0LCBhcmdzKTsKICB9OwogIGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKGNvbm5lY3QuQmFzZUVycm9yLnByb3RvdHlwZSk7CiAgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvcjsKCiAgY29ubmVjdC5TdGF0ZUVycm9yID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgdmFyIGZvcm1hdCA9IGFyZ3Muc2hpZnQoKTsKICAgIGNvbm5lY3QuQmFzZUVycm9yLmNhbGwodGhpcywgZm9ybWF0LCBhcmdzKTsKICB9OwogIGNvbm5lY3QuU3RhdGVFcnJvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKGNvbm5lY3QuQmFzZUVycm9yLnByb3RvdHlwZSk7CiAgY29ubmVjdC5TdGF0ZUVycm9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGNvbm5lY3QuU3RhdGVFcnJvcjsKCn0pKCk7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIHZhciBBTExfRVZFTlRTID0gJzw8YWxsPj4nOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIEV2ZW50VHlwZQogICAqLwogIHZhciBFdmVudFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdhY2tub3dsZWRnZScsCiAgICAnYWNrX3RpbWVvdXQnLAogICAgJ2FwaV9yZXF1ZXN0JywKICAgICdhcGlfcmVzcG9uc2UnLAogICAgJ2F1dGhfZmFpbCcsCiAgICAnYWNjZXNzX2RlbmllZCcsCiAgICAnY2xvc2UnLAogICAgJ2NvbmZpZ3VyZScsCiAgICAnbG9nJywKICAgICdtYXN0ZXJfcmVxdWVzdCcsCiAgICAnbWFzdGVyX3Jlc3BvbnNlJywKICAgICdzeW5jaHJvbml6ZScsCiAgICAndGVybWluYXRlJywKICAgICd0ZXJtaW5hdGVkJywKICAgICdzZW5kX2xvZ3MnLAogICAgJ3JlbG9hZF9hZ2VudF9jb25maWd1cmF0aW9uJywKICAgICdicm9hZGNhc3QnLAogICAgJ2FwaV9tZXRyaWMnLAogICAgJ2NsaWVudF9tZXRyaWMnLAogICAgJ3NvZnRwaG9uZV9zdGF0cycsCiAgICAnc29mdHBob25lX3JlcG9ydCcsCiAgICAnbXV0ZScsCiAgICAiaWZyYW1lX3N0eWxlIgogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIE1hc3RlclRvcGljcwogICAqLwogIHZhciBNYXN0ZXJUb3BpY3MgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnY29ubmVjdCcsIFsKICAgICdsb2dpblBvcHVwJywKICAgICdzZW5kTG9ncycsCiAgICAnc29mdHBob25lJywKICAgICdyaW5ndG9uZScsCiAgICAnbWV0cmljcycKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBBZ2VudEV2ZW50cwogICAqLwogIHZhciBBZ2VudEV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdhZ2VudCcsIFsKICAgICdpbml0JywKICAgICd1cGRhdGUnLAogICAgJ3JlZnJlc2gnLAogICAgJ3JvdXRhYmxlJywKICAgICdub3Rfcm91dGFibGUnLAogICAgJ3BlbmRpbmcnLAogICAgJ2NvbnRhY3RfcGVuZGluZycsCiAgICAnb2ZmbGluZScsCiAgICAnZXJyb3InLAogICAgJ3NvZnRwaG9uZV9lcnJvcicsCiAgICAnd2Vic29ja2V0X2Nvbm5lY3Rpb25fbG9zdCcsCiAgICAnd2Vic29ja2V0X2Nvbm5lY3Rpb25fZ2FpbmVkJywKICAgICdzdGF0ZV9jaGFuZ2UnLAogICAgJ2FjdycsCiAgICAnbXV0ZV90b2dnbGUnLAogICAgJ2xvY2FsX21lZGlhX3N0cmVhbV9jcmVhdGVkJwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIGVudW0gV2ViU29ja2V0RXZlbnRzCiAgKi8KICB2YXIgV2ViU29ja2V0RXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ3dlYlNvY2tldCcsIFsKICAgICdpbml0X2ZhaWx1cmUnLAogICAgJ2Nvbm5lY3Rpb25fb3BlbicsCiAgICAnY29ubmVjdGlvbl9jbG9zZScsCiAgICAnY29ubmVjdGlvbl9lcnJvcicsCiAgICAnY29ubmVjdGlvbl9nYWluJywKICAgICdjb25uZWN0aW9uX2xvc3QnLAogICAgJ3N1YnNjcmlwdGlvbl91cGRhdGUnLAogICAgJ3N1YnNjcmlwdGlvbl9mYWlsdXJlJywKICAgICdhbGxfbWVzc2FnZScsCiAgICAnc2VuZCcsCiAgICAnc3Vic2NyaWJlJwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogZW51bSBDb250YWN0RXZlbnRzCiAgICAqLwogIHZhciBDb250YWN0RXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2NvbnRhY3QnLCBbCiAgICAnaW5pdCcsCiAgICAncmVmcmVzaCcsCiAgICAnZGVzdHJveWVkJywKICAgICdpbmNvbWluZycsCiAgICAncGVuZGluZycsCiAgICAnY29ubmVjdGluZycsCiAgICAnY29ubmVjdGVkJywKICAgICdtaXNzZWQnLAogICAgJ2FjdycsCiAgICAndmlldycsCiAgICAnZW5kZWQnLAogICAgJ2Vycm9yJywKICAgICdhY2NlcHRlZCcKICBdKTsKCgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogZW51bSBDb25ubmVjdGlvbkV2ZW50cwogICovCiAgdmFyIENvbm5uZWN0aW9uRXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2Nvbm5lY3Rpb24nLCBbCiAgICAnc2Vzc2lvbl9pbml0JwogIF0pOwoKICB2YXIgRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdkaXNhc3RlclJlY292ZXJ5JywgWwogICAgJ3N1cHByZXNzJywKICAgICdmb3JjZV9vZmZsaW5lJywgLy8gbGV0dGluZyB0aGUgc2hhcmVkd29ya2VyIGtub3cgdG8gZm9yY2Ugb2ZmbGluZSAKICAgICdzZXRfb2ZmbGluZScsIC8vIGlmcmFtZSBsZXR0aW5nIHRoZSBuYXRpdmUgY2NwIHRvIHNldCBvZmZsaW5lCiAgICAnaW5pdF9kaXNhc3Rlcl9yZWNvdmVyeScsCiAgICAnZmFpbG92ZXInIC8vIHVzZWQgdG8gcHJvcGFnYXRlIGZhaWxvdmVyIHN0YXRlIHRvIG90aGVyIHdpbmRvd3MKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgRXZlbnRGYWN0b3J5CiAgICovCiAgdmFyIEV2ZW50RmFjdG9yeSA9IGZ1bmN0aW9uICgpIHsgfTsKICBFdmVudEZhY3RvcnkuY3JlYXRlUmVxdWVzdCA9IGZ1bmN0aW9uICh0eXBlLCBtZXRob2QsIHBhcmFtcykgewogICAgcmV0dXJuIHsKICAgICAgZXZlbnQ6IHR5cGUsCiAgICAgIHJlcXVlc3RJZDogY29ubmVjdC5yYW5kb21JZCgpLAogICAgICBtZXRob2Q6IG1ldGhvZCwKICAgICAgcGFyYW1zOiBwYXJhbXMKICAgIH07CiAgfTsKCiAgRXZlbnRGYWN0b3J5LmNyZWF0ZVJlc3BvbnNlID0gZnVuY3Rpb24gKHR5cGUsIHJlcXVlc3QsIGRhdGEsIGVycikgewogICAgcmV0dXJuIHsKICAgICAgZXZlbnQ6IHR5cGUsCiAgICAgIHJlcXVlc3RJZDogcmVxdWVzdC5yZXF1ZXN0SWQsCiAgICAgIGRhdGE6IGRhdGEsCiAgICAgIGVycjogZXJyIHx8IG51bGwKICAgIH07CiAgfTsKCiAgLyoqCiAgICogQW4gb2JqZWN0IHJlcHJlc2VudGluZyBhbiBldmVudCBzdWJzY3JpcHRpb24gaW4gYW4gRXZlbnRCdXMuCiAgICovCiAgdmFyIFN1YnNjcmlwdGlvbiA9IGZ1bmN0aW9uIChzdWJNYXAsIGV2ZW50TmFtZSwgZikgewogICAgdGhpcy5zdWJNYXAgPSBzdWJNYXA7CiAgICB0aGlzLmlkID0gY29ubmVjdC5yYW5kb21JZCgpOwogICAgdGhpcy5ldmVudE5hbWUgPSBldmVudE5hbWU7CiAgICB0aGlzLmYgPSBmOwogIH07CgogIC8qKgogICAqIFVuc3Vic2NyaWJlIHRoZSBoYW5kbGVyIG9mIHRoaXMgc3Vic2NyaXB0aW9uIGZyb20gdGhlIEV2ZW50QnVzCiAgICogZnJvbSB3aGljaCBpdCB3YXMgY3JlYXRlZC4KICAgKi8KICBTdWJzY3JpcHRpb24ucHJvdG90eXBlLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5zdWJNYXAudW5zdWJzY3JpYmUodGhpcy5ldmVudE5hbWUsIHRoaXMuaWQpOwogIH07CgogIC8qKgogICAqIEEgbWFwIG9mIGV2ZW50IHN1YnNjcmlwdGlvbnMsIHVzZWQgYnkgdGhlIEV2ZW50QnVzLgogICAqLwogIHZhciBTdWJzY3JpcHRpb25NYXAgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnN1YklkTWFwID0ge307CiAgICB0aGlzLnN1YkV2ZW50TmFtZU1hcCA9IHt9OwogIH07CgogIC8qKgogICAqIEFkZCBhIHN1YnNjcmlwdGlvbiBmb3IgdGhlIG5hbWVkIGV2ZW50LiAgQ3JlYXRlcyBhIG5ldyBTdWJzY3JpcHRpb24KICAgKiBvYmplY3QgYW5kIHJldHVybnMgaXQuICBUaGlzIG9iamVjdCBjYW4gYmUgdXNlZCB0byB1bnN1YnNjcmliZS4KICAgKi8KICBTdWJzY3JpcHRpb25NYXAucHJvdG90eXBlLnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGYpIHsKICAgIHZhciBzdWIgPSBuZXcgU3Vic2NyaXB0aW9uKHRoaXMsIGV2ZW50TmFtZSwgZik7CgogICAgdGhpcy5zdWJJZE1hcFtzdWIuaWRdID0gc3ViOwogICAgdmFyIHN1Ykxpc3QgPSB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdIHx8IFtdOwogICAgc3ViTGlzdC5wdXNoKHN1Yik7CiAgICB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdID0gc3ViTGlzdDsKICAgIHJldHVybiBzdWI7CiAgfTsKCiAgLyoqCiAgICogVW5zdWJzY3JpYmUgYSBzdWJzY3JpcHRpb24gbWF0Y2hpbmcgdGhlIGdpdmVuIGV2ZW50IG5hbWUgYW5kIGlkLgogICAqLwogIFN1YnNjcmlwdGlvbk1hcC5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBzdWJJZCkgewogICAgaWYgKGNvbm5lY3QuY29udGFpbnModGhpcy5zdWJFdmVudE5hbWVNYXAsIGV2ZW50TmFtZSkpIHsKICAgICAgdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXSA9IHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0uZmlsdGVyKGZ1bmN0aW9uIChzKSB7IHJldHVybiBzLmlkICE9PSBzdWJJZDsgfSk7CgogICAgICBpZiAodGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXS5sZW5ndGggPCAxKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV07CiAgICAgIH0KICAgIH0KCiAgICBpZiAoY29ubmVjdC5jb250YWlucyh0aGlzLnN1YklkTWFwLCBzdWJJZCkpIHsKICAgICAgZGVsZXRlIHRoaXMuc3ViSWRNYXBbc3ViSWRdOwogICAgfQogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2YgYWxsIHN1YnNjcmlwdGlvbnMgaW4gdGhlIHN1YnNjcmlwdGlvbiBtYXAuCiAgICovCiAgU3Vic2NyaXB0aW9uTWFwLnByb3RvdHlwZS5nZXRBbGxTdWJzY3JpcHRpb25zID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QudmFsdWVzKHRoaXMuc3ViRXZlbnROYW1lTWFwKS5yZWR1Y2UoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgcmV0dXJuIGEuY29uY2F0KGIpOwogICAgfSwgW10pOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2Ygc3Vic2NyaXB0aW9ucyBmb3IgdGhlIGdpdmVuIGV2ZW50IG5hbWUsIG9yIGFuIGVtcHR5CiAgICogbGlzdCBpZiB0aGVyZSBhcmUgbm8gc3Vic2NyaXB0aW9ucy4KICAgKi8KICBTdWJzY3JpcHRpb25NYXAucHJvdG90eXBlLmdldFN1YnNjcmlwdGlvbnMgPSBmdW5jdGlvbiAoZXZlbnROYW1lKSB7CiAgICByZXR1cm4gdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXSB8fCBbXTsKICB9OwoKICAvKioKICAgKiBBbiBvYmplY3Qgd2hpY2ggbWFpbnRhaW5zIGEgbWFwIG9mIHN1YnNjcmlwdGlvbnMgYW5kIHNlcnZlcyBhcyB0aGUKICAgKiBtZWNoYW5pc20gZm9yIHRyaWdnZXJpbmcgZXZlbnRzIHRvIGJlIGhhbmRsZWQgYnkgc3Vic2NyaWJlcnMuCiAgICovCiAgdmFyIEV2ZW50QnVzID0gZnVuY3Rpb24gKHBhcmFtc0luKSB7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CgogICAgdGhpcy5zdWJNYXAgPSBuZXcgU3Vic2NyaXB0aW9uTWFwKCk7CiAgICB0aGlzLmxvZ0V2ZW50cyA9IHBhcmFtcy5sb2dFdmVudHMgfHwgZmFsc2U7CiAgfTsKCiAgLyoqCiAgICogU3Vic2NyaWJlIHRvIHRoZSBuYW1lZCBldmVudC4gIFJldHVybnMgYSBuZXcgU3Vic2NyaXB0aW9uIG9iamVjdAogICAqIHdoaWNoIGNhbiBiZSB1c2VkIHRvIHVuc3Vic2NyaWJlLgogICAqLwogIEV2ZW50QnVzLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBmKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZiwgJ2YnKTsKICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgcmV0dXJuIHRoaXMuc3ViTWFwLnN1YnNjcmliZShldmVudE5hbWUsIGYpOwogIH07CgogIC8qKgogICAqIFN1YnNjcmliZSBhIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBvbiBhbGwgZXZlbnRzLgogICAqLwogIEV2ZW50QnVzLnByb3RvdHlwZS5zdWJzY3JpYmVBbGwgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgIHJldHVybiB0aGlzLnN1Yk1hcC5zdWJzY3JpYmUoQUxMX0VWRU5UUywgZik7CiAgfTsKCiAgLyoqCiAgICogR2V0IGEgbGlzdCBvZiBzdWJzY3JpcHRpb25zIGZvciB0aGUgZ2l2ZW4gZXZlbnQgbmFtZSwgb3IgYW4gZW1wdHkKICAgKiBsaXN0IGlmIHRoZXJlIGFyZSBubyBzdWJzY3JpcHRpb25zLgogICAqLwogIEV2ZW50QnVzLnByb3RvdHlwZS5nZXRTdWJzY3JpcHRpb25zID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgcmV0dXJuIHRoaXMuc3ViTWFwLmdldFN1YnNjcmlwdGlvbnMoZXZlbnROYW1lKTsKICB9OwoKICAvKioKICAgKiBUcmlnZ2VyIHRoZSBnaXZlbiBldmVudCB3aXRoIHRoZSBnaXZlbiBkYXRhLiAgQWxsIG1ldGhvZHMgc3Vic2NyaWJlZAogICAqIHRvIHRoaXMgZXZlbnQgd2lsbCBiZSBjYWxsZWQgYW5kIGFyZSBwcm92aWRlZCB3aXRoIHRoZSBnaXZlbiBhcmJpdHJhcnkKICAgKiBkYXRhIG9iamVjdCBhbmQgdGhlIG5hbWUgb2YgdGhlIGV2ZW50LCBpbiB0aGF0IG9yZGVyLgogICAqLwogIEV2ZW50QnVzLnByb3RvdHlwZS50cmlnZ2VyID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgZGF0YSkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGFsbEV2ZW50U3VicyA9IHRoaXMuc3ViTWFwLmdldFN1YnNjcmlwdGlvbnMoQUxMX0VWRU5UUyk7CiAgICB2YXIgZXZlbnRTdWJzID0gdGhpcy5zdWJNYXAuZ2V0U3Vic2NyaXB0aW9ucyhldmVudE5hbWUpOwoKICAgIGlmICh0aGlzLmxvZ0V2ZW50cyAmJiAoZXZlbnROYW1lICE9PSBjb25uZWN0LkV2ZW50VHlwZS5MT0cgJiYgZXZlbnROYW1lICE9PSBjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVTUE9OU0UgJiYgZXZlbnROYW1lICE9PSBjb25uZWN0LkV2ZW50VHlwZS5BUElfTUVUUklDKSkgewogICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJQdWJsaXNoaW5nIGV2ZW50OiAlcyIsIGV2ZW50TmFtZSk7CiAgICB9CiAgICBhbGxFdmVudFN1YnMuY29uY2F0KGV2ZW50U3VicykuZm9yRWFjaChmdW5jdGlvbiAoc3ViKSB7CiAgICAgIHRyeSB7CiAgICAgICAgc3ViLmYoZGF0YSB8fCBudWxsLCBldmVudE5hbWUsIHNlbGYpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiJyVzJyBldmVudCBoYW5kbGVyIGZhaWxlZC4iLCBldmVudE5hbWUpLndpdGhFeGNlcHRpb24oZSk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIC8qKgogICAqIFJldHVybnMgYSBjbG9zdXJlIHdoaWNoIGJyaWRnZXMgYW4gZXZlbnQgZnJvbSBhbm90aGVyIEV2ZW50QnVzIHRvIHRoaXMgYnVzLgogICAqCiAgICogVXNhZ2U6CiAgICogY29uZHVpdC5vblVwc3RyZWFtKCJNeUV2ZW50IiwgYnVzLmJyaWRnZSgpKTsKICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuYnJpZGdlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgcmV0dXJuIGZ1bmN0aW9uIChkYXRhLCBldmVudCkgewogICAgICBzZWxmLnRyaWdnZXIoZXZlbnQsIGRhdGEpOwogICAgfTsKICB9OwoKICAvKioKICAgKiBVbnN1YnNjcmliZSBhbGwgZXZlbnRzIGluIHRoZSBldmVudCBidXMuCiAgICovCiAgRXZlbnRCdXMucHJvdG90eXBlLnVuc3Vic2NyaWJlQWxsID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5zdWJNYXAuZ2V0QWxsU3Vic2NyaXB0aW9ucygpLmZvckVhY2goZnVuY3Rpb24gKHN1YikgewogICAgICBzdWIudW5zdWJzY3JpYmUoKTsKICAgIH0pOwogIH07CgogIGNvbm5lY3QuRXZlbnRCdXMgPSBFdmVudEJ1czsKICBjb25uZWN0LkV2ZW50RmFjdG9yeSA9IEV2ZW50RmFjdG9yeTsKICBjb25uZWN0LkV2ZW50VHlwZSA9IEV2ZW50VHlwZTsKICBjb25uZWN0LkFnZW50RXZlbnRzID0gQWdlbnRFdmVudHM7CiAgY29ubmVjdC5Db25ubmVjdGlvbkV2ZW50cyA9IENvbm5uZWN0aW9uRXZlbnRzOwogIGNvbm5lY3QuQ29udGFjdEV2ZW50cyA9IENvbnRhY3RFdmVudHM7CiAgY29ubmVjdC5XZWJTb2NrZXRFdmVudHMgPSBXZWJTb2NrZXRFdmVudHM7CiAgY29ubmVjdC5NYXN0ZXJUb3BpY3MgPSBNYXN0ZXJUb3BpY3M7CiAgY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzID0gRGlzYXN0ZXJSZWNvdmVyeUV2ZW50czsKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbigpIHsKICAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgU3RyZWFtCiAgICAqCiAgICAqIFJlcHJlc2VudHMgYW4gb2JqZWN0IGZyb20gd2hpY2ggbWVzc2FnZXMgY2FuIGJlIHJlYWQgYW5kIHRvIHdoaWNoCiAgICAqIG1lc3NhZ2VzIGNhbiBiZSBzZW50LgogICAgKi8KICAgdmFyIFN0cmVhbSA9IGZ1bmN0aW9uKCkge307CgogICAvKioKICAgICogU2VuZCBhIG1lc3NhZ2UgdG8gdGhlIHN0cmVhbS4gIFRoaXMgbWV0aG9kIG11c3QgYmUgaW1wbGVtZW50ZWQgYnkgc3ViY2xhc3Nlcy4KICAgICovCiAgIFN0cmVhbS5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvcigpOwogICB9OwoKICAgLyoqCiAgICAqIFByb3ZpZGUgYSBtZXRob2QgdG8gYmUgY2FsbGVkIHdoZW4gbWVzc2FnZXMgYXJlIHJlY2VpdmVkIGZyb20gdGhpcyBzdHJlYW0uCiAgICAqIFRoaXMgbWV0aG9kIG11c3QgYmUgaW1wbGVtZW50ZWQgYnkgc3ViY2xhc3Nlcy4KICAgICovCiAgIFN0cmVhbS5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgTnVsbFN0cmVhbSBleHRlbmRzIFN0cmVhbQogICAgKgogICAgKiBBIG51bGwgc3RyZWFtIHdoaWNoIHByb3ZpZGVzIG5vIG1lc3NhZ2Ugc2VuZGluZyBvciByZWNlaXZpbmcgZmFjaWxpdGllcy4KICAgICovCiAgIHZhciBOdWxsU3RyZWFtID0gZnVuY3Rpb24oKSB7CiAgICAgIFN0cmVhbS5jYWxsKHRoaXMpOwogICB9OwogICBOdWxsU3RyZWFtLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoU3RyZWFtLnByb3RvdHlwZSk7CiAgIE51bGxTdHJlYW0ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gTnVsbFN0cmVhbTsKCiAgIE51bGxTdHJlYW0ucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHt9OwogICBOdWxsU3RyZWFtLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkge307CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgV2luZG93U3RyZWFtIGV4dGVuZHMgU3RyZWFtCiAgICAqCiAgICAqIEEgc3RyZWFtIGZvciBjb21tdW5pY2F0aW5nIHdpdGggYSB3aW5kb3cgb2JqZWN0LiAgVGhlIGRvbWFpbiBwcm92aWRlZAogICAgKiBtdXN0IG1hdGNoIHRoZSBhbGxvd2VkIG1lc3NhZ2UgZG9tYWlucyBvZiB0aGUgZG93bnN0cmVhbSByZWNlaXZlcgogICAgKiBvciBtZXNzYWdlcyB3aWxsIGJlIHJlamVjdGVkLCBzZWUgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL1dpbmRvdy9wb3N0TWVzc2FnZQogICAgKiBmb3IgbW9yZSBpbmZvLgogICAgKi8KICAgdmFyIFdpbmRvd1N0cmVhbSA9IGZ1bmN0aW9uKHdpbiwgZG9tYWluKSB7CiAgICAgIFN0cmVhbS5jYWxsKHRoaXMpOwogICAgICB0aGlzLndpbmRvdyA9IHdpbjsKICAgICAgdGhpcy5kb21haW4gPSBkb21haW4gfHwgJyonOwogICB9OwogICBXaW5kb3dTdHJlYW0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdHJlYW0ucHJvdG90eXBlKTsKICAgV2luZG93U3RyZWFtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFdpbmRvd1N0cmVhbTsKCiAgIFdpbmRvd1N0cmVhbS5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgdGhpcy53aW5kb3cucG9zdE1lc3NhZ2UobWVzc2FnZSwgdGhpcy5kb21haW4pOwogICB9OwoKICAgV2luZG93U3RyZWFtLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7CiAgICAgIHRoaXMud2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBmKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBXaW5kb3dJT1N0cmVhbSBleHRlbmRzIFN0cmVhbQogICAgKgogICAgKiBBIHN0cmVhbSB1c2VkIGJ5IElGcmFtZS9wb3B1cCB3aW5kb3dzIHRvIGNvbW11bmljYXRlIHdpdGggdGhlaXIgcGFyZW50cwogICAgKiBhbmQgdmlzZSB2ZXJzYS4KICAgICoKICAgICogVGhpcyBvYmplY3QgZW5jYXBzdWxhdGVzIHRoZSBmYWN0IHRoYXQgaW5jb21pbmcgYW5kIG91dGdvaW5nIG1lc3NhZ2VzCiAgICAqIGFycml2ZSBvbiBkaWZmZXJlbnQgd2luZG93cyBhbmQgYWxsb3dzIHRoaXMgdG8gYmUgbWFuYWdlZCBhcyBhIHNpbmdsZQogICAgKiBTdHJlYW0gb2JqZWN0LgogICAgKi8KICAgdmFyIFdpbmRvd0lPU3RyZWFtID0gZnVuY3Rpb24oaW5wdXR3aW4sIG91dHB1dHdpbiwgZG9tYWluKSB7CiAgICAgIFN0cmVhbS5jYWxsKHRoaXMpOwogICAgICB0aGlzLmlucHV0ID0gaW5wdXR3aW47CiAgICAgIHRoaXMub3V0cHV0ID0gb3V0cHV0d2luOwogICAgICB0aGlzLmRvbWFpbiA9IGRvbWFpbiB8fCAnKic7CiAgIH07CiAgIFdpbmRvd0lPU3RyZWFtLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoU3RyZWFtLnByb3RvdHlwZSk7CiAgIFdpbmRvd0lPU3RyZWFtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFdpbmRvd0lPU3RyZWFtOwoKICAgV2luZG93SU9TdHJlYW0ucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgIHRoaXMub3V0cHV0LnBvc3RNZXNzYWdlKG1lc3NhZ2UsIHRoaXMuZG9tYWluKTsKICAgfTsKCiAgIFdpbmRvd0lPU3RyZWFtLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7CiAgICAgIHRoaXMuaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIGYpOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFBvcnRTdHJlYW0gZXh0ZW5kcyBTdHJlYW0KICAgICoKICAgICogQSBzdHJlYW0gd3JhcHBpbmcgYW4gSFRNTDUgV29ya2VyIHBvcnQuICBUaGlzIGNvdWxkIGJlIHRoZSBwb3J0CiAgICAqIHVzZWQgdG8gY29ubmVjdCB0byBhIFdvcmtlciBvciBvbmUgb2YgdGhlIG11bHRpdHVkZSBvZiBwb3J0cwogICAgKiBtYWRlIGF2YWlsYWJsZSB0byBhIFNoYXJlZFdvcmtlciBmb3IgY29tbXVuaWNhdGlvbiBiYWNrIHRvCiAgICAqIGl0cyBjb25uZWN0ZWQgY2xpZW50cy4KICAgICovCiAgIHZhciBQb3J0U3RyZWFtID0gZnVuY3Rpb24ocG9ydCkgewogICAgICBTdHJlYW0uY2FsbCh0aGlzKTsKICAgICAgdGhpcy5wb3J0ID0gcG9ydDsKICAgICAgdGhpcy5pZCA9IGNvbm5lY3QucmFuZG9tSWQoKTsKICAgfTsKICAgUG9ydFN0cmVhbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUpOwogICBQb3J0U3RyZWFtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBvcnRTdHJlYW07CgogICBQb3J0U3RyZWFtLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aGlzLnBvcnQucG9zdE1lc3NhZ2UobWVzc2FnZSk7CiAgIH07CgogICBQb3J0U3RyZWFtLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7CiAgICAgIHRoaXMucG9ydC5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgZik7CiAgIH07CgogICBQb3J0U3RyZWFtLnByb3RvdHlwZS5nZXRJZCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5pZDsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBTdHJlYW1NdWx0aXBsZXhlciBleHRlbmRzIFN0cmVhbQogICAgKgogICAgKiBBIHdyYXBwZXIgZm9yIG11bHRpcGxleGVkIGRvd25zdHJlYW0gY29tbXVuaWNhdGlvbiB3aXRoCiAgICAqIG11bHRpcGxlIHN0cmVhbXMgYXQgb25jZS4gIE1haW5seSB1c2VmdWwgZm9yIHRoZSBTaGFyZWRXb3JrZXIgdG8KICAgICogYnJvYWRjYXN0IGV2ZW50cyB0byBtYW55IFBvcnRTdHJlYW0gb2JqZWN0cyBhdCBvbmNlLgogICAgKi8KICAgdmFyIFN0cmVhbU11bHRpcGxleGVyID0gZnVuY3Rpb24oc3RyZWFtcykgewogICAgICBTdHJlYW0uY2FsbCh0aGlzKTsKICAgICAgdGhpcy5zdHJlYW1NYXAgPSBzdHJlYW1zID8KICAgICAgICAgY29ubmVjdC5pbmRleChzdHJlYW1zLCBmdW5jdGlvbihzKSB7IHJldHVybiBzLmdldElkKCk7IH0pIDoge307CiAgICAgIHRoaXMubWVzc2FnZUxpc3RlbmVycyA9IFtdOwogICB9OwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUpOwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBTdHJlYW1NdWx0aXBsZXhlcjsKCiAgIC8qKgogICAgKiBTZW5kIGEgbWVzc2FnZSB0byBhbGwgcG9ydHMgaW4gdGhlIG11bHRpcGxleGVyLgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgIHRoaXMuZ2V0U3RyZWFtcygpLmZvckVhY2goZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHN0cmVhbS5zZW5kKG1lc3NhZ2UpOwoKICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAvLyBDb3VsZG4ndCBzZW5kIG1lc3NhZ2UgdG8gb25lIG9mIHRoZSBkb3duc3RyZWFtcyBmb3Igc29tZSByZWFzb24uLi4KICAgICAgICAgICAgLy8gTm8gcmVsaWFibGUgbG9nZ2luZyBwb3NzaWJsZSB3aXRob3V0IGZ1cnRoZXIgZmFpbHVyZXMsCiAgICAgICAgICAgIC8vIG5vIHJlY292ZXJ5LCBqdXN0IGVhdCBpdC4KICAgICAgICAgfQogICAgICB9KTsKICAgfTsKCiAgIC8qKgogICAgKiBSZWdpc3RlciBhIG1ldGhvZCB3aGljaCB3aWxsIGJlIGNhbGxlZCB3aGVuIGEgbWVzc2FnZSBpcyByZWNlaXZlZCBmcm9tCiAgICAqIGFueSBvZiB0aGUgZG93bnN0cmVhbXMuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikgewogICAgICB0aGlzLm1lc3NhZ2VMaXN0ZW5lcnMucHVzaChmKTsKCiAgICAgIC8vIFVwZGF0ZSBleGlzdGluZyBzdHJlYW1zIHdpdGggdGhlIG5ldyBsaXN0ZW5lci4KICAgICAgdGhpcy5nZXRTdHJlYW1zKCkuZm9yRWFjaChmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgc3RyZWFtLm9uTWVzc2FnZShmKTsKICAgICAgfSk7CiAgIH07CgogICAvKioKICAgICogQWRkIGEgc3RyZWFtIHRvIHRoZSBtdWx0aXBsZXhlci4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5hZGRTdHJlYW0gPSBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB0aGlzLnN0cmVhbU1hcFtzdHJlYW0uZ2V0SWQoKV0gPSBzdHJlYW07CgogICAgICAvLyBVcGRhdGUgc3RyZWFtIHdpdGggZXhpc3RpbmcgbGlzdGVuZXJzLgogICAgICB0aGlzLm1lc3NhZ2VMaXN0ZW5lcnMuZm9yRWFjaChmdW5jdGlvbihtZXNzYWdlTGlzdGVuZXIpIHsKICAgICAgICAgc3RyZWFtLm9uTWVzc2FnZShtZXNzYWdlTGlzdGVuZXIpOwogICAgICB9KTsKICAgfTsKCiAgIC8qKgogICAgKiBSZW1vdmUgdGhlIGdpdmVuIGRvd25zdHJlYW0uICBUaGlzIGlzIHR5cGljYWxseSB1c2VkIGluIHJlc3BvbnNlCiAgICAqIHRvIHRoZSBTaGFyZWRXb3JrZXIncyBvbmNsb3NlIGV2ZW50LCBpbmRpY2F0aW5nIHRoYXQgYSBjb25zdW1lcgogICAgKiB0YWIgaGFzIGJlZW4gY2xvc2VkLgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLnJlbW92ZVN0cmVhbSA9IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICBkZWxldGUgdGhpcy5zdHJlYW1NYXBbc3RyZWFtLmdldElkKCldOwogICB9OwoKICAgLyoqCiAgICAqIEdldCBhIGxpc3Qgb2Ygc3RyZWFtcyBpbiB0aGUgbXVsdGlwbGV4ZXIuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUuZ2V0U3RyZWFtcyA9IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICByZXR1cm4gY29ubmVjdC52YWx1ZXModGhpcy5zdHJlYW1NYXApOwogICB9OwoKICAgLyoqCiAgICAqIEdldCB0aGUgc3RyZWFtIG1hdGNoaW5nIHRoZSBnaXZlbiBwb3J0LgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLmdldFN0cmVhbUZvclBvcnQgPSBmdW5jdGlvbihwb3J0KSB7CiAgICAgIHJldHVybiBjb25uZWN0LmZpbmQodGhpcy5nZXRTdHJlYW1zKCksIGZ1bmN0aW9uKHMpIHsKICAgICAgICAgcmV0dXJuIHMucG9ydCA9PT0gcG9ydDsKICAgICAgfSk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgQ29uZHVpdAogICAgKgogICAgKiBBbiBvYmplY3Qgd2hpY2ggYnJpZGdlcyBhbiB1cHN0cmVhbSBhbmQgYSBkb3duc3RyZWFtLCBhbGxvd2luZyBtZXNzYWdlcwogICAgKiB0byBiZSBwYXNzZWQgdG8gYW5kIGZyb20gZWFjaCBhbmQgcHJvdmlkaW5nIGFuIGV2ZW50IGJ1cyBmb3IgZXZlbnQKICAgICogc3Vic2NyaXB0aW9ucyB0byBiZSBtYWRlIHVwc3RyZWFtIGFuZCBkb3duc3RyZWFtLgogICAgKi8KICAgdmFyIENvbmR1aXQgPSBmdW5jdGlvbihuYW1lLCB1cHN0cmVhbSwgZG93bnN0cmVhbSkgewogICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICB0aGlzLnVwc3RyZWFtID0gdXBzdHJlYW0gfHwgbmV3IE51bGxTdHJlYW0oKTsKICAgICAgdGhpcy5kb3duc3RyZWFtID0gZG93bnN0cmVhbSB8fCBuZXcgTnVsbFN0cmVhbSgpOwogICAgICB0aGlzLmRvd25zdHJlYW1CdXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cygpOwogICAgICB0aGlzLnVwc3RyZWFtQnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoKTsKCiAgICAgIHRoaXMudXBzdHJlYW0ub25NZXNzYWdlKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5fZGlzcGF0Y2hFdmVudCwgdGhpcy51cHN0cmVhbUJ1cykpOwogICAgICB0aGlzLmRvd25zdHJlYW0ub25NZXNzYWdlKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5fZGlzcGF0Y2hFdmVudCwgdGhpcy5kb3duc3RyZWFtQnVzKSk7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5vblVwc3RyZWFtID0gZnVuY3Rpb24oZXZlbnROYW1lLCBmKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICByZXR1cm4gdGhpcy51cHN0cmVhbUJ1cy5zdWJzY3JpYmUoZXZlbnROYW1lLCBmKTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLm9uQWxsVXBzdHJlYW0gPSBmdW5jdGlvbihmKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgcmV0dXJuIHRoaXMudXBzdHJlYW1CdXMuc3Vic2NyaWJlQWxsKGYpOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUub25Eb3duc3RyZWFtID0gZnVuY3Rpb24oZXZlbnROYW1lLCBmKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICByZXR1cm4gdGhpcy5kb3duc3RyZWFtQnVzLnN1YnNjcmliZShldmVudE5hbWUsIGYpOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUub25BbGxEb3duc3RyZWFtID0gZnVuY3Rpb24oZikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZiwgJ2YnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIHJldHVybiB0aGlzLmRvd25zdHJlYW1CdXMuc3Vic2NyaWJlQWxsKGYpOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUuc2VuZFVwc3RyZWFtID0gZnVuY3Rpb24oZXZlbnROYW1lLCBkYXRhKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgICAgdGhpcy51cHN0cmVhbS5zZW5kKHtldmVudDogZXZlbnROYW1lLCBkYXRhOiBkYXRhfSk7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5zZW5kRG93bnN0cmVhbSA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZGF0YSkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICAgIHRoaXMuZG93bnN0cmVhbS5zZW5kKHtldmVudDogZXZlbnROYW1lLCBkYXRhOiBkYXRhfSk7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5fZGlzcGF0Y2hFdmVudCA9IGZ1bmN0aW9uKGJ1cywgbWVzc2FnZUV2ZW50KSB7CiAgICAgIHZhciBtZXNzYWdlID0gbWVzc2FnZUV2ZW50LmRhdGE7CiAgICAgIGlmIChtZXNzYWdlLmV2ZW50KSB7CiAgICAgICAgIGJ1cy50cmlnZ2VyKG1lc3NhZ2UuZXZlbnQsIG1lc3NhZ2UuZGF0YSk7CiAgICAgIH0KICAgfTsKCiAgIC8qKgogICAgKiBSZXR1cm5zIGEgY2xvc3VyZSB3aGljaCBwYXNzZXMgZXZlbnRzIHVwc3RyZWFtLgogICAgKgogICAgKiBVc2FnZToKICAgICogY29uZHVpdC5vbkRvd25zdHJlYW0oIk15RXZlbnQiLCBjb25kdWl0LnBhc3NVcHN0cmVhbSgpKTsKICAgICovCiAgIENvbmR1aXQucHJvdG90eXBlLnBhc3NVcHN0cmVhbSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHJldHVybiBmdW5jdGlvbihkYXRhLCBldmVudE5hbWUpIHsKICAgICAgICAgc2VsZi51cHN0cmVhbS5zZW5kKHtldmVudDogZXZlbnROYW1lLCBkYXRhOiBkYXRhfSk7CiAgICAgIH07CiAgIH07CgogICAvKioKICAgICogUmV0dXJucyBhIGNsb3N1cmUgd2hpY2ggcGFzc2VzIGV2ZW50cyBkb3duc3RyZWFtLgogICAgKgogICAgKiBVc2FnZToKICAgICogY29uZHVpdC5vblVwc3RyZWFtKCJNeUV2ZW50IiwgY29uZHVpdC5wYXNzRG93bnN0cmVhbSgpKTsKICAgICovCiAgIENvbmR1aXQucHJvdG90eXBlLnBhc3NEb3duc3RyZWFtID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGRhdGEsIGV2ZW50TmFtZSkgewogICAgICAgICBzZWxmLmRvd25zdHJlYW0uc2VuZCh7ZXZlbnQ6IGV2ZW50TmFtZSwgZGF0YTogZGF0YX0pOwogICAgICB9OwogICB9OwoKICAgLyoqCiAgICAqIFNodXRkb3duIHRoZSBjb25kdWl0J3MgZXZlbnQgYnVzc2VzIGFuZCByZW1vdmUgYWxsIHN1YnNjcmlwdGlvbnMuCiAgICAqLwogICBDb25kdWl0LnByb3RvdHlwZS5zaHV0ZG93biA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnVwc3RyZWFtQnVzLnVuc3Vic2NyaWJlQWxsKCk7CiAgICAgIHRoaXMuZG93bnN0cmVhbUJ1cy51bnN1YnNjcmliZUFsbCgpOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIElGcmFtZUNvbmR1aXQgZXh0ZW5kcyBDb25kdWl0CiAgICAqCiAgICAqIENyZWF0ZXMgYSBjb25kdWl0IGZvciB0aGUgZ2l2ZW4gSUZyYW1lIGVsZW1lbnQuCiAgICAqLwogICB2YXIgSUZyYW1lQ29uZHVpdCA9IGZ1bmN0aW9uKG5hbWUsIHdpbmRvdywgaWZyYW1lLCBkb21haW4pIHsKICAgICAgQ29uZHVpdC5jYWxsKHRoaXMsIG5hbWUsIG5ldyBXaW5kb3dJT1N0cmVhbSh3aW5kb3csIGlmcmFtZS5jb250ZW50V2luZG93LCBkb21haW4gfHwgJyonKSwgbnVsbCk7CiAgIH07CiAgIElGcmFtZUNvbmR1aXQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb25kdWl0LnByb3RvdHlwZSk7CiAgIElGcmFtZUNvbmR1aXQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gSUZyYW1lQ29uZHVpdDsKCiAgIGNvbm5lY3QuU3RyZWFtID0gU3RyZWFtOwogICBjb25uZWN0Lk51bGxTdHJlYW0gPSBOdWxsU3RyZWFtOwogICBjb25uZWN0LldpbmRvd1N0cmVhbSA9IFdpbmRvd1N0cmVhbTsKICAgY29ubmVjdC5XaW5kb3dJT1N0cmVhbSA9IFdpbmRvd0lPU3RyZWFtOwogICBjb25uZWN0LlBvcnRTdHJlYW0gPSBQb3J0U3RyZWFtOwogICBjb25uZWN0LlN0cmVhbU11bHRpcGxleGVyID0gU3RyZWFtTXVsdGlwbGV4ZXI7CiAgIGNvbm5lY3QuQ29uZHVpdCA9IENvbmR1aXQ7CiAgIGNvbm5lY3QuSUZyYW1lQ29uZHVpdCA9IElGcmFtZUNvbmR1aXQ7Cn0pKCk7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24oKSB7CiAgIHZhciBnbG9iYWwgPSB0aGlzOwogICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGVudW0gQ2xpZW50TWV0aG9kcwogICAgKi8KICAgY29ubmVjdC5DbGllbnRNZXRob2RzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAgICAgICdnZXRBZ2VudFNuYXBzaG90JywKICAgICAgICAgJ3B1dEFnZW50U3RhdGUnLAogICAgICAgICAnZ2V0QWdlbnRTdGF0ZXMnLAogICAgICAgICAnZ2V0RGlhbGFibGVDb3VudHJ5Q29kZXMnLAogICAgICAgICAnZ2V0Um91dGluZ1Byb2ZpbGVRdWV1ZXMnLAogICAgICAgICAnZ2V0QWdlbnRQZXJtaXNzaW9ucycsCiAgICAgICAgICdnZXRBZ2VudENvbmZpZ3VyYXRpb24nLAogICAgICAgICAndXBkYXRlQWdlbnRDb25maWd1cmF0aW9uJywKICAgICAgICAgJ2FjY2VwdENvbnRhY3QnLAogICAgICAgICAnY3JlYXRlT3V0Ym91bmRDb250YWN0JywKICAgICAgICAgJ2NsZWFyQ29udGFjdCcsCiAgICAgICAgICdjb21wbGV0ZUNvbnRhY3QnLAogICAgICAgICAnZGVzdHJveUNvbnRhY3QnLAogICAgICAgICAncmVqZWN0Q29udGFjdCcsCiAgICAgICAgICdub3RpZnlDb250YWN0SXNzdWUnLAogICAgICAgICAndXBkYXRlQ29udGFjdEF0dHJpYnV0ZXMnLAogICAgICAgICAnY3JlYXRlQWRkaXRpb25hbENvbm5lY3Rpb24nLAogICAgICAgICAnZGVzdHJveUNvbm5lY3Rpb24nLAogICAgICAgICAnaG9sZENvbm5lY3Rpb24nLAogICAgICAgICAncmVzdW1lQ29ubmVjdGlvbicsCiAgICAgICAgICd0b2dnbGVBY3RpdmVDb25uZWN0aW9ucycsCiAgICAgICAgICdjb25mZXJlbmNlQ29ubmVjdGlvbnMnLAogICAgICAgICAnc2VuZENsaWVudExvZ3MnLAogICAgICAgICAnc2VuZERpZ2l0cycsCiAgICAgICAgICdzZW5kU29mdHBob25lQ2FsbFJlcG9ydCcsCiAgICAgICAgICdzZW5kU29mdHBob25lQ2FsbE1ldHJpY3MnLAogICAgICAgICAnZ2V0RW5kcG9pbnRzJywKICAgICAgICAgJ2dldE5ld0F1dGhUb2tlbicsCiAgICAgICAgICdjcmVhdGVUcmFuc3BvcnQnCiAgIF0pOwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGVudW0gTWFzdGVyTWV0aG9kcwogICAgKi8KICAgY29ubmVjdC5NYXN0ZXJNZXRob2RzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAgICAgICdiZWNvbWVNYXN0ZXInLAogICAgICAgICAnY2hlY2tNYXN0ZXInCiAgIF0pOwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGFic3RyYWN0IGNsYXNzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBDbGllbnRCYXNlID0gZnVuY3Rpb24oKSB7fTsKICAgQ2xpZW50QmFzZS5FTVBUWV9DQUxMQkFDS1MgPSB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKCkgeyB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbigpIHsgfQogICB9OwoKICAgQ2xpZW50QmFzZS5wcm90b3R5cGUuY2FsbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zSW4sIGNhbGxiYWNrc0luKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChtZXRob2QsICdtZXRob2QnKTsKICAgICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgICB2YXIgY2FsbGJhY2tzID0gY2FsbGJhY2tzSW4gfHwgQ2xpZW50QmFzZS5FTVBUWV9DQUxMQkFDS1M7CiAgICAgIHRoaXMuX2NhbGxJbXBsKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpOwogICB9OwoKICAgQ2xpZW50QmFzZS5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgTnVsbENsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBOdWxsQ2xpZW50ID0gZnVuY3Rpb24oKSB7CiAgICAgIENsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgfTsKICAgTnVsbENsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgTnVsbENsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBOdWxsQ2xpZW50OwoKICAgTnVsbENsaWVudC5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgIHZhciBtZXNzYWdlID0gY29ubmVjdC5zcHJpbnRmKCdObyBzdWNoIG1ldGhvZCBleGlzdHMgb24gTlVMTCBjbGllbnQ6ICVzJywgbWV0aG9kKTsKICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUobmV3IGNvbm5lY3QuVmFsdWVFcnJvcihtZXNzYWdlKSwge21lc3NhZ2U6IG1lc3NhZ2V9KTsKICAgICAgfQogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGFic3RyYWN0IGNsYXNzIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICAqLwogICB2YXIgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZSA9IGZ1bmN0aW9uKGNvbmR1aXQsIHJlcXVlc3RFdmVudCwgcmVzcG9uc2VFdmVudCkgewogICAgICBDbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuY29uZHVpdCA9IGNvbmR1aXQ7CiAgICAgIHRoaXMucmVxdWVzdEV2ZW50ID0gcmVxdWVzdEV2ZW50OwogICAgICB0aGlzLnJlc3BvbnNlRXZlbnQgPSByZXNwb25zZUV2ZW50OwogICAgICB0aGlzLl9yZXF1ZXN0SWRDYWxsYmFja3NNYXAgPSB7fTsKCiAgICAgIHRoaXMuY29uZHVpdC5vblVwc3RyZWFtKHJlc3BvbnNlRXZlbnQsIGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5faGFuZGxlUmVzcG9uc2UpKTsKICAgfTsKCiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZTsKCiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgICAgdmFyIHJlcXVlc3QgPSBjb25uZWN0LkV2ZW50RmFjdG9yeS5jcmVhdGVSZXF1ZXN0KHRoaXMucmVxdWVzdEV2ZW50LCBtZXRob2QsIHBhcmFtcyk7CiAgICAgIHRoaXMuX3JlcXVlc3RJZENhbGxiYWNrc01hcFtyZXF1ZXN0LnJlcXVlc3RJZF0gPSBjYWxsYmFja3M7CiAgICAgIHRoaXMuY29uZHVpdC5zZW5kVXBzdHJlYW0ocmVxdWVzdC5ldmVudCwgcmVxdWVzdCk7CiAgIH07CgogICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZS5fZ2V0Q2FsbGJhY2tzRm9yUmVxdWVzdCA9IGZ1bmN0aW9uKHJlcXVlc3RJZCkgewogICAgICB2YXIgY2FsbGJhY2tzID0gdGhpcy5fcmVxdWVzdElkQ2FsbGJhY2tzTWFwW3JlcXVlc3RJZF0gfHwgbnVsbDsKCiAgICAgIGlmIChjYWxsYmFja3MgIT0gbnVsbCkgewogICAgICAgICBkZWxldGUgdGhpcy5fcmVxdWVzdElkQ2FsbGJhY2tzTWFwW3JlcXVlc3RJZF07CiAgICAgIH0KCiAgICAgIHJldHVybiBjYWxsYmFja3M7CiAgIH07CgogICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZS5faGFuZGxlUmVzcG9uc2UgPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHZhciBjYWxsYmFja3MgPSB0aGlzLl9nZXRDYWxsYmFja3NGb3JSZXF1ZXN0KGRhdGEucmVxdWVzdElkKTsKICAgICAgaWYgKGNhbGxiYWNrcyA9PSBudWxsKSB7CiAgICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGRhdGEuZXJyICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGRhdGEuZXJyLCBkYXRhLmRhdGEpOwoKICAgICAgfSBlbHNlIGlmIChjYWxsYmFja3Muc3VjY2VzcykgewogICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhLmRhdGEpOwogICAgICB9CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgVXBzdHJlYW1Db25kdWl0Q2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIFVwc3RyZWFtQ29uZHVpdENsaWVudCA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5jYWxsKHRoaXMsIGNvbmR1aXQsIGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9SRVFVRVNULCBjb25uZWN0LkV2ZW50VHlwZS5BUElfUkVTUE9OU0UpOwogICB9OwogICBVcHN0cmVhbUNvbmR1aXRDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBVcHN0cmVhbUNvbmR1aXRDbGllbnQ7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudCA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5jYWxsKHRoaXMsIGNvbmR1aXQsIGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVFVRVNULCBjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVTUE9OU0UpOwogICB9OwogICBVcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBVcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQ7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgQVdTQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIEFXU0NsaWVudCA9IGZ1bmN0aW9uKGF1dGhUb2tlbiwgcmVnaW9uLCBlbmRwb2ludEluKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChhdXRoVG9rZW4sICdhdXRoVG9rZW4nKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJlZ2lvbiwgJ3JlZ2lvbicpOwogICAgICBDbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgICAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKHt9KTsKICAgICAgQVdTLmNvbmZpZy5yZWdpb24gPSByZWdpb247CiAgICAgIHRoaXMuYXV0aFRva2VuID0gYXV0aFRva2VuOwogICAgICB2YXIgZW5kcG9pbnRVcmwgPSBlbmRwb2ludEluIHx8IGNvbm5lY3QuZ2V0QmFzZVVybCgpICsgJy9jb25uZWN0L2FwaSc7CiAgICAgIHZhciBlbmRwb2ludCA9IG5ldyBBV1MuRW5kcG9pbnQoZW5kcG9pbnRVcmwpOwogICAgICB0aGlzLmNsaWVudCA9IG5ldyBBV1MuQ29ubmVjdCh7ZW5kcG9pbnQ6IGVuZHBvaW50fSk7CiAgIH07CiAgIEFXU0NsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEFXU0NsaWVudDsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBsb2cgPSBjb25uZWN0LmdldExvZygpOwoKICAgICAgaWYgKCEgY29ubmVjdC5jb250YWlucyh0aGlzLmNsaWVudCwgbWV0aG9kKSkgewogICAgICAgICB2YXIgbWVzc2FnZSA9IGNvbm5lY3Quc3ByaW50ZignTm8gc3VjaCBtZXRob2QgZXhpc3RzIG9uIEFXUyBjbGllbnQ6ICVzJywgbWV0aG9kKTsKICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUobmV3IGNvbm5lY3QuVmFsdWVFcnJvcihtZXNzYWdlKSwge21lc3NhZ2U6IG1lc3NhZ2V9KTsKCiAgICAgIH0gZWxzZSB7CiAgICAgICAgIHBhcmFtcyA9IHRoaXMuX3RyYW5zbGF0ZVBhcmFtcyhtZXRob2QsIHBhcmFtcyk7CgogICAgICAgICBsb2cudHJhY2UoIkFXU0NsaWVudDogLS0+IENhbGxpbmcgb3BlcmF0aW9uICclcyciLCBtZXRob2QpOwoKICAgICAgICAgdGhpcy5jbGllbnRbbWV0aG9kXShwYXJhbXMpCiAgICAgICAgICAgIC5vbignYnVpbGQnLCBmdW5jdGlvbihyZXF1ZXN0KSB7CiAgICAgICAgICAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snWC1BbXotQmVhcmVyJ10gPSBzZWxmLmF1dGhUb2tlbjsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgaWYgKGVyci5jb2RlID09PSBjb25uZWN0LkNUSUV4Y2VwdGlvbnMuVU5BVVRIT1JJWkVEX0VYQ0VQVElPTikgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3MuYXV0aEZhaWx1cmUoKTsKICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjYWxsYmFja3MuYWNjZXNzRGVuaWVkICYmIChlcnIuY29kZSA9PT0gY29ubmVjdC5DVElFeGNlcHRpb25zLkFDQ0VTU19ERU5JRURfRVhDRVBUSU9OIHx8IGVyci5zdGF0dXNDb2RlID09PSA0MDMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5hY2Nlc3NEZW5pZWQoKTsKICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FuJ3QgcGFzcyBlcnIgZGlyZWN0bHkgdG8gcG9zdE1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcG9zdE1lc3NhZ2UoKSB0cmllcyB0byBjbG9uZSB0aGUgZXJyIG9iamVjdCBhbmQgZmFpbGVkLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZWZlciB0byBodHRwczovL2dpdGh1Yi5jb20vZ29hdHNsYWNrZXIvYWx0LWRldnRvb2wvaXNzdWVzLzUKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLnR5cGUgPSBlcnIuY29kZTsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IubWVzc2FnZSA9IGVyci5tZXNzYWdlOwogICAgICAgICAgICAgICAgICAgICAgICBlcnJvci5zdGFjayA9IGVyci5zdGFjayA/IGVyci5zdGFjay5zcGxpdCgnXG4nKSA6IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvciwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgIGxvZy50cmFjZSgiQVdTQ2xpZW50OiA8LS0gT3BlcmF0aW9uICclcycgZmFpbGVkOiAlcyIsIG1ldGhvZCwgSlNPTi5zdHJpbmdpZnkoZXJyKSk7CgogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICBsb2cudHJhY2UoIkFXU0NsaWVudDogPC0tIE9wZXJhdGlvbiAnJXMnIHN1Y2NlZWRlZC4iLCBtZXRob2QpLndpdGhPYmplY3QoZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGhhbmRsZSBBV1MgQVBJIHJlcXVlc3QgZm9yIG1ldGhvZCAlcyIsIG1ldGhvZCkKICAgICAgICAgICAgICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZSk7CiAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgIH0KICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3JlcXVpcmVzQXV0aGVudGljYXRpb25QYXJhbSA9IGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgcmV0dXJuIG1ldGhvZCAhPT0gY29ubmVjdC5DbGllbnRNZXRob2RzLkNPTVBMRVRFX0NPTlRBQ1QgJiYKICAgICAgICAgbWV0aG9kICE9PSBjb25uZWN0LkNsaWVudE1ldGhvZHMuQ0xFQVJfQ09OVEFDVCAmJgogICAgICAgICBtZXRob2QgIT09IGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5SRUpFQ1RfQ09OVEFDVDsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZVBhcmFtcyA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zKSB7CiAgICAgIHN3aXRjaCAobWV0aG9kKSB7CiAgICAgICAgIGNhc2UgY29ubmVjdC5DbGllbnRNZXRob2RzLlVQREFURV9BR0VOVF9DT05GSUdVUkFUSU9OOgogICAgICAgICAgICBwYXJhbXMuY29uZmlndXJhdGlvbiA9IHRoaXMuX3RyYW5zbGF0ZUFnZW50Q29uZmlndXJhdGlvbihwYXJhbXMuY29uZmlndXJhdGlvbik7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgY2FzZSBjb25uZWN0LkNsaWVudE1ldGhvZHMuU0VORF9TT0ZUUEhPTkVfQ0FMTF9NRVRSSUNTOgogICAgICAgICAgICBwYXJhbXMuc29mdHBob25lU3RyZWFtU3RhdGlzdGljcyA9IHRoaXMuX3RyYW5zbGF0ZVNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MoCiAgICAgICAgICAgICAgICAgIHBhcmFtcy5zb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICBjYXNlIGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX1NPRlRQSE9ORV9DQUxMX1JFUE9SVDoKICAgICAgICAgICAgcGFyYW1zLnJlcG9ydCA9IHRoaXMuX3RyYW5zbGF0ZVNvZnRwaG9uZUNhbGxSZXBvcnQocGFyYW1zLnJlcG9ydCk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgYnJlYWs7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9yZXF1aXJlc0F1dGhlbnRpY2F0aW9uUGFyYW0obWV0aG9kKSkgewogICAgICAgICBwYXJhbXMuYXV0aGVudGljYXRpb24gPSB7CiAgICAgICAgICAgIGF1dGhUb2tlbjogdGhpcy5hdXRoVG9rZW4KICAgICAgICAgfTsKICAgICAgfQoKICAgICAgcmV0dXJuIHBhcmFtczsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZUFnZW50Q29uZmlndXJhdGlvbiA9IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICByZXR1cm4gewogICAgICAgICBuYW1lOiBjb25maWcubmFtZSwKICAgICAgICAgc29mdHBob25lRW5hYmxlZDogY29uZmlnLnNvZnRwaG9uZUVuYWJsZWQsCiAgICAgICAgIHNvZnRwaG9uZUF1dG9BY2NlcHQ6IGNvbmZpZy5zb2Z0cGhvbmVBdXRvQWNjZXB0LAogICAgICAgICBleHRlbnNpb246IGNvbmZpZy5leHRlbnNpb24sCiAgICAgICAgIHJvdXRpbmdQcm9maWxlOiB0aGlzLl90cmFuc2xhdGVSb3V0aW5nUHJvZmlsZShjb25maWcucm91dGluZ1Byb2ZpbGUpLAogICAgICAgICBhZ2VudFByZWZlcmVuY2VzOiBjb25maWcuYWdlbnRQcmVmZXJlbmNlcwogICAgICB9OwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlUm91dGluZ1Byb2ZpbGUgPSBmdW5jdGlvbihwcm9maWxlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgIG5hbWU6IHByb2ZpbGUubmFtZSwKICAgICAgICAgcm91dGluZ1Byb2ZpbGVBUk46IHByb2ZpbGUucm91dGluZ1Byb2ZpbGVBUk4sCiAgICAgICAgIGRlZmF1bHRPdXRib3VuZFF1ZXVlOiB0aGlzLl90cmFuc2xhdGVRdWV1ZShwcm9maWxlLmRlZmF1bHRPdXRib3VuZFF1ZXVlKQogICAgICB9OwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlUXVldWUgPSBmdW5jdGlvbihxdWV1ZSkgewogICAgICByZXR1cm4gewogICAgICAgICBxdWV1ZUFSTjogICBxdWV1ZS5xdWV1ZUFSTiwKICAgICAgICAgbmFtZTogICAgICAgcXVldWUubmFtZQogICAgICB9OwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlU29mdHBob25lU3RyZWFtU3RhdGlzdGljcyA9IGZ1bmN0aW9uKHN0YXRzKSB7CiAgICAgIHN0YXRzLmZvckVhY2goZnVuY3Rpb24oc3RhdCkgewogICAgICAgICBpZiAoJ3BhY2tldHNDb3VudCcgaW4gc3RhdCkgewogICAgICAgICAgICBzdGF0LnBhY2tldENvdW50ID0gc3RhdC5wYWNrZXRzQ291bnQ7CiAgICAgICAgICAgIGRlbGV0ZSBzdGF0LnBhY2tldHNDb3VudDsKICAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHJldHVybiBzdGF0czsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZVNvZnRwaG9uZUNhbGxSZXBvcnQgPSBmdW5jdGlvbihyZXBvcnQpIHsKICAgICAgaWYgKCdoYW5kc2hha2luZ1RpbWVNaWxsaXMnIGluIHJlcG9ydCkgewogICAgICAgICByZXBvcnQuaGFuZHNoYWtlVGltZU1pbGxpcyA9IHJlcG9ydC5oYW5kc2hha2luZ1RpbWVNaWxsaXM7CiAgICAgICAgIGRlbGV0ZSByZXBvcnQuaGFuZHNoYWtpbmdUaW1lTWlsbGlzOwogICAgICB9CgogICAgICBpZiAoJ3ByZVRhbGtpbmdUaW1lTWlsbGlzJyBpbiByZXBvcnQpIHsKICAgICAgICAgcmVwb3J0LnByZVRhbGtUaW1lTWlsbGlzID0gcmVwb3J0LnByZVRhbGtpbmdUaW1lTWlsbGlzOwogICAgICAgICBkZWxldGUgcmVwb3J0LnByZVRhbGtpbmdUaW1lTWlsbGlzOwogICAgICB9CgogICAgICBpZiAoJ2hhbmRzaGFraW5nRmFpbHVyZScgaW4gcmVwb3J0KSB7CiAgICAgICAgIHJlcG9ydC5oYW5kc2hha2VGYWlsdXJlID0gcmVwb3J0LmhhbmRzaGFraW5nRmFpbHVyZTsKICAgICAgICAgZGVsZXRlIHJlcG9ydC5oYW5kc2hha2luZ0ZhaWx1cmU7CiAgICAgIH0KCiAgICAgIGlmICgndGFsa2luZ1RpbWVNaWxsaXMnIGluIHJlcG9ydCkgewogICAgICAgICByZXBvcnQudGFsa1RpbWVNaWxsaXMgPSByZXBvcnQudGFsa2luZ1RpbWVNaWxsaXM7CiAgICAgICAgIGRlbGV0ZSByZXBvcnQudGFsa2luZ1RpbWVNaWxsaXM7CiAgICAgIH0KCiAgICAgIHJlcG9ydC5zb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzID0gdGhpcy5fdHJhbnNsYXRlU29mdHBob25lU3RyZWFtU3RhdGlzdGljcygKICAgICAgICAgICAgcmVwb3J0LnNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MpOwoKICAgICAgcmV0dXJuIHJlcG9ydDsKICAgfTsKCiAgIGNvbm5lY3QuQ2xpZW50QmFzZSA9IENsaWVudEJhc2U7CiAgIGNvbm5lY3QuTnVsbENsaWVudCA9IE51bGxDbGllbnQ7CiAgIGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0Q2xpZW50ID0gVXBzdHJlYW1Db25kdWl0Q2xpZW50OwogICBjb25uZWN0LlVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudCA9IFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudDsKICAgY29ubmVjdC5BV1NDbGllbnQgPSBBV1NDbGllbnQ7Cgp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uKCkgewogICB2YXIgZ2xvYmFsID0gdGhpczsKICAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogR3JhcGhMaW5rIDw8YWJzdHJhY3QgY2xhc3M+PgogICAgKgogICAgKiBSZXByZXNlbnRzIHRoZSBhc3NvY2lhdGlvbiBvZiBvbmUgb3IgbW9yZSBhdHRyaWJ1dGVzIHRvIGEgc3RhdGUgdHJhbnNpdGlvbi4KICAgICovCiAgIHZhciBHcmFwaExpbmsgPSBmdW5jdGlvbihmcm9tU3RhdGUsIHRvU3RhdGUpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGZyb21TdGF0ZSwgJ2Zyb21TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9TdGF0ZSwgJ3RvU3RhdGUnKTsKICAgICAgdGhpcy5mcm9tU3RhdGUgPSBmcm9tU3RhdGU7CiAgICAgIHRoaXMudG9TdGF0ZSA9IHRvU3RhdGU7CiAgIH07CgogICBHcmFwaExpbmsucHJvdG90eXBlLmdldEFzc29jaWF0aW9ucyA9IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgdGhyb3cgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7CiAgIH07CgogICBHcmFwaExpbmsucHJvdG90eXBlLmdldEZyb21TdGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5mcm9tU3RhdGU7CiAgIH07CgogICBHcmFwaExpbmsucHJvdG90eXBlLmdldFRvU3RhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMudG9TdGF0ZTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogRGlyZWN0R3JhcGhMaW5rIDw8Y29uY3JldGUgY2xhc3M+PiBleHRlbmRzIEdyYXBoTGluawogICAgKgogICAgKiBSZXByZXNlbnRzIHRoZSBieS12YWx1ZSByZXByZXNlbnRhdGlvbiBvZiBvbmUgb3IgbW9yZSBhdHRyaWJ1dGVzIHRvIGEKICAgICogc3RhdGUgdHJhbnNpdGlvbi4KICAgICovCiAgIHZhciBEaXJlY3RHcmFwaExpbmsgPSBmdW5jdGlvbihmcm9tU3RhdGUsIHRvU3RhdGUsIGFzc29jaWF0aW9ucykgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZnJvbVN0YXRlLCAnZnJvbVN0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b1N0YXRlLCAndG9TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoYXNzb2NpYXRpb25zLCAnYXNzb2NpYXRpb25zJyk7CiAgICAgIEdyYXBoTGluay5jYWxsKHRoaXMsIGZyb21TdGF0ZSwgdG9TdGF0ZSk7CiAgICAgIHRoaXMuYXNzb2NpYXRpb25zID0gYXNzb2NpYXRpb25zOwogICB9OwogICBEaXJlY3RHcmFwaExpbmsucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShHcmFwaExpbmsucHJvdG90eXBlKTsKICAgRGlyZWN0R3JhcGhMaW5rLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IERpcmVjdEdyYXBoTGluazsKCiAgIERpcmVjdEdyYXBoTGluay5wcm90b3R5cGUuZ2V0QXNzb2NpYXRpb25zID0gZnVuY3Rpb24oY29udGV4dCkgewogICAgICByZXR1cm4gdGhpcy5hc3NvY2lhdGlvbnM7CiAgIH07CgogICAvKioKICAgICogRnVuY3Rpb25hbEdyYXBoTGluayA8PGNvbmNyZXRlIGNsYXNzPj4gZXh0ZW5kcyBHcmFwaExpbmsKICAgICoKICAgICogUmVwcmVzZW50cyBhIGZ1bmN0aW9uYWwgYXNzb2NpYXRpb24gb2Ygb25lIG9yIG1vcmUgYXR0cmlidXRlcyB0byBhCiAgICAqIHN0YXRlIHRyYW5zaXRpb24uCiAgICAqLwogICB2YXIgRnVuY3Rpb25hbEdyYXBoTGluayA9IGZ1bmN0aW9uKGZyb21TdGF0ZSwgdG9TdGF0ZSwgY2xvc3VyZSkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZnJvbVN0YXRlLCAnZnJvbVN0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b1N0YXRlLCAndG9TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY2xvc3VyZSwgJ2Nsb3N1cmUnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjbG9zdXJlKSwgJ2Nsb3N1cmUgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIEdyYXBoTGluay5jYWxsKHRoaXMsIGZyb21TdGF0ZSwgdG9TdGF0ZSk7CiAgICAgIHRoaXMuY2xvc3VyZSA9IGNsb3N1cmU7CiAgIH07CiAgIEZ1bmN0aW9uYWxHcmFwaExpbmsucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShHcmFwaExpbmsucHJvdG90eXBlKTsKICAgRnVuY3Rpb25hbEdyYXBoTGluay5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBGdW5jdGlvbmFsR3JhcGhMaW5rOwoKICAgRnVuY3Rpb25hbEdyYXBoTGluay5wcm90b3R5cGUuZ2V0QXNzb2NpYXRpb25zID0gZnVuY3Rpb24oY29udGV4dCkgewogICAgICByZXR1cm4gdGhpcy5jbG9zdXJlKGNvbnRleHQsIHRoaXMuZ2V0RnJvbVN0YXRlKCksIHRoaXMuZ2V0VG9TdGF0ZSgpKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogRXZlbnRHcmFwaCA8PGNsYXNzPj4KICAgICoKICAgICogQnVpbGRzIGEgbWFwIG9mIGFzc29jaWF0aW9ucyBmcm9tIG9uZSBzdGF0ZSB0byBhbm90aGVyIGluIGNvbnRleHQgb2YgYQogICAgKiBwYXJ0aWN1bGFyIG9iamVjdC4gIFRoZSBhc3NvY2lhdGlvbnMgY2FuIGJlIGRpcmVjdCAob25lIG9yIG1vcmUgdmFsdWVzKQogICAgKiBvciBmdW5jdGlvbmFsIChhIG1ldGhvZCByZXR1cm5pbmcgb25lIG9yIG1vcmUgdmFsdWVzKSwgYW5kIGFyZSB1c2VkIHRvCiAgICAqIHByb3ZpZGUgYWRkaXRpb25hbCBjb250ZXh0dWFsIGV2ZW50IGhvb2tzIGZvciB0aGUgVUkgdG8gY29uc3VtZS4KICAgICovCiAgIHZhciBFdmVudEdyYXBoID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuZnJvbU1hcCA9IHt9OwogICB9OwogICBFdmVudEdyYXBoLkFOWSA9ICI8PGFueT4+IjsKCiAgIEV2ZW50R3JhcGgucHJvdG90eXBlLmFzc29jID0gZnVuY3Rpb24oZnJvbVN0YXRlT2JqLCB0b1N0YXRlT2JqLCBhc3NvY09iaikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICBpZiAoISBmcm9tU3RhdGVPYmopIHsKICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJmcm9tU3RhdGVPYmogaXMgbm90IGRlZmluZWQuIik7CiAgICAgIH0KCiAgICAgIGlmICghIHRvU3RhdGVPYmopIHsKICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ0b1N0YXRlT2JqIGlzIG5vdCBkZWZpbmVkLiIpOwogICAgICB9CgogICAgICBpZiAoISBhc3NvY09iaikgewogICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImFzc29jT2JqIGlzIG5vdCBkZWZpbmVkLiIpOwogICAgICB9CgogICAgICBpZiAoZnJvbVN0YXRlT2JqIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgZnJvbVN0YXRlT2JqLmZvckVhY2goZnVuY3Rpb24oZnJvbVN0YXRlKSB7CiAgICAgICAgICAgIHNlbGYuYXNzb2MoZnJvbVN0YXRlLCB0b1N0YXRlT2JqLCBhc3NvY09iaik7CiAgICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKHRvU3RhdGVPYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICB0b1N0YXRlT2JqLmZvckVhY2goZnVuY3Rpb24odG9TdGF0ZSkgewogICAgICAgICAgICBzZWxmLmFzc29jKGZyb21TdGF0ZU9iaiwgdG9TdGF0ZSwgYXNzb2NPYmopOwogICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAgaWYgKHR5cGVvZiBhc3NvY09iaiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aGlzLl9hZGRBc3NvY2lhdGlvbihuZXcgRnVuY3Rpb25hbEdyYXBoTGluayhmcm9tU3RhdGVPYmosIHRvU3RhdGVPYmosIGFzc29jT2JqKSk7CiAgICAgICAgIH0gZWxzZSBpZiAoYXNzb2NPYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICAgICB0aGlzLl9hZGRBc3NvY2lhdGlvbihuZXcgRGlyZWN0R3JhcGhMaW5rKGZyb21TdGF0ZU9iaiwgdG9TdGF0ZU9iaiwgYXNzb2NPYmopKTsKICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fYWRkQXNzb2NpYXRpb24obmV3IERpcmVjdEdyYXBoTGluayhmcm9tU3RhdGVPYmosIHRvU3RhdGVPYmosIFthc3NvY09ial0pKTsKICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICB9OwoKICAgRXZlbnRHcmFwaC5wcm90b3R5cGUuZ2V0QXNzb2NpYXRpb25zID0gZnVuY3Rpb24oY29udGV4dCwgZnJvbVN0YXRlLCB0b1N0YXRlKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmcm9tU3RhdGUsICdmcm9tU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvU3RhdGUsICd0b1N0YXRlJyk7CiAgICAgIHZhciBhc3NvY2lhdGlvbnMgPSBbXTsKCiAgICAgIHZhciB0b01hcEZyb21BbnkgPSB0aGlzLmZyb21NYXBbRXZlbnRHcmFwaC5BTlldIHx8IHt9OwogICAgICB2YXIgdG9NYXAgPSB0aGlzLmZyb21NYXBbZnJvbVN0YXRlXSB8fCB7fTsKCiAgICAgIGFzc29jaWF0aW9ucyA9IGFzc29jaWF0aW9ucy5jb25jYXQodGhpcy5fZ2V0QXNzb2NpYXRpb25zRnJvbU1hcCgKICAgICAgICAgICAgICAgdG9NYXBGcm9tQW55LCBjb250ZXh0LCBmcm9tU3RhdGUsIHRvU3RhdGUpKTsKICAgICAgYXNzb2NpYXRpb25zID0gYXNzb2NpYXRpb25zLmNvbmNhdCh0aGlzLl9nZXRBc3NvY2lhdGlvbnNGcm9tTWFwKAogICAgICAgICAgICAgICB0b01hcCwgY29udGV4dCwgZnJvbVN0YXRlLCB0b1N0YXRlKSk7CgogICAgICByZXR1cm4gYXNzb2NpYXRpb25zOwogICB9OwoKICAgRXZlbnRHcmFwaC5wcm90b3R5cGUuX2FkZEFzc29jaWF0aW9uID0gZnVuY3Rpb24oYXNzb2MpIHsKICAgICAgdmFyIHRvTWFwID0gdGhpcy5mcm9tTWFwW2Fzc29jLmdldEZyb21TdGF0ZSgpXTsKCiAgICAgIGlmICghIHRvTWFwKSB7CiAgICAgICAgIHRvTWFwID0gdGhpcy5mcm9tTWFwW2Fzc29jLmdldEZyb21TdGF0ZSgpXSA9IHt9OwogICAgICB9CgogICAgICB2YXIgYXNzb2NMaXN0ID0gdG9NYXBbYXNzb2MuZ2V0VG9TdGF0ZSgpXTsKCiAgICAgIGlmICghIGFzc29jTGlzdCkgewogICAgICAgICBhc3NvY0xpc3QgPSB0b01hcFthc3NvYy5nZXRUb1N0YXRlKCldID0gW107CiAgICAgIH0KCiAgICAgIGFzc29jTGlzdC5wdXNoKGFzc29jKTsKICAgfTsKCiAgIEV2ZW50R3JhcGgucHJvdG90eXBlLl9nZXRBc3NvY2lhdGlvbnNGcm9tTWFwID0gZnVuY3Rpb24obWFwLCBjb250ZXh0LCBmcm9tU3RhdGUsIHRvU3RhdGUpIHsKICAgICAgdmFyIGFzc29jTGlzdCA9IChtYXBbRXZlbnRHcmFwaC5BTlldIHx8IFtdKS5jb25jYXQobWFwW3RvU3RhdGVdIHx8IFtdKTsKICAgICAgcmV0dXJuIGFzc29jTGlzdC5yZWR1Y2UoZnVuY3Rpb24ocHJldiwgYXNzb2MpIHsKICAgICAgICAgcmV0dXJuIHByZXYuY29uY2F0KGFzc29jLmdldEFzc29jaWF0aW9ucyhjb250ZXh0KSk7CiAgICAgIH0sIFtdKTsKICAgfTsKCiAgIGNvbm5lY3QuRXZlbnRHcmFwaCA9IEV2ZW50R3JhcGg7Cgp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBBZ2VudFN0YXRlVHlwZQogICAqLwogIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdyb3V0YWJsZScsCiAgICAnbm90X3JvdXRhYmxlJywKICAgICdvZmZsaW5lJwogIF0pOwogIGNvbm5lY3QuQWdlbnRTdGF0dXNUeXBlID0gY29ubmVjdC5BZ2VudFN0YXRlVHlwZTsKCiAgLyoqCiAgICogZW51bSBBZ2VudEF2YWlsU3RhdGVzCiAgICovCiAgY29ubmVjdC5BZ2VudEF2YWlsU3RhdGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnSW5pdCcsCiAgICAnQnVzeScsCiAgICAnQWZ0ZXJDYWxsV29yaycsCiAgICAnQ2FsbGluZ0N1c3RvbWVyJywKICAgICdEaWFsaW5nJywKICAgICdKb2luaW5nJywKICAgICdQZW5kaW5nQXZhaWxhYmxlJywKICAgICdQZW5kaW5nQnVzeScKICBdKTsKCiAgLyoqCiAgICogZW51bSBBZ2VudEVycm9yU3RhdGVzCiAgICovCiAgY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnRXJyb3InLAogICAgJ0FnZW50SHVuZ1VwJywKICAgICdCYWRBZGRyZXNzQWdlbnQnLAogICAgJ0JhZEFkZHJlc3NDdXN0b21lcicsCiAgICAnRGVmYXVsdCcsCiAgICAnRmFpbGVkQ29ubmVjdEFnZW50JywKICAgICdGYWlsZWRDb25uZWN0Q3VzdG9tZXInLAogICAgJ0xpbmVFbmdhZ2VkQWdlbnQnLAogICAgJ0xpbmVFbmdhZ2VkQ3VzdG9tZXInLAogICAgJ01pc3NlZENhbGxBZ2VudCcsCiAgICAnTWlzc2VkQ2FsbEN1c3RvbWVyJywKICAgICdNdWx0aXBsZUNjcFdpbmRvd3MnLAogICAgJ1JlYWx0aW1lQ29tbXVuaWNhdGlvbkVycm9yJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIEFkZHJlc3NUeXBlCiAgICovCiAgY29ubmVjdC5FbmRwb2ludFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdwaG9uZV9udW1iZXInLAogICAgJ2FnZW50JywKICAgICdxdWV1ZScKICBdKTsKICBjb25uZWN0LkFkZHJlc3NUeXBlID0gY29ubmVjdC5FbmRwb2ludFR5cGU7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29ubmVjdGlvblR5cGUKICAgKi8KICBjb25uZWN0LkNvbm5lY3Rpb25UeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnYWdlbnQnLAogICAgJ2luYm91bmQnLAogICAgJ291dGJvdW5kJywKICAgICdtb25pdG9yaW5nJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIENvbm5lY3Rpb25TdGF0ZVR5cGUKICAgKi8KICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ2hvbGQnLAogICAgJ2Rpc2Nvbm5lY3RlZCcKICBdKTsKICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0dXNUeXBlID0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlOwoKICBjb25uZWN0LkNPTk5FQ1RJT05fQUNUSVZFX1NUQVRFUyA9IGNvbm5lY3Quc2V0KFsKICAgIGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNUSU5HLAogICAgY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RFRCwKICAgIGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5IT0xECiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdFN0YXRlVHlwZQogICAqLwogIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2luaXQnLAogICAgJ2luY29taW5nJywKICAgICdwZW5kaW5nJywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ21pc3NlZCcsCiAgICAnZXJyb3InLAogICAgJ2VuZGVkJwogIF0pOwogIGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUgPSBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGU7CgogIGNvbm5lY3QuQ09OVEFDVF9BQ1RJVkVfU1RBVEVTID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5jb21pbmcnLAogICAgJ3BlbmRpbmcnLAogICAgJ2Nvbm5lY3RpbmcnLAogICAgJ2Nvbm5lY3RlZCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBDb250YWN0VHlwZQogICAqLwogIGNvbm5lY3QuQ29udGFjdFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICd2b2ljZScsCiAgICAncXVldWVfY2FsbGJhY2snLAogICAgJ2NoYXQnLAogICAgJ3Rhc2snCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdEluaXRpYXRpb25NZXRob2QKICAgKi8KICBjb25uZWN0LkNvbnRhY3RJbml0aWF0aW9uTWV0aG9kID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5ib3VuZCcsCiAgICAnb3V0Ym91bmQnLAogICAgJ3RyYW5zZmVyJywKICAgICdxdWV1ZV90cmFuc2ZlcicsCiAgICAnY2FsbGJhY2snLAogICAgJ2FwaScsCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogZW51bSBDaGFubmVsVHlwZQogICovCiAgY29ubmVjdC5DaGFubmVsVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ1ZPSUNFJywKICAgICdDSEFUJywKICAgICdUQVNLJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIGVudW0gTWVkaWFUeXBlCiAgKi8KICBjb25uZWN0Lk1lZGlhVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ3NvZnRwaG9uZScsCiAgICAnY2hhdCcsCiAgICAndGFzaycKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBTb2Z0cGhvbmVDYWxsVHlwZQogICAqLwogIGNvbm5lY3QuU29mdHBob25lQ2FsbFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdhdWRpb192aWRlbycsCiAgICAndmlkZW9fb25seScsCiAgICAnYXVkaW9fb25seScsCiAgICAnbm9uZScKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgU29mdHBob25lRXJyb3JUeXBlcwogICAqLwogIGNvbm5lY3QuU29mdHBob25lRXJyb3JUeXBlcyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ3Vuc3VwcG9ydGVkX2Jyb3dzZXInLAogICAgJ21pY3JvcGhvbmVfbm90X3NoYXJlZCcsCiAgICAnc2lnbmFsbGluZ19oYW5kc2hha2VfZmFpbHVyZScsCiAgICAnc2lnbmFsbGluZ19jb25uZWN0aW9uX2ZhaWx1cmUnLAogICAgJ2ljZV9jb2xsZWN0aW9uX3RpbWVvdXQnLAogICAgJ3VzZXJfYnVzeV9lcnJvcicsCiAgICAnd2VicnRjX2Vycm9yJywKICAgICdyZWFsdGltZV9jb21tdW5pY2F0aW9uX2Vycm9yJywKICAgICdvdGhlcicKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgQ1RJIGV4Y2VwdGlvbnMKICAgKi8KICBjb25uZWN0LkNUSUV4Y2VwdGlvbnMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJBY2Nlc3NEZW5pZWRFeGNlcHRpb24iLAogICAgIkludmFsaWRTdGF0ZUV4Y2VwdGlvbiIsCiAgICAiQmFkRW5kcG9pbnRFeGNlcHRpb24iLAogICAgIkludmFsaWRBZ2VudEFSTkV4Y2VwdGlvbiIsCiAgICAiSW52YWxpZENvbmZpZ3VyYXRpb25FeGNlcHRpb24iLAogICAgIkludmFsaWRDb250YWN0VHlwZUV4Y2VwdGlvbiIsCiAgICAiUGFnaW5hdGlvbkV4Y2VwdGlvbiIsCiAgICAiUmVmcmVzaFRva2VuRXhwaXJlZEV4Y2VwdGlvbiIsCiAgICAiU2VuZERhdGFGYWlsZWRFeGNlcHRpb24iLAogICAgIlVuYXV0aG9yaXplZEV4Y2VwdGlvbiIKICBdKTsKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBBZ2VudAogICAqLwogIHZhciBBZ2VudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCJUaGUgYWdlbnQgaXMgbm90IHlldCBpbml0aWFsaXplZCEiKTsKICAgIH0KICB9OwoKICBBZ2VudC5wcm90b3R5cGUuX2dldERhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0QWdlbnREYXRhKCk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLl9jcmVhdGVDb250YWN0QVBJID0gZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0RGF0YS5jb250YWN0SWQpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbkNvbnRhY3RQZW5kaW5nID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5DT05UQUNUX1BFTkRJTkcsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblJlZnJlc2ggPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLlJFRlJFU0gsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblJvdXRhYmxlID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5ST1VUQUJMRSwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uTm90Um91dGFibGUgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLk5PVF9ST1VUQUJMRSwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uT2ZmbGluZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuT0ZGTElORSwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uRXJyb3IgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLkVSUk9SLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25Tb2Z0cGhvbmVFcnJvciA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuU09GVFBIT05FX0VSUk9SLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25XZWJTb2NrZXRDb25uZWN0aW9uTG9zdCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuV0VCU09DS0VUX0NPTk5FQ1RJT05fTE9TVCwgZik7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUub25XZWJTb2NrZXRDb25uZWN0aW9uR2FpbmVkID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5XRUJTT0NLRVRfQ09OTkVDVElPTl9HQUlORUQsIGYpOwogIH0KCiAgQWdlbnQucHJvdG90eXBlLm9uQWZ0ZXJDYWxsV29yayA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuQUNXLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25TdGF0ZUNoYW5nZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuU1RBVEVfQ0hBTkdFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25NdXRlVG9nZ2xlID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5BZ2VudEV2ZW50cy5NVVRFX1RPR0dMRSwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uTG9jYWxNZWRpYVN0cmVhbUNyZWF0ZWQgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkFnZW50RXZlbnRzLkxPQ0FMX01FRElBX1NUUkVBTV9DUkVBVEVELCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUubXV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsCiAgICAgIHsKICAgICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuTVVURSwKICAgICAgICBkYXRhOiB7IG11dGU6IHRydWUgfQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUudW5tdXRlID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwKICAgICAgewogICAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5NVVRFLAogICAgICAgIGRhdGE6IHsgbXV0ZTogZmFsc2UgfQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNuYXBzaG90LnN0YXRlOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRBdmFpbGFiaWxpdHlTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc25hcHNob3QuYWdlbnRBdmFpbGFiaWxpdHlTdGF0ZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdHVzID0gQWdlbnQucHJvdG90eXBlLmdldFN0YXRlOwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdGVEdXJhdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0Lm5vdygpIC0gdGhpcy5fZ2V0RGF0YSgpLnNuYXBzaG90LnN0YXRlLnN0YXJ0VGltZXN0YW1wLmdldFRpbWUoKSArIGNvbm5lY3QuY29yZS5nZXRTa2V3KCk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldFN0YXR1c0R1cmF0aW9uID0gQWdlbnQucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb247CgogIEFnZW50LnByb3RvdHlwZS5nZXRQZXJtaXNzaW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5wZXJtaXNzaW9uczsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0Q29udGFjdHMgPSBmdW5jdGlvbiAoY29udGFjdFR5cGVGaWx0ZXIpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc25hcHNob3QuY29udGFjdHMubWFwKGZ1bmN0aW9uIChjb250YWN0RGF0YSkgewogICAgICByZXR1cm4gc2VsZi5fY3JlYXRlQ29udGFjdEFQSShjb250YWN0RGF0YSk7CiAgICB9KS5maWx0ZXIoZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgcmV0dXJuICghY29udGFjdFR5cGVGaWx0ZXIpIHx8IGNvbnRhY3QuZ2V0VHlwZSgpID09PSBjb250YWN0VHlwZUZpbHRlcjsKICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRDb25maWd1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb25maWd1cmF0aW9uOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRBZ2VudFN0YXRlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5hZ2VudFN0YXRlczsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0Um91dGluZ1Byb2ZpbGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25maWd1cmF0aW9uKCkucm91dGluZ1Byb2ZpbGU7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldENoYW5uZWxDb25jdXJyZW5jeSA9IGZ1bmN0aW9uIChjaGFubmVsKSB7CiAgICB2YXIgY2hhbm5lbENvbmN1cnJlbmN5TWFwID0gdGhpcy5nZXRSb3V0aW5nUHJvZmlsZSgpLmNoYW5uZWxDb25jdXJyZW5jeU1hcDsKICAgIGlmICghY2hhbm5lbENvbmN1cnJlbmN5TWFwKSB7CiAgICAgIGNoYW5uZWxDb25jdXJyZW5jeU1hcCA9IE9iamVjdC5rZXlzKGNvbm5lY3QuQ2hhbm5lbFR5cGUpLnJlZHVjZShmdW5jdGlvbiAoYWNjLCBrZXkpIHsKICAgICAgICAvLyBFeGNsdWRlIFRBU0sgZnJvbSBkZWZhdWx0IGNvbmN1cnJlbmN5LgogICAgICAgIGlmIChrZXkgIT09ICdUQVNLJykgewogICAgICAgICAgYWNjW2Nvbm5lY3QuQ2hhbm5lbFR5cGVba2V5XV0gPSAxOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYWNjOwogICAgICB9LCB7fSk7CiAgICB9CiAgICByZXR1cm4gY2hhbm5lbAogICAgICA/IChjaGFubmVsQ29uY3VycmVuY3lNYXBbY2hhbm5lbF0gfHwgMCkKICAgICAgOiBjaGFubmVsQ29uY3VycmVuY3lNYXA7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldE5hbWUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25maWd1cmF0aW9uKCkubmFtZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0RXh0ZW5zaW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLmV4dGVuc2lvbjsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0RGlhbGFibGVDb3VudHJpZXMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25maWd1cmF0aW9uKCkuZGlhbGFibGVDb3VudHJpZXM7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmlzU29mdHBob25lRW5hYmxlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5zb2Z0cGhvbmVFbmFibGVkOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRDb25maWd1cmF0aW9uID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24sIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5VUERBVEVfQUdFTlRfQ09ORklHVVJBVElPTiwgewogICAgICBjb25maWd1cmF0aW9uOiBjb25uZWN0LmFzc2VydE5vdE51bGwoY29uZmlndXJhdGlvbiwgJ2NvbmZpZ3VyYXRpb24nKQogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAvLyBXZSBuZWVkIHRvIGFzayB0aGUgc2hhcmVkIHdvcmtlciB0byByZWxvYWQgYWdlbnQgY29uZmlnCiAgICAgICAgICAvLyBvbmNlIHdlIGNoYW5nZSBpdCBzbyBldmVyeSB0YWIgaGFzIGFjY3VyYXRlIGNvbmZpZy4KICAgICAgICAgIHZhciBjb25kdWl0ID0gY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCk7CiAgICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5SRUxPQURfQUdFTlRfQ09ORklHVVJBVElPTik7CgogICAgICAgICAgaWYgKGNhbGxiYWNrcy5zdWNjZXNzKSB7CiAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlCiAgICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRTdGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlBVVF9BR0VOVF9TVEFURSwgewogICAgICBzdGF0ZTogY29ubmVjdC5hc3NlcnROb3ROdWxsKHN0YXRlLCAnc3RhdGUnKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuc2V0U3RhdHVzID0gQWdlbnQucHJvdG90eXBlLnNldFN0YXRlOwoKICBBZ2VudC5wcm90b3R5cGUuY29ubmVjdCA9IGZ1bmN0aW9uIChlbmRwb2ludEluLCBwYXJhbXMpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgZW5kcG9pbnQgPSBuZXcgY29ubmVjdC5FbmRwb2ludChlbmRwb2ludEluKTsKICAgIC8vIEhhdmUgdG8gcmVtb3ZlIHRoZSBlbmRwb2ludElkIGZpZWxkIG9yIEFXUyBKUyBTREsgZ2V0cyBtYWQuCiAgICBkZWxldGUgZW5kcG9pbnQuZW5kcG9pbnRJZDsKCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX09VVEJPVU5EX0NPTlRBQ1QsIHsKICAgICAgZW5kcG9pbnQ6IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChlbmRwb2ludCwgJ2VuZHBvaW50JyksCiAgICAgIHF1ZXVlQVJOOiAocGFyYW1zICYmIChwYXJhbXMucXVldWVBUk4gfHwgcGFyYW1zLnF1ZXVlSWQpKSB8fCB0aGlzLmdldFJvdXRpbmdQcm9maWxlKCkuZGVmYXVsdE91dGJvdW5kUXVldWUucXVldWVBUk4KICAgIH0sIHBhcmFtcyAmJiB7CiAgICAgICAgc3VjY2VzczogcGFyYW1zLnN1Y2Nlc3MsCiAgICAgICAgZmFpbHVyZTogcGFyYW1zLmZhaWx1cmUKICAgICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldEFsbFF1ZXVlQVJOcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5yb3V0aW5nUHJvZmlsZS5xdWV1ZXMubWFwKGZ1bmN0aW9uIChxdWV1ZSkgewogICAgICByZXR1cm4gcXVldWUucXVldWVBUk47CiAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0RW5kcG9pbnRzID0gZnVuY3Rpb24gKHF1ZXVlQVJOcywgY2FsbGJhY2tzLCBwYWdlSW5mb0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNhbGxiYWNrcywgImNhbGxiYWNrcyIpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNhbGxiYWNrcy5zdWNjZXNzLCAiY2FsbGJhY2tzLnN1Y2Nlc3MiKTsKICAgIHZhciBwYWdlSW5mbyA9IHBhZ2VJbmZvSW4gfHwgeyB9OwoKICAgIHBhZ2VJbmZvLmVuZHBvaW50cyA9IHBhZ2VJbmZvLmVuZHBvaW50cyB8fCBbXTsKICAgIHBhZ2VJbmZvLm1heFJlc3VsdHMgPSBwYWdlSW5mby5tYXhSZXN1bHRzIHx8IGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFOwoKICAgIC8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IGFsbG93aW5nIGEgc2luZ2xlIHF1ZXVlQVJOIHRvIGJlIHNwZWNpZmllZAogICAgLy8gaW5zdGVhZCBvZiBhbiBhcnJheS4KICAgIGlmICghY29ubmVjdC5pc0FycmF5KHF1ZXVlQVJOcykpIHsKICAgICAgcXVldWVBUk5zID0gW3F1ZXVlQVJOc107CiAgICB9CgogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9FTkRQT0lOVFMsIHsKICAgICAgcXVldWVBUk5zOiBxdWV1ZUFSTnMsCiAgICAgIG5leHRUb2tlbjogcGFnZUluZm8ubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhZ2VJbmZvLm1heFJlc3VsdHMKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEubmV4dFRva2VuKSB7CiAgICAgICAgICAgIHNlbGYuZ2V0RW5kcG9pbnRzKHF1ZXVlQVJOcywgY2FsbGJhY2tzLCB7CiAgICAgICAgICAgICAgbmV4dFRva2VuOiBkYXRhLm5leHRUb2tlbiwKICAgICAgICAgICAgICBtYXhSZXN1bHRzOiBwYWdlSW5mby5tYXhSZXN1bHRzLAogICAgICAgICAgICAgIGVuZHBvaW50czogcGFnZUluZm8uZW5kcG9pbnRzLmNvbmNhdChkYXRhLmVuZHBvaW50cykKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwYWdlSW5mby5lbmRwb2ludHMgPSBwYWdlSW5mby5lbmRwb2ludHMuY29uY2F0KGRhdGEuZW5kcG9pbnRzKTsKICAgICAgICAgICAgdmFyIGVuZHBvaW50cyA9IHBhZ2VJbmZvLmVuZHBvaW50cy5tYXAoZnVuY3Rpb24gKGVuZHBvaW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LkVuZHBvaW50KGVuZHBvaW50KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjYWxsYmFja3Muc3VjY2Vzcyh7CiAgICAgICAgICAgICAgZW5kcG9pbnRzOiBlbmRwb2ludHMsCiAgICAgICAgICAgICAgYWRkcmVzc2VzOiBlbmRwb2ludHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBjYWxsYmFja3MuZmFpbHVyZQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0QWRkcmVzc2VzID0gQWdlbnQucHJvdG90eXBlLmdldEVuZHBvaW50czsKCiAgQWdlbnQucHJvdG90eXBlLnRvU25hcHNob3QgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gbmV3IGNvbm5lY3QuQWdlbnRTbmFwc2hvdCh0aGlzLl9nZXREYXRhKCkpOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIEFnZW50U25hcHNob3QKICAgKi8KICB2YXIgQWdlbnRTbmFwc2hvdCA9IGZ1bmN0aW9uIChhZ2VudERhdGEpIHsKICAgIGNvbm5lY3QuQWdlbnQuY2FsbCh0aGlzKTsKICAgIHRoaXMuYWdlbnREYXRhID0gYWdlbnREYXRhOwogIH07CiAgQWdlbnRTbmFwc2hvdC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEFnZW50LnByb3RvdHlwZSk7CiAgQWdlbnRTbmFwc2hvdC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBBZ2VudFNuYXBzaG90OwoKICBBZ2VudFNuYXBzaG90LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmFnZW50RGF0YTsKICB9OwoKICBBZ2VudFNuYXBzaG90LnByb3RvdHlwZS5fY3JlYXRlQ29udGFjdEFQSSA9IGZ1bmN0aW9uIChjb250YWN0RGF0YSkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkNvbnRhY3RTbmFwc2hvdChjb250YWN0RGF0YSk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQ29udGFjdAogICAqLwogIHZhciBDb250YWN0ID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgdGhpcy5jb250YWN0SWQgPSBjb250YWN0SWQ7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuX2dldERhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEodGhpcy5nZXRDb250YWN0SWQoKSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuX2NyZWF0ZUNvbm5lY3Rpb25BUEkgPSBmdW5jdGlvbiAoY29ubmVjdGlvbkRhdGEpIHsKICAgIGlmICh0aGlzLmdldFR5cGUoKSA9PT0gY29ubmVjdC5Db250YWN0VHlwZS5DSEFUKSB7CiAgICAgIHJldHVybiBuZXcgY29ubmVjdC5DaGF0Q29ubmVjdGlvbih0aGlzLmNvbnRhY3RJZCwgY29ubmVjdGlvbkRhdGEuY29ubmVjdGlvbklkKTsKICAgIH0gZWxzZSBpZiAodGhpcy5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29udGFjdFR5cGUuVEFTSykgewogICAgICByZXR1cm4gbmV3IGNvbm5lY3QuVGFza0Nvbm5lY3Rpb24odGhpcy5jb250YWN0SWQsIGNvbm5lY3Rpb25EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmV3IGNvbm5lY3QuVm9pY2VDb25uZWN0aW9uKHRoaXMuY29udGFjdElkLCBjb25uZWN0aW9uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgfQogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldEV2ZW50TmFtZSA9IGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShldmVudE5hbWUsIHRoaXMuZ2V0Q29udGFjdElkKCkpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uUmVmcmVzaCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5SRUZSRVNIKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25JbmNvbWluZyA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5JTkNPTUlORyksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uQ29ubmVjdGluZyA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5DT05ORUNUSU5HKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25QZW5kaW5nID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLlBFTkRJTkcpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkFjY2VwdGVkID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkFDQ0VQVEVEKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25NaXNzZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuTUlTU0VEKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25FbmRlZCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5FTkRFRCksIGYpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuREVTVFJPWUVEKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25EZXN0cm95ID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkRFU1RST1lFRCksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uQUNXID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkFDVyksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uQ29ubmVjdGVkID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkNPTk5FQ1RFRCksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uRXJyb3IgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuRVJST1IpLCBmKTsKICB9CgogIENvbnRhY3QucHJvdG90eXBlLmdldENvbnRhY3RJZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbnRhY3RJZDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRPcmlnaW5hbENvbnRhY3RJZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuaW5pdGlhbENvbnRhY3RJZDsKICB9OwogIENvbnRhY3QucHJvdG90eXBlLmdldEluaXRpYWxDb250YWN0SWQgPSBDb250YWN0LnByb3RvdHlwZS5nZXRPcmlnaW5hbENvbnRhY3RJZDsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0VHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkudHlwZTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRDb250YWN0RHVyYXRpb24gPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuY29udGFjdER1cmF0aW9uOwogIH0KCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnN0YXRlOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldFN0YXR1cyA9IENvbnRhY3QucHJvdG90eXBlLmdldFN0YXRlOwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Qubm93KCkgLSB0aGlzLl9nZXREYXRhKCkuc3RhdGUudGltZXN0YW1wLmdldFRpbWUoKSArIGNvbm5lY3QuY29yZS5nZXRTa2V3KCk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdHVzRHVyYXRpb24gPSBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uOwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRRdWV1ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkucXVldWU7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0UXVldWVUaW1lc3RhbXAgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnF1ZXVlVGltZXN0YW1wOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENvbm5lY3Rpb25zID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb25uZWN0aW9ucy5tYXAoZnVuY3Rpb24gKGNvbm5EYXRhKSB7CiAgICAgIGlmIChzZWxmLmdldFR5cGUoKSA9PT0gY29ubmVjdC5Db250YWN0VHlwZS5DSEFUKSB7CiAgICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LkNoYXRDb25uZWN0aW9uKHNlbGYuY29udGFjdElkLCBjb25uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgICB9IGVsc2UgaWYgKHNlbGYuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLlRBU0spIHsKICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuVGFza0Nvbm5lY3Rpb24oc2VsZi5jb250YWN0SWQsIGNvbm5EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LlZvaWNlQ29ubmVjdGlvbihzZWxmLmNvbnRhY3RJZCwgY29ubkRhdGEuY29ubmVjdGlvbklkKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0SW5pdGlhbENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5maW5kKHRoaXMuZ2V0Q29ubmVjdGlvbnMoKSwgZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm4uaXNJbml0aWFsQ29ubmVjdGlvbigpOwogICAgfSkgfHwgbnVsbDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRBY3RpdmVJbml0aWFsQ29ubmVjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBpbml0aWFsQ29ubiA9IHRoaXMuZ2V0SW5pdGlhbENvbm5lY3Rpb24oKTsKICAgIGlmIChpbml0aWFsQ29ubiAhPSBudWxsICYmIGluaXRpYWxDb25uLmlzQWN0aXZlKCkpIHsKICAgICAgcmV0dXJuIGluaXRpYWxDb25uOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0VGhpcmRQYXJ0eUNvbm5lY3Rpb25zID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29ubmVjdGlvbnMoKS5maWx0ZXIoZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuICFjb25uLmlzSW5pdGlhbENvbm5lY3Rpb24oKSAmJiBjb25uLmdldFR5cGUoKSAhPT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5BR0VOVDsKICAgIH0pOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldFNpbmdsZUFjdGl2ZVRoaXJkUGFydHlDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0VGhpcmRQYXJ0eUNvbm5lY3Rpb25zKCkuZmlsdGVyKGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHJldHVybiBjb25uLmlzQWN0aXZlKCk7CiAgICB9KVswXSB8fCBudWxsOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldEFnZW50Q29ubmVjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmZpbmQodGhpcy5nZXRDb25uZWN0aW9ucygpLCBmdW5jdGlvbiAoY29ubikgewogICAgICB2YXIgY29ublR5cGUgPSBjb25uLmdldFR5cGUoKTsKICAgICAgcmV0dXJuIGNvbm5UeXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLkFHRU5UIHx8IGNvbm5UeXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLk1PTklUT1JJTkc7CiAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXROYW1lID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5uYW1lOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENvbnRhY3RNZXRhZGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuY29udGFjdE1ldGFkYXRhOwogIH0KCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0RGVzY3JpcHRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmRlc2NyaXB0aW9uOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldFJlZmVyZW5jZXMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnJlZmVyZW5jZXM7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0QXR0cmlidXRlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuYXR0cmlidXRlczsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5pc1NvZnRwaG9uZUNhbGwgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5maW5kKHRoaXMuZ2V0Q29ubmVjdGlvbnMoKSwgZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm4uZ2V0U29mdHBob25lTWVkaWFJbmZvKCkgIT0gbnVsbDsKICAgIH0pICE9IG51bGw7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuX2lzSW5ib3VuZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBpbml0aWF0aW9uTWV0aG9kID0gdGhpcy5fZ2V0RGF0YSgpLmluaXRpYXRpb25NZXRob2Q7CiAgICByZXR1cm4gKGluaXRpYXRpb25NZXRob2QgPT09IGNvbm5lY3QuQ29udGFjdEluaXRpYXRpb25NZXRob2QuT1VUQk9VTkQpID8gZmFsc2UgOiB0cnVlOwogIH0KCiAgQ29udGFjdC5wcm90b3R5cGUuaXNJbmJvdW5kID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNvbm4gPSB0aGlzLmdldEluaXRpYWxDb25uZWN0aW9uKCk7CgogICAgLy8gV2Ugd2lsbCBncmFkdWFsbHkgY2hhbmdlIGNoZWNraW5nIGluYm91bmQgYnkgcmVseWluZyBvbiBjb250YWN0IGluaXRpYXRpb25NZXRob2QKICAgIGlmIChjb25uLmdldE1lZGlhVHlwZSgpID09PSBjb25uZWN0Lk1lZGlhVHlwZS5UQVNLKSB7CiAgICAgIHJldHVybiB0aGlzLl9pc0luYm91bmQoKTsKICAgIH0KCiAgICByZXR1cm4gY29ubiA/IGNvbm4uZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLklOQk9VTkQgOiBmYWxzZTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5pc0Nvbm5lY3RlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5DT05ORUNURUQ7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuYWNjZXB0ID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjb250YWN0SWQgPSB0aGlzLmdldENvbnRhY3RJZCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkFDQ0VQVF9DT05UQUNULCB7CiAgICAgIGNvbnRhY3RJZDogY29udGFjdElkCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIHZhciBjb25kdWl0ID0gY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCk7CiAgICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29udGFjdEV2ZW50cy5BQ0NFUFRFRCwKICAgICAgICAgICAgZGF0YTogbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0SWQpCiAgICAgICAgICB9KTsKICAgICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgICAgICBldmVudDogY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkFDQ0VQVEVELAogICAgICAgICAgICAgIHNlbGYuZ2V0Q29udGFjdElkKCkpLAogICAgICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkKICAgICAgICAgIH0pOwoKICAgICAgICAgIGlmIChjYWxsYmFja3MgJiYgY2FsbGJhY2tzLnN1Y2Nlc3MpIHsKICAgICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBjYWxsYmFja3MgPyBjYWxsYmFja3MuZmFpbHVyZSA6IG51bGwKICAgICAgfSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuREVTVFJPWV9DT05UQUNULCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5yZWplY3QgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlJFSkVDVF9DT05UQUNULCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5jb21wbGV0ZSA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ09NUExFVEVfQ09OVEFDVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNMRUFSX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm5vdGlmeUlzc3VlID0gZnVuY3Rpb24gKGlzc3VlQ29kZSwgZGVzY3JpcHRpb24sIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5OT1RJRllfQ09OVEFDVF9JU1NVRSwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGlzc3VlQ29kZTogaXNzdWVDb2RlLAogICAgICBkZXNjcmlwdGlvbjogZGVzY3JpcHRpb24KICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuYWRkQ29ubmVjdGlvbiA9IGZ1bmN0aW9uIChlbmRwb2ludEluLCBjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgZW5kcG9pbnQgPSBuZXcgY29ubmVjdC5FbmRwb2ludChlbmRwb2ludEluKTsKICAgIC8vIEhhdmUgdG8gcmVtb3ZlIHRoZSBlbmRwb2ludElkIGZpZWxkIG9yIEFXUyBKUyBTREsgZ2V0cyBtYWQuCiAgICBkZWxldGUgZW5kcG9pbnQuZW5kcG9pbnRJZDsKCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX0FERElUSU9OQUxfQ09OTkVDVElPTiwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGVuZHBvaW50OiBlbmRwb2ludAogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS50b2dnbGVBY3RpdmVDb25uZWN0aW9ucyA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29ubmVjdGlvbklkID0gbnVsbDsKICAgIHZhciBob2xkaW5nQ29ubiA9IGNvbm5lY3QuZmluZCh0aGlzLmdldENvbm5lY3Rpb25zKCksIGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHJldHVybiBjb25uLmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5IT0xEOwogICAgfSk7CgogICAgaWYgKGhvbGRpbmdDb25uICE9IG51bGwpIHsKICAgICAgY29ubmVjdGlvbklkID0gaG9sZGluZ0Nvbm4uZ2V0Q29ubmVjdGlvbklkKCk7CgogICAgfSBlbHNlIHsKICAgICAgdmFyIGFjdGl2ZUNvbm5zID0gdGhpcy5nZXRDb25uZWN0aW9ucygpLmZpbHRlcihmdW5jdGlvbiAoY29ubikgewogICAgICAgIHJldHVybiBjb25uLmlzQWN0aXZlKCk7CiAgICAgIH0pOwogICAgICBpZiAoYWN0aXZlQ29ubnMubGVuZ3RoID4gMCkgewogICAgICAgIGNvbm5lY3Rpb25JZCA9IGFjdGl2ZUNvbm5zWzBdLmdldENvbm5lY3Rpb25JZCgpOwogICAgICB9CiAgICB9CgogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlRPR0dMRV9BQ1RJVkVfQ09OTkVDVElPTlMsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IGNvbm5lY3Rpb25JZAogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5zZW5kU29mdHBob25lTWV0cmljcyA9IGZ1bmN0aW9uIChzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzLCBjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CgogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfU09GVFBIT05FX0NBTExfTUVUUklDUywgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNjcFZlcnNpb246IGdsb2JhbC5jY3BWZXJzaW9uLAogICAgICBzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzOiBzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzCiAgICB9LCBjYWxsYmFja3MpOwoKICAgIGNvbm5lY3QucHVibGlzaFNvZnRwaG9uZVN0YXRzKHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjY3BWZXJzaW9uOiBnbG9iYWwuY2NwVmVyc2lvbiwKICAgICAgc3RhdHM6IHNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MKICAgIH0pOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnNlbmRTb2Z0cGhvbmVSZXBvcnQgPSBmdW5jdGlvbiAocmVwb3J0LCBjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuU0VORF9TT0ZUUEhPTkVfQ0FMTF9SRVBPUlQsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjY3BWZXJzaW9uOiBnbG9iYWwuY2NwVmVyc2lvbiwKICAgICAgcmVwb3J0OiByZXBvcnQKICAgIH0sIGNhbGxiYWNrcyk7CgogICAgY29ubmVjdC5wdWJsaXNoU29mdHBob25lUmVwb3J0KHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjY3BWZXJzaW9uOiBnbG9iYWwuY2NwVmVyc2lvbiwKICAgICAgcmVwb3J0OiByZXBvcnQKICAgIH0pOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmNvbmZlcmVuY2VDb25uZWN0aW9ucyA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ09ORkVSRU5DRV9DT05ORUNUSU9OUywgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUudG9TbmFwc2hvdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db250YWN0U25hcHNob3QodGhpcy5fZ2V0RGF0YSgpKTsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBDb250YWN0U25hcHNob3QKICAgKi8KICB2YXIgQ29udGFjdFNuYXBzaG90ID0gZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICBjb25uZWN0LkNvbnRhY3QuY2FsbCh0aGlzLCBjb250YWN0RGF0YS5jb250YWN0SWQpOwogICAgdGhpcy5jb250YWN0RGF0YSA9IGNvbnRhY3REYXRhOwogIH07CiAgQ29udGFjdFNuYXBzaG90LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29udGFjdC5wcm90b3R5cGUpOwogIENvbnRhY3RTbmFwc2hvdC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBDb250YWN0U25hcHNob3Q7CgogIENvbnRhY3RTbmFwc2hvdC5wcm90b3R5cGUuX2dldERhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5jb250YWN0RGF0YTsKICB9OwoKICBDb250YWN0U25hcHNob3QucHJvdG90eXBlLl9jcmVhdGVDb25uZWN0aW9uQVBJID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25EYXRhKSB7CiAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ29ubmVjdGlvblNuYXBzaG90KGNvbm5lY3Rpb25EYXRhKTsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBDb25uZWN0aW9uCiAgICovCiAgdmFyIENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoY29udGFjdElkLCBjb25uZWN0aW9uSWQpIHsKICAgIHRoaXMuY29udGFjdElkID0gY29udGFjdElkOwogICAgdGhpcy5jb25uZWN0aW9uSWQgPSBjb25uZWN0aW9uSWQ7CiAgICB0aGlzLl9pbml0TWVkaWFDb250cm9sbGVyKCk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuX2dldERhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29ubmVjdGlvbkRhdGEoCiAgICAgIHRoaXMuZ2V0Q29udGFjdElkKCksIHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldENvbnRhY3RJZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbnRhY3RJZDsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRDb25uZWN0aW9uSWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5jb25uZWN0aW9uSWQ7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0RW5kcG9pbnQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gbmV3IGNvbm5lY3QuRW5kcG9pbnQodGhpcy5fZ2V0RGF0YSgpLmVuZHBvaW50KTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRBZGRyZXNzID0gQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0RW5kcG9pbnQ7CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zdGF0ZTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0dXMgPSBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0ZTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdGVEdXJhdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0Lm5vdygpIC0gdGhpcy5fZ2V0RGF0YSgpLnN0YXRlLnRpbWVzdGFtcC5nZXRUaW1lKCkgKyBjb25uZWN0LmNvcmUuZ2V0U2tldygpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXR1c0R1cmF0aW9uID0gQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdGVEdXJhdGlvbjsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0VHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkudHlwZTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5pc0luaXRpYWxDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5pbml0aWFsOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmlzQWN0aXZlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29udGFpbnMoY29ubmVjdC5DT05ORUNUSU9OX0FDVElWRV9TVEFURVMsIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNDb25uZWN0ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuQ09OTkVDVEVEOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmlzQ29ubmVjdGluZyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNUSU5HOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmlzT25Ib2xkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkhPTEQ7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U29mdHBob25lTWVkaWFJbmZvID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zb2Z0cGhvbmVNZWRpYUluZm87CiAgfTsKCiAgLyoqCiAgICogR2V0cyB0aGUgY3VycmVudGx5IG1vbml0b3JlZCBjb250YWN0IGluZm8sIFJldHVybnMgbnVsbCBpZiBkb2VzIG5vdCBleGlzdHMuCiAgICogQHJldHVybiB7e2FnZW50TmFtZTpzdHJpbmcsIGN1c3RvbWVyTmFtZTpzdHJpbmcsIGpvaW5UaW1lOkRhdGV9fQogICAqLwogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1vbml0b3JJbmZvID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5tb25pdG9yaW5nSW5mbzsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5ERVNUUk9ZX0NPTk5FQ1RJT04sIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuc2VuZERpZ2l0cyA9IGZ1bmN0aW9uIChkaWdpdHMsIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX0RJR0lUUywgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKSwKICAgICAgZGlnaXRzOiBkaWdpdHMKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaG9sZCA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuSE9MRF9DT05ORUNUSU9OLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY29ubmVjdGlvbklkOiB0aGlzLmdldENvbm5lY3Rpb25JZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLnJlc3VtZSA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuUkVTVU1FX0NPTk5FQ1RJT04sIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUudG9TbmFwc2hvdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db25uZWN0aW9uU25hcHNob3QodGhpcy5fZ2V0RGF0YSgpKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5faW5pdE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLmdldE1lZGlhSW5mbygpKSB7CiAgICAgIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkuZ2V0KHRoaXMpLmNhdGNoKGZ1bmN0aW9uICgpIHsgfSk7CiAgICB9CiAgfQoKICAvLyBNZXRob2QgZm9yIGNoZWNraW5nIHdoZXRoZXIgdGhpcyBjb25uZWN0aW9uIGlzIGFuIGFnZW50LXNpZGUgY29ubmVjdGlvbiAKICAvLyAodHlwZSBBR0VOVCBvciBNT05JVE9SSU5HKQogIENvbm5lY3Rpb24ucHJvdG90eXBlLl9pc0FnZW50Q29ubmVjdGlvblR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29ubmVjdGlvblR5cGUgPSB0aGlzLmdldFR5cGUoKTsKICAgIHJldHVybiBjb25uZWN0aW9uVHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5BR0VOVCAKICAgICAgfHwgY29ubmVjdGlvblR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuTU9OSVRPUklORzsKICB9CgogIC8qKgogICAqIFV0aWxpdHkgbWV0aG9kIGZvciBjaGVja2luZyB3aGV0aGVyIHRoaXMgY29ubmVjdGlvbiBpcyBhbiBhZ2VudC1zaWRlIGNvbm5lY3Rpb24gCiAgICogKHR5cGUgQUdFTlQgb3IgTU9OSVRPUklORykKICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoaXMgY29ubmVjdGlvbiBpcyBhbiBhZ2VudC1zaWRlIGNvbm5lY3Rpb24uIEZhbHNlIG90aGVyd2lzZS4KICAgKi8KICBDb25uZWN0aW9uLnByb3RvdHlwZS5faXNBZ2VudENvbm5lY3Rpb25UeXBlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNvbm5lY3Rpb25UeXBlID0gdGhpcy5nZXRUeXBlKCk7CiAgICByZXR1cm4gY29ubmVjdGlvblR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuQUdFTlQgCiAgICAgIHx8IGNvbm5lY3Rpb25UeXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLk1PTklUT1JJTkc7CiAgfQoKICAvKioKICAgKiBAY2xhc3MgVm9pY2VDb25uZWN0aW9uCiAgICogQHBhcmFtIHtudW1iZXJ9IGNvbnRhY3RJZCAKICAgKiBAcGFyYW0ge251bWJlcn0gY29ubmVjdGlvbklkIAogICAqIEBkZXNjcmlwdGlvbiAtIFByb3ZpZGVzIHZvaWNlIG1lZGlhIHNwZWNpZmljIG9wZXJhdGlvbnMKICAgKi8KICB2YXIgVm9pY2VDb25uZWN0aW9uID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKSB7CiAgICBDb25uZWN0aW9uLmNhbGwodGhpcywgY29udGFjdElkLCBjb25uZWN0aW9uSWQpOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbm5lY3Rpb24ucHJvdG90eXBlKTsKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVm9pY2VDb25uZWN0aW9uOwoKICAvKioKICAqIEBkZXByZWNhdGVkCiAgKiBQbGVhc2UgdXNlIGdldE1lZGlhSW5mbyAKICAqLwogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U29mdHBob25lTWVkaWFJbmZvID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zb2Z0cGhvbmVNZWRpYUluZm87CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNvZnRwaG9uZU1lZGlhSW5mbzsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0Lk1lZGlhVHlwZS5TT0ZUUEhPTkU7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcyk7CiAgfQoKCiAgLyoqCiAgICogQGNsYXNzIENoYXRDb25uZWN0aW9uCiAgICogQHBhcmFtIHsqfSBjb250YWN0SWQgCiAgICogQHBhcmFtIHsqfSBjb25uZWN0aW9uSWQgCiAgICogQGRlc2NyaXB0aW9uIGFkZHMgdGhlIGNoYXQgbWVkaWEgc3BlY2lmaWMgZnVuY3Rpb25hbGl0eQogICAqLwogIHZhciBDaGF0Q29ubmVjdGlvbiA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgQ29ubmVjdGlvbi5jYWxsKHRoaXMsIGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKTsKICB9OwoKICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbm5lY3Rpb24ucHJvdG90eXBlKTsKICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBDaGF0Q29ubmVjdGlvbjsKCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhSW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBkYXRhID0gdGhpcy5fZ2V0RGF0YSgpLmNoYXRNZWRpYUluZm87CiAgICBpZiAoIWRhdGEpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9IGVsc2UgewogICAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICAgIHZhciBtZWRpYU9iamVjdCA9IHsKICAgICAgICBjb250YWN0SWQ6IHRoaXMuY29udGFjdElkLAogICAgICAgIGluaXRpYWxDb250YWN0SWQ6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgdGhpcy5jb250YWN0SWQsCiAgICAgICAgcGFydGljaXBhbnRJZDogdGhpcy5jb25uZWN0aW9uSWQsCiAgICAgICAgZ2V0Q29ubmVjdGlvblRva2VuOiBjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMuZ2V0Q29ubmVjdGlvblRva2VuKQogICAgICB9OwogICAgICBpZiAoZGF0YS5jb25uZWN0aW9uRGF0YSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBtZWRpYU9iamVjdC5wYXJ0aWNpcGFudFRva2VuID0gSlNPTi5wYXJzZShkYXRhLmNvbm5lY3Rpb25EYXRhKS5Db25uZWN0aW9uQXV0aGVudGljYXRpb25Ub2tlbjsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKGNvbm5lY3QuTG9nQ29tcG9uZW50LkNIQVQsICJDb25uZWN0aW9uIGRhdGEgaXMgaW52YWxpZCIpLndpdGhPYmplY3QoZGF0YSkud2l0aEV4Y2VwdGlvbihlKTsKICAgICAgICAgIG1lZGlhT2JqZWN0LnBhcnRpY2lwYW50VG9rZW4gPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgICBtZWRpYU9iamVjdC5wYXJ0aWNpcGFudFRva2VuID0gbWVkaWFPYmplY3QucGFydGljaXBhbnRUb2tlbiB8fCBudWxsOwogICAgICAvKiogSnVzdCB0byBrZWVwIHRoZSBkYXRhIGFjY2Vzc2libGUgKi8KICAgICAgbWVkaWFPYmplY3Qub3JpZ2luYWxJbmZvID0gdGhpcy5fZ2V0RGF0YSgpLmNoYXRNZWRpYUluZm87CiAgICAgIHJldHVybiBtZWRpYU9iamVjdDsKICAgIH0KICB9OwoKICAvKioKICAqIFByb3ZpZGVzIHRoZSBjaGF0IGNvbm5lY3Rpb25Ub2tlbiB0aHJvdWdoIHRoZSBjcmVhdGVfdHJhbnNwb3J0IEFQSSBmb3IgYSBzcGVjaWZpYyBjb250YWN0IGFuZCBwYXJ0aWNpcGFudCBJZC4gCiAgKiBAcmV0dXJucyBhIHByb21pc2Ugd2hpY2gsIHVwb24gc3VjY2VzcywgcmV0dXJucyB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgY3JlYXRlVHJhbnNwb3J0IEFQSS4KICAqIFVzYWdlOgogICogY29ubmVjdGlvbi5nZXRDb25uZWN0aW9uVG9rZW4oKQogICogIC50aGVuKHJlc3BvbnNlID0+IHt9KQogICogIC5jYXRjaChlcnJvciA9PiB7fSkKICAqLwogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRDb25uZWN0aW9uVG9rZW4gPSBmdW5jdGlvbiAoKSB7CiAgICBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICB2YXIgdHJhbnNwb3J0RGV0YWlscyA9IHsKICAgICAgdHJhbnNwb3J0VHlwZTogY29ubmVjdC5UUkFOU1BPUlRfVFlQRVMuQ0hBVF9UT0tFTiwKICAgICAgcGFydGljaXBhbnRJZDogdGhpcy5jb25uZWN0aW9uSWQsCiAgICAgIGNvbnRhY3RJZDogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCB0aGlzLmNvbnRhY3RJZAogICAgfTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfVFJBTlNQT1JULCB0cmFuc3BvcnREZXRhaWxzLCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZ2V0Q29ubmVjdGlvblRva2VuIHN1Y2NlZWRlZCIpOwogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldENvbm5lY3Rpb25Ub2tlbiBmYWlsZWQiKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgIHJlamVjdChFcnJvcigiZ2V0Q29ubmVjdGlvblRva2VuIGZhaWxlZCIpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0Lk1lZGlhVHlwZS5DSEFUOwogIH07CgogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcyk7CiAgfTsKCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLl9pbml0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgewogICAgLy8gTm90ZSB0aGF0IGEgY2hhdCBtZWRpYSBjb250cm9sbGVyIG9ubHkgbmVlZHMgdG8gYmUgcHJvZHVjZWQgZm9yIGFnZW50IHR5cGUgY29ubmVjdGlvbnMuCiAgICBpZiAodGhpcy5faXNBZ2VudENvbm5lY3Rpb25UeXBlKCkpIHsKICAgICAgY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcykuY2F0Y2goZnVuY3Rpb24gKCkgeyB9KTsKICAgIH0KICB9CgogIC8qKgogICAqIEBjbGFzcyBUYXNrQ29ubmVjdGlvbgogICAqIEBwYXJhbSB7Kn0gY29udGFjdElkIAogICAqIEBwYXJhbSB7Kn0gY29ubmVjdGlvbklkIAogICAqIEBkZXNjcmlwdGlvbiBhZGRzIHRoZSB0YXNrIG1lZGlhIHNwZWNpZmljIGZ1bmN0aW9uYWxpdHkKICAgKi8KICB2YXIgVGFza0Nvbm5lY3Rpb24gPSBmdW5jdGlvbiAoY29udGFjdElkLCBjb25uZWN0aW9uSWQpIHsKICAgIENvbm5lY3Rpb24uY2FsbCh0aGlzLCBjb250YWN0SWQsIGNvbm5lY3Rpb25JZCk7CiAgfTsKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbm5lY3Rpb24ucHJvdG90eXBlKTsKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBUYXNrQ29ubmVjdGlvbjsKCiAgVGFza0Nvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0Lk1lZGlhVHlwZS5UQVNLOwogIH0KCiAgVGFza0Nvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhSW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBudWxsOwogIH07CgogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gbnVsbDsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBDb25uZWN0aW9uU25hcHNob3QKICAgKi8KICB2YXIgQ29ubmVjdGlvblNuYXBzaG90ID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25EYXRhKSB7CiAgICBjb25uZWN0LkNvbm5lY3Rpb24uY2FsbCh0aGlzLCBjb25uZWN0aW9uRGF0YS5jb250YWN0SWQsIGNvbm5lY3Rpb25EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICB0aGlzLmNvbm5lY3Rpb25EYXRhID0gY29ubmVjdGlvbkRhdGE7CiAgfTsKICBDb25uZWN0aW9uU25hcHNob3QucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb25uZWN0aW9uLnByb3RvdHlwZSk7CiAgQ29ubmVjdGlvblNuYXBzaG90LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENvbm5lY3Rpb25TbmFwc2hvdDsKCiAgQ29ubmVjdGlvblNuYXBzaG90LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbm5lY3Rpb25EYXRhOwogIH07CgogIENvbm5lY3Rpb25TbmFwc2hvdC5wcm90b3R5cGUuX2luaXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoKSB7IH07CgogIHZhciBFbmRwb2ludCA9IGZ1bmN0aW9uIChwYXJhbXNJbikgewogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgdGhpcy5lbmRwb2ludEFSTiA9IHBhcmFtcy5lbmRwb2ludElkIHx8IHBhcmFtcy5lbmRwb2ludEFSTiB8fCBudWxsOwogICAgdGhpcy5lbmRwb2ludElkID0gdGhpcy5lbmRwb2ludEFSTjsKICAgIHRoaXMudHlwZSA9IHBhcmFtcy50eXBlIHx8IG51bGw7CiAgICB0aGlzLm5hbWUgPSBwYXJhbXMubmFtZSB8fCBudWxsOwogICAgdGhpcy5waG9uZU51bWJlciA9IHBhcmFtcy5waG9uZU51bWJlciB8fCBudWxsOwogICAgdGhpcy5hZ2VudExvZ2luID0gcGFyYW1zLmFnZW50TG9naW4gfHwgbnVsbDsKICAgIHRoaXMucXVldWUgPSBwYXJhbXMucXVldWUgfHwgbnVsbDsKICB9OwoKICAvKioKICAgKiBTdHJpcCB0aGUgU0lQIGVuZHBvaW50IGNvbXBvbmVudHMgZnJvbSB0aGUgcGhvbmVOdW1iZXIgZmllbGQuCiAgICovCiAgRW5kcG9pbnQucHJvdG90eXBlLnN0cmlwUGhvbmVOdW1iZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5waG9uZU51bWJlciA/IHRoaXMucGhvbmVOdW1iZXIucmVwbGFjZSgvc2lwOihbXkBdKilALiovLCAiJDEiKSA6ICIiOwogIH07CgogIC8qKgogICAqIENyZWF0ZSBhbiBFbmRwb2ludCBvYmplY3QgZnJvbSB0aGUgZ2l2ZW4gcGhvbmUgbnVtYmVyIGFuZCBuYW1lLgogICAqLwogIEVuZHBvaW50LmJ5UGhvbmVOdW1iZXIgPSBmdW5jdGlvbiAobnVtYmVyLCBuYW1lKSB7CiAgICByZXR1cm4gbmV3IEVuZHBvaW50KHsKICAgICAgdHlwZTogY29ubmVjdC5FbmRwb2ludFR5cGUuUEhPTkVfTlVNQkVSLAogICAgICBwaG9uZU51bWJlcjogbnVtYmVyLAogICAgICBuYW1lOiBuYW1lIHx8IG51bGwKICAgIH0pOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIFNvZnRwaG9uZUVycm9yCiAgICovCiAgdmFyIFNvZnRwaG9uZUVycm9yID0gZnVuY3Rpb24gKGVycm9yVHlwZSwgZXJyb3JNZXNzYWdlLCBlbmRQb2ludFVybCkgewogICAgdGhpcy5lcnJvclR5cGUgPSBlcnJvclR5cGU7CiAgICB0aGlzLmVycm9yTWVzc2FnZSA9IGVycm9yTWVzc2FnZTsKICAgIHRoaXMuZW5kUG9pbnRVcmwgPSBlbmRQb2ludFVybDsKICB9OwogIFNvZnRwaG9uZUVycm9yLnByb3RvdHlwZS5nZXRFcnJvclR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5lcnJvclR5cGU7CiAgfTsKICBTb2Z0cGhvbmVFcnJvci5wcm90b3R5cGUuZ2V0RXJyb3JNZXNzYWdlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZXJyb3JNZXNzYWdlOwogIH07CiAgU29mdHBob25lRXJyb3IucHJvdG90eXBlLmdldEVuZFBvaW50VXJsID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZW5kUG9pbnRVcmw7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogUm9vdCBTdWJzY3JpcHRpb24gQVBJcy4KICAgKi8KICBjb25uZWN0LmFnZW50ID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIHZhciBzdWIgPSBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuSU5JVCwgZik7CiAgICBpZiAoY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCkgewogICAgICBmKG5ldyBjb25uZWN0LkFnZW50KCkpOwogICAgfQogICAgcmV0dXJuIHN1YjsKICB9OwogIGNvbm5lY3QuYWdlbnQuaW5pdGlhbGl6ZWQgPSBmYWxzZTsKCiAgY29ubmVjdC5jb250YWN0ID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIHJldHVybiBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5JTklULCBmKTsKICB9OwoKICBjb25uZWN0Lm9uV2Vic29ja2V0SW5pdEZhaWx1cmUgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgdmFyIHN1YiA9IGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuSU5JVF9GQUlMVVJFLCBmKTsKICAgIGlmIChjb25uZWN0LndlYlNvY2tldEluaXRGYWlsZWQpIHsKICAgICAgZigpOwogICAgfQogICAgcmV0dXJuIHN1YjsKICB9OwoKICAvKioKICAgKiBFeGVjdXRlIHRoZSBnaXZlbiBmdW5jdGlvbiBhc3luY2hyb25vdXNseSBvbmx5IGlmIHRoZSBzaGFyZWQgd29ya2VyCiAgICogc2F5cyB3ZSBhcmUgdGhlIG1hc3RlciBmb3IgdGhlIGdpdmVuIHRvcGljLiAgSWYgdGhlcmUgaXMgbm8gbWFzdGVyIGZvcgogICAqIHRoZSBnaXZlbiB0b3BpYywgd2UgYmVjb21lIHRoZSBtYXN0ZXIgYW5kIGV4ZWN1dGUgdGhlIGZ1bmN0aW9uLgogICAqCiAgICogQHBhcmFtIHRvcGljIFRoZSBtYXN0ZXIgdG9waWMgd2UgYXJlIGNvbmNlcm5lZCBhYm91dC4KICAgKiBAcGFyYW0gZl90cnVlIFRoZSBjYWxsYmFjayB0byBiZSBpbnZva2VkIGlmIHdlIGFyZSB0aGUgbWFzdGVyLgogICAqIEBwYXJhbSBmX2Vsc2UgW29wdGlvbmFsXSBBIGNhbGxiYWNrIHRvIGJlIGludm9rZWQgaWYgd2UgYXJlIG5vdCB0aGUgbWFzdGVyLgogICAqLwogIGNvbm5lY3QuaWZNYXN0ZXIgPSBmdW5jdGlvbiAodG9waWMsIGZfdHJ1ZSwgZl9lbHNlKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWMsICJBIHRvcGljIG11c3QgYmUgcHJvdmlkZWQuIik7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZl90cnVlLCAiQSB0cnVlIGNhbGxiYWNrIG11c3QgYmUgcHJvdmlkZWQuIik7CgogICAgaWYgKCFjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50KSB7CiAgICAgIC8vIFdlIGNhbid0IGJlIHRoZSBtYXN0ZXIgYmVjYXVzZSB0aGVyZSBpcyBubyBtYXN0ZXIgY2xpZW50IQogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIldlIGNhbid0IGJlIHRoZSBtYXN0ZXIgZm9yIHRvcGljICclcycgYmVjYXVzZSB0aGVyZSBpcyBubyBtYXN0ZXIgY2xpZW50ISIsIHRvcGljKTsKICAgICAgaWYgKGZfZWxzZSkgewogICAgICAgIGZfZWxzZSgpOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgbWFzdGVyQ2xpZW50ID0gY29ubmVjdC5jb3JlLmdldE1hc3RlckNsaWVudCgpOwogICAgbWFzdGVyQ2xpZW50LmNhbGwoY29ubmVjdC5NYXN0ZXJNZXRob2RzLkNIRUNLX01BU1RFUiwgewogICAgICB0b3BpYzogdG9waWMKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEuaXNNYXN0ZXIpIHsKICAgICAgICAgICAgZl90cnVlKCk7CgogICAgICAgICAgfSBlbHNlIGlmIChmX2Vsc2UpIHsKICAgICAgICAgICAgZl9lbHNlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICB9OwoKICAvKioKICAgKiBOb3RpZnkgdGhlIHNoYXJlZCB3b3JrZXIgdGhhdCB3ZSBhcmUgbm93IHRoZSBtYXN0ZXIgZm9yIHRoZSBnaXZlbiB0b3BpYy4KICAgKi8KICBjb25uZWN0LmJlY29tZU1hc3RlciA9IGZ1bmN0aW9uICh0b3BpYykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljLCAiQSB0b3BpYyBtdXN0IGJlIHByb3ZpZGVkLiIpOwogICAgdmFyIG1hc3RlckNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRNYXN0ZXJDbGllbnQoKTsKICAgIG1hc3RlckNsaWVudC5jYWxsKGNvbm5lY3QuTWFzdGVyTWV0aG9kcy5CRUNPTUVfTUFTVEVSLCB7CiAgICAgIHRvcGljOiB0b3BpYwogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5BZ2VudCA9IEFnZW50OwogIGNvbm5lY3QuQWdlbnRTbmFwc2hvdCA9IEFnZW50U25hcHNob3Q7CiAgY29ubmVjdC5Db250YWN0ID0gQ29udGFjdDsKICBjb25uZWN0LkNvbnRhY3RTbmFwc2hvdCA9IENvbnRhY3RTbmFwc2hvdDsKICAvKiogRGVmYXVsdCB3aWxsIGdldCB0aGUgVm9pY2UgY29ubmVjdGlvbiAqLwogIGNvbm5lY3QuQ29ubmVjdGlvbiA9IFZvaWNlQ29ubmVjdGlvbjsKICBjb25uZWN0LkJhc2VDb25uZWN0aW9uID0gQ29ubmVjdGlvbjsKICBjb25uZWN0LlZvaWNlQ29ubmVjdGlvbiA9IFZvaWNlQ29ubmVjdGlvbjsKICBjb25uZWN0LkNoYXRDb25uZWN0aW9uID0gQ2hhdENvbm5lY3Rpb247CiAgY29ubmVjdC5UYXNrQ29ubmVjdGlvbiA9IFRhc2tDb25uZWN0aW9uOwogIGNvbm5lY3QuQ29ubmVjdGlvblNuYXBzaG90ID0gQ29ubmVjdGlvblNuYXBzaG90OwogIGNvbm5lY3QuRW5kcG9pbnQgPSBFbmRwb2ludDsKICBjb25uZWN0LkFkZHJlc3MgPSBFbmRwb2ludDsKICBjb25uZWN0LlNvZnRwaG9uZUVycm9yID0gU29mdHBob25lRXJyb3I7Cgp9KSgpOwoKCiFmdW5jdGlvbihlKXt2YXIgbj17fTtmdW5jdGlvbiB0KG8pe2lmKG5bb10pcmV0dXJuIG5bb10uZXhwb3J0czt2YXIgcj1uW29dPXtpOm8sbDohMSxleHBvcnRzOnt9fTtyZXR1cm4gZVtvXS5jYWxsKHIuZXhwb3J0cyxyLHIuZXhwb3J0cyx0KSxyLmw9ITAsci5leHBvcnRzfXQubT1lLHQuYz1uLHQuZD1mdW5jdGlvbihlLG4sbyl7dC5vKGUsbil8fE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLG4se2VudW1lcmFibGU6ITAsZ2V0Om99KX0sdC5yPWZ1bmN0aW9uKGUpeyJ1bmRlZmluZWQiIT10eXBlb2YgU3ltYm9sJiZTeW1ib2wudG9TdHJpbmdUYWcmJk9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLFN5bWJvbC50b1N0cmluZ1RhZyx7dmFsdWU6Ik1vZHVsZSJ9KSxPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwiX19lc01vZHVsZSIse3ZhbHVlOiEwfSl9LHQudD1mdW5jdGlvbihlLG4pe2lmKDEmbiYmKGU9dChlKSksOCZuKXJldHVybiBlO2lmKDQmbiYmIm9iamVjdCI9PXR5cGVvZiBlJiZlJiZlLl9fZXNNb2R1bGUpcmV0dXJuIGU7dmFyIG89T2JqZWN0LmNyZWF0ZShudWxsKTtpZih0LnIobyksT2JqZWN0LmRlZmluZVByb3BlcnR5KG8sImRlZmF1bHQiLHtlbnVtZXJhYmxlOiEwLHZhbHVlOmV9KSwyJm4mJiJzdHJpbmciIT10eXBlb2YgZSlmb3IodmFyIHIgaW4gZSl0LmQobyxyLGZ1bmN0aW9uKG4pe3JldHVybiBlW25dfS5iaW5kKG51bGwscikpO3JldHVybiBvfSx0Lm49ZnVuY3Rpb24oZSl7dmFyIG49ZSYmZS5fX2VzTW9kdWxlP2Z1bmN0aW9uKCl7cmV0dXJuIGUuZGVmYXVsdH06ZnVuY3Rpb24oKXtyZXR1cm4gZX07cmV0dXJuIHQuZChuLCJhIixuKSxufSx0Lm89ZnVuY3Rpb24oZSxuKXtyZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGUsbil9LHQucD0iIix0KHQucz0yKX0oW2Z1bmN0aW9uKGUsbix0KXsidXNlIHN0cmljdCI7dmFyIG89dCgxKTtmdW5jdGlvbiByKGUpe3JldHVybihyPSJmdW5jdGlvbiI9PXR5cGVvZiBTeW1ib2wmJiJzeW1ib2wiPT10eXBlb2YgU3ltYm9sLml0ZXJhdG9yP2Z1bmN0aW9uKGUpe3JldHVybiB0eXBlb2YgZX06ZnVuY3Rpb24oZSl7cmV0dXJuIGUmJiJmdW5jdGlvbiI9PXR5cGVvZiBTeW1ib2wmJmUuY29uc3RydWN0b3I9PT1TeW1ib2wmJmUhPT1TeW1ib2wucHJvdG90eXBlPyJzeW1ib2wiOnR5cGVvZiBlfSkoZSl9dmFyIGk9e2Fzc2VydFRydWU6ZnVuY3Rpb24oZSxuKXtpZighZSl0aHJvdyBuZXcgRXJyb3Iobil9LGFzc2VydE5vdE51bGw6ZnVuY3Rpb24oZSxuKXtyZXR1cm4gaS5hc3NlcnRUcnVlKG51bGwhPT1lJiZ2b2lkIDAhPT1yKGUpLE9iamVjdChvLnNwcmludGYpKCIlcyBtdXN0IGJlIHByb3ZpZGVkIixufHwiQSB2YWx1ZSIpKSxlfSxpc05vbkVtcHR5U3RyaW5nOmZ1bmN0aW9uKGUpe3JldHVybiJzdHJpbmciPT10eXBlb2YgZSYmZS5sZW5ndGg+MH0sYXNzZXJ0SXNMaXN0OmZ1bmN0aW9uKGUsbil7aWYoIUFycmF5LmlzQXJyYXkoZSkpdGhyb3cgbmV3IEVycm9yKG4rIiBpcyBub3QgYW4gYXJyYXkiKX0saXNGdW5jdGlvbjpmdW5jdGlvbihlKXtyZXR1cm4hIShlJiZlLmNvbnN0cnVjdG9yJiZlLmNhbGwmJmUuYXBwbHkpfSxpc09iamVjdDpmdW5jdGlvbihlKXtyZXR1cm4hKCJvYmplY3QiIT09cihlKXx8bnVsbD09PWUpfSxpc1N0cmluZzpmdW5jdGlvbihlKXtyZXR1cm4ic3RyaW5nIj09dHlwZW9mIGV9LGlzTnVtYmVyOmZ1bmN0aW9uKGUpe3JldHVybiJudW1iZXIiPT10eXBlb2YgZX19LGM9bmV3IFJlZ0V4cCgiXih3c3M6Ly8pXFx3KiIpO2kudmFsaWRXU1VybD1mdW5jdGlvbihlKXtyZXR1cm4gYy50ZXN0KGUpfSxpLmdldFN1YnNjcmlwdGlvblJlc3BvbnNlPWZ1bmN0aW9uKGUsbix0KXtyZXR1cm57dG9waWM6ZSxjb250ZW50OntzdGF0dXM6bj8ic3VjY2VzcyI6ImZhaWx1cmUiLHRvcGljczp0fX19LGkuYXNzZXJ0SXNPYmplY3Q9ZnVuY3Rpb24oZSxuKXtpZighaS5pc09iamVjdChlKSl0aHJvdyBuZXcgRXJyb3IobisiIGlzIG5vdCBhbiBvYmplY3QhIil9LGkuYWRkSml0dGVyPWZ1bmN0aW9uKGUpe3ZhciBuPWFyZ3VtZW50cy5sZW5ndGg+MSYmdm9pZCAwIT09YXJndW1lbnRzWzFdP2FyZ3VtZW50c1sxXToxO249TWF0aC5taW4obiwxKTt2YXIgdD1NYXRoLnJhbmRvbSgpPi41PzE6LTE7cmV0dXJuIE1hdGguZmxvb3IoZSt0KmUqTWF0aC5yYW5kb20oKSpuKX0saS5pc05ldHdvcmtPbmxpbmU9ZnVuY3Rpb24oKXtyZXR1cm4gbmF2aWdhdG9yLm9uTGluZX07dmFyIHM9aSxhPSJOVUxMIix1PSJDTElFTlRfTE9HR0VSIixsPSJERUJVRyIsZj0iYXdzL3N1YnNjcmliZSIscD0iYXdzL3Vuc3Vic2NyaWJlIixkPSJhd3MvaGVhcnRiZWF0IixiPSJjb25uZWN0ZWQiLGc9ImRpc2Nvbm5lY3RlZCI7ZnVuY3Rpb24gbShlKXtyZXR1cm4obT0iZnVuY3Rpb24iPT10eXBlb2YgU3ltYm9sJiYic3ltYm9sIj09dHlwZW9mIFN5bWJvbC5pdGVyYXRvcj9mdW5jdGlvbihlKXtyZXR1cm4gdHlwZW9mIGV9OmZ1bmN0aW9uKGUpe3JldHVybiBlJiYiZnVuY3Rpb24iPT10eXBlb2YgU3ltYm9sJiZlLmNvbnN0cnVjdG9yPT09U3ltYm9sJiZlIT09U3ltYm9sLnByb3RvdHlwZT8ic3ltYm9sIjp0eXBlb2YgZX0pKGUpfWZ1bmN0aW9uIHkoZSxuKXtyZXR1cm4hbnx8Im9iamVjdCIhPT1tKG4pJiYiZnVuY3Rpb24iIT10eXBlb2Ygbj9mdW5jdGlvbihlKXtpZih2b2lkIDA9PT1lKXRocm93IG5ldyBSZWZlcmVuY2VFcnJvcigidGhpcyBoYXNuJ3QgYmVlbiBpbml0aWFsaXNlZCAtIHN1cGVyKCkgaGFzbid0IGJlZW4gY2FsbGVkIik7cmV0dXJuIGV9KGUpOm59ZnVuY3Rpb24gUyhlKXtyZXR1cm4oUz1PYmplY3Quc2V0UHJvdG90eXBlT2Y/T2JqZWN0LmdldFByb3RvdHlwZU9mOmZ1bmN0aW9uKGUpe3JldHVybiBlLl9fcHJvdG9fX3x8T2JqZWN0LmdldFByb3RvdHlwZU9mKGUpfSkoZSl9ZnVuY3Rpb24gayhlLG4pe3JldHVybihrPU9iamVjdC5zZXRQcm90b3R5cGVPZnx8ZnVuY3Rpb24oZSxuKXtyZXR1cm4gZS5fX3Byb3RvX189bixlfSkoZSxuKX1mdW5jdGlvbiBoKGUsbil7aWYoIShlIGluc3RhbmNlb2YgbikpdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIil9ZnVuY3Rpb24gdihlLG4pe2Zvcih2YXIgdD0wO3Q8bi5sZW5ndGg7dCsrKXt2YXIgbz1uW3RdO28uZW51bWVyYWJsZT1vLmVudW1lcmFibGV8fCExLG8uY29uZmlndXJhYmxlPSEwLCJ2YWx1ZSJpbiBvJiYoby53cml0YWJsZT0hMCksT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsby5rZXksbyl9fWZ1bmN0aW9uIHcoZSxuLHQpe3JldHVybiBuJiZ2KGUucHJvdG90eXBlLG4pLHQmJnYoZSx0KSxlfXZhciBDPWZ1bmN0aW9uKCl7ZnVuY3Rpb24gZSgpe2godGhpcyxlKX1yZXR1cm4gdyhlLFt7a2V5OiJkZWJ1ZyIsdmFsdWU6ZnVuY3Rpb24oZSl7fX0se2tleToiaW5mbyIsdmFsdWU6ZnVuY3Rpb24oZSl7fX0se2tleToid2FybiIsdmFsdWU6ZnVuY3Rpb24oZSl7fX0se2tleToiZXJyb3IiLHZhbHVlOmZ1bmN0aW9uKGUpe319XSksZX0oKSxUPXtERUJVRzoxMCxJTkZPOjIwLFdBUk46MzAsRVJST1I6NDB9LE89ZnVuY3Rpb24oKXtmdW5jdGlvbiBlKCl7aCh0aGlzLGUpLHRoaXMudXBkYXRlTG9nZ2VyQ29uZmlnKCksdGhpcy5jb25zb2xlTG9nZ2VyV3JhcHBlcj1OKCl9cmV0dXJuIHcoZSxbe2tleToid3JpdGVUb0NsaWVudExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oZSxuKXtpZih0aGlzLmhhc0NsaWVudExvZ2dlcigpKXN3aXRjaChlKXtjYXNlIFQuREVCVUc6cmV0dXJuIHRoaXMuX2NsaWVudExvZ2dlci5kZWJ1ZyhuKTtjYXNlIFQuSU5GTzpyZXR1cm4gdGhpcy5fY2xpZW50TG9nZ2VyLmluZm8obik7Y2FzZSBULldBUk46cmV0dXJuIHRoaXMuX2NsaWVudExvZ2dlci53YXJuKG4pO2Nhc2UgVC5FUlJPUjpyZXR1cm4gdGhpcy5fY2xpZW50TG9nZ2VyLmVycm9yKG4pfX19LHtrZXk6ImlzTGV2ZWxFbmFibGVkIix2YWx1ZTpmdW5jdGlvbihlKXtyZXR1cm4gZT49dGhpcy5fbGV2ZWx9fSx7a2V5OiJoYXNDbGllbnRMb2dnZXIiLHZhbHVlOmZ1bmN0aW9uKCl7cmV0dXJuIG51bGwhPT10aGlzLl9jbGllbnRMb2dnZXJ9fSx7a2V5OiJnZXRMb2dnZXIiLHZhbHVlOmZ1bmN0aW9uKGUpe3ZhciBuPWUucHJlZml4fHwiIjtyZXR1cm4gdGhpcy5fbG9nc0Rlc3RpbmF0aW9uPT09bD90aGlzLmNvbnNvbGVMb2dnZXJXcmFwcGVyOm5ldyBXKG4pfX0se2tleToidXBkYXRlTG9nZ2VyQ29uZmlnIix2YWx1ZTpmdW5jdGlvbihlKXt2YXIgbj1lfHx7fTt0aGlzLl9sZXZlbD1uLmxldmVsfHxULkRFQlVHLHRoaXMuX2NsaWVudExvZ2dlcj1uLmxvZ2dlcnx8bnVsbCx0aGlzLl9sb2dzRGVzdGluYXRpb249YSxuLmRlYnVnJiYodGhpcy5fbG9nc0Rlc3RpbmF0aW9uPWwpLG4ubG9nZ2VyJiYodGhpcy5fbG9nc0Rlc3RpbmF0aW9uPXUpfX1dKSxlfSgpLEk9ZnVuY3Rpb24oKXtmdW5jdGlvbiBlKCl7aCh0aGlzLGUpfXJldHVybiB3KGUsW3trZXk6ImRlYnVnIix2YWx1ZTpmdW5jdGlvbigpe319LHtrZXk6ImluZm8iLHZhbHVlOmZ1bmN0aW9uKCl7fX0se2tleToid2FybiIsdmFsdWU6ZnVuY3Rpb24oKXt9fSx7a2V5OiJlcnJvciIsdmFsdWU6ZnVuY3Rpb24oKXt9fV0pLGV9KCksVz1mdW5jdGlvbihlKXtmdW5jdGlvbiBuKGUpe3ZhciB0O3JldHVybiBoKHRoaXMsbiksKHQ9eSh0aGlzLFMobikuY2FsbCh0aGlzKSkpLnByZWZpeD1lfHwiIix0fXJldHVybiBmdW5jdGlvbihlLG4pe2lmKCJmdW5jdGlvbiIhPXR5cGVvZiBuJiZudWxsIT09bil0aHJvdyBuZXcgVHlwZUVycm9yKCJTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiIpO2UucHJvdG90eXBlPU9iamVjdC5jcmVhdGUobiYmbi5wcm90b3R5cGUse2NvbnN0cnVjdG9yOnt2YWx1ZTplLHdyaXRhYmxlOiEwLGNvbmZpZ3VyYWJsZTohMH19KSxuJiZrKGUsbil9KG4sSSksdyhuLFt7a2V5OiJkZWJ1ZyIsdmFsdWU6ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTt0aGlzLl9sb2coVC5ERUJVRyxuKX19LHtrZXk6ImluZm8iLHZhbHVlOmZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07dGhpcy5fbG9nKFQuSU5GTyxuKX19LHtrZXk6Indhcm4iLHZhbHVlOmZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07dGhpcy5fbG9nKFQuV0FSTixuKX19LHtrZXk6ImVycm9yIix2YWx1ZTpmdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3RoaXMuX2xvZyhULkVSUk9SLG4pfX0se2tleToiX3Nob3VsZExvZyIsdmFsdWU6ZnVuY3Rpb24oZSl7cmV0dXJuIF8uaGFzQ2xpZW50TG9nZ2VyKCkmJl8uaXNMZXZlbEVuYWJsZWQoZSl9fSx7a2V5OiJfd3JpdGVUb0NsaWVudExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oZSxuKXtfLndyaXRlVG9DbGllbnRMb2dnZXIoZSxuKX19LHtrZXk6Il9sb2ciLHZhbHVlOmZ1bmN0aW9uKGUsbil7aWYodGhpcy5fc2hvdWxkTG9nKGUpKXt2YXIgdD10aGlzLl9jb252ZXJ0VG9TaW5nbGVTdGF0ZW1lbnQobik7dGhpcy5fd3JpdGVUb0NsaWVudExvZ2dlcihlLHQpfX19LHtrZXk6Il9jb252ZXJ0VG9TaW5nbGVTdGF0ZW1lbnQiLHZhbHVlOmZ1bmN0aW9uKGUpe3ZhciBuPSIiO3RoaXMucHJlZml4JiYobis9dGhpcy5wcmVmaXgrIiAiKTtmb3IodmFyIHQ9MDt0PGUubGVuZ3RoO3QrKyl7dmFyIG89ZVt0XTtuKz10aGlzLl9jb252ZXJ0VG9TdHJpbmcobykrIiAifXJldHVybiBufX0se2tleToiX2NvbnZlcnRUb1N0cmluZyIsdmFsdWU6ZnVuY3Rpb24oZSl7dHJ5e2lmKCFlKXJldHVybiIiO2lmKHMuaXNTdHJpbmcoZSkpcmV0dXJuIGU7aWYocy5pc09iamVjdChlKSYmcy5pc0Z1bmN0aW9uKGUudG9TdHJpbmcpKXt2YXIgbj1lLnRvU3RyaW5nKCk7aWYoIltvYmplY3QgT2JqZWN0XSIhPT1uKXJldHVybiBufXJldHVybiBKU09OLnN0cmluZ2lmeShlKX1jYXRjaChuKXtyZXR1cm4gY29uc29sZS5lcnJvcigiRXJyb3Igd2hpbGUgY29udmVydGluZyBhcmd1bWVudCB0byBzdHJpbmciLGUsbiksIiJ9fX1dKSxufSgpLE49ZnVuY3Rpb24oKXt2YXIgZT1uZXcgSTtyZXR1cm4gZS5kZWJ1Zz1jb25zb2xlLmRlYnVnLGUuaW5mbz1jb25zb2xlLmluZm8sZS53YXJuPWNvbnNvbGUud2FybixlLmVycm9yPWNvbnNvbGUuZXJyb3IsZX0sXz1uZXcgTzt0LmQobiwiYSIsZnVuY3Rpb24oKXtyZXR1cm4gTH0pO3ZhciBFPWZ1bmN0aW9uKCl7dmFyIGU9Xy5nZXRMb2dnZXIoe30pLG49cy5pc05ldHdvcmtPbmxpbmUoKSx0PXtwcmltYXJ5Om51bGwsc2Vjb25kYXJ5Om51bGx9LG89e3JlY29ubmVjdFdlYlNvY2tldDohMCx3ZWJzb2NrZXRJbml0RmFpbGVkOiExLGV4cG9uZW50aWFsQmFja09mZlRpbWU6MWUzLGV4cG9uZW50aWFsVGltZW91dEhhbmRsZTpudWxsLGxpZmVUaW1lVGltZW91dEhhbmRsZTpudWxsLHdlYlNvY2tldEluaXRDaGVja2VyVGltZW91dElkOm51bGwsY29ublN0YXRlOm51bGx9LHI9e2Nvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50OjAsY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU6bnVsbCxub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcDpudWxsfSxpPXtwZW5kaW5nUmVzcG9uc2U6ITEsaW50ZXJ2YWxIYW5kbGU6bnVsbH0sYz17aW5pdEZhaWx1cmU6bmV3IFNldCxnZXRXZWJTb2NrZXRUcmFuc3BvcnQ6bnVsbCxzdWJzY3JpcHRpb25VcGRhdGU6bmV3IFNldCxzdWJzY3JpcHRpb25GYWlsdXJlOm5ldyBTZXQsdG9waWM6bmV3IE1hcCxhbGxNZXNzYWdlOm5ldyBTZXQsY29ubmVjdGlvbkdhaW46bmV3IFNldCxjb25uZWN0aW9uTG9zdDpuZXcgU2V0LGNvbm5lY3Rpb25PcGVuOm5ldyBTZXQsY29ubmVjdGlvbkNsb3NlOm5ldyBTZXR9LGE9e2Nvbm5Db25maWc6bnVsbCxwcm9taXNlSGFuZGxlOm51bGwscHJvbWlzZUNvbXBsZXRlZDohMH0sdT17c3Vic2NyaWJlZDpuZXcgU2V0LHBlbmRpbmc6bmV3IFNldCxzdWJzY3JpcHRpb25IaXN0b3J5Om5ldyBTZXR9LGw9e3Jlc3BvbnNlQ2hlY2tJbnRlcnZhbElkOm51bGwscmVxdWVzdENvbXBsZXRlZDohMCxyZVN1YnNjcmliZUludGVydmFsSWQ6bnVsbCxjb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzOjAsY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdDowfSxtPW5ldyBTZXQoW2YscCxkXSkseT1zZXRJbnRlcnZhbChmdW5jdGlvbigpe2lmKG4hPT1zLmlzTmV0d29ya09ubGluZSgpKXtpZighKG49cy5pc05ldHdvcmtPbmxpbmUoKSkpcmV0dXJuIHZvaWQgZS5pbmZvKCJOZXR3b3JrIG9mZmxpbmUiKTt2YXIgdD1UKCk7biYmKCF0fHx2KHQsV2ViU29ja2V0LkNMT1NJTkcpfHx2KHQsV2ViU29ja2V0LkNMT1NFRCkpJiYoZS5pbmZvKCJOZXR3b3JrIG9ubGluZSwgY29ubmVjdGluZyB0byBXZWJTb2NrZXQgc2VydmVyIiksRygpKX19LDI1MCksUz1mdW5jdGlvbihuLHQpe24uZm9yRWFjaChmdW5jdGlvbihuKXt0cnl7bih0KX1jYXRjaChuKXtlLmVycm9yKCJFcnJvciBleGVjdXRpbmcgY2FsbGJhY2siLG4pfX0pfSxrPWZ1bmN0aW9uKGUpe2lmKG51bGw9PT1lKXJldHVybiJOVUxMIjtzd2l0Y2goZS5yZWFkeVN0YXRlKXtjYXNlIFdlYlNvY2tldC5DT05ORUNUSU5HOnJldHVybiJDT05ORUNUSU5HIjtjYXNlIFdlYlNvY2tldC5PUEVOOnJldHVybiJPUEVOIjtjYXNlIFdlYlNvY2tldC5DTE9TSU5HOnJldHVybiJDTE9TSU5HIjtjYXNlIFdlYlNvY2tldC5DTE9TRUQ6cmV0dXJuIkNMT1NFRCI7ZGVmYXVsdDpyZXR1cm4iVU5ERUZJTkVEIn19LGg9ZnVuY3Rpb24oKXt2YXIgbj1hcmd1bWVudHMubGVuZ3RoPjAmJnZvaWQgMCE9PWFyZ3VtZW50c1swXT9hcmd1bWVudHNbMF06IiI7ZS5kZWJ1ZygiWyIrbisiXSBQcmltYXJ5IFdlYlNvY2tldDogIitrKHQucHJpbWFyeSkrIiB8IFNlY29uZGFyeSBXZWJTb2NrZXQ6ICIrayh0LnNlY29uZGFyeSkpfSx2PWZ1bmN0aW9uKGUsbil7cmV0dXJuIGUmJmUucmVhZHlTdGF0ZT09PW59LHc9ZnVuY3Rpb24oZSl7cmV0dXJuIHYoZSxXZWJTb2NrZXQuT1BFTil9LEM9ZnVuY3Rpb24oZSl7cmV0dXJuIG51bGw9PT1lfHx2b2lkIDA9PT1lLnJlYWR5U3RhdGV8fHYoZSxXZWJTb2NrZXQuQ0xPU0VEKX0sVD1mdW5jdGlvbigpe3JldHVybiBudWxsIT09dC5zZWNvbmRhcnk/dC5zZWNvbmRhcnk6dC5wcmltYXJ5fSxPPWZ1bmN0aW9uKCl7cmV0dXJuIHcoVCgpKX0sST1mdW5jdGlvbigpe2lmKGkucGVuZGluZ1Jlc3BvbnNlKXJldHVybiBlLndhcm4oIkhlYXJ0YmVhdCByZXNwb25zZSBub3QgcmVjZWl2ZWQiKSxjbGVhckludGVydmFsKGkuaW50ZXJ2YWxIYW5kbGUpLGkucGVuZGluZ1Jlc3BvbnNlPSExLHZvaWQgRygpO08oKT8oZS5kZWJ1ZygiU2VuZGluZyBoZWFydGJlYXQiKSxUKCkuc2VuZChQKGQpKSxpLnBlbmRpbmdSZXNwb25zZT0hMCk6KGUud2FybigiRmFpbGVkIHRvIHNlbmQgaGVhcnRiZWF0IHNpbmNlIFdlYlNvY2tldCBpcyBub3Qgb3BlbiIpLGgoInNlbmRIZWFydEJlYXQiKSxHKCkpfSxXPWZ1bmN0aW9uKCl7by5leHBvbmVudGlhbEJhY2tPZmZUaW1lPTFlMyxpLnBlbmRpbmdSZXNwb25zZT0hMSxvLnJlY29ubmVjdFdlYlNvY2tldD0hMCxjbGVhclRpbWVvdXQoby5saWZlVGltZVRpbWVvdXRIYW5kbGUpLGNsZWFySW50ZXJ2YWwoaS5pbnRlcnZhbEhhbmRsZSksY2xlYXJUaW1lb3V0KG8uZXhwb25lbnRpYWxUaW1lb3V0SGFuZGxlKSxjbGVhclRpbWVvdXQoby53ZWJTb2NrZXRJbml0Q2hlY2tlclRpbWVvdXRJZCl9LE49ZnVuY3Rpb24oKXtsLmNvbnNlY3V0aXZlRmFpbGVkU3Vic2NyaWJlQXR0ZW1wdHM9MCxsLmNvbnNlY3V0aXZlTm9SZXNwb25zZVJlcXVlc3Q9MCxjbGVhckludGVydmFsKGwucmVzcG9uc2VDaGVja0ludGVydmFsSWQpLGNsZWFySW50ZXJ2YWwobC5yZVN1YnNjcmliZUludGVydmFsSWQpfSxFPWZ1bmN0aW9uKCl7ci5jb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudD0wLHIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU9bnVsbCxyLm5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wPW51bGx9LEw9ZnVuY3Rpb24oKXt0cnl7ZS5pbmZvKCJXZWJTb2NrZXQgY29ubmVjdGlvbiBlc3RhYmxpc2hlZCEiKSxoKCJ3ZWJTb2NrZXRPbk9wZW4iKSxudWxsIT09by5jb25uU3RhdGUmJm8uY29ublN0YXRlIT09Z3x8UyhjLmNvbm5lY3Rpb25HYWluKSxvLmNvbm5TdGF0ZT1iO3ZhciBuPURhdGUubm93KCk7UyhjLmNvbm5lY3Rpb25PcGVuLHtjb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudDpyLmNvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50LGNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lOnIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWUsbm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA6ci5ub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcCxjb25uZWN0aW9uRXN0YWJsaXNoZWRUaW1lOm4sdGltZVRvQ29ubmVjdDpuLXIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWUsdGltZVdpdGhvdXRDb25uZWN0aW9uOnIubm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA/bi1yLm5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wOm51bGx9KSxFKCksVygpLFQoKS5vcGVuVGltZXN0YW1wPURhdGUubm93KCksMD09PXUuc3Vic2NyaWJlZC5zaXplJiZ3KHQuc2Vjb25kYXJ5KSYmaih0LnByaW1hcnksIltQcmltYXJ5IFdlYlNvY2tldF0gQ2xvc2luZyBXZWJTb2NrZXQiKSwodS5zdWJzY3JpYmVkLnNpemU+MHx8dS5wZW5kaW5nLnNpemU+MCkmJih3KHQuc2Vjb25kYXJ5KSYmZS5pbmZvKCJTdWJzY3JpYmluZyBzZWNvbmRhcnkgd2Vic29ja2V0IHRvIHRvcGljcyBvZiBwcmltYXJ5IHdlYnNvY2tldCIpLHUuc3Vic2NyaWJlZC5mb3JFYWNoKGZ1bmN0aW9uKGUpe3Uuc3Vic2NyaXB0aW9uSGlzdG9yeS5hZGQoZSksdS5wZW5kaW5nLmFkZChlKX0pLHUuc3Vic2NyaWJlZC5jbGVhcigpLFIoKSksSSgpLGkuaW50ZXJ2YWxIYW5kbGU9c2V0SW50ZXJ2YWwoSSwxZTQpO3ZhciBsPU1hdGgubWluKHMuYWRkSml0dGVyKDNlNiwuMSksMWUzKmEuY29ubkNvbmZpZy53ZWJTb2NrZXRUcmFuc3BvcnQudHJhbnNwb3J0TGlmZVRpbWVJblNlY29uZHMpO2UuZGVidWcoIlNjaGVkdWxpbmcgV2ViU29ja2V0IG1hbmFnZXIgcmVjb25uZWN0aW9uLCBhZnRlciBkZWxheSAiK2wrIiBtcyIpLG8ubGlmZVRpbWVUaW1lb3V0SGFuZGxlPXNldFRpbWVvdXQoZnVuY3Rpb24oKXtlLmRlYnVnKCJTdGFydGluZyBzY2hlZHVsZWQgV2ViU29ja2V0IG1hbmFnZXIgcmVjb25uZWN0aW9uIiksRygpfSxsKX1jYXRjaChuKXtlLmVycm9yKCJFcnJvciBhZnRlciBlc3RhYmxpc2hpbmcgV2ViU29ja2V0IGNvbm5lY3Rpb24iLG4pfX0sRj1mdW5jdGlvbihuKXtoKCJ3ZWJTb2NrZXRPbkVycm9yIiksZS5lcnJvcigiV2ViU29ja2V0TWFuYWdlciBFcnJvciwgZXJyb3JfZXZlbnQ6ICIsSlNPTi5zdHJpbmdpZnkobikpLEcoKX0seD1mdW5jdGlvbihuKXt2YXIgbz1KU09OLnBhcnNlKG4uZGF0YSk7c3dpdGNoKG8udG9waWMpe2Nhc2UgZjppZihlLmRlYnVnKCJTdWJzY3JpcHRpb24gTWVzc2FnZSByZWNlaXZlZCBmcm9tIHdlYlNvY2tldCBzZXJ2ZXIiLG4uZGF0YSksbC5yZXF1ZXN0Q29tcGxldGVkPSEwLGwuY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdD0wLCJzdWNjZXNzIj09PW8uY29udGVudC5zdGF0dXMpbC5jb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzPTAsby5jb250ZW50LnRvcGljcy5mb3JFYWNoKGZ1bmN0aW9uKGUpe3Uuc3Vic2NyaXB0aW9uSGlzdG9yeS5kZWxldGUoZSksdS5wZW5kaW5nLmRlbGV0ZShlKSx1LnN1YnNjcmliZWQuYWRkKGUpfSksMD09PXUuc3Vic2NyaXB0aW9uSGlzdG9yeS5zaXplP3codC5zZWNvbmRhcnkpJiYoZS5pbmZvKCJTdWNjZXNzZnVsbHkgc3Vic2NyaWJlZCBzZWNvbmRhcnkgd2Vic29ja2V0IHRvIGFsbCB0b3BpY3Mgb2YgcHJpbWFyeSB3ZWJzb2NrZXQiKSxqKHQucHJpbWFyeSwiW1ByaW1hcnkgV2ViU29ja2V0XSBDbG9zaW5nIFdlYlNvY2tldCIpKTpSKCksUyhjLnN1YnNjcmlwdGlvblVwZGF0ZSxvKTtlbHNle2lmKGNsZWFySW50ZXJ2YWwobC5yZVN1YnNjcmliZUludGVydmFsSWQpLCsrbC5jb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzLDU9PT1sLmNvbnNlY3V0aXZlRmFpbGVkU3Vic2NyaWJlQXR0ZW1wdHMpcmV0dXJuIFMoYy5zdWJzY3JpcHRpb25GYWlsdXJlLG8pLHZvaWQobC5jb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzPTApO2wucmVTdWJzY3JpYmVJbnRlcnZhbElkPXNldEludGVydmFsKGZ1bmN0aW9uKCl7UigpfSw1MDApfWJyZWFrO2Nhc2UgZDplLmRlYnVnKCJIZWFydGJlYXQgcmVzcG9uc2UgcmVjZWl2ZWQiKSxpLnBlbmRpbmdSZXNwb25zZT0hMTticmVhaztkZWZhdWx0OmlmKG8udG9waWMpe2lmKGUuZGVidWcoIk1lc3NhZ2UgcmVjZWl2ZWQgZm9yIHRvcGljICIrby50b3BpYyksdyh0LnByaW1hcnkpJiZ3KHQuc2Vjb25kYXJ5KSYmMD09PXUuc3Vic2NyaXB0aW9uSGlzdG9yeS5zaXplJiZ0aGlzPT09dC5wcmltYXJ5KXJldHVybiB2b2lkIGUud2FybigiSWdub3JpbmcgTWVzc2FnZSBmb3IgVG9waWMgIitvLnRvcGljKyIsIHRvIGF2b2lkIGR1cGxpY2F0ZXMiKTtpZigwPT09Yy5hbGxNZXNzYWdlLnNpemUmJjA9PT1jLnRvcGljLnNpemUpcmV0dXJuIHZvaWQgZS53YXJuKCJObyByZWdpc3RlcmVkIGNhbGxiYWNrIGxpc3RlbmVyIGZvciBUb3BpYyIsby50b3BpYyk7UyhjLmFsbE1lc3NhZ2UsbyksYy50b3BpYy5oYXMoby50b3BpYykmJlMoYy50b3BpYy5nZXQoby50b3BpYyksbyl9ZWxzZSBvLm1lc3NhZ2U/ZS53YXJuKCJXZWJTb2NrZXRNYW5hZ2VyIE1lc3NhZ2UgRXJyb3IiLG8pOmUud2FybigiSW52YWxpZCBpbmNvbWluZyBtZXNzYWdlIixvKX19LFI9ZnVuY3Rpb24gbigpe2lmKGwuY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdD4zKXJldHVybiBlLndhcm4oIklnbm9yaW5nIHN1YnNjcmliZVBlbmRpbmdUb3BpY3Mgc2luY2Ugd2UgaGF2ZSBleGhhdXN0ZWQgbWF4IHN1YnNjcmlwdGlvbiByZXRyaWVzIHdpdGggbm8gcmVzcG9uc2UiKSx2b2lkIFMoYy5zdWJzY3JpcHRpb25GYWlsdXJlLHMuZ2V0U3Vic2NyaXB0aW9uUmVzcG9uc2UoZiwhMSxBcnJheS5mcm9tKHUucGVuZGluZykpKTtPKCk/KGNsZWFySW50ZXJ2YWwobC5yZXNwb25zZUNoZWNrSW50ZXJ2YWxJZCksVCgpLnNlbmQoUChmLHt0b3BpY3M6QXJyYXkuZnJvbSh1LnBlbmRpbmcpfSkpLGwucmVxdWVzdENvbXBsZXRlZD0hMSxsLnJlc3BvbnNlQ2hlY2tJbnRlcnZhbElkPXNldEludGVydmFsKGZ1bmN0aW9uKCl7bC5yZXF1ZXN0Q29tcGxldGVkfHwoKytsLmNvbnNlY3V0aXZlTm9SZXNwb25zZVJlcXVlc3QsbigpKX0sMWUzKSk6ZS53YXJuKCJJZ25vcmluZyBzdWJzY3JpYmVQZW5kaW5nVG9waWNzIGNhbGwgc2luY2UgRGVmYXVsdCBXZWJTb2NrZXQgaXMgbm90IG9wZW4iKX0saj1mdW5jdGlvbihuLHQpe3YobixXZWJTb2NrZXQuQ09OTkVDVElORyl8fHYobixXZWJTb2NrZXQuT1BFTik/bi5jbG9zZSgxZTMsdCk6ZS53YXJuKCJJZ25vcmluZyBXZWJTb2NrZXQgQ2xvc2UgcmVxdWVzdCwgV2ViU29ja2V0IFN0YXRlOiAiK2sobikpfSxNPWZ1bmN0aW9uKGUpe2oodC5wcmltYXJ5LCJbUHJpbWFyeV0gV2ViU29ja2V0ICIrZSksaih0LnNlY29uZGFyeSwiW1NlY29uZGFyeV0gV2ViU29ja2V0ICIrZSl9LEE9ZnVuY3Rpb24oKXtyLmNvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50Kys7dmFyIG49cy5hZGRKaXR0ZXIoby5leHBvbmVudGlhbEJhY2tPZmZUaW1lLC4zKTtEYXRlLm5vdygpK248PWEuY29ubkNvbmZpZy51cmxDb25uVmFsaWRUaW1lPyhlLmRlYnVnKCJTY2hlZHVsaW5nIFdlYlNvY2tldCByZWluaXRpYWxpemF0aW9uLCBhZnRlciBkZWxheSAiK24rIiBtcyIpLG8uZXhwb25lbnRpYWxUaW1lb3V0SGFuZGxlPXNldFRpbWVvdXQoZnVuY3Rpb24oKXtyZXR1cm4geigpfSxuKSxvLmV4cG9uZW50aWFsQmFja09mZlRpbWUqPTIpOihlLndhcm4oIldlYlNvY2tldCBVUkwgY2Fubm90IGJlIHVzZWQgdG8gZXN0YWJsaXNoIGNvbm5lY3Rpb24iKSxHKCkpfSxEPWZ1bmN0aW9uKG4pe1coKSxOKCksZS5lcnJvcigiV2ViU29ja2V0IEluaXRpYWxpemF0aW9uIGZhaWxlZCIpLG8ud2Vic29ja2V0SW5pdEZhaWxlZD0hMCxNKCJUZXJtaW5hdGluZyBXZWJTb2NrZXQgTWFuYWdlciIpLGNsZWFySW50ZXJ2YWwoeSksUyhjLmluaXRGYWlsdXJlLHtjb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudDpyLmNvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50LGNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lOnIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWUscmVhc29uOm59KSxFKCl9LFA9ZnVuY3Rpb24oZSxuKXtyZXR1cm4gSlNPTi5zdHJpbmdpZnkoe3RvcGljOmUsY29udGVudDpufSl9LEg9ZnVuY3Rpb24obil7cmV0dXJuISEocy5pc09iamVjdChuKSYmcy5pc09iamVjdChuLndlYlNvY2tldFRyYW5zcG9ydCkmJnMuaXNOb25FbXB0eVN0cmluZyhuLndlYlNvY2tldFRyYW5zcG9ydC51cmwpJiZzLnZhbGlkV1NVcmwobi53ZWJTb2NrZXRUcmFuc3BvcnQudXJsKSYmMWUzKm4ud2ViU29ja2V0VHJhbnNwb3J0LnRyYW5zcG9ydExpZmVUaW1lSW5TZWNvbmRzPj0zZTUpfHwoZS5lcnJvcigiSW52YWxpZCBXZWJTb2NrZXQgQ29ubmVjdGlvbiBDb25maWd1cmF0aW9uIixuKSwhMSl9LEc9ZnVuY3Rpb24oKXtpZihzLmlzTmV0d29ya09ubGluZSgpKWlmKG8ud2Vic29ja2V0SW5pdEZhaWxlZCllLmRlYnVnKCJXZWJTb2NrZXQgSW5pdCBoYWQgZmFpbGVkLCBpZ25vcmluZyB0aGlzIGdldFdlYlNvY2tldENvbm5Db25maWcgcmVxdWVzdCIpO2Vsc2V7aWYoYS5wcm9taXNlQ29tcGxldGVkKXJldHVybiBXKCksZS5pbmZvKCJGZXRjaGluZyBuZXcgV2ViU29ja2V0IGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbiIpLHIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU9ci5jb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZXx8RGF0ZS5ub3coKSxhLnByb21pc2VDb21wbGV0ZWQ9ITEsYS5wcm9taXNlSGFuZGxlPWMuZ2V0V2ViU29ja2V0VHJhbnNwb3J0KCksYS5wcm9taXNlSGFuZGxlLnRoZW4oZnVuY3Rpb24obil7cmV0dXJuIGEucHJvbWlzZUNvbXBsZXRlZD0hMCxlLmRlYnVnKCJTdWNjZXNzZnVsbHkgZmV0Y2hlZCB3ZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uIixuKSxIKG4pPyhhLmNvbm5Db25maWc9bixhLmNvbm5Db25maWcudXJsQ29ublZhbGlkVGltZT1EYXRlLm5vdygpKzg1ZTMseigpKTooRCgiSW52YWxpZCBXZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uOiAiK24pLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfSl9LGZ1bmN0aW9uKG4pe3JldHVybiBhLnByb21pc2VDb21wbGV0ZWQ9ITAsZS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIHdlYlNvY2tldCBjb25uZWN0aW9uIGNvbmZpZ3VyYXRpb24iLG4pLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfX0pO2UuZGVidWcoIlRoZXJlIGlzIGFuIG9uZ29pbmcgZ2V0V2ViU29ja2V0Q29ubkNvbmZpZyByZXF1ZXN0LCB0aGlzIHJlcXVlc3Qgd2lsbCBiZSBpZ25vcmVkIil9ZWxzZSBlLmluZm8oIk5ldHdvcmsgb2ZmbGluZSwgaWdub3JpbmcgdGhpcyBnZXRXZWJTb2NrZXRDb25uQ29uZmlnIHJlcXVlc3QiKX0sej1mdW5jdGlvbigpe2lmKG8ud2Vic29ja2V0SW5pdEZhaWxlZClyZXR1cm4gZS5pbmZvKCJ3ZWItc29ja2V0IGluaXRpYWxpemluZyBoYWQgZmFpbGVkLCBhYm9ydGluZyByZS1pbml0Iikse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITB9O2lmKCFzLmlzTmV0d29ya09ubGluZSgpKXJldHVybiBlLndhcm4oIlN5c3RlbSBpcyBvZmZsaW5lIGFib3J0aW5nIHdlYi1zb2NrZXQgaW5pdCIpLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfTtlLmluZm8oIkluaXRpYWxpemluZyBXZWJzb2NrZXQgTWFuYWdlciIpLGgoImluaXRXZWJTb2NrZXQiKTt0cnl7aWYoSChhLmNvbm5Db25maWcpKXt2YXIgbj1udWxsO3JldHVybiB3KHQucHJpbWFyeSk/KGUuZGVidWcoIlByaW1hcnkgU29ja2V0IGNvbm5lY3Rpb24gaXMgYWxyZWFkeSBvcGVuIiksdih0LnNlY29uZGFyeSxXZWJTb2NrZXQuQ09OTkVDVElORyl8fChlLmRlYnVnKCJFc3RhYmxpc2hpbmcgYSBzZWNvbmRhcnkgd2ViLXNvY2tldCBjb25uZWN0aW9uIiksdC5zZWNvbmRhcnk9VSgpKSxuPXQuc2Vjb25kYXJ5KToodih0LnByaW1hcnksV2ViU29ja2V0LkNPTk5FQ1RJTkcpfHwoZS5kZWJ1ZygiRXN0YWJsaXNoaW5nIGEgcHJpbWFyeSB3ZWItc29ja2V0IGNvbm5lY3Rpb24iKSx0LnByaW1hcnk9VSgpKSxuPXQucHJpbWFyeSksby53ZWJTb2NrZXRJbml0Q2hlY2tlclRpbWVvdXRJZD1zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7dyhuKXx8QSgpfSwxZTMpLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiExfX19Y2F0Y2gobil7cmV0dXJuIGUuZXJyb3IoIkVycm9yIEluaXRpYWxpemluZyB3ZWItc29ja2V0LW1hbmFnZXIiLG4pLEQoIkZhaWxlZCB0byBpbml0aWFsaXplIG5ldyBXZWJTb2NrZXQ6ICIrbi5tZXNzYWdlKSx7d2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZDohMH19fSxVPWZ1bmN0aW9uKCl7dmFyIG49bmV3IFdlYlNvY2tldChhLmNvbm5Db25maWcud2ViU29ja2V0VHJhbnNwb3J0LnVybCk7cmV0dXJuIG4uYWRkRXZlbnRMaXN0ZW5lcigib3BlbiIsTCksbi5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIix4KSxuLmFkZEV2ZW50TGlzdGVuZXIoImVycm9yIixGKSxuLmFkZEV2ZW50TGlzdGVuZXIoImNsb3NlIixmdW5jdGlvbihpKXtyZXR1cm4gZnVuY3Rpb24obixpKXtlLmluZm8oIlNvY2tldCBjb25uZWN0aW9uIGlzIGNsb3NlZCIsbiksaCgid2ViU29ja2V0T25DbG9zZSBiZWZvcmUtY2xlYW51cCIpLFMoYy5jb25uZWN0aW9uQ2xvc2Use29wZW5UaW1lc3RhbXA6aS5vcGVuVGltZXN0YW1wLGNsb3NlVGltZXN0YW1wOkRhdGUubm93KCksY29ubmVjdGlvbkR1cmF0aW9uOkRhdGUubm93KCktaS5vcGVuVGltZXN0YW1wLGNvZGU6bi5jb2RlLHJlYXNvbjpuLnJlYXNvbn0pLEModC5wcmltYXJ5KSYmKHQucHJpbWFyeT1udWxsKSxDKHQuc2Vjb25kYXJ5KSYmKHQuc2Vjb25kYXJ5PW51bGwpLG8ucmVjb25uZWN0V2ViU29ja2V0JiYodyh0LnByaW1hcnkpfHx3KHQuc2Vjb25kYXJ5KT9DKHQucHJpbWFyeSkmJncodC5zZWNvbmRhcnkpJiYoZS5pbmZvKCJbUHJpbWFyeV0gV2ViU29ja2V0IENsZWFubHkgQ2xvc2VkIiksdC5wcmltYXJ5PXQuc2Vjb25kYXJ5LHQuc2Vjb25kYXJ5PW51bGwpOihlLndhcm4oIk5laXRoZXIgcHJpbWFyeSB3ZWJzb2NrZXQgYW5kIG5vciBzZWNvbmRhcnkgd2Vic29ja2V0IGhhdmUgb3BlbiBjb25uZWN0aW9ucywgYXR0ZW1wdGluZyB0byByZS1lc3RhYmxpc2ggY29ubmVjdGlvbiIpLG8uY29ublN0YXRlPT09Zz9lLmluZm8oIklnbm9yaW5nIGNvbm5lY3Rpb25Mb3N0IGNhbGxiYWNrIGludm9jYXRpb24iKTooUyhjLmNvbm5lY3Rpb25Mb3N0LHtvcGVuVGltZXN0YW1wOmkub3BlblRpbWVzdGFtcCxjbG9zZVRpbWVzdGFtcDpEYXRlLm5vdygpLGNvbm5lY3Rpb25EdXJhdGlvbjpEYXRlLm5vdygpLWkub3BlblRpbWVzdGFtcCxjb2RlOm4uY29kZSxyZWFzb246bi5yZWFzb259KSxyLm5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wPURhdGUubm93KCkpLG8uY29ublN0YXRlPWcsRygpKSxoKCJ3ZWJTb2NrZXRPbkNsb3NlIGFmdGVyLWNsZWFudXAiKSl9KGksbil9KSxufTt0aGlzLmluaXQ9ZnVuY3Rpb24obil7aWYocy5hc3NlcnRUcnVlKHMuaXNGdW5jdGlvbihuKSwidHJhbnNwb3J0SGFuZGxlIG11c3QgYmUgYSBmdW5jdGlvbiIpLG51bGw9PT1jLmdldFdlYlNvY2tldFRyYW5zcG9ydClyZXR1cm4gYy5nZXRXZWJTb2NrZXRUcmFuc3BvcnQ9bixHKCk7ZS53YXJuKCJXZWIgU29ja2V0IE1hbmFnZXIgd2FzIGFscmVhZHkgaW5pdGlhbGl6ZWQiKX0sdGhpcy5vbkluaXRGYWlsdXJlPWZ1bmN0aW9uKGUpe3JldHVybiBzLmFzc2VydFRydWUocy5pc0Z1bmN0aW9uKGUpLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmluaXRGYWlsdXJlLmFkZChlKSxvLndlYnNvY2tldEluaXRGYWlsZWQmJmUoKSxmdW5jdGlvbigpe3JldHVybiBjLmluaXRGYWlsdXJlLmRlbGV0ZShlKX19LHRoaXMub25Db25uZWN0aW9uT3Blbj1mdW5jdGlvbihlKXtyZXR1cm4gcy5hc3NlcnRUcnVlKHMuaXNGdW5jdGlvbihlKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5jb25uZWN0aW9uT3Blbi5hZGQoZSksZnVuY3Rpb24oKXtyZXR1cm4gYy5jb25uZWN0aW9uT3Blbi5kZWxldGUoZSl9fSx0aGlzLm9uQ29ubmVjdGlvbkNsb3NlPWZ1bmN0aW9uKGUpe3JldHVybiBzLmFzc2VydFRydWUocy5pc0Z1bmN0aW9uKGUpLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmNvbm5lY3Rpb25DbG9zZS5hZGQoZSksZnVuY3Rpb24oKXtyZXR1cm4gYy5jb25uZWN0aW9uQ2xvc2UuZGVsZXRlKGUpfX0sdGhpcy5vbkNvbm5lY3Rpb25HYWluPWZ1bmN0aW9uKGUpe3JldHVybiBzLmFzc2VydFRydWUocy5pc0Z1bmN0aW9uKGUpLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmNvbm5lY3Rpb25HYWluLmFkZChlKSxPKCkmJmUoKSxmdW5jdGlvbigpe3JldHVybiBjLmNvbm5lY3Rpb25HYWluLmRlbGV0ZShlKX19LHRoaXMub25Db25uZWN0aW9uTG9zdD1mdW5jdGlvbihlKXtyZXR1cm4gcy5hc3NlcnRUcnVlKHMuaXNGdW5jdGlvbihlKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5jb25uZWN0aW9uTG9zdC5hZGQoZSksby5jb25uU3RhdGU9PT1nJiZlKCksZnVuY3Rpb24oKXtyZXR1cm4gYy5jb25uZWN0aW9uTG9zdC5kZWxldGUoZSl9fSx0aGlzLm9uU3Vic2NyaXB0aW9uVXBkYXRlPWZ1bmN0aW9uKGUpe3JldHVybiBzLmFzc2VydFRydWUocy5pc0Z1bmN0aW9uKGUpLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLnN1YnNjcmlwdGlvblVwZGF0ZS5hZGQoZSksZnVuY3Rpb24oKXtyZXR1cm4gYy5zdWJzY3JpcHRpb25VcGRhdGUuZGVsZXRlKGUpfX0sdGhpcy5vblN1YnNjcmlwdGlvbkZhaWx1cmU9ZnVuY3Rpb24oZSl7cmV0dXJuIHMuYXNzZXJ0VHJ1ZShzLmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuc3Vic2NyaXB0aW9uRmFpbHVyZS5hZGQoZSksZnVuY3Rpb24oKXtyZXR1cm4gYy5zdWJzY3JpcHRpb25GYWlsdXJlLmRlbGV0ZShlKX19LHRoaXMub25NZXNzYWdlPWZ1bmN0aW9uKGUsbil7cmV0dXJuIHMuYXNzZXJ0Tm90TnVsbChlLCJ0b3BpY05hbWUiKSxzLmFzc2VydFRydWUocy5pc0Z1bmN0aW9uKG4pLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLnRvcGljLmhhcyhlKT9jLnRvcGljLmdldChlKS5hZGQobik6Yy50b3BpYy5zZXQoZSxuZXcgU2V0KFtuXSkpLGZ1bmN0aW9uKCl7cmV0dXJuIGMudG9waWMuZ2V0KGUpLmRlbGV0ZShuKX19LHRoaXMub25BbGxNZXNzYWdlPWZ1bmN0aW9uKGUpe3JldHVybiBzLmFzc2VydFRydWUocy5pc0Z1bmN0aW9uKGUpLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmFsbE1lc3NhZ2UuYWRkKGUpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuYWxsTWVzc2FnZS5kZWxldGUoZSl9fSx0aGlzLnN1YnNjcmliZVRvcGljcz1mdW5jdGlvbihlKXtzLmFzc2VydE5vdE51bGwoZSwidG9waWNzIikscy5hc3NlcnRJc0xpc3QoZSksZS5mb3JFYWNoKGZ1bmN0aW9uKGUpe3Uuc3Vic2NyaWJlZC5oYXMoZSl8fHUucGVuZGluZy5hZGQoZSl9KSxsLmNvbnNlY3V0aXZlTm9SZXNwb25zZVJlcXVlc3Q9MCxSKCl9LHRoaXMuc2VuZE1lc3NhZ2U9ZnVuY3Rpb24obil7aWYocy5hc3NlcnRJc09iamVjdChuLCJwYXlsb2FkIiksdm9pZCAwPT09bi50b3BpY3x8bS5oYXMobi50b3BpYykpZS53YXJuKCJDYW5ub3Qgc2VuZCBtZXNzYWdlLCBJbnZhbGlkIHRvcGljIixuKTtlbHNle3RyeXtuPUpTT04uc3RyaW5naWZ5KG4pfWNhdGNoKHQpe3JldHVybiB2b2lkIGUud2FybigiRXJyb3Igc3RyaW5naWZ5IG1lc3NhZ2UiLG4pfU8oKT9UKCkuc2VuZChuKTplLndhcm4oIkNhbm5vdCBzZW5kIG1lc3NhZ2UsIHdlYiBzb2NrZXQgY29ubmVjdGlvbiBpcyBub3Qgb3BlbiIpfX0sdGhpcy5jbG9zZVdlYlNvY2tldD1mdW5jdGlvbigpe1coKSxOKCksby5yZWNvbm5lY3RXZWJTb2NrZXQ9ITEsY2xlYXJJbnRlcnZhbCh5KSxNKCJVc2VyIHJlcXVlc3QgdG8gY2xvc2UgV2ViU29ja2V0Iil9LHRoaXMudGVybWluYXRlV2ViU29ja2V0TWFuYWdlcj1EfSxMPXtjcmVhdGU6ZnVuY3Rpb24oKXtyZXR1cm4gbmV3IEV9LHNldEdsb2JhbENvbmZpZzpmdW5jdGlvbihlKXt2YXIgbj1lLmxvZ2dlckNvbmZpZztfLnVwZGF0ZUxvZ2dlckNvbmZpZyhuKX0sTG9nTGV2ZWw6VCxMb2dnZXI6Q319LGZ1bmN0aW9uKGUsbix0KXt2YXIgbzshZnVuY3Rpb24oKXsidXNlIHN0cmljdCI7dmFyIHI9e25vdF9zdHJpbmc6L1tec10vLG5vdF9ib29sOi9bXnRdLyxub3RfdHlwZTovW15UXS8sbm90X3ByaW1pdGl2ZTovW152XS8sbnVtYmVyOi9bZGllZmddLyxudW1lcmljX2FyZzovW2JjZGllZmd1eFhdLyxqc29uOi9bal0vLG5vdF9qc29uOi9bXmpdLyx0ZXh0Oi9eW15ceDI1XSsvLG1vZHVsbzovXlx4MjV7Mn0vLHBsYWNlaG9sZGVyOi9eXHgyNSg/OihbMS05XVxkKilcJHxcKChbXildKylcKSk/KFwrKT8oMHwnW14kXSk/KC0pPyhcZCspPyg/OlwuKFxkKykpPyhbYi1naWpvc3RUdXZ4WF0pLyxrZXk6L14oW2Etel9dW2Etel9cZF0qKS9pLGtleV9hY2Nlc3M6L15cLihbYS16X11bYS16X1xkXSopL2ksaW5kZXhfYWNjZXNzOi9eXFsoXGQrKVxdLyxzaWduOi9eWystXS99O2Z1bmN0aW9uIGkoZSl7cmV0dXJuIGZ1bmN0aW9uKGUsbil7dmFyIHQsbyxjLHMsYSx1LGwsZixwLGQ9MSxiPWUubGVuZ3RoLGc9IiI7Zm9yKG89MDtvPGI7bysrKWlmKCJzdHJpbmciPT10eXBlb2YgZVtvXSlnKz1lW29dO2Vsc2UgaWYoIm9iamVjdCI9PXR5cGVvZiBlW29dKXtpZigocz1lW29dKS5rZXlzKWZvcih0PW5bZF0sYz0wO2M8cy5rZXlzLmxlbmd0aDtjKyspe2lmKG51bGw9PXQpdGhyb3cgbmV3IEVycm9yKGkoJ1tzcHJpbnRmXSBDYW5ub3QgYWNjZXNzIHByb3BlcnR5ICIlcyIgb2YgdW5kZWZpbmVkIHZhbHVlICIlcyInLHMua2V5c1tjXSxzLmtleXNbYy0xXSkpO3Q9dFtzLmtleXNbY11dfWVsc2UgdD1zLnBhcmFtX25vP25bcy5wYXJhbV9ub106bltkKytdO2lmKHIubm90X3R5cGUudGVzdChzLnR5cGUpJiZyLm5vdF9wcmltaXRpdmUudGVzdChzLnR5cGUpJiZ0IGluc3RhbmNlb2YgRnVuY3Rpb24mJih0PXQoKSksci5udW1lcmljX2FyZy50ZXN0KHMudHlwZSkmJiJudW1iZXIiIT10eXBlb2YgdCYmaXNOYU4odCkpdGhyb3cgbmV3IFR5cGVFcnJvcihpKCJbc3ByaW50Zl0gZXhwZWN0aW5nIG51bWJlciBidXQgZm91bmQgJVQiLHQpKTtzd2l0Y2goci5udW1iZXIudGVzdChzLnR5cGUpJiYoZj10Pj0wKSxzLnR5cGUpe2Nhc2UiYiI6dD1wYXJzZUludCh0LDEwKS50b1N0cmluZygyKTticmVhaztjYXNlImMiOnQ9U3RyaW5nLmZyb21DaGFyQ29kZShwYXJzZUludCh0LDEwKSk7YnJlYWs7Y2FzZSJkIjpjYXNlImkiOnQ9cGFyc2VJbnQodCwxMCk7YnJlYWs7Y2FzZSJqIjp0PUpTT04uc3RyaW5naWZ5KHQsbnVsbCxzLndpZHRoP3BhcnNlSW50KHMud2lkdGgpOjApO2JyZWFrO2Nhc2UiZSI6dD1zLnByZWNpc2lvbj9wYXJzZUZsb2F0KHQpLnRvRXhwb25lbnRpYWwocy5wcmVjaXNpb24pOnBhcnNlRmxvYXQodCkudG9FeHBvbmVudGlhbCgpO2JyZWFrO2Nhc2UiZiI6dD1zLnByZWNpc2lvbj9wYXJzZUZsb2F0KHQpLnRvRml4ZWQocy5wcmVjaXNpb24pOnBhcnNlRmxvYXQodCk7YnJlYWs7Y2FzZSJnIjp0PXMucHJlY2lzaW9uP1N0cmluZyhOdW1iZXIodC50b1ByZWNpc2lvbihzLnByZWNpc2lvbikpKTpwYXJzZUZsb2F0KHQpO2JyZWFrO2Nhc2UibyI6dD0ocGFyc2VJbnQodCwxMCk+Pj4wKS50b1N0cmluZyg4KTticmVhaztjYXNlInMiOnQ9U3RyaW5nKHQpLHQ9cy5wcmVjaXNpb24/dC5zdWJzdHJpbmcoMCxzLnByZWNpc2lvbik6dDticmVhaztjYXNlInQiOnQ9U3RyaW5nKCEhdCksdD1zLnByZWNpc2lvbj90LnN1YnN0cmluZygwLHMucHJlY2lzaW9uKTp0O2JyZWFrO2Nhc2UiVCI6dD1PYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodCkuc2xpY2UoOCwtMSkudG9Mb3dlckNhc2UoKSx0PXMucHJlY2lzaW9uP3Quc3Vic3RyaW5nKDAscy5wcmVjaXNpb24pOnQ7YnJlYWs7Y2FzZSJ1Ijp0PXBhcnNlSW50KHQsMTApPj4+MDticmVhaztjYXNlInYiOnQ9dC52YWx1ZU9mKCksdD1zLnByZWNpc2lvbj90LnN1YnN0cmluZygwLHMucHJlY2lzaW9uKTp0O2JyZWFrO2Nhc2UieCI6dD0ocGFyc2VJbnQodCwxMCk+Pj4wKS50b1N0cmluZygxNik7YnJlYWs7Y2FzZSJYIjp0PShwYXJzZUludCh0LDEwKT4+PjApLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpfXIuanNvbi50ZXN0KHMudHlwZSk/Zys9dDooIXIubnVtYmVyLnRlc3Qocy50eXBlKXx8ZiYmIXMuc2lnbj9wPSIiOihwPWY/IisiOiItIix0PXQudG9TdHJpbmcoKS5yZXBsYWNlKHIuc2lnbiwiIikpLHU9cy5wYWRfY2hhcj8iMCI9PT1zLnBhZF9jaGFyPyIwIjpzLnBhZF9jaGFyLmNoYXJBdCgxKToiICIsbD1zLndpZHRoLShwK3QpLmxlbmd0aCxhPXMud2lkdGgmJmw+MD91LnJlcGVhdChsKToiIixnKz1zLmFsaWduP3ArdCthOiIwIj09PXU/cCthK3Q6YStwK3QpfXJldHVybiBnfShmdW5jdGlvbihlKXtpZihzW2VdKXJldHVybiBzW2VdO3ZhciBuLHQ9ZSxvPVtdLGk9MDtmb3IoO3Q7KXtpZihudWxsIT09KG49ci50ZXh0LmV4ZWModCkpKW8ucHVzaChuWzBdKTtlbHNlIGlmKG51bGwhPT0obj1yLm1vZHVsby5leGVjKHQpKSlvLnB1c2goIiUiKTtlbHNle2lmKG51bGw9PT0obj1yLnBsYWNlaG9sZGVyLmV4ZWModCkpKXRocm93IG5ldyBTeW50YXhFcnJvcigiW3NwcmludGZdIHVuZXhwZWN0ZWQgcGxhY2Vob2xkZXIiKTtpZihuWzJdKXtpfD0xO3ZhciBjPVtdLGE9blsyXSx1PVtdO2lmKG51bGw9PT0odT1yLmtleS5leGVjKGEpKSl0aHJvdyBuZXcgU3ludGF4RXJyb3IoIltzcHJpbnRmXSBmYWlsZWQgdG8gcGFyc2UgbmFtZWQgYXJndW1lbnQga2V5Iik7Zm9yKGMucHVzaCh1WzFdKTsiIiE9PShhPWEuc3Vic3RyaW5nKHVbMF0ubGVuZ3RoKSk7KWlmKG51bGwhPT0odT1yLmtleV9hY2Nlc3MuZXhlYyhhKSkpYy5wdXNoKHVbMV0pO2Vsc2V7aWYobnVsbD09PSh1PXIuaW5kZXhfYWNjZXNzLmV4ZWMoYSkpKXRocm93IG5ldyBTeW50YXhFcnJvcigiW3NwcmludGZdIGZhaWxlZCB0byBwYXJzZSBuYW1lZCBhcmd1bWVudCBrZXkiKTtjLnB1c2godVsxXSl9blsyXT1jfWVsc2UgaXw9MjtpZigzPT09aSl0aHJvdyBuZXcgRXJyb3IoIltzcHJpbnRmXSBtaXhpbmcgcG9zaXRpb25hbCBhbmQgbmFtZWQgcGxhY2Vob2xkZXJzIGlzIG5vdCAoeWV0KSBzdXBwb3J0ZWQiKTtvLnB1c2goe3BsYWNlaG9sZGVyOm5bMF0scGFyYW1fbm86blsxXSxrZXlzOm5bMl0sc2lnbjpuWzNdLHBhZF9jaGFyOm5bNF0sYWxpZ246bls1XSx3aWR0aDpuWzZdLHByZWNpc2lvbjpuWzddLHR5cGU6bls4XX0pfXQ9dC5zdWJzdHJpbmcoblswXS5sZW5ndGgpfXJldHVybiBzW2VdPW99KGUpLGFyZ3VtZW50cyl9ZnVuY3Rpb24gYyhlLG4pe3JldHVybiBpLmFwcGx5KG51bGwsW2VdLmNvbmNhdChufHxbXSkpfXZhciBzPU9iamVjdC5jcmVhdGUobnVsbCk7bi5zcHJpbnRmPWksbi52c3ByaW50Zj1jLCJ1bmRlZmluZWQiIT10eXBlb2Ygd2luZG93JiYod2luZG93LnNwcmludGY9aSx3aW5kb3cudnNwcmludGY9Yyx2b2lkIDA9PT0obz1mdW5jdGlvbigpe3JldHVybntzcHJpbnRmOmksdnNwcmludGY6Y319LmNhbGwobix0LG4sZSkpfHwoZS5leHBvcnRzPW8pKX0oKX0sZnVuY3Rpb24oZSxuLHQpeyJ1c2Ugc3RyaWN0Ijt0LnIobiksZnVuY3Rpb24oZSl7dC5kKG4sIldlYlNvY2tldE1hbmFnZXIiLGZ1bmN0aW9uKCl7cmV0dXJuIHJ9KTt2YXIgbz10KDApO2UuY29ubmVjdD1lLmNvbm5lY3R8fHt9LGNvbm5lY3QuV2ViU29ja2V0TWFuYWdlcj1vLmE7dmFyIHI9by5hfS5jYWxsKHRoaXMsdCgzKSl9LGZ1bmN0aW9uKGUsbil7dmFyIHQ7dD1mdW5jdGlvbigpe3JldHVybiB0aGlzfSgpO3RyeXt0PXR8fG5ldyBGdW5jdGlvbigicmV0dXJuIHRoaXMiKSgpfWNhdGNoKGUpeyJvYmplY3QiPT10eXBlb2Ygd2luZG93JiYodD13aW5kb3cpfWUuZXhwb3J0cz10fV0pOwovLyMgc291cmNlTWFwcGluZ1VSTD1hbWF6b24tY29ubmVjdC13ZWJzb2NrZXQtbWFuYWdlci5qcy5tYXAKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CiAKICBjb25uZWN0LmNvcmUgPSB7fTsKICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSBmYWxzZTsKICBjb25uZWN0LnZlcnNpb24gPSAiMS40LjAiOwogIGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFID0gNTAwOwogCiAgdmFyIENDUF9TWU5fVElNRU9VVCA9IDEwMDA7IC8vIDEgc2VjCiAgdmFyIENDUF9BQ0tfVElNRU9VVCA9IDMwMDA7IC8vIDMgc2VjCiAgdmFyIENDUF9MT0FEX1RJTUVPVVQgPSAzMDAwOyAvLyAzIHNlYwogIHZhciBDQ1BfSUZSQU1FX1JFRlJFU0hfSU5URVJWQUwgPSA1MDAwOyAvLyA1IHNlYwogIHZhciBDQ1BfRFJfSUZSQU1FX1JFRlJFU0hfSU5URVJWQUwgPSAxMDAwMDsgLy8xMCBzCiAKICB2YXIgTE9HSU5fVVJMX1BBVFRFUk4gPSAiaHR0cHM6Ly97YWxpYXN9LmF3c2FwcHMuY29tL2F1dGgvP2NsaWVudF9pZD17Y2xpZW50X2lkfSZyZWRpcmVjdF91cmk9e3JlZGlyZWN0fSI7CiAgdmFyIENMSUVOVF9JRF9NQVAgPSB7CiAgICAidXMtZWFzdC0xIjogIjA2OTE5ZjRmZDhlZDMyNGUiCiAgfTsKIAogIHZhciBBVVRIT1JJWkVfRU5EUE9JTlQgPSAiL2Nvbm5lY3QvYXV0aC9hdXRob3JpemUiOwogIHZhciBBVVRIT1JJWkVfUkVUUllfSU5URVJWQUwgPSAyMDAwOwogIHZhciBBVVRIT1JJWkVfTUFYX1JFVFJZID0gNTsKIAogIHZhciBXSElURUxJU1RFRF9PUklHSU5TX0VORFBPSU5UID0gIi9jb25uZWN0L3doaXRlbGlzdGVkLW9yaWdpbnMiOwogIHZhciBXSElURUxJU1RFRF9PUklHSU5TX1JFVFJZX0lOVEVSVkFMID0gMjAwMDsKICB2YXIgV0hJVEVMSVNURURfT1JJR0lOU19NQVhfUkVUUlkgPSA1OwogCiAgLyoqCiAgICogQGRlcHJlY2F0ZWQKICAgKiBXZSB3aWxsIG5vIGxvbmdlciBuZWVkIHRoaXMgZnVuY3Rpb24gc29vbi4KICAgKi8KICB2YXIgY3JlYXRlTG9naW5VcmwgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICB2YXIgcmVkaXJlY3QgPSAiaHR0cHM6Ly9saWx5LnVzLWVhc3QtMS5hbWF6b25hd3MuY29tL3Rhdy9hdXRoL2NvZGUiOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJlZGlyZWN0KTsKIAogICAgaWYgKHBhcmFtcy5sb2dpblVybCkgewogICAgICByZXR1cm4gcGFyYW1zLmxvZ2luVXJsCiAgICB9IGVsc2UgaWYgKHBhcmFtcy5hbGlhcykgewogICAgICByZXR1cm4gTE9HSU5fVVJMX1BBVFRFUk4KICAgICAgICAucmVwbGFjZSgie2FsaWFzfSIsIHBhcmFtcy5hbGlhcykKICAgICAgICAucmVwbGFjZSgie2NsaWVudF9pZH0iLCBDTElFTlRfSURfTUFQWyJ1cy1lYXN0LTEiXSkKICAgICAgICAucmVwbGFjZSgie3JlZGlyZWN0fSIsIGdsb2JhbC5lbmNvZGVVUklDb21wb25lbnQoCiAgICAgICAgICByZWRpcmVjdCkpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHBhcmFtcy5jY3BVcmw7CiAgICB9CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIFJldHVybnMgc2NoZW1lOi8vaG9zdDpwb3J0IGZvciBhIGdpdmVuIHVybAogICovCiAgZnVuY3Rpb24gc2FuaXRpemVEb21haW4odXJsKSB7CiAgICB2YXIgZG9tYWluID0gdXJsLm1hdGNoKC9eKD86aHR0cHM/OlwvXC8pPyg/OlteQFxuXStAKT8oPzp3d3dcLik/KFteOlwvXG4/XSspL2lnKTsKICAgIHJldHVybiBkb21haW4ubGVuZ3RoID8gZG9tYWluWzBdIDogIiI7CiAgfQogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBQcmludCBhIHdhcm5pbmcgbWVzc2FnZSBpZiB0aGUgQ29ubmVjdCBjb3JlIGlzIG5vdCBpbml0aWFsaXplZC4KICAgICovCiAgY29ubmVjdC5jb3JlLmNoZWNrTm90SW5pdGlhbGl6ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoY29ubmVjdC5jb3JlLmluaXRpYWxpemVkKSB7CiAgICAgIHZhciBsb2cgPSBjb25uZWN0LmdldExvZygpOwogICAgICBsb2cud2FybigiQ29ubmVjdCBjb3JlIGFscmVhZHkgaW5pdGlhbGl6ZWQsIG9ubHkgbmVlZHMgdG8gYmUgaW5pdGlhbGl6ZWQgb25jZS4iKTsKICAgIH0KICB9OwogCiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBESVNBU1RFUiBSRUNPVkVSWSAKICAqLwogIAogIHZhciBtYWtlQWdlbnRPZmZsaW5lID0gZnVuY3Rpb24oYWdlbnQsIGNhbGxiYWNrcykgewogICAgdmFyIG9mZmxpbmVTdGF0ZSA9IGFnZW50LmdldEFnZW50U3RhdGVzKCkuZmluZChmdW5jdGlvbiAoc3RhdGUpIHsKICAgICAgcmV0dXJuIHN0YXRlLnR5cGUgPT09IGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUuT0ZGTElORTsKICAgIH0pOwogICAgYWdlbnQuc2V0U3RhdGUob2ZmbGluZVN0YXRlLCBjYWxsYmFja3MpOyAgIAogIH0KIAogIC8vIFN1cHByZXNzIENvbnRhY3RzIGZ1bmN0aW9uIAogIC8vIFRoaXMgaXMgdXNlZCBieSBEaXNhc3RlciBSZWNvdmVyeSBhcyBhIHNhZmVndWFyZCB0byBub3Qgc3VyZmFjZSBpbmNvbWluZyBjYWxscy9jaGF0cyB0byBVSQogIC8vIAogIHZhciBzdXBwcmVzc0NvbnRhY3RzID0gZnVuY3Rpb24gKGlzU3VwcHJlc3NlZCkgewogICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIFNpZ25hbCBzaGFyZWR3b3JrZXIgdG8gc2V0IGNvbnRhY3RzIHN1cHByZXNzb3IgdG8gJXMgZm9yIGluc3RhbmNlICVzLiIsIAogICAgICBpc1N1cHByZXNzZWQsIGNvbm5lY3QuY29yZS5yZWdpb24KICAgICk7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLlNVUFBSRVNTLCB7CiAgICAgIHN1cHByZXNzOiBpc1N1cHByZXNzZWQKICAgIH0pOwogIH0KIAogIHZhciBzZXRGb3JjZU9mZmxpbmVVcHN0cmVhbSA9IGZ1bmN0aW9uKG9mZmxpbmUpIHsKICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW0RJU0FTVEVSIFJFQ09WRVJZXSBTaWduYWwgc2hhcmVkd29ya2VyIHRvIHNldCBmb3JjZU9mZmxpbmUgdG8gJXMgZm9yIGluc3RhbmNlICVzLiIsIAogICAgICBvZmZsaW5lLCBjb25uZWN0LmNvcmUucmVnaW9uCiAgICApOwogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GT1JDRV9PRkZMSU5FLCB7CiAgICAgIG9mZmxpbmU6IG9mZmxpbmUKICAgIH0pOwogIH0KIAogIC8vIEZvcmNlIHRoZSBpbnN0YW5jZSB0byBiZSBvZmZsaW5lLiAKICAvLyBUaGlzIHRyaWVzIHRvIGRpc2Nvbm5lY3QgYWxsIGNvbnRhY3RzIChIYXJkIHN0b3ApCiAgLy8gaWYgZHVlIHRvIGEgZmFpbHVyZSAodGhlIGJhY2tlbmQgaXMgbm90IHJlYWNoYWJsZSksIHNpZ25hbCB0aGUgc2hhcmVkIHdvcmtlciB0byBmb3JjZV9vZmZsaW5lIHdoZW4gaXQgd2FrZXMgdXAgYWdhaW4KICAvLyBUaGlzIGZ1bmN0aW9uIHNob3VsZCBvbmx5IGJlIHJhbiBmcm9tIG5hdGl2ZSBDQ1AgZm9yIGRpc2Nvbm5lY3RpbmcgY2hhdHMuCiAgdmFyIGZvcmNlT2ZmbGluZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGxvZyA9IGNvbm5lY3QuZ2V0TG9nKCk7CiAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBBdHRlbXB0aW5nIHRvIGZvcmNlIGluc3RhbmNlICVzIG9mZmxpbmUiLCBjb25uZWN0LmNvcmUucmVnaW9uKTsKICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24oYWdlbnQpIHsKICAgICAgdmFyIGNvbnRhY3RDbG9zZWQgPSAwOwogICAgICB2YXIgY29udGFjdHMgPSBhZ2VudC5nZXRDb250YWN0cygpOwogICAgICBpZiAoY29udGFjdHMubGVuZ3RoKSB7CiAgICAgICAgY29udGFjdHMuZm9yRWFjaChmdW5jdGlvbihjb250YWN0KSAKICAgICAgICAgIHsKICAgICAgICAgICAgY29udGFjdC5nZXRBZ2VudENvbm5lY3Rpb24oKS5kZXN0cm95KHsKICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIC8vIGNoZWNrIGlmIGFsbCBhY3RpdmUgY29udGFjdHMgYXJlIGNsb3NlZAogICAgICAgICAgICAgICAgaWYgKCsrY29udGFjdENsb3NlZCA9PT0gY29udGFjdHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHNldEZvcmNlT2ZmbGluZVVwc3RyZWFtKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgLy8gSXQncyBvayBpZiB3ZSdyZSBub3QgYWJsZSB0byBwdXQgdGhlIGFnZW50IG9mZmxpbmUuIAogICAgICAgICAgICAgICAgICAvLyBzaW5jZSB3ZSdyZSBzdXBwcmVzc2luZyB0aGUgYWdlbnRzIGNvbnRhY3RzIGFscmVhZHkuIAogICAgICAgICAgICAgICAgICBtYWtlQWdlbnRPZmZsaW5lKGFnZW50KTsKICAgICAgICAgICAgICAgICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gSW5zdGFuY2UgJXMgaXMgbm93IG9mZmxpbmUiLCBjb25uZWN0LmNvcmUucmVnaW9uKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgICAgbG9nLndhcm4oIltEaXNhc3RlciBSZWNvdmVyeV0gQW4gZXJyb3Igb2NjdXJlZCB3aGlsZSBhdHRlbXB0aW5nIHRvIGZvcmNlIHRoaXMgaW5zdGFuY2UgdG8gb2ZmbGluZSBpbiByZWdpb24gJXMiLCBjb25uZWN0LmNvcmUucmVnaW9uKTsKICAgICAgICAgICAgICAgIGxvZy53YXJuKGVycik7CiAgICAgICAgICAgICAgICAvLyBzaWduYWwgdGhlIHNoYXJlZHdvcmtlciB0byBjYWxsIGZvcmNlT2ZmbGluZSBhZ2FpbiB3aGVuIG5ldHdvcmsgY29ubmVjdGlvbiAKICAgICAgICAgICAgICAgIC8vIGhhcyBiZWVuIHJlLWVzdGFibGlzaGVkICh0aGlzIGhhcHBlbnMgaW4gY2FzZSBvZiBuZXR3b3JrIG9yIGJhY2tlbmQgZmFpbHVyZXMpCiAgICAgICAgICAgICAgICBzZXRGb3JjZU9mZmxpbmVVcHN0cmVhbSh0cnVlKTsKICAgICAgICAgICAgfX0pOwogICAgICAgICAgfQogICAgICAgICkgICAgICAgIAogICAgICB9IGVsc2UgewogICAgICAgIHNldEZvcmNlT2ZmbGluZVVwc3RyZWFtKGZhbHNlKTsKICAgICAgICBtYWtlQWdlbnRPZmZsaW5lKGFnZW50KTsKICAgICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBJbnN0YW5jZSAlcyBpcyBub3cgb2ZmbGluZSIsIGNvbm5lY3QuY29yZS5yZWdpb24pOyAgCiAgICAgIH0KICAgIH0pOwogIH0KIAogIC8vSW5pdGlhdGUgRGlzYXN0ZXIgUmVjb3ZlcnkgKFRoaXMgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIGZyb20gY3VzdG9tQ0NQIHRoYXQgYXJlIERSIGVuYWJsZWQpCiAgY29ubmVjdC5jb3JlLmluaXREaXNhc3RlclJlY292ZXJ5ID0gZnVuY3Rpb24ocGFyYW1zKSB7CiAgICB2YXIgbG9nID0gY29ubmVjdC5nZXRMb2coKTsKICAgIGNvbm5lY3QuY29yZS5yZWdpb24gPSBwYXJhbXMucmVnaW9uOwogICAgY29ubmVjdC5jb3JlLnN1cHByZXNzQ29udGFjdHMgPSBzdXBwcmVzc0NvbnRhY3RzOyAgCiAgICBjb25uZWN0LmNvcmUuZm9yY2VPZmZsaW5lID0gZm9yY2VPZmZsaW5lOwoKICAgIC8vUmVnaXN0ZXIgaWZyYW1lIGxpc3RuZXIgdG8gc2V0IG5hdGl2ZSBDQ1Agb2ZmbGluZQogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25Eb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5TRVRfT0ZGTElORSwgZnVuY3Rpb24oKSB7CiAgICAgIGNvbm5lY3QuY29yZS5mb3JjZU9mZmxpbmUoKTsKICAgIH0pOwogCiAgICAvLyBSZWdpc3RlciBFdmVudCBsaXN0bmVyIHRvIEZvcmNlIHRoZSBBZ2VudCB0byBiZSBvZmZsaW5lIHdoZW4gc2hhcmVkIHdvcmtlciByZWNvdmVycyBmcm9tIG5ldHdvcmsgZmFpbHVyZQogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuRk9SQ0VfT0ZGTElORSwgZnVuY3Rpb24oKSB7CiAgICAgIGNvbm5lY3QuY29yZS5mb3JjZU9mZmxpbmUoKTsKICAgIH0pOwoKICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU09GVFBIT05FLCAKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gSW5pdGlhbGl6aW5nIHJlZ2lvbiAlcyBhcyBwYXJ0IG9mIGEgRGlzYXN0ZXIgUmVjb3ZlcnkgZmxlZXQiLCBjb25uZWN0LmNvcmUucmVnaW9uKTsKICAgICAgfSwgCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldICVzIGFscmVhZHkgcGFydCBvZiBhIERpc2FzdGVyIFJlY292ZXJ5IGZsZWV0IiwgY29ubmVjdC5jb3JlLnJlZ2lvbik7CiAgICAgIH0pOwoKICAgIGlmICghcGFyYW1zLmlzUHJpbWFyeSkgewogICAgICBjb25uZWN0LmNvcmUuc3VwcHJlc3NDb250YWN0cyh0cnVlKTsKICAgICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSgpOwogICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSAlcyBpbnN0YW5jZSBpcyBzZXQgdG8gc3RhbmQtYnkiLCBjb25uZWN0LmNvcmUucmVnaW9uKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbm5lY3QuY29yZS5zdXBwcmVzc0NvbnRhY3RzKGZhbHNlKTsKICAgICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gJXMgaW5zdGFuY2UgaXMgc2V0IHRvIHByaW1hcnkiLCBjb25uZWN0LmNvcmUucmVnaW9uKTsKICAgIH0KICB9CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogQmFzaWMgQ29ubmVjdCBjbGllbnQgaW5pdGlhbGl6YXRpb24uCiAgICogU2hvdWxkIGJlIHVzZWQgb25seSBieSB0aGUgQVBJIFNoYXJlZCBXb3JrZXIuCiAgICovCiAgY29ubmVjdC5jb3JlLmluaXQgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmNvcmUuZXZlbnRCdXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cygpOwogICAgY29ubmVjdC5jb3JlLmFnZW50RGF0YVByb3ZpZGVyID0gbmV3IEFnZW50RGF0YVByb3ZpZGVyKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpKTsKICAgIGNvbm5lY3QuY29yZS5pbml0Q2xpZW50KHBhcmFtcyk7CiAgICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSB0cnVlOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogSW5pdGlhbGl6ZWQgQVdTIGNsaWVudAogICAqIFNob3VsZCBiZSB1c2VkIGJ5IFNoYXJlZCBXb3JrZXIgdG8gdXBkYXRlIEFXUyBjbGllbnQgd2l0aCBuZXcgY3JlZGVudGlhbHMKICAgKiBhZnRlciByZWZyZXNoZWQgYXV0aGVudGljYXRpb24uCiAgICovCiAgY29ubmVjdC5jb3JlLmluaXRDbGllbnQgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAncGFyYW1zJyk7CiAKICAgIHZhciBhdXRoVG9rZW4gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmF1dGhUb2tlbiwgJ3BhcmFtcy5hdXRoVG9rZW4nKTsKICAgIHZhciByZWdpb24gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnJlZ2lvbiwgJ3BhcmFtcy5yZWdpb24nKTsKICAgIHZhciBlbmRwb2ludCA9IHBhcmFtcy5lbmRwb2ludCB8fCBudWxsOwogCiAgICBjb25uZWN0LmNvcmUuY2xpZW50ID0gbmV3IGNvbm5lY3QuQVdTQ2xpZW50KGF1dGhUb2tlbiwgcmVnaW9uLCBlbmRwb2ludCk7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBVbmluaXRpYWxpemUgQ29ubmVjdC4KICAgKi8KICBjb25uZWN0LmNvcmUudGVybWluYXRlID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5jb3JlLmNsaWVudCA9IG5ldyBjb25uZWN0Lk51bGxDbGllbnQoKTsKICAgIGNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQgPSBuZXcgY29ubmVjdC5OdWxsQ2xpZW50KCk7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBpZiAoYnVzKSBidXMudW5zdWJzY3JpYmVBbGwoKTsKICAgIGNvbm5lY3QuY29yZS5idXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cygpOwogICAgY29ubmVjdC5jb3JlLmFnZW50RGF0YVByb3ZpZGVyID0gbnVsbDsKICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyID0gbnVsbDsKICAgIGNvbm5lY3QuY29yZS51cHN0cmVhbSA9IG51bGw7CiAgICBjb25uZWN0LmNvcmUua2VlcGFsaXZlTWFuYWdlciA9IG51bGw7CiAgICBjb25uZWN0LmFnZW50LmluaXRpYWxpemVkID0gZmFsc2U7CiAgICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSBmYWxzZTsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIFNldHVwIHRoZSBTb2Z0cGhvbmVNYW5hZ2VyIHRvIGJlIGluaXRpYWxpemVkIHdoZW4gdGhlIGFnZW50CiAgICogaXMgZGV0ZXJtaW5lZCB0byBoYXZlIHNvZnRwaG9uZSBlbmFibGVkLgogICAqLwogIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0gPSBudWxsOwogCiAgY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuc29mdHBob25lVXNlck1lZGlhU3RyZWFtOwogIH07CiAKICBjb25uZWN0LmNvcmUuc2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtID0gZnVuY3Rpb24gKHN0cmVhbSkgewogICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSA9IHN0cmVhbTsKICB9OwogCiAgY29ubmVjdC5jb3JlLmluaXRSaW5ndG9uZUVuZ2luZXMgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAicGFyYW1zIik7CiAKICAgIHZhciBzZXR1cFJpbmd0b25lRW5naW5lcyA9IGZ1bmN0aW9uIChyaW5ndG9uZVNldHRpbmdzKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChyaW5ndG9uZVNldHRpbmdzLCAicmluZ3RvbmVTZXR0aW5ncyIpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmluZ3RvbmVTZXR0aW5ncy52b2ljZSwgInJpbmd0b25lU2V0dGluZ3Mudm9pY2UiKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKHJpbmd0b25lU2V0dGluZ3Mudm9pY2UucmluZ3RvbmVVcmwgfHwgcmluZ3RvbmVTZXR0aW5ncy52b2ljZS5kaXNhYmxlZCwgInJpbmd0b25lU2V0dGluZ3Mudm9pY2UucmluZ3RvbmVVcmwgbXVzdCBiZSBwcm92aWRlZCBvciByaW5ndG9uZVNldHRpbmdzLnZvaWNlLmRpc2FibGVkIG11c3QgYmUgdHJ1ZSIpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjaywgInJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2siKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2sucmluZ3RvbmVVcmwgfHwgcmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjay5kaXNhYmxlZCwgInJpbmd0b25lU2V0dGluZ3Mudm9pY2UucmluZ3RvbmVVcmwgbXVzdCBiZSBwcm92aWRlZCBvciByaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrLmRpc2FibGVkIG11c3QgYmUgdHJ1ZSIpOwogCiAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMgPSB7fTsKIAogICAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uIChhZ2VudCkgewogICAgICAgIGFnZW50Lm9uUmVmcmVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlJJTkdUT05FLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICghcmluZ3RvbmVTZXR0aW5ncy52b2ljZS5kaXNhYmxlZCAmJiAhY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy52b2ljZSkgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMudm9pY2UgPQogICAgICAgICAgICAgICAgbmV3IGNvbm5lY3QuVm9pY2VSaW5ndG9uZUVuZ2luZShyaW5ndG9uZVNldHRpbmdzLnZvaWNlKTsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlZvaWNlUmluZ3RvbmVFbmdpbmUgaW5pdGlhbGl6ZWQuIik7CiAgICAgICAgICAgIH0KIAogICAgICAgICAgICBpZiAoIXJpbmd0b25lU2V0dGluZ3MuY2hhdC5kaXNhYmxlZCAmJiAhY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5jaGF0KSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5jaGF0ID0KICAgICAgICAgICAgICAgIG5ldyBjb25uZWN0LkNoYXRSaW5ndG9uZUVuZ2luZShyaW5ndG9uZVNldHRpbmdzLmNoYXQpOwogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQ2hhdFJpbmd0b25lRW5naW5lIGluaXRpYWxpemVkLiIpOwogICAgICAgICAgICB9CiAKICAgICAgICAgICAgaWYgKCFyaW5ndG9uZVNldHRpbmdzLnRhc2suZGlzYWJsZWQgJiYgIWNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMudGFzaykgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMudGFzayA9CiAgICAgICAgICAgICAgICBuZXcgY29ubmVjdC5UYXNrUmluZ3RvbmVFbmdpbmUocmluZ3RvbmVTZXR0aW5ncy50YXNrKTsKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiVGFza1Jpbmd0b25lRW5naW5lIGluaXRpYWxpemVkLiIpOwogICAgICAgICAgICB9CiAKICAgICAgICAgICAgaWYgKCFyaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrLmRpc2FibGVkICYmICFjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnF1ZXVlX2NhbGxiYWNrKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5xdWV1ZV9jYWxsYmFjayA9CiAgICAgICAgICAgICAgICBuZXcgY29ubmVjdC5RdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUocmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjayk7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUgaW5pdGlhbGl6ZWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH07CiAKICAgIHZhciBtZXJnZVBhcmFtcyA9IGZ1bmN0aW9uIChwYXJhbXMsIG90aGVyUGFyYW1zKSB7CiAgICAgIC8vIEZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eTogc3VwcG9ydCBwdWxsaW5nIGRpc2FibGVkIGZsYWcgYW5kIHJpbmd0b25lVXJsCiAgICAgIC8vIGZyb20gc29mdHBob25lIGNvbmZpZyBpZiBpdCBleGlzdHMgZnJvbSBkb3duc3RyZWFtIGludG8gdGhlIHJpbmd0b25lIGNvbmZpZy4KICAgICAgcGFyYW1zLnJpbmd0b25lID0gcGFyYW1zLnJpbmd0b25lIHx8IHt9OwogICAgICBwYXJhbXMucmluZ3RvbmUudm9pY2UgPSBwYXJhbXMucmluZ3RvbmUudm9pY2UgfHwge307CiAgICAgIHBhcmFtcy5yaW5ndG9uZS5xdWV1ZV9jYWxsYmFjayA9IHBhcmFtcy5yaW5ndG9uZS5xdWV1ZV9jYWxsYmFjayB8fCB7fTsKICAgICAgcGFyYW1zLnJpbmd0b25lLmNoYXQgPSBwYXJhbXMucmluZ3RvbmUuY2hhdCB8fCB7IGRpc2FibGVkOiB0cnVlIH07CiAgICAgIHBhcmFtcy5yaW5ndG9uZS50YXNrID0gcGFyYW1zLnJpbmd0b25lLnRhc2sgfHwgeyBkaXNhYmxlZDogdHJ1ZSB9OwogCiAgICAgIGlmIChvdGhlclBhcmFtcy5zb2Z0cGhvbmUpIHsKICAgICAgICBpZiAob3RoZXJQYXJhbXMuc29mdHBob25lLmRpc2FibGVSaW5ndG9uZSkgewogICAgICAgICAgcGFyYW1zLnJpbmd0b25lLnZvaWNlLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS5xdWV1ZV9jYWxsYmFjay5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgfQogCiAgICAgICAgaWYgKG90aGVyUGFyYW1zLnNvZnRwaG9uZS5yaW5ndG9uZVVybCkgewogICAgICAgICAgcGFyYW1zLnJpbmd0b25lLnZvaWNlLnJpbmd0b25lVXJsID0gb3RoZXJQYXJhbXMuc29mdHBob25lLnJpbmd0b25lVXJsOwogICAgICAgICAgcGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrLnJpbmd0b25lVXJsID0gb3RoZXJQYXJhbXMuc29mdHBob25lLnJpbmd0b25lVXJsOwogICAgICAgIH0KICAgICAgfQogCiAgICAgIGlmIChvdGhlclBhcmFtcy5jaGF0KSB7CiAgICAgICAgaWYgKG90aGVyUGFyYW1zLmNoYXQuZGlzYWJsZVJpbmd0b25lKSB7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUuY2hhdC5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgfQogCiAgICAgICAgaWYgKG90aGVyUGFyYW1zLmNoYXQucmluZ3RvbmVVcmwpIHsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS5jaGF0LnJpbmd0b25lVXJsID0gb3RoZXJQYXJhbXMuY2hhdC5yaW5ndG9uZVVybDsKICAgICAgICB9CiAgICAgIH0KIAogICAgICAvLyBNZXJnZSBpbiByaW5ndG9uZSBzZXR0aW5ncyBmcm9tIGRvd25zdHJlYW0uCiAgICAgIGlmIChvdGhlclBhcmFtcy5yaW5ndG9uZSkgewogICAgICAgIHBhcmFtcy5yaW5ndG9uZS52b2ljZSA9IGNvbm5lY3QubWVyZ2UocGFyYW1zLnJpbmd0b25lLnZvaWNlLAogICAgICAgICAgb3RoZXJQYXJhbXMucmluZ3RvbmUudm9pY2UgfHwge30pOwogICAgICAgIHBhcmFtcy5yaW5ndG9uZS5xdWV1ZV9jYWxsYmFjayA9IGNvbm5lY3QubWVyZ2UocGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrLAogICAgICAgICAgb3RoZXJQYXJhbXMucmluZ3RvbmUudm9pY2UgfHwge30pOwogICAgICAgIHBhcmFtcy5yaW5ndG9uZS5jaGF0ID0gY29ubmVjdC5tZXJnZShwYXJhbXMucmluZ3RvbmUuY2hhdCwKICAgICAgICAgIG90aGVyUGFyYW1zLnJpbmd0b25lLmNoYXQgfHwge30pOwogICAgICB9CiAgICB9OwogCiAgICAvLyBNZXJnZSBwYXJhbXMgZnJvbSBwYXJhbXMuc29mdHBob25lIGFuZCBwYXJhbXMuY2hhdCBpbnRvIHBhcmFtcy5yaW5ndG9uZQogICAgLy8gZm9yIGVtYmVkZGVkIGFuZCBub24tZW1iZWRkZWQgdXNlIGNhc2VzIHNvIHRoYXQgZGVmYXVsdHMgYXJlIHBpY2tlZCB1cC4KICAgIG1lcmdlUGFyYW1zKHBhcmFtcywgcGFyYW1zKTsKIAogICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSkgewogICAgICAvLyBJZiB0aGUgQ0NQIGlzIGluIGEgZnJhbWUsIHdhaXQgZm9yIGNvbmZpZ3VyYXRpb24gZnJvbSBkb3duc3RyZWFtLgogICAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuQ09ORklHVVJFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKICAgICAgICAvLyBNZXJnZSBhbGwgcGFyYW1zIGZyb20gZGF0YSBpbnRvIHBhcmFtcyBmb3IgYW55IG92ZXJyaWRkZW4KICAgICAgICAvLyB2YWx1ZXMgaW4gZWl0aGVyIGxlZ2FjeSAic29mdHBob25lIiBvciAicmluZ3RvbmUiIHNldHRpbmdzLgogICAgICAgIG1lcmdlUGFyYW1zKHBhcmFtcywgZGF0YSk7CiAgICAgICAgc2V0dXBSaW5ndG9uZUVuZ2luZXMocGFyYW1zLnJpbmd0b25lKTsKICAgICAgfSk7CiAKICAgIH0gZWxzZSB7CiAgICAgIHNldHVwUmluZ3RvbmVFbmdpbmVzKHBhcmFtcy5yaW5ndG9uZSk7CiAgICB9CiAgfTsKIAogIGNvbm5lY3QuY29yZS5pbml0U29mdHBob25lTWFuYWdlciA9IGZ1bmN0aW9uIChwYXJhbXNJbikgewogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogCiAgICB2YXIgY29tcGV0ZUZvck1hc3Rlck9uQWdlbnRVcGRhdGUgPSBmdW5jdGlvbiAoc29mdHBob25lUGFyYW1zSW4pIHsKICAgICAgdmFyIHNvZnRwaG9uZVBhcmFtcyA9IGNvbm5lY3QubWVyZ2UocGFyYW1zLnNvZnRwaG9uZSB8fCB7fSwgc29mdHBob25lUGFyYW1zSW4pOwogCiAgICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24gKGFnZW50KSB7CiAgICAgICAgaWYgKCFhZ2VudC5nZXRDaGFubmVsQ29uY3VycmVuY3koY29ubmVjdC5DaGFubmVsVHlwZS5WT0lDRSkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgYWdlbnQub25SZWZyZXNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBzdWIgPSB0aGlzOwogCiAgICAgICAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNPRlRQSE9ORSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoIWNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyICYmIGFnZW50LmlzU29mdHBob25lRW5hYmxlZCgpKSB7CiAgICAgICAgICAgICAgLy8gQmVjb21lIG1hc3RlciB0byBzZW5kIGxvZ3MsIHNpbmNlIHdlIG5lZWQgbG9ncyBmcm9tIHNvZnRwaG9uZSB0YWIuCiAgICAgICAgICAgICAgY29ubmVjdC5iZWNvbWVNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU0VORF9MT0dTKTsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciA9IG5ldyBjb25uZWN0LlNvZnRwaG9uZU1hbmFnZXIoc29mdHBob25lUGFyYW1zKTsKICAgICAgICAgICAgICBzdWIudW5zdWJzY3JpYmUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfTsKIAogICAgLyoqCiAgICAgKiBJZiB0aGUgd2luZG93IGlzIGZyYW1lZCwgd2UgbmVlZCB0byB3YWl0IGZvciBhIENPTkZJR1VSRSBtZXNzYWdlIGZyb20KICAgICAqIGRvd25zdHJlYW0gYmVmb3JlIHdlIHRyeSB0byBpbml0aWFsaXplLCB1bmxlc3MgcGFyYW1zLmFsbG93RnJhbWVkU29mdHBob25lIGlzIHRydWUuCiAgICAgKi8KICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkgJiYgIXBhcmFtcy5hbGxvd0ZyYW1lZFNvZnRwaG9uZSkgewogICAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuQ09ORklHVVJFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGlmIChkYXRhLnNvZnRwaG9uZSAmJiBkYXRhLnNvZnRwaG9uZS5hbGxvd0ZyYW1lZFNvZnRwaG9uZSkgewogICAgICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwogICAgICAgICAgY29tcGV0ZUZvck1hc3Rlck9uQWdlbnRVcGRhdGUoZGF0YS5zb2Z0cGhvbmUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBjb21wZXRlRm9yTWFzdGVyT25BZ2VudFVwZGF0ZShwYXJhbXMpOwogICAgfQogCiAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uIChhZ2VudCkgewogICAgICAvLyBTeW5jIG11dGUgYWNyb3NzIGFsbCB0YWJzIAogICAgICBpZiAoYWdlbnQuaXNTb2Z0cGhvbmVFbmFibGVkKCkgJiYgYWdlbnQuZ2V0Q2hhbm5lbENvbmN1cnJlbmN5KGNvbm5lY3QuQ2hhbm5lbFR5cGUuVk9JQ0UpKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwKICAgICAgICAgIHsKICAgICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuRXZlbnRUeXBlLk1VVEUKICAgICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICB9OwogCiAgY29ubmVjdC5jb3JlLmF1dGhvcml6ZSA9IGZ1bmN0aW9uIChlbmRwb2ludCkgewogICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgIGNyZWRlbnRpYWxzOiAnaW5jbHVkZScKICAgIH07CiAgICByZXR1cm4gY29ubmVjdC5mZXRjaChlbmRwb2ludCB8fCBBVVRIT1JJWkVfRU5EUE9JTlQsIG9wdGlvbnMsIEFVVEhPUklaRV9SRVRSWV9JTlRFUlZBTCwgQVVUSE9SSVpFX01BWF9SRVRSWSk7CiAgfTsKIAogIGNvbm5lY3QuY29yZS52ZXJpZnlEb21haW5BY2Nlc3MgPSBmdW5jdGlvbiAoYXV0aFRva2VuLCBlbmRwb2ludCkgewogICAgaWYgKCFjb25uZWN0LmlzRnJhbWVkKCkpIHsKICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpOwogICAgfQogICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgIGhlYWRlcnM6IHsKICAgICAgICAnWC1BbXotQmVhcmVyJzogYXV0aFRva2VuCiAgICAgIH0KICAgIH07CiAgICByZXR1cm4gY29ubmVjdC5mZXRjaChlbmRwb2ludCB8fCBXSElURUxJU1RFRF9PUklHSU5TX0VORFBPSU5ULCBvcHRpb25zLCBXSElURUxJU1RFRF9PUklHSU5TX1JFVFJZX0lOVEVSVkFMLCBXSElURUxJU1RFRF9PUklHSU5TX01BWF9SRVRSWSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgdmFyIHRvcERvbWFpbiA9IHNhbml0aXplRG9tYWluKHdpbmRvdy5kb2N1bWVudC5yZWZlcnJlcik7CiAgICAgIHZhciBpc0FsbG93ZWQgPSByZXNwb25zZS53aGl0ZWxpc3RlZE9yaWdpbnMuc29tZShmdW5jdGlvbiAob3JpZ2luKSB7CiAgICAgICAgcmV0dXJuIHRvcERvbWFpbiA9PT0gc2FuaXRpemVEb21haW4ob3JpZ2luKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBpc0FsbG93ZWQgPyBQcm9taXNlLnJlc29sdmUoKSA6IFByb21pc2UucmVqZWN0KCk7CiAgICB9KTsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEluaXRpYWxpemVzIENvbm5lY3QgYnkgY3JlYXRpbmcgb3IgY29ubmVjdGluZyB0byB0aGUgQVBJIFNoYXJlZCBXb3JrZXIuCiAgICogVXNlZCBwcmltYXJpbHkgYnkgdGhlIENDUC4KICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdFNoYXJlZFdvcmtlciA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIGNvbm5lY3QuY29yZS5jaGVja05vdEluaXRpYWxpemVkKCk7CiAgICBpZiAoY29ubmVjdC5jb3JlLmluaXRpYWxpemVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMsICdwYXJhbXMnKTsKIAogICAgdmFyIHNoYXJlZFdvcmtlclVybCA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuc2hhcmVkV29ya2VyVXJsLCAncGFyYW1zLnNoYXJlZFdvcmtlclVybCcpOwogICAgdmFyIGF1dGhUb2tlbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuYXV0aFRva2VuLCAncGFyYW1zLmF1dGhUb2tlbicpOwogICAgdmFyIHJlZnJlc2hUb2tlbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMucmVmcmVzaFRva2VuLCAncGFyYW1zLnJlZnJlc2hUb2tlbicpOwogICAgdmFyIGF1dGhUb2tlbkV4cGlyYXRpb24gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmF1dGhUb2tlbkV4cGlyYXRpb24sICdwYXJhbXMuYXV0aFRva2VuRXhwaXJhdGlvbicpOwogICAgdmFyIHJlZ2lvbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMucmVnaW9uLCAncGFyYW1zLnJlZ2lvbicpOwogICAgdmFyIGVuZHBvaW50ID0gcGFyYW1zLmVuZHBvaW50IHx8IG51bGw7CiAgICB2YXIgYXV0aG9yaXplRW5kcG9pbnQgPSBwYXJhbXMuYXV0aG9yaXplRW5kcG9pbnQgfHwgIi9jb25uZWN0L2F1dGgvYXV0aG9yaXplIjsKIAogICAgdHJ5IHsKICAgICAgLy8gSW5pdGlhbGl6ZSB0aGUgZXZlbnQgYnVzIGFuZCBhZ2VudCBkYXRhIHByb3ZpZGVycy4KICAgICAgY29ubmVjdC5jb3JlLmV2ZW50QnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoeyBsb2dFdmVudHM6IHRydWUgfSk7CiAgICAgIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlciA9IG5ldyBBZ2VudERhdGFQcm92aWRlcihjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKSk7CiAgICAgIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkgPSBuZXcgY29ubmVjdC5NZWRpYUZhY3RvcnkocGFyYW1zKTsKICAgICAgLy8gQ3JlYXRlIHRoZSBzaGFyZWQgd29ya2VyIGFuZCB1cHN0cmVhbSBjb25kdWl0LgogICAgICB2YXIgd29ya2VyID0gbmV3IFNoYXJlZFdvcmtlcihzaGFyZWRXb3JrZXJVcmwsICJDb25uZWN0U2hhcmVkV29ya2VyIik7CiAgICAgIHZhciBjb25kdWl0ID0gbmV3IGNvbm5lY3QuQ29uZHVpdCgiQ29ubmVjdFNoYXJlZFdvcmtlckNvbmR1aXQiLAogICAgICAgIG5ldyBjb25uZWN0LlBvcnRTdHJlYW0od29ya2VyLnBvcnQpLAogICAgICAgIG5ldyBjb25uZWN0LldpbmRvd0lPU3RyZWFtKHdpbmRvdywgcGFyZW50KSk7CiAKICAgICAgLy8gU2V0IHRoZSBnbG9iYWwgdXBzdHJlYW0gY29uZHVpdCBmb3IgZXh0ZXJuYWwgdXNlLgogICAgICBjb25uZWN0LmNvcmUudXBzdHJlYW0gPSBjb25kdWl0OwogCiAgICAgIGNvbm5lY3QuY29yZS53ZWJTb2NrZXRQcm92aWRlciA9IG5ldyBXZWJTb2NrZXRQcm92aWRlcigpOwogCiAgICAgIC8vIENsb3NlIG91ciBwb3J0IHRvIHRoZSBzaGFyZWQgd29ya2VyIGJlZm9yZSB0aGUgd2luZG93IGNsb3Nlcy4KICAgICAgZ2xvYmFsLm9udW5sb2FkID0gZnVuY3Rpb24gKCkgewogICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNMT1NFKTsKICAgICAgICB3b3JrZXIucG9ydC5jbG9zZSgpOwogICAgICB9OwogCiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuc2NoZWR1bGVVcHN0cmVhbUxvZ1B1c2goY29uZHVpdCk7CiAgICAgIC8vIEJyaWRnZSBhbGwgdXBzdHJlYW0gbWVzc2FnZXMgaW50byB0aGUgZXZlbnQgYnVzLgogICAgICBjb25kdWl0Lm9uQWxsVXBzdHJlYW0oY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuYnJpZGdlKCkpOwogICAgICAvLyBCcmlkZ2UgYWxsIGRvd25zdHJlYW0gbWVzc2FnZXMgaW50byB0aGUgZXZlbnQgYnVzLgogICAgICBjb25kdWl0Lm9uQWxsRG93bnN0cmVhbShjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5icmlkZ2UoKSk7CiAgICAgIC8vIFBhc3MgYWxsIHVwc3RyZWFtIG1lc3NhZ2VzIChmcm9tIHNoYXJlZCB3b3JrZXIpIGRvd25zdHJlYW0gKHRvIENDUCBjb25zdW1lcikuCiAgICAgIGNvbmR1aXQub25BbGxVcHN0cmVhbShjb25kdWl0LnBhc3NEb3duc3RyZWFtKCkpOwogICAgICAvLyBQYXNzIGFsbCBkb3duc3RyZWFtIG1lc3NhZ2VzIChmcm9tIENDUCBjb25zdW1lcikgdXBzdHJlYW0gKHRvIHNoYXJlZCB3b3JrZXIpLgogICAgICBjb25kdWl0Lm9uQWxsRG93bnN0cmVhbShjb25kdWl0LnBhc3NVcHN0cmVhbSgpKTsKICAgICAgLy8gU2VuZCBjb25maWd1cmF0aW9uIHVwIHRvIHRoZSBzaGFyZWQgd29ya2VyLgogCiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgewogICAgICAgIGF1dGhUb2tlbjogYXV0aFRva2VuLAogICAgICAgIGF1dGhUb2tlbkV4cGlyYXRpb246IGF1dGhUb2tlbkV4cGlyYXRpb24sCiAgICAgICAgZW5kcG9pbnQ6IGVuZHBvaW50LAogICAgICAgIHJlZnJlc2hUb2tlbjogcmVmcmVzaFRva2VuLAogICAgICAgIHJlZ2lvbjogcmVnaW9uLAogICAgICAgIGF1dGhvcml6ZUVuZHBvaW50OiBhdXRob3JpemVFbmRwb2ludAogICAgICB9KTsKIAogICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsIGZ1bmN0aW9uICgpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkFja25vd2xlZGdlZCBieSB0aGUgQ29ubmVjdFNoYXJlZFdvcmtlciEiKTsKICAgICAgICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKICAgICAgfSk7CiAgICAgIC8vIEFkZCBhbGwgdXBzdHJlYW0gbG9nIGVudHJpZXMgdG8gb3VyIG93biBsb2dnZXIuCiAgICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgICAgIGlmIChsb2dFbnRyeS5sb2dnZXJJZCAhPT0gY29ubmVjdC5nZXRMb2coKS5nZXRMb2dnZXJJZCgpKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmFkZExvZ0VudHJ5KGNvbm5lY3QuTG9nRW50cnkuZnJvbU9iamVjdChsb2dFbnRyeSkpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIC8vIFJlbG9hZCB0aGUgcGFnZSBpZiB0aGUgc2hhcmVkIHdvcmtlciBkZXRlY3RzIGFuIEFQSSBhdXRoIGZhaWx1cmUuCiAgICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BVVRIX0ZBSUwsIGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgICAgIGxvY2F0aW9uLnJlbG9hZCgpOwogICAgICB9KTsKIAogICAgICBjb25uZWN0LmNvcmUuY2xpZW50ID0gbmV3IGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0Q2xpZW50KGNvbmR1aXQpOwogICAgICBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50ID0gbmV3IGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50KGNvbmR1aXQpOwogCiAgICAgIC8vIFBhc3MgdGhlIFRFUk1JTkFURSByZXF1ZXN0IHVwc3RyZWFtIHRvIHRoZSBzaGFyZWQgd29ya2VyLgogICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFLAogICAgICAgIGNvbmR1aXQucGFzc1Vwc3RyZWFtKCkpOwogCiAgICAgIC8vIFJlZnJlc2ggdGhlIHBhZ2Ugd2hlbiB3ZSByZWNlaXZlIHRoZSBURVJNSU5BVEVEIHJlc3BvbnNlIGZyb20gdGhlCiAgICAgIC8vIHNoYXJlZCB3b3JrZXIuCiAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5URVJNSU5BVEVELCBmdW5jdGlvbiAoKSB7CiAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCh0cnVlKTsKICAgICAgfSk7CiAKICAgICAgd29ya2VyLnBvcnQuc3RhcnQoKTsKIAogICAgICAvLyBBdHRlbXB0IHRvIGdldCBwZXJtaXNzaW9uIHRvIHNob3cgbm90aWZpY2F0aW9ucy4KICAgICAgdmFyIG5tID0gY29ubmVjdC5jb3JlLmdldE5vdGlmaWNhdGlvbk1hbmFnZXIoKTsKICAgICAgbm0ucmVxdWVzdFBlcm1pc3Npb24oKTsKIAogICAgICBjb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuSU5JVF9ESVNBU1RFUl9SRUNPVkVSWSwgZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmluaXREaXNhc3RlclJlY292ZXJ5KHBhcmFtcyk7CiAgICAgIH0pCiAKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGluaXRpYWxpemUgdGhlIEFQSSBzaGFyZWQgd29ya2VyLCB3ZSdyZSBkZWFkISIpCiAgICAgICAgLndpdGhFeGNlcHRpb24oZSk7CiAgICB9CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJbml0aWFsaXplcyBDb25uZWN0IGJ5IGNyZWF0aW5nIG9yIGNvbm5lY3RpbmcgdG8gdGhlIEFQSSBTaGFyZWQgV29ya2VyLgogICAqIEluaXRpYWxpemVzIENvbm5lY3QgYnkgbG9hZGluZyB0aGUgQ0NQIGluIGFuIGlmcmFtZSBhbmQgY29ubmVjdGluZyB0byBpdC4KICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdENDUCA9IGZ1bmN0aW9uIChjb250YWluZXJEaXYsIHBhcmFtc0luKSB7CiAgICBjb25uZWN0LmNvcmUuY2hlY2tOb3RJbml0aWFsaXplZCgpOwogICAgaWYgKGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCkgewogICAgICByZXR1cm47CiAgICB9CiAKICAgIC8vIEZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSwgd2hlbiBpbnN0ZWFkIG9mIHRha2luZyBhIHBhcmFtcyBvYmplY3QKICAgIC8vIGFzIGlucHV0IHdlIG9ubHkgYWNjZXB0ZWQgY2NwVXJsLgogICAgdmFyIHBhcmFtcyA9IHt9OwogICAgaWYgKHR5cGVvZiAocGFyYW1zSW4pID09PSAnc3RyaW5nJykgewogICAgICBwYXJhbXMuY2NwVXJsID0gcGFyYW1zSW47CiAgICB9IGVsc2UgewogICAgICBwYXJhbXMgPSBwYXJhbXNJbjsKICAgIH0KIAogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbnRhaW5lckRpdiwgJ2NvbnRhaW5lckRpdicpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5jY3BVcmwsICdwYXJhbXMuY2NwVXJsJyk7CiAKICAgIC8vIENyZWF0ZSB0aGUgQ0NQIGlmcmFtZSBhbmQgYXBwZW5kIGl0IHRvIHRoZSBjb250YWluZXIgZGl2LgogICAgdmFyIGlmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lmcmFtZScpOwogICAgaWZyYW1lLnNyYyA9IHBhcmFtcy5jY3BVcmw7CiAgICBpZnJhbWUuYWxsb3cgPSAibWljcm9waG9uZTsgYXV0b3BsYXkiOwogICAgaWZyYW1lLnN0eWxlID0gIndpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCUiOwogICAgY29udGFpbmVyRGl2LmFwcGVuZENoaWxkKGlmcmFtZSk7CiAKICAgIC8vIEluaXRpYWxpemUgdGhlIGV2ZW50IGJ1cyBhbmQgYWdlbnQgZGF0YSBwcm92aWRlcnMuCiAgICAvLyBOT1RFOiBTZXR0aW5nIGxvZ0V2ZW50cyBoZXJlIHRvIEZBTFNFIGluIG9yZGVyIHRvIGF2b2lkIGR1cGxpY2F0aW5nCiAgICAvLyBldmVudHMgd2hpY2ggYXJlIGxvZ2dlZCBpbiBDQ1AuCiAgICBjb25uZWN0LmNvcmUuZXZlbnRCdXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cyh7IGxvZ0V2ZW50czogZmFsc2UgfSk7CiAgICBjb25uZWN0LmNvcmUuYWdlbnREYXRhUHJvdmlkZXIgPSBuZXcgQWdlbnREYXRhUHJvdmlkZXIoY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkpOwogICAgY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeSA9IG5ldyBjb25uZWN0Lk1lZGlhRmFjdG9yeShwYXJhbXMpOwogCiAgICAvLyBCdWlsZCB0aGUgdXBzdHJlYW0gY29uZHVpdCBjb21tdW5pY2F0aW5nIHdpdGggdGhlIENDUCBpZnJhbWUuCiAgICB2YXIgY29uZHVpdCA9IG5ldyBjb25uZWN0LklGcmFtZUNvbmR1aXQocGFyYW1zLmNjcFVybCwgd2luZG93LCBpZnJhbWUpOwogCiAgICAvLyBMZXQgQ0NQIGtub3cgaWYgaWZyYW1lIGlzIHZpc2libGUKICAgIGlmcmFtZS5vbmxvYWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICB2YXIgc3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShpZnJhbWUsIG51bGwpOwogICAgICB2YXIgZGF0YSA9IHsKICAgICAgICBkaXNwbGF5OiBzdHlsZS5kaXNwbGF5LAogICAgICAgIG9mZnNldFdpZHRoOiBpZnJhbWUub2Zmc2V0V2lkdGgsCiAgICAgICAgb2Zmc2V0SGVpZ2h0OiBpZnJhbWUub2Zmc2V0SGVpZ2h0LAogICAgICAgIGNsaWVudFJlY3RzTGVuZ3RoOiBpZnJhbWUuZ2V0Q2xpZW50UmVjdHMoKS5sZW5ndGgKICAgICAgfTsKICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuSUZSQU1FX1NUWUxFLCBkYXRhKTsKICAgIH0sIDEwMDAwKTsKIAogICAgLy8gU2V0IHRoZSBnbG9iYWwgdXBzdHJlYW0gY29uZHVpdCBmb3IgZXh0ZXJuYWwgdXNlLgogICAgY29ubmVjdC5jb3JlLnVwc3RyZWFtID0gY29uZHVpdDsKIAogICAgLy8gSW5pdCB3ZWJTb2NrZXRQcm92aWRlcgogICAgY29ubmVjdC5jb3JlLndlYlNvY2tldFByb3ZpZGVyID0gbmV3IFdlYlNvY2tldFByb3ZpZGVyKCk7CiAKICAgIGNvbmR1aXQub25BbGxVcHN0cmVhbShjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5icmlkZ2UoKSk7CiAKICAgIC8vIEluaXRpYWxpemUgdGhlIGtlZXBhbGl2ZSBtYW5hZ2VyLgogICAgY29ubmVjdC5jb3JlLmtlZXBhbGl2ZU1hbmFnZXIgPSBuZXcgS2VlcGFsaXZlTWFuYWdlcihjb25kdWl0LAogICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKSwKICAgICAgcGFyYW1zLmNjcFN5blRpbWVvdXQgfHwgQ0NQX1NZTl9USU1FT1VULAogICAgICBwYXJhbXMuY2NwQWNrVGltZW91dCB8fCBDQ1BfQUNLX1RJTUVPVVQpCiAgICAgIDsKICAgIGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoSW50ZXJ2YWwgPSBudWxsOwogCiAgICAvLyBBbGxvdyAxMCBzZWMgKGRlZmF1bHQpIGJlZm9yZSByZWNlaXZpbmcgdGhlIGZpcnN0IEFDSyBmcm9tIHRoZSBDQ1AuCiAgICBjb25uZWN0LmNvcmUuY2NwTG9hZFRpbWVvdXRJbnN0YW5jZSA9IGdsb2JhbC5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgY29ubmVjdC5jb3JlLmNjcExvYWRUaW1lb3V0SW5zdGFuY2UgPSBudWxsOwogICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLkFDS19USU1FT1VUKTsKICAgIH0sIHBhcmFtcy5jY3BMb2FkVGltZW91dCB8fCBDQ1BfTE9BRF9USU1FT1VUKTsKIAogICAgLy8gT25jZSB3ZSByZWNlaXZlIHRoZSBmaXJzdCBBQ0ssIHNldHVwIG91ciB1cHN0cmVhbSBBUEkgY2xpZW50IGFuZCBlc3RhYmxpc2gKICAgIC8vIHRoZSBTWU4vQUNLIHJlZnJlc2ggZmxvdy4KICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSwgZnVuY3Rpb24gKCkgewogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkFja25vd2xlZGdlZCBieSB0aGUgQ0NQISIpOwogICAgICBjb25uZWN0LmNvcmUuY2xpZW50ID0gbmV3IGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0Q2xpZW50KGNvbmR1aXQpOwogICAgICBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50ID0gbmV3IGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50KGNvbmR1aXQpOwogICAgICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSB0cnVlOwogCiAgICAgIGlmIChwYXJhbXMuc29mdHBob25lIHx8IHBhcmFtcy5jaGF0KSB7CiAgICAgICAgLy8gU2VuZCBjb25maWd1cmF0aW9uIHVwIHRvIHRoZSBDQ1AuCiAgICAgICAgLy9zZXQgaXQgdG8gZmFsc2UgaWYgc2Vjb25kYXJ5CiAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQ09ORklHVVJFLCB7CiAgICAgICAgICBzb2Z0cGhvbmU6IHBhcmFtcy5zb2Z0cGhvbmUsCiAgICAgICAgICBjaGF0OiBwYXJhbXMuY2hhdAogICAgICAgIH0pOwogICAgICB9CiAKICAgICAgLy8gSWYgRFIgZW5hYmxlZCwgc2V0IHRoaXMgQ0NQIGluc3RhbmNlIGFzIHBhcnQgb2YgYSBEaXNhc3RlciBSZWNvdmVyeSBmbGVldAogICAgICBpZiAocGFyYW1zLmRpc2FzdGVyUmVjb3ZlcnlPbikgewogICAgICAgIGNvbm5lY3QuY29yZS5yZWdpb24gPSBwYXJhbXMucmVnaW9uOwogICAgICAgIGNvbm5lY3QuY29yZS5zdXBwcmVzc0NvbnRhY3RzID0gc3VwcHJlc3NDb250YWN0czsKICAgICAgICBjb25uZWN0LmNvcmUuZm9yY2VPZmZsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuU0VUX09GRkxJTkUpOwogICAgICAgIH0gICAgICAgCiAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLklOSVRfRElTQVNURVJfUkVDT1ZFUlksIHBhcmFtcyk7CiAgICAgIH0KIAogICAgICBpZiAoY29ubmVjdC5jb3JlLmNjcExvYWRUaW1lb3V0SW5zdGFuY2UpIHsKICAgICAgICBnbG9iYWwuY2xlYXJUaW1lb3V0KGNvbm5lY3QuY29yZS5jY3BMb2FkVGltZW91dEluc3RhbmNlKTsKICAgICAgICBjb25uZWN0LmNvcmUuY2NwTG9hZFRpbWVvdXRJbnN0YW5jZSA9IG51bGw7CiAgICAgIH0KIAogICAgICBjb25uZWN0LmNvcmUua2VlcGFsaXZlTWFuYWdlci5zdGFydCgpOwogICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICB9KTsKIAogICAgLy8gQWRkIGFueSBsb2dzIGZyb20gdGhlIHVwc3RyZWFtIHRvIG91ciBvd24gbG9nZ2VyLgogICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgZnVuY3Rpb24gKGxvZ0VudHJ5KSB7CiAgICAgIGlmIChsb2dFbnRyeS5sb2dnZXJJZCAhPT0gY29ubmVjdC5nZXRMb2coKS5nZXRMb2dnZXJJZCgpKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5hZGRMb2dFbnRyeShjb25uZWN0LkxvZ0VudHJ5LmZyb21PYmplY3QobG9nRW50cnkpKTsKICAgICAgfQogICAgfSk7CiAKICAgIC8vIFBvcCBhIGxvZ2luIHBhZ2Ugd2hlbiB3ZSBlbmNvdW50ZXIgYW4gQUNLIHRpbWVvdXQuCiAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuQUNLX1RJTUVPVVQsIGZ1bmN0aW9uICgpIHsKICAgICAgLy8gbG9naW5Qb3B1cCBpcyB0cnVlIGJ5IGRlZmF1bHQsIG9ubHkgZmFsc2UgaWYgZXhwbGljaXRseSBzZXQgdG8gZmFsc2UuCiAgICAgIGlmIChwYXJhbXMubG9naW5Qb3B1cCAhPT0gZmFsc2UpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIGxvZ2luVXJsID0gY3JlYXRlTG9naW5VcmwocGFyYW1zKTsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiQUNLX1RJTUVPVVQgb2NjdXJyZWQsIGF0dGVtcHRpbmcgdG8gcG9wIHRoZSBsb2dpbiBwYWdlIGlmIG5vdCBhbHJlYWR5IG9wZW4uIik7CiAgICAgICAgICAvLyBjbGVhciBvdXQgbGFzdCBvcGVuZWQgdGltZXN0YW1wIGZvciBTQU1MIGF1dGhlbnRpY2F0aW9uIHdoZW4gdGhlcmUgaXMgQUNLX1RJTUVPVVQKICAgICAgICAgIGlmIChwYXJhbXMubG9naW5VcmwpIHsKICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5nZXRQb3B1cE1hbmFnZXIoKS5jbGVhcihjb25uZWN0Lk1hc3RlclRvcGljcy5MT0dJTl9QT1BVUCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25uZWN0LmNvcmUubG9naW5XaW5kb3cgPSBjb25uZWN0LmNvcmUuZ2V0UG9wdXBNYW5hZ2VyKCkub3Blbihsb2dpblVybCwgY29ubmVjdC5NYXN0ZXJUb3BpY3MuTE9HSU5fUE9QVVApOwogCiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiQUNLX1RJTUVPVVQgb2NjdXJyZWQgYnV0IHdlIGFyZSB1bmFibGUgdG8gb3BlbiB0aGUgbG9naW4gcG9wdXAuIikud2l0aEV4Y2VwdGlvbihlKTsKICAgICAgICB9CiAgICAgIH0KIAogICAgICBpZiAoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hJbnRlcnZhbCA9PSBudWxsKSB7CiAgICAgICAgdmFyIGNjcF9pZnJhbWVfcmVmcmVzaF9pbnRlcnZhbCA9IChwYXJhbXMuZGlzYXN0ZXJSZWNvdmVyeU9uKSA/IENDUF9EUl9JRlJBTUVfUkVGUkVTSF9JTlRFUlZBTCA6IENDUF9JRlJBTUVfUkVGUkVTSF9JTlRFUlZBTDsKICAgICAgICBjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEludGVydmFsID0gd2luZG93LnNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmcmFtZS5zcmMgPSAocGFyYW1zLmRpc2FzdGVyUmVjb3ZlcnlPbikgPyBwYXJhbXMubG9naW5VcmwgOiBwYXJhbXMuY2NwVXJsOwogICAgICAgIH0sIGNjcF9pZnJhbWVfcmVmcmVzaF9pbnRlcnZhbCk7CiAKICAgICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKICAgICAgICAgIGdsb2JhbC5jbGVhckludGVydmFsKGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoSW50ZXJ2YWwpOwogICAgICAgICAgY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hJbnRlcnZhbCA9IG51bGw7CiAgICAgICAgICBjb25uZWN0LmNvcmUuZ2V0UG9wdXBNYW5hZ2VyKCkuY2xlYXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuTE9HSU5fUE9QVVApOwogICAgICAgICAgaWYgKHBhcmFtcy5sb2dpblBvcHVwQXV0b0Nsb3NlICYmIGNvbm5lY3QuY29yZS5sb2dpbldpbmRvdykgewogICAgICAgICAgICBjb25uZWN0LmNvcmUubG9naW5XaW5kb3cuY2xvc2UoKTsKICAgICAgICAgICAgY29ubmVjdC5jb3JlLmxvZ2luV2luZG93ID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAKICAgIGlmIChwYXJhbXMub25WaWV3Q29udGFjdCkgewogICAgICBjb25uZWN0LmNvcmUub25WaWV3Q29udGFjdChwYXJhbXMub25WaWV3Q29udGFjdCk7CiAgICB9CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICB2YXIgS2VlcGFsaXZlTWFuYWdlciA9IGZ1bmN0aW9uIChjb25kdWl0LCBldmVudEJ1cywgc3luVGltZW91dCwgYWNrVGltZW91dCkgewogICAgdGhpcy5jb25kdWl0ID0gY29uZHVpdDsKICAgIHRoaXMuZXZlbnRCdXMgPSBldmVudEJ1czsKICAgIHRoaXMuc3luVGltZW91dCA9IHN5blRpbWVvdXQ7CiAgICB0aGlzLmFja1RpbWVvdXQgPSBhY2tUaW1lb3V0OwogICAgdGhpcy5hY2tUaW1lciA9IG51bGw7CiAgICB0aGlzLnN5blRpbWVyID0gbnVsbDsKICAgIHRoaXMuYWNrU3ViID0gbnVsbDsKICB9OwogCiAgS2VlcGFsaXZlTWFuYWdlci5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAKICAgIHRoaXMuY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU1lOQ0hST05JWkUpOwogICAgdGhpcy5hY2tTdWIgPSB0aGlzLmNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSwgZnVuY3Rpb24gKCkgewogICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgIGdsb2JhbC5jbGVhclRpbWVvdXQoc2VsZi5hY2tUaW1lcik7CiAgICAgIHNlbGYuZGVmZXJTdGFydCgpOwogICAgfSk7CiAgICB0aGlzLmFja1RpbWVyID0gZ2xvYmFsLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICBzZWxmLmFja1N1Yi51bnN1YnNjcmliZSgpOwogICAgICBzZWxmLmV2ZW50QnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuQUNLX1RJTUVPVVQpOwogICAgICBzZWxmLmRlZmVyU3RhcnQoKTsKICAgIH0sIHRoaXMuYWNrVGltZW91dCk7CiAgfTsKIAogIEtlZXBhbGl2ZU1hbmFnZXIucHJvdG90eXBlLmRlZmVyU3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAodGhpcy5zeW5UaW1lciA9PSBudWxsKSB7CiAgICAgIHRoaXMuc3luVGltZXIgPSBnbG9iYWwuc2V0VGltZW91dChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMuc3RhcnQpLCB0aGlzLnN5blRpbWVvdXQpOwogICAgfQogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAKICB2YXIgV2ViU29ja2V0UHJvdmlkZXIgPSBmdW5jdGlvbiAoKSB7CiAKICAgIHZhciBjYWxsYmFja3MgPSB7CiAgICAgIGluaXRGYWlsdXJlOiBuZXcgU2V0KCksCiAgICAgIHN1YnNjcmlwdGlvblVwZGF0ZTogbmV3IFNldCgpLAogICAgICBzdWJzY3JpcHRpb25GYWlsdXJlOiBuZXcgU2V0KCksCiAgICAgIHRvcGljOiBuZXcgTWFwKCksCiAgICAgIGFsbE1lc3NhZ2U6IG5ldyBTZXQoKSwKICAgICAgY29ubmVjdGlvbkdhaW46IG5ldyBTZXQoKSwKICAgICAgY29ubmVjdGlvbkxvc3Q6IG5ldyBTZXQoKSwKICAgICAgY29ubmVjdGlvbk9wZW46IG5ldyBTZXQoKSwKICAgICAgY29ubmVjdGlvbkNsb3NlOiBuZXcgU2V0KCkKICAgIH07CiAKICAgIHZhciBpbnZva2VDYWxsYmFja3MgPSBmdW5jdGlvbiAoY2FsbGJhY2tzLCByZXNwb25zZSkgewogICAgICBjYWxsYmFja3MuZm9yRWFjaChmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICBjYWxsYmFjayhyZXNwb25zZSk7CiAgICAgIH0pOwogICAgfTsKIAogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5JTklUX0ZBSUxVUkUsIGZ1bmN0aW9uICgpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5pbml0RmFpbHVyZSk7CiAgICB9KTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fT1BFTiwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuY29ubmVjdGlvbk9wZW4sIHJlc3BvbnNlKTsKICAgIH0pOwoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9DTE9TRSwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuY29ubmVjdGlvbkNsb3NlLCByZXNwb25zZSk7CiAgICB9KTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fR0FJTiwgZnVuY3Rpb24gKCkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmNvbm5lY3Rpb25HYWluKTsKICAgIH0pOwoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9MT1NULCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5jb25uZWN0aW9uTG9zdCwgcmVzcG9uc2UpOwogICAgfSk7CiAKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSVBUSU9OX1VQREFURSwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3Muc3Vic2NyaXB0aW9uVXBkYXRlLCByZXNwb25zZSk7CiAgICB9KTsKIAogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJUFRJT05fRkFJTFVSRSwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3Muc3Vic2NyaXB0aW9uRmFpbHVyZSwgcmVzcG9uc2UpOwogICAgfSk7CiAKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQUxMX01FU1NBR0UsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmFsbE1lc3NhZ2UsIHJlc3BvbnNlKTsKICAgICAgaWYgKGNhbGxiYWNrcy50b3BpYy5oYXMocmVzcG9uc2UudG9waWMpKSB7CiAgICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy50b3BpYy5nZXQocmVzcG9uc2UudG9waWMpLCByZXNwb25zZSk7CiAgICAgIH0KICAgIH0pOwogCiAgICB0aGlzLnNlbmRNZXNzYWdlID0gZnVuY3Rpb24gKHdlYlNvY2tldFBheWxvYWQpIHsKICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNFTkQsIHdlYlNvY2tldFBheWxvYWQpOwogICAgfTsKIAogICAgdGhpcy5vbkluaXRGYWlsdXJlID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuaW5pdEZhaWx1cmUuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmluaXRGYWlsdXJlLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwoKICAgIHRoaXMub25Db25uZWN0aW9uT3BlbiA9IGZ1bmN0aW9uKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuY29ubmVjdGlvbk9wZW4uYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmNvbm5lY3Rpb25PcGVuLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwoKICAgIHRoaXMub25Db25uZWN0aW9uQ2xvc2UgPSBmdW5jdGlvbihjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmNvbm5lY3Rpb25DbG9zZS5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuY29ubmVjdGlvbkNsb3NlLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwoKICAgIHRoaXMub25Db25uZWN0aW9uR2FpbiA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmNvbm5lY3Rpb25HYWluLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5jb25uZWN0aW9uR2Fpbi5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogICAgdGhpcy5vbkNvbm5lY3Rpb25Mb3N0ID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuY29ubmVjdGlvbkxvc3QuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmNvbm5lY3Rpb25Mb3N0LmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgICB0aGlzLm9uU3Vic2NyaXB0aW9uVXBkYXRlID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3Muc3Vic2NyaXB0aW9uVXBkYXRlLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5zdWJzY3JpcHRpb25VcGRhdGUuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICAgIHRoaXMub25TdWJzY3JpcHRpb25GYWlsdXJlID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3Muc3Vic2NyaXB0aW9uRmFpbHVyZS5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3Muc3Vic2NyaXB0aW9uRmFpbHVyZS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogICAgdGhpcy5zdWJzY3JpYmVUb3BpY3MgPSBmdW5jdGlvbiAodG9waWNzKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b3BpY3MsICd0b3BpY3MnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNBcnJheSh0b3BpY3MpLCAndG9waWNzIG11c3QgYmUgYSBhcnJheScpOwogICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSUJFLCB0b3BpY3MpOwogICAgfTsKIAogICAgdGhpcy5vbk1lc3NhZ2UgPSBmdW5jdGlvbiAodG9waWNOYW1lLCBjYikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWNOYW1lLCAndG9waWNOYW1lJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBpZiAoY2FsbGJhY2tzLnRvcGljLmhhcyh0b3BpY05hbWUpKSB7CiAgICAgICAgY2FsbGJhY2tzLnRvcGljLmdldCh0b3BpY05hbWUpLmFkZChjYik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2tzLnRvcGljLnNldCh0b3BpY05hbWUsIG5ldyBTZXQoW2NiXSkpOwogICAgICB9CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy50b3BpYy5nZXQodG9waWNOYW1lKS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogICAgdGhpcy5vbkFsbE1lc3NhZ2UgPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5hbGxNZXNzYWdlLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5hbGxNZXNzYWdlLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICB2YXIgQWdlbnREYXRhUHJvdmlkZXIgPSBmdW5jdGlvbiAoYnVzKSB7CiAgICB2YXIgYWdlbnREYXRhID0gbnVsbDsKICAgIHRoaXMuYnVzID0gYnVzOwogICAgdGhpcy5idXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuVVBEQVRFLCBjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMudXBkYXRlQWdlbnREYXRhKSk7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS51cGRhdGVBZ2VudERhdGEgPSBmdW5jdGlvbiAoYWdlbnREYXRhKSB7CiAgICB2YXIgb2xkQWdlbnREYXRhID0gdGhpcy5hZ2VudERhdGE7CiAgICB0aGlzLmFnZW50RGF0YSA9IGFnZW50RGF0YTsKIAogICAgaWYgKG9sZEFnZW50RGF0YSA9PSBudWxsKSB7CiAgICAgIGNvbm5lY3QuYWdlbnQuaW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICB0aGlzLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQWdlbnRFdmVudHMuSU5JVCwgbmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICB9CiAKICAgIHRoaXMuYnVzLnRyaWdnZXIoY29ubmVjdC5BZ2VudEV2ZW50cy5SRUZSRVNILCBuZXcgY29ubmVjdC5BZ2VudCgpKTsKIAogICAgdGhpcy5fZmlyZUFnZW50VXBkYXRlRXZlbnRzKG9sZEFnZW50RGF0YSk7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5nZXRBZ2VudERhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAodGhpcy5hZ2VudERhdGEgPT0gbnVsbCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdObyBhZ2VudCBkYXRhIGlzIGF2YWlsYWJsZSB5ZXQhJyk7CiAgICB9CiAKICAgIHJldHVybiB0aGlzLmFnZW50RGF0YTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLmdldENvbnRhY3REYXRhID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgdmFyIGFnZW50RGF0YSA9IHRoaXMuZ2V0QWdlbnREYXRhKCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmZpbmQoYWdlbnREYXRhLnNuYXBzaG90LmNvbnRhY3RzLCBmdW5jdGlvbiAoY3RkYXRhKSB7CiAgICAgIHJldHVybiBjdGRhdGEuY29udGFjdElkID09PSBjb250YWN0SWQ7CiAgICB9KTsKIAogICAgaWYgKGNvbnRhY3REYXRhID09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignQ29udGFjdCAlcyBubyBsb25nZXIgZXhpc3RzLicsIGNvbnRhY3RJZCk7CiAgICB9CiAKICAgIHJldHVybiBjb250YWN0RGF0YTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLmdldENvbm5lY3Rpb25EYXRhID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKSB7CiAgICB2YXIgY29udGFjdERhdGEgPSB0aGlzLmdldENvbnRhY3REYXRhKGNvbnRhY3RJZCk7CiAgICB2YXIgY29ubmVjdGlvbkRhdGEgPSBjb25uZWN0LmZpbmQoY29udGFjdERhdGEuY29ubmVjdGlvbnMsIGZ1bmN0aW9uIChjZGF0YSkgewogICAgICByZXR1cm4gY2RhdGEuY29ubmVjdGlvbklkID09PSBjb25uZWN0aW9uSWQ7CiAgICB9KTsKIAogICAgaWYgKGNvbm5lY3Rpb25EYXRhID09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignQ29ubmVjdGlvbiAlcyBmb3IgY29udGFjdCAlcyBubyBsb25nZXIgZXhpc3RzLicsIGNvbm5lY3Rpb25JZCwgY29udGFjdElkKTsKICAgIH0KIAogICAgcmV0dXJuIGNvbm5lY3Rpb25EYXRhOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuX2RpZmZDb250YWN0cyA9IGZ1bmN0aW9uIChvbGRBZ2VudERhdGEpIHsKICAgIHZhciBkaWZmID0gewogICAgICBhZGRlZDoge30sCiAgICAgIHJlbW92ZWQ6IHt9LAogICAgICBjb21tb246IHt9LAogICAgICBvbGRNYXA6IGNvbm5lY3QuaW5kZXgob2xkQWdlbnREYXRhID09IG51bGwgPyBbXSA6IG9sZEFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGNvbnRhY3QpIHsgcmV0dXJuIGNvbnRhY3QuY29udGFjdElkOyB9KSwKICAgICAgbmV3TWFwOiBjb25uZWN0LmluZGV4KHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LmNvbnRhY3RzLCBmdW5jdGlvbiAoY29udGFjdCkgeyByZXR1cm4gY29udGFjdC5jb250YWN0SWQ7IH0pCiAgICB9OwogCiAgICBjb25uZWN0LmtleXMoZGlmZi5vbGRNYXApLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgICBpZiAoY29ubmVjdC5jb250YWlucyhkaWZmLm5ld01hcCwgY29udGFjdElkKSkgewogICAgICAgIGRpZmYuY29tbW9uW2NvbnRhY3RJZF0gPSBkaWZmLm5ld01hcFtjb250YWN0SWRdOwogICAgICB9IGVsc2UgewogICAgICAgIGRpZmYucmVtb3ZlZFtjb250YWN0SWRdID0gZGlmZi5vbGRNYXBbY29udGFjdElkXTsKICAgICAgfQogICAgfSk7CiAKICAgIGNvbm5lY3Qua2V5cyhkaWZmLm5ld01hcCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICAgIGlmICghY29ubmVjdC5jb250YWlucyhkaWZmLm9sZE1hcCwgY29udGFjdElkKSkgewogICAgICAgIGRpZmYuYWRkZWRbY29udGFjdElkXSA9IGRpZmYubmV3TWFwW2NvbnRhY3RJZF07CiAgICAgIH0KICAgIH0pOwogCiAgICByZXR1cm4gZGlmZjsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLl9maXJlQWdlbnRVcGRhdGVFdmVudHMgPSBmdW5jdGlvbiAob2xkQWdlbnREYXRhKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgZGlmZiA9IG51bGw7CiAgICB2YXIgb2xkQWdlbnRTdGF0ZSA9IG9sZEFnZW50RGF0YSA9PSBudWxsID8gY29ubmVjdC5BZ2VudEF2YWlsU3RhdGVzLklOSVQgOiBvbGRBZ2VudERhdGEuc25hcHNob3Quc3RhdGUubmFtZTsKICAgIHZhciBuZXdBZ2VudFN0YXRlID0gdGhpcy5hZ2VudERhdGEuc25hcHNob3Quc3RhdGUubmFtZTsKICAgIHZhciBvbGRSb3V0aW5nU3RhdGUgPSBvbGRBZ2VudERhdGEgPT0gbnVsbCA/IGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUuSU5JVCA6IG9sZEFnZW50RGF0YS5zbmFwc2hvdC5zdGF0ZS50eXBlOwogICAgdmFyIG5ld1JvdXRpbmdTdGF0ZSA9IHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LnN0YXRlLnR5cGU7CiAKICAgIGlmIChvbGRSb3V0aW5nU3RhdGUgIT09IG5ld1JvdXRpbmdTdGF0ZSkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRSb3V0aW5nRXZlbnRHcmFwaCgpLmdldEFzc29jaWF0aW9ucyh0aGlzLCBvbGRSb3V0aW5nU3RhdGUsIG5ld1JvdXRpbmdTdGF0ZSkuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBzZWxmLmJ1cy50cmlnZ2VyKGV2ZW50LCBuZXcgY29ubmVjdC5BZ2VudCgpKTsKICAgICAgfSk7CiAgICB9CiAKICAgIGlmIChvbGRBZ2VudFN0YXRlICE9PSBuZXdBZ2VudFN0YXRlKSB7CiAgICAgIHRoaXMuYnVzLnRyaWdnZXIoY29ubmVjdC5BZ2VudEV2ZW50cy5TVEFURV9DSEFOR0UsIHsKICAgICAgICBhZ2VudDogbmV3IGNvbm5lY3QuQWdlbnQoKSwKICAgICAgICBvbGRTdGF0ZTogb2xkQWdlbnRTdGF0ZSwKICAgICAgICBuZXdTdGF0ZTogbmV3QWdlbnRTdGF0ZQogCiAgICAgIH0pOwogICAgICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRTdGF0ZUV2ZW50R3JhcGgoKS5nZXRBc3NvY2lhdGlvbnModGhpcywgb2xkQWdlbnRTdGF0ZSwgbmV3QWdlbnRTdGF0ZSkuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBzZWxmLmJ1cy50cmlnZ2VyKGV2ZW50LCBuZXcgY29ubmVjdC5BZ2VudCgpKTsKICAgICAgfSk7CiAgICB9CiAKICAgIGlmIChvbGRBZ2VudERhdGEgIT09IG51bGwpIHsKICAgICAgZGlmZiA9IHRoaXMuX2RpZmZDb250YWN0cyhvbGRBZ2VudERhdGEpOwogCiAgICB9IGVsc2UgewogICAgICBkaWZmID0gewogICAgICAgIGFkZGVkOiBjb25uZWN0LmluZGV4KHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LmNvbnRhY3RzLCBmdW5jdGlvbiAoY29udGFjdCkgeyByZXR1cm4gY29udGFjdC5jb250YWN0SWQ7IH0pLAogICAgICAgIHJlbW92ZWQ6IHt9LAogICAgICAgIGNvbW1vbjoge30sCiAgICAgICAgb2xkTWFwOiB7fSwKICAgICAgICBuZXdNYXA6IGNvbm5lY3QuaW5kZXgodGhpcy5hZ2VudERhdGEuc25hcHNob3QuY29udGFjdHMsIGZ1bmN0aW9uIChjb250YWN0KSB7IHJldHVybiBjb250YWN0LmNvbnRhY3RJZDsgfSkKICAgICAgfTsKICAgIH0KIAogICAgY29ubmVjdC52YWx1ZXMoZGlmZi5hZGRlZCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LkNvbnRhY3RFdmVudHMuSU5JVCwgbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0RGF0YS5jb250YWN0SWQpKTsKICAgICAgc2VsZi5fZmlyZUNvbnRhY3RVcGRhdGVFdmVudHMoY29udGFjdERhdGEuY29udGFjdElkLCBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuSU5JVCwgY29udGFjdERhdGEuc3RhdGUudHlwZSk7CiAgICB9KTsKIAogICAgY29ubmVjdC52YWx1ZXMoZGlmZi5yZW1vdmVkKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0RGF0YSkgewogICAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5ERVNUUk9ZRUQsIG5ldyBjb25uZWN0LkNvbnRhY3RTbmFwc2hvdChjb250YWN0RGF0YSkpOwogICAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5ERVNUUk9ZRUQsIGNvbnRhY3REYXRhLmNvbnRhY3RJZCksIG5ldyBjb25uZWN0LkNvbnRhY3RTbmFwc2hvdChjb250YWN0RGF0YSkpOwogICAgICBzZWxmLl91bnN1YkFsbENvbnRhY3RFdmVudHNGb3JDb250YWN0KGNvbnRhY3REYXRhLmNvbnRhY3RJZCk7CiAgICB9KTsKIAogICAgY29ubmVjdC5rZXlzKGRpZmYuY29tbW9uKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgICAgc2VsZi5fZmlyZUNvbnRhY3RVcGRhdGVFdmVudHMoY29udGFjdElkLCBkaWZmLm9sZE1hcFtjb250YWN0SWRdLnN0YXRlLnR5cGUsIGRpZmYubmV3TWFwW2NvbnRhY3RJZF0uc3RhdGUudHlwZSk7CiAgICB9KTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLl9maXJlQ29udGFjdFVwZGF0ZUV2ZW50cyA9IGZ1bmN0aW9uIChjb250YWN0SWQsIG9sZENvbnRhY3RTdGF0ZSwgbmV3Q29udGFjdFN0YXRlKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZiAob2xkQ29udGFjdFN0YXRlICE9PSBuZXdDb250YWN0U3RhdGUpIHsKICAgICAgY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudEdyYXBoKCkuZ2V0QXNzb2NpYXRpb25zKHRoaXMsIG9sZENvbnRhY3RTdGF0ZSwgbmV3Q29udGFjdFN0YXRlKS5mb3JFYWNoKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHNlbGYuYnVzLnRyaWdnZXIoZXZlbnQsIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKSk7CiAgICAgICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShldmVudCwgY29udGFjdElkKSwgbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0SWQpKTsKICAgICAgfSk7CiAgICB9CiAKICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5Db250YWN0RXZlbnRzLlJFRlJFU0gsIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKSk7CiAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5SRUZSRVNILCBjb250YWN0SWQpLCBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkpOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuX3Vuc3ViQWxsQ29udGFjdEV2ZW50c0ZvckNvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBjb25uZWN0LnZhbHVlcyhjb25uZWN0LkNvbnRhY3RFdmVudHMpLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgICBzZWxmLmJ1cy5nZXRTdWJzY3JpcHRpb25zKGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGV2ZW50TmFtZSwgY29udGFjdElkKSkKICAgICAgICAubWFwKGZ1bmN0aW9uIChzdWIpIHsgc3ViLnVuc3Vic2NyaWJlKCk7IH0pOwogICAgfSk7CiAgfTsKIAogIC8qKiAtLS0tLSBtaW5pbWFsIHZpZXcgbGF5ZXIgZXZlbnQgaGFuZGxpbmcgKiovCiAKICBjb25uZWN0LmNvcmUub25WaWV3Q29udGFjdCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5WSUVXLCBmKTsKICB9OwogCiAgLyoqCiAgICogVXNlZCBvZiBhZ2VudCBpbnRlcmZhY2UgY29udHJvbC4gCiAgICogY29ubmVjdC5jb3JlLnZpZXdDb250YWN0KCJjb250YWN0SWQiKSAtPiAgdGhpcyBpcyBjdXJlbnRseSBwcm9ncmFtbWVkIHRvIGdldCB0aGUgY29udGFjdCBpbnRvIHZpZXcuCiAgICovCiAgY29ubmVjdC5jb3JlLnZpZXdDb250YWN0ID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db250YWN0RXZlbnRzLlZJRVcsCiAgICAgIGRhdGE6IHsKICAgICAgICBjb250YWN0SWQ6IGNvbnRhY3RJZAogICAgICB9CiAgICB9KTsKICB9OwogCiAgLyoqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KIAogIC8qKgogICogVGhpcyB3aWxsIGJlIGhlbHBmdWwgZm9yIHRoZSBjdXN0b20gYW5kIGVtYmVkZGVkIENDUHMgCiAgKiB0byBoYW5kbGUgdGhlIGFjY2VzcyBkZW5pZWQgdXNlIGNhc2UuIAogICovCiAgY29ubmVjdC5jb3JlLm9uQWNjZXNzRGVuaWVkID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNDRVNTX0RFTklFRCwgZik7CiAgfTsKIAogIC8qKgogICogVGhpcyB3aWxsIGJlIGhlbHBmdWwgZm9yIFNBTUwgdXNlIGNhc2VzIHRvIGhhbmRsZSB0aGUgY3VzdG9tIGxvZ2lucy4gCiAgKi8KICBjb25uZWN0LmNvcmUub25BdXRoRmFpbCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhfRkFJTCwgZik7CiAgfTsKIAogIC8qKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCiAKICAvKioKICAgKiBVc2VkIGZvciBoYW5kbGluZyB0aGUgcnRjIHNlc3Npb24gc3RhdHMuCiAgICogVXNhZ2UKICAgKiBjb25uZWN0LmNvcmUub25Tb2Z0cGhvbmVTZXNzaW9uSW5pdChmdW5jdGlvbih7IGNvbm5lY3Rpb25JZCB9KSB7CiAgICogICAgIHZhciBzb2Z0cGhvbmVNYW5hZ2VyID0gY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZU1hbmFnZXIoKTsKICAgKiAgICAgaWYoc29mdHBob25lTWFuYWdlcil7CiAgICogICAgICAgIC8vIGFjY2VzcyBzZXNzaW9uCiAgICogICAgICAgIHZhciBzZXNzaW9uID0gc29mdHBob25lTWFuYWdlci5nZXRTZXNzaW9uKGNvbm5lY3Rpb25JZCk7IAogICAqICAgICAgfQogICAqIH0pOwogICAqLwogCiAgY29ubmVjdC5jb3JlLm9uU29mdHBob25lU2Vzc2lvbkluaXQgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkNvbm5uZWN0aW9uRXZlbnRzLlNFU1NJT05fSU5JVCwgZik7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZSA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGNvbnRhY3RJZCkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbnRhY3RJZCwgJ2NvbnRhY3RJZCcpOwogICAgaWYgKCFjb25uZWN0LmNvbnRhaW5zKGNvbm5lY3QudmFsdWVzKGNvbm5lY3QuQ29udGFjdEV2ZW50cyksIGV2ZW50TmFtZSkpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuVmFsdWVFcnJvcignJXMgaXMgbm90IGEgdmFsaWQgY29udGFjdCBldmVudC4nLCBldmVudE5hbWUpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3Quc3ByaW50ZignJXM6OiVzJywgZXZlbnROYW1lLCBjb250YWN0SWQpOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5ldmVudEJ1czsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRXZWJTb2NrZXRNYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS53ZWJTb2NrZXRQcm92aWRlcjsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuYWdlbnREYXRhUHJvdmlkZXI7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0TG9jYWxUaW1lc3RhbXAgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0QWdlbnREYXRhKCkuc25hcHNob3QubG9jYWxUaW1lc3RhbXA7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0U2tldyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBZ2VudERhdGEoKS5zbmFwc2hvdC5za2V3OwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldEFnZW50Um91dGluZ0V2ZW50R3JhcGggPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmFnZW50Um91dGluZ0V2ZW50R3JhcGg7CiAgfTsKICBjb25uZWN0LmNvcmUuYWdlbnRSb3V0aW5nRXZlbnRHcmFwaCA9IG5ldyBjb25uZWN0LkV2ZW50R3JhcGgoKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUuUk9VVEFCTEUsCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuUk9VVEFCTEUpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwgY29ubmVjdC5BZ2VudFN0YXRlVHlwZS5OT1RfUk9VVEFCTEUsCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuTk9UX1JPVVRBQkxFKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUuT0ZGTElORSwKICAgICAgY29ubmVjdC5BZ2VudEV2ZW50cy5PRkZMSU5FKTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRTdGF0ZUV2ZW50R3JhcGggPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmFnZW50U3RhdGVFdmVudEdyYXBoOwogIH07CiAgY29ubmVjdC5jb3JlLmFnZW50U3RhdGVFdmVudEdyYXBoID0gbmV3IGNvbm5lY3QuRXZlbnRHcmFwaCgpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC52YWx1ZXMoY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzKSwKICAgICAgY29ubmVjdC5BZ2VudEV2ZW50cy5FUlJPUikKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLCBjb25uZWN0LkFnZW50QXZhaWxTdGF0ZXMuQUZURVJfQ0FMTF9XT1JLLAogICAgICBjb25uZWN0LkFnZW50RXZlbnRzLkFDVyk7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudEdyYXBoID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5jb250YWN0RXZlbnRHcmFwaDsKICB9OwogCiAgY29ubmVjdC5jb3JlLmNvbnRhY3RFdmVudEdyYXBoID0gbmV3IGNvbm5lY3QuRXZlbnRHcmFwaCgpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLklOQ09NSU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuSU5DT01JTkcpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLlBFTkRJTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5QRU5ESU5HKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5DT05ORUNUSU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuQ09OTkVDVElORykKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuQ09OTkVDVEVELAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuQ09OTkVDVEVEKQogICAgLmFzc29jKGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5DT05ORUNUSU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuRVJST1IsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpCiAgICAuYXNzb2MoY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLklOQ09NSU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuRVJST1IsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkVOREVELAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNXKQogICAgLmFzc29jKGNvbm5lY3QudmFsdWVzKGNvbm5lY3QuQ09OVEFDVF9BQ1RJVkVfU1RBVEVTKSwKICAgICAgY29ubmVjdC52YWx1ZXMoY29ubmVjdC5yZWxhdGl2ZUNvbXBsZW1lbnQoY29ubmVjdC5DT05UQUNUX0FDVElWRV9TVEFURVMsIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZSkpLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuRU5ERUQpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC52YWx1ZXMoY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzKSwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLkVSUk9SKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRDbGllbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS5jbGllbnQpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignVGhlIGNvbm5lY3QgY29yZSBoYXMgbm90IGJlZW4gaW5pdGlhbGl6ZWQhJyk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmNsaWVudDsKICB9OwogIGNvbm5lY3QuY29yZS5jbGllbnQgPSBudWxsOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRNYXN0ZXJDbGllbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignVGhlIGNvbm5lY3QgbWFzdGVyIGNsaWVudCBoYXMgbm90IGJlZW4gaW5pdGlhbGl6ZWQhJyk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudDsKICB9OwogIGNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQgPSBudWxsOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVNYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyOwogIH07CiAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIgPSBudWxsOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXROb3RpZmljYXRpb25NYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmNvcmUubm90aWZpY2F0aW9uTWFuYWdlcikgewogICAgICBjb25uZWN0LmNvcmUubm90aWZpY2F0aW9uTWFuYWdlciA9IG5ldyBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIoKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmNvcmUubm90aWZpY2F0aW9uTWFuYWdlcjsKICB9OwogIGNvbm5lY3QuY29yZS5ub3RpZmljYXRpb25NYW5hZ2VyID0gbnVsbDsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0UG9wdXBNYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5wb3B1cE1hbmFnZXI7CiAgfTsKICBjb25uZWN0LmNvcmUucG9wdXBNYW5hZ2VyID0gbmV3IGNvbm5lY3QuUG9wdXBNYW5hZ2VyKCk7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmNvcmUudXBzdHJlYW0pIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignVGhlcmUgaXMgbm8gdXBzdHJlYW0gY29uZHVpdCEnKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmNvcmUudXBzdHJlYW07CiAgfTsKICBjb25uZWN0LmNvcmUudXBzdHJlYW0gPSBudWxsOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5BZ2VudERhdGFQcm92aWRlciA9IEFnZW50RGF0YVByb3ZpZGVyOwogCn0pKCk7Ci8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICB2YXIgUmluZ3RvbmVFbmdpbmVCYXNlID0gZnVuY3Rpb24gKHJpbmd0b25lQ29uZmlnKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0aGlzLl9wcmV2Q29udGFjdElkID0gbnVsbDsKCiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmluZ3RvbmVDb25maWcsICJyaW5ndG9uZUNvbmZpZyIpOwogICAgaWYgKCFyaW5ndG9uZUNvbmZpZy5yaW5ndG9uZVVybCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoInJpbmd0b25lVXJsIGlzIHJlcXVpcmVkISIpOwogICAgfQoKICAgIGlmIChnbG9iYWwuQXVkaW8gJiYgdHlwZW9mIGdsb2JhbC5Qcm9taXNlICE9PSAidW5kZWZpbmVkIikgewogICAgICB0aGlzLl9wbGF5YWJsZUF1ZGlvUHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBzZWxmLl9hdWRpbyA9IG5ldyBBdWRpbyhyaW5ndG9uZUNvbmZpZy5yaW5ndG9uZVVybCk7CiAgICAgICAgc2VsZi5fYXVkaW8ubG9vcCA9IHRydWU7CiAgICAgICAgc2VsZi5fYXVkaW8uYWRkRXZlbnRMaXN0ZW5lcigiY2FucGxheSIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHNlbGYuX2F1ZGlvUGxheWFibGUgPSB0cnVlOwogICAgICAgICAgcmVzb2x2ZShzZWxmLl9hdWRpbyk7CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2F1ZGlvID0gbnVsbDsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiVW5hYmxlIHRvIHByb3ZpZGUgYSByaW5ndG9uZS4iKTsKICAgIH0KCiAgICBzZWxmLl9kcml2ZVJpbmd0b25lKCk7CiAgfTsKCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5fZHJpdmVSaW5ndG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRocm93IG5ldyBFcnJvcigiTm90IGltcGxlbWVudGVkLiIpOwogIH07CgogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuX3N0YXJ0UmluZ3RvbmUgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgaWYgKHRoaXMuX2F1ZGlvKSB7CiAgICAgIHRoaXMuX2F1ZGlvLnBsYXkoKTsKICAgICAgdGhpcy5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJSaW5ndG9uZSBTdGFydCIsIGNvbnRhY3QpOwogICAgfQogIH07CgogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuX3N0b3BSaW5ndG9uZSA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICBpZiAodGhpcy5fYXVkaW8pIHsKICAgICAgdGhpcy5fYXVkaW8ucGF1c2UoKTsKICAgICAgdGhpcy5fYXVkaW8uY3VycmVudFRpbWUgPSAwOwogICAgICB0aGlzLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlJpbmd0b25lIFN0b3AiLCBjb250YWN0KTsKICAgIH0KICB9OwoKICAvKioKICAgKiBTdG9wIHJpbmd0b25lLgogICAqLwogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuc3RvcFJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5fc3RvcFJpbmd0b25lKCk7CiAgfTsKCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5fcmluZ3RvbmVTZXR1cCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlJJTkdUT05FLCBmdW5jdGlvbiAoKSB7CiAgICAgIHNlbGYuX3N0YXJ0UmluZ3RvbmUoY29udGFjdCk7CiAgICAgIHNlbGYuX3ByZXZDb250YWN0SWQgPSBjb250YWN0LmdldENvbnRhY3RJZCgpOwoKICAgICAgY29udGFjdC5vbkNvbm5lY3RlZChsaWx5LmhpdGNoKHNlbGYsIHNlbGYuX3N0b3BSaW5ndG9uZSkpOwogICAgICBjb250YWN0Lm9uQWNjZXB0ZWQobGlseS5oaXRjaChzZWxmLCBzZWxmLl9zdG9wUmluZ3RvbmUpKTsKICAgICAgY29udGFjdC5vbkVuZGVkKGxpbHkuaGl0Y2goc2VsZiwgc2VsZi5fc3RvcFJpbmd0b25lKSk7CiAgICAgIC8vIEp1c3QgdG8gbWFrZSBzdXJlIHRvIHN0b3AgdGhlIHJpbmd0b25lIGluIGNhc2Ugb2YgdGhlIGZhaWx1cmVzIG9mIHNwZWNpZmljIGNhbGxiYWNrcyhvbkFjY2VwdGVkLG9uQ29ubmVjdGVkKTsKICAgICAgY29udGFjdC5vblJlZnJlc2goZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICBpZiAoY29udGFjdC5nZXRTdGF0dXMoKS50eXBlICE9PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkNPTk5FQ1RJTkcgJiYKICAgICAgICAgIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSAhPT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5JTkNPTUlORykgewogICAgICAgICAgc2VsZi5fc3RvcFJpbmd0b25lKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH07CgogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGNvbnRhY3QpIHsKICAgIGlmIChjb250YWN0ICYmIGNvbnRhY3QuZ2V0Q29udGFjdElkKCkpIHsKICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICBuYW1lOiBldmVudE5hbWUsCiAgICAgICAgY29udGFjdElkOiBjb250YWN0LmdldENvbnRhY3RJZCgpCiAgICAgIH0pOwogICAgfQogIH07CgogIC8qKgogICAqIENoYW5nZSB0aGUgYXVkaW8gZGV2aWNlIHVzZWQgdG8gcGxheSByaW5ndG9uZS4KICAgKiBJZiBhdWRpbyBlbGVtZW50IGlzIG5vdCBmdWxseSBpbml0aWFsaXplZCwgdGhlIEFQSSB3aWxsIHdhaXQgX2F1ZGlvUGxheWFibGVQcm9taXNlIGZvciAzIHNlY29uZHMgYW5kIGZhaWwgb24gdGltZW91dC4KICAgKiBUaGlzIEFQSSBpcyBzdXBwb3J0ZWQgb25seSBieSBicm93c2VycyB0aGF0IGltcGxlbWVudGVkIEVTNiBQcm9taXNlIGFuZCBodHRwOi8vd3d3LnczLm9yZy9UUi9hdWRpby1vdXRwdXQvCiAgICogUmV0dXJuIGEgUHJvbWlzZSB0aGF0IGluZGljYXRlcyB0aGUgcmVzdWx0IG9mIGNoYW5naW5nIG91dHB1dCBkZXZpY2UuCiAgICovCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5zZXRPdXRwdXREZXZpY2UgPSBmdW5jdGlvbiAoZGV2aWNlSWQpIHsKICAgIGlmICh0aGlzLl9wbGF5YWJsZUF1ZGlvUHJvbWlzZSkgewogICAgICB2YXIgcGxheWFibGVBdWRpb1dpdGhUaW1lb3V0ID0gUHJvbWlzZS5yYWNlKFsKICAgICAgICB0aGlzLl9wbGF5YWJsZUF1ZGlvUHJvbWlzZSwKICAgICAgICBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7IHJlamVjdCgiVGltZWQgb3V0IHdhaXRpbmcgZm9yIHBsYXlhYmxlIGF1ZGlvIik7IH0sIDMwMDAvKm1zKi8pOwogICAgICAgIH0pCiAgICAgIF0pOwogICAgICByZXR1cm4gcGxheWFibGVBdWRpb1dpdGhUaW1lb3V0LnRoZW4oZnVuY3Rpb24gKGF1ZGlvKSB7CiAgICAgICAgaWYgKGF1ZGlvLnNldFNpbmtJZCkgewogICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShhdWRpby5zZXRTaW5rSWQoZGV2aWNlSWQpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJOb3Qgc3VwcG9ydGVkIik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBpZiAoZ2xvYmFsLlByb21pc2UpIHsKICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJOb3QgZWxpZ2libGUgcmluZ3RvbmUgb3duZXIiKTsKICAgIH0KICB9OwoKICB2YXIgVm9pY2VSaW5ndG9uZUVuZ2luZSA9IGZ1bmN0aW9uIChyaW5ndG9uZUNvbmZpZykgewogICAgUmluZ3RvbmVFbmdpbmVCYXNlLmNhbGwodGhpcywgcmluZ3RvbmVDb25maWcpOwogIH07CiAgVm9pY2VSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUpOwogIFZvaWNlUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVm9pY2VSaW5ndG9uZUVuZ2luZTsKCiAgVm9pY2VSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdmFyIG9uQ29udGFjdENvbm5lY3QgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBpZiAoY29udGFjdC5nZXRUeXBlKCkgPT09IGxpbHkuQ29udGFjdFR5cGUuVk9JQ0UgJiYKICAgICAgICBjb250YWN0LmlzU29mdHBob25lQ2FsbCgpICYmIGNvbnRhY3QuaXNJbmJvdW5kKCkpIHsKICAgICAgICBzZWxmLl9yaW5ndG9uZVNldHVwKGNvbnRhY3QpOwogICAgICAgIHNlbGYuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiUmluZ3RvbmUgQ29ubmVjdGluZyIsIGNvbnRhY3QpOwogICAgICB9CiAgICB9OwoKICAgIGNvbm5lY3QuY29udGFjdChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBjb250YWN0Lm9uQ29ubmVjdGluZyhvbkNvbnRhY3RDb25uZWN0KTsKICAgIH0pOwoKICAgIG5ldyBjb25uZWN0LkFnZW50KCkuZ2V0Q29udGFjdHMoKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGlmIChjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuQ09OTkVDVElORykgewogICAgICAgIG9uQ29udGFjdENvbm5lY3QoY29udGFjdCk7CiAgICAgIH0KICAgIH0pOwogIH07CgoKICB2YXIgQ2hhdFJpbmd0b25lRW5naW5lID0gZnVuY3Rpb24gKHJpbmd0b25lQ29uZmlnKSB7CiAgICBSaW5ndG9uZUVuZ2luZUJhc2UuY2FsbCh0aGlzLCByaW5ndG9uZUNvbmZpZyk7CiAgfTsKICBDaGF0UmluZ3RvbmVFbmdpbmUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlKTsKICBDaGF0UmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQ2hhdFJpbmd0b25lRW5naW5lOwoKICBDaGF0UmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLl9kcml2ZVJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHZhciBvbkNvbnRhY3RDb25uZWN0ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgaWYgKGNvbnRhY3QuZ2V0VHlwZSgpID09PSBsaWx5LkNvbnRhY3RUeXBlLkNIQVQgJiYgY29udGFjdC5pc0luYm91bmQoKSkgewogICAgICAgIHNlbGYuX3Jpbmd0b25lU2V0dXAoY29udGFjdCk7CiAgICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDaGF0IFJpbmd0b25lIENvbm5lY3RpbmciLCBjb250YWN0KTsKICAgICAgfQogICAgfTsKCiAgICBjb25uZWN0LmNvbnRhY3QoZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgY29udGFjdC5vbkNvbm5lY3Rpbmcob25Db250YWN0Q29ubmVjdCk7CiAgICB9KTsKICB9OwoKICB2YXIgVGFza1Jpbmd0b25lRW5naW5lID0gZnVuY3Rpb24gKHJpbmd0b25lQ29uZmlnKSB7CiAgICBSaW5ndG9uZUVuZ2luZUJhc2UuY2FsbCh0aGlzLCByaW5ndG9uZUNvbmZpZyk7CiAgfTsKICBUYXNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlKTsKICBUYXNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVGFza1Jpbmd0b25lRW5naW5lOwoKICBUYXNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLl9kcml2ZVJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHZhciBvbkNvbnRhY3RDb25uZWN0ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgaWYgKGNvbnRhY3QuZ2V0VHlwZSgpID09PSBsaWx5LkNvbnRhY3RUeXBlLlRBU0sgJiYgY29udGFjdC5pc0luYm91bmQoKSkgewogICAgICAgIHNlbGYuX3Jpbmd0b25lU2V0dXAoY29udGFjdCk7CiAgICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJUYXNrIFJpbmd0b25lIENvbm5lY3RpbmciLCBjb250YWN0KTsKICAgICAgfQogICAgfTsKCiAgICBjb25uZWN0LmNvbnRhY3QoZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgY29udGFjdC5vbkNvbm5lY3Rpbmcob25Db250YWN0Q29ubmVjdCk7CiAgICB9KTsKICB9OwoKCiAgdmFyIFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZSA9IGZ1bmN0aW9uIChyaW5ndG9uZUNvbmZpZykgewogICAgUmluZ3RvbmVFbmdpbmVCYXNlLmNhbGwodGhpcywgcmluZ3RvbmVDb25maWcpOwogIH07CiAgUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZSk7CiAgUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZTsKCiAgUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lLnByb3RvdHlwZS5fZHJpdmVSaW5ndG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBjb25uZWN0LmNvbnRhY3QoZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgY29udGFjdC5vbkluY29taW5nKGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoY29udGFjdC5nZXRUeXBlKCkgPT09IGxpbHkuQ29udGFjdFR5cGUuUVVFVUVfQ0FMTEJBQ0spIHsKICAgICAgICAgIHNlbGYuX3Jpbmd0b25lU2V0dXAoY29udGFjdCk7CiAgICAgICAgICBzZWxmLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNhbGxiYWNrIFJpbmd0b25lIENvbm5lY3RpbmciLCBjb250YWN0KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgLyogZXhwb3J0IGNvbm5lY3QuUmluZ3RvbmVFbmdpbmUgKi8KICBjb25uZWN0LlZvaWNlUmluZ3RvbmVFbmdpbmUgPSBWb2ljZVJpbmd0b25lRW5naW5lOwogIGNvbm5lY3QuQ2hhdFJpbmd0b25lRW5naW5lID0gQ2hhdFJpbmd0b25lRW5naW5lOwogIGNvbm5lY3QuVGFza1Jpbmd0b25lRW5naW5lID0gVGFza1Jpbmd0b25lRW5naW5lOwogIGNvbm5lY3QuUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lID0gUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lOwp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKICBnbG9iYWwuY2NwVmVyc2lvbiA9ICJWMiI7CgogIHZhciBSVFBKb2JJbnRlcnZhbE1zID0gMTAwMDsKICB2YXIgc3RhdHNSZXBvcnRpbmdKb2JJbnRlcnZhbE1zID0gMzAwMDA7CiAgdmFyIHN0cmVhbUJ1ZmZlclNpemUgPSA1MDA7CiAgdmFyIENhbGxUeXBlTWFwID0ge307CiAgQ2FsbFR5cGVNYXBbY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZS5BVURJT19PTkxZXSA9ICdBdWRpbyc7CiAgQ2FsbFR5cGVNYXBbY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZS5WSURFT19PTkxZXSA9ICdWaWRlbyc7CiAgQ2FsbFR5cGVNYXBbY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZS5BVURJT19WSURFT10gPSAnQXVkaW9WaWRlbyc7CiAgQ2FsbFR5cGVNYXBbY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZS5OT05FXSA9ICdOb25lJzsKICB2YXIgQVVESU9fSU5QVVQgPSAnYXVkaW9faW5wdXQnOwogIHZhciBBVURJT19PVVRQVVQgPSAnYXVkaW9fb3V0cHV0JzsKCiAgdmFyIE1lZGlhVHlwZU1hcCA9IHt9OwogIE1lZGlhVHlwZU1hcFtjb25uZWN0LkNvbnRhY3RUeXBlLlZPSUNFXSA9ICJWb2ljZSI7CiAgdmFyIFVOS05PV05fTUVESUFfVFlQRSA9ICJVbmtub3duIjsKCiAgdmFyIHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlciA9IFtdOwogIHZhciBhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHMgPSB7fTsKICB2YXIgYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHMgPSB7fTsKICB2YXIgcnRwU3RhdHNKb2IgPSBudWxsOwogIHZhciByZXBvcnRTdGF0c0pvYiA9IG51bGw7CiAgLy9Mb2dnZXIgc3BlY2lmaWMgdG8gc29mdHBob25lLgogIHZhciBsb2dnZXIgPSBudWxsOwogIHZhciBTb2Z0cGhvbmVFcnJvclR5cGVzID0gY29ubmVjdC5Tb2Z0cGhvbmVFcnJvclR5cGVzOwogIHZhciBIQU5HX1VQX01VTFRJUExFX1NFU1NJT05TX0VWRU5UID0gIk11bHRpU2Vzc2lvbkhhbmdVcCI7CiAgdmFyIE1VTFRJUExFX1NFU1NJT05TX0VWRU5UID0gIk11bHRpU2Vzc2lvbnMiOwoKICB2YXIgbG9jYWxNZWRpYVN0cmVhbSA9IHt9OwoKICB2YXIgc29mdHBob25lQ2xpZW50SWQgPSBjb25uZWN0LnJhbmRvbUlkKCk7CgogIHZhciByZXF1ZXN0SWNlQWNjZXNzID0gZnVuY3Rpb24gKHRyYW5zcG9ydCkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY29ubmVjdC5jb3JlLmdldENsaWVudCgpLmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNSRUFURV9UUkFOU1BPUlQsIHRyYW5zcG9ydCwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICByZXNvbHZlKGRhdGEuc29mdHBob25lVHJhbnNwb3J0LnNvZnRwaG9uZU1lZGlhQ29ubmVjdGlvbnMpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgaWYgKHJlYXNvbi5tZXNzYWdlICYmIHJlYXNvbi5tZXNzYWdlLmluY2x1ZGVzKCJTb2Z0cGhvbmVDb25uZWN0aW9uTGltaXRCcmVhY2hlZEV4Y2VwdGlvbiIpKSB7CiAgICAgICAgICAgIHB1Ymxpc2hFcnJvcigibXVsdGlwbGVfc29mdHBob25lX2FjdGl2ZV9zZXNzaW9ucyIsICJOdW1iZXIgb2YgYWN0aXZlIHNlc3Npb25zIGFyZSBtb3JlIHRoZW4gYWxsb3dlZCBsaW1pdC4iLCAiIik7CiAgICAgICAgICB9CiAgICAgICAgICByZWplY3QoRXJyb3IoInJlcXVlc3RJY2VBY2Nlc3MgZmFpbGVkIikpOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJlamVjdChFcnJvcigiQXV0aGVudGljYXRpb24gZmFpbGVkIHdoaWxlIHJlcXVlc3RJY2VBY2Nlc3MiKSk7CiAgICAgICAgfSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJlamVjdChFcnJvcigiQWNjZXNzIERlbmllZCB3aGlsZSByZXF1ZXN0SWNlQWNjZXNzIikpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICB2YXIgU29mdHBob25lTWFuYWdlciA9IGZ1bmN0aW9uIChzb2Z0cGhvbmVQYXJhbXMpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGxvZ2dlciA9IG5ldyBTb2Z0cGhvbmVMb2dnZXIoY29ubmVjdC5nZXRMb2coKSk7CiAgICB2YXIgcnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5OwogICAgaWYgKGNvbm5lY3QuUnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5KSB7CiAgICAgIHJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeSA9IG5ldyBjb25uZWN0LlJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeShsb2dnZXIsCiAgICAgICAgY29ubmVjdC5jb3JlLmdldFdlYlNvY2tldE1hbmFnZXIoKSwKICAgICAgICBzb2Z0cGhvbmVDbGllbnRJZCwKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHJlcXVlc3RJY2VBY2Nlc3MsIHsKICAgICAgICAgIHRyYW5zcG9ydFR5cGU6ICJzb2Z0cGhvbmUiLAogICAgICAgICAgc29mdHBob25lQ2xpZW50SWQ6IHNvZnRwaG9uZUNsaWVudElkCiAgICAgICAgfSksCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBwdWJsaXNoRXJyb3IpKTsKICAgIH0KICAgIGlmICghaXNCcm93c2VyU29mdFBob25lU3VwcG9ydGVkKCkpIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuVU5TVVBQT1JURURfQlJPV1NFUiwKICAgICAgICAiQ29ubmVjdCBkb2VzIG5vdCBzdXBwb3J0IHRoaXMgYnJvd3Nlci4gU29tZSBmdW5jdGlvbmFsaXR5IG1heSBub3Qgd29yay4gIiwKICAgICAgICAiIik7CiAgICB9CiAgICB2YXIgZ3VtUHJvbWlzZSA9IGZldGNoVXNlck1lZGlhKHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKHN0cmVhbSkgewogICAgICAgIGlmIChjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIoKSkgewogICAgICAgICAgY29ubmVjdC5jb3JlLnNldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbShzdHJlYW0pOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgIHB1Ymxpc2hFcnJvcihlcnIsICJZb3VyIG1pY3JvcGhvbmUgaXMgbm90IGVuYWJsZWQgaW4geW91ciBicm93c2VyLiAiLCAiIik7CiAgICAgIH0KICAgIH0pOwogICAgaGFuZGxlU29mdFBob25lTXV0ZVRvZ2dsZSgpOwoKICAgIHRoaXMucmluZ3RvbmVFbmdpbmUgPSBudWxsOwogICAgdmFyIGNsZWFuTXVsdGlwbGVTZXNzaW9ucyA9ICd0cnVlJyA9PT0gc29mdHBob25lUGFyYW1zLmNsZWFuTXVsdGlwbGVTZXNzaW9uczsKICAgIHZhciBydGNTZXNzaW9ucyA9IHt9OwogICAgLy8gVHJhY2tzIHRoZSBhZ2VudCBjb25uZWN0aW9uIElELCBzbyB0aGF0IGlmIHRoZSBzYW1lIGNvbnRhY3QgZ2V0cyByZS1yb3V0ZWQgdG8gdGhlIHNhbWUgYWdlbnQsIGl0J2xsIHN0aWxsIHNldCB1cCBzb2Z0cGhvbmUKICAgIHZhciBjYWxsc0RldGVjdGVkID0ge307CgogICAgLy8gaGVscGVyIG1ldGhvZCB0byBwcm92aWRlIGFjY2VzcyB0byBydGMgc2Vzc2lvbnMKICAgIHRoaXMuZ2V0U2Vzc2lvbiA9IGZ1bmN0aW9uIChjb25uZWN0aW9uSWQpIHsKICAgICAgcmV0dXJuIHJ0Y1Nlc3Npb25zW2Nvbm5lY3Rpb25JZF07CiAgICB9CgogICAgdmFyIGlzQ29udGFjdFRlcm1pbmF0ZWQgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICByZXR1cm4gY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkVOREVEIHx8CiAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkVSUk9SIHx8CiAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLk1JU1NFRDsKICAgIH07CgogICAgdmFyIGRlc3Ryb3lTZXNzaW9uID0gZnVuY3Rpb24gKGFnZW50Q29ubmVjdGlvbklkKSB7CiAgICAgIGlmIChydGNTZXNzaW9ucy5oYXNPd25Qcm9wZXJ0eShhZ2VudENvbm5lY3Rpb25JZCkpIHsKICAgICAgICB2YXIgc2Vzc2lvbiA9IHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICAvLyBDdXJyZW50bHkgdGhlIGFzc3VtcHRpb24gaXMgaXQgd2lsbCB0aHJvdyBhbiBleGNlcHRpb24gb25seSBhbmQgaWYgb25seSBpdCBhbHJlYWR5IGhhcyBiZWVuIGh1bmcgdXAuCiAgICAgICAgLy8gVE9ETzogVXBkYXRlIG9uY2UgdGhlIGhhbmd1cCBBUEkgZG9lcyBub3QgdGhyb3cgZXhjZXB0aW9ucwogICAgICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIGRlbGV0ZSBydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgICBkZWxldGUgY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgICBzZXNzaW9uLmhhbmd1cCgpOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgIGxpbHkuZ2V0TG9nKCkud2FybigiQ2xlYW4gdXAgdGhlIHNlc3Npb24gbG9jYWxseSAiICsgYWdlbnRDb25uZWN0aW9uSWQsIGVyci5tZXNzYWdlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKCiAgICAvLyBXaGVuIGZlYXR1cmUgYWNjZXNzIGNvbnRyb2wgZmxhZyBpcyBvbiwgaWdub3JlIHRoZSBuZXcgY2FsbCBhbmQgaGFuZyB1cCB0aGUgcHJldmlvdXMgc2Vzc2lvbnMuCiAgICAvLyBPdGhlcndpc2UganVzdCBsb2cgdGhlIGNvbnRhY3QgYW5kIGFnZW50IGluIHRoZSBjbGllbnQgc2lkZSBtZXRyaWNzLgogICAgLy8gVE9ETzogVXBkYXRlIHdoZW4gY29ubmVjdC1ydGMgZXhwb3NlcyBhbiBBUEkgdG8gZGV0ZWN0IHNlc3Npb24gc3RhdHVzLgogICAgdmFyIHNhbml0eUNoZWNrQWN0aXZlU2Vzc2lvbnMgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbnMpIHsKICAgICAgaWYgKE9iamVjdC5rZXlzKHJ0Y1Nlc3Npb25zKS5sZW5ndGggPiAwKSB7CiAgICAgICAgaWYgKGNsZWFuTXVsdGlwbGVTZXNzaW9ucykgewogICAgICAgICAgLy8gRXJyb3IhIG91ciBzdGF0ZSBkb2Vzbid0IG1hdGNoLCB0ZWFyIGl0IGFsbCBkb3duLgogICAgICAgICAgZm9yICh2YXIgY29ubmVjdGlvbklkIGluIHJ0Y1Nlc3Npb25zKSB7CiAgICAgICAgICAgIGlmIChydGNTZXNzaW9ucy5oYXNPd25Qcm9wZXJ0eShjb25uZWN0aW9uSWQpKSB7CiAgICAgICAgICAgICAgLy8gTG9nIGFuIGVycm9yIGZvciB0aGUgc2Vzc2lvbiB3ZSBhcmUgYWJvdXQgdG8ga2lsbC4KICAgICAgICAgICAgICBwdWJsaXNoTXVsdGlwbGVTZXNzaW9uc0V2ZW50KEhBTkdfVVBfTVVMVElQTEVfU0VTU0lPTlNfRVZFTlQsIHJ0Y1Nlc3Npb25zW2Nvbm5lY3Rpb25JZF0uY2FsbElkLCBjb25uZWN0aW9uSWQpOwogICAgICAgICAgICAgIGRlc3Ryb3lTZXNzaW9uKGNvbm5lY3Rpb25JZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZHVwbGljYXRlIHNlc3Npb24gZGV0ZWN0ZWQsIHJlZnVzaW5nIHRvIHNldHVwIG5ldyBjb25uZWN0aW9uIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAodmFyIF9jb25uZWN0aW9uSWQgaW4gcnRjU2Vzc2lvbnMpIHsKICAgICAgICAgICAgaWYgKHJ0Y1Nlc3Npb25zLmhhc093blByb3BlcnR5KF9jb25uZWN0aW9uSWQpKSB7CiAgICAgICAgICAgICAgcHVibGlzaE11bHRpcGxlU2Vzc2lvbnNFdmVudChNVUxUSVBMRV9TRVNTSU9OU19FVkVOVCwgcnRjU2Vzc2lvbnNbX2Nvbm5lY3Rpb25JZF0uY2FsbElkLCBfY29ubmVjdGlvbklkKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICB2YXIgb25SZWZyZXNoQ29udGFjdCA9IGZ1bmN0aW9uIChjb250YWN0LCBhZ2VudENvbm5lY3Rpb25JZCkgewogICAgICBpZiAocnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdICYmIGlzQ29udGFjdFRlcm1pbmF0ZWQoY29udGFjdCkpIHsKICAgICAgICBkZXN0cm95U2Vzc2lvbihhZ2VudENvbm5lY3Rpb25JZCk7CiAgICAgIH0KICAgICAgaWYgKGNvbnRhY3QuaXNTb2Z0cGhvbmVDYWxsKCkgJiYgIWNhbGxzRGV0ZWN0ZWRbYWdlbnRDb25uZWN0aW9uSWRdICYmICgKICAgICAgICBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuQ09OTkVDVElORyB8fAogICAgICAgIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5JTkNPTUlORykpIHsKCiAgICAgICAgLy8gU2V0IHRvIHRydWUsIHRoaXMgd2lsbCBibG9jayBzdWJzZXF1ZW50IGludm9rZXMgZnJvbSBlbnRlcmluZy4KICAgICAgICBjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXSA9IHRydWU7CiAgICAgICAgbG9nZ2VyLmluZm8oIlNvZnRwaG9uZSBjYWxsIGRldGVjdGVkOiIsICJjb250YWN0SWQgIiArIGNvbnRhY3QuZ2V0Q29udGFjdElkKCksICJhZ2VudCBjb25uZWN0aW9uSWQgIiArIGFnZW50Q29ubmVjdGlvbklkKTsKCiAgICAgICAgLy8gRW5zdXJlIG91ciBzZXNzaW9uIHN0YXRlIG1hdGNoZXMgb3VyIGNvbnRhY3Qgc3RhdGUgdG8gcHJldmVudCBpc3N1ZXMgc2hvdWxkIHdlIGxvc2UgdHJhY2sgb2YgYSBjb250YWN0LgogICAgICAgIHNhbml0eUNoZWNrQWN0aXZlU2Vzc2lvbnMocnRjU2Vzc2lvbnMpOwoKICAgICAgICBpZiAoY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkNPTk5FQ1RJTkcpIHsKICAgICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiU29mdHBob25lIENvbm5lY3RpbmciLCBjb250YWN0LmdldENvbnRhY3RJZCgpKTsKICAgICAgICB9CgogICAgICAgIGluaXRpYWxpemVQYXJhbXMoKTsKICAgICAgICB2YXIgc29mdHBob25lSW5mbyA9IGNvbnRhY3QuZ2V0QWdlbnRDb25uZWN0aW9uKCkuZ2V0U29mdHBob25lTWVkaWFJbmZvKCk7CiAgICAgICAgdmFyIGNhbGxDb25maWcgPSBwYXJzZUNhbGxDb25maWcoc29mdHBob25lSW5mby5jYWxsQ29uZmlnSnNvbik7CiAgICAgICAgdmFyIHdlYlNvY2tldFByb3ZpZGVyOwogICAgICAgIGlmIChjYWxsQ29uZmlnLnVzZVdlYlNvY2tldFByb3ZpZGVyKSB7CiAgICAgICAgICB3ZWJTb2NrZXRQcm92aWRlciA9IGNvbm5lY3QuY29yZS5nZXRXZWJTb2NrZXRNYW5hZ2VyKCk7CiAgICAgICAgfQogICAgICAgIHZhciBzZXNzaW9uID0gbmV3IGNvbm5lY3QuUlRDU2Vzc2lvbigKICAgICAgICAgIGNhbGxDb25maWcuc2lnbmFsaW5nRW5kcG9pbnQsCiAgICAgICAgICBjYWxsQ29uZmlnLmljZVNlcnZlcnMsCiAgICAgICAgICBzb2Z0cGhvbmVJbmZvLmNhbGxDb250ZXh0VG9rZW4sCiAgICAgICAgICBsb2dnZXIsCiAgICAgICAgICBjb250YWN0LmdldENvbnRhY3RJZCgpLAogICAgICAgICAgYWdlbnRDb25uZWN0aW9uSWQsCiAgICAgICAgICB3ZWJTb2NrZXRQcm92aWRlcik7CgogICAgICAgIHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXSA9IHNlc3Npb247CgogICAgICAgIGlmIChjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtKCkpIHsKICAgICAgICAgIHNlc3Npb24ubWVkaWFTdHJlYW0gPSBjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBDdXN0b20gRXZlbnQgdG8gaW5kaWNhdGUgdGhlIHNlc3Npb24gaW5pdCBvcGVyYXRpb25zCiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29ubm5lY3Rpb25FdmVudHMuU0VTU0lPTl9JTklULAogICAgICAgICAgZGF0YTogewogICAgICAgICAgICBjb25uZWN0aW9uSWQ6IGFnZW50Q29ubmVjdGlvbklkCiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHNlc3Npb24ub25TZXNzaW9uRmFpbGVkID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24sIHJlYXNvbikgewogICAgICAgICAgZGVsZXRlIHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICAgIGRlbGV0ZSBjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICAgIHB1Ymxpc2hTb2Z0cGhvbmVGYWlsdXJlTG9ncyhydGNTZXNzaW9uLCByZWFzb24pOwogICAgICAgICAgcHVibGlzaFNlc3Npb25GYWlsdXJlVGVsZW1ldHJ5RXZlbnQoY29udGFjdC5nZXRDb250YWN0SWQoKSwgcmVhc29uKTsKICAgICAgICAgIHN0b3BKb2JzQW5kUmVwb3J0KGNvbnRhY3QsIHJ0Y1Nlc3Npb24uc2Vzc2lvblJlcG9ydCk7CiAgICAgICAgfTsKICAgICAgICBzZXNzaW9uLm9uU2Vzc2lvbkNvbm5lY3RlZCA9IGZ1bmN0aW9uIChydGNTZXNzaW9uKSB7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlNvZnRwaG9uZSBTZXNzaW9uIENvbm5lY3RlZCIsIGNvbnRhY3QuZ2V0Q29udGFjdElkKCkpOwogICAgICAgICAgLy8gQmVjb21lIG1hc3RlciB0byBzZW5kIGxvZ3MsIHNpbmNlIHdlIG5lZWQgbG9ncyBmcm9tIHNvZnRwaG9uZSB0YWIuCiAgICAgICAgICBjb25uZWN0LmJlY29tZU1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TRU5EX0xPR1MpOwogICAgICAgICAgLy9zdGFydCBzdGF0cyBjb2xsZWN0aW9uIGFuZCByZXBvcnRpbmcgam9icwogICAgICAgICAgc3RhcnRTdGF0c0NvbGxlY3Rpb25Kb2IocnRjU2Vzc2lvbik7CiAgICAgICAgICBzdGFydFN0YXRzUmVwb3J0aW5nSm9iKGNvbnRhY3QpOwogICAgICAgICAgZmlyZUNvbnRhY3RBY2NlcHRlZEV2ZW50KGNvbnRhY3QpOwogICAgICAgIH07CgogICAgICAgIHNlc3Npb24ub25TZXNzaW9uQ29tcGxldGVkID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24pIHsKICAgICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiU29mdHBob25lIFNlc3Npb24gQ29tcGxldGVkIiwgY29udGFjdC5nZXRDb250YWN0SWQoKSk7CgogICAgICAgICAgZGVsZXRlIHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICAgIGRlbGV0ZSBjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICAgIC8vIFN0b3AgYWxsIGpvYnMgYW5kIHBlcmZvcm0gb25lIGxhc3Qgam9iLgogICAgICAgICAgc3RvcEpvYnNBbmRSZXBvcnQoY29udGFjdCwgcnRjU2Vzc2lvbi5zZXNzaW9uUmVwb3J0KTsKCiAgICAgICAgICAvLyBDbGVhbnVwIHRoZSBjYWNoZWQgc3RyZWFtcwogICAgICAgICAgZGVsZXRlTG9jYWxNZWRpYVN0cmVhbShhZ2VudENvbm5lY3Rpb25JZCk7CiAgICAgICAgfTsKCiAgICAgICAgc2Vzc2lvbi5vbkxvY2FsU3RyZWFtQWRkZWQgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbiwgc3RyZWFtKSB7CiAgICAgICAgICAvLyBDYWNoZSB0aGUgc3RyZWFtcyBmb3IgbXV0ZS91bm11dGUKICAgICAgICAgIGxvY2FsTWVkaWFTdHJlYW1bYWdlbnRDb25uZWN0aW9uSWRdID0gewogICAgICAgICAgICBzdHJlYW06IHN0cmVhbQogICAgICAgICAgfTsKICAgICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuQWdlbnRFdmVudHMuTE9DQUxfTUVESUFfU1RSRUFNX0NSRUFURUQsCiAgICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgICBjb25uZWN0aW9uSWQ6IGFnZW50Q29ubmVjdGlvbklkCiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIHNlc3Npb24ucmVtb3RlQXVkaW9FbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlbW90ZS1hdWRpbycpOwogICAgICAgIGlmIChydGNQZWVyQ29ubmVjdGlvbkZhY3RvcnkpIHsKICAgICAgICAgIHNlc3Npb24uY29ubmVjdChydGNQZWVyQ29ubmVjdGlvbkZhY3RvcnkuZ2V0KGNhbGxDb25maWcuaWNlU2VydmVycykpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZXNzaW9uLmNvbm5lY3QoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgdmFyIG9uSW5pdENvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICB2YXIgYWdlbnRDb25uZWN0aW9uSWQgPSBjb250YWN0LmdldEFnZW50Q29ubmVjdGlvbigpLmNvbm5lY3Rpb25JZDsKICAgICAgbG9nZ2VyLmluZm8oIkNvbnRhY3QgZGV0ZWN0ZWQ6IiwgImNvbnRhY3RJZCAiICsgY29udGFjdC5nZXRDb250YWN0SWQoKSwgImFnZW50IGNvbm5lY3Rpb25JZCAiICsgYWdlbnRDb25uZWN0aW9uSWQpOwoKICAgICAgaWYgKCFjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXSkgewogICAgICAgIGNvbnRhY3Qub25SZWZyZXNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIG9uUmVmcmVzaENvbnRhY3QoY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwoKICAgIGNvbm5lY3QuY29udGFjdChvbkluaXRDb250YWN0KTsKCiAgICAvLyBDb250YWN0IGFscmVhZHkgaW4gY29ubmVjdGluZyBzdGF0ZSBzY2VuYXJpbyAtIEluIHRoaXMgY2FzZSBjb250YWN0IElOSVQgaXMgbWlzc2VkIGhlbmNlIHRoZSBPblJlZnJlc2ggY2FsbGJhY2sgaXMgbWlzc2VkLiAKICAgIG5ldyBjb25uZWN0LkFnZW50KCkuZ2V0Q29udGFjdHMoKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIHZhciBhZ2VudENvbm5lY3Rpb25JZCA9IGNvbnRhY3QuZ2V0QWdlbnRDb25uZWN0aW9uKCkuY29ubmVjdGlvbklkOwogICAgICBsb2dnZXIuaW5mbygiQ29udGFjdCBleGlzdCBpbiB0aGUgc25hcHNob3QuIFJlaW5pdGlhdGUgdGhlIENvbnRhY3QgYW5kIFJUQyBzZXNzaW9uIGNyZWF0aW9uIGZvciBjb250YWN0SWQiICsgY29udGFjdC5nZXRDb250YWN0SWQoKSwgImFnZW50IGNvbm5lY3Rpb25JZCAiICsgYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICBvbkluaXRDb250YWN0KGNvbnRhY3QpOwogICAgICBvblJlZnJlc2hDb250YWN0KGNvbnRhY3QsIGFnZW50Q29ubmVjdGlvbklkKTsKICAgIH0pOwogIH07CgogIHZhciBmaXJlQ29udGFjdEFjY2VwdGVkRXZlbnQgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgIHZhciBhZ2VudENvbm5lY3Rpb24gPSBjb250YWN0LmdldEFnZW50Q29ubmVjdGlvbigpOwogICAgaWYgKCFhZ2VudENvbm5lY3Rpb24pIHsKICAgICAgbG9nZ2VyLmluZm8oIk5vdCBhYmxlIHRvIHJldHJpZXZlIHRoZSBhdXRvLWFjY2VwdCBzZXR0aW5nIGZyb20gbnVsbCBBZ2VudENvbm5lY3Rpb24sIGlnbm9yaW5nIGV2ZW50IHB1Ymxpc2guLiIpOwogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgc29mdHBob25lTWVkaWFJbmZvID0gYWdlbnRDb25uZWN0aW9uLmdldFNvZnRwaG9uZU1lZGlhSW5mbygpOwogICAgaWYgKCFzb2Z0cGhvbmVNZWRpYUluZm8pIHsKICAgICAgbG9nZ2VyLmluZm8oIk5vdCBhYmxlIHRvIHJldHJpZXZlIHRoZSBhdXRvLWFjY2VwdCBzZXR0aW5nIGZyb20gbnVsbCBTb2Z0cGhvbmVNZWRpYUluZm8sIGlnbm9yaW5nIGV2ZW50IHB1Ymxpc2guLiIpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoc29mdHBob25lTWVkaWFJbmZvLmF1dG9BY2NlcHQgPT09IHRydWUpIHsKICAgICAgbG9nZ2VyLmluZm8oIkF1dG8tYWNjZXB0IGlzIGVuYWJsZWQsIHNlbmRpbmcgb3V0IEFjY2VwdGVkIGV2ZW50IHRvIHN0b3AgcmluZ3RvbmUuLiIpOwogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgICBldmVudDogY29ubmVjdC5Db250YWN0RXZlbnRzLkFDQ0VQVEVECiAgICAgIH0pOwogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgICBldmVudDogY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkFDQ0VQVEVELCBjb250YWN0LmNvbnRhY3RJZCkKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBsb2dnZXIuaW5mbygiQXV0by1hY2NlcHQgaXMgZGlzYWJsZWQsIHJpbmd0b25lIHdpbGwgYmUgc3RvcHBlZCBieSB1c2VyIGFjdGlvbi4iKTsKICAgIH0KICB9OwoKICAvLyBCaW5kIGV2ZW50cyBmb3IgbXV0ZQogIHZhciBoYW5kbGVTb2Z0UGhvbmVNdXRlVG9nZ2xlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5NVVRFLCBtdXRlVG9nZ2xlKTsKICB9OwoKICAvLyBNYWtlIHN1cmUgb25jZSB3ZSBkaXNjb25uZWN0ZWQgd2UgZ2V0IHRoZSBtdXRlIHN0YXRlIGJhY2sgdG8gbm9ybWFsCiAgdmFyIGRlbGV0ZUxvY2FsTWVkaWFTdHJlYW0gPSBmdW5jdGlvbiAoY29ubmVjdGlvbklkKSB7CiAgICBkZWxldGUgbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdOwogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5BZ2VudEV2ZW50cy5NVVRFX1RPR0dMRSwKICAgICAgZGF0YTogeyBtdXRlZDogZmFsc2UgfQogICAgfSk7CiAgfTsKCiAgLy8gQ2hlY2sgZm9yIHRoZSBsb2NhbCBzdHJlYW1zIGlmIGV4aXN0cyAgLSAgcmV2ZXJ0IGl0CiAgLy8gQW5kIGluZm9ybSBvdGhlciBjbGllbnRzIGFib3V0IHRoZSBjaGFuZ2UgCiAgdmFyIG11dGVUb2dnbGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgdmFyIHN0YXR1czsKICAgIGlmIChjb25uZWN0LmtleXMobG9jYWxNZWRpYVN0cmVhbSkubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoZGF0YSAmJiBkYXRhLm11dGUgIT09IHVuZGVmaW5lZCkgewogICAgICBzdGF0dXMgPSBkYXRhLm11dGU7CiAgICB9CgogICAgZm9yICh2YXIgY29ubmVjdGlvbklkIGluIGxvY2FsTWVkaWFTdHJlYW0pIHsKICAgICAgaWYgKGxvY2FsTWVkaWFTdHJlYW0uaGFzT3duUHJvcGVydHkoY29ubmVjdGlvbklkKSkgewogICAgICAgIHZhciBsb2NhbE1lZGlhID0gbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLnN0cmVhbTsKICAgICAgICBpZiAobG9jYWxNZWRpYSkgewogICAgICAgICAgdmFyIGF1ZGlvVHJhY2tzID0gbG9jYWxNZWRpYS5nZXRBdWRpb1RyYWNrcygpWzBdOwogICAgICAgICAgaWYgKHN0YXR1cyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGF1ZGlvVHJhY2tzLmVuYWJsZWQgPSAhc3RhdHVzOwogICAgICAgICAgICBsb2NhbE1lZGlhU3RyZWFtW2Nvbm5lY3Rpb25JZF0ubXV0ZWQgPSBzdGF0dXM7CgogICAgICAgICAgICBpZiAoc3RhdHVzKSB7CiAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkFnZW50IGhhcyBtdXRlZCB0aGUgY29udGFjdCwgY29ubmVjdGlvbklkIC0gICIgKyBjb25uZWN0aW9uSWQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJBZ2VudCBoYXMgdW5tdXRlZCB0aGUgY29udGFjdCwgY29ubmVjdGlvbklkIC0gIiArIGNvbm5lY3Rpb25JZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdGF0dXMgPSBsb2NhbE1lZGlhU3RyZWFtW2Nvbm5lY3Rpb25JZF0ubXV0ZWQgfHwgZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5BZ2VudEV2ZW50cy5NVVRFX1RPR0dMRSwKICAgICAgZGF0YTogeyBtdXRlZDogc3RhdHVzIH0KICAgIH0pOwogIH07CgogIHZhciBwdWJsaXNoU29mdHBob25lRmFpbHVyZUxvZ3MgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbiwgcmVhc29uKSB7CiAgICBpZiAocmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5JQ0VfQ09MTEVDVElPTl9USU1FT1VUKSB7CiAgICAgIHZhciBlbmRQb2ludFVybCA9ICJcbiI7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcnRjU2Vzc2lvbi5faWNlU2VydmVycy5sZW5ndGg7IGkrKykgewogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcnRjU2Vzc2lvbi5faWNlU2VydmVyc1tpXS51cmxzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBlbmRQb2ludFVybCA9IGVuZFBvaW50VXJsICsgcnRjU2Vzc2lvbi5faWNlU2VydmVyc1tpXS51cmxzW2pdICsgIlxuIjsKICAgICAgICB9CiAgICAgIH0KICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuSUNFX0NPTExFQ1RJT05fVElNRU9VVCwgIkljZSBjb2xsZWN0aW9uIHRpbWVkb3V0LiAiLCBlbmRQb2ludFVybCk7CiAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuVVNFUl9CVVNZKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLlVTRVJfQlVTWV9FUlJPUiwKICAgICAgICAiU29mdHBob25lIGNhbGwgVXNlckJ1c3kgZXJyb3IuICIsCiAgICAgICAgIiIpOwogICAgfSBlbHNlIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLlNJR05BTExJTkdfSEFORFNIQUtFX0ZBSUxVUkUpIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuU0lHTkFMTElOR19IQU5EU0hBS0VfRkFJTFVSRSwKICAgICAgICAiSGFuZHNoYWtpbmcgd2l0aCBTaWduYWxsaW5nIFNlcnZlciAiICsgcnRjU2Vzc2lvbi5fc2lnbmFsaW5nVXJpICsgIiBmYWlsZWQuICIsCiAgICAgICAgcnRjU2Vzc2lvbi5fc2lnbmFsaW5nVXJpKTsKICAgIH0gZWxzZSBpZiAocmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5HVU1fVElNRU9VVF9GQUlMVVJFIHx8IHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuR1VNX09USEVSX0ZBSUxVUkUpIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuTUlDUk9QSE9ORV9OT1RfU0hBUkVELAogICAgICAgICJZb3VyIG1pY3JvcGhvbmUgaXMgbm90IGVuYWJsZWQgaW4geW91ciBicm93c2VyLiAiLAogICAgICAgICIiKTsKICAgIH0gZWxzZSBpZiAocmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5TSUdOQUxMSU5HX0NPTk5FQ1RJT05fRkFJTFVSRSkgewogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5TSUdOQUxMSU5HX0NPTk5FQ1RJT05fRkFJTFVSRSwKICAgICAgICAiVVJMICIgKyBydGNTZXNzaW9uLl9zaWduYWxpbmdVcmkgKyAiIGNhbm5vdCBiZSByZWFjaGVkLiAiLAogICAgICAgIHJ0Y1Nlc3Npb24uX3NpZ25hbGluZ1VyaSk7CiAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuQ0FMTF9OT1RfRk9VTkQpIHsKICAgICAgLy8gTm8gbmVlZCB0byBwdWJsaXNoIGFueSBzb2Z0cGhvbmUgZXJyb3IgZm9yIHRoaXMgY2FzZS4gQ0NQIFVYIHdpbGwgaGFuZGxlIHRoaXMgY2FzZS4KICAgICAgbG9nZ2VyLmVycm9yKCJTb2Z0cGhvbmUgY2FsbCBmYWlsZWQgZHVlIHRvIENhbGxOb3RGb3VuZEV4Y2VwdGlvbi4iKTsKICAgIH0gZWxzZSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLldFQlJUQ19FUlJPUiwKICAgICAgICAid2VicnRjIHN5c3RlbSBlcnJvci4gIiwKICAgICAgICAiIik7CiAgICB9CiAgfTsKCiAgLyoqIFBhcnNlIHRoZSBKU09OIGVuY29kZWQgd2ViIGNhbGwgY29uZmlnIGludG8gdGhlIGRhdGEgaXQgcmVwcmVzZW50cy4gKi8KICB2YXIgcGFyc2VDYWxsQ29uZmlnID0gZnVuY3Rpb24gKHNlcmlhbGl6ZWRDb25maWcpIHsKICAgIC8vIE91ciB1bmRlcnNjb3JlIGlzIHRvbyBvbGQgZm9yIHVuZXNjYXBlCiAgICAvLyBodHRwczovL2lzc3Vlcy5hbWF6b24uY29tL2lzc3Vlcy9DU1dGLTE0NjcKICAgIHZhciBkZWNvZGVkSlNPTiA9IHNlcmlhbGl6ZWRDb25maWcucmVwbGFjZSgvJnF1b3Q7L2csICciJyk7CiAgICByZXR1cm4gSlNPTi5wYXJzZShkZWNvZGVkSlNPTik7CiAgfTsKCiAgdmFyIGZldGNoVXNlck1lZGlhID0gZnVuY3Rpb24gKGNhbGxiYWNrc0luKSB7CiAgICB2YXIgY2FsbGJhY2tzID0gY2FsbGJhY2tzSW4gfHwge307CiAgICBjYWxsYmFja3Muc3VjY2VzcyA9IGNhbGxiYWNrcy5zdWNjZXNzIHx8IGZ1bmN0aW9uICgpIHsgfTsKICAgIGNhbGxiYWNrcy5mYWlsdXJlID0gY2FsbGJhY2tzLmZhaWx1cmUgfHwgZnVuY3Rpb24gKCkgeyB9OwoKICAgIHZhciBDT05TVFJBSU5UID0gewogICAgICBhdWRpbzogdHJ1ZQogICAgfTsKCiAgICB2YXIgcHJvbWlzZSA9IG51bGw7CgogICAgaWYgKHR5cGVvZiBQcm9taXNlICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKFNvZnRwaG9uZUVycm9yVHlwZXMuVU5TVVBQT1JURURfQlJPV1NFUik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAodHlwZW9mIG5hdmlnYXRvci5tZWRpYURldmljZXMgPT09ICJvYmplY3QiICYmIHR5cGVvZiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSA9PT0gImZ1bmN0aW9uIikgewogICAgICBwcm9taXNlID0gbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEoQ09OU1RSQUlOVCk7CgogICAgfSBlbHNlIGlmICh0eXBlb2YgbmF2aWdhdG9yLndlYmtpdEdldFVzZXJNZWRpYSA9PT0gImZ1bmN0aW9uIikgewogICAgICBwcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIG5hdmlnYXRvci53ZWJraXRHZXRVc2VyTWVkaWEoQ09OU1RSQUlOVCwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgfSk7CgogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoU29mdHBob25lRXJyb3JUeXBlcy5VTlNVUFBPUlRFRF9CUk9XU0VSKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAoc3RyZWFtKSB7CiAgICAgIHZhciBhdWRpb1RyYWNrcyA9IHN0cmVhbS5nZXRBdWRpb1RyYWNrcygpOwogICAgICBpZiAoYXVkaW9UcmFja3MgJiYgYXVkaW9UcmFja3MubGVuZ3RoID4gMCkgewogICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKHN0cmVhbSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoU29mdHBob25lRXJyb3JUeXBlcy5NSUNST1BIT05FX05PVF9TSEFSRUQpOwogICAgICB9CiAgICB9LCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKFNvZnRwaG9uZUVycm9yVHlwZXMuTUlDUk9QSE9ORV9OT1RfU0hBUkVEKTsKICAgIH0pOwogICAgcmV0dXJuIHByb21pc2U7CiAgfTsKCiAgdmFyIHB1Ymxpc2hFcnJvciA9IGZ1bmN0aW9uIChlcnJvclR5cGUsIG1lc3NhZ2UsIGVuZFBvaW50VXJsKSB7CiAgICBsb2dnZXIuZXJyb3IoIlNvZnRwaG9uZSBlcnJvciBvY2N1cnJlZCA6ICIsIGVycm9yVHlwZSwKICAgICAgbWVzc2FnZSB8fCAiIik7CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5BZ2VudEV2ZW50cy5TT0ZUUEhPTkVfRVJST1IsCiAgICAgIGRhdGE6IG5ldyBjb25uZWN0LlNvZnRwaG9uZUVycm9yKGVycm9yVHlwZSwgbWVzc2FnZSwgZW5kUG9pbnRVcmwpCiAgICB9KTsKICB9OwoKICB2YXIgcHVibGlzaFNlc3Npb25GYWlsdXJlVGVsZW1ldHJ5RXZlbnQgPSBmdW5jdGlvbiAoY29udGFjdElkLCByZWFzb24pIHsKICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiU29mdHBob25lIFNlc3Npb24gRmFpbGVkIiwgY29udGFjdElkLCB7CiAgICAgIGZhaWxlZFJlYXNvbjogcmVhc29uCiAgICB9KTsKICB9OwoKICB2YXIgcHVibGlzaFRlbGVtZXRyeUV2ZW50ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgY29udGFjdElkLCBkYXRhKSB7CiAgICBpZiAoY29udGFjdElkKSB7CiAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgbmFtZTogZXZlbnROYW1lLAogICAgICAgIGNvbnRhY3RJZDogY29udGFjdElkLAogICAgICAgIGRhdGE6IGRhdGEKICAgICAgfSk7CiAgICB9CiAgfTsKCiAgLy8gUHVibGlzaCB0aGUgY29udGFjdCBhbmQgYWdlbnQgaW5mb3JtYXRpb24gaW4gYSBtdWx0aXBsZSBzZXNzaW9ucyBzY2VuYXJpb3MKICB2YXIgcHVibGlzaE11bHRpcGxlU2Vzc2lvbnNFdmVudCA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGNvbnRhY3RJZCwgYWdlbnRDb25uZWN0aW9uSWQpIHsKICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudChldmVudE5hbWUsIGNvbnRhY3RJZCwgW3sKICAgICAgbmFtZTogIkFnZW50Q29ubmVjdGlvbklkIiwKICAgICAgdmFsdWU6IGFnZW50Q29ubmVjdGlvbklkCiAgICB9XSk7CiAgICBsb2dnZXIuaW5mbygiUHVibGlzaCBtdWx0aXBsZSBzZXNzaW9uIGVycm9yIG1ldHJpY3MiLCBldmVudE5hbWUsICJjb250YWN0SWQgIiArIGNvbnRhY3RJZCwgImFnZW50IGNvbm5lY3Rpb25JZCAiICsgYWdlbnRDb25uZWN0aW9uSWQpOwogIH07CgogIHZhciBpc0Jyb3dzZXJTb2Z0UGhvbmVTdXBwb3J0ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICAvLyBJbiBPcGVyYSwgdGhlIHRydWUgdmVyc2lvbiBpcyBhZnRlciAiT3BlcmEiIG9yIGFmdGVyICJWZXJzaW9uIgogICAgaWYgKGNvbm5lY3QuaXNPcGVyYUJyb3dzZXIoKSAmJiBjb25uZWN0LmdldE9wZXJhQnJvd3NlclZlcnNpb24oKSA+IDE3KSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLy8gSW4gQ2hyb21lLCB0aGUgdHJ1ZSB2ZXJzaW9uIGlzIGFmdGVyICJDaHJvbWUiCiAgICBlbHNlIGlmIChjb25uZWN0LmlzQ2hyb21lQnJvd3NlcigpICYmIGNvbm5lY3QuZ2V0Q2hyb21lQnJvd3NlclZlcnNpb24oKSA+IDIyKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLy8gSW4gRmlyZWZveCwgdGhlIHRydWUgdmVyc2lvbiBpcyBhZnRlciAiRmlyZWZveCIKICAgIGVsc2UgaWYgKGNvbm5lY3QuaXNGaXJlZm94QnJvd3NlcigpICYmIGNvbm5lY3QuZ2V0RmlyZWZveEJyb3dzZXJWZXJzaW9uKCkgPiAyMSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9OwoKICB2YXIgc2VuZFNvZnRwaG9uZU1ldHJpY3MgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgdmFyIHN0cmVhbVN0YXRzID0gdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyLnNsaWNlKCk7CiAgICB0aW1lU2VyaWVzU3RyZWFtU3RhdHNCdWZmZXIgPSBbXTsKICAgIGlmIChzdHJlYW1TdGF0cy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnRhY3Quc2VuZFNvZnRwaG9uZU1ldHJpY3Moc3RyZWFtU3RhdHMsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBsb2dnZXIuaW5mbygic2VuZFNvZnRwaG9uZU1ldHJpY3Mgc3VjY2VzcyIgKyBKU09OLnN0cmluZ2lmeShzdHJlYW1TdGF0cykpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGxvZ2dlci5lcnJvcigic2VuZFNvZnRwaG9uZU1ldHJpY3MgZmFpbGVkLiIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfTsKCiAgdmFyIHNlbmRTb2Z0cGhvbmVSZXBvcnQgPSBmdW5jdGlvbiAoY29udGFjdCwgcmVwb3J0LCB1c2VyQXVkaW9TdGF0cywgcmVtb3RlQXVkaW9TdGF0cykgewogICAgcmVwb3J0LnN0cmVhbVN0YXRzID0gW2FkZFN0cmVhbVR5cGVUb1N0YXRzKHVzZXJBdWRpb1N0YXRzLCBBVURJT19JTlBVVCksCiAgICBhZGRTdHJlYW1UeXBlVG9TdGF0cyhyZW1vdGVBdWRpb1N0YXRzLCBBVURJT19PVVRQVVQpXTsKICAgIHZhciBjYWxsUmVwb3J0ID0gewogICAgICBjYWxsU3RhcnRUaW1lOiByZXBvcnQuc2Vzc2lvblN0YXJ0VGltZSwKICAgICAgY2FsbEVuZFRpbWU6IHJlcG9ydC5zZXNzaW9uRW5kVGltZSwKICAgICAgZ3VtVGltZU1pbGxpczogcmVwb3J0Lmd1bVRpbWVNaWxsaXMsCiAgICAgIGluaXRpYWxpemF0aW9uVGltZU1pbGxpczogcmVwb3J0LmluaXRpYWxpemF0aW9uVGltZU1pbGxpcywKICAgICAgaWNlQ29sbGVjdGlvblRpbWVNaWxsaXM6IHJlcG9ydC5pY2VDb2xsZWN0aW9uVGltZU1pbGxpcywKICAgICAgc2lnbmFsbGluZ0Nvbm5lY3RUaW1lTWlsbGlzOiByZXBvcnQuc2lnbmFsbGluZ0Nvbm5lY3RUaW1lTWlsbGlzLAogICAgICBoYW5kc2hha2luZ1RpbWVNaWxsaXM6IHJlcG9ydC5oYW5kc2hha2luZ1RpbWVNaWxsaXMsCiAgICAgIHByZVRhbGtpbmdUaW1lTWlsbGlzOiByZXBvcnQucHJlVGFsa2luZ1RpbWVNaWxsaXMsCiAgICAgIHRhbGtpbmdUaW1lTWlsbGlzOiByZXBvcnQudGFsa2luZ1RpbWVNaWxsaXMsCiAgICAgIGNsZWFudXBUaW1lTWlsbGlzOiByZXBvcnQuY2xlYW51cFRpbWVNaWxsaXMsCiAgICAgIGljZUNvbGxlY3Rpb25GYWlsdXJlOiByZXBvcnQuaWNlQ29sbGVjdGlvbkZhaWx1cmUsCiAgICAgIHNpZ25hbGxpbmdDb25uZWN0aW9uRmFpbHVyZTogcmVwb3J0LnNpZ25hbGxpbmdDb25uZWN0aW9uRmFpbHVyZSwKICAgICAgaGFuZHNoYWtpbmdGYWlsdXJlOiByZXBvcnQuaGFuZHNoYWtpbmdGYWlsdXJlLAogICAgICBndW1PdGhlckZhaWx1cmU6IHJlcG9ydC5ndW1PdGhlckZhaWx1cmUsCiAgICAgIGd1bVRpbWVvdXRGYWlsdXJlOiByZXBvcnQuZ3VtVGltZW91dEZhaWx1cmUsCiAgICAgIGNyZWF0ZU9mZmVyRmFpbHVyZTogcmVwb3J0LmNyZWF0ZU9mZmVyRmFpbHVyZSwKICAgICAgc2V0TG9jYWxEZXNjcmlwdGlvbkZhaWx1cmU6IHJlcG9ydC5zZXRMb2NhbERlc2NyaXB0aW9uRmFpbHVyZSwKICAgICAgdXNlckJ1c3lGYWlsdXJlOiByZXBvcnQudXNlckJ1c3lGYWlsdXJlLAogICAgICBpbnZhbGlkUmVtb3RlU0RQRmFpbHVyZTogcmVwb3J0LmludmFsaWRSZW1vdGVTRFBGYWlsdXJlLAogICAgICBub1JlbW90ZUljZUNhbmRpZGF0ZUZhaWx1cmU6IHJlcG9ydC5ub1JlbW90ZUljZUNhbmRpZGF0ZUZhaWx1cmUsCiAgICAgIHNldFJlbW90ZURlc2NyaXB0aW9uRmFpbHVyZTogcmVwb3J0LnNldFJlbW90ZURlc2NyaXB0aW9uRmFpbHVyZSwKICAgICAgc29mdHBob25lU3RyZWFtU3RhdGlzdGljczogcmVwb3J0LnN0cmVhbVN0YXRzCiAgICB9OwogICAgY29udGFjdC5zZW5kU29mdHBob25lUmVwb3J0KGNhbGxSZXBvcnQsIHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKCkgewogICAgICAgIGxvZ2dlci5pbmZvKCJzZW5kU29mdHBob25lUmVwb3J0IHN1Y2Nlc3MiICsgSlNPTi5zdHJpbmdpZnkoY2FsbFJlcG9ydCkpOwogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGxvZ2dlci5lcnJvcigic2VuZFNvZnRwaG9uZVJlcG9ydCBmYWlsZWQuIikKICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpOwogICAgICB9CiAgICB9KTsKICB9OwoKICB2YXIgc3RhcnRTdGF0c0NvbGxlY3Rpb25Kb2IgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbikgewogICAgcnRwU3RhdHNKb2IgPSB3aW5kb3cuc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICBydGNTZXNzaW9uLmdldFVzZXJBdWRpb1N0YXRzKCkudGhlbihmdW5jdGlvbiAoc3RhdHMpIHsKICAgICAgICB2YXIgcHJldmlvdXNVc2VyU3RhdHMgPSBhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHM7CiAgICAgICAgYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzID0gc3RhdHM7CiAgICAgICAgdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyLnB1c2goZ2V0VGltZVNlcmllc1N0YXRzKGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cywgcHJldmlvdXNVc2VyU3RhdHMsIEFVRElPX0lOUFVUKSk7CiAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgIGxvZ2dlci5kZWJ1ZygiRmFpbGVkIHRvIGdldCB1c2VyIGF1ZGlvIHN0YXRzLiIsIGVycm9yKTsKICAgICAgfSk7CiAgICAgIHJ0Y1Nlc3Npb24uZ2V0UmVtb3RlQXVkaW9TdGF0cygpLnRoZW4oZnVuY3Rpb24gKHN0YXRzKSB7CiAgICAgICAgdmFyIHByZXZpb3VzUmVtb3RlU3RhdHMgPSBhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0czsKICAgICAgICBhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cyA9IHN0YXRzOwogICAgICAgIHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlci5wdXNoKGdldFRpbWVTZXJpZXNTdGF0cyhhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cywgcHJldmlvdXNSZW1vdGVTdGF0cywgQVVESU9fT1VUUFVUKSk7CiAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgIGxvZ2dlci5kZWJ1ZygiRmFpbGVkIHRvIGdldCByZW1vdGUgYXVkaW8gc3RhdHMuIiwgZXJyb3IpOwogICAgICB9KTsKICAgIH0sIDEwMDApOwogIH07CgogIHZhciBzdGFydFN0YXRzUmVwb3J0aW5nSm9iID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIHJlcG9ydFN0YXRzSm9iID0gd2luZG93LnNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgc2VuZFNvZnRwaG9uZU1ldHJpY3MoY29udGFjdCk7CiAgICB9LCBzdGF0c1JlcG9ydGluZ0pvYkludGVydmFsTXMpOwogIH07CgogIHZhciBpbml0aWFsaXplUGFyYW1zID0gZnVuY3Rpb24gKCkgewogICAgYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzID0gbnVsbDsKICAgIGFnZ3JlZ2F0ZWRSZW1vdGVBdWRpb1N0YXRzID0gbnVsbDsKICAgIHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlciA9IFtdOwogICAgcnRwU3RhdHNKb2IgPSBudWxsOwogICAgcmVwb3J0U3RhdHNKb2IgPSBudWxsOwogIH07CgogIHZhciBnZXRUaW1lU2VyaWVzU3RhdHMgPSBmdW5jdGlvbiAoY3VycmVudFN0YXRzLCBwcmV2aW91c1N0YXRzLCBzdHJlYW1UeXBlKSB7CiAgICBpZiAocHJldmlvdXNTdGF0cyAmJiBjdXJyZW50U3RhdHMpIHsKICAgICAgdmFyIHBhY2tldHNMb3N0ID0gY3VycmVudFN0YXRzLnBhY2tldHNMb3N0ID4gcHJldmlvdXNTdGF0cy5wYWNrZXRzTG9zdCA/IGN1cnJlbnRTdGF0cy5wYWNrZXRzTG9zdCAtIHByZXZpb3VzU3RhdHMucGFja2V0c0xvc3QgOiAwOwogICAgICB2YXIgcGFja2V0c0NvdW50ID0gY3VycmVudFN0YXRzLnBhY2tldHNDb3VudCA+IHByZXZpb3VzU3RhdHMucGFja2V0c0NvdW50ID8gY3VycmVudFN0YXRzLnBhY2tldHNDb3VudCAtIHByZXZpb3VzU3RhdHMucGFja2V0c0NvdW50IDogMDsKICAgICAgcmV0dXJuIG5ldyBSVFBTdHJlYW1TdGF0cyhjdXJyZW50U3RhdHMudGltZXN0YW1wLAogICAgICAgIHBhY2tldHNMb3N0LAogICAgICAgIHBhY2tldHNDb3VudCwKICAgICAgICBzdHJlYW1UeXBlLAogICAgICAgIGN1cnJlbnRTdGF0cy5hdWRpb0xldmVsLAogICAgICAgIGN1cnJlbnRTdGF0cy5qYk1pbGxpc2Vjb25kcywKICAgICAgICBjdXJyZW50U3RhdHMucnR0TWlsbGlzZWNvbmRzKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBuZXcgUlRQU3RyZWFtU3RhdHMoY3VycmVudFN0YXRzLnRpbWVzdGFtcCwKICAgICAgICBjdXJyZW50U3RhdHMucGFja2V0c0xvc3QsCiAgICAgICAgY3VycmVudFN0YXRzLnBhY2tldHNDb3VudCwKICAgICAgICBzdHJlYW1UeXBlLAogICAgICAgIGN1cnJlbnRTdGF0cy5hdWRpb0xldmVsLAogICAgICAgIGN1cnJlbnRTdGF0cy5qYk1pbGxpc2Vjb25kcywKICAgICAgICBjdXJyZW50U3RhdHMucnR0TWlsbGlzZWNvbmRzKTsKICAgIH0KICB9OwoKICB2YXIgc3RvcEpvYiA9IGZ1bmN0aW9uICh0YXNrKSB7CiAgICBpZiAodGFzayAhPT0gbnVsbCkgewogICAgICB3aW5kb3cuY2xlYXJJbnRlcnZhbCh0YXNrKTsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH07CgogIHZhciBzdG9wSm9ic0FuZFJlcG9ydCA9IGZ1bmN0aW9uIChjb250YWN0LCBzZXNzaW9uUmVwb3J0KSB7CiAgICBydHBTdGF0c0pvYiA9IHN0b3BKb2IocnRwU3RhdHNKb2IpOwogICAgcmVwb3J0U3RhdHNKb2IgPSBzdG9wSm9iKHJlcG9ydFN0YXRzSm9iKTsKICAgIHNlbmRTb2Z0cGhvbmVSZXBvcnQoY29udGFjdCwgc2Vzc2lvblJlcG9ydCwgYWRkU3RyZWFtVHlwZVRvU3RhdHMoYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzLCBBVURJT19JTlBVVCksIGFkZFN0cmVhbVR5cGVUb1N0YXRzKGFnZ3JlZ2F0ZWRSZW1vdGVBdWRpb1N0YXRzLCBBVURJT19PVVRQVVQpKTsKICAgIHNlbmRTb2Z0cGhvbmVNZXRyaWNzKGNvbnRhY3QpOwogIH07CgogIC8qKgogICogICBBZGRpbmcgc3RyZWFtdHlwZSBwYXJhbWV0ZXIgb24gdG9wIG9mIFJUQ0pTIFJUU3RhdHMgb2JqZWN0LgogICovCiAgdmFyIFJUUFN0cmVhbVN0YXRzID0gZnVuY3Rpb24gKHRpbWVzdGFtcCwgcGFja2V0c0xvc3QsIHBhY2tldHNDb3VudCwgc3RyZWFtVHlwZSwgYXVkaW9MZXZlbCwgaml0dGVyQnVmZmVyTWlsbGlzLCByb3VuZFRyaXBUaW1lTWlsbGlzKSB7CiAgICB0aGlzLnNvZnRwaG9uZVN0cmVhbVR5cGUgPSBzdHJlYW1UeXBlOwogICAgdGhpcy50aW1lc3RhbXAgPSB0aW1lc3RhbXA7CiAgICB0aGlzLnBhY2tldHNMb3N0ID0gcGFja2V0c0xvc3Q7CiAgICB0aGlzLnBhY2tldHNDb3VudCA9IHBhY2tldHNDb3VudDsKICAgIHRoaXMuYXVkaW9MZXZlbCA9IGF1ZGlvTGV2ZWw7CiAgICB0aGlzLmppdHRlckJ1ZmZlck1pbGxpcyA9IGppdHRlckJ1ZmZlck1pbGxpczsKICAgIHRoaXMucm91bmRUcmlwVGltZU1pbGxpcyA9IHJvdW5kVHJpcFRpbWVNaWxsaXM7CiAgfTsKCiAgdmFyIGFkZFN0cmVhbVR5cGVUb1N0YXRzID0gZnVuY3Rpb24gKHN0YXRzLCBzdHJlYW1UeXBlKSB7CiAgICBzdGF0cyA9IHN0YXRzIHx8IHt9OwogICAgcmV0dXJuIG5ldyBSVFBTdHJlYW1TdGF0cyhzdGF0cy50aW1lc3RhbXAsIHN0YXRzLnBhY2tldHNMb3N0LCBzdGF0cy5wYWNrZXRzQ291bnQsIHN0cmVhbVR5cGUsIHN0YXRzLmF1ZGlvTGV2ZWwpOwogIH07CgogIHZhciBTb2Z0cGhvbmVMb2dnZXIgPSBmdW5jdGlvbiAobG9nZ2VyKSB7CiAgICB0aGlzLl9vcmlnaW5hbExvZ2dlciA9IGxvZ2dlcjsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHRoaXMuX3RlZSA9IGZ1bmN0aW9uIChsZXZlbCwgbWV0aG9kKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gY2FsbCB0aGUgb3JpZ2luYWwgbG9nZ2VyIG9iamVjdCB0byBvdXRwdXQgdG8gYnJvd3NlcgogICAgICAgIC8vQ29ubmVjdCBsb2dnZXIgZm9sbG93cyAlcyBmb3JtYXQgdG8gcHJpbnQgb2JqZWN0cyB0byBjb25zb2xlLgogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzWzBdKTsKICAgICAgICB2YXIgZm9ybWF0ID0gIiI7CiAgICAgICAgYXJncy5mb3JFYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGZvcm1hdCA9IGZvcm1hdCArICIgJXMiOwogICAgICAgIH0pOwogICAgICAgIG1ldGhvZC5hcHBseShzZWxmLl9vcmlnaW5hbExvZ2dlciwgW2Nvbm5lY3QuTG9nQ29tcG9uZW50LlNPRlRQSE9ORSwgZm9ybWF0XS5jb25jYXQoYXJncykpOwogICAgICB9OwogICAgfTsKICB9OwoKICBTb2Z0cGhvbmVMb2dnZXIucHJvdG90eXBlLmRlYnVnID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5fdGVlKDEsIHRoaXMuX29yaWdpbmFsTG9nZ2VyLmRlYnVnKShhcmd1bWVudHMpOwogIH07CiAgU29mdHBob25lTG9nZ2VyLnByb3RvdHlwZS5pbmZvID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5fdGVlKDIsIHRoaXMuX29yaWdpbmFsTG9nZ2VyLmluZm8pKGFyZ3VtZW50cyk7CiAgfTsKICBTb2Z0cGhvbmVMb2dnZXIucHJvdG90eXBlLmxvZyA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuX3RlZSgzLCB0aGlzLl9vcmlnaW5hbExvZ2dlci5sb2cpKGFyZ3VtZW50cyk7CiAgfTsKICBTb2Z0cGhvbmVMb2dnZXIucHJvdG90eXBlLndhcm4gPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLl90ZWUoNCwgdGhpcy5fb3JpZ2luYWxMb2dnZXIud2FybikoYXJndW1lbnRzKTsKICB9OwogIFNvZnRwaG9uZUxvZ2dlci5wcm90b3R5cGUuZXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLl90ZWUoNSwgdGhpcy5fb3JpZ2luYWxMb2dnZXIuZXJyb3IpKGFyZ3VtZW50cyk7CiAgfTsKCiAgY29ubmVjdC5Tb2Z0cGhvbmVNYW5hZ2VyID0gU29mdHBob25lTWFuYWdlcjsKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogIGNvbm5lY3Qud29ya2VyID0ge307CgogIHZhciBHRVRfQUdFTlRfVElNRU9VVF9NUyA9IDMwMDAwOwogIHZhciBHRVRfQUdFTlRfUkVDT1ZFUllfVElNRU9VVF9NUyA9IDUwMDA7CiAgdmFyIEdFVF9BR0VOVF9TVUNDRVNTX1RJTUVPVVRfTVMgPSAxMDA7CiAgdmFyIExPR19CVUZGRVJfQ0FQX1NJWkUgPSA0MDA7CgogIHZhciBDSEVDS19BVVRIX1RPS0VOX0lOVEVSVkFMX01TID0gMzAwMDAwOyAvLyA1IG1pbnV0cwogIHZhciBSRUZSRVNIX0FVVEhfVE9LRU5fSU5URVJWQUxfTVMgPSAxMDAwMDsgLy8gMTAgc2Vjb25kcwogIHZhciBSRUZSRVNIX0FVVEhfVE9LRU5fTUFYX1RSWSA9IDQ7CgogIHZhciBHRVRfQUdFTlRfQ09ORklHVVJBVElPTl9JTlRFUlZBTF9NUyA9IDMwMDAwOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgdmFyIE1hc3RlclRvcGljQ29vcmRpbmF0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnRvcGljTWFzdGVyTWFwID0ge307CiAgfTsKCiAgTWFzdGVyVG9waWNDb29yZGluYXRvci5wcm90b3R5cGUuZ2V0TWFzdGVyID0gZnVuY3Rpb24gKHRvcGljKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWMsICd0b3BpYycpOwogICAgcmV0dXJuIHRoaXMudG9waWNNYXN0ZXJNYXBbdG9waWNdIHx8IG51bGw7CiAgfTsKCiAgTWFzdGVyVG9waWNDb29yZGluYXRvci5wcm90b3R5cGUuc2V0TWFzdGVyID0gZnVuY3Rpb24gKHRvcGljLCBpZCkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljLCAndG9waWMnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChpZCwgJ2lkJyk7CiAgICB0aGlzLnRvcGljTWFzdGVyTWFwW3RvcGljXSA9IGlkOwogIH07CgogIE1hc3RlclRvcGljQ29vcmRpbmF0b3IucHJvdG90eXBlLnJlbW92ZU1hc3RlciA9IGZ1bmN0aW9uIChpZCkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGlkLCAnaWQnKTsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBjb25uZWN0LmVudHJpZXModGhpcy50b3BpY01hc3Rlck1hcCkuZmlsdGVyKGZ1bmN0aW9uIChlbnRyeSkgewogICAgICByZXR1cm4gZW50cnkudmFsdWUgPT09IGlkOwogICAgfSkuZm9yRWFjaChmdW5jdGlvbiAoZW50cnkpIHsKICAgICAgZGVsZXRlIHNlbGYudG9waWNNYXN0ZXJNYXBbZW50cnkua2V5XTsKICAgIH0pOwogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIFdvcmtlckNsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgKi8KICB2YXIgV29ya2VyQ2xpZW50ID0gZnVuY3Rpb24gKGNvbmR1aXQpIHsKICAgIGNvbm5lY3QuQ2xpZW50QmFzZS5jYWxsKHRoaXMpOwogICAgdGhpcy5jb25kdWl0ID0gY29uZHVpdDsKICB9OwogIFdvcmtlckNsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKGNvbm5lY3QuQ2xpZW50QmFzZS5wcm90b3R5cGUpOwogIFdvcmtlckNsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBXb3JrZXJDbGllbnQ7CgogIFdvcmtlckNsaWVudC5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24gKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciByZXF1ZXN0X3N0YXJ0ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCkuX2NhbGxJbXBsKG1ldGhvZCwgcGFyYW1zLCB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQpOwogICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyb3IsIGRhdGEpIHsKICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCwgZXJyb3IpOwogICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVycm9yLCBkYXRhKTsKICAgICAgfSwKICAgICAgYXV0aEZhaWx1cmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCk7CiAgICAgICAgY2FsbGJhY2tzLmF1dGhGYWlsdXJlKCk7CiAgICAgIH0sCiAgICAgIGFjY2Vzc0RlbmllZDogZnVuY3Rpb24gKCkgewogICAgICAgIGNhbGxiYWNrcy5hY2Nlc3NEZW5pZWQgJiYgY2FsbGJhY2tzLmFjY2Vzc0RlbmllZCgpOwogICAgICB9CiAgICB9KTsKICB9OwoKICBXb3JrZXJDbGllbnQucHJvdG90eXBlLl9yZWNvcmRBUElMYXRlbmN5ID0gZnVuY3Rpb24gKG1ldGhvZCwgcmVxdWVzdF9zdGFydCwgZXJyKSB7CiAgICB2YXIgcmVxdWVzdF9lbmQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIHZhciByZXF1ZXN0X3RpbWUgPSByZXF1ZXN0X2VuZCAtIHJlcXVlc3Rfc3RhcnQ7CiAgICB0aGlzLl9zZW5kQVBJTWV0cmljcyhtZXRob2QsIHJlcXVlc3RfdGltZSwgZXJyKTsKICB9OwoKICBXb3JrZXJDbGllbnQucHJvdG90eXBlLl9zZW5kQVBJTWV0cmljcyA9IGZ1bmN0aW9uIChtZXRob2QsIHRpbWUsIGVycikgewogICAgdGhpcy5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9NRVRSSUMsIHsKICAgICAgbmFtZTogbWV0aG9kLAogICAgICB0aW1lOiB0aW1lLAogICAgICBkaW1lbnNpb25zOiBbCiAgICAgICAgewogICAgICAgICAgbmFtZTogIkNhdGVnb3J5IiwKICAgICAgICAgIHZhbHVlOiAiQVBJIgogICAgICAgIH0KICAgICAgXSwKICAgICAgZXJyb3I6IGVycgogICAgfSk7CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIFRoZSBvYmplY3QgcmVzcG9uc2libGUgZm9yIHBvbGxpbmcgYW5kIHBhc3NpbmcgZGF0YSBkb3duc3RyZWFtIHRvIGFsbAogICAqIGNvbnN1bWVyIHBvcnRzLgogICAqLwogIHZhciBDbGllbnRFbmdpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdGhpcy5tdWx0aXBsZXhlciA9IG5ldyBjb25uZWN0LlN0cmVhbU11bHRpcGxleGVyKCk7CiAgICB0aGlzLmNvbmR1aXQgPSBuZXcgY29ubmVjdC5Db25kdWl0KCJBbWF6b25Db25uZWN0U2hhcmVkV29ya2VyIiwgbnVsbCwgdGhpcy5tdWx0aXBsZXhlcik7CiAgICB0aGlzLmNsaWVudCA9IG5ldyBXb3JrZXJDbGllbnQodGhpcy5jb25kdWl0KTsKICAgIHRoaXMudGltZW91dCA9IG51bGw7CiAgICB0aGlzLmFnZW50ID0gbnVsbDsKICAgIHRoaXMubmV4dFRva2VuID0gbnVsbDsKICAgIHRoaXMuaW5pdERhdGEgPSB7fTsKICAgIHRoaXMucG9ydENvbmR1aXRNYXAgPSB7fTsKICAgIHRoaXMubWFzdGVyQ29vcmQgPSBuZXcgTWFzdGVyVG9waWNDb29yZGluYXRvcigpOwogICAgdGhpcy5sb2dzQnVmZmVyID0gW107CiAgICB0aGlzLnN1cHByZXNzID0gZmFsc2U7CiAgICB0aGlzLmZvcmNlT2ZmbGluZSA9IGZhbHNlOwoKICAgIHZhciB3ZWJTb2NrZXRNYW5hZ2VyID0gbnVsbDsKCiAgICBjb25uZWN0LnJvb3RMb2dnZXIgPSBuZXcgY29ubmVjdC5Eb3duc3RyZWFtQ29uZHVpdExvZ2dlcih0aGlzLmNvbmR1aXQpOwoKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU0VORF9MT0dTLCBmdW5jdGlvbiAobG9nc1RvVXBsb2FkKSB7CiAgICAgIC8vIEFkZCBzb2Z0cGhvbmUgbG9ncyBkb3duc3RyZWFtCiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkucHVzaExvZ3NEb3duc3RyZWFtKGxvZ3NUb1VwbG9hZCk7CgogICAgICBzZWxmLmxvZ3NCdWZmZXIgPSBzZWxmLmxvZ3NCdWZmZXIuY29uY2F0KGxvZ3NUb1VwbG9hZCk7CiAgICAgIC8vb25seSBjYWxsIEFQSSB0byBzZW5kIGxvZ3MgaWYgYnVmZmVyIHJlYWNoZWQgY2FwCiAgICAgIGlmIChzZWxmLmxvZ3NCdWZmZXIubGVuZ3RoID4gTE9HX0JVRkZFUl9DQVBfU0laRSkgewogICAgICAgIHNlbGYuaGFuZGxlU2VuZExvZ3NSZXF1ZXN0KHNlbGYubG9nc0J1ZmZlcik7CiAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLlNVUFBSRVNTLCBmdW5jdGlvbiAoZGF0YSl7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZGVidWcoIltEaXNhc3RlciBSZWNvdmVyeV0gU2V0dGluZyBTdXBwcmVzcyB0byAlcyIsIGRhdGEuc3VwcHJlc3MpOwogICAgICBzZWxmLnN1cHByZXNzID0gZGF0YS5zdXBwcmVzcyB8fCBmYWxzZTsKICAgICAgLy9zaWduYWwgb3RoZXIgd2luZG93cyB0aGF0IGEgZmFpbG92ZXIgaGFwcGVuZWQKICAgICAgaWYgKHNlbGYubWFzdGVyQ29vcmQuZ2V0TWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNPRlRQSE9ORSkpIHsKICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLkZBSUxPVkVSLCB7CiAgICAgICAgICBpc1ByaW1hcnk6ICFzZWxmLnN1cHByZXNzCiAgICAgICAgfSk7ICAgICAgCiAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLkZPUkNFX09GRkxJTkUsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZGVidWcoIltEaXNhc3RlciBSZWNvdmVyeV0gU2V0dGluZyBGT1JDRV9PRkZMSU5FIHRvICVzIiwgZGF0YS5vZmZsaW5lKTsKICAgICAgc2VsZi5mb3JjZU9mZmxpbmUgPSBkYXRhLm9mZmxpbmUgfHwgZmFsc2U7CiAgICB9KTsKCiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgaWYgKGRhdGEuYXV0aFRva2VuICYmIGRhdGEuYXV0aFRva2VuICE9PSBzZWxmLmluaXREYXRhLmF1dGhUb2tlbikgewogICAgICAgIHNlbGYuaW5pdERhdGEgPSBkYXRhOwogICAgICAgIGNvbm5lY3QuY29yZS5pbml0KGRhdGEpOwogICAgICAgIC8vIGluaXQgb25seSBvbmNlLgogICAgICAgIGlmICghd2ViU29ja2V0TWFuYWdlcikgewoKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQ3JlYXRpbmcgYSBuZXcgV2Vic29ja2V0IGNvbm5lY3Rpb24gZm9yIENDUCIpOwoKICAgICAgICAgIGNvbm5lY3QuV2ViU29ja2V0TWFuYWdlci5zZXRHbG9iYWxDb25maWcoewogICAgICAgICAgICBsb2dnZXJDb25maWc6IHsgbG9nZ2VyOiBjb25uZWN0LmdldExvZygpIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIgPSBjb25uZWN0LldlYlNvY2tldE1hbmFnZXIuY3JlYXRlKCk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkluaXRGYWlsdXJlKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLklOSVRfRkFJTFVSRSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uQ29ubmVjdGlvbk9wZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX09QRU4sIHJlc3BvbnNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25Db25uZWN0aW9uQ2xvc2UoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0NMT1NFLCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uQ29ubmVjdGlvbkdhaW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5BZ2VudEV2ZW50cy5XRUJTT0NLRVRfQ09OTkVDVElPTl9HQUlORUQpOwogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9HQUlOKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25Db25uZWN0aW9uTG9zdChmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuQWdlbnRFdmVudHMuV0VCU09DS0VUX0NPTk5FQ1RJT05fTE9TVCwgcmVzcG9uc2UpOwogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9MT1NULCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uU3Vic2NyaXB0aW9uVXBkYXRlKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSVBUSU9OX1VQREFURSwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vblN1YnNjcmlwdGlvbkZhaWx1cmUoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJUFRJT05fRkFJTFVSRSwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkFsbE1lc3NhZ2UoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5BTExfTUVTU0FHRSwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgc2VsZi5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TRU5ELCBmdW5jdGlvbiAobWVzc2FnZSkgewogICAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLnNlbmRNZXNzYWdlKG1lc3NhZ2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgc2VsZi5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJQkUsIGZ1bmN0aW9uICh0b3BpY3MpIHsKICAgICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5zdWJzY3JpYmVUb3BpY3ModG9waWNzKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIuaW5pdChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuZ2V0V2ViU29ja2V0VXJsKSkudGhlbihmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICBpZiAocmVzcG9uc2UgJiYgIXJlc3BvbnNlLndlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQpIHsKICAgICAgICAgICAgICAvLyBTdGFydCBwb2xsaW5nIGZvciBhZ2VudCBkYXRhLgogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiS2lja2luZyBvZmYgYWdlbnQgcG9sbGluZyIpOwogICAgICAgICAgICAgIHNlbGYucG9sbEZvckFnZW50KCk7CgogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiS2lja2luZyBvZmYgY29uZmlnIHBvbGxpbmciKTsKICAgICAgICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudENvbmZpZ3VyYXRpb24oeyByZXBlYXRGb3JldmVyOiB0cnVlIH0pOwoKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIktpY2tpbmcgb2ZmIGF1dGggdG9rZW4gcG9sbGluZyIpOwogICAgICAgICAgICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuY2hlY2tBdXRoVG9rZW4pLCBDSEVDS19BVVRIX1RPS0VOX0lOVEVSVkFMX01TKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoIWNvbm5lY3Qud2ViU29ja2V0SW5pdEZhaWxlZCkgewogICAgICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLklOSVRfRkFJTFVSRSk7CiAgICAgICAgICAgICAgICBjb25uZWN0LndlYlNvY2tldEluaXRGYWlsZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiTm90IEluaXRpYWxpemluZyBhIG5ldyBXZWJzb2NrZXRNYW5hZ2VyIGluc3RhbmNlLCBzaW5jZSBvbmUgYWxyZWFkeSBleGlzdHMiKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5URVJNSU5BVEUsIGZ1bmN0aW9uICgpIHsKICAgICAgLy91cGxvYWQgcGVuZGluZyBsb2dzIGJlZm9yZSB0ZXJtaW5hdGluZy4KICAgICAgc2VsZi5oYW5kbGVTZW5kTG9nc1JlcXVlc3Qoc2VsZi5sb2dzQnVmZmVyKTsKICAgICAgY29ubmVjdC5jb3JlLnRlcm1pbmF0ZSgpOwogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFRCk7CiAgICB9KTsKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU1lOQ0hST05JWkUsIGZ1bmN0aW9uICgpIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFKTsKICAgIH0pOwogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShkYXRhLmV2ZW50LCBkYXRhLmRhdGEpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDYWxsZWQgd2hlbiBhIGNvbnN1bWVyIHBvcnQgY29ubmVjdHMgdG8gdGhpcyBTaGFyZWRXb3JrZXIuCiAgICAgKiBMZXQncyBhZGQgdGhlbSB0byBvdXIgbXVsdGlwbGV4ZXIuCiAgICAgKi8KICAgIGdsb2JhbC5vbmNvbm5lY3QgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgdmFyIHBvcnQgPSBldmVudC5wb3J0c1swXTsKICAgICAgdmFyIHN0cmVhbSA9IG5ldyBjb25uZWN0LlBvcnRTdHJlYW0ocG9ydCk7CiAgICAgIHNlbGYubXVsdGlwbGV4ZXIuYWRkU3RyZWFtKHN0cmVhbSk7CiAgICAgIHBvcnQuc3RhcnQoKTsKCiAgICAgIHZhciBwb3J0Q29uZHVpdCA9IG5ldyBjb25uZWN0LkNvbmR1aXQoc3RyZWFtLmdldElkKCksIG51bGwsIHN0cmVhbSk7CiAgICAgIHBvcnRDb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFLCB7IGlkOiBzdHJlYW0uZ2V0SWQoKSB9KTsKCiAgICAgIHNlbGYucG9ydENvbmR1aXRNYXBbc3RyZWFtLmdldElkKCldID0gcG9ydENvbmR1aXQ7CgogICAgICBpZiAoc2VsZi5hZ2VudCAhPT0gbnVsbCkgewogICAgICAgIHNlbGYudXBkYXRlQWdlbnQoKTsKICAgICAgfQoKICAgICAgcG9ydENvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9SRVFVRVNULAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBUElSZXF1ZXN0LCBwb3J0Q29uZHVpdCkpOwogICAgICBwb3J0Q29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFUVVFU1QsCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZU1hc3RlclJlcXVlc3QsIHBvcnRDb25kdWl0LCBzdHJlYW0uZ2V0SWQoKSkpOwogICAgICBwb3J0Q29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuUkVMT0FEX0FHRU5UX0NPTkZJR1VSQVRJT04sCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLnBvbGxGb3JBZ2VudENvbmZpZ3VyYXRpb24pKTsKICAgICAgcG9ydENvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNMT1NFLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgc2VsZi5tdWx0aXBsZXhlci5yZW1vdmVTdHJlYW0oc3RyZWFtKTsKICAgICAgICBkZWxldGUgc2VsZi5wb3J0Q29uZHVpdE1hcFtzdHJlYW0uZ2V0SWQoKV07CiAgICAgICAgc2VsZi5tYXN0ZXJDb29yZC5yZW1vdmVNYXN0ZXIoc3RyZWFtLmdldElkKCkpOwogICAgICB9KTsKICAgIH07CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yQWdlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgb25BdXRoRmFpbCA9IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCk7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0FHRU5UX1NOQVBTSE9ULCB7CiAgICAgIG5leHRUb2tlbjogc2VsZi5uZXh0VG9rZW4sCiAgICAgIHRpbWVvdXQ6IEdFVF9BR0VOVF9USU1FT1VUX01TCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNlbGYuYWdlbnQgPSBzZWxmLmFnZW50IHx8IHt9OwogICAgICAgICAgICBzZWxmLmFnZW50LnNuYXBzaG90ID0gZGF0YS5zbmFwc2hvdDsKICAgICAgICAgICAgc2VsZi5hZ2VudC5zbmFwc2hvdC5sb2NhbFRpbWVzdGFtcCA9IGNvbm5lY3Qubm93KCk7CiAgICAgICAgICAgIHNlbGYuYWdlbnQuc25hcHNob3Quc2tldyA9IHNlbGYuYWdlbnQuc25hcHNob3Quc25hcHNob3RUaW1lc3RhbXAgLSBzZWxmLmFnZW50LnNuYXBzaG90LmxvY2FsVGltZXN0YW1wOwogICAgICAgICAgICBzZWxmLm5leHRUb2tlbiA9IGRhdGEubmV4dFRva2VuOwogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJHRVRfQUdFTlRfU05BUFNIT1Qgc3VjY2VlZGVkLiIpLndpdGhPYmplY3QoZGF0YSk7CiAgICAgICAgICAgIHNlbGYudXBkYXRlQWdlbnQoKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiTG9uZyBwb2xsIGZhaWxlZCB0byB1cGRhdGUgYWdlbnQuIikud2l0aE9iamVjdChkYXRhKS53aXRoRXhjZXB0aW9uKGUpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLnBvbGxGb3JBZ2VudCksIEdFVF9BR0VOVF9TVUNDRVNTX1RJTUVPVVRfTVMpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGdldCBhZ2VudCBkYXRhLiIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLnBvbGxGb3JBZ2VudCksIEdFVF9BR0VOVF9SRUNPVkVSWV9USU1FT1VUX01TKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBvbkF1dGhGYWlsKCk7CiAgICAgICAgfSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpCgogICAgICB9KTsKCiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yQWdlbnRDb25maWd1cmF0aW9uID0gZnVuY3Rpb24gKHBhcmFtc0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICB2YXIgb25BdXRoRmFpbCA9IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCk7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0FHRU5UX0NPTkZJR1VSQVRJT04sIHt9LCB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgdmFyIGNvbmZpZ3VyYXRpb24gPSBkYXRhLmNvbmZpZ3VyYXRpb247CiAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnRQZXJtaXNzaW9ucyhjb25maWd1cmF0aW9uKTsKICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudFN0YXRlcyhjb25maWd1cmF0aW9uKTsKICAgICAgICBzZWxmLnBvbGxGb3JEaWFsYWJsZUNvdW50cnlDb2Rlcyhjb25maWd1cmF0aW9uKTsKICAgICAgICBzZWxmLnBvbGxGb3JSb3V0aW5nUHJvZmlsZVF1ZXVlcyhjb25maWd1cmF0aW9uKTsKICAgICAgICBpZiAocGFyYW1zLnJlcGVhdEZvcmV2ZXIpIHsKICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5wb2xsRm9yQWdlbnRDb25maWd1cmF0aW9uLCBwYXJhbXMpLAogICAgICAgICAgICBHRVRfQUdFTlRfQ09ORklHVVJBVElPTl9JTlRFUlZBTF9NUyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBmZXRjaCBhZ2VudCBjb25maWd1cmF0aW9uIGRhdGEuIikKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGlmIChwYXJhbXMucmVwZWF0Rm9yZXZlcikgewogICAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYucG9sbEZvckFnZW50Q29uZmlndXJhdGlvbiksCiAgICAgICAgICAgICAgR0VUX0FHRU5UX0NPTkZJR1VSQVRJT05fSU5URVJWQUxfTVMsIHBhcmFtcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBhdXRoRmFpbHVyZTogZnVuY3Rpb24gKCkgewogICAgICAgIG9uQXV0aEZhaWwoKTsKICAgICAgfSwKICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQogICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yQWdlbnRTdGF0ZXMgPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgcGFyYW1zSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHBhcmFtcy5tYXhSZXN1bHRzID0gcGFyYW1zLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0FHRU5UX1NUQVRFUywgewogICAgICBuZXh0VG9rZW46IHBhcmFtcy5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLm5leHRUb2tlbikgewogICAgICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudFN0YXRlcyhjb25maWd1cmF0aW9uLCB7CiAgICAgICAgICAgICAgc3RhdGVzOiAocGFyYW1zLnN0YXRlcyB8fCBbXSkuY29uY2F0KGRhdGEuc3RhdGVzKSwKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24uYWdlbnRTdGF0ZXMgPSAocGFyYW1zLnN0YXRlcyB8fCBbXSkuY29uY2F0KGRhdGEuc3RhdGVzKTsKICAgICAgICAgICAgc2VsZi51cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24oY29uZmlndXJhdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggYWdlbnQgc3RhdGVzIGxpc3QuIikKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpCiAgICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvckFnZW50UGVybWlzc2lvbnMgPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgcGFyYW1zSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHBhcmFtcy5tYXhSZXN1bHRzID0gcGFyYW1zLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0FHRU5UX1BFUk1JU1NJT05TLCB7CiAgICAgIG5leHRUb2tlbjogcGFyYW1zLm5leHRUb2tlbiB8fCBudWxsLAogICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwoKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEubmV4dFRva2VuKSB7CiAgICAgICAgICAgIHNlbGYucG9sbEZvckFnZW50UGVybWlzc2lvbnMoY29uZmlndXJhdGlvbiwgewogICAgICAgICAgICAgIHBlcm1pc3Npb25zOiAocGFyYW1zLnBlcm1pc3Npb25zIHx8IFtdKS5jb25jYXQoZGF0YS5wZXJtaXNzaW9ucyksCiAgICAgICAgICAgICAgbmV4dFRva2VuOiBkYXRhLm5leHRUb2tlbiwKICAgICAgICAgICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgICAgICAgICB9KTsKCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25maWd1cmF0aW9uLnBlcm1pc3Npb25zID0gKHBhcmFtcy5wZXJtaXNzaW9ucyB8fCBbXSkuY29uY2F0KGRhdGEucGVybWlzc2lvbnMpOwogICAgICAgICAgICBzZWxmLnVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbihjb25maWd1cmF0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBmZXRjaCBhZ2VudCBwZXJtaXNzaW9ucyBsaXN0LiIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCksCiAgICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQogICAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JEaWFsYWJsZUNvdW50cnlDb2RlcyA9IGZ1bmN0aW9uIChjb25maWd1cmF0aW9uLCBwYXJhbXNJbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgcGFyYW1zLm1heFJlc3VsdHMgPSBwYXJhbXMubWF4UmVzdWx0cyB8fCBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfRElBTEFCTEVfQ09VTlRSWV9DT0RFUywgewogICAgICBuZXh0VG9rZW46IHBhcmFtcy5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEubmV4dFRva2VuKSB7CiAgICAgICAgICAgIHNlbGYucG9sbEZvckRpYWxhYmxlQ291bnRyeUNvZGVzKGNvbmZpZ3VyYXRpb24sIHsKICAgICAgICAgICAgICBjb3VudHJ5Q29kZXM6IChwYXJhbXMuY291bnRyeUNvZGVzIHx8IFtdKS5jb25jYXQoZGF0YS5jb3VudHJ5Q29kZXMpLAogICAgICAgICAgICAgIG5leHRUb2tlbjogZGF0YS5uZXh0VG9rZW4sCiAgICAgICAgICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgICAgICAgICAgfSk7CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uZmlndXJhdGlvbi5kaWFsYWJsZUNvdW50cmllcyA9IChwYXJhbXMuY291bnRyeUNvZGVzIHx8IFtdKS5jb25jYXQoZGF0YS5jb3VudHJ5Q29kZXMpOwogICAgICAgICAgICBzZWxmLnVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbihjb25maWd1cmF0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBmZXRjaCBkaWFsYWJsZSBjb3VudHJ5IGNvZGVzIGxpc3QuIikKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpCiAgICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvclJvdXRpbmdQcm9maWxlUXVldWVzID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24sIHBhcmFtc0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICBwYXJhbXMubWF4UmVzdWx0cyA9IHBhcmFtcy5tYXhSZXN1bHRzIHx8IGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9ST1VUSU5HX1BST0ZJTEVfUVVFVUVTLCB7CiAgICAgIHJvdXRpbmdQcm9maWxlQVJOOiBjb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnJvdXRpbmdQcm9maWxlQVJOLAogICAgICBuZXh0VG9rZW46IHBhcmFtcy5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEubmV4dFRva2VuKSB7CiAgICAgICAgICAgIHNlbGYucG9sbEZvclJvdXRpbmdQcm9maWxlUXVldWVzKGNvbmZpZ3VyYXRpb24sIHsKICAgICAgICAgICAgICBjb3VudHJ5Q29kZXM6IChwYXJhbXMucXVldWVzIHx8IFtdKS5jb25jYXQoZGF0YS5xdWV1ZXMpLAogICAgICAgICAgICAgIG5leHRUb2tlbjogZGF0YS5uZXh0VG9rZW4sCiAgICAgICAgICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgICAgICAgICAgfSk7CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5xdWV1ZXMgPSAocGFyYW1zLnF1ZXVlcyB8fCBbXSkuY29uY2F0KGRhdGEucXVldWVzKTsKICAgICAgICAgICAgc2VsZi51cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24oY29uZmlndXJhdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggcm91dGluZyBwcm9maWxlIHF1ZXVlcyBsaXN0LiIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCksCiAgICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQogICAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZUFQSVJlcXVlc3QgPSBmdW5jdGlvbiAocG9ydENvbmR1aXQsIHJlcXVlc3QpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB0aGlzLmNsaWVudC5jYWxsKHJlcXVlc3QubWV0aG9kLCByZXF1ZXN0LnBhcmFtcywgewogICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIHZhciByZXNwb25zZSA9IGNvbm5lY3QuRXZlbnRGYWN0b3J5LmNyZWF0ZVJlc3BvbnNlKGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9SRVNQT05TRSwgcmVxdWVzdCwgZGF0YSk7CiAgICAgICAgcG9ydENvbmR1aXQuc2VuZERvd25zdHJlYW0ocmVzcG9uc2UuZXZlbnQsIHJlc3BvbnNlKTsKICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIHZhciByZXNwb25zZSA9IGNvbm5lY3QuRXZlbnRGYWN0b3J5LmNyZWF0ZVJlc3BvbnNlKGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9SRVNQT05TRSwgcmVxdWVzdCwgZGF0YSwgSlNPTi5zdHJpbmdpZnkoZXJyKSk7CiAgICAgICAgcG9ydENvbmR1aXQuc2VuZERvd25zdHJlYW0ocmVzcG9uc2UuZXZlbnQsIHJlc3BvbnNlKTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCInJXMnIEFQSSByZXF1ZXN0IGZhaWxlZCIsIHJlcXVlc3QubWV0aG9kKQogICAgICAgICAgLndpdGhPYmplY3QoeyByZXF1ZXN0OiBzZWxmLmZpbHRlckF1dGhUb2tlbihyZXF1ZXN0KSwgcmVzcG9uc2U6IHJlc3BvbnNlIH0pLndpdGhFeGNlcHRpb24oZXJyKTsKICAgICAgfSwKICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCkKICAgIH0pOwogIH07CgogIC8qKgogICAqIEhhbmRsZSBpbmNvbWluZyBtYXN0ZXIgcXVlcnkgb3IgbW9kaWZpY2F0aW9uIHJlcXVlc3RzIGZyb20gY29ubmVjdGVkIHRhYiBwb3J0cy4KICAgKi8KICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZU1hc3RlclJlcXVlc3QgPSBmdW5jdGlvbiAocG9ydENvbmR1aXQsIHBvcnRJZCwgcmVxdWVzdCkgewogICAgdmFyIHJlc3BvbnNlID0gbnVsbDsKCiAgICBzd2l0Y2ggKHJlcXVlc3QubWV0aG9kKSB7CiAgICAgIGNhc2UgY29ubmVjdC5NYXN0ZXJNZXRob2RzLkJFQ09NRV9NQVNURVI6CiAgICAgICAgdGhpcy5tYXN0ZXJDb29yZC5zZXRNYXN0ZXIocmVxdWVzdC5wYXJhbXMudG9waWMsIHBvcnRJZCk7CiAgICAgICAgcmVzcG9uc2UgPSBjb25uZWN0LkV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZShjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVTUE9OU0UsIHJlcXVlc3QsIHsKICAgICAgICAgIG1hc3RlcklkOiBwb3J0SWQsCiAgICAgICAgICBpc01hc3RlcjogdHJ1ZSwKICAgICAgICAgIHRvcGljOiByZXF1ZXN0LnBhcmFtcy50b3BpYwogICAgICAgIH0pOwoKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgY29ubmVjdC5NYXN0ZXJNZXRob2RzLkNIRUNLX01BU1RFUjoKICAgICAgICB2YXIgbWFzdGVySWQgPSB0aGlzLm1hc3RlckNvb3JkLmdldE1hc3RlcihyZXF1ZXN0LnBhcmFtcy50b3BpYyk7CiAgICAgICAgaWYgKCFtYXN0ZXJJZCkgewogICAgICAgICAgdGhpcy5tYXN0ZXJDb29yZC5zZXRNYXN0ZXIocmVxdWVzdC5wYXJhbXMudG9waWMsIHBvcnRJZCk7CiAgICAgICAgICBtYXN0ZXJJZCA9IHBvcnRJZDsKICAgICAgICB9CgogICAgICAgIHJlc3BvbnNlID0gY29ubmVjdC5FdmVudEZhY3RvcnkuY3JlYXRlUmVzcG9uc2UoY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFU1BPTlNFLCByZXF1ZXN0LCB7CiAgICAgICAgICBtYXN0ZXJJZDogbWFzdGVySWQsCiAgICAgICAgICBpc01hc3RlcjogcG9ydElkID09PSBtYXN0ZXJJZCwKICAgICAgICAgIHRvcGljOiByZXF1ZXN0LnBhcmFtcy50b3BpYwogICAgICAgIH0pOwoKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIG1hc3RlciBtZXRob2Q6ICIgKyByZXF1ZXN0Lm1ldGhvZCk7CiAgICB9CgogICAgcG9ydENvbmR1aXQuc2VuZERvd25zdHJlYW0ocmVzcG9uc2UuZXZlbnQsIHJlc3BvbnNlKTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbiA9IGZ1bmN0aW9uIChjb25maWd1cmF0aW9uKSB7CiAgICBpZiAoY29uZmlndXJhdGlvbi5wZXJtaXNzaW9ucyAmJgogICAgICBjb25maWd1cmF0aW9uLmRpYWxhYmxlQ291bnRyaWVzICYmCiAgICAgIGNvbmZpZ3VyYXRpb24uYWdlbnRTdGF0ZXMgJiYKICAgICAgY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5xdWV1ZXMpIHsKCiAgICAgIHRoaXMuYWdlbnQgPSB0aGlzLmFnZW50IHx8IHt9OwogICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24gPSBjb25maWd1cmF0aW9uOwogICAgICB0aGlzLnVwZGF0ZUFnZW50KCk7CgogICAgfSBlbHNlIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiV2FpdGluZyB0byB1cGRhdGUgYWdlbnQgY29uZmlndXJhdGlvbiB1bnRpbCBhbGwgY29uZmlnIGRhdGEgaGFzIGJlZW4gZmV0Y2hlZC4iKTsKICAgIH0KICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnVwZGF0ZUFnZW50ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCF0aGlzLmFnZW50KSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIldhaXRpbmcgdG8gdXBkYXRlIGFnZW50IHVudGlsIHRoZSBhZ2VudCBoYXMgYmVlbiBmdWxseSBjb25zdHJ1Y3RlZC4iKTsKCiAgICB9IGVsc2UgaWYgKCF0aGlzLmFnZW50LnNuYXBzaG90KSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIldhaXRpbmcgdG8gdXBkYXRlIGFnZW50IHVudGlsIHRoZSBhZ2VudCBzbmFwc2hvdCBpcyBhdmFpbGFibGUuIik7CgogICAgfSBlbHNlIGlmICghdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIldhaXRpbmcgdG8gdXBkYXRlIGFnZW50IHVudGlsIHRoZSBhZ2VudCBjb25maWd1cmF0aW9uIGlzIGF2YWlsYWJsZS4iKTsKCiAgICB9IGVsc2UgewogICAgICAvLyBBbGlhcyBzb21lIG9mIHRoZSBwcm9wZXJ0aWVzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KICAgICAgdGhpcy5hZ2VudC5zbmFwc2hvdC5zdGF0dXMgPSB0aGlzLmFnZW50LnN0YXRlOwoKICAgICAgLy8gU29ydCB0aGUgY29udGFjdHMgb24gdGhlIHRpbWVzdGFtcAogICAgICBpZiAodGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cyAmJiB0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzLmxlbmd0aCA+IDEpIHsKICAgICAgICB0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzLnNvcnQoZnVuY3Rpb24gKGNvbnRhY3RBLCBjb250YWN0QikgewogICAgICAgICAgcmV0dXJuIGNvbnRhY3RBLnN0YXRlLnRpbWVzdGFtcC5nZXRUaW1lKCkgLSBjb250YWN0Qi5zdGF0ZS50aW1lc3RhbXAuZ2V0VGltZSgpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICB0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICBjb250YWN0LnN0YXR1cyA9IGNvbnRhY3Quc3RhdGU7CgogICAgICAgIGNvbnRhY3QuY29ubmVjdGlvbnMuZm9yRWFjaChmdW5jdGlvbiAoY29ubmVjdGlvbikgewogICAgICAgICAgY29ubmVjdGlvbi5hZGRyZXNzID0gY29ubmVjdGlvbi5lbmRwb2ludDsKICAgICAgICB9KTsKICAgICAgfSk7CgogICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUuZGVmYXVsdE91dGJvdW5kUXVldWUucXVldWVJZCA9CiAgICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLmRlZmF1bHRPdXRib3VuZFF1ZXVlLnF1ZXVlQVJOOwogICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucXVldWVzLmZvckVhY2goZnVuY3Rpb24gKHF1ZXVlKSB7CiAgICAgICAgcXVldWUucXVldWVJZCA9IHF1ZXVlLnF1ZXVlQVJOOwogICAgICB9KTsKICAgICAgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cy5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgICAgLy9jb250YWN0LnF1ZXVlIGlzIG51bGwgd2hlbiBtb25pdG9yaW5nCiAgICAgICAgaWYgKGNvbnRhY3QucXVldWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgY29udGFjdC5xdWV1ZS5xdWV1ZUlkID0gY29udGFjdC5xdWV1ZS5xdWV1ZUFSTjsKICAgICAgICB9CiAgICAgIH0pOwogICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucm91dGluZ1Byb2ZpbGVJZCA9CiAgICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnJvdXRpbmdQcm9maWxlQVJOOwogICAgICAKICAgICAgaWYgKHRoaXMuc3VwcHJlc3MpIHsKICAgICAgICB0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzID0gdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cy5maWx0ZXIoZnVuY3Rpb24oY29udGFjdCl7CiAgICAgICAgICByZXR1cm4gKGNvbnRhY3Quc3RhdGUudHlwZSA9PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuSE9MRCB8fCBjb250YWN0LnN0YXRlLnR5cGUgPT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RFRCk7CiAgICAgICAgfSk7CiAgICAgICAgaWYgKHRoaXMuZm9yY2VPZmZsaW5lKSB7CiAgICAgICAgICB0aGlzLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLkZPUkNFX09GRkxJTkUpOwogICAgICAgIH0KICAgICAgfSAKICAgICAgdGhpcy5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuQWdlbnRFdmVudHMuVVBEQVRFLCB0aGlzLmFnZW50KTsKICAgIH0KICB9OwoKLyoqCiAqIFByb3ZpZGVzIGEgd2Vic29ja2V0IHVybCB0aHJvdWdoIHRoZSBjcmVhdGVfdHJhbnNwb3J0IEFQSS4KICogQHJldHVybnMgYSBwcm9taXNlIHdoaWNoLCB1cG9uIHN1Y2Nlc3MsIHJldHVybnMgdGhlIHJlc3BvbnNlIGZyb20gdGhlIGNyZWF0ZVRyYW5zcG9ydCBBUEkuCiAqLwogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuZ2V0V2ViU29ja2V0VXJsID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBvbkF1dGhGYWlsID0gY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKTsKICAgIHZhciBvbkFjY2Vzc0RlbmllZCA9IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNSRUFURV9UUkFOU1BPUlQsIHsgdHJhbnNwb3J0VHlwZTogY29ubmVjdC5UUkFOU1BPUlRfVFlQRVMuV0VCX1NPQ0tFVCB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZ2V0V2ViU29ja2V0VXJsIHN1Y2NlZWRlZCIpOwogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldFdlYlNvY2tldFVybCBmYWlsZWQiKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgIHJlamVjdChFcnJvcigiZ2V0V2ViU29ja2V0VXJsIGZhaWxlZCIpKTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJnZXRXZWJTb2NrZXRVcmwgQXV0aCBGYWlsdXJlIik7CiAgICAgICAgICByZWplY3QoRXJyb3IoIkF1dGhlbnRpY2F0aW9uIGZhaWxlZCB3aGlsZSBnZXR0aW5nIGdldFdlYlNvY2tldFVybCIpKTsKICAgICAgICAgIG9uQXV0aEZhaWwoKTsKICAgICAgICB9LAogICAgICAgIGFjY2Vzc0RlbmllZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0V2ViU29ja2V0VXJsIEFjY2VzcyBEZW5pZWQgRmFpbHVyZSIpOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJBY2Nlc3MgRGVuaWVkIEZhaWx1cmUgd2hpbGUgZ2V0dGluZyBnZXRXZWJTb2NrZXRVcmwiKSk7CiAgICAgICAgICBvbkFjY2Vzc0RlbmllZCgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKCiAgLyoqCiAgICAqIFNlbmQgYSBtZXNzYWdlIGRvd25zdHJlYW0gdG8gYWxsIGNvbnN1bWVycyB3aGVuIHdlIGRldGVjdCB0aGF0IGF1dGhlbnRpY2F0aW9uCiAgICAqIGFnYWluc3Qgb25lIG9mIG91ciBBUElzIGhhcyBmYWlsZWQuCiAgICAqLwogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlU2VuZExvZ3NSZXF1ZXN0ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGxvZ0V2ZW50cyA9IFtdOwogICAgdmFyIGxvZ3NUb1NlbmQgPSBzZWxmLmxvZ3NCdWZmZXIuc2xpY2UoKTsKICAgIHNlbGYubG9nc0J1ZmZlciA9IFtdOwogICAgbG9nc1RvU2VuZC5mb3JFYWNoKGZ1bmN0aW9uIChsb2cpIHsKICAgICAgbG9nRXZlbnRzLnB1c2goewogICAgICAgIHRpbWVzdGFtcDogbG9nLnRpbWUsCiAgICAgICAgY29tcG9uZW50OiBsb2cuY29tcG9uZW50LAogICAgICAgIG1lc3NhZ2U6IGxvZy50ZXh0CiAgICAgIH0pOwogICAgfSk7CiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX0NMSUVOVF9MT0dTLCB7IGxvZ0V2ZW50czogbG9nRXZlbnRzIH0sIHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlNlbmRMb2dzIHJlcXVlc3Qgc3VjY2VlZGVkLiIpOwogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiU2VuZExvZ3MgcmVxdWVzdCBmYWlsZWQuIikud2l0aE9iamVjdChkYXRhKS53aXRoRXhjZXB0aW9uKGVycik7CiAgICAgIH0sCiAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpCiAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZUF1dGhGYWlsID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhfRkFJTCk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVBY2Nlc3NEZW5pZWQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNDRVNTX0RFTklFRCk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5jaGVja0F1dGhUb2tlbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBleHBpcmF0aW9uRGF0ZSA9IG5ldyBEYXRlKHNlbGYuaW5pdERhdGEuYXV0aFRva2VuRXhwaXJhdGlvbik7CiAgICB2YXIgY3VycmVudFRpbWVTdGFtcCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgdmFyIHRoaXJ0eU1pbnMgPSAzMCAqIDYwICogMTAwMDsKCiAgICAvLyByZWZyZXNoIHRva2VuIDMwIG1pbnV0ZXMgYmVmb3JlIGV4cGlyYXRpb24KICAgIGlmIChleHBpcmF0aW9uRGF0ZS5nZXRUaW1lKCkgPCAoY3VycmVudFRpbWVTdGFtcCArIHRoaXJ0eU1pbnMpKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQXV0aCB0b2tlbiBleHBpcmVzIGF0ICIgKyBleHBpcmF0aW9uRGF0ZSArICIgU3RhcnQgcmVmcmVzaGluZyB0b2tlbiB3aXRoIHJldHJ5LiIpOwogICAgICBjb25uZWN0LmJhY2tvZmYoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmF1dGhvcml6ZSksIFJFRlJFU0hfQVVUSF9UT0tFTl9JTlRFUlZBTF9NUywgUkVGUkVTSF9BVVRIX1RPS0VOX01BWF9UUlkpOwogICAgfQogIH07CgoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmF1dGhvcml6ZSA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGNvbm5lY3QuY29yZS5hdXRob3JpemUodGhpcy5pbml0RGF0YS5hdXRob3JpemVFbmRwb2ludCkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgdmFyIGV4cGlyYXRpb24gPSBuZXcgRGF0ZShyZXNwb25zZS5leHBpcmF0aW9uKTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJBdXRob3JpemF0aW9uIHN1Y2NlZWRlZCBhbmQgdGhlIHRva2VuIGV4cGlyZXMgYXQgJXMiLCBleHBpcmF0aW9uKTsKICAgICAgc2VsZi5pbml0RGF0YS5hdXRoVG9rZW4gPSByZXNwb25zZS5hY2Nlc3NUb2tlbjsKICAgICAgc2VsZi5pbml0RGF0YS5hdXRoVG9rZW5FeHBpcmF0aW9uID0gZXhwaXJhdGlvbjsKICAgICAgY29ubmVjdC5jb3JlLmluaXRDbGllbnQoc2VsZi5pbml0RGF0YSk7CiAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKCk7CiAgICB9KS5jYXRjaChmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiQXV0aG9yaXphdGlvbiBmYWlsZWQgd2l0aCBjb2RlICVzIiwgcmVzcG9uc2Uuc3RhdHVzKTsKICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gNDAxKSB7CiAgICAgICAgc2VsZi5oYW5kbGVBdXRoRmFpbCgpOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKCk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIC8qKgogICAqIEZpbHRlciB0aGUgJ2F1dGhlbnRpY2F0aW9uJyBmaWVsZCBvZiB0aGUgcmVxdWVzdCBwYXJhbXMgZnJvbSB0aGUgZ2l2ZW4gQVBJX1JFUVVFU1QgZXZlbnQuCiAgICovCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5maWx0ZXJBdXRoVG9rZW4gPSBmdW5jdGlvbiAocmVxdWVzdCkgewogICAgdmFyIG5ld19yZXF1ZXN0ID0ge307CgogICAgZm9yICh2YXIga2V5QSBpbiByZXF1ZXN0KSB7CiAgICAgIGlmIChrZXlBID09PSAncGFyYW1zJykgewogICAgICAgIHZhciBuZXdfcGFyYW1zID0ge307CiAgICAgICAgZm9yICh2YXIga2V5QiBpbiByZXF1ZXN0LnBhcmFtcykgewogICAgICAgICAgaWYgKGtleUIgIT09ICdhdXRoZW50aWNhdGlvbicpIHsKICAgICAgICAgICAgbmV3X3BhcmFtc1trZXlCXSA9IHJlcXVlc3QucGFyYW1zW2tleUJdOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbmV3X3JlcXVlc3QucGFyYW1zID0gbmV3X3BhcmFtczsKICAgICAgfSBlbHNlIHsKICAgICAgICBuZXdfcmVxdWVzdFtrZXlBXSA9IHJlcXVlc3Rba2V5QV07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbmV3X3JlcXVlc3Q7CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3Qud29ya2VyLm1haW4gPSBmdW5jdGlvbiAoKSB7CiAgICBjb25uZWN0Lndvcmtlci5jbGllbnRFbmdpbmUgPSBuZXcgQ2xpZW50RW5naW5lKCk7CiAgfTsKCn0pKCk7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBbWF6b24gU29mdHdhcmUgTGljZW5zZSAodGhlICJMaWNlbnNlIikuIFlvdSBtYXkgbm90IHVzZQogKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzCiAqIGxvY2F0ZWQgYXQKICoKICogICAgaHR0cDovL2F3cy5hbWF6b24uY29tL2FzbC8KICoKICogb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZAogKiBvbiBhbiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcwogKiBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMKICogYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKi8KCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKCiAgY29ubmVjdC5DaGF0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKG1lZGlhSW5mbywgbWV0YWRhdGEpIHsKICAgIHZhciBsb2dnZXIgPSBjb25uZWN0LmdldExvZygpOwogICAgdmFyIGxvZ0NvbXBvbmVudCA9IGNvbm5lY3QuTG9nQ29tcG9uZW50LkNIQVQ7CgogICAgdmFyIGNyZWF0ZU1lZGlhSW5zdGFuY2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBtZWRpYSBjb250cm9sbGVyIGluaXQiLCBtZWRpYUluZm8uY29udGFjdElkKTsKICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAiQ2hhdCBtZWRpYSBjb250cm9sbGVyIGluaXQiKS53aXRoT2JqZWN0KG1lZGlhSW5mbyk7CgogICAgICBjb25uZWN0LkNoYXRTZXNzaW9uLnNldEdsb2JhbENvbmZpZyh7CiAgICAgICAgbG9nZ2VyQ29uZmlnOiB7CiAgICAgICAgICBsb2dnZXI6IGxvZ2dlcgogICAgICAgIH0sCiAgICAgICAgcmVnaW9uOiBtZXRhZGF0YS5yZWdpb24KICAgICAgfSk7CgogICAgICAvKiogQ291bGQgYmUgYWxzbyBDVVNUT01FUiAtICBGb3Igbm93IHdlIGFyZSBjcmVhdGluZyBvbmx5IEFnZW50IGNvbm5lY3Rpb24gbWVkaWEgb2JqZWN0ICovCiAgICAgIHZhciBjb250cm9sbGVyID0gY29ubmVjdC5DaGF0U2Vzc2lvbi5jcmVhdGUoewogICAgICAgIGNoYXREZXRhaWxzOiBtZWRpYUluZm8sCiAgICAgICAgdHlwZTogIkFHRU5UIiwKICAgICAgICB3ZWJzb2NrZXRNYW5hZ2VyOiBjb25uZWN0LmNvcmUuZ2V0V2ViU29ja2V0TWFuYWdlcigpCiAgICAgIH0pOwogICAgICAKICAgICAgdHJhY2tDaGF0Q29ubmVjdGlvblN0YXR1cyhjb250cm9sbGVyKTsKICAgICAgcmV0dXJuIGNvbnRyb2xsZXIKICAgICAgICAuY29ubmVjdCgpCiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGxvZ2dlci5pbmZvKGxvZ0NvbXBvbmVudCwgIkNoYXQgU2Vzc2lvbiBTdWNjZXNzZnVsbHkgZXN0YWJsaXNoZWQgZm9yIGNvbnRhY3RJZCAlcyIsIG1lZGlhSW5mby5jb250YWN0SWQpOwogICAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDaGF0IFNlc3Npb24gU3VjY2Vzc2Z1bGx5IGVzdGFibGlzaGVkIiwgbWVkaWFJbmZvLmNvbnRhY3RJZCk7CiAgICAgICAgICByZXR1cm4gY29udHJvbGxlcjsKICAgICAgICB9KQogICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgIGxvZ2dlci5lcnJvcihsb2dDb21wb25lbnQsICJDaGF0IFNlc3Npb24gZXN0YWJsaXNoZW1lbnQgZmFpbGVkIGZvciBjb250YWN0ICVzIiwgbWVkaWFJbmZvLmNvbnRhY3RJZCkud2l0aEV4Y2VwdGlvbihlcnJvcik7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgU2Vzc2lvbiBlc3RhYmxpc2hlbWVudCBmYWlsZWQiLCBtZWRpYUluZm8uY29udGFjdElkLCBlcnJvcik7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9KTsKICAgIH07CgogICAgdmFyIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGRhdGEpIHsKICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICBuYW1lOiBldmVudE5hbWUsCiAgICAgICAgY29udGFjdElkOiBtZWRpYUluZm8uY29udGFjdElkLAogICAgICAgIGRhdGE6IGRhdGEgfHwgbWVkaWFJbmZvCiAgICAgIH0pOwogICAgfTsKCiAgICB2YXIgdHJhY2tDaGF0Q29ubmVjdGlvblN0YXR1cyA9IGZ1bmN0aW9uIChjb250cm9sbGVyKSB7CiAgICAgIGNvbnRyb2xsZXIub25Db25uZWN0aW9uQnJva2VuKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgbG9nZ2VyLmVycm9yKGxvZ0NvbXBvbmVudCwgIkNoYXQgU2Vzc2lvbiBjb25uZWN0aW9uIGJyb2tlbiIpLndpdGhFeGNlcHRpb24oZGF0YSk7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDaGF0IFNlc3Npb24gY29ubmVjdGlvbiBicm9rZW4iLCBkYXRhKTsKICAgICAgfSk7CgogICAgICBjb250cm9sbGVyLm9uQ29ubmVjdGlvbkVzdGFibGlzaGVkKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAiQ2hhdCBTZXNzaW9uIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQiKS53aXRoT2JqZWN0KGRhdGEpOwogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBTZXNzaW9uIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQiLCBkYXRhKTsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNyZWF0ZU1lZGlhSW5zdGFuY2UoKTsKICAgICAgfQogICAgfQogIH0KfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFtYXpvbiBTb2Z0d2FyZSBMaWNlbnNlICh0aGUgIkxpY2Vuc2UiKS4gWW91IG1heSBub3QgdXNlCiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMKICogbG9jYXRlZCBhdAogKgogKiAgICBodHRwOi8vYXdzLmFtYXpvbi5jb20vYXNsLwogKgogKiBvciBpbiB0aGUgImxpY2Vuc2UiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkCiAqIG9uIGFuICJBUyBJUyIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzCiAqIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucwogKiBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwoKKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwoKICBjb25uZWN0Lk1lZGlhRmFjdG9yeSA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIC8qKiBjb250cm9sbGVyIGhvbGRlciAqLwogICAgdmFyIG1lZGlhQ29udHJvbGxlcnMgPSB7fTsKCiAgICB2YXIgbG9nZ2VyID0gY29ubmVjdC5nZXRMb2coKTsKICAgIHZhciBsb2dDb21wb25lbnQgPSBjb25uZWN0LkxvZ0NvbXBvbmVudC5DSEFUOwoKICAgIHZhciBtZXRhZGF0YSA9IHBhcmFtcyB8fCB7fTsKICAgIG1ldGFkYXRhLnJlZ2lvbiA9ICBtZXRhZGF0YS5yZWdpb24gfHwgInVzLXdlc3QtMiI7IC8vIERlZmF1bHQgaXQgdG8gdXMtd2VzdC0yCgogICAgdmFyIGdldE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uIChjb25uZWN0aW9uT2JqKSB7CiAgICAgIHZhciBjb25uZWN0aW9uSWQgPSBjb25uZWN0aW9uT2JqLmdldENvbm5lY3Rpb25JZCgpOwogICAgICB2YXIgbWVkaWFJbmZvID0gY29ubmVjdGlvbk9iai5nZXRNZWRpYUluZm8oKTsKICAgICAgLyoqIGlmIHdlIGRvIG5vdCBoYXZlIHRoZSBtZWRpYSBpbmZvIHRoZW4ganVzdCByZWplY3QgdGhlIHJlcXVlc3QgKi8KICAgICAgaWYgKCFtZWRpYUluZm8pIHsKICAgICAgICBsb2dnZXIuZXJyb3IobG9nQ29tcG9uZW50LCAiTWVkaWEgaW5mbyBkb2VzIG5vdCBleGlzdHMgZm9yIGEgbWVkaWEgdHlwZSAlcyIpLndpdGhPYmplY3QoY29ubmVjdGlvbk9iaik7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJNZWRpYSBpbmZvIGRvZXMgbm90IGV4aXN0cyBmb3IgdGhpcyBjb25uZWN0aW9uIik7CiAgICAgIH0KCiAgICAgIGlmICghbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdKSB7CiAgICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAibWVkaWEgY29udHJvbGxlciBvZiB0eXBlICVzIGluaXQiLCBjb25uZWN0aW9uT2JqLmdldE1lZGlhVHlwZSgpKS53aXRoT2JqZWN0KGNvbm5lY3Rpb25PYmopOwogICAgICAgIHN3aXRjaCAoY29ubmVjdGlvbk9iai5nZXRNZWRpYVR5cGUoKSkgewogICAgICAgICAgY2FzZSBjb25uZWN0Lk1lZGlhVHlwZS5DSEFUOgogICAgICAgICAgICByZXR1cm4gbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdID0gbmV3IGNvbm5lY3QuQ2hhdE1lZGlhQ29udHJvbGxlcihjb25uZWN0aW9uT2JqLmdldE1lZGlhSW5mbygpLCBtZXRhZGF0YSkuZ2V0KCk7CiAgICAgICAgICBjYXNlIGNvbm5lY3QuTWVkaWFUeXBlLlNPRlRQSE9ORToKICAgICAgICAgICAgcmV0dXJuIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXSA9IG5ldyBjb25uZWN0LlNvZnRwaG9uZU1lZGlhQ29udHJvbGxlcihjb25uZWN0aW9uT2JqLmdldE1lZGlhSW5mbygpKS5nZXQoKTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihsb2dDb21wb25lbnQsICJVbnJlY29nbml6ZWQgbWVkaWEgdHlwZSAlcyAiLCBjb25uZWN0aW9uT2JqLmdldE1lZGlhVHlwZSgpKTsKICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF07CiAgICAgIH0KICAgIH07CgogICAgLyoqIENoZWNrIGFsbCB0aGUgYWN0aXZlIHN0YXRlcyBmb3IgdGhlIGNvbm5lY3Rpb24gKi8KICAgIHZhciBpZkNvbm5lY3Rpb25BY3RpdmUgPSBmdW5jdGlvbiAoY29ubmVjdGlvbk9iaikgewogICAgICByZXR1cm4gY29ubmVjdGlvbk9iai5pc0FjdGl2ZSgpOwogICAgfTsKCiAgICB2YXIgZ2V0ID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25PYmopIHsKICAgICAgaWYgKGlmQ29ubmVjdGlvbkFjdGl2ZShjb25uZWN0aW9uT2JqKSkgewogICAgICAgIHJldHVybiBnZXRNZWRpYUNvbnRyb2xsZXIoY29ubmVjdGlvbk9iaik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGVzdHJveShjb25uZWN0aW9uT2JqLmdldENvbm5lY3Rpb25JZCgpKTsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoIk1lZGlhIENvbnRyb2xsZXIgaXMgbm8gbG9uZ2VyIGF2YWlsYWJsZSBmb3IgdGhpcyBjb25uZWN0aW9uIik7CiAgICAgIH0KICAgIH07CgogICAgdmFyIGRlc3Ryb3kgPSBmdW5jdGlvbiAoY29ubmVjdGlvbklkKSB7CiAgICAgIGlmIChtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0pIHsKICAgICAgICBsb2dnZXIuaW5mbyhsb2dDb21wb25lbnQsICJEZXN0cm95aW5nIG1lZGlhQ29udHJvbGxlciBmb3IgJXMiLCBjb25uZWN0aW9uSWQpOwogICAgICAgIGRlbGV0ZSBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF07CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIHsKICAgICAgZ2V0OiBnZXQsCiAgICAgIGRlc3Ryb3k6IGRlc3Ryb3kKICAgIH07CiAgfQp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQW1hem9uIFNvZnR3YXJlIExpY2Vuc2UgKHRoZSAiTGljZW5zZSIpLiBZb3UgbWF5IG5vdCB1c2UKICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcwogKiBsb2NhdGVkIGF0CiAqCiAqICAgIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hc2wvCiAqCiAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQKICogb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3MKICogb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zCiAqIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIC8vIFRPRE8gbW92ZSBzb2Z0cGhvbmUgaW1wbGVtZW50YXRpb25zIGhlcmUgLSBXaWwgZG8gdGhpcyBmb3IgR0EKICBjb25uZWN0LlNvZnRwaG9uZU1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uIChtZWRpYUluZm8pIHsKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobWVkaWFJbmZvKQogICAgICB9CiAgICB9CiAgfQp9KSgpOwo=");I.prototype._createFramedCcp=function(I){var g=this.style||"margin: 0; border: 0; padding: 0px; width: 0px; height: 0px",C=document.createElement("iframe");return C.srcdoc=this.getContent(I),C.allow="microphone; autoplay",C.id=this.id,C.style=g,C.scrolling="no",C},I.prototype.getContent=function(I){return["<!DOCTYPE html>","<meta charset='UTF-8'>","<html>","<head>","<script type='text/javascript'>",g,"<\/script>","</head>","<body onload='init()'>","<div id=containerDiv style='width: 100%;height: "+this.height+"'></div>","<script type='text/javascript'>","function init() {","connect.core.initCCP(containerDiv,"+I+");","}","<\/script>","</body>","</html>"].join("")},globalConnect.Container=I}(),function(){var I=this;connect=I.connect||{},globalConnect=I.globalConnect||{},I.connect=connect,I.globalConnect=globalConnect,I.lily=connect,connect.core={},globalConnect.core={regions:{}};function G(I,g){if(connect.assertTrue("string"==typeof I,"Region provided "+I+" is not a valid string"),!(g||globalConnect.core.regions).hasOwnProperty(I)){I="Region provided "+I+" is not found!";throw new connect.ValueError(I)}}var Z="465px",c=!0,d=function(I){I=window.getComputedStyle(I);return{height:I.getPropertyValue("height"),width:I.getPropertyValue("width"),display:I.getPropertyValue("display")}};globalConnect.core.initCCP=function(l,I){connect.assertNotNull(I.getPrimaryRegion,"getPrimaryRegion"),connect.assertTrue(connect.isFunction(I.getPrimaryRegion),"getPrimaryRegion must be a function");var g=I.getPrimaryRegion;delete I.getPrimaryRegion;var b=function(I,g){connect.assertNotNull(g.standByRegion,"ccpBackupResource"),connect.assertNotNull(g.standByRegion.ccpUrl,"ccpUrl"),connect.assertNotNull(g.standByRegion.loginUrl,"loginUrl"),connect.assertNotNull(g.standByRegion.region,"region");var C=g,g=Object.assign({},g,{ccpUrl:g.standByRegion.ccpUrl,loginUrl:g.standByRegion.loginUrl,region:g.standByRegion.region}),A=d(I);return"none"==A.display&&(c=!1),parseInt(A.height)<=0&&(I.style.height=Z,A.height=Z),[C,g].map(function(I){return connect.assertNotNull(I.ccpUrl,"ccpUrl"),connect.assertNotNull(I.loginUrl,"loginUrl"),connect.assertNotNull(I.region,"region"),delete I.standByRegion,I.loginPopup=!1,I.disasterRecoveryOn=!0,I.iframe_style="margin: 0; border: 0; padding:0px;width: 0px;height: 0px",I.height=A.height,I})}(l,I);g(function(A){var I=b.reduce(function(I,g){return I[g.region]=null,I},{});G(A,I);var g=b.map(function(I){return I.region===A&&(I.isPrimary=!0),new globalConnect.Container(I)}),C=g.map(function(I){return I.ccp.outerHTML}),Z=document.createElement("iframe");Z.style="margin: 0; border: 0; padding:0px;width: 100%;height: 100%",Z.id="globalCCP",Z.scrolling="no",Z.onload=function(){var C;c&&(C=Object.keys(I).find(function(I){return I!=A}),W(A,Z.id),B(C,Z.id)),g.map(function(I){globalConnect.core.regions[I.region]=Z.contentDocument.getElementById(I.id).contentWindow.connect;var g=globalConnect.core.regions[I.region];g.core.getUpstream().onUpstream(g.DisasterRecoveryEvents.FAILOVER,function(I){I.isPrimary?(connect=g,A=connect.core.region,c&&W(A,Z.id)):c&&(C=g.core.region,B(C,Z.id))})}),connect=globalConnect.core.regions[A]},Z.srcdoc=C.join(""),l.appendChild(Z)},function(){console.log("[Disaster Recovery] An error occured, while attempting to retrieve your primary region;")})};function C(g){return g=g||connect.core.region,Object.keys(globalConnect.core.regions).find(function(I){return I!==g})}var B=function(I,g){I=I.replace(/-/g,"_"),document.getElementById(g).contentDocument.getElementById(I).style="height: 0; width: 0; border: 0px"},W=function(I,g){I=I.replace(/-/g,"_"),document.getElementById(g).contentDocument.getElementById(I).style="height:800px;width:100%;border:0px"};globalConnect.core.failover=function(){globalConnect.core.failoverTo(C())},globalConnect.core.failoverTo=function(I){G(I);var g=C(I);A(g),l(I),connect=globalConnect.core.regions[I]};var A=function(I){I=globalConnect.core.regions[I];I.getLog().info("[Disaster Recovery] Deactivating %s region.",I.core.region),I.core.suppressContacts(!0),I.core.forceOffline()},l=function(I){I=globalConnect.core.regions[I];I.getLog().info("[Disaster Recovery] Activating %s region.",I.core.region),I.core.suppressContacts(!1)};connect.core.initCCP=globalConnect.core.initCCP}();