!function(){var V=function(){return V.cache.hasOwnProperty(arguments[0])||(V.cache[arguments[0]]=V.parse(arguments[0])),V.format.call(null,V.cache[arguments[0]],arguments)};V.format=function(I,g){for(var C,A,Z,l,b,G,c=1,d=I.length,B=[],W=0;W<d;W++)if("string"===(C=m(I[W])))B.push(I[W]);else if("array"===C){if((l=I[W])[2])for(A=g[c],Z=0;Z<l[2].length;Z++){if(!A.hasOwnProperty(l[2][Z]))throw V('[sprintf] property "%s" does not exist',l[2][Z]);A=A[l[2][Z]]}else A=l[1]?g[l[1]]:g[c++];if(/[^s]/.test(l[8])&&"number"!=m(A))throw V("[sprintf] expecting number but found %s",m(A));switch(l[8]){case"b":A=A.toString(2);break;case"c":A=String.fromCharCode(A);break;case"d":A=parseInt(A,10);break;case"e":A=l[7]?A.toExponential(l[7]):A.toExponential();break;case"f":A=l[7]?parseFloat(A).toFixed(l[7]):parseFloat(A);break;case"o":A=A.toString(8);break;case"s":A=(A=String(A))&&l[7]?A.substring(0,l[7]):A;break;case"u":A>>>=0;break;case"x":A=A.toString(16);break;case"X":A=A.toString(16).toUpperCase()}A=/[def]/.test(l[8])&&l[3]&&0<=A?"+"+A:A,b=l[4]?"0"==l[4]?"0":l[4].charAt(1):" ",G=l[6]-String(A).length,G=l[6]?function(I,g){for(var C=[];0<g;C[--g]=I);return C.join("")}(b,G):"",B.push(l[5]?A+G:G+A)}return B.join("")},V.cache={},V.parse=function(I){for(var g=I,C=[],A=[],Z=0;g;){if(null!==(C=/^[^\x25]+/.exec(g)))A.push(C[0]);else if(null!==(C=/^\x25{2}/.exec(g)))A.push("%");else{if(null===(C=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(g)))throw"[sprintf] huh?";if(C[2]){Z|=1;var l=[],b=C[2],G=[];if(null===(G=/^([a-z_][a-z_\d]*)/i.exec(b)))throw"[sprintf] huh?";for(l.push(G[1]);""!==(b=b.substring(G[0].length));)if(null!==(G=/^\.([a-z_][a-z_\d]*)/i.exec(b)))l.push(G[1]);else{if(null===(G=/^\[(\d+)\]/.exec(b)))throw"[sprintf] huh?";l.push(G[1])}C[2]=l}else Z|=2;if(3===Z)throw"[sprintf] mixing positional and named placeholders is not (yet) supported";A.push(C)}g=g.substring(C[0].length)}return A};function m(I){return Object.prototype.toString.call(I).slice(8,-1).toLowerCase()}this.sprintf=V,this.vsprintf=function(I,g,C){return(C=g.slice(0)).splice(0,0,I),V.apply(null,C)}}(),function(){var c=this;connect=c.connect||{},c.connect=connect,c.lily=connect;var g=navigator.userAgent;connect.sprintf=c.sprintf,connect.vsprintf=c.vsprintf,delete c.sprintf,delete c.vsprintf,connect.HTTP_STATUS_CODES={SUCCESS:200,TOO_MANY_REQUESTS:429,INTERNAL_SERVER_ERROR:500},connect.TRANSPORT_TYPES={CHAT_TOKEN:"chat_token",WEB_SOCKET:"web_socket"},connect.hitch=function(){var g=Array.prototype.slice.call(arguments),C=g.shift(),A=g.shift();return connect.assertNotNull(C,"scope"),connect.assertNotNull(A,"method"),connect.assertTrue(connect.isFunction(A),"method must be a function"),function(){var I=Array.prototype.slice.call(arguments);return A.apply(C,g.concat(I))}},connect.isFunction=function(I){return!!(I&&I.constructor&&I.call&&I.apply)},connect.isArray=function(I){return"[object Array]"===Object.prototype.toString.call(I)},connect.keys=function(I){var g,C=[];for(g in connect.assertNotNull(I,"map"),I)C.push(g);return C},connect.values=function(I){var g,C=[];for(g in connect.assertNotNull(I,"map"),I)C.push(I[g]);return C},connect.entries=function(I){var g,C=[];for(g in I)C.push({key:g,value:I[g]});return C},connect.merge=function(){var I=Array.prototype.slice.call(arguments,0),g={};return I.forEach(function(I){connect.entries(I).forEach(function(I){g[I.key]=I.value})}),g},connect.now=function(){return(new Date).getTime()},connect.find=function(I,g){for(var C=0;C<I.length;C++)if(g(I[C]))return I[C];return null},connect.contains=function(I,g){return I instanceof Array?null!=connect.find(I,function(I){return I===g}):g in I},connect.containsValue=function(I,g){return I instanceof Array?null!=connect.find(I,function(I){return I===g}):null!=connect.find(connect.values(I),function(I){return I===g})},connect.randomId=function(){return connect.sprintf("%s-%s",connect.now(),Math.random().toString(36).slice(2))},connect.makeEnum=function(I){var C={};return I.forEach(function(I){var g=I.replace(/\.?([a-z]+)_?/g,function(I,g){return g.toUpperCase()+"_"}).replace(/_$/,"");C[g]=I}),C},connect.makeNamespacedEnum=function(g,I){var C=connect.makeEnum(I);return connect.keys(C).forEach(function(I){C[I]=connect.sprintf("%s::%s",g,C[I])}),C},connect.isChromeBrowser=function(){return-1!==g.indexOf("Chrome")},connect.isFirefoxBrowser=function(){return-1!==g.indexOf("Firefox")},connect.isOperaBrowser=function(){return-1!==g.indexOf("Opera")},connect.getChromeBrowserVersion=function(){var I=g.substring(g.indexOf("Chrome")+7);return I?parseFloat(I):-1},connect.getFirefoxBrowserVersion=function(){var I=g.substring(g.indexOf("Firefox")+8);return I?parseFloat(I):-1},connect.getOperaBrowserVersion=function(){var I=g.indexOf("Opera"),I=-1!==g.indexOf("Version")?g.substring(I+8):g.substring(I+6);return I?parseFloat(I):-1},connect.index=function(I,g){var C={};return I.forEach(function(I){C[g(I)]=I}),C},connect.set=function(I){var g={};return I.forEach(function(I){g[I]=1}),g},connect.relativeComplement=function(g,C){var A={};return connect.keys(C).forEach(function(I){I in g||(A[I]=C[I])}),A},connect.assertTrue=function(I,g){if(!I)throw new connect.ValueError(g)},connect.assertNotNull=function(I,g){return connect.assertTrue(null!=I&&!0,connect.sprintf("%s must be provided",g||"A value")),I},connect.deepcopy=function(I){return JSON.parse(JSON.stringify(I))},connect.getBaseUrl=function(){var I=c.location;return connect.sprintf("%s//%s:%s",I.protocol,I.hostname,I.port)},connect.isFramed=function(){try{return window.self!==window.top}catch(I){return!0}},connect.fetch=function(I,l,b,g){return g=g||5,b=b||1e3,l=l||{},new Promise(function(A,Z){!function g(C){fetch(I,l).then(function(I){I.status===connect.HTTP_STATUS_CODES.SUCCESS?A(I.json()):1!==C&&(I.status>=connect.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR||I.status===connect.HTTP_STATUS_CODES.TOO_MANY_REQUESTS)?setTimeout(function(){g(--C)},b):Z(I)}).catch(function(I){Z(I)})}(g)})},connect.backoff=function(A,Z,l,b){connect.assertTrue(connect.isFunction(A),"func must be a Function");var G=this;A({success:function(I){b&&b.success&&b.success(I)},failure:function(I,g){var C;0<l?(C=2*Z*Math.random(),c.setTimeout(function(){G.backoff(A,2*C,--l,b)},C)):b&&b.failure&&b.failure(I,g)}})},connect.publishMetric=function(I){connect.core.getEventBus().trigger(connect.EventType.CLIENT_METRIC,I)},connect.publishSoftphoneStats=function(I){connect.core.getEventBus().trigger(connect.EventType.SOFTPHONE_STATS,I)},connect.publishSoftphoneReport=function(I){connect.core.getEventBus().trigger(connect.EventType.SOFTPHONE_REPORT,I)},connect.PopupManager=function(){},connect.PopupManager.prototype.open=function(I,g){var C=this._getLastOpenedTimestamp(g),A=(new Date).getTime(),Z=null;return 864e5<A-C&&((Z=window.open("",g)).location!==I&&(Z=window.open(I,g)),this._setLastOpenedTimestamp(g,A)),Z},connect.PopupManager.prototype.clear=function(I){I=this._getLocalStorageKey(I);c.localStorage.removeItem(I)},connect.PopupManager.prototype._getLastOpenedTimestamp=function(I){I=this._getLocalStorageKey(I),I=c.localStorage.getItem(I);return I?parseInt(I,10):0},connect.PopupManager.prototype._setLastOpenedTimestamp=function(I,g){I=this._getLocalStorageKey(I);c.localStorage.setItem(I,""+g)},connect.PopupManager.prototype._getLocalStorageKey=function(I){return"connectPopupManager::"+I};var C=connect.makeEnum(["granted","denied","default"]);connect.NotificationManager=function(){this.queue=[],this.permission=C.DEFAULT},connect.NotificationManager.prototype.requestPermission=function(){var g=this;"Notification"in c?c.Notification.permission===C.DENIED?(connect.getLog().warn("The user has requested to not receive notifications."),this.permission=C.DENIED):this.permission!==C.GRANTED&&c.Notification.requestPermission().then(function(I){(g.permission=I)===C.GRANTED?g._showQueued():g.queue=[]}):(connect.getLog().warn("This browser doesn't support notifications."),this.permission=C.DENIED)},connect.NotificationManager.prototype.show=function(I,g){if(this.permission===C.GRANTED)return this._showImpl({title:I,options:g});this.permission===C.DENIED?connect.getLog().warn("Unable to show notification.").withObject({title:I,options:g}):(g={title:I,options:g},connect.getLog().warn("Deferring notification until user decides to allow or deny.").withObject(g),this.queue.push(g))},connect.NotificationManager.prototype._showQueued=function(){var g=this,I=this.queue.map(function(I){return g._showImpl(I)});return this.queue=[],I},connect.NotificationManager.prototype._showImpl=function(I){var g=new c.Notification(I.title,I.options);return I.options.clicked&&(g.onclick=function(){I.options.clicked.call(g)}),g},connect.BaseError=function(I,g){c.Error.call(this,connect.vsprintf(I,g))},connect.BaseError.prototype=Object.create(Error.prototype),connect.BaseError.prototype.constructor=connect.BaseError,connect.ValueError=function(){var I=Array.prototype.slice.call(arguments,0),g=I.shift();connect.BaseError.call(this,g,I)},connect.ValueError.prototype=Object.create(connect.BaseError.prototype),connect.ValueError.prototype.constructor=connect.ValueError,connect.NotImplementedError=function(){var I=Array.prototype.slice.call(arguments,0),g=I.shift();connect.BaseError.call(this,g,I)},connect.NotImplementedError.prototype=Object.create(connect.BaseError.prototype),connect.NotImplementedError.prototype.constructor=connect.NotImplementedError,connect.StateError=function(){var I=Array.prototype.slice.call(arguments,0),g=I.shift();connect.BaseError.call(this,g,I)},connect.StateError.prototype=Object.create(connect.BaseError.prototype),connect.StateError.prototype.constructor=connect.StateError}(),function(){connect=this.connect||{},this.connect=connect,this.globalConnect={},this.lily=connect,globalConnect.Container=null;function I(I){this.region=I.region,this.id=this.region.replace(/-/g,"_"),this.height=I.height,this.style=I.iframe_style,this.ccp=this._createFramedCcp(JSON.stringify(I))}var g=window.atob("Ly8gQVdTIFNESyBmb3IgSmF2YVNjcmlwdCB2Mi41NTMuMAovLyBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KLy8gTGljZW5zZSBhdCBodHRwczovL3Nkay5hbWF6b25hd3MuY29tL2pzL0JVTkRMRV9MSUNFTlNFLnR4dAooZnVuY3Rpb24oKXtmdW5jdGlvbiByKGUsbix0KXtmdW5jdGlvbiBvKGksZil7aWYoIW5baV0pe2lmKCFlW2ldKXt2YXIgYz0iZnVuY3Rpb24iPT10eXBlb2YgcmVxdWlyZSYmcmVxdWlyZTtpZighZiYmYylyZXR1cm4gYyhpLCEwKTtpZih1KXJldHVybiB1KGksITApO3ZhciBhPW5ldyBFcnJvcigiQ2Fubm90IGZpbmQgbW9kdWxlICciK2krIiciKTt0aHJvdyBhLmNvZGU9Ik1PRFVMRV9OT1RfRk9VTkQiLGF9dmFyIHA9bltpXT17ZXhwb3J0czp7fX07ZVtpXVswXS5jYWxsKHAuZXhwb3J0cyxmdW5jdGlvbihyKXt2YXIgbj1lW2ldWzFdW3JdO3JldHVybiBvKG58fHIpfSxwLHAuZXhwb3J0cyxyLGUsbix0KX1yZXR1cm4gbltpXS5leHBvcnRzfWZvcih2YXIgdT0iZnVuY3Rpb24iPT10eXBlb2YgcmVxdWlyZSYmcmVxdWlyZSxpPTA7aTx0Lmxlbmd0aDtpKyspbyh0W2ldKTtyZXR1cm4gb31yZXR1cm4gcn0pKCkoezE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzPXsKICAgICJ2ZXJzaW9uIjogIjIuMCIsCiAgICAibWV0YWRhdGEiOiB7CiAgICAgICJhcGlWZXJzaW9uIjogIjIwMTQtMDYtMzAiLAogICAgICAiZW5kcG9pbnRQcmVmaXgiOiAiY29nbml0by1pZGVudGl0eSIsCiAgICAgICJqc29uVmVyc2lvbiI6ICIxLjEiLAogICAgICAicHJvdG9jb2wiOiAianNvbiIsCiAgICAgICJzZXJ2aWNlRnVsbE5hbWUiOiAiQW1hem9uIENvZ25pdG8gSWRlbnRpdHkiLAogICAgICAic2VydmljZUlkIjogIkNvZ25pdG8gSWRlbnRpdHkiLAogICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJ2NCIsCiAgICAgICJ0YXJnZXRQcmVmaXgiOiAiQVdTQ29nbml0b0lkZW50aXR5U2VydmljZSIsCiAgICAgICJ1aWQiOiAiY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwIgogICAgfSwKICAgICJvcGVyYXRpb25zIjogewogICAgICAiQ3JlYXRlSWRlbnRpdHlQb29sIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xOYW1lIiwKICAgICAgICAgICAgIkFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiOiB7fSwKICAgICAgICAgICAgIkFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiU3VwcG9ydGVkTG9naW5Qcm92aWRlcnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAgICJPcGVuSWRDb25uZWN0UHJvdmlkZXJBUk5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTOCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkNvZ25pdG9JZGVudGl0eVByb3ZpZGVycyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2EiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJTYW1sUHJvdmlkZXJBUk5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTZiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIklkZW50aXR5UG9vbFRhZ3MiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNnIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInNoYXBlIjogIlNqIgogICAgICAgIH0KICAgICAgfSwKICAgICAgIkRlbGV0ZUlkZW50aXRpZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWRzVG9EZWxldGUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkc1RvRGVsZXRlIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiVW5wcm9jZXNzZWRJZGVudGl0eUlkcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAgICAgICAiRXJyb3JDb2RlIjoge30KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJEZWxldGVJZGVudGl0eVBvb2wiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkRlc2NyaWJlSWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAic2hhcGUiOiAiU3UiCiAgICAgICAgfQogICAgICB9LAogICAgICAiRGVzY3JpYmVJZGVudGl0eVBvb2wiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTaiIKICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eUlkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTeiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkN1c3RvbVJvbGVBcm4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAiQWNjZXNzS2V5SWQiOiB7fSwKICAgICAgICAgICAgICAgICJTZWNyZXRLZXkiOiB7fSwKICAgICAgICAgICAgICAgICJTZXNzaW9uVG9rZW4iOiB7fSwKICAgICAgICAgICAgICAgICJFeHBpcmF0aW9uIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0SWQiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQWNjb3VudElkIjoge30sCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTeiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldElkZW50aXR5UG9vbFJvbGVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiUm9sZXMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMxYiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlJvbGVNYXBwaW5ncyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzFkIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0T3BlbklkVG9rZW4iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlN6IgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiVG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldE9wZW5JZFRva2VuRm9yRGV2ZWxvcGVySWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICAgIkxvZ2lucyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlN6IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiVG9rZW5EdXJhdGlvbiI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiVG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkxpc3RJZGVudGl0aWVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgICAgICJNYXhSZXN1bHRzIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICAgIk1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIk5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAiSGlkZURpc2FibGVkIjogewogICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiSWRlbnRpdGllcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlN1IgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTGlzdElkZW50aXR5UG9vbHMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIk1heFJlc3VsdHMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJNYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJOZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICAgICAgICJJZGVudGl0eVBvb2xOYW1lIjoge30KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJOZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkxpc3RUYWdzRm9yUmVzb3VyY2UiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJlc291cmNlQXJuIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUmVzb3VyY2VBcm4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlRhZ3MiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNnIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTG9va3VwRGV2ZWxvcGVySWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIkRldmVsb3BlclVzZXJJZGVudGlmaWVyIjoge30sCiAgICAgICAgICAgICJNYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJOZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIkRldmVsb3BlclVzZXJJZGVudGlmaWVyTGlzdCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTWVyZ2VEZXZlbG9wZXJJZGVudGl0aWVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJTb3VyY2VVc2VySWRlbnRpZmllciIsCiAgICAgICAgICAgICJEZXN0aW5hdGlvblVzZXJJZGVudGlmaWVyIiwKICAgICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSIsCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlNvdXJjZVVzZXJJZGVudGlmaWVyIjoge30sCiAgICAgICAgICAgICJEZXN0aW5hdGlvblVzZXJJZGVudGlmaWVyIjoge30sCiAgICAgICAgICAgICJEZXZlbG9wZXJQcm92aWRlck5hbWUiOiB7fSwKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTZXRJZGVudGl0eVBvb2xSb2xlcyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiLAogICAgICAgICAgICAiUm9sZXMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiUm9sZXMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMxYiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlJvbGVNYXBwaW5ncyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzFkIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVGFnUmVzb3VyY2UiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJlc291cmNlQXJuIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUmVzb3VyY2VBcm4iOiB7fSwKICAgICAgICAgICAgIlRhZ3MiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNnIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJVbmxpbmtEZXZlbG9wZXJJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlJZCIsCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgICAgICJEZXZlbG9wZXJQcm92aWRlck5hbWUiLAogICAgICAgICAgICAiRGV2ZWxvcGVyVXNlcklkZW50aWZpZXIiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAgICJEZXZlbG9wZXJVc2VySWRlbnRpZmllciI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVW5saW5rSWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWQiLAogICAgICAgICAgICAiTG9naW5zIiwKICAgICAgICAgICAgIkxvZ2luc1RvUmVtb3ZlIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTeiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkxvZ2luc1RvUmVtb3ZlIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTdiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlVudGFnUmVzb3VyY2UiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJlc291cmNlQXJuIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUmVzb3VyY2VBcm4iOiB7fSwKICAgICAgICAgICAgIlRhZ0tleXMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlVwZGF0ZUlkZW50aXR5UG9vbCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAic2hhcGUiOiAiU2oiCiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInNoYXBlIjogIlNqIgogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJzaGFwZXMiOiB7CiAgICAgICJTNCI6IHsKICAgICAgICAidHlwZSI6ICJtYXAiLAogICAgICAgICJrZXkiOiB7fSwKICAgICAgICAidmFsdWUiOiB7fQogICAgICB9LAogICAgICAiUzgiOiB7CiAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgIH0sCiAgICAgICJTYSI6IHsKICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAgICJDbGllbnRJZCI6IHt9LAogICAgICAgICAgICAiU2VydmVyU2lkZVRva2VuQ2hlY2siOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNmIjogewogICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICJtZW1iZXIiOiB7fQogICAgICB9LAogICAgICAiU2ciOiB7CiAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAia2V5Ijoge30sCiAgICAgICAgInZhbHVlIjoge30KICAgICAgfSwKICAgICAgIlNqIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICJJZGVudGl0eVBvb2xOYW1lIiwKICAgICAgICAgICJBbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiOiB7fSwKICAgICAgICAgICJBbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICB9LAogICAgICAgICAgIlN1cHBvcnRlZExvZ2luUHJvdmlkZXJzIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICB9LAogICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgIk9wZW5JZENvbm5lY3RQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTOCIKICAgICAgICAgIH0sCiAgICAgICAgICAiQ29nbml0b0lkZW50aXR5UHJvdmlkZXJzIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2EiCiAgICAgICAgICB9LAogICAgICAgICAgIlNhbWxQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTZiIKICAgICAgICAgIH0sCiAgICAgICAgICAiSWRlbnRpdHlQb29sVGFncyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNnIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlN1IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgIkxvZ2lucyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlN2IgogICAgICAgICAgfSwKICAgICAgICAgICJDcmVhdGlvbkRhdGUiOiB7CiAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgIH0sCiAgICAgICAgICAiTGFzdE1vZGlmaWVkRGF0ZSI6IHsKICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlN2IjogewogICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICJtZW1iZXIiOiB7fQogICAgICB9LAogICAgICAiU3oiOiB7CiAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAia2V5Ijoge30sCiAgICAgICAgInZhbHVlIjoge30KICAgICAgfSwKICAgICAgIlMxYiI6IHsKICAgICAgICAidHlwZSI6ICJtYXAiLAogICAgICAgICJrZXkiOiB7fSwKICAgICAgICAidmFsdWUiOiB7fQogICAgICB9LAogICAgICAiUzFkIjogewogICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgImtleSI6IHt9LAogICAgICAgICJ2YWx1ZSI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJUeXBlIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiVHlwZSI6IHt9LAogICAgICAgICAgICAiQW1iaWd1b3VzUm9sZVJlc29sdXRpb24iOiB7fSwKICAgICAgICAgICAgIlJ1bGVzQ29uZmlndXJhdGlvbiI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICJSdWxlcyIKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgIlJ1bGVzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICJDbGFpbSIsCiAgICAgICAgICAgICAgICAgICAgICAiTWF0Y2hUeXBlIiwKICAgICAgICAgICAgICAgICAgICAgICJWYWx1ZSIsCiAgICAgICAgICAgICAgICAgICAgICAiUm9sZUFSTiIKICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgIkNsYWltIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAiTWF0Y2hUeXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAiVmFsdWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJSb2xlQVJOIjoge30KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgfSx7fV0sMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHM9ewogICAgInBhZ2luYXRpb24iOiB7CiAgICB9CiAgfQogIAogIH0se31dLDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzPXsKICAgICJ2ZXJzaW9uIjogIjIuMCIsCiAgICAibWV0YWRhdGEiOiB7CiAgICAgICJhcGlWZXJzaW9uIjogIjIwMTctMDItMTUiLAogICAgICAiZW5kcG9pbnRQcmVmaXgiOiAiY29ubmVjdCIsCiAgICAgICJqc29uVmVyc2lvbiI6ICIxLjAiLAogICAgICAicHJvdG9jb2wiOiAianNvbiIsCiAgICAgICJzZXJ2aWNlQWJicmV2aWF0aW9uIjogIkNvbm5lY3QiLAogICAgICAic2VydmljZUZ1bGxOYW1lIjogIkFtYXpvbkNvbm5lY3RDVElTZXJ2aWNlIiwKICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAiIiwKICAgICAgInRhcmdldFByZWZpeCI6ICJBbWF6b25Db25uZWN0Q1RJU2VydmljZSIsCiAgICAgICJ1aWQiOiAiY29ubmVjdC0yMDE3LTAyLTE1IgogICAgfSwKICAgICJvcGVyYXRpb25zIjogewogICAgICAiQWNjZXB0Q29udGFjdCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNsZWFyQ29udGFjdCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiY29udGFjdElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNvbXBsZXRlQ29udGFjdCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiY29udGFjdElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNvbmZlcmVuY2VDb25uZWN0aW9ucyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNyZWF0ZUFkZGl0aW9uYWxDb25uZWN0aW9uIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiZW5kcG9pbnQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImVuZHBvaW50IjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQ3JlYXRlT3V0Ym91bmRDb250YWN0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJlbmRwb2ludCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImVuZHBvaW50IjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInF1ZXVlQVJOIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNyZWF0ZVRhc2tDb250YWN0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJlbmRwb2ludCIsCiAgICAgICAgICAgICJuYW1lIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiZW5kcG9pbnQiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNlIgogICAgICAgICAgICB9LAogICAgICAgICAgICAicHJldmlvdXNDb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICAgImRlc2NyaXB0aW9uIjoge30sCiAgICAgICAgICAgICJyZWZlcmVuY2VzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImlkZW1wb3RlbmN5VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQ3JlYXRlVHJhbnNwb3J0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJ0cmFuc3BvcnRUeXBlIiwKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAidHJhbnNwb3J0VHlwZSI6IHt9LAogICAgICAgICAgICAicGFydGljaXBhbnRJZCI6IHt9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICJzb2Z0cGhvbmVDbGllbnRJZCI6IHt9LAogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAid2ViU29ja2V0VHJhbnNwb3J0IjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgInVybCIsCiAgICAgICAgICAgICAgICAidHJhbnNwb3J0TGlmZVRpbWVJblNlY29uZHMiCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJ1cmwiOiB7fSwKICAgICAgICAgICAgICAgICJ0cmFuc3BvcnRMaWZlVGltZUluU2Vjb25kcyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiZXhwaXJ5Ijoge30KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjaGF0VG9rZW5UcmFuc3BvcnQiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAicGFydGljaXBhbnRUb2tlbiIsCiAgICAgICAgICAgICAgICAiZXhwaXJ5IgogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAicGFydGljaXBhbnRUb2tlbiI6IHt9LAogICAgICAgICAgICAgICAgImV4cGlyeSI6IHt9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAic29mdHBob25lVHJhbnNwb3J0IjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgInNvZnRwaG9uZU1lZGlhQ29ubmVjdGlvbnMiCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJzb2Z0cGhvbmVNZWRpYUNvbm5lY3Rpb25zIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICJ1c2VybmFtZSIsCiAgICAgICAgICAgICAgICAgICAgICAiY3JlZGVudGlhbCIsCiAgICAgICAgICAgICAgICAgICAgICAidXJscyIKICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgInVzZXJuYW1lIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAiY3JlZGVudGlhbCI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgInVybHMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJEZXN0cm95Q29ubmVjdGlvbiI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldEFnZW50Q29uZmlndXJhdGlvbiI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiY29uZmlndXJhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImNvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMxaCIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldEFnZW50UGVybWlzc2lvbnMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30sCiAgICAgICAgICAgICJtYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAicGVybWlzc2lvbnMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJwZXJtaXNzaW9ucyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0QWdlbnRTbmFwc2hvdCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgInRpbWVvdXQiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJzbmFwc2hvdCIsCiAgICAgICAgICAgICJuZXh0VG9rZW4iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJzbmFwc2hvdCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICJzdGF0ZSIsCiAgICAgICAgICAgICAgICAiY29udGFjdHMiLAogICAgICAgICAgICAgICAgInNuYXBzaG90VGltZXN0YW1wIgogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAic3RhdGUiOiB7CiAgICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTMXoiCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgIm5leHRTdGF0ZSI6IHsKICAgICAgICAgICAgICAgICAgInNoYXBlIjogIlMxeiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiYWdlbnRBdmFpbGFiaWxpdHlTdGF0ZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgInN0YXRlIjoge30sCiAgICAgICAgICAgICAgICAgICAgInRpbWVTdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiY29udGFjdHMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICAgICAgICAgICAidHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAic3RhdGUiLAogICAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25zIiwKICAgICAgICAgICAgICAgICAgICAgICJhdHRyaWJ1dGVzIgogICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAiaW5pdGlhbENvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgImNvbnRhY3RGZWF0dXJlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgImF0dGFjaG1lbnRzRW5hYmxlZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJzdGF0ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgInF1ZXVlIjogewogICAgICAgICAgICAgICAgICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgInF1ZXVlVGltZXN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25zIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjb25uZWN0aW9uSWQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXRlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpbml0aWFsIgogICAgICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZW5kcG9pbnQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaW5pdGlhbCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic29mdHBob25lTWVkaWFJbmZvIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2FsbFR5cGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYXV0b0FjY2VwdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVkaWFMZWdDb250ZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2FsbENvbnRleHRUb2tlbiI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjYWxsQ29uZmlnSnNvbiI6IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2hhdE1lZGlhSW5mbyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNoYXRBdXRvQWNjZXB0IjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjb25uZWN0aW9uRGF0YSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjdXN0b21lck5hbWUiOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1vbml0b3JpbmdJbmZvIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYWdlbnQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJhZ2VudE5hbWUiOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImpvaW5UaW1lU3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgImF0dHJpYnV0ZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJrZXkiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgInZhbHVlIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiCiAgICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICJjb250YWN0RHVyYXRpb24iOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJyZWZlcmVuY2VzIjogewogICAgICAgICAgICAgICAgICAgICAgICAic2hhcGUiOiAiU3IiCiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgImluaXRpYXRpb25NZXRob2QiOiB7fQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJzbmFwc2hvdFRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0QWdlbnRTdGF0ZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30sCiAgICAgICAgICAgICJtYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAic3RhdGVzIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAic3RhdGVzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAic2hhcGUiOiAiUzF6IgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0RGlhbGFibGVDb3VudHJ5Q29kZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30sCiAgICAgICAgICAgICJtYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiY291bnRyeUNvZGVzIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiY291bnRyeUNvZGVzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRFbmRwb2ludHMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgInF1ZXVlQVJOcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInF1ZXVlQVJOcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiZW5kcG9pbnRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAic2hhcGUiOiAiU2UiCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXROZXdBdXRoVG9rZW4iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgInJlZnJlc2hUb2tlbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInJlZnJlc2hUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAibmV3QXV0aFRva2VuIjoge30sCiAgICAgICAgICAgICJleHBpcmF0aW9uRGF0ZVRpbWUiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0Um91dGluZ1Byb2ZpbGVRdWV1ZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgInJvdXRpbmdQcm9maWxlQVJOIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAicm91dGluZ1Byb2ZpbGVBUk4iOiB7fSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgInF1ZXVlcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgInF1ZXVlcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlNrIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiSG9sZENvbm5lY3Rpb24iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJOb3RpZnlDb250YWN0SXNzdWUiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiaXNzdWVDb2RlIjoge30sCiAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6IHt9LAogICAgICAgICAgICAiY2xpZW50TG9ncyI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJQdXRBZ2VudFN0YXRlIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJzdGF0ZSIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInN0YXRlIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMXoiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJlbnF1ZXVlTmV4dFN0YXRlIjogewogICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlJlamVjdENvbnRhY3QiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJSZXN1bWVDb25uZWN0aW9uIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2VuZENsaWVudExvZ3MiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImxvZ0V2ZW50cyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImxvZ0V2ZW50cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgImNvbXBvbmVudCI6IHt9LAogICAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHt9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTZW5kRGlnaXRzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiY29ubmVjdGlvbklkIiwKICAgICAgICAgICAgImRpZ2l0cyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30sCiAgICAgICAgICAgICJkaWdpdHMiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2VuZFNvZnRwaG9uZUNhbGxNZXRyaWNzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAic29mdHBob25lU3RyZWFtU3RhdGlzdGljcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY2NwVmVyc2lvbiI6IHt9LAogICAgICAgICAgICAic29mdHBob25lU3RyZWFtU3RhdGlzdGljcyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzNuIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTZW5kU29mdHBob25lQ2FsbFJlcG9ydCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgInJlcG9ydCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY2NwVmVyc2lvbiI6IHt9LAogICAgICAgICAgICAicmVwb3J0IjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAiY2FsbFN0YXJ0VGltZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJjYWxsRW5kVGltZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzIjogewogICAgICAgICAgICAgICAgICAic2hhcGUiOiAiUzNuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJndW1UaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJpbml0aWFsaXphdGlvblRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImljZUNvbGxlY3Rpb25UaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJzaWduYWxsaW5nQ29ubmVjdFRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImhhbmRzaGFrZVRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgInByZVRhbGtUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJ0YWxrVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiY2xlYW51cFRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImljZUNvbGxlY3Rpb25GYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJzaWduYWxsaW5nQ29ubmVjdGlvbkZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImhhbmRzaGFrZUZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImd1bU90aGVyRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiZ3VtVGltZW91dEZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImNyZWF0ZU9mZmVyRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic2V0TG9jYWxEZXNjcmlwdGlvbkZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgInVzZXJCdXN5RmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiaW52YWxpZFJlbW90ZVNEUEZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgIm5vUmVtb3RlSWNlQ2FuZGlkYXRlRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic2V0UmVtb3RlRGVzY3JpcHRpb25GYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVG9nZ2xlQWN0aXZlQ29ubmVjdGlvbnMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJVcGRhdGVBZ2VudENvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbmZpZ3VyYXRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb25maWd1cmF0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMWgiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJzaGFwZXMiOiB7CiAgICAgICJTMiI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImFnZW50QVJOIjoge30sCiAgICAgICAgICAiYXV0aFRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTZSI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJ0eXBlIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiZW5kcG9pbnRBUk4iOiB7fSwKICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICAgInBob25lTnVtYmVyIjoge30sCiAgICAgICAgICAiYWdlbnRMb2dpbiI6IHt9LAogICAgICAgICAgInF1ZXVlIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2siOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJxdWV1ZUFSTiI6IHt9LAogICAgICAgICAgIm5hbWUiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNyIjogewogICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgImtleSI6IHt9LAogICAgICAgICJ2YWx1ZSI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJ2YWx1ZSIsCiAgICAgICAgICAgICJ0eXBlIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAidmFsdWUiOiB7fSwKICAgICAgICAgICAgInR5cGUiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlMxaCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJuYW1lIiwKICAgICAgICAgICJzb2Z0cGhvbmVFbmFibGVkIiwKICAgICAgICAgICJzb2Z0cGhvbmVBdXRvQWNjZXB0IiwKICAgICAgICAgICJleHRlbnNpb24iLAogICAgICAgICAgInJvdXRpbmdQcm9maWxlIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICAgInVzZXJuYW1lIjoge30sCiAgICAgICAgICAic29mdHBob25lRW5hYmxlZCI6IHsKICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgIH0sCiAgICAgICAgICAic29mdHBob25lQXV0b0FjY2VwdCI6IHsKICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgIH0sCiAgICAgICAgICAiZXh0ZW5zaW9uIjoge30sCiAgICAgICAgICAicm91dGluZ1Byb2ZpbGUiOiB7CiAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAgICAgInJvdXRpbmdQcm9maWxlQVJOIjoge30sCiAgICAgICAgICAgICAgImRlZmF1bHRPdXRib3VuZFF1ZXVlIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlNrIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImNoYW5uZWxDb25jdXJyZW5jeU1hcCI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgICAgICAgICAia2V5Ijoge30sCiAgICAgICAgICAgICAgICAidmFsdWUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgImFnZW50UHJlZmVyZW5jZXMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgICAgICJrZXkiOiB7fSwKICAgICAgICAgICAgInZhbHVlIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTMXoiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAidHlwZSIsCiAgICAgICAgICAibmFtZSIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImFnZW50U3RhdGVBUk4iOiB7fSwKICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICAgInN0YXJ0VGltZXN0YW1wIjogewogICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiUzNuIjogewogICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJ0aW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICB9LAogICAgICAgICAgICAic29mdHBob25lU3RyZWFtVHlwZSI6IHt9LAogICAgICAgICAgICAicGFja2V0Q291bnQiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInBhY2tldHNMb3N0IjogewogICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJhdWRpb0xldmVsIjogewogICAgICAgICAgICAgICJ0eXBlIjogImRvdWJsZSIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImppdHRlckJ1ZmZlck1pbGxpcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9LAogICAgICAgICAgICAicm91bmRUcmlwVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIH0se31dLDQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzPXsKICAgICJhY20iOiB7CiAgICAgICJuYW1lIjogIkFDTSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJhcGlnYXRld2F5IjogewogICAgICAibmFtZSI6ICJBUElHYXRld2F5IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFwcGxpY2F0aW9uYXV0b3NjYWxpbmciOiB7CiAgICAgICJwcmVmaXgiOiAiYXBwbGljYXRpb24tYXV0b3NjYWxpbmciLAogICAgICAibmFtZSI6ICJBcHBsaWNhdGlvbkF1dG9TY2FsaW5nIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFwcHN0cmVhbSI6IHsKICAgICAgIm5hbWUiOiAiQXBwU3RyZWFtIgogICAgfSwKICAgICJhdXRvc2NhbGluZyI6IHsKICAgICAgIm5hbWUiOiAiQXV0b1NjYWxpbmciLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiYmF0Y2giOiB7CiAgICAgICJuYW1lIjogIkJhdGNoIgogICAgfSwKICAgICJidWRnZXRzIjogewogICAgICAibmFtZSI6ICJCdWRnZXRzIgogICAgfSwKICAgICJjbG91ZGRpcmVjdG9yeSI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWREaXJlY3RvcnkiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTYtMDUtMTAqIgogICAgICBdCiAgICB9LAogICAgImNsb3VkZm9ybWF0aW9uIjogewogICAgICAibmFtZSI6ICJDbG91ZEZvcm1hdGlvbiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjbG91ZGZyb250IjogewogICAgICAibmFtZSI6ICJDbG91ZEZyb250IiwKICAgICAgInZlcnNpb25zIjogWwogICAgICAgICIyMDEzLTA1LTEyKiIsCiAgICAgICAgIjIwMTMtMTEtMTEqIiwKICAgICAgICAiMjAxNC0wNS0zMSoiLAogICAgICAgICIyMDE0LTEwLTIxKiIsCiAgICAgICAgIjIwMTQtMTEtMDYqIiwKICAgICAgICAiMjAxNS0wNC0xNyoiLAogICAgICAgICIyMDE1LTA3LTI3KiIsCiAgICAgICAgIjIwMTUtMDktMTcqIiwKICAgICAgICAiMjAxNi0wMS0xMyoiLAogICAgICAgICIyMDE2LTAxLTI4KiIsCiAgICAgICAgIjIwMTYtMDgtMDEqIiwKICAgICAgICAiMjAxNi0wOC0yMCoiLAogICAgICAgICIyMDE2LTA5LTA3KiIsCiAgICAgICAgIjIwMTYtMDktMjkqIiwKICAgICAgICAiMjAxNi0xMS0yNSoiLAogICAgICAgICIyMDE3LTAzLTI1KiIsCiAgICAgICAgIjIwMTctMTAtMzAqIiwKICAgICAgICAiMjAxOC0wNi0xOCoiLAogICAgICAgICIyMDE4LTExLTA1KiIKICAgICAgXSwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNsb3VkaHNtIjogewogICAgICAibmFtZSI6ICJDbG91ZEhTTSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjbG91ZHNlYXJjaCI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWRTZWFyY2giCiAgICB9LAogICAgImNsb3Vkc2VhcmNoZG9tYWluIjogewogICAgICAibmFtZSI6ICJDbG91ZFNlYXJjaERvbWFpbiIKICAgIH0sCiAgICAiY2xvdWR0cmFpbCI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWRUcmFpbCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjbG91ZHdhdGNoIjogewogICAgICAicHJlZml4IjogIm1vbml0b3JpbmciLAogICAgICAibmFtZSI6ICJDbG91ZFdhdGNoIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNsb3Vkd2F0Y2hldmVudHMiOiB7CiAgICAgICJwcmVmaXgiOiAiZXZlbnRzIiwKICAgICAgIm5hbWUiOiAiQ2xvdWRXYXRjaEV2ZW50cyIsCiAgICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgICAiMjAxNC0wMi0wMyoiCiAgICAgIF0sCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjbG91ZHdhdGNobG9ncyI6IHsKICAgICAgInByZWZpeCI6ICJsb2dzIiwKICAgICAgIm5hbWUiOiAiQ2xvdWRXYXRjaExvZ3MiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29kZWJ1aWxkIjogewogICAgICAibmFtZSI6ICJDb2RlQnVpbGQiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29kZWNvbW1pdCI6IHsKICAgICAgIm5hbWUiOiAiQ29kZUNvbW1pdCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb2RlZGVwbG95IjogewogICAgICAibmFtZSI6ICJDb2RlRGVwbG95IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvZGVwaXBlbGluZSI6IHsKICAgICAgIm5hbWUiOiAiQ29kZVBpcGVsaW5lIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvZ25pdG9pZGVudGl0eSI6IHsKICAgICAgInByZWZpeCI6ICJjb2duaXRvLWlkZW50aXR5IiwKICAgICAgIm5hbWUiOiAiQ29nbml0b0lkZW50aXR5IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvZ25pdG9pZGVudGl0eXNlcnZpY2Vwcm92aWRlciI6IHsKICAgICAgInByZWZpeCI6ICJjb2duaXRvLWlkcCIsCiAgICAgICJuYW1lIjogIkNvZ25pdG9JZGVudGl0eVNlcnZpY2VQcm92aWRlciIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb2duaXRvc3luYyI6IHsKICAgICAgInByZWZpeCI6ICJjb2duaXRvLXN5bmMiLAogICAgICAibmFtZSI6ICJDb2duaXRvU3luYyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb25maWdzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogImNvbmZpZyIsCiAgICAgICJuYW1lIjogIkNvbmZpZ1NlcnZpY2UiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY3VyIjogewogICAgICAibmFtZSI6ICJDVVIiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZGF0YXBpcGVsaW5lIjogewogICAgICAibmFtZSI6ICJEYXRhUGlwZWxpbmUiCiAgICB9LAogICAgImRldmljZWZhcm0iOiB7CiAgICAgICJuYW1lIjogIkRldmljZUZhcm0iLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZGlyZWN0Y29ubmVjdCI6IHsKICAgICAgIm5hbWUiOiAiRGlyZWN0Q29ubmVjdCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJkaXJlY3RvcnlzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogImRzIiwKICAgICAgIm5hbWUiOiAiRGlyZWN0b3J5U2VydmljZSIKICAgIH0sCiAgICAiZGlzY292ZXJ5IjogewogICAgICAibmFtZSI6ICJEaXNjb3ZlcnkiCiAgICB9LAogICAgImRtcyI6IHsKICAgICAgIm5hbWUiOiAiRE1TIgogICAgfSwKICAgICJkeW5hbW9kYiI6IHsKICAgICAgIm5hbWUiOiAiRHluYW1vREIiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZHluYW1vZGJzdHJlYW1zIjogewogICAgICAicHJlZml4IjogInN0cmVhbXMuZHluYW1vZGIiLAogICAgICAibmFtZSI6ICJEeW5hbW9EQlN0cmVhbXMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZWMyIjogewogICAgICAibmFtZSI6ICJFQzIiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTMtMDYtMTUqIiwKICAgICAgICAiMjAxMy0xMC0xNSoiLAogICAgICAgICIyMDE0LTAyLTAxKiIsCiAgICAgICAgIjIwMTQtMDUtMDEqIiwKICAgICAgICAiMjAxNC0wNi0xNSoiLAogICAgICAgICIyMDE0LTA5LTAxKiIsCiAgICAgICAgIjIwMTQtMTAtMDEqIiwKICAgICAgICAiMjAxNS0wMy0wMSoiLAogICAgICAgICIyMDE1LTA0LTE1KiIsCiAgICAgICAgIjIwMTUtMTAtMDEqIiwKICAgICAgICAiMjAxNi0wNC0wMSoiLAogICAgICAgICIyMDE2LTA5LTE1KiIKICAgICAgXSwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVjciI6IHsKICAgICAgIm5hbWUiOiAiRUNSIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVjcyI6IHsKICAgICAgIm5hbWUiOiAiRUNTIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVmcyI6IHsKICAgICAgInByZWZpeCI6ICJlbGFzdGljZmlsZXN5c3RlbSIsCiAgICAgICJuYW1lIjogIkVGUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlbGFzdGljYWNoZSI6IHsKICAgICAgIm5hbWUiOiAiRWxhc3RpQ2FjaGUiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTItMTEtMTUqIiwKICAgICAgICAiMjAxNC0wMy0yNCoiLAogICAgICAgICIyMDE0LTA3LTE1KiIsCiAgICAgICAgIjIwMTQtMDktMzAqIgogICAgICBdLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZWxhc3RpY2JlYW5zdGFsayI6IHsKICAgICAgIm5hbWUiOiAiRWxhc3RpY0JlYW5zdGFsayIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlbGIiOiB7CiAgICAgICJwcmVmaXgiOiAiZWxhc3RpY2xvYWRiYWxhbmNpbmciLAogICAgICAibmFtZSI6ICJFTEIiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZWxidjIiOiB7CiAgICAgICJwcmVmaXgiOiAiZWxhc3RpY2xvYWRiYWxhbmNpbmd2MiIsCiAgICAgICJuYW1lIjogIkVMQnYyIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVtciI6IHsKICAgICAgInByZWZpeCI6ICJlbGFzdGljbWFwcmVkdWNlIiwKICAgICAgIm5hbWUiOiAiRU1SIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVzIjogewogICAgICAibmFtZSI6ICJFUyIKICAgIH0sCiAgICAiZWxhc3RpY3RyYW5zY29kZXIiOiB7CiAgICAgICJuYW1lIjogIkVsYXN0aWNUcmFuc2NvZGVyIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImZpcmVob3NlIjogewogICAgICAibmFtZSI6ICJGaXJlaG9zZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJnYW1lbGlmdCI6IHsKICAgICAgIm5hbWUiOiAiR2FtZUxpZnQiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZ2xhY2llciI6IHsKICAgICAgIm5hbWUiOiAiR2xhY2llciIKICAgIH0sCiAgICAiaGVhbHRoIjogewogICAgICAibmFtZSI6ICJIZWFsdGgiCiAgICB9LAogICAgImlhbSI6IHsKICAgICAgIm5hbWUiOiAiSUFNIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImltcG9ydGV4cG9ydCI6IHsKICAgICAgIm5hbWUiOiAiSW1wb3J0RXhwb3J0IgogICAgfSwKICAgICJpbnNwZWN0b3IiOiB7CiAgICAgICJuYW1lIjogIkluc3BlY3RvciIsCiAgICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgICAiMjAxNS0wOC0xOCoiCiAgICAgIF0sCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJpb3QiOiB7CiAgICAgICJuYW1lIjogIklvdCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJpb3RkYXRhIjogewogICAgICAicHJlZml4IjogImlvdC1kYXRhIiwKICAgICAgIm5hbWUiOiAiSW90RGF0YSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJraW5lc2lzIjogewogICAgICAibmFtZSI6ICJLaW5lc2lzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImtpbmVzaXNhbmFseXRpY3MiOiB7CiAgICAgICJuYW1lIjogIktpbmVzaXNBbmFseXRpY3MiCiAgICB9LAogICAgImttcyI6IHsKICAgICAgIm5hbWUiOiAiS01TIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImxhbWJkYSI6IHsKICAgICAgIm5hbWUiOiAiTGFtYmRhIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImxleHJ1bnRpbWUiOiB7CiAgICAgICJwcmVmaXgiOiAicnVudGltZS5sZXgiLAogICAgICAibmFtZSI6ICJMZXhSdW50aW1lIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImxpZ2h0c2FpbCI6IHsKICAgICAgIm5hbWUiOiAiTGlnaHRzYWlsIgogICAgfSwKICAgICJtYWNoaW5lbGVhcm5pbmciOiB7CiAgICAgICJuYW1lIjogIk1hY2hpbmVMZWFybmluZyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJtYXJrZXRwbGFjZWNvbW1lcmNlYW5hbHl0aWNzIjogewogICAgICAibmFtZSI6ICJNYXJrZXRwbGFjZUNvbW1lcmNlQW5hbHl0aWNzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIm1hcmtldHBsYWNlbWV0ZXJpbmciOiB7CiAgICAgICJwcmVmaXgiOiAibWV0ZXJpbmdtYXJrZXRwbGFjZSIsCiAgICAgICJuYW1lIjogIk1hcmtldHBsYWNlTWV0ZXJpbmciCiAgICB9LAogICAgIm10dXJrIjogewogICAgICAicHJlZml4IjogIm10dXJrLXJlcXVlc3RlciIsCiAgICAgICJuYW1lIjogIk1UdXJrIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIm1vYmlsZWFuYWx5dGljcyI6IHsKICAgICAgIm5hbWUiOiAiTW9iaWxlQW5hbHl0aWNzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIm9wc3dvcmtzIjogewogICAgICAibmFtZSI6ICJPcHNXb3JrcyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJvcHN3b3Jrc2NtIjogewogICAgICAibmFtZSI6ICJPcHNXb3Jrc0NNIgogICAgfSwKICAgICJvcmdhbml6YXRpb25zIjogewogICAgICAibmFtZSI6ICJPcmdhbml6YXRpb25zIgogICAgfSwKICAgICJwaW5wb2ludCI6IHsKICAgICAgIm5hbWUiOiAiUGlucG9pbnQiCiAgICB9LAogICAgInBvbGx5IjogewogICAgICAibmFtZSI6ICJQb2xseSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJyZHMiOiB7CiAgICAgICJuYW1lIjogIlJEUyIsCiAgICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgICAiMjAxNC0wOS0wMSoiCiAgICAgIF0sCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJyZWRzaGlmdCI6IHsKICAgICAgIm5hbWUiOiAiUmVkc2hpZnQiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAicmVrb2duaXRpb24iOiB7CiAgICAgICJuYW1lIjogIlJla29nbml0aW9uIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInJlc291cmNlZ3JvdXBzdGFnZ2luZ2FwaSI6IHsKICAgICAgIm5hbWUiOiAiUmVzb3VyY2VHcm91cHNUYWdnaW5nQVBJIgogICAgfSwKICAgICJyb3V0ZTUzIjogewogICAgICAibmFtZSI6ICJSb3V0ZTUzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInJvdXRlNTNkb21haW5zIjogewogICAgICAibmFtZSI6ICJSb3V0ZTUzRG9tYWlucyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzMyI6IHsKICAgICAgIm5hbWUiOiAiUzMiLAogICAgICAiZHVhbHN0YWNrQXZhaWxhYmxlIjogdHJ1ZSwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInMzY29udHJvbCI6IHsKICAgICAgIm5hbWUiOiAiUzNDb250cm9sIiwKICAgICAgImR1YWxzdGFja0F2YWlsYWJsZSI6IHRydWUKICAgIH0sCiAgICAic2VydmljZWNhdGFsb2ciOiB7CiAgICAgICJuYW1lIjogIlNlcnZpY2VDYXRhbG9nIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInNlcyI6IHsKICAgICAgInByZWZpeCI6ICJlbWFpbCIsCiAgICAgICJuYW1lIjogIlNFUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzaGllbGQiOiB7CiAgICAgICJuYW1lIjogIlNoaWVsZCIKICAgIH0sCiAgICAic2ltcGxlZGIiOiB7CiAgICAgICJwcmVmaXgiOiAic2RiIiwKICAgICAgIm5hbWUiOiAiU2ltcGxlREIiCiAgICB9LAogICAgInNtcyI6IHsKICAgICAgIm5hbWUiOiAiU01TIgogICAgfSwKICAgICJzbm93YmFsbCI6IHsKICAgICAgIm5hbWUiOiAiU25vd2JhbGwiCiAgICB9LAogICAgInNucyI6IHsKICAgICAgIm5hbWUiOiAiU05TIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInNxcyI6IHsKICAgICAgIm5hbWUiOiAiU1FTIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInNzbSI6IHsKICAgICAgIm5hbWUiOiAiU1NNIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInN0b3JhZ2VnYXRld2F5IjogewogICAgICAibmFtZSI6ICJTdG9yYWdlR2F0ZXdheSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzdGVwZnVuY3Rpb25zIjogewogICAgICAicHJlZml4IjogInN0YXRlcyIsCiAgICAgICJuYW1lIjogIlN0ZXBGdW5jdGlvbnMiCiAgICB9LAogICAgInN0cyI6IHsKICAgICAgIm5hbWUiOiAiU1RTIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInN1cHBvcnQiOiB7CiAgICAgICJuYW1lIjogIlN1cHBvcnQiCiAgICB9LAogICAgInN3ZiI6IHsKICAgICAgIm5hbWUiOiAiU1dGIgogICAgfSwKICAgICJ4cmF5IjogewogICAgICAibmFtZSI6ICJYUmF5IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIndhZiI6IHsKICAgICAgIm5hbWUiOiAiV0FGIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIndhZnJlZ2lvbmFsIjogewogICAgICAicHJlZml4IjogIndhZi1yZWdpb25hbCIsCiAgICAgICJuYW1lIjogIldBRlJlZ2lvbmFsIgogICAgfSwKICAgICJ3b3JrZG9jcyI6IHsKICAgICAgIm5hbWUiOiAiV29ya0RvY3MiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAid29ya3NwYWNlcyI6IHsKICAgICAgIm5hbWUiOiAiV29ya1NwYWNlcyIKICAgIH0sCiAgICAiY29kZXN0YXIiOiB7CiAgICAgICJuYW1lIjogIkNvZGVTdGFyIgogICAgfSwKICAgICJsZXhtb2RlbGJ1aWxkaW5nc2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJsZXgtbW9kZWxzIiwKICAgICAgIm5hbWUiOiAiTGV4TW9kZWxCdWlsZGluZ1NlcnZpY2UiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAibWFya2V0cGxhY2VlbnRpdGxlbWVudHNlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAiZW50aXRsZW1lbnQubWFya2V0cGxhY2UiLAogICAgICAibmFtZSI6ICJNYXJrZXRwbGFjZUVudGl0bGVtZW50U2VydmljZSIKICAgIH0sCiAgICAiYXRoZW5hIjogewogICAgICAibmFtZSI6ICJBdGhlbmEiCiAgICB9LAogICAgImdyZWVuZ3Jhc3MiOiB7CiAgICAgICJuYW1lIjogIkdyZWVuZ3Jhc3MiCiAgICB9LAogICAgImRheCI6IHsKICAgICAgIm5hbWUiOiAiREFYIgogICAgfSwKICAgICJtaWdyYXRpb25odWIiOiB7CiAgICAgICJwcmVmaXgiOiAiQVdTTWlncmF0aW9uSHViIiwKICAgICAgIm5hbWUiOiAiTWlncmF0aW9uSHViIgogICAgfSwKICAgICJjbG91ZGhzbXYyIjogewogICAgICAibmFtZSI6ICJDbG91ZEhTTVYyIgogICAgfSwKICAgICJnbHVlIjogewogICAgICAibmFtZSI6ICJHbHVlIgogICAgfSwKICAgICJtb2JpbGUiOiB7CiAgICAgICJuYW1lIjogIk1vYmlsZSIKICAgIH0sCiAgICAicHJpY2luZyI6IHsKICAgICAgIm5hbWUiOiAiUHJpY2luZyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb3N0ZXhwbG9yZXIiOiB7CiAgICAgICJwcmVmaXgiOiAiY2UiLAogICAgICAibmFtZSI6ICJDb3N0RXhwbG9yZXIiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAibWVkaWFjb252ZXJ0IjogewogICAgICAibmFtZSI6ICJNZWRpYUNvbnZlcnQiCiAgICB9LAogICAgIm1lZGlhbGl2ZSI6IHsKICAgICAgIm5hbWUiOiAiTWVkaWFMaXZlIgogICAgfSwKICAgICJtZWRpYXBhY2thZ2UiOiB7CiAgICAgICJuYW1lIjogIk1lZGlhUGFja2FnZSIKICAgIH0sCiAgICAibWVkaWFzdG9yZSI6IHsKICAgICAgIm5hbWUiOiAiTWVkaWFTdG9yZSIKICAgIH0sCiAgICAibWVkaWFzdG9yZWRhdGEiOiB7CiAgICAgICJwcmVmaXgiOiAibWVkaWFzdG9yZS1kYXRhIiwKICAgICAgIm5hbWUiOiAiTWVkaWFTdG9yZURhdGEiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiYXBwc3luYyI6IHsKICAgICAgIm5hbWUiOiAiQXBwU3luYyIKICAgIH0sCiAgICAiZ3VhcmRkdXR5IjogewogICAgICAibmFtZSI6ICJHdWFyZER1dHkiCiAgICB9LAogICAgIm1xIjogewogICAgICAibmFtZSI6ICJNUSIKICAgIH0sCiAgICAiY29tcHJlaGVuZCI6IHsKICAgICAgIm5hbWUiOiAiQ29tcHJlaGVuZCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJpb3Rqb2JzZGF0YXBsYW5lIjogewogICAgICAicHJlZml4IjogImlvdC1qb2JzLWRhdGEiLAogICAgICAibmFtZSI6ICJJb1RKb2JzRGF0YVBsYW5lIgogICAgfSwKICAgICJraW5lc2lzdmlkZW9hcmNoaXZlZG1lZGlhIjogewogICAgICAicHJlZml4IjogImtpbmVzaXMtdmlkZW8tYXJjaGl2ZWQtbWVkaWEiLAogICAgICAibmFtZSI6ICJLaW5lc2lzVmlkZW9BcmNoaXZlZE1lZGlhIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImtpbmVzaXN2aWRlb21lZGlhIjogewogICAgICAicHJlZml4IjogImtpbmVzaXMtdmlkZW8tbWVkaWEiLAogICAgICAibmFtZSI6ICJLaW5lc2lzVmlkZW9NZWRpYSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJraW5lc2lzdmlkZW8iOiB7CiAgICAgICJuYW1lIjogIktpbmVzaXNWaWRlbyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzYWdlbWFrZXJydW50aW1lIjogewogICAgICAicHJlZml4IjogInJ1bnRpbWUuc2FnZW1ha2VyIiwKICAgICAgIm5hbWUiOiAiU2FnZU1ha2VyUnVudGltZSIKICAgIH0sCiAgICAic2FnZW1ha2VyIjogewogICAgICAibmFtZSI6ICJTYWdlTWFrZXIiCiAgICB9LAogICAgInRyYW5zbGF0ZSI6IHsKICAgICAgIm5hbWUiOiAiVHJhbnNsYXRlIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInJlc291cmNlZ3JvdXBzIjogewogICAgICAicHJlZml4IjogInJlc291cmNlLWdyb3VwcyIsCiAgICAgICJuYW1lIjogIlJlc291cmNlR3JvdXBzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFsZXhhZm9yYnVzaW5lc3MiOiB7CiAgICAgICJuYW1lIjogIkFsZXhhRm9yQnVzaW5lc3MiCiAgICB9LAogICAgImNsb3VkOSI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWQ5IgogICAgfSwKICAgICJzZXJ2ZXJsZXNzYXBwbGljYXRpb25yZXBvc2l0b3J5IjogewogICAgICAicHJlZml4IjogInNlcnZlcmxlc3NyZXBvIiwKICAgICAgIm5hbWUiOiAiU2VydmVybGVzc0FwcGxpY2F0aW9uUmVwb3NpdG9yeSIKICAgIH0sCiAgICAic2VydmljZWRpc2NvdmVyeSI6IHsKICAgICAgIm5hbWUiOiAiU2VydmljZURpc2NvdmVyeSIKICAgIH0sCiAgICAid29ya21haWwiOiB7CiAgICAgICJuYW1lIjogIldvcmtNYWlsIgogICAgfSwKICAgICJhdXRvc2NhbGluZ3BsYW5zIjogewogICAgICAicHJlZml4IjogImF1dG9zY2FsaW5nLXBsYW5zIiwKICAgICAgIm5hbWUiOiAiQXV0b1NjYWxpbmdQbGFucyIKICAgIH0sCiAgICAidHJhbnNjcmliZXNlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAidHJhbnNjcmliZSIsCiAgICAgICJuYW1lIjogIlRyYW5zY3JpYmVTZXJ2aWNlIgogICAgfSwKICAgICJjb25uZWN0IjogewogICAgICAibmFtZSI6ICJDb25uZWN0IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFjbXBjYSI6IHsKICAgICAgInByZWZpeCI6ICJhY20tcGNhIiwKICAgICAgIm5hbWUiOiAiQUNNUENBIgogICAgfSwKICAgICJmbXMiOiB7CiAgICAgICJuYW1lIjogIkZNUyIKICAgIH0sCiAgICAic2VjcmV0c21hbmFnZXIiOiB7CiAgICAgICJuYW1lIjogIlNlY3JldHNNYW5hZ2VyIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImlvdGFuYWx5dGljcyI6IHsKICAgICAgIm5hbWUiOiAiSW9UQW5hbHl0aWNzIiwKICAgICAgImNvcnMiOiB0cnVlCQogICAgfSwKICAgICJpb3QxY2xpY2tkZXZpY2Vzc2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJpb3QxY2xpY2stZGV2aWNlcyIsCiAgICAgICJuYW1lIjogIklvVDFDbGlja0RldmljZXNTZXJ2aWNlIgogICAgfSwKICAgICJpb3QxY2xpY2twcm9qZWN0cyI6IHsKICAgICAgInByZWZpeCI6ICJpb3QxY2xpY2stcHJvamVjdHMiLAogICAgICAibmFtZSI6ICJJb1QxQ2xpY2tQcm9qZWN0cyIKICAgIH0sCiAgICAicGkiOiB7CiAgICAgICJuYW1lIjogIlBJIgogICAgfSwKICAgICJuZXB0dW5lIjogewogICAgICAibmFtZSI6ICJOZXB0dW5lIgogICAgfSwKICAgICJtZWRpYXRhaWxvciI6IHsKICAgICAgIm5hbWUiOiAiTWVkaWFUYWlsb3IiCiAgICB9LAogICAgImVrcyI6IHsKICAgICAgIm5hbWUiOiAiRUtTIgogICAgfSwKICAgICJtYWNpZSI6IHsKICAgICAgIm5hbWUiOiAiTWFjaWUiCiAgICB9LAogICAgImRsbSI6IHsKICAgICAgIm5hbWUiOiAiRExNIgogICAgfSwKICAgICJzaWduZXIiOiB7CiAgICAgICJuYW1lIjogIlNpZ25lciIKICAgIH0sCiAgICAiY2hpbWUiOiB7CiAgICAgICJuYW1lIjogIkNoaW1lIgogICAgfSwKICAgICJwaW5wb2ludGVtYWlsIjogewogICAgICAicHJlZml4IjogInBpbnBvaW50LWVtYWlsIiwKICAgICAgIm5hbWUiOiAiUGlucG9pbnRFbWFpbCIKICAgIH0sCiAgICAicmFtIjogewogICAgICAibmFtZSI6ICJSQU0iCiAgICB9LAogICAgInJvdXRlNTNyZXNvbHZlciI6IHsKICAgICAgIm5hbWUiOiAiUm91dGU1M1Jlc29sdmVyIgogICAgfSwKICAgICJwaW5wb2ludHNtc3ZvaWNlIjogewogICAgICAicHJlZml4IjogInNtcy12b2ljZSIsCiAgICAgICJuYW1lIjogIlBpbnBvaW50U01TVm9pY2UiCiAgICB9LAogICAgInF1aWNrc2lnaHQiOiB7CiAgICAgICJuYW1lIjogIlF1aWNrU2lnaHQiCiAgICB9LAogICAgInJkc2RhdGFzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogInJkcy1kYXRhIiwKICAgICAgIm5hbWUiOiAiUkRTRGF0YVNlcnZpY2UiCiAgICB9LAogICAgImFtcGxpZnkiOiB7CiAgICAgICJuYW1lIjogIkFtcGxpZnkiCiAgICB9LAogICAgImRhdGFzeW5jIjogewogICAgICAibmFtZSI6ICJEYXRhU3luYyIKICAgIH0sCiAgICAicm9ib21ha2VyIjogewogICAgICAibmFtZSI6ICJSb2JvTWFrZXIiCiAgICB9LAogICAgInRyYW5zZmVyIjogewogICAgICAibmFtZSI6ICJUcmFuc2ZlciIKICAgIH0sCiAgICAiZ2xvYmFsYWNjZWxlcmF0b3IiOiB7CiAgICAgICJuYW1lIjogIkdsb2JhbEFjY2VsZXJhdG9yIgogICAgfSwKICAgICJjb21wcmVoZW5kbWVkaWNhbCI6IHsKICAgICAgIm5hbWUiOiAiQ29tcHJlaGVuZE1lZGljYWwiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAia2luZXNpc2FuYWx5dGljc3YyIjogewogICAgICAibmFtZSI6ICJLaW5lc2lzQW5hbHl0aWNzVjIiCiAgICB9LAogICAgIm1lZGlhY29ubmVjdCI6IHsKICAgICAgIm5hbWUiOiAiTWVkaWFDb25uZWN0IgogICAgfSwKICAgICJmc3giOiB7CiAgICAgICJuYW1lIjogIkZTeCIKICAgIH0sCiAgICAic2VjdXJpdHlodWIiOiB7CiAgICAgICJuYW1lIjogIlNlY3VyaXR5SHViIgogICAgfSwKICAgICJhcHBtZXNoIjogewogICAgICAibmFtZSI6ICJBcHBNZXNoIiwKICAgICAgInZlcnNpb25zIjogWwogICAgICAgICIyMDE4LTEwLTAxKiIKICAgICAgXQogICAgfSwKICAgICJsaWNlbnNlbWFuYWdlciI6IHsKICAgICAgInByZWZpeCI6ICJsaWNlbnNlLW1hbmFnZXIiLAogICAgICAibmFtZSI6ICJMaWNlbnNlTWFuYWdlciIKICAgIH0sCiAgICAia2Fma2EiOiB7CiAgICAgICJuYW1lIjogIkthZmthIgogICAgfSwKICAgICJhcGlnYXRld2F5bWFuYWdlbWVudGFwaSI6IHsKICAgICAgIm5hbWUiOiAiQXBpR2F0ZXdheU1hbmFnZW1lbnRBcGkiCiAgICB9LAogICAgImFwaWdhdGV3YXl2MiI6IHsKICAgICAgIm5hbWUiOiAiQXBpR2F0ZXdheVYyIgogICAgfSwKICAgICJkb2NkYiI6IHsKICAgICAgIm5hbWUiOiAiRG9jREIiCiAgICB9LAogICAgImJhY2t1cCI6IHsKICAgICAgIm5hbWUiOiAiQmFja3VwIgogICAgfSwKICAgICJ3b3JrbGluayI6IHsKICAgICAgIm5hbWUiOiAiV29ya0xpbmsiCiAgICB9LAogICAgInRleHRyYWN0IjogewogICAgICAibmFtZSI6ICJUZXh0cmFjdCIKICAgIH0sCiAgICAibWFuYWdlZGJsb2NrY2hhaW4iOiB7CiAgICAgICJuYW1lIjogIk1hbmFnZWRCbG9ja2NoYWluIgogICAgfSwKICAgICJtZWRpYXBhY2thZ2V2b2QiOiB7CiAgICAgICJwcmVmaXgiOiAibWVkaWFwYWNrYWdlLXZvZCIsCiAgICAgICJuYW1lIjogIk1lZGlhUGFja2FnZVZvZCIKICAgIH0sCiAgICAiZ3JvdW5kc3RhdGlvbiI6IHsKICAgICAgIm5hbWUiOiAiR3JvdW5kU3RhdGlvbiIKICAgIH0sCiAgICAiaW90dGhpbmdzZ3JhcGgiOiB7CiAgICAgICJuYW1lIjogIklvVFRoaW5nc0dyYXBoIgogICAgfSwKICAgICJpb3RldmVudHMiOiB7CiAgICAgICJuYW1lIjogIklvVEV2ZW50cyIKICAgIH0sCiAgICAiaW90ZXZlbnRzZGF0YSI6IHsKICAgICAgInByZWZpeCI6ICJpb3RldmVudHMtZGF0YSIsCiAgICAgICJuYW1lIjogIklvVEV2ZW50c0RhdGEiCiAgICB9LAogICAgInBlcnNvbmFsaXplIjogewogICAgICAibmFtZSI6ICJQZXJzb25hbGl6ZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJwZXJzb25hbGl6ZWV2ZW50cyI6IHsKICAgICAgInByZWZpeCI6ICJwZXJzb25hbGl6ZS1ldmVudHMiLAogICAgICAibmFtZSI6ICJQZXJzb25hbGl6ZUV2ZW50cyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJwZXJzb25hbGl6ZXJ1bnRpbWUiOiB7CiAgICAgICJwcmVmaXgiOiAicGVyc29uYWxpemUtcnVudGltZSIsCiAgICAgICJuYW1lIjogIlBlcnNvbmFsaXplUnVudGltZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJhcHBsaWNhdGlvbmluc2lnaHRzIjogewogICAgICAicHJlZml4IjogImFwcGxpY2F0aW9uLWluc2lnaHRzIiwKICAgICAgIm5hbWUiOiAiQXBwbGljYXRpb25JbnNpZ2h0cyIKICAgIH0sCiAgICAic2VydmljZXF1b3RhcyI6IHsKICAgICAgInByZWZpeCI6ICJzZXJ2aWNlLXF1b3RhcyIsCiAgICAgICJuYW1lIjogIlNlcnZpY2VRdW90YXMiCiAgICB9LAogICAgImVjMmluc3RhbmNlY29ubmVjdCI6IHsKICAgICAgInByZWZpeCI6ICJlYzItaW5zdGFuY2UtY29ubmVjdCIsCiAgICAgICJuYW1lIjogIkVDMkluc3RhbmNlQ29ubmVjdCIKICAgIH0sCiAgICAiZXZlbnRicmlkZ2UiOiB7CiAgICAgICJuYW1lIjogIkV2ZW50QnJpZGdlIgogICAgfSwKICAgICJsYWtlZm9ybWF0aW9uIjogewogICAgICAibmFtZSI6ICJMYWtlRm9ybWF0aW9uIgogICAgfSwKICAgICJmb3JlY2FzdHNlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAiZm9yZWNhc3QiLAogICAgICAibmFtZSI6ICJGb3JlY2FzdFNlcnZpY2UiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZm9yZWNhc3RxdWVyeXNlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAiZm9yZWNhc3RxdWVyeSIsCiAgICAgICJuYW1lIjogIkZvcmVjYXN0UXVlcnlTZXJ2aWNlIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInFsZGIiOiB7CiAgICAgICJuYW1lIjogIlFMREIiCiAgICB9LAogICAgInFsZGJzZXNzaW9uIjogewogICAgICAicHJlZml4IjogInFsZGItc2Vzc2lvbiIsCiAgICAgICJuYW1lIjogIlFMREJTZXNzaW9uIgogICAgfSwKICAgICJ3b3JrbWFpbG1lc3NhZ2VmbG93IjogewogICAgICAibmFtZSI6ICJXb3JrTWFpbE1lc3NhZ2VGbG93IgogICAgfQogIH0KICAKICB9LHt9XSw1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBtb2R1bGUuZXhwb3J0cz17CiAgICAidmVyc2lvbiI6ICIyLjAiLAogICAgIm1ldGFkYXRhIjogewogICAgICAiYXBpVmVyc2lvbiI6ICIyMDExLTA2LTE1IiwKICAgICAgImVuZHBvaW50UHJlZml4IjogInN0cyIsCiAgICAgICJnbG9iYWxFbmRwb2ludCI6ICJzdHMuYW1hem9uYXdzLmNvbSIsCiAgICAgICJwcm90b2NvbCI6ICJxdWVyeSIsCiAgICAgICJzZXJ2aWNlQWJicmV2aWF0aW9uIjogIkFXUyBTVFMiLAogICAgICAic2VydmljZUZ1bGxOYW1lIjogIkFXUyBTZWN1cml0eSBUb2tlbiBTZXJ2aWNlIiwKICAgICAgInNlcnZpY2VJZCI6ICJTVFMiLAogICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJ2NCIsCiAgICAgICJ1aWQiOiAic3RzLTIwMTEtMDYtMTUiLAogICAgICAieG1sTmFtZXNwYWNlIjogImh0dHBzOi8vc3RzLmFtYXpvbmF3cy5jb20vZG9jLzIwMTEtMDYtMTUvIgogICAgfSwKICAgICJvcGVyYXRpb25zIjogewogICAgICAiQXNzdW1lUm9sZSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiUm9sZUFybiIsCiAgICAgICAgICAgICJSb2xlU2Vzc2lvbk5hbWUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJSb2xlQXJuIjoge30sCiAgICAgICAgICAgICJSb2xlU2Vzc2lvbk5hbWUiOiB7fSwKICAgICAgICAgICAgIlBvbGljeUFybnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUG9saWN5Ijoge30sCiAgICAgICAgICAgICJEdXJhdGlvblNlY29uZHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkV4dGVybmFsSWQiOiB7fSwKICAgICAgICAgICAgIlNlcmlhbE51bWJlciI6IHt9LAogICAgICAgICAgICAiVG9rZW5Db2RlIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJBc3N1bWVSb2xlUmVzdWx0IiwKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTYyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkFzc3VtZWRSb2xlVXNlciI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2giCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQYWNrZWRQb2xpY3lTaXplIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJBc3N1bWVSb2xlV2l0aFNBTUwiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJvbGVBcm4iLAogICAgICAgICAgICAiUHJpbmNpcGFsQXJuIiwKICAgICAgICAgICAgIlNBTUxBc3NlcnRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJSb2xlQXJuIjoge30sCiAgICAgICAgICAgICJQcmluY2lwYWxBcm4iOiB7fSwKICAgICAgICAgICAgIlNBTUxBc3NlcnRpb24iOiB7fSwKICAgICAgICAgICAgIlBvbGljeUFybnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUG9saWN5Ijoge30sCiAgICAgICAgICAgICJEdXJhdGlvblNlY29uZHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkFzc3VtZVJvbGVXaXRoU0FNTFJlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJDcmVkZW50aWFscyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2MiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJBc3N1bWVkUm9sZVVzZXIiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNoIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUGFja2VkUG9saWN5U2l6ZSI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiU3ViamVjdCI6IHt9LAogICAgICAgICAgICAiU3ViamVjdFR5cGUiOiB7fSwKICAgICAgICAgICAgIklzc3VlciI6IHt9LAogICAgICAgICAgICAiQXVkaWVuY2UiOiB7fSwKICAgICAgICAgICAgIk5hbWVRdWFsaWZpZXIiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJvbGVBcm4iLAogICAgICAgICAgICAiUm9sZVNlc3Npb25OYW1lIiwKICAgICAgICAgICAgIldlYklkZW50aXR5VG9rZW4iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJSb2xlQXJuIjoge30sCiAgICAgICAgICAgICJSb2xlU2Vzc2lvbk5hbWUiOiB7fSwKICAgICAgICAgICAgIldlYklkZW50aXR5VG9rZW4iOiB7fSwKICAgICAgICAgICAgIlByb3ZpZGVySWQiOiB7fSwKICAgICAgICAgICAgIlBvbGljeUFybnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUG9saWN5Ijoge30sCiAgICAgICAgICAgICJEdXJhdGlvblNlY29uZHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHlSZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNjIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiU3ViamVjdEZyb21XZWJJZGVudGl0eVRva2VuIjoge30sCiAgICAgICAgICAgICJBc3N1bWVkUm9sZVVzZXIiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNoIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUGFja2VkUG9saWN5U2l6ZSI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUHJvdmlkZXIiOiB7fSwKICAgICAgICAgICAgIkF1ZGllbmNlIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJEZWNvZGVBdXRob3JpemF0aW9uTWVzc2FnZSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiRW5jb2RlZE1lc3NhZ2UiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJFbmNvZGVkTWVzc2FnZSI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiRGVjb2RlQXV0aG9yaXphdGlvbk1lc3NhZ2VSZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiRGVjb2RlZE1lc3NhZ2UiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldEFjY2Vzc0tleUluZm8iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIkFjY2Vzc0tleUlkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQWNjZXNzS2V5SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkdldEFjY2Vzc0tleUluZm9SZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQWNjb3VudCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0Q2FsbGVySWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJHZXRDYWxsZXJJZGVudGl0eVJlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJVc2VySWQiOiB7fSwKICAgICAgICAgICAgIkFjY291bnQiOiB7fSwKICAgICAgICAgICAgIkFybiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0RmVkZXJhdGlvblRva2VuIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJOYW1lIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiTmFtZSI6IHt9LAogICAgICAgICAgICAiUG9saWN5Ijoge30sCiAgICAgICAgICAgICJQb2xpY3lBcm5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTNCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiR2V0RmVkZXJhdGlvblRva2VuUmVzdWx0IiwKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTYyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkZlZGVyYXRlZFVzZXIiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAiRmVkZXJhdGVkVXNlcklkIiwKICAgICAgICAgICAgICAgICJBcm4iCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJGZWRlcmF0ZWRVc2VySWQiOiB7fSwKICAgICAgICAgICAgICAgICJBcm4iOiB7fQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlBhY2tlZFBvbGljeVNpemUiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldFNlc3Npb25Ub2tlbiI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJEdXJhdGlvblNlY29uZHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlNlcmlhbE51bWJlciI6IHt9LAogICAgICAgICAgICAiVG9rZW5Db2RlIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJHZXRTZXNzaW9uVG9rZW5SZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNjIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgInNoYXBlcyI6IHsKICAgICAgIlM0IjogewogICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhcm4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNjIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIkFjY2Vzc0tleUlkIiwKICAgICAgICAgICJTZWNyZXRBY2Nlc3NLZXkiLAogICAgICAgICAgIlNlc3Npb25Ub2tlbiIsCiAgICAgICAgICAiRXhwaXJhdGlvbiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIkFjY2Vzc0tleUlkIjoge30sCiAgICAgICAgICAiU2VjcmV0QWNjZXNzS2V5Ijoge30sCiAgICAgICAgICAiU2Vzc2lvblRva2VuIjoge30sCiAgICAgICAgICAiRXhwaXJhdGlvbiI6IHsKICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNoIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIkFzc3VtZWRSb2xlSWQiLAogICAgICAgICAgIkFybiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIkFzc3VtZWRSb2xlSWQiOiB7fSwKICAgICAgICAgICJBcm4iOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICB9LHt9XSw2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBhcmd1bWVudHNbNF1bMl1bMF0uYXBwbHkoZXhwb3J0cyxhcmd1bWVudHMpCiAgfSx7ImR1cCI6Mn1dLDc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHJlcXVpcmUoJy4uL2xpYi9ub2RlX2xvYWRlcicpOwogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9saWIvY29yZScpOwogIHZhciBTZXJ2aWNlID0gQVdTLlNlcnZpY2U7CiAgdmFyIGFwaUxvYWRlciA9IEFXUy5hcGlMb2FkZXI7CiAgCiAgYXBpTG9hZGVyLnNlcnZpY2VzWydjb2duaXRvaWRlbnRpdHknXSA9IHt9OwogIEFXUy5Db2duaXRvSWRlbnRpdHkgPSBTZXJ2aWNlLmRlZmluZVNlcnZpY2UoJ2NvZ25pdG9pZGVudGl0eScsIFsnMjAxNC0wNi0zMCddKTsKICByZXF1aXJlKCcuLi9saWIvc2VydmljZXMvY29nbml0b2lkZW50aXR5Jyk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGFwaUxvYWRlci5zZXJ2aWNlc1snY29nbml0b2lkZW50aXR5J10sICcyMDE0LTA2LTMwJywgewogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHZhciBtb2RlbCA9IHJlcXVpcmUoJy4uL2FwaXMvY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwLm1pbi5qc29uJyk7CiAgICAgIG1vZGVsLnBhZ2luYXRvcnMgPSByZXF1aXJlKCcuLi9hcGlzL2NvZ25pdG8taWRlbnRpdHktMjAxNC0wNi0zMC5wYWdpbmF0b3JzLmpzb24nKS5wYWdpbmF0aW9uOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogIH0pOwogIAogIG1vZHVsZS5leHBvcnRzID0gQVdTLkNvZ25pdG9JZGVudGl0eTsKICAKICB9LHsiLi4vYXBpcy9jb2duaXRvLWlkZW50aXR5LTIwMTQtMDYtMzAubWluLmpzb24iOjEsIi4uL2FwaXMvY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwLnBhZ2luYXRvcnMuanNvbiI6MiwiLi4vbGliL2NvcmUiOjE4LCIuLi9saWIvbm9kZV9sb2FkZXIiOjE2LCIuLi9saWIvc2VydmljZXMvY29nbml0b2lkZW50aXR5Ijo2MH1dLDg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHJlcXVpcmUoJy4uL2xpYi9ub2RlX2xvYWRlcicpOwogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9saWIvY29yZScpOwogIHZhciBTZXJ2aWNlID0gQVdTLlNlcnZpY2U7CiAgdmFyIGFwaUxvYWRlciA9IEFXUy5hcGlMb2FkZXI7CiAgCiAgYXBpTG9hZGVyLnNlcnZpY2VzWydzdHMnXSA9IHt9OwogIEFXUy5TVFMgPSBTZXJ2aWNlLmRlZmluZVNlcnZpY2UoJ3N0cycsIFsnMjAxMS0wNi0xNSddKTsKICByZXF1aXJlKCcuLi9saWIvc2VydmljZXMvc3RzJyk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGFwaUxvYWRlci5zZXJ2aWNlc1snc3RzJ10sICcyMDExLTA2LTE1JywgewogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHZhciBtb2RlbCA9IHJlcXVpcmUoJy4uL2FwaXMvc3RzLTIwMTEtMDYtMTUubWluLmpzb24nKTsKICAgICAgbW9kZWwucGFnaW5hdG9ycyA9IHJlcXVpcmUoJy4uL2FwaXMvc3RzLTIwMTEtMDYtMTUucGFnaW5hdG9ycy5qc29uJykucGFnaW5hdGlvbjsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBjb25maWd1cmFibGU6IHRydWUKICB9KTsKICAKICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TVFM7CiAgCiAgfSx7Ii4uL2FwaXMvc3RzLTIwMTEtMDYtMTUubWluLmpzb24iOjUsIi4uL2FwaXMvc3RzLTIwMTEtMDYtMTUucGFnaW5hdG9ycy5qc29uIjo2LCIuLi9saWIvY29yZSI6MTgsIi4uL2xpYi9ub2RlX2xvYWRlciI6MTYsIi4uL2xpYi9zZXJ2aWNlcy9zdHMiOjYxfV0sOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgZnVuY3Rpb24gYXBpTG9hZGVyKHN2YywgdmVyc2lvbikgewogICAgaWYgKCFhcGlMb2FkZXIuc2VydmljZXMuaGFzT3duUHJvcGVydHkoc3ZjKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWRTZXJ2aWNlOiBGYWlsZWQgdG8gbG9hZCBhcGkgZm9yICcgKyBzdmMpOwogICAgfQogICAgcmV0dXJuIGFwaUxvYWRlci5zZXJ2aWNlc1tzdmNdW3ZlcnNpb25dOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKgogICAqIFRoaXMgbWVtYmVyIG9mIEFXUy5hcGlMb2FkZXIgaXMgcHJpdmF0ZSwgYnV0IGNoYW5naW5nIGl0IHdpbGwgbmVjZXNzaXRhdGUgYQogICAqIGNoYW5nZSB0byAuLi9zY3JpcHRzL3NlcnZpY2VzLXRhYmxlLWdlbmVyYXRvci50cwogICAqLwogIGFwaUxvYWRlci5zZXJ2aWNlcyA9IHt9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gYXBpTG9hZGVyOwogIAogIH0se31dLDEwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgSG1hYyA9IHJlcXVpcmUoJy4vYnJvd3NlckhtYWMnKTsKICB2YXIgTWQ1ID0gcmVxdWlyZSgnLi9icm93c2VyTWQ1Jyk7CiAgdmFyIFNoYTEgPSByZXF1aXJlKCcuL2Jyb3dzZXJTaGExJyk7CiAgdmFyIFNoYTI1NiA9IHJlcXVpcmUoJy4vYnJvd3NlclNoYTI1NicpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IHsKICAgICAgY3JlYXRlSGFzaDogZnVuY3Rpb24gY3JlYXRlSGFzaChhbGcpIHsKICAgICAgICBhbGcgPSBhbGcudG9Mb3dlckNhc2UoKTsKICAgICAgICBpZiAoYWxnID09PSAnbWQ1JykgewogICAgICAgICAgcmV0dXJuIG5ldyBNZDUoKTsKICAgICAgICB9IGVsc2UgaWYgKGFsZyA9PT0gJ3NoYTI1NicpIHsKICAgICAgICAgIHJldHVybiBuZXcgU2hhMjU2KCk7CiAgICAgICAgfSBlbHNlIGlmIChhbGcgPT09ICdzaGExJykgewogICAgICAgICAgcmV0dXJuIG5ldyBTaGExKCk7CiAgICAgICAgfQogIAogICAgICAgIHRocm93IG5ldyBFcnJvcignSGFzaCBhbGdvcml0aG0gJyArIGFsZyArICcgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGUgYnJvd3NlciBTREsnKTsKICAgICAgfSwKICAgICAgY3JlYXRlSG1hYzogZnVuY3Rpb24gY3JlYXRlSG1hYyhhbGcsIGtleSkgewogICAgICAgIGFsZyA9IGFsZy50b0xvd2VyQ2FzZSgpOwogICAgICAgIGlmIChhbGcgPT09ICdtZDUnKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEhtYWMoTWQ1LCBrZXkpOwogICAgICAgIH0gZWxzZSBpZiAoYWxnID09PSAnc2hhMjU2JykgewogICAgICAgICAgcmV0dXJuIG5ldyBIbWFjKFNoYTI1Niwga2V5KTsKICAgICAgICB9IGVsc2UgaWYgKGFsZyA9PT0gJ3NoYTEnKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEhtYWMoU2hhMSwga2V5KTsKICAgICAgICB9CiAgCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdITUFDIGFsZ29yaXRobSAnICsgYWxnICsgJyBpcyBub3Qgc3VwcG9ydGVkIGluIHRoZSBicm93c2VyIFNESycpOwogICAgICB9LAogICAgICBjcmVhdGVTaWduOiBmdW5jdGlvbigpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NyZWF0ZVNpZ24gaXMgbm90IGltcGxlbWVudGVkIGluIHRoZSBicm93c2VyJyk7CiAgICAgIH0KICAgIH07CiAgCiAgfSx7Ii4vYnJvd3NlckhtYWMiOjEyLCIuL2Jyb3dzZXJNZDUiOjEzLCIuL2Jyb3dzZXJTaGExIjoxNCwiLi9icm93c2VyU2hhMjU2IjoxNX1dLDExOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKICAKICAvKioKICAgKiBUaGlzIGlzIGEgcG9seWZpbGwgZm9yIHRoZSBzdGF0aWMgbWV0aG9kIGBpc1ZpZXdgIG9mIGBBcnJheUJ1ZmZlcmAsIHdoaWNoIGlzCiAgICogZS5nLiBtaXNzaW5nIGluIElFIDEwLgogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgaWYgKAogICAgICB0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmCiAgICAgIHR5cGVvZiBBcnJheUJ1ZmZlci5pc1ZpZXcgPT09ICd1bmRlZmluZWQnCiAgKSB7CiAgICAgIEFycmF5QnVmZmVyLmlzVmlldyA9IGZ1bmN0aW9uKGFyZykgewogICAgICAgICAgcmV0dXJuIHZpZXdTdHJpbmdzLmluZGV4T2YoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGFyZykpID4gLTE7CiAgICAgIH07CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciB2aWV3U3RyaW5ncyA9IFsKICAgICAgJ1tvYmplY3QgSW50OEFycmF5XScsCiAgICAgICdbb2JqZWN0IFVpbnQ4QXJyYXldJywKICAgICAgJ1tvYmplY3QgVWludDhDbGFtcGVkQXJyYXldJywKICAgICAgJ1tvYmplY3QgSW50MTZBcnJheV0nLAogICAgICAnW29iamVjdCBVaW50MTZBcnJheV0nLAogICAgICAnW29iamVjdCBJbnQzMkFycmF5XScsCiAgICAgICdbb2JqZWN0IFVpbnQzMkFycmF5XScsCiAgICAgICdbb2JqZWN0IEZsb2F0MzJBcnJheV0nLAogICAgICAnW29iamVjdCBGbG9hdDY0QXJyYXldJywKICAgICAgJ1tvYmplY3QgRGF0YVZpZXddJywKICBdOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGlzRW1wdHlEYXRhKGRhdGEpIHsKICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgewogICAgICAgICAgcmV0dXJuIGRhdGEubGVuZ3RoID09PSAwOwogICAgICB9CiAgICAgIHJldHVybiBkYXRhLmJ5dGVMZW5ndGggPT09IDA7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGNvbnZlcnRUb0J1ZmZlcihkYXRhKSB7CiAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGRhdGEgPSBuZXcgQnVmZmVyKGRhdGEsICd1dGY4Jyk7CiAgICAgIH0KICAKICAgICAgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhkYXRhKSkgewogICAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQsIGRhdGEuYnl0ZUxlbmd0aCAvIFVpbnQ4QXJyYXkuQllURVNfUEVSX0VMRU1FTlQpOwogICAgICB9CiAgCiAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShkYXRhKTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gewogICAgICBpc0VtcHR5RGF0YTogaXNFbXB0eURhdGEsCiAgICAgIGNvbnZlcnRUb0J1ZmZlcjogY29udmVydFRvQnVmZmVyLAogIH07CiAgCiAgfSx7ImJ1ZmZlci8iOjgwfV0sMTI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBoYXNoVXRpbHMgPSByZXF1aXJlKCcuL2Jyb3dzZXJIYXNoVXRpbHMnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBIbWFjKGhhc2hDdG9yLCBzZWNyZXQpIHsKICAgICAgdGhpcy5oYXNoID0gbmV3IGhhc2hDdG9yKCk7CiAgICAgIHRoaXMub3V0ZXIgPSBuZXcgaGFzaEN0b3IoKTsKICAKICAgICAgdmFyIGlubmVyID0gYnVmZmVyRnJvbVNlY3JldChoYXNoQ3Rvciwgc2VjcmV0KTsKICAgICAgdmFyIG91dGVyID0gbmV3IFVpbnQ4QXJyYXkoaGFzaEN0b3IuQkxPQ0tfU0laRSk7CiAgICAgIG91dGVyLnNldChpbm5lcik7CiAgCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaGFzaEN0b3IuQkxPQ0tfU0laRTsgaSsrKSB7CiAgICAgICAgICBpbm5lcltpXSBePSAweDM2OwogICAgICAgICAgb3V0ZXJbaV0gXj0gMHg1YzsKICAgICAgfQogIAogICAgICB0aGlzLmhhc2gudXBkYXRlKGlubmVyKTsKICAgICAgdGhpcy5vdXRlci51cGRhdGUob3V0ZXIpOwogIAogICAgICAvLyBaZXJvIG91dCB0aGUgY29waWVkIGtleSBidWZmZXIuCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5uZXIuYnl0ZUxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpbm5lcltpXSA9IDA7CiAgICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gSG1hYzsKICAKICBIbWFjLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAodG9IYXNoKSB7CiAgICAgIGlmIChoYXNoVXRpbHMuaXNFbXB0eURhdGEodG9IYXNoKSB8fCB0aGlzLmVycm9yKSB7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogIAogICAgICB0cnkgewogICAgICAgICAgdGhpcy5oYXNoLnVwZGF0ZShoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKHRvSGFzaCkpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICB0aGlzLmVycm9yID0gZTsKICAgICAgfQogIAogICAgICByZXR1cm4gdGhpczsKICB9OwogIAogIEhtYWMucHJvdG90eXBlLmRpZ2VzdCA9IGZ1bmN0aW9uIChlbmNvZGluZykgewogICAgICBpZiAoIXRoaXMub3V0ZXIuZmluaXNoZWQpIHsKICAgICAgICAgIHRoaXMub3V0ZXIudXBkYXRlKHRoaXMuaGFzaC5kaWdlc3QoKSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXMub3V0ZXIuZGlnZXN0KGVuY29kaW5nKTsKICB9OwogIAogIGZ1bmN0aW9uIGJ1ZmZlckZyb21TZWNyZXQoaGFzaEN0b3IsIHNlY3JldCkgewogICAgICB2YXIgaW5wdXQgPSBoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKHNlY3JldCk7CiAgICAgIGlmIChpbnB1dC5ieXRlTGVuZ3RoID4gaGFzaEN0b3IuQkxPQ0tfU0laRSkgewogICAgICAgICAgdmFyIGJ1ZmZlckhhc2ggPSBuZXcgaGFzaEN0b3I7CiAgICAgICAgICBidWZmZXJIYXNoLnVwZGF0ZShpbnB1dCk7CiAgICAgICAgICBpbnB1dCA9IGJ1ZmZlckhhc2guZGlnZXN0KCk7CiAgICAgIH0KICAgICAgdmFyIGJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KGhhc2hDdG9yLkJMT0NLX1NJWkUpOwogICAgICBidWZmZXIuc2V0KGlucHV0KTsKICAgICAgcmV0dXJuIGJ1ZmZlcjsKICB9CiAgCiAgfSx7Ii4vYnJvd3Nlckhhc2hVdGlscyI6MTF9XSwxMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIGhhc2hVdGlscyA9IHJlcXVpcmUoJy4vYnJvd3Nlckhhc2hVdGlscycpOwogIHZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwogIAogIHZhciBCTE9DS19TSVpFID0gNjQ7CiAgCiAgdmFyIERJR0VTVF9MRU5HVEggPSAxNjsKICAKICB2YXIgSU5JVCA9IFsKICAgICAgMHg2NzQ1MjMwMSwKICAgICAgMHhlZmNkYWI4OSwKICAgICAgMHg5OGJhZGNmZSwKICAgICAgMHgxMDMyNTQ3NiwKICBdOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIE1kNSgpIHsKICAgICAgdGhpcy5zdGF0ZSA9IFsKICAgICAgICAgIDB4Njc0NTIzMDEsCiAgICAgICAgICAweGVmY2RhYjg5LAogICAgICAgICAgMHg5OGJhZGNmZSwKICAgICAgICAgIDB4MTAzMjU0NzYsCiAgICAgIF07CiAgICAgIHRoaXMuYnVmZmVyID0gbmV3IERhdGFWaWV3KG5ldyBBcnJheUJ1ZmZlcihCTE9DS19TSVpFKSk7CiAgICAgIHRoaXMuYnVmZmVyTGVuZ3RoID0gMDsKICAgICAgdGhpcy5ieXRlc0hhc2hlZCA9IDA7CiAgICAgIHRoaXMuZmluaXNoZWQgPSBmYWxzZTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gTWQ1OwogIAogIE1kNS5CTE9DS19TSVpFID0gQkxPQ0tfU0laRTsKICAKICBNZDUucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIChzb3VyY2VEYXRhKSB7CiAgICAgIGlmIChoYXNoVXRpbHMuaXNFbXB0eURhdGEoc291cmNlRGF0YSkpIHsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICB9IGVsc2UgaWYgKHRoaXMuZmluaXNoZWQpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQXR0ZW1wdGVkIHRvIHVwZGF0ZSBhbiBhbHJlYWR5IGZpbmlzaGVkIGhhc2guJyk7CiAgICAgIH0KICAKICAgICAgdmFyIGRhdGEgPSBoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKHNvdXJjZURhdGEpOwogICAgICB2YXIgcG9zaXRpb24gPSAwOwogICAgICB2YXIgYnl0ZUxlbmd0aCA9IGRhdGEuYnl0ZUxlbmd0aDsKICAgICAgdGhpcy5ieXRlc0hhc2hlZCArPSBieXRlTGVuZ3RoOwogICAgICB3aGlsZSAoYnl0ZUxlbmd0aCA+IDApIHsKICAgICAgICAgIHRoaXMuYnVmZmVyLnNldFVpbnQ4KHRoaXMuYnVmZmVyTGVuZ3RoKyssIGRhdGFbcG9zaXRpb24rK10pOwogICAgICAgICAgYnl0ZUxlbmd0aC0tOwogICAgICAgICAgaWYgKHRoaXMuYnVmZmVyTGVuZ3RoID09PSBCTE9DS19TSVpFKSB7CiAgICAgICAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgTWQ1LnByb3RvdHlwZS5kaWdlc3QgPSBmdW5jdGlvbiAoZW5jb2RpbmcpIHsKICAgICAgaWYgKCF0aGlzLmZpbmlzaGVkKSB7CiAgICAgICAgICB2YXIgX2EgPSB0aGlzLCBidWZmZXIgPSBfYS5idWZmZXIsIHVuZGVjb3JhdGVkTGVuZ3RoID0gX2EuYnVmZmVyTGVuZ3RoLCBieXRlc0hhc2hlZCA9IF9hLmJ5dGVzSGFzaGVkOwogICAgICAgICAgdmFyIGJpdHNIYXNoZWQgPSBieXRlc0hhc2hlZCAqIDg7CiAgICAgICAgICBidWZmZXIuc2V0VWludDgodGhpcy5idWZmZXJMZW5ndGgrKywgMTI4KTsKICAgICAgICAgIC8vIEVuc3VyZSB0aGUgZmluYWwgYmxvY2sgaGFzIGVub3VnaCByb29tIGZvciB0aGUgaGFzaGVkIGxlbmd0aAogICAgICAgICAgaWYgKHVuZGVjb3JhdGVkTGVuZ3RoICUgQkxPQ0tfU0laRSA+PSBCTE9DS19TSVpFIC0gOCkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmJ1ZmZlckxlbmd0aDsgaSA8IEJMT0NLX1NJWkU7IGkrKykgewogICAgICAgICAgICAgICAgICBidWZmZXIuc2V0VWludDgoaSwgMCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuaGFzaEJ1ZmZlcigpOwogICAgICAgICAgICAgIHRoaXMuYnVmZmVyTGVuZ3RoID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmJ1ZmZlckxlbmd0aDsgaSA8IEJMT0NLX1NJWkUgLSA4OyBpKyspIHsKICAgICAgICAgICAgICBidWZmZXIuc2V0VWludDgoaSwgMCk7CiAgICAgICAgICB9CiAgICAgICAgICBidWZmZXIuc2V0VWludDMyKEJMT0NLX1NJWkUgLSA4LCBiaXRzSGFzaGVkID4+PiAwLCB0cnVlKTsKICAgICAgICAgIGJ1ZmZlci5zZXRVaW50MzIoQkxPQ0tfU0laRSAtIDQsIE1hdGguZmxvb3IoYml0c0hhc2hlZCAvIDB4MTAwMDAwMDAwKSwgdHJ1ZSk7CiAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgIHRoaXMuZmluaXNoZWQgPSB0cnVlOwogICAgICB9CiAgICAgIHZhciBvdXQgPSBuZXcgRGF0YVZpZXcobmV3IEFycmF5QnVmZmVyKERJR0VTVF9MRU5HVEgpKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCA0OyBpKyspIHsKICAgICAgICAgIG91dC5zZXRVaW50MzIoaSAqIDQsIHRoaXMuc3RhdGVbaV0sIHRydWUpOwogICAgICB9CiAgICAgIHZhciBidWZmID0gbmV3IEJ1ZmZlcihvdXQuYnVmZmVyLCBvdXQuYnl0ZU9mZnNldCwgb3V0LmJ5dGVMZW5ndGgpOwogICAgICByZXR1cm4gZW5jb2RpbmcgPyBidWZmLnRvU3RyaW5nKGVuY29kaW5nKSA6IGJ1ZmY7CiAgfTsKICAKICBNZDUucHJvdG90eXBlLmhhc2hCdWZmZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfYSA9IHRoaXMsIGJ1ZmZlciA9IF9hLmJ1ZmZlciwgc3RhdGUgPSBfYS5zdGF0ZTsKICAgICAgdmFyIGEgPSBzdGF0ZVswXSwgYiA9IHN0YXRlWzFdLCBjID0gc3RhdGVbMl0sIGQgPSBzdGF0ZVszXTsKICAgICAgYSA9IGZmKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMCwgdHJ1ZSksIDcsIDB4ZDc2YWE0NzgpOwogICAgICBkID0gZmYoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig0LCB0cnVlKSwgMTIsIDB4ZThjN2I3NTYpOwogICAgICBjID0gZmYoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig4LCB0cnVlKSwgMTcsIDB4MjQyMDcwZGIpOwogICAgICBiID0gZmYoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigxMiwgdHJ1ZSksIDIyLCAweGMxYmRjZWVlKTsKICAgICAgYSA9IGZmKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMTYsIHRydWUpLCA3LCAweGY1N2MwZmFmKTsKICAgICAgZCA9IGZmKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMjAsIHRydWUpLCAxMiwgMHg0Nzg3YzYyYSk7CiAgICAgIGMgPSBmZihjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDI0LCB0cnVlKSwgMTcsIDB4YTgzMDQ2MTMpOwogICAgICBiID0gZmYoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigyOCwgdHJ1ZSksIDIyLCAweGZkNDY5NTAxKTsKICAgICAgYSA9IGZmKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMzIsIHRydWUpLCA3LCAweDY5ODA5OGQ4KTsKICAgICAgZCA9IGZmKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMzYsIHRydWUpLCAxMiwgMHg4YjQ0ZjdhZik7CiAgICAgIGMgPSBmZihjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDQwLCB0cnVlKSwgMTcsIDB4ZmZmZjViYjEpOwogICAgICBiID0gZmYoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig0NCwgdHJ1ZSksIDIyLCAweDg5NWNkN2JlKTsKICAgICAgYSA9IGZmKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNDgsIHRydWUpLCA3LCAweDZiOTAxMTIyKTsKICAgICAgZCA9IGZmKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNTIsIHRydWUpLCAxMiwgMHhmZDk4NzE5Myk7CiAgICAgIGMgPSBmZihjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDU2LCB0cnVlKSwgMTcsIDB4YTY3OTQzOGUpOwogICAgICBiID0gZmYoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig2MCwgdHJ1ZSksIDIyLCAweDQ5YjQwODIxKTsKICAgICAgYSA9IGdnKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNCwgdHJ1ZSksIDUsIDB4ZjYxZTI1NjIpOwogICAgICBkID0gZ2coZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigyNCwgdHJ1ZSksIDksIDB4YzA0MGIzNDApOwogICAgICBjID0gZ2coYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig0NCwgdHJ1ZSksIDE0LCAweDI2NWU1YTUxKTsKICAgICAgYiA9IGdnKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMCwgdHJ1ZSksIDIwLCAweGU5YjZjN2FhKTsKICAgICAgYSA9IGdnKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMjAsIHRydWUpLCA1LCAweGQ2MmYxMDVkKTsKICAgICAgZCA9IGdnKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNDAsIHRydWUpLCA5LCAweDAyNDQxNDUzKTsKICAgICAgYyA9IGdnKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNjAsIHRydWUpLCAxNCwgMHhkOGExZTY4MSk7CiAgICAgIGIgPSBnZyhiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDE2LCB0cnVlKSwgMjAsIDB4ZTdkM2ZiYzgpOwogICAgICBhID0gZ2coYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigzNiwgdHJ1ZSksIDUsIDB4MjFlMWNkZTYpOwogICAgICBkID0gZ2coZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig1NiwgdHJ1ZSksIDksIDB4YzMzNzA3ZDYpOwogICAgICBjID0gZ2coYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMigxMiwgdHJ1ZSksIDE0LCAweGY0ZDUwZDg3KTsKICAgICAgYiA9IGdnKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMzIsIHRydWUpLCAyMCwgMHg0NTVhMTRlZCk7CiAgICAgIGEgPSBnZyhhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDUyLCB0cnVlKSwgNSwgMHhhOWUzZTkwNSk7CiAgICAgIGQgPSBnZyhkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDgsIHRydWUpLCA5LCAweGZjZWZhM2Y4KTsKICAgICAgYyA9IGdnKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMjgsIHRydWUpLCAxNCwgMHg2NzZmMDJkOSk7CiAgICAgIGIgPSBnZyhiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDQ4LCB0cnVlKSwgMjAsIDB4OGQyYTRjOGEpOwogICAgICBhID0gaGgoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigyMCwgdHJ1ZSksIDQsIDB4ZmZmYTM5NDIpOwogICAgICBkID0gaGgoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigzMiwgdHJ1ZSksIDExLCAweDg3NzFmNjgxKTsKICAgICAgYyA9IGhoKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNDQsIHRydWUpLCAxNiwgMHg2ZDlkNjEyMik7CiAgICAgIGIgPSBoaChiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDU2LCB0cnVlKSwgMjMsIDB4ZmRlNTM4MGMpOwogICAgICBhID0gaGgoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMig0LCB0cnVlKSwgNCwgMHhhNGJlZWE0NCk7CiAgICAgIGQgPSBoaChkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDE2LCB0cnVlKSwgMTEsIDB4NGJkZWNmYTkpOwogICAgICBjID0gaGgoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMigyOCwgdHJ1ZSksIDE2LCAweGY2YmI0YjYwKTsKICAgICAgYiA9IGhoKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNDAsIHRydWUpLCAyMywgMHhiZWJmYmM3MCk7CiAgICAgIGEgPSBoaChhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDUyLCB0cnVlKSwgNCwgMHgyODliN2VjNik7CiAgICAgIGQgPSBoaChkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDAsIHRydWUpLCAxMSwgMHhlYWExMjdmYSk7CiAgICAgIGMgPSBoaChjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDEyLCB0cnVlKSwgMTYsIDB4ZDRlZjMwODUpOwogICAgICBiID0gaGgoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigyNCwgdHJ1ZSksIDIzLCAweDA0ODgxZDA1KTsKICAgICAgYSA9IGhoKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMzYsIHRydWUpLCA0LCAweGQ5ZDRkMDM5KTsKICAgICAgZCA9IGhoKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNDgsIHRydWUpLCAxMSwgMHhlNmRiOTllNSk7CiAgICAgIGMgPSBoaChjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDYwLCB0cnVlKSwgMTYsIDB4MWZhMjdjZjgpOwogICAgICBiID0gaGgoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig4LCB0cnVlKSwgMjMsIDB4YzRhYzU2NjUpOwogICAgICBhID0gaWkoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigwLCB0cnVlKSwgNiwgMHhmNDI5MjI0NCk7CiAgICAgIGQgPSBpaShkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDI4LCB0cnVlKSwgMTAsIDB4NDMyYWZmOTcpOwogICAgICBjID0gaWkoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig1NiwgdHJ1ZSksIDE1LCAweGFiOTQyM2E3KTsKICAgICAgYiA9IGlpKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMjAsIHRydWUpLCAyMSwgMHhmYzkzYTAzOSk7CiAgICAgIGEgPSBpaShhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDQ4LCB0cnVlKSwgNiwgMHg2NTViNTljMyk7CiAgICAgIGQgPSBpaShkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDEyLCB0cnVlKSwgMTAsIDB4OGYwY2NjOTIpOwogICAgICBjID0gaWkoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig0MCwgdHJ1ZSksIDE1LCAweGZmZWZmNDdkKTsKICAgICAgYiA9IGlpKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNCwgdHJ1ZSksIDIxLCAweDg1ODQ1ZGQxKTsKICAgICAgYSA9IGlpKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMzIsIHRydWUpLCA2LCAweDZmYTg3ZTRmKTsKICAgICAgZCA9IGlpKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNjAsIHRydWUpLCAxMCwgMHhmZTJjZTZlMCk7CiAgICAgIGMgPSBpaShjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDI0LCB0cnVlKSwgMTUsIDB4YTMwMTQzMTQpOwogICAgICBiID0gaWkoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig1MiwgdHJ1ZSksIDIxLCAweDRlMDgxMWExKTsKICAgICAgYSA9IGlpKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMTYsIHRydWUpLCA2LCAweGY3NTM3ZTgyKTsKICAgICAgZCA9IGlpKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNDQsIHRydWUpLCAxMCwgMHhiZDNhZjIzNSk7CiAgICAgIGMgPSBpaShjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDgsIHRydWUpLCAxNSwgMHgyYWQ3ZDJiYik7CiAgICAgIGIgPSBpaShiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDM2LCB0cnVlKSwgMjEsIDB4ZWI4NmQzOTEpOwogICAgICBzdGF0ZVswXSA9IChhICsgc3RhdGVbMF0pICYgMHhGRkZGRkZGRjsKICAgICAgc3RhdGVbMV0gPSAoYiArIHN0YXRlWzFdKSAmIDB4RkZGRkZGRkY7CiAgICAgIHN0YXRlWzJdID0gKGMgKyBzdGF0ZVsyXSkgJiAweEZGRkZGRkZGOwogICAgICBzdGF0ZVszXSA9IChkICsgc3RhdGVbM10pICYgMHhGRkZGRkZGRjsKICB9OwogIAogIGZ1bmN0aW9uIGNtbihxLCBhLCBiLCB4LCBzLCB0KSB7CiAgICAgIGEgPSAoKChhICsgcSkgJiAweEZGRkZGRkZGKSArICgoeCArIHQpICYgMHhGRkZGRkZGRikpICYgMHhGRkZGRkZGRjsKICAgICAgcmV0dXJuICgoKGEgPDwgcykgfCAoYSA+Pj4gKDMyIC0gcykpKSArIGIpICYgMHhGRkZGRkZGRjsKICB9CiAgCiAgZnVuY3Rpb24gZmYoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICByZXR1cm4gY21uKChiICYgYykgfCAoKH5iKSAmIGQpLCBhLCBiLCB4LCBzLCB0KTsKICB9CiAgCiAgZnVuY3Rpb24gZ2coYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICByZXR1cm4gY21uKChiICYgZCkgfCAoYyAmICh+ZCkpLCBhLCBiLCB4LCBzLCB0KTsKICB9CiAgCiAgZnVuY3Rpb24gaGgoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICByZXR1cm4gY21uKGIgXiBjIF4gZCwgYSwgYiwgeCwgcywgdCk7CiAgfQogIAogIGZ1bmN0aW9uIGlpKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgICAgcmV0dXJuIGNtbihjIF4gKGIgfCAofmQpKSwgYSwgYiwgeCwgcywgdCk7CiAgfQogIAogIH0seyIuL2Jyb3dzZXJIYXNoVXRpbHMiOjExLCJidWZmZXIvIjo4MH1dLDE0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKICB2YXIgaGFzaFV0aWxzID0gcmVxdWlyZSgnLi9icm93c2VySGFzaFV0aWxzJyk7CiAgCiAgdmFyIEJMT0NLX1NJWkUgPSA2NDsKICAKICB2YXIgRElHRVNUX0xFTkdUSCA9IDIwOwogIAogIHZhciBLRVkgPSBuZXcgVWludDMyQXJyYXkoWwogICAgICAweDVhODI3OTk5LAogICAgICAweDZlZDllYmExLAogICAgICAweDhmMWJiY2RjIHwgMCwKICAgICAgMHhjYTYyYzFkNiB8IDAKICBdKTsKICAKICB2YXIgSU5JVCA9IFsKICAgICAgMHg2YTA5ZTY2NywKICAgICAgMHhiYjY3YWU4NSwKICAgICAgMHgzYzZlZjM3MiwKICAgICAgMHhhNTRmZjUzYSwKICAgICAgMHg1MTBlNTI3ZiwKICAgICAgMHg5YjA1Njg4YywKICAgICAgMHgxZjgzZDlhYiwKICAgICAgMHg1YmUwY2QxOSwKICBdOwogIAogIHZhciBNQVhfSEFTSEFCTEVfTEVOR1RIID0gTWF0aC5wb3coMiwgNTMpIC0gMTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBTaGExKCkgewogICAgICB0aGlzLmgwID0gMHg2NzQ1MjMwMTsKICAgICAgdGhpcy5oMSA9IDB4RUZDREFCODk7CiAgICAgIHRoaXMuaDIgPSAweDk4QkFEQ0ZFOwogICAgICB0aGlzLmgzID0gMHgxMDMyNTQ3NjsKICAgICAgdGhpcy5oNCA9IDB4QzNEMkUxRjA7CiAgICAgIC8vIFRoZSBmaXJzdCA2NCBieXRlcyAoMTYgd29yZHMpIGlzIHRoZSBkYXRhIGNodW5rCiAgICAgIHRoaXMuYmxvY2sgPSBuZXcgVWludDMyQXJyYXkoODApOwogICAgICB0aGlzLm9mZnNldCA9IDA7CiAgICAgIHRoaXMuc2hpZnQgPSAyNDsKICAgICAgdGhpcy50b3RhbExlbmd0aCA9IDA7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IFNoYTE7CiAgCiAgU2hhMS5CTE9DS19TSVpFID0gQkxPQ0tfU0laRTsKICAKICBTaGExLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICBpZiAodGhpcy5maW5pc2hlZCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdHRlbXB0ZWQgdG8gdXBkYXRlIGFuIGFscmVhZHkgZmluaXNoZWQgaGFzaC4nKTsKICAgICAgfQogIAogICAgICBpZiAoaGFzaFV0aWxzLmlzRW1wdHlEYXRhKGRhdGEpKSB7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogIAogICAgICBkYXRhID0gaGFzaFV0aWxzLmNvbnZlcnRUb0J1ZmZlcihkYXRhKTsKICAKICAgICAgdmFyIGxlbmd0aCA9IGRhdGEubGVuZ3RoOwogICAgICB0aGlzLnRvdGFsTGVuZ3RoICs9IGxlbmd0aCAqIDg7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHRoaXMud3JpdGUoZGF0YVtpXSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBTaGExLnByb3RvdHlwZS53cml0ZSA9IGZ1bmN0aW9uIHdyaXRlKGJ5dGUpIHsKICAgICAgdGhpcy5ibG9ja1t0aGlzLm9mZnNldF0gfD0gKGJ5dGUgJiAweGZmKSA8PCB0aGlzLnNoaWZ0OwogICAgICBpZiAodGhpcy5zaGlmdCkgewogICAgICAgICAgdGhpcy5zaGlmdCAtPSA4OwogICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5vZmZzZXQrKzsKICAgICAgICAgIHRoaXMuc2hpZnQgPSAyNDsKICAgICAgfQogIAogICAgICBpZiAodGhpcy5vZmZzZXQgPT09IDE2KSB0aGlzLnByb2Nlc3NCbG9jaygpOwogIH07CiAgCiAgU2hhMS5wcm90b3R5cGUuZGlnZXN0ID0gZnVuY3Rpb24gKGVuY29kaW5nKSB7CiAgICAgIC8vIFBhZAogICAgICB0aGlzLndyaXRlKDB4ODApOwogICAgICBpZiAodGhpcy5vZmZzZXQgPiAxNCB8fCAodGhpcy5vZmZzZXQgPT09IDE0ICYmIHRoaXMuc2hpZnQgPCAyNCkpIHsKICAgICAgICB0aGlzLnByb2Nlc3NCbG9jaygpOwogICAgICB9CiAgICAgIHRoaXMub2Zmc2V0ID0gMTQ7CiAgICAgIHRoaXMuc2hpZnQgPSAyNDsKICAKICAgICAgLy8gNjQtYml0IGxlbmd0aCBiaWctZW5kaWFuCiAgICAgIHRoaXMud3JpdGUoMHgwMCk7IC8vIG51bWJlcnMgdGhpcyBiaWcgYXJlbid0IGFjY3VyYXRlIGluIGphdmFzY3JpcHQgYW55d2F5CiAgICAgIHRoaXMud3JpdGUoMHgwMCk7IC8vIC4uU28ganVzdCBoYXJkLWNvZGUgdG8gemVyby4KICAgICAgdGhpcy53cml0ZSh0aGlzLnRvdGFsTGVuZ3RoID4gMHhmZmZmZmZmZmZmID8gdGhpcy50b3RhbExlbmd0aCAvIDB4MTAwMDAwMDAwMDAgOiAweDAwKTsKICAgICAgdGhpcy53cml0ZSh0aGlzLnRvdGFsTGVuZ3RoID4gMHhmZmZmZmZmZiA/IHRoaXMudG90YWxMZW5ndGggLyAweDEwMDAwMDAwMCA6IDB4MDApOwogICAgICBmb3IgKHZhciBzID0gMjQ7IHMgPj0gMDsgcyAtPSA4KSB7CiAgICAgICAgICB0aGlzLndyaXRlKHRoaXMudG90YWxMZW5ndGggPj4gcyk7CiAgICAgIH0KICAgICAgLy8gVGhlIHZhbHVlIGluIHN0YXRlIGlzIGxpdHRsZS1lbmRpYW4gcmF0aGVyIHRoYW4gYmlnLWVuZGlhbiwgc28gZmxpcAogICAgICAvLyBlYWNoIHdvcmQgaW50byBhIG5ldyBVaW50OEFycmF5CiAgICAgIHZhciBvdXQgPSBuZXcgQnVmZmVyKERJR0VTVF9MRU5HVEgpOwogICAgICB2YXIgb3V0VmlldyA9IG5ldyBEYXRhVmlldyhvdXQuYnVmZmVyKTsKICAgICAgb3V0Vmlldy5zZXRVaW50MzIoMCwgdGhpcy5oMCwgZmFsc2UpOwogICAgICBvdXRWaWV3LnNldFVpbnQzMig0LCB0aGlzLmgxLCBmYWxzZSk7CiAgICAgIG91dFZpZXcuc2V0VWludDMyKDgsIHRoaXMuaDIsIGZhbHNlKTsKICAgICAgb3V0Vmlldy5zZXRVaW50MzIoMTIsIHRoaXMuaDMsIGZhbHNlKTsKICAgICAgb3V0Vmlldy5zZXRVaW50MzIoMTYsIHRoaXMuaDQsIGZhbHNlKTsKICAKICAgICAgcmV0dXJuIGVuY29kaW5nID8gb3V0LnRvU3RyaW5nKGVuY29kaW5nKSA6IG91dDsKICB9OwogIAogIFNoYTEucHJvdG90eXBlLnByb2Nlc3NCbG9jayA9IGZ1bmN0aW9uIHByb2Nlc3NCbG9jaygpIHsKICAgICAgLy8gRXh0ZW5kIHRoZSBzaXh0ZWVuIDMyLWJpdCB3b3JkcyBpbnRvIGVpZ2h0eSAzMi1iaXQgd29yZHM6CiAgICAgIGZvciAodmFyIGkgPSAxNjsgaSA8IDgwOyBpKyspIHsKICAgICAgICB2YXIgdyA9IHRoaXMuYmxvY2tbaSAtIDNdIF4gdGhpcy5ibG9ja1tpIC0gOF0gXiB0aGlzLmJsb2NrW2kgLSAxNF0gXiB0aGlzLmJsb2NrW2kgLSAxNl07CiAgICAgICAgdGhpcy5ibG9ja1tpXSA9ICh3IDw8IDEpIHwgKHcgPj4+IDMxKTsKICAgICAgfQogIAogICAgICAvLyBJbml0aWFsaXplIGhhc2ggdmFsdWUgZm9yIHRoaXMgY2h1bms6CiAgICAgIHZhciBhID0gdGhpcy5oMDsKICAgICAgdmFyIGIgPSB0aGlzLmgxOwogICAgICB2YXIgYyA9IHRoaXMuaDI7CiAgICAgIHZhciBkID0gdGhpcy5oMzsKICAgICAgdmFyIGUgPSB0aGlzLmg0OwogICAgICB2YXIgZiwgazsKICAKICAgICAgLy8gTWFpbiBsb29wOgogICAgICBmb3IgKGkgPSAwOyBpIDwgODA7IGkrKykgewogICAgICAgIGlmIChpIDwgMjApIHsKICAgICAgICAgIGYgPSBkIF4gKGIgJiAoYyBeIGQpKTsKICAgICAgICAgIGsgPSAweDVBODI3OTk5OwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChpIDwgNDApIHsKICAgICAgICAgIGYgPSBiIF4gYyBeIGQ7CiAgICAgICAgICBrID0gMHg2RUQ5RUJBMTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoaSA8IDYwKSB7CiAgICAgICAgICBmID0gKGIgJiBjKSB8IChkICYgKGIgfCBjKSk7CiAgICAgICAgICBrID0gMHg4RjFCQkNEQzsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICBmID0gYiBeIGMgXiBkOwogICAgICAgICAgayA9IDB4Q0E2MkMxRDY7CiAgICAgICAgfQogICAgICAgIHZhciB0ZW1wID0gKGEgPDwgNSB8IGEgPj4+IDI3KSArIGYgKyBlICsgayArICh0aGlzLmJsb2NrW2ldfDApOwogICAgICAgIGUgPSBkOwogICAgICAgIGQgPSBjOwogICAgICAgIGMgPSAoYiA8PCAzMCB8IGIgPj4+IDIpOwogICAgICAgIGIgPSBhOwogICAgICAgIGEgPSB0ZW1wOwogICAgICB9CiAgCiAgICAgIC8vIEFkZCB0aGlzIGNodW5rJ3MgaGFzaCB0byByZXN1bHQgc28gZmFyOgogICAgICB0aGlzLmgwID0gKHRoaXMuaDAgKyBhKSB8IDA7CiAgICAgIHRoaXMuaDEgPSAodGhpcy5oMSArIGIpIHwgMDsKICAgICAgdGhpcy5oMiA9ICh0aGlzLmgyICsgYykgfCAwOwogICAgICB0aGlzLmgzID0gKHRoaXMuaDMgKyBkKSB8IDA7CiAgICAgIHRoaXMuaDQgPSAodGhpcy5oNCArIGUpIHwgMDsKICAKICAgICAgLy8gVGhlIGJsb2NrIGlzIG5vdyByZXVzYWJsZS4KICAgICAgdGhpcy5vZmZzZXQgPSAwOwogICAgICBmb3IgKGkgPSAwOyBpIDwgMTY7IGkrKykgewogICAgICAgICAgdGhpcy5ibG9ja1tpXSA9IDA7CiAgICAgIH0KICB9OwogIAogIH0seyIuL2Jyb3dzZXJIYXNoVXRpbHMiOjExLCJidWZmZXIvIjo4MH1dLDE1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKICB2YXIgaGFzaFV0aWxzID0gcmVxdWlyZSgnLi9icm93c2VySGFzaFV0aWxzJyk7CiAgCiAgdmFyIEJMT0NLX1NJWkUgPSA2NDsKICAKICB2YXIgRElHRVNUX0xFTkdUSCA9IDMyOwogIAogIHZhciBLRVkgPSBuZXcgVWludDMyQXJyYXkoWwogICAgICAweDQyOGEyZjk4LAogICAgICAweDcxMzc0NDkxLAogICAgICAweGI1YzBmYmNmLAogICAgICAweGU5YjVkYmE1LAogICAgICAweDM5NTZjMjViLAogICAgICAweDU5ZjExMWYxLAogICAgICAweDkyM2Y4MmE0LAogICAgICAweGFiMWM1ZWQ1LAogICAgICAweGQ4MDdhYTk4LAogICAgICAweDEyODM1YjAxLAogICAgICAweDI0MzE4NWJlLAogICAgICAweDU1MGM3ZGMzLAogICAgICAweDcyYmU1ZDc0LAogICAgICAweDgwZGViMWZlLAogICAgICAweDliZGMwNmE3LAogICAgICAweGMxOWJmMTc0LAogICAgICAweGU0OWI2OWMxLAogICAgICAweGVmYmU0Nzg2LAogICAgICAweDBmYzE5ZGM2LAogICAgICAweDI0MGNhMWNjLAogICAgICAweDJkZTkyYzZmLAogICAgICAweDRhNzQ4NGFhLAogICAgICAweDVjYjBhOWRjLAogICAgICAweDc2Zjk4OGRhLAogICAgICAweDk4M2U1MTUyLAogICAgICAweGE4MzFjNjZkLAogICAgICAweGIwMDMyN2M4LAogICAgICAweGJmNTk3ZmM3LAogICAgICAweGM2ZTAwYmYzLAogICAgICAweGQ1YTc5MTQ3LAogICAgICAweDA2Y2E2MzUxLAogICAgICAweDE0MjkyOTY3LAogICAgICAweDI3YjcwYTg1LAogICAgICAweDJlMWIyMTM4LAogICAgICAweDRkMmM2ZGZjLAogICAgICAweDUzMzgwZDEzLAogICAgICAweDY1MGE3MzU0LAogICAgICAweDc2NmEwYWJiLAogICAgICAweDgxYzJjOTJlLAogICAgICAweDkyNzIyYzg1LAogICAgICAweGEyYmZlOGExLAogICAgICAweGE4MWE2NjRiLAogICAgICAweGMyNGI4YjcwLAogICAgICAweGM3NmM1MWEzLAogICAgICAweGQxOTJlODE5LAogICAgICAweGQ2OTkwNjI0LAogICAgICAweGY0MGUzNTg1LAogICAgICAweDEwNmFhMDcwLAogICAgICAweDE5YTRjMTE2LAogICAgICAweDFlMzc2YzA4LAogICAgICAweDI3NDg3NzRjLAogICAgICAweDM0YjBiY2I1LAogICAgICAweDM5MWMwY2IzLAogICAgICAweDRlZDhhYTRhLAogICAgICAweDViOWNjYTRmLAogICAgICAweDY4MmU2ZmYzLAogICAgICAweDc0OGY4MmVlLAogICAgICAweDc4YTU2MzZmLAogICAgICAweDg0Yzg3ODE0LAogICAgICAweDhjYzcwMjA4LAogICAgICAweDkwYmVmZmZhLAogICAgICAweGE0NTA2Y2ViLAogICAgICAweGJlZjlhM2Y3LAogICAgICAweGM2NzE3OGYyCiAgXSk7CiAgCiAgdmFyIElOSVQgPSBbCiAgICAgIDB4NmEwOWU2NjcsCiAgICAgIDB4YmI2N2FlODUsCiAgICAgIDB4M2M2ZWYzNzIsCiAgICAgIDB4YTU0ZmY1M2EsCiAgICAgIDB4NTEwZTUyN2YsCiAgICAgIDB4OWIwNTY4OGMsCiAgICAgIDB4MWY4M2Q5YWIsCiAgICAgIDB4NWJlMGNkMTksCiAgXTsKICAKICB2YXIgTUFYX0hBU0hBQkxFX0xFTkdUSCA9IE1hdGgucG93KDIsIDUzKSAtIDE7CiAgCiAgLyoqCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBTaGEyNTYoKSB7CiAgICAgIHRoaXMuc3RhdGUgPSBbCiAgICAgICAgICAweDZhMDllNjY3LAogICAgICAgICAgMHhiYjY3YWU4NSwKICAgICAgICAgIDB4M2M2ZWYzNzIsCiAgICAgICAgICAweGE1NGZmNTNhLAogICAgICAgICAgMHg1MTBlNTI3ZiwKICAgICAgICAgIDB4OWIwNTY4OGMsCiAgICAgICAgICAweDFmODNkOWFiLAogICAgICAgICAgMHg1YmUwY2QxOSwKICAgICAgXTsKICAgICAgdGhpcy50ZW1wID0gbmV3IEludDMyQXJyYXkoNjQpOwogICAgICB0aGlzLmJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KDY0KTsKICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICB0aGlzLmJ5dGVzSGFzaGVkID0gMDsKICAgICAgLyoqCiAgICAgICAqIEBwcml2YXRlCiAgICAgICAqLwogICAgICB0aGlzLmZpbmlzaGVkID0gZmFsc2U7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IFNoYTI1NjsKICAKICBTaGEyNTYuQkxPQ0tfU0laRSA9IEJMT0NLX1NJWkU7CiAgCiAgU2hhMjU2LnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICBpZiAodGhpcy5maW5pc2hlZCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdHRlbXB0ZWQgdG8gdXBkYXRlIGFuIGFscmVhZHkgZmluaXNoZWQgaGFzaC4nKTsKICAgICAgfQogIAogICAgICBpZiAoaGFzaFV0aWxzLmlzRW1wdHlEYXRhKGRhdGEpKSB7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogIAogICAgICBkYXRhID0gaGFzaFV0aWxzLmNvbnZlcnRUb0J1ZmZlcihkYXRhKTsKICAKICAgICAgdmFyIHBvc2l0aW9uID0gMDsKICAgICAgdmFyIGJ5dGVMZW5ndGggPSBkYXRhLmJ5dGVMZW5ndGg7CiAgICAgIHRoaXMuYnl0ZXNIYXNoZWQgKz0gYnl0ZUxlbmd0aDsKICAgICAgaWYgKHRoaXMuYnl0ZXNIYXNoZWQgKiA4ID4gTUFYX0hBU0hBQkxFX0xFTkdUSCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgaGFzaCBtb3JlIHRoYW4gMl41MyAtIDEgYml0cycpOwogICAgICB9CiAgCiAgICAgIHdoaWxlIChieXRlTGVuZ3RoID4gMCkgewogICAgICAgICAgdGhpcy5idWZmZXJbdGhpcy5idWZmZXJMZW5ndGgrK10gPSBkYXRhW3Bvc2l0aW9uKytdOwogICAgICAgICAgYnl0ZUxlbmd0aC0tOwogICAgICAgICAgaWYgKHRoaXMuYnVmZmVyTGVuZ3RoID09PSBCTE9DS19TSVpFKSB7CiAgICAgICAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgU2hhMjU2LnByb3RvdHlwZS5kaWdlc3QgPSBmdW5jdGlvbiAoZW5jb2RpbmcpIHsKICAgICAgaWYgKCF0aGlzLmZpbmlzaGVkKSB7CiAgICAgICAgICB2YXIgYml0c0hhc2hlZCA9IHRoaXMuYnl0ZXNIYXNoZWQgKiA4OwogICAgICAgICAgdmFyIGJ1ZmZlclZpZXcgPSBuZXcgRGF0YVZpZXcodGhpcy5idWZmZXIuYnVmZmVyLCB0aGlzLmJ1ZmZlci5ieXRlT2Zmc2V0LCB0aGlzLmJ1ZmZlci5ieXRlTGVuZ3RoKTsKICAgICAgICAgIHZhciB1bmRlY29yYXRlZExlbmd0aCA9IHRoaXMuYnVmZmVyTGVuZ3RoOwogICAgICAgICAgYnVmZmVyVmlldy5zZXRVaW50OCh0aGlzLmJ1ZmZlckxlbmd0aCsrLCAweDgwKTsKICAgICAgICAgIC8vIEVuc3VyZSB0aGUgZmluYWwgYmxvY2sgaGFzIGVub3VnaCByb29tIGZvciB0aGUgaGFzaGVkIGxlbmd0aAogICAgICAgICAgaWYgKHVuZGVjb3JhdGVkTGVuZ3RoICUgQkxPQ0tfU0laRSA+PSBCTE9DS19TSVpFIC0gOCkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmJ1ZmZlckxlbmd0aDsgaSA8IEJMT0NLX1NJWkU7IGkrKykgewogICAgICAgICAgICAgICAgICBidWZmZXJWaWV3LnNldFVpbnQ4KGksIDApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgICAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5idWZmZXJMZW5ndGg7IGkgPCBCTE9DS19TSVpFIC0gODsgaSsrKSB7CiAgICAgICAgICAgICAgYnVmZmVyVmlldy5zZXRVaW50OChpLCAwKTsKICAgICAgICAgIH0KICAgICAgICAgIGJ1ZmZlclZpZXcuc2V0VWludDMyKEJMT0NLX1NJWkUgLSA4LCBNYXRoLmZsb29yKGJpdHNIYXNoZWQgLyAweDEwMDAwMDAwMCksIHRydWUpOwogICAgICAgICAgYnVmZmVyVmlldy5zZXRVaW50MzIoQkxPQ0tfU0laRSAtIDQsIGJpdHNIYXNoZWQpOwogICAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgICB0aGlzLmZpbmlzaGVkID0gdHJ1ZTsKICAgICAgfQogICAgICAvLyBUaGUgdmFsdWUgaW4gc3RhdGUgaXMgbGl0dGxlLWVuZGlhbiByYXRoZXIgdGhhbiBiaWctZW5kaWFuLCBzbyBmbGlwCiAgICAgIC8vIGVhY2ggd29yZCBpbnRvIGEgbmV3IFVpbnQ4QXJyYXkKICAgICAgdmFyIG91dCA9IG5ldyBCdWZmZXIoRElHRVNUX0xFTkdUSCk7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgODsgaSsrKSB7CiAgICAgICAgICBvdXRbaSAqIDRdID0gKHRoaXMuc3RhdGVbaV0gPj4+IDI0KSAmIDB4ZmY7CiAgICAgICAgICBvdXRbaSAqIDQgKyAxXSA9ICh0aGlzLnN0YXRlW2ldID4+PiAxNikgJiAweGZmOwogICAgICAgICAgb3V0W2kgKiA0ICsgMl0gPSAodGhpcy5zdGF0ZVtpXSA+Pj4gOCkgJiAweGZmOwogICAgICAgICAgb3V0W2kgKiA0ICsgM10gPSAodGhpcy5zdGF0ZVtpXSA+Pj4gMCkgJiAweGZmOwogICAgICB9CiAgICAgIHJldHVybiBlbmNvZGluZyA/IG91dC50b1N0cmluZyhlbmNvZGluZykgOiBvdXQ7CiAgfTsKICAKICBTaGEyNTYucHJvdG90eXBlLmhhc2hCdWZmZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfYSA9IHRoaXMsCiAgICAgICAgICBidWZmZXIgPSBfYS5idWZmZXIsCiAgICAgICAgICBzdGF0ZSA9IF9hLnN0YXRlOwogICAgICB2YXIgc3RhdGUwID0gc3RhdGVbMF0sCiAgICAgICAgICBzdGF0ZTEgPSBzdGF0ZVsxXSwKICAgICAgICAgIHN0YXRlMiA9IHN0YXRlWzJdLAogICAgICAgICAgc3RhdGUzID0gc3RhdGVbM10sCiAgICAgICAgICBzdGF0ZTQgPSBzdGF0ZVs0XSwKICAgICAgICAgIHN0YXRlNSA9IHN0YXRlWzVdLAogICAgICAgICAgc3RhdGU2ID0gc3RhdGVbNl0sCiAgICAgICAgICBzdGF0ZTcgPSBzdGF0ZVs3XTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBCTE9DS19TSVpFOyBpKyspIHsKICAgICAgICAgIGlmIChpIDwgMTYpIHsKICAgICAgICAgICAgICB0aGlzLnRlbXBbaV0gPSAoKChidWZmZXJbaSAqIDRdICYgMHhmZikgPDwgMjQpIHwKICAgICAgICAgICAgICAgICAgKChidWZmZXJbKGkgKiA0KSArIDFdICYgMHhmZikgPDwgMTYpIHwKICAgICAgICAgICAgICAgICAgKChidWZmZXJbKGkgKiA0KSArIDJdICYgMHhmZikgPDwgOCkgfAogICAgICAgICAgICAgICAgICAoYnVmZmVyWyhpICogNCkgKyAzXSAmIDB4ZmYpKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHZhciB1ID0gdGhpcy50ZW1wW2kgLSAyXTsKICAgICAgICAgICAgICB2YXIgdDFfMSA9ICh1ID4+PiAxNyB8IHUgPDwgMTUpIF4KICAgICAgICAgICAgICAgICAgKHUgPj4+IDE5IHwgdSA8PCAxMykgXgogICAgICAgICAgICAgICAgICAodSA+Pj4gMTApOwogICAgICAgICAgICAgIHUgPSB0aGlzLnRlbXBbaSAtIDE1XTsKICAgICAgICAgICAgICB2YXIgdDJfMSA9ICh1ID4+PiA3IHwgdSA8PCAyNSkgXgogICAgICAgICAgICAgICAgICAodSA+Pj4gMTggfCB1IDw8IDE0KSBeCiAgICAgICAgICAgICAgICAgICh1ID4+PiAzKTsKICAgICAgICAgICAgICB0aGlzLnRlbXBbaV0gPSAodDFfMSArIHRoaXMudGVtcFtpIC0gN10gfCAwKSArCiAgICAgICAgICAgICAgICAgICh0Ml8xICsgdGhpcy50ZW1wW2kgLSAxNl0gfCAwKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0MSA9ICgoKCgoc3RhdGU0ID4+PiA2IHwgc3RhdGU0IDw8IDI2KSBeCiAgICAgICAgICAgICAgKHN0YXRlNCA+Pj4gMTEgfCBzdGF0ZTQgPDwgMjEpIF4KICAgICAgICAgICAgICAoc3RhdGU0ID4+PiAyNSB8IHN0YXRlNCA8PCA3KSkKICAgICAgICAgICAgICArICgoc3RhdGU0ICYgc3RhdGU1KSBeICh+c3RhdGU0ICYgc3RhdGU2KSkpIHwgMCkKICAgICAgICAgICAgICArICgoc3RhdGU3ICsgKChLRVlbaV0gKyB0aGlzLnRlbXBbaV0pIHwgMCkpIHwgMCkpIHwgMDsKICAgICAgICAgIHZhciB0MiA9ICgoKHN0YXRlMCA+Pj4gMiB8IHN0YXRlMCA8PCAzMCkgXgogICAgICAgICAgICAgIChzdGF0ZTAgPj4+IDEzIHwgc3RhdGUwIDw8IDE5KSBeCiAgICAgICAgICAgICAgKHN0YXRlMCA+Pj4gMjIgfCBzdGF0ZTAgPDwgMTApKSArICgoc3RhdGUwICYgc3RhdGUxKSBeIChzdGF0ZTAgJiBzdGF0ZTIpIF4gKHN0YXRlMSAmIHN0YXRlMikpKSB8IDA7CiAgICAgICAgICBzdGF0ZTcgPSBzdGF0ZTY7CiAgICAgICAgICBzdGF0ZTYgPSBzdGF0ZTU7CiAgICAgICAgICBzdGF0ZTUgPSBzdGF0ZTQ7CiAgICAgICAgICBzdGF0ZTQgPSAoc3RhdGUzICsgdDEpIHwgMDsKICAgICAgICAgIHN0YXRlMyA9IHN0YXRlMjsKICAgICAgICAgIHN0YXRlMiA9IHN0YXRlMTsKICAgICAgICAgIHN0YXRlMSA9IHN0YXRlMDsKICAgICAgICAgIHN0YXRlMCA9ICh0MSArIHQyKSB8IDA7CiAgICAgIH0KICAgICAgc3RhdGVbMF0gKz0gc3RhdGUwOwogICAgICBzdGF0ZVsxXSArPSBzdGF0ZTE7CiAgICAgIHN0YXRlWzJdICs9IHN0YXRlMjsKICAgICAgc3RhdGVbM10gKz0gc3RhdGUzOwogICAgICBzdGF0ZVs0XSArPSBzdGF0ZTQ7CiAgICAgIHN0YXRlWzVdICs9IHN0YXRlNTsKICAgICAgc3RhdGVbNl0gKz0gc3RhdGU2OwogICAgICBzdGF0ZVs3XSArPSBzdGF0ZTc7CiAgfTsKICAKICB9LHsiLi9icm93c2VySGFzaFV0aWxzIjoxMSwiYnVmZmVyLyI6ODB9XSwxNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChwcm9jZXNzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4vdXRpbCcpOwogIAogIC8vIGJyb3dzZXIgc3BlY2lmaWMgbW9kdWxlcwogIHV0aWwuY3J5cHRvLmxpYiA9IHJlcXVpcmUoJy4vYnJvd3NlckNyeXB0b0xpYicpOwogIHV0aWwuQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKICB1dGlsLnVybCA9IHJlcXVpcmUoJ3VybC8nKTsKICB1dGlsLnF1ZXJ5c3RyaW5nID0gcmVxdWlyZSgncXVlcnlzdHJpbmcvJyk7CiAgdXRpbC5yZWFsQ2xvY2sgPSByZXF1aXJlKCcuL3JlYWxjbG9jay9icm93c2VyQ2xvY2snKTsKICB1dGlsLmVudmlyb25tZW50ID0gJ2pzJzsKICB1dGlsLmNyZWF0ZUV2ZW50U3RyZWFtID0gcmVxdWlyZSgnLi9ldmVudC1zdHJlYW0vYnVmZmVyZWQtY3JlYXRlLWV2ZW50LXN0cmVhbScpLmNyZWF0ZUV2ZW50U3RyZWFtOwogIHV0aWwuaXNCcm93c2VyID0gZnVuY3Rpb24oKSB7IHJldHVybiB0cnVlOyB9OwogIHV0aWwuaXNOb2RlID0gZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZTsgfTsKICAKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1M7CiAgCiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscycpOwogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMvY3JlZGVudGlhbF9wcm92aWRlcl9jaGFpbicpOwogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMvdGVtcG9yYXJ5X2NyZWRlbnRpYWxzJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscy9jaGFpbmFibGVfdGVtcG9yYXJ5X2NyZWRlbnRpYWxzJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscy93ZWJfaWRlbnRpdHlfY3JlZGVudGlhbHMnKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzL2NvZ25pdG9faWRlbnRpdHlfY3JlZGVudGlhbHMnKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzL3NhbWxfY3JlZGVudGlhbHMnKTsKICAKICAvLyBMb2FkIHRoZSBET01QYXJzZXIgWE1MIHBhcnNlcgogIEFXUy5YTUwuUGFyc2VyID0gcmVxdWlyZSgnLi94bWwvYnJvd3Nlcl9wYXJzZXInKTsKICAKICAvLyBMb2FkIHRoZSBYSFIgSHR0cENsaWVudAogIHJlcXVpcmUoJy4vaHR0cC94aHInKTsKICAKICBpZiAodHlwZW9mIHByb2Nlc3MgPT09ICd1bmRlZmluZWQnKSB7CiAgICB2YXIgcHJvY2VzcyA9IHsKICAgICAgYnJvd3NlcjogdHJ1ZQogICAgfTsKICB9CiAgCiAgfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCiAgfSx7Ii4vYnJvd3NlckNyeXB0b0xpYiI6MTAsIi4vY29yZSI6MTgsIi4vY3JlZGVudGlhbHMiOjE5LCIuL2NyZWRlbnRpYWxzL2NoYWluYWJsZV90ZW1wb3JhcnlfY3JlZGVudGlhbHMiOjIwLCIuL2NyZWRlbnRpYWxzL2NvZ25pdG9faWRlbnRpdHlfY3JlZGVudGlhbHMiOjIxLCIuL2NyZWRlbnRpYWxzL2NyZWRlbnRpYWxfcHJvdmlkZXJfY2hhaW4iOjIyLCIuL2NyZWRlbnRpYWxzL3NhbWxfY3JlZGVudGlhbHMiOjIzLCIuL2NyZWRlbnRpYWxzL3RlbXBvcmFyeV9jcmVkZW50aWFscyI6MjQsIi4vY3JlZGVudGlhbHMvd2ViX2lkZW50aXR5X2NyZWRlbnRpYWxzIjoyNSwiLi9ldmVudC1zdHJlYW0vYnVmZmVyZWQtY3JlYXRlLWV2ZW50LXN0cmVhbSI6MjcsIi4vaHR0cC94aHIiOjM1LCIuL3JlYWxjbG9jay9icm93c2VyQ2xvY2siOjUyLCIuL3V0aWwiOjcxLCIuL3htbC9icm93c2VyX3BhcnNlciI6NzIsIl9wcm9jZXNzIjo4NSwiYnVmZmVyLyI6ODAsInF1ZXJ5c3RyaW5nLyI6OTIsInVybC8iOjk0fV0sMTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscy9jcmVkZW50aWFsX3Byb3ZpZGVyX2NoYWluJyk7CiAgdmFyIFByb21pc2VzRGVwZW5kZW5jeTsKICAKICAvKioKICAgKiBUaGUgbWFpbiBjb25maWd1cmF0aW9uIGNsYXNzIHVzZWQgYnkgYWxsIHNlcnZpY2Ugb2JqZWN0cyB0byBzZXQKICAgKiB0aGUgcmVnaW9uLCBjcmVkZW50aWFscywgYW5kIG90aGVyIG9wdGlvbnMgZm9yIHJlcXVlc3RzLgogICAqCiAgICogQnkgZGVmYXVsdCwgY3JlZGVudGlhbHMgYW5kIHJlZ2lvbiBzZXR0aW5ncyBhcmUgbGVmdCB1bmNvbmZpZ3VyZWQuCiAgICogVGhpcyBzaG91bGQgYmUgY29uZmlndXJlZCBieSB0aGUgYXBwbGljYXRpb24gYmVmb3JlIHVzaW5nIGFueQogICAqIEFXUyBzZXJ2aWNlIEFQSXMuCiAgICoKICAgKiBJbiBvcmRlciB0byBzZXQgZ2xvYmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9ucywgcHJvcGVydGllcyBzaG91bGQKICAgKiBiZSBhc3NpZ25lZCB0byB0aGUgZ2xvYmFsIHtBV1MuY29uZmlnfSBvYmplY3QuCiAgICoKICAgKiBAc2VlIEFXUy5jb25maWcKICAgKgogICAqIEAhZ3JvdXAgR2VuZXJhbCBDb25maWd1cmF0aW9uIE9wdGlvbnMKICAgKgogICAqIEAhYXR0cmlidXRlIGNyZWRlbnRpYWxzCiAgICogICBAcmV0dXJuIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBBV1MgY3JlZGVudGlhbHMgdG8gc2lnbiByZXF1ZXN0cyB3aXRoLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcmVnaW9uCiAgICogICBAZXhhbXBsZSBTZXQgdGhlIGdsb2JhbCByZWdpb24gc2V0dGluZyB0byB1cy13ZXN0LTIKICAgKiAgICAgQVdTLmNvbmZpZy51cGRhdGUoe3JlZ2lvbjogJ3VzLXdlc3QtMid9KTsKICAgKiAgIEByZXR1cm4gW0FXUy5DcmVkZW50aWFsc10gVGhlIHJlZ2lvbiB0byBzZW5kIHNlcnZpY2UgcmVxdWVzdHMgdG8uCiAgICogICBAc2VlIGh0dHA6Ly9kb2NzLmFtYXpvbndlYnNlcnZpY2VzLmNvbS9nZW5lcmFsL2xhdGVzdC9nci9yYW5kZS5odG1sCiAgICogICAgIEEgbGlzdCBvZiBhdmFpbGFibGUgZW5kcG9pbnRzIGZvciBlYWNoIEFXUyBzZXJ2aWNlCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBtYXhSZXRyaWVzCiAgICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbWF4aW11bSBhbW91bnQgb2YgcmV0cmllcyB0byBwZXJmb3JtIGZvciBhCiAgICogICAgIHNlcnZpY2UgcmVxdWVzdC4gQnkgZGVmYXVsdCB0aGlzIHZhbHVlIGlzIGNhbGN1bGF0ZWQgYnkgdGhlIHNwZWNpZmljCiAgICogICAgIHNlcnZpY2Ugb2JqZWN0IHRoYXQgdGhlIHJlcXVlc3QgaXMgYmVpbmcgbWFkZSB0by4KICAgKgogICAqIEAhYXR0cmlidXRlIG1heFJlZGlyZWN0cwogICAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIG1heGltdW0gYW1vdW50IG9mIHJlZGlyZWN0cyB0byBmb2xsb3cgZm9yIGEKICAgKiAgICAgc2VydmljZSByZXF1ZXN0LiBEZWZhdWx0cyB0byAxMC4KICAgKgogICAqIEAhYXR0cmlidXRlIHBhcmFtVmFsaWRhdGlvbgogICAqICAgQHJldHVybiBbQm9vbGVhbnxtYXBdIHdoZXRoZXIgaW5wdXQgcGFyYW1ldGVycyBzaG91bGQgYmUgdmFsaWRhdGVkIGFnYWluc3QKICAgKiAgICAgdGhlIG9wZXJhdGlvbiBkZXNjcmlwdGlvbiBiZWZvcmUgc2VuZGluZyB0aGUgcmVxdWVzdC4gRGVmYXVsdHMgdG8gdHJ1ZS4KICAgKiAgICAgUGFzcyBhIG1hcCB0byBlbmFibGUgYW55IG9mIHRoZSBmb2xsb3dpbmcgc3BlY2lmaWMgdmFsaWRhdGlvbiBmZWF0dXJlczoKICAgKgogICAqICAgICAqICoqbWluKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWluCiAgICogICAgICAgY29uc3RyYWludC4gVGhpcyBpcyBlbmFibGVkIGJ5IGRlZmF1bHQgd2hlbiBwYXJhbVZhbGlkYXRpb24gaXMgc2V0CiAgICogICAgICAgdG8gYHRydWVgLgogICAqICAgICAqICoqbWF4KiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWF4CiAgICogICAgICAgY29uc3RyYWludC4KICAgKiAgICAgKiAqKnBhdHRlcm4qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIGEKICAgKiAgICAgICByZWd1bGFyIGV4cHJlc3Npb24uCiAgICogICAgICogKiplbnVtKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBvbmUKICAgKiAgICAgICBvZiB0aGUgYWxsb3dhYmxlIGVudW0gdmFsdWVzLgogICAqCiAgICogQCFhdHRyaWJ1dGUgY29tcHV0ZUNoZWNrc3VtcwogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBjb21wdXRlIGNoZWNrc3VtcyBmb3IgcGF5bG9hZCBib2RpZXMgd2hlbgogICAqICAgICB0aGUgc2VydmljZSBhY2NlcHRzIGl0IChjdXJyZW50bHkgc3VwcG9ydGVkIGluIFMzIG9ubHkpLgogICAqCiAgICogQCFhdHRyaWJ1dGUgY29udmVydFJlc3BvbnNlVHlwZXMKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdHlwZXMgYXJlIGNvbnZlcnRlZCB3aGVuIHBhcnNpbmcgcmVzcG9uc2UgZGF0YS4KICAgKiAgICAgQ3VycmVudGx5IG9ubHkgc3VwcG9ydGVkIGZvciBKU09OIGJhc2VkIHNlcnZpY2VzLiBUdXJuaW5nIHRoaXMgb2ZmIG1heQogICAqICAgICBpbXByb3ZlIHBlcmZvcm1hbmNlIG9uIGxhcmdlIHJlc3BvbnNlIHBheWxvYWRzLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBjb3JyZWN0Q2xvY2tTa2V3CiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIGFwcGx5IGEgY2xvY2sgc2tldyBjb3JyZWN0aW9uIGFuZCByZXRyeQogICAqICAgICByZXF1ZXN0cyB0aGF0IGZhaWwgYmVjYXVzZSBvZiBhbiBza2V3ZWQgY2xpZW50IGNsb2NrLiBEZWZhdWx0cyB0bwogICAqICAgICBgZmFsc2VgLgogICAqCiAgICogQCFhdHRyaWJ1dGUgc3NsRW5hYmxlZAogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciBTU0wgaXMgZW5hYmxlZCBmb3IgcmVxdWVzdHMKICAgKgogICAqIEAhYXR0cmlidXRlIHMzRm9yY2VQYXRoU3R5bGUKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gZm9yY2UgcGF0aCBzdHlsZSBVUkxzIGZvciBTMyBvYmplY3RzCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzM0J1Y2tldEVuZHBvaW50CiAgICogICBAbm90ZSBTZXR0aW5nIHRoaXMgY29uZmlndXJhdGlvbiBvcHRpb24gcmVxdWlyZXMgYW4gYGVuZHBvaW50YCB0byBiZQogICAqICAgICBwcm92aWRlZCBleHBsaWNpdGx5IHRvIHRoZSBzZXJ2aWNlIGNvbnN0cnVjdG9yLgogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0aGUgcHJvdmlkZWQgZW5kcG9pbnQgYWRkcmVzc2VzIGFuIGluZGl2aWR1YWwKICAgKiAgICAgYnVja2V0IChmYWxzZSBpZiBpdCBhZGRyZXNzZXMgdGhlIHJvb3QgQVBJIGVuZHBvaW50KS4KICAgKgogICAqIEAhYXR0cmlidXRlIHMzRGlzYWJsZUJvZHlTaWduaW5nCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIGRpc2FibGUgUzMgYm9keSBzaWduaW5nIHdoZW4gdXNpbmcgc2lnbmF0dXJlIHZlcnNpb24gYHY0YC4KICAgKiAgICAgQm9keSBzaWduaW5nIGNhbiBvbmx5IGJlIGRpc2FibGVkIHdoZW4gdXNpbmcgaHR0cHMuIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgKgogICAqIEAhYXR0cmlidXRlIHVzZUFjY2VsZXJhdGVFbmRwb2ludAogICAqICAgQG5vdGUgVGhpcyBjb25maWd1cmF0aW9uIG9wdGlvbiBpcyBvbmx5IGNvbXBhdGlibGUgd2l0aCBTMyB3aGlsZSBhY2Nlc3NpbmcKICAgKiAgICAgZG5zLWNvbXBhdGlibGUgYnVja2V0cy4KICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIFdoZXRoZXIgdG8gdXNlIHRoZSBBY2NlbGVyYXRlIGVuZHBvaW50IHdpdGggdGhlIFMzIHNlcnZpY2UuCiAgICogICAgIERlZmF1bHRzIHRvIGBmYWxzZWAuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSByZXRyeURlbGF5T3B0aW9ucwogICAqICAgQGV4YW1wbGUgU2V0IHRoZSBiYXNlIHJldHJ5IGRlbGF5IGZvciBhbGwgc2VydmljZXMgdG8gMzAwIG1zCiAgICogICAgIEFXUy5jb25maWcudXBkYXRlKHtyZXRyeURlbGF5T3B0aW9uczoge2Jhc2U6IDMwMH19KTsKICAgKiAgICAgLy8gRGVsYXlzIHdpdGggbWF4UmV0cmllcyA9IDM6IDMwMCwgNjAwLCAxMjAwCiAgICogICBAZXhhbXBsZSBTZXQgYSBjdXN0b20gYmFja29mZiBmdW5jdGlvbiB0byBwcm92aWRlIGRlbGF5IHZhbHVlcyBvbiByZXRyaWVzCiAgICogICAgIEFXUy5jb25maWcudXBkYXRlKHtyZXRyeURlbGF5T3B0aW9uczoge2N1c3RvbUJhY2tvZmY6IGZ1bmN0aW9uKHJldHJ5Q291bnQpIHsKICAgKiAgICAgICAvLyByZXR1cm5zIGRlbGF5IGluIG1zCiAgICogICAgIH19fSk7CiAgICogICBAcmV0dXJuIFttYXBdIEEgc2V0IG9mIG9wdGlvbnMgdG8gY29uZmlndXJlIHRoZSByZXRyeSBkZWxheSBvbiByZXRyeWFibGUgZXJyb3JzLgogICAqICAgICBDdXJyZW50bHkgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogICAqCiAgICogICAgICogKipiYXNlKiogW0ludGVnZXJdICZtZGFzaDsgVGhlIGJhc2UgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB1c2UgaW4gdGhlCiAgICogICAgICAgZXhwb25lbnRpYWwgYmFja29mZiBmb3Igb3BlcmF0aW9uIHJldHJpZXMuIERlZmF1bHRzIHRvIDEwMCBtcyBmb3IgYWxsIHNlcnZpY2VzIGV4Y2VwdAogICAqICAgICAgIER5bmFtb0RCLCB3aGVyZSBpdCBkZWZhdWx0cyB0byA1MG1zLgogICAqICAgICAqICoqY3VzdG9tQmFja29mZiAqKiBbZnVuY3Rpb25dICZtZGFzaDsgQSBjdXN0b20gZnVuY3Rpb24gdGhhdCBhY2NlcHRzIGEgcmV0cnkgY291bnQKICAgKiAgICAgICBhbmQgcmV0dXJucyB0aGUgYW1vdW50IG9mIHRpbWUgdG8gZGVsYXkgaW4gbWlsbGlzZWNvbmRzLiBUaGUgYGJhc2VgIG9wdGlvbiB3aWxsIGJlCiAgICogICAgICAgaWdub3JlZCBpZiB0aGlzIG9wdGlvbiBpcyBzdXBwbGllZC4KICAgKgogICAqIEAhYXR0cmlidXRlIGh0dHBPcHRpb25zCiAgICogICBAcmV0dXJuIFttYXBdIEEgc2V0IG9mIG9wdGlvbnMgdG8gcGFzcyB0byB0aGUgbG93LWxldmVsIEhUVFAgcmVxdWVzdC4KICAgKiAgICAgQ3VycmVudGx5IHN1cHBvcnRlZCBvcHRpb25zIGFyZToKICAgKgogICAqICAgICAqICoqcHJveHkqKiBbU3RyaW5nXSAmbWRhc2g7IHRoZSBVUkwgdG8gcHJveHkgcmVxdWVzdHMgdGhyb3VnaAogICAqICAgICAqICoqYWdlbnQqKiBbaHR0cC5BZ2VudCwgaHR0cHMuQWdlbnRdICZtZGFzaDsgdGhlIEFnZW50IG9iamVjdCB0byBwZXJmb3JtCiAgICogICAgICAgSFRUUCByZXF1ZXN0cyB3aXRoLiBVc2VkIGZvciBjb25uZWN0aW9uIHBvb2xpbmcuIE5vdGUgdGhhdCBmb3IKICAgKiAgICAgICBTU0wgY29ubmVjdGlvbnMsIGEgc3BlY2lhbCBBZ2VudCBvYmplY3QgaXMgdXNlZCBpbiBvcmRlciB0byBlbmFibGUKICAgKiAgICAgICBwZWVyIGNlcnRpZmljYXRlIHZlcmlmaWNhdGlvbi4gVGhpcyBmZWF0dXJlIGlzIG9ubHkgc3VwcG9ydGVkIGluIHRoZQogICAqICAgICAgIE5vZGUuanMgZW52aXJvbm1lbnQuCiAgICogICAgICogKipjb25uZWN0VGltZW91dCoqIFtJbnRlZ2VyXSAmbWRhc2g7IFNldHMgdGhlIHNvY2tldCB0byB0aW1lb3V0IGFmdGVyCiAgICogICAgICAgZmFpbGluZyB0byBlc3RhYmxpc2ggYSBjb25uZWN0aW9uIHdpdGggdGhlIHNlcnZlciBhZnRlcgogICAqICAgICAgIGBjb25uZWN0VGltZW91dGAgbWlsbGlzZWNvbmRzLiBUaGlzIHRpbWVvdXQgaGFzIG5vIGVmZmVjdCBvbmNlIGEgc29ja2V0CiAgICogICAgICAgY29ubmVjdGlvbiBoYXMgYmVlbiBlc3RhYmxpc2hlZC4KICAgKiAgICAgKiAqKnRpbWVvdXQqKiBbSW50ZWdlcl0gJm1kYXNoOyBTZXRzIHRoZSBzb2NrZXQgdG8gdGltZW91dCBhZnRlciB0aW1lb3V0CiAgICogICAgICAgbWlsbGlzZWNvbmRzIG9mIGluYWN0aXZpdHkgb24gdGhlIHNvY2tldC4gRGVmYXVsdHMgdG8gdHdvIG1pbnV0ZXMKICAgKiAgICAgICAoMTIwMDAwKQogICAqICAgICAqICoqeGhyQXN5bmMqKiBbQm9vbGVhbl0gJm1kYXNoOyBXaGV0aGVyIHRoZSBTREsgd2lsbCBzZW5kIGFzeW5jaHJvbm91cwogICAqICAgICAgIEhUVFAgcmVxdWVzdHMuIFVzZWQgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQgb25seS4gU2V0IHRvIGZhbHNlIHRvCiAgICogICAgICAgc2VuZCByZXF1ZXN0cyBzeW5jaHJvbm91c2x5LiBEZWZhdWx0cyB0byB0cnVlIChhc3luYyBvbikuCiAgICogICAgICogKip4aHJXaXRoQ3JlZGVudGlhbHMqKiBbQm9vbGVhbl0gJm1kYXNoOyBTZXRzIHRoZSAid2l0aENyZWRlbnRpYWxzIgogICAqICAgICAgIHByb3BlcnR5IG9mIGFuIFhNTEh0dHBSZXF1ZXN0IG9iamVjdC4gVXNlZCBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudAogICAqICAgICAgIG9ubHkuIERlZmF1bHRzIHRvIGZhbHNlLgogICAqIEAhYXR0cmlidXRlIGxvZ2dlcgogICAqICAgQHJldHVybiBbI3dyaXRlLCNsb2ddIGFuIG9iamVjdCB0aGF0IHJlc3BvbmRzIHRvIC53cml0ZSgpIChsaWtlIGEgc3RyZWFtKQogICAqICAgICBvciAubG9nKCkgKGxpa2UgdGhlIGNvbnNvbGUgb2JqZWN0KSBpbiBvcmRlciB0byBsb2cgaW5mb3JtYXRpb24gYWJvdXQKICAgKiAgICAgcmVxdWVzdHMKICAgKgogICAqIEAhYXR0cmlidXRlIHN5c3RlbUNsb2NrT2Zmc2V0CiAgICogICBAcmV0dXJuIFtOdW1iZXJdIGFuIG9mZnNldCB2YWx1ZSBpbiBtaWxsaXNlY29uZHMgdG8gYXBwbHkgdG8gYWxsIHNpZ25pbmcKICAgKiAgICAgdGltZXMuIFVzZSB0aGlzIHRvIGNvbXBlbnNhdGUgZm9yIGNsb2NrIHNrZXcgd2hlbiB5b3VyIHN5c3RlbSBtYXkgYmUKICAgKiAgICAgb3V0IG9mIHN5bmMgd2l0aCB0aGUgc2VydmljZSB0aW1lLiBOb3RlIHRoYXQgdGhpcyBjb25maWd1cmF0aW9uIG9wdGlvbgogICAqICAgICBjYW4gb25seSBiZSBhcHBsaWVkIHRvIHRoZSBnbG9iYWwgYEFXUy5jb25maWdgIG9iamVjdCBhbmQgY2Fubm90IGJlCiAgICogICAgIG92ZXJyaWRkZW4gaW4gc2VydmljZS1zcGVjaWZpYyBjb25maWd1cmF0aW9uLiBEZWZhdWx0cyB0byAwIG1pbGxpc2Vjb25kcy4KICAgKgogICAqIEAhYXR0cmlidXRlIHNpZ25hdHVyZVZlcnNpb24KICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIHNpZ25hdHVyZSB2ZXJzaW9uIHRvIHNpZ24gcmVxdWVzdHMgd2l0aCAob3ZlcnJpZGluZwogICAqICAgICB0aGUgQVBJIGNvbmZpZ3VyYXRpb24pLiBQb3NzaWJsZSB2YWx1ZXMgYXJlOiAndjInLCAndjMnLCAndjQnLgogICAqCiAgICogQCFhdHRyaWJ1dGUgc2lnbmF0dXJlQ2FjaGUKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIHNpZ25hdHVyZSB0byBzaWduIHJlcXVlc3RzIHdpdGggKG92ZXJyaWRpbmcKICAgKiAgICAgdGhlIEFQSSBjb25maWd1cmF0aW9uKSBpcyBjYWNoZWQuIE9ubHkgYXBwbGllcyB0byB0aGUgc2lnbmF0dXJlIHZlcnNpb24gJ3Y0Jy4KICAgKiAgICAgRGVmYXVsdHMgdG8gYHRydWVgLgogICAqCiAgICogQCFhdHRyaWJ1dGUgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIGVuYWJsZSBlbmRwb2ludCBkaXNjb3ZlcnkgZm9yIG9wZXJhdGlvbnMgdGhhdAogICAqICAgICBhbGxvdyBvcHRpb25hbGx5IHVzaW5nIGFuIGVuZHBvaW50IHJldHVybmVkIGJ5IHRoZSBzZXJ2aWNlLgogICAqICAgICBEZWZhdWx0cyB0byAnZmFsc2UnCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBlbmRwb2ludENhY2hlU2l6ZQogICAqICAgQHJldHVybiBbTnVtYmVyXSB0aGUgc2l6ZSBvZiB0aGUgZ2xvYmFsIGNhY2hlIHN0b3JpbmcgZW5kcG9pbnRzIGZyb20gZW5kcG9pbnQKICAgKiAgICAgZGlzY292ZXJ5IG9wZXJhdGlvbnMuIE9uY2UgZW5kcG9pbnQgY2FjaGUgaXMgY3JlYXRlZCwgdXBkYXRpbmcgdGhpcyBzZXR0aW5nCiAgICogICAgIGNhbm5vdCBjaGFuZ2UgZXhpc3RpbmcgY2FjaGUgc2l6ZS4KICAgKiAgICAgRGVmYXVsdHMgdG8gMTAwMAogICAqCiAgICogQCFhdHRyaWJ1dGUgaG9zdFByZWZpeEVuYWJsZWQKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gbWFyc2hhbCByZXF1ZXN0IHBhcmFtZXRlcnMgdG8gdGhlIHByZWZpeCBvZgogICAqICAgICBob3N0bmFtZS4gRGVmYXVsdHMgdG8gYHRydWVgLgogICAqCiAgICogQCFhdHRyaWJ1dGUgc3RzUmVnaW9uYWxFbmRwb2ludHMKICAgKiAgIEByZXR1cm4gWydsZWdhY3knfCdyZWdpb25hbCddIHdoZXRoZXIgdG8gc2VuZCBzdHMgcmVxdWVzdCB0byBnbG9iYWwgZW5kcG9pbnRzIG9yCiAgICogICAgIHJlZ2lvbmFsIGVuZHBvaW50cy4KICAgKiAgICAgRGVmYXVsdHMgdG8gJ2xlZ2FjeScKICAgKi8KICBBV1MuQ29uZmlnID0gQVdTLnV0aWwuaW5oZXJpdCh7CiAgICAvKioKICAgICAqIEAhZW5kZ3JvdXAKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IGNvbmZpZ3VyYXRpb24gb2JqZWN0LiBUaGlzIGlzIHRoZSBvYmplY3QgdGhhdCBwYXNzZXMKICAgICAqIG9wdGlvbiBkYXRhIGFsb25nIHRvIHNlcnZpY2UgcmVxdWVzdHMsIGluY2x1ZGluZyBjcmVkZW50aWFscywgc2VjdXJpdHksCiAgICAgKiByZWdpb24gaW5mb3JtYXRpb24sIGFuZCBzb21lIHNlcnZpY2Ugc3BlY2lmaWMgc2V0dGluZ3MuCiAgICAgKgogICAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY29uZmlndXJhdGlvbiBvYmplY3Qgd2l0aCBjcmVkZW50aWFscyBhbmQgcmVnaW9uCiAgICAgKiAgIHZhciBjb25maWcgPSBuZXcgQVdTLkNvbmZpZyh7CiAgICAgKiAgICAgYWNjZXNzS2V5SWQ6ICdBS0lEJywgc2VjcmV0QWNjZXNzS2V5OiAnU0VDUkVUJywgcmVnaW9uOiAndXMtd2VzdC0yJwogICAgICogICB9KTsKICAgICAqIEBvcHRpb24gb3B0aW9ucyBhY2Nlc3NLZXlJZCBbU3RyaW5nXSB5b3VyIEFXUyBhY2Nlc3Mga2V5IElELgogICAgICogQG9wdGlvbiBvcHRpb25zIHNlY3JldEFjY2Vzc0tleSBbU3RyaW5nXSB5b3VyIEFXUyBzZWNyZXQgYWNjZXNzIGtleS4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzZXNzaW9uVG9rZW4gW0FXUy5DcmVkZW50aWFsc10gdGhlIG9wdGlvbmFsIEFXUwogICAgICogICBzZXNzaW9uIHRva2VuIHRvIHNpZ24gcmVxdWVzdHMgd2l0aC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBjcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgQVdTIGNyZWRlbnRpYWxzCiAgICAgKiAgIHRvIHNpZ24gcmVxdWVzdHMgd2l0aC4gWW91IGNhbiBlaXRoZXIgc3BlY2lmeSB0aGlzIG9iamVjdCwgb3IKICAgICAqICAgc3BlY2lmeSB0aGUgYWNjZXNzS2V5SWQgYW5kIHNlY3JldEFjY2Vzc0tleSBvcHRpb25zIGRpcmVjdGx5LgogICAgICogQG9wdGlvbiBvcHRpb25zIGNyZWRlbnRpYWxQcm92aWRlciBbQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluXSB0aGUKICAgICAqICAgcHJvdmlkZXIgY2hhaW4gdXNlZCB0byByZXNvbHZlIGNyZWRlbnRpYWxzIGlmIG5vIHN0YXRpYyBgY3JlZGVudGlhbHNgCiAgICAgKiAgIHByb3BlcnR5IGlzIHNldC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyByZWdpb24gW1N0cmluZ10gdGhlIHJlZ2lvbiB0byBzZW5kIHNlcnZpY2UgcmVxdWVzdHMgdG8uCiAgICAgKiAgIFNlZSB7cmVnaW9ufSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBtYXhSZXRyaWVzIFtJbnRlZ2VyXSB0aGUgbWF4aW11bSBhbW91bnQgb2YgcmV0cmllcyB0bwogICAgICogICBhdHRlbXB0IHdpdGggYSByZXF1ZXN0LiBTZWUge21heFJldHJpZXN9IGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICogQG9wdGlvbiBvcHRpb25zIG1heFJlZGlyZWN0cyBbSW50ZWdlcl0gdGhlIG1heGltdW0gYW1vdW50IG9mIHJlZGlyZWN0cyB0bwogICAgICogICBmb2xsb3cgd2l0aCBhIHJlcXVlc3QuIFNlZSB7bWF4UmVkaXJlY3RzfSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzc2xFbmFibGVkIFtCb29sZWFuXSB3aGV0aGVyIHRvIGVuYWJsZSBTU0wgZm9yCiAgICAgKiAgIHJlcXVlc3RzLgogICAgICogQG9wdGlvbiBvcHRpb25zIHBhcmFtVmFsaWRhdGlvbiBbQm9vbGVhbnxtYXBdIHdoZXRoZXIgaW5wdXQgcGFyYW1ldGVycwogICAgICogICBzaG91bGQgYmUgdmFsaWRhdGVkIGFnYWluc3QgdGhlIG9wZXJhdGlvbiBkZXNjcmlwdGlvbiBiZWZvcmUgc2VuZGluZwogICAgICogICB0aGUgcmVxdWVzdC4gRGVmYXVsdHMgdG8gdHJ1ZS4gUGFzcyBhIG1hcCB0byBlbmFibGUgYW55IG9mIHRoZQogICAgICogICBmb2xsb3dpbmcgc3BlY2lmaWMgdmFsaWRhdGlvbiBmZWF0dXJlczoKICAgICAqCiAgICAgKiAgICogKiptaW4qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHZhbHVlIG1lZXRzIHRoZSBtaW4KICAgICAqICAgICBjb25zdHJhaW50LiBUaGlzIGlzIGVuYWJsZWQgYnkgZGVmYXVsdCB3aGVuIHBhcmFtVmFsaWRhdGlvbiBpcyBzZXQKICAgICAqICAgICB0byBgdHJ1ZWAuCiAgICAgKiAgICogKiptYXgqKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHZhbHVlIG1lZXRzIHRoZSBtYXgKICAgICAqICAgICBjb25zdHJhaW50LgogICAgICogICAqICoqcGF0dGVybioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgYQogICAgICogICAgIHJlZ3VsYXIgZXhwcmVzc2lvbi4KICAgICAqICAgKiAqKmVudW0qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIG9uZQogICAgICogICAgIG9mIHRoZSBhbGxvd2FibGUgZW51bSB2YWx1ZXMuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgY29tcHV0ZUNoZWNrc3VtcyBbQm9vbGVhbl0gd2hldGhlciB0byBjb21wdXRlIGNoZWNrc3VtcwogICAgICogICBmb3IgcGF5bG9hZCBib2RpZXMgd2hlbiB0aGUgc2VydmljZSBhY2NlcHRzIGl0IChjdXJyZW50bHkgc3VwcG9ydGVkCiAgICAgKiAgIGluIFMzIG9ubHkpCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgY29udmVydFJlc3BvbnNlVHlwZXMgW0Jvb2xlYW5dIHdoZXRoZXIgdHlwZXMgYXJlIGNvbnZlcnRlZAogICAgICogICAgIHdoZW4gcGFyc2luZyByZXNwb25zZSBkYXRhLiBDdXJyZW50bHkgb25seSBzdXBwb3J0ZWQgZm9yIEpTT04gYmFzZWQKICAgICAqICAgICBzZXJ2aWNlcy4gVHVybmluZyB0aGlzIG9mZiBtYXkgaW1wcm92ZSBwZXJmb3JtYW5jZSBvbiBsYXJnZSByZXNwb25zZQogICAgICogICAgIHBheWxvYWRzLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgY29ycmVjdENsb2NrU2tldyBbQm9vbGVhbl0gd2hldGhlciB0byBhcHBseSBhIGNsb2NrIHNrZXcKICAgICAqICAgICBjb3JyZWN0aW9uIGFuZCByZXRyeSByZXF1ZXN0cyB0aGF0IGZhaWwgYmVjYXVzZSBvZiBhbiBza2V3ZWQgY2xpZW50CiAgICAgKiAgICAgY2xvY2suIERlZmF1bHRzIHRvIGBmYWxzZWAuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgczNGb3JjZVBhdGhTdHlsZSBbQm9vbGVhbl0gd2hldGhlciB0byBmb3JjZSBwYXRoCiAgICAgKiAgIHN0eWxlIFVSTHMgZm9yIFMzIG9iamVjdHMuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgczNCdWNrZXRFbmRwb2ludCBbQm9vbGVhbl0gd2hldGhlciB0aGUgcHJvdmlkZWQgZW5kcG9pbnQKICAgICAqICAgYWRkcmVzc2VzIGFuIGluZGl2aWR1YWwgYnVja2V0IChmYWxzZSBpZiBpdCBhZGRyZXNzZXMgdGhlIHJvb3QgQVBJCiAgICAgKiAgIGVuZHBvaW50KS4gTm90ZSB0aGF0IHNldHRpbmcgdGhpcyBjb25maWd1cmF0aW9uIG9wdGlvbiByZXF1aXJlcyBhbgogICAgICogICBgZW5kcG9pbnRgIHRvIGJlIHByb3ZpZGVkIGV4cGxpY2l0bHkgdG8gdGhlIHNlcnZpY2UgY29uc3RydWN0b3IuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgczNEaXNhYmxlQm9keVNpZ25pbmcgW0Jvb2xlYW5dIHdoZXRoZXIgUzMgYm9keSBzaWduaW5nCiAgICAgKiAgIHNob3VsZCBiZSBkaXNhYmxlZCB3aGVuIHVzaW5nIHNpZ25hdHVyZSB2ZXJzaW9uIGB2NGAuIEJvZHkgc2lnbmluZwogICAgICogICBjYW4gb25seSBiZSBkaXNhYmxlZCB3aGVuIHVzaW5nIGh0dHBzLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICAgKgogICAgICogQG9wdGlvbiBvcHRpb25zIHJldHJ5RGVsYXlPcHRpb25zIFttYXBdIEEgc2V0IG9mIG9wdGlvbnMgdG8gY29uZmlndXJlCiAgICAgKiAgIHRoZSByZXRyeSBkZWxheSBvbiByZXRyeWFibGUgZXJyb3JzLiBDdXJyZW50bHkgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogICAgICoKICAgICAqICAgKiAqKmJhc2UqKiBbSW50ZWdlcl0gJm1kYXNoOyBUaGUgYmFzZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHVzZSBpbiB0aGUKICAgICAqICAgICBleHBvbmVudGlhbCBiYWNrb2ZmIGZvciBvcGVyYXRpb24gcmV0cmllcy4gRGVmYXVsdHMgdG8gMTAwIG1zIGZvciBhbGwKICAgICAqICAgICBzZXJ2aWNlcyBleGNlcHQgRHluYW1vREIsIHdoZXJlIGl0IGRlZmF1bHRzIHRvIDUwbXMuCiAgICAgKiAgICogKipjdXN0b21CYWNrb2ZmICoqIFtmdW5jdGlvbl0gJm1kYXNoOyBBIGN1c3RvbSBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgYSByZXRyeSBjb3VudAogICAgICogICAgIGFuZCByZXR1cm5zIHRoZSBhbW91bnQgb2YgdGltZSB0byBkZWxheSBpbiBtaWxsaXNlY29uZHMuIFRoZSBgYmFzZWAgb3B0aW9uIHdpbGwgYmUKICAgICAqICAgICBpZ25vcmVkIGlmIHRoaXMgb3B0aW9uIGlzIHN1cHBsaWVkLgogICAgICogQG9wdGlvbiBvcHRpb25zIGh0dHBPcHRpb25zIFttYXBdIEEgc2V0IG9mIG9wdGlvbnMgdG8gcGFzcyB0byB0aGUgbG93LWxldmVsCiAgICAgKiAgIEhUVFAgcmVxdWVzdC4gQ3VycmVudGx5IHN1cHBvcnRlZCBvcHRpb25zIGFyZToKICAgICAqCiAgICAgKiAgICogKipwcm94eSoqIFtTdHJpbmddICZtZGFzaDsgdGhlIFVSTCB0byBwcm94eSByZXF1ZXN0cyB0aHJvdWdoCiAgICAgKiAgICogKiphZ2VudCoqIFtodHRwLkFnZW50LCBodHRwcy5BZ2VudF0gJm1kYXNoOyB0aGUgQWdlbnQgb2JqZWN0IHRvIHBlcmZvcm0KICAgICAqICAgICBIVFRQIHJlcXVlc3RzIHdpdGguIFVzZWQgZm9yIGNvbm5lY3Rpb24gcG9vbGluZy4gRGVmYXVsdHMgdG8gdGhlIGdsb2JhbAogICAgICogICAgIGFnZW50IChgaHR0cC5nbG9iYWxBZ2VudGApIGZvciBub24tU1NMIGNvbm5lY3Rpb25zLiBOb3RlIHRoYXQgZm9yCiAgICAgKiAgICAgU1NMIGNvbm5lY3Rpb25zLCBhIHNwZWNpYWwgQWdlbnQgb2JqZWN0IGlzIHVzZWQgaW4gb3JkZXIgdG8gZW5hYmxlCiAgICAgKiAgICAgcGVlciBjZXJ0aWZpY2F0ZSB2ZXJpZmljYXRpb24uIFRoaXMgZmVhdHVyZSBpcyBvbmx5IGF2YWlsYWJsZSBpbiB0aGUKICAgICAqICAgICBOb2RlLmpzIGVudmlyb25tZW50LgogICAgICogICAqICoqY29ubmVjdFRpbWVvdXQqKiBbSW50ZWdlcl0gJm1kYXNoOyBTZXRzIHRoZSBzb2NrZXQgdG8gdGltZW91dCBhZnRlcgogICAgICogICAgIGZhaWxpbmcgdG8gZXN0YWJsaXNoIGEgY29ubmVjdGlvbiB3aXRoIHRoZSBzZXJ2ZXIgYWZ0ZXIKICAgICAqICAgICBgY29ubmVjdFRpbWVvdXRgIG1pbGxpc2Vjb25kcy4gVGhpcyB0aW1lb3V0IGhhcyBubyBlZmZlY3Qgb25jZSBhIHNvY2tldAogICAgICogICAgIGNvbm5lY3Rpb24gaGFzIGJlZW4gZXN0YWJsaXNoZWQuCiAgICAgKiAgICogKip0aW1lb3V0KiogW0ludGVnZXJdICZtZGFzaDsgU2V0cyB0aGUgc29ja2V0IHRvIHRpbWVvdXQgYWZ0ZXIgdGltZW91dAogICAgICogICAgIG1pbGxpc2Vjb25kcyBvZiBpbmFjdGl2aXR5IG9uIHRoZSBzb2NrZXQuIERlZmF1bHRzIHRvIHR3byBtaW51dGVzCiAgICAgKiAgICAgKDEyMDAwMCkuCiAgICAgKiAgICogKip4aHJBc3luYyoqIFtCb29sZWFuXSAmbWRhc2g7IFdoZXRoZXIgdGhlIFNESyB3aWxsIHNlbmQgYXN5bmNocm9ub3VzCiAgICAgKiAgICAgSFRUUCByZXF1ZXN0cy4gVXNlZCBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudCBvbmx5LiBTZXQgdG8gZmFsc2UgdG8KICAgICAqICAgICBzZW5kIHJlcXVlc3RzIHN5bmNocm9ub3VzbHkuIERlZmF1bHRzIHRvIHRydWUgKGFzeW5jIG9uKS4KICAgICAqICAgKiAqKnhocldpdGhDcmVkZW50aWFscyoqIFtCb29sZWFuXSAmbWRhc2g7IFNldHMgdGhlICJ3aXRoQ3JlZGVudGlhbHMiCiAgICAgKiAgICAgcHJvcGVydHkgb2YgYW4gWE1MSHR0cFJlcXVlc3Qgb2JqZWN0LiBVc2VkIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50CiAgICAgKiAgICAgb25seS4gRGVmYXVsdHMgdG8gZmFsc2UuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgYXBpVmVyc2lvbiBbU3RyaW5nLCBEYXRlXSBhIFN0cmluZyBpbiBZWVlZLU1NLUREIGZvcm1hdAogICAgICogICAob3IgYSBkYXRlKSB0aGF0IHJlcHJlc2VudHMgdGhlIGxhdGVzdCBwb3NzaWJsZSBBUEkgdmVyc2lvbiB0aGF0IGNhbiBiZQogICAgICogICB1c2VkIGluIGFsbCBzZXJ2aWNlcyAodW5sZXNzIG92ZXJyaWRkZW4gYnkgYGFwaVZlcnNpb25zYCkuIFNwZWNpZnkKICAgICAqICAgJ2xhdGVzdCcgdG8gdXNlIHRoZSBsYXRlc3QgcG9zc2libGUgdmVyc2lvbi4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBhcGlWZXJzaW9ucyBbbWFwPFN0cmluZywgU3RyaW5nfERhdGU+XSBhIG1hcCBvZiBzZXJ2aWNlCiAgICAgKiAgIGlkZW50aWZpZXJzICh0aGUgbG93ZXJjYXNlIHNlcnZpY2UgY2xhc3MgbmFtZSkgd2l0aCB0aGUgQVBJIHZlcnNpb24gdG8KICAgICAqICAgdXNlIHdoZW4gaW5zdGFudGlhdGluZyBhIHNlcnZpY2UuIFNwZWNpZnkgJ2xhdGVzdCcgZm9yIGVhY2ggaW5kaXZpZHVhbAogICAgICogICB0aGF0IGNhbiB1c2UgdGhlIGxhdGVzdCBhdmFpbGFibGUgdmVyc2lvbi4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBsb2dnZXIgWyN3cml0ZSwjbG9nXSBhbiBvYmplY3QgdGhhdCByZXNwb25kcyB0byAud3JpdGUoKQogICAgICogICAobGlrZSBhIHN0cmVhbSkgb3IgLmxvZygpIChsaWtlIHRoZSBjb25zb2xlIG9iamVjdCkgaW4gb3JkZXIgdG8gbG9nCiAgICAgKiAgIGluZm9ybWF0aW9uIGFib3V0IHJlcXVlc3RzCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgc3lzdGVtQ2xvY2tPZmZzZXQgW051bWJlcl0gYW4gb2Zmc2V0IHZhbHVlIGluIG1pbGxpc2Vjb25kcwogICAgICogICB0byBhcHBseSB0byBhbGwgc2lnbmluZyB0aW1lcy4gVXNlIHRoaXMgdG8gY29tcGVuc2F0ZSBmb3IgY2xvY2sgc2tldwogICAgICogICB3aGVuIHlvdXIgc3lzdGVtIG1heSBiZSBvdXQgb2Ygc3luYyB3aXRoIHRoZSBzZXJ2aWNlIHRpbWUuIE5vdGUgdGhhdAogICAgICogICB0aGlzIGNvbmZpZ3VyYXRpb24gb3B0aW9uIGNhbiBvbmx5IGJlIGFwcGxpZWQgdG8gdGhlIGdsb2JhbCBgQVdTLmNvbmZpZ2AKICAgICAqICAgb2JqZWN0IGFuZCBjYW5ub3QgYmUgb3ZlcnJpZGRlbiBpbiBzZXJ2aWNlLXNwZWNpZmljIGNvbmZpZ3VyYXRpb24uCiAgICAgKiAgIERlZmF1bHRzIHRvIDAgbWlsbGlzZWNvbmRzLgogICAgICogQG9wdGlvbiBvcHRpb25zIHNpZ25hdHVyZVZlcnNpb24gW1N0cmluZ10gdGhlIHNpZ25hdHVyZSB2ZXJzaW9uIHRvIHNpZ24KICAgICAqICAgcmVxdWVzdHMgd2l0aCAob3ZlcnJpZGluZyB0aGUgQVBJIGNvbmZpZ3VyYXRpb24pLiBQb3NzaWJsZSB2YWx1ZXMgYXJlOgogICAgICogICAndjInLCAndjMnLCAndjQnLgogICAgICogQG9wdGlvbiBvcHRpb25zIHNpZ25hdHVyZUNhY2hlIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBzaWduYXR1cmUgdG8gc2lnbgogICAgICogICByZXF1ZXN0cyB3aXRoIChvdmVycmlkaW5nIHRoZSBBUEkgY29uZmlndXJhdGlvbikgaXMgY2FjaGVkLiBPbmx5IGFwcGxpZXMKICAgICAqICAgdG8gdGhlIHNpZ25hdHVyZSB2ZXJzaW9uICd2NCcuIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBkeW5hbW9EYkNyYzMyIFtCb29sZWFuXSB3aGV0aGVyIHRvIHZhbGlkYXRlIHRoZSBDUkMzMgogICAgICogICBjaGVja3N1bSBvZiBIVFRQIHJlc3BvbnNlIGJvZGllcyByZXR1cm5lZCBieSBEeW5hbW9EQi4gRGVmYXVsdDogYHRydWVgLgogICAgICogQG9wdGlvbiBvcHRpb25zIHVzZUFjY2VsZXJhdGVFbmRwb2ludCBbQm9vbGVhbl0gV2hldGhlciB0byB1c2UgdGhlCiAgICAgKiAgIFMzIFRyYW5zZmVyIEFjY2VsZXJhdGlvbiBlbmRwb2ludCB3aXRoIHRoZSBTMyBzZXJ2aWNlLiBEZWZhdWx0OiBgZmFsc2VgLgogICAgICogQG9wdGlvbiBvcHRpb25zIGNsaWVudFNpZGVNb25pdG9yaW5nIFtCb29sZWFuXSB3aGV0aGVyIHRvIGNvbGxlY3QgYW5kCiAgICAgKiAgIHB1Ymxpc2ggdGhpcyBjbGllbnQncyBwZXJmb3JtYW5jZSBtZXRyaWNzIG9mIGFsbCBpdHMgQVBJIHJlcXVlc3RzLgogICAgICogQG9wdGlvbiBvcHRpb25zIGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZCBbQm9vbGVhbl0gd2hldGhlciB0byBlbmFibGUgZW5kcG9pbnQKICAgICAqICAgZGlzY292ZXJ5IGZvciBvcGVyYXRpb25zIHRoYXQgYWxsb3cgb3B0aW9uYWxseSB1c2luZyBhbiBlbmRwb2ludCByZXR1cm5lZCBieQogICAgICogICB0aGUgc2VydmljZS4KICAgICAqICAgRGVmYXVsdHMgdG8gJ2ZhbHNlJwogICAgICogQG9wdGlvbiBvcHRpb25zIGVuZHBvaW50Q2FjaGVTaXplIFtOdW1iZXJdIHRoZSBzaXplIG9mIHRoZSBnbG9iYWwgY2FjaGUgc3RvcmluZwogICAgICogICBlbmRwb2ludHMgZnJvbSBlbmRwb2ludCBkaXNjb3Zlcnkgb3BlcmF0aW9ucy4gT25jZSBlbmRwb2ludCBjYWNoZSBpcyBjcmVhdGVkLAogICAgICogICB1cGRhdGluZyB0aGlzIHNldHRpbmcgY2Fubm90IGNoYW5nZSBleGlzdGluZyBjYWNoZSBzaXplLgogICAgICogICBEZWZhdWx0cyB0byAxMDAwCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgaG9zdFByZWZpeEVuYWJsZWQgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gbWFyc2hhbCByZXF1ZXN0CiAgICAgKiAgIHBhcmFtZXRlcnMgdG8gdGhlIHByZWZpeCBvZiBob3N0bmFtZS4KICAgICAqICAgRGVmYXVsdHMgdG8gYHRydWVgLgogICAgICogQG9wdGlvbiBvcHRpb25zIHN0c1JlZ2lvbmFsRW5kcG9pbnRzIFsnbGVnYWN5J3wncmVnaW9uYWwnXSB3aGV0aGVyIHRvIHNlbmQgc3RzIHJlcXVlc3QKICAgICAqICAgdG8gZ2xvYmFsIGVuZHBvaW50cyBvciByZWdpb25hbCBlbmRwb2ludHMuCiAgICAgKiAgIERlZmF1bHRzIHRvICdsZWdhY3knLgogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gQ29uZmlnKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHVuZGVmaW5lZCkgb3B0aW9ucyA9IHt9OwogICAgICBvcHRpb25zID0gdGhpcy5leHRyYWN0Q3JlZGVudGlhbHMob3B0aW9ucyk7CiAgCiAgICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLmtleXMsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgdGhpcy5zZXQoa2V5LCBvcHRpb25zW2tleV0sIHZhbHVlKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAIWdyb3VwIE1hbmFnaW5nIENyZWRlbnRpYWxzCiAgICAgKi8KICAKICAgIC8qKgogICAgICogTG9hZHMgY3JlZGVudGlhbHMgZnJvbSB0aGUgY29uZmlndXJhdGlvbiBvYmplY3QuIFRoaXMgaXMgdXNlZCBpbnRlcm5hbGx5CiAgICAgKiBieSB0aGUgU0RLIHRvIGVuc3VyZSB0aGF0IHJlZnJlc2hhYmxlIHtDcmVkZW50aWFsc30gb2JqZWN0cyBhcmUgcHJvcGVybHkKICAgICAqIHJlZnJlc2hlZCBhbmQgbG9hZGVkIHdoZW4gc2VuZGluZyBhIHJlcXVlc3QuIElmIHlvdSB3YW50IHRvIGVuc3VyZSB0aGF0CiAgICAgKiB5b3VyIGNyZWRlbnRpYWxzIGFyZSBsb2FkZWQgcHJpb3IgdG8gYSByZXF1ZXN0LCB5b3UgY2FuIHVzZSB0aGlzIG1ldGhvZAogICAgICogZGlyZWN0bHkgdG8gcHJvdmlkZSBhY2N1cmF0ZSBjcmVkZW50aWFsIGRhdGEgc3RvcmVkIGluIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogQG5vdGUgSWYgeW91IGNvbmZpZ3VyZSB0aGUgU0RLIHdpdGggc3RhdGljIG9yIGVudmlyb25tZW50IGNyZWRlbnRpYWxzLAogICAgICogICB0aGUgY3JlZGVudGlhbCBkYXRhIHNob3VsZCBhbHJlYWR5IGJlIHByZXNlbnQgaW4ge2NyZWRlbnRpYWxzfSBhdHRyaWJ1dGUuCiAgICAgKiAgIFRoaXMgbWV0aG9kIGlzIHByaW1hcmlseSBuZWNlc3NhcnkgdG8gbG9hZCBjcmVkZW50aWFscyBmcm9tIGFzeW5jaHJvbm91cwogICAgICogICBzb3VyY2VzLCBvciBzb3VyY2VzIHRoYXQgY2FuIHJlZnJlc2ggY3JlZGVudGlhbHMgcGVyaW9kaWNhbGx5LgogICAgICogQGV4YW1wbGUgR2V0dGluZyB5b3VyIGFjY2VzcyBrZXkKICAgICAqICAgQVdTLmNvbmZpZy5nZXRDcmVkZW50aWFscyhmdW5jdGlvbihlcnIpIHsKICAgICAqICAgICBpZiAoZXJyKSBjb25zb2xlLmxvZyhlcnIuc3RhY2spOyAvLyBjcmVkZW50aWFscyBub3QgbG9hZGVkCiAgICAgKiAgICAgZWxzZSBjb25zb2xlLmxvZygiQWNjZXNzIEtleToiLCBBV1MuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkKTsKICAgICAqICAgfSkKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIENhbGxlZCB3aGVuIHRoZSB7Y3JlZGVudGlhbHN9IGhhdmUgYmVlbiBwcm9wZXJseSBzZXQgb24gdGhlIGNvbmZpZ3VyYXRpb24KICAgICAqICAgb2JqZWN0LgogICAgICoKICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIHRoaXMgaXMgc2V0LCBjcmVkZW50aWFscyB3ZXJlIG5vdCBzdWNjZXNzZnVsbHkKICAgICAqICAgICBsb2FkZWQgYW5kIHRoaXMgZXJyb3IgcHJvdmlkZXMgaW5mb3JtYXRpb24gd2h5LgogICAgICogQHNlZSBjcmVkZW50aWFscwogICAgICogQHNlZSBDcmVkZW50aWFscwogICAgICovCiAgICBnZXRDcmVkZW50aWFsczogZnVuY3Rpb24gZ2V0Q3JlZGVudGlhbHMoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogIAogICAgICBmdW5jdGlvbiBmaW5pc2goZXJyKSB7CiAgICAgICAgY2FsbGJhY2soZXJyLCBlcnIgPyBudWxsIDogc2VsZi5jcmVkZW50aWFscyk7CiAgICAgIH0KICAKICAgICAgZnVuY3Rpb24gY3JlZEVycm9yKG1zZywgZXJyKSB7CiAgICAgICAgcmV0dXJuIG5ldyBBV1MudXRpbC5lcnJvcihlcnIgfHwgbmV3IEVycm9yKCksIHsKICAgICAgICAgIGNvZGU6ICdDcmVkZW50aWFsc0Vycm9yJywKICAgICAgICAgIG1lc3NhZ2U6IG1zZywKICAgICAgICAgIG5hbWU6ICdDcmVkZW50aWFsc0Vycm9yJwogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIGZ1bmN0aW9uIGdldEFzeW5jQ3JlZGVudGlhbHMoKSB7CiAgICAgICAgc2VsZi5jcmVkZW50aWFscy5nZXQoZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIHZhciBtc2cgPSAnQ291bGQgbm90IGxvYWQgY3JlZGVudGlhbHMgZnJvbSAnICsKICAgICAgICAgICAgICBzZWxmLmNyZWRlbnRpYWxzLmNvbnN0cnVjdG9yLm5hbWU7CiAgICAgICAgICAgIGVyciA9IGNyZWRFcnJvcihtc2csIGVycik7CiAgICAgICAgICB9CiAgICAgICAgICBmaW5pc2goZXJyKTsKICAgICAgICB9KTsKICAgICAgfQogIAogICAgICBmdW5jdGlvbiBnZXRTdGF0aWNDcmVkZW50aWFscygpIHsKICAgICAgICB2YXIgZXJyID0gbnVsbDsKICAgICAgICBpZiAoIXNlbGYuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgfHwgIXNlbGYuY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5KSB7CiAgICAgICAgICBlcnIgPSBjcmVkRXJyb3IoJ01pc3NpbmcgY3JlZGVudGlhbHMnKTsKICAgICAgICB9CiAgICAgICAgZmluaXNoKGVycik7CiAgICAgIH0KICAKICAgICAgaWYgKHNlbGYuY3JlZGVudGlhbHMpIHsKICAgICAgICBpZiAodHlwZW9mIHNlbGYuY3JlZGVudGlhbHMuZ2V0ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBnZXRBc3luY0NyZWRlbnRpYWxzKCk7CiAgICAgICAgfSBlbHNlIHsgLy8gc3RhdGljIGNyZWRlbnRpYWxzCiAgICAgICAgICBnZXRTdGF0aWNDcmVkZW50aWFscygpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChzZWxmLmNyZWRlbnRpYWxQcm92aWRlcikgewogICAgICAgIHNlbGYuY3JlZGVudGlhbFByb3ZpZGVyLnJlc29sdmUoZnVuY3Rpb24oZXJyLCBjcmVkcykgewogICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICBlcnIgPSBjcmVkRXJyb3IoJ0NvdWxkIG5vdCBsb2FkIGNyZWRlbnRpYWxzIGZyb20gYW55IHByb3ZpZGVycycsIGVycik7CiAgICAgICAgICB9CiAgICAgICAgICBzZWxmLmNyZWRlbnRpYWxzID0gY3JlZHM7CiAgICAgICAgICBmaW5pc2goZXJyKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmaW5pc2goY3JlZEVycm9yKCdObyBjcmVkZW50aWFscyB0byBsb2FkJykpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAIWdyb3VwIExvYWRpbmcgYW5kIFNldHRpbmcgQ29uZmlndXJhdGlvbiBPcHRpb25zCiAgICAgKi8KICAKICAgIC8qKgogICAgICogQG92ZXJsb2FkIHVwZGF0ZShvcHRpb25zLCBhbGxvd1Vua25vd25LZXlzID0gZmFsc2UpCiAgICAgKiAgIFVwZGF0ZXMgdGhlIGN1cnJlbnQgY29uZmlndXJhdGlvbiBvYmplY3Qgd2l0aCBuZXcgb3B0aW9ucy4KICAgICAqCiAgICAgKiAgIEBleGFtcGxlIFVwZGF0ZSBtYXhSZXRyaWVzIHByb3BlcnR5IG9mIGEgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAqICAgICBjb25maWcudXBkYXRlKHttYXhSZXRyaWVzOiAxMH0pOwogICAgICogICBAcGFyYW0gW09iamVjdF0gb3B0aW9ucyBhIG1hcCBvZiBvcHRpb24ga2V5cyBhbmQgdmFsdWVzLgogICAgICogICBAcGFyYW0gW0Jvb2xlYW5dIGFsbG93VW5rbm93bktleXMgd2hldGhlciB1bmtub3duIGtleXMgY2FuIGJlIHNldCBvbgogICAgICogICAgIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdC4gRGVmYXVsdHMgdG8gYGZhbHNlYC4KICAgICAqICAgQHNlZSBjb25zdHJ1Y3RvcgogICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShvcHRpb25zLCBhbGxvd1Vua25vd25LZXlzKSB7CiAgICAgIGFsbG93VW5rbm93bktleXMgPSBhbGxvd1Vua25vd25LZXlzIHx8IGZhbHNlOwogICAgICBvcHRpb25zID0gdGhpcy5leHRyYWN0Q3JlZGVudGlhbHMob3B0aW9ucyk7CiAgICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCBvcHRpb25zLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgIGlmIChhbGxvd1Vua25vd25LZXlzIHx8IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLmtleXMsIGtleSkgfHwKICAgICAgICAgICAgQVdTLlNlcnZpY2UuaGFzU2VydmljZShrZXkpKSB7CiAgICAgICAgICB0aGlzLnNldChrZXksIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogTG9hZHMgY29uZmlndXJhdGlvbiBkYXRhIGZyb20gYSBKU09OIGZpbGUgaW50byB0aGlzIGNvbmZpZyBvYmplY3QuCiAgICAgKiBAbm90ZSBMb2FkaW5nIGNvbmZpZ3VyYXRpb24gd2lsbCByZXNldCBhbGwgZXhpc3RpbmcgY29uZmlndXJhdGlvbgogICAgICogICBvbiB0aGUgb2JqZWN0LgogICAgICogQCFtYWNybyBub2Jyb3dzZXIKICAgICAqIEBwYXJhbSBwYXRoIFtTdHJpbmddIHRoZSBwYXRoIHJlbGF0aXZlIHRvIHlvdXIgcHJvY2VzcydzIGN1cnJlbnQKICAgICAqICAgIHdvcmtpbmcgZGlyZWN0b3J5IHRvIGxvYWQgY29uZmlndXJhdGlvbiBmcm9tLgogICAgICogQHJldHVybiBbQVdTLkNvbmZpZ10gdGhlIHNhbWUgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAqLwogICAgbG9hZEZyb21QYXRoOiBmdW5jdGlvbiBsb2FkRnJvbVBhdGgocGF0aCkgewogICAgICB0aGlzLmNsZWFyKCk7CiAgCiAgICAgIHZhciBvcHRpb25zID0gSlNPTi5wYXJzZShBV1MudXRpbC5yZWFkRmlsZVN5bmMocGF0aCkpOwogICAgICB2YXIgZmlsZVN5c3RlbUNyZWRzID0gbmV3IEFXUy5GaWxlU3lzdGVtQ3JlZGVudGlhbHMocGF0aCk7CiAgICAgIHZhciBjaGFpbiA9IG5ldyBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4oKTsKICAgICAgY2hhaW4ucHJvdmlkZXJzLnVuc2hpZnQoZmlsZVN5c3RlbUNyZWRzKTsKICAgICAgY2hhaW4ucmVzb2x2ZShmdW5jdGlvbiAoZXJyLCBjcmVkcykgewogICAgICAgIGlmIChlcnIpIHRocm93IGVycjsKICAgICAgICBlbHNlIG9wdGlvbnMuY3JlZGVudGlhbHMgPSBjcmVkczsKICAgICAgfSk7CiAgCiAgICAgIHRoaXMuY29uc3RydWN0b3Iob3B0aW9ucyk7CiAgCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8qKgogICAgICogQ2xlYXJzIGNvbmZpZ3VyYXRpb24gZGF0YSBvbiB0aGlzIG9iamVjdAogICAgICoKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjbGVhcjogZnVuY3Rpb24gY2xlYXIoKSB7CiAgICAgIC8qanNoaW50IGZvcmluOmZhbHNlICovCiAgICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLmtleXMsIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBkZWxldGUgdGhpc1trZXldOwogICAgICB9KTsKICAKICAgICAgLy8gcmVzZXQgY3JlZGVudGlhbCBwcm92aWRlcgogICAgICB0aGlzLnNldCgnY3JlZGVudGlhbHMnLCB1bmRlZmluZWQpOwogICAgICB0aGlzLnNldCgnY3JlZGVudGlhbFByb3ZpZGVyJywgdW5kZWZpbmVkKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFNldHMgYSBwcm9wZXJ0eSBvbiB0aGUgY29uZmlndXJhdGlvbiBvYmplY3QsIGFsbG93aW5nIGZvciBhCiAgICAgKiBkZWZhdWx0IHZhbHVlCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc2V0OiBmdW5jdGlvbiBzZXQocHJvcGVydHksIHZhbHVlLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAoZGVmYXVsdFZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGRlZmF1bHRWYWx1ZSA9IHRoaXMua2V5c1twcm9wZXJ0eV07CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgZGVmYXVsdFZhbHVlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICB0aGlzW3Byb3BlcnR5XSA9IGRlZmF1bHRWYWx1ZS5jYWxsKHRoaXMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzW3Byb3BlcnR5XSA9IGRlZmF1bHRWYWx1ZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAocHJvcGVydHkgPT09ICdodHRwT3B0aW9ucycgJiYgdGhpc1twcm9wZXJ0eV0pIHsKICAgICAgICAvLyBkZWVwIG1lcmdlIGh0dHBPcHRpb25zCiAgICAgICAgdGhpc1twcm9wZXJ0eV0gPSBBV1MudXRpbC5tZXJnZSh0aGlzW3Byb3BlcnR5XSwgdmFsdWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXNbcHJvcGVydHldID0gdmFsdWU7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEFsbCBvZiB0aGUga2V5cyB3aXRoIHRoZWlyIGRlZmF1bHQgdmFsdWVzLgogICAgICoKICAgICAqIEBjb25zdGFudAogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGtleXM6IHsKICAgICAgY3JlZGVudGlhbHM6IG51bGwsCiAgICAgIGNyZWRlbnRpYWxQcm92aWRlcjogbnVsbCwKICAgICAgcmVnaW9uOiBudWxsLAogICAgICBsb2dnZXI6IG51bGwsCiAgICAgIGFwaVZlcnNpb25zOiB7fSwKICAgICAgYXBpVmVyc2lvbjogbnVsbCwKICAgICAgZW5kcG9pbnQ6IHVuZGVmaW5lZCwKICAgICAgaHR0cE9wdGlvbnM6IHsKICAgICAgICB0aW1lb3V0OiAxMjAwMDAKICAgICAgfSwKICAgICAgbWF4UmV0cmllczogdW5kZWZpbmVkLAogICAgICBtYXhSZWRpcmVjdHM6IDEwLAogICAgICBwYXJhbVZhbGlkYXRpb246IHRydWUsCiAgICAgIHNzbEVuYWJsZWQ6IHRydWUsCiAgICAgIHMzRm9yY2VQYXRoU3R5bGU6IGZhbHNlLAogICAgICBzM0J1Y2tldEVuZHBvaW50OiBmYWxzZSwKICAgICAgczNEaXNhYmxlQm9keVNpZ25pbmc6IHRydWUsCiAgICAgIGNvbXB1dGVDaGVja3N1bXM6IHRydWUsCiAgICAgIGNvbnZlcnRSZXNwb25zZVR5cGVzOiB0cnVlLAogICAgICBjb3JyZWN0Q2xvY2tTa2V3OiBmYWxzZSwKICAgICAgY3VzdG9tVXNlckFnZW50OiBudWxsLAogICAgICBkeW5hbW9EYkNyYzMyOiB0cnVlLAogICAgICBzeXN0ZW1DbG9ja09mZnNldDogMCwKICAgICAgc2lnbmF0dXJlVmVyc2lvbjogbnVsbCwKICAgICAgc2lnbmF0dXJlQ2FjaGU6IHRydWUsCiAgICAgIHJldHJ5RGVsYXlPcHRpb25zOiB7fSwKICAgICAgdXNlQWNjZWxlcmF0ZUVuZHBvaW50OiBmYWxzZSwKICAgICAgY2xpZW50U2lkZU1vbml0b3Jpbmc6IGZhbHNlLAogICAgICBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWQ6IGZhbHNlLAogICAgICBlbmRwb2ludENhY2hlU2l6ZTogMTAwMCwKICAgICAgaG9zdFByZWZpeEVuYWJsZWQ6IHRydWUsCiAgICAgIHN0c1JlZ2lvbmFsRW5kcG9pbnRzOiBudWxsCiAgICB9LAogIAogICAgLyoqCiAgICAgKiBFeHRyYWN0cyBhY2Nlc3NLZXlJZCwgc2VjcmV0QWNjZXNzS2V5IGFuZCBzZXNzaW9uVG9rZW4KICAgICAqIGZyb20gYSBjb25maWd1cmF0aW9uIGhhc2guCiAgICAgKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGV4dHJhY3RDcmVkZW50aWFsczogZnVuY3Rpb24gZXh0cmFjdENyZWRlbnRpYWxzKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMuYWNjZXNzS2V5SWQgJiYgb3B0aW9ucy5zZWNyZXRBY2Nlc3NLZXkpIHsKICAgICAgICBvcHRpb25zID0gQVdTLnV0aWwuY29weShvcHRpb25zKTsKICAgICAgICBvcHRpb25zLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5DcmVkZW50aWFscyhvcHRpb25zKTsKICAgICAgfQogICAgICByZXR1cm4gb3B0aW9uczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFNldHMgdGhlIHByb21pc2UgZGVwZW5kZW5jeSB0aGUgU0RLIHdpbGwgdXNlIHdoZXJldmVyIFByb21pc2VzIGFyZSByZXR1cm5lZC4KICAgICAqIFBhc3NpbmcgYG51bGxgIHdpbGwgZm9yY2UgdGhlIFNESyB0byB1c2UgbmF0aXZlIFByb21pc2VzIGlmIHRoZXkgYXJlIGF2YWlsYWJsZS4KICAgICAqIElmIG5hdGl2ZSBQcm9taXNlcyBhcmUgbm90IGF2YWlsYWJsZSwgcGFzc2luZyBgbnVsbGAgd2lsbCBoYXZlIG5vIGVmZmVjdC4KICAgICAqIEBwYXJhbSBbQ29uc3RydWN0b3JdIGRlcCBBIHJlZmVyZW5jZSB0byBhIFByb21pc2UgY29uc3RydWN0b3IKICAgICAqLwogICAgc2V0UHJvbWlzZXNEZXBlbmRlbmN5OiBmdW5jdGlvbiBzZXRQcm9taXNlc0RlcGVuZGVuY3koZGVwKSB7CiAgICAgIFByb21pc2VzRGVwZW5kZW5jeSA9IGRlcDsKICAgICAgLy8gaWYgbnVsbCB3YXMgcGFzc2VkIGluLCB3ZSBzaG91bGQgdHJ5IHRvIHVzZSBuYXRpdmUgcHJvbWlzZXMKICAgICAgaWYgKGRlcCA9PT0gbnVsbCAmJiB0eXBlb2YgUHJvbWlzZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIFByb21pc2VzRGVwZW5kZW5jeSA9IFByb21pc2U7CiAgICAgIH0KICAgICAgdmFyIGNvbnN0cnVjdG9ycyA9IFtBV1MuUmVxdWVzdCwgQVdTLkNyZWRlbnRpYWxzLCBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW5dOwogICAgICBpZiAoQVdTLlMzKSB7CiAgICAgICAgY29uc3RydWN0b3JzLnB1c2goQVdTLlMzKTsKICAgICAgICBpZiAoQVdTLlMzLk1hbmFnZWRVcGxvYWQpIHsKICAgICAgICAgIGNvbnN0cnVjdG9ycy5wdXNoKEFXUy5TMy5NYW5hZ2VkVXBsb2FkKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgQVdTLnV0aWwuYWRkUHJvbWlzZXMoY29uc3RydWN0b3JzLCBQcm9taXNlc0RlcGVuZGVuY3kpOwogICAgfSwKICAKICAgIC8qKgogICAgICogR2V0cyB0aGUgcHJvbWlzZSBkZXBlbmRlbmN5IHNldCBieSBgQVdTLmNvbmZpZy5zZXRQcm9taXNlc0RlcGVuZGVuY3lgLgogICAgICovCiAgICBnZXRQcm9taXNlc0RlcGVuZGVuY3k6IGZ1bmN0aW9uIGdldFByb21pc2VzRGVwZW5kZW5jeSgpIHsKICAgICAgcmV0dXJuIFByb21pc2VzRGVwZW5kZW5jeTsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAcmV0dXJuIFtBV1MuQ29uZmlnXSBUaGUgZ2xvYmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0IHNpbmdsZXRvbiBpbnN0YW5jZQogICAqIEByZWFkb25seQogICAqIEBzZWUgQVdTLkNvbmZpZwogICAqLwogIEFXUy5jb25maWcgPSBuZXcgQVdTLkNvbmZpZygpOwogIAogIH0seyIuL2NvcmUiOjE4LCIuL2NyZWRlbnRpYWxzIjoxOSwiLi9jcmVkZW50aWFscy9jcmVkZW50aWFsX3Byb3ZpZGVyX2NoYWluIjoyMn1dLDE4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvKioKICAgKiBUaGUgbWFpbiBBV1MgbmFtZXNwYWNlCiAgICovCiAgdmFyIEFXUyA9IHsgdXRpbDogcmVxdWlyZSgnLi91dGlsJykgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAIW1hY3JvIFtuZXddIG5vYnJvd3NlcgogICAqICAgQG5vdGUgVGhpcyBmZWF0dXJlIGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQgb2YgdGhlIFNESy4KICAgKi8KICB2YXIgX2hpZGRlbiA9IHt9OyBfaGlkZGVuLnRvU3RyaW5nKCk7IC8vIGhhY2sgdG8gcGFyc2UgbWFjcm8KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUzsKICAKICBBV1MudXRpbC51cGRhdGUoQVdTLCB7CiAgCiAgICAvKioKICAgICAqIEBjb25zdGFudAogICAgICovCiAgICBWRVJTSU9OOiAnMi41NTMuMCcsCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBTaWduZXJzOiB7fSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIFByb3RvY29sOiB7CiAgICAgIEpzb246IHJlcXVpcmUoJy4vcHJvdG9jb2wvanNvbicpLAogICAgICBRdWVyeTogcmVxdWlyZSgnLi9wcm90b2NvbC9xdWVyeScpLAogICAgICBSZXN0OiByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3QnKSwKICAgICAgUmVzdEpzb246IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdF9qc29uJyksCiAgICAgIFJlc3RYbWw6IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdF94bWwnKQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIFhNTDogewogICAgICBCdWlsZGVyOiByZXF1aXJlKCcuL3htbC9idWlsZGVyJyksCiAgICAgIFBhcnNlcjogbnVsbCAvLyBjb25kaXRpb25hbGx5IHNldCBiYXNlZCBvbiBlbnZpcm9ubWVudAogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIEpTT046IHsKICAgICAgQnVpbGRlcjogcmVxdWlyZSgnLi9qc29uL2J1aWxkZXInKSwKICAgICAgUGFyc2VyOiByZXF1aXJlKCcuL2pzb24vcGFyc2VyJykKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBNb2RlbDogewogICAgICBBcGk6IHJlcXVpcmUoJy4vbW9kZWwvYXBpJyksCiAgICAgIE9wZXJhdGlvbjogcmVxdWlyZSgnLi9tb2RlbC9vcGVyYXRpb24nKSwKICAgICAgU2hhcGU6IHJlcXVpcmUoJy4vbW9kZWwvc2hhcGUnKSwKICAgICAgUGFnaW5hdG9yOiByZXF1aXJlKCcuL21vZGVsL3BhZ2luYXRvcicpLAogICAgICBSZXNvdXJjZVdhaXRlcjogcmVxdWlyZSgnLi9tb2RlbC9yZXNvdXJjZV93YWl0ZXInKQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwaUxvYWRlcjogcmVxdWlyZSgnLi9hcGlfbG9hZGVyJyksCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBFbmRwb2ludENhY2hlOiByZXF1aXJlKCcuLi92ZW5kb3IvZW5kcG9pbnQtY2FjaGUnKS5FbmRwb2ludENhY2hlCiAgfSk7CiAgcmVxdWlyZSgnLi9zZXF1ZW50aWFsX2V4ZWN1dG9yJyk7CiAgcmVxdWlyZSgnLi9zZXJ2aWNlJyk7CiAgcmVxdWlyZSgnLi9jb25maWcnKTsKICByZXF1aXJlKCcuL2h0dHAnKTsKICByZXF1aXJlKCcuL2V2ZW50X2xpc3RlbmVycycpOwogIHJlcXVpcmUoJy4vcmVxdWVzdCcpOwogIHJlcXVpcmUoJy4vcmVzcG9uc2UnKTsKICByZXF1aXJlKCcuL3Jlc291cmNlX3dhaXRlcicpOwogIHJlcXVpcmUoJy4vc2lnbmVycy9yZXF1ZXN0X3NpZ25lcicpOwogIHJlcXVpcmUoJy4vcGFyYW1fdmFsaWRhdG9yJyk7CiAgCiAgLyoqCiAgICogQHJlYWRvbmx5CiAgICogQHJldHVybiBbQVdTLlNlcXVlbnRpYWxFeGVjdXRvcl0gYSBjb2xsZWN0aW9uIG9mIGdsb2JhbCBldmVudCBsaXN0ZW5lcnMgdGhhdAogICAqICAgYXJlIGF0dGFjaGVkIHRvIGV2ZXJ5IHNlbnQgcmVxdWVzdC4KICAgKiBAc2VlIEFXUy5SZXF1ZXN0IEFXUy5SZXF1ZXN0IGZvciBhIGxpc3Qgb2YgZXZlbnRzIHRvIGxpc3RlbiBmb3IKICAgKiBAZXhhbXBsZSBMb2dnaW5nIHRoZSB0aW1lIHRha2VuIHRvIHNlbmQgYSByZXF1ZXN0CiAgICogICBBV1MuZXZlbnRzLm9uKCdzZW5kJywgZnVuY3Rpb24gc3RhcnRTZW5kKHJlc3ApIHsKICAgKiAgICAgcmVzcC5zdGFydFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgKiAgIH0pLm9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uIGNhbGN1bGF0ZVRpbWUocmVzcCkgewogICAqICAgICB2YXIgdGltZSA9IChuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHJlc3Auc3RhcnRUaW1lKSAvIDEwMDA7CiAgICogICAgIGNvbnNvbGUubG9nKCdSZXF1ZXN0IHRvb2sgJyArIHRpbWUgKyAnIHNlY29uZHMnKTsKICAgKiAgIH0pOwogICAqCiAgICogICBuZXcgQVdTLlMzKCkubGlzdEJ1Y2tldHMoKTsgLy8gcHJpbnRzICdSZXF1ZXN0IHRvb2sgMC4yODUgc2Vjb25kcycKICAgKi8KICBBV1MuZXZlbnRzID0gbmV3IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IoKTsKICAKICAvL2NyZWF0ZSBlbmRwb2ludCBjYWNoZSBsYXppbHkKICBBV1MudXRpbC5tZW1vaXplZFByb3BlcnR5KEFXUywgJ2VuZHBvaW50Q2FjaGUnLCBmdW5jdGlvbigpIHsKICAgIHJldHVybiBuZXcgQVdTLkVuZHBvaW50Q2FjaGUoQVdTLmNvbmZpZy5lbmRwb2ludENhY2hlU2l6ZSk7CiAgfSwgdHJ1ZSk7CiAgCiAgfSx7Ii4uL3ZlbmRvci9lbmRwb2ludC1jYWNoZSI6MTAzLCIuL2FwaV9sb2FkZXIiOjksIi4vY29uZmlnIjoxNywiLi9ldmVudF9saXN0ZW5lcnMiOjMzLCIuL2h0dHAiOjM0LCIuL2pzb24vYnVpbGRlciI6MzYsIi4vanNvbi9wYXJzZXIiOjM3LCIuL21vZGVsL2FwaSI6MzgsIi4vbW9kZWwvb3BlcmF0aW9uIjo0MCwiLi9tb2RlbC9wYWdpbmF0b3IiOjQxLCIuL21vZGVsL3Jlc291cmNlX3dhaXRlciI6NDIsIi4vbW9kZWwvc2hhcGUiOjQzLCIuL3BhcmFtX3ZhbGlkYXRvciI6NDQsIi4vcHJvdG9jb2wvanNvbiI6NDYsIi4vcHJvdG9jb2wvcXVlcnkiOjQ3LCIuL3Byb3RvY29sL3Jlc3QiOjQ4LCIuL3Byb3RvY29sL3Jlc3RfanNvbiI6NDksIi4vcHJvdG9jb2wvcmVzdF94bWwiOjUwLCIuL3JlcXVlc3QiOjU1LCIuL3Jlc291cmNlX3dhaXRlciI6NTYsIi4vcmVzcG9uc2UiOjU3LCIuL3NlcXVlbnRpYWxfZXhlY3V0b3IiOjU4LCIuL3NlcnZpY2UiOjU5LCIuL3NpZ25lcnMvcmVxdWVzdF9zaWduZXIiOjYzLCIuL3V0aWwiOjcxLCIuL3htbC9idWlsZGVyIjo3M31dLDE5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyB5b3VyIEFXUyBzZWN1cml0eSBjcmVkZW50aWFscywgc3BlY2lmaWNhbGx5IHRoZQogICAqIHthY2Nlc3NLZXlJZH0sIHtzZWNyZXRBY2Nlc3NLZXl9LCBhbmQgb3B0aW9uYWwge3Nlc3Npb25Ub2tlbn0uCiAgICogQ3JlYXRpbmcgYSBgQ3JlZGVudGlhbHNgIG9iamVjdCBhbGxvd3MgeW91IHRvIHBhc3MgYXJvdW5kIHlvdXIKICAgKiBzZWN1cml0eSBpbmZvcm1hdGlvbiB0byBjb25maWd1cmF0aW9uIGFuZCBzZXJ2aWNlIG9iamVjdHMuCiAgICoKICAgKiBOb3RlIHRoYXQgdGhpcyBjbGFzcyB0eXBpY2FsbHkgZG9lcyBub3QgbmVlZCB0byBiZSBjb25zdHJ1Y3RlZCBtYW51YWxseSwKICAgKiBhcyB0aGUge0FXUy5Db25maWd9IGFuZCB7QVdTLlNlcnZpY2V9IGNsYXNzZXMgYm90aCBhY2NlcHQgc2ltcGxlCiAgICogb3B0aW9ucyBoYXNoZXMgd2l0aCB0aGUgdGhyZWUga2V5cy4gVGhlc2Ugc3RydWN0dXJlcyB3aWxsIGJlIGNvbnZlcnRlZAogICAqIGludG8gQ3JlZGVudGlhbHMgb2JqZWN0cyBhdXRvbWF0aWNhbGx5LgogICAqCiAgICogIyMgRXhwaXJpbmcgYW5kIFJlZnJlc2hpbmcgQ3JlZGVudGlhbHMKICAgKgogICAqIE9jY2FzaW9uYWxseSBjcmVkZW50aWFscyBjYW4gZXhwaXJlIGluIHRoZSBtaWRkbGUgb2YgYSBsb25nLXJ1bm5pbmcKICAgKiBhcHBsaWNhdGlvbi4gSW4gdGhpcyBjYXNlLCB0aGUgU0RLIHdpbGwgYXV0b21hdGljYWxseSBhdHRlbXB0IHRvCiAgICogcmVmcmVzaCB0aGUgY3JlZGVudGlhbHMgZnJvbSB0aGUgc3RvcmFnZSBsb2NhdGlvbiBpZiB0aGUgQ3JlZGVudGlhbHMKICAgKiBjbGFzcyBpbXBsZW1lbnRzIHRoZSB7cmVmcmVzaH0gbWV0aG9kLgogICAqCiAgICogSWYgeW91IGFyZSBpbXBsZW1lbnRpbmcgYSBjcmVkZW50aWFsIHN0b3JhZ2UgbG9jYXRpb24sIHlvdQogICAqIHdpbGwgd2FudCB0byBjcmVhdGUgYSBzdWJjbGFzcyBvZiB0aGUgYENyZWRlbnRpYWxzYCBjbGFzcyBhbmQKICAgKiBvdmVycmlkZSB0aGUge3JlZnJlc2h9IG1ldGhvZC4gVGhpcyBtZXRob2QgYWxsb3dzIGNyZWRlbnRpYWxzIHRvIGJlCiAgICogcmV0cmlldmVkIGZyb20gdGhlIGJhY2tpbmcgc3RvcmUsIGJlIGl0IGEgZmlsZSBzeXN0ZW0sIGRhdGFiYXNlLCBvcgogICAqIHNvbWUgbmV0d29yayBzdG9yYWdlLiBUaGUgbWV0aG9kIHNob3VsZCByZXNldCB0aGUgY3JlZGVudGlhbCBhdHRyaWJ1dGVzCiAgICogb24gdGhlIG9iamVjdC4KICAgKgogICAqIEAhYXR0cmlidXRlIGV4cGlyZWQKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIGNyZWRlbnRpYWxzIGhhdmUgYmVlbiBleHBpcmVkIGFuZAogICAqICAgICByZXF1aXJlIGEgcmVmcmVzaC4gVXNlZCBpbiBjb25qdW5jdGlvbiB3aXRoIHtleHBpcmVUaW1lfS4KICAgKiBAIWF0dHJpYnV0ZSBleHBpcmVUaW1lCiAgICogICBAcmV0dXJuIFtEYXRlXSBhIHRpbWUgd2hlbiBjcmVkZW50aWFscyBzaG91bGQgYmUgY29uc2lkZXJlZCBleHBpcmVkLiBVc2VkCiAgICogICAgIGluIGNvbmp1bmN0aW9uIHdpdGgge2V4cGlyZWR9LgogICAqIEAhYXR0cmlidXRlIGFjY2Vzc0tleUlkCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBBV1MgYWNjZXNzIGtleSBJRAogICAqIEAhYXR0cmlidXRlIHNlY3JldEFjY2Vzc0tleQogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgQVdTIHNlY3JldCBhY2Nlc3Mga2V5CiAgICogQCFhdHRyaWJ1dGUgc2Vzc2lvblRva2VuCiAgICogICBAcmV0dXJuIFtTdHJpbmddIGFuIG9wdGlvbmFsIEFXUyBzZXNzaW9uIHRva2VuCiAgICovCiAgQVdTLkNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdCh7CiAgICAvKioKICAgICAqIEEgY3JlZGVudGlhbHMgb2JqZWN0IGNhbiBiZSBjcmVhdGVkIHVzaW5nIHBvc2l0aW9uYWwgYXJndW1lbnRzIG9yIGFuIG9wdGlvbnMKICAgICAqIGhhc2guCiAgICAgKgogICAgICogQG92ZXJsb2FkIEFXUy5DcmVkZW50aWFscyhhY2Nlc3NLZXlJZCwgc2VjcmV0QWNjZXNzS2V5LCBzZXNzaW9uVG9rZW49bnVsbCkKICAgICAqICAgQ3JlYXRlcyBhIENyZWRlbnRpYWxzIG9iamVjdCB3aXRoIGEgZ2l2ZW4gc2V0IG9mIGNyZWRlbnRpYWwgaW5mb3JtYXRpb24KICAgICAqICAgYXMgcG9zaXRpb25hbCBhcmd1bWVudHMuCiAgICAgKiAgIEBwYXJhbSBhY2Nlc3NLZXlJZCBbU3RyaW5nXSB0aGUgQVdTIGFjY2VzcyBrZXkgSUQKICAgICAqICAgQHBhcmFtIHNlY3JldEFjY2Vzc0tleSBbU3RyaW5nXSB0aGUgQVdTIHNlY3JldCBhY2Nlc3Mga2V5CiAgICAgKiAgIEBwYXJhbSBzZXNzaW9uVG9rZW4gW1N0cmluZ10gdGhlIG9wdGlvbmFsIEFXUyBzZXNzaW9uIHRva2VuCiAgICAgKiAgIEBleGFtcGxlIENyZWF0ZSBhIGNyZWRlbnRpYWxzIG9iamVjdCB3aXRoIEFXUyBjcmVkZW50aWFscwogICAgICogICAgIHZhciBjcmVkcyA9IG5ldyBBV1MuQ3JlZGVudGlhbHMoJ2FraWQnLCAnc2VjcmV0JywgJ3Nlc3Npb24nKTsKICAgICAqIEBvdmVybG9hZCBBV1MuQ3JlZGVudGlhbHMob3B0aW9ucykKICAgICAqICAgQ3JlYXRlcyBhIENyZWRlbnRpYWxzIG9iamVjdCB3aXRoIGEgZ2l2ZW4gc2V0IG9mIGNyZWRlbnRpYWwgaW5mb3JtYXRpb24KICAgICAqICAgYXMgYW4gb3B0aW9ucyBoYXNoLgogICAgICogICBAb3B0aW9uIG9wdGlvbnMgYWNjZXNzS2V5SWQgW1N0cmluZ10gdGhlIEFXUyBhY2Nlc3Mga2V5IElECiAgICAgKiAgIEBvcHRpb24gb3B0aW9ucyBzZWNyZXRBY2Nlc3NLZXkgW1N0cmluZ10gdGhlIEFXUyBzZWNyZXQgYWNjZXNzIGtleQogICAgICogICBAb3B0aW9uIG9wdGlvbnMgc2Vzc2lvblRva2VuIFtTdHJpbmddIHRoZSBvcHRpb25hbCBBV1Mgc2Vzc2lvbiB0b2tlbgogICAgICogICBAZXhhbXBsZSBDcmVhdGUgYSBjcmVkZW50aWFscyBvYmplY3Qgd2l0aCBBV1MgY3JlZGVudGlhbHMKICAgICAqICAgICB2YXIgY3JlZHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKHsKICAgICAqICAgICAgIGFjY2Vzc0tleUlkOiAnYWtpZCcsIHNlY3JldEFjY2Vzc0tleTogJ3NlY3JldCcsIHNlc3Npb25Ub2tlbjogJ3Nlc3Npb24nCiAgICAgKiAgICAgfSk7CiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDcmVkZW50aWFscygpIHsKICAgICAgLy8gaGlkZSBzZWNyZXRBY2Nlc3NLZXkgZnJvbSBiZWluZyBkaXNwbGF5ZWQgd2l0aCB1dGlsLmluc3BlY3QKICAgICAgQVdTLnV0aWwuaGlkZVByb3BlcnRpZXModGhpcywgWydzZWNyZXRBY2Nlc3NLZXknXSk7CiAgCiAgICAgIHRoaXMuZXhwaXJlZCA9IGZhbHNlOwogICAgICB0aGlzLmV4cGlyZVRpbWUgPSBudWxsOwogICAgICB0aGlzLnJlZnJlc2hDYWxsYmFja3MgPSBbXTsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEgJiYgdHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gJ29iamVjdCcpIHsKICAgICAgICB2YXIgY3JlZHMgPSBhcmd1bWVudHNbMF0uY3JlZGVudGlhbHMgfHwgYXJndW1lbnRzWzBdOwogICAgICAgIHRoaXMuYWNjZXNzS2V5SWQgPSBjcmVkcy5hY2Nlc3NLZXlJZDsKICAgICAgICB0aGlzLnNlY3JldEFjY2Vzc0tleSA9IGNyZWRzLnNlY3JldEFjY2Vzc0tleTsKICAgICAgICB0aGlzLnNlc3Npb25Ub2tlbiA9IGNyZWRzLnNlc3Npb25Ub2tlbjsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmFjY2Vzc0tleUlkID0gYXJndW1lbnRzWzBdOwogICAgICAgIHRoaXMuc2VjcmV0QWNjZXNzS2V5ID0gYXJndW1lbnRzWzFdOwogICAgICAgIHRoaXMuc2Vzc2lvblRva2VuID0gYXJndW1lbnRzWzJdOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbnVtYmVyIG9mIHNlY29uZHMgYmVmb3JlIHtleHBpcmVUaW1lfSBkdXJpbmcgd2hpY2gKICAgICAqICAgdGhlIGNyZWRlbnRpYWxzIHdpbGwgYmUgY29uc2lkZXJlZCBleHBpcmVkLgogICAgICovCiAgICBleHBpcnlXaW5kb3c6IDE1LAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBjcmVkZW50aWFscyBvYmplY3Qgc2hvdWxkIGNhbGwge3JlZnJlc2h9CiAgICAgKiBAbm90ZSBTdWJjbGFzc2VzIHNob3VsZCBvdmVycmlkZSB0aGlzIG1ldGhvZCB0byBwcm92aWRlIGN1c3RvbSByZWZyZXNoCiAgICAgKiAgIGxvZ2ljLgogICAgICovCiAgICBuZWVkc1JlZnJlc2g6IGZ1bmN0aW9uIG5lZWRzUmVmcmVzaCgpIHsKICAgICAgdmFyIGN1cnJlbnRUaW1lID0gQVdTLnV0aWwuZGF0ZS5nZXREYXRlKCkuZ2V0VGltZSgpOwogICAgICB2YXIgYWRqdXN0ZWRUaW1lID0gbmV3IERhdGUoY3VycmVudFRpbWUgKyB0aGlzLmV4cGlyeVdpbmRvdyAqIDEwMDApOwogIAogICAgICBpZiAodGhpcy5leHBpcmVUaW1lICYmIGFkanVzdGVkVGltZSA+IHRoaXMuZXhwaXJlVGltZSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmV4cGlyZWQgfHwgIXRoaXMuYWNjZXNzS2V5SWQgfHwgIXRoaXMuc2VjcmV0QWNjZXNzS2V5OwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBleGlzdGluZyBjcmVkZW50aWFscywgcmVmcmVzaGluZyB0aGVtIGlmIHRoZXkgYXJlIG5vdCB5ZXQgbG9hZGVkCiAgICAgKiBvciBoYXZlIGV4cGlyZWQuIFVzZXJzIHNob3VsZCBjYWxsIHRoaXMgbWV0aG9kIGJlZm9yZSB1c2luZyB7cmVmcmVzaH0sCiAgICAgKiBhcyB0aGlzIHdpbGwgbm90IGF0dGVtcHQgdG8gcmVsb2FkIGNyZWRlbnRpYWxzIHdoZW4gdGhleSBhcmUgYWxyZWFkeQogICAgICogbG9hZGVkIGludG8gdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICBXaGVuIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIGVpdGhlciBjcmVkZW50aWFscwogICAgICogICBkbyBub3QgbmVlZCB0byBiZSByZWZyZXNoZWQgb3IgcmVmcmVzaGVkIGNyZWRlbnRpYWxzIGluZm9ybWF0aW9uIGhhcwogICAgICogICBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLCBgc2VjcmV0QWNjZXNzS2V5YCwKICAgICAqICAgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqLwogICAgZ2V0OiBmdW5jdGlvbiBnZXQoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZiAodGhpcy5uZWVkc1JlZnJlc2goKSkgewogICAgICAgIHRoaXMucmVmcmVzaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIGlmICghZXJyKSBzZWxmLmV4cGlyZWQgPSBmYWxzZTsgLy8gcmVzZXQgZXhwaXJlZCBmbGFnCiAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKGVycik7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAoY2FsbGJhY2spIHsKICAgICAgICBjYWxsYmFjaygpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAIW1ldGhvZCAgZ2V0UHJvbWlzZSgpCiAgICAgKiAgIFJldHVybnMgYSAndGhlbmFibGUnIHByb21pc2UuCiAgICAgKiAgIEdldHMgdGhlIGV4aXN0aW5nIGNyZWRlbnRpYWxzLCByZWZyZXNoaW5nIHRoZW0gaWYgdGhleSBhcmUgbm90IHlldCBsb2FkZWQKICAgICAqICAgb3IgaGF2ZSBleHBpcmVkLiBVc2VycyBzaG91bGQgY2FsbCB0aGlzIG1ldGhvZCBiZWZvcmUgdXNpbmcge3JlZnJlc2h9LAogICAgICogICBhcyB0aGlzIHdpbGwgbm90IGF0dGVtcHQgdG8gcmVsb2FkIGNyZWRlbnRpYWxzIHdoZW4gdGhleSBhcmUgYWxyZWFkeQogICAgICogICBsb2FkZWQgaW50byB0aGUgb2JqZWN0LgogICAgICoKICAgICAqICAgVHdvIGNhbGxiYWNrcyBjYW4gYmUgcHJvdmlkZWQgdG8gdGhlIGB0aGVuYCBtZXRob2Qgb24gdGhlIHJldHVybmVkIHByb21pc2UuCiAgICAgKiAgIFRoZSBmaXJzdCBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQsIGFuZCB0aGUgc2Vjb25kCiAgICAgKiAgIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICBAY2FsbGJhY2sgZnVsZmlsbGVkQ2FsbGJhY2sgZnVuY3Rpb24oKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQuIFdoZW4gdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQsIGl0CiAgICAgKiAgICAgbWVhbnMgZWl0aGVyIGNyZWRlbnRpYWxzIGRvIG5vdCBuZWVkIHRvIGJlIHJlZnJlc2hlZCBvciByZWZyZXNoZWQKICAgICAqICAgICBjcmVkZW50aWFscyBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUKICAgICAqICAgICBgYWNjZXNzS2V5SWRgLCBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAY2FsbGJhY2sgcmVqZWN0ZWRDYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogICBAcmV0dXJuIFtQcm9taXNlXSBBIHByb21pc2UgdGhhdCByZXByZXNlbnRzIHRoZSBzdGF0ZSBvZiB0aGUgYGdldGAgY2FsbC4KICAgICAqICAgQGV4YW1wbGUgQ2FsbGluZyB0aGUgYGdldFByb21pc2VgIG1ldGhvZC4KICAgICAqICAgICB2YXIgcHJvbWlzZSA9IGNyZWRQcm92aWRlci5nZXRQcm9taXNlKCk7CiAgICAgKiAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKCkgeyAuLi4gfSwgZnVuY3Rpb24oZXJyKSB7IC4uLiB9KTsKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBAIW1ldGhvZCAgcmVmcmVzaFByb21pc2UoKQogICAgICogICBSZXR1cm5zIGEgJ3RoZW5hYmxlJyBwcm9taXNlLgogICAgICogICBSZWZyZXNoZXMgdGhlIGNyZWRlbnRpYWxzLiBVc2VycyBzaG91bGQgY2FsbCB7Z2V0fSBiZWZvcmUgYXR0ZW1wdGluZwogICAgICogICB0byBmb3JjaWJseSByZWZyZXNoIGNyZWRlbnRpYWxzLgogICAgICoKICAgICAqICAgVHdvIGNhbGxiYWNrcyBjYW4gYmUgcHJvdmlkZWQgdG8gdGhlIGB0aGVuYCBtZXRob2Qgb24gdGhlIHJldHVybmVkIHByb21pc2UuCiAgICAgKiAgIFRoZSBmaXJzdCBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQsIGFuZCB0aGUgc2Vjb25kCiAgICAgKiAgIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICBAY2FsbGJhY2sgZnVsZmlsbGVkQ2FsbGJhY2sgZnVuY3Rpb24oKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQuIFdoZW4gdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQsIGl0CiAgICAgKiAgICAgbWVhbnMgcmVmcmVzaGVkIGNyZWRlbnRpYWxzIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QKICAgICAqICAgICAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBjYWxsYmFjayByZWplY3RlZENhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICAgKiAgICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKiAgIEByZXR1cm4gW1Byb21pc2VdIEEgcHJvbWlzZSB0aGF0IHJlcHJlc2VudHMgdGhlIHN0YXRlIG9mIHRoZSBgcmVmcmVzaGAgY2FsbC4KICAgICAqICAgQGV4YW1wbGUgQ2FsbGluZyB0aGUgYHJlZnJlc2hQcm9taXNlYCBtZXRob2QuCiAgICAgKiAgICAgdmFyIHByb21pc2UgPSBjcmVkUHJvdmlkZXIucmVmcmVzaFByb21pc2UoKTsKICAgICAqICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24oKSB7IC4uLiB9LCBmdW5jdGlvbihlcnIpIHsgLi4uIH0pOwogICAgICovCiAgCiAgICAvKioKICAgICAqIFJlZnJlc2hlcyB0aGUgY3JlZGVudGlhbHMuIFVzZXJzIHNob3VsZCBjYWxsIHtnZXR9IGJlZm9yZSBhdHRlbXB0aW5nCiAgICAgKiB0byBmb3JjaWJseSByZWZyZXNoIGNyZWRlbnRpYWxzLgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIFdoZW4gdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgcmVmcmVzaGVkCiAgICAgKiAgIGNyZWRlbnRpYWxzIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZQogICAgICogICBgYWNjZXNzS2V5SWRgLCBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqIEBub3RlIFN1YmNsYXNzZXMgc2hvdWxkIG92ZXJyaWRlIHRoaXMgY2xhc3MgdG8gcmVzZXQgdGhlCiAgICAgKiAgIHthY2Nlc3NLZXlJZH0sIHtzZWNyZXRBY2Nlc3NLZXl9IGFuZCBvcHRpb25hbCB7c2Vzc2lvblRva2VufQogICAgICogICBvbiB0aGUgY3JlZGVudGlhbHMgb2JqZWN0IGFuZCB0aGVuIGNhbGwgdGhlIGNhbGxiYWNrIHdpdGgKICAgICAqICAgYW55IGVycm9yIGluZm9ybWF0aW9uLgogICAgICogQHNlZSBnZXQKICAgICAqLwogICAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaChjYWxsYmFjaykgewogICAgICB0aGlzLmV4cGlyZWQgPSBmYWxzZTsKICAgICAgY2FsbGJhY2soKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICogQHBhcmFtIGNhbGxiYWNrCiAgICAgKi8KICAgIGNvYWxlc2NlUmVmcmVzaDogZnVuY3Rpb24gY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrLCBzeW5jKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgaWYgKHNlbGYucmVmcmVzaENhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKSA9PT0gMSkgewogICAgICAgIHNlbGYubG9hZChmdW5jdGlvbiBvbkxvYWQoZXJyKSB7CiAgICAgICAgICBBV1MudXRpbC5hcnJheUVhY2goc2VsZi5yZWZyZXNoQ2FsbGJhY2tzLCBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgICBpZiAoc3luYykgewogICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gY2FsbGJhY2sgY291bGQgdGhyb3csIHNvIGRlZmVyIHRvIGVuc3VyZSBhbGwgY2FsbGJhY2tzIGFyZSBub3RpZmllZAogICAgICAgICAgICAgIEFXUy51dGlsLmRlZmVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgc2VsZi5yZWZyZXNoQ2FsbGJhY2tzLmxlbmd0aCA9IDA7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICogQHBhcmFtIGNhbGxiYWNrCiAgICAgKi8KICAgIGxvYWQ6IGZ1bmN0aW9uIGxvYWQoY2FsbGJhY2spIHsKICAgICAgY2FsbGJhY2soKTsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuQ3JlZGVudGlhbHMuYWRkUHJvbWlzZXNUb0NsYXNzID0gZnVuY3Rpb24gYWRkUHJvbWlzZXNUb0NsYXNzKFByb21pc2VEZXBlbmRlbmN5KSB7CiAgICB0aGlzLnByb3RvdHlwZS5nZXRQcm9taXNlID0gQVdTLnV0aWwucHJvbWlzaWZ5TWV0aG9kKCdnZXQnLCBQcm9taXNlRGVwZW5kZW5jeSk7CiAgICB0aGlzLnByb3RvdHlwZS5yZWZyZXNoUHJvbWlzZSA9IEFXUy51dGlsLnByb21pc2lmeU1ldGhvZCgncmVmcmVzaCcsIFByb21pc2VEZXBlbmRlbmN5KTsKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5DcmVkZW50aWFscy5kZWxldGVQcm9taXNlc0Zyb21DbGFzcyA9IGZ1bmN0aW9uIGRlbGV0ZVByb21pc2VzRnJvbUNsYXNzKCkgewogICAgZGVsZXRlIHRoaXMucHJvdG90eXBlLmdldFByb21pc2U7CiAgICBkZWxldGUgdGhpcy5wcm90b3R5cGUucmVmcmVzaFByb21pc2U7CiAgfTsKICAKICBBV1MudXRpbC5hZGRQcm9taXNlcyhBV1MuQ3JlZGVudGlhbHMpOwogIAogIH0seyIuL2NvcmUiOjE4fV0sMjA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIFNUUyA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvc3RzJyk7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgcmV0cmlldmVkIGZyb20ge0FXUy5TVFN9LiBXaXRob3V0IGFueQogICAqIGV4dHJhIHBhcmFtZXRlcnMsIGNyZWRlbnRpYWxzIHdpbGwgYmUgZmV0Y2hlZCBmcm9tIHRoZQogICAqIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0gb3BlcmF0aW9uLiBJZiBhbiBJQU0gcm9sZSBpcyBwcm92aWRlZCwgdGhlCiAgICoge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3BlcmF0aW9uIHdpbGwgYmUgdXNlZCB0byBmZXRjaCBjcmVkZW50aWFscyBmb3IgdGhlCiAgICogcm9sZSBpbnN0ZWFkLgogICAqCiAgICogQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzIGRpZmZlcnMgZnJvbSBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgaW4KICAgKiB0aGUgd2F5IG1hc3RlckNyZWRlbnRpYWxzIGFuZCByZWZyZXNoZXMgYXJlIGhhbmRsZWQuCiAgICogQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzIHJlZnJlc2hlcyBleHBpcmVkIGNyZWRlbnRpYWxzIHVzaW5nIHRoZQogICAqIG1hc3RlckNyZWRlbnRpYWxzIHBhc3NlZCBieSB0aGUgdXNlciB0byBzdXBwb3J0IGNoYWluaW5nIG9mIFNUUyBjcmVkZW50aWFscy4KICAgKiBIb3dldmVyLCBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgcmVjdXJzaXZlbHkgY29sbGFwc2VzIHRoZSBtYXN0ZXJDcmVkZW50aWFscwogICAqIGR1cmluZyBpbnN0YW50aWF0aW9uLCBwcmVjbHVkaW5nIHRoZSBhYmlsaXR5IHRvIHJlZnJlc2ggY3JlZGVudGlhbHMgd2hpY2gKICAgKiByZXF1aXJlIGludGVybWVkaWF0ZSwgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLgogICAqCiAgICogRm9yIGV4YW1wbGUsIGlmIHRoZSBhcHBsaWNhdGlvbiBzaG91bGQgdXNlIFJvbGVBLCB3aGljaCBtdXN0IGJlIGFzc3VtZWQgZnJvbQogICAqIFJvbGVCLCBhbmQgdGhlIGVudmlyb25tZW50IHByb3ZpZGVzIGNyZWRlbnRpYWxzIHdoaWNoIGNhbiBhc3N1bWUgUm9sZUIsIHRoZW4KICAgKiBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgbXVzdCBiZSB1c2VkIHRvIHN1cHBvcnQgcmVmcmVzaGluZyB0aGUKICAgKiB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZm9yIFJvbGVBOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIHZhciByb2xlQUNyZWRzID0gbmV3IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyh7CiAgICogICBwYXJhbXM6IHtSb2xlQXJuOiAnUm9sZUEnfSwKICAgKiAgIG1hc3RlckNyZWRlbnRpYWxzOiBuZXcgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICAgKiAgICAgcGFyYW1zOiB7Um9sZUFybjogJ1JvbGVCJ30sCiAgICogICAgIG1hc3RlckNyZWRlbnRpYWxzOiBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FXUycpCiAgICogICB9KQogICAqIH0pOwogICAqIGBgYAogICAqCiAgICogSWYgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzIGhhZCBiZWVuIHVzZWQgaW4gdGhlIHByZXZpb3VzIGV4YW1wbGUsCiAgICogYHJvbGVBQ3JlZHNgIHdvdWxkIGZhaWwgdG8gcmVmcmVzaCBiZWNhdXNlIGByb2xlQUNyZWRzYCB3b3VsZAogICAqIHVzZSB0aGUgZW52aXJvbm1lbnQgY3JlZGVudGlhbHMgZm9yIHRoZSBBc3N1bWVSb2xlIHJlcXVlc3QuCiAgICoKICAgKiBBbm90aGVyIGRpZmZlcmVuY2UgaXMgdGhhdCBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgY3JlYXRlcyB0aGUgU1RTCiAgICogc2VydmljZSBpbnN0YW5jZSBkdXJpbmcgaW5zdGFudGlhdGlvbiB3aGlsZSBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgY3JlYXRlcwogICAqIHRoZSBTVFMgc2VydmljZSBpbnN0YW5jZSBkdXJpbmcgdGhlIGZpcnN0IHJlZnJlc2guIENyZWF0aW5nIHRoZSBzZXJ2aWNlCiAgICogaW5zdGFuY2UgZHVyaW5nIGluc3RhbnRpYXRpb24gZWZmZWN0aXZlbHkgY2FwdHVyZXMgdGhlIG1hc3RlciBjcmVkZW50aWFscwogICAqIGZyb20gdGhlIGdsb2JhbCBjb25maWcsIHNvIHRoYXQgc3Vic2VxdWVudCBjaGFuZ2VzIHRvIHRoZSBnbG9iYWwgY29uZmlnIGRvCiAgICogbm90IGFmZmVjdCB0aGUgbWFzdGVyIGNyZWRlbnRpYWxzIHVzZWQgdG8gcmVmcmVzaCB0aGUgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLgogICAqCiAgICogVGhpcyBhbGxvd3MgYW4gaW5zdGFuY2Ugb2YgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzIHRvIGJlIGFzc2lnbmVkCiAgICogdG8gQVdTLmNvbmZpZy5jcmVkZW50aWFsczoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiB2YXIgZW52Q3JlZHMgPSBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FXUycpOwogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBlbnZDcmVkczsKICAgKiAvLyBtYXN0ZXJDcmVkZW50aWFscyB3aWxsIGJlIGVudkNyZWRzCiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogICAqICAgcGFyYW1zOiB7Um9sZUFybjogJy4uLid9CiAgICogfSk7CiAgICogYGBgCiAgICoKICAgKiBTaW1pbGFybHksIHRvIHVzZSB0aGUgQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4ncyBkZWZhdWx0IHByb3ZpZGVycyBhcyB0aGUKICAgKiBtYXN0ZXIgY3JlZGVudGlhbHMsIHNpbXBseSBjcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YKICAgKiBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHM6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBDaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyh7CiAgICogICBwYXJhbXM6IHtSb2xlQXJuOiAnLi4uJ30KICAgKiB9KTsKICAgKiBgYGAKICAgKgogICAqIEAhYXR0cmlidXRlIHNlcnZpY2UKICAgKiAgIEByZXR1cm4gW0FXUy5TVFNdIHRoZSBTVFMgc2VydmljZSBpbnN0YW5jZSB1c2VkIHRvCiAgICogICAgIGdldCBhbmQgcmVmcmVzaCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZnJvbSBBV1MgU1RTLgogICAqIEBub3RlIChzZWUgY29uc3RydWN0b3IpCiAgICovCiAgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgb2JqZWN0LgogICAgICoKICAgICAqIEBwYXJhbSBvcHRpb25zIFttYXBdIGEgc2V0IG9mIG9wdGlvbnMKICAgICAqIEBvcHRpb24gb3B0aW9ucyBwYXJhbXMgW21hcF0gKHt9KSBhIG1hcCBvZiBvcHRpb25zIHRoYXQgYXJlIHBhc3NlZCB0byB0aGUKICAgICAqICAge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3Ige0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSBvcGVyYXRpb25zLgogICAgICogICBJZiBhIGBSb2xlQXJuYCBwYXJhbWV0ZXIgaXMgcGFzc2VkIGluLCBjcmVkZW50aWFscyB3aWxsIGJlIGJhc2VkIG9uIHRoZQogICAgICogICBJQU0gcm9sZS4gSWYgYSBgU2VyaWFsTnVtYmVyYCBwYXJhbWV0ZXIgaXMgcGFzc2VkIGluLCB7dG9rZW5Db2RlRm59IG11c3QKICAgICAqICAgYWxzbyBiZSBwYXNzZWQgaW4gb3IgYW4gZXJyb3Igd2lsbCBiZSB0aHJvd24uCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgbWFzdGVyQ3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gdGhlIG1hc3RlciBjcmVkZW50aWFscwogICAgICogICB1c2VkIHRvIGdldCBhbmQgcmVmcmVzaCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZnJvbSBBV1MgU1RTLiBCeSBkZWZhdWx0LAogICAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzIG9yIEFXUy5jb25maWcuY3JlZGVudGlhbFByb3ZpZGVyIHdpbGwgYmUgdXNlZC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyB0b2tlbkNvZGVGbiBbRnVuY3Rpb25dIChudWxsKSBGdW5jdGlvbiB0byBwcm92aWRlCiAgICAgKiAgIGBUb2tlbkNvZGVgLCBpZiBgU2VyaWFsTnVtYmVyYCBpcyBwcm92aWRlZCBmb3IgcHJvZmlsZSBpbiB7cGFyYW1zfS4gRnVuY3Rpb24KICAgICAqICAgaXMgY2FsbGVkIHdpdGggdmFsdWUgb2YgYFNlcmlhbE51bWJlcmAgYW5kIGBjYWxsYmFja2AsIGFuZCBzaG91bGQgcHJvdmlkZQogICAgICogICB0aGUgYFRva2VuQ29kZWAgb3IgYW4gZXJyb3IgdG8gdGhlIGNhbGxiYWNrIGluIHRoZSBmb3JtYXQKICAgICAqICAgYGNhbGxiYWNrKGVyciwgdG9rZW4pYC4KICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdCBmb3IgZ2VuZXJpYyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoKTsKICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdCBmb3IgYW4gSUFNIHJvbGUKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogICAgICogICAgIHBhcmFtczogewogICAgICogICAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvVGVtcG9yYXJ5Q3JlZGVudGlhbHMnCiAgICAgKiAgICAgfQogICAgICogICB9KTsKICAgICAqIEBzZWUgQVdTLlNUUy5hc3N1bWVSb2xlCiAgICAgKiBAc2VlIEFXUy5TVFMuZ2V0U2Vzc2lvblRva2VuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyhvcHRpb25zKSB7CiAgICAgIEFXUy5DcmVkZW50aWFscy5jYWxsKHRoaXMpOwogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgdGhpcy5lcnJvckNvZGUgPSAnQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHNQcm92aWRlckZhaWx1cmUnOwogICAgICB0aGlzLmV4cGlyZWQgPSB0cnVlOwogICAgICB0aGlzLnRva2VuQ29kZUZuID0gbnVsbDsKICAKICAgICAgdmFyIHBhcmFtcyA9IEFXUy51dGlsLmNvcHkob3B0aW9ucy5wYXJhbXMpIHx8IHt9OwogICAgICBpZiAocGFyYW1zLlJvbGVBcm4pIHsKICAgICAgICBwYXJhbXMuUm9sZVNlc3Npb25OYW1lID0gcGFyYW1zLlJvbGVTZXNzaW9uTmFtZSB8fCAndGVtcG9yYXJ5LWNyZWRlbnRpYWxzJzsKICAgICAgfQogICAgICBpZiAocGFyYW1zLlNlcmlhbE51bWJlcikgewogICAgICAgIGlmICghb3B0aW9ucy50b2tlbkNvZGVGbiB8fCAodHlwZW9mIG9wdGlvbnMudG9rZW5Db2RlRm4gIT09ICdmdW5jdGlvbicpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgQVdTLnV0aWwuZXJyb3IoCiAgICAgICAgICAgIG5ldyBFcnJvcigndG9rZW5Db2RlRm4gbXVzdCBiZSBhIGZ1bmN0aW9uIHdoZW4gcGFyYW1zLlNlcmlhbE51bWJlciBpcyBnaXZlbicpLAogICAgICAgICAgICB7Y29kZTogdGhpcy5lcnJvckNvZGV9CiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnRva2VuQ29kZUZuID0gb3B0aW9ucy50b2tlbkNvZGVGbjsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIGNvbmZpZyA9IEFXUy51dGlsLm1lcmdlKAogICAgICAgIHsKICAgICAgICAgIHBhcmFtczogcGFyYW1zLAogICAgICAgICAgY3JlZGVudGlhbHM6IG9wdGlvbnMubWFzdGVyQ3JlZGVudGlhbHMgfHwgQVdTLmNvbmZpZy5jcmVkZW50aWFscwogICAgICAgIH0sCiAgICAgICAgb3B0aW9ucy5zdHNDb25maWcgfHwge30KICAgICAgKTsKICAgICAgdGhpcy5zZXJ2aWNlID0gbmV3IFNUUyhjb25maWcpOwogICAgfSwKICAKICAgIC8qKgogICAgICogUmVmcmVzaGVzIGNyZWRlbnRpYWxzIHVzaW5nIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9yCiAgICAgKiB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59LCBkZXBlbmRpbmcgb24gd2hldGhlciBhbiBJQU0gcm9sZSBBUk4gd2FzIHBhc3NlZAogICAgICogdG8gdGhlIGNyZWRlbnRpYWxzIHtjb25zdHJ1Y3Rvcn0uCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgQ2FsbGVkIHdoZW4gdGhlIFNUUyBzZXJ2aWNlIHJlc3BvbmRzIChvciBmYWlscykuIFdoZW4KICAgICAqICAgdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgdGhhdCB0aGUgY3JlZGVudGlhbHMKICAgICAqICAgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsCiAgICAgKiAgIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogQHNlZSBBV1MuQ3JlZGVudGlhbHMuZ2V0CiAgICAgKi8KICAgIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2goY2FsbGJhY2spIHsKICAgICAgdGhpcy5jb2FsZXNjZVJlZnJlc2goY2FsbGJhY2sgfHwgQVdTLnV0aWwuZm4uY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgICAqLwogICAgbG9hZDogZnVuY3Rpb24gbG9hZChjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBvcGVyYXRpb24gPSBzZWxmLnNlcnZpY2UuY29uZmlnLnBhcmFtcy5Sb2xlQXJuID8gJ2Fzc3VtZVJvbGUnIDogJ2dldFNlc3Npb25Ub2tlbic7CiAgICAgIHRoaXMuZ2V0VG9rZW5Db2RlKGZ1bmN0aW9uIChlcnIsIHRva2VuQ29kZSkgewogICAgICAgIHZhciBwYXJhbXMgPSB7fTsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodG9rZW5Db2RlKSB7CiAgICAgICAgICBwYXJhbXMuVG9rZW5Db2RlID0gdG9rZW5Db2RlOwogICAgICAgIH0KICAgICAgICBzZWxmLnNlcnZpY2Vbb3BlcmF0aW9uXShwYXJhbXMsIGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICAgIHNlbGYuc2VydmljZS5jcmVkZW50aWFsc0Zyb20oZGF0YSwgc2VsZik7CiAgICAgICAgICB9CiAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRUb2tlbkNvZGU6IGZ1bmN0aW9uIGdldFRva2VuQ29kZShjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmICh0aGlzLnRva2VuQ29kZUZuKSB7CiAgICAgICAgdGhpcy50b2tlbkNvZGVGbih0aGlzLnNlcnZpY2UuY29uZmlnLnBhcmFtcy5TZXJpYWxOdW1iZXIsIGZ1bmN0aW9uIChlcnIsIHRva2VuKSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gZXJyOwogICAgICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICAgICAgICBtZXNzYWdlID0gZXJyLm1lc3NhZ2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FsbGJhY2soCiAgICAgICAgICAgICAgQVdTLnV0aWwuZXJyb3IoCiAgICAgICAgICAgICAgICBuZXcgRXJyb3IoJ0Vycm9yIGZldGNoaW5nIE1GQSB0b2tlbjogJyArIG1lc3NhZ2UpLAogICAgICAgICAgICAgICAgeyBjb2RlOiBzZWxmLmVycm9yQ29kZX0KICAgICAgICAgICAgICApCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHRva2VuKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFjayhudWxsKTsKICAgICAgfQogICAgfQogIH0pOwogIAogIH0seyIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTh9XSwyMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgQ29nbml0b0lkZW50aXR5ID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9jb2duaXRvaWRlbnRpdHknKTsKICB2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIGNyZWRlbnRpYWxzIHJldHJpZXZlZCBmcm9tIFNUUyBXZWIgSWRlbnRpdHkgRmVkZXJhdGlvbiB1c2luZwogICAqIHRoZSBBbWF6b24gQ29nbml0byBJZGVudGl0eSBzZXJ2aWNlLgogICAqCiAgICogQnkgZGVmYXVsdCB0aGlzIHByb3ZpZGVyIGdldHMgY3JlZGVudGlhbHMgdXNpbmcgdGhlCiAgICoge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eX0gc2VydmljZSBvcGVyYXRpb24sIHdoaWNoCiAgICogcmVxdWlyZXMgZWl0aGVyIGFuIGBJZGVudGl0eUlkYCBvciBhbiBgSWRlbnRpdHlQb29sSWRgIChBbWF6b24gQ29nbml0bwogICAqIElkZW50aXR5IFBvb2wgSUQpLCB3aGljaCBpcyB1c2VkIHRvIGNhbGwge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0SWR9IHRvCiAgICogb2J0YWluIGFuIGBJZGVudGl0eUlkYC4gSWYgdGhlIGlkZW50aXR5IG9yIGlkZW50aXR5IHBvb2wgaXMgbm90IGNvbmZpZ3VyZWQgaW4KICAgKiB0aGUgQW1hem9uIENvZ25pdG8gQ29uc29sZSB0byB1c2UgSUFNIHJvbGVzIHdpdGggdGhlIGFwcHJvcHJpYXRlIHBlcm1pc3Npb25zLAogICAqIHRoZW4gYWRkaXRpb25hbGx5IGEgYFJvbGVBcm5gIGlzIHJlcXVpcmVkIGNvbnRhaW5pbmcgdGhlIEFSTiBvZiB0aGUgSUFNIHRydXN0CiAgICogcG9saWN5IGZvciB0aGUgQW1hem9uIENvZ25pdG8gcm9sZSB0aGF0IHRoZSB1c2VyIHdpbGwgbG9nIGludG8uIElmIGEgYFJvbGVBcm5gCiAgICogaXMgcHJvdmlkZWQsIHRoZW4gdGhpcyBwcm92aWRlciBnZXRzIGNyZWRlbnRpYWxzIHVzaW5nIHRoZQogICAqIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9IHNlcnZpY2Ugb3BlcmF0aW9uLCBhZnRlciBmaXJzdCBnZXR0aW5nIGFuCiAgICogT3BlbiBJRCB0b2tlbiBmcm9tIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldE9wZW5JZFRva2VufS4KICAgKgogICAqIEluIGFkZGl0aW9uLCBpZiB0aGlzIGNyZWRlbnRpYWwgcHJvdmlkZXIgaXMgdXNlZCB0byBwcm92aWRlIGF1dGhlbnRpY2F0ZWQKICAgKiBsb2dpbiwgdGhlIGBMb2dpbnNgIG1hcCBtYXkgYmUgc2V0IHRvIHRoZSB0b2tlbnMgcHJvdmlkZWQgYnkgdGhlIHJlc3BlY3RpdmUKICAgKiBpZGVudGl0eSBwcm92aWRlcnMuIFNlZSB7Y29uc3RydWN0b3J9IGZvciBhbiBleGFtcGxlIG9uIGNyZWF0aW5nIGEgY3JlZGVudGlhbHMKICAgKiBvYmplY3Qgd2l0aCBwcm9wZXIgcHJvcGVydHkgdmFsdWVzLgogICAqCiAgICogIyMgUmVmcmVzaGluZyBDcmVkZW50aWFscyBmcm9tIElkZW50aXR5IFNlcnZpY2UKICAgKgogICAqIEluIGFkZGl0aW9uIHRvIEFXUyBjcmVkZW50aWFscyBleHBpcmluZyBhZnRlciBhIGdpdmVuIGFtb3VudCBvZiB0aW1lLCB0aGUKICAgKiBsb2dpbiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlciB3aWxsIGFsc28gZXhwaXJlLiBPbmNlIHRoaXMgdG9rZW4KICAgKiBleHBpcmVzLCBpdCB3aWxsIG5vdCBiZSB1c2FibGUgdG8gcmVmcmVzaCBBV1MgY3JlZGVudGlhbHMsIGFuZCBhbm90aGVyCiAgICogdG9rZW4gd2lsbCBiZSBuZWVkZWQuIFRoZSBTREsgZG9lcyBub3QgbWFuYWdlIHJlZnJlc2hpbmcgb2YgdGhlIHRva2VuIHZhbHVlLAogICAqIGJ1dCB0aGlzIGNhbiBiZSBkb25lIHRocm91Z2ggYSAicmVmcmVzaCB0b2tlbiIgc3VwcG9ydGVkIGJ5IG1vc3QgaWRlbnRpdHkKICAgKiBwcm92aWRlcnMuIENvbnN1bHQgdGhlIGRvY3VtZW50YXRpb24gZm9yIHRoZSBpZGVudGl0eSBwcm92aWRlciBmb3IgcmVmcmVzaGluZwogICAqIHRva2Vucy4gT25jZSB0aGUgcmVmcmVzaGVkIHRva2VuIGlzIGFjcXVpcmVkLCB5b3Ugc2hvdWxkIG1ha2Ugc3VyZSB0byB1cGRhdGUKICAgKiB0aGlzIG5ldyB0b2tlbiBpbiB0aGUgY3JlZGVudGlhbHMgb2JqZWN0J3Mge3BhcmFtc30gcHJvcGVydHkuIFRoZSBmb2xsb3dpbmcKICAgKiBjb2RlIHdpbGwgdXBkYXRlIHRoZSBXZWJJZGVudGl0eVRva2VuLCBhc3N1bWluZyB5b3UgaGF2ZSByZXRyaWV2ZWQgYW4gdXBkYXRlZAogICAqIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMucGFyYW1zLkxvZ2luc1snZ3JhcGguZmFjZWJvb2suY29tJ10gPSB1cGRhdGVkVG9rZW47CiAgICogYGBgCiAgICoKICAgKiBGdXR1cmUgY2FsbHMgdG8gYGNyZWRlbnRpYWxzLnJlZnJlc2goKWAgd2lsbCBub3cgdXNlIHRoZSBuZXcgdG9rZW4uCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBwYXJhbXMKICAgKiAgIEByZXR1cm4gW21hcF0gdGhlIG1hcCBvZiBwYXJhbXMgcGFzc2VkIHRvCiAgICogICAgIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldElkfSwKICAgKiAgICAge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0T3BlbklkVG9rZW59LCBhbmQKICAgKiAgICAge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uIFRvIHVwZGF0ZSB0aGUgdG9rZW4sIHNldCB0aGUKICAgKiAgICAgYHBhcmFtcy5XZWJJZGVudGl0eVRva2VuYCBwcm9wZXJ0eS4KICAgKiBAIWF0dHJpYnV0ZSBkYXRhCiAgICogICBAcmV0dXJuIFttYXBdIHRoZSByYXcgZGF0YSByZXNwb25zZSBmcm9tIHRoZSBjYWxsIHRvCiAgICogICAgIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHl9LCBvcgogICAqICAgICB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4gVXNlIHRoaXMgaWYgeW91IHdhbnQgdG8gZ2V0CiAgICogICAgIGFjY2VzcyB0byBvdGhlciBwcm9wZXJ0aWVzIGZyb20gdGhlIHJlc3BvbnNlLgogICAqIEAhYXR0cmlidXRlIGlkZW50aXR5SWQKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIENvZ25pdG8gSUQgcmV0dXJuZWQgYnkgdGhlIGxhc3QgY2FsbCB0bwogICAqICAgICB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRPcGVuSWRUb2tlbn0uIFRoaXMgSUQgcmVwcmVzZW50cyB0aGUgYWN0dWFsCiAgICogICAgIGZpbmFsIHJlc29sdmVkIGlkZW50aXR5IElEIGZyb20gQW1hem9uIENvZ25pdG8uCiAgICovCiAgQVdTLkNvZ25pdG9JZGVudGl0eUNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxvY2FsU3RvcmFnZUtleTogewogICAgICBpZDogJ2F3cy5jb2duaXRvLmlkZW50aXR5LWlkLicsCiAgICAgIHByb3ZpZGVyczogJ2F3cy5jb2duaXRvLmlkZW50aXR5LXByb3ZpZGVycy4nCiAgICB9LAogIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdC4KICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdAogICAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5Db2duaXRvSWRlbnRpdHlDcmVkZW50aWFscyh7CiAgICAgKgogICAgICogICAgIC8vIGVpdGhlciBJZGVudGl0eVBvb2xJZCBvciBJZGVudGl0eUlkIGlzIHJlcXVpcmVkCiAgICAgKiAgICAgLy8gU2VlIHRoZSBJZGVudGl0eVBvb2xJZCBwYXJhbSBmb3IgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRJRCAobGlua2VkIGJlbG93KQogICAgICogICAgIC8vIFNlZSB0aGUgSWRlbnRpdHlJZCBwYXJhbSBmb3IgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5CiAgICAgKiAgICAgLy8gb3IgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRPcGVuSWRUb2tlbiAobGlua2VkIGJlbG93KQogICAgICogICAgIElkZW50aXR5UG9vbElkOiAndXMtZWFzdC0xOjE2OTllYmMwLTc5MDAtNDA5OS1iOTEwLTJkZjk0ZjUyYTAzMCcsCiAgICAgKiAgICAgSWRlbnRpdHlJZDogJ3VzLWVhc3QtMToxMjhkMGE3NC1jODJmLTQ1NTMtOTE2ZC05MDA1M2U0YThiMGYnCiAgICAgKgogICAgICogICAgIC8vIG9wdGlvbmFsLCBvbmx5IG5lY2Vzc2FyeSB3aGVuIHRoZSBpZGVudGl0eSBwb29sIGlzIG5vdCBjb25maWd1cmVkCiAgICAgKiAgICAgLy8gdG8gdXNlIElBTSByb2xlcyBpbiB0aGUgQW1hem9uIENvZ25pdG8gQ29uc29sZQogICAgICogICAgIC8vIFNlZSB0aGUgUm9sZUFybiBwYXJhbSBmb3IgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5IChsaW5rZWQgYmVsb3cpCiAgICAgKiAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvTVlBUFAtQ29nbml0b0lkZW50aXR5JywKICAgICAqCiAgICAgKiAgICAgLy8gb3B0aW9uYWwgdG9rZW5zLCB1c2VkIGZvciBhdXRoZW50aWNhdGVkIGxvZ2luCiAgICAgKiAgICAgLy8gU2VlIHRoZSBMb2dpbnMgcGFyYW0gZm9yIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0SUQgKGxpbmtlZCBiZWxvdykKICAgICAqICAgICBMb2dpbnM6IHsKICAgICAqICAgICAgICdncmFwaC5mYWNlYm9vay5jb20nOiAnRkJUT0tFTicsCiAgICAgKiAgICAgICAnd3d3LmFtYXpvbi5jb20nOiAnQU1BWk9OVE9LRU4nLAogICAgICogICAgICAgJ2FjY291bnRzLmdvb2dsZS5jb20nOiAnR09PR0xFVE9LRU4nLAogICAgICogICAgICAgJ2FwaS50d2l0dGVyLmNvbSc6ICdUV0lUVEVSVE9LRU4nLAogICAgICogICAgICAgJ3d3dy5kaWdpdHMuY29tJzogJ0RJR0lUU1RPS0VOJwogICAgICogICAgIH0sCiAgICAgKgogICAgICogICAgIC8vIG9wdGlvbmFsIG5hbWUsIGRlZmF1bHRzIHRvIHdlYi1pZGVudGl0eQogICAgICogICAgIC8vIFNlZSB0aGUgUm9sZVNlc3Npb25OYW1lIHBhcmFtIGZvciBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkgKGxpbmtlZCBiZWxvdykKICAgICAqICAgICBSb2xlU2Vzc2lvbk5hbWU6ICd3ZWInLAogICAgICoKICAgICAqICAgICAvLyBvcHRpb25hbCwgb25seSBuZWNlc3Nhcnkgd2hlbiBhcHBsaWNhdGlvbiBydW5zIGluIGEgYnJvd3NlcgogICAgICogICAgIC8vIGFuZCBtdWx0aXBsZSB1c2VycyBhcmUgc2lnbmVkIGluIGF0IG9uY2UsIHVzZWQgZm9yIGNhY2hpbmcKICAgICAqICAgICBMb2dpbklkOiAnZXhhbXBsZUBnbWFpbC5jb20nCiAgICAgKgogICAgICogICB9LCB7CiAgICAgKiAgICAgIC8vIG9wdGlvbmFsbHkgcHJvdmlkZSBjb25maWd1cmF0aW9uIHRvIGFwcGx5IHRvIHRoZSB1bmRlcmx5aW5nIHNlcnZpY2UgY2xpZW50cwogICAgICogICAgICAvLyBpZiBjb25maWd1cmF0aW9uIGlzIG5vdCBwcm92aWRlZCwgdGhlbiBjb25maWd1cmF0aW9uIHdpbGwgYmUgcHVsbGVkIGZyb20gQVdTLmNvbmZpZwogICAgICoKICAgICAqICAgICAgLy8gcmVnaW9uIHNob3VsZCBtYXRjaCB0aGUgcmVnaW9uIHlvdXIgaWRlbnRpdHkgcG9vbCBpcyBsb2NhdGVkIGluCiAgICAgKiAgICAgIHJlZ2lvbjogJ3VzLWVhc3QtMScsCiAgICAgKgogICAgICogICAgICAvLyBzcGVjaWZ5IHRpbWVvdXQgb3B0aW9ucwogICAgICogICAgICBodHRwT3B0aW9uczogewogICAgICogICAgICAgIHRpbWVvdXQ6IDEwMAogICAgICogICAgICB9CiAgICAgKiAgIH0pOwogICAgICogQHNlZSBBV1MuQ29nbml0b0lkZW50aXR5LmdldElkCiAgICAgKiBAc2VlIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eQogICAgICogQHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkKICAgICAqIEBzZWUgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRPcGVuSWRUb2tlbgogICAgICogQHNlZSBBV1MuQ29uZmlnCiAgICAgKiBAbm90ZSBJZiBhIHJlZ2lvbiBpcyBub3QgcHJvdmlkZWQgaW4gdGhlIGdsb2JhbCBBV1MuY29uZmlnLCBvcgogICAgICogICBzcGVjaWZpZWQgaW4gdGhlIGBjbGllbnRDb25maWdgIHRvIHRoZSBDb2duaXRvSWRlbnRpdHlDcmVkZW50aWFscwogICAgICogICBjb25zdHJ1Y3RvciwgeW91IG1heSBlbmNvdW50ZXIgYSAnTWlzc2luZyBjcmVkZW50aWFscyBpbiBjb25maWcnIGVycm9yCiAgICAgKiAgIHdoZW4gY2FsbGluZyBtYWtpbmcgYSBzZXJ2aWNlIGNhbGwuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDb2duaXRvSWRlbnRpdHlDcmVkZW50aWFscyhwYXJhbXMsIGNsaWVudENvbmZpZykgewogICAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKICAgICAgdGhpcy5wYXJhbXMgPSBwYXJhbXM7CiAgICAgIHRoaXMuZGF0YSA9IG51bGw7CiAgICAgIHRoaXMuX2lkZW50aXR5SWQgPSBudWxsOwogICAgICB0aGlzLl9jbGllbnRDb25maWcgPSBBV1MudXRpbC5jb3B5KGNsaWVudENvbmZpZyB8fCB7fSk7CiAgICAgIHRoaXMubG9hZENhY2hlZElkKCk7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdpZGVudGl0eUlkJywgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICBzZWxmLmxvYWRDYWNoZWRJZCgpOwogICAgICAgICAgcmV0dXJuIHNlbGYuX2lkZW50aXR5SWQgfHwgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZDsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24oaWRlbnRpdHlJZCkgewogICAgICAgICAgc2VsZi5faWRlbnRpdHlJZCA9IGlkZW50aXR5SWQ7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFJlZnJlc2hlcyBjcmVkZW50aWFscyB1c2luZyB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5fSwKICAgICAqIG9yIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIENhbGxlZCB3aGVuIHRoZSBTVFMgc2VydmljZSByZXNwb25kcyAob3IgZmFpbHMpLiBXaGVuCiAgICAgKiAgIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHRoYXQgdGhlIGNyZWRlbnRpYWxzCiAgICAgKiAgIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLAogICAgICogICBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqIEBzZWUgQVdTLkNyZWRlbnRpYWxzLmdldAogICAgICovCiAgICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrIHx8IEFXUy51dGlsLmZuLmNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICogQHBhcmFtIGNhbGxiYWNrCiAgICAgKi8KICAgIGxvYWQ6IGZ1bmN0aW9uIGxvYWQoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzZWxmLmNyZWF0ZUNsaWVudHMoKTsKICAgICAgc2VsZi5kYXRhID0gbnVsbDsKICAgICAgc2VsZi5faWRlbnRpdHlJZCA9IG51bGw7CiAgICAgIHNlbGYuZ2V0SWQoZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgIGlmICghc2VsZi5wYXJhbXMuUm9sZUFybikgewogICAgICAgICAgICBzZWxmLmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkoY2FsbGJhY2spOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZi5nZXRDcmVkZW50aWFsc0Zyb21TVFMoY2FsbGJhY2spOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxmLmNsZWFySWRPbk5vdEF1dGhvcml6ZWQoZXJyKTsKICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIENsZWFycyB0aGUgY2FjaGVkIENvZ25pdG8gSUQgYXNzb2NpYXRlZCB3aXRoIHRoZSBjdXJyZW50bHkgY29uZmlndXJlZAogICAgICogaWRlbnRpdHkgcG9vbCBJRC4gVXNlIHRoaXMgdG8gbWFudWFsbHkgaW52YWxpZGF0ZSB5b3VyIGNhY2hlIGlmCiAgICAgKiB0aGUgaWRlbnRpdHkgcG9vbCBJRCB3YXMgZGVsZXRlZC4KICAgICAqLwogICAgY2xlYXJDYWNoZWRJZDogZnVuY3Rpb24gY2xlYXJDYWNoZSgpIHsKICAgICAgdGhpcy5faWRlbnRpdHlJZCA9IG51bGw7CiAgICAgIGRlbGV0ZSB0aGlzLnBhcmFtcy5JZGVudGl0eUlkOwogIAogICAgICB2YXIgcG9vbElkID0gdGhpcy5wYXJhbXMuSWRlbnRpdHlQb29sSWQ7CiAgICAgIHZhciBsb2dpbklkID0gdGhpcy5wYXJhbXMuTG9naW5JZCB8fCAnJzsKICAgICAgZGVsZXRlIHRoaXMuc3RvcmFnZVt0aGlzLmxvY2FsU3RvcmFnZUtleS5pZCArIHBvb2xJZCArIGxvZ2luSWRdOwogICAgICBkZWxldGUgdGhpcy5zdG9yYWdlW3RoaXMubG9jYWxTdG9yYWdlS2V5LnByb3ZpZGVycyArIHBvb2xJZCArIGxvZ2luSWRdOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNsZWFySWRPbk5vdEF1dGhvcml6ZWQ6IGZ1bmN0aW9uIGNsZWFySWRPbk5vdEF1dGhvcml6ZWQoZXJyKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgaWYgKGVyci5jb2RlID09ICdOb3RBdXRob3JpemVkRXhjZXB0aW9uJykgewogICAgICAgIHNlbGYuY2xlYXJDYWNoZWRJZCgpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBSZXRyaWV2ZXMgYSBDb2duaXRvIElELCBsb2FkaW5nIGZyb20gY2FjaGUgaWYgaXQgd2FzIGFscmVhZHkgcmV0cmlldmVkCiAgICAgKiBvbiB0aGlzIGRldmljZS4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBpZGVudGl0eUlkKQogICAgICogICBAcGFyYW0gZXJyIFtFcnJvciwgbnVsbF0gYW4gZXJyb3Igb2JqZWN0IGlmIHRoZSBjYWxsIGZhaWxlZCBvciBudWxsIGlmCiAgICAgKiAgICAgaXQgc3VjY2VlZGVkLgogICAgICogICBAcGFyYW0gaWRlbnRpdHlJZCBbU3RyaW5nLCBudWxsXSBpZiBzdWNjZXNzZnVsLCB0aGUgY2FsbGJhY2sgd2lsbCByZXR1cm4KICAgICAqICAgICB0aGUgQ29nbml0byBJRC4KICAgICAqIEBub3RlIElmIG5vdCBsb2FkZWQgZXhwbGljaXRseSwgdGhlIENvZ25pdG8gSUQgaXMgbG9hZGVkIGFuZCBzdG9yZWQgaW4KICAgICAqICAgbG9jYWxTdG9yYWdlIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50IG9mIGEgZGV2aWNlLgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldElkOiBmdW5jdGlvbiBnZXRJZChjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmICh0eXBlb2Ygc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCA9PT0gJ3N0cmluZycpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCk7CiAgICAgIH0KICAKICAgICAgc2VsZi5jb2duaXRvLmdldElkKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgIGlmICghZXJyICYmIGRhdGEuSWRlbnRpdHlJZCkgewogICAgICAgICAgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCA9IGRhdGEuSWRlbnRpdHlJZDsKICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGRhdGEuSWRlbnRpdHlJZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkQ3JlZGVudGlhbHM6IGZ1bmN0aW9uIGxvYWRDcmVkZW50aWFscyhkYXRhLCBjcmVkZW50aWFscykgewogICAgICBpZiAoIWRhdGEgfHwgIWNyZWRlbnRpYWxzKSByZXR1cm47CiAgICAgIGNyZWRlbnRpYWxzLmV4cGlyZWQgPSBmYWxzZTsKICAgICAgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgPSBkYXRhLkNyZWRlbnRpYWxzLkFjY2Vzc0tleUlkOwogICAgICBjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXkgPSBkYXRhLkNyZWRlbnRpYWxzLlNlY3JldEtleTsKICAgICAgY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuID0gZGF0YS5DcmVkZW50aWFscy5TZXNzaW9uVG9rZW47CiAgICAgIGNyZWRlbnRpYWxzLmV4cGlyZVRpbWUgPSBkYXRhLkNyZWRlbnRpYWxzLkV4cGlyYXRpb247CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eTogZnVuY3Rpb24gZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eShjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHNlbGYuY29nbml0by5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5KGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICBzZWxmLmNhY2hlSWQoZGF0YSk7CiAgICAgICAgICBzZWxmLmRhdGEgPSBkYXRhOwogICAgICAgICAgc2VsZi5sb2FkQ3JlZGVudGlhbHMoc2VsZi5kYXRhLCBzZWxmKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5jbGVhcklkT25Ob3RBdXRob3JpemVkKGVycik7CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldENyZWRlbnRpYWxzRnJvbVNUUzogZnVuY3Rpb24gZ2V0Q3JlZGVudGlhbHNGcm9tU1RTKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgc2VsZi5jb2duaXRvLmdldE9wZW5JZFRva2VuKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICBzZWxmLmNhY2hlSWQoZGF0YSk7CiAgICAgICAgICBzZWxmLnBhcmFtcy5XZWJJZGVudGl0eVRva2VuID0gZGF0YS5Ub2tlbjsKICAgICAgICAgIHNlbGYud2ViSWRlbnRpdHlDcmVkZW50aWFscy5yZWZyZXNoKGZ1bmN0aW9uKHdlYkVycikgewogICAgICAgICAgICBpZiAoIXdlYkVycikgewogICAgICAgICAgICAgIHNlbGYuZGF0YSA9IHNlbGYud2ViSWRlbnRpdHlDcmVkZW50aWFscy5kYXRhOwogICAgICAgICAgICAgIHNlbGYuc3RzLmNyZWRlbnRpYWxzRnJvbShzZWxmLmRhdGEsIHNlbGYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbGxiYWNrKHdlYkVycik7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5jbGVhcklkT25Ob3RBdXRob3JpemVkKGVycik7CiAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZENhY2hlZElkOiBmdW5jdGlvbiBsb2FkQ2FjaGVkSWQoKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAKICAgICAgLy8gaW4gdGhlIGJyb3dzZXIgd2Ugc291cmNlIGRlZmF1bHQgSWRlbnRpdHlJZCBmcm9tIGxvY2FsU3RvcmFnZQogICAgICBpZiAoQVdTLnV0aWwuaXNCcm93c2VyKCkgJiYgIXNlbGYucGFyYW1zLklkZW50aXR5SWQpIHsKICAgICAgICB2YXIgaWQgPSBzZWxmLmdldFN0b3JhZ2UoJ2lkJyk7CiAgICAgICAgaWYgKGlkICYmIHNlbGYucGFyYW1zLkxvZ2lucykgewogICAgICAgICAgdmFyIGFjdHVhbFByb3ZpZGVycyA9IE9iamVjdC5rZXlzKHNlbGYucGFyYW1zLkxvZ2lucyk7CiAgICAgICAgICB2YXIgY2FjaGVkUHJvdmlkZXJzID0KICAgICAgICAgICAgKHNlbGYuZ2V0U3RvcmFnZSgncHJvdmlkZXJzJykgfHwgJycpLnNwbGl0KCcsJyk7CiAgCiAgICAgICAgICAvLyBvbmx5IGxvYWQgSUQgaWYgYXQgbGVhc3Qgb25lIHByb3ZpZGVyIHVzZWQgdGhpcyBJRCBiZWZvcmUKICAgICAgICAgIHZhciBpbnRlcnNlY3QgPSBjYWNoZWRQcm92aWRlcnMuZmlsdGVyKGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgcmV0dXJuIGFjdHVhbFByb3ZpZGVycy5pbmRleE9mKG4pICE9PSAtMTsKICAgICAgICAgIH0pOwogICAgICAgICAgaWYgKGludGVyc2VjdC5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCA9IGlkOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoaWQpIHsKICAgICAgICAgIHNlbGYucGFyYW1zLklkZW50aXR5SWQgPSBpZDsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjcmVhdGVDbGllbnRzOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNsaWVudENvbmZpZyA9IHRoaXMuX2NsaWVudENvbmZpZzsKICAgICAgdGhpcy53ZWJJZGVudGl0eUNyZWRlbnRpYWxzID0gdGhpcy53ZWJJZGVudGl0eUNyZWRlbnRpYWxzIHx8CiAgICAgICAgbmV3IEFXUy5XZWJJZGVudGl0eUNyZWRlbnRpYWxzKHRoaXMucGFyYW1zLCBjbGllbnRDb25maWcpOwogICAgICBpZiAoIXRoaXMuY29nbml0bykgewogICAgICAgIHZhciBjb2duaXRvQ29uZmlnID0gQVdTLnV0aWwubWVyZ2Uoe30sIGNsaWVudENvbmZpZyk7CiAgICAgICAgY29nbml0b0NvbmZpZy5wYXJhbXMgPSB0aGlzLnBhcmFtczsKICAgICAgICB0aGlzLmNvZ25pdG8gPSBuZXcgQ29nbml0b0lkZW50aXR5KGNvZ25pdG9Db25maWcpOwogICAgICB9CiAgICAgIHRoaXMuc3RzID0gdGhpcy5zdHMgfHwgbmV3IFNUUyhjbGllbnRDb25maWcpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNhY2hlSWQ6IGZ1bmN0aW9uIGNhY2hlSWQoZGF0YSkgewogICAgICB0aGlzLl9pZGVudGl0eUlkID0gZGF0YS5JZGVudGl0eUlkOwogICAgICB0aGlzLnBhcmFtcy5JZGVudGl0eUlkID0gdGhpcy5faWRlbnRpdHlJZDsKICAKICAgICAgLy8gY2FjaGUgdGhpcyBJZGVudGl0eUlkIGluIGJyb3dzZXIgbG9jYWxTdG9yYWdlIGlmIHBvc3NpYmxlCiAgICAgIGlmIChBV1MudXRpbC5pc0Jyb3dzZXIoKSkgewogICAgICAgIHRoaXMuc2V0U3RvcmFnZSgnaWQnLCBkYXRhLklkZW50aXR5SWQpOwogIAogICAgICAgIGlmICh0aGlzLnBhcmFtcy5Mb2dpbnMpIHsKICAgICAgICAgIHRoaXMuc2V0U3RvcmFnZSgncHJvdmlkZXJzJywgT2JqZWN0LmtleXModGhpcy5wYXJhbXMuTG9naW5zKS5qb2luKCcsJykpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldFN0b3JhZ2U6IGZ1bmN0aW9uIGdldFN0b3JhZ2Uoa2V5KSB7CiAgICAgIHJldHVybiB0aGlzLnN0b3JhZ2VbdGhpcy5sb2NhbFN0b3JhZ2VLZXlba2V5XSArIHRoaXMucGFyYW1zLklkZW50aXR5UG9vbElkICsgKHRoaXMucGFyYW1zLkxvZ2luSWQgfHwgJycpXTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzZXRTdG9yYWdlOiBmdW5jdGlvbiBzZXRTdG9yYWdlKGtleSwgdmFsKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdGhpcy5zdG9yYWdlW3RoaXMubG9jYWxTdG9yYWdlS2V5W2tleV0gKyB0aGlzLnBhcmFtcy5JZGVudGl0eVBvb2xJZCArICh0aGlzLnBhcmFtcy5Mb2dpbklkIHx8ICcnKV0gPSB2YWw7CiAgICAgIH0gY2F0Y2ggKF8pIHt9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc3RvcmFnZTogKGZ1bmN0aW9uKCkgewogICAgICB0cnkgewogICAgICAgIHZhciBzdG9yYWdlID0gQVdTLnV0aWwuaXNCcm93c2VyKCkgJiYgd2luZG93LmxvY2FsU3RvcmFnZSAhPT0gbnVsbCAmJiB0eXBlb2Ygd2luZG93LmxvY2FsU3RvcmFnZSA9PT0gJ29iamVjdCcgPwogICAgICAgICAgICB3aW5kb3cubG9jYWxTdG9yYWdlIDoge307CiAgCiAgICAgICAgLy8gVGVzdCBzZXQvcmVtb3ZlIHdoaWNoIHdvdWxkIHRocm93IGFuIGVycm9yIGluIFNhZmFyaSdzIHByaXZhdGUgYnJvd3NpbmcKICAgICAgICBzdG9yYWdlWydhd3MudGVzdC1zdG9yYWdlJ10gPSAnZm9vYmFyJzsKICAgICAgICBkZWxldGUgc3RvcmFnZVsnYXdzLnRlc3Qtc3RvcmFnZSddOwogIAogICAgICAgIHJldHVybiBzdG9yYWdlOwogICAgICB9IGNhdGNoIChfKSB7CiAgICAgICAgcmV0dXJuIHt9OwogICAgICB9CiAgICB9KSgpCiAgfSk7CiAgCiAgfSx7Ii4uLy4uL2NsaWVudHMvY29nbml0b2lkZW50aXR5Ijo3LCIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTh9XSwyMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICAKICAvKioKICAgKiBDcmVhdGVzIGEgY3JlZGVudGlhbCBwcm92aWRlciBjaGFpbiB0aGF0IHNlYXJjaGVzIGZvciBBV1MgY3JlZGVudGlhbHMKICAgKiBpbiBhIGxpc3Qgb2YgY3JlZGVudGlhbCBwcm92aWRlcnMgc3BlY2lmaWVkIGJ5IHRoZSB7cHJvdmlkZXJzfSBwcm9wZXJ0eS4KICAgKgogICAqIEJ5IGRlZmF1bHQsIHRoZSBjaGFpbiB3aWxsIHVzZSB0aGUge2RlZmF1bHRQcm92aWRlcnN9IHRvIHJlc29sdmUgY3JlZGVudGlhbHMuCiAgICogVGhlc2UgcHJvdmlkZXJzIHdpbGwgbG9vayBpbiB0aGUgZW52aXJvbm1lbnQgdXNpbmcgdGhlCiAgICoge0FXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzfSBjbGFzcyB3aXRoIHRoZSAnQVdTJyBhbmQgJ0FNQVpPTicgcHJlZml4ZXMuCiAgICoKICAgKiAjIyBTZXR0aW5nIFByb3ZpZGVycwogICAqCiAgICogRWFjaCBwcm92aWRlciBpbiB0aGUge3Byb3ZpZGVyc30gbGlzdCBzaG91bGQgYmUgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMKICAgKiBhIHtBV1MuQ3JlZGVudGlhbHN9IG9iamVjdCwgb3IgYSBoYXJkY29kZWQgY3JlZGVudGlhbHMgb2JqZWN0LiBUaGUgZnVuY3Rpb24KICAgKiBmb3JtIGFsbG93cyBmb3IgZGVsYXllZCBleGVjdXRpb24gb2YgdGhlIGNyZWRlbnRpYWwgY29uc3RydWN0aW9uLgogICAqCiAgICogIyMgUmVzb2x2aW5nIENyZWRlbnRpYWxzIGZyb20gYSBDaGFpbgogICAqCiAgICogQ2FsbCB7cmVzb2x2ZX0gdG8gcmV0dXJuIHRoZSBmaXJzdCB2YWxpZCBjcmVkZW50aWFsIG9iamVjdCB0aGF0IGNhbiBiZQogICAqIGxvYWRlZCBieSB0aGUgcHJvdmlkZXIgY2hhaW4uCiAgICoKICAgKiBGb3IgZXhhbXBsZSwgdG8gcmVzb2x2ZSBhIGNoYWluIHdpdGggYSBjdXN0b20gcHJvdmlkZXIgdGhhdCBjaGVja3MgYSBmaWxlCiAgICogb24gZGlzayBhZnRlciB0aGUgc2V0IG9mIHtkZWZhdWx0UHJvdmlkZXJzfToKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiB2YXIgZGlza1Byb3ZpZGVyID0gbmV3IEFXUy5GaWxlU3lzdGVtQ3JlZGVudGlhbHMoJy4vY3JlZHMuanNvbicpOwogICAqIHZhciBjaGFpbiA9IG5ldyBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4oKTsKICAgKiBjaGFpbi5wcm92aWRlcnMucHVzaChkaXNrUHJvdmlkZXIpOwogICAqIGNoYWluLnJlc29sdmUoKTsKICAgKiBgYGAKICAgKgogICAqIFRoZSBhYm92ZSBjb2RlIHdpbGwgcmV0dXJuIHRoZSBgZGlza1Byb3ZpZGVyYCBvYmplY3QgaWYgdGhlCiAgICogZmlsZSBjb250YWlucyBjcmVkZW50aWFscyBhbmQgdGhlIGBkZWZhdWx0UHJvdmlkZXJzYCBkbyBub3QgY29udGFpbgogICAqIGFueSBjcmVkZW50aWFsIHNldHRpbmdzLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcHJvdmlkZXJzCiAgICogICBAcmV0dXJuIFtBcnJheTxBV1MuQ3JlZGVudGlhbHMsIEZ1bmN0aW9uPl0KICAgKiAgICAgYSBsaXN0IG9mIGNyZWRlbnRpYWxzIG9iamVjdHMgb3IgZnVuY3Rpb25zIHRoYXQgcmV0dXJuIGNyZWRlbnRpYWxzCiAgICogICAgIG9iamVjdHMuIElmIHRoZSBwcm92aWRlciBpcyBhIGZ1bmN0aW9uLCB0aGUgZnVuY3Rpb24gd2lsbCBiZQogICAqICAgICBleGVjdXRlZCBsYXppbHkgd2hlbiB0aGUgcHJvdmlkZXIgbmVlZHMgdG8gYmUgY2hlY2tlZCBmb3IgdmFsaWQKICAgKiAgICAgY3JlZGVudGlhbHMuIEJ5IGRlZmF1bHQsIHRoaXMgb2JqZWN0IHdpbGwgYmUgc2V0IHRvIHRoZQogICAqICAgICB7ZGVmYXVsdFByb3ZpZGVyc30uCiAgICogICBAc2VlIGRlZmF1bHRQcm92aWRlcnMKICAgKi8KICBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4gPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IENyZWRlbnRpYWxQcm92aWRlckNoYWluIHdpdGggYSBkZWZhdWx0IHNldCBvZiBwcm92aWRlcnMKICAgICAqIHNwZWNpZmllZCBieSB7ZGVmYXVsdFByb3ZpZGVyc30uCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDcmVkZW50aWFsUHJvdmlkZXJDaGFpbihwcm92aWRlcnMpIHsKICAgICAgaWYgKHByb3ZpZGVycykgewogICAgICAgIHRoaXMucHJvdmlkZXJzID0gcHJvdmlkZXJzOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucHJvdmlkZXJzID0gQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmRlZmF1bHRQcm92aWRlcnMuc2xpY2UoMCk7CiAgICAgIH0KICAgICAgdGhpcy5yZXNvbHZlQ2FsbGJhY2tzID0gW107CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAIW1ldGhvZCAgcmVzb2x2ZVByb21pc2UoKQogICAgICogICBSZXR1cm5zIGEgJ3RoZW5hYmxlJyBwcm9taXNlLgogICAgICogICBSZXNvbHZlcyB0aGUgcHJvdmlkZXIgY2hhaW4gYnkgc2VhcmNoaW5nIGZvciB0aGUgZmlyc3Qgc2V0IG9mCiAgICAgKiAgIGNyZWRlbnRpYWxzIGluIHtwcm92aWRlcnN9LgogICAgICoKICAgICAqICAgVHdvIGNhbGxiYWNrcyBjYW4gYmUgcHJvdmlkZWQgdG8gdGhlIGB0aGVuYCBtZXRob2Qgb24gdGhlIHJldHVybmVkIHByb21pc2UuCiAgICAgKiAgIFRoZSBmaXJzdCBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQsIGFuZCB0aGUgc2Vjb25kCiAgICAgKiAgIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICBAY2FsbGJhY2sgZnVsZmlsbGVkQ2FsbGJhY2sgZnVuY3Rpb24oY3JlZGVudGlhbHMpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZCBhbmQgdGhlIHByb3ZpZGVyIHJlc29sdmVzIHRoZSBjaGFpbgogICAgICogICAgIHRvIGEgY3JlZGVudGlhbHMgb2JqZWN0CiAgICAgKiAgICAgQHBhcmFtIGNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBjcmVkZW50aWFscyBvYmplY3QgcmVzb2x2ZWQKICAgICAqICAgICAgIGJ5IHRoZSBwcm92aWRlciBjaGFpbi4KICAgICAqICAgQGNhbGxiYWNrIHJlamVjdGVkQ2FsbGJhY2sgZnVuY3Rpb24oZXJyb3IpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGlmIG5vIGNyZWRlbnRpYWxzIGFyZSBmb3VuZC4KICAgICAqICAgQHJldHVybiBbUHJvbWlzZV0gQSBwcm9taXNlIHRoYXQgcmVwcmVzZW50cyB0aGUgc3RhdGUgb2YgdGhlIGByZXNvbHZlYCBtZXRob2QgY2FsbC4KICAgICAqICAgQGV4YW1wbGUgQ2FsbGluZyB0aGUgYHJlc29sdmVQcm9taXNlYCBtZXRob2QuCiAgICAgKiAgICAgdmFyIHByb21pc2UgPSBjaGFpbi5yZXNvbHZlUHJvbWlzZSgpOwogICAgICogICAgIHByb21pc2UudGhlbihmdW5jdGlvbihjcmVkZW50aWFscykgeyAuLi4gfSwgZnVuY3Rpb24oZXJyKSB7IC4uLiB9KTsKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBSZXNvbHZlcyB0aGUgcHJvdmlkZXIgY2hhaW4gYnkgc2VhcmNoaW5nIGZvciB0aGUgZmlyc3Qgc2V0IG9mCiAgICAgKiBjcmVkZW50aWFscyBpbiB7cHJvdmlkZXJzfS4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBjcmVkZW50aWFscykKICAgICAqICAgQ2FsbGVkIHdoZW4gdGhlIHByb3ZpZGVyIHJlc29sdmVzIHRoZSBjaGFpbiB0byBhIGNyZWRlbnRpYWxzIG9iamVjdAogICAgICogICBvciBudWxsIGlmIG5vIGNyZWRlbnRpYWxzIGNhbiBiZSBmb3VuZC4KICAgICAqCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGlmIG5vIGNyZWRlbnRpYWxzIGFyZQogICAgICogICAgIGZvdW5kLgogICAgICogICBAcGFyYW0gY3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCByZXNvbHZlZAogICAgICogICAgIGJ5IHRoZSBwcm92aWRlciBjaGFpbi4KICAgICAqIEByZXR1cm4gW0FXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbl0gdGhlIHByb3ZpZGVyLCBmb3IgY2hhaW5pbmcuCiAgICAgKi8KICAgIHJlc29sdmU6IGZ1bmN0aW9uIHJlc29sdmUoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZiAoc2VsZi5wcm92aWRlcnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgY2FsbGJhY2sobmV3IEVycm9yKCdObyBwcm92aWRlcnMnKSk7CiAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgIH0KICAKICAgICAgaWYgKHNlbGYucmVzb2x2ZUNhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKSA9PT0gMSkgewogICAgICAgIHZhciBpbmRleCA9IDA7CiAgICAgICAgdmFyIHByb3ZpZGVycyA9IHNlbGYucHJvdmlkZXJzLnNsaWNlKDApOwogIAogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVOZXh0KGVyciwgY3JlZHMpIHsKICAgICAgICAgIGlmICgoIWVyciAmJiBjcmVkcykgfHwgaW5kZXggPT09IHByb3ZpZGVycy5sZW5ndGgpIHsKICAgICAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHNlbGYucmVzb2x2ZUNhbGxiYWNrcywgZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2soZXJyLCBjcmVkcyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzZWxmLnJlc29sdmVDYWxsYmFja3MubGVuZ3RoID0gMDsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogIAogICAgICAgICAgdmFyIHByb3ZpZGVyID0gcHJvdmlkZXJzW2luZGV4KytdOwogICAgICAgICAgaWYgKHR5cGVvZiBwcm92aWRlciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBjcmVkcyA9IHByb3ZpZGVyLmNhbGwoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNyZWRzID0gcHJvdmlkZXI7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBpZiAoY3JlZHMuZ2V0KSB7CiAgICAgICAgICAgIGNyZWRzLmdldChmdW5jdGlvbiAoZ2V0RXJyKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZU5leHQoZ2V0RXJyLCBnZXRFcnIgPyBudWxsIDogY3JlZHMpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc29sdmVOZXh0KG51bGwsIGNyZWRzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgCiAgICAgICAgcmVzb2x2ZU5leHQoKTsKICAgICAgfQogIAogICAgICByZXR1cm4gc2VsZjsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBUaGUgZGVmYXVsdCBzZXQgb2YgcHJvdmlkZXJzIHVzZWQgYnkgYSB2YW5pbGxhIENyZWRlbnRpYWxQcm92aWRlckNoYWluLgogICAqCiAgICogSW4gdGhlIGJyb3dzZXI6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmRlZmF1bHRQcm92aWRlcnMgPSBbXQogICAqIGBgYAogICAqCiAgICogSW4gTm9kZS5qczoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uZGVmYXVsdFByb3ZpZGVycyA9IFsKICAgKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFscygnQVdTJyk7IH0sCiAgICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FNQVpPTicpOyB9LAogICAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5TaGFyZWRJbmlGaWxlQ3JlZGVudGlhbHMoKTsgfSwKICAgKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuRUNTQ3JlZGVudGlhbHMoKTsgfSwKICAgKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuUHJvY2Vzc0NyZWRlbnRpYWxzKCk7IH0sCiAgICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLlRva2VuRmlsZVdlYklkZW50aXR5Q3JlZGVudGlhbHMoKTsgfSwKICAgKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuRUMyTWV0YWRhdGFDcmVkZW50aWFscygpIH0KICAgKiBdCiAgICogYGBgCiAgICovCiAgQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmRlZmF1bHRQcm92aWRlcnMgPSBbXTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uYWRkUHJvbWlzZXNUb0NsYXNzID0gZnVuY3Rpb24gYWRkUHJvbWlzZXNUb0NsYXNzKFByb21pc2VEZXBlbmRlbmN5KSB7CiAgICB0aGlzLnByb3RvdHlwZS5yZXNvbHZlUHJvbWlzZSA9IEFXUy51dGlsLnByb21pc2lmeU1ldGhvZCgncmVzb2x2ZScsIFByb21pc2VEZXBlbmRlbmN5KTsKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5kZWxldGVQcm9taXNlc0Zyb21DbGFzcyA9IGZ1bmN0aW9uIGRlbGV0ZVByb21pc2VzRnJvbUNsYXNzKCkgewogICAgZGVsZXRlIHRoaXMucHJvdG90eXBlLnJlc29sdmVQcm9taXNlOwogIH07CiAgCiAgQVdTLnV0aWwuYWRkUHJvbWlzZXMoQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluKTsKICAKICB9LHsiLi4vY29yZSI6MTh9XSwyMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIGNyZWRlbnRpYWxzIHJldHJpZXZlZCBmcm9tIFNUUyBTQU1MIHN1cHBvcnQuCiAgICoKICAgKiBCeSBkZWZhdWx0IHRoaXMgcHJvdmlkZXIgZ2V0cyBjcmVkZW50aWFscyB1c2luZyB0aGUKICAgKiB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFNBTUx9IHNlcnZpY2Ugb3BlcmF0aW9uLiBUaGlzIG9wZXJhdGlvbgogICAqIHJlcXVpcmVzIGEgYFJvbGVBcm5gIGNvbnRhaW5pbmcgdGhlIEFSTiBvZiB0aGUgSUFNIHRydXN0IHBvbGljeSBmb3IgdGhlCiAgICogYXBwbGljYXRpb24gZm9yIHdoaWNoIGNyZWRlbnRpYWxzIHdpbGwgYmUgZ2l2ZW4sIGFzIHdlbGwgYXMgYSBgUHJpbmNpcGFsQXJuYAogICAqIHJlcHJlc2VudGluZyB0aGUgQVJOIGZvciB0aGUgU0FNTCBpZGVudGl0eSBwcm92aWRlci4gSW4gYWRkaXRpb24sIHRoZQogICAqIGBTQU1MQXNzZXJ0aW9uYCBtdXN0IGJlIHNldCB0byB0aGUgdG9rZW4gcHJvdmlkZWQgYnkgdGhlIGlkZW50aXR5CiAgICogcHJvdmlkZXIuIFNlZSB7Y29uc3RydWN0b3J9IGZvciBhbiBleGFtcGxlIG9uIGNyZWF0aW5nIGEgY3JlZGVudGlhbHMKICAgKiBvYmplY3Qgd2l0aCBwcm9wZXIgYFJvbGVBcm5gLCBgUHJpbmNpcGFsQXJuYCwgYW5kIGBTQU1MQXNzZXJ0aW9uYCB2YWx1ZXMuCiAgICoKICAgKiAjIyBSZWZyZXNoaW5nIENyZWRlbnRpYWxzIGZyb20gSWRlbnRpdHkgU2VydmljZQogICAqCiAgICogSW4gYWRkaXRpb24gdG8gQVdTIGNyZWRlbnRpYWxzIGV4cGlyaW5nIGFmdGVyIGEgZ2l2ZW4gYW1vdW50IG9mIHRpbWUsIHRoZQogICAqIGxvZ2luIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyIHdpbGwgYWxzbyBleHBpcmUuIE9uY2UgdGhpcyB0b2tlbgogICAqIGV4cGlyZXMsIGl0IHdpbGwgbm90IGJlIHVzYWJsZSB0byByZWZyZXNoIEFXUyBjcmVkZW50aWFscywgYW5kIGFub3RoZXIKICAgKiB0b2tlbiB3aWxsIGJlIG5lZWRlZC4gVGhlIFNESyBkb2VzIG5vdCBtYW5hZ2UgcmVmcmVzaGluZyBvZiB0aGUgdG9rZW4gdmFsdWUsCiAgICogYnV0IHRoaXMgY2FuIGJlIGRvbmUgdGhyb3VnaCBhICJyZWZyZXNoIHRva2VuIiBzdXBwb3J0ZWQgYnkgbW9zdCBpZGVudGl0eQogICAqIHByb3ZpZGVycy4gQ29uc3VsdCB0aGUgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIGlkZW50aXR5IHByb3ZpZGVyIGZvciByZWZyZXNoaW5nCiAgICogdG9rZW5zLiBPbmNlIHRoZSByZWZyZXNoZWQgdG9rZW4gaXMgYWNxdWlyZWQsIHlvdSBzaG91bGQgbWFrZSBzdXJlIHRvIHVwZGF0ZQogICAqIHRoaXMgbmV3IHRva2VuIGluIHRoZSBjcmVkZW50aWFscyBvYmplY3QncyB7cGFyYW1zfSBwcm9wZXJ0eS4gVGhlIGZvbGxvd2luZwogICAqIGNvZGUgd2lsbCB1cGRhdGUgdGhlIFNBTUxBc3NlcnRpb24sIGFzc3VtaW5nIHlvdSBoYXZlIHJldHJpZXZlZCBhbiB1cGRhdGVkCiAgICogdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXI6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscy5wYXJhbXMuU0FNTEFzc2VydGlvbiA9IHVwZGF0ZWRUb2tlbjsKICAgKiBgYGAKICAgKgogICAqIEZ1dHVyZSBjYWxscyB0byBgY3JlZGVudGlhbHMucmVmcmVzaCgpYCB3aWxsIG5vdyB1c2UgdGhlIG5ldyB0b2tlbi4KICAgKgogICAqIEAhYXR0cmlidXRlIHBhcmFtcwogICAqICAgQHJldHVybiBbbWFwXSB0aGUgbWFwIG9mIHBhcmFtcyBwYXNzZWQgdG8KICAgKiAgICAge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhTQU1MfS4gVG8gdXBkYXRlIHRoZSB0b2tlbiwgc2V0IHRoZQogICAqICAgICBgcGFyYW1zLlNBTUxBc3NlcnRpb25gIHByb3BlcnR5LgogICAqLwogIEFXUy5TQU1MQ3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdC4KICAgICAqIEBwYXJhbSAoc2VlIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhTQU1MKQogICAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0CiAgICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLlNBTUxDcmVkZW50aWFscyh7CiAgICAgKiAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvU0FNTFJvbGUnLAogICAgICogICAgIFByaW5jaXBhbEFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvU0FNTFByaW5jaXBhbCcsCiAgICAgKiAgICAgU0FNTEFzc2VydGlvbjogJ2Jhc2U2NC10b2tlbicsIC8vIGJhc2U2NC1lbmNvZGVkIHRva2VuIGZyb20gSWRQCiAgICAgKiAgIH0pOwogICAgICogQHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoU0FNTAogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gU0FNTENyZWRlbnRpYWxzKHBhcmFtcykgewogICAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKICAgICAgdGhpcy5wYXJhbXMgPSBwYXJhbXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBSZWZyZXNoZXMgY3JlZGVudGlhbHMgdXNpbmcge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhTQU1MfQogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIENhbGxlZCB3aGVuIHRoZSBTVFMgc2VydmljZSByZXNwb25kcyAob3IgZmFpbHMpLiBXaGVuCiAgICAgKiAgIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHRoYXQgdGhlIGNyZWRlbnRpYWxzCiAgICAgKiAgIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLAogICAgICogICBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqIEBzZWUgZ2V0CiAgICAgKi8KICAgIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2goY2FsbGJhY2spIHsKICAgICAgdGhpcy5jb2FsZXNjZVJlZnJlc2goY2FsbGJhY2sgfHwgQVdTLnV0aWwuZm4uY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxvYWQ6IGZ1bmN0aW9uIGxvYWQoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzZWxmLmNyZWF0ZUNsaWVudHMoKTsKICAgICAgc2VsZi5zZXJ2aWNlLmFzc3VtZVJvbGVXaXRoU0FNTChmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgIHNlbGYuc2VydmljZS5jcmVkZW50aWFsc0Zyb20oZGF0YSwgc2VsZik7CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNyZWF0ZUNsaWVudHM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnNlcnZpY2UgPSB0aGlzLnNlcnZpY2UgfHwgbmV3IFNUUyh7cGFyYW1zOiB0aGlzLnBhcmFtc30pOwogICAgfQogIAogIH0pOwogIAogIH0seyIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTh9XSwyNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIHRlbXBvcmFyeSBjcmVkZW50aWFscyByZXRyaWV2ZWQgZnJvbSB7QVdTLlNUU30uIFdpdGhvdXQgYW55CiAgICogZXh0cmEgcGFyYW1ldGVycywgY3JlZGVudGlhbHMgd2lsbCBiZSBmZXRjaGVkIGZyb20gdGhlCiAgICoge0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSBvcGVyYXRpb24uIElmIGFuIElBTSByb2xlIGlzIHByb3ZpZGVkLCB0aGUKICAgKiB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvcGVyYXRpb24gd2lsbCBiZSB1c2VkIHRvIGZldGNoIGNyZWRlbnRpYWxzIGZvciB0aGUKICAgKiByb2xlIGluc3RlYWQuCiAgICoKICAgKiBAbm90ZSBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgaXMgZGVwcmVjYXRlZCwgYnV0IHJlbWFpbnMgYXZhaWxhYmxlIGZvcgogICAqICAgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuIHtBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHN9IGlzIHRoZQogICAqICAgcHJlZmVycmVkIGNsYXNzIGZvciB0ZW1wb3JhcnkgY3JlZGVudGlhbHMuCiAgICoKICAgKiBUbyBzZXR1cCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMsIGNvbmZpZ3VyZSBhIHNldCBvZiBtYXN0ZXIgY3JlZGVudGlhbHMKICAgKiB1c2luZyB0aGUgc3RhbmRhcmQgY3JlZGVudGlhbHMgcHJvdmlkZXJzIChlbnZpcm9ubWVudCwgRUMyIGluc3RhbmNlIG1ldGFkYXRhLAogICAqIG9yIGZyb20gdGhlIGZpbGVzeXN0ZW0pLCB0aGVuIHNldCB0aGUgZ2xvYmFsIGNyZWRlbnRpYWxzIHRvIGEgbmV3CiAgICogdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIG9iamVjdDoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiAvLyBOb3RlIHRoYXQgZW52aXJvbm1lbnQgY3JlZGVudGlhbHMgYXJlIGxvYWRlZCBieSBkZWZhdWx0LAogICAqIC8vIHRoZSBmb2xsb3dpbmcgbGluZSBpcyBzaG93biBmb3IgY2xhcml0eToKICAgKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzKCdBV1MnKTsKICAgKgogICAqIC8vIE5vdyBzZXQgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIHNlZWRlZCBmcm9tIHRoZSBtYXN0ZXIgY3JlZGVudGlhbHMKICAgKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscygpOwogICAqCiAgICogLy8gc3Vic2VxdWVudCByZXF1ZXN0cyB3aWxsIG5vdyB1c2UgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZyb20gQVdTIFNUUy4KICAgKiBuZXcgQVdTLlMzKCkubGlzdEJ1Y2tldChmdW5jdGlvbihlcnIsIGRhdGEpIHsgLi4uIH0pOwogICAqIGBgYAogICAqCiAgICogQCFhdHRyaWJ1dGUgbWFzdGVyQ3JlZGVudGlhbHMKICAgKiAgIEByZXR1cm4gW0FXUy5DcmVkZW50aWFsc10gdGhlIG1hc3RlciAobm9uLXRlbXBvcmFyeSkgY3JlZGVudGlhbHMgdXNlZCB0bwogICAqICAgICBnZXQgYW5kIHJlZnJlc2ggdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZyb20gQVdTIFNUUy4KICAgKiBAbm90ZSAoc2VlIGNvbnN0cnVjdG9yKQogICAqLwogIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIG9iamVjdC4KICAgICAqCiAgICAgKiBAbm90ZSBJbiBvcmRlciB0byBjcmVhdGUgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLCB5b3UgZmlyc3QgbmVlZCB0byBoYXZlCiAgICAgKiAgICJtYXN0ZXIiIGNyZWRlbnRpYWxzIGNvbmZpZ3VyZWQgaW4ge0FXUy5Db25maWcuY3JlZGVudGlhbHN9LiBUaGVzZQogICAgICogICBtYXN0ZXIgY3JlZGVudGlhbHMgYXJlIG5lY2Vzc2FyeSB0byByZXRyaWV2ZSB0aGUgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLAogICAgICogICBhcyB3ZWxsIGFzIHJlZnJlc2ggdGhlIGNyZWRlbnRpYWxzIHdoZW4gdGhleSBleHBpcmUuCiAgICAgKiBAcGFyYW0gcGFyYW1zIFttYXBdIGEgbWFwIG9mIG9wdGlvbnMgdGhhdCBhcmUgcGFzc2VkIHRvIHRoZQogICAgICogICB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvciB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59IG9wZXJhdGlvbnMuCiAgICAgKiAgIElmIGEgYFJvbGVBcm5gIHBhcmFtZXRlciBpcyBwYXNzZWQgaW4sIGNyZWRlbnRpYWxzIHdpbGwgYmUgYmFzZWQgb24gdGhlCiAgICAgKiAgIElBTSByb2xlLgogICAgICogQHBhcmFtIG1hc3RlckNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBtYXN0ZXIgKG5vbi10ZW1wb3JhcnkpIGNyZWRlbnRpYWxzCiAgICAgKiAgdXNlZCB0byBnZXQgYW5kIHJlZnJlc2ggdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZyb20gQVdTIFNUUy4KICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdCBmb3IgZ2VuZXJpYyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMoKTsKICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdCBmb3IgYW4gSUFNIHJvbGUKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogICAgICogICAgIFJvbGVBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL1RlbXBvcmFyeUNyZWRlbnRpYWxzJywKICAgICAqICAgfSk7CiAgICAgKiBAc2VlIEFXUy5TVFMuYXNzdW1lUm9sZQogICAgICogQHNlZSBBV1MuU1RTLmdldFNlc3Npb25Ub2tlbgogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gVGVtcG9yYXJ5Q3JlZGVudGlhbHMocGFyYW1zLCBtYXN0ZXJDcmVkZW50aWFscykgewogICAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5sb2FkTWFzdGVyQ3JlZGVudGlhbHMobWFzdGVyQ3JlZGVudGlhbHMpOwogICAgICB0aGlzLmV4cGlyZWQgPSB0cnVlOwogIAogICAgICB0aGlzLnBhcmFtcyA9IHBhcmFtcyB8fCB7fTsKICAgICAgaWYgKHRoaXMucGFyYW1zLlJvbGVBcm4pIHsKICAgICAgICB0aGlzLnBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgPQogICAgICAgICAgdGhpcy5wYXJhbXMuUm9sZVNlc3Npb25OYW1lIHx8ICd0ZW1wb3JhcnktY3JlZGVudGlhbHMnOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBSZWZyZXNoZXMgY3JlZGVudGlhbHMgdXNpbmcge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3IKICAgICAqIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0sIGRlcGVuZGluZyBvbiB3aGV0aGVyIGFuIElBTSByb2xlIEFSTiB3YXMgcGFzc2VkCiAgICAgKiB0byB0aGUgY3JlZGVudGlhbHMge2NvbnN0cnVjdG9yfS4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICBDYWxsZWQgd2hlbiB0aGUgU1RTIHNlcnZpY2UgcmVzcG9uZHMgKG9yIGZhaWxzKS4gV2hlbgogICAgICogICB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyB0aGF0IHRoZSBjcmVkZW50aWFscwogICAgICogICBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwKICAgICAqICAgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKiBAc2VlIGdldAogICAgICovCiAgICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoIChjYWxsYmFjaykgewogICAgICB0aGlzLmNvYWxlc2NlUmVmcmVzaChjYWxsYmFjayB8fCBBV1MudXRpbC5mbi5jYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZDogZnVuY3Rpb24gbG9hZCAoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzZWxmLmNyZWF0ZUNsaWVudHMoKTsKICAgICAgc2VsZi5tYXN0ZXJDcmVkZW50aWFscy5nZXQoZnVuY3Rpb24gKCkgewogICAgICAgIHNlbGYuc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMgPSBzZWxmLm1hc3RlckNyZWRlbnRpYWxzOwogICAgICAgIHZhciBvcGVyYXRpb24gPSBzZWxmLnBhcmFtcy5Sb2xlQXJuID8KICAgICAgICAgIHNlbGYuc2VydmljZS5hc3N1bWVSb2xlIDogc2VsZi5zZXJ2aWNlLmdldFNlc3Npb25Ub2tlbjsKICAgICAgICBvcGVyYXRpb24uY2FsbChzZWxmLnNlcnZpY2UsIGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICAgIHNlbGYuc2VydmljZS5jcmVkZW50aWFsc0Zyb20oZGF0YSwgc2VsZik7CiAgICAgICAgICB9CiAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkTWFzdGVyQ3JlZGVudGlhbHM6IGZ1bmN0aW9uIGxvYWRNYXN0ZXJDcmVkZW50aWFscyAobWFzdGVyQ3JlZGVudGlhbHMpIHsKICAgICAgdGhpcy5tYXN0ZXJDcmVkZW50aWFscyA9IG1hc3RlckNyZWRlbnRpYWxzIHx8IEFXUy5jb25maWcuY3JlZGVudGlhbHM7CiAgICAgIHdoaWxlICh0aGlzLm1hc3RlckNyZWRlbnRpYWxzLm1hc3RlckNyZWRlbnRpYWxzKSB7CiAgICAgICAgdGhpcy5tYXN0ZXJDcmVkZW50aWFscyA9IHRoaXMubWFzdGVyQ3JlZGVudGlhbHMubWFzdGVyQ3JlZGVudGlhbHM7CiAgICAgIH0KICAKICAgICAgaWYgKHR5cGVvZiB0aGlzLm1hc3RlckNyZWRlbnRpYWxzLmdldCAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRoaXMubWFzdGVyQ3JlZGVudGlhbHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKHRoaXMubWFzdGVyQ3JlZGVudGlhbHMpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY3JlYXRlQ2xpZW50czogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLnNlcnZpY2UgPSB0aGlzLnNlcnZpY2UgfHwgbmV3IFNUUyh7cGFyYW1zOiB0aGlzLnBhcmFtc30pOwogICAgfQogIAogIH0pOwogIAogIH0seyIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTh9XSwyNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIGNyZWRlbnRpYWxzIHJldHJpZXZlZCBmcm9tIFNUUyBXZWIgSWRlbnRpdHkgRmVkZXJhdGlvbiBzdXBwb3J0LgogICAqCiAgICogQnkgZGVmYXVsdCB0aGlzIHByb3ZpZGVyIGdldHMgY3JlZGVudGlhbHMgdXNpbmcgdGhlCiAgICoge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0gc2VydmljZSBvcGVyYXRpb24uIFRoaXMgb3BlcmF0aW9uCiAgICogcmVxdWlyZXMgYSBgUm9sZUFybmAgY29udGFpbmluZyB0aGUgQVJOIG9mIHRoZSBJQU0gdHJ1c3QgcG9saWN5IGZvciB0aGUKICAgKiBhcHBsaWNhdGlvbiBmb3Igd2hpY2ggY3JlZGVudGlhbHMgd2lsbCBiZSBnaXZlbi4gSW4gYWRkaXRpb24sIHRoZQogICAqIGBXZWJJZGVudGl0eVRva2VuYCBtdXN0IGJlIHNldCB0byB0aGUgdG9rZW4gcHJvdmlkZWQgYnkgdGhlIGlkZW50aXR5CiAgICogcHJvdmlkZXIuIFNlZSB7Y29uc3RydWN0b3J9IGZvciBhbiBleGFtcGxlIG9uIGNyZWF0aW5nIGEgY3JlZGVudGlhbHMKICAgKiBvYmplY3Qgd2l0aCBwcm9wZXIgYFJvbGVBcm5gIGFuZCBgV2ViSWRlbnRpdHlUb2tlbmAgdmFsdWVzLgogICAqCiAgICogIyMgUmVmcmVzaGluZyBDcmVkZW50aWFscyBmcm9tIElkZW50aXR5IFNlcnZpY2UKICAgKgogICAqIEluIGFkZGl0aW9uIHRvIEFXUyBjcmVkZW50aWFscyBleHBpcmluZyBhZnRlciBhIGdpdmVuIGFtb3VudCBvZiB0aW1lLCB0aGUKICAgKiBsb2dpbiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlciB3aWxsIGFsc28gZXhwaXJlLiBPbmNlIHRoaXMgdG9rZW4KICAgKiBleHBpcmVzLCBpdCB3aWxsIG5vdCBiZSB1c2FibGUgdG8gcmVmcmVzaCBBV1MgY3JlZGVudGlhbHMsIGFuZCBhbm90aGVyCiAgICogdG9rZW4gd2lsbCBiZSBuZWVkZWQuIFRoZSBTREsgZG9lcyBub3QgbWFuYWdlIHJlZnJlc2hpbmcgb2YgdGhlIHRva2VuIHZhbHVlLAogICAqIGJ1dCB0aGlzIGNhbiBiZSBkb25lIHRocm91Z2ggYSAicmVmcmVzaCB0b2tlbiIgc3VwcG9ydGVkIGJ5IG1vc3QgaWRlbnRpdHkKICAgKiBwcm92aWRlcnMuIENvbnN1bHQgdGhlIGRvY3VtZW50YXRpb24gZm9yIHRoZSBpZGVudGl0eSBwcm92aWRlciBmb3IgcmVmcmVzaGluZwogICAqIHRva2Vucy4gT25jZSB0aGUgcmVmcmVzaGVkIHRva2VuIGlzIGFjcXVpcmVkLCB5b3Ugc2hvdWxkIG1ha2Ugc3VyZSB0byB1cGRhdGUKICAgKiB0aGlzIG5ldyB0b2tlbiBpbiB0aGUgY3JlZGVudGlhbHMgb2JqZWN0J3Mge3BhcmFtc30gcHJvcGVydHkuIFRoZSBmb2xsb3dpbmcKICAgKiBjb2RlIHdpbGwgdXBkYXRlIHRoZSBXZWJJZGVudGl0eVRva2VuLCBhc3N1bWluZyB5b3UgaGF2ZSByZXRyaWV2ZWQgYW4gdXBkYXRlZAogICAqIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMucGFyYW1zLldlYklkZW50aXR5VG9rZW4gPSB1cGRhdGVkVG9rZW47CiAgICogYGBgCiAgICoKICAgKiBGdXR1cmUgY2FsbHMgdG8gYGNyZWRlbnRpYWxzLnJlZnJlc2goKWAgd2lsbCBub3cgdXNlIHRoZSBuZXcgdG9rZW4uCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBwYXJhbXMKICAgKiAgIEByZXR1cm4gW21hcF0gdGhlIG1hcCBvZiBwYXJhbXMgcGFzc2VkIHRvCiAgICogICAgIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LiBUbyB1cGRhdGUgdGhlIHRva2VuLCBzZXQgdGhlCiAgICogICAgIGBwYXJhbXMuV2ViSWRlbnRpdHlUb2tlbmAgcHJvcGVydHkuCiAgICogQCFhdHRyaWJ1dGUgZGF0YQogICAqICAgQHJldHVybiBbbWFwXSB0aGUgcmF3IGRhdGEgcmVzcG9uc2UgZnJvbSB0aGUgY2FsbCB0bwogICAqICAgICB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4gVXNlIHRoaXMgaWYgeW91IHdhbnQgdG8gZ2V0CiAgICogICAgIGFjY2VzcyB0byBvdGhlciBwcm9wZXJ0aWVzIGZyb20gdGhlIHJlc3BvbnNlLgogICAqLwogIEFXUy5XZWJJZGVudGl0eUNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QuCiAgICAgKiBAcGFyYW0gKHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkpCiAgICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuV2ViSWRlbnRpdHlDcmVkZW50aWFscyh7CiAgICAgKiAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvV2ViSWRlbnRpdHknLAogICAgICogICAgIFdlYklkZW50aXR5VG9rZW46ICdBQkNERUZHSElKS0xNTk9QJywgLy8gdG9rZW4gZnJvbSBpZGVudGl0eSBzZXJ2aWNlCiAgICAgKiAgICAgUm9sZVNlc3Npb25OYW1lOiAnd2ViJyAvLyBvcHRpb25hbCBuYW1lLCBkZWZhdWx0cyB0byB3ZWItaWRlbnRpdHkKICAgICAqICAgfSwgewogICAgICogICAgIC8vIG9wdGlvbmFsbHkgcHJvdmlkZSBjb25maWd1cmF0aW9uIHRvIGFwcGx5IHRvIHRoZSB1bmRlcmx5aW5nIEFXUy5TVFMgc2VydmljZSBjbGllbnQKICAgICAqICAgICAvLyBpZiBjb25maWd1cmF0aW9uIGlzIG5vdCBwcm92aWRlZCwgdGhlbiBjb25maWd1cmF0aW9uIHdpbGwgYmUgcHVsbGVkIGZyb20gQVdTLmNvbmZpZwogICAgICoKICAgICAqICAgICAvLyBzcGVjaWZ5IHRpbWVvdXQgb3B0aW9ucwogICAgICogICAgIGh0dHBPcHRpb25zOiB7CiAgICAgKiAgICAgICB0aW1lb3V0OiAxMDAKICAgICAqICAgICB9CiAgICAgKiAgIH0pOwogICAgICogQHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkKICAgICAqIEBzZWUgQVdTLkNvbmZpZwogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gV2ViSWRlbnRpdHlDcmVkZW50aWFscyhwYXJhbXMsIGNsaWVudENvbmZpZykgewogICAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKICAgICAgdGhpcy5wYXJhbXMgPSBwYXJhbXM7CiAgICAgIHRoaXMucGFyYW1zLlJvbGVTZXNzaW9uTmFtZSA9IHRoaXMucGFyYW1zLlJvbGVTZXNzaW9uTmFtZSB8fCAnd2ViLWlkZW50aXR5JzsKICAgICAgdGhpcy5kYXRhID0gbnVsbDsKICAgICAgdGhpcy5fY2xpZW50Q29uZmlnID0gQVdTLnV0aWwuY29weShjbGllbnRDb25maWcgfHwge30pOwogICAgfSwKICAKICAgIC8qKgogICAgICogUmVmcmVzaGVzIGNyZWRlbnRpYWxzIHVzaW5nIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9CiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgQ2FsbGVkIHdoZW4gdGhlIFNUUyBzZXJ2aWNlIHJlc3BvbmRzIChvciBmYWlscykuIFdoZW4KICAgICAqICAgdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgdGhhdCB0aGUgY3JlZGVudGlhbHMKICAgICAqICAgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsCiAgICAgKiAgIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogQHNlZSBnZXQKICAgICAqLwogICAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaChjYWxsYmFjaykgewogICAgICB0aGlzLmNvYWxlc2NlUmVmcmVzaChjYWxsYmFjayB8fCBBV1MudXRpbC5mbi5jYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZDogZnVuY3Rpb24gbG9hZChjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHNlbGYuY3JlYXRlQ2xpZW50cygpOwogICAgICBzZWxmLnNlcnZpY2UuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eShmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgc2VsZi5kYXRhID0gbnVsbDsKICAgICAgICBpZiAoIWVycikgewogICAgICAgICAgc2VsZi5kYXRhID0gZGF0YTsKICAgICAgICAgIHNlbGYuc2VydmljZS5jcmVkZW50aWFsc0Zyb20oZGF0YSwgc2VsZik7CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNyZWF0ZUNsaWVudHM6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMuc2VydmljZSkgewogICAgICAgIHZhciBzdHNDb25maWcgPSBBV1MudXRpbC5tZXJnZSh7fSwgdGhpcy5fY2xpZW50Q29uZmlnKTsKICAgICAgICBzdHNDb25maWcucGFyYW1zID0gdGhpcy5wYXJhbXM7CiAgICAgICAgdGhpcy5zZXJ2aWNlID0gbmV3IFNUUyhzdHNDb25maWcpOwogICAgICB9CiAgICB9CiAgCiAgfSk7CiAgCiAgfSx7Ii4uLy4uL2NsaWVudHMvc3RzIjo4LCIuLi9jb3JlIjoxOH1dLDI2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKHByb2Nlc3MpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4vdXRpbCcpOwogIHZhciBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWRFbnZzID0gWydBV1NfRU5BQkxFX0VORFBPSU5UX0RJU0NPVkVSWScsICdBV1NfRU5EUE9JTlRfRElTQ09WRVJZX0VOQUJMRUQnXTsKICAKICAvKioKICAgKiBHZW5lcmF0ZSBrZXkgKGV4Y2VwdCByZXNvdXJjZXMgYW5kIG9wZXJhdGlvbiBwYXJ0KSB0byBpbmRleCB0aGUgZW5kcG9pbnRzIGluIHRoZSBjYWNoZQogICAqIElmIGlucHV0IHNoYXBlIGhhcyBlbmRwb2ludGRpc2NvdmVyeWlkIHRyYWl0IHRoZW4gdXNlCiAgICogICBhY2Nlc3NLZXkgKyBvcGVyYXRpb24gKyByZXNvdXJjZXMgKyByZWdpb24gKyBzZXJ2aWNlIGFzIGNhY2hlIGtleQogICAqIElmIGlucHV0IHNoYXBlIGRvZXNuJ3QgaGF2ZSBlbmRwb2ludGRpc2NvdmVyeWlkIHRyYWl0IHRoZW4gdXNlCiAgICogICBhY2Nlc3NLZXkgKyByZWdpb24gKyBzZXJ2aWNlIGFzIGNhY2hlIGtleQogICAqIEByZXR1cm4gW21hcDxTdHJpbmcsU3RyaW5nPl0gb2JqZWN0IHdpdGgga2V5cyB0byBpbmRleCBlbmRwb2ludHMuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gZ2V0Q2FjaGVLZXkocmVxdWVzdCkgewogICAgdmFyIHNlcnZpY2UgPSByZXF1ZXN0LnNlcnZpY2U7CiAgICB2YXIgYXBpID0gc2VydmljZS5hcGkgfHwge307CiAgICB2YXIgb3BlcmF0aW9ucyA9IGFwaS5vcGVyYXRpb25zOwogICAgdmFyIGlkZW50aWZpZXJzID0ge307CiAgICBpZiAoc2VydmljZS5jb25maWcucmVnaW9uKSB7CiAgICAgIGlkZW50aWZpZXJzLnJlZ2lvbiA9IHNlcnZpY2UuY29uZmlnLnJlZ2lvbjsKICAgIH0KICAgIGlmIChhcGkuc2VydmljZUlkKSB7CiAgICAgIGlkZW50aWZpZXJzLnNlcnZpY2VJZCA9IGFwaS5zZXJ2aWNlSWQ7CiAgICB9CiAgICBpZiAoc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQpIHsKICAgICAgaWRlbnRpZmllcnMuYWNjZXNzS2V5SWQgPSBzZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscy5hY2Nlc3NLZXlJZDsKICAgIH0KICAgIHJldHVybiBpZGVudGlmaWVyczsKICB9CiAgCiAgLyoqCiAgICogUmVjdXJzaXZlIGhlbHBlciBmb3IgbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycygpLgogICAqIExvb2tzIGZvciByZXF1aXJlZCBzdHJpbmcgaW5wdXQgbWVtYmVycyB0aGF0IGhhdmUgJ2VuZHBvaW50ZGlzY292ZXJ5aWQnIHRyYWl0LgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnNIZWxwZXIocmVzdWx0LCBwYXJhbXMsIHNoYXBlKSB7CiAgICBpZiAoIXNoYXBlIHx8IHBhcmFtcyA9PT0gdW5kZWZpbmVkIHx8IHBhcmFtcyA9PT0gbnVsbCkgcmV0dXJuOwogICAgaWYgKHNoYXBlLnR5cGUgPT09ICdzdHJ1Y3R1cmUnICYmIHNoYXBlLnJlcXVpcmVkICYmIHNoYXBlLnJlcXVpcmVkLmxlbmd0aCA+IDApIHsKICAgICAgdXRpbC5hcnJheUVhY2goc2hhcGUucmVxdWlyZWQsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICB2YXIgbWVtYmVyU2hhcGUgPSBzaGFwZS5tZW1iZXJzW25hbWVdOwogICAgICAgIGlmIChtZW1iZXJTaGFwZS5lbmRwb2ludERpc2NvdmVyeUlkID09PSB0cnVlKSB7CiAgICAgICAgICB2YXIgbG9jYXRpb25OYW1lID0gbWVtYmVyU2hhcGUuaXNMb2NhdGlvbk5hbWUgPyBtZW1iZXJTaGFwZS5uYW1lIDogbmFtZTsKICAgICAgICAgIHJlc3VsdFtsb2NhdGlvbk5hbWVdID0gU3RyaW5nKHBhcmFtc1tuYW1lXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnNIZWxwZXIocmVzdWx0LCBwYXJhbXNbbmFtZV0sIG1lbWJlclNoYXBlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KICAKICAvKioKICAgKiBHZXQgY3VzdG9tIGlkZW50aWZpZXJzIGZvciBjYWNoZSBrZXkuCiAgICogSWRlbnRpZmllcyBjdXN0b20gaWRlbnRpZmllcnMgYnkgY2hlY2tpbmcgZWFjaCBzaGFwZSdzIGBlbmRwb2ludERpc2NvdmVyeUlkYCB0cmFpdC4KICAgKiBAcGFyYW0gW29iamVjdF0gcmVxdWVzdCBvYmplY3QKICAgKiBAcGFyYW0gW29iamVjdF0gaW5wdXQgc2hhcGUgb2YgdGhlIGdpdmVuIG9wZXJhdGlvbidzIGFwaQogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnMocmVxdWVzdCwgc2hhcGUpIHsKICAgIHZhciBpZGVudGlmaWVycyA9IHt9OwogICAgbWFyc2hhbGxDdXN0b21JZGVudGlmaWVyc0hlbHBlcihpZGVudGlmaWVycywgcmVxdWVzdC5wYXJhbXMsIHNoYXBlKTsKICAgIHJldHVybiBpZGVudGlmaWVyczsKICB9CiAgCiAgLyoqCiAgICogQ2FsbCBlbmRwb2ludCBkaXNjb3Zlcnkgb3BlcmF0aW9uIHdoZW4gaXQncyBvcHRpb25hbC4KICAgKiBXaGVuIGVuZHBvaW50IGlzIGF2YWlsYWJsZSBpbiBjYWNoZSB0aGVuIHVzZSB0aGUgY2FjaGVkIGVuZHBvaW50cy4gSWYgZW5kcG9pbnRzCiAgICogYXJlIHVuYXZhaWxhYmxlIHRoZW4gdXNlIHJlZ2lvbmFsIGVuZHBvaW50cyBhbmQgY2FsbCBlbmRwb2ludCBkaXNjb3Zlcnkgb3BlcmF0aW9uCiAgICogYXN5bmNocm9ub3VzbHkuIFRoaXMgaXMgdHVybmVkIG9mZiBieSBkZWZhdWx0LgogICAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0IG9iamVjdAogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG9wdGlvbmFsRGlzY292ZXJFbmRwb2ludChyZXF1ZXN0KSB7CiAgICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZTsKICAgIHZhciBhcGkgPSBzZXJ2aWNlLmFwaTsKICAgIHZhciBvcGVyYXRpb25Nb2RlbCA9IGFwaS5vcGVyYXRpb25zID8gYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dIDogdW5kZWZpbmVkOwogICAgdmFyIGlucHV0U2hhcGUgPSBvcGVyYXRpb25Nb2RlbCA/IG9wZXJhdGlvbk1vZGVsLmlucHV0IDogdW5kZWZpbmVkOwogIAogICAgdmFyIGlkZW50aWZpZXJzID0gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycyhyZXF1ZXN0LCBpbnB1dFNoYXBlKTsKICAgIHZhciBjYWNoZUtleSA9IGdldENhY2hlS2V5KHJlcXVlc3QpOwogICAgaWYgKE9iamVjdC5rZXlzKGlkZW50aWZpZXJzKS5sZW5ndGggPiAwKSB7CiAgICAgIGNhY2hlS2V5ID0gdXRpbC51cGRhdGUoY2FjaGVLZXksIGlkZW50aWZpZXJzKTsKICAgICAgaWYgKG9wZXJhdGlvbk1vZGVsKSBjYWNoZUtleS5vcGVyYXRpb24gPSBvcGVyYXRpb25Nb2RlbC5uYW1lOwogICAgfQogICAgdmFyIGVuZHBvaW50cyA9IEFXUy5lbmRwb2ludENhY2hlLmdldChjYWNoZUtleSk7CiAgICBpZiAoZW5kcG9pbnRzICYmIGVuZHBvaW50cy5sZW5ndGggPT09IDEgJiYgZW5kcG9pbnRzWzBdLkFkZHJlc3MgPT09ICcnKSB7CiAgICAgIC8vZW5kcG9pbnQgb3BlcmF0aW9uIGlzIGJlaW5nIG1hZGUgYnV0IHJlc3BvbnNlIG5vdCB5ZXQgcmVjZWl2ZWQKICAgICAgLy9vciBlbmRwb2ludCBvcGVyYXRpb24ganVzdCBmYWlsZWQgaW4gMSBtaW51dGUKICAgICAgcmV0dXJuOwogICAgfSBlbHNlIGlmIChlbmRwb2ludHMgJiYgZW5kcG9pbnRzLmxlbmd0aCA+IDApIHsKICAgICAgLy9mb3VuZCBlbmRwb2ludCByZWNvcmQgZnJvbSBjYWNoZQogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnVwZGF0ZUVuZHBvaW50KGVuZHBvaW50c1swXS5BZGRyZXNzKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vZW5kcG9pbnQgcmVjb3JkIG5vdCBpbiBjYWNoZSBvciBvdXRkYXRlZC4gbWFrZSBkaXNjb3Zlcnkgb3BlcmF0aW9uCiAgICAgIHZhciBlbmRwb2ludFJlcXVlc3QgPSBzZXJ2aWNlLm1ha2VSZXF1ZXN0KGFwaS5lbmRwb2ludE9wZXJhdGlvbiwgewogICAgICAgIE9wZXJhdGlvbjogb3BlcmF0aW9uTW9kZWwubmFtZSwKICAgICAgICBJZGVudGlmaWVyczogaWRlbnRpZmllcnMsCiAgICAgIH0pOwogICAgICBhZGRBcGlWZXJzaW9uSGVhZGVyKGVuZHBvaW50UmVxdWVzdCk7CiAgICAgIGVuZHBvaW50UmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9QQVJBTUVURVJTKTsKICAgICAgZW5kcG9pbnRSZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdyZXRyeScsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlJFVFJZX0NIRUNLKTsKICAgICAgLy9wdXQgaW4gYSBwbGFjZWhvbGRlciBmb3IgZW5kcG9pbnRzIGFscmVhZHkgcmVxdWVzdGVkLCBwcmV2ZW50CiAgICAgIC8vdG9vIG11Y2ggaW4tZmxpZ2h0IGNhbGxzCiAgICAgIEFXUy5lbmRwb2ludENhY2hlLnB1dChjYWNoZUtleSwgW3sKICAgICAgICBBZGRyZXNzOiAnJywKICAgICAgICBDYWNoZVBlcmlvZEluTWludXRlczogMQogICAgICB9XSk7CiAgICAgIGVuZHBvaW50UmVxdWVzdC5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgIGlmIChkYXRhICYmIGRhdGEuRW5kcG9pbnRzKSB7CiAgICAgICAgICBBV1MuZW5kcG9pbnRDYWNoZS5wdXQoY2FjaGVLZXksIGRhdGEuRW5kcG9pbnRzKTsKICAgICAgICB9IGVsc2UgaWYgKGVycikgewogICAgICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucHV0KGNhY2hlS2V5LCBbewogICAgICAgICAgICBBZGRyZXNzOiAnJywKICAgICAgICAgICAgQ2FjaGVQZXJpb2RJbk1pbnV0ZXM6IDEgLy9ub3QgdG8gbWFrZSBtb3JlIGVuZHBvaW50IG9wZXJhdGlvbiBpbiBuZXh0IDEgbWludXRlCiAgICAgICAgICB9XSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9CiAgCiAgdmFyIHJlcXVlc3RRdWV1ZSA9IHt9OwogIAogIC8qKgogICAqIENhbGwgZW5kcG9pbnQgZGlzY292ZXJ5IG9wZXJhdGlvbiB3aGVuIGl0J3MgcmVxdWlyZWQuCiAgICogV2hlbiBlbmRwb2ludCBpcyBhdmFpbGFibGUgaW4gY2FjaGUgdGhlbiB1c2UgY2FjaGVkIG9uZXMuIElmIGVuZHBvaW50cyBhcmUKICAgKiB1bmF2YWlsYWJsZSB0aGVuIFNESyBzaG91bGQgY2FsbCBlbmRwb2ludCBvcGVyYXRpb24gdGhlbiB1c2UgcmV0dXJuZWQgbmV3CiAgICogZW5kcG9pbnQgZm9yIHRoZSBhcGkgY2FsbC4gU0RLIHdpbGwgYXV0b21hdGljYWxseSBhdHRlbXB0IHRvIGRvIGVuZHBvaW50CiAgICogZGlzY292ZXJ5LiBUaGlzIGlzIHR1cm5lZCBvZmYgYnkgZGVmYXVsdAogICAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0IG9iamVjdAogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHJlcXVpcmVkRGlzY292ZXJFbmRwb2ludChyZXF1ZXN0LCBkb25lKSB7CiAgICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZTsKICAgIHZhciBhcGkgPSBzZXJ2aWNlLmFwaTsKICAgIHZhciBvcGVyYXRpb25Nb2RlbCA9IGFwaS5vcGVyYXRpb25zID8gYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dIDogdW5kZWZpbmVkOwogICAgdmFyIGlucHV0U2hhcGUgPSBvcGVyYXRpb25Nb2RlbCA/IG9wZXJhdGlvbk1vZGVsLmlucHV0IDogdW5kZWZpbmVkOwogIAogICAgdmFyIGlkZW50aWZpZXJzID0gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycyhyZXF1ZXN0LCBpbnB1dFNoYXBlKTsKICAgIHZhciBjYWNoZUtleSA9IGdldENhY2hlS2V5KHJlcXVlc3QpOwogICAgaWYgKE9iamVjdC5rZXlzKGlkZW50aWZpZXJzKS5sZW5ndGggPiAwKSB7CiAgICAgIGNhY2hlS2V5ID0gdXRpbC51cGRhdGUoY2FjaGVLZXksIGlkZW50aWZpZXJzKTsKICAgICAgaWYgKG9wZXJhdGlvbk1vZGVsKSBjYWNoZUtleS5vcGVyYXRpb24gPSBvcGVyYXRpb25Nb2RlbC5uYW1lOwogICAgfQogICAgdmFyIGNhY2hlS2V5U3RyID0gQVdTLkVuZHBvaW50Q2FjaGUuZ2V0S2V5U3RyaW5nKGNhY2hlS2V5KTsKICAgIHZhciBlbmRwb2ludHMgPSBBV1MuZW5kcG9pbnRDYWNoZS5nZXQoY2FjaGVLZXlTdHIpOyAvL2VuZHBvaW50IGNhY2hlIGFsc28gYWNjZXB0cyBzdHJpbmcga2V5cwogICAgaWYgKGVuZHBvaW50cyAmJiBlbmRwb2ludHMubGVuZ3RoID09PSAxICYmIGVuZHBvaW50c1swXS5BZGRyZXNzID09PSAnJykgewogICAgICAvL2VuZHBvaW50IG9wZXJhdGlvbiBpcyBiZWluZyBtYWRlIGJ1dCByZXNwb25zZSBub3QgeWV0IHJlY2VpdmVkCiAgICAgIC8vcHVzaCByZXF1ZXN0IG9iamVjdCB0byBhIHBlbmRpbmcgcXVldWUKICAgICAgaWYgKCFyZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdKSByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdID0gW107CiAgICAgIHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0ucHVzaCh7cmVxdWVzdDogcmVxdWVzdCwgY2FsbGJhY2s6IGRvbmV9KTsKICAgICAgcmV0dXJuOwogICAgfSBlbHNlIGlmIChlbmRwb2ludHMgJiYgZW5kcG9pbnRzLmxlbmd0aCA+IDApIHsKICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC51cGRhdGVFbmRwb2ludChlbmRwb2ludHNbMF0uQWRkcmVzcyk7CiAgICAgIGRvbmUoKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBlbmRwb2ludFJlcXVlc3QgPSBzZXJ2aWNlLm1ha2VSZXF1ZXN0KGFwaS5lbmRwb2ludE9wZXJhdGlvbiwgewogICAgICAgIE9wZXJhdGlvbjogb3BlcmF0aW9uTW9kZWwubmFtZSwKICAgICAgICBJZGVudGlmaWVyczogaWRlbnRpZmllcnMsCiAgICAgIH0pOwogICAgICBlbmRwb2ludFJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUEFSQU1FVEVSUyk7CiAgICAgIGFkZEFwaVZlcnNpb25IZWFkZXIoZW5kcG9pbnRSZXF1ZXN0KTsKICAKICAgICAgLy9wdXQgaW4gYSBwbGFjZWhvbGRlciBmb3IgZW5kcG9pbnRzIGFscmVhZHkgcmVxdWVzdGVkLCBwcmV2ZW50CiAgICAgIC8vdG9vIG11Y2ggaW4tZmxpZ2h0IGNhbGxzCiAgICAgIEFXUy5lbmRwb2ludENhY2hlLnB1dChjYWNoZUtleVN0ciwgW3sKICAgICAgICBBZGRyZXNzOiAnJywKICAgICAgICBDYWNoZVBlcmlvZEluTWludXRlczogNjAgLy9sb25nLWxpdmUgY2FjaGUKICAgICAgfV0pOwogICAgICBlbmRwb2ludFJlcXVlc3Quc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICB2YXIgZXJyb3JQYXJhbXMgPSB7CiAgICAgICAgICAgIGNvZGU6ICdFbmRwb2ludERpc2NvdmVyeUV4Y2VwdGlvbicsCiAgICAgICAgICAgIG1lc3NhZ2U6ICdSZXF1ZXN0IGNhbm5vdCBiZSBmdWxmaWxsZWQgd2l0aG91dCBzcGVjaWZ5aW5nIGFuIGVuZHBvaW50JywKICAgICAgICAgICAgcmV0cnlhYmxlOiBmYWxzZQogICAgICAgICAgfTsKICAgICAgICAgIHJlcXVlc3QucmVzcG9uc2UuZXJyb3IgPSB1dGlsLmVycm9yKGVyciwgZXJyb3JQYXJhbXMpOwogICAgICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucmVtb3ZlKGNhY2hlS2V5KTsKICAKICAgICAgICAgIC8vZmFpbCBhbGwgdGhlIHBlbmRpbmcgcmVxdWVzdHMgaW4gYmF0Y2gKICAgICAgICAgIGlmIChyZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdKSB7CiAgICAgICAgICAgIHZhciBwZW5kaW5nUmVxdWVzdHMgPSByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdOwogICAgICAgICAgICB1dGlsLmFycmF5RWFjaChwZW5kaW5nUmVxdWVzdHMsIGZ1bmN0aW9uKHJlcXVlc3RDb250ZXh0KSB7CiAgICAgICAgICAgICAgcmVxdWVzdENvbnRleHQucmVxdWVzdC5yZXNwb25zZS5lcnJvciA9IHV0aWwuZXJyb3IoZXJyLCBlcnJvclBhcmFtcyk7CiAgICAgICAgICAgICAgcmVxdWVzdENvbnRleHQuY2FsbGJhY2soKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRlbGV0ZSByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoZGF0YSkgewogICAgICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucHV0KGNhY2hlS2V5U3RyLCBkYXRhLkVuZHBvaW50cyk7CiAgICAgICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnVwZGF0ZUVuZHBvaW50KGRhdGEuRW5kcG9pbnRzWzBdLkFkZHJlc3MpOwogIAogICAgICAgICAgLy91cGRhdGUgdGhlIGVuZHBvaW50IGZvciBhbGwgdGhlIHBlbmRpbmcgcmVxdWVzdHMgaW4gYmF0Y2gKICAgICAgICAgIGlmIChyZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdKSB7CiAgICAgICAgICAgIHZhciBwZW5kaW5nUmVxdWVzdHMgPSByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdOwogICAgICAgICAgICB1dGlsLmFycmF5RWFjaChwZW5kaW5nUmVxdWVzdHMsIGZ1bmN0aW9uKHJlcXVlc3RDb250ZXh0KSB7CiAgICAgICAgICAgICAgcmVxdWVzdENvbnRleHQucmVxdWVzdC5odHRwUmVxdWVzdC51cGRhdGVFbmRwb2ludChkYXRhLkVuZHBvaW50c1swXS5BZGRyZXNzKTsKICAgICAgICAgICAgICByZXF1ZXN0Q29udGV4dC5jYWxsYmFjaygpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZGVsZXRlIHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGRvbmUoKTsKICAgICAgfSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIGFkZCBhcGkgdmVyc2lvbiBoZWFkZXIgdG8gZW5kcG9pbnQgb3BlcmF0aW9uCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gYWRkQXBpVmVyc2lvbkhlYWRlcihlbmRwb2ludFJlcXVlc3QpIHsKICAgIHZhciBhcGkgPSBlbmRwb2ludFJlcXVlc3Quc2VydmljZS5hcGk7CiAgICB2YXIgYXBpVmVyc2lvbiA9IGFwaS5hcGlWZXJzaW9uOwogICAgaWYgKGFwaVZlcnNpb24gJiYgIWVuZHBvaW50UmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWyd4LWFtei1hcGktdmVyc2lvbiddKSB7CiAgICAgIGVuZHBvaW50UmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWyd4LWFtei1hcGktdmVyc2lvbiddID0gYXBpVmVyc2lvbjsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogSWYgYXBpIGNhbGwgZ2V0cyBpbnZhbGlkIGVuZHBvaW50IGV4Y2VwdGlvbiwgU0RLIHNob3VsZCBhdHRlbXB0IHRvIHJlbW92ZSB0aGUgaW52YWxpZAogICAqIGVuZHBvaW50IGZyb20gY2FjaGUuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50cyhyZXNwb25zZSkgewogICAgdmFyIGVycm9yID0gcmVzcG9uc2UuZXJyb3I7CiAgICB2YXIgaHR0cFJlc3BvbnNlID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlOwogICAgaWYgKGVycm9yICYmCiAgICAgIChlcnJvci5jb2RlID09PSAnSW52YWxpZEVuZHBvaW50RXhjZXB0aW9uJyB8fCBodHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gNDIxKQogICAgKSB7CiAgICAgIHZhciByZXF1ZXN0ID0gcmVzcG9uc2UucmVxdWVzdDsKICAgICAgdmFyIG9wZXJhdGlvbnMgPSByZXF1ZXN0LnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMgfHwge307CiAgICAgIHZhciBpbnB1dFNoYXBlID0gb3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0gPyBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXS5pbnB1dCA6IHVuZGVmaW5lZDsKICAgICAgdmFyIGlkZW50aWZpZXJzID0gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycyhyZXF1ZXN0LCBpbnB1dFNoYXBlKTsKICAgICAgdmFyIGNhY2hlS2V5ID0gZ2V0Q2FjaGVLZXkocmVxdWVzdCk7CiAgICAgIGlmIChPYmplY3Qua2V5cyhpZGVudGlmaWVycykubGVuZ3RoID4gMCkgewogICAgICAgIGNhY2hlS2V5ID0gdXRpbC51cGRhdGUoY2FjaGVLZXksIGlkZW50aWZpZXJzKTsKICAgICAgICBpZiAob3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0pIGNhY2hlS2V5Lm9wZXJhdGlvbiA9IG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dLm5hbWU7CiAgICAgIH0KICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucmVtb3ZlKGNhY2hlS2V5KTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogSWYgZW5kcG9pbnQgaXMgZXhwbGljaXRseSBjb25maWd1cmVkLCBTREsgc2hvdWxkIG5vdCBkbyBlbmRwb2ludCBkaXNjb3ZlcnkgaW4gYW55dGltZS4KICAgKiBAcGFyYW0gW29iamVjdF0gY2xpZW50IFNlcnZpY2UgY2xpZW50IG9iamVjdC4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBoYXNDdXN0b21FbmRwb2ludChjbGllbnQpIHsKICAgIC8vaWYgc2V0IGVuZHBvaW50IGlzIHNldCBmb3Igc3BlY2lmaWMgY2xpZW50LCBlbmFibGUgZW5kcG9pbnQgZGlzY292ZXJ5IHdpbGwgcmFpc2UgYW4gZXJyb3IuCiAgICBpZiAoY2xpZW50Ll9vcmlnaW5hbENvbmZpZyAmJiBjbGllbnQuX29yaWdpbmFsQ29uZmlnLmVuZHBvaW50ICYmIGNsaWVudC5fb3JpZ2luYWxDb25maWcuZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkID09PSB0cnVlKSB7CiAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiAnQ29uZmlndXJhdGlvbkV4Y2VwdGlvbicsCiAgICAgICAgbWVzc2FnZTogJ0N1c3RvbSBlbmRwb2ludCBpcyBzdXBwbGllZDsgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkIG11c3Qgbm90IGJlIHRydWUuJwogICAgICB9KTsKICAgIH07CiAgICB2YXIgc3ZjQ29uZmlnID0gQVdTLmNvbmZpZ1tjbGllbnQuc2VydmljZUlkZW50aWZpZXJdIHx8IHt9OwogICAgcmV0dXJuIEJvb2xlYW4oQVdTLmNvbmZpZy5lbmRwb2ludCB8fCBzdmNDb25maWcuZW5kcG9pbnQgfHwgKGNsaWVudC5fb3JpZ2luYWxDb25maWcgJiYgY2xpZW50Ll9vcmlnaW5hbENvbmZpZy5lbmRwb2ludCkpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBpc0ZhbHN5KHZhbHVlKSB7CiAgICByZXR1cm4gWydmYWxzZScsICcwJ10uaW5kZXhPZih2YWx1ZSkgPj0gMDsKICB9CiAgCiAgLyoqCiAgICogSWYgZW5kcG9pbnQgZGlzY292ZXJ5IHNob3VsZCBwZXJmb3JtIGZvciB0aGlzIHJlcXVlc3Qgd2hlbiBlbmRwb2ludCBkaXNjb3ZlcnkgaXMgb3B0aW9uYWwuCiAgICogU0RLIHBlcmZvcm1zIGNvbmZpZyByZXNvbHV0aW9uIGluIG9yZGVyIGxpa2UgYmVsb3c6CiAgICogMS4gSWYgdHVybmVkIG9uIGNsaWVudCBjb25maWd1cmF0aW9uKGRlZmF1bHQgdG8gb2ZmKSB0aGVuIHR1cm4gb24gZW5kcG9pbnQgZGlzY292ZXJ5LgogICAqIDIuIElmIHR1cm5lZCBvbiBpbiBlbnYgQVdTX0VOQUJMRV9FTkRQT0lOVF9ESVNDT1ZFUlkgdGhlbiB0dXJuIG9uIGVuZHBvaW50IGRpc2NvdmVyeS4KICAgKiAzLiBJZiB0dXJuZWQgb24gaW4gc2hhcmVkIGluaSBjb25maWcgZmlsZSB3aXRoIGtleSAnZW5kcG9pbnRfZGlzY292ZXJ5X2VuYWJsZWQnLCB0aGVuCiAgICogICB0dXJuIG9uIGVuZHBvaW50IGRpc2NvdmVyeS4KICAgKiBAcGFyYW0gW29iamVjdF0gcmVxdWVzdCByZXF1ZXN0IG9iamVjdC4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBpc0VuZHBvaW50RGlzY292ZXJ5QXBwbGljYWJsZShyZXF1ZXN0KSB7CiAgICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZSB8fCB7fTsKICAgIGlmIChzZXJ2aWNlLmNvbmZpZy5lbmRwb2ludERpc2NvdmVyeUVuYWJsZWQgPT09IHRydWUpIHJldHVybiB0cnVlOwogIAogICAgLy9zaGFyZWQgaW5pIGZpbGUgaXMgb25seSBhdmFpbGFibGUgaW4gTm9kZQogICAgLy9ub3QgdG8gY2hlY2sgZW52IGluIGJyb3dzZXIKICAgIGlmICh1dGlsLmlzQnJvd3NlcigpKSByZXR1cm4gZmFsc2U7CiAgCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZEVudnMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGVudiA9IGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZEVudnNbaV07CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocHJvY2Vzcy5lbnYsIGVudikpIHsKICAgICAgICBpZiAocHJvY2Vzcy5lbnZbZW52XSA9PT0gJycgfHwgcHJvY2Vzcy5lbnZbZW52XSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICAgIGNvZGU6ICdDb25maWd1cmF0aW9uRXhjZXB0aW9uJywKICAgICAgICAgICAgbWVzc2FnZTogJ2Vudmlyb25tZW50YWwgdmFyaWFibGUgJyArIGVudiArICcgY2Fubm90IGJlIHNldCB0byBub3RoaW5nJwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICghaXNGYWxzeShwcm9jZXNzLmVudltlbnZdKSkgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KICAKICAgIHZhciBjb25maWdGaWxlID0ge307CiAgICB0cnkgewogICAgICBjb25maWdGaWxlID0gQVdTLnV0aWwuaW5pTG9hZGVyID8gQVdTLnV0aWwuaW5pTG9hZGVyLmxvYWRGcm9tKHsKICAgICAgICBpc0NvbmZpZzogdHJ1ZSwKICAgICAgICBmaWxlbmFtZTogcHJvY2Vzcy5lbnZbQVdTLnV0aWwuc2hhcmVkQ29uZmlnRmlsZUVudl0KICAgICAgfSkgOiB7fTsKICAgIH0gY2F0Y2ggKGUpIHt9CiAgICB2YXIgc2hhcmVkRmlsZUNvbmZpZyA9IGNvbmZpZ0ZpbGVbCiAgICAgIHByb2Nlc3MuZW52LkFXU19QUk9GSUxFIHx8IEFXUy51dGlsLmRlZmF1bHRQcm9maWxlCiAgICBdIHx8IHt9OwogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzaGFyZWRGaWxlQ29uZmlnLCAnZW5kcG9pbnRfZGlzY292ZXJ5X2VuYWJsZWQnKSkgewogICAgICBpZiAoc2hhcmVkRmlsZUNvbmZpZy5lbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgICAgY29kZTogJ0NvbmZpZ3VyYXRpb25FeGNlcHRpb24nLAogICAgICAgICAgbWVzc2FnZTogJ2NvbmZpZyBmaWxlIGVudHJ5IFwnZW5kcG9pbnRfZGlzY292ZXJ5X2VuYWJsZWRcJyBjYW5ub3QgYmUgc2V0IHRvIG5vdGhpbmcnCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKCFpc0ZhbHN5KHNoYXJlZEZpbGVDb25maWcuZW5kcG9pbnRfZGlzY292ZXJ5X2VuYWJsZWQpKSByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgCiAgLyoqCiAgICogYXR0YWNoIGVuZHBvaW50IGRpc2NvdmVyeSBsb2dpYyB0byByZXF1ZXN0IG9iamVjdAogICAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0CiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gZGlzY292ZXJFbmRwb2ludChyZXF1ZXN0LCBkb25lKSB7CiAgICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZSB8fCB7fTsKICAgIGlmIChoYXNDdXN0b21FbmRwb2ludChzZXJ2aWNlKSB8fCByZXF1ZXN0LmlzUHJlc2lnbmVkKCkpIHJldHVybiBkb25lKCk7CiAgCiAgICBpZiAoIWlzRW5kcG9pbnREaXNjb3ZlcnlBcHBsaWNhYmxlKHJlcXVlc3QpKSByZXR1cm4gZG9uZSgpOwogIAogICAgcmVxdWVzdC5odHRwUmVxdWVzdC5hcHBlbmRUb1VzZXJBZ2VudCgnZW5kcG9pbnQtZGlzY292ZXJ5Jyk7CiAgCiAgICB2YXIgb3BlcmF0aW9ucyA9IHNlcnZpY2UuYXBpLm9wZXJhdGlvbnMgfHwge307CiAgICB2YXIgb3BlcmF0aW9uTW9kZWwgPSBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXTsKICAgIHZhciBpc0VuZHBvaW50RGlzY292ZXJ5UmVxdWlyZWQgPSBvcGVyYXRpb25Nb2RlbCA/IG9wZXJhdGlvbk1vZGVsLmVuZHBvaW50RGlzY292ZXJ5UmVxdWlyZWQgOiAnTlVMTCc7CiAgICBzd2l0Y2ggKGlzRW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCkgewogICAgICBjYXNlICdPUFRJT05BTCc6CiAgICAgICAgb3B0aW9uYWxEaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QpOwogICAgICAgIHJlcXVlc3QuYWRkTmFtZWRMaXN0ZW5lcignSU5WQUxJREFURV9DQUNIRURfRU5EUE9JTlRTJywgJ2V4dHJhY3RFcnJvcicsIGludmFsaWRhdGVDYWNoZWRFbmRwb2ludHMpOwogICAgICAgIGRvbmUoKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnUkVRVUlSRUQnOgogICAgICAgIHJlcXVlc3QuYWRkTmFtZWRMaXN0ZW5lcignSU5WQUxJREFURV9DQUNIRURfRU5EUE9JTlRTJywgJ2V4dHJhY3RFcnJvcicsIGludmFsaWRhdGVDYWNoZWRFbmRwb2ludHMpOwogICAgICAgIHJlcXVpcmVkRGlzY292ZXJFbmRwb2ludChyZXF1ZXN0LCBkb25lKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnTlVMTCc6CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgZG9uZSgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KICAKICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIGRpc2NvdmVyRW5kcG9pbnQ6IGRpc2NvdmVyRW5kcG9pbnQsCiAgICByZXF1aXJlZERpc2NvdmVyRW5kcG9pbnQ6IHJlcXVpcmVkRGlzY292ZXJFbmRwb2ludCwKICAgIG9wdGlvbmFsRGlzY292ZXJFbmRwb2ludDogb3B0aW9uYWxEaXNjb3ZlckVuZHBvaW50LAogICAgbWFyc2hhbGxDdXN0b21JZGVudGlmaWVyczogbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycywKICAgIGdldENhY2hlS2V5OiBnZXRDYWNoZUtleSwKICAgIGludmFsaWRhdGVDYWNoZWRFbmRwb2ludDogaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50cywKICB9OwogIAogIH0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQogIH0seyIuL2NvcmUiOjE4LCIuL3V0aWwiOjcxLCJfcHJvY2VzcyI6ODV9XSwyNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIGV2ZW50TWVzc2FnZUNodW5rZXIgPSByZXF1aXJlKCcuLi9ldmVudC1zdHJlYW0vZXZlbnQtbWVzc2FnZS1jaHVua2VyJykuZXZlbnRNZXNzYWdlQ2h1bmtlcjsKICB2YXIgcGFyc2VFdmVudCA9IHJlcXVpcmUoJy4vcGFyc2UtZXZlbnQnKS5wYXJzZUV2ZW50OwogIAogIGZ1bmN0aW9uIGNyZWF0ZUV2ZW50U3RyZWFtKGJvZHksIHBhcnNlciwgbW9kZWwpIHsKICAgICAgdmFyIGV2ZW50TWVzc2FnZXMgPSBldmVudE1lc3NhZ2VDaHVua2VyKGJvZHkpOwogIAogICAgICB2YXIgZXZlbnRzID0gW107CiAgCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnRNZXNzYWdlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgZXZlbnRzLnB1c2gocGFyc2VFdmVudChwYXJzZXIsIGV2ZW50TWVzc2FnZXNbaV0sIG1vZGVsKSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIGV2ZW50czsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGNyZWF0ZUV2ZW50U3RyZWFtOiBjcmVhdGVFdmVudFN0cmVhbQogIH07CiAgCiAgfSx7Ii4uL2V2ZW50LXN0cmVhbS9ldmVudC1tZXNzYWdlLWNodW5rZXIiOjI4LCIuL3BhcnNlLWV2ZW50IjozMH1dLDI4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvKioKICAgKiBUYWtlcyBpbiBhIGJ1ZmZlciBvZiBldmVudCBtZXNzYWdlcyBhbmQgc3BsaXRzIHRoZW0gaW50byBpbmRpdmlkdWFsIG1lc3NhZ2VzLgogICAqIEBwYXJhbSB7QnVmZmVyfSBidWZmZXIKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBldmVudE1lc3NhZ2VDaHVua2VyKGJ1ZmZlcikgewogICAgICAvKiogQHR5cGUgQnVmZmVyW10gKi8KICAgICAgdmFyIG1lc3NhZ2VzID0gW107CiAgICAgIHZhciBvZmZzZXQgPSAwOwogIAogICAgICB3aGlsZSAob2Zmc2V0IDwgYnVmZmVyLmxlbmd0aCkgewogICAgICAgICAgdmFyIHRvdGFsTGVuZ3RoID0gYnVmZmVyLnJlYWRJbnQzMkJFKG9mZnNldCk7CiAgCiAgICAgICAgICAvLyBjcmVhdGUgbmV3IGJ1ZmZlciBmb3IgaW5kaXZpZHVhbCBtZXNzYWdlIChzaGFyZXMgbWVtb3J5IHdpdGggb3JpZ2luYWwpCiAgICAgICAgICB2YXIgbWVzc2FnZSA9IGJ1ZmZlci5zbGljZShvZmZzZXQsIHRvdGFsTGVuZ3RoICsgb2Zmc2V0KTsKICAgICAgICAgIC8vIGluY3JlbWVudCBvZmZzZXQgdG8gaXQgc3RhcnRzIGF0IHRoZSBuZXh0IG1lc3NhZ2UKICAgICAgICAgIG9mZnNldCArPSB0b3RhbExlbmd0aDsKICAKICAgICAgICAgIG1lc3NhZ2VzLnB1c2gobWVzc2FnZSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIG1lc3NhZ2VzOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgZXZlbnRNZXNzYWdlQ2h1bmtlcjogZXZlbnRNZXNzYWdlQ2h1bmtlcgogIH07CiAgCiAgfSx7fV0sMjk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vY29yZScpLnV0aWw7CiAgdmFyIHRvQnVmZmVyID0gdXRpbC5idWZmZXIudG9CdWZmZXI7CiAgCiAgLyoqCiAgICogQSBsb3NzbGVzcyByZXByZXNlbnRhdGlvbiBvZiBhIHNpZ25lZCwgNjQtYml0IGludGVnZXIuIEluc3RhbmNlcyBvZiB0aGlzCiAgICogY2xhc3MgbWF5IGJlIHVzZWQgaW4gYXJpdGhtZXRpYyBleHByZXNzaW9ucyBhcyBpZiB0aGV5IHdlcmUgbnVtZXJpYwogICAqIHByaW1pdGl2ZXMsIGJ1dCB0aGUgYmluYXJ5IHJlcHJlc2VudGF0aW9uIHdpbGwgYmUgcHJlc2VydmVkIHVuY2hhbmdlZCBhcyB0aGUKICAgKiBgYnl0ZXNgIHByb3BlcnR5IG9mIHRoZSBvYmplY3QuIFRoZSBieXRlcyBzaG91bGQgYmUgZW5jb2RlZCBhcyBiaWctZW5kaWFuLAogICAqIHR3bydzIGNvbXBsZW1lbnQgaW50ZWdlcnMuCiAgICogQHBhcmFtIHtCdWZmZXJ9IGJ5dGVzCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBJbnQ2NChieXRlcykgewogICAgICBpZiAoYnl0ZXMubGVuZ3RoICE9PSA4KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludDY0IGJ1ZmZlcnMgbXVzdCBiZSBleGFjdGx5IDggYnl0ZXMnKTsKICAgICAgfQogICAgICBpZiAoIXV0aWwuQnVmZmVyLmlzQnVmZmVyKGJ5dGVzKSkgYnl0ZXMgPSB0b0J1ZmZlcihieXRlcyk7CiAgCiAgICAgIHRoaXMuYnl0ZXMgPSBieXRlczsKICB9CiAgCiAgLyoqCiAgICogQHBhcmFtIHtudW1iZXJ9IG51bWJlcgogICAqIEByZXR1cm5zIHtJbnQ2NH0KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEludDY0LmZyb21OdW1iZXIgPSBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgaWYgKG51bWJlciA+IDkyMjMzNzIwMzY4NTQ3NzU4MDcgfHwgbnVtYmVyIDwgLTkyMjMzNzIwMzY4NTQ3NzU4MDgpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICBudW1iZXIgKyAnIGlzIHRvbyBsYXJnZSAob3IsIGlmIG5lZ2F0aXZlLCB0b28gc21hbGwpIHRvIHJlcHJlc2VudCBhcyBhbiBJbnQ2NCcKICAgICAgICAgICk7CiAgICAgIH0KICAKICAgICAgdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkoOCk7CiAgICAgIGZvciAoCiAgICAgICAgICB2YXIgaSA9IDcsIHJlbWFpbmluZyA9IE1hdGguYWJzKE1hdGgucm91bmQobnVtYmVyKSk7CiAgICAgICAgICBpID4gLTEgJiYgcmVtYWluaW5nID4gMDsKICAgICAgICAgIGktLSwgcmVtYWluaW5nIC89IDI1NgogICAgICApIHsKICAgICAgICAgIGJ5dGVzW2ldID0gcmVtYWluaW5nOwogICAgICB9CiAgCiAgICAgIGlmIChudW1iZXIgPCAwKSB7CiAgICAgICAgICBuZWdhdGUoYnl0ZXMpOwogICAgICB9CiAgCiAgICAgIHJldHVybiBuZXcgSW50NjQoYnl0ZXMpOwogIH07CiAgCiAgLyoqCiAgICogQHJldHVybnMge251bWJlcn0KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEludDY0LnByb3RvdHlwZS52YWx1ZU9mID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBieXRlcyA9IHRoaXMuYnl0ZXMuc2xpY2UoMCk7CiAgICAgIHZhciBuZWdhdGl2ZSA9IGJ5dGVzWzBdICYgMTI4OwogICAgICBpZiAobmVnYXRpdmUpIHsKICAgICAgICAgIG5lZ2F0ZShieXRlcyk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHBhcnNlSW50KGJ5dGVzLnRvU3RyaW5nKCdoZXgnKSwgMTYpICogKG5lZ2F0aXZlID8gLTEgOiAxKTsKICB9OwogIAogIEludDY0LnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gU3RyaW5nKHRoaXMudmFsdWVPZigpKTsKICB9OwogIAogIC8qKgogICAqIEBwYXJhbSB7QnVmZmVyfSBieXRlcwogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gbmVnYXRlKGJ5dGVzKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgODsgaSsrKSB7CiAgICAgICAgICBieXRlc1tpXSBePSAweEZGOwogICAgICB9CiAgICAgIGZvciAodmFyIGkgPSA3OyBpID4gLTE7IGktLSkgewogICAgICAgICAgYnl0ZXNbaV0rKzsKICAgICAgICAgIGlmIChieXRlc1tpXSAhPT0gMCkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBJbnQ2NDogSW50NjQKICB9OwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDMwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgcGFyc2VNZXNzYWdlID0gcmVxdWlyZSgnLi9wYXJzZS1tZXNzYWdlJykucGFyc2VNZXNzYWdlOwogIAogIC8qKgogICAqCiAgICogQHBhcmFtIHsqfSBwYXJzZXIKICAgKiBAcGFyYW0ge0J1ZmZlcn0gbWVzc2FnZQogICAqIEBwYXJhbSB7Kn0gc2hhcGUKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBwYXJzZUV2ZW50KHBhcnNlciwgbWVzc2FnZSwgc2hhcGUpIHsKICAgICAgdmFyIHBhcnNlZE1lc3NhZ2UgPSBwYXJzZU1lc3NhZ2UobWVzc2FnZSk7CiAgCiAgICAgIC8vIGNoZWNrIGlmIG1lc3NhZ2UgaXMgYW4gZXZlbnQgb3IgZXJyb3IKICAgICAgdmFyIG1lc3NhZ2VUeXBlID0gcGFyc2VkTWVzc2FnZS5oZWFkZXJzWyc6bWVzc2FnZS10eXBlJ107CiAgICAgIGlmIChtZXNzYWdlVHlwZSkgewogICAgICAgICAgaWYgKG1lc3NhZ2VUeXBlLnZhbHVlID09PSAnZXJyb3InKSB7CiAgICAgICAgICAgICAgdGhyb3cgcGFyc2VFcnJvcihwYXJzZWRNZXNzYWdlKTsKICAgICAgICAgIH0gZWxzZSBpZiAobWVzc2FnZVR5cGUudmFsdWUgIT09ICdldmVudCcpIHsKICAgICAgICAgICAgICAvLyBub3Qgc3VyZSBob3cgdG8gcGFyc2Ugbm9uLWV2ZW50cy9ub24tZXJyb3JzLCBpZ25vcmUgZm9yIG5vdwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgfQogIAogICAgICAvLyBkZXRlcm1pbmUgZXZlbnQgdHlwZQogICAgICB2YXIgZXZlbnRUeXBlID0gcGFyc2VkTWVzc2FnZS5oZWFkZXJzWyc6ZXZlbnQtdHlwZSddOwogICAgICAvLyBjaGVjayB0aGF0IHRoZSBldmVudCB0eXBlIGlzIG1vZGVsZWQKICAgICAgdmFyIGV2ZW50TW9kZWwgPSBzaGFwZS5tZW1iZXJzW2V2ZW50VHlwZS52YWx1ZV07CiAgICAgIGlmICghZXZlbnRNb2RlbCkgewogICAgICAgICAgcmV0dXJuOwogICAgICB9CiAgCiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgLy8gY2hlY2sgaWYgYW4gZXZlbnQgcGF5bG9hZCBleGlzdHMKICAgICAgdmFyIGV2ZW50UGF5bG9hZE1lbWJlck5hbWUgPSBldmVudE1vZGVsLmV2ZW50UGF5bG9hZE1lbWJlck5hbWU7CiAgICAgIGlmIChldmVudFBheWxvYWRNZW1iZXJOYW1lKSB7CiAgICAgICAgICB2YXIgcGF5bG9hZFNoYXBlID0gZXZlbnRNb2RlbC5tZW1iZXJzW2V2ZW50UGF5bG9hZE1lbWJlck5hbWVdOwogICAgICAgICAgLy8gaWYgdGhlIHNoYXBlIGlzIGJpbmFyeSwgcmV0dXJuIHRoZSBieXRlIGFycmF5CiAgICAgICAgICBpZiAocGF5bG9hZFNoYXBlLnR5cGUgPT09ICdiaW5hcnknKSB7CiAgICAgICAgICAgICAgcmVzdWx0W2V2ZW50UGF5bG9hZE1lbWJlck5hbWVdID0gcGFyc2VkTWVzc2FnZS5ib2R5OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXN1bHRbZXZlbnRQYXlsb2FkTWVtYmVyTmFtZV0gPSBwYXJzZXIucGFyc2UocGFyc2VkTWVzc2FnZS5ib2R5LnRvU3RyaW5nKCksIHBheWxvYWRTaGFwZSk7CiAgICAgICAgICB9CiAgICAgIH0KICAKICAgICAgLy8gcmVhZCBldmVudCBoZWFkZXJzCiAgICAgIHZhciBldmVudEhlYWRlck5hbWVzID0gZXZlbnRNb2RlbC5ldmVudEhlYWRlck1lbWJlck5hbWVzOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50SGVhZGVyTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBuYW1lID0gZXZlbnRIZWFkZXJOYW1lc1tpXTsKICAgICAgICAgIGlmIChwYXJzZWRNZXNzYWdlLmhlYWRlcnNbbmFtZV0pIHsKICAgICAgICAgICAgICAvLyBwYXJzZSB0aGUgaGVhZGVyIQogICAgICAgICAgICAgIHJlc3VsdFtuYW1lXSA9IGV2ZW50TW9kZWwubWVtYmVyc1tuYW1lXS50b1R5cGUocGFyc2VkTWVzc2FnZS5oZWFkZXJzW25hbWVdLnZhbHVlKTsKICAgICAgICAgIH0KICAgICAgfQogIAogICAgICB2YXIgb3V0cHV0ID0ge307CiAgICAgIG91dHB1dFtldmVudFR5cGUudmFsdWVdID0gcmVzdWx0OwogICAgICByZXR1cm4gb3V0cHV0OwogIH0KICAKICBmdW5jdGlvbiBwYXJzZUVycm9yKG1lc3NhZ2UpIHsKICAgICAgdmFyIGVycm9yQ29kZSA9IG1lc3NhZ2UuaGVhZGVyc1snOmVycm9yLWNvZGUnXTsKICAgICAgdmFyIGVycm9yTWVzc2FnZSA9IG1lc3NhZ2UuaGVhZGVyc1snOmVycm9yLW1lc3NhZ2UnXTsKICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKGVycm9yTWVzc2FnZS52YWx1ZSB8fCBlcnJvck1lc3NhZ2UpOwogICAgICBlcnJvci5jb2RlID0gZXJyb3IubmFtZSA9IGVycm9yQ29kZS52YWx1ZSB8fCBlcnJvckNvZGU7CiAgICAgIHJldHVybiBlcnJvcjsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIHBhcnNlRXZlbnQ6IHBhcnNlRXZlbnQKICB9OwogIAogIH0seyIuL3BhcnNlLW1lc3NhZ2UiOjMxfV0sMzE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBJbnQ2NCA9IHJlcXVpcmUoJy4vaW50NjQnKS5JbnQ2NDsKICAKICB2YXIgc3BsaXRNZXNzYWdlID0gcmVxdWlyZSgnLi9zcGxpdC1tZXNzYWdlJykuc3BsaXRNZXNzYWdlOwogIAogIHZhciBCT09MRUFOX1RBRyA9ICdib29sZWFuJzsKICB2YXIgQllURV9UQUcgPSAnYnl0ZSc7CiAgdmFyIFNIT1JUX1RBRyA9ICdzaG9ydCc7CiAgdmFyIElOVF9UQUcgPSAnaW50ZWdlcic7CiAgdmFyIExPTkdfVEFHID0gJ2xvbmcnOwogIHZhciBCSU5BUllfVEFHID0gJ2JpbmFyeSc7CiAgdmFyIFNUUklOR19UQUcgPSAnc3RyaW5nJzsKICB2YXIgVElNRVNUQU1QX1RBRyA9ICd0aW1lc3RhbXAnOwogIHZhciBVVUlEX1RBRyA9ICd1dWlkJzsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKgogICAqIEBwYXJhbSB7QnVmZmVyfSBoZWFkZXJzCiAgICovCiAgZnVuY3Rpb24gcGFyc2VIZWFkZXJzKGhlYWRlcnMpIHsKICAgICAgdmFyIG91dCA9IHt9OwogICAgICB2YXIgcG9zaXRpb24gPSAwOwogICAgICB3aGlsZSAocG9zaXRpb24gPCBoZWFkZXJzLmxlbmd0aCkgewogICAgICAgICAgdmFyIG5hbWVMZW5ndGggPSBoZWFkZXJzLnJlYWRVSW50OChwb3NpdGlvbisrKTsKICAgICAgICAgIHZhciBuYW1lID0gaGVhZGVycy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyBuYW1lTGVuZ3RoKS50b1N0cmluZygpOwogICAgICAgICAgcG9zaXRpb24gKz0gbmFtZUxlbmd0aDsKICAgICAgICAgIHN3aXRjaCAoaGVhZGVycy5yZWFkVUludDgocG9zaXRpb24rKykpIHsKICAgICAgICAgICAgICBjYXNlIDAgLyogYm9vbFRydWUgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IEJPT0xFQU5fVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHRydWUKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAxIC8qIGJvb2xGYWxzZSAqLzoKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogQk9PTEVBTl9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZmFsc2UKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAyIC8qIGJ5dGUgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IEJZVEVfVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGhlYWRlcnMucmVhZEludDgocG9zaXRpb24rKykKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAzIC8qIHNob3J0ICovOgogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBTSE9SVF9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5yZWFkSW50MTZCRShwb3NpdGlvbikKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gMjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA0IC8qIGludGVnZXIgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IElOVF9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5yZWFkSW50MzJCRShwb3NpdGlvbikKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gNDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA1IC8qIGxvbmcgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IExPTkdfVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG5ldyBJbnQ2NChoZWFkZXJzLnNsaWNlKHBvc2l0aW9uLCBwb3NpdGlvbiArIDgpKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSA4OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDYgLyogYnl0ZUFycmF5ICovOgogICAgICAgICAgICAgICAgICB2YXIgYmluYXJ5TGVuZ3RoID0gaGVhZGVycy5yZWFkVUludDE2QkUocG9zaXRpb24pOwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSAyOwogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBCSU5BUllfVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGhlYWRlcnMuc2xpY2UocG9zaXRpb24sIHBvc2l0aW9uICsgYmluYXJ5TGVuZ3RoKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSBiaW5hcnlMZW5ndGg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgNyAvKiBzdHJpbmcgKi86CiAgICAgICAgICAgICAgICAgIHZhciBzdHJpbmdMZW5ndGggPSBoZWFkZXJzLnJlYWRVSW50MTZCRShwb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDI7CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFNUUklOR19UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5zbGljZSgKICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiArIHN0cmluZ0xlbmd0aAogICAgICAgICAgICAgICAgICAgICAgKS50b1N0cmluZygpCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IHN0cmluZ0xlbmd0aDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA4IC8qIHRpbWVzdGFtcCAqLzoKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogVElNRVNUQU1QX1RBRywKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBuZXcgRGF0ZSgKICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgSW50NjQoaGVhZGVycy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyA4KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnZhbHVlT2YoKQogICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSA4OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDkgLyogdXVpZCAqLzoKICAgICAgICAgICAgICAgICAgdmFyIHV1aWRDaGFycyA9IGhlYWRlcnMuc2xpY2UocG9zaXRpb24sIHBvc2l0aW9uICsgMTYpCiAgICAgICAgICAgICAgICAgICAgICAudG9TdHJpbmcoJ2hleCcpOwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSAxNjsKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogVVVJRF9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdXVpZENoYXJzLnN1YnN0cigwLCA4KSArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgdXVpZENoYXJzLnN1YnN0cig4LCA0KSArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgdXVpZENoYXJzLnN1YnN0cigxMiwgNCkgKyAnLScgKwogICAgICAgICAgICAgICAgICAgICAgICAgIHV1aWRDaGFycy5zdWJzdHIoMTYsIDQpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgICB1dWlkQ2hhcnMuc3Vic3RyKDIwKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VucmVjb2duaXplZCBoZWFkZXIgdHlwZSB0YWcnKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gb3V0OwogIH0KICAKICBmdW5jdGlvbiBwYXJzZU1lc3NhZ2UobWVzc2FnZSkgewogICAgICB2YXIgcGFyc2VkID0gc3BsaXRNZXNzYWdlKG1lc3NhZ2UpOwogICAgICByZXR1cm4geyBoZWFkZXJzOiBwYXJzZUhlYWRlcnMocGFyc2VkLmhlYWRlcnMpLCBib2R5OiBwYXJzZWQuYm9keSB9OwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgcGFyc2VNZXNzYWdlOiBwYXJzZU1lc3NhZ2UKICB9OwogIAogIH0seyIuL2ludDY0IjoyOSwiLi9zcGxpdC1tZXNzYWdlIjozMn1dLDMyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL2NvcmUnKS51dGlsOwogIHZhciB0b0J1ZmZlciA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyOwogIAogIC8vIEFsbCBwcmVsdWRlIGNvbXBvbmVudHMgYXJlIHVuc2lnbmVkLCAzMi1iaXQgaW50ZWdlcnMKICB2YXIgUFJFTFVERV9NRU1CRVJfTEVOR1RIID0gNDsKICAvLyBUaGUgcHJlbHVkZSBjb25zaXN0cyBvZiB0d28gY29tcG9uZW50cwogIHZhciBQUkVMVURFX0xFTkdUSCA9IFBSRUxVREVfTUVNQkVSX0xFTkdUSCAqIDI7CiAgLy8gQ2hlY2tzdW1zIGFyZSBhbHdheXMgQ1JDMzIgaGFzaGVzLgogIHZhciBDSEVDS1NVTV9MRU5HVEggPSA0OwogIC8vIE1lc3NhZ2VzIG11c3QgaW5jbHVkZSBhIGZ1bGwgcHJlbHVkZSwgYSBwcmVsdWRlIGNoZWNrc3VtLCBhbmQgYSBtZXNzYWdlIGNoZWNrc3VtCiAgdmFyIE1JTklNVU1fTUVTU0FHRV9MRU5HVEggPSBQUkVMVURFX0xFTkdUSCArIENIRUNLU1VNX0xFTkdUSCAqIDI7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICoKICAgKiBAcGFyYW0ge0J1ZmZlcn0gbWVzc2FnZQogICAqLwogIGZ1bmN0aW9uIHNwbGl0TWVzc2FnZShtZXNzYWdlKSB7CiAgICAgIGlmICghdXRpbC5CdWZmZXIuaXNCdWZmZXIobWVzc2FnZSkpIG1lc3NhZ2UgPSB0b0J1ZmZlcihtZXNzYWdlKTsKICAKICAgICAgaWYgKG1lc3NhZ2UubGVuZ3RoIDwgTUlOSU1VTV9NRVNTQUdFX0xFTkdUSCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQcm92aWRlZCBtZXNzYWdlIHRvbyBzaG9ydCB0byBhY2NvbW1vZGF0ZSBldmVudCBzdHJlYW0gbWVzc2FnZSBvdmVyaGVhZCcpOwogICAgICB9CiAgCiAgICAgIGlmIChtZXNzYWdlLmxlbmd0aCAhPT0gbWVzc2FnZS5yZWFkVUludDMyQkUoMCkpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUmVwb3J0ZWQgbWVzc2FnZSBsZW5ndGggZG9lcyBub3QgbWF0Y2ggcmVjZWl2ZWQgbWVzc2FnZSBsZW5ndGgnKTsKICAgICAgfQogIAogICAgICB2YXIgZXhwZWN0ZWRQcmVsdWRlQ2hlY2tzdW0gPSBtZXNzYWdlLnJlYWRVSW50MzJCRShQUkVMVURFX0xFTkdUSCk7CiAgCiAgICAgIGlmICgKICAgICAgICAgIGV4cGVjdGVkUHJlbHVkZUNoZWNrc3VtICE9PSB1dGlsLmNyeXB0by5jcmMzMigKICAgICAgICAgICAgICBtZXNzYWdlLnNsaWNlKDAsIFBSRUxVREVfTEVOR1RIKQogICAgICAgICAgKQogICAgICApIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAnVGhlIHByZWx1ZGUgY2hlY2tzdW0gc3BlY2lmaWVkIGluIHRoZSBtZXNzYWdlICgnICsKICAgICAgICAgICAgICBleHBlY3RlZFByZWx1ZGVDaGVja3N1bSArCiAgICAgICAgICAgICAgJykgZG9lcyBub3QgbWF0Y2ggdGhlIGNhbGN1bGF0ZWQgQ1JDMzIgY2hlY2tzdW0uJwogICAgICAgICAgKTsKICAgICAgfQogIAogICAgICB2YXIgZXhwZWN0ZWRNZXNzYWdlQ2hlY2tzdW0gPSBtZXNzYWdlLnJlYWRVSW50MzJCRShtZXNzYWdlLmxlbmd0aCAtIENIRUNLU1VNX0xFTkdUSCk7CiAgCiAgICAgIGlmICgKICAgICAgICAgIGV4cGVjdGVkTWVzc2FnZUNoZWNrc3VtICE9PSB1dGlsLmNyeXB0by5jcmMzMigKICAgICAgICAgICAgICBtZXNzYWdlLnNsaWNlKDAsIG1lc3NhZ2UubGVuZ3RoIC0gQ0hFQ0tTVU1fTEVOR1RIKQogICAgICAgICAgKQogICAgICApIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAnVGhlIG1lc3NhZ2UgY2hlY2tzdW0gZGlkIG5vdCBtYXRjaCB0aGUgZXhwZWN0ZWQgdmFsdWUgb2YgJyArCiAgICAgICAgICAgICAgICAgIGV4cGVjdGVkTWVzc2FnZUNoZWNrc3VtCiAgICAgICAgICApOwogICAgICB9CiAgCiAgICAgIHZhciBoZWFkZXJzU3RhcnQgPSBQUkVMVURFX0xFTkdUSCArIENIRUNLU1VNX0xFTkdUSDsKICAgICAgdmFyIGhlYWRlcnNFbmQgPSBoZWFkZXJzU3RhcnQgKyBtZXNzYWdlLnJlYWRVSW50MzJCRShQUkVMVURFX01FTUJFUl9MRU5HVEgpOwogIAogICAgICByZXR1cm4gewogICAgICAgICAgaGVhZGVyczogbWVzc2FnZS5zbGljZShoZWFkZXJzU3RhcnQsIGhlYWRlcnNFbmQpLAogICAgICAgICAgYm9keTogbWVzc2FnZS5zbGljZShoZWFkZXJzRW5kLCBtZXNzYWdlLmxlbmd0aCAtIENIRUNLU1VNX0xFTkdUSCksCiAgICAgIH07CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBzcGxpdE1lc3NhZ2U6IHNwbGl0TWVzc2FnZQogIH07CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sMzM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICB2YXIgU2VxdWVudGlhbEV4ZWN1dG9yID0gcmVxdWlyZSgnLi9zZXF1ZW50aWFsX2V4ZWN1dG9yJyk7CiAgdmFyIERJU0NPVkVSX0VORFBPSU5UID0gcmVxdWlyZSgnLi9kaXNjb3Zlcl9lbmRwb2ludCcpLmRpc2NvdmVyRW5kcG9pbnQ7CiAgLyoqCiAgICogVGhlIG5hbWVzcGFjZSB1c2VkIHRvIHJlZ2lzdGVyIGdsb2JhbCBldmVudCBsaXN0ZW5lcnMgZm9yIHJlcXVlc3QgYnVpbGRpbmcKICAgKiBhbmQgc2VuZGluZy4KICAgKi8KICBBV1MuRXZlbnRMaXN0ZW5lcnMgPSB7CiAgICAvKioKICAgICAqIEAhYXR0cmlidXRlIFZBTElEQVRFX0NSRURFTlRJQUxTCiAgICAgKiAgIEEgcmVxdWVzdCBsaXN0ZW5lciB0aGF0IHZhbGlkYXRlcyB3aGV0aGVyIHRoZSByZXF1ZXN0IGlzIGJlaW5nCiAgICAgKiAgIHNlbnQgd2l0aCBjcmVkZW50aWFscy4KICAgICAqICAgSGFuZGxlcyB0aGUge0FXUy5SZXF1ZXN0fnZhbGlkYXRlICd2YWxpZGF0ZScgUmVxdWVzdCBldmVudH0KICAgICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3Qgd2l0aG91dCB2YWxpZGF0aW5nIGNyZWRlbnRpYWxzCiAgICAgKiAgICAgdmFyIGxpc3RlbmVyID0gQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfQ1JFREVOVElBTFM7CiAgICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBsaXN0ZW5lcik7CiAgICAgKiAgIEByZWFkb25seQogICAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgICAqIEAhYXR0cmlidXRlIFZBTElEQVRFX1JFR0lPTgogICAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCB2YWxpZGF0ZXMgd2hldGhlciB0aGUgcmVnaW9uIGlzIHNldAogICAgICogICBmb3IgYSByZXF1ZXN0LgogICAgICogICBIYW5kbGVzIHRoZSB7QVdTLlJlcXVlc3R+dmFsaWRhdGUgJ3ZhbGlkYXRlJyBSZXF1ZXN0IGV2ZW50fQogICAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRob3V0IHZhbGlkYXRpbmcgcmVnaW9uIGNvbmZpZ3VyYXRpb24KICAgICAqICAgICB2YXIgbGlzdGVuZXIgPSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9SRUdJT047CiAgICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBsaXN0ZW5lcik7CiAgICAgKiAgIEByZWFkb25seQogICAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgICAqIEAhYXR0cmlidXRlIFZBTElEQVRFX1BBUkFNRVRFUlMKICAgICAqICAgQSByZXF1ZXN0IGxpc3RlbmVyIHRoYXQgdmFsaWRhdGVzIGlucHV0IHBhcmFtZXRlcnMgaW4gYSByZXF1ZXN0LgogICAgICogICBIYW5kbGVzIHRoZSB7QVdTLlJlcXVlc3R+dmFsaWRhdGUgJ3ZhbGlkYXRlJyBSZXF1ZXN0IGV2ZW50fQogICAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRob3V0IHZhbGlkYXRpbmcgcGFyYW1ldGVycwogICAgICogICAgIHZhciBsaXN0ZW5lciA9IEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1BBUkFNRVRFUlM7CiAgICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBsaXN0ZW5lcik7CiAgICAgKiAgIEBleGFtcGxlIERpc2FibGUgcGFyYW1ldGVyIHZhbGlkYXRpb24gZ2xvYmFsbHkKICAgICAqICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLAogICAgICogICAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUkVHSU9OKTsKICAgICAqICAgQHJlYWRvbmx5CiAgICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAgICogQCFhdHRyaWJ1dGUgU0VORAogICAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCBpbml0aWF0ZXMgdGhlIEhUVFAgY29ubmVjdGlvbiBmb3IgYQogICAgICogICByZXF1ZXN0IGJlaW5nIHNlbnQuIEhhbmRsZXMgdGhlIHtBV1MuUmVxdWVzdH5zZW5kICdzZW5kJyBSZXF1ZXN0IGV2ZW50fQogICAgICogICBAZXhhbXBsZSBSZXBsYWNpbmcgdGhlIEhUVFAgaGFuZGxlcgogICAgICogICAgIHZhciBsaXN0ZW5lciA9IEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlNFTkQ7CiAgICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcignc2VuZCcsIGxpc3RlbmVyKTsKICAgICAqICAgICByZXF1ZXN0Lm9uKCdzZW5kJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAqICAgICAgIGN1c3RvbUhhbmRsZXIuc2VuZChyZXNwb25zZSk7CiAgICAgKiAgICAgfSk7CiAgICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAgICogICBAcmVhZG9ubHkKICAgICAqIEAhYXR0cmlidXRlIEhUVFBfREFUQQogICAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCByZWFkcyBkYXRhIGZyb20gdGhlIEhUVFAgY29ubmVjdGlvbiBpbiBvcmRlcgogICAgICogICB0byBidWlsZCB0aGUgcmVzcG9uc2UgZGF0YS4KICAgICAqICAgSGFuZGxlcyB0aGUge0FXUy5SZXF1ZXN0fmh0dHBEYXRhICdodHRwRGF0YScgUmVxdWVzdCBldmVudH0uCiAgICAgKiAgIFJlbW92ZSB0aGlzIGhhbmRsZXIgaWYgeW91IGFyZSBvdmVycmlkaW5nIHRoZSAnaHR0cERhdGEnIGV2ZW50IGFuZAogICAgICogICBkbyBub3Qgd2FudCBleHRyYSBkYXRhIHByb2Nlc3NpbmcgYW5kIGJ1ZmZlcmluZyBvdmVyaGVhZC4KICAgICAqICAgQGV4YW1wbGUgRGlzYWJsaW5nIGRlZmF1bHQgZGF0YSBwcm9jZXNzaW5nCiAgICAgKiAgICAgdmFyIGxpc3RlbmVyID0gQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuSFRUUF9EQVRBOwogICAgICogICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ2h0dHBEYXRhJywgbGlzdGVuZXIpOwogICAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgICAqICAgQHJlYWRvbmx5CiAgICAgKi8KICAgIENvcmU6IHt9IC8qIGRvYyBoYWNrICovCiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBnZXRPcGVyYXRpb25BdXRodHlwZShyZXEpIHsKICAgIGlmICghcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMpIHsKICAgICAgcmV0dXJuICcnOwogICAgfQogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgcmV0dXJuIG9wZXJhdGlvbiA/IG9wZXJhdGlvbi5hdXRodHlwZSA6ICcnOwogIH0KICAKICBBV1MuRXZlbnRMaXN0ZW5lcnMgPSB7CiAgICBDb3JlOiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkLCBhZGRBc3luYykgewogICAgICBhZGRBc3luYygnVkFMSURBVEVfQ1JFREVOVElBTFMnLCAndmFsaWRhdGUnLAogICAgICAgICAgZnVuY3Rpb24gVkFMSURBVEVfQ1JFREVOVElBTFMocmVxLCBkb25lKSB7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkuc2lnbmF0dXJlVmVyc2lvbiAmJiAhcmVxLnNlcnZpY2UuY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIHJldHVybiBkb25lKCk7IC8vIG5vbmUKICAgICAgICByZXEuc2VydmljZS5jb25maWcuZ2V0Q3JlZGVudGlhbHMoZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIHJlcS5yZXNwb25zZS5lcnJvciA9IEFXUy51dGlsLmVycm9yKGVyciwKICAgICAgICAgICAgICB7Y29kZTogJ0NyZWRlbnRpYWxzRXJyb3InLCBtZXNzYWdlOiAnTWlzc2luZyBjcmVkZW50aWFscyBpbiBjb25maWcnfSk7CiAgICAgICAgICB9CiAgICAgICAgICBkb25lKCk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1ZBTElEQVRFX1JFR0lPTicsICd2YWxpZGF0ZScsIGZ1bmN0aW9uIFZBTElEQVRFX1JFR0lPTihyZXEpIHsKICAgICAgICBpZiAoIXJlcS5zZXJ2aWNlLmNvbmZpZy5yZWdpb24gJiYgIXJlcS5zZXJ2aWNlLmlzR2xvYmFsRW5kcG9pbnQpIHsKICAgICAgICAgIHJlcS5yZXNwb25zZS5lcnJvciA9IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAgICB7Y29kZTogJ0NvbmZpZ0Vycm9yJywgbWVzc2FnZTogJ01pc3NpbmcgcmVnaW9uIGluIGNvbmZpZyd9KTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0JVSUxEX0lERU1QT1RFTkNZX1RPS0VOUycsICd2YWxpZGF0ZScsIGZ1bmN0aW9uIEJVSUxEX0lERU1QT1RFTkNZX1RPS0VOUyhyZXEpIHsKICAgICAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgICAgICBpZiAoIW9wZXJhdGlvbikgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgaWRlbXBvdGVudE1lbWJlcnMgPSBvcGVyYXRpb24uaWRlbXBvdGVudE1lbWJlcnM7CiAgICAgICAgaWYgKCFpZGVtcG90ZW50TWVtYmVycy5sZW5ndGgpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgLy8gY3JlYXRlcyBhIGNvcHkgb2YgcGFyYW1zIHNvIHVzZXIncyBwYXJhbSBvYmplY3QgaXNuJ3QgbXV0YXRlZAogICAgICAgIHZhciBwYXJhbXMgPSBBV1MudXRpbC5jb3B5KHJlcS5wYXJhbXMpOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gaWRlbXBvdGVudE1lbWJlcnMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICBpZiAoIXBhcmFtc1tpZGVtcG90ZW50TWVtYmVyc1tpXV0pIHsKICAgICAgICAgICAgLy8gYWRkIHRoZSBtZW1iZXIKICAgICAgICAgICAgcGFyYW1zW2lkZW1wb3RlbnRNZW1iZXJzW2ldXSA9IEFXUy51dGlsLnV1aWQudjQoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVxLnBhcmFtcyA9IHBhcmFtczsKICAgICAgfSk7CiAgCiAgICAgIGFkZCgnVkFMSURBVEVfUEFSQU1FVEVSUycsICd2YWxpZGF0ZScsIGZ1bmN0aW9uIFZBTElEQVRFX1BBUkFNRVRFUlMocmVxKSB7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgcnVsZXMgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dDsKICAgICAgICB2YXIgdmFsaWRhdGlvbiA9IHJlcS5zZXJ2aWNlLmNvbmZpZy5wYXJhbVZhbGlkYXRpb247CiAgICAgICAgbmV3IEFXUy5QYXJhbVZhbGlkYXRvcih2YWxpZGF0aW9uKS52YWxpZGF0ZShydWxlcywgcmVxLnBhcmFtcyk7CiAgICAgIH0pOwogIAogICAgICBhZGRBc3luYygnQ09NUFVURV9TSEEyNTYnLCAnYWZ0ZXJCdWlsZCcsIGZ1bmN0aW9uIENPTVBVVEVfU0hBMjU2KHJlcSwgZG9uZSkgewogICAgICAgIHJlcS5oYWx0SGFuZGxlcnNPbkVycm9yKCk7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICAgICAgdmFyIGF1dGh0eXBlID0gb3BlcmF0aW9uID8gb3BlcmF0aW9uLmF1dGh0eXBlIDogJyc7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkuc2lnbmF0dXJlVmVyc2lvbiAmJiAhYXV0aHR5cGUgJiYgIXJlcS5zZXJ2aWNlLmNvbmZpZy5zaWduYXR1cmVWZXJzaW9uKSByZXR1cm4gZG9uZSgpOyAvLyBub25lCiAgICAgICAgaWYgKHJlcS5zZXJ2aWNlLmdldFNpZ25lckNsYXNzKHJlcSkgPT09IEFXUy5TaWduZXJzLlY0KSB7CiAgICAgICAgICB2YXIgYm9keSA9IHJlcS5odHRwUmVxdWVzdC5ib2R5IHx8ICcnOwogICAgICAgICAgaWYgKGF1dGh0eXBlLmluZGV4T2YoJ3Vuc2lnbmVkLWJvZHknKSA+PSAwKSB7CiAgICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1Db250ZW50LVNoYTI1NiddID0gJ1VOU0lHTkVELVBBWUxPQUQnOwogICAgICAgICAgICByZXR1cm4gZG9uZSgpOwogICAgICAgICAgfQogICAgICAgICAgQVdTLnV0aWwuY29tcHV0ZVNoYTI1Nihib2R5LCBmdW5jdGlvbihlcnIsIHNoYSkgewogICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgZG9uZShlcnIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1Db250ZW50LVNoYTI1NiddID0gc2hhOwogICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRvbmUoKTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1NFVF9DT05URU5UX0xFTkdUSCcsICdhZnRlckJ1aWxkJywgZnVuY3Rpb24gU0VUX0NPTlRFTlRfTEVOR1RIKHJlcSkgewogICAgICAgIHZhciBhdXRodHlwZSA9IGdldE9wZXJhdGlvbkF1dGh0eXBlKHJlcSk7CiAgICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBBV1MudXRpbC5nZXRSZXF1ZXN0UGF5bG9hZFNoYXBlKHJlcSk7CiAgICAgICAgaWYgKHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LUxlbmd0aCddID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBsZW5ndGggPSBBV1MudXRpbC5zdHJpbmcuYnl0ZUxlbmd0aChyZXEuaHR0cFJlcXVlc3QuYm9keSk7CiAgICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LUxlbmd0aCddID0gbGVuZ3RoOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGlmIChwYXlsb2FkTWVtYmVyICYmIHBheWxvYWRNZW1iZXIuaXNTdHJlYW1pbmcpIHsKICAgICAgICAgICAgICBpZiAocGF5bG9hZE1lbWJlci5yZXF1aXJlc0xlbmd0aCkgewogICAgICAgICAgICAgICAgLy9zdHJlYW1pbmcgcGF5bG9hZCByZXF1aXJlcyBsZW5ndGgoczMsIGdsYWNpZXIpCiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChhdXRodHlwZS5pbmRleE9mKCd1bnNpZ25lZC1ib2R5JykgPj0gMCkgewogICAgICAgICAgICAgICAgLy91bmJvdW5kZWQgc3RyZWFtaW5nIHBheWxvYWQobGV4LCBtZWRpYXN0b3JlKQogICAgICAgICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1RyYW5zZmVyLUVuY29kaW5nJ10gPSAnY2h1bmtlZCc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnU0VUX0hUVFBfSE9TVCcsICdhZnRlckJ1aWxkJywgZnVuY3Rpb24gU0VUX0hUVFBfSE9TVChyZXEpIHsKICAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snSG9zdCddID0gcmVxLmh0dHBSZXF1ZXN0LmVuZHBvaW50Lmhvc3Q7CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1JFU1RBUlQnLCAncmVzdGFydCcsIGZ1bmN0aW9uIFJFU1RBUlQoKSB7CiAgICAgICAgdmFyIGVyciA9IHRoaXMucmVzcG9uc2UuZXJyb3I7CiAgICAgICAgaWYgKCFlcnIgfHwgIWVyci5yZXRyeWFibGUpIHJldHVybjsKICAKICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0ID0gbmV3IEFXUy5IdHRwUmVxdWVzdCgKICAgICAgICAgIHRoaXMuc2VydmljZS5lbmRwb2ludCwKICAgICAgICAgIHRoaXMuc2VydmljZS5yZWdpb24KICAgICAgICApOwogIAogICAgICAgIGlmICh0aGlzLnJlc3BvbnNlLnJldHJ5Q291bnQgPCB0aGlzLnNlcnZpY2UuY29uZmlnLm1heFJldHJpZXMpIHsKICAgICAgICAgIHRoaXMucmVzcG9uc2UucmV0cnlDb3VudCsrOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnJlc3BvbnNlLmVycm9yID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICB2YXIgYWRkVG9IZWFkID0gdHJ1ZTsKICAgICAgYWRkQXN5bmMoJ0RJU0NPVkVSX0VORFBPSU5UJywgJ3NpZ24nLCBESVNDT1ZFUl9FTkRQT0lOVCwgYWRkVG9IZWFkKTsKICAKICAgICAgYWRkQXN5bmMoJ1NJR04nLCAnc2lnbicsIGZ1bmN0aW9uIFNJR04ocmVxLCBkb25lKSB7CiAgICAgICAgdmFyIHNlcnZpY2UgPSByZXEuc2VydmljZTsKICAgICAgICB2YXIgb3BlcmF0aW9ucyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zIHx8IHt9OwogICAgICAgIHZhciBvcGVyYXRpb24gPSBvcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgICAgIHZhciBhdXRodHlwZSA9IG9wZXJhdGlvbiA/IG9wZXJhdGlvbi5hdXRodHlwZSA6ICcnOwogICAgICAgIGlmICghc2VydmljZS5hcGkuc2lnbmF0dXJlVmVyc2lvbiAmJiAhYXV0aHR5cGUgJiYgIXNlcnZpY2UuY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIHJldHVybiBkb25lKCk7IC8vIG5vbmUKICAKICAgICAgICBzZXJ2aWNlLmNvbmZpZy5nZXRDcmVkZW50aWFscyhmdW5jdGlvbiAoZXJyLCBjcmVkZW50aWFscykgewogICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICByZXEucmVzcG9uc2UuZXJyb3IgPSBlcnI7CiAgICAgICAgICAgIHJldHVybiBkb25lKCk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgZGF0ZSA9IHNlcnZpY2UuZ2V0U2tld0NvcnJlY3RlZERhdGUoKTsKICAgICAgICAgICAgdmFyIFNpZ25lckNsYXNzID0gc2VydmljZS5nZXRTaWduZXJDbGFzcyhyZXEpOwogICAgICAgICAgICB2YXIgc2lnbmVyID0gbmV3IFNpZ25lckNsYXNzKHJlcS5odHRwUmVxdWVzdCwKICAgICAgICAgICAgICBzZXJ2aWNlLmFwaS5zaWduaW5nTmFtZSB8fCBzZXJ2aWNlLmFwaS5lbmRwb2ludFByZWZpeCwKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzaWduYXR1cmVDYWNoZTogc2VydmljZS5jb25maWcuc2lnbmF0dXJlQ2FjaGUsCiAgICAgICAgICAgICAgICBvcGVyYXRpb246IG9wZXJhdGlvbiwKICAgICAgICAgICAgICAgIHNpZ25hdHVyZVZlcnNpb246IHNlcnZpY2UuYXBpLnNpZ25hdHVyZVZlcnNpb24KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgc2lnbmVyLnNldFNlcnZpY2VDbGllbnRJZChzZXJ2aWNlLl9jbGllbnRJZCk7CiAgCiAgICAgICAgICAgIC8vIGNsZWFyIG9sZCBhdXRob3JpemF0aW9uIGhlYWRlcnMKICAgICAgICAgICAgZGVsZXRlIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydBdXRob3JpemF0aW9uJ107CiAgICAgICAgICAgIGRlbGV0ZSByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snRGF0ZSddOwogICAgICAgICAgICBkZWxldGUgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXTsKICAKICAgICAgICAgICAgLy8gYWRkIG5ldyBhdXRob3JpemF0aW9uCiAgICAgICAgICAgIHNpZ25lci5hZGRBdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRlKTsKICAgICAgICAgICAgcmVxLnNpZ25lZEF0ID0gZGF0ZTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmVxLnJlc3BvbnNlLmVycm9yID0gZTsKICAgICAgICAgIH0KICAgICAgICAgIGRvbmUoKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgCiAgICAgIGFkZCgnVkFMSURBVEVfUkVTUE9OU0UnLCAndmFsaWRhdGVSZXNwb25zZScsIGZ1bmN0aW9uIFZBTElEQVRFX1JFU1BPTlNFKHJlc3ApIHsKICAgICAgICBpZiAodGhpcy5zZXJ2aWNlLnN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwLCB0aGlzKSkgewogICAgICAgICAgcmVzcC5kYXRhID0ge307CiAgICAgICAgICByZXNwLmVycm9yID0gbnVsbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzcC5kYXRhID0gbnVsbDsKICAgICAgICAgIHJlc3AuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgICAge2NvZGU6ICdVbmtub3duRXJyb3InLCBtZXNzYWdlOiAnQW4gdW5rbm93biBlcnJvciBvY2N1cnJlZC4nfSk7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkQXN5bmMoJ1NFTkQnLCAnc2VuZCcsIGZ1bmN0aW9uIFNFTkQocmVzcCwgZG9uZSkgewogICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLl9hYm9ydENhbGxiYWNrID0gZG9uZTsKICAgICAgICByZXNwLmVycm9yID0gbnVsbDsKICAgICAgICByZXNwLmRhdGEgPSBudWxsOwogIAogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKGh0dHBSZXNwKSB7CiAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5zdHJlYW0gPSBodHRwUmVzcDsKICAgICAgICAgIHZhciBzdHJlYW0gPSByZXNwLnJlcXVlc3QuaHR0cFJlcXVlc3Quc3RyZWFtOwogICAgICAgICAgdmFyIHNlcnZpY2UgPSByZXNwLnJlcXVlc3Quc2VydmljZTsKICAgICAgICAgIHZhciBhcGkgPSBzZXJ2aWNlLmFwaTsKICAgICAgICAgIHZhciBvcGVyYXRpb25OYW1lID0gcmVzcC5yZXF1ZXN0Lm9wZXJhdGlvbjsKICAgICAgICAgIHZhciBvcGVyYXRpb24gPSBhcGkub3BlcmF0aW9uc1tvcGVyYXRpb25OYW1lXSB8fCB7fTsKICAKICAgICAgICAgIGh0dHBSZXNwLm9uKCdoZWFkZXJzJywgZnVuY3Rpb24gb25IZWFkZXJzKHN0YXR1c0NvZGUsIGhlYWRlcnMsIHN0YXR1c01lc3NhZ2UpIHsKICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoCiAgICAgICAgICAgICAgJ2h0dHBIZWFkZXJzJywKICAgICAgICAgICAgICBbc3RhdHVzQ29kZSwgaGVhZGVycywgcmVzcCwgc3RhdHVzTWVzc2FnZV0KICAgICAgICAgICAgKTsKICAKICAgICAgICAgICAgaWYgKCFyZXNwLmh0dHBSZXNwb25zZS5zdHJlYW1pbmcpIHsKICAgICAgICAgICAgICBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIpIHsgLy8gc3RyZWFtczIgQVBJIGNoZWNrCiAgICAgICAgICAgICAgICAvLyBpZiB3ZSBkZXRlY3QgZXZlbnQgc3RyZWFtcywgd2UncmUgZ29pbmcgdG8gaGF2ZSB0bwogICAgICAgICAgICAgICAgLy8gcmV0dXJuIHRoZSBzdHJlYW0gaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIGlmIChvcGVyYXRpb24uaGFzRXZlbnRPdXRwdXQgJiYgc2VydmljZS5zdWNjZXNzZnVsUmVzcG9uc2UocmVzcCkpIHsKICAgICAgICAgICAgICAgICAgLy8gc2tpcCByZWFkaW5nIHRoZSBJbmNvbWluZ1N0cmVhbQogICAgICAgICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERvbmUnKTsKICAgICAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgCiAgICAgICAgICAgICAgICBodHRwUmVzcC5vbigncmVhZGFibGUnLCBmdW5jdGlvbiBvblJlYWRhYmxlKCkgewogICAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IGh0dHBSZXNwLnJlYWQoKTsKICAgICAgICAgICAgICAgICAgaWYgKGRhdGEgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERhdGEnLCBbZGF0YSwgcmVzcF0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBsZWdhY3kgc3RyZWFtcyBBUEkKICAgICAgICAgICAgICAgIGh0dHBSZXNwLm9uKCdkYXRhJywgZnVuY3Rpb24gb25EYXRhKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEYXRhJywgW2RhdGEsIHJlc3BdKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgCiAgICAgICAgICBodHRwUmVzcC5vbignZW5kJywgZnVuY3Rpb24gb25FbmQoKSB7CiAgICAgICAgICAgIGlmICghc3RyZWFtIHx8ICFzdHJlYW0uZGlkQ2FsbGJhY2spIHsKICAgICAgICAgICAgICBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIgJiYgKG9wZXJhdGlvbi5oYXNFdmVudE91dHB1dCAmJiBzZXJ2aWNlLnN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwKSkpIHsKICAgICAgICAgICAgICAgIC8vIGRvbid0IGNvbmNhdGVuYXRlIHJlc3BvbnNlIGNodW5rcyB3aGVuIHN0cmVhbWluZyBldmVudCBzdHJlYW0gZGF0YSB3aGVuIHJlc3BvbnNlIGlzIHN1Y2Nlc3NmdWwKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEb25lJyk7CiAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgCiAgICAgICAgZnVuY3Rpb24gcHJvZ3Jlc3MoaHR0cFJlc3ApIHsKICAgICAgICAgIGh0dHBSZXNwLm9uKCdzZW5kUHJvZ3Jlc3MnLCBmdW5jdGlvbiBvblNlbmRQcm9ncmVzcyh2YWx1ZSkgewogICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cFVwbG9hZFByb2dyZXNzJywgW3ZhbHVlLCByZXNwXSk7CiAgICAgICAgICB9KTsKICAKICAgICAgICAgIGh0dHBSZXNwLm9uKCdyZWNlaXZlUHJvZ3Jlc3MnLCBmdW5jdGlvbiBvblJlY2VpdmVQcm9ncmVzcyh2YWx1ZSkgewogICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERvd25sb2FkUHJvZ3Jlc3MnLCBbdmFsdWUsIHJlc3BdKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAKICAgICAgICBmdW5jdGlvbiBlcnJvcihlcnIpIHsKICAgICAgICAgIGlmIChlcnIuY29kZSAhPT0gJ1JlcXVlc3RBYm9ydGVkRXJyb3InKSB7CiAgICAgICAgICAgIHZhciBlcnJDb2RlID0gZXJyLmNvZGUgPT09ICdUaW1lb3V0RXJyb3InID8gZXJyLmNvZGUgOiAnTmV0d29ya2luZ0Vycm9yJzsKICAgICAgICAgICAgZXJyID0gQVdTLnV0aWwuZXJyb3IoZXJyLCB7CiAgICAgICAgICAgICAgY29kZTogZXJyQ29kZSwKICAgICAgICAgICAgICByZWdpb246IHJlc3AucmVxdWVzdC5odHRwUmVxdWVzdC5yZWdpb24sCiAgICAgICAgICAgICAgaG9zdG5hbWU6IHJlc3AucmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludC5ob3N0bmFtZSwKICAgICAgICAgICAgICByZXRyeWFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXNwLmVycm9yID0gZXJyOwogICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBFcnJvcicsIFtyZXNwLmVycm9yLCByZXNwXSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAKICAgICAgICBmdW5jdGlvbiBleGVjdXRlU2VuZCgpIHsKICAgICAgICAgIHZhciBodHRwID0gQVdTLkh0dHBDbGllbnQuZ2V0SW5zdGFuY2UoKTsKICAgICAgICAgIHZhciBodHRwT3B0aW9ucyA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5odHRwT3B0aW9ucyB8fCB7fTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBzdHJlYW0gPSBodHRwLmhhbmRsZVJlcXVlc3QocmVzcC5yZXF1ZXN0Lmh0dHBSZXF1ZXN0LCBodHRwT3B0aW9ucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaywgZXJyb3IpOwogICAgICAgICAgICBwcm9ncmVzcyhzdHJlYW0pOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGVycm9yKGVycik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB0aW1lRGlmZiA9IChyZXNwLnJlcXVlc3Quc2VydmljZS5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpIC0gdGhpcy5zaWduZWRBdCkgLyAxMDAwOwogICAgICAgIGlmICh0aW1lRGlmZiA+PSA2MCAqIDEwKSB7IC8vIGlmIHdlIHNpZ25lZCAxMG1pbiBhZ28sIHJlLXNpZ24KICAgICAgICAgIHRoaXMuZW1pdCgnc2lnbicsIFt0aGlzXSwgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgIGlmIChlcnIpIGRvbmUoZXJyKTsKICAgICAgICAgICAgZWxzZSBleGVjdXRlU2VuZCgpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGV4ZWN1dGVTZW5kKCk7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdIVFRQX0hFQURFUlMnLCAnaHR0cEhlYWRlcnMnLAogICAgICAgICAgZnVuY3Rpb24gSFRUUF9IRUFERVJTKHN0YXR1c0NvZGUsIGhlYWRlcnMsIHJlc3AsIHN0YXR1c01lc3NhZ2UpIHsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlID0gc3RhdHVzQ29kZTsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNNZXNzYWdlID0gc3RhdHVzTWVzc2FnZTsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzID0gaGVhZGVyczsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5ib2R5ID0gQVdTLnV0aWwuYnVmZmVyLnRvQnVmZmVyKCcnKTsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzID0gW107CiAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UubnVtQnl0ZXMgPSAwOwogICAgICAgIHZhciBkYXRlSGVhZGVyID0gaGVhZGVycy5kYXRlIHx8IGhlYWRlcnMuRGF0ZTsKICAgICAgICB2YXIgc2VydmljZSA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlOwogICAgICAgIGlmIChkYXRlSGVhZGVyKSB7CiAgICAgICAgICB2YXIgc2VydmVyVGltZSA9IERhdGUucGFyc2UoZGF0ZUhlYWRlcik7CiAgICAgICAgICBpZiAoc2VydmljZS5jb25maWcuY29ycmVjdENsb2NrU2tldwogICAgICAgICAgICAgICYmIHNlcnZpY2UuaXNDbG9ja1NrZXdlZChzZXJ2ZXJUaW1lKSkgewogICAgICAgICAgICBzZXJ2aWNlLmFwcGx5Q2xvY2tPZmZzZXQoc2VydmVyVGltZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdIVFRQX0RBVEEnLCAnaHR0cERhdGEnLCBmdW5jdGlvbiBIVFRQX0RBVEEoY2h1bmssIHJlc3ApIHsKICAgICAgICBpZiAoY2h1bmspIHsKICAgICAgICAgIGlmIChBV1MudXRpbC5pc05vZGUoKSkgewogICAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5udW1CeXRlcyArPSBjaHVuay5sZW5ndGg7CiAgCiAgICAgICAgICAgIHZhciB0b3RhbCA9IHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ2NvbnRlbnQtbGVuZ3RoJ107CiAgICAgICAgICAgIHZhciBwcm9ncmVzcyA9IHsgbG9hZGVkOiByZXNwLmh0dHBSZXNwb25zZS5udW1CeXRlcywgdG90YWw6IHRvdGFsIH07CiAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRG93bmxvYWRQcm9ncmVzcycsIFtwcm9ncmVzcywgcmVzcF0pOwogICAgICAgICAgfQogIAogICAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycy5wdXNoKEFXUy51dGlsLmJ1ZmZlci50b0J1ZmZlcihjaHVuaykpOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnSFRUUF9ET05FJywgJ2h0dHBEb25lJywgZnVuY3Rpb24gSFRUUF9ET05FKHJlc3ApIHsKICAgICAgICAvLyBjb252ZXJ0IGJ1ZmZlcnMgYXJyYXkgaW50byBzaW5nbGUgYnVmZmVyCiAgICAgICAgaWYgKHJlc3AuaHR0cFJlc3BvbnNlLmJ1ZmZlcnMgJiYgcmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICB2YXIgYm9keSA9IEFXUy51dGlsLmJ1ZmZlci5jb25jYXQocmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycyk7CiAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5ib2R5ID0gYm9keTsKICAgICAgICB9CiAgICAgICAgZGVsZXRlIHJlc3AuaHR0cFJlc3BvbnNlLm51bUJ5dGVzOwogICAgICAgIGRlbGV0ZSByZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzOwogICAgICB9KTsKICAKICAgICAgYWRkKCdGSU5BTElaRV9FUlJPUicsICdyZXRyeScsIGZ1bmN0aW9uIEZJTkFMSVpFX0VSUk9SKHJlc3ApIHsKICAgICAgICBpZiAocmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSkgewogICAgICAgICAgcmVzcC5lcnJvci5zdGF0dXNDb2RlID0gcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICAgIGlmIChyZXNwLmVycm9yLnJldHJ5YWJsZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gdGhpcy5zZXJ2aWNlLnJldHJ5YWJsZUVycm9yKHJlc3AuZXJyb3IsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnSU5WQUxJREFURV9DUkVERU5USUFMUycsICdyZXRyeScsIGZ1bmN0aW9uIElOVkFMSURBVEVfQ1JFREVOVElBTFMocmVzcCkgewogICAgICAgIGlmICghcmVzcC5lcnJvcikgcmV0dXJuOwogICAgICAgIHN3aXRjaCAocmVzcC5lcnJvci5jb2RlKSB7CiAgICAgICAgICBjYXNlICdSZXF1ZXN0RXhwaXJlZCc6IC8vIEVDMiBvbmx5CiAgICAgICAgICBjYXNlICdFeHBpcmVkVG9rZW5FeGNlcHRpb24nOgogICAgICAgICAgY2FzZSAnRXhwaXJlZFRva2VuJzoKICAgICAgICAgICAgcmVzcC5lcnJvci5yZXRyeWFibGUgPSB0cnVlOwogICAgICAgICAgICByZXNwLnJlcXVlc3Quc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMuZXhwaXJlZCA9IHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdFWFBJUkVEX1NJR05BVFVSRScsICdyZXRyeScsIGZ1bmN0aW9uIEVYUElSRURfU0lHTkFUVVJFKHJlc3ApIHsKICAgICAgICB2YXIgZXJyID0gcmVzcC5lcnJvcjsKICAgICAgICBpZiAoIWVycikgcmV0dXJuOwogICAgICAgIGlmICh0eXBlb2YgZXJyLmNvZGUgPT09ICdzdHJpbmcnICYmIHR5cGVvZiBlcnIubWVzc2FnZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGlmIChlcnIuY29kZS5tYXRjaCgvU2lnbmF0dXJlLykgJiYgZXJyLm1lc3NhZ2UubWF0Y2goL2V4cGlyZWQvKSkgewogICAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdDTE9DS19TS0VXRUQnLCAncmV0cnknLCBmdW5jdGlvbiBDTE9DS19TS0VXRUQocmVzcCkgewogICAgICAgIGlmICghcmVzcC5lcnJvcikgcmV0dXJuOwogICAgICAgIGlmICh0aGlzLnNlcnZpY2UuY2xvY2tTa2V3RXJyb3IocmVzcC5lcnJvcikKICAgICAgICAgICAgJiYgdGhpcy5zZXJ2aWNlLmNvbmZpZy5jb3JyZWN0Q2xvY2tTa2V3KSB7CiAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdSRURJUkVDVCcsICdyZXRyeScsIGZ1bmN0aW9uIFJFRElSRUNUKHJlc3ApIHsKICAgICAgICBpZiAocmVzcC5lcnJvciAmJiByZXNwLmVycm9yLnN0YXR1c0NvZGUgPj0gMzAwICYmCiAgICAgICAgICAgIHJlc3AuZXJyb3Iuc3RhdHVzQ29kZSA8IDQwMCAmJiByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWydsb2NhdGlvbiddKSB7CiAgICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0LmVuZHBvaW50ID0KICAgICAgICAgICAgbmV3IEFXUy5FbmRwb2ludChyZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWydsb2NhdGlvbiddKTsKICAgICAgICAgIHRoaXMuaHR0cFJlcXVlc3QuaGVhZGVyc1snSG9zdCddID0gdGhpcy5odHRwUmVxdWVzdC5lbmRwb2ludC5ob3N0OwogICAgICAgICAgcmVzcC5lcnJvci5yZWRpcmVjdCA9IHRydWU7CiAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdSRVRSWV9DSEVDSycsICdyZXRyeScsIGZ1bmN0aW9uIFJFVFJZX0NIRUNLKHJlc3ApIHsKICAgICAgICBpZiAocmVzcC5lcnJvcikgewogICAgICAgICAgaWYgKHJlc3AuZXJyb3IucmVkaXJlY3QgJiYgcmVzcC5yZWRpcmVjdENvdW50IDwgcmVzcC5tYXhSZWRpcmVjdHMpIHsKICAgICAgICAgICAgcmVzcC5lcnJvci5yZXRyeURlbGF5ID0gMDsKICAgICAgICAgIH0gZWxzZSBpZiAocmVzcC5yZXRyeUNvdW50IDwgcmVzcC5tYXhSZXRyaWVzKSB7CiAgICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlEZWxheSA9IHRoaXMuc2VydmljZS5yZXRyeURlbGF5cyhyZXNwLnJldHJ5Q291bnQpIHx8IDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkQXN5bmMoJ1JFU0VUX1JFVFJZX1NUQVRFJywgJ2FmdGVyUmV0cnknLCBmdW5jdGlvbiBSRVNFVF9SRVRSWV9TVEFURShyZXNwLCBkb25lKSB7CiAgICAgICAgdmFyIGRlbGF5LCB3aWxsUmV0cnkgPSBmYWxzZTsKICAKICAgICAgICBpZiAocmVzcC5lcnJvcikgewogICAgICAgICAgZGVsYXkgPSByZXNwLmVycm9yLnJldHJ5RGVsYXkgfHwgMDsKICAgICAgICAgIGlmIChyZXNwLmVycm9yLnJldHJ5YWJsZSAmJiByZXNwLnJldHJ5Q291bnQgPCByZXNwLm1heFJldHJpZXMpIHsKICAgICAgICAgICAgcmVzcC5yZXRyeUNvdW50Kys7CiAgICAgICAgICAgIHdpbGxSZXRyeSA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3AuZXJyb3IucmVkaXJlY3QgJiYgcmVzcC5yZWRpcmVjdENvdW50IDwgcmVzcC5tYXhSZWRpcmVjdHMpIHsKICAgICAgICAgICAgcmVzcC5yZWRpcmVjdENvdW50Kys7CiAgICAgICAgICAgIHdpbGxSZXRyeSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogIAogICAgICAgIGlmICh3aWxsUmV0cnkpIHsKICAgICAgICAgIHJlc3AuZXJyb3IgPSBudWxsOwogICAgICAgICAgc2V0VGltZW91dChkb25lLCBkZWxheSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRvbmUoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSksCiAgCiAgICBDb3JlUG9zdDogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICBhZGQoJ0VYVFJBQ1RfUkVRVUVTVF9JRCcsICdleHRyYWN0RGF0YScsIEFXUy51dGlsLmV4dHJhY3RSZXF1ZXN0SWQpOwogICAgICBhZGQoJ0VYVFJBQ1RfUkVRVUVTVF9JRCcsICdleHRyYWN0RXJyb3InLCBBV1MudXRpbC5leHRyYWN0UmVxdWVzdElkKTsKICAKICAgICAgYWRkKCdFTk9URk9VTkRfRVJST1InLCAnaHR0cEVycm9yJywgZnVuY3Rpb24gRU5PVEZPVU5EX0VSUk9SKGVycikgewogICAgICAgIGlmIChlcnIuY29kZSA9PT0gJ05ldHdvcmtpbmdFcnJvcicgJiYgZXJyLmVycm5vID09PSAnRU5PVEZPVU5EJykgewogICAgICAgICAgdmFyIG1lc3NhZ2UgPSAnSW5hY2Nlc3NpYmxlIGhvc3Q6IGAnICsgZXJyLmhvc3RuYW1lICsKICAgICAgICAgICAgJ1wnLiBUaGlzIHNlcnZpY2UgbWF5IG5vdCBiZSBhdmFpbGFibGUgaW4gdGhlIGAnICsgZXJyLnJlZ2lvbiArCiAgICAgICAgICAgICdcJyByZWdpb24uJzsKICAgICAgICAgIHRoaXMucmVzcG9uc2UuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IobWVzc2FnZSksIHsKICAgICAgICAgICAgY29kZTogJ1Vua25vd25FbmRwb2ludCcsCiAgICAgICAgICAgIHJlZ2lvbjogZXJyLnJlZ2lvbiwKICAgICAgICAgICAgaG9zdG5hbWU6IGVyci5ob3N0bmFtZSwKICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlLAogICAgICAgICAgICBvcmlnaW5hbEVycm9yOiBlcnIKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KSwKICAKICAgIExvZ2dlcjogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICBhZGQoJ0xPR19SRVFVRVNUJywgJ2NvbXBsZXRlJywgZnVuY3Rpb24gTE9HX1JFUVVFU1QocmVzcCkgewogICAgICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICAgICAgdmFyIGxvZ2dlciA9IHJlcS5zZXJ2aWNlLmNvbmZpZy5sb2dnZXI7CiAgICAgICAgaWYgKCFsb2dnZXIpIHJldHVybjsKICAgICAgICBmdW5jdGlvbiBmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZSwgc2hhcGUpIHsKICAgICAgICAgIGlmICghc2hhcGUpIHsKICAgICAgICAgICAgcmV0dXJuIHNoYXBlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoIChpbnB1dFNoYXBlLnR5cGUpIHsKICAgICAgICAgICAgY2FzZSAnc3RydWN0dXJlJzoKICAgICAgICAgICAgICB2YXIgc3RydWN0ID0ge307CiAgICAgICAgICAgICAgQVdTLnV0aWwuZWFjaChzaGFwZSwgZnVuY3Rpb24oc3ViU2hhcGVOYW1lLCBzdWJTaGFwZSkgewogICAgICAgICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChpbnB1dFNoYXBlLm1lbWJlcnMsIHN1YlNoYXBlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgc3RydWN0W3N1YlNoYXBlTmFtZV0gPSBmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZS5tZW1iZXJzW3N1YlNoYXBlTmFtZV0sIHN1YlNoYXBlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHN0cnVjdFtzdWJTaGFwZU5hbWVdID0gc3ViU2hhcGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmV0dXJuIHN0cnVjdDsKICAgICAgICAgICAgY2FzZSAnbGlzdCc6CiAgICAgICAgICAgICAgdmFyIGxpc3QgPSBbXTsKICAgICAgICAgICAgICBBV1MudXRpbC5hcnJheUVhY2goc2hhcGUsIGZ1bmN0aW9uKHN1YlNoYXBlLCBpbmRleCkgewogICAgICAgICAgICAgICAgbGlzdC5wdXNoKGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLm1lbWJlciwgc3ViU2hhcGUpKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXR1cm4gbGlzdDsKICAgICAgICAgICAgY2FzZSAnbWFwJzoKICAgICAgICAgICAgICB2YXIgbWFwID0ge307CiAgICAgICAgICAgICAgQVdTLnV0aWwuZWFjaChzaGFwZSwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgbWFwW2tleV0gPSBmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZS52YWx1ZSwgdmFsdWUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybiBtYXA7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgaWYgKGlucHV0U2hhcGUuaXNTZW5zaXRpdmUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAnKioqU2Vuc2l0aXZlSW5mb3JtYXRpb24qKionOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2hhcGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAKICAgICAgICBmdW5jdGlvbiBidWlsZE1lc3NhZ2UoKSB7CiAgICAgICAgICB2YXIgdGltZSA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlLmdldFNrZXdDb3JyZWN0ZWREYXRlKCkuZ2V0VGltZSgpOwogICAgICAgICAgdmFyIGRlbHRhID0gKHRpbWUgLSByZXEuc3RhcnRUaW1lLmdldFRpbWUoKSkgLyAxMDAwOwogICAgICAgICAgdmFyIGFuc2kgPSBsb2dnZXIuaXNUVFkgPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICB2YXIgc3RhdHVzID0gcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICAgIHZhciBjZW5zb3JlZFBhcmFtcyA9IHJlcS5wYXJhbXM7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zICYmCiAgICAgICAgICAgICAgICByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXSAmJgogICAgICAgICAgICAgICAgcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQKICAgICAgICAgICkgewogICAgICAgICAgICB2YXIgaW5wdXRTaGFwZSA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmlucHV0OwogICAgICAgICAgICBjZW5zb3JlZFBhcmFtcyA9IGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLCByZXEucGFyYW1zKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwYXJhbXMgPSByZXF1aXJlKCd1dGlsJykuaW5zcGVjdChjZW5zb3JlZFBhcmFtcywgdHJ1ZSwgbnVsbCk7CiAgICAgICAgICB2YXIgbWVzc2FnZSA9ICcnOwogICAgICAgICAgaWYgKGFuc2kpIG1lc3NhZ2UgKz0gJ1x4MUJbMzNtJzsKICAgICAgICAgIG1lc3NhZ2UgKz0gJ1tBV1MgJyArIHJlcS5zZXJ2aWNlLnNlcnZpY2VJZGVudGlmaWVyICsgJyAnICsgc3RhdHVzOwogICAgICAgICAgbWVzc2FnZSArPSAnICcgKyBkZWx0YS50b1N0cmluZygpICsgJ3MgJyArIHJlc3AucmV0cnlDb3VudCArICcgcmV0cmllc10nOwogICAgICAgICAgaWYgKGFuc2kpIG1lc3NhZ2UgKz0gJ1x4MUJbMDsxbSc7CiAgICAgICAgICBtZXNzYWdlICs9ICcgJyArIEFXUy51dGlsLnN0cmluZy5sb3dlckZpcnN0KHJlcS5vcGVyYXRpb24pOwogICAgICAgICAgbWVzc2FnZSArPSAnKCcgKyBwYXJhbXMgKyAnKSc7CiAgICAgICAgICBpZiAoYW5zaSkgbWVzc2FnZSArPSAnXHgxQlswbSc7CiAgICAgICAgICByZXR1cm4gbWVzc2FnZTsKICAgICAgICB9CiAgCiAgICAgICAgdmFyIGxpbmUgPSBidWlsZE1lc3NhZ2UoKTsKICAgICAgICBpZiAodHlwZW9mIGxvZ2dlci5sb2cgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGxvZ2dlci5sb2cobGluZSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbG9nZ2VyLndyaXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBsb2dnZXIud3JpdGUobGluZSArICdcbicpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KSwKICAKICAgIEpzb246IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvanNvbicpOwogICAgICBhZGQoJ0JVSUxEJywgJ2J1aWxkJywgc3ZjLmJ1aWxkUmVxdWVzdCk7CiAgICAgIGFkZCgnRVhUUkFDVF9EQVRBJywgJ2V4dHJhY3REYXRhJywgc3ZjLmV4dHJhY3REYXRhKTsKICAgICAgYWRkKCdFWFRSQUNUX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIHN2Yy5leHRyYWN0RXJyb3IpOwogICAgfSksCiAgCiAgICBSZXN0OiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICAgIHZhciBzdmMgPSByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3QnKTsKICAgICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICAgIH0pLAogIAogICAgUmVzdEpzb246IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdF9qc29uJyk7CiAgICAgIGFkZCgnQlVJTEQnLCAnYnVpbGQnLCBzdmMuYnVpbGRSZXF1ZXN0KTsKICAgICAgYWRkKCdFWFRSQUNUX0RBVEEnLCAnZXh0cmFjdERhdGEnLCBzdmMuZXh0cmFjdERhdGEpOwogICAgICBhZGQoJ0VYVFJBQ1RfRVJST1InLCAnZXh0cmFjdEVycm9yJywgc3ZjLmV4dHJhY3RFcnJvcik7CiAgICB9KSwKICAKICAgIFJlc3RYbWw6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdF94bWwnKTsKICAgICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICAgIH0pLAogIAogICAgUXVlcnk6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvcXVlcnknKTsKICAgICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICAgIH0pCiAgfTsKICAKICB9LHsiLi9jb3JlIjoxOCwiLi9kaXNjb3Zlcl9lbmRwb2ludCI6MjYsIi4vcHJvdG9jb2wvanNvbiI6NDYsIi4vcHJvdG9jb2wvcXVlcnkiOjQ3LCIuL3Byb3RvY29sL3Jlc3QiOjQ4LCIuL3Byb3RvY29sL3Jlc3RfanNvbiI6NDksIi4vcHJvdG9jb2wvcmVzdF94bWwiOjUwLCIuL3NlcXVlbnRpYWxfZXhlY3V0b3IiOjU4LCJ1dGlsIjo5N31dLDM0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIAogIC8qKgogICAqIFRoZSBlbmRwb2ludCB0aGF0IGEgc2VydmljZSB3aWxsIHRhbGsgdG8sIGZvciBleGFtcGxlLAogICAqIGAnaHR0cHM6Ly9lYzIuYXAtc291dGhlYXN0LTEuYW1hem9uYXdzLmNvbSdgLiBJZgogICAqIHlvdSBuZWVkIHRvIG92ZXJyaWRlIGFuIGVuZHBvaW50IGZvciBhIHNlcnZpY2UsIHlvdSBjYW4KICAgKiBzZXQgdGhlIGVuZHBvaW50IG9uIGEgc2VydmljZSBieSBwYXNzaW5nIHRoZSBlbmRwb2ludAogICAqIG9iamVjdCB3aXRoIHRoZSBgZW5kcG9pbnRgIG9wdGlvbiBrZXk6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogdmFyIGVwID0gbmV3IEFXUy5FbmRwb2ludCgnYXdzcHJveHkuZXhhbXBsZS5jb20nKTsKICAgKiB2YXIgczMgPSBuZXcgQVdTLlMzKHtlbmRwb2ludDogZXB9KTsKICAgKiBzMy5zZXJ2aWNlLmVuZHBvaW50Lmhvc3RuYW1lID09ICdhd3Nwcm94eS5leGFtcGxlLmNvbScKICAgKiBgYGAKICAgKgogICAqIE5vdGUgdGhhdCBpZiB5b3UgZG8gbm90IHNwZWNpZnkgYSBwcm90b2NvbCwgdGhlIHByb3RvY29sIHdpbGwKICAgKiBiZSBzZWxlY3RlZCBiYXNlZCBvbiB5b3VyIGN1cnJlbnQge0FXUy5jb25maWd9IGNvbmZpZ3VyYXRpb24uCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBwcm90b2NvbAogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcHJvdG9jb2wgKGh0dHAgb3IgaHR0cHMpIG9mIHRoZSBlbmRwb2ludAogICAqICAgICBVUkwKICAgKiBAIWF0dHJpYnV0ZSBob3N0bmFtZQogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgaG9zdCBwb3J0aW9uIG9mIHRoZSBlbmRwb2ludCwgZS5nLiwKICAgKiAgICAgZXhhbXBsZS5jb20KICAgKiBAIWF0dHJpYnV0ZSBob3N0CiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBob3N0IHBvcnRpb24gb2YgdGhlIGVuZHBvaW50IGluY2x1ZGluZwogICAqICAgICB0aGUgcG9ydCwgZS5nLiwgZXhhbXBsZS5jb206ODAKICAgKiBAIWF0dHJpYnV0ZSBwb3J0CiAgICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgcG9ydCBvZiB0aGUgZW5kcG9pbnQKICAgKiBAIWF0dHJpYnV0ZSBocmVmCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBmdWxsIFVSTCBvZiB0aGUgZW5kcG9pbnQKICAgKi8KICBBV1MuRW5kcG9pbnQgPSBpbmhlcml0KHsKICAKICAgIC8qKgogICAgICogQG92ZXJsb2FkIEVuZHBvaW50KGVuZHBvaW50KQogICAgICogICBDb25zdHJ1Y3RzIGEgbmV3IGVuZHBvaW50IGdpdmVuIGFuIGVuZHBvaW50IFVSTC4gSWYgdGhlCiAgICAgKiAgIFVSTCBvbWl0cyBhIHByb3RvY29sIChodHRwIG9yIGh0dHBzKSwgdGhlIGRlZmF1bHQgcHJvdG9jb2wKICAgICAqICAgc2V0IGluIHRoZSBnbG9iYWwge0FXUy5jb25maWd9IHdpbGwgYmUgdXNlZC4KICAgICAqICAgQHBhcmFtIGVuZHBvaW50IFtTdHJpbmddIHRoZSBVUkwgdG8gY29uc3RydWN0IGFuIGVuZHBvaW50IGZyb20KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIEVuZHBvaW50KGVuZHBvaW50LCBjb25maWcpIHsKICAgICAgQVdTLnV0aWwuaGlkZVByb3BlcnRpZXModGhpcywgWydzbGFzaGVzJywgJ2F1dGgnLCAnaGFzaCcsICdzZWFyY2gnLCAncXVlcnknXSk7CiAgCiAgICAgIGlmICh0eXBlb2YgZW5kcG9pbnQgPT09ICd1bmRlZmluZWQnIHx8IGVuZHBvaW50ID09PSBudWxsKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGVuZHBvaW50OiAnICsgZW5kcG9pbnQpOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmRwb2ludCAhPT0gJ3N0cmluZycpIHsKICAgICAgICByZXR1cm4gQVdTLnV0aWwuY29weShlbmRwb2ludCk7CiAgICAgIH0KICAKICAgICAgaWYgKCFlbmRwb2ludC5tYXRjaCgvXmh0dHAvKSkgewogICAgICAgIHZhciB1c2VTU0wgPSBjb25maWcgJiYgY29uZmlnLnNzbEVuYWJsZWQgIT09IHVuZGVmaW5lZCA/CiAgICAgICAgICBjb25maWcuc3NsRW5hYmxlZCA6IEFXUy5jb25maWcuc3NsRW5hYmxlZDsKICAgICAgICBlbmRwb2ludCA9ICh1c2VTU0wgPyAnaHR0cHMnIDogJ2h0dHAnKSArICc6Ly8nICsgZW5kcG9pbnQ7CiAgICAgIH0KICAKICAgICAgQVdTLnV0aWwudXBkYXRlKHRoaXMsIEFXUy51dGlsLnVybFBhcnNlKGVuZHBvaW50KSk7CiAgCiAgICAgIC8vIEVuc3VyZSB0aGUgcG9ydCBwcm9wZXJ0eSBpcyBzZXQgYXMgYW4gaW50ZWdlcgogICAgICBpZiAodGhpcy5wb3J0KSB7CiAgICAgICAgdGhpcy5wb3J0ID0gcGFyc2VJbnQodGhpcy5wb3J0LCAxMCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5wb3J0ID0gdGhpcy5wcm90b2NvbCA9PT0gJ2h0dHBzOicgPyA0NDMgOiA4MDsKICAgICAgfQogICAgfQogIAogIH0pOwogIAogIC8qKgogICAqIFRoZSBsb3cgbGV2ZWwgSFRUUCByZXF1ZXN0IG9iamVjdCwgZW5jYXBzdWxhdGluZyBhbGwgSFRUUCBoZWFkZXIKICAgKiBhbmQgYm9keSBkYXRhIHNlbnQgYnkgYSBzZXJ2aWNlIHJlcXVlc3QuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBtZXRob2QKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIEhUVFAgbWV0aG9kIG9mIHRoZSByZXF1ZXN0CiAgICogQCFhdHRyaWJ1dGUgcGF0aAogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcGF0aCBwb3J0aW9uIG9mIHRoZSBVUkksIGUuZy4sCiAgICogICAgICIvbGlzdC8/c3RhcnQ9NSZudW09MTAiCiAgICogQCFhdHRyaWJ1dGUgaGVhZGVycwogICAqICAgQHJldHVybiBbbWFwPFN0cmluZyxTdHJpbmc+XQogICAqICAgICBhIG1hcCBvZiBoZWFkZXIga2V5cyBhbmQgdGhlaXIgcmVzcGVjdGl2ZSB2YWx1ZXMKICAgKiBAIWF0dHJpYnV0ZSBib2R5CiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSByZXF1ZXN0IGJvZHkgcGF5bG9hZAogICAqIEAhYXR0cmlidXRlIGVuZHBvaW50CiAgICogICBAcmV0dXJuIFtBV1MuRW5kcG9pbnRdIHRoZSBlbmRwb2ludCBmb3IgdGhlIHJlcXVlc3QKICAgKiBAIWF0dHJpYnV0ZSByZWdpb24KICAgKiAgIEBhcGkgcHJpdmF0ZQogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcmVnaW9uLCBmb3Igc2lnbmluZyBwdXJwb3NlcyBvbmx5LgogICAqLwogIEFXUy5IdHRwUmVxdWVzdCA9IGluaGVyaXQoewogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIEh0dHBSZXF1ZXN0KGVuZHBvaW50LCByZWdpb24pIHsKICAgICAgZW5kcG9pbnQgPSBuZXcgQVdTLkVuZHBvaW50KGVuZHBvaW50KTsKICAgICAgdGhpcy5tZXRob2QgPSAnUE9TVCc7CiAgICAgIHRoaXMucGF0aCA9IGVuZHBvaW50LnBhdGggfHwgJy8nOwogICAgICB0aGlzLmhlYWRlcnMgPSB7fTsKICAgICAgdGhpcy5ib2R5ID0gJyc7CiAgICAgIHRoaXMuZW5kcG9pbnQgPSBlbmRwb2ludDsKICAgICAgdGhpcy5yZWdpb24gPSByZWdpb247CiAgICAgIHRoaXMuX3VzZXJBZ2VudCA9ICcnOwogICAgICB0aGlzLnNldFVzZXJBZ2VudCgpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNldFVzZXJBZ2VudDogZnVuY3Rpb24gc2V0VXNlckFnZW50KCkgewogICAgICB0aGlzLl91c2VyQWdlbnQgPSB0aGlzLmhlYWRlcnNbdGhpcy5nZXRVc2VyQWdlbnRIZWFkZXJOYW1lKCldID0gQVdTLnV0aWwudXNlckFnZW50KCk7CiAgICB9LAogIAogICAgZ2V0VXNlckFnZW50SGVhZGVyTmFtZTogZnVuY3Rpb24gZ2V0VXNlckFnZW50SGVhZGVyTmFtZSgpIHsKICAgICAgdmFyIHByZWZpeCA9IEFXUy51dGlsLmlzQnJvd3NlcigpID8gJ1gtQW16LScgOiAnJzsKICAgICAgcmV0dXJuIHByZWZpeCArICdVc2VyLUFnZW50JzsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhcHBlbmRUb1VzZXJBZ2VudDogZnVuY3Rpb24gYXBwZW5kVG9Vc2VyQWdlbnQoYWdlbnRQYXJ0aWFsKSB7CiAgICAgIGlmICh0eXBlb2YgYWdlbnRQYXJ0aWFsID09PSAnc3RyaW5nJyAmJiBhZ2VudFBhcnRpYWwpIHsKICAgICAgICB0aGlzLl91c2VyQWdlbnQgKz0gJyAnICsgYWdlbnRQYXJ0aWFsOwogICAgICB9CiAgICAgIHRoaXMuaGVhZGVyc1t0aGlzLmdldFVzZXJBZ2VudEhlYWRlck5hbWUoKV0gPSB0aGlzLl91c2VyQWdlbnQ7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0VXNlckFnZW50OiBmdW5jdGlvbiBnZXRVc2VyQWdlbnQoKSB7CiAgICAgIHJldHVybiB0aGlzLl91c2VyQWdlbnQ7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtTdHJpbmddIHRoZSBwYXJ0IG9mIHRoZSB7cGF0aH0gZXhjbHVkaW5nIHRoZQogICAgICogICBxdWVyeSBzdHJpbmcKICAgICAqLwogICAgcGF0aG5hbWU6IGZ1bmN0aW9uIHBhdGhuYW1lKCkgewogICAgICByZXR1cm4gdGhpcy5wYXRoLnNwbGl0KCc/JywgMSlbMF07CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtTdHJpbmddIHRoZSBxdWVyeSBzdHJpbmcgcG9ydGlvbiBvZiB0aGUge3BhdGh9CiAgICAgKi8KICAgIHNlYXJjaDogZnVuY3Rpb24gc2VhcmNoKCkgewogICAgICB2YXIgcXVlcnkgPSB0aGlzLnBhdGguc3BsaXQoJz8nLCAyKVsxXTsKICAgICAgaWYgKHF1ZXJ5KSB7CiAgICAgICAgcXVlcnkgPSBBV1MudXRpbC5xdWVyeVN0cmluZ1BhcnNlKHF1ZXJ5KTsKICAgICAgICByZXR1cm4gQVdTLnV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhxdWVyeSk7CiAgICAgIH0KICAgICAgcmV0dXJuICcnOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKiB1cGRhdGUgaHR0cFJlcXVlc3QgZW5kcG9pbnQgd2l0aCBlbmRwb2ludCBzdHJpbmcKICAgICAqLwogICAgdXBkYXRlRW5kcG9pbnQ6IGZ1bmN0aW9uIHVwZGF0ZUVuZHBvaW50KGVuZHBvaW50U3RyKSB7CiAgICAgIHZhciBuZXdFbmRwb2ludCA9IG5ldyBBV1MuRW5kcG9pbnQoZW5kcG9pbnRTdHIpOwogICAgICB0aGlzLmVuZHBvaW50ID0gbmV3RW5kcG9pbnQ7CiAgICAgIHRoaXMucGF0aCA9IG5ld0VuZHBvaW50LnBhdGggfHwgJy8nOwogICAgfQogIH0pOwogIAogIC8qKgogICAqIFRoZSBsb3cgbGV2ZWwgSFRUUCByZXNwb25zZSBvYmplY3QsIGVuY2Fwc3VsYXRpbmcgYWxsIEhUVFAgaGVhZGVyCiAgICogYW5kIGJvZHkgZGF0YSByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAqCiAgICogQCFhdHRyaWJ1dGUgc3RhdHVzQ29kZQogICAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIEhUVFAgc3RhdHVzIGNvZGUgb2YgdGhlIHJlc3BvbnNlIChlLmcuLCAyMDAsIDQwNCkKICAgKiBAIWF0dHJpYnV0ZSBoZWFkZXJzCiAgICogICBAcmV0dXJuIFttYXA8U3RyaW5nLFN0cmluZz5dCiAgICogICAgICBhIG1hcCBvZiByZXNwb25zZSBoZWFkZXIga2V5cyBhbmQgdGhlaXIgcmVzcGVjdGl2ZSB2YWx1ZXMKICAgKiBAIWF0dHJpYnV0ZSBib2R5CiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSByZXNwb25zZSBib2R5IHBheWxvYWQKICAgKiBAIWF0dHJpYnV0ZSBbcl0gc3RyZWFtaW5nCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoaXMgcmVzcG9uc2UgaXMgYmVpbmcgc3RyZWFtZWQgYXQgYSBsb3ctbGV2ZWwuCiAgICogICAgIERlZmF1bHRzIHRvIGBmYWxzZWAgKGJ1ZmZlcmVkIHJlYWRzKS4gRG8gbm90IG1vZGlmeSB0aGlzIG1hbnVhbGx5LCB1c2UKICAgKiAgICAge2NyZWF0ZVVuYnVmZmVyZWRTdHJlYW19IHRvIGNvbnZlcnQgdGhlIHN0cmVhbSB0byB1bmJ1ZmZlcmVkIG1vZGUKICAgKiAgICAgaW5zdGVhZC4KICAgKi8KICBBV1MuSHR0cFJlc3BvbnNlID0gaW5oZXJpdCh7CiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gSHR0cFJlc3BvbnNlKCkgewogICAgICB0aGlzLnN0YXR1c0NvZGUgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuaGVhZGVycyA9IHt9OwogICAgICB0aGlzLmJvZHkgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuc3RyZWFtaW5nID0gZmFsc2U7CiAgICAgIHRoaXMuc3RyZWFtID0gbnVsbDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIERpc2FibGVzIGJ1ZmZlcmluZyBvbiB0aGUgSFRUUCByZXNwb25zZSBhbmQgcmV0dXJucyB0aGUgc3RyZWFtIGZvciByZWFkaW5nLgogICAgICogQHJldHVybiBbU3RyZWFtLCBYTUxIdHRwUmVxdWVzdCwgbnVsbF0gdGhlIHVuZGVybHlpbmcgc3RyZWFtIG9iamVjdC4KICAgICAqICAgVXNlIHRoaXMgb2JqZWN0IHRvIGRpcmVjdGx5IHJlYWQgZGF0YSBvZmYgb2YgdGhlIHN0cmVhbS4KICAgICAqIEBub3RlIFRoaXMgb2JqZWN0IGlzIG9ubHkgYXZhaWxhYmxlIGFmdGVyIHRoZSB7QVdTLlJlcXVlc3R+aHR0cEhlYWRlcnN9CiAgICAgKiAgIGV2ZW50IGhhcyBmaXJlZC4gVGhpcyBtZXRob2QgbXVzdCBiZSBjYWxsZWQgcHJpb3IgdG8KICAgICAqICAge0FXUy5SZXF1ZXN0fmh0dHBEYXRhfS4KICAgICAqIEBleGFtcGxlIFRha2luZyBjb250cm9sIG9mIGEgc3RyZWFtCiAgICAgKiAgIHJlcXVlc3Qub24oJ2h0dHBIZWFkZXJzJywgZnVuY3Rpb24oc3RhdHVzQ29kZSwgaGVhZGVycykgewogICAgICogICAgIGlmIChzdGF0dXNDb2RlIDwgMzAwKSB7CiAgICAgKiAgICAgICBpZiAoaGVhZGVycy5ldGFnID09PSAneHl6JykgewogICAgICogICAgICAgICAvLyBwaXBlIHRoZSBzdHJlYW0sIGRpc2FibGluZyBidWZmZXJpbmcKICAgICAqICAgICAgICAgdmFyIHN0cmVhbSA9IHRoaXMucmVzcG9uc2UuaHR0cFJlc3BvbnNlLmNyZWF0ZVVuYnVmZmVyZWRTdHJlYW0oKTsKICAgICAqICAgICAgICAgc3RyZWFtLnBpcGUocHJvY2Vzcy5zdGRvdXQpOwogICAgICogICAgICAgfSBlbHNlIHsgLy8gYWJvcnQgdGhpcyByZXF1ZXN0IGFuZCBzZXQgYSBiZXR0ZXIgZXJyb3IgbWVzc2FnZQogICAgICogICAgICAgICB0aGlzLmFib3J0KCk7CiAgICAgKiAgICAgICAgIHRoaXMucmVzcG9uc2UuZXJyb3IgPSBuZXcgRXJyb3IoJ0ludmFsaWQgRVRhZycpOwogICAgICogICAgICAgfQogICAgICogICAgIH0KICAgICAqICAgfSkuc2VuZChjb25zb2xlLmxvZyk7CiAgICAgKi8KICAgIGNyZWF0ZVVuYnVmZmVyZWRTdHJlYW06IGZ1bmN0aW9uIGNyZWF0ZVVuYnVmZmVyZWRTdHJlYW0oKSB7CiAgICAgIHRoaXMuc3RyZWFtaW5nID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXMuc3RyZWFtOwogICAgfQogIH0pOwogIAogIAogIEFXUy5IdHRwQ2xpZW50ID0gaW5oZXJpdCh7fSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLkh0dHBDbGllbnQuZ2V0SW5zdGFuY2UgPSBmdW5jdGlvbiBnZXRJbnN0YW5jZSgpIHsKICAgIGlmICh0aGlzLnNpbmdsZXRvbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHRoaXMuc2luZ2xldG9uID0gbmV3IHRoaXMoKTsKICAgIH0KICAgIHJldHVybiB0aGlzLnNpbmdsZXRvbjsKICB9OwogIAogIH0seyIuL2NvcmUiOjE4fV0sMzU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKICByZXF1aXJlKCcuLi9odHRwJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlhIUkNsaWVudCA9IEFXUy51dGlsLmluaGVyaXQoewogICAgaGFuZGxlUmVxdWVzdDogZnVuY3Rpb24gaGFuZGxlUmVxdWVzdChodHRwUmVxdWVzdCwgaHR0cE9wdGlvbnMsIGNhbGxiYWNrLCBlcnJDYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBlbmRwb2ludCA9IGh0dHBSZXF1ZXN0LmVuZHBvaW50OwogICAgICB2YXIgZW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTsKICAgICAgdmFyIGhyZWYgPSBlbmRwb2ludC5wcm90b2NvbCArICcvLycgKyBlbmRwb2ludC5ob3N0bmFtZTsKICAgICAgaWYgKGVuZHBvaW50LnBvcnQgIT09IDgwICYmIGVuZHBvaW50LnBvcnQgIT09IDQ0MykgewogICAgICAgIGhyZWYgKz0gJzonICsgZW5kcG9pbnQucG9ydDsKICAgICAgfQogICAgICBocmVmICs9IGh0dHBSZXF1ZXN0LnBhdGg7CiAgCiAgICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKSwgaGVhZGVyc0VtaXR0ZWQgPSBmYWxzZTsKICAgICAgaHR0cFJlcXVlc3Quc3RyZWFtID0geGhyOwogIAogICAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoeGhyLnN0YXR1cyA9PT0gMCkgcmV0dXJuOyAvLyAwIGNvZGUgaXMgaW52YWxpZAogICAgICAgIH0gY2F0Y2ggKGUpIHsgcmV0dXJuOyB9CiAgCiAgICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA+PSB0aGlzLkhFQURFUlNfUkVDRUlWRUQgJiYgIWhlYWRlcnNFbWl0dGVkKSB7CiAgICAgICAgICBlbWl0dGVyLnN0YXR1c0NvZGUgPSB4aHIuc3RhdHVzOwogICAgICAgICAgZW1pdHRlci5oZWFkZXJzID0gc2VsZi5wYXJzZUhlYWRlcnMoeGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpKTsKICAgICAgICAgIGVtaXR0ZXIuZW1pdCgKICAgICAgICAgICAgJ2hlYWRlcnMnLAogICAgICAgICAgICBlbWl0dGVyLnN0YXR1c0NvZGUsCiAgICAgICAgICAgIGVtaXR0ZXIuaGVhZGVycywKICAgICAgICAgICAgeGhyLnN0YXR1c1RleHQKICAgICAgICAgICk7CiAgICAgICAgICBoZWFkZXJzRW1pdHRlZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLnJlYWR5U3RhdGUgPT09IHRoaXMuRE9ORSkgewogICAgICAgICAgc2VsZi5maW5pc2hSZXF1ZXN0KHhociwgZW1pdHRlcik7CiAgICAgICAgfQogICAgICB9LCBmYWxzZSk7CiAgICAgIHhoci51cGxvYWQuYWRkRXZlbnRMaXN0ZW5lcigncHJvZ3Jlc3MnLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgZW1pdHRlci5lbWl0KCdzZW5kUHJvZ3Jlc3MnLCBldnQpOwogICAgICB9KTsKICAgICAgeGhyLmFkZEV2ZW50TGlzdGVuZXIoJ3Byb2dyZXNzJywgZnVuY3Rpb24gKGV2dCkgewogICAgICAgIGVtaXR0ZXIuZW1pdCgncmVjZWl2ZVByb2dyZXNzJywgZXZ0KTsKICAgICAgfSwgZmFsc2UpOwogICAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcigndGltZW91dCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICBlcnJDYWxsYmFjayhBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ1RpbWVvdXQnKSwge2NvZGU6ICdUaW1lb3V0RXJyb3InfSkpOwogICAgICB9LCBmYWxzZSk7CiAgICAgIHhoci5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIGZ1bmN0aW9uICgpIHsKICAgICAgICBlcnJDYWxsYmFjayhBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ05ldHdvcmsgRmFpbHVyZScpLCB7CiAgICAgICAgICBjb2RlOiAnTmV0d29ya2luZ0Vycm9yJwogICAgICAgIH0pKTsKICAgICAgfSwgZmFsc2UpOwogICAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcignYWJvcnQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgZXJyQ2FsbGJhY2soQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCdSZXF1ZXN0IGFib3J0ZWQnKSwgewogICAgICAgICAgY29kZTogJ1JlcXVlc3RBYm9ydGVkRXJyb3InCiAgICAgICAgfSkpOwogICAgICB9LCBmYWxzZSk7CiAgCiAgICAgIGNhbGxiYWNrKGVtaXR0ZXIpOwogICAgICB4aHIub3BlbihodHRwUmVxdWVzdC5tZXRob2QsIGhyZWYsIGh0dHBPcHRpb25zLnhockFzeW5jICE9PSBmYWxzZSk7CiAgICAgIEFXUy51dGlsLmVhY2goaHR0cFJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICBpZiAoa2V5ICE9PSAnQ29udGVudC1MZW5ndGgnICYmIGtleSAhPT0gJ1VzZXItQWdlbnQnICYmIGtleSAhPT0gJ0hvc3QnKSB7CiAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBpZiAoaHR0cE9wdGlvbnMudGltZW91dCAmJiBodHRwT3B0aW9ucy54aHJBc3luYyAhPT0gZmFsc2UpIHsKICAgICAgICB4aHIudGltZW91dCA9IGh0dHBPcHRpb25zLnRpbWVvdXQ7CiAgICAgIH0KICAKICAgICAgaWYgKGh0dHBPcHRpb25zLnhocldpdGhDcmVkZW50aWFscykgewogICAgICAgIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwogICAgICB9CiAgICAgIHRyeSB7IHhoci5yZXNwb25zZVR5cGUgPSAnYXJyYXlidWZmZXInOyB9IGNhdGNoIChlKSB7fQogIAogICAgICB0cnkgewogICAgICAgIGlmIChodHRwUmVxdWVzdC5ib2R5KSB7CiAgICAgICAgICB4aHIuc2VuZChodHRwUmVxdWVzdC5ib2R5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgeGhyLnNlbmQoKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGlmIChodHRwUmVxdWVzdC5ib2R5ICYmIHR5cGVvZiBodHRwUmVxdWVzdC5ib2R5LmJ1ZmZlciA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgIHhoci5zZW5kKGh0dHBSZXF1ZXN0LmJvZHkuYnVmZmVyKTsgLy8gc2VuZCBBcnJheUJ1ZmZlciBkaXJlY3RseQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiBlbWl0dGVyOwogICAgfSwKICAKICAgIHBhcnNlSGVhZGVyczogZnVuY3Rpb24gcGFyc2VIZWFkZXJzKHJhd0hlYWRlcnMpIHsKICAgICAgdmFyIGhlYWRlcnMgPSB7fTsKICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHJhd0hlYWRlcnMuc3BsaXQoL1xyP1xuLyksIGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgICAgdmFyIGtleSA9IGxpbmUuc3BsaXQoJzonLCAxKVswXTsKICAgICAgICB2YXIgdmFsdWUgPSBsaW5lLnN1YnN0cmluZyhrZXkubGVuZ3RoICsgMik7CiAgICAgICAgaWYgKGtleS5sZW5ndGggPiAwKSBoZWFkZXJzW2tleS50b0xvd2VyQ2FzZSgpXSA9IHZhbHVlOwogICAgICB9KTsKICAgICAgcmV0dXJuIGhlYWRlcnM7CiAgICB9LAogIAogICAgZmluaXNoUmVxdWVzdDogZnVuY3Rpb24gZmluaXNoUmVxdWVzdCh4aHIsIGVtaXR0ZXIpIHsKICAgICAgdmFyIGJ1ZmZlcjsKICAgICAgaWYgKHhoci5yZXNwb25zZVR5cGUgPT09ICdhcnJheWJ1ZmZlcicgJiYgeGhyLnJlc3BvbnNlKSB7CiAgICAgICAgdmFyIGFiID0geGhyLnJlc3BvbnNlOwogICAgICAgIGJ1ZmZlciA9IG5ldyBBV1MudXRpbC5CdWZmZXIoYWIuYnl0ZUxlbmd0aCk7CiAgICAgICAgdmFyIHZpZXcgPSBuZXcgVWludDhBcnJheShhYik7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBidWZmZXIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGJ1ZmZlcltpXSA9IHZpZXdbaV07CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHRyeSB7CiAgICAgICAgaWYgKCFidWZmZXIgJiYgdHlwZW9mIHhoci5yZXNwb25zZVRleHQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBidWZmZXIgPSBuZXcgQVdTLnV0aWwuQnVmZmVyKHhoci5yZXNwb25zZVRleHQpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkge30KICAKICAgICAgaWYgKGJ1ZmZlcikgZW1pdHRlci5lbWl0KCdkYXRhJywgYnVmZmVyKTsKICAgICAgZW1pdHRlci5lbWl0KCdlbmQnKTsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuSHR0cENsaWVudC5wcm90b3R5cGUgPSBBV1MuWEhSQ2xpZW50LnByb3RvdHlwZTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9IDE7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuLi9odHRwIjozNCwiZXZlbnRzIjo4MX1dLDM2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICAKICBmdW5jdGlvbiBKc29uQnVpbGRlcigpIHsgfQogIAogIEpzb25CdWlsZGVyLnByb3RvdHlwZS5idWlsZCA9IGZ1bmN0aW9uKHZhbHVlLCBzaGFwZSkgewogICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUpKTsKICB9OwogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUpIHsKICAgIGlmICghc2hhcGUgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAKICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICBjYXNlICdzdHJ1Y3R1cmUnOiByZXR1cm4gdHJhbnNsYXRlU3RydWN0dXJlKHZhbHVlLCBzaGFwZSk7CiAgICAgIGNhc2UgJ21hcCc6IHJldHVybiB0cmFuc2xhdGVNYXAodmFsdWUsIHNoYXBlKTsKICAgICAgY2FzZSAnbGlzdCc6IHJldHVybiB0cmFuc2xhdGVMaXN0KHZhbHVlLCBzaGFwZSk7CiAgICAgIGRlZmF1bHQ6IHJldHVybiB0cmFuc2xhdGVTY2FsYXIodmFsdWUsIHNoYXBlKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlU3RydWN0dXJlKHN0cnVjdHVyZSwgc2hhcGUpIHsKICAgIHZhciBzdHJ1Y3QgPSB7fTsKICAgIHV0aWwuZWFjaChzdHJ1Y3R1cmUsIGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgIHZhciBtZW1iZXJTaGFwZSA9IHNoYXBlLm1lbWJlcnNbbmFtZV07CiAgICAgIGlmIChtZW1iZXJTaGFwZSkgewogICAgICAgIGlmIChtZW1iZXJTaGFwZS5sb2NhdGlvbiAhPT0gJ2JvZHknKSByZXR1cm47CiAgICAgICAgdmFyIGxvY2F0aW9uTmFtZSA9IG1lbWJlclNoYXBlLmlzTG9jYXRpb25OYW1lID8gbWVtYmVyU2hhcGUubmFtZSA6IG5hbWU7CiAgICAgICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgbWVtYmVyU2hhcGUpOwogICAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgc3RydWN0W2xvY2F0aW9uTmFtZV0gPSByZXN1bHQ7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHN0cnVjdDsKICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlTGlzdChsaXN0LCBzaGFwZSkgewogICAgdmFyIG91dCA9IFtdOwogICAgdXRpbC5hcnJheUVhY2gobGlzdCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUubWVtYmVyKTsKICAgICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSBvdXQucHVzaChyZXN1bHQpOwogICAgfSk7CiAgICByZXR1cm4gb3V0OwogIH0KICAKICBmdW5jdGlvbiB0cmFuc2xhdGVNYXAobWFwLCBzaGFwZSkgewogICAgdmFyIG91dCA9IHt9OwogICAgdXRpbC5lYWNoKG1hcCwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZS52YWx1ZSk7CiAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgb3V0W2tleV0gPSByZXN1bHQ7CiAgICB9KTsKICAgIHJldHVybiBvdXQ7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZVNjYWxhcih2YWx1ZSwgc2hhcGUpIHsKICAgIHJldHVybiBzaGFwZS50b1dpcmVGb3JtYXQodmFsdWUpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEpzb25CdWlsZGVyOwogIAogIH0seyIuLi91dGlsIjo3MX1dLDM3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICAKICBmdW5jdGlvbiBKc29uUGFyc2VyKCkgeyB9CiAgCiAgSnNvblBhcnNlci5wcm90b3R5cGUucGFyc2UgPSBmdW5jdGlvbih2YWx1ZSwgc2hhcGUpIHsKICAgIHJldHVybiB0cmFuc2xhdGUoSlNPTi5wYXJzZSh2YWx1ZSksIHNoYXBlKTsKICB9OwogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUpIHsKICAgIGlmICghc2hhcGUgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHVuZGVmaW5lZDsKICAKICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICBjYXNlICdzdHJ1Y3R1cmUnOiByZXR1cm4gdHJhbnNsYXRlU3RydWN0dXJlKHZhbHVlLCBzaGFwZSk7CiAgICAgIGNhc2UgJ21hcCc6IHJldHVybiB0cmFuc2xhdGVNYXAodmFsdWUsIHNoYXBlKTsKICAgICAgY2FzZSAnbGlzdCc6IHJldHVybiB0cmFuc2xhdGVMaXN0KHZhbHVlLCBzaGFwZSk7CiAgICAgIGRlZmF1bHQ6IHJldHVybiB0cmFuc2xhdGVTY2FsYXIodmFsdWUsIHNoYXBlKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlU3RydWN0dXJlKHN0cnVjdHVyZSwgc2hhcGUpIHsKICAgIGlmIChzdHJ1Y3R1cmUgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAKICAgIHZhciBzdHJ1Y3QgPSB7fTsKICAgIHZhciBzaGFwZU1lbWJlcnMgPSBzaGFwZS5tZW1iZXJzOwogICAgdXRpbC5lYWNoKHNoYXBlTWVtYmVycywgZnVuY3Rpb24obmFtZSwgbWVtYmVyU2hhcGUpIHsKICAgICAgdmFyIGxvY2F0aW9uTmFtZSA9IG1lbWJlclNoYXBlLmlzTG9jYXRpb25OYW1lID8gbWVtYmVyU2hhcGUubmFtZSA6IG5hbWU7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc3RydWN0dXJlLCBsb2NhdGlvbk5hbWUpKSB7CiAgICAgICAgdmFyIHZhbHVlID0gc3RydWN0dXJlW2xvY2F0aW9uTmFtZV07CiAgICAgICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgbWVtYmVyU2hhcGUpOwogICAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgc3RydWN0W25hbWVdID0gcmVzdWx0OwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBzdHJ1Y3Q7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZUxpc3QobGlzdCwgc2hhcGUpIHsKICAgIGlmIChsaXN0ID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgCiAgICB2YXIgb3V0ID0gW107CiAgICB1dGlsLmFycmF5RWFjaChsaXN0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZS5tZW1iZXIpOwogICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIG91dC5wdXNoKG51bGwpOwogICAgICBlbHNlIG91dC5wdXNoKHJlc3VsdCk7CiAgICB9KTsKICAgIHJldHVybiBvdXQ7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZU1hcChtYXAsIHNoYXBlKSB7CiAgICBpZiAobWFwID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgCiAgICB2YXIgb3V0ID0ge307CiAgICB1dGlsLmVhY2gobWFwLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIHZhciByZXN1bHQgPSB0cmFuc2xhdGUodmFsdWUsIHNoYXBlLnZhbHVlKTsKICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSBvdXRba2V5XSA9IG51bGw7CiAgICAgIGVsc2Ugb3V0W2tleV0gPSByZXN1bHQ7CiAgICB9KTsKICAgIHJldHVybiBvdXQ7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZVNjYWxhcih2YWx1ZSwgc2hhcGUpIHsKICAgIHJldHVybiBzaGFwZS50b1R5cGUodmFsdWUpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEpzb25QYXJzZXI7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxfV0sMzg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBDb2xsZWN0aW9uID0gcmVxdWlyZSgnLi9jb2xsZWN0aW9uJyk7CiAgdmFyIE9wZXJhdGlvbiA9IHJlcXVpcmUoJy4vb3BlcmF0aW9uJyk7CiAgdmFyIFNoYXBlID0gcmVxdWlyZSgnLi9zaGFwZScpOwogIHZhciBQYWdpbmF0b3IgPSByZXF1aXJlKCcuL3BhZ2luYXRvcicpOwogIHZhciBSZXNvdXJjZVdhaXRlciA9IHJlcXVpcmUoJy4vcmVzb3VyY2Vfd2FpdGVyJyk7CiAgCiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIHByb3BlcnR5ID0gdXRpbC5wcm9wZXJ0eTsKICB2YXIgbWVtb2l6ZWRQcm9wZXJ0eSA9IHV0aWwubWVtb2l6ZWRQcm9wZXJ0eTsKICAKICBmdW5jdGlvbiBBcGkoYXBpLCBvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBhcGkgPSBhcGkgfHwge307CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIG9wdGlvbnMuYXBpID0gdGhpczsKICAKICAgIGFwaS5tZXRhZGF0YSA9IGFwaS5tZXRhZGF0YSB8fCB7fTsKICAKICAgIHByb3BlcnR5KHRoaXMsICdpc0FwaScsIHRydWUsIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdhcGlWZXJzaW9uJywgYXBpLm1ldGFkYXRhLmFwaVZlcnNpb24pOwogICAgcHJvcGVydHkodGhpcywgJ2VuZHBvaW50UHJlZml4JywgYXBpLm1ldGFkYXRhLmVuZHBvaW50UHJlZml4KTsKICAgIHByb3BlcnR5KHRoaXMsICdzaWduaW5nTmFtZScsIGFwaS5tZXRhZGF0YS5zaWduaW5nTmFtZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZ2xvYmFsRW5kcG9pbnQnLCBhcGkubWV0YWRhdGEuZ2xvYmFsRW5kcG9pbnQpOwogICAgcHJvcGVydHkodGhpcywgJ3NpZ25hdHVyZVZlcnNpb24nLCBhcGkubWV0YWRhdGEuc2lnbmF0dXJlVmVyc2lvbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnanNvblZlcnNpb24nLCBhcGkubWV0YWRhdGEuanNvblZlcnNpb24pOwogICAgcHJvcGVydHkodGhpcywgJ3RhcmdldFByZWZpeCcsIGFwaS5tZXRhZGF0YS50YXJnZXRQcmVmaXgpOwogICAgcHJvcGVydHkodGhpcywgJ3Byb3RvY29sJywgYXBpLm1ldGFkYXRhLnByb3RvY29sKTsKICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCBhcGkubWV0YWRhdGEudGltZXN0YW1wRm9ybWF0KTsKICAgIHByb3BlcnR5KHRoaXMsICd4bWxOYW1lc3BhY2VVcmknLCBhcGkubWV0YWRhdGEueG1sTmFtZXNwYWNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdhYmJyZXZpYXRpb24nLCBhcGkubWV0YWRhdGEuc2VydmljZUFiYnJldmlhdGlvbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZnVsbE5hbWUnLCBhcGkubWV0YWRhdGEuc2VydmljZUZ1bGxOYW1lKTsKICAgIHByb3BlcnR5KHRoaXMsICdzZXJ2aWNlSWQnLCBhcGkubWV0YWRhdGEuc2VydmljZUlkKTsKICAKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2NsYXNzTmFtZScsIGZ1bmN0aW9uKCkgewogICAgICB2YXIgbmFtZSA9IGFwaS5tZXRhZGF0YS5zZXJ2aWNlQWJicmV2aWF0aW9uIHx8IGFwaS5tZXRhZGF0YS5zZXJ2aWNlRnVsbE5hbWU7CiAgICAgIGlmICghbmFtZSkgcmV0dXJuIG51bGw7CiAgCiAgICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UoL15BbWF6b258QVdTXHMqfFwoLip8XHMrfFxXKy9nLCAnJyk7CiAgICAgIGlmIChuYW1lID09PSAnRWxhc3RpY0xvYWRCYWxhbmNpbmcnKSBuYW1lID0gJ0VMQic7CiAgICAgIHJldHVybiBuYW1lOwogICAgfSk7CiAgCiAgICBmdW5jdGlvbiBhZGRFbmRwb2ludE9wZXJhdGlvbihuYW1lLCBvcGVyYXRpb24pIHsKICAgICAgaWYgKG9wZXJhdGlvbi5lbmRwb2ludG9wZXJhdGlvbiA9PT0gdHJ1ZSkgewogICAgICAgIHByb3BlcnR5KHNlbGYsICdlbmRwb2ludE9wZXJhdGlvbicsIHV0aWwuc3RyaW5nLmxvd2VyRmlyc3QobmFtZSkpOwogICAgICB9CiAgICB9CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAnb3BlcmF0aW9ucycsIG5ldyBDb2xsZWN0aW9uKGFwaS5vcGVyYXRpb25zLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCBvcGVyYXRpb24pIHsKICAgICAgcmV0dXJuIG5ldyBPcGVyYXRpb24obmFtZSwgb3BlcmF0aW9uLCBvcHRpb25zKTsKICAgIH0sIHV0aWwuc3RyaW5nLmxvd2VyRmlyc3QsIGFkZEVuZHBvaW50T3BlcmF0aW9uKSk7CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAnc2hhcGVzJywgbmV3IENvbGxlY3Rpb24oYXBpLnNoYXBlcywgb3B0aW9ucywgZnVuY3Rpb24obmFtZSwgc2hhcGUpIHsKICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShzaGFwZSwgb3B0aW9ucyk7CiAgICB9KSk7CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAncGFnaW5hdG9ycycsIG5ldyBDb2xsZWN0aW9uKGFwaS5wYWdpbmF0b3JzLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCBwYWdpbmF0b3IpIHsKICAgICAgcmV0dXJuIG5ldyBQYWdpbmF0b3IobmFtZSwgcGFnaW5hdG9yLCBvcHRpb25zKTsKICAgIH0pKTsKICAKICAgIHByb3BlcnR5KHRoaXMsICd3YWl0ZXJzJywgbmV3IENvbGxlY3Rpb24oYXBpLndhaXRlcnMsIG9wdGlvbnMsIGZ1bmN0aW9uKG5hbWUsIHdhaXRlcikgewogICAgICByZXR1cm4gbmV3IFJlc291cmNlV2FpdGVyKG5hbWUsIHdhaXRlciwgb3B0aW9ucyk7CiAgICB9LCB1dGlsLnN0cmluZy5sb3dlckZpcnN0KSk7CiAgCiAgICBpZiAob3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uJywgYXBpLmRvY3VtZW50YXRpb24pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAnZG9jdW1lbnRhdGlvblVybCcsIGFwaS5kb2N1bWVudGF0aW9uVXJsKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBcGk7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxLCIuL2NvbGxlY3Rpb24iOjM5LCIuL29wZXJhdGlvbiI6NDAsIi4vcGFnaW5hdG9yIjo0MSwiLi9yZXNvdXJjZV93YWl0ZXIiOjQyLCIuL3NoYXBlIjo0M31dLDM5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgbWVtb2l6ZWRQcm9wZXJ0eSA9IHJlcXVpcmUoJy4uL3V0aWwnKS5tZW1vaXplZFByb3BlcnR5OwogIAogIGZ1bmN0aW9uIG1lbW9pemUobmFtZSwgdmFsdWUsIGZhY3RvcnksIG5hbWVUcikgewogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCBuYW1lVHIobmFtZSksIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZmFjdG9yeShuYW1lLCB2YWx1ZSk7CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gQ29sbGVjdGlvbihpdGVyYWJsZSwgb3B0aW9ucywgZmFjdG9yeSwgbmFtZVRyLCBjYWxsYmFjaykgewogICAgbmFtZVRyID0gbmFtZVRyIHx8IFN0cmluZzsKICAgIHZhciBzZWxmID0gdGhpczsKICAKICAgIGZvciAodmFyIGlkIGluIGl0ZXJhYmxlKSB7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoaXRlcmFibGUsIGlkKSkgewogICAgICAgIG1lbW9pemUuY2FsbChzZWxmLCBpZCwgaXRlcmFibGVbaWRdLCBmYWN0b3J5LCBuYW1lVHIpOwogICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soaWQsIGl0ZXJhYmxlW2lkXSk7CiAgICAgIH0KICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBDb2xsZWN0aW9uOwogIAogIH0seyIuLi91dGlsIjo3MX1dLDQwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgU2hhcGUgPSByZXF1aXJlKCcuL3NoYXBlJyk7CiAgCiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIHByb3BlcnR5ID0gdXRpbC5wcm9wZXJ0eTsKICB2YXIgbWVtb2l6ZWRQcm9wZXJ0eSA9IHV0aWwubWVtb2l6ZWRQcm9wZXJ0eTsKICAKICBmdW5jdGlvbiBPcGVyYXRpb24obmFtZSwgb3BlcmF0aW9uLCBvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAKICAgIHByb3BlcnR5KHRoaXMsICduYW1lJywgb3BlcmF0aW9uLm5hbWUgfHwgbmFtZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnYXBpJywgb3B0aW9ucy5hcGksIGZhbHNlKTsKICAKICAgIG9wZXJhdGlvbi5odHRwID0gb3BlcmF0aW9uLmh0dHAgfHwge307CiAgICBwcm9wZXJ0eSh0aGlzLCAnZW5kcG9pbnQnLCBvcGVyYXRpb24uZW5kcG9pbnQpOwogICAgcHJvcGVydHkodGhpcywgJ2h0dHBNZXRob2QnLCBvcGVyYXRpb24uaHR0cC5tZXRob2QgfHwgJ1BPU1QnKTsKICAgIHByb3BlcnR5KHRoaXMsICdodHRwUGF0aCcsIG9wZXJhdGlvbi5odHRwLnJlcXVlc3RVcmkgfHwgJy8nKTsKICAgIHByb3BlcnR5KHRoaXMsICdhdXRodHlwZScsIG9wZXJhdGlvbi5hdXRodHlwZSB8fCAnJyk7CiAgICBwcm9wZXJ0eSgKICAgICAgdGhpcywKICAgICAgJ2VuZHBvaW50RGlzY292ZXJ5UmVxdWlyZWQnLAogICAgICBvcGVyYXRpb24uZW5kcG9pbnRkaXNjb3ZlcnkgPwogICAgICAgIChvcGVyYXRpb24uZW5kcG9pbnRkaXNjb3ZlcnkucmVxdWlyZWQgPyAnUkVRVUlSRUQnIDogJ09QVElPTkFMJykgOgogICAgICAnTlVMTCcKICAgICk7CiAgCiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdpbnB1dCcsIGZ1bmN0aW9uKCkgewogICAgICBpZiAoIW9wZXJhdGlvbi5pbnB1dCkgewogICAgICAgIHJldHVybiBuZXcgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RydWN0dXJlJ30sIG9wdGlvbnMpOwogICAgICB9CiAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUob3BlcmF0aW9uLmlucHV0LCBvcHRpb25zKTsKICAgIH0pOwogIAogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnb3V0cHV0JywgZnVuY3Rpb24oKSB7CiAgICAgIGlmICghb3BlcmF0aW9uLm91dHB1dCkgewogICAgICAgIHJldHVybiBuZXcgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RydWN0dXJlJ30sIG9wdGlvbnMpOwogICAgICB9CiAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUob3BlcmF0aW9uLm91dHB1dCwgb3B0aW9ucyk7CiAgICB9KTsKICAKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2Vycm9ycycsIGZ1bmN0aW9uKCkgewogICAgICB2YXIgbGlzdCA9IFtdOwogICAgICBpZiAoIW9wZXJhdGlvbi5lcnJvcnMpIHJldHVybiBudWxsOwogIAogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9wZXJhdGlvbi5lcnJvcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBsaXN0LnB1c2goU2hhcGUuY3JlYXRlKG9wZXJhdGlvbi5lcnJvcnNbaV0sIG9wdGlvbnMpKTsKICAgICAgfQogIAogICAgICByZXR1cm4gbGlzdDsKICAgIH0pOwogIAogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAncGFnaW5hdG9yJywgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBvcHRpb25zLmFwaS5wYWdpbmF0b3JzW25hbWVdOwogICAgfSk7CiAgCiAgICBpZiAob3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uJywgb3BlcmF0aW9uLmRvY3VtZW50YXRpb24pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAnZG9jdW1lbnRhdGlvblVybCcsIG9wZXJhdGlvbi5kb2N1bWVudGF0aW9uVXJsKTsKICAgIH0KICAKICAgIC8vIGlkZW1wb3RlbnRNZW1iZXJzIG9ubHkgdHJhY2tzIHRvcC1sZXZlbCBpbnB1dCBzaGFwZXMKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2lkZW1wb3RlbnRNZW1iZXJzJywgZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpZGVtcG90ZW50TWVtYmVycyA9IFtdOwogICAgICB2YXIgaW5wdXQgPSBzZWxmLmlucHV0OwogICAgICB2YXIgbWVtYmVycyA9IGlucHV0Lm1lbWJlcnM7CiAgICAgIGlmICghaW5wdXQubWVtYmVycykgewogICAgICAgIHJldHVybiBpZGVtcG90ZW50TWVtYmVyczsKICAgICAgfQogICAgICBmb3IgKHZhciBuYW1lIGluIG1lbWJlcnMpIHsKICAgICAgICBpZiAoIW1lbWJlcnMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBpZiAobWVtYmVyc1tuYW1lXS5pc0lkZW1wb3RlbnQgPT09IHRydWUpIHsKICAgICAgICAgIGlkZW1wb3RlbnRNZW1iZXJzLnB1c2gobmFtZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBpZGVtcG90ZW50TWVtYmVyczsKICAgIH0pOwogIAogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnaGFzRXZlbnRPdXRwdXQnLCBmdW5jdGlvbigpIHsKICAgICAgdmFyIG91dHB1dCA9IHNlbGYub3V0cHV0OwogICAgICByZXR1cm4gaGFzRXZlbnRTdHJlYW0ob3V0cHV0KTsKICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBoYXNFdmVudFN0cmVhbSh0b3BMZXZlbFNoYXBlKSB7CiAgICB2YXIgbWVtYmVycyA9IHRvcExldmVsU2hhcGUubWVtYmVyczsKICAgIHZhciBwYXlsb2FkID0gdG9wTGV2ZWxTaGFwZS5wYXlsb2FkOwogIAogICAgaWYgKCF0b3BMZXZlbFNoYXBlLm1lbWJlcnMpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIAogICAgaWYgKHBheWxvYWQpIHsKICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBtZW1iZXJzW3BheWxvYWRdOwogICAgICByZXR1cm4gcGF5bG9hZE1lbWJlci5pc0V2ZW50U3RyZWFtOwogICAgfQogIAogICAgLy8gY2hlY2sgaWYgYW55IG1lbWJlciBpcyBhbiBldmVudCBzdHJlYW0KICAgIGZvciAodmFyIG5hbWUgaW4gbWVtYmVycykgewogICAgICBpZiAoIW1lbWJlcnMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICBpZiAobWVtYmVyc1tuYW1lXS5pc0V2ZW50U3RyZWFtID09PSB0cnVlKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBPcGVyYXRpb247CiAgCiAgfSx7Ii4uL3V0aWwiOjcxLCIuL3NoYXBlIjo0M31dLDQxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgcHJvcGVydHkgPSByZXF1aXJlKCcuLi91dGlsJykucHJvcGVydHk7CiAgCiAgZnVuY3Rpb24gUGFnaW5hdG9yKG5hbWUsIHBhZ2luYXRvcikgewogICAgcHJvcGVydHkodGhpcywgJ2lucHV0VG9rZW4nLCBwYWdpbmF0b3IuaW5wdXRfdG9rZW4pOwogICAgcHJvcGVydHkodGhpcywgJ2xpbWl0S2V5JywgcGFnaW5hdG9yLmxpbWl0X2tleSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnbW9yZVJlc3VsdHMnLCBwYWdpbmF0b3IubW9yZV9yZXN1bHRzKTsKICAgIHByb3BlcnR5KHRoaXMsICdvdXRwdXRUb2tlbicsIHBhZ2luYXRvci5vdXRwdXRfdG9rZW4pOwogICAgcHJvcGVydHkodGhpcywgJ3Jlc3VsdEtleScsIHBhZ2luYXRvci5yZXN1bHRfa2V5KTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBQYWdpbmF0b3I7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxfV0sNDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBwcm9wZXJ0eSA9IHV0aWwucHJvcGVydHk7CiAgCiAgZnVuY3Rpb24gUmVzb3VyY2VXYWl0ZXIobmFtZSwgd2FpdGVyLCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHByb3BlcnR5KHRoaXMsICduYW1lJywgbmFtZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnYXBpJywgb3B0aW9ucy5hcGksIGZhbHNlKTsKICAKICAgIGlmICh3YWl0ZXIub3BlcmF0aW9uKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdvcGVyYXRpb24nLCB1dGlsLnN0cmluZy5sb3dlckZpcnN0KHdhaXRlci5vcGVyYXRpb24pKTsKICAgIH0KICAKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBrZXlzID0gWwogICAgICAndHlwZScsCiAgICAgICdkZXNjcmlwdGlvbicsCiAgICAgICdkZWxheScsCiAgICAgICdtYXhBdHRlbXB0cycsCiAgICAgICdhY2NlcHRvcnMnCiAgICBdOwogIAogICAga2V5cy5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgICB2YXIgdmFsdWUgPSB3YWl0ZXJba2V5XTsKICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgcHJvcGVydHkoc2VsZiwga2V5LCB2YWx1ZSk7CiAgICAgIH0KICAgIH0pOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IFJlc291cmNlV2FpdGVyOwogIAogIH0seyIuLi91dGlsIjo3MX1dLDQzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQ29sbGVjdGlvbiA9IHJlcXVpcmUoJy4vY29sbGVjdGlvbicpOwogIAogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIAogIGZ1bmN0aW9uIHByb3BlcnR5KG9iaiwgbmFtZSwgdmFsdWUpIHsKICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHV0aWwucHJvcGVydHkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gbWVtb2l6ZWRQcm9wZXJ0eShvYmosIG5hbWUpIHsKICAgIGlmICghb2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZVtuYW1lXSkgewogICAgICB1dGlsLm1lbW9pemVkUHJvcGVydHkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gU2hhcGUoc2hhcGUsIG9wdGlvbnMsIG1lbWJlck5hbWUpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIAogICAgcHJvcGVydHkodGhpcywgJ3NoYXBlJywgc2hhcGUuc2hhcGUpOwogICAgcHJvcGVydHkodGhpcywgJ2FwaScsIG9wdGlvbnMuYXBpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAndHlwZScsIHNoYXBlLnR5cGUpOwogICAgcHJvcGVydHkodGhpcywgJ2VudW0nLCBzaGFwZS5lbnVtKTsKICAgIHByb3BlcnR5KHRoaXMsICdtaW4nLCBzaGFwZS5taW4pOwogICAgcHJvcGVydHkodGhpcywgJ21heCcsIHNoYXBlLm1heCk7CiAgICBwcm9wZXJ0eSh0aGlzLCAncGF0dGVybicsIHNoYXBlLnBhdHRlcm4pOwogICAgcHJvcGVydHkodGhpcywgJ2xvY2F0aW9uJywgc2hhcGUubG9jYXRpb24gfHwgdGhpcy5sb2NhdGlvbiB8fCAnYm9keScpOwogICAgcHJvcGVydHkodGhpcywgJ25hbWUnLCB0aGlzLm5hbWUgfHwgc2hhcGUueG1sTmFtZSB8fCBzaGFwZS5xdWVyeU5hbWUgfHwKICAgICAgc2hhcGUubG9jYXRpb25OYW1lIHx8IG1lbWJlck5hbWUpOwogICAgcHJvcGVydHkodGhpcywgJ2lzU3RyZWFtaW5nJywgc2hhcGUuc3RyZWFtaW5nIHx8IHRoaXMuaXNTdHJlYW1pbmcgfHwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ3JlcXVpcmVzTGVuZ3RoJywgc2hhcGUucmVxdWlyZXNMZW5ndGgsIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0NvbXBvc2l0ZScsIHNoYXBlLmlzQ29tcG9zaXRlIHx8IGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc1NoYXBlJywgdHJ1ZSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzUXVlcnlOYW1lJywgQm9vbGVhbihzaGFwZS5xdWVyeU5hbWUpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNMb2NhdGlvbk5hbWUnLCBCb29sZWFuKHNoYXBlLmxvY2F0aW9uTmFtZSksIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0lkZW1wb3RlbnQnLCBzaGFwZS5pZGVtcG90ZW5jeVRva2VuID09PSB0cnVlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0pzb25WYWx1ZScsIHNoYXBlLmpzb252YWx1ZSA9PT0gdHJ1ZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNTZW5zaXRpdmUnLCBzaGFwZS5zZW5zaXRpdmUgPT09IHRydWUgfHwgc2hhcGUucHJvdG90eXBlICYmIHNoYXBlLnByb3RvdHlwZS5zZW5zaXRpdmUgPT09IHRydWUpOwogICAgcHJvcGVydHkodGhpcywgJ2lzRXZlbnRTdHJlYW0nLCBCb29sZWFuKHNoYXBlLmV2ZW50c3RyZWFtKSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzRXZlbnQnLCBCb29sZWFuKHNoYXBlLmV2ZW50KSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzRXZlbnRQYXlsb2FkJywgQm9vbGVhbihzaGFwZS5ldmVudHBheWxvYWQpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNFdmVudEhlYWRlcicsIEJvb2xlYW4oc2hhcGUuZXZlbnRoZWFkZXIpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNUaW1lc3RhbXBGb3JtYXRTZXQnLCBCb29sZWFuKHNoYXBlLnRpbWVzdGFtcEZvcm1hdCkgfHwgc2hhcGUucHJvdG90eXBlICYmIHNoYXBlLnByb3RvdHlwZS5pc1RpbWVzdGFtcEZvcm1hdFNldCA9PT0gdHJ1ZSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2VuZHBvaW50RGlzY292ZXJ5SWQnLCBCb29sZWFuKHNoYXBlLmVuZHBvaW50ZGlzY292ZXJ5aWQpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaG9zdExhYmVsJywgQm9vbGVhbihzaGFwZS5ob3N0TGFiZWwpLCBmYWxzZSk7CiAgCiAgICBpZiAob3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uJywgc2hhcGUuZG9jdW1lbnRhdGlvbik7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uVXJsJywgc2hhcGUuZG9jdW1lbnRhdGlvblVybCk7CiAgICB9CiAgCiAgICBpZiAoc2hhcGUueG1sQXR0cmlidXRlKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdpc1htbEF0dHJpYnV0ZScsIHNoYXBlLnhtbEF0dHJpYnV0ZSB8fCBmYWxzZSk7CiAgICB9CiAgCiAgICAvLyB0eXBlIGNvbnZlcnNpb24gYW5kIHBhcnNpbmcKICAgIHByb3BlcnR5KHRoaXMsICdkZWZhdWx0VmFsdWUnLCBudWxsKTsKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiAnJzsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfTsKICAgIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsgcmV0dXJuIHZhbHVlOyB9OwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBTaGFwZS5ub3JtYWxpemVkVHlwZXMgPSB7CiAgICBjaGFyYWN0ZXI6ICdzdHJpbmcnLAogICAgZG91YmxlOiAnZmxvYXQnLAogICAgbG9uZzogJ2ludGVnZXInLAogICAgc2hvcnQ6ICdpbnRlZ2VyJywKICAgIGJpZ2ludGVnZXI6ICdpbnRlZ2VyJywKICAgIGJpZ2RlY2ltYWw6ICdmbG9hdCcsCiAgICBibG9iOiAnYmluYXJ5JwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgU2hhcGUudHlwZXMgPSB7CiAgICAnc3RydWN0dXJlJzogU3RydWN0dXJlU2hhcGUsCiAgICAnbGlzdCc6IExpc3RTaGFwZSwKICAgICdtYXAnOiBNYXBTaGFwZSwKICAgICdib29sZWFuJzogQm9vbGVhblNoYXBlLAogICAgJ3RpbWVzdGFtcCc6IFRpbWVzdGFtcFNoYXBlLAogICAgJ2Zsb2F0JzogRmxvYXRTaGFwZSwKICAgICdpbnRlZ2VyJzogSW50ZWdlclNoYXBlLAogICAgJ3N0cmluZyc6IFN0cmluZ1NoYXBlLAogICAgJ2Jhc2U2NCc6IEJhc2U2NFNoYXBlLAogICAgJ2JpbmFyeSc6IEJpbmFyeVNoYXBlCiAgfTsKICAKICBTaGFwZS5yZXNvbHZlID0gZnVuY3Rpb24gcmVzb2x2ZShzaGFwZSwgb3B0aW9ucykgewogICAgaWYgKHNoYXBlLnNoYXBlKSB7CiAgICAgIHZhciByZWZTaGFwZSA9IG9wdGlvbnMuYXBpLnNoYXBlc1tzaGFwZS5zaGFwZV07CiAgICAgIGlmICghcmVmU2hhcGUpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBmaW5kIHNoYXBlIHJlZmVyZW5jZTogJyArIHNoYXBlLnNoYXBlKTsKICAgICAgfQogIAogICAgICByZXR1cm4gcmVmU2hhcGU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9OwogIAogIFNoYXBlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShzaGFwZSwgb3B0aW9ucywgbWVtYmVyTmFtZSkgewogICAgaWYgKHNoYXBlLmlzU2hhcGUpIHJldHVybiBzaGFwZTsKICAKICAgIHZhciByZWZTaGFwZSA9IFNoYXBlLnJlc29sdmUoc2hhcGUsIG9wdGlvbnMpOwogICAgaWYgKHJlZlNoYXBlKSB7CiAgICAgIHZhciBmaWx0ZXJlZEtleXMgPSBPYmplY3Qua2V5cyhzaGFwZSk7CiAgICAgIGlmICghb3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICAgICAgZmlsdGVyZWRLZXlzID0gZmlsdGVyZWRLZXlzLmZpbHRlcihmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICByZXR1cm4gIW5hbWUubWF0Y2goL2RvY3VtZW50YXRpb24vKTsKICAgICAgICB9KTsKICAgICAgfQogIAogICAgICAvLyBjcmVhdGUgYW4gaW5saW5lIHNoYXBlIHdpdGggZXh0cmEgbWVtYmVycwogICAgICB2YXIgSW5saW5lU2hhcGUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZWZTaGFwZS5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIHNoYXBlLCBvcHRpb25zLCBtZW1iZXJOYW1lKTsKICAgICAgfTsKICAgICAgSW5saW5lU2hhcGUucHJvdG90eXBlID0gcmVmU2hhcGU7CiAgICAgIHJldHVybiBuZXcgSW5saW5lU2hhcGUoKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHNldCB0eXBlIGlmIG5vdCBzZXQKICAgICAgaWYgKCFzaGFwZS50eXBlKSB7CiAgICAgICAgaWYgKHNoYXBlLm1lbWJlcnMpIHNoYXBlLnR5cGUgPSAnc3RydWN0dXJlJzsKICAgICAgICBlbHNlIGlmIChzaGFwZS5tZW1iZXIpIHNoYXBlLnR5cGUgPSAnbGlzdCc7CiAgICAgICAgZWxzZSBpZiAoc2hhcGUua2V5KSBzaGFwZS50eXBlID0gJ21hcCc7CiAgICAgICAgZWxzZSBzaGFwZS50eXBlID0gJ3N0cmluZyc7CiAgICAgIH0KICAKICAgICAgLy8gbm9ybWFsaXplIHR5cGVzCiAgICAgIHZhciBvcmlnVHlwZSA9IHNoYXBlLnR5cGU7CiAgICAgIGlmIChTaGFwZS5ub3JtYWxpemVkVHlwZXNbc2hhcGUudHlwZV0pIHsKICAgICAgICBzaGFwZS50eXBlID0gU2hhcGUubm9ybWFsaXplZFR5cGVzW3NoYXBlLnR5cGVdOwogICAgICB9CiAgCiAgICAgIGlmIChTaGFwZS50eXBlc1tzaGFwZS50eXBlXSkgewogICAgICAgIHJldHVybiBuZXcgU2hhcGUudHlwZXNbc2hhcGUudHlwZV0oc2hhcGUsIG9wdGlvbnMsIG1lbWJlck5hbWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5yZWNvZ25pemVkIHNoYXBlIHR5cGU6ICcgKyBvcmlnVHlwZSk7CiAgICAgIH0KICAgIH0KICB9OwogIAogIGZ1bmN0aW9uIENvbXBvc2l0ZVNoYXBlKHNoYXBlKSB7CiAgICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgcHJvcGVydHkodGhpcywgJ2lzQ29tcG9zaXRlJywgdHJ1ZSk7CiAgCiAgICBpZiAoc2hhcGUuZmxhdHRlbmVkKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdmbGF0dGVuZWQnLCBzaGFwZS5mbGF0dGVuZWQgfHwgZmFsc2UpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBTdHJ1Y3R1cmVTaGFwZShzaGFwZSwgb3B0aW9ucykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHJlcXVpcmVkTWFwID0gbnVsbCwgZmlyc3RJbml0ID0gIXRoaXMuaXNTaGFwZTsKICAKICAgIENvbXBvc2l0ZVNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICBpZiAoZmlyc3RJbml0KSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkZWZhdWx0VmFsdWUnLCBmdW5jdGlvbigpIHsgcmV0dXJuIHt9OyB9KTsKICAgICAgcHJvcGVydHkodGhpcywgJ21lbWJlcnMnLCB7fSk7CiAgICAgIHByb3BlcnR5KHRoaXMsICdtZW1iZXJOYW1lcycsIFtdKTsKICAgICAgcHJvcGVydHkodGhpcywgJ3JlcXVpcmVkJywgW10pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAnaXNSZXF1aXJlZCcsIGZ1bmN0aW9uKCkgeyByZXR1cm4gZmFsc2U7IH0pOwogICAgfQogIAogICAgaWYgKHNoYXBlLm1lbWJlcnMpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ21lbWJlcnMnLCBuZXcgQ29sbGVjdGlvbihzaGFwZS5tZW1iZXJzLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCBtZW1iZXIpIHsKICAgICAgICByZXR1cm4gU2hhcGUuY3JlYXRlKG1lbWJlciwgb3B0aW9ucywgbmFtZSk7CiAgICAgIH0pKTsKICAgICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnbWVtYmVyTmFtZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc2hhcGUueG1sT3JkZXIgfHwgT2JqZWN0LmtleXMoc2hhcGUubWVtYmVycyk7CiAgICAgIH0pOwogIAogICAgICBpZiAoc2hhcGUuZXZlbnQpIHsKICAgICAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdldmVudFBheWxvYWRNZW1iZXJOYW1lJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgbWVtYmVycyA9IHNlbGYubWVtYmVyczsKICAgICAgICAgIHZhciBtZW1iZXJOYW1lcyA9IHNlbGYubWVtYmVyTmFtZXM7CiAgICAgICAgICAvLyBpdGVyYXRlIG92ZXIgbWVtYmVycyB0byBmaW5kIG9uZXMgdGhhdCBhcmUgZXZlbnQgcGF5bG9hZHMKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gbWVtYmVyTmFtZXMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmIChtZW1iZXJzW21lbWJlck5hbWVzW2ldXS5pc0V2ZW50UGF5bG9hZCkgewogICAgICAgICAgICAgIHJldHVybiBtZW1iZXJOYW1lc1tpXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogIAogICAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2V2ZW50SGVhZGVyTWVtYmVyTmFtZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBtZW1iZXJzID0gc2VsZi5tZW1iZXJzOwogICAgICAgICAgdmFyIG1lbWJlck5hbWVzID0gc2VsZi5tZW1iZXJOYW1lczsKICAgICAgICAgIHZhciBldmVudEhlYWRlck1lbWJlck5hbWVzID0gW107CiAgICAgICAgICAvLyBpdGVyYXRlIG92ZXIgbWVtYmVycyB0byBmaW5kIG9uZXMgdGhhdCBhcmUgZXZlbnQgaGVhZGVycwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBtZW1iZXJOYW1lcy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgICAgaWYgKG1lbWJlcnNbbWVtYmVyTmFtZXNbaV1dLmlzRXZlbnRIZWFkZXIpIHsKICAgICAgICAgICAgICBldmVudEhlYWRlck1lbWJlck5hbWVzLnB1c2gobWVtYmVyTmFtZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZXZlbnRIZWFkZXJNZW1iZXJOYW1lczsKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIAogICAgaWYgKHNoYXBlLnJlcXVpcmVkKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdyZXF1aXJlZCcsIHNoYXBlLnJlcXVpcmVkKTsKICAgICAgcHJvcGVydHkodGhpcywgJ2lzUmVxdWlyZWQnLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgaWYgKCFyZXF1aXJlZE1hcCkgewogICAgICAgICAgcmVxdWlyZWRNYXAgPSB7fTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2hhcGUucmVxdWlyZWQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcmVxdWlyZWRNYXBbc2hhcGUucmVxdWlyZWRbaV1dID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgCiAgICAgICAgcmV0dXJuIHJlcXVpcmVkTWFwW25hbWVdOwogICAgICB9LCBmYWxzZSwgdHJ1ZSk7CiAgICB9CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAncmVzdWx0V3JhcHBlcicsIHNoYXBlLnJlc3VsdFdyYXBwZXIgfHwgbnVsbCk7CiAgCiAgICBpZiAoc2hhcGUucGF5bG9hZCkgewogICAgICBwcm9wZXJ0eSh0aGlzLCAncGF5bG9hZCcsIHNoYXBlLnBheWxvYWQpOwogICAgfQogIAogICAgaWYgKHR5cGVvZiBzaGFwZS54bWxOYW1lc3BhY2UgPT09ICdzdHJpbmcnKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd4bWxOYW1lc3BhY2VVcmknLCBzaGFwZS54bWxOYW1lc3BhY2UpOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygc2hhcGUueG1sTmFtZXNwYWNlID09PSAnb2JqZWN0JykgewogICAgICBwcm9wZXJ0eSh0aGlzLCAneG1sTmFtZXNwYWNlUHJlZml4Jywgc2hhcGUueG1sTmFtZXNwYWNlLnByZWZpeCk7CiAgICAgIHByb3BlcnR5KHRoaXMsICd4bWxOYW1lc3BhY2VVcmknLCBzaGFwZS54bWxOYW1lc3BhY2UudXJpKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gTGlzdFNoYXBlKHNoYXBlLCBvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXMsIGZpcnN0SW5pdCA9ICF0aGlzLmlzU2hhcGU7CiAgICBDb21wb3NpdGVTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgaWYgKGZpcnN0SW5pdCkgewogICAgICBwcm9wZXJ0eSh0aGlzLCAnZGVmYXVsdFZhbHVlJywgZnVuY3Rpb24oKSB7IHJldHVybiBbXTsgfSk7CiAgICB9CiAgCiAgICBpZiAoc2hhcGUubWVtYmVyKSB7CiAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ21lbWJlcicsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUoc2hhcGUubWVtYmVyLCBvcHRpb25zKTsKICAgICAgfSk7CiAgICB9CiAgCiAgICBpZiAodGhpcy5mbGF0dGVuZWQpIHsKICAgICAgdmFyIG9sZE5hbWUgPSB0aGlzLm5hbWU7CiAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ25hbWUnLCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc2VsZi5tZW1iZXIubmFtZSB8fCBvbGROYW1lOwogICAgICB9KTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gTWFwU2hhcGUoc2hhcGUsIG9wdGlvbnMpIHsKICAgIHZhciBmaXJzdEluaXQgPSAhdGhpcy5pc1NoYXBlOwogICAgQ29tcG9zaXRlU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAKICAgIGlmIChmaXJzdEluaXQpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ2RlZmF1bHRWYWx1ZScsIGZ1bmN0aW9uKCkgeyByZXR1cm4ge307IH0pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAna2V5JywgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RyaW5nJ30sIG9wdGlvbnMpKTsKICAgICAgcHJvcGVydHkodGhpcywgJ3ZhbHVlJywgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RyaW5nJ30sIG9wdGlvbnMpKTsKICAgIH0KICAKICAgIGlmIChzaGFwZS5rZXkpIHsKICAgICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAna2V5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShzaGFwZS5rZXksIG9wdGlvbnMpOwogICAgICB9KTsKICAgIH0KICAgIGlmIChzaGFwZS52YWx1ZSkgewogICAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICd2YWx1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUoc2hhcGUudmFsdWUsIG9wdGlvbnMpOwogICAgICB9KTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gVGltZXN0YW1wU2hhcGUoc2hhcGUpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICBpZiAoc2hhcGUudGltZXN0YW1wRm9ybWF0KSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCBzaGFwZS50aW1lc3RhbXBGb3JtYXQpOwogICAgfSBlbHNlIGlmIChzZWxmLmlzVGltZXN0YW1wRm9ybWF0U2V0ICYmIHRoaXMudGltZXN0YW1wRm9ybWF0KSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCB0aGlzLnRpbWVzdGFtcEZvcm1hdCk7CiAgICB9IGVsc2UgaWYgKHRoaXMubG9jYXRpb24gPT09ICdoZWFkZXInKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCAncmZjODIyJyk7CiAgICB9IGVsc2UgaWYgKHRoaXMubG9jYXRpb24gPT09ICdxdWVyeXN0cmluZycpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsICdpc284NjAxJyk7CiAgICB9IGVsc2UgaWYgKHRoaXMuYXBpKSB7CiAgICAgIHN3aXRjaCAodGhpcy5hcGkucHJvdG9jb2wpIHsKICAgICAgICBjYXNlICdqc29uJzoKICAgICAgICBjYXNlICdyZXN0LWpzb24nOgogICAgICAgICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsICd1bml4VGltZXN0YW1wJyk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdyZXN0LXhtbCc6CiAgICAgICAgY2FzZSAncXVlcnknOgogICAgICAgIGNhc2UgJ2VjMic6CiAgICAgICAgICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0JywgJ2lzbzg2MDEnKTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgCiAgICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZS50b1VUQ1N0cmluZyA9PT0gJ2Z1bmN0aW9uJykgcmV0dXJuIHZhbHVlOwogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInID8KICAgICAgICAgICAgIHV0aWwuZGF0ZS5wYXJzZVRpbWVzdGFtcCh2YWx1ZSkgOiBudWxsOwogICAgfTsKICAKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHV0aWwuZGF0ZS5mb3JtYXQodmFsdWUsIHNlbGYudGltZXN0YW1wRm9ybWF0KTsKICAgIH07CiAgfQogIAogIGZ1bmN0aW9uIFN0cmluZ1NoYXBlKCkgewogICAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAKICAgIHZhciBudWxsTGVzc1Byb3RvY29scyA9IFsncmVzdC14bWwnLCAncXVlcnknLCAnZWMyJ107CiAgICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhbHVlID0gdGhpcy5hcGkgJiYgbnVsbExlc3NQcm90b2NvbHMuaW5kZXhPZih0aGlzLmFwaS5wcm90b2NvbCkgPiAtMSA/CiAgICAgICAgdmFsdWUgfHwgJycgOiB2YWx1ZTsKICAgICAgaWYgKHRoaXMuaXNKc29uVmFsdWUpIHsKICAgICAgICByZXR1cm4gSlNPTi5wYXJzZSh2YWx1ZSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHZhbHVlICYmIHR5cGVvZiB2YWx1ZS50b1N0cmluZyA9PT0gJ2Z1bmN0aW9uJyA/CiAgICAgICAgdmFsdWUudG9TdHJpbmcoKSA6IHZhbHVlOwogICAgfTsKICAKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHRoaXMuaXNKc29uVmFsdWUgPyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgOiB2YWx1ZTsKICAgIH07CiAgfQogIAogIGZ1bmN0aW9uIEZsb2F0U2hhcGUoKSB7CiAgICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiBwYXJzZUZsb2F0KHZhbHVlKTsKICAgIH07CiAgICB0aGlzLnRvV2lyZUZvcm1hdCA9IHRoaXMudG9UeXBlOwogIH0KICAKICBmdW5jdGlvbiBJbnRlZ2VyU2hhcGUoKSB7CiAgICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiBwYXJzZUludCh2YWx1ZSwgMTApOwogICAgfTsKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gdGhpcy50b1R5cGU7CiAgfQogIAogIGZ1bmN0aW9uIEJpbmFyeVNoYXBlKCkgewogICAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIGJ1ZiA9IHV0aWwuYmFzZTY0LmRlY29kZSh2YWx1ZSk7CiAgICAgIGlmICh0aGlzLmlzU2Vuc2l0aXZlICYmIHV0aWwuaXNOb2RlKCkgJiYgdHlwZW9mIHV0aWwuQnVmZmVyLmFsbG9jID09PSAnZnVuY3Rpb24nKSB7CiAgICAvKiBOb2RlLmpzIGNhbiBjcmVhdGUgYSBCdWZmZXIgdGhhdCBpcyBub3QgaXNvbGF0ZWQuCiAgICAgKiBpLmUuIGJ1Zi5ieXRlTGVuZ3RoICE9PSBidWYuYnVmZmVyLmJ5dGVMZW5ndGgKICAgICAqIFRoaXMgbWVhbnMgdGhhdCB0aGUgc2Vuc2l0aXZlIGRhdGEgaXMgYWNjZXNzaWJsZSB0byBhbnlvbmUgd2l0aCBhY2Nlc3MgdG8gYnVmLmJ1ZmZlci4KICAgICAqIElmIHRoaXMgaXMgdGhlIG5vZGUgc2hhcmVkIEJ1ZmZlciwgdGhlbiBvdGhlciBjb2RlIHdpdGhpbiB0aGlzIHByb2Nlc3MgX2NvdWxkXyBmaW5kIHRoaXMgc2VjcmV0LgogICAgICogQ29weSBzZW5zaXRpdmUgZGF0YSB0byBhbiBpc29sYXRlZCBCdWZmZXIgYW5kIHplcm8gdGhlIHNlbnNpdGl2ZSBkYXRhLgogICAgICogV2hpbGUgdGhpcyBpcyBzYWZlIHRvIGRvIGhlcmUsIGNvcHlpbmcgdGhpcyBjb2RlIHNvbWV3aGVyZSBlbHNlIG1heSBwcm9kdWNlIHVuZXhwZWN0ZWQgcmVzdWx0cy4KICAgICAqLwogICAgICAgIHZhciBzZWN1cmVCdWYgPSB1dGlsLkJ1ZmZlci5hbGxvYyhidWYubGVuZ3RoLCBidWYpOwogICAgICAgIGJ1Zi5maWxsKDApOwogICAgICAgIGJ1ZiA9IHNlY3VyZUJ1ZjsKICAgICAgfQogICAgICByZXR1cm4gYnVmOwogICAgfTsKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gdXRpbC5iYXNlNjQuZW5jb2RlOwogIH0KICAKICBmdW5jdGlvbiBCYXNlNjRTaGFwZSgpIHsKICAgIEJpbmFyeVNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfQogIAogIGZ1bmN0aW9uIEJvb2xlYW5TaGFwZSgpIHsKICAgIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJykgcmV0dXJuIHZhbHVlOwogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiB2YWx1ZSA9PT0gJ3RydWUnOwogICAgfTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgU2hhcGUuc2hhcGVzID0gewogICAgU3RydWN0dXJlU2hhcGU6IFN0cnVjdHVyZVNoYXBlLAogICAgTGlzdFNoYXBlOiBMaXN0U2hhcGUsCiAgICBNYXBTaGFwZTogTWFwU2hhcGUsCiAgICBTdHJpbmdTaGFwZTogU3RyaW5nU2hhcGUsCiAgICBCb29sZWFuU2hhcGU6IEJvb2xlYW5TaGFwZSwKICAgIEJhc2U2NFNoYXBlOiBCYXNlNjRTaGFwZQogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBTaGFwZTsKICAKICB9LHsiLi4vdXRpbCI6NzEsIi4vY29sbGVjdGlvbiI6Mzl9XSw0NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5QYXJhbVZhbGlkYXRvciA9IEFXUy51dGlsLmluaGVyaXQoewogICAgLyoqCiAgICAgKiBDcmVhdGUgYSBuZXcgdmFsaWRhdG9yIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsaWRhdGlvbiBbQm9vbGVhbnxtYXBdIHdoZXRoZXIgaW5wdXQgcGFyYW1ldGVycyBzaG91bGQgYmUKICAgICAqICAgICB2YWxpZGF0ZWQgYWdhaW5zdCB0aGUgb3BlcmF0aW9uIGRlc2NyaXB0aW9uIGJlZm9yZSBzZW5kaW5nIHRoZQogICAgICogICAgIHJlcXVlc3QuIFBhc3MgYSBtYXAgdG8gZW5hYmxlIGFueSBvZiB0aGUgZm9sbG93aW5nIHNwZWNpZmljCiAgICAgKiAgICAgdmFsaWRhdGlvbiBmZWF0dXJlczoKICAgICAqCiAgICAgKiAgICAgKiAqKm1pbioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1pbgogICAgICogICAgICAgY29uc3RyYWludC4gVGhpcyBpcyBlbmFibGVkIGJ5IGRlZmF1bHQgd2hlbiBwYXJhbVZhbGlkYXRpb24gaXMgc2V0CiAgICAgKiAgICAgICB0byBgdHJ1ZWAuCiAgICAgKiAgICAgKiAqKm1heCoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1heAogICAgICogICAgICAgY29uc3RyYWludC4KICAgICAqICAgICAqICoqcGF0dGVybioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgYQogICAgICogICAgICAgcmVndWxhciBleHByZXNzaW9uLgogICAgICogICAgICogKiplbnVtKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBvbmUKICAgICAqICAgICAgIG9mIHRoZSBhbGxvd2FibGUgZW51bSB2YWx1ZXMuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBQYXJhbVZhbGlkYXRvcih2YWxpZGF0aW9uKSB7CiAgICAgIGlmICh2YWxpZGF0aW9uID09PSB0cnVlIHx8IHZhbGlkYXRpb24gPT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhbGlkYXRpb24gPSB7J21pbic6IHRydWV9OwogICAgICB9CiAgICAgIHRoaXMudmFsaWRhdGlvbiA9IHZhbGlkYXRpb247CiAgICB9LAogIAogICAgdmFsaWRhdGU6IGZ1bmN0aW9uIHZhbGlkYXRlKHNoYXBlLCBwYXJhbXMsIGNvbnRleHQpIHsKICAgICAgdGhpcy5lcnJvcnMgPSBbXTsKICAgICAgdGhpcy52YWxpZGF0ZU1lbWJlcihzaGFwZSwgcGFyYW1zIHx8IHt9LCBjb250ZXh0IHx8ICdwYXJhbXMnKTsKICAKICAgICAgaWYgKHRoaXMuZXJyb3JzLmxlbmd0aCA+IDEpIHsKICAgICAgICB2YXIgbXNnID0gdGhpcy5lcnJvcnMuam9pbignXG4qICcpOwogICAgICAgIG1zZyA9ICdUaGVyZSB3ZXJlICcgKyB0aGlzLmVycm9ycy5sZW5ndGggKwogICAgICAgICAgJyB2YWxpZGF0aW9uIGVycm9yczpcbiogJyArIG1zZzsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IobXNnKSwKICAgICAgICAgIHtjb2RlOiAnTXVsdGlwbGVWYWxpZGF0aW9uRXJyb3JzJywgZXJyb3JzOiB0aGlzLmVycm9yc30pOwogICAgICB9IGVsc2UgaWYgKHRoaXMuZXJyb3JzLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHRocm93IHRoaXMuZXJyb3JzWzBdOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9LAogIAogICAgZmFpbDogZnVuY3Rpb24gZmFpbChjb2RlLCBtZXNzYWdlKSB7CiAgICAgIHRoaXMuZXJyb3JzLnB1c2goQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKG1lc3NhZ2UpLCB7Y29kZTogY29kZX0pKTsKICAgIH0sCiAgCiAgICB2YWxpZGF0ZVN0cnVjdHVyZTogZnVuY3Rpb24gdmFsaWRhdGVTdHJ1Y3R1cmUoc2hhcGUsIHBhcmFtcywgY29udGV4dCkgewogICAgICB0aGlzLnZhbGlkYXRlVHlwZShwYXJhbXMsIGNvbnRleHQsIFsnb2JqZWN0J10sICdzdHJ1Y3R1cmUnKTsKICAKICAgICAgdmFyIHBhcmFtTmFtZTsKICAgICAgZm9yICh2YXIgaSA9IDA7IHNoYXBlLnJlcXVpcmVkICYmIGkgPCBzaGFwZS5yZXF1aXJlZC5sZW5ndGg7IGkrKykgewogICAgICAgIHBhcmFtTmFtZSA9IHNoYXBlLnJlcXVpcmVkW2ldOwogICAgICAgIHZhciB2YWx1ZSA9IHBhcmFtc1twYXJhbU5hbWVdOwogICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ01pc3NpbmdSZXF1aXJlZFBhcmFtZXRlcicsCiAgICAgICAgICAgICdNaXNzaW5nIHJlcXVpcmVkIGtleSBcJycgKyBwYXJhbU5hbWUgKyAnXCcgaW4gJyArIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogIAogICAgICAvLyB2YWxpZGF0ZSBoYXNoIG1lbWJlcnMKICAgICAgZm9yIChwYXJhbU5hbWUgaW4gcGFyYW1zKSB7CiAgICAgICAgaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocGFyYW1zLCBwYXJhbU5hbWUpKSBjb250aW51ZTsKICAKICAgICAgICB2YXIgcGFyYW1WYWx1ZSA9IHBhcmFtc1twYXJhbU5hbWVdLAogICAgICAgICAgICBtZW1iZXJTaGFwZSA9IHNoYXBlLm1lbWJlcnNbcGFyYW1OYW1lXTsKICAKICAgICAgICBpZiAobWVtYmVyU2hhcGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdmFyIG1lbWJlckNvbnRleHQgPSBbY29udGV4dCwgcGFyYW1OYW1lXS5qb2luKCcuJyk7CiAgICAgICAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKG1lbWJlclNoYXBlLCBwYXJhbVZhbHVlLCBtZW1iZXJDb250ZXh0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5mYWlsKCdVbmV4cGVjdGVkUGFyYW1ldGVyJywKICAgICAgICAgICAgJ1VuZXhwZWN0ZWQga2V5IFwnJyArIHBhcmFtTmFtZSArICdcJyBmb3VuZCBpbiAnICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAKICAgIHZhbGlkYXRlTWVtYmVyOiBmdW5jdGlvbiB2YWxpZGF0ZU1lbWJlcihzaGFwZSwgcGFyYW0sIGNvbnRleHQpIHsKICAgICAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICAgICAgY2FzZSAnc3RydWN0dXJlJzoKICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlU3RydWN0dXJlKHNoYXBlLCBwYXJhbSwgY29udGV4dCk7CiAgICAgICAgY2FzZSAnbGlzdCc6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZUxpc3Qoc2hhcGUsIHBhcmFtLCBjb250ZXh0KTsKICAgICAgICBjYXNlICdtYXAnOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVNYXAoc2hhcGUsIHBhcmFtLCBjb250ZXh0KTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVTY2FsYXIoc2hhcGUsIHBhcmFtLCBjb250ZXh0KTsKICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlTGlzdDogZnVuY3Rpb24gdmFsaWRhdGVMaXN0KHNoYXBlLCBwYXJhbXMsIGNvbnRleHQpIHsKICAgICAgaWYgKHRoaXMudmFsaWRhdGVUeXBlKHBhcmFtcywgY29udGV4dCwgW0FycmF5XSkpIHsKICAgICAgICB0aGlzLnZhbGlkYXRlUmFuZ2Uoc2hhcGUsIHBhcmFtcy5sZW5ndGgsIGNvbnRleHQsICdsaXN0IG1lbWJlciBjb3VudCcpOwogICAgICAgIC8vIHZhbGlkYXRlIGFycmF5IG1lbWJlcnMKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcmFtcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdGhpcy52YWxpZGF0ZU1lbWJlcihzaGFwZS5tZW1iZXIsIHBhcmFtc1tpXSwgY29udGV4dCArICdbJyArIGkgKyAnXScpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlTWFwOiBmdW5jdGlvbiB2YWxpZGF0ZU1hcChzaGFwZSwgcGFyYW1zLCBjb250ZXh0KSB7CiAgICAgIGlmICh0aGlzLnZhbGlkYXRlVHlwZShwYXJhbXMsIGNvbnRleHQsIFsnb2JqZWN0J10sICdtYXAnKSkgewogICAgICAgIC8vIEJ1aWxkIHVwIGEgY291bnQgb2YgbWFwIG1lbWJlcnMgdG8gdmFsaWRhdGUgcmFuZ2UgdHJhaXRzLgogICAgICAgIHZhciBtYXBDb3VudCA9IDA7CiAgICAgICAgZm9yICh2YXIgcGFyYW0gaW4gcGFyYW1zKSB7CiAgICAgICAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwYXJhbXMsIHBhcmFtKSkgY29udGludWU7CiAgICAgICAgICAvLyBWYWxpZGF0ZSBhbnkgbWFwIGtleSB0cmFpdCBjb25zdHJhaW50cwogICAgICAgICAgdGhpcy52YWxpZGF0ZU1lbWJlcihzaGFwZS5rZXksIHBhcmFtLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0ICsgJ1trZXk9XCcnICsgcGFyYW0gKyAnXCddJyk7CiAgICAgICAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKHNoYXBlLnZhbHVlLCBwYXJhbXNbcGFyYW1dLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0ICsgJ1tcJycgKyBwYXJhbSArICdcJ10nKTsKICAgICAgICAgIG1hcENvdW50Kys7CiAgICAgICAgfQogICAgICAgIHRoaXMudmFsaWRhdGVSYW5nZShzaGFwZSwgbWFwQ291bnQsIGNvbnRleHQsICdtYXAgbWVtYmVyIGNvdW50Jyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVNjYWxhcjogZnVuY3Rpb24gdmFsaWRhdGVTY2FsYXIoc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICAgIGNhc2UgbnVsbDoKICAgICAgICBjYXNlIHVuZGVmaW5lZDoKICAgICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVTdHJpbmcoc2hhcGUsIHZhbHVlLCBjb250ZXh0KTsKICAgICAgICBjYXNlICdiYXNlNjQnOgogICAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVBheWxvYWQodmFsdWUsIGNvbnRleHQpOwogICAgICAgIGNhc2UgJ2ludGVnZXInOgogICAgICAgIGNhc2UgJ2Zsb2F0JzoKICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlTnVtYmVyKHNoYXBlLCB2YWx1ZSwgY29udGV4dCk7CiAgICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVR5cGUodmFsdWUsIGNvbnRleHQsIFsnYm9vbGVhbiddKTsKICAgICAgICBjYXNlICd0aW1lc3RhbXAnOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCBbRGF0ZSwKICAgICAgICAgICAgL15cZHs0fS1cZHsyfS1cZHsyfVRcZHsyfTpcZHsyfTpcZHsyfShcLlxkKyk/WiQvLCAnbnVtYmVyJ10sCiAgICAgICAgICAgICdEYXRlIG9iamVjdCwgSVNPLTg2MDEgc3RyaW5nLCBvciBhIFVOSVggdGltZXN0YW1wJyk7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiB0aGlzLmZhaWwoJ1Vua293blR5cGUnLCAnVW5oYW5kbGVkIHR5cGUgJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlLnR5cGUgKyAnIGZvciAnICsgY29udGV4dCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVN0cmluZzogZnVuY3Rpb24gdmFsaWRhdGVTdHJpbmcoc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciB2YWxpZFR5cGVzID0gWydzdHJpbmcnXTsKICAgICAgaWYgKHNoYXBlLmlzSnNvblZhbHVlKSB7CiAgICAgICAgdmFsaWRUeXBlcyA9IHZhbGlkVHlwZXMuY29uY2F0KFsnbnVtYmVyJywgJ29iamVjdCcsICdib29sZWFuJ10pOwogICAgICB9CiAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB0aGlzLnZhbGlkYXRlVHlwZSh2YWx1ZSwgY29udGV4dCwgdmFsaWRUeXBlcykpIHsKICAgICAgICB0aGlzLnZhbGlkYXRlRW51bShzaGFwZSwgdmFsdWUsIGNvbnRleHQpOwogICAgICAgIHRoaXMudmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUubGVuZ3RoLCBjb250ZXh0LCAnc3RyaW5nIGxlbmd0aCcpOwogICAgICAgIHRoaXMudmFsaWRhdGVQYXR0ZXJuKHNoYXBlLCB2YWx1ZSwgY29udGV4dCk7CiAgICAgICAgdGhpcy52YWxpZGF0ZVVyaShzaGFwZSwgdmFsdWUsIGNvbnRleHQpOwogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVVcmk6IGZ1bmN0aW9uIHZhbGlkYXRlVXJpKHNoYXBlLCB2YWx1ZSwgY29udGV4dCkgewogICAgICBpZiAoc2hhcGVbJ2xvY2F0aW9uJ10gPT09ICd1cmknKSB7CiAgICAgICAgaWYgKHZhbHVlLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgdGhpcy5mYWlsKCdVcmlQYXJhbWV0ZXJFcnJvcicsICdFeHBlY3RlZCB1cmkgcGFyYW1ldGVyIHRvIGhhdmUgbGVuZ3RoID49IDEsJwogICAgICAgICAgICArICcgYnV0IGZvdW5kICInICsgdmFsdWUgKyciIGZvciAnICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVQYXR0ZXJuOiBmdW5jdGlvbiB2YWxpZGF0ZVBhdHRlcm4oc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIGlmICh0aGlzLnZhbGlkYXRpb25bJ3BhdHRlcm4nXSAmJiBzaGFwZVsncGF0dGVybiddICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAoIShuZXcgUmVnRXhwKHNoYXBlWydwYXR0ZXJuJ10pKS50ZXN0KHZhbHVlKSkgewogICAgICAgICAgdGhpcy5mYWlsKCdQYXR0ZXJuTWF0Y2hFcnJvcicsICdQcm92aWRlZCB2YWx1ZSAiJyArIHZhbHVlICsgJyIgJwogICAgICAgICAgICArICdkb2VzIG5vdCBtYXRjaCByZWdleCBwYXR0ZXJuIC8nICsgc2hhcGVbJ3BhdHRlcm4nXSArICcvIGZvciAnCiAgICAgICAgICAgICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVSYW5nZTogZnVuY3Rpb24gdmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUsIGNvbnRleHQsIGRlc2NyaXB0b3IpIHsKICAgICAgaWYgKHRoaXMudmFsaWRhdGlvblsnbWluJ10pIHsKICAgICAgICBpZiAoc2hhcGVbJ21pbiddICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgPCBzaGFwZVsnbWluJ10pIHsKICAgICAgICAgIHRoaXMuZmFpbCgnTWluUmFuZ2VFcnJvcicsICdFeHBlY3RlZCAnICsgZGVzY3JpcHRvciArICcgPj0gJwogICAgICAgICAgICArIHNoYXBlWydtaW4nXSArICcsIGJ1dCBmb3VuZCAnICsgdmFsdWUgKyAnIGZvciAnICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICh0aGlzLnZhbGlkYXRpb25bJ21heCddKSB7CiAgICAgICAgaWYgKHNoYXBlWydtYXgnXSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlID4gc2hhcGVbJ21heCddKSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ01heFJhbmdlRXJyb3InLCAnRXhwZWN0ZWQgJyArIGRlc2NyaXB0b3IgKyAnIDw9ICcKICAgICAgICAgICAgKyBzaGFwZVsnbWF4J10gKyAnLCBidXQgZm91bmQgJyArIHZhbHVlICsgJyBmb3IgJyArIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlRW51bTogZnVuY3Rpb24gdmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgaWYgKHRoaXMudmFsaWRhdGlvblsnZW51bSddICYmIHNoYXBlWydlbnVtJ10gIT09IHVuZGVmaW5lZCkgewogICAgICAgIC8vIEZhaWwgaWYgdGhlIHN0cmluZyB2YWx1ZSBpcyBub3QgcHJlc2VudCBpbiB0aGUgZW51bSBsaXN0CiAgICAgICAgaWYgKHNoYXBlWydlbnVtJ10uaW5kZXhPZih2YWx1ZSkgPT09IC0xKSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ0VudW1FcnJvcicsICdGb3VuZCBzdHJpbmcgdmFsdWUgb2YgJyArIHZhbHVlICsgJywgYnV0ICcKICAgICAgICAgICAgKyAnZXhwZWN0ZWQgJyArIHNoYXBlWydlbnVtJ10uam9pbignfCcpICsgJyBmb3IgJyArIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlVHlwZTogZnVuY3Rpb24gdmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCBhY2NlcHRlZFR5cGVzLCB0eXBlKSB7CiAgICAgIC8vIFdlIHdpbGwgbm90IGxvZyBhbiBlcnJvciBmb3IgbnVsbCBvciB1bmRlZmluZWQsIGJ1dCB3ZSB3aWxsIHJldHVybgogICAgICAvLyBmYWxzZSBzbyB0aGF0IGNhbGxlcnMga25vdyB0aGF0IHRoZSBleHBlY3RlZCB0eXBlIHdhcyBub3Qgc3RyaWN0bHkgbWV0LgogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGZhbHNlOwogIAogICAgICB2YXIgZm91bmRJbnZhbGlkVHlwZSA9IGZhbHNlOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFjY2VwdGVkVHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAodHlwZW9mIGFjY2VwdGVkVHlwZXNbaV0gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSBhY2NlcHRlZFR5cGVzW2ldKSByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKGFjY2VwdGVkVHlwZXNbaV0gaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICAgIGlmICgodmFsdWUgfHwgJycpLnRvU3RyaW5nKCkubWF0Y2goYWNjZXB0ZWRUeXBlc1tpXSkpIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBhY2NlcHRlZFR5cGVzW2ldKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgIGlmIChBV1MudXRpbC5pc1R5cGUodmFsdWUsIGFjY2VwdGVkVHlwZXNbaV0pKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgIGlmICghdHlwZSAmJiAhZm91bmRJbnZhbGlkVHlwZSkgYWNjZXB0ZWRUeXBlcyA9IGFjY2VwdGVkVHlwZXMuc2xpY2UoKTsKICAgICAgICAgIGFjY2VwdGVkVHlwZXNbaV0gPSBBV1MudXRpbC50eXBlTmFtZShhY2NlcHRlZFR5cGVzW2ldKTsKICAgICAgICB9CiAgICAgICAgZm91bmRJbnZhbGlkVHlwZSA9IHRydWU7CiAgICAgIH0KICAKICAgICAgdmFyIGFjY2VwdGVkVHlwZSA9IHR5cGU7CiAgICAgIGlmICghYWNjZXB0ZWRUeXBlKSB7CiAgICAgICAgYWNjZXB0ZWRUeXBlID0gYWNjZXB0ZWRUeXBlcy5qb2luKCcsICcpLnJlcGxhY2UoLywoW14sXSspJC8sICcsIG9yJDEnKTsKICAgICAgfQogIAogICAgICB2YXIgdm93ZWwgPSBhY2NlcHRlZFR5cGUubWF0Y2goL15bYWVpb3VdL2kpID8gJ24nIDogJyc7CiAgICAgIHRoaXMuZmFpbCgnSW52YWxpZFBhcmFtZXRlclR5cGUnLCAnRXhwZWN0ZWQgJyArIGNvbnRleHQgKyAnIHRvIGJlIGEnICsKICAgICAgICAgICAgICAgIHZvd2VsICsgJyAnICsgYWNjZXB0ZWRUeXBlKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAKICAgIHZhbGlkYXRlTnVtYmVyOiBmdW5jdGlvbiB2YWxpZGF0ZU51bWJlcihzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICB2YXIgY2FzdGVkVmFsdWUgPSBwYXJzZUZsb2F0KHZhbHVlKTsKICAgICAgICBpZiAoY2FzdGVkVmFsdWUudG9TdHJpbmcoKSA9PT0gdmFsdWUpIHZhbHVlID0gY2FzdGVkVmFsdWU7CiAgICAgIH0KICAgICAgaWYgKHRoaXMudmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCBbJ251bWJlciddKSkgewogICAgICAgIHRoaXMudmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUsIGNvbnRleHQsICdudW1lcmljIHZhbHVlJyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVBheWxvYWQ6IGZ1bmN0aW9uIHZhbGlkYXRlUGF5bG9hZCh2YWx1ZSwgY29udGV4dCkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgcmV0dXJuOwogICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlLmJ5dGVMZW5ndGggPT09ICdudW1iZXInKSByZXR1cm47IC8vIHR5cGVkIGFycmF5cwogICAgICBpZiAoQVdTLnV0aWwuaXNOb2RlKCkpIHsgLy8gc3BlY2lhbCBjaGVjayBmb3IgYnVmZmVyL3N0cmVhbSBpbiBOb2RlLmpzCiAgICAgICAgdmFyIFN0cmVhbSA9IEFXUy51dGlsLnN0cmVhbS5TdHJlYW07CiAgICAgICAgaWYgKEFXUy51dGlsLkJ1ZmZlci5pc0J1ZmZlcih2YWx1ZSkgfHwgdmFsdWUgaW5zdGFuY2VvZiBTdHJlYW0pIHJldHVybjsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodHlwZW9mIEJsb2IgIT09IHZvaWQgMCAmJiB2YWx1ZSBpbnN0YW5jZW9mIEJsb2IpIHJldHVybjsKICAgICAgfQogIAogICAgICB2YXIgdHlwZXMgPSBbJ0J1ZmZlcicsICdTdHJlYW0nLCAnRmlsZScsICdCbG9iJywgJ0FycmF5QnVmZmVyJywgJ0RhdGFWaWV3J107CiAgICAgIGlmICh2YWx1ZSkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChBV1MudXRpbC5pc1R5cGUodmFsdWUsIHR5cGVzW2ldKSkgcmV0dXJuOwogICAgICAgICAgaWYgKEFXUy51dGlsLnR5cGVOYW1lKHZhbHVlLmNvbnN0cnVjdG9yKSA9PT0gdHlwZXNbaV0pIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgdGhpcy5mYWlsKCdJbnZhbGlkUGFyYW1ldGVyVHlwZScsICdFeHBlY3RlZCAnICsgY29udGV4dCArICcgdG8gYmUgYSAnICsKICAgICAgICAnc3RyaW5nLCBCdWZmZXIsIFN0cmVhbSwgQmxvYiwgb3IgdHlwZWQgYXJyYXkgb2JqZWN0Jyk7CiAgICB9CiAgfSk7CiAgCiAgfSx7Ii4vY29yZSI6MTh9XSw0NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSAgcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogUHJlcGVuZCBwcmVmaXggZGVmaW5lZCBieSBBUEkgbW9kZWwgdG8gZW5kcG9pbnQgdGhhdCdzIGFscmVhZHkKICAgKiBjb25zdHJ1Y3RlZC4gVGhpcyBmZWF0dXJlIGRvZXMgbm90IGFwcGx5IHRvIG9wZXJhdGlvbnMgdXNpbmcKICAgKiBlbmRwb2ludCBkaXNjb3ZlcnkgYW5kIGNhbiBiZSBkaXNhYmxlZC4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBwb3B1bGF0ZUhvc3RQcmVmaXgocmVxdWVzdCkgIHsKICAgIHZhciBlbmFibGVkID0gcmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5ob3N0UHJlZml4RW5hYmxlZDsKICAgIGlmICghZW5hYmxlZCkgcmV0dXJuIHJlcXVlc3Q7CiAgICB2YXIgb3BlcmF0aW9uTW9kZWwgPSByZXF1ZXN0LnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dOwogICAgLy9kb24ndCBtYXJzaGFsIGhvc3QgcHJlZml4IHdoZW4gb3BlcmF0aW9uIGhhcyBlbmRwb2ludCBkaXNjb3ZlcnkgdHJhaXRzCiAgICBpZiAoaGFzRW5kcG9pbnREaXNjb3ZlcihyZXF1ZXN0KSkgcmV0dXJuIHJlcXVlc3Q7CiAgICBpZiAob3BlcmF0aW9uTW9kZWwuZW5kcG9pbnQgJiYgb3BlcmF0aW9uTW9kZWwuZW5kcG9pbnQuaG9zdFByZWZpeCkgewogICAgICB2YXIgaG9zdFByZWZpeE5vdGF0aW9uID0gb3BlcmF0aW9uTW9kZWwuZW5kcG9pbnQuaG9zdFByZWZpeDsKICAgICAgdmFyIGhvc3RQcmVmaXggPSBleHBhbmRIb3N0UHJlZml4KGhvc3RQcmVmaXhOb3RhdGlvbiwgcmVxdWVzdC5wYXJhbXMsIG9wZXJhdGlvbk1vZGVsLmlucHV0KTsKICAgICAgcHJlcGVuZEVuZHBvaW50UHJlZml4KHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQsIGhvc3RQcmVmaXgpOwogICAgICB2YWxpZGF0ZUhvc3RuYW1lKHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQuaG9zdG5hbWUpOwogICAgfQogICAgcmV0dXJuIHJlcXVlc3Q7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGhhc0VuZHBvaW50RGlzY292ZXIocmVxdWVzdCkgewogICAgdmFyIGFwaSA9IHJlcXVlc3Quc2VydmljZS5hcGk7CiAgICB2YXIgb3BlcmF0aW9uTW9kZWwgPSBhcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICB2YXIgaXNFbmRwb2ludE9wZXJhdGlvbiA9IGFwaS5lbmRwb2ludE9wZXJhdGlvbiAmJiAoYXBpLmVuZHBvaW50T3BlcmF0aW9uID09PSB1dGlsLnN0cmluZy5sb3dlckZpcnN0KG9wZXJhdGlvbk1vZGVsLm5hbWUpKTsKICAgIHJldHVybiAob3BlcmF0aW9uTW9kZWwuZW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCAhPT0gJ05VTEwnIHx8IGlzRW5kcG9pbnRPcGVyYXRpb24gPT09IHRydWUpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBleHBhbmRIb3N0UHJlZml4KGhvc3RQcmVmaXhOb3RhdGlvbiwgcGFyYW1zLCBzaGFwZSkgewogICAgdXRpbC5lYWNoKHNoYXBlLm1lbWJlcnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlcikgewogICAgICBpZiAobWVtYmVyLmhvc3RMYWJlbCA9PT0gdHJ1ZSkgewogICAgICAgIGlmICh0eXBlb2YgcGFyYW1zW25hbWVdICE9PSAnc3RyaW5nJyB8fCBwYXJhbXNbbmFtZV0gPT09ICcnKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICAgIG1lc3NhZ2U6ICdQYXJhbWV0ZXIgJyArIG5hbWUgKyAnIHNob3VsZCBiZSBhIG5vbi1lbXB0eSBzdHJpbmcuJywKICAgICAgICAgICAgY29kZTogJ0ludmFsaWRQYXJhbWV0ZXInCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cCgnXFx7JyArIG5hbWUgKyAnXFx9JywgJ2cnKTsKICAgICAgICBob3N0UHJlZml4Tm90YXRpb24gPSBob3N0UHJlZml4Tm90YXRpb24ucmVwbGFjZShyZWdleCwgcGFyYW1zW25hbWVdKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gaG9zdFByZWZpeE5vdGF0aW9uOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBwcmVwZW5kRW5kcG9pbnRQcmVmaXgoZW5kcG9pbnQsIHByZWZpeCkgewogICAgaWYgKGVuZHBvaW50Lmhvc3QpIHsKICAgICAgZW5kcG9pbnQuaG9zdCA9IHByZWZpeCArIGVuZHBvaW50Lmhvc3Q7CiAgICB9CiAgICBpZiAoZW5kcG9pbnQuaG9zdG5hbWUpIHsKICAgICAgZW5kcG9pbnQuaG9zdG5hbWUgPSBwcmVmaXggKyBlbmRwb2ludC5ob3N0bmFtZTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gdmFsaWRhdGVIb3N0bmFtZShob3N0bmFtZSkgewogICAgdmFyIGxhYmVscyA9IGhvc3RuYW1lLnNwbGl0KCcuJyk7CiAgICAvL1JlZmVyZW5jZTogaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzExMjMjc2VjdGlvbi0yCiAgICB2YXIgaG9zdFBhdHRlcm4gPSAvXlthLXpBLVowLTldezF9JHxeW2EtekEtWjAtOV1bYS16QS1aMC05XC1dKlthLXpBLVowLTldJC87CiAgICB1dGlsLmFycmF5RWFjaChsYWJlbHMsIGZ1bmN0aW9uKGxhYmVsKSB7CiAgICAgIGlmICghbGFiZWwubGVuZ3RoIHx8IGxhYmVsLmxlbmd0aCA8IDEgfHwgbGFiZWwubGVuZ3RoID4gNjMpIHsKICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICBjb2RlOiAnVmFsaWRhdGlvbkVycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdIb3N0bmFtZSBsYWJlbCBsZW5ndGggc2hvdWxkIGJlIGJldHdlZW4gMSB0byA2MyBjaGFyYWN0ZXJzLCBpbmNsdXNpdmUuJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICghaG9zdFBhdHRlcm4udGVzdChsYWJlbCkpIHsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgIHtjb2RlOiAnVmFsaWRhdGlvbkVycm9yJywgbWVzc2FnZTogbGFiZWwgKyAnIGlzIG5vdCBob3N0bmFtZSBjb21wYXRpYmxlLid9KTsKICAgICAgfQogICAgfSk7CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gewogICAgcG9wdWxhdGVIb3N0UHJlZml4OiBwb3B1bGF0ZUhvc3RQcmVmaXgKICB9OwogIAogIH0seyIuLi9jb3JlIjoxOCwiLi4vdXRpbCI6NzF9XSw0NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIEpzb25CdWlsZGVyID0gcmVxdWlyZSgnLi4vanNvbi9idWlsZGVyJyk7CiAgdmFyIEpzb25QYXJzZXIgPSByZXF1aXJlKCcuLi9qc29uL3BhcnNlcicpOwogIHZhciBwb3B1bGF0ZUhvc3RQcmVmaXggPSByZXF1aXJlKCcuL2hlbHBlcnMnKS5wb3B1bGF0ZUhvc3RQcmVmaXg7CiAgCiAgZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogICAgdmFyIGh0dHBSZXF1ZXN0ID0gcmVxLmh0dHBSZXF1ZXN0OwogICAgdmFyIGFwaSA9IHJlcS5zZXJ2aWNlLmFwaTsKICAgIHZhciB0YXJnZXQgPSBhcGkudGFyZ2V0UHJlZml4ICsgJy4nICsgYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0ubmFtZTsKICAgIHZhciB2ZXJzaW9uID0gYXBpLmpzb25WZXJzaW9uIHx8ICcxLjAnOwogICAgdmFyIGlucHV0ID0gYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQ7CiAgICB2YXIgYnVpbGRlciA9IG5ldyBKc29uQnVpbGRlcigpOwogIAogICAgaWYgKHZlcnNpb24gPT09IDEpIHZlcnNpb24gPSAnMS4wJzsKICAgIGh0dHBSZXF1ZXN0LmJvZHkgPSBidWlsZGVyLmJ1aWxkKHJlcS5wYXJhbXMgfHwge30sIGlucHV0KTsKICAgIGh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID0gJ2FwcGxpY2F0aW9uL3gtYW16LWpzb24tJyArIHZlcnNpb247CiAgICBodHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1UYXJnZXQnXSA9IHRhcmdldDsKICAKICAgIHBvcHVsYXRlSG9zdFByZWZpeChyZXEpOwogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RXJyb3IocmVzcCkgewogICAgdmFyIGVycm9yID0ge307CiAgICB2YXIgaHR0cFJlc3BvbnNlID0gcmVzcC5odHRwUmVzcG9uc2U7CiAgCiAgICBlcnJvci5jb2RlID0gaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16bi1lcnJvcnR5cGUnXSB8fCAnVW5rbm93bkVycm9yJzsKICAgIGlmICh0eXBlb2YgZXJyb3IuY29kZSA9PT0gJ3N0cmluZycpIHsKICAgICAgZXJyb3IuY29kZSA9IGVycm9yLmNvZGUuc3BsaXQoJzonKVswXTsKICAgIH0KICAKICAgIGlmIChodHRwUmVzcG9uc2UuYm9keS5sZW5ndGggPiAwKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIGUgPSBKU09OLnBhcnNlKGh0dHBSZXNwb25zZS5ib2R5LnRvU3RyaW5nKCkpOwogICAgICAgIGlmIChlLl9fdHlwZSB8fCBlLmNvZGUpIHsKICAgICAgICAgIGVycm9yLmNvZGUgPSAoZS5fX3R5cGUgfHwgZS5jb2RlKS5zcGxpdCgnIycpLnBvcCgpOwogICAgICAgIH0KICAgICAgICBpZiAoZXJyb3IuY29kZSA9PT0gJ1JlcXVlc3RFbnRpdHlUb29MYXJnZScpIHsKICAgICAgICAgIGVycm9yLm1lc3NhZ2UgPSAnUmVxdWVzdCBib2R5IG11c3QgYmUgbGVzcyB0aGFuIDEgTUInOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlcnJvci5tZXNzYWdlID0gKGUubWVzc2FnZSB8fCBlLk1lc3NhZ2UgfHwgbnVsbCk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgZXJyb3Iuc3RhdHVzQ29kZSA9IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICAgIGVycm9yLm1lc3NhZ2UgPSBodHRwUmVzcG9uc2Uuc3RhdHVzTWVzc2FnZTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZXJyb3Iuc3RhdHVzQ29kZSA9IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICBlcnJvci5tZXNzYWdlID0gaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUudG9TdHJpbmcoKTsKICAgIH0KICAKICAgIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCBlcnJvcik7CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICAgIHZhciBib2R5ID0gcmVzcC5odHRwUmVzcG9uc2UuYm9keS50b1N0cmluZygpIHx8ICd7fSc7CiAgICBpZiAocmVzcC5yZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNvbnZlcnRSZXNwb25zZVR5cGVzID09PSBmYWxzZSkgewogICAgICByZXNwLmRhdGEgPSBKU09OLnBhcnNlKGJvZHkpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIG9wZXJhdGlvbiA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3Jlc3AucmVxdWVzdC5vcGVyYXRpb25dOwogICAgICB2YXIgc2hhcGUgPSBvcGVyYXRpb24ub3V0cHV0IHx8IHt9OwogICAgICB2YXIgcGFyc2VyID0gbmV3IEpzb25QYXJzZXIoKTsKICAgICAgcmVzcC5kYXRhID0gcGFyc2VyLnBhcnNlKGJvZHksIHNoYXBlKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICAgIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogICAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhCiAgfTsKICAKICB9LHsiLi4vanNvbi9idWlsZGVyIjozNiwiLi4vanNvbi9wYXJzZXIiOjM3LCIuLi91dGlsIjo3MSwiLi9oZWxwZXJzIjo0NX1dLDQ3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBRdWVyeVBhcmFtU2VyaWFsaXplciA9IHJlcXVpcmUoJy4uL3F1ZXJ5L3F1ZXJ5X3BhcmFtX3NlcmlhbGl6ZXInKTsKICB2YXIgU2hhcGUgPSByZXF1aXJlKCcuLi9tb2RlbC9zaGFwZScpOwogIHZhciBwb3B1bGF0ZUhvc3RQcmVmaXggPSByZXF1aXJlKCcuL2hlbHBlcnMnKS5wb3B1bGF0ZUhvc3RQcmVmaXg7CiAgCiAgZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIGh0dHBSZXF1ZXN0ID0gcmVxLmh0dHBSZXF1ZXN0OwogICAgaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ10gPQogICAgICAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PXV0Zi04JzsKICAgIGh0dHBSZXF1ZXN0LnBhcmFtcyA9IHsKICAgICAgVmVyc2lvbjogcmVxLnNlcnZpY2UuYXBpLmFwaVZlcnNpb24sCiAgICAgIEFjdGlvbjogb3BlcmF0aW9uLm5hbWUKICAgIH07CiAgCiAgICAvLyBjb252ZXJ0IHRoZSByZXF1ZXN0IHBhcmFtZXRlcnMgaW50byBhIGxpc3Qgb2YgcXVlcnkgcGFyYW1zLAogICAgLy8gZS5nLiBEZWVwbHkuTmVzdGVkUGFyYW0uMC5OYW1lPXZhbHVlCiAgICB2YXIgYnVpbGRlciA9IG5ldyBRdWVyeVBhcmFtU2VyaWFsaXplcigpOwogICAgYnVpbGRlci5zZXJpYWxpemUocmVxLnBhcmFtcywgb3BlcmF0aW9uLmlucHV0LCBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICBodHRwUmVxdWVzdC5wYXJhbXNbbmFtZV0gPSB2YWx1ZTsKICAgIH0pOwogICAgaHR0cFJlcXVlc3QuYm9keSA9IHV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhodHRwUmVxdWVzdC5wYXJhbXMpOwogIAogICAgcG9wdWxhdGVIb3N0UHJlZml4KHJlcSk7CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3RFcnJvcihyZXNwKSB7CiAgICB2YXIgZGF0YSwgYm9keSA9IHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkudG9TdHJpbmcoKTsKICAgIGlmIChib2R5Lm1hdGNoKCc8VW5rbm93bk9wZXJhdGlvbkV4Y2VwdGlvbicpKSB7CiAgICAgIGRhdGEgPSB7CiAgICAgICAgQ29kZTogJ1Vua25vd25PcGVyYXRpb24nLAogICAgICAgIE1lc3NhZ2U6ICdVbmtub3duIG9wZXJhdGlvbiAnICsgcmVzcC5yZXF1ZXN0Lm9wZXJhdGlvbgogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgdHJ5IHsKICAgICAgICBkYXRhID0gbmV3IEFXUy5YTUwuUGFyc2VyKCkucGFyc2UoYm9keSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBkYXRhID0gewogICAgICAgICAgQ29kZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSwKICAgICAgICAgIE1lc3NhZ2U6IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c01lc3NhZ2UKICAgICAgICB9OwogICAgICB9CiAgICB9CiAgCiAgICBpZiAoZGF0YS5yZXF1ZXN0SWQgJiYgIXJlc3AucmVxdWVzdElkKSByZXNwLnJlcXVlc3RJZCA9IGRhdGEucmVxdWVzdElkOwogICAgaWYgKGRhdGEuRXJyb3JzKSBkYXRhID0gZGF0YS5FcnJvcnM7CiAgICBpZiAoZGF0YS5FcnJvcikgZGF0YSA9IGRhdGEuRXJyb3I7CiAgICBpZiAoZGF0YS5Db2RlKSB7CiAgICAgIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogZGF0YS5Db2RlLAogICAgICAgIG1lc3NhZ2U6IGRhdGEuTWVzc2FnZQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSwKICAgICAgICBtZXNzYWdlOiBudWxsCiAgICAgIH0pOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RGF0YShyZXNwKSB7CiAgICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIHNoYXBlID0gb3BlcmF0aW9uLm91dHB1dCB8fCB7fTsKICAgIHZhciBvcmlnUnVsZXMgPSBzaGFwZTsKICAKICAgIGlmIChvcmlnUnVsZXMucmVzdWx0V3JhcHBlcikgewogICAgICB2YXIgdG1wID0gU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RydWN0dXJlJ30pOwogICAgICB0bXAubWVtYmVyc1tvcmlnUnVsZXMucmVzdWx0V3JhcHBlcl0gPSBzaGFwZTsKICAgICAgdG1wLm1lbWJlck5hbWVzID0gW29yaWdSdWxlcy5yZXN1bHRXcmFwcGVyXTsKICAgICAgdXRpbC5wcm9wZXJ0eShzaGFwZSwgJ25hbWUnLCBzaGFwZS5yZXN1bHRXcmFwcGVyKTsKICAgICAgc2hhcGUgPSB0bXA7CiAgICB9CiAgCiAgICB2YXIgcGFyc2VyID0gbmV3IEFXUy5YTUwuUGFyc2VyKCk7CiAgCiAgICAvLyBUT0RPOiBSZWZhY3RvciBYTUwgUGFyc2VyIHRvIHBhcnNlIFJlcXVlc3RJZCBmcm9tIHJlc3BvbnNlLgogICAgaWYgKHNoYXBlICYmIHNoYXBlLm1lbWJlcnMgJiYgIXNoYXBlLm1lbWJlcnMuX1hBTVpSZXF1ZXN0SWQpIHsKICAgICAgdmFyIHJlcXVlc3RJZFNoYXBlID0gU2hhcGUuY3JlYXRlKAogICAgICAgIHsgdHlwZTogJ3N0cmluZycgfSwKICAgICAgICB7IGFwaTogeyBwcm90b2NvbDogJ3F1ZXJ5JyB9IH0sCiAgICAgICAgJ3JlcXVlc3RJZCcKICAgICAgKTsKICAgICAgc2hhcGUubWVtYmVycy5fWEFNWlJlcXVlc3RJZCA9IHJlcXVlc3RJZFNoYXBlOwogICAgfQogIAogICAgdmFyIGRhdGEgPSBwYXJzZXIucGFyc2UocmVzcC5odHRwUmVzcG9uc2UuYm9keS50b1N0cmluZygpLCBzaGFwZSk7CiAgICByZXNwLnJlcXVlc3RJZCA9IGRhdGEuX1hBTVpSZXF1ZXN0SWQgfHwgZGF0YS5yZXF1ZXN0SWQ7CiAgCiAgICBpZiAoZGF0YS5fWEFNWlJlcXVlc3RJZCkgZGVsZXRlIGRhdGEuX1hBTVpSZXF1ZXN0SWQ7CiAgCiAgICBpZiAob3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXIpIHsKICAgICAgaWYgKGRhdGFbb3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXJdKSB7CiAgICAgICAgdXRpbC51cGRhdGUoZGF0YSwgZGF0YVtvcmlnUnVsZXMucmVzdWx0V3JhcHBlcl0pOwogICAgICAgIGRlbGV0ZSBkYXRhW29yaWdSdWxlcy5yZXN1bHRXcmFwcGVyXTsKICAgICAgfQogICAgfQogIAogICAgcmVzcC5kYXRhID0gZGF0YTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICAgIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogICAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhCiAgfTsKICAKICB9LHsiLi4vY29yZSI6MTgsIi4uL21vZGVsL3NoYXBlIjo0MywiLi4vcXVlcnkvcXVlcnlfcGFyYW1fc2VyaWFsaXplciI6NTEsIi4uL3V0aWwiOjcxLCIuL2hlbHBlcnMiOjQ1fV0sNDg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBwb3B1bGF0ZUhvc3RQcmVmaXggPSByZXF1aXJlKCcuL2hlbHBlcnMnKS5wb3B1bGF0ZUhvc3RQcmVmaXg7CiAgCiAgZnVuY3Rpb24gcG9wdWxhdGVNZXRob2QocmVxKSB7CiAgICByZXEuaHR0cFJlcXVlc3QubWV0aG9kID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaHR0cE1ldGhvZDsKICB9CiAgCiAgZnVuY3Rpb24gZ2VuZXJhdGVVUkkoZW5kcG9pbnRQYXRoLCBvcGVyYXRpb25QYXRoLCBpbnB1dCwgcGFyYW1zKSB7CiAgICB2YXIgdXJpID0gW2VuZHBvaW50UGF0aCwgb3BlcmF0aW9uUGF0aF0uam9pbignLycpOwogICAgdXJpID0gdXJpLnJlcGxhY2UoL1wvKy9nLCAnLycpOwogIAogICAgdmFyIHF1ZXJ5U3RyaW5nID0ge30sIHF1ZXJ5U3RyaW5nU2V0ID0gZmFsc2U7CiAgICB1dGlsLmVhY2goaW5wdXQubWVtYmVycywgZnVuY3Rpb24gKG5hbWUsIG1lbWJlcikgewogICAgICB2YXIgcGFyYW1WYWx1ZSA9IHBhcmFtc1tuYW1lXTsKICAgICAgaWYgKHBhcmFtVmFsdWUgPT09IG51bGwgfHwgcGFyYW1WYWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICd1cmknKSB7CiAgICAgICAgdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cCgnXFx7JyArIG1lbWJlci5uYW1lICsgJyhcXCspP1xcfScpOwogICAgICAgIHVyaSA9IHVyaS5yZXBsYWNlKHJlZ2V4LCBmdW5jdGlvbihfLCBwbHVzKSB7CiAgICAgICAgICB2YXIgZm4gPSBwbHVzID8gdXRpbC51cmlFc2NhcGVQYXRoIDogdXRpbC51cmlFc2NhcGU7CiAgICAgICAgICByZXR1cm4gZm4oU3RyaW5nKHBhcmFtVmFsdWUpKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdxdWVyeXN0cmluZycpIHsKICAgICAgICBxdWVyeVN0cmluZ1NldCA9IHRydWU7CiAgCiAgICAgICAgaWYgKG1lbWJlci50eXBlID09PSAnbGlzdCcpIHsKICAgICAgICAgIHF1ZXJ5U3RyaW5nW21lbWJlci5uYW1lXSA9IHBhcmFtVmFsdWUubWFwKGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICByZXR1cm4gdXRpbC51cmlFc2NhcGUobWVtYmVyLm1lbWJlci50b1dpcmVGb3JtYXQodmFsKS50b1N0cmluZygpKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSBpZiAobWVtYmVyLnR5cGUgPT09ICdtYXAnKSB7CiAgICAgICAgICB1dGlsLmVhY2gocGFyYW1WYWx1ZSwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICBxdWVyeVN0cmluZ1trZXldID0gdmFsdWUubWFwKGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwudXJpRXNjYXBlKFN0cmluZyh2YWwpKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBxdWVyeVN0cmluZ1trZXldID0gdXRpbC51cmlFc2NhcGUoU3RyaW5nKHZhbHVlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBxdWVyeVN0cmluZ1ttZW1iZXIubmFtZV0gPSB1dGlsLnVyaUVzY2FwZShtZW1iZXIudG9XaXJlRm9ybWF0KHBhcmFtVmFsdWUpLnRvU3RyaW5nKCkpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgCiAgICBpZiAocXVlcnlTdHJpbmdTZXQpIHsKICAgICAgdXJpICs9ICh1cmkuaW5kZXhPZignPycpID49IDAgPyAnJicgOiAnPycpOwogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgdXRpbC5hcnJheUVhY2goT2JqZWN0LmtleXMocXVlcnlTdHJpbmcpLnNvcnQoKSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHF1ZXJ5U3RyaW5nW2tleV0pKSB7CiAgICAgICAgICBxdWVyeVN0cmluZ1trZXldID0gW3F1ZXJ5U3RyaW5nW2tleV1dOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXJ5U3RyaW5nW2tleV0ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHBhcnRzLnB1c2godXRpbC51cmlFc2NhcGUoU3RyaW5nKGtleSkpICsgJz0nICsgcXVlcnlTdHJpbmdba2V5XVtpXSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdXJpICs9IHBhcnRzLmpvaW4oJyYnKTsKICAgIH0KICAKICAgIHJldHVybiB1cmk7CiAgfQogIAogIGZ1bmN0aW9uIHBvcHVsYXRlVVJJKHJlcSkgewogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIGlucHV0ID0gb3BlcmF0aW9uLmlucHV0OwogIAogICAgdmFyIHVyaSA9IGdlbmVyYXRlVVJJKHJlcS5odHRwUmVxdWVzdC5lbmRwb2ludC5wYXRoLCBvcGVyYXRpb24uaHR0cFBhdGgsIGlucHV0LCByZXEucGFyYW1zKTsKICAgIHJlcS5odHRwUmVxdWVzdC5wYXRoID0gdXJpOwogIH0KICAKICBmdW5jdGlvbiBwb3B1bGF0ZUhlYWRlcnMocmVxKSB7CiAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICB1dGlsLmVhY2gob3BlcmF0aW9uLmlucHV0Lm1lbWJlcnMsIGZ1bmN0aW9uIChuYW1lLCBtZW1iZXIpIHsKICAgICAgdmFyIHZhbHVlID0gcmVxLnBhcmFtc1tuYW1lXTsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAKICAgICAgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ2hlYWRlcnMnICYmIG1lbWJlci50eXBlID09PSAnbWFwJykgewogICAgICAgIHV0aWwuZWFjaCh2YWx1ZSwgZnVuY3Rpb24oa2V5LCBtZW1iZXJWYWx1ZSkgewogICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbbWVtYmVyLm5hbWUgKyBrZXldID0gbWVtYmVyVmFsdWU7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAnaGVhZGVyJykgewogICAgICAgIHZhbHVlID0gbWVtYmVyLnRvV2lyZUZvcm1hdCh2YWx1ZSkudG9TdHJpbmcoKTsKICAgICAgICBpZiAobWVtYmVyLmlzSnNvblZhbHVlKSB7CiAgICAgICAgICB2YWx1ZSA9IHV0aWwuYmFzZTY0LmVuY29kZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzW21lbWJlci5uYW1lXSA9IHZhbHVlOwogICAgICB9CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogICAgcG9wdWxhdGVNZXRob2QocmVxKTsKICAgIHBvcHVsYXRlVVJJKHJlcSk7CiAgICBwb3B1bGF0ZUhlYWRlcnMocmVxKTsKICAgIHBvcHVsYXRlSG9zdFByZWZpeChyZXEpOwogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RXJyb3IoKSB7CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICB2YXIgZGF0YSA9IHt9OwogICAgdmFyIHIgPSByZXNwLmh0dHBSZXNwb25zZTsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBvdXRwdXQgPSBvcGVyYXRpb24ub3V0cHV0OwogIAogICAgLy8gbm9ybWFsaXplIGhlYWRlcnMgbmFtZXMgdG8gbG93ZXItY2FzZWQga2V5cyBmb3IgbWF0Y2hpbmcKICAgIHZhciBoZWFkZXJzID0ge307CiAgICB1dGlsLmVhY2goci5oZWFkZXJzLCBmdW5jdGlvbiAoaywgdikgewogICAgICBoZWFkZXJzW2sudG9Mb3dlckNhc2UoKV0gPSB2OwogICAgfSk7CiAgCiAgICB1dGlsLmVhY2gob3V0cHV0Lm1lbWJlcnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlcikgewogICAgICB2YXIgaGVhZGVyID0gKG1lbWJlci5uYW1lIHx8IG5hbWUpLnRvTG93ZXJDYXNlKCk7CiAgICAgIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdoZWFkZXJzJyAmJiBtZW1iZXIudHlwZSA9PT0gJ21hcCcpIHsKICAgICAgICBkYXRhW25hbWVdID0ge307CiAgICAgICAgdmFyIGxvY2F0aW9uID0gbWVtYmVyLmlzTG9jYXRpb25OYW1lID8gbWVtYmVyLm5hbWUgOiAnJzsKICAgICAgICB2YXIgcGF0dGVybiA9IG5ldyBSZWdFeHAoJ14nICsgbG9jYXRpb24gKyAnKC4rKScsICdpJyk7CiAgICAgICAgdXRpbC5lYWNoKHIuaGVhZGVycywgZnVuY3Rpb24gKGssIHYpIHsKICAgICAgICAgIHZhciByZXN1bHQgPSBrLm1hdGNoKHBhdHRlcm4pOwogICAgICAgICAgaWYgKHJlc3VsdCAhPT0gbnVsbCkgewogICAgICAgICAgICBkYXRhW25hbWVdW3Jlc3VsdFsxXV0gPSB2OwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ2hlYWRlcicpIHsKICAgICAgICBpZiAoaGVhZGVyc1toZWFkZXJdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IG1lbWJlci5pc0pzb25WYWx1ZSA/CiAgICAgICAgICAgIHV0aWwuYmFzZTY0LmRlY29kZShoZWFkZXJzW2hlYWRlcl0pIDoKICAgICAgICAgICAgaGVhZGVyc1toZWFkZXJdOwogICAgICAgICAgZGF0YVtuYW1lXSA9IG1lbWJlci50b1R5cGUodmFsdWUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdzdGF0dXNDb2RlJykgewogICAgICAgIGRhdGFbbmFtZV0gPSBwYXJzZUludChyLnN0YXR1c0NvZGUsIDEwKTsKICAgICAgfQogICAgfSk7CiAgCiAgICByZXNwLmRhdGEgPSBkYXRhOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIGJ1aWxkUmVxdWVzdDogYnVpbGRSZXF1ZXN0LAogICAgZXh0cmFjdEVycm9yOiBleHRyYWN0RXJyb3IsCiAgICBleHRyYWN0RGF0YTogZXh0cmFjdERhdGEsCiAgICBnZW5lcmF0ZVVSSTogZ2VuZXJhdGVVUkkKICB9OwogIAogIH0seyIuLi91dGlsIjo3MSwiLi9oZWxwZXJzIjo0NX1dLDQ5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgUmVzdCA9IHJlcXVpcmUoJy4vcmVzdCcpOwogIHZhciBKc29uID0gcmVxdWlyZSgnLi9qc29uJyk7CiAgdmFyIEpzb25CdWlsZGVyID0gcmVxdWlyZSgnLi4vanNvbi9idWlsZGVyJyk7CiAgdmFyIEpzb25QYXJzZXIgPSByZXF1aXJlKCcuLi9qc29uL3BhcnNlcicpOwogIAogIGZ1bmN0aW9uIHBvcHVsYXRlQm9keShyZXEpIHsKICAgIHZhciBidWlsZGVyID0gbmV3IEpzb25CdWlsZGVyKCk7CiAgICB2YXIgaW5wdXQgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dDsKICAKICAgIGlmIChpbnB1dC5wYXlsb2FkKSB7CiAgICAgIHZhciBwYXJhbXMgPSB7fTsKICAgICAgdmFyIHBheWxvYWRTaGFwZSA9IGlucHV0Lm1lbWJlcnNbaW5wdXQucGF5bG9hZF07CiAgICAgIHBhcmFtcyA9IHJlcS5wYXJhbXNbaW5wdXQucGF5bG9hZF07CiAgICAgIGlmIChwYXJhbXMgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogIAogICAgICBpZiAocGF5bG9hZFNoYXBlLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmJvZHkgPSBidWlsZGVyLmJ1aWxkKHBhcmFtcywgcGF5bG9hZFNoYXBlKTsKICAgICAgICBhcHBseUNvbnRlbnRUeXBlSGVhZGVyKHJlcSk7CiAgICAgIH0gZWxzZSB7IC8vIG5vbi1KU09OIHBheWxvYWQKICAgICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IHBhcmFtczsKICAgICAgICBpZiAocGF5bG9hZFNoYXBlLnR5cGUgPT09ICdiaW5hcnknIHx8IHBheWxvYWRTaGFwZS5pc1N0cmVhbWluZykgewogICAgICAgICAgYXBwbHlDb250ZW50VHlwZUhlYWRlcihyZXEsIHRydWUpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGJvZHkgPSBidWlsZGVyLmJ1aWxkKHJlcS5wYXJhbXMsIGlucHV0KTsKICAgICAgaWYgKGJvZHkgIT09ICd7fScgfHwgcmVxLmh0dHBSZXF1ZXN0Lm1ldGhvZCAhPT0gJ0dFVCcpIHsgLy9kb24ndCBzZW5kIGVtcHR5IGJvZHkgZm9yIEdFVCBtZXRob2QKICAgICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IGJvZHk7CiAgICAgIH0KICAgICAgYXBwbHlDb250ZW50VHlwZUhlYWRlcihyZXEpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBhcHBseUNvbnRlbnRUeXBlSGVhZGVyKHJlcSwgaXNCaW5hcnkpIHsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBpbnB1dCA9IG9wZXJhdGlvbi5pbnB1dDsKICAKICAgIGlmICghcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddKSB7CiAgICAgIHZhciB0eXBlID0gaXNCaW5hcnkgPyAnYmluYXJ5L29jdGV0LXN0cmVhbScgOiAnYXBwbGljYXRpb24vanNvbic7CiAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXSA9IHR5cGU7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGJ1aWxkUmVxdWVzdChyZXEpIHsKICAgIFJlc3QuYnVpbGRSZXF1ZXN0KHJlcSk7CiAgCiAgICAvLyBuZXZlciBzZW5kIGJvZHkgcGF5bG9hZCBvbiBIRUFEL0RFTEVURQogICAgaWYgKFsnSEVBRCcsICdERUxFVEUnXS5pbmRleE9mKHJlcS5odHRwUmVxdWVzdC5tZXRob2QpIDwgMCkgewogICAgICBwb3B1bGF0ZUJvZHkocmVxKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gZXh0cmFjdEVycm9yKHJlc3ApIHsKICAgIEpzb24uZXh0cmFjdEVycm9yKHJlc3ApOwogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RGF0YShyZXNwKSB7CiAgICBSZXN0LmV4dHJhY3REYXRhKHJlc3ApOwogIAogICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBydWxlcyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLm91dHB1dCB8fCB7fTsKICAgIHZhciBwYXJzZXI7CiAgICB2YXIgaGFzRXZlbnRPdXRwdXQgPSBvcGVyYXRpb24uaGFzRXZlbnRPdXRwdXQ7CiAgCiAgICBpZiAocnVsZXMucGF5bG9hZCkgewogICAgICB2YXIgcGF5bG9hZE1lbWJlciA9IHJ1bGVzLm1lbWJlcnNbcnVsZXMucGF5bG9hZF07CiAgICAgIHZhciBib2R5ID0gcmVzcC5odHRwUmVzcG9uc2UuYm9keTsKICAgICAgaWYgKHBheWxvYWRNZW1iZXIuaXNFdmVudFN0cmVhbSkgewogICAgICAgIHBhcnNlciA9IG5ldyBKc29uUGFyc2VyKCk7CiAgICAgICAgcmVzcC5kYXRhW3BheWxvYWRdID0gdXRpbC5jcmVhdGVFdmVudFN0cmVhbSgKICAgICAgICAgIEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyID8gcmVzcC5odHRwUmVzcG9uc2Uuc3RyZWFtIDogYm9keSwKICAgICAgICAgIHBhcnNlciwKICAgICAgICAgIHBheWxvYWRNZW1iZXIKICAgICAgICApOwogICAgICB9IGVsc2UgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ3N0cnVjdHVyZScgfHwgcGF5bG9hZE1lbWJlci50eXBlID09PSAnbGlzdCcpIHsKICAgICAgICB2YXIgcGFyc2VyID0gbmV3IEpzb25QYXJzZXIoKTsKICAgICAgICByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0gPSBwYXJzZXIucGFyc2UoYm9keSwgcGF5bG9hZE1lbWJlcik7CiAgICAgIH0gZWxzZSBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnYmluYXJ5JyB8fCBwYXlsb2FkTWVtYmVyLmlzU3RyZWFtaW5nKSB7CiAgICAgICAgcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdID0gYm9keTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0gPSBwYXlsb2FkTWVtYmVyLnRvVHlwZShib2R5KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGRhdGEgPSByZXNwLmRhdGE7CiAgICAgIEpzb24uZXh0cmFjdERhdGEocmVzcCk7CiAgICAgIHJlc3AuZGF0YSA9IHV0aWwubWVyZ2UoZGF0YSwgcmVzcC5kYXRhKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICAgIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogICAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhCiAgfTsKICAKICB9LHsiLi4vanNvbi9idWlsZGVyIjozNiwiLi4vanNvbi9wYXJzZXIiOjM3LCIuLi91dGlsIjo3MSwiLi9qc29uIjo0NiwiLi9yZXN0Ijo0OH1dLDUwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBSZXN0ID0gcmVxdWlyZSgnLi9yZXN0Jyk7CiAgCiAgZnVuY3Rpb24gcG9wdWxhdGVCb2R5KHJlcSkgewogICAgdmFyIGlucHV0ID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQ7CiAgICB2YXIgYnVpbGRlciA9IG5ldyBBV1MuWE1MLkJ1aWxkZXIoKTsKICAgIHZhciBwYXJhbXMgPSByZXEucGFyYW1zOwogIAogICAgdmFyIHBheWxvYWQgPSBpbnB1dC5wYXlsb2FkOwogICAgaWYgKHBheWxvYWQpIHsKICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBpbnB1dC5tZW1iZXJzW3BheWxvYWRdOwogICAgICBwYXJhbXMgPSBwYXJhbXNbcGF5bG9hZF07CiAgICAgIGlmIChwYXJhbXMgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogIAogICAgICBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnc3RydWN0dXJlJykgewogICAgICAgIHZhciByb290RWxlbWVudCA9IHBheWxvYWRNZW1iZXIubmFtZTsKICAgICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IGJ1aWxkZXIudG9YTUwocGFyYW1zLCBwYXlsb2FkTWVtYmVyLCByb290RWxlbWVudCwgdHJ1ZSk7CiAgICAgIH0gZWxzZSB7IC8vIG5vbi14bWwgcGF5bG9hZAogICAgICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gcGFyYW1zOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IGJ1aWxkZXIudG9YTUwocGFyYW1zLCBpbnB1dCwgaW5wdXQubmFtZSB8fAogICAgICAgIGlucHV0LnNoYXBlIHx8IHV0aWwuc3RyaW5nLnVwcGVyRmlyc3QocmVxLm9wZXJhdGlvbikgKyAnUmVxdWVzdCcpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBidWlsZFJlcXVlc3QocmVxKSB7CiAgICBSZXN0LmJ1aWxkUmVxdWVzdChyZXEpOwogIAogICAgLy8gbmV2ZXIgc2VuZCBib2R5IHBheWxvYWQgb24gR0VUL0hFQUQKICAgIGlmIChbJ0dFVCcsICdIRUFEJ10uaW5kZXhPZihyZXEuaHR0cFJlcXVlc3QubWV0aG9kKSA8IDApIHsKICAgICAgcG9wdWxhdGVCb2R5KHJlcSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3RFcnJvcihyZXNwKSB7CiAgICBSZXN0LmV4dHJhY3RFcnJvcihyZXNwKTsKICAKICAgIHZhciBkYXRhOwogICAgdHJ5IHsKICAgICAgZGF0YSA9IG5ldyBBV1MuWE1MLlBhcnNlcigpLnBhcnNlKHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkudG9TdHJpbmcoKSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGRhdGEgPSB7CiAgICAgICAgQ29kZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSwKICAgICAgICBNZXNzYWdlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNNZXNzYWdlCiAgICAgIH07CiAgICB9CiAgCiAgICBpZiAoZGF0YS5FcnJvcnMpIGRhdGEgPSBkYXRhLkVycm9yczsKICAgIGlmIChkYXRhLkVycm9yKSBkYXRhID0gZGF0YS5FcnJvcjsKICAgIGlmIChkYXRhLkNvZGUpIHsKICAgICAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiBkYXRhLkNvZGUsCiAgICAgICAgbWVzc2FnZTogZGF0YS5NZXNzYWdlCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlLAogICAgICAgIG1lc3NhZ2U6IG51bGwKICAgICAgfSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICAgIFJlc3QuZXh0cmFjdERhdGEocmVzcCk7CiAgCiAgICB2YXIgcGFyc2VyOwogICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgIHZhciBib2R5ID0gcmVzcC5odHRwUmVzcG9uc2UuYm9keTsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBvdXRwdXQgPSBvcGVyYXRpb24ub3V0cHV0OwogIAogICAgdmFyIGhhc0V2ZW50T3V0cHV0ID0gb3BlcmF0aW9uLmhhc0V2ZW50T3V0cHV0OwogIAogICAgdmFyIHBheWxvYWQgPSBvdXRwdXQucGF5bG9hZDsKICAgIGlmIChwYXlsb2FkKSB7CiAgICAgIHZhciBwYXlsb2FkTWVtYmVyID0gb3V0cHV0Lm1lbWJlcnNbcGF5bG9hZF07CiAgICAgIGlmIChwYXlsb2FkTWVtYmVyLmlzRXZlbnRTdHJlYW0pIHsKICAgICAgICBwYXJzZXIgPSBuZXcgQVdTLlhNTC5QYXJzZXIoKTsKICAgICAgICByZXNwLmRhdGFbcGF5bG9hZF0gPSB1dGlsLmNyZWF0ZUV2ZW50U3RyZWFtKAogICAgICAgICAgQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIgPyByZXNwLmh0dHBSZXNwb25zZS5zdHJlYW0gOiByZXNwLmh0dHBSZXNwb25zZS5ib2R5LAogICAgICAgICAgcGFyc2VyLAogICAgICAgICAgcGF5bG9hZE1lbWJlcgogICAgICAgICk7CiAgICAgIH0gZWxzZSBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnc3RydWN0dXJlJykgewogICAgICAgIHBhcnNlciA9IG5ldyBBV1MuWE1MLlBhcnNlcigpOwogICAgICAgIHJlc3AuZGF0YVtwYXlsb2FkXSA9IHBhcnNlci5wYXJzZShib2R5LnRvU3RyaW5nKCksIHBheWxvYWRNZW1iZXIpOwogICAgICB9IGVsc2UgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ2JpbmFyeScgfHwgcGF5bG9hZE1lbWJlci5pc1N0cmVhbWluZykgewogICAgICAgIHJlc3AuZGF0YVtwYXlsb2FkXSA9IGJvZHk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzcC5kYXRhW3BheWxvYWRdID0gcGF5bG9hZE1lbWJlci50b1R5cGUoYm9keSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoYm9keS5sZW5ndGggPiAwKSB7CiAgICAgIHBhcnNlciA9IG5ldyBBV1MuWE1MLlBhcnNlcigpOwogICAgICB2YXIgZGF0YSA9IHBhcnNlci5wYXJzZShib2R5LnRvU3RyaW5nKCksIG91dHB1dCk7CiAgICAgIHV0aWwudXBkYXRlKHJlc3AuZGF0YSwgZGF0YSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgYnVpbGRSZXF1ZXN0OiBidWlsZFJlcXVlc3QsCiAgICBleHRyYWN0RXJyb3I6IGV4dHJhY3RFcnJvciwKICAgIGV4dHJhY3REYXRhOiBleHRyYWN0RGF0YQogIH07CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuLi91dGlsIjo3MSwiLi9yZXN0Ijo0OH1dLDUxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICAKICBmdW5jdGlvbiBRdWVyeVBhcmFtU2VyaWFsaXplcigpIHsKICB9CiAgCiAgUXVlcnlQYXJhbVNlcmlhbGl6ZXIucHJvdG90eXBlLnNlcmlhbGl6ZSA9IGZ1bmN0aW9uKHBhcmFtcywgc2hhcGUsIGZuKSB7CiAgICBzZXJpYWxpemVTdHJ1Y3R1cmUoJycsIHBhcmFtcywgc2hhcGUsIGZuKTsKICB9OwogIAogIGZ1bmN0aW9uIHVjZmlyc3Qoc2hhcGUpIHsKICAgIGlmIChzaGFwZS5pc1F1ZXJ5TmFtZSB8fCBzaGFwZS5hcGkucHJvdG9jb2wgIT09ICdlYzInKSB7CiAgICAgIHJldHVybiBzaGFwZS5uYW1lOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHNoYXBlLm5hbWVbMF0udG9VcHBlckNhc2UoKSArIHNoYXBlLm5hbWUuc3Vic3RyKDEpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVTdHJ1Y3R1cmUocHJlZml4LCBzdHJ1Y3QsIHJ1bGVzLCBmbikgewogICAgdXRpbC5lYWNoKHJ1bGVzLm1lbWJlcnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlcikgewogICAgICB2YXIgdmFsdWUgPSBzdHJ1Y3RbbmFtZV07CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgCiAgICAgIHZhciBtZW1iZXJOYW1lID0gdWNmaXJzdChtZW1iZXIpOwogICAgICBtZW1iZXJOYW1lID0gcHJlZml4ID8gcHJlZml4ICsgJy4nICsgbWVtYmVyTmFtZSA6IG1lbWJlck5hbWU7CiAgICAgIHNlcmlhbGl6ZU1lbWJlcihtZW1iZXJOYW1lLCB2YWx1ZSwgbWVtYmVyLCBmbik7CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplTWFwKG5hbWUsIG1hcCwgcnVsZXMsIGZuKSB7CiAgICB2YXIgaSA9IDE7CiAgICB1dGlsLmVhY2gobWFwLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICB2YXIgcHJlZml4ID0gcnVsZXMuZmxhdHRlbmVkID8gJy4nIDogJy5lbnRyeS4nOwogICAgICB2YXIgcG9zaXRpb24gPSBwcmVmaXggKyAoaSsrKSArICcuJzsKICAgICAgdmFyIGtleU5hbWUgPSBwb3NpdGlvbiArIChydWxlcy5rZXkubmFtZSB8fCAna2V5Jyk7CiAgICAgIHZhciB2YWx1ZU5hbWUgPSBwb3NpdGlvbiArIChydWxlcy52YWx1ZS5uYW1lIHx8ICd2YWx1ZScpOwogICAgICBzZXJpYWxpemVNZW1iZXIobmFtZSArIGtleU5hbWUsIGtleSwgcnVsZXMua2V5LCBmbik7CiAgICAgIHNlcmlhbGl6ZU1lbWJlcihuYW1lICsgdmFsdWVOYW1lLCB2YWx1ZSwgcnVsZXMudmFsdWUsIGZuKTsKICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVMaXN0KG5hbWUsIGxpc3QsIHJ1bGVzLCBmbikgewogICAgdmFyIG1lbWJlclJ1bGVzID0gcnVsZXMubWVtYmVyIHx8IHt9OwogIAogICAgaWYgKGxpc3QubGVuZ3RoID09PSAwKSB7CiAgICAgIGZuLmNhbGwodGhpcywgbmFtZSwgbnVsbCk7CiAgICAgIHJldHVybjsKICAgIH0KICAKICAgIHV0aWwuYXJyYXlFYWNoKGxpc3QsIGZ1bmN0aW9uICh2LCBuKSB7CiAgICAgIHZhciBzdWZmaXggPSAnLicgKyAobiArIDEpOwogICAgICBpZiAocnVsZXMuYXBpLnByb3RvY29sID09PSAnZWMyJykgewogICAgICAgIC8vIERvIG5vdGhpbmcgZm9yIEVDMgogICAgICAgIHN1ZmZpeCA9IHN1ZmZpeCArICcnOyAvLyBtYWtlIGxpbnRlciBoYXBweQogICAgICB9IGVsc2UgaWYgKHJ1bGVzLmZsYXR0ZW5lZCkgewogICAgICAgIGlmIChtZW1iZXJSdWxlcy5uYW1lKSB7CiAgICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCcuJyk7CiAgICAgICAgICBwYXJ0cy5wb3AoKTsKICAgICAgICAgIHBhcnRzLnB1c2godWNmaXJzdChtZW1iZXJSdWxlcykpOwogICAgICAgICAgbmFtZSA9IHBhcnRzLmpvaW4oJy4nKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3VmZml4ID0gJy4nICsgKG1lbWJlclJ1bGVzLm5hbWUgPyBtZW1iZXJSdWxlcy5uYW1lIDogJ21lbWJlcicpICsgc3VmZml4OwogICAgICB9CiAgICAgIHNlcmlhbGl6ZU1lbWJlcihuYW1lICsgc3VmZml4LCB2LCBtZW1iZXJSdWxlcywgZm4pOwogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZU1lbWJlcihuYW1lLCB2YWx1ZSwgcnVsZXMsIGZuKSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgaWYgKHJ1bGVzLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgIHNlcmlhbGl6ZVN0cnVjdHVyZShuYW1lLCB2YWx1ZSwgcnVsZXMsIGZuKTsKICAgIH0gZWxzZSBpZiAocnVsZXMudHlwZSA9PT0gJ2xpc3QnKSB7CiAgICAgIHNlcmlhbGl6ZUxpc3QobmFtZSwgdmFsdWUsIHJ1bGVzLCBmbik7CiAgICB9IGVsc2UgaWYgKHJ1bGVzLnR5cGUgPT09ICdtYXAnKSB7CiAgICAgIHNlcmlhbGl6ZU1hcChuYW1lLCB2YWx1ZSwgcnVsZXMsIGZuKTsKICAgIH0gZWxzZSB7CiAgICAgIGZuKG5hbWUsIHJ1bGVzLnRvV2lyZUZvcm1hdCh2YWx1ZSkudG9TdHJpbmcoKSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gUXVlcnlQYXJhbVNlcmlhbGl6ZXI7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxfV0sNTI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzID0gewogICAgLy9wcm92aWRlIHJlYWx0aW1lIGNsb2NrIGZvciBwZXJmb3JtYW5jZSBtZWFzdXJlbWVudAogICAgbm93OiBmdW5jdGlvbiBub3coKSB7CiAgICAgIGlmICh0eXBlb2YgcGVyZm9ybWFuY2UgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBwZXJmb3JtYW5jZS5ub3cgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm4gcGVyZm9ybWFuY2Uubm93KCk7CiAgICAgIH0KICAgICAgcmV0dXJuIERhdGUubm93KCk7CiAgICB9CiAgfTsKICAKICB9LHt9XSw1MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuL3V0aWwnKTsKICB2YXIgcmVnaW9uQ29uZmlnID0gcmVxdWlyZSgnLi9yZWdpb25fY29uZmlnX2RhdGEuanNvbicpOwogIAogIGZ1bmN0aW9uIGdlbmVyYXRlUmVnaW9uUHJlZml4KHJlZ2lvbikgewogICAgaWYgKCFyZWdpb24pIHJldHVybiBudWxsOwogIAogICAgdmFyIHBhcnRzID0gcmVnaW9uLnNwbGl0KCctJyk7CiAgICBpZiAocGFydHMubGVuZ3RoIDwgMykgcmV0dXJuIG51bGw7CiAgICByZXR1cm4gcGFydHMuc2xpY2UoMCwgcGFydHMubGVuZ3RoIC0gMikuam9pbignLScpICsgJy0qJzsKICB9CiAgCiAgZnVuY3Rpb24gZGVyaXZlZEtleXMoc2VydmljZSkgewogICAgdmFyIHJlZ2lvbiA9IHNlcnZpY2UuY29uZmlnLnJlZ2lvbjsKICAgIHZhciByZWdpb25QcmVmaXggPSBnZW5lcmF0ZVJlZ2lvblByZWZpeChyZWdpb24pOwogICAgdmFyIGVuZHBvaW50UHJlZml4ID0gc2VydmljZS5hcGkuZW5kcG9pbnRQcmVmaXg7CiAgCiAgICByZXR1cm4gWwogICAgICBbcmVnaW9uLCBlbmRwb2ludFByZWZpeF0sCiAgICAgIFtyZWdpb25QcmVmaXgsIGVuZHBvaW50UHJlZml4XSwKICAgICAgW3JlZ2lvbiwgJyonXSwKICAgICAgW3JlZ2lvblByZWZpeCwgJyonXSwKICAgICAgWycqJywgZW5kcG9pbnRQcmVmaXhdLAogICAgICBbJyonLCAnKiddCiAgICBdLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgIHJldHVybiBpdGVtWzBdICYmIGl0ZW1bMV0gPyBpdGVtLmpvaW4oJy8nKSA6IG51bGw7CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gYXBwbHlDb25maWcoc2VydmljZSwgY29uZmlnKSB7CiAgICB1dGlsLmVhY2goY29uZmlnLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIGlmIChrZXkgPT09ICdnbG9iYWxFbmRwb2ludCcpIHJldHVybjsKICAgICAgaWYgKHNlcnZpY2UuY29uZmlnW2tleV0gPT09IHVuZGVmaW5lZCB8fCBzZXJ2aWNlLmNvbmZpZ1trZXldID09PSBudWxsKSB7CiAgICAgICAgc2VydmljZS5jb25maWdba2V5XSA9IHZhbHVlOwogICAgICB9CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gY29uZmlndXJlRW5kcG9pbnQoc2VydmljZSkgewogICAgdmFyIGtleXMgPSBkZXJpdmVkS2V5cyhzZXJ2aWNlKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgaWYgKCFrZXkpIGNvbnRpbnVlOwogIAogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHJlZ2lvbkNvbmZpZy5ydWxlcywga2V5KSkgewogICAgICAgIHZhciBjb25maWcgPSByZWdpb25Db25maWcucnVsZXNba2V5XTsKICAgICAgICBpZiAodHlwZW9mIGNvbmZpZyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGNvbmZpZyA9IHJlZ2lvbkNvbmZpZy5wYXR0ZXJuc1tjb25maWddOwogICAgICAgIH0KICAKICAgICAgICAvLyBzZXQgZHVhbHN0YWNrIGVuZHBvaW50CiAgICAgICAgaWYgKHNlcnZpY2UuY29uZmlnLnVzZUR1YWxzdGFjayAmJiB1dGlsLmlzRHVhbHN0YWNrQXZhaWxhYmxlKHNlcnZpY2UpKSB7CiAgICAgICAgICBjb25maWcgPSB1dGlsLmNvcHkoY29uZmlnKTsKICAgICAgICAgIGNvbmZpZy5lbmRwb2ludCA9ICd7c2VydmljZX0uZHVhbHN0YWNrLntyZWdpb259LmFtYXpvbmF3cy5jb20nOwogICAgICAgIH0KICAKICAgICAgICAvLyBzZXQgZ2xvYmFsIGVuZHBvaW50CiAgICAgICAgc2VydmljZS5pc0dsb2JhbEVuZHBvaW50ID0gISFjb25maWcuZ2xvYmFsRW5kcG9pbnQ7CiAgCiAgICAgICAgLy8gc2lnbmF0dXJlIHZlcnNpb24KICAgICAgICBpZiAoIWNvbmZpZy5zaWduYXR1cmVWZXJzaW9uKSBjb25maWcuc2lnbmF0dXJlVmVyc2lvbiA9ICd2NCc7CiAgCiAgICAgICAgLy8gbWVyZ2UgY29uZmlnCiAgICAgICAgYXBwbHlDb25maWcoc2VydmljZSwgY29uZmlnKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBjb25maWd1cmVFbmRwb2ludDsKICAKICB9LHsiLi9yZWdpb25fY29uZmlnX2RhdGEuanNvbiI6NTQsIi4vdXRpbCI6NzF9XSw1NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHM9ewogICAgInJ1bGVzIjogewogICAgICAiKi8qIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgICAgfSwKICAgICAgImNuLSovKiI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LmFtYXpvbmF3cy5jb20uY24iCiAgICAgIH0sCiAgICAgICIqL2J1ZGdldHMiOiAiZ2xvYmFsU1NMIiwKICAgICAgIiovY2xvdWRmcm9udCI6ICJnbG9iYWxTU0wiLAogICAgICAiKi9pYW0iOiAiZ2xvYmFsU1NMIiwKICAgICAgIiovc3RzIjogImdsb2JhbFNTTCIsCiAgICAgICIqL2ltcG9ydGV4cG9ydCI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInYyIiwKICAgICAgICAiZ2xvYmFsRW5kcG9pbnQiOiB0cnVlCiAgICAgIH0sCiAgICAgICIqL3JvdXRlNTMiOiB7CiAgICAgICAgImVuZHBvaW50IjogImh0dHBzOi8ve3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInYzaHR0cHMiLAogICAgICAgICJnbG9iYWxFbmRwb2ludCI6IHRydWUKICAgICAgfSwKICAgICAgIiovd2FmIjogImdsb2JhbFNTTCIsCiAgICAgICJ1cy1nb3YtKi9pYW0iOiAiZ2xvYmFsR292Q2xvdWQiLAogICAgICAidXMtZ292LSovc3RzIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgICAgfSwKICAgICAgInVzLWdvdi13ZXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAidXMtd2VzdC0xL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICAgInVzLXdlc3QtMi9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAgICJldS13ZXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAiYXAtc291dGhlYXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAiYXAtc291dGhlYXN0LTIvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAiYXAtbm9ydGhlYXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAic2EtZWFzdC0xL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICAgInVzLWVhc3QtMS9zMyI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInMzIgogICAgICB9LAogICAgICAidXMtZWFzdC0xL3NkYiI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInYyIgogICAgICB9LAogICAgICAiKi9zZGIiOiB7CiAgICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hbWF6b25hd3MuY29tIiwKICAgICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJ2MiIKICAgICAgfQogICAgfSwKICAKICAgICJwYXR0ZXJucyI6IHsKICAgICAgImdsb2JhbFNTTCI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAiaHR0cHM6Ly97c2VydmljZX0uYW1hem9uYXdzLmNvbSIsCiAgICAgICAgImdsb2JhbEVuZHBvaW50IjogdHJ1ZQogICAgICB9LAogICAgICAiZ2xvYmFsR292Q2xvdWQiOiB7CiAgICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS51cy1nb3YuYW1hem9uYXdzLmNvbSIKICAgICAgfSwKICAgICAgInMzc2lnbmF0dXJlIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIsCiAgICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAiczMiCiAgICAgIH0KICAgIH0KICB9CiAgCiAgfSx7fV0sNTU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAocHJvY2Vzcyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHZhciBBY2NlcHRvclN0YXRlTWFjaGluZSA9IHJlcXVpcmUoJy4vc3RhdGVfbWFjaGluZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICB2YXIgZG9tYWluID0gQVdTLnV0aWwuZG9tYWluOwogIHZhciBqbWVzcGF0aCA9IHJlcXVpcmUoJ2ptZXNwYXRoJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIGhhcmRFcnJvclN0YXRlcyA9IHtzdWNjZXNzOiAxLCBlcnJvcjogMSwgY29tcGxldGU6IDF9OwogIAogIGZ1bmN0aW9uIGlzVGVybWluYWxTdGF0ZShtYWNoaW5lKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGhhcmRFcnJvclN0YXRlcywgbWFjaGluZS5fYXNtLmN1cnJlbnRTdGF0ZSk7CiAgfQogIAogIHZhciBmc20gPSBuZXcgQWNjZXB0b3JTdGF0ZU1hY2hpbmUoKTsKICBmc20uc2V0dXBTdGF0ZXMgPSBmdW5jdGlvbigpIHsKICAgIHZhciB0cmFuc2l0aW9uID0gZnVuY3Rpb24oXywgZG9uZSkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHNlbGYuX2hhbHRIYW5kbGVyc09uRXJyb3IgPSBmYWxzZTsKICAKICAgICAgc2VsZi5lbWl0KHNlbGYuX2FzbS5jdXJyZW50U3RhdGUsIGZ1bmN0aW9uKGVycikgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIGlmIChpc1Rlcm1pbmFsU3RhdGUoc2VsZikpIHsKICAgICAgICAgICAgaWYgKGRvbWFpbiAmJiBzZWxmLmRvbWFpbiBpbnN0YW5jZW9mIGRvbWFpbi5Eb21haW4pIHsKICAgICAgICAgICAgICBlcnIuZG9tYWluRW1pdHRlciA9IHNlbGY7CiAgICAgICAgICAgICAgZXJyLmRvbWFpbiA9IHNlbGYuZG9tYWluOwogICAgICAgICAgICAgIGVyci5kb21haW5UaHJvd24gPSBmYWxzZTsKICAgICAgICAgICAgICBzZWxmLmRvbWFpbi5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxmLnJlc3BvbnNlLmVycm9yID0gZXJyOwogICAgICAgICAgICBkb25lKGVycik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRvbmUoc2VsZi5yZXNwb25zZS5lcnJvcik7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgIH07CiAgCiAgICB0aGlzLmFkZFN0YXRlKCd2YWxpZGF0ZScsICdidWlsZCcsICdlcnJvcicsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnYnVpbGQnLCAnYWZ0ZXJCdWlsZCcsICdyZXN0YXJ0JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdhZnRlckJ1aWxkJywgJ3NpZ24nLCAncmVzdGFydCcsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnc2lnbicsICdzZW5kJywgJ3JldHJ5JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdyZXRyeScsICdhZnRlclJldHJ5JywgJ2FmdGVyUmV0cnknLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ2FmdGVyUmV0cnknLCAnc2lnbicsICdlcnJvcicsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnc2VuZCcsICd2YWxpZGF0ZVJlc3BvbnNlJywgJ3JldHJ5JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCd2YWxpZGF0ZVJlc3BvbnNlJywgJ2V4dHJhY3REYXRhJywgJ2V4dHJhY3RFcnJvcicsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnZXh0cmFjdEVycm9yJywgJ2V4dHJhY3REYXRhJywgJ3JldHJ5JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdleHRyYWN0RGF0YScsICdzdWNjZXNzJywgJ3JldHJ5JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdyZXN0YXJ0JywgJ2J1aWxkJywgJ2Vycm9yJywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdzdWNjZXNzJywgJ2NvbXBsZXRlJywgJ2NvbXBsZXRlJywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdlcnJvcicsICdjb21wbGV0ZScsICdjb21wbGV0ZScsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnY29tcGxldGUnLCBudWxsLCBudWxsLCB0cmFuc2l0aW9uKTsKICB9OwogIGZzbS5zZXR1cFN0YXRlcygpOwogIAogIC8qKgogICAqICMjIEFzeW5jaHJvbm91cyBSZXF1ZXN0cwogICAqCiAgICogQWxsIHJlcXVlc3RzIG1hZGUgdGhyb3VnaCB0aGUgU0RLIGFyZSBhc3luY2hyb25vdXMgYW5kIHVzZSBhCiAgICogY2FsbGJhY2sgaW50ZXJmYWNlLiBFYWNoIHNlcnZpY2UgbWV0aG9kIHRoYXQga2lja3Mgb2ZmIGEgcmVxdWVzdAogICAqIHJldHVybnMgYW4gYEFXUy5SZXF1ZXN0YCBvYmplY3QgdGhhdCB5b3UgY2FuIHVzZSB0byByZWdpc3RlcgogICAqIGNhbGxiYWNrcy4KICAgKgogICAqIEZvciBleGFtcGxlLCB0aGUgZm9sbG93aW5nIHNlcnZpY2UgbWV0aG9kIHJldHVybnMgdGhlIHJlcXVlc3QKICAgKiBvYmplY3QgYXMgInJlcXVlc3QiLCB3aGljaCBjYW4gYmUgdXNlZCB0byByZWdpc3RlciBjYWxsYmFja3M6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogLy8gcmVxdWVzdCBpcyBhbiBBV1MuUmVxdWVzdCBvYmplY3QKICAgKiB2YXIgcmVxdWVzdCA9IGVjMi5kZXNjcmliZUluc3RhbmNlcygpOwogICAqCiAgICogLy8gcmVnaXN0ZXIgY2FsbGJhY2tzIG9uIHJlcXVlc3QgdG8gcmV0cmlldmUgcmVzcG9uc2UgZGF0YQogICAqIHJlcXVlc3Qub24oJ3N1Y2Nlc3MnLCBmdW5jdGlvbihyZXNwb25zZSkgewogICAqICAgY29uc29sZS5sb2cocmVzcG9uc2UuZGF0YSk7CiAgICogfSk7CiAgICogYGBgCiAgICoKICAgKiBXaGVuIGEgcmVxdWVzdCBpcyByZWFkeSB0byBiZSBzZW50LCB0aGUge3NlbmR9IG1ldGhvZCBzaG91bGQKICAgKiBiZSBjYWxsZWQ6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogcmVxdWVzdC5zZW5kKCk7CiAgICogYGBgCiAgICoKICAgKiBTaW5jZSByZWdpc3RlcmVkIGNhbGxiYWNrcyBtYXkgb3IgbWF5IG5vdCBiZSBpZGVtcG90ZW50LCByZXF1ZXN0cyBzaG91bGQgb25seQogICAqIGJlIHNlbnQgb25jZS4gVG8gcGVyZm9ybSB0aGUgc2FtZSBvcGVyYXRpb24gbXVsdGlwbGUgdGltZXMsIHlvdSB3aWxsIG5lZWQgdG8KICAgKiBjcmVhdGUgbXVsdGlwbGUgcmVxdWVzdCBvYmplY3RzLCBlYWNoIHdpdGggaXRzIG93biByZWdpc3RlcmVkIGNhbGxiYWNrcy4KICAgKgogICAqICMjIFJlbW92aW5nIERlZmF1bHQgTGlzdGVuZXJzIGZvciBFdmVudHMKICAgKgogICAqIFJlcXVlc3Qgb2JqZWN0cyBhcmUgYnVpbHQgd2l0aCBkZWZhdWx0IGxpc3RlbmVycyBmb3IgdGhlIHZhcmlvdXMgZXZlbnRzLAogICAqIGRlcGVuZGluZyBvbiB0aGUgc2VydmljZSB0eXBlLiBJbiBzb21lIGNhc2VzLCB5b3UgbWF5IHdhbnQgdG8gcmVtb3ZlCiAgICogc29tZSBidWlsdC1pbiBsaXN0ZW5lcnMgdG8gY3VzdG9taXplIGJlaGF2aW91ci4gRG9pbmcgdGhpcyByZXF1aXJlcwogICAqIGFjY2VzcyB0byB0aGUgYnVpbHQtaW4gbGlzdGVuZXIgZnVuY3Rpb25zLCB3aGljaCBhcmUgZXhwb3NlZCB0aHJvdWdoCiAgICogdGhlIHtBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZX0gbmFtZXNwYWNlLiBGb3IgaW5zdGFuY2UsIHlvdSBtYXkKICAgKiB3YW50IHRvIGN1c3RvbWl6ZSB0aGUgSFRUUCBoYW5kbGVyIHVzZWQgd2hlbiBzZW5kaW5nIGEgcmVxdWVzdC4gSW4gdGhpcwogICAqIGNhc2UsIHlvdSBjYW4gcmVtb3ZlIHRoZSBidWlsdC1pbiBsaXN0ZW5lciBhc3NvY2lhdGVkIHdpdGggdGhlICdzZW5kJwogICAqIGV2ZW50LCB0aGUge0FXUy5FdmVudExpc3RlbmVycy5Db3JlLlNFTkR9IGxpc3RlbmVyIGFuZCBhZGQgeW91ciBvd24uCiAgICoKICAgKiAjIyBNdWx0aXBsZSBDYWxsYmFja3MgYW5kIENoYWluaW5nCiAgICoKICAgKiBZb3UgY2FuIHJlZ2lzdGVyIG11bHRpcGxlIGNhbGxiYWNrcyBvbiBhbnkgcmVxdWVzdCBvYmplY3QuIFRoZQogICAqIGNhbGxiYWNrcyBjYW4gYmUgcmVnaXN0ZXJlZCBmb3IgZGlmZmVyZW50IGV2ZW50cywgb3IgYWxsIGZvciB0aGUKICAgKiBzYW1lIGV2ZW50LiBJbiBhZGRpdGlvbiwgeW91IGNhbiBjaGFpbiBjYWxsYmFjayByZWdpc3RyYXRpb24sIGZvcgogICAqIGV4YW1wbGU6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogcmVxdWVzdC4KICAgKiAgIG9uKCdzdWNjZXNzJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgKiAgICAgY29uc29sZS5sb2coIlN1Y2Nlc3MhIik7CiAgICogICB9KS4KICAgKiAgIG9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycm9yLCByZXNwb25zZSkgewogICAqICAgICBjb25zb2xlLmxvZygiRXJyb3IhIik7CiAgICogICB9KS4KICAgKiAgIG9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICogICAgIGNvbnNvbGUubG9nKCJBbHdheXMhIik7CiAgICogICB9KS4KICAgKiAgIHNlbmQoKTsKICAgKiBgYGAKICAgKgogICAqIFRoZSBhYm92ZSBleGFtcGxlIHdpbGwgcHJpbnQgZWl0aGVyICJTdWNjZXNzISBBbHdheXMhIiwgb3IgIkVycm9yISBBbHdheXMhIiwKICAgKiBkZXBlbmRpbmcgb24gd2hldGhlciB0aGUgcmVxdWVzdCBzdWNjZWVkZWQgb3Igbm90LgogICAqCiAgICogQCFhdHRyaWJ1dGUgaHR0cFJlcXVlc3QKICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBIVFRQIFByb3BlcnRpZXMKICAgKiAgIEByZXR1cm4gW0FXUy5IdHRwUmVxdWVzdF0gdGhlIHJhdyBIVFRQIHJlcXVlc3Qgb2JqZWN0CiAgICogICAgIGNvbnRhaW5pbmcgcmVxdWVzdCBoZWFkZXJzIGFuZCBib2R5IGluZm9ybWF0aW9uCiAgICogICAgIHNlbnQgYnkgdGhlIHNlcnZpY2UuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzdGFydFRpbWUKICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBPcGVyYXRpb24gUHJvcGVydGllcwogICAqICAgQHJldHVybiBbRGF0ZV0gdGhlIHRpbWUgdGhhdCB0aGUgcmVxdWVzdCBzdGFydGVkCiAgICoKICAgKiBAIWdyb3VwIFJlcXVlc3QgQnVpbGRpbmcgRXZlbnRzCiAgICoKICAgKiBAIWV2ZW50IHZhbGlkYXRlKHJlcXVlc3QpCiAgICogICBUcmlnZ2VyZWQgd2hlbiBhIHJlcXVlc3QgaXMgYmVpbmcgdmFsaWRhdGVkLiBMaXN0ZW5lcnMKICAgKiAgIHNob3VsZCB0aHJvdyBhbiBlcnJvciBpZiB0aGUgcmVxdWVzdCBzaG91bGQgbm90IGJlIHNlbnQuCiAgICogICBAcGFyYW0gcmVxdWVzdCBbUmVxdWVzdF0gdGhlIHJlcXVlc3Qgb2JqZWN0IGJlaW5nIHNlbnQKICAgKiAgIEBzZWUgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfQ1JFREVOVElBTFMKICAgKiAgIEBzZWUgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUkVHSU9OCiAgICogICBAZXhhbXBsZSBFbnN1cmluZyB0aGF0IGEgY2VydGFpbiBwYXJhbWV0ZXIgaXMgc2V0IGJlZm9yZSBzZW5kaW5nIGEgcmVxdWVzdAogICAqICAgICB2YXIgcmVxID0gczMucHV0T2JqZWN0KHBhcmFtcyk7CiAgICogICAgIHJlcS5vbigndmFsaWRhdGUnLCBmdW5jdGlvbigpIHsKICAgKiAgICAgICBpZiAoIXJlcS5wYXJhbXMuQm9keS5tYXRjaCgvXkhlbGxvXHMvKSkgewogICAqICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCb2R5IG11c3Qgc3RhcnQgd2l0aCAiSGVsbG8gIicpOwogICAqICAgICAgIH0KICAgKiAgICAgfSk7CiAgICogICAgIHJlcS5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgeyAuLi4gfSk7CiAgICoKICAgKiBAIWV2ZW50IGJ1aWxkKHJlcXVlc3QpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgcmVxdWVzdCBwYXlsb2FkIGlzIGJlaW5nIGJ1aWx0LiBMaXN0ZW5lcnMKICAgKiAgIHNob3VsZCBmaWxsIHRoZSBuZWNlc3NhcnkgaW5mb3JtYXRpb24gdG8gc2VuZCB0aGUgcmVxdWVzdAogICAqICAgb3ZlciBIVFRQLgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+dmFsaWRhdGUpCiAgICogICBAZXhhbXBsZSBBZGQgYSBjdXN0b20gSFRUUCBoZWFkZXIgdG8gYSByZXF1ZXN0CiAgICogICAgIHZhciByZXEgPSBzMy5wdXRPYmplY3QocGFyYW1zKTsKICAgKiAgICAgcmVxLm9uKCdidWlsZCcsIGZ1bmN0aW9uKCkgewogICAqICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDdXN0b20tSGVhZGVyJ10gPSAndmFsdWUnOwogICAqICAgICB9KTsKICAgKiAgICAgcmVxLnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7IC4uLiB9KTsKICAgKgogICAqIEAhZXZlbnQgc2lnbihyZXF1ZXN0KQogICAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIHJlcXVlc3QgaXMgYmVpbmcgc2lnbmVkLiBMaXN0ZW5lcnMgc2hvdWxkCiAgICogICBhZGQgdGhlIGNvcnJlY3QgYXV0aGVudGljYXRpb24gaGVhZGVycyBhbmQvb3IgYWRqdXN0IHRoZSBib2R5LAogICAqICAgZGVwZW5kaW5nIG9uIHRoZSBhdXRoZW50aWNhdGlvbiBtZWNoYW5pc20gYmVpbmcgdXNlZC4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnZhbGlkYXRlKQogICAqCiAgICogQCFncm91cCBSZXF1ZXN0IFNlbmRpbmcgRXZlbnRzCiAgICoKICAgKiBAIWV2ZW50IHNlbmQocmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgcmVxdWVzdCBpcyByZWFkeSB0byBiZSBzZW50LiBMaXN0ZW5lcnMKICAgKiAgIHNob3VsZCBjYWxsIHRoZSB1bmRlcmx5aW5nIHRyYW5zcG9ydCBsYXllciB0byBpbml0aWF0ZQogICAqICAgdGhlIHNlbmRpbmcgb2YgdGhlIHJlcXVlc3QuCiAgICogICBAcGFyYW0gcmVzcG9uc2UgW1Jlc3BvbnNlXSB0aGUgcmVzcG9uc2Ugb2JqZWN0CiAgICogICBAY29udGV4dCBbUmVxdWVzdF0gdGhlIHJlcXVlc3Qgb2JqZWN0IHRoYXQgd2FzIHNlbnQKICAgKiAgIEBzZWUgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuU0VORAogICAqCiAgICogQCFldmVudCByZXRyeShyZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIGEgcmVxdWVzdCBmYWlsZWQgYW5kIG1pZ2h0IG5lZWQgdG8gYmUgcmV0cmllZCBvciByZWRpcmVjdGVkLgogICAqICAgSWYgdGhlIHJlc3BvbnNlIGlzIHJldHJ5YWJsZSwgdGhlIGxpc3RlbmVyIHNob3VsZCBzZXQgdGhlCiAgICogICBgcmVzcG9uc2UuZXJyb3IucmV0cnlhYmxlYCBwcm9wZXJ0eSB0byBgdHJ1ZWAsIGFuZCBvcHRpb25hbGx5IHNldAogICAqICAgYHJlc3BvbnNlLmVycm9yLnJldHJ5RGVsYXlgIHRvIHRoZSBtaWxsaXNlY29uZCBkZWxheSBmb3IgdGhlIG5leHQgYXR0ZW1wdC4KICAgKiAgIEluIHRoZSBjYXNlIG9mIGEgcmVkaXJlY3QsIGByZXNwb25zZS5lcnJvci5yZWRpcmVjdGAgc2hvdWxkIGJlIHNldCB0bwogICAqICAgYHRydWVgIHdpdGggYHJldHJ5RGVsYXlgIHNldCB0byBhbiBvcHRpb25hbCBkZWxheSBvbiB0aGUgbmV4dCByZXF1ZXN0LgogICAqCiAgICogICBJZiBhIGxpc3RlbmVyIGRlY2lkZXMgdGhhdCBhIHJlcXVlc3Qgc2hvdWxkIG5vdCBiZSByZXRyaWVkLAogICAqICAgaXQgc2hvdWxkIHNldCBib3RoIGByZXRyeWFibGVgIGFuZCBgcmVkaXJlY3RgIHRvIGZhbHNlLgogICAqCiAgICogICBOb3RlIHRoYXQgYSByZXRyeWFibGUgZXJyb3Igd2lsbCBiZSByZXRyaWVkIGF0IG1vc3QKICAgKiAgIHtBV1MuQ29uZmlnLm1heFJldHJpZXN9IHRpbWVzIChiYXNlZCBvbiB0aGUgc2VydmljZSBvYmplY3QncyBjb25maWcpLgogICAqICAgU2ltaWxhcmx5LCBhIHJlcXVlc3QgdGhhdCBpcyByZWRpcmVjdGVkIHdpbGwgb25seSByZWRpcmVjdCBhdCBtb3N0CiAgICogICB7QVdTLkNvbmZpZy5tYXhSZWRpcmVjdHN9IHRpbWVzLgogICAqCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGV4YW1wbGUgQWRkaW5nIGEgY3VzdG9tIHJldHJ5IGZvciBhIDQwNCByZXNwb25zZQogICAqICAgICByZXF1ZXN0Lm9uKCdyZXRyeScsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICogICAgICAgLy8gdGhpcyByZXNvdXJjZSBpcyBub3QgeWV0IGF2YWlsYWJsZSwgd2FpdCAxMCBzZWNvbmRzIHRvIGdldCBpdCBhZ2FpbgogICAqICAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gNDA0ICYmIHJlc3BvbnNlLmVycm9yKSB7CiAgICogICAgICAgICByZXNwb25zZS5lcnJvci5yZXRyeWFibGUgPSB0cnVlOyAgIC8vIHJldHJ5IHRoaXMgZXJyb3IKICAgKiAgICAgICAgIHJlc3BvbnNlLmVycm9yLnJldHJ5RGVsYXkgPSAxMDAwMDsgLy8gd2FpdCAxMCBzZWNvbmRzCiAgICogICAgICAgfQogICAqICAgICB9KTsKICAgKgogICAqIEAhZ3JvdXAgRGF0YSBQYXJzaW5nIEV2ZW50cwogICAqCiAgICogQCFldmVudCBleHRyYWN0RXJyb3IocmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgb24gYWxsIG5vbi0yeHggcmVxdWVzdHMgc28gdGhhdCBsaXN0ZW5lcnMgY2FuIGV4dHJhY3QKICAgKiAgIGVycm9yIGRldGFpbHMgZnJvbSB0aGUgcmVzcG9uc2UgYm9keS4gTGlzdGVuZXJzIHRvIHRoaXMgZXZlbnQKICAgKiAgIHNob3VsZCBzZXQgdGhlIGByZXNwb25zZS5lcnJvcmAgcHJvcGVydHkuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQCFldmVudCBleHRyYWN0RGF0YShyZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCBpbiBzdWNjZXNzZnVsIHJlcXVlc3RzIHRvIGFsbG93IGxpc3RlbmVycyB0bwogICAqICAgZGUtc2VyaWFsaXplIHRoZSByZXNwb25zZSBib2R5IGludG8gYHJlc3BvbnNlLmRhdGFgLgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEAhZ3JvdXAgQ29tcGxldGlvbiBFdmVudHMKICAgKgogICAqIEAhZXZlbnQgc3VjY2VzcyhyZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSByZXF1ZXN0IGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkuCiAgICogICBgcmVzcG9uc2UuZGF0YWAgd2lsbCBjb250YWluIHRoZSByZXNwb25zZSBkYXRhIGFuZAogICAqICAgYHJlc3BvbnNlLmVycm9yYCB3aWxsIGJlIG51bGwuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQCFldmVudCBlcnJvcihlcnJvciwgcmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiBhbiBlcnJvciBvY2N1cnMgYXQgYW55IHBvaW50IGR1cmluZyB0aGUKICAgKiAgIHJlcXVlc3QuIGByZXNwb25zZS5lcnJvcmAgd2lsbCBjb250YWluIGRldGFpbHMgYWJvdXQgdGhlIGVycm9yCiAgICogICB0aGF0IG9jY3VycmVkLiBgcmVzcG9uc2UuZGF0YWAgd2lsbCBiZSBudWxsLgogICAqICAgQHBhcmFtIGVycm9yIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCBjb250YWluaW5nIGRldGFpbHMgYWJvdXQKICAgKiAgICAgdGhlIGVycm9yIHRoYXQgb2NjdXJyZWQuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQCFldmVudCBjb21wbGV0ZShyZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuZXZlciBhIHJlcXVlc3QgY3ljbGUgY29tcGxldGVzLiBgcmVzcG9uc2UuZXJyb3JgCiAgICogICBzaG91bGQgYmUgY2hlY2tlZCwgc2luY2UgdGhlIHJlcXVlc3QgbWF5IGhhdmUgZmFpbGVkLgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEAhZ3JvdXAgSFRUUCBFdmVudHMKICAgKgogICAqIEAhZXZlbnQgaHR0cEhlYWRlcnMoc3RhdHVzQ29kZSwgaGVhZGVycywgcmVzcG9uc2UsIHN0YXR1c01lc3NhZ2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiBoZWFkZXJzIGFyZSBzZW50IGJ5IHRoZSByZW1vdGUgc2VydmVyCiAgICogICBAcGFyYW0gc3RhdHVzQ29kZSBbSW50ZWdlcl0gdGhlIEhUVFAgcmVzcG9uc2UgY29kZQogICAqICAgQHBhcmFtIGhlYWRlcnMgW21hcDxTdHJpbmcsU3RyaW5nPl0gdGhlIHJlc3BvbnNlIGhlYWRlcnMKICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAcGFyYW0gc3RhdHVzTWVzc2FnZSBbU3RyaW5nXSBBIHN0YXR1cyBtZXNzYWdlIGNvcnJlc3BvbmRpbmcgdG8gdGhlIEhUVFAKICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlIGNvZGUKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEAhZXZlbnQgaHR0cERhdGEoY2h1bmssIHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gZGF0YSBpcyBzZW50IGJ5IHRoZSByZW1vdGUgc2VydmVyCiAgICogICBAcGFyYW0gY2h1bmsgW0J1ZmZlcl0gdGhlIGJ1ZmZlciBkYXRhIGNvbnRhaW5pbmcgdGhlIG5leHQgZGF0YSBjaHVuawogICAqICAgICBmcm9tIHRoZSBzZXJ2ZXIKICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAc2VlIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLkhUVFBfREFUQQogICAqCiAgICogQCFldmVudCBodHRwVXBsb2FkUHJvZ3Jlc3MocHJvZ3Jlc3MsIHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIEhUVFAgcmVxdWVzdCBoYXMgdXBsb2FkZWQgbW9yZSBkYXRhCiAgICogICBAcGFyYW0gcHJvZ3Jlc3MgW21hcF0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGBsb2FkZWRgIGFuZCBgdG90YWxgIGJ5dGVzCiAgICogICAgIG9mIHRoZSByZXF1ZXN0LgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBub3RlIFRoaXMgZXZlbnQgd2lsbCBub3QgYmUgZW1pdHRlZCBpbiBOb2RlLmpzIDAuOC54LgogICAqCiAgICogQCFldmVudCBodHRwRG93bmxvYWRQcm9ncmVzcyhwcm9ncmVzcywgcmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgSFRUUCByZXF1ZXN0IGhhcyBkb3dubG9hZGVkIG1vcmUgZGF0YQogICAqICAgQHBhcmFtIHByb2dyZXNzIFttYXBdIEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBgbG9hZGVkYCBhbmQgYHRvdGFsYCBieXRlcwogICAqICAgICBvZiB0aGUgcmVxdWVzdC4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAbm90ZSBUaGlzIGV2ZW50IHdpbGwgbm90IGJlIGVtaXR0ZWQgaW4gTm9kZS5qcyAwLjgueC4KICAgKgogICAqIEAhZXZlbnQgaHR0cEVycm9yKGVycm9yLCByZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSBIVFRQIHJlcXVlc3QgZmFpbGVkCiAgICogICBAcGFyYW0gZXJyb3IgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHRoYXQgd2FzIHRocm93bgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEAhZXZlbnQgaHR0cERvbmUocmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgc2VydmVyIGlzIGZpbmlzaGVkIHNlbmRpbmcgZGF0YQogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEBzZWUgQVdTLlJlc3BvbnNlCiAgICovCiAgQVdTLlJlcXVlc3QgPSBpbmhlcml0KHsKICAKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHJlcXVlc3QgZm9yIGFuIG9wZXJhdGlvbiBvbiBhIGdpdmVuIHNlcnZpY2Ugd2l0aAogICAgICogYSBzZXQgb2YgaW5wdXQgcGFyYW1ldGVycy4KICAgICAqCiAgICAgKiBAcGFyYW0gc2VydmljZSBbQVdTLlNlcnZpY2VdIHRoZSBzZXJ2aWNlIHRvIHBlcmZvcm0gdGhlIG9wZXJhdGlvbiBvbgogICAgICogQHBhcmFtIG9wZXJhdGlvbiBbU3RyaW5nXSB0aGUgb3BlcmF0aW9uIHRvIHBlcmZvcm0gb24gdGhlIHNlcnZpY2UKICAgICAqIEBwYXJhbSBwYXJhbXMgW09iamVjdF0gcGFyYW1ldGVycyB0byBzZW5kIHRvIHRoZSBvcGVyYXRpb24uCiAgICAgKiAgIFNlZSB0aGUgb3BlcmF0aW9uJ3MgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIGZvcm1hdCBvZiB0aGUKICAgICAqICAgcGFyYW1ldGVycy4KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFJlcXVlc3Qoc2VydmljZSwgb3BlcmF0aW9uLCBwYXJhbXMpIHsKICAgICAgdmFyIGVuZHBvaW50ID0gc2VydmljZS5lbmRwb2ludDsKICAgICAgdmFyIHJlZ2lvbiA9IHNlcnZpY2UuY29uZmlnLnJlZ2lvbjsKICAgICAgdmFyIGN1c3RvbVVzZXJBZ2VudCA9IHNlcnZpY2UuY29uZmlnLmN1c3RvbVVzZXJBZ2VudDsKICAKICAgICAgLy8gZ2xvYmFsIGVuZHBvaW50cyBzaWduIGFzIHVzLWVhc3QtMQogICAgICBpZiAoc2VydmljZS5pc0dsb2JhbEVuZHBvaW50KSByZWdpb24gPSAndXMtZWFzdC0xJzsKICAKICAgICAgdGhpcy5kb21haW4gPSBkb21haW4gJiYgZG9tYWluLmFjdGl2ZTsKICAgICAgdGhpcy5zZXJ2aWNlID0gc2VydmljZTsKICAgICAgdGhpcy5vcGVyYXRpb24gPSBvcGVyYXRpb247CiAgICAgIHRoaXMucGFyYW1zID0gcGFyYW1zIHx8IHt9OwogICAgICB0aGlzLmh0dHBSZXF1ZXN0ID0gbmV3IEFXUy5IdHRwUmVxdWVzdChlbmRwb2ludCwgcmVnaW9uKTsKICAgICAgdGhpcy5odHRwUmVxdWVzdC5hcHBlbmRUb1VzZXJBZ2VudChjdXN0b21Vc2VyQWdlbnQpOwogICAgICB0aGlzLnN0YXJ0VGltZSA9IHNlcnZpY2UuZ2V0U2tld0NvcnJlY3RlZERhdGUoKTsKICAKICAgICAgdGhpcy5yZXNwb25zZSA9IG5ldyBBV1MuUmVzcG9uc2UodGhpcyk7CiAgICAgIHRoaXMuX2FzbSA9IG5ldyBBY2NlcHRvclN0YXRlTWFjaGluZShmc20uc3RhdGVzLCAndmFsaWRhdGUnKTsKICAgICAgdGhpcy5faGFsdEhhbmRsZXJzT25FcnJvciA9IGZhbHNlOwogIAogICAgICBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuZW1pdCA9IHRoaXMuZW1pdEV2ZW50OwogICAgfSwKICAKICAgIC8qKgogICAgICogQCFncm91cCBTZW5kaW5nIGEgUmVxdWVzdAogICAgICovCiAgCiAgICAvKioKICAgICAqIEBvdmVybG9hZCBzZW5kKGNhbGxiYWNrID0gbnVsbCkKICAgICAqICAgU2VuZHMgdGhlIHJlcXVlc3Qgb2JqZWN0LgogICAgICoKICAgICAqICAgQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgICAqICAgICBJZiBhIGNhbGxiYWNrIGlzIHN1cHBsaWVkLCBpdCBpcyBjYWxsZWQgd2hlbiBhIHJlc3BvbnNlIGlzIHJldHVybmVkCiAgICAgKiAgICAgZnJvbSB0aGUgc2VydmljZS4KICAgICAqICAgICBAY29udGV4dCBbQVdTLlJlcXVlc3RdIHRoZSByZXF1ZXN0IG9iamVjdCBiZWluZyBzZW50LgogICAgICogICAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICAgKiAgICAgICBTZXQgdG8gYG51bGxgIGlmIHRoZSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwuCiAgICAgKiAgICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgZGF0YSByZXR1cm5lZCBmcm9tCiAgICAgKiAgICAgICB0aGUgcmVxdWVzdC4gU2V0IHRvIGBudWxsYCBpZiBhIHJlcXVlc3QgZXJyb3Igb2NjdXJzLgogICAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRoIGEgY2FsbGJhY2sKICAgICAqICAgICByZXF1ZXN0ID0gczMucHV0T2JqZWN0KHtCdWNrZXQ6ICdidWNrZXQnLCBLZXk6ICdrZXknfSk7CiAgICAgKiAgICAgcmVxdWVzdC5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgeyBjb25zb2xlLmxvZyhlcnIsIGRhdGEpOyB9KTsKICAgICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3Qgd2l0aCBubyBjYWxsYmFjayAodXNpbmcgZXZlbnQgaGFuZGxlcnMpCiAgICAgKiAgICAgcmVxdWVzdCA9IHMzLnB1dE9iamVjdCh7QnVja2V0OiAnYnVja2V0JywgS2V5OiAna2V5J30pOwogICAgICogICAgIHJlcXVlc3Qub24oJ2NvbXBsZXRlJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsgLi4uIH0pOyAvLyByZWdpc3RlciBhIGNhbGxiYWNrCiAgICAgKiAgICAgcmVxdWVzdC5zZW5kKCk7CiAgICAgKi8KICAgIHNlbmQ6IGZ1bmN0aW9uIHNlbmQoY2FsbGJhY2spIHsKICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgLy8gYXBwZW5kIHRvIHVzZXIgYWdlbnQKICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0LmFwcGVuZFRvVXNlckFnZW50KCdjYWxsYmFjaycpOwogICAgICAgIHRoaXMub24oJ2NvbXBsZXRlJywgZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICAgIGNhbGxiYWNrLmNhbGwocmVzcCwgcmVzcC5lcnJvciwgcmVzcC5kYXRhKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICB0aGlzLnJ1blRvKCk7CiAgCiAgICAgIHJldHVybiB0aGlzLnJlc3BvbnNlOwogICAgfSwKICAKICAgIC8qKgogICAgICogQCFtZXRob2QgIHByb21pc2UoKQogICAgICogICBTZW5kcyB0aGUgcmVxdWVzdCBhbmQgcmV0dXJucyBhICd0aGVuYWJsZScgcHJvbWlzZS4KICAgICAqCiAgICAgKiAgIFR3byBjYWxsYmFja3MgY2FuIGJlIHByb3ZpZGVkIHRvIHRoZSBgdGhlbmAgbWV0aG9kIG9uIHRoZSByZXR1cm5lZCBwcm9taXNlLgogICAgICogICBUaGUgZmlyc3QgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLCBhbmQgdGhlIHNlY29uZAogICAgICogICBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAqICAgQGNhbGxiYWNrIGZ1bGZpbGxlZENhbGxiYWNrIGZ1bmN0aW9uKGRhdGEpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZC4KICAgICAqICAgICBAcGFyYW0gZGF0YSBbT2JqZWN0XSB0aGUgZGUtc2VyaWFsaXplZCBkYXRhIHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICAgKiAgIEBjYWxsYmFjayByZWplY3RlZENhbGxiYWNrIGZ1bmN0aW9uKGVycm9yKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAqICAgICBAcGFyYW0gZXJyb3IgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICAgKiAgIEByZXR1cm4gW1Byb21pc2VdIEEgcHJvbWlzZSB0aGF0IHJlcHJlc2VudHMgdGhlIHN0YXRlIG9mIHRoZSByZXF1ZXN0LgogICAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB1c2luZyBwcm9taXNlcy4KICAgICAqICAgICB2YXIgcmVxdWVzdCA9IHMzLnB1dE9iamVjdCh7QnVja2V0OiAnYnVja2V0JywgS2V5OiAna2V5J30pOwogICAgICogICAgIHZhciByZXN1bHQgPSByZXF1ZXN0LnByb21pc2UoKTsKICAgICAqICAgICByZXN1bHQudGhlbihmdW5jdGlvbihkYXRhKSB7IC4uLiB9LCBmdW5jdGlvbihlcnJvcikgeyAuLi4gfSk7CiAgICAgKi8KICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGJ1aWxkOiBmdW5jdGlvbiBidWlsZChjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5ydW5Ubygnc2VuZCcsIGNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBydW5UbzogZnVuY3Rpb24gcnVuVG8oc3RhdGUsIGRvbmUpIHsKICAgICAgdGhpcy5fYXNtLnJ1blRvKHN0YXRlLCBkb25lLCB0aGlzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBBYm9ydHMgYSByZXF1ZXN0LCBlbWl0dGluZyB0aGUgZXJyb3IgYW5kIGNvbXBsZXRlIGV2ZW50cy4KICAgICAqCiAgICAgKiBAIW1hY3JvIG5vYnJvd3NlcgogICAgICogQGV4YW1wbGUgQWJvcnRpbmcgYSByZXF1ZXN0IGFmdGVyIHNlbmRpbmcKICAgICAqICAgdmFyIHBhcmFtcyA9IHsKICAgICAqICAgICBCdWNrZXQ6ICdidWNrZXQnLCBLZXk6ICdrZXknLAogICAgICogICAgIEJvZHk6IEJ1ZmZlci5hbGxvYygxMDI0ICogMTAyNCAqIDUpIC8vIDVNQiBwYXlsb2FkCiAgICAgKiAgIH07CiAgICAgKiAgIHZhciByZXF1ZXN0ID0gczMucHV0T2JqZWN0KHBhcmFtcyk7CiAgICAgKiAgIHJlcXVlc3Quc2VuZChmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgKiAgICAgaWYgKGVycikgY29uc29sZS5sb2coIkVycm9yOiIsIGVyci5jb2RlLCBlcnIubWVzc2FnZSk7CiAgICAgKiAgICAgZWxzZSBjb25zb2xlLmxvZyhkYXRhKTsKICAgICAqICAgfSk7CiAgICAgKgogICAgICogICAvLyBhYm9ydCByZXF1ZXN0IGluIDEgc2Vjb25kCiAgICAgKiAgIHNldFRpbWVvdXQocmVxdWVzdC5hYm9ydC5iaW5kKHJlcXVlc3QpLCAxMDAwKTsKICAgICAqCiAgICAgKiAgIC8vIHByaW50cyAiRXJyb3I6IFJlcXVlc3RBYm9ydGVkRXJyb3IgUmVxdWVzdCBhYm9ydGVkIGJ5IHVzZXIiCiAgICAgKiBAcmV0dXJuIFtBV1MuUmVxdWVzdF0gdGhlIHNhbWUgcmVxdWVzdCBvYmplY3QsIGZvciBjaGFpbmluZy4KICAgICAqIEBzaW5jZSB2MS40LjAKICAgICAqLwogICAgYWJvcnQ6IGZ1bmN0aW9uIGFib3J0KCkgewogICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygndmFsaWRhdGVSZXNwb25zZScpOwogICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygnZXh0cmFjdEVycm9yJyk7CiAgICAgIHRoaXMub24oJ3ZhbGlkYXRlUmVzcG9uc2UnLCBmdW5jdGlvbiBhZGRBYm9ydGVkRXJyb3IocmVzcCkgewogICAgICAgIHJlc3AuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ1JlcXVlc3QgYWJvcnRlZCBieSB1c2VyJyksIHsKICAgICAgICAgICBjb2RlOiAnUmVxdWVzdEFib3J0ZWRFcnJvcicsIHJldHJ5YWJsZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgfSk7CiAgCiAgICAgIGlmICh0aGlzLmh0dHBSZXF1ZXN0LnN0cmVhbSAmJiAhdGhpcy5odHRwUmVxdWVzdC5zdHJlYW0uZGlkQ2FsbGJhY2spIHsgLy8gYWJvcnQgSFRUUCBzdHJlYW0KICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0LnN0cmVhbS5hYm9ydCgpOwogICAgICAgIGlmICh0aGlzLmh0dHBSZXF1ZXN0Ll9hYm9ydENhbGxiYWNrKSB7CiAgICAgICAgICAgdGhpcy5odHRwUmVxdWVzdC5fYWJvcnRDYWxsYmFjaygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygnc2VuZCcpOyAvLyBoYXZlbid0IHNlbnQgeWV0LCBzbyBsZXQncyBub3QKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBJdGVyYXRlcyBvdmVyIGVhY2ggcGFnZSBvZiByZXN1bHRzIGdpdmVuIGEgcGFnZWFibGUgcmVxdWVzdCwgY2FsbGluZwogICAgICogdGhlIHByb3ZpZGVkIGNhbGxiYWNrIHdpdGggZWFjaCBwYWdlIG9mIGRhdGEuIEFmdGVyIGFsbCBwYWdlcyBoYXZlIGJlZW4KICAgICAqIHJldHJpZXZlZCwgdGhlIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIGBudWxsYCBkYXRhLgogICAgICoKICAgICAqIEBub3RlIFRoaXMgb3BlcmF0aW9uIGNhbiBnZW5lcmF0ZSBtdWx0aXBsZSByZXF1ZXN0cyB0byBhIHNlcnZpY2UuCiAgICAgKiBAZXhhbXBsZSBJdGVyYXRpbmcgb3ZlciBtdWx0aXBsZSBwYWdlcyBvZiBvYmplY3RzIGluIGFuIFMzIGJ1Y2tldAogICAgICogICB2YXIgcGFnZXMgPSAxOwogICAgICogICBzMy5saXN0T2JqZWN0cygpLmVhY2hQYWdlKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICogICAgIGlmIChlcnIpIHJldHVybjsKICAgICAqICAgICBjb25zb2xlLmxvZygiUGFnZSIsIHBhZ2VzKyspOwogICAgICogICAgIGNvbnNvbGUubG9nKGRhdGEpOwogICAgICogICB9KTsKICAgICAqIEBleGFtcGxlIEl0ZXJhdGluZyBvdmVyIG11bHRpcGxlIHBhZ2VzIHdpdGggYW4gYXN5bmNocm9ub3VzIGNhbGxiYWNrCiAgICAgKiAgIHMzLmxpc3RPYmplY3RzKHBhcmFtcykuZWFjaFBhZ2UoZnVuY3Rpb24oZXJyLCBkYXRhLCBkb25lKSB7CiAgICAgKiAgICAgZG9Tb21ldGhpbmdBc3luY0FuZE9yRXhwZW5zaXZlKGZ1bmN0aW9uKCkgewogICAgICogICAgICAgLy8gVGhlIG5leHQgcGFnZSBvZiByZXN1bHRzIGlzbid0IGZldGNoZWQgdW50aWwgZG9uZSBpcyBjYWxsZWQKICAgICAqICAgICAgIGRvbmUoKTsKICAgICAqICAgICB9KTsKICAgICAqICAgfSk7CiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBkYXRhLCBbZG9uZUNhbGxiYWNrXSkKICAgICAqICAgQ2FsbGVkIHdpdGggZWFjaCBwYWdlIG9mIHJlc3VsdGluZyBkYXRhIGZyb20gdGhlIHJlcXVlc3QuIElmIHRoZQogICAgICogICBvcHRpb25hbCBgZG9uZUNhbGxiYWNrYCBpcyBwcm92aWRlZCBpbiB0aGUgZnVuY3Rpb24sIGl0IG11c3QgYmUgY2FsbGVkCiAgICAgKiAgIHdoZW4gdGhlIGNhbGxiYWNrIGlzIGNvbXBsZXRlLgogICAgICoKICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGFuIGVycm9yIG9iamVjdCwgaWYgYW4gZXJyb3Igb2NjdXJyZWQuCiAgICAgKiAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIGEgc2luZ2xlIHBhZ2Ugb2YgcmVzcG9uc2UgZGF0YS4gSWYgdGhlcmUgaXMgbm8KICAgICAqICAgICBtb3JlIGRhdGEsIHRoaXMgb2JqZWN0IHdpbGwgYmUgYG51bGxgLgogICAgICogICBAcGFyYW0gZG9uZUNhbGxiYWNrIFtGdW5jdGlvbl0gYW4gb3B0aW9uYWwgZG9uZSBjYWxsYmFjay4gSWYgdGhpcwogICAgICogICAgIGFyZ3VtZW50IGlzIGRlZmluZWQgaW4gdGhlIGZ1bmN0aW9uIGRlY2xhcmF0aW9uLCBpdCBzaG91bGQgYmUgY2FsbGVkCiAgICAgKiAgICAgd2hlbiB0aGUgbmV4dCBwYWdlIGlzIHJlYWR5IHRvIGJlIHJldHJpZXZlZC4gVGhpcyBpcyB1c2VmdWwgZm9yCiAgICAgKiAgICAgY29udHJvbGxpbmcgc2VyaWFsIHBhZ2luYXRpb24gYWNyb3NzIGFzeW5jaHJvbm91cyBvcGVyYXRpb25zLgogICAgICogICBAcmV0dXJuIFtCb29sZWFuXSBpZiB0aGUgY2FsbGJhY2sgcmV0dXJucyBgZmFsc2VgLCBwYWdpbmF0aW9uIHdpbGwKICAgICAqICAgICBzdG9wLgogICAgICoKICAgICAqIEBzZWUgQVdTLlJlcXVlc3QuZWFjaEl0ZW0KICAgICAqIEBzZWUgQVdTLlJlc3BvbnNlLm5leHRQYWdlCiAgICAgKiBAc2luY2UgdjEuNC4wCiAgICAgKi8KICAgIGVhY2hQYWdlOiBmdW5jdGlvbiBlYWNoUGFnZShjYWxsYmFjaykgewogICAgICAvLyBNYWtlIGFsbCBjYWxsYmFja3MgYXN5bmMtaXNoCiAgICAgIGNhbGxiYWNrID0gQVdTLnV0aWwuZm4ubWFrZUFzeW5jKGNhbGxiYWNrLCAzKTsKICAKICAgICAgZnVuY3Rpb24gd3JhcHBlZENhbGxiYWNrKHJlc3BvbnNlKSB7CiAgICAgICAgY2FsbGJhY2suY2FsbChyZXNwb25zZSwgcmVzcG9uc2UuZXJyb3IsIHJlc3BvbnNlLmRhdGEsIGZ1bmN0aW9uIChyZXN1bHQpIHsKICAgICAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKSByZXR1cm47CiAgCiAgICAgICAgICBpZiAocmVzcG9uc2UuaGFzTmV4dFBhZ2UoKSkgewogICAgICAgICAgICByZXNwb25zZS5uZXh0UGFnZSgpLm9uKCdjb21wbGV0ZScsIHdyYXBwZWRDYWxsYmFjaykuc2VuZCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2FsbGJhY2suY2FsbChyZXNwb25zZSwgbnVsbCwgbnVsbCwgQVdTLnV0aWwuZm4ubm9vcCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAKICAgICAgdGhpcy5vbignY29tcGxldGUnLCB3cmFwcGVkQ2FsbGJhY2spLnNlbmQoKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEVudW1lcmF0ZXMgb3ZlciBpbmRpdmlkdWFsIGl0ZW1zIG9mIGEgcmVxdWVzdCwgcGFnaW5nIHRoZSByZXNwb25zZXMgaWYKICAgICAqIG5lY2Vzc2FyeS4KICAgICAqCiAgICAgKiBAYXBpIGV4cGVyaW1lbnRhbAogICAgICogQHNpbmNlIHYxLjQuMAogICAgICovCiAgICBlYWNoSXRlbTogZnVuY3Rpb24gZWFjaEl0ZW0oY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBmdW5jdGlvbiB3cmFwcGVkQ2FsbGJhY2soZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKGVycikgcmV0dXJuIGNhbGxiYWNrKGVyciwgbnVsbCk7CiAgICAgICAgaWYgKGRhdGEgPT09IG51bGwpIHJldHVybiBjYWxsYmFjayhudWxsLCBudWxsKTsKICAKICAgICAgICB2YXIgY29uZmlnID0gc2VsZi5zZXJ2aWNlLnBhZ2luYXRpb25Db25maWcoc2VsZi5vcGVyYXRpb24pOwogICAgICAgIHZhciByZXN1bHRLZXkgPSBjb25maWcucmVzdWx0S2V5OwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdEtleSkpIHJlc3VsdEtleSA9IHJlc3VsdEtleVswXTsKICAgICAgICB2YXIgaXRlbXMgPSBqbWVzcGF0aC5zZWFyY2goZGF0YSwgcmVzdWx0S2V5KTsKICAgICAgICB2YXIgY29udGludWVJdGVyYXRpb24gPSB0cnVlOwogICAgICAgIEFXUy51dGlsLmFycmF5RWFjaChpdGVtcywgZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgY29udGludWVJdGVyYXRpb24gPSBjYWxsYmFjayhudWxsLCBpdGVtKTsKICAgICAgICAgIGlmIChjb250aW51ZUl0ZXJhdGlvbiA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgcmV0dXJuIEFXUy51dGlsLmFib3J0OwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBjb250aW51ZUl0ZXJhdGlvbjsKICAgICAgfQogIAogICAgICB0aGlzLmVhY2hQYWdlKHdyYXBwZWRDYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBvcGVyYXRpb24gY2FuIHJldHVybiBtdWx0aXBsZSBwYWdlcyBvZgogICAgICogICByZXNwb25zZSBkYXRhLgogICAgICogQHNlZSBBV1MuUmVzcG9uc2UuZWFjaFBhZ2UKICAgICAqIEBzaW5jZSB2MS40LjAKICAgICAqLwogICAgaXNQYWdlYWJsZTogZnVuY3Rpb24gaXNQYWdlYWJsZSgpIHsKICAgICAgcmV0dXJuIHRoaXMuc2VydmljZS5wYWdpbmF0aW9uQ29uZmlnKHRoaXMub3BlcmF0aW9uKSA/IHRydWUgOiBmYWxzZTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFNlbmRzIHRoZSByZXF1ZXN0IGFuZCBjb252ZXJ0cyB0aGUgcmVxdWVzdCBvYmplY3QgaW50byBhIHJlYWRhYmxlIHN0cmVhbQogICAgICogdGhhdCBjYW4gYmUgcmVhZCBmcm9tIG9yIHBpcGVkIGludG8gYSB3cml0YWJsZSBzdHJlYW0uCiAgICAgKgogICAgICogQG5vdGUgVGhlIGRhdGEgcmVhZCBmcm9tIGEgcmVhZGFibGUgc3RyZWFtIGNvbnRhaW5zIG9ubHkKICAgICAqICAgdGhlIHJhdyBIVFRQIGJvZHkgY29udGVudHMuCiAgICAgKiBAZXhhbXBsZSBNYW51YWxseSByZWFkaW5nIGZyb20gYSBzdHJlYW0KICAgICAqICAgcmVxdWVzdC5jcmVhdGVSZWFkU3RyZWFtKCkub24oJ2RhdGEnLCBmdW5jdGlvbihkYXRhKSB7CiAgICAgKiAgICAgY29uc29sZS5sb2coIkdvdCBkYXRhOiIsIGRhdGEudG9TdHJpbmcoKSk7CiAgICAgKiAgIH0pOwogICAgICogQGV4YW1wbGUgUGlwaW5nIGEgcmVxdWVzdCBib2R5IGludG8gYSBmaWxlCiAgICAgKiAgIHZhciBvdXQgPSBmcy5jcmVhdGVXcml0ZVN0cmVhbSgnL3BhdGgvdG8vb3V0ZmlsZS5qcGcnKTsKICAgICAqICAgczMuc2VydmljZS5nZXRPYmplY3QocGFyYW1zKS5jcmVhdGVSZWFkU3RyZWFtKCkucGlwZShvdXQpOwogICAgICogQHJldHVybiBbU3RyZWFtXSB0aGUgcmVhZGFibGUgc3RyZWFtIG9iamVjdCB0aGF0IGNhbiBiZSBwaXBlZAogICAgICogICBvciByZWFkIGZyb20gKGJ5IHJlZ2lzdGVyaW5nICdkYXRhJyBldmVudCBsaXN0ZW5lcnMpLgogICAgICogQCFtYWNybyBub2Jyb3dzZXIKICAgICAqLwogICAgY3JlYXRlUmVhZFN0cmVhbTogZnVuY3Rpb24gY3JlYXRlUmVhZFN0cmVhbSgpIHsKICAgICAgdmFyIHN0cmVhbXMgPSBBV1MudXRpbC5zdHJlYW07CiAgICAgIHZhciByZXEgPSB0aGlzOwogICAgICB2YXIgc3RyZWFtID0gbnVsbDsKICAKICAgICAgaWYgKEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyKSB7CiAgICAgICAgc3RyZWFtID0gbmV3IHN0cmVhbXMuUGFzc1Rocm91Z2goKTsKICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgeyByZXEuc2VuZCgpOyB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdHJlYW0gPSBuZXcgc3RyZWFtcy5TdHJlYW0oKTsKICAgICAgICBzdHJlYW0ucmVhZGFibGUgPSB0cnVlOwogIAogICAgICAgIHN0cmVhbS5zZW50ID0gZmFsc2U7CiAgICAgICAgc3RyZWFtLm9uKCduZXdMaXN0ZW5lcicsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICBpZiAoIXN0cmVhbS5zZW50ICYmIGV2ZW50ID09PSAnZGF0YScpIHsKICAgICAgICAgICAgc3RyZWFtLnNlbnQgPSB0cnVlOwogICAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgeyByZXEuc2VuZCgpOyB9KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogIAogICAgICB0aGlzLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycikgewogICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgIH0pOwogIAogICAgICB0aGlzLm9uKCdodHRwSGVhZGVycycsIGZ1bmN0aW9uIHN0cmVhbUhlYWRlcnMoc3RhdHVzQ29kZSwgaGVhZGVycywgcmVzcCkgewogICAgICAgIGlmIChzdGF0dXNDb2RlIDwgMzAwKSB7CiAgICAgICAgICByZXEucmVtb3ZlTGlzdGVuZXIoJ2h0dHBEYXRhJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuSFRUUF9EQVRBKTsKICAgICAgICAgIHJlcS5yZW1vdmVMaXN0ZW5lcignaHR0cEVycm9yJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuSFRUUF9FUlJPUik7CiAgICAgICAgICByZXEub24oJ2h0dHBFcnJvcicsIGZ1bmN0aW9uIHN0cmVhbUh0dHBFcnJvcihlcnJvcikgewogICAgICAgICAgICByZXNwLmVycm9yID0gZXJyb3I7CiAgICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gZmFsc2U7CiAgICAgICAgICB9KTsKICAKICAgICAgICAgIHZhciBzaG91bGRDaGVja0NvbnRlbnRMZW5ndGggPSBmYWxzZTsKICAgICAgICAgIHZhciBleHBlY3RlZExlbjsKICAgICAgICAgIGlmIChyZXEuaHR0cFJlcXVlc3QubWV0aG9kICE9PSAnSEVBRCcpIHsKICAgICAgICAgICAgZXhwZWN0ZWRMZW4gPSBwYXJzZUludChoZWFkZXJzWydjb250ZW50LWxlbmd0aCddLCAxMCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXhwZWN0ZWRMZW4gIT09IHVuZGVmaW5lZCAmJiAhaXNOYU4oZXhwZWN0ZWRMZW4pICYmIGV4cGVjdGVkTGVuID49IDApIHsKICAgICAgICAgICAgc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIHJlY2VpdmVkTGVuID0gMDsKICAgICAgICAgIH0KICAKICAgICAgICAgIHZhciBjaGVja0NvbnRlbnRMZW5ndGhBbmRFbWl0ID0gZnVuY3Rpb24gY2hlY2tDb250ZW50TGVuZ3RoQW5kRW1pdCgpIHsKICAgICAgICAgICAgaWYgKHNob3VsZENoZWNrQ29udGVudExlbmd0aCAmJiByZWNlaXZlZExlbiAhPT0gZXhwZWN0ZWRMZW4pIHsKICAgICAgICAgICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBBV1MudXRpbC5lcnJvcigKICAgICAgICAgICAgICAgIG5ldyBFcnJvcignU3RyZWFtIGNvbnRlbnQgbGVuZ3RoIG1pc21hdGNoLiBSZWNlaXZlZCAnICsKICAgICAgICAgICAgICAgICAgcmVjZWl2ZWRMZW4gKyAnIG9mICcgKyBleHBlY3RlZExlbiArICcgYnl0ZXMuJyksCiAgICAgICAgICAgICAgICB7IGNvZGU6ICdTdHJlYW1Db250ZW50TGVuZ3RoTWlzbWF0Y2gnIH0KICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMikgewogICAgICAgICAgICAgIHN0cmVhbS5lbmQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdHJlYW0uZW1pdCgnZW5kJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgCiAgICAgICAgICB2YXIgaHR0cFN0cmVhbSA9IHJlc3AuaHR0cFJlc3BvbnNlLmNyZWF0ZVVuYnVmZmVyZWRTdHJlYW0oKTsKICAKICAgICAgICAgIGlmIChBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMikgewogICAgICAgICAgICBpZiAoc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoKSB7CiAgICAgICAgICAgICAgdmFyIGxlbmd0aEFjY3VtdWxhdG9yID0gbmV3IHN0cmVhbXMuUGFzc1Rocm91Z2goKTsKICAgICAgICAgICAgICBsZW5ndGhBY2N1bXVsYXRvci5fd3JpdGUgPSBmdW5jdGlvbihjaHVuaykgewogICAgICAgICAgICAgICAgaWYgKGNodW5rICYmIGNodW5rLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICByZWNlaXZlZExlbiArPSBjaHVuay5sZW5ndGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gc3RyZWFtcy5QYXNzVGhyb3VnaC5wcm90b3R5cGUuX3dyaXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgfTsKICAKICAgICAgICAgICAgICBsZW5ndGhBY2N1bXVsYXRvci5vbignZW5kJywgY2hlY2tDb250ZW50TGVuZ3RoQW5kRW1pdCk7CiAgICAgICAgICAgICAgc3RyZWFtLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgICAgc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoID0gZmFsc2U7CiAgICAgICAgICAgICAgICBodHRwU3RyZWFtLnVucGlwZShsZW5ndGhBY2N1bXVsYXRvcik7CiAgICAgICAgICAgICAgICBsZW5ndGhBY2N1bXVsYXRvci5lbWl0KCdlbmQnKTsKICAgICAgICAgICAgICAgIGxlbmd0aEFjY3VtdWxhdG9yLmVuZCgpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGh0dHBTdHJlYW0ucGlwZShsZW5ndGhBY2N1bXVsYXRvcikucGlwZShzdHJlYW0sIHsgZW5kOiBmYWxzZSB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBodHRwU3RyZWFtLnBpcGUoc3RyZWFtKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAKICAgICAgICAgICAgaWYgKHNob3VsZENoZWNrQ29udGVudExlbmd0aCkgewogICAgICAgICAgICAgIGh0dHBTdHJlYW0ub24oJ2RhdGEnLCBmdW5jdGlvbihhcmcpIHsKICAgICAgICAgICAgICAgIGlmIChhcmcgJiYgYXJnLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICByZWNlaXZlZExlbiArPSBhcmcubGVuZ3RoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgCiAgICAgICAgICAgIGh0dHBTdHJlYW0ub24oJ2RhdGEnLCBmdW5jdGlvbihhcmcpIHsKICAgICAgICAgICAgICBzdHJlYW0uZW1pdCgnZGF0YScsIGFyZyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBodHRwU3RyZWFtLm9uKCdlbmQnLCBjaGVja0NvbnRlbnRMZW5ndGhBbmRFbWl0KTsKICAgICAgICAgIH0KICAKICAgICAgICAgIGh0dHBTdHJlYW0ub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgIHNob3VsZENoZWNrQ29udGVudExlbmd0aCA9IGZhbHNlOwogICAgICAgICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBlcnIpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgcmV0dXJuIHN0cmVhbTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBwYXJhbSBbQXJyYXksUmVzcG9uc2VdIGFyZ3MgVGhpcyBzaG91bGQgYmUgdGhlIHJlc3BvbnNlIG9iamVjdCwKICAgICAqICAgb3IgYW4gYXJyYXkgb2YgYXJncyB0byBzZW5kIHRvIHRoZSBldmVudC4KICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBlbWl0RXZlbnQ6IGZ1bmN0aW9uIGVtaXQoZXZlbnROYW1lLCBhcmdzLCBkb25lKSB7CiAgICAgIGlmICh0eXBlb2YgYXJncyA9PT0gJ2Z1bmN0aW9uJykgeyBkb25lID0gYXJnczsgYXJncyA9IG51bGw7IH0KICAgICAgaWYgKCFkb25lKSBkb25lID0gZnVuY3Rpb24oKSB7IH07CiAgICAgIGlmICghYXJncykgYXJncyA9IHRoaXMuZXZlbnRQYXJhbWV0ZXJzKGV2ZW50TmFtZSwgdGhpcy5yZXNwb25zZSk7CiAgCiAgICAgIHZhciBvcmlnRW1pdCA9IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IucHJvdG90eXBlLmVtaXQ7CiAgICAgIG9yaWdFbWl0LmNhbGwodGhpcywgZXZlbnROYW1lLCBhcmdzLCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgaWYgKGVycikgdGhpcy5yZXNwb25zZS5lcnJvciA9IGVycjsKICAgICAgICBkb25lLmNhbGwodGhpcywgZXJyKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZXZlbnRQYXJhbWV0ZXJzOiBmdW5jdGlvbiBldmVudFBhcmFtZXRlcnMoZXZlbnROYW1lKSB7CiAgICAgIHN3aXRjaCAoZXZlbnROYW1lKSB7CiAgICAgICAgY2FzZSAncmVzdGFydCc6CiAgICAgICAgY2FzZSAndmFsaWRhdGUnOgogICAgICAgIGNhc2UgJ3NpZ24nOgogICAgICAgIGNhc2UgJ2J1aWxkJzoKICAgICAgICBjYXNlICdhZnRlclZhbGlkYXRlJzoKICAgICAgICBjYXNlICdhZnRlckJ1aWxkJzoKICAgICAgICAgIHJldHVybiBbdGhpc107CiAgICAgICAgY2FzZSAnZXJyb3InOgogICAgICAgICAgcmV0dXJuIFt0aGlzLnJlc3BvbnNlLmVycm9yLCB0aGlzLnJlc3BvbnNlXTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIFt0aGlzLnJlc3BvbnNlXTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHByZXNpZ246IGZ1bmN0aW9uIHByZXNpZ24oZXhwaXJlcywgY2FsbGJhY2spIHsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgZXhwaXJlcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGNhbGxiYWNrID0gZXhwaXJlczsKICAgICAgICBleHBpcmVzID0gbnVsbDsKICAgICAgfQogICAgICByZXR1cm4gbmV3IEFXUy5TaWduZXJzLlByZXNpZ24oKS5zaWduKHRoaXMudG9HZXQoKSwgZXhwaXJlcywgY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGlzUHJlc2lnbmVkOiBmdW5jdGlvbiBpc1ByZXNpZ25lZCgpIHsKICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLmh0dHBSZXF1ZXN0LmhlYWRlcnMsICdwcmVzaWduZWQtZXhwaXJlcycpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHRvVW5hdXRoZW50aWNhdGVkOiBmdW5jdGlvbiB0b1VuYXV0aGVudGljYXRlZCgpIHsKICAgICAgdGhpcy5fdW5BdXRoZW50aWNhdGVkID0gdHJ1ZTsKICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9DUkVERU5USUFMUyk7CiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ3NpZ24nLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5TSUdOKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdG9HZXQ6IGZ1bmN0aW9uIHRvR2V0KCkgewogICAgICBpZiAodGhpcy5zZXJ2aWNlLmFwaS5wcm90b2NvbCA9PT0gJ3F1ZXJ5JyB8fAogICAgICAgICAgdGhpcy5zZXJ2aWNlLmFwaS5wcm90b2NvbCA9PT0gJ2VjMicpIHsKICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKCdidWlsZCcsIHRoaXMuYnVpbGRBc0dldCk7CiAgICAgICAgdGhpcy5hZGRMaXN0ZW5lcignYnVpbGQnLCB0aGlzLmJ1aWxkQXNHZXQpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGJ1aWxkQXNHZXQ6IGZ1bmN0aW9uIGJ1aWxkQXNHZXQocmVxdWVzdCkgewogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0Lm1ldGhvZCA9ICdHRVQnOwogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnBhdGggPSByZXF1ZXN0LnNlcnZpY2UuZW5kcG9pbnQucGF0aCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc/JyArIHJlcXVlc3QuaHR0cFJlcXVlc3QuYm9keTsKICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC5ib2R5ID0gJyc7CiAgCiAgICAgIC8vIGRvbid0IG5lZWQgdGhlc2UgaGVhZGVycyBvbiBhIEdFVCByZXF1ZXN0CiAgICAgIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtTGVuZ3RoJ107CiAgICAgIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGhhbHRIYW5kbGVyc09uRXJyb3I6IGZ1bmN0aW9uIGhhbHRIYW5kbGVyc09uRXJyb3IoKSB7CiAgICAgIHRoaXMuX2hhbHRIYW5kbGVyc09uRXJyb3IgPSB0cnVlOwogICAgfQogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5SZXF1ZXN0LmFkZFByb21pc2VzVG9DbGFzcyA9IGZ1bmN0aW9uIGFkZFByb21pc2VzVG9DbGFzcyhQcm9taXNlRGVwZW5kZW5jeSkgewogICAgdGhpcy5wcm90b3R5cGUucHJvbWlzZSA9IGZ1bmN0aW9uIHByb21pc2UoKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgLy8gYXBwZW5kIHRvIHVzZXIgYWdlbnQKICAgICAgdGhpcy5odHRwUmVxdWVzdC5hcHBlbmRUb1VzZXJBZ2VudCgncHJvbWlzZScpOwogICAgICByZXR1cm4gbmV3IFByb21pc2VEZXBlbmRlbmN5KGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIHNlbGYub24oJ2NvbXBsZXRlJywgZnVuY3Rpb24ocmVzcCkgewogICAgICAgICAgaWYgKHJlc3AuZXJyb3IpIHsKICAgICAgICAgICAgcmVqZWN0KHJlc3AuZXJyb3IpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gZGVmaW5lICRyZXNwb25zZSBwcm9wZXJ0eSBzbyB0aGF0IGl0IGlzIG5vdCBlbnVtYmVyYWJsZQogICAgICAgICAgICAvLyB0aGlzIHByZXZlbnRzIGNpcmN1bGFyIHJlZmVyZW5jZSBlcnJvcnMgd2hlbiBzdHJpbmdpZnlpbmcgdGhlIEpTT04gb2JqZWN0CiAgICAgICAgICAgIHJlc29sdmUoT2JqZWN0LmRlZmluZVByb3BlcnR5KAogICAgICAgICAgICAgIHJlc3AuZGF0YSB8fCB7fSwKICAgICAgICAgICAgICAnJHJlc3BvbnNlJywKICAgICAgICAgICAgICB7dmFsdWU6IHJlc3B9CiAgICAgICAgICAgICkpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHNlbGYucnVuVG8oKTsKICAgICAgfSk7CiAgICB9OwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlJlcXVlc3QuZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MgPSBmdW5jdGlvbiBkZWxldGVQcm9taXNlc0Zyb21DbGFzcygpIHsKICAgIGRlbGV0ZSB0aGlzLnByb3RvdHlwZS5wcm9taXNlOwogIH07CiAgCiAgQVdTLnV0aWwuYWRkUHJvbWlzZXMoQVdTLlJlcXVlc3QpOwogIAogIEFXUy51dGlsLm1peGluKEFXUy5SZXF1ZXN0LCBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKTsKICAKICB9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKICB9LHsiLi9jb3JlIjoxOCwiLi9zdGF0ZV9tYWNoaW5lIjo3MCwiX3Byb2Nlc3MiOjg1LCJqbWVzcGF0aCI6ODR9XSw1NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLyoqCiAgICogQ29weXJpZ2h0IDIwMTItMjAxMyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogICAqCiAgICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIikuIFlvdQogICAqIG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YKICAgKiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0CiAgICoKICAgKiAgICAgaHR0cDovL2F3cy5hbWF6b24uY29tL2FwYWNoZTIuMC8KICAgKgogICAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMKICAgKiBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRgogICAqIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYwogICAqIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAgICovCiAgCiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICB2YXIgam1lc3BhdGggPSByZXF1aXJlKCdqbWVzcGF0aCcpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIENIRUNLX0FDQ0VQVE9SUyhyZXNwKSB7CiAgICB2YXIgd2FpdGVyID0gcmVzcC5yZXF1ZXN0Ll93YWl0ZXI7CiAgICB2YXIgYWNjZXB0b3JzID0gd2FpdGVyLmNvbmZpZy5hY2NlcHRvcnM7CiAgICB2YXIgYWNjZXB0b3JNYXRjaGVkID0gZmFsc2U7CiAgICB2YXIgc3RhdGUgPSAncmV0cnknOwogIAogICAgYWNjZXB0b3JzLmZvckVhY2goZnVuY3Rpb24oYWNjZXB0b3IpIHsKICAgICAgaWYgKCFhY2NlcHRvck1hdGNoZWQpIHsKICAgICAgICB2YXIgbWF0Y2hlciA9IHdhaXRlci5tYXRjaGVyc1thY2NlcHRvci5tYXRjaGVyXTsKICAgICAgICBpZiAobWF0Y2hlciAmJiBtYXRjaGVyKHJlc3AsIGFjY2VwdG9yLmV4cGVjdGVkLCBhY2NlcHRvci5hcmd1bWVudCkpIHsKICAgICAgICAgIGFjY2VwdG9yTWF0Y2hlZCA9IHRydWU7CiAgICAgICAgICBzdGF0ZSA9IGFjY2VwdG9yLnN0YXRlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgCiAgICBpZiAoIWFjY2VwdG9yTWF0Y2hlZCAmJiByZXNwLmVycm9yKSBzdGF0ZSA9ICdmYWlsdXJlJzsKICAKICAgIGlmIChzdGF0ZSA9PT0gJ3N1Y2Nlc3MnKSB7CiAgICAgIHdhaXRlci5zZXRTdWNjZXNzKHJlc3ApOwogICAgfSBlbHNlIHsKICAgICAgd2FpdGVyLnNldEVycm9yKHJlc3AsIHN0YXRlID09PSAncmV0cnknKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlJlc291cmNlV2FpdGVyID0gaW5oZXJpdCh7CiAgICAvKioKICAgICAqIFdhaXRzIGZvciBhIGdpdmVuIHN0YXRlIG9uIGEgc2VydmljZSBvYmplY3QKICAgICAqIEBwYXJhbSBzZXJ2aWNlIFtTZXJ2aWNlXSB0aGUgc2VydmljZSBvYmplY3QgdG8gd2FpdCBvbgogICAgICogQHBhcmFtIHN0YXRlIFtTdHJpbmddIHRoZSBzdGF0ZSAoZGVmaW5lZCBpbiB3YWl0ZXIgY29uZmlndXJhdGlvbikgdG8gd2FpdAogICAgICogICBmb3IuCiAgICAgKiBAZXhhbXBsZSBDcmVhdGUgYSB3YWl0ZXIgZm9yIHJ1bm5pbmcgRUMyIGluc3RhbmNlcwogICAgICogICB2YXIgZWMyID0gbmV3IEFXUy5FQzI7CiAgICAgKiAgIHZhciB3YWl0ZXIgPSBuZXcgQVdTLlJlc291cmNlV2FpdGVyKGVjMiwgJ2luc3RhbmNlUnVubmluZycpOwogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gY29uc3RydWN0b3Ioc2VydmljZSwgc3RhdGUpIHsKICAgICAgdGhpcy5zZXJ2aWNlID0gc2VydmljZTsKICAgICAgdGhpcy5zdGF0ZSA9IHN0YXRlOwogICAgICB0aGlzLmxvYWRXYWl0ZXJDb25maWcodGhpcy5zdGF0ZSk7CiAgICB9LAogIAogICAgc2VydmljZTogbnVsbCwKICAKICAgIHN0YXRlOiBudWxsLAogIAogICAgY29uZmlnOiBudWxsLAogIAogICAgbWF0Y2hlcnM6IHsKICAgICAgcGF0aDogZnVuY3Rpb24ocmVzcCwgZXhwZWN0ZWQsIGFyZ3VtZW50KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciByZXN1bHQgPSBqbWVzcGF0aC5zZWFyY2gocmVzcC5kYXRhLCBhcmd1bWVudCk7CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogIAogICAgICAgIHJldHVybiBqbWVzcGF0aC5zdHJpY3REZWVwRXF1YWwocmVzdWx0LGV4cGVjdGVkKTsKICAgICAgfSwKICAKICAgICAgcGF0aEFsbDogZnVuY3Rpb24ocmVzcCwgZXhwZWN0ZWQsIGFyZ3VtZW50KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciByZXN1bHRzID0gam1lc3BhdGguc2VhcmNoKHJlc3AuZGF0YSwgYXJndW1lbnQpOwogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAKICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkocmVzdWx0cykpIHJlc3VsdHMgPSBbcmVzdWx0c107CiAgICAgICAgdmFyIG51bVJlc3VsdHMgPSByZXN1bHRzLmxlbmd0aDsKICAgICAgICBpZiAoIW51bVJlc3VsdHMpIHJldHVybiBmYWxzZTsKICAgICAgICBmb3IgKHZhciBpbmQgPSAwIDsgaW5kIDwgbnVtUmVzdWx0czsgaW5kKyspIHsKICAgICAgICAgIGlmICgham1lc3BhdGguc3RyaWN0RGVlcEVxdWFsKHJlc3VsdHNbaW5kXSwgZXhwZWN0ZWQpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0sCiAgCiAgICAgIHBhdGhBbnk6IGZ1bmN0aW9uKHJlc3AsIGV4cGVjdGVkLCBhcmd1bWVudCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgcmVzdWx0cyA9IGptZXNwYXRoLnNlYXJjaChyZXNwLmRhdGEsIGFyZ3VtZW50KTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgCiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdHMpKSByZXN1bHRzID0gW3Jlc3VsdHNdOwogICAgICAgIHZhciBudW1SZXN1bHRzID0gcmVzdWx0cy5sZW5ndGg7CiAgICAgICAgZm9yICh2YXIgaW5kID0gMCA7IGluZCA8IG51bVJlc3VsdHM7IGluZCsrKSB7CiAgICAgICAgICBpZiAoam1lc3BhdGguc3RyaWN0RGVlcEVxdWFsKHJlc3VsdHNbaW5kXSwgZXhwZWN0ZWQpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0sCiAgCiAgICAgIHN0YXR1czogZnVuY3Rpb24ocmVzcCwgZXhwZWN0ZWQpIHsKICAgICAgICB2YXIgc3RhdHVzQ29kZSA9IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgICAgcmV0dXJuICh0eXBlb2Ygc3RhdHVzQ29kZSA9PT0gJ251bWJlcicpICYmIChzdGF0dXNDb2RlID09PSBleHBlY3RlZCk7CiAgICAgIH0sCiAgCiAgICAgIGVycm9yOiBmdW5jdGlvbihyZXNwLCBleHBlY3RlZCkgewogICAgICAgIGlmICh0eXBlb2YgZXhwZWN0ZWQgPT09ICdzdHJpbmcnICYmIHJlc3AuZXJyb3IpIHsKICAgICAgICAgIHJldHVybiBleHBlY3RlZCA9PT0gcmVzcC5lcnJvci5jb2RlOwogICAgICAgIH0KICAgICAgICAvLyBpZiBleHBlY3RlZCBpcyBub3Qgc3RyaW5nLCBjYW4gYmUgYm9vbGVhbiBpbmRpY2F0aW5nIHByZXNlbmNlIG9mIGVycm9yCiAgICAgICAgcmV0dXJuIGV4cGVjdGVkID09PSAhIXJlc3AuZXJyb3I7CiAgICAgIH0KICAgIH0sCiAgCiAgICBsaXN0ZW5lcnM6IG5ldyBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICAgIGFkZCgnUkVUUllfQ0hFQ0snLCAncmV0cnknLCBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgdmFyIHdhaXRlciA9IHJlc3AucmVxdWVzdC5fd2FpdGVyOwogICAgICAgIGlmIChyZXNwLmVycm9yICYmIHJlc3AuZXJyb3IuY29kZSA9PT0gJ1Jlc291cmNlTm90UmVhZHknKSB7CiAgICAgICAgICByZXNwLmVycm9yLnJldHJ5RGVsYXkgPSAod2FpdGVyLmNvbmZpZy5kZWxheSB8fCAwKSAqIDEwMDA7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdDSEVDS19PVVRQVVQnLCAnZXh0cmFjdERhdGEnLCBDSEVDS19BQ0NFUFRPUlMpOwogIAogICAgICBhZGQoJ0NIRUNLX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIENIRUNLX0FDQ0VQVE9SUyk7CiAgICB9KSwKICAKICAgIC8qKgogICAgICogQHJldHVybiBbQVdTLlJlcXVlc3RdCiAgICAgKi8KICAgIHdhaXQ6IGZ1bmN0aW9uIHdhaXQocGFyYW1zLCBjYWxsYmFjaykgewogICAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGNhbGxiYWNrID0gcGFyYW1zOyBwYXJhbXMgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAKICAgICAgaWYgKHBhcmFtcyAmJiBwYXJhbXMuJHdhaXRlcikgewogICAgICAgIHBhcmFtcyA9IEFXUy51dGlsLmNvcHkocGFyYW1zKTsKICAgICAgICBpZiAodHlwZW9mIHBhcmFtcy4kd2FpdGVyLmRlbGF5ID09PSAnbnVtYmVyJykgewogICAgICAgICAgdGhpcy5jb25maWcuZGVsYXkgPSBwYXJhbXMuJHdhaXRlci5kZWxheTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBwYXJhbXMuJHdhaXRlci5tYXhBdHRlbXB0cyA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHRoaXMuY29uZmlnLm1heEF0dGVtcHRzID0gcGFyYW1zLiR3YWl0ZXIubWF4QXR0ZW1wdHM7CiAgICAgICAgfQogICAgICAgIGRlbGV0ZSBwYXJhbXMuJHdhaXRlcjsKICAgICAgfQogIAogICAgICB2YXIgcmVxdWVzdCA9IHRoaXMuc2VydmljZS5tYWtlUmVxdWVzdCh0aGlzLmNvbmZpZy5vcGVyYXRpb24sIHBhcmFtcyk7CiAgICAgIHJlcXVlc3QuX3dhaXRlciA9IHRoaXM7CiAgICAgIHJlcXVlc3QucmVzcG9uc2UubWF4UmV0cmllcyA9IHRoaXMuY29uZmlnLm1heEF0dGVtcHRzOwogICAgICByZXF1ZXN0LmFkZExpc3RlbmVycyh0aGlzLmxpc3RlbmVycyk7CiAgCiAgICAgIGlmIChjYWxsYmFjaykgcmVxdWVzdC5zZW5kKGNhbGxiYWNrKTsKICAgICAgcmV0dXJuIHJlcXVlc3Q7CiAgICB9LAogIAogICAgc2V0U3VjY2VzczogZnVuY3Rpb24gc2V0U3VjY2VzcyhyZXNwKSB7CiAgICAgIHJlc3AuZXJyb3IgPSBudWxsOwogICAgICByZXNwLmRhdGEgPSByZXNwLmRhdGEgfHwge307CiAgICAgIHJlc3AucmVxdWVzdC5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2V4dHJhY3REYXRhJyk7CiAgICB9LAogIAogICAgc2V0RXJyb3I6IGZ1bmN0aW9uIHNldEVycm9yKHJlc3AsIHJldHJ5YWJsZSkgewogICAgICByZXNwLmRhdGEgPSBudWxsOwogICAgICByZXNwLmVycm9yID0gQVdTLnV0aWwuZXJyb3IocmVzcC5lcnJvciB8fCBuZXcgRXJyb3IoKSwgewogICAgICAgIGNvZGU6ICdSZXNvdXJjZU5vdFJlYWR5JywKICAgICAgICBtZXNzYWdlOiAnUmVzb3VyY2UgaXMgbm90IGluIHRoZSBzdGF0ZSAnICsgdGhpcy5zdGF0ZSwKICAgICAgICByZXRyeWFibGU6IHJldHJ5YWJsZQogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIExvYWRzIHdhaXRlciBjb25maWd1cmF0aW9uIGZyb20gQVBJIGNvbmZpZ3VyYXRpb24KICAgICAqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZFdhaXRlckNvbmZpZzogZnVuY3Rpb24gbG9hZFdhaXRlckNvbmZpZyhzdGF0ZSkgewogICAgICBpZiAoIXRoaXMuc2VydmljZS5hcGkud2FpdGVyc1tzdGF0ZV0pIHsKICAgICAgICB0aHJvdyBuZXcgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICAgIGNvZGU6ICdTdGF0ZU5vdEZvdW5kRXJyb3InLAogICAgICAgICAgbWVzc2FnZTogJ1N0YXRlICcgKyBzdGF0ZSArICcgbm90IGZvdW5kLicKICAgICAgICB9KTsKICAgICAgfQogIAogICAgICB0aGlzLmNvbmZpZyA9IEFXUy51dGlsLmNvcHkodGhpcy5zZXJ2aWNlLmFwaS53YWl0ZXJzW3N0YXRlXSk7CiAgICB9CiAgfSk7CiAgCiAgfSx7Ii4vY29yZSI6MTgsImptZXNwYXRoIjo4NH1dLDU3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIHZhciBqbWVzcGF0aCA9IHJlcXVpcmUoJ2ptZXNwYXRoJyk7CiAgCiAgLyoqCiAgICogVGhpcyBjbGFzcyBlbmNhcHN1bGF0ZXMgdGhlIHJlc3BvbnNlIGluZm9ybWF0aW9uCiAgICogZnJvbSBhIHNlcnZpY2UgcmVxdWVzdCBvcGVyYXRpb24gc2VudCB0aHJvdWdoIHtBV1MuUmVxdWVzdH0uCiAgICogVGhlIHJlc3BvbnNlIG9iamVjdCBoYXMgdHdvIG1haW4gcHJvcGVydGllcyBmb3IgZ2V0dGluZyBpbmZvcm1hdGlvbgogICAqIGJhY2sgZnJvbSBhIHJlcXVlc3Q6CiAgICoKICAgKiAjIyBUaGUgYGRhdGFgIHByb3BlcnR5CiAgICoKICAgKiBUaGUgYHJlc3BvbnNlLmRhdGFgIHByb3BlcnR5IGNvbnRhaW5zIHRoZSBzZXJpYWxpemVkIG9iamVjdCBkYXRhCiAgICogcmV0cmlldmVkIGZyb20gdGhlIHNlcnZpY2UgcmVxdWVzdC4gRm9yIGluc3RhbmNlLCBmb3IgYW4KICAgKiBBbWF6b24gRHluYW1vREIgYGxpc3RUYWJsZXNgIG1ldGhvZCBjYWxsLCB0aGUgcmVzcG9uc2UgZGF0YSBtaWdodAogICAqIGxvb2sgbGlrZToKICAgKgogICAqIGBgYAogICAqID4gcmVzcC5kYXRhCiAgICogeyBUYWJsZU5hbWVzOgogICAqICAgIFsgJ3RhYmxlMScsICd0YWJsZTInLCAuLi4gXSB9CiAgICogYGBgCiAgICoKICAgKiBUaGUgYGRhdGFgIHByb3BlcnR5IGNhbiBiZSBudWxsIGlmIGFuIGVycm9yIG9jY3VycyAoc2VlIGJlbG93KS4KICAgKgogICAqICMjIFRoZSBgZXJyb3JgIHByb3BlcnR5CiAgICoKICAgKiBJbiB0aGUgZXZlbnQgb2YgYSBzZXJ2aWNlIGVycm9yIChvciB0cmFuc2ZlciBlcnJvciksIHRoZQogICAqIGByZXNwb25zZS5lcnJvcmAgcHJvcGVydHkgd2lsbCBiZSBmaWxsZWQgd2l0aCB0aGUgZ2l2ZW4KICAgKiBlcnJvciBkYXRhIGluIHRoZSBmb3JtOgogICAqCiAgICogYGBgCiAgICogeyBjb2RlOiAnU0hPUlRfVU5JUVVFX0VSUk9SX0NPREUnLAogICAqICAgbWVzc2FnZTogJ1NvbWUgaHVtYW4gcmVhZGFibGUgZXJyb3IgbWVzc2FnZScgfQogICAqIGBgYAogICAqCiAgICogSW4gdGhlIGNhc2Ugb2YgYW4gZXJyb3IsIHRoZSBgZGF0YWAgcHJvcGVydHkgd2lsbCBiZSBgbnVsbGAuCiAgICogTm90ZSB0aGF0IGlmIHlvdSBoYW5kbGUgZXZlbnRzIHRoYXQgY2FuIGJlIGluIGEgZmFpbHVyZSBzdGF0ZSwKICAgKiB5b3Ugc2hvdWxkIGFsd2F5cyBjaGVjayB3aGV0aGVyIGByZXNwb25zZS5lcnJvcmAgaXMgc2V0CiAgICogYmVmb3JlIGF0dGVtcHRpbmcgdG8gYWNjZXNzIHRoZSBgcmVzcG9uc2UuZGF0YWAgcHJvcGVydHkuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBkYXRhCiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgRGF0YSBQcm9wZXJ0aWVzCiAgICogICBAbm90ZSBJbnNpZGUgb2YgYSB7QVdTLlJlcXVlc3R+aHR0cERhdGF9IGV2ZW50LCB0aGlzCiAgICogICAgIHByb3BlcnR5IGNvbnRhaW5zIGEgc2luZ2xlIHJhdyBwYWNrZXQgaW5zdGVhZCBvZiB0aGUKICAgKiAgICAgZnVsbCBkZS1zZXJpYWxpemVkIHNlcnZpY2UgcmVzcG9uc2UuCiAgICogICBAcmV0dXJuIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIHJlc3BvbnNlIGRhdGEKICAgKiAgICAgZnJvbSB0aGUgc2VydmljZS4KICAgKgogICAqIEAhYXR0cmlidXRlIGVycm9yCiAgICogICBBbiBzdHJ1Y3R1cmUgY29udGFpbmluZyBpbmZvcm1hdGlvbiBhYm91dCBhIHNlcnZpY2UKICAgKiAgIG9yIG5ldHdvcmtpbmcgZXJyb3IuCiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgRGF0YSBQcm9wZXJ0aWVzCiAgICogICBAbm90ZSBUaGlzIGF0dHJpYnV0ZSBpcyBvbmx5IGZpbGxlZCBpZiBhIHNlcnZpY2Ugb3IKICAgKiAgICAgbmV0d29ya2luZyBlcnJvciBvY2N1cnMuCiAgICogICBAcmV0dXJuIFtFcnJvcl0KICAgKiAgICAgKiBjb2RlIFtTdHJpbmddIGEgdW5pcXVlIHNob3J0IGNvZGUgcmVwcmVzZW50aW5nIHRoZQogICAqICAgICAgIGVycm9yIHRoYXQgd2FzIGVtaXR0ZWQuCiAgICogICAgICogbWVzc2FnZSBbU3RyaW5nXSBhIGxvbmdlciBodW1hbiByZWFkYWJsZSBlcnJvciBtZXNzYWdlCiAgICogICAgICogcmV0cnlhYmxlIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBlcnJvciBtZXNzYWdlIGlzCiAgICogICAgICAgcmV0cnlhYmxlLgogICAqICAgICAqIHN0YXR1c0NvZGUgW051bWVyaWNdIGluIHRoZSBjYXNlIG9mIGEgcmVxdWVzdCB0aGF0IHJlYWNoZWQgdGhlIHNlcnZpY2UsCiAgICogICAgICAgdGhpcyB2YWx1ZSBjb250YWlucyB0aGUgcmVzcG9uc2Ugc3RhdHVzIGNvZGUuCiAgICogICAgICogdGltZSBbRGF0ZV0gdGhlIGRhdGUgdGltZSBvYmplY3Qgd2hlbiB0aGUgZXJyb3Igb2NjdXJyZWQuCiAgICogICAgICogaG9zdG5hbWUgW1N0cmluZ10gc2V0IHdoZW4gYSBuZXR3b3JraW5nIGVycm9yIG9jY3VycyB0byBlYXNpbHkKICAgKiAgICAgICBpZGVudGlmeSB0aGUgZW5kcG9pbnQgb2YgdGhlIHJlcXVlc3QuCiAgICogICAgICogcmVnaW9uIFtTdHJpbmddIHNldCB3aGVuIGEgbmV0d29ya2luZyBlcnJvciBvY2N1cnMgdG8gZWFzaWx5CiAgICogICAgICAgaWRlbnRpZnkgdGhlIHJlZ2lvbiBvZiB0aGUgcmVxdWVzdC4KICAgKgogICAqIEAhYXR0cmlidXRlIHJlcXVlc3RJZAogICAqICAgQHJlYWRvbmx5CiAgICogICBAIWdyb3VwIERhdGEgUHJvcGVydGllcwogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgdW5pcXVlIHJlcXVlc3QgSUQgYXNzb2NpYXRlZCB3aXRoIHRoZSByZXNwb25zZS4KICAgKiAgICAgTG9nIHRoaXMgdmFsdWUgd2hlbiBkZWJ1Z2dpbmcgcmVxdWVzdHMgZm9yIEFXUyBzdXBwb3J0LgogICAqCiAgICogQCFhdHRyaWJ1dGUgcmV0cnlDb3VudAogICAqICAgQHJlYWRvbmx5CiAgICogICBAIWdyb3VwIE9wZXJhdGlvbiBQcm9wZXJ0aWVzCiAgICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbnVtYmVyIG9mIHJldHJpZXMgdGhhdCB3ZXJlCiAgICogICAgIGF0dGVtcHRlZCBiZWZvcmUgdGhlIHJlcXVlc3Qgd2FzIGNvbXBsZXRlZC4KICAgKgogICAqIEAhYXR0cmlidXRlIHJlZGlyZWN0Q291bnQKICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBPcGVyYXRpb24gUHJvcGVydGllcwogICAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIG51bWJlciBvZiByZWRpcmVjdHMgdGhhdCB3ZXJlCiAgICogICAgIGZvbGxvd2VkIGJlZm9yZSB0aGUgcmVxdWVzdCB3YXMgY29tcGxldGVkLgogICAqCiAgICogQCFhdHRyaWJ1dGUgaHR0cFJlc3BvbnNlCiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgSFRUUCBQcm9wZXJ0aWVzCiAgICogICBAcmV0dXJuIFtBV1MuSHR0cFJlc3BvbnNlXSB0aGUgcmF3IEhUVFAgcmVzcG9uc2Ugb2JqZWN0CiAgICogICAgIGNvbnRhaW5pbmcgdGhlIHJlc3BvbnNlIGhlYWRlcnMgYW5kIGJvZHkgaW5mb3JtYXRpb24KICAgKiAgICAgZnJvbSB0aGUgc2VydmVyLgogICAqCiAgICogQHNlZSBBV1MuUmVxdWVzdAogICAqLwogIEFXUy5SZXNwb25zZSA9IGluaGVyaXQoewogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFJlc3BvbnNlKHJlcXVlc3QpIHsKICAgICAgdGhpcy5yZXF1ZXN0ID0gcmVxdWVzdDsKICAgICAgdGhpcy5kYXRhID0gbnVsbDsKICAgICAgdGhpcy5lcnJvciA9IG51bGw7CiAgICAgIHRoaXMucmV0cnlDb3VudCA9IDA7CiAgICAgIHRoaXMucmVkaXJlY3RDb3VudCA9IDA7CiAgICAgIHRoaXMuaHR0cFJlc3BvbnNlID0gbmV3IEFXUy5IdHRwUmVzcG9uc2UoKTsKICAgICAgaWYgKHJlcXVlc3QpIHsKICAgICAgICB0aGlzLm1heFJldHJpZXMgPSByZXF1ZXN0LnNlcnZpY2UubnVtUmV0cmllcygpOwogICAgICAgIHRoaXMubWF4UmVkaXJlY3RzID0gcmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5tYXhSZWRpcmVjdHM7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgcmVxdWVzdCBmb3IgdGhlIG5leHQgcGFnZSBvZiByZXNwb25zZSBkYXRhLCBjYWxsaW5nIHRoZQogICAgICogY2FsbGJhY2sgd2l0aCB0aGUgcGFnZSBkYXRhIGlmIGEgY2FsbGJhY2sgaXMgcHJvdmlkZWQuCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgICAqICAgQ2FsbGVkIHdoZW4gYSBwYWdlIG9mIGRhdGEgaXMgcmV0dXJuZWQgZnJvbSB0aGUgbmV4dCByZXF1ZXN0LgogICAgICoKICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGFuIGVycm9yIG9iamVjdCwgaWYgYW4gZXJyb3Igb2NjdXJyZWQgaW4gdGhlIHJlcXVlc3QKICAgICAqICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIG5leHQgcGFnZSBvZiBkYXRhLCBvciBudWxsLCBpZiB0aGVyZSBhcmUgbm8KICAgICAqICAgICBtb3JlIHBhZ2VzIGxlZnQuCiAgICAgKiBAcmV0dXJuIFtBV1MuUmVxdWVzdF0gdGhlIHJlcXVlc3Qgb2JqZWN0IGZvciB0aGUgbmV4dCBwYWdlIG9mIGRhdGEKICAgICAqIEByZXR1cm4gW251bGxdIGlmIG5vIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGFuZCB0aGVyZSBhcmUgbm8gcGFnZXMgbGVmdAogICAgICogICB0byByZXRyaWV2ZS4KICAgICAqIEBzaW5jZSB2MS40LjAKICAgICAqLwogICAgbmV4dFBhZ2U6IGZ1bmN0aW9uIG5leHRQYWdlKGNhbGxiYWNrKSB7CiAgICAgIHZhciBjb25maWc7CiAgICAgIHZhciBzZXJ2aWNlID0gdGhpcy5yZXF1ZXN0LnNlcnZpY2U7CiAgICAgIHZhciBvcGVyYXRpb24gPSB0aGlzLnJlcXVlc3Qub3BlcmF0aW9uOwogICAgICB0cnkgewogICAgICAgIGNvbmZpZyA9IHNlcnZpY2UucGFnaW5hdGlvbkNvbmZpZyhvcGVyYXRpb24sIHRydWUpOwogICAgICB9IGNhdGNoIChlKSB7IHRoaXMuZXJyb3IgPSBlOyB9CiAgCiAgICAgIGlmICghdGhpcy5oYXNOZXh0UGFnZSgpKSB7CiAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayh0aGlzLmVycm9yLCBudWxsKTsKICAgICAgICBlbHNlIGlmICh0aGlzLmVycm9yKSB0aHJvdyB0aGlzLmVycm9yOwogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgCiAgICAgIHZhciBwYXJhbXMgPSBBV1MudXRpbC5jb3B5KHRoaXMucmVxdWVzdC5wYXJhbXMpOwogICAgICBpZiAoIXRoaXMubmV4dFBhZ2VUb2tlbnMpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2sgPyBjYWxsYmFjayhudWxsLCBudWxsKSA6IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGlucHV0VG9rZW5zID0gY29uZmlnLmlucHV0VG9rZW47CiAgICAgICAgaWYgKHR5cGVvZiBpbnB1dFRva2VucyA9PT0gJ3N0cmluZycpIGlucHV0VG9rZW5zID0gW2lucHV0VG9rZW5zXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGlucHV0VG9rZW5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBwYXJhbXNbaW5wdXRUb2tlbnNbaV1dID0gdGhpcy5uZXh0UGFnZVRva2Vuc1tpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNlcnZpY2UubWFrZVJlcXVlc3QodGhpcy5yZXF1ZXN0Lm9wZXJhdGlvbiwgcGFyYW1zLCBjYWxsYmFjayk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgbW9yZSBwYWdlcyBvZiBkYXRhIGNhbiBiZSByZXR1cm5lZCBieSBmdXJ0aGVyCiAgICAgKiAgIHJlcXVlc3RzCiAgICAgKiBAc2luY2UgdjEuNC4wCiAgICAgKi8KICAgIGhhc05leHRQYWdlOiBmdW5jdGlvbiBoYXNOZXh0UGFnZSgpIHsKICAgICAgdGhpcy5jYWNoZU5leHRQYWdlVG9rZW5zKCk7CiAgICAgIGlmICh0aGlzLm5leHRQYWdlVG9rZW5zKSByZXR1cm4gdHJ1ZTsKICAgICAgaWYgKHRoaXMubmV4dFBhZ2VUb2tlbnMgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgZWxzZSByZXR1cm4gZmFsc2U7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY2FjaGVOZXh0UGFnZVRva2VuczogZnVuY3Rpb24gY2FjaGVOZXh0UGFnZVRva2VucygpIHsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLCAnbmV4dFBhZ2VUb2tlbnMnKSkgcmV0dXJuIHRoaXMubmV4dFBhZ2VUb2tlbnM7CiAgICAgIHRoaXMubmV4dFBhZ2VUb2tlbnMgPSB1bmRlZmluZWQ7CiAgCiAgICAgIHZhciBjb25maWcgPSB0aGlzLnJlcXVlc3Quc2VydmljZS5wYWdpbmF0aW9uQ29uZmlnKHRoaXMucmVxdWVzdC5vcGVyYXRpb24pOwogICAgICBpZiAoIWNvbmZpZykgcmV0dXJuIHRoaXMubmV4dFBhZ2VUb2tlbnM7CiAgCiAgICAgIHRoaXMubmV4dFBhZ2VUb2tlbnMgPSBudWxsOwogICAgICBpZiAoY29uZmlnLm1vcmVSZXN1bHRzKSB7CiAgICAgICAgaWYgKCFqbWVzcGF0aC5zZWFyY2godGhpcy5kYXRhLCBjb25maWcubW9yZVJlc3VsdHMpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5uZXh0UGFnZVRva2VuczsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgdmFyIGV4cHJzID0gY29uZmlnLm91dHB1dFRva2VuOwogICAgICBpZiAodHlwZW9mIGV4cHJzID09PSAnc3RyaW5nJykgZXhwcnMgPSBbZXhwcnNdOwogICAgICBBV1MudXRpbC5hcnJheUVhY2guY2FsbCh0aGlzLCBleHBycywgZnVuY3Rpb24gKGV4cHIpIHsKICAgICAgICB2YXIgb3V0cHV0ID0gam1lc3BhdGguc2VhcmNoKHRoaXMuZGF0YSwgZXhwcik7CiAgICAgICAgaWYgKG91dHB1dCkgewogICAgICAgICAgdGhpcy5uZXh0UGFnZVRva2VucyA9IHRoaXMubmV4dFBhZ2VUb2tlbnMgfHwgW107CiAgICAgICAgICB0aGlzLm5leHRQYWdlVG9rZW5zLnB1c2gob3V0cHV0KTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICByZXR1cm4gdGhpcy5uZXh0UGFnZVRva2VuczsKICAgIH0KICAKICB9KTsKICAKICB9LHsiLi9jb3JlIjoxOCwiam1lc3BhdGgiOjg0fV0sNTg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAIW1ldGhvZCBvbihldmVudE5hbWUsIGNhbGxiYWNrKQogICAqICAgUmVnaXN0ZXJzIGFuIGV2ZW50IGxpc3RlbmVyIGNhbGxiYWNrIGZvciB0aGUgZXZlbnQgZ2l2ZW4gYnkgYGV2ZW50TmFtZWAuCiAgICogICBQYXJhbWV0ZXJzIHBhc3NlZCB0byB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gZGVwZW5kIG9uIHRoZSBpbmRpdmlkdWFsIGV2ZW50CiAgICogICBiZWluZyB0cmlnZ2VyZWQuIFNlZSB0aGUgZXZlbnQgZG9jdW1lbnRhdGlvbiBmb3IgdGhvc2UgcGFyYW1ldGVycy4KICAgKgogICAqICAgQHBhcmFtIGV2ZW50TmFtZSBbU3RyaW5nXSB0aGUgZXZlbnQgbmFtZSB0byByZWdpc3RlciB0aGUgbGlzdGVuZXIgZm9yCiAgICogICBAcGFyYW0gY2FsbGJhY2sgW0Z1bmN0aW9uXSB0aGUgbGlzdGVuZXIgY2FsbGJhY2sgZnVuY3Rpb24KICAgKiAgIEBwYXJhbSB0b0hlYWQgW0Jvb2xlYW5dIGF0dGFjaCB0aGUgbGlzdGVuZXIgY2FsbGJhY2sgdG8gdGhlIGhlYWQgb2YgY2FsbGJhY2sgYXJyYXkgaWYgc2V0IHRvIHRydWUuCiAgICogICAgIERlZmF1bHQgdG8gYmUgZmFsc2UuCiAgICogICBAcmV0dXJuIFtBV1MuU2VxdWVudGlhbEV4ZWN1dG9yXSB0aGUgc2FtZSBvYmplY3QgZm9yIGNoYWluaW5nCiAgICovCiAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvciA9IEFXUy51dGlsLmluaGVyaXQoewogIAogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFNlcXVlbnRpYWxFeGVjdXRvcigpIHsKICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbGlzdGVuZXJzOiBmdW5jdGlvbiBsaXN0ZW5lcnMoZXZlbnROYW1lKSB7CiAgICAgIHJldHVybiB0aGlzLl9ldmVudHNbZXZlbnROYW1lXSA/IHRoaXMuX2V2ZW50c1tldmVudE5hbWVdLnNsaWNlKDApIDogW107CiAgICB9LAogIAogICAgb246IGZ1bmN0aW9uIG9uKGV2ZW50TmFtZSwgbGlzdGVuZXIsIHRvSGVhZCkgewogICAgICBpZiAodGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0pIHsKICAgICAgICB0b0hlYWQgPwogICAgICAgICAgdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0udW5zaGlmdChsaXN0ZW5lcikgOgogICAgICAgICAgdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0ucHVzaChsaXN0ZW5lcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0gPSBbbGlzdGVuZXJdOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIG9uQXN5bmM6IGZ1bmN0aW9uIG9uQXN5bmMoZXZlbnROYW1lLCBsaXN0ZW5lciwgdG9IZWFkKSB7CiAgICAgIGxpc3RlbmVyLl9pc0FzeW5jID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXMub24oZXZlbnROYW1lLCBsaXN0ZW5lciwgdG9IZWFkKTsKICAgIH0sCiAgCiAgICByZW1vdmVMaXN0ZW5lcjogZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXIoZXZlbnROYW1lLCBsaXN0ZW5lcikgewogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV07CiAgICAgIGlmIChsaXN0ZW5lcnMpIHsKICAgICAgICB2YXIgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aDsKICAgICAgICB2YXIgcG9zaXRpb24gPSAtMTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBpZiAobGlzdGVuZXJzW2ldID09PSBsaXN0ZW5lcikgewogICAgICAgICAgICBwb3NpdGlvbiA9IGk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChwb3NpdGlvbiA+IC0xKSB7CiAgICAgICAgICBsaXN0ZW5lcnMuc3BsaWNlKHBvc2l0aW9uLCAxKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgcmVtb3ZlQWxsTGlzdGVuZXJzOiBmdW5jdGlvbiByZW1vdmVBbGxMaXN0ZW5lcnMoZXZlbnROYW1lKSB7CiAgICAgIGlmIChldmVudE5hbWUpIHsKICAgICAgICBkZWxldGUgdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZW1pdDogZnVuY3Rpb24gZW1pdChldmVudE5hbWUsIGV2ZW50QXJncywgZG9uZUNhbGxiYWNrKSB7CiAgICAgIGlmICghZG9uZUNhbGxiYWNrKSBkb25lQ2FsbGJhY2sgPSBmdW5jdGlvbigpIHsgfTsKICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMubGlzdGVuZXJzKGV2ZW50TmFtZSk7CiAgICAgIHZhciBjb3VudCA9IGxpc3RlbmVycy5sZW5ndGg7CiAgICAgIHRoaXMuY2FsbExpc3RlbmVycyhsaXN0ZW5lcnMsIGV2ZW50QXJncywgZG9uZUNhbGxiYWNrKTsKICAgICAgcmV0dXJuIGNvdW50ID4gMDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjYWxsTGlzdGVuZXJzOiBmdW5jdGlvbiBjYWxsTGlzdGVuZXJzKGxpc3RlbmVycywgYXJncywgZG9uZUNhbGxiYWNrLCBwcmV2RXJyb3IpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgZXJyb3IgPSBwcmV2RXJyb3IgfHwgbnVsbDsKICAKICAgICAgZnVuY3Rpb24gY2FsbE5leHRMaXN0ZW5lcihlcnIpIHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICBlcnJvciA9IEFXUy51dGlsLmVycm9yKGVycm9yIHx8IG5ldyBFcnJvcigpLCBlcnIpOwogICAgICAgICAgaWYgKHNlbGYuX2hhbHRIYW5kbGVyc09uRXJyb3IpIHsKICAgICAgICAgICAgcmV0dXJuIGRvbmVDYWxsYmFjay5jYWxsKHNlbGYsIGVycm9yKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc2VsZi5jYWxsTGlzdGVuZXJzKGxpc3RlbmVycywgYXJncywgZG9uZUNhbGxiYWNrLCBlcnJvcik7CiAgICAgIH0KICAKICAgICAgd2hpbGUgKGxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgdmFyIGxpc3RlbmVyID0gbGlzdGVuZXJzLnNoaWZ0KCk7CiAgICAgICAgaWYgKGxpc3RlbmVyLl9pc0FzeW5jKSB7IC8vIGFzeW5jaHJvbm91cyBsaXN0ZW5lcgogICAgICAgICAgbGlzdGVuZXIuYXBwbHkoc2VsZiwgYXJncy5jb25jYXQoW2NhbGxOZXh0TGlzdGVuZXJdKSk7CiAgICAgICAgICByZXR1cm47IC8vIHN0b3AgaGVyZSwgY2FsbE5leHRMaXN0ZW5lciB3aWxsIGNvbnRpbnVlCiAgICAgICAgfSBlbHNlIHsgLy8gc3luY2hyb25vdXMgbGlzdGVuZXIKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGxpc3RlbmVyLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGVycm9yID0gQVdTLnV0aWwuZXJyb3IoZXJyb3IgfHwgbmV3IEVycm9yKCksIGVycik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXJyb3IgJiYgc2VsZi5faGFsdEhhbmRsZXJzT25FcnJvcikgewogICAgICAgICAgICBkb25lQ2FsbGJhY2suY2FsbChzZWxmLCBlcnJvcik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZG9uZUNhbGxiYWNrLmNhbGwoc2VsZiwgZXJyb3IpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQWRkcyBvciBjb3BpZXMgYSBzZXQgb2YgbGlzdGVuZXJzIGZyb20gYW5vdGhlciBsaXN0IG9mCiAgICAgKiBsaXN0ZW5lcnMgb3IgU2VxdWVudGlhbEV4ZWN1dG9yIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0gbGlzdGVuZXJzIFttYXA8U3RyaW5nLEFycmF5PEZ1bmN0aW9uPj4sIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3JdCiAgICAgKiAgIGEgbGlzdCBvZiBldmVudHMgYW5kIGNhbGxiYWNrcywgb3IgYW4gZXZlbnQgZW1pdHRlciBvYmplY3QKICAgICAqICAgY29udGFpbmluZyBsaXN0ZW5lcnMgdG8gYWRkIHRvIHRoaXMgZW1pdHRlciBvYmplY3QuCiAgICAgKiBAcmV0dXJuIFtBV1MuU2VxdWVudGlhbEV4ZWN1dG9yXSB0aGUgZW1pdHRlciBvYmplY3QsIGZvciBjaGFpbmluZy4KICAgICAqIEBleGFtcGxlIEFkZGluZyBsaXN0ZW5lcnMgZnJvbSBhIG1hcCBvZiBsaXN0ZW5lcnMKICAgICAqICAgZW1pdHRlci5hZGRMaXN0ZW5lcnMoewogICAgICogICAgIGV2ZW50MTogW2Z1bmN0aW9uKCkgeyAuLi4gfSwgZnVuY3Rpb24oKSB7IC4uLiB9XSwKICAgICAqICAgICBldmVudDI6IFtmdW5jdGlvbigpIHsgLi4uIH1dCiAgICAgKiAgIH0pOwogICAgICogICBlbWl0dGVyLmVtaXQoJ2V2ZW50MScpOyAvLyBlbWl0dGVyIGhhcyBldmVudDEKICAgICAqICAgZW1pdHRlci5lbWl0KCdldmVudDInKTsgLy8gZW1pdHRlciBoYXMgZXZlbnQyCiAgICAgKiBAZXhhbXBsZSBBZGRpbmcgbGlzdGVuZXJzIGZyb20gYW5vdGhlciBlbWl0dGVyIG9iamVjdAogICAgICogICB2YXIgZW1pdHRlcjEgPSBuZXcgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcigpOwogICAgICogICBlbWl0dGVyMS5vbignZXZlbnQxJywgZnVuY3Rpb24oKSB7IC4uLiB9KTsKICAgICAqICAgZW1pdHRlcjEub24oJ2V2ZW50MicsIGZ1bmN0aW9uKCkgeyAuLi4gfSk7CiAgICAgKiAgIHZhciBlbWl0dGVyMiA9IG5ldyBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKCk7CiAgICAgKiAgIGVtaXR0ZXIyLmFkZExpc3RlbmVycyhlbWl0dGVyMSk7CiAgICAgKiAgIGVtaXR0ZXIyLmVtaXQoJ2V2ZW50MScpOyAvLyBlbWl0dGVyMiBoYXMgZXZlbnQxCiAgICAgKiAgIGVtaXR0ZXIyLmVtaXQoJ2V2ZW50MicpOyAvLyBlbWl0dGVyMiBoYXMgZXZlbnQyCiAgICAgKi8KICAgIGFkZExpc3RlbmVyczogZnVuY3Rpb24gYWRkTGlzdGVuZXJzKGxpc3RlbmVycykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgCiAgICAgIC8vIGV4dHJhY3QgbGlzdGVuZXJzIGlmIHBhcmFtZXRlciBpcyBhbiBTZXF1ZW50aWFsRXhlY3V0b3Igb2JqZWN0CiAgICAgIGlmIChsaXN0ZW5lcnMuX2V2ZW50cykgbGlzdGVuZXJzID0gbGlzdGVuZXJzLl9ldmVudHM7CiAgCiAgICAgIEFXUy51dGlsLmVhY2gobGlzdGVuZXJzLCBmdW5jdGlvbihldmVudCwgY2FsbGJhY2tzKSB7CiAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFja3MgPT09ICdmdW5jdGlvbicpIGNhbGxiYWNrcyA9IFtjYWxsYmFja3NdOwogICAgICAgIEFXUy51dGlsLmFycmF5RWFjaChjYWxsYmFja3MsIGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICBzZWxmLm9uKGV2ZW50LCBjYWxsYmFjayk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogIAogICAgICByZXR1cm4gc2VsZjsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFJlZ2lzdGVycyBhbiBldmVudCB3aXRoIHtvbn0gYW5kIHNhdmVzIHRoZSBjYWxsYmFjayBoYW5kbGUgZnVuY3Rpb24KICAgICAqIGFzIGEgcHJvcGVydHkgb24gdGhlIGVtaXR0ZXIgb2JqZWN0IHVzaW5nIGEgZ2l2ZW4gYG5hbWVgLgogICAgICoKICAgICAqIEBwYXJhbSBuYW1lIFtTdHJpbmddIHRoZSBwcm9wZXJ0eSBuYW1lIHRvIHNldCBvbiB0aGlzIG9iamVjdCBjb250YWluaW5nCiAgICAgKiAgIHRoZSBjYWxsYmFjayBmdW5jdGlvbiBoYW5kbGUgc28gdGhhdCB0aGUgbGlzdGVuZXIgY2FuIGJlIHJlbW92ZWQgaW4KICAgICAqICAgdGhlIGZ1dHVyZS4KICAgICAqIEBwYXJhbSAoc2VlIG9uKQogICAgICogQHJldHVybiAoc2VlIG9uKQogICAgICogQGV4YW1wbGUgQWRkaW5nIGEgbmFtZWQgbGlzdGVuZXIgREFUQV9DQUxMQkFDSwogICAgICogICB2YXIgbGlzdGVuZXIgPSBmdW5jdGlvbigpIHsgZG9Tb21ldGhpbmcoKTsgfTsKICAgICAqICAgZW1pdHRlci5hZGROYW1lZExpc3RlbmVyKCdEQVRBX0NBTExCQUNLJywgJ2RhdGEnLCBsaXN0ZW5lcik7CiAgICAgKgogICAgICogICAvLyB0aGUgZm9sbG93aW5nIHByaW50czogdHJ1ZQogICAgICogICBjb25zb2xlLmxvZyhlbWl0dGVyLkRBVEFfQ0FMTEJBQ0sgPT0gbGlzdGVuZXIpOwogICAgICovCiAgICBhZGROYW1lZExpc3RlbmVyOiBmdW5jdGlvbiBhZGROYW1lZExpc3RlbmVyKG5hbWUsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIHRvSGVhZCkgewogICAgICB0aGlzW25hbWVdID0gY2FsbGJhY2s7CiAgICAgIHRoaXMuYWRkTGlzdGVuZXIoZXZlbnROYW1lLCBjYWxsYmFjaywgdG9IZWFkKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYWRkTmFtZWRBc3luY0xpc3RlbmVyOiBmdW5jdGlvbiBhZGROYW1lZEFzeW5jTGlzdGVuZXIobmFtZSwgZXZlbnROYW1lLCBjYWxsYmFjaywgdG9IZWFkKSB7CiAgICAgIGNhbGxiYWNrLl9pc0FzeW5jID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXMuYWRkTmFtZWRMaXN0ZW5lcihuYW1lLCBldmVudE5hbWUsIGNhbGxiYWNrLCB0b0hlYWQpOwogICAgfSwKICAKICAgIC8qKgogICAgICogSGVscGVyIG1ldGhvZCB0byBhZGQgYSBzZXQgb2YgbmFtZWQgbGlzdGVuZXJzIHVzaW5nCiAgICAgKiB7YWRkTmFtZWRMaXN0ZW5lcn0uIFRoZSBjYWxsYmFjayBjb250YWlucyBhIHBhcmFtZXRlcgogICAgICogd2l0aCBhIGhhbmRsZSB0byB0aGUgYGFkZE5hbWVkTGlzdGVuZXJgIG1ldGhvZC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oYWRkKQogICAgICogICBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gaXMgY2FsbGVkIGltbWVkaWF0ZWx5IGluIG9yZGVyIHRvIHByb3ZpZGUKICAgICAqICAgdGhlIGBhZGRgIGZ1bmN0aW9uIHRvIHRoZSBibG9jay4gVGhpcyBzaW1wbGlmaWVzIHRoZSBhZGRpdGlvbiBvZgogICAgICogICBhIGxhcmdlIGdyb3VwIG9mIG5hbWVkIGxpc3RlbmVycy4KICAgICAqICAgQHBhcmFtIGFkZCBbRnVuY3Rpb25dIHRoZSB7YWRkTmFtZWRMaXN0ZW5lcn0gZnVuY3Rpb24gdG8gY2FsbAogICAgICogICAgIHdoZW4gcmVnaXN0ZXJpbmcgbGlzdGVuZXJzLgogICAgICogQGV4YW1wbGUgQWRkaW5nIGEgc2V0IG9mIG5hbWVkIGxpc3RlbmVycwogICAgICogICBlbWl0dGVyLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICogICAgIGFkZCgnREFUQV9DQUxMQkFDSycsICdkYXRhJywgZnVuY3Rpb24oKSB7IC4uLiB9KTsKICAgICAqICAgICBhZGQoJ09USEVSJywgJ290aGVyRXZlbnQnLCBmdW5jdGlvbigpIHsgLi4uIH0pOwogICAgICogICAgIGFkZCgnTEFTVCcsICdsYXN0RXZlbnQnLCBmdW5jdGlvbigpIHsgLi4uIH0pOwogICAgICogICB9KTsKICAgICAqCiAgICAgKiAgIC8vIHRoZXNlIHByb3BlcnRpZXMgYXJlIG5vdyBzZXQ6CiAgICAgKiAgIGVtaXR0ZXIuREFUQV9DQUxMQkFDSzsKICAgICAqICAgZW1pdHRlci5PVEhFUjsKICAgICAqICAgZW1pdHRlci5MQVNUOwogICAgICovCiAgICBhZGROYW1lZExpc3RlbmVyczogZnVuY3Rpb24gYWRkTmFtZWRMaXN0ZW5lcnMoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBjYWxsYmFjaygKICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgIHNlbGYuYWRkTmFtZWRMaXN0ZW5lci5hcHBseShzZWxmLCBhcmd1bWVudHMpOwogICAgICAgIH0sCiAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICBzZWxmLmFkZE5hbWVkQXN5bmNMaXN0ZW5lci5hcHBseShzZWxmLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICoge29ufSBpcyB0aGUgcHJlZmVyZWQgbWV0aG9kLgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IucHJvdG90eXBlLmFkZExpc3RlbmVyID0gQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5wcm90b3R5cGUub247CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yOwogIAogIH0seyIuL2NvcmUiOjE4fV0sNTk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAocHJvY2Vzcyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHZhciBBcGkgPSByZXF1aXJlKCcuL21vZGVsL2FwaScpOwogIHZhciByZWdpb25Db25maWcgPSByZXF1aXJlKCcuL3JlZ2lvbl9jb25maWcnKTsKICAKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgdmFyIGNsaWVudENvdW50ID0gMDsKICAKICAvKioKICAgKiBUaGUgc2VydmljZSBjbGFzcyByZXByZXNlbnRpbmcgYW4gQVdTIHNlcnZpY2UuCiAgICoKICAgKiBAY2xhc3NfYWJzdHJhY3QgVGhpcyBjbGFzcyBpcyBhbiBhYnN0cmFjdCBjbGFzcy4KICAgKgogICAqIEAhYXR0cmlidXRlIGFwaVZlcnNpb25zCiAgICogICBAcmV0dXJuIFtBcnJheTxTdHJpbmc+XSB0aGUgbGlzdCBvZiBBUEkgdmVyc2lvbnMgc3VwcG9ydGVkIGJ5IHRoaXMgc2VydmljZS4KICAgKiAgIEByZWFkb25seQogICAqLwogIEFXUy5TZXJ2aWNlID0gaW5oZXJpdCh7CiAgICAvKioKICAgICAqIENyZWF0ZSBhIG5ldyBzZXJ2aWNlIG9iamVjdCB3aXRoIGEgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAqCiAgICAgKiBAcGFyYW0gY29uZmlnIFttYXBdIGEgbWFwIG9mIGNvbmZpZ3VyYXRpb24gb3B0aW9ucwogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gU2VydmljZShjb25maWcpIHsKICAgICAgaWYgKCF0aGlzLmxvYWRTZXJ2aWNlQ2xhc3MpIHsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgICdTZXJ2aWNlIG11c3QgYmUgY29uc3RydWN0ZWQgd2l0aCBgbmV3XCcgb3BlcmF0b3InKTsKICAgICAgfQogICAgICB2YXIgU2VydmljZUNsYXNzID0gdGhpcy5sb2FkU2VydmljZUNsYXNzKGNvbmZpZyB8fCB7fSk7CiAgICAgIGlmIChTZXJ2aWNlQ2xhc3MpIHsKICAgICAgICB2YXIgb3JpZ2luYWxDb25maWcgPSBBV1MudXRpbC5jb3B5KGNvbmZpZyk7CiAgICAgICAgdmFyIHN2YyA9IG5ldyBTZXJ2aWNlQ2xhc3MoY29uZmlnKTsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoc3ZjLCAnX29yaWdpbmFsQ29uZmlnJywgewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIG9yaWdpbmFsQ29uZmlnOyB9LAogICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICB9KTsKICAgICAgICBzdmMuX2NsaWVudElkID0gKytjbGllbnRDb3VudDsKICAgICAgICByZXR1cm4gc3ZjOwogICAgICB9CiAgICAgIHRoaXMuaW5pdGlhbGl6ZShjb25maWcpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIGluaXRpYWxpemUoY29uZmlnKSB7CiAgICAgIHZhciBzdmNDb25maWcgPSBBV1MuY29uZmlnW3RoaXMuc2VydmljZUlkZW50aWZpZXJdOwogICAgICB0aGlzLmNvbmZpZyA9IG5ldyBBV1MuQ29uZmlnKEFXUy5jb25maWcpOwogICAgICBpZiAoc3ZjQ29uZmlnKSB0aGlzLmNvbmZpZy51cGRhdGUoc3ZjQ29uZmlnLCB0cnVlKTsKICAgICAgaWYgKGNvbmZpZykgdGhpcy5jb25maWcudXBkYXRlKGNvbmZpZywgdHJ1ZSk7CiAgCiAgICAgIHRoaXMudmFsaWRhdGVTZXJ2aWNlKCk7CiAgICAgIGlmICghdGhpcy5jb25maWcuZW5kcG9pbnQpIHJlZ2lvbkNvbmZpZyh0aGlzKTsKICAKICAgICAgdGhpcy5jb25maWcuZW5kcG9pbnQgPSB0aGlzLmVuZHBvaW50RnJvbVRlbXBsYXRlKHRoaXMuY29uZmlnLmVuZHBvaW50KTsKICAgICAgdGhpcy5zZXRFbmRwb2ludCh0aGlzLmNvbmZpZy5lbmRwb2ludCk7CiAgICAgIC8vZW5hYmxlIGF0dGFjaGluZyBsaXN0ZW5lcnMgdG8gc2VydmljZSBjbGllbnQKICAgICAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5jYWxsKHRoaXMpOwogICAgICBBV1MuU2VydmljZS5hZGREZWZhdWx0TW9uaXRvcmluZ0xpc3RlbmVycyh0aGlzKTsKICAgICAgaWYgKCh0aGlzLmNvbmZpZy5jbGllbnRTaWRlTW9uaXRvcmluZyB8fCBBV1MuU2VydmljZS5fY2xpZW50U2lkZU1vbml0b3JpbmcpICYmIHRoaXMucHVibGlzaGVyKSB7CiAgICAgICAgdmFyIHB1Ymxpc2hlciA9IHRoaXMucHVibGlzaGVyOwogICAgICAgIHRoaXMuYWRkTmFtZWRMaXN0ZW5lcignUFVCTElTSF9BUElfQ0FMTCcsICdhcGlDYWxsJywgZnVuY3Rpb24gUFVCTElTSF9BUElfQ0FMTChldmVudCkgewogICAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHtwdWJsaXNoZXIuZXZlbnRIYW5kbGVyKGV2ZW50KTt9KTsKICAgICAgICB9KTsKICAgICAgICB0aGlzLmFkZE5hbWVkTGlzdGVuZXIoJ1BVQkxJU0hfQVBJX0FUVEVNUFQnLCAnYXBpQ2FsbEF0dGVtcHQnLCBmdW5jdGlvbiBQVUJMSVNIX0FQSV9BVFRFTVBUKGV2ZW50KSB7CiAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkge3B1Ymxpc2hlci5ldmVudEhhbmRsZXIoZXZlbnQpO30pOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdmFsaWRhdGVTZXJ2aWNlOiBmdW5jdGlvbiB2YWxpZGF0ZVNlcnZpY2UoKSB7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZFNlcnZpY2VDbGFzczogZnVuY3Rpb24gbG9hZFNlcnZpY2VDbGFzcyhzZXJ2aWNlQ29uZmlnKSB7CiAgICAgIHZhciBjb25maWcgPSBzZXJ2aWNlQ29uZmlnOwogICAgICBpZiAoIUFXUy51dGlsLmlzRW1wdHkodGhpcy5hcGkpKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0gZWxzZSBpZiAoY29uZmlnLmFwaUNvbmZpZykgewogICAgICAgIHJldHVybiBBV1MuU2VydmljZS5kZWZpbmVTZXJ2aWNlQXBpKHRoaXMuY29uc3RydWN0b3IsIGNvbmZpZy5hcGlDb25maWcpOwogICAgICB9IGVsc2UgaWYgKCF0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uZmlnID0gbmV3IEFXUy5Db25maWcoQVdTLmNvbmZpZyk7CiAgICAgICAgY29uZmlnLnVwZGF0ZShzZXJ2aWNlQ29uZmlnLCB0cnVlKTsKICAgICAgICB2YXIgdmVyc2lvbiA9IGNvbmZpZy5hcGlWZXJzaW9uc1t0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VJZGVudGlmaWVyXTsKICAgICAgICB2ZXJzaW9uID0gdmVyc2lvbiB8fCBjb25maWcuYXBpVmVyc2lvbjsKICAgICAgICByZXR1cm4gdGhpcy5nZXRMYXRlc3RTZXJ2aWNlQ2xhc3ModmVyc2lvbik7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRMYXRlc3RTZXJ2aWNlQ2xhc3M6IGZ1bmN0aW9uIGdldExhdGVzdFNlcnZpY2VDbGFzcyh2ZXJzaW9uKSB7CiAgICAgIHZlcnNpb24gPSB0aGlzLmdldExhdGVzdFNlcnZpY2VWZXJzaW9uKHZlcnNpb24pOwogICAgICBpZiAodGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlc1t2ZXJzaW9uXSA9PT0gbnVsbCkgewogICAgICAgIEFXUy5TZXJ2aWNlLmRlZmluZVNlcnZpY2VBcGkodGhpcy5jb25zdHJ1Y3RvciwgdmVyc2lvbik7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXNbdmVyc2lvbl07CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0TGF0ZXN0U2VydmljZVZlcnNpb246IGZ1bmN0aW9uIGdldExhdGVzdFNlcnZpY2VWZXJzaW9uKHZlcnNpb24pIHsKICAgICAgaWYgKCF0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzIHx8IHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBzZXJ2aWNlcyBkZWZpbmVkIG9uICcgKwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VJZGVudGlmaWVyKTsKICAgICAgfQogIAogICAgICBpZiAoIXZlcnNpb24pIHsKICAgICAgICB2ZXJzaW9uID0gJ2xhdGVzdCc7CiAgICAgIH0gZWxzZSBpZiAoQVdTLnV0aWwuaXNUeXBlKHZlcnNpb24sIERhdGUpKSB7CiAgICAgICAgdmVyc2lvbiA9IEFXUy51dGlsLmRhdGUuaXNvODYwMSh2ZXJzaW9uKS5zcGxpdCgnVCcpWzBdOwogICAgICB9CiAgCiAgICAgIGlmIChPYmplY3QuaGFzT3duUHJvcGVydHkodGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlcywgdmVyc2lvbikpIHsKICAgICAgICByZXR1cm4gdmVyc2lvbjsKICAgICAgfQogIAogICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXMpLnNvcnQoKTsKICAgICAgdmFyIHNlbGVjdGVkVmVyc2lvbiA9IG51bGw7CiAgICAgIGZvciAodmFyIGkgPSBrZXlzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgLy8gdmVyc2lvbnMgdGhhdCBlbmQgaW4gIioiIGFyZSBub3QgYXZhaWxhYmxlIG9uIGRpc2sgYW5kIGNhbiBiZQogICAgICAgIC8vIHNraXBwZWQsIHNvIGRvIG5vdCBjaG9vc2UgdGhlc2UgYXMgc2VsZWN0ZWRWZXJzaW9ucwogICAgICAgIGlmIChrZXlzW2ldW2tleXNbaV0ubGVuZ3RoIC0gMV0gIT09ICcqJykgewogICAgICAgICAgc2VsZWN0ZWRWZXJzaW9uID0ga2V5c1tpXTsKICAgICAgICB9CiAgICAgICAgaWYgKGtleXNbaV0uc3Vic3RyKDAsIDEwKSA8PSB2ZXJzaW9uKSB7CiAgICAgICAgICByZXR1cm4gc2VsZWN0ZWRWZXJzaW9uOwogICAgICAgIH0KICAgICAgfQogIAogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBmaW5kICcgKyB0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VJZGVudGlmaWVyICsKICAgICAgICAgICAgICAgICAgICAgICcgQVBJIHRvIHNhdGlzZnkgdmVyc2lvbiBjb25zdHJhaW50IGAnICsgdmVyc2lvbiArICdcJycpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwaToge30sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBkZWZhdWx0UmV0cnlDb3VudDogMywKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGN1c3RvbWl6ZVJlcXVlc3RzOiBmdW5jdGlvbiBjdXN0b21pemVSZXF1ZXN0cyhjYWxsYmFjaykgewogICAgICBpZiAoIWNhbGxiYWNrKSB7CiAgICAgICAgdGhpcy5jdXN0b21SZXF1ZXN0SGFuZGxlciA9IG51bGw7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhpcy5jdXN0b21SZXF1ZXN0SGFuZGxlciA9IGNhbGxiYWNrOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBjYWxsYmFjayB0eXBlIFwnJyArIHR5cGVvZiBjYWxsYmFjayArICdcJyBwcm92aWRlZCBpbiBjdXN0b21pemVSZXF1ZXN0cycpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBDYWxscyBhbiBvcGVyYXRpb24gb24gYSBzZXJ2aWNlIHdpdGggdGhlIGdpdmVuIGlucHV0IHBhcmFtZXRlcnMuCiAgICAgKgogICAgICogQHBhcmFtIG9wZXJhdGlvbiBbU3RyaW5nXSB0aGUgbmFtZSBvZiB0aGUgb3BlcmF0aW9uIHRvIGNhbGwgb24gdGhlIHNlcnZpY2UuCiAgICAgKiBAcGFyYW0gcGFyYW1zIFttYXBdIGEgbWFwIG9mIGlucHV0IG9wdGlvbnMgZm9yIHRoZSBvcGVyYXRpb24KICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEpCiAgICAgKiAgIElmIGEgY2FsbGJhY2sgaXMgc3VwcGxpZWQsIGl0IGlzIGNhbGxlZCB3aGVuIGEgcmVzcG9uc2UgaXMgcmV0dXJuZWQKICAgICAqICAgZnJvbSB0aGUgc2VydmljZS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgICAqICAgICBTZXQgdG8gYG51bGxgIGlmIHRoZSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwuCiAgICAgKiAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIGRhdGEgcmV0dXJuZWQgZnJvbQogICAgICogICAgIHRoZSByZXF1ZXN0LiBTZXQgdG8gYG51bGxgIGlmIGEgcmVxdWVzdCBlcnJvciBvY2N1cnMuCiAgICAgKi8KICAgIG1ha2VSZXF1ZXN0OiBmdW5jdGlvbiBtYWtlUmVxdWVzdChvcGVyYXRpb24sIHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBjYWxsYmFjayA9IHBhcmFtczsKICAgICAgICBwYXJhbXMgPSBudWxsOwogICAgICB9CiAgCiAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTsKICAgICAgaWYgKHRoaXMuY29uZmlnLnBhcmFtcykgeyAvLyBjb3B5IG9ubHkgdG9wbGV2ZWwgYm91bmQgcGFyYW1zCiAgICAgICAgdmFyIHJ1bGVzID0gdGhpcy5hcGkub3BlcmF0aW9uc1tvcGVyYXRpb25dOwogICAgICAgIGlmIChydWxlcykgewogICAgICAgICAgcGFyYW1zID0gQVdTLnV0aWwuY29weShwYXJhbXMpOwogICAgICAgICAgQVdTLnV0aWwuZWFjaCh0aGlzLmNvbmZpZy5wYXJhbXMsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKHJ1bGVzLmlucHV0Lm1lbWJlcnNba2V5XSkgewogICAgICAgICAgICAgIGlmIChwYXJhbXNba2V5XSA9PT0gdW5kZWZpbmVkIHx8IHBhcmFtc1trZXldID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBwYXJhbXNba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHZhciByZXF1ZXN0ID0gbmV3IEFXUy5SZXF1ZXN0KHRoaXMsIG9wZXJhdGlvbiwgcGFyYW1zKTsKICAgICAgdGhpcy5hZGRBbGxSZXF1ZXN0TGlzdGVuZXJzKHJlcXVlc3QpOwogICAgICB0aGlzLmF0dGFjaE1vbml0b3JpbmdFbWl0dGVyKHJlcXVlc3QpOwogICAgICBpZiAoY2FsbGJhY2spIHJlcXVlc3Quc2VuZChjYWxsYmFjayk7CiAgICAgIHJldHVybiByZXF1ZXN0OwogICAgfSwKICAKICAgIC8qKgogICAgICogQ2FsbHMgYW4gb3BlcmF0aW9uIG9uIGEgc2VydmljZSB3aXRoIHRoZSBnaXZlbiBpbnB1dCBwYXJhbWV0ZXJzLCB3aXRob3V0CiAgICAgKiBhbnkgYXV0aGVudGljYXRpb24gZGF0YS4gVGhpcyBtZXRob2QgaXMgdXNlZnVsIGZvciAicHVibGljIiBBUEkgb3BlcmF0aW9ucy4KICAgICAqCiAgICAgKiBAcGFyYW0gb3BlcmF0aW9uIFtTdHJpbmddIHRoZSBuYW1lIG9mIHRoZSBvcGVyYXRpb24gdG8gY2FsbCBvbiB0aGUgc2VydmljZS4KICAgICAqIEBwYXJhbSBwYXJhbXMgW21hcF0gYSBtYXAgb2YgaW5wdXQgb3B0aW9ucyBmb3IgdGhlIG9wZXJhdGlvbgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgICAqICAgSWYgYSBjYWxsYmFjayBpcyBzdXBwbGllZCwgaXQgaXMgY2FsbGVkIHdoZW4gYSByZXNwb25zZSBpcyByZXR1cm5lZAogICAgICogICBmcm9tIHRoZSBzZXJ2aWNlLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAgICogICAgIFNldCB0byBgbnVsbGAgaWYgdGhlIHJlcXVlc3QgaXMgc3VjY2Vzc2Z1bC4KICAgICAqICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgZGF0YSByZXR1cm5lZCBmcm9tCiAgICAgKiAgICAgdGhlIHJlcXVlc3QuIFNldCB0byBgbnVsbGAgaWYgYSByZXF1ZXN0IGVycm9yIG9jY3Vycy4KICAgICAqLwogICAgbWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3Q6IGZ1bmN0aW9uIG1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KG9wZXJhdGlvbiwgcGFyYW1zLCBjYWxsYmFjaykgewogICAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGNhbGxiYWNrID0gcGFyYW1zOwogICAgICAgIHBhcmFtcyA9IHt9OwogICAgICB9CiAgCiAgICAgIHZhciByZXF1ZXN0ID0gdGhpcy5tYWtlUmVxdWVzdChvcGVyYXRpb24sIHBhcmFtcykudG9VbmF1dGhlbnRpY2F0ZWQoKTsKICAgICAgcmV0dXJuIGNhbGxiYWNrID8gcmVxdWVzdC5zZW5kKGNhbGxiYWNrKSA6IHJlcXVlc3Q7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBXYWl0cyBmb3IgYSBnaXZlbiBzdGF0ZQogICAgICoKICAgICAqIEBwYXJhbSBzdGF0ZSBbU3RyaW5nXSB0aGUgc3RhdGUgb24gdGhlIHNlcnZpY2UgdG8gd2FpdCBmb3IKICAgICAqIEBwYXJhbSBwYXJhbXMgW21hcF0gYSBtYXAgb2YgcGFyYW1ldGVycyB0byBwYXNzIHdpdGggZWFjaCByZXF1ZXN0CiAgICAgKiBAb3B0aW9uIHBhcmFtcyAkd2FpdGVyIFttYXBdIGEgbWFwIG9mIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIHdhaXRlcgogICAgICogQG9wdGlvbiBwYXJhbXMgJHdhaXRlci5kZWxheSBbTnVtYmVyXSBUaGUgbnVtYmVyIG9mIHNlY29uZHMgdG8gd2FpdCBiZXR3ZWVuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3RzCiAgICAgKiBAb3B0aW9uIHBhcmFtcyAkd2FpdGVyLm1heEF0dGVtcHRzIFtOdW1iZXJdIFRoZSBtYXhpbXVtIG51bWJlciBvZiByZXF1ZXN0cwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0byBzZW5kIHdoaWxlIHdhaXRpbmcKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEpCiAgICAgKiAgIElmIGEgY2FsbGJhY2sgaXMgc3VwcGxpZWQsIGl0IGlzIGNhbGxlZCB3aGVuIGEgcmVzcG9uc2UgaXMgcmV0dXJuZWQKICAgICAqICAgZnJvbSB0aGUgc2VydmljZS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgICAqICAgICBTZXQgdG8gYG51bGxgIGlmIHRoZSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwuCiAgICAgKiAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIGRhdGEgcmV0dXJuZWQgZnJvbQogICAgICogICAgIHRoZSByZXF1ZXN0LiBTZXQgdG8gYG51bGxgIGlmIGEgcmVxdWVzdCBlcnJvciBvY2N1cnMuCiAgICAgKi8KICAgIHdhaXRGb3I6IGZ1bmN0aW9uIHdhaXRGb3Ioc3RhdGUsIHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgdmFyIHdhaXRlciA9IG5ldyBBV1MuUmVzb3VyY2VXYWl0ZXIodGhpcywgc3RhdGUpOwogICAgICByZXR1cm4gd2FpdGVyLndhaXQocGFyYW1zLCBjYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYWRkQWxsUmVxdWVzdExpc3RlbmVyczogZnVuY3Rpb24gYWRkQWxsUmVxdWVzdExpc3RlbmVycyhyZXF1ZXN0KSB7CiAgICAgIHZhciBsaXN0ID0gW0FXUy5ldmVudHMsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLCB0aGlzLnNlcnZpY2VJbnRlcmZhY2UoKSwKICAgICAgICAgICAgICAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmVQb3N0XTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGxpc3RbaV0pIHJlcXVlc3QuYWRkTGlzdGVuZXJzKGxpc3RbaV0pOwogICAgICB9CiAgCiAgICAgIC8vIGRpc2FibGUgcGFyYW1ldGVyIHZhbGlkYXRpb24KICAgICAgaWYgKCF0aGlzLmNvbmZpZy5wYXJhbVZhbGlkYXRpb24pIHsKICAgICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsCiAgICAgICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9QQVJBTUVURVJTKTsKICAgICAgfQogIAogICAgICBpZiAodGhpcy5jb25maWcubG9nZ2VyKSB7IC8vIGFkZCBsb2dnaW5nIGV2ZW50cwogICAgICAgIHJlcXVlc3QuYWRkTGlzdGVuZXJzKEFXUy5FdmVudExpc3RlbmVycy5Mb2dnZXIpOwogICAgICB9CiAgCiAgICAgIHRoaXMuc2V0dXBSZXF1ZXN0TGlzdGVuZXJzKHJlcXVlc3QpOwogICAgICAvLyBjYWxsIHByb3RvdHlwZSdzIGN1c3RvbVJlcXVlc3RIYW5kbGVyCiAgICAgIGlmICh0eXBlb2YgdGhpcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUuY3VzdG9tUmVxdWVzdEhhbmRsZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5jdXN0b21SZXF1ZXN0SGFuZGxlcihyZXF1ZXN0KTsKICAgICAgfQogICAgICAvLyBjYWxsIGluc3RhbmNlJ3MgY3VzdG9tUmVxdWVzdEhhbmRsZXIKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLCAnY3VzdG9tUmVxdWVzdEhhbmRsZXInKSAmJiB0eXBlb2YgdGhpcy5jdXN0b21SZXF1ZXN0SGFuZGxlciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRoaXMuY3VzdG9tUmVxdWVzdEhhbmRsZXIocmVxdWVzdCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEV2ZW50IHJlY29yZGluZyBtZXRyaWNzIGZvciBhIHdob2xlIEFQSSBjYWxsLgogICAgICogQHJldHVybnMge29iamVjdH0gYSBzdWJzZXQgb2YgYXBpIGNhbGwgbWV0cmljcwogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwaUNhbGxFdmVudDogZnVuY3Rpb24gYXBpQ2FsbEV2ZW50KHJlcXVlc3QpIHsKICAgICAgdmFyIGFwaSA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICAgIHZhciBtb25pdG9yaW5nRXZlbnQgPSB7CiAgICAgICAgVHlwZTogJ0FwaUNhbGwnLAogICAgICAgIEFwaTogYXBpID8gYXBpLm5hbWUgOiByZXF1ZXN0Lm9wZXJhdGlvbiwKICAgICAgICBWZXJzaW9uOiAxLAogICAgICAgIFNlcnZpY2U6IHJlcXVlc3Quc2VydmljZS5hcGkuc2VydmljZUlkIHx8IHJlcXVlc3Quc2VydmljZS5hcGkuZW5kcG9pbnRQcmVmaXgsCiAgICAgICAgUmVnaW9uOiByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnJlZ2lvbiwKICAgICAgICBNYXhSZXRyaWVzRXhjZWVkZWQ6IDAsCiAgICAgICAgVXNlckFnZW50OiByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmdldFVzZXJBZ2VudCgpLAogICAgICB9OwogICAgICB2YXIgcmVzcG9uc2UgPSByZXF1ZXN0LnJlc3BvbnNlOwogICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUpIHsKICAgICAgICBtb25pdG9yaW5nRXZlbnQuRmluYWxIdHRwU3RhdHVzQ29kZSA9IHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICB9CiAgICAgIGlmIChyZXNwb25zZS5lcnJvcikgewogICAgICAgIHZhciBlcnJvciA9IHJlc3BvbnNlLmVycm9yOwogICAgICAgIHZhciBzdGF0dXNDb2RlID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgICAgaWYgKHN0YXR1c0NvZGUgPiAyOTkpIHsKICAgICAgICAgIGlmIChlcnJvci5jb2RlKSBtb25pdG9yaW5nRXZlbnQuRmluYWxBd3NFeGNlcHRpb24gPSBlcnJvci5jb2RlOwogICAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIG1vbml0b3JpbmdFdmVudC5GaW5hbEF3c0V4Y2VwdGlvbk1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoZXJyb3IuY29kZSB8fCBlcnJvci5uYW1lKSBtb25pdG9yaW5nRXZlbnQuRmluYWxTZGtFeGNlcHRpb24gPSBlcnJvci5jb2RlIHx8IGVycm9yLm5hbWU7CiAgICAgICAgICBpZiAoZXJyb3IubWVzc2FnZSkgbW9uaXRvcmluZ0V2ZW50LkZpbmFsU2RrRXhjZXB0aW9uTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBtb25pdG9yaW5nRXZlbnQ7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBFdmVudCByZWNvcmRpbmcgbWV0cmljcyBmb3IgYW4gQVBJIGNhbGwgYXR0ZW1wdC4KICAgICAqIEByZXR1cm5zIHtvYmplY3R9IGEgc3Vic2V0IG9mIGFwaSBjYWxsIGF0dGVtcHQgbWV0cmljcwogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwaUF0dGVtcHRFdmVudDogZnVuY3Rpb24gYXBpQXR0ZW1wdEV2ZW50KHJlcXVlc3QpIHsKICAgICAgdmFyIGFwaSA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICAgIHZhciBtb25pdG9yaW5nRXZlbnQgPSB7CiAgICAgICAgVHlwZTogJ0FwaUNhbGxBdHRlbXB0JywKICAgICAgICBBcGk6IGFwaSA/IGFwaS5uYW1lIDogcmVxdWVzdC5vcGVyYXRpb24sCiAgICAgICAgVmVyc2lvbjogMSwKICAgICAgICBTZXJ2aWNlOiByZXF1ZXN0LnNlcnZpY2UuYXBpLnNlcnZpY2VJZCB8fCByZXF1ZXN0LnNlcnZpY2UuYXBpLmVuZHBvaW50UHJlZml4LAogICAgICAgIEZxZG46IHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQuaG9zdG5hbWUsCiAgICAgICAgVXNlckFnZW50OiByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmdldFVzZXJBZ2VudCgpLAogICAgICB9OwogICAgICB2YXIgcmVzcG9uc2UgPSByZXF1ZXN0LnJlc3BvbnNlOwogICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUpIHsKICAgICAgICBtb25pdG9yaW5nRXZlbnQuSHR0cFN0YXR1c0NvZGUgPSByZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgfQogICAgICBpZiAoCiAgICAgICAgIXJlcXVlc3QuX3VuQXV0aGVudGljYXRlZCAmJgogICAgICAgIHJlcXVlc3Quc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMgJiYKICAgICAgICByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkCiAgICAgICkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5BY2Nlc3NLZXkgPSByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkOwogICAgICB9CiAgICAgIGlmICghcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnMpIHJldHVybiBtb25pdG9yaW5nRXZlbnQ7CiAgICAgIGlmIChyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LXNlY3VyaXR5LXRva2VuJ10pIHsKICAgICAgICBtb25pdG9yaW5nRXZlbnQuU2Vzc2lvblRva2VuID0gcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWyd4LWFtei1zZWN1cml0eS10b2tlbiddOwogICAgICB9CiAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXpuLXJlcXVlc3RpZCddKSB7CiAgICAgICAgbW9uaXRvcmluZ0V2ZW50LlhBbXpuUmVxdWVzdElkID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16bi1yZXF1ZXN0aWQnXTsKICAgICAgfQogICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LXJlcXVlc3QtaWQnXSkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5YQW16UmVxdWVzdElkID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LXJlcXVlc3QtaWQnXTsKICAgICAgfQogICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LWlkLTInXSkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5YQW16SWQyID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LWlkLTInXTsKICAgICAgfQogICAgICByZXR1cm4gbW9uaXRvcmluZ0V2ZW50OwogICAgfSwKICAKICAgIC8qKgogICAgICogQWRkIG1ldHJpY3Mgb2YgZmFpbGVkIHJlcXVlc3QuCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXR0ZW1wdEZhaWxFdmVudDogZnVuY3Rpb24gYXR0ZW1wdEZhaWxFdmVudChyZXF1ZXN0KSB7CiAgICAgIHZhciBtb25pdG9yaW5nRXZlbnQgPSB0aGlzLmFwaUF0dGVtcHRFdmVudChyZXF1ZXN0KTsKICAgICAgdmFyIHJlc3BvbnNlID0gcmVxdWVzdC5yZXNwb25zZTsKICAgICAgdmFyIGVycm9yID0gcmVzcG9uc2UuZXJyb3I7CiAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSA+IDI5OSApIHsKICAgICAgICBpZiAoZXJyb3IuY29kZSkgbW9uaXRvcmluZ0V2ZW50LkF3c0V4Y2VwdGlvbiA9IGVycm9yLmNvZGU7CiAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIG1vbml0b3JpbmdFdmVudC5Bd3NFeGNlcHRpb25NZXNzYWdlID0gZXJyb3IubWVzc2FnZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoZXJyb3IuY29kZSB8fCBlcnJvci5uYW1lKSBtb25pdG9yaW5nRXZlbnQuU2RrRXhjZXB0aW9uID0gZXJyb3IuY29kZSB8fCBlcnJvci5uYW1lOwogICAgICAgIGlmIChlcnJvci5tZXNzYWdlKSBtb25pdG9yaW5nRXZlbnQuU2RrRXhjZXB0aW9uTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICAgIH0KICAgICAgcmV0dXJuIG1vbml0b3JpbmdFdmVudDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEF0dGFjaCBsaXN0ZW5lcnMgdG8gcmVxdWVzdCBvYmplY3QgdG8gZmV0Y2ggbWV0cmljcyBvZiBlYWNoIHJlcXVlc3QKICAgICAqIGFuZCBlbWl0IGRhdGEgb2JqZWN0IHRocm91Z2ggXCdBcGlDYWxsXCcgYW5kIFwnQXBpQ2FsbEF0dGVtcHRcJyBldmVudHMuCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXR0YWNoTW9uaXRvcmluZ0VtaXR0ZXI6IGZ1bmN0aW9uIGF0dGFjaE1vbml0b3JpbmdFbWl0dGVyKHJlcXVlc3QpIHsKICAgICAgdmFyIGF0dGVtcHRUaW1lc3RhbXA7IC8vdGltZXN0YW1wIG1hcmtpbmcgdGhlIGJlZ2lubmluZyBvZiBhIHJlcXVlc3QgYXR0ZW1wdAogICAgICB2YXIgYXR0ZW1wdFN0YXJ0UmVhbFRpbWU7IC8vU3RhcnQgdGltZSBvZiByZXF1ZXN0IGF0dGVtcHQuIFVzZWQgdG8gY2FsY3VsYXRpbmcgYXR0ZW1wdExhdGVuY3kKICAgICAgdmFyIGF0dGVtcHRMYXRlbmN5OyAvL2xhdGVuY3kgZnJvbSByZXF1ZXN0IHNlbnQgb3V0IHRvIGh0dHAgcmVzcG9uc2UgcmVhY2hpbmcgU0RLCiAgICAgIHZhciBjYWxsU3RhcnRSZWFsVGltZTsgLy9TdGFydCB0aW1lIG9mIEFQSSBjYWxsLiBVc2VkIHRvIGNhbGN1bGF0aW5nIEFQSSBjYWxsIGxhdGVuY3kKICAgICAgdmFyIGF0dGVtcHRDb3VudCA9IDA7IC8vcmVxdWVzdC5yZXRyeUNvdW50IGlzIG5vdCByZWxpYWJsZSBoZXJlCiAgICAgIHZhciByZWdpb247IC8vcmVnaW9uIGNhY2hlIHJlZ2lvbiBmb3IgZWFjaCBhdHRlbXB0IHNpbmNlIGl0IGNhbiBiZSB1cGRhdGVkIGluIHBsYXNlIChlLmcuIHMzKQogICAgICB2YXIgY2FsbFRpbWVzdGFtcDsgLy90aW1lc3RhbXAgd2hlbiB0aGUgcmVxdWVzdCBpcyBjcmVhdGVkCiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGFkZFRvSGVhZCA9IHRydWU7CiAgCiAgICAgIHJlcXVlc3Qub24oJ3ZhbGlkYXRlJywgZnVuY3Rpb24gKCkgewogICAgICAgIGNhbGxTdGFydFJlYWxUaW1lID0gQVdTLnV0aWwucmVhbENsb2NrLm5vdygpOwogICAgICAgIGNhbGxUaW1lc3RhbXAgPSBEYXRlLm5vdygpOwogICAgICB9LCBhZGRUb0hlYWQpOwogICAgICByZXF1ZXN0Lm9uKCdzaWduJywgZnVuY3Rpb24gKCkgewogICAgICAgIGF0dGVtcHRTdGFydFJlYWxUaW1lID0gQVdTLnV0aWwucmVhbENsb2NrLm5vdygpOwogICAgICAgIGF0dGVtcHRUaW1lc3RhbXAgPSBEYXRlLm5vdygpOwogICAgICAgIHJlZ2lvbiA9IHJlcXVlc3QuaHR0cFJlcXVlc3QucmVnaW9uOwogICAgICAgIGF0dGVtcHRDb3VudCsrOwogICAgICB9LCBhZGRUb0hlYWQpOwogICAgICByZXF1ZXN0Lm9uKCd2YWxpZGF0ZVJlc3BvbnNlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgYXR0ZW1wdExhdGVuY3kgPSBNYXRoLnJvdW5kKEFXUy51dGlsLnJlYWxDbG9jay5ub3coKSAtIGF0dGVtcHRTdGFydFJlYWxUaW1lKTsKICAgICAgfSk7CiAgICAgIHJlcXVlc3QuYWRkTmFtZWRMaXN0ZW5lcignQVBJX0NBTExfQVRURU1QVCcsICdzdWNjZXNzJywgZnVuY3Rpb24gQVBJX0NBTExfQVRURU1QVCgpIHsKICAgICAgICB2YXIgYXBpQXR0ZW1wdEV2ZW50ID0gc2VsZi5hcGlBdHRlbXB0RXZlbnQocmVxdWVzdCk7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LlRpbWVzdGFtcCA9IGF0dGVtcHRUaW1lc3RhbXA7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LkF0dGVtcHRMYXRlbmN5ID0gYXR0ZW1wdExhdGVuY3kgPj0gMCA/IGF0dGVtcHRMYXRlbmN5IDogMDsKICAgICAgICBhcGlBdHRlbXB0RXZlbnQuUmVnaW9uID0gcmVnaW9uOwogICAgICAgIHNlbGYuZW1pdCgnYXBpQ2FsbEF0dGVtcHQnLCBbYXBpQXR0ZW1wdEV2ZW50XSk7CiAgICAgIH0pOwogICAgICByZXF1ZXN0LmFkZE5hbWVkTGlzdGVuZXIoJ0FQSV9DQUxMX0FUVEVNUFRfUkVUUlknLCAncmV0cnknLCBmdW5jdGlvbiBBUElfQ0FMTF9BVFRFTVBUX1JFVFJZKCkgewogICAgICAgIHZhciBhcGlBdHRlbXB0RXZlbnQgPSBzZWxmLmF0dGVtcHRGYWlsRXZlbnQocmVxdWVzdCk7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LlRpbWVzdGFtcCA9IGF0dGVtcHRUaW1lc3RhbXA7CiAgICAgICAgLy9hdHRlbXB0TGF0ZW5jeSBtYXkgbm90IGJlIGF2YWlsYWJsZSBpZiBmYWlsIGJlZm9yZSByZXNwb25zZQogICAgICAgIGF0dGVtcHRMYXRlbmN5ID0gYXR0ZW1wdExhdGVuY3kgfHwKICAgICAgICAgIE1hdGgucm91bmQoQVdTLnV0aWwucmVhbENsb2NrLm5vdygpIC0gYXR0ZW1wdFN0YXJ0UmVhbFRpbWUpOwogICAgICAgIGFwaUF0dGVtcHRFdmVudC5BdHRlbXB0TGF0ZW5jeSA9IGF0dGVtcHRMYXRlbmN5ID49IDAgPyBhdHRlbXB0TGF0ZW5jeSA6IDA7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LlJlZ2lvbiA9IHJlZ2lvbjsKICAgICAgICBzZWxmLmVtaXQoJ2FwaUNhbGxBdHRlbXB0JywgW2FwaUF0dGVtcHRFdmVudF0pOwogICAgICB9KTsKICAgICAgcmVxdWVzdC5hZGROYW1lZExpc3RlbmVyKCdBUElfQ0FMTCcsICdjb21wbGV0ZScsIGZ1bmN0aW9uIEFQSV9DQUxMKCkgewogICAgICAgIHZhciBhcGlDYWxsRXZlbnQgPSBzZWxmLmFwaUNhbGxFdmVudChyZXF1ZXN0KTsKICAgICAgICBhcGlDYWxsRXZlbnQuQXR0ZW1wdENvdW50ID0gYXR0ZW1wdENvdW50OwogICAgICAgIGlmIChhcGlDYWxsRXZlbnQuQXR0ZW1wdENvdW50IDw9IDApIHJldHVybjsKICAgICAgICBhcGlDYWxsRXZlbnQuVGltZXN0YW1wID0gY2FsbFRpbWVzdGFtcDsKICAgICAgICB2YXIgbGF0ZW5jeSA9IE1hdGgucm91bmQoQVdTLnV0aWwucmVhbENsb2NrLm5vdygpIC0gY2FsbFN0YXJ0UmVhbFRpbWUpOwogICAgICAgIGFwaUNhbGxFdmVudC5MYXRlbmN5ID0gbGF0ZW5jeSA+PSAwID8gbGF0ZW5jeSA6IDA7CiAgICAgICAgdmFyIHJlc3BvbnNlID0gcmVxdWVzdC5yZXNwb25zZTsKICAgICAgICBpZiAoCiAgICAgICAgICB0eXBlb2YgcmVzcG9uc2UucmV0cnlDb3VudCA9PT0gJ251bWJlcicgJiYKICAgICAgICAgIHR5cGVvZiByZXNwb25zZS5tYXhSZXRyaWVzID09PSAnbnVtYmVyJyAmJgogICAgICAgICAgKHJlc3BvbnNlLnJldHJ5Q291bnQgPj0gcmVzcG9uc2UubWF4UmV0cmllcykKICAgICAgICApIHsKICAgICAgICAgIGFwaUNhbGxFdmVudC5NYXhSZXRyaWVzRXhjZWVkZWQgPSAxOwogICAgICAgIH0KICAgICAgICBzZWxmLmVtaXQoJ2FwaUNhbGwnLCBbYXBpQ2FsbEV2ZW50XSk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogT3ZlcnJpZGUgdGhpcyBtZXRob2QgdG8gc2V0dXAgYW55IGN1c3RvbSByZXF1ZXN0IGxpc3RlbmVycyBmb3IgZWFjaAogICAgICogbmV3IHJlcXVlc3QgdG8gdGhlIHNlcnZpY2UuCiAgICAgKgogICAgICogQG1ldGhvZF9hYnN0cmFjdCBUaGlzIGlzIGFuIGFic3RyYWN0IG1ldGhvZC4KICAgICAqLwogICAgc2V0dXBSZXF1ZXN0TGlzdGVuZXJzOiBmdW5jdGlvbiBzZXR1cFJlcXVlc3RMaXN0ZW5lcnMocmVxdWVzdCkgewogICAgfSwKICAKICAgIC8qKgogICAgICogR2V0cyB0aGUgc2lnbmVyIGNsYXNzIGZvciBhIGdpdmVuIHJlcXVlc3QKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRTaWduZXJDbGFzczogZnVuY3Rpb24gZ2V0U2lnbmVyQ2xhc3MocmVxdWVzdCkgewogICAgICB2YXIgdmVyc2lvbjsKICAgICAgLy8gZ2V0IG9wZXJhdGlvbiBhdXRodHlwZSBpZiBwcmVzZW50CiAgICAgIHZhciBvcGVyYXRpb24gPSBudWxsOwogICAgICB2YXIgYXV0aHR5cGUgPSAnJzsKICAgICAgaWYgKHJlcXVlc3QpIHsKICAgICAgICB2YXIgb3BlcmF0aW9ucyA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9ucyB8fCB7fTsKICAgICAgICBvcGVyYXRpb24gPSBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXSB8fCBudWxsOwogICAgICAgIGF1dGh0eXBlID0gb3BlcmF0aW9uID8gb3BlcmF0aW9uLmF1dGh0eXBlIDogJyc7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIHsKICAgICAgICB2ZXJzaW9uID0gdGhpcy5jb25maWcuc2lnbmF0dXJlVmVyc2lvbjsKICAgICAgfSBlbHNlIGlmIChhdXRodHlwZSA9PT0gJ3Y0JyB8fCBhdXRodHlwZSA9PT0gJ3Y0LXVuc2lnbmVkLWJvZHknKSB7CiAgICAgICAgdmVyc2lvbiA9ICd2NCc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmVyc2lvbiA9IHRoaXMuYXBpLnNpZ25hdHVyZVZlcnNpb247CiAgICAgIH0KICAgICAgcmV0dXJuIEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIuZ2V0VmVyc2lvbih2ZXJzaW9uKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzZXJ2aWNlSW50ZXJmYWNlOiBmdW5jdGlvbiBzZXJ2aWNlSW50ZXJmYWNlKCkgewogICAgICBzd2l0Y2ggKHRoaXMuYXBpLnByb3RvY29sKSB7CiAgICAgICAgY2FzZSAnZWMyJzogcmV0dXJuIEFXUy5FdmVudExpc3RlbmVycy5RdWVyeTsKICAgICAgICBjYXNlICdxdWVyeSc6IHJldHVybiBBV1MuRXZlbnRMaXN0ZW5lcnMuUXVlcnk7CiAgICAgICAgY2FzZSAnanNvbic6IHJldHVybiBBV1MuRXZlbnRMaXN0ZW5lcnMuSnNvbjsKICAgICAgICBjYXNlICdyZXN0LWpzb24nOiByZXR1cm4gQVdTLkV2ZW50TGlzdGVuZXJzLlJlc3RKc29uOwogICAgICAgIGNhc2UgJ3Jlc3QteG1sJzogcmV0dXJuIEFXUy5FdmVudExpc3RlbmVycy5SZXN0WG1sOwogICAgICB9CiAgICAgIGlmICh0aGlzLmFwaS5wcm90b2NvbCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBzZXJ2aWNlIGBwcm90b2NvbFwnICcgKwogICAgICAgICAgdGhpcy5hcGkucHJvdG9jb2wgKyAnIGluIEFQSSBjb25maWcnKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHN1Y2Nlc3NmdWxSZXNwb25zZTogZnVuY3Rpb24gc3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3ApIHsKICAgICAgcmV0dXJuIHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUgPCAzMDA7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBIb3cgbWFueSB0aW1lcyBhIGZhaWxlZCByZXF1ZXN0IHNob3VsZCBiZSByZXRyaWVkIGJlZm9yZSBnaXZpbmcgdXAuCiAgICAgKiB0aGUgZGVmYXVsdFJldHJ5Q291bnQgY2FuIGJlIG92ZXJyaWRlbiBieSBzZXJ2aWNlIGNsYXNzZXMuCiAgICAgKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIG51bVJldHJpZXM6IGZ1bmN0aW9uIG51bVJldHJpZXMoKSB7CiAgICAgIGlmICh0aGlzLmNvbmZpZy5tYXhSZXRyaWVzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25maWcubWF4UmV0cmllczsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5kZWZhdWx0UmV0cnlDb3VudDsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHJldHJ5RGVsYXlzOiBmdW5jdGlvbiByZXRyeURlbGF5cyhyZXRyeUNvdW50KSB7CiAgICAgIHJldHVybiBBV1MudXRpbC5jYWxjdWxhdGVSZXRyeURlbGF5KHJldHJ5Q291bnQsIHRoaXMuY29uZmlnLnJldHJ5RGVsYXlPcHRpb25zKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICByZXRyeWFibGVFcnJvcjogZnVuY3Rpb24gcmV0cnlhYmxlRXJyb3IoZXJyb3IpIHsKICAgICAgaWYgKHRoaXMudGltZW91dEVycm9yKGVycm9yKSkgcmV0dXJuIHRydWU7CiAgICAgIGlmICh0aGlzLm5ldHdvcmtpbmdFcnJvcihlcnJvcikpIHJldHVybiB0cnVlOwogICAgICBpZiAodGhpcy5leHBpcmVkQ3JlZGVudGlhbHNFcnJvcihlcnJvcikpIHJldHVybiB0cnVlOwogICAgICBpZiAodGhpcy50aHJvdHRsZWRFcnJvcihlcnJvcikpIHJldHVybiB0cnVlOwogICAgICBpZiAoZXJyb3Iuc3RhdHVzQ29kZSA+PSA1MDApIHJldHVybiB0cnVlOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbmV0d29ya2luZ0Vycm9yOiBmdW5jdGlvbiBuZXR3b3JraW5nRXJyb3IoZXJyb3IpIHsKICAgICAgcmV0dXJuIGVycm9yLmNvZGUgPT09ICdOZXR3b3JraW5nRXJyb3InOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHRpbWVvdXRFcnJvcjogZnVuY3Rpb24gdGltZW91dEVycm9yKGVycm9yKSB7CiAgICAgIHJldHVybiBlcnJvci5jb2RlID09PSAnVGltZW91dEVycm9yJzsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBleHBpcmVkQ3JlZGVudGlhbHNFcnJvcjogZnVuY3Rpb24gZXhwaXJlZENyZWRlbnRpYWxzRXJyb3IoZXJyb3IpIHsKICAgICAgLy8gVE9ETyA6IHRoaXMgb25seSBoYW5kbGVzICpvbmUqIG9mIHRoZSBleHBpcmVkIGNyZWRlbnRpYWwgY29kZXMKICAgICAgcmV0dXJuIChlcnJvci5jb2RlID09PSAnRXhwaXJlZFRva2VuRXhjZXB0aW9uJyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY2xvY2tTa2V3RXJyb3I6IGZ1bmN0aW9uIGNsb2NrU2tld0Vycm9yKGVycm9yKSB7CiAgICAgIHN3aXRjaCAoZXJyb3IuY29kZSkgewogICAgICAgIGNhc2UgJ1JlcXVlc3RUaW1lVG9vU2tld2VkJzoKICAgICAgICBjYXNlICdSZXF1ZXN0RXhwaXJlZCc6CiAgICAgICAgY2FzZSAnSW52YWxpZFNpZ25hdHVyZUV4Y2VwdGlvbic6CiAgICAgICAgY2FzZSAnU2lnbmF0dXJlRG9lc05vdE1hdGNoJzoKICAgICAgICBjYXNlICdBdXRoRmFpbHVyZSc6CiAgICAgICAgY2FzZSAnUmVxdWVzdEluVGhlRnV0dXJlJzoKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIGRlZmF1bHQ6IHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldFNrZXdDb3JyZWN0ZWREYXRlOiBmdW5jdGlvbiBnZXRTa2V3Q29ycmVjdGVkRGF0ZSgpIHsKICAgICAgcmV0dXJuIG5ldyBEYXRlKERhdGUubm93KCkgKyB0aGlzLmNvbmZpZy5zeXN0ZW1DbG9ja09mZnNldCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXBwbHlDbG9ja09mZnNldDogZnVuY3Rpb24gYXBwbHlDbG9ja09mZnNldChuZXdTZXJ2ZXJUaW1lKSB7CiAgICAgIGlmIChuZXdTZXJ2ZXJUaW1lKSB7CiAgICAgICAgdGhpcy5jb25maWcuc3lzdGVtQ2xvY2tPZmZzZXQgPSBuZXdTZXJ2ZXJUaW1lIC0gRGF0ZS5ub3coKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGlzQ2xvY2tTa2V3ZWQ6IGZ1bmN0aW9uIGlzQ2xvY2tTa2V3ZWQobmV3U2VydmVyVGltZSkgewogICAgICBpZiAobmV3U2VydmVyVGltZSkgewogICAgICAgIHJldHVybiBNYXRoLmFicyh0aGlzLmdldFNrZXdDb3JyZWN0ZWREYXRlKCkuZ2V0VGltZSgpIC0gbmV3U2VydmVyVGltZSkgPj0gMzAwMDA7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICB0aHJvdHRsZWRFcnJvcjogZnVuY3Rpb24gdGhyb3R0bGVkRXJyb3IoZXJyb3IpIHsKICAgICAgLy8gdGhpcyBsb2dpYyB2YXJpZXMgYmV0d2VlbiBzZXJ2aWNlcwogICAgICBpZiAoZXJyb3Iuc3RhdHVzQ29kZSA9PT0gNDI5KSByZXR1cm4gdHJ1ZTsKICAgICAgc3dpdGNoIChlcnJvci5jb2RlKSB7CiAgICAgICAgY2FzZSAnUHJvdmlzaW9uZWRUaHJvdWdocHV0RXhjZWVkZWRFeGNlcHRpb24nOgogICAgICAgIGNhc2UgJ1Rocm90dGxpbmcnOgogICAgICAgIGNhc2UgJ1Rocm90dGxpbmdFeGNlcHRpb24nOgogICAgICAgIGNhc2UgJ1JlcXVlc3RMaW1pdEV4Y2VlZGVkJzoKICAgICAgICBjYXNlICdSZXF1ZXN0VGhyb3R0bGVkJzoKICAgICAgICBjYXNlICdSZXF1ZXN0VGhyb3R0bGVkRXhjZXB0aW9uJzoKICAgICAgICBjYXNlICdUb29NYW55UmVxdWVzdHNFeGNlcHRpb24nOgogICAgICAgIGNhc2UgJ1RyYW5zYWN0aW9uSW5Qcm9ncmVzc0V4Y2VwdGlvbic6IC8vZHluYW1vZGIKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBlbmRwb2ludEZyb21UZW1wbGF0ZTogZnVuY3Rpb24gZW5kcG9pbnRGcm9tVGVtcGxhdGUoZW5kcG9pbnQpIHsKICAgICAgaWYgKHR5cGVvZiBlbmRwb2ludCAhPT0gJ3N0cmluZycpIHJldHVybiBlbmRwb2ludDsKICAKICAgICAgdmFyIGUgPSBlbmRwb2ludDsKICAgICAgZSA9IGUucmVwbGFjZSgvXHtzZXJ2aWNlXH0vZywgdGhpcy5hcGkuZW5kcG9pbnRQcmVmaXgpOwogICAgICBlID0gZS5yZXBsYWNlKC9ce3JlZ2lvblx9L2csIHRoaXMuY29uZmlnLnJlZ2lvbik7CiAgICAgIGUgPSBlLnJlcGxhY2UoL1x7c2NoZW1lXH0vZywgdGhpcy5jb25maWcuc3NsRW5hYmxlZCA/ICdodHRwcycgOiAnaHR0cCcpOwogICAgICByZXR1cm4gZTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzZXRFbmRwb2ludDogZnVuY3Rpb24gc2V0RW5kcG9pbnQoZW5kcG9pbnQpIHsKICAgICAgdGhpcy5lbmRwb2ludCA9IG5ldyBBV1MuRW5kcG9pbnQoZW5kcG9pbnQsIHRoaXMuY29uZmlnKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBwYWdpbmF0aW9uQ29uZmlnOiBmdW5jdGlvbiBwYWdpbmF0aW9uQ29uZmlnKG9wZXJhdGlvbiwgdGhyb3dFeGNlcHRpb24pIHsKICAgICAgdmFyIHBhZ2luYXRvciA9IHRoaXMuYXBpLm9wZXJhdGlvbnNbb3BlcmF0aW9uXS5wYWdpbmF0b3I7CiAgICAgIGlmICghcGFnaW5hdG9yKSB7CiAgICAgICAgaWYgKHRocm93RXhjZXB0aW9uKSB7CiAgICAgICAgICB2YXIgZSA9IG5ldyBFcnJvcigpOwogICAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IoZSwgJ05vIHBhZ2luYXRpb24gY29uZmlndXJhdGlvbiBmb3IgJyArIG9wZXJhdGlvbik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgCiAgICAgIHJldHVybiBwYWdpbmF0b3I7CiAgICB9CiAgfSk7CiAgCiAgQVdTLnV0aWwudXBkYXRlKEFXUy5TZXJ2aWNlLCB7CiAgCiAgICAvKioKICAgICAqIEFkZHMgb25lIG1ldGhvZCBmb3IgZWFjaCBvcGVyYXRpb24gZGVzY3JpYmVkIGluIHRoZSBhcGkgY29uZmlndXJhdGlvbgogICAgICoKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBkZWZpbmVNZXRob2RzOiBmdW5jdGlvbiBkZWZpbmVNZXRob2RzKHN2YykgewogICAgICBBV1MudXRpbC5lYWNoKHN2Yy5wcm90b3R5cGUuYXBpLm9wZXJhdGlvbnMsIGZ1bmN0aW9uIGl0ZXJhdG9yKG1ldGhvZCkgewogICAgICAgIGlmIChzdmMucHJvdG90eXBlW21ldGhvZF0pIHJldHVybjsKICAgICAgICB2YXIgb3BlcmF0aW9uID0gc3ZjLnByb3RvdHlwZS5hcGkub3BlcmF0aW9uc1ttZXRob2RdOwogICAgICAgIGlmIChvcGVyYXRpb24uYXV0aHR5cGUgPT09ICdub25lJykgewogICAgICAgICAgc3ZjLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24gKHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3QobWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN2Yy5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uIChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1ha2VSZXF1ZXN0KG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFjayk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBEZWZpbmVzIGEgbmV3IFNlcnZpY2UgY2xhc3MgdXNpbmcgYSBzZXJ2aWNlIGlkZW50aWZpZXIgYW5kIGxpc3Qgb2YgdmVyc2lvbnMKICAgICAqIGluY2x1ZGluZyBhbiBvcHRpb25hbCBzZXQgb2YgZmVhdHVyZXMgKGZ1bmN0aW9ucykgdG8gYXBwbHkgdG8gdGhlIGNsYXNzCiAgICAgKiBwcm90b3R5cGUuCiAgICAgKgogICAgICogQHBhcmFtIHNlcnZpY2VJZGVudGlmaWVyIFtTdHJpbmddIHRoZSBpZGVudGlmaWVyIGZvciB0aGUgc2VydmljZQogICAgICogQHBhcmFtIHZlcnNpb25zIFtBcnJheTxTdHJpbmc+XSBhIGxpc3Qgb2YgdmVyc2lvbnMgdGhhdCB3b3JrIHdpdGggdGhpcwogICAgICogICBzZXJ2aWNlCiAgICAgKiBAcGFyYW0gZmVhdHVyZXMgW09iamVjdF0gYW4gb2JqZWN0IHRvIGF0dGFjaCB0byB0aGUgcHJvdG90eXBlCiAgICAgKiBAcmV0dXJuIFtDbGFzczxTZXJ2aWNlPl0gdGhlIHNlcnZpY2UgY2xhc3MgZGVmaW5lZCBieSB0aGlzIGZ1bmN0aW9uLgogICAgICovCiAgICBkZWZpbmVTZXJ2aWNlOiBmdW5jdGlvbiBkZWZpbmVTZXJ2aWNlKHNlcnZpY2VJZGVudGlmaWVyLCB2ZXJzaW9ucywgZmVhdHVyZXMpIHsKICAgICAgQVdTLlNlcnZpY2UuX3NlcnZpY2VNYXBbc2VydmljZUlkZW50aWZpZXJdID0gdHJ1ZTsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHZlcnNpb25zKSkgewogICAgICAgIGZlYXR1cmVzID0gdmVyc2lvbnM7CiAgICAgICAgdmVyc2lvbnMgPSBbXTsKICAgICAgfQogIAogICAgICB2YXIgc3ZjID0gaW5oZXJpdChBV1MuU2VydmljZSwgZmVhdHVyZXMgfHwge30pOwogIAogICAgICBpZiAodHlwZW9mIHNlcnZpY2VJZGVudGlmaWVyID09PSAnc3RyaW5nJykgewogICAgICAgIEFXUy5TZXJ2aWNlLmFkZFZlcnNpb25zKHN2YywgdmVyc2lvbnMpOwogIAogICAgICAgIHZhciBpZGVudGlmaWVyID0gc3ZjLnNlcnZpY2VJZGVudGlmaWVyIHx8IHNlcnZpY2VJZGVudGlmaWVyOwogICAgICAgIHN2Yy5zZXJ2aWNlSWRlbnRpZmllciA9IGlkZW50aWZpZXI7CiAgICAgIH0gZWxzZSB7IC8vIGRlZmluZVNlcnZpY2UgY2FsbGVkIHdpdGggYW4gQVBJCiAgICAgICAgc3ZjLnByb3RvdHlwZS5hcGkgPSBzZXJ2aWNlSWRlbnRpZmllcjsKICAgICAgICBBV1MuU2VydmljZS5kZWZpbmVNZXRob2RzKHN2Yyk7CiAgICAgIH0KICAgICAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5jYWxsKHRoaXMucHJvdG90eXBlKTsKICAgICAgLy91dGlsLmNsaWVudFNpZGVNb25pdG9yaW5nIGlzIG9ubHkgYXZhaWxhYmxlIGluIG5vZGUKICAgICAgaWYgKCF0aGlzLnByb3RvdHlwZS5wdWJsaXNoZXIgJiYgQVdTLnV0aWwuY2xpZW50U2lkZU1vbml0b3JpbmcpIHsKICAgICAgICB2YXIgUHVibGlzaGVyID0gQVdTLnV0aWwuY2xpZW50U2lkZU1vbml0b3JpbmcuUHVibGlzaGVyOwogICAgICAgIHZhciBjb25maWdQcm92aWRlciA9IEFXUy51dGlsLmNsaWVudFNpZGVNb25pdG9yaW5nLmNvbmZpZ1Byb3ZpZGVyOwogICAgICAgIHZhciBwdWJsaXNoZXJDb25maWcgPSBjb25maWdQcm92aWRlcigpOwogICAgICAgIHRoaXMucHJvdG90eXBlLnB1Ymxpc2hlciA9IG5ldyBQdWJsaXNoZXIocHVibGlzaGVyQ29uZmlnKTsKICAgICAgICBpZiAocHVibGlzaGVyQ29uZmlnLmVuYWJsZWQpIHsKICAgICAgICAgIC8vaWYgY3NtIGlzIGVuYWJsZWQgaW4gZW52aXJvbm1lbnQsIFNESyBzaG91bGQgc2VuZCBhbGwgbWV0cmljcwogICAgICAgICAgQVdTLlNlcnZpY2UuX2NsaWVudFNpZGVNb25pdG9yaW5nID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5jYWxsKHN2Yy5wcm90b3R5cGUpOwogICAgICBBV1MuU2VydmljZS5hZGREZWZhdWx0TW9uaXRvcmluZ0xpc3RlbmVycyhzdmMucHJvdG90eXBlKTsKICAgICAgcmV0dXJuIHN2YzsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhZGRWZXJzaW9uczogZnVuY3Rpb24gYWRkVmVyc2lvbnMoc3ZjLCB2ZXJzaW9ucykgewogICAgICBpZiAoIUFycmF5LmlzQXJyYXkodmVyc2lvbnMpKSB2ZXJzaW9ucyA9IFt2ZXJzaW9uc107CiAgCiAgICAgIHN2Yy5zZXJ2aWNlcyA9IHN2Yy5zZXJ2aWNlcyB8fCB7fTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2ZXJzaW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChzdmMuc2VydmljZXNbdmVyc2lvbnNbaV1dID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHN2Yy5zZXJ2aWNlc1t2ZXJzaW9uc1tpXV0gPSBudWxsOwogICAgICAgIH0KICAgICAgfQogIAogICAgICBzdmMuYXBpVmVyc2lvbnMgPSBPYmplY3Qua2V5cyhzdmMuc2VydmljZXMpLnNvcnQoKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBkZWZpbmVTZXJ2aWNlQXBpOiBmdW5jdGlvbiBkZWZpbmVTZXJ2aWNlQXBpKHN1cGVyY2xhc3MsIHZlcnNpb24sIGFwaUNvbmZpZykgewogICAgICB2YXIgc3ZjID0gaW5oZXJpdChzdXBlcmNsYXNzLCB7CiAgICAgICAgc2VydmljZUlkZW50aWZpZXI6IHN1cGVyY2xhc3Muc2VydmljZUlkZW50aWZpZXIKICAgICAgfSk7CiAgCiAgICAgIGZ1bmN0aW9uIHNldEFwaShhcGkpIHsKICAgICAgICBpZiAoYXBpLmlzQXBpKSB7CiAgICAgICAgICBzdmMucHJvdG90eXBlLmFwaSA9IGFwaTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3ZjLnByb3RvdHlwZS5hcGkgPSBuZXcgQXBpKGFwaSk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIGlmICh0eXBlb2YgdmVyc2lvbiA9PT0gJ3N0cmluZycpIHsKICAgICAgICBpZiAoYXBpQ29uZmlnKSB7CiAgICAgICAgICBzZXRBcGkoYXBpQ29uZmlnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2V0QXBpKEFXUy5hcGlMb2FkZXIoc3VwZXJjbGFzcy5zZXJ2aWNlSWRlbnRpZmllciwgdmVyc2lvbikpOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKGVyciwgewogICAgICAgICAgICAgIG1lc3NhZ2U6ICdDb3VsZCBub3QgZmluZCBBUEkgY29uZmlndXJhdGlvbiAnICsKICAgICAgICAgICAgICAgIHN1cGVyY2xhc3Muc2VydmljZUlkZW50aWZpZXIgKyAnLScgKyB2ZXJzaW9uCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzdXBlcmNsYXNzLnNlcnZpY2VzLCB2ZXJzaW9uKSkgewogICAgICAgICAgc3VwZXJjbGFzcy5hcGlWZXJzaW9ucyA9IHN1cGVyY2xhc3MuYXBpVmVyc2lvbnMuY29uY2F0KHZlcnNpb24pLnNvcnQoKTsKICAgICAgICB9CiAgICAgICAgc3VwZXJjbGFzcy5zZXJ2aWNlc1t2ZXJzaW9uXSA9IHN2YzsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXRBcGkodmVyc2lvbik7CiAgICAgIH0KICAKICAgICAgQVdTLlNlcnZpY2UuZGVmaW5lTWV0aG9kcyhzdmMpOwogICAgICByZXR1cm4gc3ZjOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGhhc1NlcnZpY2U6IGZ1bmN0aW9uKGlkZW50aWZpZXIpIHsKICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChBV1MuU2VydmljZS5fc2VydmljZU1hcCwgaWRlbnRpZmllcik7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcGFyYW0gYXR0YWNoT24gYXR0YWNoIGRlZmF1bHQgbW9uaXRvcmluZyBsaXN0ZW5lcnMgdG8gb2JqZWN0CiAgICAgKgogICAgICogRWFjaCBtb25pdG9yaW5nIGV2ZW50IHNob3VsZCBiZSBlbWl0dGVkIGZyb20gc2VydmljZSBjbGllbnQgdG8gc2VydmljZSBjb25zdHJ1Y3RvciBwcm90b3R5cGUgYW5kIHRoZW4KICAgICAqIHRvIGdsb2JhbCBzZXJ2aWNlIHByb3RvdHlwZSBsaWtlIGJ1YmJsaW5nIHVwLiBUaGVzZSBkZWZhdWx0IG1vbml0b3JpbmcgZXZlbnRzIGxpc3RlbmVyIHdpbGwgdHJhbnNmZXIKICAgICAqIHRoZSBtb25pdG9yaW5nIGV2ZW50cyB0byB0aGUgdXBwZXIgbGF5ZXIuCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYWRkRGVmYXVsdE1vbml0b3JpbmdMaXN0ZW5lcnM6IGZ1bmN0aW9uIGFkZERlZmF1bHRNb25pdG9yaW5nTGlzdGVuZXJzKGF0dGFjaE9uKSB7CiAgICAgIGF0dGFjaE9uLmFkZE5hbWVkTGlzdGVuZXIoJ01PTklUT1JfRVZFTlRTX0JVQkJMRScsICdhcGlDYWxsQXR0ZW1wdCcsIGZ1bmN0aW9uIEVWRU5UU19CVUJCTEUoZXZlbnQpIHsKICAgICAgICB2YXIgYmFzZUNsYXNzID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGF0dGFjaE9uKTsKICAgICAgICBpZiAoYmFzZUNsYXNzLl9ldmVudHMpIGJhc2VDbGFzcy5lbWl0KCdhcGlDYWxsQXR0ZW1wdCcsIFtldmVudF0pOwogICAgICB9KTsKICAgICAgYXR0YWNoT24uYWRkTmFtZWRMaXN0ZW5lcignQ0FMTF9FVkVOVFNfQlVCQkxFJywgJ2FwaUNhbGwnLCBmdW5jdGlvbiBDQUxMX0VWRU5UU19CVUJCTEUoZXZlbnQpIHsKICAgICAgICB2YXIgYmFzZUNsYXNzID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGF0dGFjaE9uKTsKICAgICAgICBpZiAoYmFzZUNsYXNzLl9ldmVudHMpIGJhc2VDbGFzcy5lbWl0KCdhcGlDYWxsJywgW2V2ZW50XSk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIF9zZXJ2aWNlTWFwOiB7fQogIH0pOwogIAogIEFXUy51dGlsLm1peGluKEFXUy5TZXJ2aWNlLCBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TZXJ2aWNlOwogIAogIH0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQogIH0seyIuL2NvcmUiOjE4LCIuL21vZGVsL2FwaSI6MzgsIi4vcmVnaW9uX2NvbmZpZyI6NTMsIl9wcm9jZXNzIjo4NX1dLDYwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIAogIEFXUy51dGlsLnVwZGF0ZShBV1MuQ29nbml0b0lkZW50aXR5LnByb3RvdHlwZSwgewogICAgZ2V0T3BlbklkVG9rZW46IGZ1bmN0aW9uIGdldE9wZW5JZFRva2VuKHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHRoaXMubWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3QoJ2dldE9wZW5JZFRva2VuJywgcGFyYW1zLCBjYWxsYmFjayk7CiAgICB9LAogIAogICAgZ2V0SWQ6IGZ1bmN0aW9uIGdldElkKHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHRoaXMubWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3QoJ2dldElkJywgcGFyYW1zLCBjYWxsYmFjayk7CiAgICB9LAogIAogICAgZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eTogZnVuY3Rpb24gZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eShwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLm1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KCdnZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5JywgcGFyYW1zLCBjYWxsYmFjayk7CiAgICB9CiAgfSk7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sNjE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAocHJvY2Vzcyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgcmVnaW9uQ29uZmlnID0gcmVxdWlyZSgnLi4vcmVnaW9uX2NvbmZpZycpOwogIHZhciBFTlZfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRCA9ICdBV1NfU1RTX1JFR0lPTkFMX0VORFBPSU5UUyc7CiAgdmFyIENPTkZJR19SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEID0gJ3N0c19yZWdpb25hbF9lbmRwb2ludHMnOwogIAogIEFXUy51dGlsLnVwZGF0ZShBV1MuU1RTLnByb3RvdHlwZSwgewogICAgLyoqCiAgICAgKiBAb3ZlcmxvYWQgY3JlZGVudGlhbHNGcm9tKGRhdGEsIGNyZWRlbnRpYWxzID0gbnVsbCkKICAgICAqICAgQ3JlYXRlcyBhIGNyZWRlbnRpYWxzIG9iamVjdCBmcm9tIFNUUyByZXNwb25zZSBkYXRhIGNvbnRhaW5pbmcKICAgICAqICAgY3JlZGVudGlhbHMgaW5mb3JtYXRpb24uIFVzZWZ1bCBmb3IgcXVpY2tseSBzZXR0aW5nIEFXUyBjcmVkZW50aWFscy4KICAgICAqCiAgICAgKiAgIEBub3RlIFRoaXMgaXMgYSBsb3ctbGV2ZWwgdXRpbGl0eSBmdW5jdGlvbi4gSWYgeW91IHdhbnQgdG8gbG9hZCB0ZW1wb3JhcnkKICAgICAqICAgICBjcmVkZW50aWFscyBpbnRvIHlvdXIgcHJvY2VzcyBmb3Igc3Vic2VxdWVudCByZXF1ZXN0cyB0byBBV1MgcmVzb3VyY2VzLAogICAgICogICAgIHlvdSBzaG91bGQgdXNlIHtBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHN9IGluc3RlYWQuCiAgICAgKiAgIEBwYXJhbSBkYXRhIFttYXBdIGRhdGEgcmV0cmlldmVkIGZyb20gYSBjYWxsIHRvIHtnZXRGZWRlcmF0ZWRUb2tlbn0sCiAgICAgKiAgICAge2dldFNlc3Npb25Ub2tlbn0sIHthc3N1bWVSb2xlfSwgb3Ige2Fzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LgogICAgICogICBAcGFyYW0gY3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gYW4gb3B0aW9uYWwgY3JlZGVudGlhbHMgb2JqZWN0IHRvCiAgICAgKiAgICAgZmlsbCBpbnN0ZWFkIG9mIGNyZWF0aW5nIGEgbmV3IG9iamVjdC4gVXNlZnVsIHdoZW4gbW9kaWZ5aW5nIGFuCiAgICAgKiAgICAgZXhpc3RpbmcgY3JlZGVudGlhbHMgb2JqZWN0IGZyb20gYSByZWZyZXNoIGNhbGwuCiAgICAgKiAgIEByZXR1cm4gW0FXUy5UZW1wb3JhcnlDcmVkZW50aWFsc10gdGhlIHNldCBvZiB0ZW1wb3JhcnkgY3JlZGVudGlhbHMKICAgICAqICAgICBsb2FkZWQgZnJvbSBhIHJhdyBTVFMgb3BlcmF0aW9uIHJlc3BvbnNlLgogICAgICogICBAZXhhbXBsZSBVc2luZyBjcmVkZW50aWFsc0Zyb20gdG8gbG9hZCBnbG9iYWwgQVdTIGNyZWRlbnRpYWxzCiAgICAgKiAgICAgdmFyIHN0cyA9IG5ldyBBV1MuU1RTKCk7CiAgICAgKiAgICAgc3RzLmdldFNlc3Npb25Ub2tlbihmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgKiAgICAgICBpZiAoZXJyKSBjb25zb2xlLmxvZygiRXJyb3IgZ2V0dGluZyBjcmVkZW50aWFscyIpOwogICAgICogICAgICAgZWxzZSB7CiAgICAgKiAgICAgICAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBzdHMuY3JlZGVudGlhbHNGcm9tKGRhdGEpOwogICAgICogICAgICAgfQogICAgICogICAgIH0pOwogICAgICogICBAc2VlIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscwogICAgICovCiAgICBjcmVkZW50aWFsc0Zyb206IGZ1bmN0aW9uIGNyZWRlbnRpYWxzRnJvbShkYXRhLCBjcmVkZW50aWFscykgewogICAgICBpZiAoIWRhdGEpIHJldHVybiBudWxsOwogICAgICBpZiAoIWNyZWRlbnRpYWxzKSBjcmVkZW50aWFscyA9IG5ldyBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMoKTsKICAgICAgY3JlZGVudGlhbHMuZXhwaXJlZCA9IGZhbHNlOwogICAgICBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCA9IGRhdGEuQ3JlZGVudGlhbHMuQWNjZXNzS2V5SWQ7CiAgICAgIGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSA9IGRhdGEuQ3JlZGVudGlhbHMuU2VjcmV0QWNjZXNzS2V5OwogICAgICBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4gPSBkYXRhLkNyZWRlbnRpYWxzLlNlc3Npb25Ub2tlbjsKICAgICAgY3JlZGVudGlhbHMuZXhwaXJlVGltZSA9IGRhdGEuQ3JlZGVudGlhbHMuRXhwaXJhdGlvbjsKICAgICAgcmV0dXJuIGNyZWRlbnRpYWxzOwogICAgfSwKICAKICAgIGFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHk6IGZ1bmN0aW9uIGFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkocGFyYW1zLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5tYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdCgnYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eScsIHBhcmFtcywgY2FsbGJhY2spOwogICAgfSwKICAKICAgIGFzc3VtZVJvbGVXaXRoU0FNTDogZnVuY3Rpb24gYXNzdW1lUm9sZVdpdGhTQU1MKHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHRoaXMubWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3QoJ2Fzc3VtZVJvbGVXaXRoU0FNTCcsIHBhcmFtcywgY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnVmFsdWU6IGZ1bmN0aW9uIHZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnVmFsdWUoY29uZmlnVmFsdWUsIGVycm9yT3B0aW9ucykgewogICAgICBpZiAodHlwZW9mIGNvbmZpZ1ZhbHVlID09PSAnc3RyaW5nJyAmJiBbJ2xlZ2FjeScsICdyZWdpb25hbCddLmluZGV4T2YoY29uZmlnVmFsdWUudG9Mb3dlckNhc2UoKSkgPj0gMCkgewogICAgICAgIHRoaXMuY29uZmlnLnN0c1JlZ2lvbmFsRW5kcG9pbnRzID0gY29uZmlnVmFsdWUudG9Mb3dlckNhc2UoKTsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksIGVycm9yT3B0aW9ucyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICB2YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZzogZnVuY3Rpb24gdmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWcoKSB7CiAgICAgIC8vdmFsaWRhdGUgY29uZmlnIHZhbHVlCiAgICAgIHZhciBjb25maWcgPSB0aGlzLmNvbmZpZzsKICAgICAgaWYgKGNvbmZpZy5zdHNSZWdpb25hbEVuZHBvaW50cykgewogICAgICAgIHRoaXMudmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWdWYWx1ZShjb25maWcuc3RzUmVnaW9uYWxFbmRwb2ludHMsIHsKICAgICAgICAgIGNvZGU6ICdJbnZhbGlkQ29uZmlndXJhdGlvbicsCiAgICAgICAgICBtZXNzYWdlOiAnaW52YWxpZCAic3RzUmVnaW9uYWxFbmRwb2ludHMiIGNvbmZpZ3VyYXRpb24uIEV4cGVjdCAibGVnYWN5IiAnICsKICAgICAgICAgICcgb3IgInJlZ2lvbmFsIi4gR290ICInICsgY29uZmlnLnN0c1JlZ2lvbmFsRW5kcG9pbnRzICsgJyIuJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICghQVdTLnV0aWwuaXNOb2RlKCkpIHJldHVybjsKICAgICAgLy92YWxpZGF0ZSBlbnZpcm9ubWVudGFsIHZhcmlhYmxlCiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocHJvY2Vzcy5lbnYsIEVOVl9SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEKSkgewogICAgICAgIHZhciBlbnZGbGFnID0gcHJvY2Vzcy5lbnZbRU5WX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRURdOwogICAgICAgIHRoaXMudmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWdWYWx1ZShlbnZGbGFnLCB7CiAgICAgICAgICBjb2RlOiAnSW52YWxpZEVudmlyb25tZW50YWxWYXJpYWJsZScsCiAgICAgICAgICBtZXNzYWdlOiAnaW52YWxpZCAnICsgRU5WX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQgKyAnIGVudmlyb25tZW50YWwgdmFyaWFibGUuIEV4cGVjdCAibGVnYWN5IiAnICsKICAgICAgICAgICcgb3IgInJlZ2lvbmFsIi4gR290ICInICsgcHJvY2Vzcy5lbnZbRU5WX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRURdICsgJyIuJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIC8vdmFsaWRhdGUgc2hhcmVkIGNvbmZpZyBmaWxlCiAgICAgIHZhciBwcm9maWxlID0ge307CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIHByb2ZpbGVzID0gQVdTLnV0aWwuZ2V0UHJvZmlsZXNGcm9tU2hhcmVkQ29uZmlnKEFXUy51dGlsLmluaUxvYWRlcik7CiAgICAgICAgcHJvZmlsZSA9IHByb2ZpbGVzW3Byb2Nlc3MuZW52LkFXU19QUk9GSUxFIHx8IEFXUy51dGlsLmRlZmF1bHRQcm9maWxlXTsKICAgICAgfSBjYXRjaCAoZSkge307CiAgICAgIGlmIChwcm9maWxlICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwcm9maWxlLCBDT05GSUdfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRCkpIHsKICAgICAgICB2YXIgZmlsZUZsYWcgPSBwcm9maWxlW0NPTkZJR19SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEXTsKICAgICAgICB0aGlzLnZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnVmFsdWUoZmlsZUZsYWcsIHsKICAgICAgICAgIGNvZGU6ICdJbnZhbGlkQ29uZmlndXJhdGlvbicsCiAgICAgICAgICBtZXNzYWdlOiAnaW52YWxpZCAnK0NPTkZJR19SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEKycgcHJvZmlsZSBjb25maWcuIEV4cGVjdCAibGVnYWN5IiAnICsKICAgICAgICAgICcgb3IgInJlZ2lvbmFsIi4gR290ICInICsgcHJvZmlsZVtDT05GSUdfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRF0gKyAnIi4nCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBvcHRJblJlZ2lvbmFsRW5kcG9pbnQ6IGZ1bmN0aW9uIG9wdEluUmVnaW9uYWxFbmRwb2ludCgpIHsKICAgICAgdGhpcy52YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZygpOwogICAgICB2YXIgY29uZmlnID0gdGhpcy5jb25maWc7CiAgICAgIGlmIChjb25maWcuc3RzUmVnaW9uYWxFbmRwb2ludHMgPT09ICdyZWdpb25hbCcpIHsKICAgICAgICByZWdpb25Db25maWcodGhpcyk7CiAgICAgICAgaWYgKCF0aGlzLmlzR2xvYmFsRW5kcG9pbnQpIHJldHVybjsKICAgICAgICB0aGlzLmlzR2xvYmFsRW5kcG9pbnQgPSBmYWxzZTsKICAgICAgICAvL2NsaWVudCB3aWxsIHRocm93IGlmIHJlZ2lvbiBpcyBub3Qgc3VwcGxpZWQ7IHJlcXVlc3Qgd2lsbCBiZSBzaWduZWQgd2l0aCBzcGVjaWZpZWQgcmVnaW9uCiAgICAgICAgaWYgKCFjb25maWcucmVnaW9uKSB7CiAgICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgICAge2NvZGU6ICdDb25maWdFcnJvcicsIG1lc3NhZ2U6ICdNaXNzaW5nIHJlZ2lvbiBpbiBjb25maWcnfSk7CiAgICAgICAgfQogICAgICAgIHZhciBpbnNlcnRQb2ludCA9IGNvbmZpZy5lbmRwb2ludC5pbmRleE9mKCcuYW1hem9uYXdzLmNvbScpOwogICAgICAgIGNvbmZpZy5lbmRwb2ludCA9IGNvbmZpZy5lbmRwb2ludC5zdWJzdHJpbmcoMCwgaW5zZXJ0UG9pbnQpICsKICAgICAgICAgICcuJyArIGNvbmZpZy5yZWdpb24gKyBjb25maWcuZW5kcG9pbnQuc3Vic3RyaW5nKGluc2VydFBvaW50KTsKICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlU2VydmljZTogZnVuY3Rpb24gdmFsaWRhdGVTZXJ2aWNlKCkgewogICAgICB0aGlzLm9wdEluUmVnaW9uYWxFbmRwb2ludCgpOwogICAgfQogIAogIH0pOwogIAogIH0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQogIH0seyIuLi9jb3JlIjoxOCwiLi4vcmVnaW9uX2NvbmZpZyI6NTMsIl9wcm9jZXNzIjo4NX1dLDYyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgZXhwaXJlc0hlYWRlciA9ICdwcmVzaWduZWQtZXhwaXJlcyc7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gc2lnbmVkVXJsQnVpbGRlcihyZXF1ZXN0KSB7CiAgICB2YXIgZXhwaXJlcyA9IHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXTsKICAgIHZhciBzaWduZXJDbGFzcyA9IHJlcXVlc3Quc2VydmljZS5nZXRTaWduZXJDbGFzcyhyZXF1ZXN0KTsKICAKICAgIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1VzZXItQWdlbnQnXTsKICAgIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LVVzZXItQWdlbnQnXTsKICAKICAgIGlmIChzaWduZXJDbGFzcyA9PT0gQVdTLlNpZ25lcnMuVjQpIHsKICAgICAgaWYgKGV4cGlyZXMgPiA2MDQ4MDApIHsgLy8gb25lIHdlZWsgZXhwaXJ5IGlzIGludmFsaWQKICAgICAgICB2YXIgbWVzc2FnZSA9ICdQcmVzaWduaW5nIGRvZXMgbm90IHN1cHBvcnQgZXhwaXJ5IHRpbWUgZ3JlYXRlciAnICsKICAgICAgICAgICAgICAgICAgICAgICd0aGFuIGEgd2VlayB3aXRoIFNpZ1Y0IHNpZ25pbmcuJzsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgICAgY29kZTogJ0ludmFsaWRFeHBpcnlUaW1lJywgbWVzc2FnZTogbWVzc2FnZSwgcmV0cnlhYmxlOiBmYWxzZQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXSA9IGV4cGlyZXM7CiAgICB9IGVsc2UgaWYgKHNpZ25lckNsYXNzID09PSBBV1MuU2lnbmVycy5TMykgewogICAgICB2YXIgbm93ID0gcmVxdWVzdC5zZXJ2aWNlID8gcmVxdWVzdC5zZXJ2aWNlLmdldFNrZXdDb3JyZWN0ZWREYXRlKCkgOiBBV1MudXRpbC5kYXRlLmdldERhdGUoKTsKICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdID0gcGFyc2VJbnQoCiAgICAgICAgQVdTLnV0aWwuZGF0ZS51bml4VGltZXN0YW1wKG5vdykgKyBleHBpcmVzLCAxMCkudG9TdHJpbmcoKTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgbWVzc2FnZTogJ1ByZXNpZ25pbmcgb25seSBzdXBwb3J0cyBTMyBvciBTaWdWNCBzaWduaW5nLicsCiAgICAgICAgY29kZTogJ1Vuc3VwcG9ydGVkU2lnbmVyJywgcmV0cnlhYmxlOiBmYWxzZQogICAgICB9KTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gc2lnbmVkVXJsU2lnbmVyKHJlcXVlc3QpIHsKICAgIHZhciBlbmRwb2ludCA9IHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQ7CiAgICB2YXIgcGFyc2VkVXJsID0gQVdTLnV0aWwudXJsUGFyc2UocmVxdWVzdC5odHRwUmVxdWVzdC5wYXRoKTsKICAgIHZhciBxdWVyeVBhcmFtcyA9IHt9OwogIAogICAgaWYgKHBhcnNlZFVybC5zZWFyY2gpIHsKICAgICAgcXVlcnlQYXJhbXMgPSBBV1MudXRpbC5xdWVyeVN0cmluZ1BhcnNlKHBhcnNlZFVybC5zZWFyY2guc3Vic3RyKDEpKTsKICAgIH0KICAKICAgIHZhciBhdXRoID0gcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydBdXRob3JpemF0aW9uJ10uc3BsaXQoJyAnKTsKICAgIGlmIChhdXRoWzBdID09PSAnQVdTJykgewogICAgICBhdXRoID0gYXV0aFsxXS5zcGxpdCgnOicpOwogICAgICBxdWVyeVBhcmFtc1snQVdTQWNjZXNzS2V5SWQnXSA9IGF1dGhbMF07CiAgICAgIHF1ZXJ5UGFyYW1zWydTaWduYXR1cmUnXSA9IGF1dGhbMV07CiAgCiAgICAgIEFXUy51dGlsLmVhY2gocmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgIGlmIChrZXkgPT09IGV4cGlyZXNIZWFkZXIpIGtleSA9ICdFeHBpcmVzJzsKICAgICAgICBpZiAoa2V5LmluZGV4T2YoJ3gtYW16LW1ldGEtJykgPT09IDApIHsKICAgICAgICAgIC8vIERlbGV0ZSBleGlzdGluZywgcG90ZW50aWFsbHkgbm90IG5vcm1hbGl6ZWQga2V5CiAgICAgICAgICBkZWxldGUgcXVlcnlQYXJhbXNba2V5XTsKICAgICAgICAgIGtleSA9IGtleS50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0KICAgICAgICBxdWVyeVBhcmFtc1trZXldID0gdmFsdWU7CiAgICAgIH0pOwogICAgICBkZWxldGUgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdOwogICAgICBkZWxldGUgcXVlcnlQYXJhbXNbJ0F1dGhvcml6YXRpb24nXTsKICAgICAgZGVsZXRlIHF1ZXJ5UGFyYW1zWydIb3N0J107CiAgICB9IGVsc2UgaWYgKGF1dGhbMF0gPT09ICdBV1M0LUhNQUMtU0hBMjU2JykgeyAvLyBTaWdWNCBzaWduaW5nCiAgICAgIGF1dGguc2hpZnQoKTsKICAgICAgdmFyIHJlc3QgPSBhdXRoLmpvaW4oJyAnKTsKICAgICAgdmFyIHNpZ25hdHVyZSA9IHJlc3QubWF0Y2goL1NpZ25hdHVyZT0oLio/KSg/Oix8XHN8XHI/XG58JCkvKVsxXTsKICAgICAgcXVlcnlQYXJhbXNbJ1gtQW16LVNpZ25hdHVyZSddID0gc2lnbmF0dXJlOwogICAgICBkZWxldGUgcXVlcnlQYXJhbXNbJ0V4cGlyZXMnXTsKICAgIH0KICAKICAgIC8vIGJ1aWxkIFVSTAogICAgZW5kcG9pbnQucGF0aG5hbWUgPSBwYXJzZWRVcmwucGF0aG5hbWU7CiAgICBlbmRwb2ludC5zZWFyY2ggPSBBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHF1ZXJ5UGFyYW1zKTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuUHJlc2lnbiA9IGluaGVyaXQoewogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc2lnbjogZnVuY3Rpb24gc2lnbihyZXF1ZXN0LCBleHBpcmVUaW1lLCBjYWxsYmFjaykgewogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl0gPSBleHBpcmVUaW1lIHx8IDM2MDA7CiAgICAgIHJlcXVlc3Qub24oJ2J1aWxkJywgc2lnbmVkVXJsQnVpbGRlcik7CiAgICAgIHJlcXVlc3Qub24oJ3NpZ24nLCBzaWduZWRVcmxTaWduZXIpOwogICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdhZnRlckJ1aWxkJywKICAgICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5TRVRfQ09OVEVOVF9MRU5HVEgpOwogICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdhZnRlckJ1aWxkJywKICAgICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5DT01QVVRFX1NIQTI1Nik7CiAgCiAgICAgIHJlcXVlc3QuZW1pdCgnYmVmb3JlUHJlc2lnbicsIFtyZXF1ZXN0XSk7CiAgCiAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgIHJlcXVlc3QuYnVpbGQoZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAodGhpcy5yZXNwb25zZS5lcnJvcikgY2FsbGJhY2sodGhpcy5yZXNwb25zZS5lcnJvcik7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgQVdTLnV0aWwudXJsRm9ybWF0KHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQpKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXF1ZXN0LmJ1aWxkKCk7CiAgICAgICAgaWYgKHJlcXVlc3QucmVzcG9uc2UuZXJyb3IpIHRocm93IHJlcXVlc3QucmVzcG9uc2UuZXJyb3I7CiAgICAgICAgcmV0dXJuIEFXUy51dGlsLnVybEZvcm1hdChyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50KTsKICAgICAgfQogICAgfQogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuUHJlc2lnbjsKICAKICB9LHsiLi4vY29yZSI6MTh9XSw2MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICAKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lciA9IGluaGVyaXQoewogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFJlcXVlc3RTaWduZXIocmVxdWVzdCkgewogICAgICB0aGlzLnJlcXVlc3QgPSByZXF1ZXN0OwogICAgfSwKICAKICAgIHNldFNlcnZpY2VDbGllbnRJZDogZnVuY3Rpb24gc2V0U2VydmljZUNsaWVudElkKGlkKSB7CiAgICAgIHRoaXMuc2VydmljZUNsaWVudElkID0gaWQ7CiAgICB9LAogIAogICAgZ2V0U2VydmljZUNsaWVudElkOiBmdW5jdGlvbiBnZXRTZXJ2aWNlQ2xpZW50SWQoKSB7CiAgICAgIHJldHVybiB0aGlzLnNlcnZpY2VDbGllbnRJZDsKICAgIH0KICB9KTsKICAKICBBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLmdldFZlcnNpb24gPSBmdW5jdGlvbiBnZXRWZXJzaW9uKHZlcnNpb24pIHsKICAgIHN3aXRjaCAodmVyc2lvbikgewogICAgICBjYXNlICd2Mic6IHJldHVybiBBV1MuU2lnbmVycy5WMjsKICAgICAgY2FzZSAndjMnOiByZXR1cm4gQVdTLlNpZ25lcnMuVjM7CiAgICAgIGNhc2UgJ3MzdjQnOiByZXR1cm4gQVdTLlNpZ25lcnMuVjQ7CiAgICAgIGNhc2UgJ3Y0JzogcmV0dXJuIEFXUy5TaWduZXJzLlY0OwogICAgICBjYXNlICdzMyc6IHJldHVybiBBV1MuU2lnbmVycy5TMzsKICAgICAgY2FzZSAndjNodHRwcyc6IHJldHVybiBBV1MuU2lnbmVycy5WM0h0dHBzOwogICAgfQogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHNpZ25pbmcgdmVyc2lvbiAnICsgdmVyc2lvbik7CiAgfTsKICAKICByZXF1aXJlKCcuL3YyJyk7CiAgcmVxdWlyZSgnLi92MycpOwogIHJlcXVpcmUoJy4vdjNodHRwcycpOwogIHJlcXVpcmUoJy4vdjQnKTsKICByZXF1aXJlKCcuL3MzJyk7CiAgcmVxdWlyZSgnLi9wcmVzaWduJyk7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuL3ByZXNpZ24iOjYyLCIuL3MzIjo2NCwiLi92MiI6NjUsIi4vdjMiOjY2LCIuL3YzaHR0cHMiOjY3LCIuL3Y0Ijo2OH1dLDY0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuU2lnbmVycy5TMyA9IGluaGVyaXQoQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lciwgewogICAgLyoqCiAgICAgKiBXaGVuIGJ1aWxkaW5nIHRoZSBzdHJpbmdUb1NpZ24sIHRoZXNlIHN1YiByZXNvdXJjZSBwYXJhbXMgc2hvdWxkIGJlCiAgICAgKiBwYXJ0IG9mIHRoZSBjYW5vbmljYWwgcmVzb3VyY2Ugc3RyaW5nIHdpdGggdGhlaXIgTk9OLWRlY29kZWQgdmFsdWVzCiAgICAgKi8KICAgIHN1YlJlc291cmNlczogewogICAgICAnYWNsJzogMSwKICAgICAgJ2FjY2VsZXJhdGUnOiAxLAogICAgICAnYW5hbHl0aWNzJzogMSwKICAgICAgJ2NvcnMnOiAxLAogICAgICAnbGlmZWN5Y2xlJzogMSwKICAgICAgJ2RlbGV0ZSc6IDEsCiAgICAgICdpbnZlbnRvcnknOiAxLAogICAgICAnbG9jYXRpb24nOiAxLAogICAgICAnbG9nZ2luZyc6IDEsCiAgICAgICdtZXRyaWNzJzogMSwKICAgICAgJ25vdGlmaWNhdGlvbic6IDEsCiAgICAgICdwYXJ0TnVtYmVyJzogMSwKICAgICAgJ3BvbGljeSc6IDEsCiAgICAgICdyZXF1ZXN0UGF5bWVudCc6IDEsCiAgICAgICdyZXBsaWNhdGlvbic6IDEsCiAgICAgICdyZXN0b3JlJzogMSwKICAgICAgJ3RhZ2dpbmcnOiAxLAogICAgICAndG9ycmVudCc6IDEsCiAgICAgICd1cGxvYWRJZCc6IDEsCiAgICAgICd1cGxvYWRzJzogMSwKICAgICAgJ3ZlcnNpb25JZCc6IDEsCiAgICAgICd2ZXJzaW9uaW5nJzogMSwKICAgICAgJ3ZlcnNpb25zJzogMSwKICAgICAgJ3dlYnNpdGUnOiAxCiAgICB9LAogIAogICAgLy8gd2hlbiBidWlsZGluZyB0aGUgc3RyaW5nVG9TaWduLCB0aGVzZSBxdWVyeXN0cmluZyBwYXJhbXMgc2hvdWxkIGJlCiAgICAvLyBwYXJ0IG9mIHRoZSBjYW5vbmljYWwgcmVzb3VyY2Ugc3RyaW5nIHdpdGggdGhlaXIgTk9OLWVuY29kZWQgdmFsdWVzCiAgICByZXNwb25zZUhlYWRlcnM6IHsKICAgICAgJ3Jlc3BvbnNlLWNvbnRlbnQtdHlwZSc6IDEsCiAgICAgICdyZXNwb25zZS1jb250ZW50LWxhbmd1YWdlJzogMSwKICAgICAgJ3Jlc3BvbnNlLWV4cGlyZXMnOiAxLAogICAgICAncmVzcG9uc2UtY2FjaGUtY29udHJvbCc6IDEsCiAgICAgICdyZXNwb25zZS1jb250ZW50LWRpc3Bvc2l0aW9uJzogMSwKICAgICAgJ3Jlc3BvbnNlLWNvbnRlbnQtZW5jb2RpbmcnOiAxCiAgICB9LAogIAogICAgYWRkQXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYWRkQXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZSkgewogICAgICBpZiAoIXRoaXMucmVxdWVzdC5oZWFkZXJzWydwcmVzaWduZWQtZXhwaXJlcyddKSB7CiAgICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXSA9IEFXUy51dGlsLmRhdGUucmZjODIyKGRhdGUpOwogICAgICB9CiAgCiAgICAgIGlmIChjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4pIHsKICAgICAgICAvLyBwcmVzaWduZWQgVVJMcyByZXF1aXJlIHRoaXMgaGVhZGVyIHRvIGJlIGxvd2VyY2FzZWQKICAgICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1sneC1hbXotc2VjdXJpdHktdG9rZW4nXSA9IGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbjsKICAgICAgfQogIAogICAgICB2YXIgc2lnbmF0dXJlID0gdGhpcy5zaWduKGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSwgdGhpcy5zdHJpbmdUb1NpZ24oKSk7CiAgICAgIHZhciBhdXRoID0gJ0FXUyAnICsgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgKyAnOicgKyBzaWduYXR1cmU7CiAgCiAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydBdXRob3JpemF0aW9uJ10gPSBhdXRoOwogICAgfSwKICAKICAgIHN0cmluZ1RvU2lnbjogZnVuY3Rpb24gc3RyaW5nVG9TaWduKCkgewogICAgICB2YXIgciA9IHRoaXMucmVxdWVzdDsKICAKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIHBhcnRzLnB1c2goci5tZXRob2QpOwogICAgICBwYXJ0cy5wdXNoKHIuaGVhZGVyc1snQ29udGVudC1NRDUnXSB8fCAnJyk7CiAgICAgIHBhcnRzLnB1c2goci5oZWFkZXJzWydDb250ZW50LVR5cGUnXSB8fCAnJyk7CiAgCiAgICAgIC8vIFRoaXMgaXMgdGhlICJEYXRlIiBoZWFkZXIsIGJ1dCB3ZSB1c2UgWC1BbXotRGF0ZS4KICAgICAgLy8gVGhlIFMzIHNpZ25pbmcgbWVjaGFuaXNtIHJlcXVpcmVzIHVzIHRvIHBhc3MgYW4gZW1wdHkKICAgICAgLy8gc3RyaW5nIGZvciB0aGlzIERhdGUgaGVhZGVyIHJlZ2FyZGxlc3MuCiAgICAgIHBhcnRzLnB1c2goci5oZWFkZXJzWydwcmVzaWduZWQtZXhwaXJlcyddIHx8ICcnKTsKICAKICAgICAgdmFyIGhlYWRlcnMgPSB0aGlzLmNhbm9uaWNhbGl6ZWRBbXpIZWFkZXJzKCk7CiAgICAgIGlmIChoZWFkZXJzKSBwYXJ0cy5wdXNoKGhlYWRlcnMpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMuY2Fub25pY2FsaXplZFJlc291cmNlKCkpOwogIAogICAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKICAKICAgIH0sCiAgCiAgICBjYW5vbmljYWxpemVkQW16SGVhZGVyczogZnVuY3Rpb24gY2Fub25pY2FsaXplZEFtekhlYWRlcnMoKSB7CiAgCiAgICAgIHZhciBhbXpIZWFkZXJzID0gW107CiAgCiAgICAgIEFXUy51dGlsLmVhY2godGhpcy5yZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgaWYgKG5hbWUubWF0Y2goL154LWFtei0vaSkpCiAgICAgICAgICBhbXpIZWFkZXJzLnB1c2gobmFtZSk7CiAgICAgIH0pOwogIAogICAgICBhbXpIZWFkZXJzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICByZXR1cm4gYS50b0xvd2VyQ2FzZSgpIDwgYi50b0xvd2VyQ2FzZSgpID8gLTEgOiAxOwogICAgICB9KTsKICAKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIEFXUy51dGlsLmFycmF5RWFjaC5jYWxsKHRoaXMsIGFtekhlYWRlcnMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgcGFydHMucHVzaChuYW1lLnRvTG93ZXJDYXNlKCkgKyAnOicgKyBTdHJpbmcodGhpcy5yZXF1ZXN0LmhlYWRlcnNbbmFtZV0pKTsKICAgICAgfSk7CiAgCiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogIAogICAgfSwKICAKICAgIGNhbm9uaWNhbGl6ZWRSZXNvdXJjZTogZnVuY3Rpb24gY2Fub25pY2FsaXplZFJlc291cmNlKCkgewogIAogICAgICB2YXIgciA9IHRoaXMucmVxdWVzdDsKICAKICAgICAgdmFyIHBhcnRzID0gci5wYXRoLnNwbGl0KCc/Jyk7CiAgICAgIHZhciBwYXRoID0gcGFydHNbMF07CiAgICAgIHZhciBxdWVyeXN0cmluZyA9IHBhcnRzWzFdOwogIAogICAgICB2YXIgcmVzb3VyY2UgPSAnJzsKICAKICAgICAgaWYgKHIudmlydHVhbEhvc3RlZEJ1Y2tldCkKICAgICAgICByZXNvdXJjZSArPSAnLycgKyByLnZpcnR1YWxIb3N0ZWRCdWNrZXQ7CiAgCiAgICAgIHJlc291cmNlICs9IHBhdGg7CiAgCiAgICAgIGlmIChxdWVyeXN0cmluZykgewogIAogICAgICAgIC8vIGNvbGxlY3QgYSBsaXN0IG9mIHN1YiByZXNvdXJjZXMgYW5kIHF1ZXJ5IHBhcmFtcyB0aGF0IG5lZWQgdG8gYmUgc2lnbmVkCiAgICAgICAgdmFyIHJlc291cmNlcyA9IFtdOwogIAogICAgICAgIEFXUy51dGlsLmFycmF5RWFjaC5jYWxsKHRoaXMsIHF1ZXJ5c3RyaW5nLnNwbGl0KCcmJyksIGZ1bmN0aW9uIChwYXJhbSkgewogICAgICAgICAgdmFyIG5hbWUgPSBwYXJhbS5zcGxpdCgnPScpWzBdOwogICAgICAgICAgdmFyIHZhbHVlID0gcGFyYW0uc3BsaXQoJz0nKVsxXTsKICAgICAgICAgIGlmICh0aGlzLnN1YlJlc291cmNlc1tuYW1lXSB8fCB0aGlzLnJlc3BvbnNlSGVhZGVyc1tuYW1lXSkgewogICAgICAgICAgICB2YXIgc3VicmVzb3VyY2UgPSB7IG5hbWU6IG5hbWUgfTsKICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5zdWJSZXNvdXJjZXNbbmFtZV0pIHsKICAgICAgICAgICAgICAgIHN1YnJlc291cmNlLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN1YnJlc291cmNlLnZhbHVlID0gZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzb3VyY2VzLnB1c2goc3VicmVzb3VyY2UpOwogICAgICAgICAgfQogICAgICAgIH0pOwogIAogICAgICAgIHJlc291cmNlcy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7IHJldHVybiBhLm5hbWUgPCBiLm5hbWUgPyAtMSA6IDE7IH0pOwogIAogICAgICAgIGlmIChyZXNvdXJjZXMubGVuZ3RoKSB7CiAgCiAgICAgICAgICBxdWVyeXN0cmluZyA9IFtdOwogICAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHJlc291cmNlcywgZnVuY3Rpb24gKHJlcykgewogICAgICAgICAgICBpZiAocmVzLnZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICBxdWVyeXN0cmluZy5wdXNoKHJlcy5uYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBxdWVyeXN0cmluZy5wdXNoKHJlcy5uYW1lICsgJz0nICsgcmVzLnZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgCiAgICAgICAgICByZXNvdXJjZSArPSAnPycgKyBxdWVyeXN0cmluZy5qb2luKCcmJyk7CiAgICAgICAgfQogIAogICAgICB9CiAgCiAgICAgIHJldHVybiByZXNvdXJjZTsKICAKICAgIH0sCiAgCiAgICBzaWduOiBmdW5jdGlvbiBzaWduKHNlY3JldCwgc3RyaW5nKSB7CiAgICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uaG1hYyhzZWNyZXQsIHN0cmluZywgJ2Jhc2U2NCcsICdzaGExJyk7CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5TMzsKICAKICB9LHsiLi4vY29yZSI6MTh9XSw2NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuVjIgPSBpbmhlcml0KEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIsIHsKICAgIGFkZEF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGFkZEF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGUpIHsKICAKICAgICAgaWYgKCFkYXRlKSBkYXRlID0gQVdTLnV0aWwuZGF0ZS5nZXREYXRlKCk7CiAgCiAgICAgIHZhciByID0gdGhpcy5yZXF1ZXN0OwogIAogICAgICByLnBhcmFtcy5UaW1lc3RhbXAgPSBBV1MudXRpbC5kYXRlLmlzbzg2MDEoZGF0ZSk7CiAgICAgIHIucGFyYW1zLlNpZ25hdHVyZVZlcnNpb24gPSAnMic7CiAgICAgIHIucGFyYW1zLlNpZ25hdHVyZU1ldGhvZCA9ICdIbWFjU0hBMjU2JzsKICAgICAgci5wYXJhbXMuQVdTQWNjZXNzS2V5SWQgPSBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZDsKICAKICAgICAgaWYgKGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbikgewogICAgICAgIHIucGFyYW1zLlNlY3VyaXR5VG9rZW4gPSBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW47CiAgICAgIH0KICAKICAgICAgZGVsZXRlIHIucGFyYW1zLlNpZ25hdHVyZTsgLy8gZGVsZXRlIG9sZCBTaWduYXR1cmUgZm9yIHJlLXNpZ25pbmcKICAgICAgci5wYXJhbXMuU2lnbmF0dXJlID0gdGhpcy5zaWduYXR1cmUoY3JlZGVudGlhbHMpOwogIAogICAgICByLmJvZHkgPSBBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHIucGFyYW1zKTsKICAgICAgci5oZWFkZXJzWydDb250ZW50LUxlbmd0aCddID0gci5ib2R5Lmxlbmd0aDsKICAgIH0sCiAgCiAgICBzaWduYXR1cmU6IGZ1bmN0aW9uIHNpZ25hdHVyZShjcmVkZW50aWFscykgewogICAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLmhtYWMoY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5LCB0aGlzLnN0cmluZ1RvU2lnbigpLCAnYmFzZTY0Jyk7CiAgICB9LAogIAogICAgc3RyaW5nVG9TaWduOiBmdW5jdGlvbiBzdHJpbmdUb1NpZ24oKSB7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5tZXRob2QpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5lbmRwb2ludC5ob3N0LnRvTG93ZXJDYXNlKCkpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5wYXRobmFtZSgpKTsKICAgICAgcGFydHMucHVzaChBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHRoaXMucmVxdWVzdC5wYXJhbXMpKTsKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CiAgICB9CiAgCiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5WMjsKICAKICB9LHsiLi4vY29yZSI6MTh9XSw2NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuVjMgPSBpbmhlcml0KEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIsIHsKICAgIGFkZEF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGFkZEF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGUpIHsKICAKICAgICAgdmFyIGRhdGV0aW1lID0gQVdTLnV0aWwuZGF0ZS5yZmM4MjIoZGF0ZSk7CiAgCiAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydYLUFtei1EYXRlJ10gPSBkYXRldGltZTsKICAKICAgICAgaWYgKGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbikgewogICAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWyd4LWFtei1zZWN1cml0eS10b2tlbiddID0gY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuOwogICAgICB9CiAgCiAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydYLUFtem4tQXV0aG9yaXphdGlvbiddID0KICAgICAgICB0aGlzLmF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGV0aW1lKTsKICAKICAgIH0sCiAgCiAgICBhdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzKSB7CiAgICAgIHJldHVybiAnQVdTMyAnICsKICAgICAgICAnQVdTQWNjZXNzS2V5SWQ9JyArIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJywnICsKICAgICAgICAnQWxnb3JpdGhtPUhtYWNTSEEyNTYsJyArCiAgICAgICAgJ1NpZ25lZEhlYWRlcnM9JyArIHRoaXMuc2lnbmVkSGVhZGVycygpICsgJywnICsKICAgICAgICAnU2lnbmF0dXJlPScgKyB0aGlzLnNpZ25hdHVyZShjcmVkZW50aWFscyk7CiAgICB9LAogIAogICAgc2lnbmVkSGVhZGVyczogZnVuY3Rpb24gc2lnbmVkSGVhZGVycygpIHsKICAgICAgdmFyIGhlYWRlcnMgPSBbXTsKICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHRoaXMuaGVhZGVyc1RvU2lnbigpLCBmdW5jdGlvbiBpdGVyYXRvcihoKSB7CiAgICAgICAgaGVhZGVycy5wdXNoKGgudG9Mb3dlckNhc2UoKSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gaGVhZGVycy5zb3J0KCkuam9pbignOycpOwogICAgfSwKICAKICAgIGNhbm9uaWNhbEhlYWRlcnM6IGZ1bmN0aW9uIGNhbm9uaWNhbEhlYWRlcnMoKSB7CiAgICAgIHZhciBoZWFkZXJzID0gdGhpcy5yZXF1ZXN0LmhlYWRlcnM7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICBBV1MudXRpbC5hcnJheUVhY2godGhpcy5oZWFkZXJzVG9TaWduKCksIGZ1bmN0aW9uIGl0ZXJhdG9yKGgpIHsKICAgICAgICBwYXJ0cy5wdXNoKGgudG9Mb3dlckNhc2UoKS50cmltKCkgKyAnOicgKyBTdHJpbmcoaGVhZGVyc1toXSkudHJpbSgpKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBwYXJ0cy5zb3J0KCkuam9pbignXG4nKSArICdcbic7CiAgICB9LAogIAogICAgaGVhZGVyc1RvU2lnbjogZnVuY3Rpb24gaGVhZGVyc1RvU2lnbigpIHsKICAgICAgdmFyIGhlYWRlcnMgPSBbXTsKICAgICAgQVdTLnV0aWwuZWFjaCh0aGlzLnJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gaXRlcmF0b3IoaykgewogICAgICAgIGlmIChrID09PSAnSG9zdCcgfHwgayA9PT0gJ0NvbnRlbnQtRW5jb2RpbmcnIHx8IGsubWF0Y2goL15YLUFtei9pKSkgewogICAgICAgICAgaGVhZGVycy5wdXNoKGspOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBoZWFkZXJzOwogICAgfSwKICAKICAgIHNpZ25hdHVyZTogZnVuY3Rpb24gc2lnbmF0dXJlKGNyZWRlbnRpYWxzKSB7CiAgICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uaG1hYyhjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXksIHRoaXMuc3RyaW5nVG9TaWduKCksICdiYXNlNjQnKTsKICAgIH0sCiAgCiAgICBzdHJpbmdUb1NpZ246IGZ1bmN0aW9uIHN0cmluZ1RvU2lnbigpIHsKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0Lm1ldGhvZCk7CiAgICAgIHBhcnRzLnB1c2goJy8nKTsKICAgICAgcGFydHMucHVzaCgnJyk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5jYW5vbmljYWxIZWFkZXJzKCkpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5ib2R5KTsKICAgICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5zaGEyNTYocGFydHMuam9pbignXG4nKSk7CiAgICB9CiAgCiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5WMzsKICAKICB9LHsiLi4vY29yZSI6MTh9XSw2NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgcmVxdWlyZSgnLi92MycpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5TaWduZXJzLlYzSHR0cHMgPSBpbmhlcml0KEFXUy5TaWduZXJzLlYzLCB7CiAgICBhdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzKSB7CiAgICAgIHJldHVybiAnQVdTMy1IVFRQUyAnICsKICAgICAgICAnQVdTQWNjZXNzS2V5SWQ9JyArIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJywnICsKICAgICAgICAnQWxnb3JpdGhtPUhtYWNTSEEyNTYsJyArCiAgICAgICAgJ1NpZ25hdHVyZT0nICsgdGhpcy5zaWduYXR1cmUoY3JlZGVudGlhbHMpOwogICAgfSwKICAKICAgIHN0cmluZ1RvU2lnbjogZnVuY3Rpb24gc3RyaW5nVG9TaWduKCkgewogICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXTsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlYzSHR0cHM7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuL3YzIjo2Nn1dLDY4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciB2NENyZWRlbnRpYWxzID0gcmVxdWlyZSgnLi92NF9jcmVkZW50aWFscycpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgZXhwaXJlc0hlYWRlciA9ICdwcmVzaWduZWQtZXhwaXJlcyc7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuVjQgPSBpbmhlcml0KEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIsIHsKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBWNChyZXF1ZXN0LCBzZXJ2aWNlTmFtZSwgb3B0aW9ucykgewogICAgICBBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLmNhbGwodGhpcywgcmVxdWVzdCk7CiAgICAgIHRoaXMuc2VydmljZU5hbWUgPSBzZXJ2aWNlTmFtZTsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHRoaXMuc2lnbmF0dXJlQ2FjaGUgPSB0eXBlb2Ygb3B0aW9ucy5zaWduYXR1cmVDYWNoZSA9PT0gJ2Jvb2xlYW4nID8gb3B0aW9ucy5zaWduYXR1cmVDYWNoZSA6IHRydWU7CiAgICAgIHRoaXMub3BlcmF0aW9uID0gb3B0aW9ucy5vcGVyYXRpb247CiAgICAgIHRoaXMuc2lnbmF0dXJlVmVyc2lvbiA9IG9wdGlvbnMuc2lnbmF0dXJlVmVyc2lvbjsKICAgIH0sCiAgCiAgICBhbGdvcml0aG06ICdBV1M0LUhNQUMtU0hBMjU2JywKICAKICAgIGFkZEF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGFkZEF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGUpIHsKICAgICAgdmFyIGRhdGV0aW1lID0gQVdTLnV0aWwuZGF0ZS5pc284NjAxKGRhdGUpLnJlcGxhY2UoL1s6XC1dfFwuXGR7M30vZywgJycpOwogIAogICAgICBpZiAodGhpcy5pc1ByZXNpZ25lZCgpKSB7CiAgICAgICAgdGhpcy51cGRhdGVGb3JQcmVzaWduZWQoY3JlZGVudGlhbHMsIGRhdGV0aW1lKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmFkZEhlYWRlcnMoY3JlZGVudGlhbHMsIGRhdGV0aW1lKTsKICAgICAgfQogIAogICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQXV0aG9yaXphdGlvbiddID0KICAgICAgICB0aGlzLmF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGV0aW1lKTsKICAgIH0sCiAgCiAgICBhZGRIZWFkZXJzOiBmdW5jdGlvbiBhZGRIZWFkZXJzKGNyZWRlbnRpYWxzLCBkYXRldGltZSkgewogICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snWC1BbXotRGF0ZSddID0gZGF0ZXRpbWU7CiAgICAgIGlmIChjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4pIHsKICAgICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1sneC1hbXotc2VjdXJpdHktdG9rZW4nXSA9IGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbjsKICAgICAgfQogICAgfSwKICAKICAgIHVwZGF0ZUZvclByZXNpZ25lZDogZnVuY3Rpb24gdXBkYXRlRm9yUHJlc2lnbmVkKGNyZWRlbnRpYWxzLCBkYXRldGltZSkgewogICAgICB2YXIgY3JlZFN0cmluZyA9IHRoaXMuY3JlZGVudGlhbFN0cmluZyhkYXRldGltZSk7CiAgICAgIHZhciBxcyA9IHsKICAgICAgICAnWC1BbXotRGF0ZSc6IGRhdGV0aW1lLAogICAgICAgICdYLUFtei1BbGdvcml0aG0nOiB0aGlzLmFsZ29yaXRobSwKICAgICAgICAnWC1BbXotQ3JlZGVudGlhbCc6IGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJy8nICsgY3JlZFN0cmluZywKICAgICAgICAnWC1BbXotRXhwaXJlcyc6IHRoaXMucmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdLAogICAgICAgICdYLUFtei1TaWduZWRIZWFkZXJzJzogdGhpcy5zaWduZWRIZWFkZXJzKCkKICAgICAgfTsKICAKICAgICAgaWYgKGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbikgewogICAgICAgIHFzWydYLUFtei1TZWN1cml0eS1Ub2tlbiddID0gY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuOwogICAgICB9CiAgCiAgICAgIGlmICh0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ10pIHsKICAgICAgICBxc1snQ29udGVudC1UeXBlJ10gPSB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ107CiAgICAgIH0KICAgICAgaWYgKHRoaXMucmVxdWVzdC5oZWFkZXJzWydDb250ZW50LU1ENSddKSB7CiAgICAgICAgcXNbJ0NvbnRlbnQtTUQ1J10gPSB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1NRDUnXTsKICAgICAgfQogICAgICBpZiAodGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NhY2hlLUNvbnRyb2wnXSkgewogICAgICAgIHFzWydDYWNoZS1Db250cm9sJ10gPSB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ2FjaGUtQ29udHJvbCddOwogICAgICB9CiAgCiAgICAgIC8vIG5lZWQgdG8gcHVsbCBpbiBhbnkgb3RoZXIgWC1BbXotKiBoZWFkZXJzCiAgICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLnJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIGlmIChrZXkgPT09IGV4cGlyZXNIZWFkZXIpIHJldHVybjsKICAgICAgICBpZiAodGhpcy5pc1NpZ25hYmxlSGVhZGVyKGtleSkpIHsKICAgICAgICAgIHZhciBsb3dlcktleSA9IGtleS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgLy8gTWV0YWRhdGEgc2hvdWxkIGJlIG5vcm1hbGl6ZWQKICAgICAgICAgIGlmIChsb3dlcktleS5pbmRleE9mKCd4LWFtei1tZXRhLScpID09PSAwKSB7CiAgICAgICAgICAgIHFzW2xvd2VyS2V5XSA9IHZhbHVlOwogICAgICAgICAgfSBlbHNlIGlmIChsb3dlcktleS5pbmRleE9mKCd4LWFtei0nKSA9PT0gMCkgewogICAgICAgICAgICBxc1trZXldID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgdmFyIHNlcCA9IHRoaXMucmVxdWVzdC5wYXRoLmluZGV4T2YoJz8nKSA+PSAwID8gJyYnIDogJz8nOwogICAgICB0aGlzLnJlcXVlc3QucGF0aCArPSBzZXAgKyBBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHFzKTsKICAgIH0sCiAgCiAgICBhdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRldGltZSkgewogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgdmFyIGNyZWRTdHJpbmcgPSB0aGlzLmNyZWRlbnRpYWxTdHJpbmcoZGF0ZXRpbWUpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMuYWxnb3JpdGhtICsgJyBDcmVkZW50aWFsPScgKwogICAgICAgIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJy8nICsgY3JlZFN0cmluZyk7CiAgICAgIHBhcnRzLnB1c2goJ1NpZ25lZEhlYWRlcnM9JyArIHRoaXMuc2lnbmVkSGVhZGVycygpKTsKICAgICAgcGFydHMucHVzaCgnU2lnbmF0dXJlPScgKyB0aGlzLnNpZ25hdHVyZShjcmVkZW50aWFscywgZGF0ZXRpbWUpKTsKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJywgJyk7CiAgICB9LAogIAogICAgc2lnbmF0dXJlOiBmdW5jdGlvbiBzaWduYXR1cmUoY3JlZGVudGlhbHMsIGRhdGV0aW1lKSB7CiAgICAgIHZhciBzaWduaW5nS2V5ID0gdjRDcmVkZW50aWFscy5nZXRTaWduaW5nS2V5KAogICAgICAgIGNyZWRlbnRpYWxzLAogICAgICAgIGRhdGV0aW1lLnN1YnN0cigwLCA4KSwKICAgICAgICB0aGlzLnJlcXVlc3QucmVnaW9uLAogICAgICAgIHRoaXMuc2VydmljZU5hbWUsCiAgICAgICAgdGhpcy5zaWduYXR1cmVDYWNoZQogICAgICApOwogICAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLmhtYWMoc2lnbmluZ0tleSwgdGhpcy5zdHJpbmdUb1NpZ24oZGF0ZXRpbWUpLCAnaGV4Jyk7CiAgICB9LAogIAogICAgc3RyaW5nVG9TaWduOiBmdW5jdGlvbiBzdHJpbmdUb1NpZ24oZGF0ZXRpbWUpIHsKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIHBhcnRzLnB1c2goJ0FXUzQtSE1BQy1TSEEyNTYnKTsKICAgICAgcGFydHMucHVzaChkYXRldGltZSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5jcmVkZW50aWFsU3RyaW5nKGRhdGV0aW1lKSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5oZXhFbmNvZGVkSGFzaCh0aGlzLmNhbm9uaWNhbFN0cmluZygpKSk7CiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogICAgfSwKICAKICAgIGNhbm9uaWNhbFN0cmluZzogZnVuY3Rpb24gY2Fub25pY2FsU3RyaW5nKCkgewogICAgICB2YXIgcGFydHMgPSBbXSwgcGF0aG5hbWUgPSB0aGlzLnJlcXVlc3QucGF0aG5hbWUoKTsKICAgICAgaWYgKHRoaXMuc2VydmljZU5hbWUgIT09ICdzMycgJiYgdGhpcy5zaWduYXR1cmVWZXJzaW9uICE9PSAnczN2NCcpIHBhdGhuYW1lID0gQVdTLnV0aWwudXJpRXNjYXBlUGF0aChwYXRobmFtZSk7CiAgCiAgICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0Lm1ldGhvZCk7CiAgICAgIHBhcnRzLnB1c2gocGF0aG5hbWUpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5zZWFyY2goKSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5jYW5vbmljYWxIZWFkZXJzKCkgKyAnXG4nKTsKICAgICAgcGFydHMucHVzaCh0aGlzLnNpZ25lZEhlYWRlcnMoKSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5oZXhFbmNvZGVkQm9keUhhc2goKSk7CiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogICAgfSwKICAKICAgIGNhbm9uaWNhbEhlYWRlcnM6IGZ1bmN0aW9uIGNhbm9uaWNhbEhlYWRlcnMoKSB7CiAgICAgIHZhciBoZWFkZXJzID0gW107CiAgICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLnJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gKGtleSwgaXRlbSkgewogICAgICAgIGhlYWRlcnMucHVzaChba2V5LCBpdGVtXSk7CiAgICAgIH0pOwogICAgICBoZWFkZXJzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICByZXR1cm4gYVswXS50b0xvd2VyQ2FzZSgpIDwgYlswXS50b0xvd2VyQ2FzZSgpID8gLTEgOiAxOwogICAgICB9KTsKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIEFXUy51dGlsLmFycmF5RWFjaC5jYWxsKHRoaXMsIGhlYWRlcnMsIGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgdmFyIGtleSA9IGl0ZW1bMF0udG9Mb3dlckNhc2UoKTsKICAgICAgICBpZiAodGhpcy5pc1NpZ25hYmxlSGVhZGVyKGtleSkpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IGl0ZW1bMV07CiAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJyB8fCB2YWx1ZSA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUudG9TdHJpbmcgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCdIZWFkZXIgJyArIGtleSArICcgY29udGFpbnMgaW52YWxpZCB2YWx1ZScpLCB7CiAgICAgICAgICAgICAgY29kZTogJ0ludmFsaWRIZWFkZXInCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcGFydHMucHVzaChrZXkgKyAnOicgKwogICAgICAgICAgICB0aGlzLmNhbm9uaWNhbEhlYWRlclZhbHVlcyh2YWx1ZS50b1N0cmluZygpKSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CiAgICB9LAogIAogICAgY2Fub25pY2FsSGVhZGVyVmFsdWVzOiBmdW5jdGlvbiBjYW5vbmljYWxIZWFkZXJWYWx1ZXModmFsdWVzKSB7CiAgICAgIHJldHVybiB2YWx1ZXMucmVwbGFjZSgvXHMrL2csICcgJykucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKICAgIH0sCiAgCiAgICBzaWduZWRIZWFkZXJzOiBmdW5jdGlvbiBzaWduZWRIZWFkZXJzKCkgewogICAgICB2YXIga2V5cyA9IFtdOwogICAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgdGhpcy5yZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBrZXkgPSBrZXkudG9Mb3dlckNhc2UoKTsKICAgICAgICBpZiAodGhpcy5pc1NpZ25hYmxlSGVhZGVyKGtleSkpIGtleXMucHVzaChrZXkpOwogICAgICB9KTsKICAgICAgcmV0dXJuIGtleXMuc29ydCgpLmpvaW4oJzsnKTsKICAgIH0sCiAgCiAgICBjcmVkZW50aWFsU3RyaW5nOiBmdW5jdGlvbiBjcmVkZW50aWFsU3RyaW5nKGRhdGV0aW1lKSB7CiAgICAgIHJldHVybiB2NENyZWRlbnRpYWxzLmNyZWF0ZVNjb3BlKAogICAgICAgIGRhdGV0aW1lLnN1YnN0cigwLCA4KSwKICAgICAgICB0aGlzLnJlcXVlc3QucmVnaW9uLAogICAgICAgIHRoaXMuc2VydmljZU5hbWUKICAgICAgKTsKICAgIH0sCiAgCiAgICBoZXhFbmNvZGVkSGFzaDogZnVuY3Rpb24gaGFzaChzdHJpbmcpIHsKICAgICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5zaGEyNTYoc3RyaW5nLCAnaGV4Jyk7CiAgICB9LAogIAogICAgaGV4RW5jb2RlZEJvZHlIYXNoOiBmdW5jdGlvbiBoZXhFbmNvZGVkQm9keUhhc2goKSB7CiAgICAgIHZhciByZXF1ZXN0ID0gdGhpcy5yZXF1ZXN0OwogICAgICBpZiAodGhpcy5pc1ByZXNpZ25lZCgpICYmIHRoaXMuc2VydmljZU5hbWUgPT09ICdzMycgJiYgIXJlcXVlc3QuYm9keSkgewogICAgICAgIHJldHVybiAnVU5TSUdORUQtUEFZTE9BRCc7CiAgICAgIH0gZWxzZSBpZiAocmVxdWVzdC5oZWFkZXJzWydYLUFtei1Db250ZW50LVNoYTI1NiddKSB7CiAgICAgICAgcmV0dXJuIHJlcXVlc3QuaGVhZGVyc1snWC1BbXotQ29udGVudC1TaGEyNTYnXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5oZXhFbmNvZGVkSGFzaCh0aGlzLnJlcXVlc3QuYm9keSB8fCAnJyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB1bnNpZ25hYmxlSGVhZGVyczogWwogICAgICAnYXV0aG9yaXphdGlvbicsCiAgICAgICdjb250ZW50LXR5cGUnLAogICAgICAnY29udGVudC1sZW5ndGgnLAogICAgICAndXNlci1hZ2VudCcsCiAgICAgIGV4cGlyZXNIZWFkZXIsCiAgICAgICdleHBlY3QnLAogICAgICAneC1hbXpuLXRyYWNlLWlkJwogICAgXSwKICAKICAgIGlzU2lnbmFibGVIZWFkZXI6IGZ1bmN0aW9uIGlzU2lnbmFibGVIZWFkZXIoa2V5KSB7CiAgICAgIGlmIChrZXkudG9Mb3dlckNhc2UoKS5pbmRleE9mKCd4LWFtei0nKSA9PT0gMCkgcmV0dXJuIHRydWU7CiAgICAgIHJldHVybiB0aGlzLnVuc2lnbmFibGVIZWFkZXJzLmluZGV4T2Yoa2V5KSA8IDA7CiAgICB9LAogIAogICAgaXNQcmVzaWduZWQ6IGZ1bmN0aW9uIGlzUHJlc2lnbmVkKCkgewogICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl0gPyB0cnVlIDogZmFsc2U7CiAgICB9CiAgCiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5WNDsKICAKICB9LHsiLi4vY29yZSI6MTgsIi4vdjRfY3JlZGVudGlhbHMiOjY5fV0sNjk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIGNhY2hlZFNlY3JldCA9IHt9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciBjYWNoZVF1ZXVlID0gW107CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIG1heENhY2hlRW50cmllcyA9IDUwOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciB2NElkZW50aWZpZXIgPSAnYXdzNF9yZXF1ZXN0JzsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKgogICAgICogQHBhcmFtIGRhdGUgW1N0cmluZ10KICAgICAqIEBwYXJhbSByZWdpb24gW1N0cmluZ10KICAgICAqIEBwYXJhbSBzZXJ2aWNlTmFtZSBbU3RyaW5nXQogICAgICogQHJldHVybiBbU3RyaW5nXQogICAgICovCiAgICBjcmVhdGVTY29wZTogZnVuY3Rpb24gY3JlYXRlU2NvcGUoZGF0ZSwgcmVnaW9uLCBzZXJ2aWNlTmFtZSkgewogICAgICByZXR1cm4gWwogICAgICAgIGRhdGUuc3Vic3RyKDAsIDgpLAogICAgICAgIHJlZ2lvbiwKICAgICAgICBzZXJ2aWNlTmFtZSwKICAgICAgICB2NElkZW50aWZpZXIKICAgICAgXS5qb2luKCcvJyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW0gY3JlZGVudGlhbHMgW0NyZWRlbnRpYWxzXQogICAgICogQHBhcmFtIGRhdGUgW1N0cmluZ10KICAgICAqIEBwYXJhbSByZWdpb24gW1N0cmluZ10KICAgICAqIEBwYXJhbSBzZXJ2aWNlIFtTdHJpbmddCiAgICAgKiBAcGFyYW0gc2hvdWxkQ2FjaGUgW0Jvb2xlYW5dCiAgICAgKiBAcmV0dXJuIFtTdHJpbmddCiAgICAgKi8KICAgIGdldFNpZ25pbmdLZXk6IGZ1bmN0aW9uIGdldFNpZ25pbmdLZXkoCiAgICAgIGNyZWRlbnRpYWxzLAogICAgICBkYXRlLAogICAgICByZWdpb24sCiAgICAgIHNlcnZpY2UsCiAgICAgIHNob3VsZENhY2hlCiAgICApIHsKICAgICAgdmFyIGNyZWRzSWRlbnRpZmllciA9IEFXUy51dGlsLmNyeXB0bwogICAgICAgIC5obWFjKGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSwgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQsICdiYXNlNjQnKTsKICAgICAgdmFyIGNhY2hlS2V5ID0gW2NyZWRzSWRlbnRpZmllciwgZGF0ZSwgcmVnaW9uLCBzZXJ2aWNlXS5qb2luKCdfJyk7CiAgICAgIHNob3VsZENhY2hlID0gc2hvdWxkQ2FjaGUgIT09IGZhbHNlOwogICAgICBpZiAoc2hvdWxkQ2FjaGUgJiYgKGNhY2hlS2V5IGluIGNhY2hlZFNlY3JldCkpIHsKICAgICAgICByZXR1cm4gY2FjaGVkU2VjcmV0W2NhY2hlS2V5XTsKICAgICAgfQogIAogICAgICB2YXIga0RhdGUgPSBBV1MudXRpbC5jcnlwdG8uaG1hYygKICAgICAgICAnQVdTNCcgKyBjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXksCiAgICAgICAgZGF0ZSwKICAgICAgICAnYnVmZmVyJwogICAgICApOwogICAgICB2YXIga1JlZ2lvbiA9IEFXUy51dGlsLmNyeXB0by5obWFjKGtEYXRlLCByZWdpb24sICdidWZmZXInKTsKICAgICAgdmFyIGtTZXJ2aWNlID0gQVdTLnV0aWwuY3J5cHRvLmhtYWMoa1JlZ2lvbiwgc2VydmljZSwgJ2J1ZmZlcicpOwogIAogICAgICB2YXIgc2lnbmluZ0tleSA9IEFXUy51dGlsLmNyeXB0by5obWFjKGtTZXJ2aWNlLCB2NElkZW50aWZpZXIsICdidWZmZXInKTsKICAgICAgaWYgKHNob3VsZENhY2hlKSB7CiAgICAgICAgY2FjaGVkU2VjcmV0W2NhY2hlS2V5XSA9IHNpZ25pbmdLZXk7CiAgICAgICAgY2FjaGVRdWV1ZS5wdXNoKGNhY2hlS2V5KTsKICAgICAgICBpZiAoY2FjaGVRdWV1ZS5sZW5ndGggPiBtYXhDYWNoZUVudHJpZXMpIHsKICAgICAgICAgIC8vIHJlbW92ZSB0aGUgb2xkZXN0IGVudHJ5IChub3QgdGhlIGxlYXN0IHJlY2VudGx5IHVzZWQpCiAgICAgICAgICBkZWxldGUgY2FjaGVkU2VjcmV0W2NhY2hlUXVldWUuc2hpZnQoKV07CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiBzaWduaW5nS2V5OwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKgogICAgICogRW1wdGllcyB0aGUgZGVyaXZlZCBzaWduaW5nIGtleSBjYWNoZS4gTWFkZSBhdmFpbGFibGUgZm9yIHRlc3RpbmcgcHVycG9zZXMKICAgICAqIG9ubHkuCiAgICAgKi8KICAgIGVtcHR5Q2FjaGU6IGZ1bmN0aW9uIGVtcHR5Q2FjaGUoKSB7CiAgICAgIGNhY2hlZFNlY3JldCA9IHt9OwogICAgICBjYWNoZVF1ZXVlID0gW107CiAgICB9CiAgfTsKICAKICB9LHsiLi4vY29yZSI6MTh9XSw3MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgZnVuY3Rpb24gQWNjZXB0b3JTdGF0ZU1hY2hpbmUoc3RhdGVzLCBzdGF0ZSkgewogICAgdGhpcy5jdXJyZW50U3RhdGUgPSBzdGF0ZSB8fCBudWxsOwogICAgdGhpcy5zdGF0ZXMgPSBzdGF0ZXMgfHwge307CiAgfQogIAogIEFjY2VwdG9yU3RhdGVNYWNoaW5lLnByb3RvdHlwZS5ydW5UbyA9IGZ1bmN0aW9uIHJ1blRvKGZpbmFsU3RhdGUsIGRvbmUsIGJpbmRPYmplY3QsIGlucHV0RXJyb3IpIHsKICAgIGlmICh0eXBlb2YgZmluYWxTdGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBpbnB1dEVycm9yID0gYmluZE9iamVjdDsgYmluZE9iamVjdCA9IGRvbmU7CiAgICAgIGRvbmUgPSBmaW5hbFN0YXRlOyBmaW5hbFN0YXRlID0gbnVsbDsKICAgIH0KICAKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBzdGF0ZSA9IHNlbGYuc3RhdGVzW3NlbGYuY3VycmVudFN0YXRlXTsKICAgIHN0YXRlLmZuLmNhbGwoYmluZE9iamVjdCB8fCBzZWxmLCBpbnB1dEVycm9yLCBmdW5jdGlvbihlcnIpIHsKICAgICAgaWYgKGVycikgewogICAgICAgIGlmIChzdGF0ZS5mYWlsKSBzZWxmLmN1cnJlbnRTdGF0ZSA9IHN0YXRlLmZhaWw7CiAgICAgICAgZWxzZSByZXR1cm4gZG9uZSA/IGRvbmUuY2FsbChiaW5kT2JqZWN0LCBlcnIpIDogbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoc3RhdGUuYWNjZXB0KSBzZWxmLmN1cnJlbnRTdGF0ZSA9IHN0YXRlLmFjY2VwdDsKICAgICAgICBlbHNlIHJldHVybiBkb25lID8gZG9uZS5jYWxsKGJpbmRPYmplY3QpIDogbnVsbDsKICAgICAgfQogICAgICBpZiAoc2VsZi5jdXJyZW50U3RhdGUgPT09IGZpbmFsU3RhdGUpIHsKICAgICAgICByZXR1cm4gZG9uZSA/IGRvbmUuY2FsbChiaW5kT2JqZWN0LCBlcnIpIDogbnVsbDsKICAgICAgfQogIAogICAgICBzZWxmLnJ1blRvKGZpbmFsU3RhdGUsIGRvbmUsIGJpbmRPYmplY3QsIGVycik7CiAgICB9KTsKICB9OwogIAogIEFjY2VwdG9yU3RhdGVNYWNoaW5lLnByb3RvdHlwZS5hZGRTdGF0ZSA9IGZ1bmN0aW9uIGFkZFN0YXRlKG5hbWUsIGFjY2VwdFN0YXRlLCBmYWlsU3RhdGUsIGZuKSB7CiAgICBpZiAodHlwZW9mIGFjY2VwdFN0YXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGZuID0gYWNjZXB0U3RhdGU7IGFjY2VwdFN0YXRlID0gbnVsbDsgZmFpbFN0YXRlID0gbnVsbDsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGZhaWxTdGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBmbiA9IGZhaWxTdGF0ZTsgZmFpbFN0YXRlID0gbnVsbDsKICAgIH0KICAKICAgIGlmICghdGhpcy5jdXJyZW50U3RhdGUpIHRoaXMuY3VycmVudFN0YXRlID0gbmFtZTsKICAgIHRoaXMuc3RhdGVzW25hbWVdID0geyBhY2NlcHQ6IGFjY2VwdFN0YXRlLCBmYWlsOiBmYWlsU3RhdGUsIGZuOiBmbiB9OwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFjY2VwdG9yU3RhdGVNYWNoaW5lOwogIAogIH0se31dLDcxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKHByb2Nlc3Msc2V0SW1tZWRpYXRlKXsKICAvKiBlc2xpbnQgZ3VhcmQtZm9yLWluOjAgKi8KICB2YXIgQVdTOwogIAogIC8qKgogICAqIEEgc2V0IG9mIHV0aWxpdHkgbWV0aG9kcyBmb3IgdXNlIHdpdGggdGhlIEFXUyBTREsuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBhYm9ydAogICAqICAgUmV0dXJuIHRoaXMgdmFsdWUgZnJvbSBhbiBpdGVyYXRvciBmdW5jdGlvbiB7ZWFjaH0gb3Ige2FycmF5RWFjaH0KICAgKiAgIHRvIGJyZWFrIG91dCBvZiB0aGUgaXRlcmF0aW9uLgogICAqICAgQGV4YW1wbGUgQnJlYWtpbmcgb3V0IG9mIGFuIGl0ZXJhdG9yIGZ1bmN0aW9uCiAgICogICAgIEFXUy51dGlsLmVhY2goe2E6IDEsIGI6IDIsIGM6IDN9LCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICogICAgICAgaWYgKGtleSA9PSAnYicpIHJldHVybiBBV1MudXRpbC5hYm9ydDsKICAgKiAgICAgfSk7CiAgICogICBAc2VlIGVhY2gKICAgKiAgIEBzZWUgYXJyYXlFYWNoCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIHV0aWwgPSB7CiAgICBlbnZpcm9ubWVudDogJ25vZGVqcycsCiAgICBlbmdpbmU6IGZ1bmN0aW9uIGVuZ2luZSgpIHsKICAgICAgaWYgKHV0aWwuaXNCcm93c2VyKCkgJiYgdHlwZW9mIG5hdmlnYXRvciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICByZXR1cm4gbmF2aWdhdG9yLnVzZXJBZ2VudDsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgZW5naW5lID0gcHJvY2Vzcy5wbGF0Zm9ybSArICcvJyArIHByb2Nlc3MudmVyc2lvbjsKICAgICAgICBpZiAocHJvY2Vzcy5lbnYuQVdTX0VYRUNVVElPTl9FTlYpIHsKICAgICAgICAgIGVuZ2luZSArPSAnIGV4ZWMtZW52LycgKyBwcm9jZXNzLmVudi5BV1NfRVhFQ1VUSU9OX0VOVjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGVuZ2luZTsKICAgICAgfQogICAgfSwKICAKICAgIHVzZXJBZ2VudDogZnVuY3Rpb24gdXNlckFnZW50KCkgewogICAgICB2YXIgbmFtZSA9IHV0aWwuZW52aXJvbm1lbnQ7CiAgICAgIHZhciBhZ2VudCA9ICdhd3Mtc2RrLScgKyBuYW1lICsgJy8nICsgcmVxdWlyZSgnLi9jb3JlJykuVkVSU0lPTjsKICAgICAgaWYgKG5hbWUgPT09ICdub2RlanMnKSBhZ2VudCArPSAnICcgKyB1dGlsLmVuZ2luZSgpOwogICAgICByZXR1cm4gYWdlbnQ7CiAgICB9LAogIAogICAgdXJpRXNjYXBlOiBmdW5jdGlvbiB1cmlFc2NhcGUoc3RyaW5nKSB7CiAgICAgIHZhciBvdXRwdXQgPSBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5nKTsKICAgICAgb3V0cHV0ID0gb3V0cHV0LnJlcGxhY2UoL1teQS1aYS16MC05Xy5+XC0lXSsvZywgZXNjYXBlKTsKICAKICAgICAgLy8gQVdTIHBlcmNlbnQtZW5jb2RlcyBzb21lIGV4dHJhIG5vbi1zdGFuZGFyZCBjaGFyYWN0ZXJzIGluIGEgVVJJCiAgICAgIG91dHB1dCA9IG91dHB1dC5yZXBsYWNlKC9bKl0vZywgZnVuY3Rpb24oY2gpIHsKICAgICAgICByZXR1cm4gJyUnICsgY2guY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikudG9VcHBlckNhc2UoKTsKICAgICAgfSk7CiAgCiAgICAgIHJldHVybiBvdXRwdXQ7CiAgICB9LAogIAogICAgdXJpRXNjYXBlUGF0aDogZnVuY3Rpb24gdXJpRXNjYXBlUGF0aChzdHJpbmcpIHsKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIHV0aWwuYXJyYXlFYWNoKHN0cmluZy5zcGxpdCgnLycpLCBmdW5jdGlvbiAocGFydCkgewogICAgICAgIHBhcnRzLnB1c2godXRpbC51cmlFc2NhcGUocGFydCkpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJy8nKTsKICAgIH0sCiAgCiAgICB1cmxQYXJzZTogZnVuY3Rpb24gdXJsUGFyc2UodXJsKSB7CiAgICAgIHJldHVybiB1dGlsLnVybC5wYXJzZSh1cmwpOwogICAgfSwKICAKICAgIHVybEZvcm1hdDogZnVuY3Rpb24gdXJsRm9ybWF0KHVybCkgewogICAgICByZXR1cm4gdXRpbC51cmwuZm9ybWF0KHVybCk7CiAgICB9LAogIAogICAgcXVlcnlTdHJpbmdQYXJzZTogZnVuY3Rpb24gcXVlcnlTdHJpbmdQYXJzZShxcykgewogICAgICByZXR1cm4gdXRpbC5xdWVyeXN0cmluZy5wYXJzZShxcyk7CiAgICB9LAogIAogICAgcXVlcnlQYXJhbXNUb1N0cmluZzogZnVuY3Rpb24gcXVlcnlQYXJhbXNUb1N0cmluZyhwYXJhbXMpIHsKICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgIHZhciBlc2NhcGUgPSB1dGlsLnVyaUVzY2FwZTsKICAgICAgdmFyIHNvcnRlZEtleXMgPSBPYmplY3Qua2V5cyhwYXJhbXMpLnNvcnQoKTsKICAKICAgICAgdXRpbC5hcnJheUVhY2goc29ydGVkS2V5cywgZnVuY3Rpb24obmFtZSkgewogICAgICAgIHZhciB2YWx1ZSA9IHBhcmFtc1tuYW1lXTsKICAgICAgICB2YXIgZW5hbWUgPSBlc2NhcGUobmFtZSk7CiAgICAgICAgdmFyIHJlc3VsdCA9IGVuYW1lICsgJz0nOwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgdmFyIHZhbHMgPSBbXTsKICAgICAgICAgIHV0aWwuYXJyYXlFYWNoKHZhbHVlLCBmdW5jdGlvbihpdGVtKSB7IHZhbHMucHVzaChlc2NhcGUoaXRlbSkpOyB9KTsKICAgICAgICAgIHJlc3VsdCA9IGVuYW1lICsgJz0nICsgdmFscy5zb3J0KCkuam9pbignJicgKyBlbmFtZSArICc9Jyk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgICByZXN1bHQgPSBlbmFtZSArICc9JyArIGVzY2FwZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGl0ZW1zLnB1c2gocmVzdWx0KTsKICAgICAgfSk7CiAgCiAgICAgIHJldHVybiBpdGVtcy5qb2luKCcmJyk7CiAgICB9LAogIAogICAgcmVhZEZpbGVTeW5jOiBmdW5jdGlvbiByZWFkRmlsZVN5bmMocGF0aCkgewogICAgICBpZiAodXRpbC5pc0Jyb3dzZXIoKSkgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiByZXF1aXJlKCdmcycpLnJlYWRGaWxlU3luYyhwYXRoLCAndXRmLTgnKTsKICAgIH0sCiAgCiAgICBiYXNlNjQ6IHsKICAgICAgZW5jb2RlOiBmdW5jdGlvbiBlbmNvZGU2NChzdHJpbmcpIHsKICAgICAgICBpZiAodHlwZW9mIHN0cmluZyA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdDYW5ub3QgYmFzZTY0IGVuY29kZSBudW1iZXIgJyArIHN0cmluZykpOwogICAgICAgIH0KICAgICAgICBpZiAoc3RyaW5nID09PSBudWxsIHx8IHR5cGVvZiBzdHJpbmcgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgIH0KICAgICAgICB2YXIgYnVmID0gdXRpbC5idWZmZXIudG9CdWZmZXIoc3RyaW5nKTsKICAgICAgICByZXR1cm4gYnVmLnRvU3RyaW5nKCdiYXNlNjQnKTsKICAgICAgfSwKICAKICAgICAgZGVjb2RlOiBmdW5jdGlvbiBkZWNvZGU2NChzdHJpbmcpIHsKICAgICAgICBpZiAodHlwZW9mIHN0cmluZyA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdDYW5ub3QgYmFzZTY0IGRlY29kZSBudW1iZXIgJyArIHN0cmluZykpOwogICAgICAgIH0KICAgICAgICBpZiAoc3RyaW5nID09PSBudWxsIHx8IHR5cGVvZiBzdHJpbmcgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdXRpbC5idWZmZXIudG9CdWZmZXIoc3RyaW5nLCAnYmFzZTY0Jyk7CiAgICAgIH0KICAKICAgIH0sCiAgCiAgICBidWZmZXI6IHsKICAgICAgLyoqCiAgICAgICAqIEJ1ZmZlciBjb25zdHJ1Y3RvciBmb3IgTm9kZSBidWZmZXIgYW5kIGJ1ZmZlciBwb2xseWZpbGwKICAgICAgICovCiAgICAgIHRvQnVmZmVyOiBmdW5jdGlvbihkYXRhLCBlbmNvZGluZykgewogICAgICAgIHJldHVybiAodHlwZW9mIHV0aWwuQnVmZmVyLmZyb20gPT09ICdmdW5jdGlvbicgJiYgdXRpbC5CdWZmZXIuZnJvbSAhPT0gVWludDhBcnJheS5mcm9tKSA/CiAgICAgICAgICB1dGlsLkJ1ZmZlci5mcm9tKGRhdGEsIGVuY29kaW5nKSA6IG5ldyB1dGlsLkJ1ZmZlcihkYXRhLCBlbmNvZGluZyk7CiAgICAgIH0sCiAgCiAgICAgIGFsbG9jOiBmdW5jdGlvbihzaXplLCBmaWxsLCBlbmNvZGluZykgewogICAgICAgIGlmICh0eXBlb2Ygc2l6ZSAhPT0gJ251bWJlcicpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignc2l6ZSBwYXNzZWQgdG8gYWxsb2MgbXVzdCBiZSBhIG51bWJlci4nKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiB1dGlsLkJ1ZmZlci5hbGxvYyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgcmV0dXJuIHV0aWwuQnVmZmVyLmFsbG9jKHNpemUsIGZpbGwsIGVuY29kaW5nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGJ1ZiA9IG5ldyB1dGlsLkJ1ZmZlcihzaXplKTsKICAgICAgICAgIGlmIChmaWxsICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIGJ1Zi5maWxsID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGJ1Zi5maWxsKGZpbGwsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBlbmNvZGluZyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYnVmOwogICAgICAgIH0KICAgICAgfSwKICAKICAgICAgdG9TdHJlYW06IGZ1bmN0aW9uIHRvU3RyZWFtKGJ1ZmZlcikgewogICAgICAgIGlmICghdXRpbC5CdWZmZXIuaXNCdWZmZXIoYnVmZmVyKSkgYnVmZmVyID0gIHV0aWwuYnVmZmVyLnRvQnVmZmVyKGJ1ZmZlcik7CiAgCiAgICAgICAgdmFyIHJlYWRhYmxlID0gbmV3ICh1dGlsLnN0cmVhbS5SZWFkYWJsZSkoKTsKICAgICAgICB2YXIgcG9zID0gMDsKICAgICAgICByZWFkYWJsZS5fcmVhZCA9IGZ1bmN0aW9uKHNpemUpIHsKICAgICAgICAgIGlmIChwb3MgPj0gYnVmZmVyLmxlbmd0aCkgcmV0dXJuIHJlYWRhYmxlLnB1c2gobnVsbCk7CiAgCiAgICAgICAgICB2YXIgZW5kID0gcG9zICsgc2l6ZTsKICAgICAgICAgIGlmIChlbmQgPiBidWZmZXIubGVuZ3RoKSBlbmQgPSBidWZmZXIubGVuZ3RoOwogICAgICAgICAgcmVhZGFibGUucHVzaChidWZmZXIuc2xpY2UocG9zLCBlbmQpKTsKICAgICAgICAgIHBvcyA9IGVuZDsKICAgICAgICB9OwogIAogICAgICAgIHJldHVybiByZWFkYWJsZTsKICAgICAgfSwKICAKICAgICAgLyoqCiAgICAgICAqIENvbmNhdGVuYXRlcyBhIGxpc3Qgb2YgQnVmZmVyIG9iamVjdHMuCiAgICAgICAqLwogICAgICBjb25jYXQ6IGZ1bmN0aW9uKGJ1ZmZlcnMpIHsKICAgICAgICB2YXIgbGVuZ3RoID0gMCwKICAgICAgICAgICAgb2Zmc2V0ID0gMCwKICAgICAgICAgICAgYnVmZmVyID0gbnVsbCwgaTsKICAKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYnVmZmVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgbGVuZ3RoICs9IGJ1ZmZlcnNbaV0ubGVuZ3RoOwogICAgICAgIH0KICAKICAgICAgICBidWZmZXIgPSB1dGlsLmJ1ZmZlci5hbGxvYyhsZW5ndGgpOwogIAogICAgICAgIGZvciAoaSA9IDA7IGkgPCBidWZmZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBidWZmZXJzW2ldLmNvcHkoYnVmZmVyLCBvZmZzZXQpOwogICAgICAgICAgb2Zmc2V0ICs9IGJ1ZmZlcnNbaV0ubGVuZ3RoOwogICAgICAgIH0KICAKICAgICAgICByZXR1cm4gYnVmZmVyOwogICAgICB9CiAgICB9LAogIAogICAgc3RyaW5nOiB7CiAgICAgIGJ5dGVMZW5ndGg6IGZ1bmN0aW9uIGJ5dGVMZW5ndGgoc3RyaW5nKSB7CiAgICAgICAgaWYgKHN0cmluZyA9PT0gbnVsbCB8fCBzdHJpbmcgPT09IHVuZGVmaW5lZCkgcmV0dXJuIDA7CiAgICAgICAgaWYgKHR5cGVvZiBzdHJpbmcgPT09ICdzdHJpbmcnKSBzdHJpbmcgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcihzdHJpbmcpOwogIAogICAgICAgIGlmICh0eXBlb2Ygc3RyaW5nLmJ5dGVMZW5ndGggPT09ICdudW1iZXInKSB7CiAgICAgICAgICByZXR1cm4gc3RyaW5nLmJ5dGVMZW5ndGg7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3RyaW5nLmxlbmd0aCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHJldHVybiBzdHJpbmcubGVuZ3RoOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0cmluZy5zaXplID09PSAnbnVtYmVyJykgewogICAgICAgICAgcmV0dXJuIHN0cmluZy5zaXplOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0cmluZy5wYXRoID09PSAnc3RyaW5nJykgewogICAgICAgICAgcmV0dXJuIHJlcXVpcmUoJ2ZzJykubHN0YXRTeW5jKHN0cmluZy5wYXRoKS5zaXplOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignQ2Fubm90IGRldGVybWluZSBsZW5ndGggb2YgJyArIHN0cmluZyksCiAgICAgICAgICAgIHsgb2JqZWN0OiBzdHJpbmcgfSk7CiAgICAgICAgfQogICAgICB9LAogIAogICAgICB1cHBlckZpcnN0OiBmdW5jdGlvbiB1cHBlckZpcnN0KHN0cmluZykgewogICAgICAgIHJldHVybiBzdHJpbmdbMF0udG9VcHBlckNhc2UoKSArIHN0cmluZy5zdWJzdHIoMSk7CiAgICAgIH0sCiAgCiAgICAgIGxvd2VyRmlyc3Q6IGZ1bmN0aW9uIGxvd2VyRmlyc3Qoc3RyaW5nKSB7CiAgICAgICAgcmV0dXJuIHN0cmluZ1swXS50b0xvd2VyQ2FzZSgpICsgc3RyaW5nLnN1YnN0cigxKTsKICAgICAgfQogICAgfSwKICAKICAgIGluaTogewogICAgICBwYXJzZTogZnVuY3Rpb24gc3RyaW5nKGluaSkgewogICAgICAgIHZhciBjdXJyZW50U2VjdGlvbiwgbWFwID0ge307CiAgICAgICAgdXRpbC5hcnJheUVhY2goaW5pLnNwbGl0KC9ccj9cbi8pLCBmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgICBsaW5lID0gbGluZS5zcGxpdCgvKF58XHMpWzsjXS8pWzBdOyAvLyByZW1vdmUgY29tbWVudHMKICAgICAgICAgIHZhciBzZWN0aW9uID0gbGluZS5tYXRjaCgvXlxzKlxbKFteXFtcXV0rKVxdXHMqJC8pOwogICAgICAgICAgaWYgKHNlY3Rpb24pIHsKICAgICAgICAgICAgY3VycmVudFNlY3Rpb24gPSBzZWN0aW9uWzFdOwogICAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50U2VjdGlvbikgewogICAgICAgICAgICB2YXIgaXRlbSA9IGxpbmUubWF0Y2goL15ccyooLis/KVxzKj1ccyooLis/KVxzKiQvKTsKICAgICAgICAgICAgaWYgKGl0ZW0pIHsKICAgICAgICAgICAgICBtYXBbY3VycmVudFNlY3Rpb25dID0gbWFwW2N1cnJlbnRTZWN0aW9uXSB8fCB7fTsKICAgICAgICAgICAgICBtYXBbY3VycmVudFNlY3Rpb25dW2l0ZW1bMV1dID0gaXRlbVsyXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogIAogICAgICAgIHJldHVybiBtYXA7CiAgICAgIH0KICAgIH0sCiAgCiAgICBmbjogewogICAgICBub29wOiBmdW5jdGlvbigpIHt9LAogICAgICBjYWxsYmFjazogZnVuY3Rpb24gKGVycikgeyBpZiAoZXJyKSB0aHJvdyBlcnI7IH0sCiAgCiAgICAgIC8qKgogICAgICAgKiBUdXJuIGEgc3luY2hyb25vdXMgZnVuY3Rpb24gaW50byBhcyAiYXN5bmMiIGZ1bmN0aW9uIGJ5IG1ha2luZyBpdCBjYWxsCiAgICAgICAqIGEgY2FsbGJhY2suIFRoZSB1bmRlcmx5aW5nIGZ1bmN0aW9uIGlzIGNhbGxlZCB3aXRoIGFsbCBidXQgdGhlIGxhc3QgYXJndW1lbnQsCiAgICAgICAqIHdoaWNoIGlzIHRyZWF0ZWQgYXMgdGhlIGNhbGxiYWNrLiBUaGUgY2FsbGJhY2sgaXMgcGFzc2VkIHBhc3NlZCBhIGZpcnN0IGFyZ3VtZW50CiAgICAgICAqIG9mIG51bGwgb24gc3VjY2VzcyB0byBtaW1pY2sgc3RhbmRhcmQgbm9kZSBjYWxsYmFja3MuCiAgICAgICAqLwogICAgICBtYWtlQXN5bmM6IGZ1bmN0aW9uIG1ha2VBc3luYyhmbiwgZXhwZWN0ZWRBcmdzKSB7CiAgICAgICAgaWYgKGV4cGVjdGVkQXJncyAmJiBleHBlY3RlZEFyZ3MgPD0gZm4ubGVuZ3RoKSB7CiAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgfQogIAogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgICAgICAgIHZhciBjYWxsYmFjayA9IGFyZ3MucG9wKCk7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gZm4uYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgICBjYWxsYmFjayhyZXN1bHQpOwogICAgICAgIH07CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIERhdGUgYW5kIHRpbWUgdXRpbGl0eSBmdW5jdGlvbnMuCiAgICAgKi8KICAgIGRhdGU6IHsKICAKICAgICAgLyoqCiAgICAgICAqIEByZXR1cm4gW0RhdGVdIHRoZSBjdXJyZW50IEphdmFTY3JpcHQgZGF0ZSBvYmplY3QuIFNpbmNlIGFsbAogICAgICAgKiAgIEFXUyBzZXJ2aWNlcyByZWx5IG9uIHRoaXMgZGF0ZSBvYmplY3QsIHlvdSBjYW4gb3ZlcnJpZGUKICAgICAgICogICB0aGlzIGZ1bmN0aW9uIHRvIHByb3ZpZGUgYSBzcGVjaWFsIHRpbWUgdmFsdWUgdG8gQVdTIHNlcnZpY2UKICAgICAgICogICByZXF1ZXN0cy4KICAgICAgICovCiAgICAgIGdldERhdGU6IGZ1bmN0aW9uIGdldERhdGUoKSB7CiAgICAgICAgaWYgKCFBV1MpIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogICAgICAgIGlmIChBV1MuY29uZmlnLnN5c3RlbUNsb2NrT2Zmc2V0KSB7IC8vIHVzZSBvZmZzZXQgd2hlbiBub24temVybwogICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKG5ldyBEYXRlKCkuZ2V0VGltZSgpICsgQVdTLmNvbmZpZy5zeXN0ZW1DbG9ja09mZnNldCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBuZXcgRGF0ZSgpOwogICAgICAgIH0KICAgICAgfSwKICAKICAgICAgLyoqCiAgICAgICAqIEByZXR1cm4gW1N0cmluZ10gdGhlIGRhdGUgaW4gSVNPLTg2MDEgZm9ybWF0CiAgICAgICAqLwogICAgICBpc284NjAxOiBmdW5jdGlvbiBpc284NjAxKGRhdGUpIHsKICAgICAgICBpZiAoZGF0ZSA9PT0gdW5kZWZpbmVkKSB7IGRhdGUgPSB1dGlsLmRhdGUuZ2V0RGF0ZSgpOyB9CiAgICAgICAgcmV0dXJuIGRhdGUudG9JU09TdHJpbmcoKS5yZXBsYWNlKC9cLlxkezN9WiQvLCAnWicpOwogICAgICB9LAogIAogICAgICAvKioKICAgICAgICogQHJldHVybiBbU3RyaW5nXSB0aGUgZGF0ZSBpbiBSRkMgODIyIGZvcm1hdAogICAgICAgKi8KICAgICAgcmZjODIyOiBmdW5jdGlvbiByZmM4MjIoZGF0ZSkgewogICAgICAgIGlmIChkYXRlID09PSB1bmRlZmluZWQpIHsgZGF0ZSA9IHV0aWwuZGF0ZS5nZXREYXRlKCk7IH0KICAgICAgICByZXR1cm4gZGF0ZS50b1VUQ1N0cmluZygpOwogICAgICB9LAogIAogICAgICAvKioKICAgICAgICogQHJldHVybiBbSW50ZWdlcl0gdGhlIFVOSVggdGltZXN0YW1wIHZhbHVlIGZvciB0aGUgY3VycmVudCB0aW1lCiAgICAgICAqLwogICAgICB1bml4VGltZXN0YW1wOiBmdW5jdGlvbiB1bml4VGltZXN0YW1wKGRhdGUpIHsKICAgICAgICBpZiAoZGF0ZSA9PT0gdW5kZWZpbmVkKSB7IGRhdGUgPSB1dGlsLmRhdGUuZ2V0RGF0ZSgpOyB9CiAgICAgICAgcmV0dXJuIGRhdGUuZ2V0VGltZSgpIC8gMTAwMDsKICAgICAgfSwKICAKICAgICAgLyoqCiAgICAgICAqIEBwYXJhbSBbU3RyaW5nLG51bWJlcixEYXRlXSBkYXRlCiAgICAgICAqIEByZXR1cm4gW0RhdGVdCiAgICAgICAqLwogICAgICBmcm9tOiBmdW5jdGlvbiBmb3JtYXQoZGF0ZSkgewogICAgICAgIGlmICh0eXBlb2YgZGF0ZSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShkYXRlICogMTAwMCk7IC8vIHVuaXggdGltZXN0YW1wCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShkYXRlKTsKICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIC8qKgogICAgICAgKiBHaXZlbiBhIERhdGUgb3IgZGF0ZS1saWtlIHZhbHVlLCB0aGlzIGZ1bmN0aW9uIGZvcm1hdHMgdGhlCiAgICAgICAqIGRhdGUgaW50byBhIHN0cmluZyBvZiB0aGUgcmVxdWVzdGVkIHZhbHVlLgogICAgICAgKiBAcGFyYW0gW1N0cmluZyxudW1iZXIsRGF0ZV0gZGF0ZQogICAgICAgKiBAcGFyYW0gW1N0cmluZ10gZm9ybWF0dGVyIFZhbGlkIGZvcm1hdHMgYXJlOgogICAgICAgIyAgICogJ2lzbzg2MDEnCiAgICAgICAjICAgKiAncmZjODIyJwogICAgICAgIyAgICogJ3VuaXhUaW1lc3RhbXAnCiAgICAgICAqIEByZXR1cm4gW1N0cmluZ10KICAgICAgICovCiAgICAgIGZvcm1hdDogZnVuY3Rpb24gZm9ybWF0KGRhdGUsIGZvcm1hdHRlcikgewogICAgICAgIGlmICghZm9ybWF0dGVyKSBmb3JtYXR0ZXIgPSAnaXNvODYwMSc7CiAgICAgICAgcmV0dXJuIHV0aWwuZGF0ZVtmb3JtYXR0ZXJdKHV0aWwuZGF0ZS5mcm9tKGRhdGUpKTsKICAgICAgfSwKICAKICAgICAgcGFyc2VUaW1lc3RhbXA6IGZ1bmN0aW9uIHBhcnNlVGltZXN0YW1wKHZhbHVlKSB7CiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicpIHsgLy8gdW5peCB0aW1lc3RhbXAgKG51bWJlcikKICAgICAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWx1ZSAqIDEwMDApOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWUubWF0Y2goL15cZCskLykpIHsgLy8gdW5peCB0aW1lc3RhbXAKICAgICAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWx1ZSAqIDEwMDApOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWUubWF0Y2goL15cZHs0fS8pKSB7IC8vIGlzbzg2MDEKICAgICAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5tYXRjaCgvXlx3ezN9LC8pKSB7IC8vIHJmYzgyMgogICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcigKICAgICAgICAgICAgbmV3IEVycm9yKCd1bmhhbmRsZWQgdGltZXN0YW1wIGZvcm1hdDogJyArIHZhbHVlKSwKICAgICAgICAgICAge2NvZGU6ICdUaW1lc3RhbXBQYXJzZXJFcnJvcid9KTsKICAgICAgICB9CiAgICAgIH0KICAKICAgIH0sCiAgCiAgICBjcnlwdG86IHsKICAgICAgY3JjMzJUYWJsZTogWwogICAgICAgMHgwMDAwMDAwMCwgMHg3NzA3MzA5NiwgMHhFRTBFNjEyQywgMHg5OTA5NTFCQSwgMHgwNzZEQzQxOSwKICAgICAgIDB4NzA2QUY0OEYsIDB4RTk2M0E1MzUsIDB4OUU2NDk1QTMsIDB4MEVEQjg4MzIsIDB4NzlEQ0I4QTQsCiAgICAgICAweEUwRDVFOTFFLCAweDk3RDJEOTg4LCAweDA5QjY0QzJCLCAweDdFQjE3Q0JELCAweEU3QjgyRDA3LAogICAgICAgMHg5MEJGMUQ5MSwgMHgxREI3MTA2NCwgMHg2QUIwMjBGMiwgMHhGM0I5NzE0OCwgMHg4NEJFNDFERSwKICAgICAgIDB4MUFEQUQ0N0QsIDB4NkREREU0RUIsIDB4RjRENEI1NTEsIDB4ODNEMzg1QzcsIDB4MTM2Qzk4NTYsCiAgICAgICAweDY0NkJBOEMwLCAweEZENjJGOTdBLCAweDhBNjVDOUVDLCAweDE0MDE1QzRGLCAweDYzMDY2Q0Q5LAogICAgICAgMHhGQTBGM0Q2MywgMHg4RDA4MERGNSwgMHgzQjZFMjBDOCwgMHg0QzY5MTA1RSwgMHhENTYwNDFFNCwKICAgICAgIDB4QTI2NzcxNzIsIDB4M0MwM0U0RDEsIDB4NEIwNEQ0NDcsIDB4RDIwRDg1RkQsIDB4QTUwQUI1NkIsCiAgICAgICAweDM1QjVBOEZBLCAweDQyQjI5ODZDLCAweERCQkJDOUQ2LCAweEFDQkNGOTQwLCAweDMyRDg2Q0UzLAogICAgICAgMHg0NURGNUM3NSwgMHhEQ0Q2MERDRiwgMHhBQkQxM0Q1OSwgMHgyNkQ5MzBBQywgMHg1MURFMDAzQSwKICAgICAgIDB4QzhENzUxODAsIDB4QkZEMDYxMTYsIDB4MjFCNEY0QjUsIDB4NTZCM0M0MjMsIDB4Q0ZCQTk1OTksCiAgICAgICAweEI4QkRBNTBGLCAweDI4MDJCODlFLCAweDVGMDU4ODA4LCAweEM2MENEOUIyLCAweEIxMEJFOTI0LAogICAgICAgMHgyRjZGN0M4NywgMHg1ODY4NEMxMSwgMHhDMTYxMURBQiwgMHhCNjY2MkQzRCwgMHg3NkRDNDE5MCwKICAgICAgIDB4MDFEQjcxMDYsIDB4OThEMjIwQkMsIDB4RUZENTEwMkEsIDB4NzFCMTg1ODksIDB4MDZCNkI1MUYsCiAgICAgICAweDlGQkZFNEE1LCAweEU4QjhENDMzLCAweDc4MDdDOUEyLCAweDBGMDBGOTM0LCAweDk2MDlBODhFLAogICAgICAgMHhFMTBFOTgxOCwgMHg3RjZBMERCQiwgMHgwODZEM0QyRCwgMHg5MTY0NkM5NywgMHhFNjYzNUMwMSwKICAgICAgIDB4NkI2QjUxRjQsIDB4MUM2QzYxNjIsIDB4ODU2NTMwRDgsIDB4RjI2MjAwNEUsIDB4NkMwNjk1RUQsCiAgICAgICAweDFCMDFBNTdCLCAweDgyMDhGNEMxLCAweEY1MEZDNDU3LCAweDY1QjBEOUM2LCAweDEyQjdFOTUwLAogICAgICAgMHg4QkJFQjhFQSwgMHhGQ0I5ODg3QywgMHg2MkREMURERiwgMHgxNURBMkQ0OSwgMHg4Q0QzN0NGMywKICAgICAgIDB4RkJENDRDNjUsIDB4NERCMjYxNTgsIDB4M0FCNTUxQ0UsIDB4QTNCQzAwNzQsIDB4RDRCQjMwRTIsCiAgICAgICAweDRBREZBNTQxLCAweDNERDg5NUQ3LCAweEE0RDFDNDZELCAweEQzRDZGNEZCLCAweDQzNjlFOTZBLAogICAgICAgMHgzNDZFRDlGQywgMHhBRDY3ODg0NiwgMHhEQTYwQjhEMCwgMHg0NDA0MkQ3MywgMHgzMzAzMURFNSwKICAgICAgIDB4QUEwQTRDNUYsIDB4REQwRDdDQzksIDB4NTAwNTcxM0MsIDB4MjcwMjQxQUEsIDB4QkUwQjEwMTAsCiAgICAgICAweEM5MEMyMDg2LCAweDU3NjhCNTI1LCAweDIwNkY4NUIzLCAweEI5NjZENDA5LCAweENFNjFFNDlGLAogICAgICAgMHg1RURFRjkwRSwgMHgyOUQ5Qzk5OCwgMHhCMEQwOTgyMiwgMHhDN0Q3QThCNCwgMHg1OUIzM0QxNywKICAgICAgIDB4MkVCNDBEODEsIDB4QjdCRDVDM0IsIDB4QzBCQTZDQUQsIDB4RURCODgzMjAsIDB4OUFCRkIzQjYsCiAgICAgICAweDAzQjZFMjBDLCAweDc0QjFEMjlBLCAweEVBRDU0NzM5LCAweDlERDI3N0FGLCAweDA0REIyNjE1LAogICAgICAgMHg3M0RDMTY4MywgMHhFMzYzMEIxMiwgMHg5NDY0M0I4NCwgMHgwRDZENkEzRSwgMHg3QTZBNUFBOCwKICAgICAgIDB4RTQwRUNGMEIsIDB4OTMwOUZGOUQsIDB4MEEwMEFFMjcsIDB4N0QwNzlFQjEsIDB4RjAwRjkzNDQsCiAgICAgICAweDg3MDhBM0QyLCAweDFFMDFGMjY4LCAweDY5MDZDMkZFLCAweEY3NjI1NzVELCAweDgwNjU2N0NCLAogICAgICAgMHgxOTZDMzY3MSwgMHg2RTZCMDZFNywgMHhGRUQ0MUI3NiwgMHg4OUQzMkJFMCwgMHgxMERBN0E1QSwKICAgICAgIDB4NjdERDRBQ0MsIDB4RjlCOURGNkYsIDB4OEVCRUVGRjksIDB4MTdCN0JFNDMsIDB4NjBCMDhFRDUsCiAgICAgICAweEQ2RDZBM0U4LCAweEExRDE5MzdFLCAweDM4RDhDMkM0LCAweDRGREZGMjUyLCAweEQxQkI2N0YxLAogICAgICAgMHhBNkJDNTc2NywgMHgzRkI1MDZERCwgMHg0OEIyMzY0QiwgMHhEODBEMkJEQSwgMHhBRjBBMUI0QywKICAgICAgIDB4MzYwMzRBRjYsIDB4NDEwNDdBNjAsIDB4REY2MEVGQzMsIDB4QTg2N0RGNTUsIDB4MzE2RThFRUYsCiAgICAgICAweDQ2NjlCRTc5LCAweENCNjFCMzhDLCAweEJDNjY4MzFBLCAweDI1NkZEMkEwLCAweDUyNjhFMjM2LAogICAgICAgMHhDQzBDNzc5NSwgMHhCQjBCNDcwMywgMHgyMjAyMTZCOSwgMHg1NTA1MjYyRiwgMHhDNUJBM0JCRSwKICAgICAgIDB4QjJCRDBCMjgsIDB4MkJCNDVBOTIsIDB4NUNCMzZBMDQsIDB4QzJEN0ZGQTcsIDB4QjVEMENGMzEsCiAgICAgICAweDJDRDk5RThCLCAweDVCREVBRTFELCAweDlCNjRDMkIwLCAweEVDNjNGMjI2LCAweDc1NkFBMzlDLAogICAgICAgMHgwMjZEOTMwQSwgMHg5QzA5MDZBOSwgMHhFQjBFMzYzRiwgMHg3MjA3Njc4NSwgMHgwNTAwNTcxMywKICAgICAgIDB4OTVCRjRBODIsIDB4RTJCODdBMTQsIDB4N0JCMTJCQUUsIDB4MENCNjFCMzgsIDB4OTJEMjhFOUIsCiAgICAgICAweEU1RDVCRTBELCAweDdDRENFRkI3LCAweDBCREJERjIxLCAweDg2RDNEMkQ0LCAweEYxRDRFMjQyLAogICAgICAgMHg2OEREQjNGOCwgMHgxRkRBODM2RSwgMHg4MUJFMTZDRCwgMHhGNkI5MjY1QiwgMHg2RkIwNzdFMSwKICAgICAgIDB4MThCNzQ3NzcsIDB4ODgwODVBRTYsIDB4RkYwRjZBNzAsIDB4NjYwNjNCQ0EsIDB4MTEwMTBCNUMsCiAgICAgICAweDhGNjU5RUZGLCAweEY4NjJBRTY5LCAweDYxNkJGRkQzLCAweDE2NkNDRjQ1LCAweEEwMEFFMjc4LAogICAgICAgMHhENzBERDJFRSwgMHg0RTA0ODM1NCwgMHgzOTAzQjNDMiwgMHhBNzY3MjY2MSwgMHhEMDYwMTZGNywKICAgICAgIDB4NDk2OTQ3NEQsIDB4M0U2RTc3REIsIDB4QUVEMTZBNEEsIDB4RDlENjVBREMsIDB4NDBERjBCNjYsCiAgICAgICAweDM3RDgzQkYwLCAweEE5QkNBRTUzLCAweERFQkI5RUM1LCAweDQ3QjJDRjdGLCAweDMwQjVGRkU5LAogICAgICAgMHhCREJERjIxQywgMHhDQUJBQzI4QSwgMHg1M0IzOTMzMCwgMHgyNEI0QTNBNiwgMHhCQUQwMzYwNSwKICAgICAgIDB4Q0RENzA2OTMsIDB4NTRERTU3MjksIDB4MjNEOTY3QkYsIDB4QjM2NjdBMkUsIDB4QzQ2MTRBQjgsCiAgICAgICAweDVENjgxQjAyLCAweDJBNkYyQjk0LCAweEI0MEJCRTM3LCAweEMzMEM4RUExLCAweDVBMDVERjFCLAogICAgICAgMHgyRDAyRUY4RF0sCiAgCiAgICAgIGNyYzMyOiBmdW5jdGlvbiBjcmMzMihkYXRhKSB7CiAgICAgICAgdmFyIHRibCA9IHV0aWwuY3J5cHRvLmNyYzMyVGFibGU7CiAgICAgICAgdmFyIGNyYyA9IDAgXiAtMTsKICAKICAgICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBkYXRhID0gdXRpbC5idWZmZXIudG9CdWZmZXIoZGF0YSk7CiAgICAgICAgfQogIAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGNvZGUgPSBkYXRhLnJlYWRVSW50OChpKTsKICAgICAgICAgIGNyYyA9IChjcmMgPj4+IDgpIF4gdGJsWyhjcmMgXiBjb2RlKSAmIDB4RkZdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gKGNyYyBeIC0xKSA+Pj4gMDsKICAgICAgfSwKICAKICAgICAgaG1hYzogZnVuY3Rpb24gaG1hYyhrZXksIHN0cmluZywgZGlnZXN0LCBmbikgewogICAgICAgIGlmICghZGlnZXN0KSBkaWdlc3QgPSAnYmluYXJ5JzsKICAgICAgICBpZiAoZGlnZXN0ID09PSAnYnVmZmVyJykgeyBkaWdlc3QgPSB1bmRlZmluZWQ7IH0KICAgICAgICBpZiAoIWZuKSBmbiA9ICdzaGEyNTYnOwogICAgICAgIGlmICh0eXBlb2Ygc3RyaW5nID09PSAnc3RyaW5nJykgc3RyaW5nID0gdXRpbC5idWZmZXIudG9CdWZmZXIoc3RyaW5nKTsKICAgICAgICByZXR1cm4gdXRpbC5jcnlwdG8ubGliLmNyZWF0ZUhtYWMoZm4sIGtleSkudXBkYXRlKHN0cmluZykuZGlnZXN0KGRpZ2VzdCk7CiAgICAgIH0sCiAgCiAgICAgIG1kNTogZnVuY3Rpb24gbWQ1KGRhdGEsIGRpZ2VzdCwgY2FsbGJhY2spIHsKICAgICAgICByZXR1cm4gdXRpbC5jcnlwdG8uaGFzaCgnbWQ1JywgZGF0YSwgZGlnZXN0LCBjYWxsYmFjayk7CiAgICAgIH0sCiAgCiAgICAgIHNoYTI1NjogZnVuY3Rpb24gc2hhMjU2KGRhdGEsIGRpZ2VzdCwgY2FsbGJhY2spIHsKICAgICAgICByZXR1cm4gdXRpbC5jcnlwdG8uaGFzaCgnc2hhMjU2JywgZGF0YSwgZGlnZXN0LCBjYWxsYmFjayk7CiAgICAgIH0sCiAgCiAgICAgIGhhc2g6IGZ1bmN0aW9uKGFsZ29yaXRobSwgZGF0YSwgZGlnZXN0LCBjYWxsYmFjaykgewogICAgICAgIHZhciBoYXNoID0gdXRpbC5jcnlwdG8uY3JlYXRlSGFzaChhbGdvcml0aG0pOwogICAgICAgIGlmICghZGlnZXN0KSB7IGRpZ2VzdCA9ICdiaW5hcnknOyB9CiAgICAgICAgaWYgKGRpZ2VzdCA9PT0gJ2J1ZmZlcicpIHsgZGlnZXN0ID0gdW5kZWZpbmVkOyB9CiAgICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgZGF0YSA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyKGRhdGEpOwogICAgICAgIHZhciBzbGljZUZuID0gdXRpbC5hcnJheVNsaWNlRm4oZGF0YSk7CiAgICAgICAgdmFyIGlzQnVmZmVyID0gdXRpbC5CdWZmZXIuaXNCdWZmZXIoZGF0YSk7CiAgICAgICAgLy9JZGVudGlmeWluZyBvYmplY3RzIHdpdGggYW4gQXJyYXlCdWZmZXIgYXMgYnVmZmVycwogICAgICAgIGlmICh1dGlsLmlzQnJvd3NlcigpICYmIHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gJ3VuZGVmaW5lZCcgJiYgZGF0YSAmJiBkYXRhLmJ1ZmZlciBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSBpc0J1ZmZlciA9IHRydWU7CiAgCiAgICAgICAgaWYgKGNhbGxiYWNrICYmIHR5cGVvZiBkYXRhID09PSAnb2JqZWN0JyAmJgogICAgICAgICAgICB0eXBlb2YgZGF0YS5vbiA9PT0gJ2Z1bmN0aW9uJyAmJiAhaXNCdWZmZXIpIHsKICAgICAgICAgIGRhdGEub24oJ2RhdGEnLCBmdW5jdGlvbihjaHVuaykgeyBoYXNoLnVwZGF0ZShjaHVuayk7IH0pOwogICAgICAgICAgZGF0YS5vbignZXJyb3InLCBmdW5jdGlvbihlcnIpIHsgY2FsbGJhY2soZXJyKTsgfSk7CiAgICAgICAgICBkYXRhLm9uKCdlbmQnLCBmdW5jdGlvbigpIHsgY2FsbGJhY2sobnVsbCwgaGFzaC5kaWdlc3QoZGlnZXN0KSk7IH0pOwogICAgICAgIH0gZWxzZSBpZiAoY2FsbGJhY2sgJiYgc2xpY2VGbiAmJiAhaXNCdWZmZXIgJiYKICAgICAgICAgICAgICAgICAgIHR5cGVvZiBGaWxlUmVhZGVyICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgLy8gdGhpcyBtaWdodCBiZSBhIEZpbGUvQmxvYgogICAgICAgICAgdmFyIGluZGV4ID0gMCwgc2l6ZSA9IDEwMjQgKiA1MTI7CiAgICAgICAgICB2YXIgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTsKICAgICAgICAgIHJlYWRlci5vbmVycm9yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcignRmFpbGVkIHRvIHJlYWQgZGF0YS4nKSk7CiAgICAgICAgICB9OwogICAgICAgICAgcmVhZGVyLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYnVmID0gbmV3IHV0aWwuQnVmZmVyKG5ldyBVaW50OEFycmF5KHJlYWRlci5yZXN1bHQpKTsKICAgICAgICAgICAgaGFzaC51cGRhdGUoYnVmKTsKICAgICAgICAgICAgaW5kZXggKz0gYnVmLmxlbmd0aDsKICAgICAgICAgICAgcmVhZGVyLl9jb250aW51ZVJlYWRpbmcoKTsKICAgICAgICAgIH07CiAgICAgICAgICByZWFkZXIuX2NvbnRpbnVlUmVhZGluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoaW5kZXggPj0gZGF0YS5zaXplKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgaGFzaC5kaWdlc3QoZGlnZXN0KSk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgCiAgICAgICAgICAgIHZhciBiYWNrID0gaW5kZXggKyBzaXplOwogICAgICAgICAgICBpZiAoYmFjayA+IGRhdGEuc2l6ZSkgYmFjayA9IGRhdGEuc2l6ZTsKICAgICAgICAgICAgcmVhZGVyLnJlYWRBc0FycmF5QnVmZmVyKHNsaWNlRm4uY2FsbChkYXRhLCBpbmRleCwgYmFjaykpOwogICAgICAgICAgfTsKICAKICAgICAgICAgIHJlYWRlci5fY29udGludWVSZWFkaW5nKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICh1dGlsLmlzQnJvd3NlcigpICYmIHR5cGVvZiBkYXRhID09PSAnb2JqZWN0JyAmJiAhaXNCdWZmZXIpIHsKICAgICAgICAgICAgZGF0YSA9IG5ldyB1dGlsLkJ1ZmZlcihuZXcgVWludDhBcnJheShkYXRhKSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgb3V0ID0gaGFzaC51cGRhdGUoZGF0YSkuZGlnZXN0KGRpZ2VzdCk7CiAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKG51bGwsIG91dCk7CiAgICAgICAgICByZXR1cm4gb3V0OwogICAgICAgIH0KICAgICAgfSwKICAKICAgICAgdG9IZXg6IGZ1bmN0aW9uIHRvSGV4KGRhdGEpIHsKICAgICAgICB2YXIgb3V0ID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBvdXQucHVzaCgoJzAnICsgZGF0YS5jaGFyQ29kZUF0KGkpLnRvU3RyaW5nKDE2KSkuc3Vic3RyKC0yLCAyKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvdXQuam9pbignJyk7CiAgICAgIH0sCiAgCiAgICAgIGNyZWF0ZUhhc2g6IGZ1bmN0aW9uIGNyZWF0ZUhhc2goYWxnb3JpdGhtKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuY3J5cHRvLmxpYi5jcmVhdGVIYXNoKGFsZ29yaXRobSk7CiAgICAgIH0KICAKICAgIH0sCiAgCiAgICAvKiogQCFpZ25vcmUgKi8KICAKICAgIC8qIEFib3J0IGNvbnN0YW50ICovCiAgICBhYm9ydDoge30sCiAgCiAgICBlYWNoOiBmdW5jdGlvbiBlYWNoKG9iamVjdCwgaXRlckZ1bmN0aW9uKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSkgewogICAgICAgICAgdmFyIHJldCA9IGl0ZXJGdW5jdGlvbi5jYWxsKHRoaXMsIGtleSwgb2JqZWN0W2tleV0pOwogICAgICAgICAgaWYgKHJldCA9PT0gdXRpbC5hYm9ydCkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgYXJyYXlFYWNoOiBmdW5jdGlvbiBhcnJheUVhY2goYXJyYXksIGl0ZXJGdW5jdGlvbikgewogICAgICBmb3IgKHZhciBpZHggaW4gYXJyYXkpIHsKICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGFycmF5LCBpZHgpKSB7CiAgICAgICAgICB2YXIgcmV0ID0gaXRlckZ1bmN0aW9uLmNhbGwodGhpcywgYXJyYXlbaWR4XSwgcGFyc2VJbnQoaWR4LCAxMCkpOwogICAgICAgICAgaWYgKHJldCA9PT0gdXRpbC5hYm9ydCkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgdXBkYXRlOiBmdW5jdGlvbiB1cGRhdGUob2JqMSwgb2JqMikgewogICAgICB1dGlsLmVhY2gob2JqMiwgZnVuY3Rpb24gaXRlcmF0b3Ioa2V5LCBpdGVtKSB7CiAgICAgICAgb2JqMVtrZXldID0gaXRlbTsKICAgICAgfSk7CiAgICAgIHJldHVybiBvYmoxOwogICAgfSwKICAKICAgIG1lcmdlOiBmdW5jdGlvbiBtZXJnZShvYmoxLCBvYmoyKSB7CiAgICAgIHJldHVybiB1dGlsLnVwZGF0ZSh1dGlsLmNvcHkob2JqMSksIG9iajIpOwogICAgfSwKICAKICAgIGNvcHk6IGZ1bmN0aW9uIGNvcHkob2JqZWN0KSB7CiAgICAgIGlmIChvYmplY3QgPT09IG51bGwgfHwgb2JqZWN0ID09PSB1bmRlZmluZWQpIHJldHVybiBvYmplY3Q7CiAgICAgIHZhciBkdXBlID0ge307CiAgICAgIC8vIGpzaGludCBmb3JpbjpmYWxzZQogICAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSB7CiAgICAgICAgZHVwZVtrZXldID0gb2JqZWN0W2tleV07CiAgICAgIH0KICAgICAgcmV0dXJuIGR1cGU7CiAgICB9LAogIAogICAgaXNFbXB0eTogZnVuY3Rpb24gaXNFbXB0eShvYmopIHsKICAgICAgZm9yICh2YXIgcHJvcCBpbiBvYmopIHsKICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogIAogICAgYXJyYXlTbGljZUZuOiBmdW5jdGlvbiBhcnJheVNsaWNlRm4ob2JqKSB7CiAgICAgIHZhciBmbiA9IG9iai5zbGljZSB8fCBvYmoud2Via2l0U2xpY2UgfHwgb2JqLm1velNsaWNlOwogICAgICByZXR1cm4gdHlwZW9mIGZuID09PSAnZnVuY3Rpb24nID8gZm4gOiBudWxsOwogICAgfSwKICAKICAgIGlzVHlwZTogZnVuY3Rpb24gaXNUeXBlKG9iaiwgdHlwZSkgewogICAgICAvLyBoYW5kbGUgY3Jvc3MtImZyYW1lIiBvYmplY3RzCiAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gJ2Z1bmN0aW9uJykgdHlwZSA9IHV0aWwudHlwZU5hbWUodHlwZSk7CiAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgJyArIHR5cGUgKyAnXSc7CiAgICB9LAogIAogICAgdHlwZU5hbWU6IGZ1bmN0aW9uIHR5cGVOYW1lKHR5cGUpIHsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0eXBlLCAnbmFtZScpKSByZXR1cm4gdHlwZS5uYW1lOwogICAgICB2YXIgc3RyID0gdHlwZS50b1N0cmluZygpOwogICAgICB2YXIgbWF0Y2ggPSBzdHIubWF0Y2goL15ccypmdW5jdGlvbiAoLispXCgvKTsKICAgICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiBzdHI7CiAgICB9LAogIAogICAgZXJyb3I6IGZ1bmN0aW9uIGVycm9yKGVyciwgb3B0aW9ucykgewogICAgICB2YXIgb3JpZ2luYWxFcnJvciA9IG51bGw7CiAgICAgIGlmICh0eXBlb2YgZXJyLm1lc3NhZ2UgPT09ICdzdHJpbmcnICYmIGVyci5tZXNzYWdlICE9PSAnJykgewogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycgfHwgKG9wdGlvbnMgJiYgb3B0aW9ucy5tZXNzYWdlKSkgewogICAgICAgICAgb3JpZ2luYWxFcnJvciA9IHV0aWwuY29weShlcnIpOwogICAgICAgICAgb3JpZ2luYWxFcnJvci5tZXNzYWdlID0gZXJyLm1lc3NhZ2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIGVyci5tZXNzYWdlID0gZXJyLm1lc3NhZ2UgfHwgbnVsbDsKICAKICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJykgewogICAgICAgIGVyci5tZXNzYWdlID0gb3B0aW9uczsKICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ29iamVjdCcgJiYgb3B0aW9ucyAhPT0gbnVsbCkgewogICAgICAgIHV0aWwudXBkYXRlKGVyciwgb3B0aW9ucyk7CiAgICAgICAgaWYgKG9wdGlvbnMubWVzc2FnZSkKICAgICAgICAgIGVyci5tZXNzYWdlID0gb3B0aW9ucy5tZXNzYWdlOwogICAgICAgIGlmIChvcHRpb25zLmNvZGUgfHwgb3B0aW9ucy5uYW1lKQogICAgICAgICAgZXJyLmNvZGUgPSBvcHRpb25zLmNvZGUgfHwgb3B0aW9ucy5uYW1lOwogICAgICAgIGlmIChvcHRpb25zLnN0YWNrKQogICAgICAgICAgZXJyLnN0YWNrID0gb3B0aW9ucy5zdGFjazsKICAgICAgfQogIAogICAgICBpZiAodHlwZW9mIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlcnIsICduYW1lJywge3dyaXRhYmxlOiB0cnVlLCBlbnVtZXJhYmxlOiBmYWxzZX0pOwogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlcnIsICdtZXNzYWdlJywge2VudW1lcmFibGU6IHRydWV9KTsKICAgICAgfQogIAogICAgICBlcnIubmFtZSA9IG9wdGlvbnMgJiYgb3B0aW9ucy5uYW1lIHx8IGVyci5uYW1lIHx8IGVyci5jb2RlIHx8ICdFcnJvcic7CiAgICAgIGVyci50aW1lID0gbmV3IERhdGUoKTsKICAKICAgICAgaWYgKG9yaWdpbmFsRXJyb3IpIGVyci5vcmlnaW5hbEVycm9yID0gb3JpZ2luYWxFcnJvcjsKICAKICAgICAgcmV0dXJuIGVycjsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBpbmhlcml0OiBmdW5jdGlvbiBpbmhlcml0KGtsYXNzLCBmZWF0dXJlcykgewogICAgICB2YXIgbmV3T2JqZWN0ID0gbnVsbDsKICAgICAgaWYgKGZlYXR1cmVzID09PSB1bmRlZmluZWQpIHsKICAgICAgICBmZWF0dXJlcyA9IGtsYXNzOwogICAgICAgIGtsYXNzID0gT2JqZWN0OwogICAgICAgIG5ld09iamVjdCA9IHt9OwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBjdG9yID0gZnVuY3Rpb24gQ29uc3RydWN0b3JXcmFwcGVyKCkge307CiAgICAgICAgY3Rvci5wcm90b3R5cGUgPSBrbGFzcy5wcm90b3R5cGU7CiAgICAgICAgbmV3T2JqZWN0ID0gbmV3IGN0b3IoKTsKICAgICAgfQogIAogICAgICAvLyBjb25zdHJ1Y3RvciBub3Qgc3VwcGxpZWQsIGNyZWF0ZSBwYXNzLXRocm91Z2ggY3RvcgogICAgICBpZiAoZmVhdHVyZXMuY29uc3RydWN0b3IgPT09IE9iamVjdCkgewogICAgICAgIGZlYXR1cmVzLmNvbnN0cnVjdG9yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoa2xhc3MgIT09IE9iamVjdCkgewogICAgICAgICAgICByZXR1cm4ga2xhc3MuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgCiAgICAgIGZlYXR1cmVzLmNvbnN0cnVjdG9yLnByb3RvdHlwZSA9IG5ld09iamVjdDsKICAgICAgdXRpbC51cGRhdGUoZmVhdHVyZXMuY29uc3RydWN0b3IucHJvdG90eXBlLCBmZWF0dXJlcyk7CiAgICAgIGZlYXR1cmVzLmNvbnN0cnVjdG9yLl9fc3VwZXJfXyA9IGtsYXNzOwogICAgICByZXR1cm4gZmVhdHVyZXMuY29uc3RydWN0b3I7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbWl4aW46IGZ1bmN0aW9uIG1peGluKCkgewogICAgICB2YXIga2xhc3MgPSBhcmd1bWVudHNbMF07CiAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgLy8ganNoaW50IGZvcmluOmZhbHNlCiAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBhcmd1bWVudHNbaV0ucHJvdG90eXBlKSB7CiAgICAgICAgICB2YXIgZm4gPSBhcmd1bWVudHNbaV0ucHJvdG90eXBlW3Byb3BdOwogICAgICAgICAgaWYgKHByb3AgIT09ICdjb25zdHJ1Y3RvcicpIHsKICAgICAgICAgICAga2xhc3MucHJvdG90eXBlW3Byb3BdID0gZm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBrbGFzczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBoaWRlUHJvcGVydGllczogZnVuY3Rpb24gaGlkZVByb3BlcnRpZXMob2JqLCBwcm9wcykgewogICAgICBpZiAodHlwZW9mIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSAhPT0gJ2Z1bmN0aW9uJykgcmV0dXJuOwogIAogICAgICB1dGlsLmFycmF5RWFjaChwcm9wcywgZnVuY3Rpb24gKGtleSkgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgewogICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsIHdyaXRhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHByb3BlcnR5OiBmdW5jdGlvbiBwcm9wZXJ0eShvYmosIG5hbWUsIHZhbHVlLCBlbnVtZXJhYmxlLCBpc1ZhbHVlKSB7CiAgICAgIHZhciBvcHRzID0gewogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICBlbnVtZXJhYmxlOiBlbnVtZXJhYmxlICE9PSB1bmRlZmluZWQgPyBlbnVtZXJhYmxlIDogdHJ1ZQogICAgICB9OwogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nICYmICFpc1ZhbHVlKSB7CiAgICAgICAgb3B0cy5nZXQgPSB2YWx1ZTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICBvcHRzLnZhbHVlID0gdmFsdWU7IG9wdHMud3JpdGFibGUgPSB0cnVlOwogICAgICB9CiAgCiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIG5hbWUsIG9wdHMpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIG1lbW9pemVkUHJvcGVydHk6IGZ1bmN0aW9uIG1lbW9pemVkUHJvcGVydHkob2JqLCBuYW1lLCBnZXQsIGVudW1lcmFibGUpIHsKICAgICAgdmFyIGNhY2hlZFZhbHVlID0gbnVsbDsKICAKICAgICAgLy8gYnVpbGQgZW51bWVyYWJsZSBhdHRyaWJ1dGUgZm9yIGVhY2ggdmFsdWUgd2l0aCBsYXp5IGFjY2Vzc29yLgogICAgICB1dGlsLnByb3BlcnR5KG9iaiwgbmFtZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKGNhY2hlZFZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICBjYWNoZWRWYWx1ZSA9IGdldCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY2FjaGVkVmFsdWU7CiAgICAgIH0sIGVudW1lcmFibGUpOwogICAgfSwKICAKICAgIC8qKgogICAgICogVE9ETyBSZW1vdmUgaW4gbWFqb3IgdmVyc2lvbiByZXZpc2lvbgogICAgICogVGhpcyBiYWNrZmlsbCBwb3B1bGF0ZXMgcmVzcG9uc2UgZGF0YSB3aXRob3V0IHRoZQogICAgICogdG9wLWxldmVsIHBheWxvYWQgbmFtZS4KICAgICAqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaG9pc3RQYXlsb2FkTWVtYmVyOiBmdW5jdGlvbiBob2lzdFBheWxvYWRNZW1iZXIocmVzcCkgewogICAgICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogICAgICB2YXIgb3BlcmF0aW9uTmFtZSA9IHJlcS5vcGVyYXRpb247CiAgICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tvcGVyYXRpb25OYW1lXTsKICAgICAgdmFyIG91dHB1dCA9IG9wZXJhdGlvbi5vdXRwdXQ7CiAgICAgIGlmIChvdXRwdXQucGF5bG9hZCAmJiAhb3BlcmF0aW9uLmhhc0V2ZW50T3V0cHV0KSB7CiAgICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBvdXRwdXQubWVtYmVyc1tvdXRwdXQucGF5bG9hZF07CiAgICAgICAgdmFyIHJlc3BvbnNlUGF5bG9hZCA9IHJlc3AuZGF0YVtvdXRwdXQucGF5bG9hZF07CiAgICAgICAgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ3N0cnVjdHVyZScpIHsKICAgICAgICAgIHV0aWwuZWFjaChyZXNwb25zZVBheWxvYWQsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgdXRpbC5wcm9wZXJ0eShyZXNwLmRhdGEsIGtleSwgdmFsdWUsIGZhbHNlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQ29tcHV0ZSBTSEEtMjU2IGNoZWNrc3VtcyBvZiBzdHJlYW1zCiAgICAgKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNvbXB1dGVTaGEyNTY6IGZ1bmN0aW9uIGNvbXB1dGVTaGEyNTYoYm9keSwgZG9uZSkgewogICAgICBpZiAodXRpbC5pc05vZGUoKSkgewogICAgICAgIHZhciBTdHJlYW0gPSB1dGlsLnN0cmVhbS5TdHJlYW07CiAgICAgICAgdmFyIGZzID0gcmVxdWlyZSgnZnMnKTsKICAgICAgICBpZiAodHlwZW9mIFN0cmVhbSA9PT0gJ2Z1bmN0aW9uJyAmJiBib2R5IGluc3RhbmNlb2YgU3RyZWFtKSB7CiAgICAgICAgICBpZiAodHlwZW9mIGJvZHkucGF0aCA9PT0gJ3N0cmluZycpIHsgLy8gYXNzdW1lIGZpbGUgb2JqZWN0CiAgICAgICAgICAgIHZhciBzZXR0aW5ncyA9IHt9OwogICAgICAgICAgICBpZiAodHlwZW9mIGJvZHkuc3RhcnQgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgc2V0dGluZ3Muc3RhcnQgPSBib2R5LnN0YXJ0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgYm9keS5lbmQgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgc2V0dGluZ3MuZW5kID0gYm9keS5lbmQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYm9keSA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0oYm9keS5wYXRoLCBzZXR0aW5ncyk7CiAgICAgICAgICB9IGVsc2UgeyAvLyBUT0RPIHN1cHBvcnQgb3RoZXIgc3RyZWFtIHR5cGVzCiAgICAgICAgICAgIHJldHVybiBkb25lKG5ldyBFcnJvcignTm9uLWZpbGUgc3RyZWFtIG9iamVjdHMgYXJlICcgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ25vdCBzdXBwb3J0ZWQgd2l0aCBTaWdWNCcpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAKICAgICAgdXRpbC5jcnlwdG8uc2hhMjU2KGJvZHksICdoZXgnLCBmdW5jdGlvbihlcnIsIHNoYSkgewogICAgICAgIGlmIChlcnIpIGRvbmUoZXJyKTsKICAgICAgICBlbHNlIGRvbmUobnVsbCwgc2hhKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaXNDbG9ja1NrZXdlZDogZnVuY3Rpb24gaXNDbG9ja1NrZXdlZChzZXJ2ZXJUaW1lKSB7CiAgICAgIGlmIChzZXJ2ZXJUaW1lKSB7CiAgICAgICAgdXRpbC5wcm9wZXJ0eShBV1MuY29uZmlnLCAnaXNDbG9ja1NrZXdlZCcsCiAgICAgICAgICBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHNlcnZlclRpbWUpID49IDMwMDAwMCwgZmFsc2UpOwogICAgICAgIHJldHVybiBBV1MuY29uZmlnLmlzQ2xvY2tTa2V3ZWQ7CiAgICAgIH0KICAgIH0sCiAgCiAgICBhcHBseUNsb2NrT2Zmc2V0OiBmdW5jdGlvbiBhcHBseUNsb2NrT2Zmc2V0KHNlcnZlclRpbWUpIHsKICAgICAgaWYgKHNlcnZlclRpbWUpCiAgICAgICAgQVdTLmNvbmZpZy5zeXN0ZW1DbG9ja09mZnNldCA9IHNlcnZlclRpbWUgLSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBleHRyYWN0UmVxdWVzdElkOiBmdW5jdGlvbiBleHRyYWN0UmVxdWVzdElkKHJlc3ApIHsKICAgICAgdmFyIHJlcXVlc3RJZCA9IHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LXJlcXVlc3QtaWQnXSB8fAogICAgICAgICAgICAgICAgICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16bi1yZXF1ZXN0aWQnXTsKICAKICAgICAgaWYgKCFyZXF1ZXN0SWQgJiYgcmVzcC5kYXRhICYmIHJlc3AuZGF0YS5SZXNwb25zZU1ldGFkYXRhKSB7CiAgICAgICAgcmVxdWVzdElkID0gcmVzcC5kYXRhLlJlc3BvbnNlTWV0YWRhdGEuUmVxdWVzdElkOwogICAgICB9CiAgCiAgICAgIGlmIChyZXF1ZXN0SWQpIHsKICAgICAgICByZXNwLnJlcXVlc3RJZCA9IHJlcXVlc3RJZDsKICAgICAgfQogIAogICAgICBpZiAocmVzcC5lcnJvcikgewogICAgICAgIHJlc3AuZXJyb3IucmVxdWVzdElkID0gcmVxdWVzdElkOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYWRkUHJvbWlzZXM6IGZ1bmN0aW9uIGFkZFByb21pc2VzKGNvbnN0cnVjdG9ycywgUHJvbWlzZURlcGVuZGVuY3kpIHsKICAgICAgdmFyIGRlbGV0ZVByb21pc2VzID0gZmFsc2U7CiAgICAgIGlmIChQcm9taXNlRGVwZW5kZW5jeSA9PT0gdW5kZWZpbmVkICYmIEFXUyAmJiBBV1MuY29uZmlnKSB7CiAgICAgICAgUHJvbWlzZURlcGVuZGVuY3kgPSBBV1MuY29uZmlnLmdldFByb21pc2VzRGVwZW5kZW5jeSgpOwogICAgICB9CiAgICAgIGlmIChQcm9taXNlRGVwZW5kZW5jeSA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiBQcm9taXNlICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIFByb21pc2VEZXBlbmRlbmN5ID0gUHJvbWlzZTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIFByb21pc2VEZXBlbmRlbmN5ICE9PSAnZnVuY3Rpb24nKSBkZWxldGVQcm9taXNlcyA9IHRydWU7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShjb25zdHJ1Y3RvcnMpKSBjb25zdHJ1Y3RvcnMgPSBbY29uc3RydWN0b3JzXTsKICAKICAgICAgZm9yICh2YXIgaW5kID0gMDsgaW5kIDwgY29uc3RydWN0b3JzLmxlbmd0aDsgaW5kKyspIHsKICAgICAgICB2YXIgY29uc3RydWN0b3IgPSBjb25zdHJ1Y3RvcnNbaW5kXTsKICAgICAgICBpZiAoZGVsZXRlUHJvbWlzZXMpIHsKICAgICAgICAgIGlmIChjb25zdHJ1Y3Rvci5kZWxldGVQcm9taXNlc0Zyb21DbGFzcykgewogICAgICAgICAgICBjb25zdHJ1Y3Rvci5kZWxldGVQcm9taXNlc0Zyb21DbGFzcygpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoY29uc3RydWN0b3IuYWRkUHJvbWlzZXNUb0NsYXNzKSB7CiAgICAgICAgICBjb25zdHJ1Y3Rvci5hZGRQcm9taXNlc1RvQ2xhc3MoUHJvbWlzZURlcGVuZGVuY3kpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKiBSZXR1cm4gYSBmdW5jdGlvbiB0aGF0IHdpbGwgcmV0dXJuIGEgcHJvbWlzZSB3aG9zZSBmYXRlIGlzIGRlY2lkZWQgYnkgdGhlCiAgICAgKiBjYWxsYmFjayBiZWhhdmlvciBvZiB0aGUgZ2l2ZW4gbWV0aG9kIHdpdGggYG1ldGhvZE5hbWVgLiBUaGUgbWV0aG9kIHRvIGJlCiAgICAgKiBwcm9taXNpZmllZCBzaG91bGQgY29uZm9ybSB0byBub2RlLmpzIGNvbnZlbnRpb24gb2YgYWNjZXB0aW5nIGEgY2FsbGJhY2sgYXMKICAgICAqIGxhc3QgYXJndW1lbnQgYW5kIGNhbGxpbmcgdGhhdCBjYWxsYmFjayB3aXRoIGVycm9yIGFzIHRoZSBmaXJzdCBhcmd1bWVudAogICAgICogYW5kIHN1Y2Nlc3MgdmFsdWUgb24gdGhlIHNlY29uZCBhcmd1bWVudC4KICAgICAqLwogICAgcHJvbWlzaWZ5TWV0aG9kOiBmdW5jdGlvbiBwcm9taXNpZnlNZXRob2QobWV0aG9kTmFtZSwgUHJvbWlzZURlcGVuZGVuY3kpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIHByb21pc2UoKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2VEZXBlbmRlbmN5KGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgYXJncy5wdXNoKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBzZWxmW21ldGhvZE5hbWVdLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgICAgIH0pOwogICAgICB9OwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGlzRHVhbHN0YWNrQXZhaWxhYmxlOiBmdW5jdGlvbiBpc0R1YWxzdGFja0F2YWlsYWJsZShzZXJ2aWNlKSB7CiAgICAgIGlmICghc2VydmljZSkgcmV0dXJuIGZhbHNlOwogICAgICB2YXIgbWV0YWRhdGEgPSByZXF1aXJlKCcuLi9hcGlzL21ldGFkYXRhLmpzb24nKTsKICAgICAgaWYgKHR5cGVvZiBzZXJ2aWNlICE9PSAnc3RyaW5nJykgc2VydmljZSA9IHNlcnZpY2Uuc2VydmljZUlkZW50aWZpZXI7CiAgICAgIGlmICh0eXBlb2Ygc2VydmljZSAhPT0gJ3N0cmluZycgfHwgIW1ldGFkYXRhLmhhc093blByb3BlcnR5KHNlcnZpY2UpKSByZXR1cm4gZmFsc2U7CiAgICAgIHJldHVybiAhIW1ldGFkYXRhW3NlcnZpY2VdLmR1YWxzdGFja0F2YWlsYWJsZTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjYWxjdWxhdGVSZXRyeURlbGF5OiBmdW5jdGlvbiBjYWxjdWxhdGVSZXRyeURlbGF5KHJldHJ5Q291bnQsIHJldHJ5RGVsYXlPcHRpb25zKSB7CiAgICAgIGlmICghcmV0cnlEZWxheU9wdGlvbnMpIHJldHJ5RGVsYXlPcHRpb25zID0ge307CiAgICAgIHZhciBjdXN0b21CYWNrb2ZmID0gcmV0cnlEZWxheU9wdGlvbnMuY3VzdG9tQmFja29mZiB8fCBudWxsOwogICAgICBpZiAodHlwZW9mIGN1c3RvbUJhY2tvZmYgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm4gY3VzdG9tQmFja29mZihyZXRyeUNvdW50KTsKICAgICAgfQogICAgICB2YXIgYmFzZSA9IHR5cGVvZiByZXRyeURlbGF5T3B0aW9ucy5iYXNlID09PSAnbnVtYmVyJyA/IHJldHJ5RGVsYXlPcHRpb25zLmJhc2UgOiAxMDA7CiAgICAgIHZhciBkZWxheSA9IE1hdGgucmFuZG9tKCkgKiAoTWF0aC5wb3coMiwgcmV0cnlDb3VudCkgKiBiYXNlKTsKICAgICAgcmV0dXJuIGRlbGF5OwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGhhbmRsZVJlcXVlc3RXaXRoUmV0cmllczogZnVuY3Rpb24gaGFuZGxlUmVxdWVzdFdpdGhSZXRyaWVzKGh0dHBSZXF1ZXN0LCBvcHRpb25zLCBjYikgewogICAgICBpZiAoIW9wdGlvbnMpIG9wdGlvbnMgPSB7fTsKICAgICAgdmFyIGh0dHAgPSBBV1MuSHR0cENsaWVudC5nZXRJbnN0YW5jZSgpOwogICAgICB2YXIgaHR0cE9wdGlvbnMgPSBvcHRpb25zLmh0dHBPcHRpb25zIHx8IHt9OwogICAgICB2YXIgcmV0cnlDb3VudCA9IDA7CiAgCiAgICAgIHZhciBlcnJDYWxsYmFjayA9IGZ1bmN0aW9uKGVycikgewogICAgICAgIHZhciBtYXhSZXRyaWVzID0gb3B0aW9ucy5tYXhSZXRyaWVzIHx8IDA7CiAgICAgICAgaWYgKGVyciAmJiBlcnIuY29kZSA9PT0gJ1RpbWVvdXRFcnJvcicpIGVyci5yZXRyeWFibGUgPSB0cnVlOwogICAgICAgIGlmIChlcnIgJiYgZXJyLnJldHJ5YWJsZSAmJiByZXRyeUNvdW50IDwgbWF4UmV0cmllcykgewogICAgICAgICAgcmV0cnlDb3VudCsrOwogICAgICAgICAgdmFyIGRlbGF5ID0gdXRpbC5jYWxjdWxhdGVSZXRyeURlbGF5KHJldHJ5Q291bnQsIG9wdGlvbnMucmV0cnlEZWxheU9wdGlvbnMpOwogICAgICAgICAgc2V0VGltZW91dChzZW5kUmVxdWVzdCwgZGVsYXkgKyAoZXJyLnJldHJ5QWZ0ZXIgfHwgMCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjYihlcnIpOwogICAgICAgIH0KICAgICAgfTsKICAKICAgICAgdmFyIHNlbmRSZXF1ZXN0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGRhdGEgPSAnJzsKICAgICAgICBodHRwLmhhbmRsZVJlcXVlc3QoaHR0cFJlcXVlc3QsIGh0dHBPcHRpb25zLCBmdW5jdGlvbihodHRwUmVzcG9uc2UpIHsKICAgICAgICAgIGh0dHBSZXNwb25zZS5vbignZGF0YScsIGZ1bmN0aW9uKGNodW5rKSB7IGRhdGEgKz0gY2h1bmsudG9TdHJpbmcoKTsgfSk7CiAgICAgICAgICBodHRwUmVzcG9uc2Uub24oJ2VuZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgc3RhdHVzQ29kZSA9IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICAgICAgICBpZiAoc3RhdHVzQ29kZSA8IDMwMCkgewogICAgICAgICAgICAgIGNiKG51bGwsIGRhdGEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciByZXRyeUFmdGVyID0gcGFyc2VJbnQoaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3JldHJ5LWFmdGVyJ10sIDEwKSAqIDEwMDAgfHwgMDsKICAgICAgICAgICAgICB2YXIgZXJyID0gdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgICAgICAgIHsgcmV0cnlhYmxlOiBzdGF0dXNDb2RlID49IDUwMCB8fCBzdGF0dXNDb2RlID09PSA0MjkgfQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKHJldHJ5QWZ0ZXIgJiYgZXJyLnJldHJ5YWJsZSkgZXJyLnJldHJ5QWZ0ZXIgPSByZXRyeUFmdGVyOwogICAgICAgICAgICAgIGVyckNhbGxiYWNrKGVycik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0sIGVyckNhbGxiYWNrKTsKICAgICAgfTsKICAKICAgICAgQVdTLnV0aWwuZGVmZXIoc2VuZFJlcXVlc3QpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHV1aWQ6IHsKICAgICAgdjQ6IGZ1bmN0aW9uIHV1aWRWNCgpIHsKICAgICAgICByZXR1cm4gcmVxdWlyZSgndXVpZCcpLnY0KCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjb252ZXJ0UGF5bG9hZFRvU3RyaW5nOiBmdW5jdGlvbiBjb252ZXJ0UGF5bG9hZFRvU3RyaW5nKHJlc3ApIHsKICAgICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5vcGVyYXRpb247CiAgICAgIHZhciBydWxlcyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW29wZXJhdGlvbl0ub3V0cHV0IHx8IHt9OwogICAgICBpZiAocnVsZXMucGF5bG9hZCAmJiByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0pIHsKICAgICAgICByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0gPSByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0udG9TdHJpbmcoKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGRlZmVyOiBmdW5jdGlvbiBkZWZlcihjYWxsYmFjaykgewogICAgICBpZiAodHlwZW9mIHByb2Nlc3MgPT09ICdvYmplY3QnICYmIHR5cGVvZiBwcm9jZXNzLm5leHRUaWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhjYWxsYmFjayk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHNldEltbWVkaWF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHNldEltbWVkaWF0ZShjYWxsYmFjayk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0VGltZW91dChjYWxsYmFjaywgMCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRSZXF1ZXN0UGF5bG9hZFNoYXBlOiBmdW5jdGlvbiBnZXRSZXF1ZXN0UGF5bG9hZFNoYXBlKHJlcSkgewogICAgICB2YXIgb3BlcmF0aW9ucyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zOwogICAgICBpZiAoIW9wZXJhdGlvbnMpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIHZhciBvcGVyYXRpb24gPSAob3BlcmF0aW9ucyB8fCB7fSlbcmVxLm9wZXJhdGlvbl07CiAgICAgIGlmICghb3BlcmF0aW9uIHx8ICFvcGVyYXRpb24uaW5wdXQgfHwgIW9wZXJhdGlvbi5pbnB1dC5wYXlsb2FkKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICByZXR1cm4gb3BlcmF0aW9uLmlucHV0Lm1lbWJlcnNbb3BlcmF0aW9uLmlucHV0LnBheWxvYWRdOwogICAgfSwKICAKICAgIGdldFByb2ZpbGVzRnJvbVNoYXJlZENvbmZpZzogZnVuY3Rpb24gZ2V0UHJvZmlsZXNGcm9tU2hhcmVkQ29uZmlnKGluaUxvYWRlciwgZmlsZW5hbWUpIHsKICAgICAgdmFyIHByb2ZpbGVzID0ge307CiAgICAgIHZhciBwcm9maWxlc0Zyb21Db25maWcgPSB7fTsKICAgICAgaWYgKHByb2Nlc3MuZW52W3V0aWwuY29uZmlnT3B0SW5FbnZdKSB7CiAgICAgICAgdmFyIHByb2ZpbGVzRnJvbUNvbmZpZyA9IGluaUxvYWRlci5sb2FkRnJvbSh7CiAgICAgICAgICBpc0NvbmZpZzogdHJ1ZSwKICAgICAgICAgIGZpbGVuYW1lOiBwcm9jZXNzLmVudlt1dGlsLnNoYXJlZENvbmZpZ0ZpbGVFbnZdCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgdmFyIHByb2ZpbGVzRnJvbUNyZWRzID0gaW5pTG9hZGVyLmxvYWRGcm9tKHsKICAgICAgICBmaWxlbmFtZTogZmlsZW5hbWUgfHwKICAgICAgICAgIChwcm9jZXNzLmVudlt1dGlsLmNvbmZpZ09wdEluRW52XSAmJiBwcm9jZXNzLmVudlt1dGlsLnNoYXJlZENyZWRlbnRpYWxzRmlsZUVudl0pCiAgICAgIH0pOwogICAgICBmb3IgKHZhciBpID0gMCwgcHJvZmlsZU5hbWVzID0gT2JqZWN0LmtleXMocHJvZmlsZXNGcm9tQ29uZmlnKTsgaSA8IHByb2ZpbGVOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgIHByb2ZpbGVzW3Byb2ZpbGVOYW1lc1tpXV0gPSBwcm9maWxlc0Zyb21Db25maWdbcHJvZmlsZU5hbWVzW2ldXTsKICAgICAgfQogICAgICBmb3IgKHZhciBpID0gMCwgcHJvZmlsZU5hbWVzID0gT2JqZWN0LmtleXMocHJvZmlsZXNGcm9tQ3JlZHMpOyBpIDwgcHJvZmlsZU5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcHJvZmlsZXNbcHJvZmlsZU5hbWVzW2ldXSA9IHByb2ZpbGVzRnJvbUNyZWRzW3Byb2ZpbGVOYW1lc1tpXV07CiAgICAgIH0KICAgICAgcmV0dXJuIHByb2ZpbGVzOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGRlZmF1bHRQcm9maWxlOiAnZGVmYXVsdCcsCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjb25maWdPcHRJbkVudjogJ0FXU19TREtfTE9BRF9DT05GSUcnLAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc2hhcmVkQ3JlZGVudGlhbHNGaWxlRW52OiAnQVdTX1NIQVJFRF9DUkVERU5USUFMU19GSUxFJywKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNoYXJlZENvbmZpZ0ZpbGVFbnY6ICdBV1NfQ09ORklHX0ZJTEUnLAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaW1kc0Rpc2FibGVkRW52OiAnQVdTX0VDMl9NRVRBREFUQV9ESVNBQkxFRCcKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gdXRpbDsKICAKICB9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSxyZXF1aXJlKCJ0aW1lcnMiKS5zZXRJbW1lZGlhdGUpCiAgfSx7Ii4uL2FwaXMvbWV0YWRhdGEuanNvbiI6NCwiLi9jb3JlIjoxOCwiX3Byb2Nlc3MiOjg1LCJmcyI6NzksInRpbWVycyI6OTMsInV1aWQiOjk4fV0sNzI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBTaGFwZSA9IHJlcXVpcmUoJy4uL21vZGVsL3NoYXBlJyk7CiAgCiAgZnVuY3Rpb24gRG9tWG1sUGFyc2VyKCkgeyB9CiAgCiAgRG9tWG1sUGFyc2VyLnByb3RvdHlwZS5wYXJzZSA9IGZ1bmN0aW9uKHhtbCwgc2hhcGUpIHsKICAgIGlmICh4bWwucmVwbGFjZSgvXlxzKy8sICcnKSA9PT0gJycpIHJldHVybiB7fTsKICAKICAgIHZhciByZXN1bHQsIGVycm9yOwogICAgdHJ5IHsKICAgICAgaWYgKHdpbmRvdy5ET01QYXJzZXIpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIHBhcnNlciA9IG5ldyBET01QYXJzZXIoKTsKICAgICAgICAgIHJlc3VsdCA9IHBhcnNlci5wYXJzZUZyb21TdHJpbmcoeG1sLCAndGV4dC94bWwnKTsKICAgICAgICB9IGNhdGNoIChzeW50YXhFcnJvcikgewogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ1BhcnNlIGVycm9yIGluIGRvY3VtZW50JyksCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBvcmlnaW5hbEVycm9yOiBzeW50YXhFcnJvciwKICAgICAgICAgICAgICBjb2RlOiAnWE1MUGFyc2VyRXJyb3InLAogICAgICAgICAgICAgIHJldHJ5YWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgCiAgICAgICAgaWYgKHJlc3VsdC5kb2N1bWVudEVsZW1lbnQgPT09IG51bGwpIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdDYW5ub3QgcGFyc2UgZW1wdHkgZG9jdW1lbnQuJyksCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjb2RlOiAnWE1MUGFyc2VyRXJyb3InLAogICAgICAgICAgICAgIHJldHJ5YWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgCiAgICAgICAgdmFyIGlzRXJyb3IgPSByZXN1bHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3BhcnNlcmVycm9yJylbMF07CiAgICAgICAgaWYgKGlzRXJyb3IgJiYgKGlzRXJyb3IucGFyZW50Tm9kZSA9PT0gcmVzdWx0IHx8CiAgICAgICAgICAgIGlzRXJyb3IucGFyZW50Tm9kZS5ub2RlTmFtZSA9PT0gJ2JvZHknIHx8CiAgICAgICAgICAgIGlzRXJyb3IucGFyZW50Tm9kZS5wYXJlbnROb2RlID09PSByZXN1bHQgfHwKICAgICAgICAgICAgaXNFcnJvci5wYXJlbnROb2RlLnBhcmVudE5vZGUubm9kZU5hbWUgPT09ICdib2R5JykpIHsKICAgICAgICAgIHZhciBlcnJvckVsZW1lbnQgPSBpc0Vycm9yLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdkaXYnKVswXSB8fCBpc0Vycm9yOwogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoZXJyb3JFbGVtZW50LnRleHRDb250ZW50IHx8ICdQYXJzZXIgZXJyb3IgaW4gZG9jdW1lbnQnKSwKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNvZGU6ICdYTUxQYXJzZXJFcnJvcicsCiAgICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh3aW5kb3cuQWN0aXZlWE9iamVjdCkgewogICAgICAgIHJlc3VsdCA9IG5ldyB3aW5kb3cuQWN0aXZlWE9iamVjdCgnTWljcm9zb2Z0LlhNTERPTScpOwogICAgICAgIHJlc3VsdC5hc3luYyA9IGZhbHNlOwogIAogICAgICAgIGlmICghcmVzdWx0LmxvYWRYTUwoeG1sKSkgewogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ1BhcnNlIGVycm9yIGluIGRvY3VtZW50JyksCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjb2RlOiAnWE1MUGFyc2VyRXJyb3InLAogICAgICAgICAgICAgIHJldHJ5YWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgbG9hZCBYTUwgcGFyc2VyJyk7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZXJyb3IgPSBlOwogICAgfQogIAogICAgaWYgKHJlc3VsdCAmJiByZXN1bHQuZG9jdW1lbnRFbGVtZW50ICYmICFlcnJvcikgewogICAgICB2YXIgZGF0YSA9IHBhcnNlWG1sKHJlc3VsdC5kb2N1bWVudEVsZW1lbnQsIHNoYXBlKTsKICAgICAgdmFyIG1ldGFkYXRhID0gZ2V0RWxlbWVudEJ5VGFnTmFtZShyZXN1bHQuZG9jdW1lbnRFbGVtZW50LCAnUmVzcG9uc2VNZXRhZGF0YScpOwogICAgICBpZiAobWV0YWRhdGEpIHsKICAgICAgICBkYXRhLlJlc3BvbnNlTWV0YWRhdGEgPSBwYXJzZVhtbChtZXRhZGF0YSwge30pOwogICAgICB9CiAgICAgIHJldHVybiBkYXRhOwogICAgfSBlbHNlIGlmIChlcnJvcikgewogICAgICB0aHJvdyB1dGlsLmVycm9yKGVycm9yIHx8IG5ldyBFcnJvcigpLCB7Y29kZTogJ1hNTFBhcnNlckVycm9yJywgcmV0cnlhYmxlOiB0cnVlfSk7CiAgICB9IGVsc2UgeyAvLyBlbXB0eSB4bWwgZG9jdW1lbnQKICAgICAgcmV0dXJuIHt9OwogICAgfQogIH07CiAgCiAgZnVuY3Rpb24gZ2V0RWxlbWVudEJ5VGFnTmFtZSh4bWwsIHRhZykgewogICAgdmFyIGVsZW1lbnRzID0geG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZyk7CiAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IGVsZW1lbnRzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICBpZiAoZWxlbWVudHNbaV0ucGFyZW50Tm9kZSA9PT0geG1sKSB7CiAgICAgICAgcmV0dXJuIGVsZW1lbnRzW2ldOwogICAgICB9CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIHBhcnNlWG1sKHhtbCwgc2hhcGUpIHsKICAgIGlmICghc2hhcGUpIHNoYXBlID0ge307CiAgICBzd2l0Y2ggKHNoYXBlLnR5cGUpIHsKICAgICAgY2FzZSAnc3RydWN0dXJlJzogcmV0dXJuIHBhcnNlU3RydWN0dXJlKHhtbCwgc2hhcGUpOwogICAgICBjYXNlICdtYXAnOiByZXR1cm4gcGFyc2VNYXAoeG1sLCBzaGFwZSk7CiAgICAgIGNhc2UgJ2xpc3QnOiByZXR1cm4gcGFyc2VMaXN0KHhtbCwgc2hhcGUpOwogICAgICBjYXNlIHVuZGVmaW5lZDogY2FzZSBudWxsOiByZXR1cm4gcGFyc2VVbmtub3duKHhtbCk7CiAgICAgIGRlZmF1bHQ6IHJldHVybiBwYXJzZVNjYWxhcih4bWwsIHNoYXBlKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gcGFyc2VTdHJ1Y3R1cmUoeG1sLCBzaGFwZSkgewogICAgdmFyIGRhdGEgPSB7fTsKICAgIGlmICh4bWwgPT09IG51bGwpIHJldHVybiBkYXRhOwogIAogICAgdXRpbC5lYWNoKHNoYXBlLm1lbWJlcnMsIGZ1bmN0aW9uKG1lbWJlck5hbWUsIG1lbWJlclNoYXBlKSB7CiAgICAgIGlmIChtZW1iZXJTaGFwZS5pc1htbEF0dHJpYnV0ZSkgewogICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoeG1sLmF0dHJpYnV0ZXMsIG1lbWJlclNoYXBlLm5hbWUpKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSB4bWwuYXR0cmlidXRlc1ttZW1iZXJTaGFwZS5uYW1lXS52YWx1ZTsKICAgICAgICAgIGRhdGFbbWVtYmVyTmFtZV0gPSBwYXJzZVhtbCh7dGV4dENvbnRlbnQ6IHZhbHVlfSwgbWVtYmVyU2hhcGUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgeG1sQ2hpbGQgPSBtZW1iZXJTaGFwZS5mbGF0dGVuZWQgPyB4bWwgOgogICAgICAgICAgZ2V0RWxlbWVudEJ5VGFnTmFtZSh4bWwsIG1lbWJlclNoYXBlLm5hbWUpOwogICAgICAgIGlmICh4bWxDaGlsZCkgewogICAgICAgICAgZGF0YVttZW1iZXJOYW1lXSA9IHBhcnNlWG1sKHhtbENoaWxkLCBtZW1iZXJTaGFwZSk7CiAgICAgICAgfSBlbHNlIGlmICghbWVtYmVyU2hhcGUuZmxhdHRlbmVkICYmIG1lbWJlclNoYXBlLnR5cGUgPT09ICdsaXN0JykgewogICAgICAgICAgZGF0YVttZW1iZXJOYW1lXSA9IG1lbWJlclNoYXBlLmRlZmF1bHRWYWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIAogICAgcmV0dXJuIGRhdGE7CiAgfQogIAogIGZ1bmN0aW9uIHBhcnNlTWFwKHhtbCwgc2hhcGUpIHsKICAgIHZhciBkYXRhID0ge307CiAgICB2YXIgeG1sS2V5ID0gc2hhcGUua2V5Lm5hbWUgfHwgJ2tleSc7CiAgICB2YXIgeG1sVmFsdWUgPSBzaGFwZS52YWx1ZS5uYW1lIHx8ICd2YWx1ZSc7CiAgICB2YXIgdGFnTmFtZSA9IHNoYXBlLmZsYXR0ZW5lZCA/IHNoYXBlLm5hbWUgOiAnZW50cnknOwogIAogICAgdmFyIGNoaWxkID0geG1sLmZpcnN0RWxlbWVudENoaWxkOwogICAgd2hpbGUgKGNoaWxkKSB7CiAgICAgIGlmIChjaGlsZC5ub2RlTmFtZSA9PT0gdGFnTmFtZSkgewogICAgICAgIHZhciBrZXkgPSBnZXRFbGVtZW50QnlUYWdOYW1lKGNoaWxkLCB4bWxLZXkpLnRleHRDb250ZW50OwogICAgICAgIHZhciB2YWx1ZSA9IGdldEVsZW1lbnRCeVRhZ05hbWUoY2hpbGQsIHhtbFZhbHVlKTsKICAgICAgICBkYXRhW2tleV0gPSBwYXJzZVhtbCh2YWx1ZSwgc2hhcGUudmFsdWUpOwogICAgICB9CiAgICAgIGNoaWxkID0gY2hpbGQubmV4dEVsZW1lbnRTaWJsaW5nOwogICAgfQogICAgcmV0dXJuIGRhdGE7CiAgfQogIAogIGZ1bmN0aW9uIHBhcnNlTGlzdCh4bWwsIHNoYXBlKSB7CiAgICB2YXIgZGF0YSA9IFtdOwogICAgdmFyIHRhZ05hbWUgPSBzaGFwZS5mbGF0dGVuZWQgPyBzaGFwZS5uYW1lIDogKHNoYXBlLm1lbWJlci5uYW1lIHx8ICdtZW1iZXInKTsKICAKICAgIHZhciBjaGlsZCA9IHhtbC5maXJzdEVsZW1lbnRDaGlsZDsKICAgIHdoaWxlIChjaGlsZCkgewogICAgICBpZiAoY2hpbGQubm9kZU5hbWUgPT09IHRhZ05hbWUpIHsKICAgICAgICBkYXRhLnB1c2gocGFyc2VYbWwoY2hpbGQsIHNoYXBlLm1lbWJlcikpOwogICAgICB9CiAgICAgIGNoaWxkID0gY2hpbGQubmV4dEVsZW1lbnRTaWJsaW5nOwogICAgfQogICAgcmV0dXJuIGRhdGE7CiAgfQogIAogIGZ1bmN0aW9uIHBhcnNlU2NhbGFyKHhtbCwgc2hhcGUpIHsKICAgIGlmICh4bWwuZ2V0QXR0cmlidXRlKSB7CiAgICAgIHZhciBlbmNvZGluZyA9IHhtbC5nZXRBdHRyaWJ1dGUoJ2VuY29kaW5nJyk7CiAgICAgIGlmIChlbmNvZGluZyA9PT0gJ2Jhc2U2NCcpIHsKICAgICAgICBzaGFwZSA9IG5ldyBTaGFwZS5jcmVhdGUoe3R5cGU6IGVuY29kaW5nfSk7CiAgICAgIH0KICAgIH0KICAKICAgIHZhciB0ZXh0ID0geG1sLnRleHRDb250ZW50OwogICAgaWYgKHRleHQgPT09ICcnKSB0ZXh0ID0gbnVsbDsKICAgIGlmICh0eXBlb2Ygc2hhcGUudG9UeXBlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHJldHVybiBzaGFwZS50b1R5cGUodGV4dCk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGV4dDsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gcGFyc2VVbmtub3duKHhtbCkgewogICAgaWYgKHhtbCA9PT0gdW5kZWZpbmVkIHx8IHhtbCA9PT0gbnVsbCkgcmV0dXJuICcnOwogIAogICAgLy8gZW1wdHkgb2JqZWN0CiAgICBpZiAoIXhtbC5maXJzdEVsZW1lbnRDaGlsZCkgewogICAgICBpZiAoeG1sLnBhcmVudE5vZGUucGFyZW50Tm9kZSA9PT0gbnVsbCkgcmV0dXJuIHt9OwogICAgICBpZiAoeG1sLmNoaWxkTm9kZXMubGVuZ3RoID09PSAwKSByZXR1cm4gJyc7CiAgICAgIGVsc2UgcmV0dXJuIHhtbC50ZXh0Q29udGVudDsKICAgIH0KICAKICAgIC8vIG9iamVjdCwgcGFyc2UgYXMgc3RydWN0dXJlCiAgICB2YXIgc2hhcGUgPSB7dHlwZTogJ3N0cnVjdHVyZScsIG1lbWJlcnM6IHt9fTsKICAgIHZhciBjaGlsZCA9IHhtbC5maXJzdEVsZW1lbnRDaGlsZDsKICAgIHdoaWxlIChjaGlsZCkgewogICAgICB2YXIgdGFnID0gY2hpbGQubm9kZU5hbWU7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc2hhcGUubWVtYmVycywgdGFnKSkgewogICAgICAgIC8vIG11bHRpcGxlIHRhZ3Mgb2YgdGhlIHNhbWUgbmFtZSBtYWtlcyBpdCBhIGxpc3QKICAgICAgICBzaGFwZS5tZW1iZXJzW3RhZ10udHlwZSA9ICdsaXN0JzsKICAgICAgfSBlbHNlIHsKICAgICAgICBzaGFwZS5tZW1iZXJzW3RhZ10gPSB7bmFtZTogdGFnfTsKICAgICAgfQogICAgICBjaGlsZCA9IGNoaWxkLm5leHRFbGVtZW50U2libGluZzsKICAgIH0KICAgIHJldHVybiBwYXJzZVN0cnVjdHVyZSh4bWwsIHNoYXBlKTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBEb21YbWxQYXJzZXI7CiAgCiAgfSx7Ii4uL21vZGVsL3NoYXBlIjo0MywiLi4vdXRpbCI6NzF9XSw3MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIFhtbE5vZGUgPSByZXF1aXJlKCcuL3htbC1ub2RlJykuWG1sTm9kZTsKICB2YXIgWG1sVGV4dCA9IHJlcXVpcmUoJy4veG1sLXRleHQnKS5YbWxUZXh0OwogIAogIGZ1bmN0aW9uIFhtbEJ1aWxkZXIoKSB7IH0KICAKICBYbWxCdWlsZGVyLnByb3RvdHlwZS50b1hNTCA9IGZ1bmN0aW9uKHBhcmFtcywgc2hhcGUsIHJvb3RFbGVtZW50LCBub0VtcHR5KSB7CiAgICB2YXIgeG1sID0gbmV3IFhtbE5vZGUocm9vdEVsZW1lbnQpOwogICAgYXBwbHlOYW1lc3BhY2VzKHhtbCwgc2hhcGUsIHRydWUpOwogICAgc2VyaWFsaXplKHhtbCwgcGFyYW1zLCBzaGFwZSk7CiAgICByZXR1cm4geG1sLmNoaWxkcmVuLmxlbmd0aCA+IDAgfHwgbm9FbXB0eSA/IHhtbC50b1N0cmluZygpIDogJyc7CiAgfTsKICAKICBmdW5jdGlvbiBzZXJpYWxpemUoeG1sLCB2YWx1ZSwgc2hhcGUpIHsKICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICBjYXNlICdzdHJ1Y3R1cmUnOiByZXR1cm4gc2VyaWFsaXplU3RydWN0dXJlKHhtbCwgdmFsdWUsIHNoYXBlKTsKICAgICAgY2FzZSAnbWFwJzogcmV0dXJuIHNlcmlhbGl6ZU1hcCh4bWwsIHZhbHVlLCBzaGFwZSk7CiAgICAgIGNhc2UgJ2xpc3QnOiByZXR1cm4gc2VyaWFsaXplTGlzdCh4bWwsIHZhbHVlLCBzaGFwZSk7CiAgICAgIGRlZmF1bHQ6IHJldHVybiBzZXJpYWxpemVTY2FsYXIoeG1sLCB2YWx1ZSwgc2hhcGUpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVTdHJ1Y3R1cmUoeG1sLCBwYXJhbXMsIHNoYXBlKSB7CiAgICB1dGlsLmFycmF5RWFjaChzaGFwZS5tZW1iZXJOYW1lcywgZnVuY3Rpb24obWVtYmVyTmFtZSkgewogICAgICB2YXIgbWVtYmVyU2hhcGUgPSBzaGFwZS5tZW1iZXJzW21lbWJlck5hbWVdOwogICAgICBpZiAobWVtYmVyU2hhcGUubG9jYXRpb24gIT09ICdib2R5JykgcmV0dXJuOwogIAogICAgICB2YXIgdmFsdWUgPSBwYXJhbXNbbWVtYmVyTmFtZV07CiAgICAgIHZhciBuYW1lID0gbWVtYmVyU2hhcGUubmFtZTsKICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09IG51bGwpIHsKICAgICAgICBpZiAobWVtYmVyU2hhcGUuaXNYbWxBdHRyaWJ1dGUpIHsKICAgICAgICAgIHhtbC5hZGRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAobWVtYmVyU2hhcGUuZmxhdHRlbmVkKSB7CiAgICAgICAgICBzZXJpYWxpemUoeG1sLCB2YWx1ZSwgbWVtYmVyU2hhcGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IG5ldyBYbWxOb2RlKG5hbWUpOwogICAgICAgICAgeG1sLmFkZENoaWxkTm9kZShlbGVtZW50KTsKICAgICAgICAgIGFwcGx5TmFtZXNwYWNlcyhlbGVtZW50LCBtZW1iZXJTaGFwZSk7CiAgICAgICAgICBzZXJpYWxpemUoZWxlbWVudCwgdmFsdWUsIG1lbWJlclNoYXBlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVNYXAoeG1sLCBtYXAsIHNoYXBlKSB7CiAgICB2YXIgeG1sS2V5ID0gc2hhcGUua2V5Lm5hbWUgfHwgJ2tleSc7CiAgICB2YXIgeG1sVmFsdWUgPSBzaGFwZS52YWx1ZS5uYW1lIHx8ICd2YWx1ZSc7CiAgCiAgICB1dGlsLmVhY2gobWFwLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIHZhciBlbnRyeSA9IG5ldyBYbWxOb2RlKHNoYXBlLmZsYXR0ZW5lZCA/IHNoYXBlLm5hbWUgOiAnZW50cnknKTsKICAgICAgeG1sLmFkZENoaWxkTm9kZShlbnRyeSk7CiAgCiAgICAgIHZhciBlbnRyeUtleSA9IG5ldyBYbWxOb2RlKHhtbEtleSk7CiAgICAgIHZhciBlbnRyeVZhbHVlID0gbmV3IFhtbE5vZGUoeG1sVmFsdWUpOwogICAgICBlbnRyeS5hZGRDaGlsZE5vZGUoZW50cnlLZXkpOwogICAgICBlbnRyeS5hZGRDaGlsZE5vZGUoZW50cnlWYWx1ZSk7CiAgCiAgICAgIHNlcmlhbGl6ZShlbnRyeUtleSwga2V5LCBzaGFwZS5rZXkpOwogICAgICBzZXJpYWxpemUoZW50cnlWYWx1ZSwgdmFsdWUsIHNoYXBlLnZhbHVlKTsKICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVMaXN0KHhtbCwgbGlzdCwgc2hhcGUpIHsKICAgIGlmIChzaGFwZS5mbGF0dGVuZWQpIHsKICAgICAgdXRpbC5hcnJheUVhY2gobGlzdCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgbmFtZSA9IHNoYXBlLm1lbWJlci5uYW1lIHx8IHNoYXBlLm5hbWU7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBuZXcgWG1sTm9kZShuYW1lKTsKICAgICAgICB4bWwuYWRkQ2hpbGROb2RlKGVsZW1lbnQpOwogICAgICAgIHNlcmlhbGl6ZShlbGVtZW50LCB2YWx1ZSwgc2hhcGUubWVtYmVyKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICB1dGlsLmFycmF5RWFjaChsaXN0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHZhciBuYW1lID0gc2hhcGUubWVtYmVyLm5hbWUgfHwgJ21lbWJlcic7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBuZXcgWG1sTm9kZShuYW1lKTsKICAgICAgICB4bWwuYWRkQ2hpbGROb2RlKGVsZW1lbnQpOwogICAgICAgIHNlcmlhbGl6ZShlbGVtZW50LCB2YWx1ZSwgc2hhcGUubWVtYmVyKTsKICAgICAgfSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZVNjYWxhcih4bWwsIHZhbHVlLCBzaGFwZSkgewogICAgeG1sLmFkZENoaWxkTm9kZSgKICAgICAgbmV3IFhtbFRleHQoc2hhcGUudG9XaXJlRm9ybWF0KHZhbHVlKSkKICAgICk7CiAgfQogIAogIGZ1bmN0aW9uIGFwcGx5TmFtZXNwYWNlcyh4bWwsIHNoYXBlLCBpc1Jvb3QpIHsKICAgIHZhciB1cmksIHByZWZpeCA9ICd4bWxucyc7CiAgICBpZiAoc2hhcGUueG1sTmFtZXNwYWNlVXJpKSB7CiAgICAgIHVyaSA9IHNoYXBlLnhtbE5hbWVzcGFjZVVyaTsKICAgICAgaWYgKHNoYXBlLnhtbE5hbWVzcGFjZVByZWZpeCkgcHJlZml4ICs9ICc6JyArIHNoYXBlLnhtbE5hbWVzcGFjZVByZWZpeDsKICAgIH0gZWxzZSBpZiAoaXNSb290ICYmIHNoYXBlLmFwaS54bWxOYW1lc3BhY2VVcmkpIHsKICAgICAgdXJpID0gc2hhcGUuYXBpLnhtbE5hbWVzcGFjZVVyaTsKICAgIH0KICAKICAgIGlmICh1cmkpIHhtbC5hZGRBdHRyaWJ1dGUocHJlZml4LCB1cmkpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IFhtbEJ1aWxkZXI7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxLCIuL3htbC1ub2RlIjo3NiwiLi94bWwtdGV4dCI6Nzd9XSw3NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLyoqCiAgICogRXNjYXBlcyBjaGFyYWN0ZXJzIHRoYXQgY2FuIG5vdCBiZSBpbiBhbiBYTUwgYXR0cmlidXRlLgogICAqLwogIGZ1bmN0aW9uIGVzY2FwZUF0dHJpYnV0ZSh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUucmVwbGFjZSgvJi9nLCAnJmFtcDsnKS5yZXBsYWNlKC8nL2csICcmYXBvczsnKS5yZXBsYWNlKC88L2csICcmbHQ7JykucmVwbGFjZSgvPi9nLCAnJmd0OycpLnJlcGxhY2UoLyIvZywgJyZxdW90OycpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgZXNjYXBlQXR0cmlidXRlOiBlc2NhcGVBdHRyaWJ1dGUKICB9OwogIAogIH0se31dLDc1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvKioKICAgKiBFc2NhcGVzIGNoYXJhY3RlcnMgdGhhdCBjYW4gbm90IGJlIGluIGFuIFhNTCBlbGVtZW50LgogICAqLwogIGZ1bmN0aW9uIGVzY2FwZUVsZW1lbnQodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoLyYvZywgJyZhbXA7JykucmVwbGFjZSgvPC9nLCAnJmx0OycpLnJlcGxhY2UoLz4vZywgJyZndDsnKTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGVzY2FwZUVsZW1lbnQ6IGVzY2FwZUVsZW1lbnQKICB9OwogIAogIH0se31dLDc2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgZXNjYXBlQXR0cmlidXRlID0gcmVxdWlyZSgnLi9lc2NhcGUtYXR0cmlidXRlJykuZXNjYXBlQXR0cmlidXRlOwogIAogIC8qKgogICAqIFJlcHJlc2VudHMgYW4gWE1MIG5vZGUuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gWG1sTm9kZShuYW1lLCBjaGlsZHJlbikgewogICAgICBpZiAoY2hpbGRyZW4gPT09IHZvaWQgMCkgeyBjaGlsZHJlbiA9IFtdOyB9CiAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgICAgdGhpcy5hdHRyaWJ1dGVzID0ge307CiAgfQogIFhtbE5vZGUucHJvdG90eXBlLmFkZEF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICB0aGlzLmF0dHJpYnV0ZXNbbmFtZV0gPSB2YWx1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgfTsKICBYbWxOb2RlLnByb3RvdHlwZS5hZGRDaGlsZE5vZGUgPSBmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgdGhpcy5jaGlsZHJlbi5wdXNoKGNoaWxkKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgfTsKICBYbWxOb2RlLnByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGUgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICBkZWxldGUgdGhpcy5hdHRyaWJ1dGVzW25hbWVdOwogICAgICByZXR1cm4gdGhpczsKICB9OwogIFhtbE5vZGUucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgaGFzQ2hpbGRyZW4gPSBCb29sZWFuKHRoaXMuY2hpbGRyZW4ubGVuZ3RoKTsKICAgICAgdmFyIHhtbFRleHQgPSAnPCcgKyB0aGlzLm5hbWU7CiAgICAgIC8vIGFkZCBhdHRyaWJ1dGVzCiAgICAgIHZhciBhdHRyaWJ1dGVzID0gdGhpcy5hdHRyaWJ1dGVzOwogICAgICBmb3IgKHZhciBpID0gMCwgYXR0cmlidXRlTmFtZXMgPSBPYmplY3Qua2V5cyhhdHRyaWJ1dGVzKTsgaSA8IGF0dHJpYnV0ZU5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgYXR0cmlidXRlTmFtZSA9IGF0dHJpYnV0ZU5hbWVzW2ldOwogICAgICAgICAgdmFyIGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV07CiAgICAgICAgICBpZiAodHlwZW9mIGF0dHJpYnV0ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgYXR0cmlidXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgeG1sVGV4dCArPSAnICcgKyBhdHRyaWJ1dGVOYW1lICsgJz1cIicgKyBlc2NhcGVBdHRyaWJ1dGUoJycgKyBhdHRyaWJ1dGUpICsgJ1wiJzsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4geG1sVGV4dCArPSAhaGFzQ2hpbGRyZW4gPyAnLz4nIDogJz4nICsgdGhpcy5jaGlsZHJlbi5tYXAoZnVuY3Rpb24gKGMpIHsgcmV0dXJuIGMudG9TdHJpbmcoKTsgfSkuam9pbignJykgKyAnPC8nICsgdGhpcy5uYW1lICsgJz4nOwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIFhtbE5vZGU6IFhtbE5vZGUKICB9OwogIAogIH0seyIuL2VzY2FwZS1hdHRyaWJ1dGUiOjc0fV0sNzc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBlc2NhcGVFbGVtZW50ID0gcmVxdWlyZSgnLi9lc2NhcGUtZWxlbWVudCcpLmVzY2FwZUVsZW1lbnQ7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyBhbiBYTUwgdGV4dCB2YWx1ZS4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBYbWxUZXh0KHZhbHVlKSB7CiAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICB9CiAgCiAgWG1sVGV4dC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBlc2NhcGVFbGVtZW50KCcnICsgdGhpcy52YWx1ZSk7CiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgWG1sVGV4dDogWG1sVGV4dAogIH07CiAgCiAgfSx7Ii4vZXNjYXBlLWVsZW1lbnQiOjc1fV0sNzg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogICd1c2Ugc3RyaWN0JwogIAogIGV4cG9ydHMuYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGgKICBleHBvcnRzLnRvQnl0ZUFycmF5ID0gdG9CeXRlQXJyYXkKICBleHBvcnRzLmZyb21CeXRlQXJyYXkgPSBmcm9tQnl0ZUFycmF5CiAgCiAgdmFyIGxvb2t1cCA9IFtdCiAgdmFyIHJldkxvb2t1cCA9IFtdCiAgdmFyIEFyciA9IHR5cGVvZiBVaW50OEFycmF5ICE9PSAndW5kZWZpbmVkJyA/IFVpbnQ4QXJyYXkgOiBBcnJheQogIAogIHZhciBjb2RlID0gJ0FCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5Ky8nCiAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGNvZGUubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgIGxvb2t1cFtpXSA9IGNvZGVbaV0KICAgIHJldkxvb2t1cFtjb2RlLmNoYXJDb2RlQXQoaSldID0gaQogIH0KICAKICAvLyBTdXBwb3J0IGRlY29kaW5nIFVSTC1zYWZlIGJhc2U2NCBzdHJpbmdzLCBhcyBOb2RlLmpzIGRvZXMuCiAgLy8gU2VlOiBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9CYXNlNjQjVVJMX2FwcGxpY2F0aW9ucwogIHJldkxvb2t1cFsnLScuY2hhckNvZGVBdCgwKV0gPSA2MgogIHJldkxvb2t1cFsnXycuY2hhckNvZGVBdCgwKV0gPSA2MwogIAogIGZ1bmN0aW9uIGdldExlbnMgKGI2NCkgewogICAgdmFyIGxlbiA9IGI2NC5sZW5ndGgKICAKICAgIGlmIChsZW4gJSA0ID4gMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgc3RyaW5nLiBMZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDQnKQogICAgfQogIAogICAgLy8gVHJpbSBvZmYgZXh0cmEgYnl0ZXMgYWZ0ZXIgcGxhY2Vob2xkZXIgYnl0ZXMgYXJlIGZvdW5kCiAgICAvLyBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9iZWF0Z2FtbWl0L2Jhc2U2NC1qcy9pc3N1ZXMvNDIKICAgIHZhciB2YWxpZExlbiA9IGI2NC5pbmRleE9mKCc9JykKICAgIGlmICh2YWxpZExlbiA9PT0gLTEpIHZhbGlkTGVuID0gbGVuCiAgCiAgICB2YXIgcGxhY2VIb2xkZXJzTGVuID0gdmFsaWRMZW4gPT09IGxlbgogICAgICA/IDAKICAgICAgOiA0IC0gKHZhbGlkTGVuICUgNCkKICAKICAgIHJldHVybiBbdmFsaWRMZW4sIHBsYWNlSG9sZGVyc0xlbl0KICB9CiAgCiAgLy8gYmFzZTY0IGlzIDQvMyArIHVwIHRvIHR3byBjaGFyYWN0ZXJzIG9mIHRoZSBvcmlnaW5hbCBkYXRhCiAgZnVuY3Rpb24gYnl0ZUxlbmd0aCAoYjY0KSB7CiAgICB2YXIgbGVucyA9IGdldExlbnMoYjY0KQogICAgdmFyIHZhbGlkTGVuID0gbGVuc1swXQogICAgdmFyIHBsYWNlSG9sZGVyc0xlbiA9IGxlbnNbMV0KICAgIHJldHVybiAoKHZhbGlkTGVuICsgcGxhY2VIb2xkZXJzTGVuKSAqIDMgLyA0KSAtIHBsYWNlSG9sZGVyc0xlbgogIH0KICAKICBmdW5jdGlvbiBfYnl0ZUxlbmd0aCAoYjY0LCB2YWxpZExlbiwgcGxhY2VIb2xkZXJzTGVuKSB7CiAgICByZXR1cm4gKCh2YWxpZExlbiArIHBsYWNlSG9sZGVyc0xlbikgKiAzIC8gNCkgLSBwbGFjZUhvbGRlcnNMZW4KICB9CiAgCiAgZnVuY3Rpb24gdG9CeXRlQXJyYXkgKGI2NCkgewogICAgdmFyIHRtcAogICAgdmFyIGxlbnMgPSBnZXRMZW5zKGI2NCkKICAgIHZhciB2YWxpZExlbiA9IGxlbnNbMF0KICAgIHZhciBwbGFjZUhvbGRlcnNMZW4gPSBsZW5zWzFdCiAgCiAgICB2YXIgYXJyID0gbmV3IEFycihfYnl0ZUxlbmd0aChiNjQsIHZhbGlkTGVuLCBwbGFjZUhvbGRlcnNMZW4pKQogIAogICAgdmFyIGN1ckJ5dGUgPSAwCiAgCiAgICAvLyBpZiB0aGVyZSBhcmUgcGxhY2Vob2xkZXJzLCBvbmx5IGdldCB1cCB0byB0aGUgbGFzdCBjb21wbGV0ZSA0IGNoYXJzCiAgICB2YXIgbGVuID0gcGxhY2VIb2xkZXJzTGVuID4gMAogICAgICA/IHZhbGlkTGVuIC0gNAogICAgICA6IHZhbGlkTGVuCiAgCiAgICB2YXIgaQogICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSArPSA0KSB7CiAgICAgIHRtcCA9CiAgICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpKV0gPDwgMTgpIHwKICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAxKV0gPDwgMTIpIHwKICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAyKV0gPDwgNikgfAogICAgICAgIHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMyldCiAgICAgIGFycltjdXJCeXRlKytdID0gKHRtcCA+PiAxNikgJiAweEZGCiAgICAgIGFycltjdXJCeXRlKytdID0gKHRtcCA+PiA4KSAmIDB4RkYKICAgICAgYXJyW2N1ckJ5dGUrK10gPSB0bXAgJiAweEZGCiAgICB9CiAgCiAgICBpZiAocGxhY2VIb2xkZXJzTGVuID09PSAyKSB7CiAgICAgIHRtcCA9CiAgICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpKV0gPDwgMikgfAogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDEpXSA+PiA0KQogICAgICBhcnJbY3VyQnl0ZSsrXSA9IHRtcCAmIDB4RkYKICAgIH0KICAKICAgIGlmIChwbGFjZUhvbGRlcnNMZW4gPT09IDEpIHsKICAgICAgdG1wID0KICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkpXSA8PCAxMCkgfAogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDEpXSA8PCA0KSB8CiAgICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMildID4+IDIpCiAgICAgIGFycltjdXJCeXRlKytdID0gKHRtcCA+PiA4KSAmIDB4RkYKICAgICAgYXJyW2N1ckJ5dGUrK10gPSB0bXAgJiAweEZGCiAgICB9CiAgCiAgICByZXR1cm4gYXJyCiAgfQogIAogIGZ1bmN0aW9uIHRyaXBsZXRUb0Jhc2U2NCAobnVtKSB7CiAgICByZXR1cm4gbG9va3VwW251bSA+PiAxOCAmIDB4M0ZdICsKICAgICAgbG9va3VwW251bSA+PiAxMiAmIDB4M0ZdICsKICAgICAgbG9va3VwW251bSA+PiA2ICYgMHgzRl0gKwogICAgICBsb29rdXBbbnVtICYgMHgzRl0KICB9CiAgCiAgZnVuY3Rpb24gZW5jb2RlQ2h1bmsgKHVpbnQ4LCBzdGFydCwgZW5kKSB7CiAgICB2YXIgdG1wCiAgICB2YXIgb3V0cHV0ID0gW10KICAgIGZvciAodmFyIGkgPSBzdGFydDsgaSA8IGVuZDsgaSArPSAzKSB7CiAgICAgIHRtcCA9CiAgICAgICAgKCh1aW50OFtpXSA8PCAxNikgJiAweEZGMDAwMCkgKwogICAgICAgICgodWludDhbaSArIDFdIDw8IDgpICYgMHhGRjAwKSArCiAgICAgICAgKHVpbnQ4W2kgKyAyXSAmIDB4RkYpCiAgICAgIG91dHB1dC5wdXNoKHRyaXBsZXRUb0Jhc2U2NCh0bXApKQogICAgfQogICAgcmV0dXJuIG91dHB1dC5qb2luKCcnKQogIH0KICAKICBmdW5jdGlvbiBmcm9tQnl0ZUFycmF5ICh1aW50OCkgewogICAgdmFyIHRtcAogICAgdmFyIGxlbiA9IHVpbnQ4Lmxlbmd0aAogICAgdmFyIGV4dHJhQnl0ZXMgPSBsZW4gJSAzIC8vIGlmIHdlIGhhdmUgMSBieXRlIGxlZnQsIHBhZCAyIGJ5dGVzCiAgICB2YXIgcGFydHMgPSBbXQogICAgdmFyIG1heENodW5rTGVuZ3RoID0gMTYzODMgLy8gbXVzdCBiZSBtdWx0aXBsZSBvZiAzCiAgCiAgICAvLyBnbyB0aHJvdWdoIHRoZSBhcnJheSBldmVyeSB0aHJlZSBieXRlcywgd2UnbGwgZGVhbCB3aXRoIHRyYWlsaW5nIHN0dWZmIGxhdGVyCiAgICBmb3IgKHZhciBpID0gMCwgbGVuMiA9IGxlbiAtIGV4dHJhQnl0ZXM7IGkgPCBsZW4yOyBpICs9IG1heENodW5rTGVuZ3RoKSB7CiAgICAgIHBhcnRzLnB1c2goZW5jb2RlQ2h1bmsoCiAgICAgICAgdWludDgsIGksIChpICsgbWF4Q2h1bmtMZW5ndGgpID4gbGVuMiA/IGxlbjIgOiAoaSArIG1heENodW5rTGVuZ3RoKQogICAgICApKQogICAgfQogIAogICAgLy8gcGFkIHRoZSBlbmQgd2l0aCB6ZXJvcywgYnV0IG1ha2Ugc3VyZSB0byBub3QgZm9yZ2V0IHRoZSBleHRyYSBieXRlcwogICAgaWYgKGV4dHJhQnl0ZXMgPT09IDEpIHsKICAgICAgdG1wID0gdWludDhbbGVuIC0gMV0KICAgICAgcGFydHMucHVzaCgKICAgICAgICBsb29rdXBbdG1wID4+IDJdICsKICAgICAgICBsb29rdXBbKHRtcCA8PCA0KSAmIDB4M0ZdICsKICAgICAgICAnPT0nCiAgICAgICkKICAgIH0gZWxzZSBpZiAoZXh0cmFCeXRlcyA9PT0gMikgewogICAgICB0bXAgPSAodWludDhbbGVuIC0gMl0gPDwgOCkgKyB1aW50OFtsZW4gLSAxXQogICAgICBwYXJ0cy5wdXNoKAogICAgICAgIGxvb2t1cFt0bXAgPj4gMTBdICsKICAgICAgICBsb29rdXBbKHRtcCA+PiA0KSAmIDB4M0ZdICsKICAgICAgICBsb29rdXBbKHRtcCA8PCAyKSAmIDB4M0ZdICsKICAgICAgICAnPScKICAgICAgKQogICAgfQogIAogICAgcmV0dXJuIHBhcnRzLmpvaW4oJycpCiAgfQogIAogIH0se31dLDc5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAKICB9LHt9XSw4MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChnbG9iYWwsQnVmZmVyKXsKICAvKiEKICAgKiBUaGUgYnVmZmVyIG1vZHVsZSBmcm9tIG5vZGUuanMsIGZvciB0aGUgYnJvd3Nlci4KICAgKgogICAqIEBhdXRob3IgICBGZXJvc3MgQWJvdWtoYWRpamVoIDxmZXJvc3NAZmVyb3NzLm9yZz4gPGh0dHA6Ly9mZXJvc3Mub3JnPgogICAqIEBsaWNlbnNlICBNSVQKICAgKi8KICAvKiBlc2xpbnQtZGlzYWJsZSBuby1wcm90byAqLwogIAogICd1c2Ugc3RyaWN0JwogIAogIHZhciBiYXNlNjQgPSByZXF1aXJlKCdiYXNlNjQtanMnKQogIHZhciBpZWVlNzU0ID0gcmVxdWlyZSgnaWVlZTc1NCcpCiAgdmFyIGlzQXJyYXkgPSByZXF1aXJlKCdpc2FycmF5JykKICAKICBleHBvcnRzLkJ1ZmZlciA9IEJ1ZmZlcgogIGV4cG9ydHMuU2xvd0J1ZmZlciA9IFNsb3dCdWZmZXIKICBleHBvcnRzLklOU1BFQ1RfTUFYX0JZVEVTID0gNTAKICAKICAvKioKICAgKiBJZiBgQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlRgOgogICAqICAgPT09IHRydWUgICAgVXNlIFVpbnQ4QXJyYXkgaW1wbGVtZW50YXRpb24gKGZhc3Rlc3QpCiAgICogICA9PT0gZmFsc2UgICBVc2UgT2JqZWN0IGltcGxlbWVudGF0aW9uIChtb3N0IGNvbXBhdGlibGUsIGV2ZW4gSUU2KQogICAqCiAgICogQnJvd3NlcnMgdGhhdCBzdXBwb3J0IHR5cGVkIGFycmF5cyBhcmUgSUUgMTArLCBGaXJlZm94IDQrLCBDaHJvbWUgNyssIFNhZmFyaSA1LjErLAogICAqIE9wZXJhIDExLjYrLCBpT1MgNC4yKy4KICAgKgogICAqIER1ZSB0byB2YXJpb3VzIGJyb3dzZXIgYnVncywgc29tZXRpbWVzIHRoZSBPYmplY3QgaW1wbGVtZW50YXRpb24gd2lsbCBiZSB1c2VkIGV2ZW4KICAgKiB3aGVuIHRoZSBicm93c2VyIHN1cHBvcnRzIHR5cGVkIGFycmF5cy4KICAgKgogICAqIE5vdGU6CiAgICoKICAgKiAgIC0gRmlyZWZveCA0LTI5IGxhY2tzIHN1cHBvcnQgZm9yIGFkZGluZyBuZXcgcHJvcGVydGllcyB0byBgVWludDhBcnJheWAgaW5zdGFuY2VzLAogICAqICAgICBTZWU6IGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTY5NTQzOC4KICAgKgogICAqICAgLSBDaHJvbWUgOS0xMCBpcyBtaXNzaW5nIHRoZSBgVHlwZWRBcnJheS5wcm90b3R5cGUuc3ViYXJyYXlgIGZ1bmN0aW9uLgogICAqCiAgICogICAtIElFMTAgaGFzIGEgYnJva2VuIGBUeXBlZEFycmF5LnByb3RvdHlwZS5zdWJhcnJheWAgZnVuY3Rpb24gd2hpY2ggcmV0dXJucyBhcnJheXMgb2YKICAgKiAgICAgaW5jb3JyZWN0IGxlbmd0aCBpbiBzb21lIHNpdHVhdGlvbnMuCiAgCiAgICogV2UgZGV0ZWN0IHRoZXNlIGJ1Z2d5IGJyb3dzZXJzIGFuZCBzZXQgYEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUYCB0byBgZmFsc2VgIHNvIHRoZXkKICAgKiBnZXQgdGhlIE9iamVjdCBpbXBsZW1lbnRhdGlvbiwgd2hpY2ggaXMgc2xvd2VyIGJ1dCBiZWhhdmVzIGNvcnJlY3RseS4KICAgKi8KICBCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCA9IGdsb2JhbC5UWVBFRF9BUlJBWV9TVVBQT1JUICE9PSB1bmRlZmluZWQKICAgID8gZ2xvYmFsLlRZUEVEX0FSUkFZX1NVUFBPUlQKICAgIDogdHlwZWRBcnJheVN1cHBvcnQoKQogIAogIC8qCiAgICogRXhwb3J0IGtNYXhMZW5ndGggYWZ0ZXIgdHlwZWQgYXJyYXkgc3VwcG9ydCBpcyBkZXRlcm1pbmVkLgogICAqLwogIGV4cG9ydHMua01heExlbmd0aCA9IGtNYXhMZW5ndGgoKQogIAogIGZ1bmN0aW9uIHR5cGVkQXJyYXlTdXBwb3J0ICgpIHsKICAgIHRyeSB7CiAgICAgIHZhciBhcnIgPSBuZXcgVWludDhBcnJheSgxKQogICAgICBhcnIuX19wcm90b19fID0ge19fcHJvdG9fXzogVWludDhBcnJheS5wcm90b3R5cGUsIGZvbzogZnVuY3Rpb24gKCkgeyByZXR1cm4gNDIgfX0KICAgICAgcmV0dXJuIGFyci5mb28oKSA9PT0gNDIgJiYgLy8gdHlwZWQgYXJyYXkgaW5zdGFuY2VzIGNhbiBiZSBhdWdtZW50ZWQKICAgICAgICAgIHR5cGVvZiBhcnIuc3ViYXJyYXkgPT09ICdmdW5jdGlvbicgJiYgLy8gY2hyb21lIDktMTAgbGFjayBgc3ViYXJyYXlgCiAgICAgICAgICBhcnIuc3ViYXJyYXkoMSwgMSkuYnl0ZUxlbmd0aCA9PT0gMCAvLyBpZTEwIGhhcyBicm9rZW4gYHN1YmFycmF5YAogICAgfSBjYXRjaCAoZSkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24ga01heExlbmd0aCAoKSB7CiAgICByZXR1cm4gQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQKICAgICAgPyAweDdmZmZmZmZmCiAgICAgIDogMHgzZmZmZmZmZgogIH0KICAKICBmdW5jdGlvbiBjcmVhdGVCdWZmZXIgKHRoYXQsIGxlbmd0aCkgewogICAgaWYgKGtNYXhMZW5ndGgoKSA8IGxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW52YWxpZCB0eXBlZCBhcnJheSBsZW5ndGgnKQogICAgfQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIC8vIFJldHVybiBhbiBhdWdtZW50ZWQgYFVpbnQ4QXJyYXlgIGluc3RhbmNlLCBmb3IgYmVzdCBwZXJmb3JtYW5jZQogICAgICB0aGF0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoKQogICAgICB0aGF0Ll9fcHJvdG9fXyA9IEJ1ZmZlci5wcm90b3R5cGUKICAgIH0gZWxzZSB7CiAgICAgIC8vIEZhbGxiYWNrOiBSZXR1cm4gYW4gb2JqZWN0IGluc3RhbmNlIG9mIHRoZSBCdWZmZXIgY2xhc3MKICAgICAgaWYgKHRoYXQgPT09IG51bGwpIHsKICAgICAgICB0aGF0ID0gbmV3IEJ1ZmZlcihsZW5ndGgpCiAgICAgIH0KICAgICAgdGhhdC5sZW5ndGggPSBsZW5ndGgKICAgIH0KICAKICAgIHJldHVybiB0aGF0CiAgfQogIAogIC8qKgogICAqIFRoZSBCdWZmZXIgY29uc3RydWN0b3IgcmV0dXJucyBpbnN0YW5jZXMgb2YgYFVpbnQ4QXJyYXlgIHRoYXQgaGF2ZSB0aGVpcgogICAqIHByb3RvdHlwZSBjaGFuZ2VkIHRvIGBCdWZmZXIucHJvdG90eXBlYC4gRnVydGhlcm1vcmUsIGBCdWZmZXJgIGlzIGEgc3ViY2xhc3Mgb2YKICAgKiBgVWludDhBcnJheWAsIHNvIHRoZSByZXR1cm5lZCBpbnN0YW5jZXMgd2lsbCBoYXZlIGFsbCB0aGUgbm9kZSBgQnVmZmVyYCBtZXRob2RzCiAgICogYW5kIHRoZSBgVWludDhBcnJheWAgbWV0aG9kcy4gU3F1YXJlIGJyYWNrZXQgbm90YXRpb24gd29ya3MgYXMgZXhwZWN0ZWQgLS0gaXQKICAgKiByZXR1cm5zIGEgc2luZ2xlIG9jdGV0LgogICAqCiAgICogVGhlIGBVaW50OEFycmF5YCBwcm90b3R5cGUgcmVtYWlucyB1bm1vZGlmaWVkLgogICAqLwogIAogIGZ1bmN0aW9uIEJ1ZmZlciAoYXJnLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpIHsKICAgIGlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQgJiYgISh0aGlzIGluc3RhbmNlb2YgQnVmZmVyKSkgewogICAgICByZXR1cm4gbmV3IEJ1ZmZlcihhcmcsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkKICAgIH0KICAKICAgIC8vIENvbW1vbiBjYXNlLgogICAgaWYgKHR5cGVvZiBhcmcgPT09ICdudW1iZXInKSB7CiAgICAgIGlmICh0eXBlb2YgZW5jb2RpbmdPck9mZnNldCA9PT0gJ3N0cmluZycpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAnSWYgZW5jb2RpbmcgaXMgc3BlY2lmaWVkIHRoZW4gdGhlIGZpcnN0IGFyZ3VtZW50IG11c3QgYmUgYSBzdHJpbmcnCiAgICAgICAgKQogICAgICB9CiAgICAgIHJldHVybiBhbGxvY1Vuc2FmZSh0aGlzLCBhcmcpCiAgICB9CiAgICByZXR1cm4gZnJvbSh0aGlzLCBhcmcsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkKICB9CiAgCiAgQnVmZmVyLnBvb2xTaXplID0gODE5MiAvLyBub3QgdXNlZCBieSB0aGlzIGltcGxlbWVudGF0aW9uCiAgCiAgLy8gVE9ETzogTGVnYWN5LCBub3QgbmVlZGVkIGFueW1vcmUuIFJlbW92ZSBpbiBuZXh0IG1ham9yIHZlcnNpb24uCiAgQnVmZmVyLl9hdWdtZW50ID0gZnVuY3Rpb24gKGFycikgewogICAgYXJyLl9fcHJvdG9fXyA9IEJ1ZmZlci5wcm90b3R5cGUKICAgIHJldHVybiBhcnIKICB9CiAgCiAgZnVuY3Rpb24gZnJvbSAodGhhdCwgdmFsdWUsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkgewogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignInZhbHVlIiBhcmd1bWVudCBtdXN0IG5vdCBiZSBhIG51bWJlcicpCiAgICB9CiAgCiAgICBpZiAodHlwZW9mIEFycmF5QnVmZmVyICE9PSAndW5kZWZpbmVkJyAmJiB2YWx1ZSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB7CiAgICAgIHJldHVybiBmcm9tQXJyYXlCdWZmZXIodGhhdCwgdmFsdWUsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkKICAgIH0KICAKICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7CiAgICAgIHJldHVybiBmcm9tU3RyaW5nKHRoYXQsIHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0KQogICAgfQogIAogICAgcmV0dXJuIGZyb21PYmplY3QodGhhdCwgdmFsdWUpCiAgfQogIAogIC8qKgogICAqIEZ1bmN0aW9uYWxseSBlcXVpdmFsZW50IHRvIEJ1ZmZlcihhcmcsIGVuY29kaW5nKSBidXQgdGhyb3dzIGEgVHlwZUVycm9yCiAgICogaWYgdmFsdWUgaXMgYSBudW1iZXIuCiAgICogQnVmZmVyLmZyb20oc3RyWywgZW5jb2RpbmddKQogICAqIEJ1ZmZlci5mcm9tKGFycmF5KQogICAqIEJ1ZmZlci5mcm9tKGJ1ZmZlcikKICAgKiBCdWZmZXIuZnJvbShhcnJheUJ1ZmZlclssIGJ5dGVPZmZzZXRbLCBsZW5ndGhdXSkKICAgKiovCiAgQnVmZmVyLmZyb20gPSBmdW5jdGlvbiAodmFsdWUsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkgewogICAgcmV0dXJuIGZyb20obnVsbCwgdmFsdWUsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkKICB9CiAgCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICBCdWZmZXIucHJvdG90eXBlLl9fcHJvdG9fXyA9IFVpbnQ4QXJyYXkucHJvdG90eXBlCiAgICBCdWZmZXIuX19wcm90b19fID0gVWludDhBcnJheQogICAgaWYgKHR5cGVvZiBTeW1ib2wgIT09ICd1bmRlZmluZWQnICYmIFN5bWJvbC5zcGVjaWVzICYmCiAgICAgICAgQnVmZmVyW1N5bWJvbC5zcGVjaWVzXSA9PT0gQnVmZmVyKSB7CiAgICAgIC8vIEZpeCBzdWJhcnJheSgpIGluIEVTMjAxNi4gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vZmVyb3NzL2J1ZmZlci9wdWxsLzk3CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShCdWZmZXIsIFN5bWJvbC5zcGVjaWVzLCB7CiAgICAgICAgdmFsdWU6IG51bGwsCiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgIH0pCiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGFzc2VydFNpemUgKHNpemUpIHsKICAgIGlmICh0eXBlb2Ygc2l6ZSAhPT0gJ251bWJlcicpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignInNpemUiIGFyZ3VtZW50IG11c3QgYmUgYSBudW1iZXInKQogICAgfSBlbHNlIGlmIChzaXplIDwgMCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignInNpemUiIGFyZ3VtZW50IG11c3Qgbm90IGJlIG5lZ2F0aXZlJykKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gYWxsb2MgKHRoYXQsIHNpemUsIGZpbGwsIGVuY29kaW5nKSB7CiAgICBhc3NlcnRTaXplKHNpemUpCiAgICBpZiAoc2l6ZSA8PSAwKSB7CiAgICAgIHJldHVybiBjcmVhdGVCdWZmZXIodGhhdCwgc2l6ZSkKICAgIH0KICAgIGlmIChmaWxsICE9PSB1bmRlZmluZWQpIHsKICAgICAgLy8gT25seSBwYXkgYXR0ZW50aW9uIHRvIGVuY29kaW5nIGlmIGl0J3MgYSBzdHJpbmcuIFRoaXMKICAgICAgLy8gcHJldmVudHMgYWNjaWRlbnRhbGx5IHNlbmRpbmcgaW4gYSBudW1iZXIgdGhhdCB3b3VsZAogICAgICAvLyBiZSBpbnRlcnByZXR0ZWQgYXMgYSBzdGFydCBvZmZzZXQuCiAgICAgIHJldHVybiB0eXBlb2YgZW5jb2RpbmcgPT09ICdzdHJpbmcnCiAgICAgICAgPyBjcmVhdGVCdWZmZXIodGhhdCwgc2l6ZSkuZmlsbChmaWxsLCBlbmNvZGluZykKICAgICAgICA6IGNyZWF0ZUJ1ZmZlcih0aGF0LCBzaXplKS5maWxsKGZpbGwpCiAgICB9CiAgICByZXR1cm4gY3JlYXRlQnVmZmVyKHRoYXQsIHNpemUpCiAgfQogIAogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgZmlsbGVkIEJ1ZmZlciBpbnN0YW5jZS4KICAgKiBhbGxvYyhzaXplWywgZmlsbFssIGVuY29kaW5nXV0pCiAgICoqLwogIEJ1ZmZlci5hbGxvYyA9IGZ1bmN0aW9uIChzaXplLCBmaWxsLCBlbmNvZGluZykgewogICAgcmV0dXJuIGFsbG9jKG51bGwsIHNpemUsIGZpbGwsIGVuY29kaW5nKQogIH0KICAKICBmdW5jdGlvbiBhbGxvY1Vuc2FmZSAodGhhdCwgc2l6ZSkgewogICAgYXNzZXJ0U2l6ZShzaXplKQogICAgdGhhdCA9IGNyZWF0ZUJ1ZmZlcih0aGF0LCBzaXplIDwgMCA/IDAgOiBjaGVja2VkKHNpemUpIHwgMCkKICAgIGlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzaXplOyArK2kpIHsKICAgICAgICB0aGF0W2ldID0gMAogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhhdAogIH0KICAKICAvKioKICAgKiBFcXVpdmFsZW50IHRvIEJ1ZmZlcihudW0pLCBieSBkZWZhdWx0IGNyZWF0ZXMgYSBub24temVyby1maWxsZWQgQnVmZmVyIGluc3RhbmNlLgogICAqICovCiAgQnVmZmVyLmFsbG9jVW5zYWZlID0gZnVuY3Rpb24gKHNpemUpIHsKICAgIHJldHVybiBhbGxvY1Vuc2FmZShudWxsLCBzaXplKQogIH0KICAvKioKICAgKiBFcXVpdmFsZW50IHRvIFNsb3dCdWZmZXIobnVtKSwgYnkgZGVmYXVsdCBjcmVhdGVzIGEgbm9uLXplcm8tZmlsbGVkIEJ1ZmZlciBpbnN0YW5jZS4KICAgKi8KICBCdWZmZXIuYWxsb2NVbnNhZmVTbG93ID0gZnVuY3Rpb24gKHNpemUpIHsKICAgIHJldHVybiBhbGxvY1Vuc2FmZShudWxsLCBzaXplKQogIH0KICAKICBmdW5jdGlvbiBmcm9tU3RyaW5nICh0aGF0LCBzdHJpbmcsIGVuY29kaW5nKSB7CiAgICBpZiAodHlwZW9mIGVuY29kaW5nICE9PSAnc3RyaW5nJyB8fCBlbmNvZGluZyA9PT0gJycpIHsKICAgICAgZW5jb2RpbmcgPSAndXRmOCcKICAgIH0KICAKICAgIGlmICghQnVmZmVyLmlzRW5jb2RpbmcoZW5jb2RpbmcpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJlbmNvZGluZyIgbXVzdCBiZSBhIHZhbGlkIHN0cmluZyBlbmNvZGluZycpCiAgICB9CiAgCiAgICB2YXIgbGVuZ3RoID0gYnl0ZUxlbmd0aChzdHJpbmcsIGVuY29kaW5nKSB8IDAKICAgIHRoYXQgPSBjcmVhdGVCdWZmZXIodGhhdCwgbGVuZ3RoKQogIAogICAgdmFyIGFjdHVhbCA9IHRoYXQud3JpdGUoc3RyaW5nLCBlbmNvZGluZykKICAKICAgIGlmIChhY3R1YWwgIT09IGxlbmd0aCkgewogICAgICAvLyBXcml0aW5nIGEgaGV4IHN0cmluZywgZm9yIGV4YW1wbGUsIHRoYXQgY29udGFpbnMgaW52YWxpZCBjaGFyYWN0ZXJzIHdpbGwKICAgICAgLy8gY2F1c2UgZXZlcnl0aGluZyBhZnRlciB0aGUgZmlyc3QgaW52YWxpZCBjaGFyYWN0ZXIgdG8gYmUgaWdub3JlZC4gKGUuZy4KICAgICAgLy8gJ2FieHhjZCcgd2lsbCBiZSB0cmVhdGVkIGFzICdhYicpCiAgICAgIHRoYXQgPSB0aGF0LnNsaWNlKDAsIGFjdHVhbCkKICAgIH0KICAKICAgIHJldHVybiB0aGF0CiAgfQogIAogIGZ1bmN0aW9uIGZyb21BcnJheUxpa2UgKHRoYXQsIGFycmF5KSB7CiAgICB2YXIgbGVuZ3RoID0gYXJyYXkubGVuZ3RoIDwgMCA/IDAgOiBjaGVja2VkKGFycmF5Lmxlbmd0aCkgfCAwCiAgICB0aGF0ID0gY3JlYXRlQnVmZmVyKHRoYXQsIGxlbmd0aCkKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDEpIHsKICAgICAgdGhhdFtpXSA9IGFycmF5W2ldICYgMjU1CiAgICB9CiAgICByZXR1cm4gdGhhdAogIH0KICAKICBmdW5jdGlvbiBmcm9tQXJyYXlCdWZmZXIgKHRoYXQsIGFycmF5LCBieXRlT2Zmc2V0LCBsZW5ndGgpIHsKICAgIGFycmF5LmJ5dGVMZW5ndGggLy8gdGhpcyB0aHJvd3MgaWYgYGFycmF5YCBpcyBub3QgYSB2YWxpZCBBcnJheUJ1ZmZlcgogIAogICAgaWYgKGJ5dGVPZmZzZXQgPCAwIHx8IGFycmF5LmJ5dGVMZW5ndGggPCBieXRlT2Zmc2V0KSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdcJ29mZnNldFwnIGlzIG91dCBvZiBib3VuZHMnKQogICAgfQogIAogICAgaWYgKGFycmF5LmJ5dGVMZW5ndGggPCBieXRlT2Zmc2V0ICsgKGxlbmd0aCB8fCAwKSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignXCdsZW5ndGhcJyBpcyBvdXQgb2YgYm91bmRzJykKICAgIH0KICAKICAgIGlmIChieXRlT2Zmc2V0ID09PSB1bmRlZmluZWQgJiYgbGVuZ3RoID09PSB1bmRlZmluZWQpIHsKICAgICAgYXJyYXkgPSBuZXcgVWludDhBcnJheShhcnJheSkKICAgIH0gZWxzZSBpZiAobGVuZ3RoID09PSB1bmRlZmluZWQpIHsKICAgICAgYXJyYXkgPSBuZXcgVWludDhBcnJheShhcnJheSwgYnl0ZU9mZnNldCkKICAgIH0gZWxzZSB7CiAgICAgIGFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXksIGJ5dGVPZmZzZXQsIGxlbmd0aCkKICAgIH0KICAKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICAvLyBSZXR1cm4gYW4gYXVnbWVudGVkIGBVaW50OEFycmF5YCBpbnN0YW5jZSwgZm9yIGJlc3QgcGVyZm9ybWFuY2UKICAgICAgdGhhdCA9IGFycmF5CiAgICAgIHRoYXQuX19wcm90b19fID0gQnVmZmVyLnByb3RvdHlwZQogICAgfSBlbHNlIHsKICAgICAgLy8gRmFsbGJhY2s6IFJldHVybiBhbiBvYmplY3QgaW5zdGFuY2Ugb2YgdGhlIEJ1ZmZlciBjbGFzcwogICAgICB0aGF0ID0gZnJvbUFycmF5TGlrZSh0aGF0LCBhcnJheSkKICAgIH0KICAgIHJldHVybiB0aGF0CiAgfQogIAogIGZ1bmN0aW9uIGZyb21PYmplY3QgKHRoYXQsIG9iaikgewogICAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihvYmopKSB7CiAgICAgIHZhciBsZW4gPSBjaGVja2VkKG9iai5sZW5ndGgpIHwgMAogICAgICB0aGF0ID0gY3JlYXRlQnVmZmVyKHRoYXQsIGxlbikKICAKICAgICAgaWYgKHRoYXQubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHRoYXQKICAgICAgfQogIAogICAgICBvYmouY29weSh0aGF0LCAwLCAwLCBsZW4pCiAgICAgIHJldHVybiB0aGF0CiAgICB9CiAgCiAgICBpZiAob2JqKSB7CiAgICAgIGlmICgodHlwZW9mIEFycmF5QnVmZmVyICE9PSAndW5kZWZpbmVkJyAmJgogICAgICAgICAgb2JqLmJ1ZmZlciBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB8fCAnbGVuZ3RoJyBpbiBvYmopIHsKICAgICAgICBpZiAodHlwZW9mIG9iai5sZW5ndGggIT09ICdudW1iZXInIHx8IGlzbmFuKG9iai5sZW5ndGgpKSB7CiAgICAgICAgICByZXR1cm4gY3JlYXRlQnVmZmVyKHRoYXQsIDApCiAgICAgICAgfQogICAgICAgIHJldHVybiBmcm9tQXJyYXlMaWtlKHRoYXQsIG9iaikKICAgICAgfQogIAogICAgICBpZiAob2JqLnR5cGUgPT09ICdCdWZmZXInICYmIGlzQXJyYXkob2JqLmRhdGEpKSB7CiAgICAgICAgcmV0dXJuIGZyb21BcnJheUxpa2UodGhhdCwgb2JqLmRhdGEpCiAgICAgIH0KICAgIH0KICAKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0ZpcnN0IGFyZ3VtZW50IG11c3QgYmUgYSBzdHJpbmcsIEJ1ZmZlciwgQXJyYXlCdWZmZXIsIEFycmF5LCBvciBhcnJheS1saWtlIG9iamVjdC4nKQogIH0KICAKICBmdW5jdGlvbiBjaGVja2VkIChsZW5ndGgpIHsKICAgIC8vIE5vdGU6IGNhbm5vdCB1c2UgYGxlbmd0aCA8IGtNYXhMZW5ndGgoKWAgaGVyZSBiZWNhdXNlIHRoYXQgZmFpbHMgd2hlbgogICAgLy8gbGVuZ3RoIGlzIE5hTiAod2hpY2ggaXMgb3RoZXJ3aXNlIGNvZXJjZWQgdG8gemVyby4pCiAgICBpZiAobGVuZ3RoID49IGtNYXhMZW5ndGgoKSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQXR0ZW1wdCB0byBhbGxvY2F0ZSBCdWZmZXIgbGFyZ2VyIHRoYW4gbWF4aW11bSAnICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3NpemU6IDB4JyArIGtNYXhMZW5ndGgoKS50b1N0cmluZygxNikgKyAnIGJ5dGVzJykKICAgIH0KICAgIHJldHVybiBsZW5ndGggfCAwCiAgfQogIAogIGZ1bmN0aW9uIFNsb3dCdWZmZXIgKGxlbmd0aCkgewogICAgaWYgKCtsZW5ndGggIT0gbGVuZ3RoKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgZXFlcWVxCiAgICAgIGxlbmd0aCA9IDAKICAgIH0KICAgIHJldHVybiBCdWZmZXIuYWxsb2MoK2xlbmd0aCkKICB9CiAgCiAgQnVmZmVyLmlzQnVmZmVyID0gZnVuY3Rpb24gaXNCdWZmZXIgKGIpIHsKICAgIHJldHVybiAhIShiICE9IG51bGwgJiYgYi5faXNCdWZmZXIpCiAgfQogIAogIEJ1ZmZlci5jb21wYXJlID0gZnVuY3Rpb24gY29tcGFyZSAoYSwgYikgewogICAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYSkgfHwgIUJ1ZmZlci5pc0J1ZmZlcihiKSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdBcmd1bWVudHMgbXVzdCBiZSBCdWZmZXJzJykKICAgIH0KICAKICAgIGlmIChhID09PSBiKSByZXR1cm4gMAogIAogICAgdmFyIHggPSBhLmxlbmd0aAogICAgdmFyIHkgPSBiLmxlbmd0aAogIAogICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IE1hdGgubWluKHgsIHkpOyBpIDwgbGVuOyArK2kpIHsKICAgICAgaWYgKGFbaV0gIT09IGJbaV0pIHsKICAgICAgICB4ID0gYVtpXQogICAgICAgIHkgPSBiW2ldCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQogIAogICAgaWYgKHggPCB5KSByZXR1cm4gLTEKICAgIGlmICh5IDwgeCkgcmV0dXJuIDEKICAgIHJldHVybiAwCiAgfQogIAogIEJ1ZmZlci5pc0VuY29kaW5nID0gZnVuY3Rpb24gaXNFbmNvZGluZyAoZW5jb2RpbmcpIHsKICAgIHN3aXRjaCAoU3RyaW5nKGVuY29kaW5nKS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgIGNhc2UgJ2hleCc6CiAgICAgIGNhc2UgJ3V0ZjgnOgogICAgICBjYXNlICd1dGYtOCc6CiAgICAgIGNhc2UgJ2FzY2lpJzoKICAgICAgY2FzZSAnbGF0aW4xJzoKICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgY2FzZSAnYmFzZTY0JzoKICAgICAgY2FzZSAndWNzMic6CiAgICAgIGNhc2UgJ3Vjcy0yJzoKICAgICAgY2FzZSAndXRmMTZsZSc6CiAgICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0KICAKICBCdWZmZXIuY29uY2F0ID0gZnVuY3Rpb24gY29uY2F0IChsaXN0LCBsZW5ndGgpIHsKICAgIGlmICghaXNBcnJheShsaXN0KSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCcibGlzdCIgYXJndW1lbnQgbXVzdCBiZSBhbiBBcnJheSBvZiBCdWZmZXJzJykKICAgIH0KICAKICAgIGlmIChsaXN0Lmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gQnVmZmVyLmFsbG9jKDApCiAgICB9CiAgCiAgICB2YXIgaQogICAgaWYgKGxlbmd0aCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGxlbmd0aCA9IDAKICAgICAgZm9yIChpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyArK2kpIHsKICAgICAgICBsZW5ndGggKz0gbGlzdFtpXS5sZW5ndGgKICAgICAgfQogICAgfQogIAogICAgdmFyIGJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShsZW5ndGgpCiAgICB2YXIgcG9zID0gMAogICAgZm9yIChpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyArK2kpIHsKICAgICAgdmFyIGJ1ZiA9IGxpc3RbaV0KICAgICAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYnVmKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJsaXN0IiBhcmd1bWVudCBtdXN0IGJlIGFuIEFycmF5IG9mIEJ1ZmZlcnMnKQogICAgICB9CiAgICAgIGJ1Zi5jb3B5KGJ1ZmZlciwgcG9zKQogICAgICBwb3MgKz0gYnVmLmxlbmd0aAogICAgfQogICAgcmV0dXJuIGJ1ZmZlcgogIH0KICAKICBmdW5jdGlvbiBieXRlTGVuZ3RoIChzdHJpbmcsIGVuY29kaW5nKSB7CiAgICBpZiAoQnVmZmVyLmlzQnVmZmVyKHN0cmluZykpIHsKICAgICAgcmV0dXJuIHN0cmluZy5sZW5ndGgKICAgIH0KICAgIGlmICh0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBBcnJheUJ1ZmZlci5pc1ZpZXcgPT09ICdmdW5jdGlvbicgJiYKICAgICAgICAoQXJyYXlCdWZmZXIuaXNWaWV3KHN0cmluZykgfHwgc3RyaW5nIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpKSB7CiAgICAgIHJldHVybiBzdHJpbmcuYnl0ZUxlbmd0aAogICAgfQogICAgaWYgKHR5cGVvZiBzdHJpbmcgIT09ICdzdHJpbmcnKSB7CiAgICAgIHN0cmluZyA9ICcnICsgc3RyaW5nCiAgICB9CiAgCiAgICB2YXIgbGVuID0gc3RyaW5nLmxlbmd0aAogICAgaWYgKGxlbiA9PT0gMCkgcmV0dXJuIDAKICAKICAgIC8vIFVzZSBhIGZvciBsb29wIHRvIGF2b2lkIHJlY3Vyc2lvbgogICAgdmFyIGxvd2VyZWRDYXNlID0gZmFsc2UKICAgIGZvciAoOzspIHsKICAgICAgc3dpdGNoIChlbmNvZGluZykgewogICAgICAgIGNhc2UgJ2FzY2lpJzoKICAgICAgICBjYXNlICdsYXRpbjEnOgogICAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgICByZXR1cm4gbGVuCiAgICAgICAgY2FzZSAndXRmOCc6CiAgICAgICAgY2FzZSAndXRmLTgnOgogICAgICAgIGNhc2UgdW5kZWZpbmVkOgogICAgICAgICAgcmV0dXJuIHV0ZjhUb0J5dGVzKHN0cmluZykubGVuZ3RoCiAgICAgICAgY2FzZSAndWNzMic6CiAgICAgICAgY2FzZSAndWNzLTInOgogICAgICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgICAgIHJldHVybiBsZW4gKiAyCiAgICAgICAgY2FzZSAnaGV4JzoKICAgICAgICAgIHJldHVybiBsZW4gPj4+IDEKICAgICAgICBjYXNlICdiYXNlNjQnOgogICAgICAgICAgcmV0dXJuIGJhc2U2NFRvQnl0ZXMoc3RyaW5nKS5sZW5ndGgKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgaWYgKGxvd2VyZWRDYXNlKSByZXR1cm4gdXRmOFRvQnl0ZXMoc3RyaW5nKS5sZW5ndGggLy8gYXNzdW1lIHV0ZjgKICAgICAgICAgIGVuY29kaW5nID0gKCcnICsgZW5jb2RpbmcpLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIGxvd2VyZWRDYXNlID0gdHJ1ZQogICAgICB9CiAgICB9CiAgfQogIEJ1ZmZlci5ieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aAogIAogIGZ1bmN0aW9uIHNsb3dUb1N0cmluZyAoZW5jb2RpbmcsIHN0YXJ0LCBlbmQpIHsKICAgIHZhciBsb3dlcmVkQ2FzZSA9IGZhbHNlCiAgCiAgICAvLyBObyBuZWVkIHRvIHZlcmlmeSB0aGF0ICJ0aGlzLmxlbmd0aCA8PSBNQVhfVUlOVDMyIiBzaW5jZSBpdCdzIGEgcmVhZC1vbmx5CiAgICAvLyBwcm9wZXJ0eSBvZiBhIHR5cGVkIGFycmF5LgogIAogICAgLy8gVGhpcyBiZWhhdmVzIG5laXRoZXIgbGlrZSBTdHJpbmcgbm9yIFVpbnQ4QXJyYXkgaW4gdGhhdCB3ZSBzZXQgc3RhcnQvZW5kCiAgICAvLyB0byB0aGVpciB1cHBlci9sb3dlciBib3VuZHMgaWYgdGhlIHZhbHVlIHBhc3NlZCBpcyBvdXQgb2YgcmFuZ2UuCiAgICAvLyB1bmRlZmluZWQgaXMgaGFuZGxlZCBzcGVjaWFsbHkgYXMgcGVyIEVDTUEtMjYyIDZ0aCBFZGl0aW9uLAogICAgLy8gU2VjdGlvbiAxMy4zLjMuNyBSdW50aW1lIFNlbWFudGljczogS2V5ZWRCaW5kaW5nSW5pdGlhbGl6YXRpb24uCiAgICBpZiAoc3RhcnQgPT09IHVuZGVmaW5lZCB8fCBzdGFydCA8IDApIHsKICAgICAgc3RhcnQgPSAwCiAgICB9CiAgICAvLyBSZXR1cm4gZWFybHkgaWYgc3RhcnQgPiB0aGlzLmxlbmd0aC4gRG9uZSBoZXJlIHRvIHByZXZlbnQgcG90ZW50aWFsIHVpbnQzMgogICAgLy8gY29lcmNpb24gZmFpbCBiZWxvdy4KICAgIGlmIChzdGFydCA+IHRoaXMubGVuZ3RoKSB7CiAgICAgIHJldHVybiAnJwogICAgfQogIAogICAgaWYgKGVuZCA9PT0gdW5kZWZpbmVkIHx8IGVuZCA+IHRoaXMubGVuZ3RoKSB7CiAgICAgIGVuZCA9IHRoaXMubGVuZ3RoCiAgICB9CiAgCiAgICBpZiAoZW5kIDw9IDApIHsKICAgICAgcmV0dXJuICcnCiAgICB9CiAgCiAgICAvLyBGb3JjZSBjb2Vyc2lvbiB0byB1aW50MzIuIFRoaXMgd2lsbCBhbHNvIGNvZXJjZSBmYWxzZXkvTmFOIHZhbHVlcyB0byAwLgogICAgZW5kID4+Pj0gMAogICAgc3RhcnQgPj4+PSAwCiAgCiAgICBpZiAoZW5kIDw9IHN0YXJ0KSB7CiAgICAgIHJldHVybiAnJwogICAgfQogIAogICAgaWYgKCFlbmNvZGluZykgZW5jb2RpbmcgPSAndXRmOCcKICAKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIHN3aXRjaCAoZW5jb2RpbmcpIHsKICAgICAgICBjYXNlICdoZXgnOgogICAgICAgICAgcmV0dXJuIGhleFNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCiAgCiAgICAgICAgY2FzZSAndXRmOCc6CiAgICAgICAgY2FzZSAndXRmLTgnOgogICAgICAgICAgcmV0dXJuIHV0ZjhTbGljZSh0aGlzLCBzdGFydCwgZW5kKQogIAogICAgICAgIGNhc2UgJ2FzY2lpJzoKICAgICAgICAgIHJldHVybiBhc2NpaVNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCiAgCiAgICAgICAgY2FzZSAnbGF0aW4xJzoKICAgICAgICBjYXNlICdiaW5hcnknOgogICAgICAgICAgcmV0dXJuIGxhdGluMVNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCiAgCiAgICAgICAgY2FzZSAnYmFzZTY0JzoKICAgICAgICAgIHJldHVybiBiYXNlNjRTbGljZSh0aGlzLCBzdGFydCwgZW5kKQogIAogICAgICAgIGNhc2UgJ3VjczInOgogICAgICAgIGNhc2UgJ3Vjcy0yJzoKICAgICAgICBjYXNlICd1dGYxNmxlJzoKICAgICAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgICAgICByZXR1cm4gdXRmMTZsZVNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCiAgCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGlmIChsb3dlcmVkQ2FzZSkgdGhyb3cgbmV3IFR5cGVFcnJvcignVW5rbm93biBlbmNvZGluZzogJyArIGVuY29kaW5nKQogICAgICAgICAgZW5jb2RpbmcgPSAoZW5jb2RpbmcgKyAnJykudG9Mb3dlckNhc2UoKQogICAgICAgICAgbG93ZXJlZENhc2UgPSB0cnVlCiAgICAgIH0KICAgIH0KICB9CiAgCiAgLy8gVGhlIHByb3BlcnR5IGlzIHVzZWQgYnkgYEJ1ZmZlci5pc0J1ZmZlcmAgYW5kIGBpcy1idWZmZXJgIChpbiBTYWZhcmkgNS03KSB0byBkZXRlY3QKICAvLyBCdWZmZXIgaW5zdGFuY2VzLgogIEJ1ZmZlci5wcm90b3R5cGUuX2lzQnVmZmVyID0gdHJ1ZQogIAogIGZ1bmN0aW9uIHN3YXAgKGIsIG4sIG0pIHsKICAgIHZhciBpID0gYltuXQogICAgYltuXSA9IGJbbV0KICAgIGJbbV0gPSBpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuc3dhcDE2ID0gZnVuY3Rpb24gc3dhcDE2ICgpIHsKICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aAogICAgaWYgKGxlbiAlIDIgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0J1ZmZlciBzaXplIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAxNi1iaXRzJykKICAgIH0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpICs9IDIpIHsKICAgICAgc3dhcCh0aGlzLCBpLCBpICsgMSkKICAgIH0KICAgIHJldHVybiB0aGlzCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuc3dhcDMyID0gZnVuY3Rpb24gc3dhcDMyICgpIHsKICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aAogICAgaWYgKGxlbiAlIDQgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0J1ZmZlciBzaXplIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAzMi1iaXRzJykKICAgIH0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpICs9IDQpIHsKICAgICAgc3dhcCh0aGlzLCBpLCBpICsgMykKICAgICAgc3dhcCh0aGlzLCBpICsgMSwgaSArIDIpCiAgICB9CiAgICByZXR1cm4gdGhpcwogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnN3YXA2NCA9IGZ1bmN0aW9uIHN3YXA2NCAoKSB7CiAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGgKICAgIGlmIChsZW4gJSA4ICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdCdWZmZXIgc2l6ZSBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgNjQtYml0cycpCiAgICB9CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSArPSA4KSB7CiAgICAgIHN3YXAodGhpcywgaSwgaSArIDcpCiAgICAgIHN3YXAodGhpcywgaSArIDEsIGkgKyA2KQogICAgICBzd2FwKHRoaXMsIGkgKyAyLCBpICsgNSkKICAgICAgc3dhcCh0aGlzLCBpICsgMywgaSArIDQpCiAgICB9CiAgICByZXR1cm4gdGhpcwogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gdG9TdHJpbmcgKCkgewogICAgdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoIHwgMAogICAgaWYgKGxlbmd0aCA9PT0gMCkgcmV0dXJuICcnCiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHV0ZjhTbGljZSh0aGlzLCAwLCBsZW5ndGgpCiAgICByZXR1cm4gc2xvd1RvU3RyaW5nLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbiBlcXVhbHMgKGIpIHsKICAgIGlmICghQnVmZmVyLmlzQnVmZmVyKGIpKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdBcmd1bWVudCBtdXN0IGJlIGEgQnVmZmVyJykKICAgIGlmICh0aGlzID09PSBiKSByZXR1cm4gdHJ1ZQogICAgcmV0dXJuIEJ1ZmZlci5jb21wYXJlKHRoaXMsIGIpID09PSAwCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuaW5zcGVjdCA9IGZ1bmN0aW9uIGluc3BlY3QgKCkgewogICAgdmFyIHN0ciA9ICcnCiAgICB2YXIgbWF4ID0gZXhwb3J0cy5JTlNQRUNUX01BWF9CWVRFUwogICAgaWYgKHRoaXMubGVuZ3RoID4gMCkgewogICAgICBzdHIgPSB0aGlzLnRvU3RyaW5nKCdoZXgnLCAwLCBtYXgpLm1hdGNoKC8uezJ9L2cpLmpvaW4oJyAnKQogICAgICBpZiAodGhpcy5sZW5ndGggPiBtYXgpIHN0ciArPSAnIC4uLiAnCiAgICB9CiAgICByZXR1cm4gJzxCdWZmZXIgJyArIHN0ciArICc+JwogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLmNvbXBhcmUgPSBmdW5jdGlvbiBjb21wYXJlICh0YXJnZXQsIHN0YXJ0LCBlbmQsIHRoaXNTdGFydCwgdGhpc0VuZCkgewogICAgaWYgKCFCdWZmZXIuaXNCdWZmZXIodGFyZ2V0KSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdBcmd1bWVudCBtdXN0IGJlIGEgQnVmZmVyJykKICAgIH0KICAKICAgIGlmIChzdGFydCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHN0YXJ0ID0gMAogICAgfQogICAgaWYgKGVuZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGVuZCA9IHRhcmdldCA/IHRhcmdldC5sZW5ndGggOiAwCiAgICB9CiAgICBpZiAodGhpc1N0YXJ0ID09PSB1bmRlZmluZWQpIHsKICAgICAgdGhpc1N0YXJ0ID0gMAogICAgfQogICAgaWYgKHRoaXNFbmQgPT09IHVuZGVmaW5lZCkgewogICAgICB0aGlzRW5kID0gdGhpcy5sZW5ndGgKICAgIH0KICAKICAgIGlmIChzdGFydCA8IDAgfHwgZW5kID4gdGFyZ2V0Lmxlbmd0aCB8fCB0aGlzU3RhcnQgPCAwIHx8IHRoaXNFbmQgPiB0aGlzLmxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignb3V0IG9mIHJhbmdlIGluZGV4JykKICAgIH0KICAKICAgIGlmICh0aGlzU3RhcnQgPj0gdGhpc0VuZCAmJiBzdGFydCA+PSBlbmQpIHsKICAgICAgcmV0dXJuIDAKICAgIH0KICAgIGlmICh0aGlzU3RhcnQgPj0gdGhpc0VuZCkgewogICAgICByZXR1cm4gLTEKICAgIH0KICAgIGlmIChzdGFydCA+PSBlbmQpIHsKICAgICAgcmV0dXJuIDEKICAgIH0KICAKICAgIHN0YXJ0ID4+Pj0gMAogICAgZW5kID4+Pj0gMAogICAgdGhpc1N0YXJ0ID4+Pj0gMAogICAgdGhpc0VuZCA+Pj49IDAKICAKICAgIGlmICh0aGlzID09PSB0YXJnZXQpIHJldHVybiAwCiAgCiAgICB2YXIgeCA9IHRoaXNFbmQgLSB0aGlzU3RhcnQKICAgIHZhciB5ID0gZW5kIC0gc3RhcnQKICAgIHZhciBsZW4gPSBNYXRoLm1pbih4LCB5KQogIAogICAgdmFyIHRoaXNDb3B5ID0gdGhpcy5zbGljZSh0aGlzU3RhcnQsIHRoaXNFbmQpCiAgICB2YXIgdGFyZ2V0Q29weSA9IHRhcmdldC5zbGljZShzdGFydCwgZW5kKQogIAogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICBpZiAodGhpc0NvcHlbaV0gIT09IHRhcmdldENvcHlbaV0pIHsKICAgICAgICB4ID0gdGhpc0NvcHlbaV0KICAgICAgICB5ID0gdGFyZ2V0Q29weVtpXQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KICAKICAgIGlmICh4IDwgeSkgcmV0dXJuIC0xCiAgICBpZiAoeSA8IHgpIHJldHVybiAxCiAgICByZXR1cm4gMAogIH0KICAKICAvLyBGaW5kcyBlaXRoZXIgdGhlIGZpcnN0IGluZGV4IG9mIGB2YWxgIGluIGBidWZmZXJgIGF0IG9mZnNldCA+PSBgYnl0ZU9mZnNldGAsCiAgLy8gT1IgdGhlIGxhc3QgaW5kZXggb2YgYHZhbGAgaW4gYGJ1ZmZlcmAgYXQgb2Zmc2V0IDw9IGBieXRlT2Zmc2V0YC4KICAvLwogIC8vIEFyZ3VtZW50czoKICAvLyAtIGJ1ZmZlciAtIGEgQnVmZmVyIHRvIHNlYXJjaAogIC8vIC0gdmFsIC0gYSBzdHJpbmcsIEJ1ZmZlciwgb3IgbnVtYmVyCiAgLy8gLSBieXRlT2Zmc2V0IC0gYW4gaW5kZXggaW50byBgYnVmZmVyYDsgd2lsbCBiZSBjbGFtcGVkIHRvIGFuIGludDMyCiAgLy8gLSBlbmNvZGluZyAtIGFuIG9wdGlvbmFsIGVuY29kaW5nLCByZWxldmFudCBpcyB2YWwgaXMgYSBzdHJpbmcKICAvLyAtIGRpciAtIHRydWUgZm9yIGluZGV4T2YsIGZhbHNlIGZvciBsYXN0SW5kZXhPZgogIGZ1bmN0aW9uIGJpZGlyZWN0aW9uYWxJbmRleE9mIChidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGRpcikgewogICAgLy8gRW1wdHkgYnVmZmVyIG1lYW5zIG5vIG1hdGNoCiAgICBpZiAoYnVmZmVyLmxlbmd0aCA9PT0gMCkgcmV0dXJuIC0xCiAgCiAgICAvLyBOb3JtYWxpemUgYnl0ZU9mZnNldAogICAgaWYgKHR5cGVvZiBieXRlT2Zmc2V0ID09PSAnc3RyaW5nJykgewogICAgICBlbmNvZGluZyA9IGJ5dGVPZmZzZXQKICAgICAgYnl0ZU9mZnNldCA9IDAKICAgIH0gZWxzZSBpZiAoYnl0ZU9mZnNldCA+IDB4N2ZmZmZmZmYpIHsKICAgICAgYnl0ZU9mZnNldCA9IDB4N2ZmZmZmZmYKICAgIH0gZWxzZSBpZiAoYnl0ZU9mZnNldCA8IC0weDgwMDAwMDAwKSB7CiAgICAgIGJ5dGVPZmZzZXQgPSAtMHg4MDAwMDAwMAogICAgfQogICAgYnl0ZU9mZnNldCA9ICtieXRlT2Zmc2V0ICAvLyBDb2VyY2UgdG8gTnVtYmVyLgogICAgaWYgKGlzTmFOKGJ5dGVPZmZzZXQpKSB7CiAgICAgIC8vIGJ5dGVPZmZzZXQ6IGl0IGl0J3MgdW5kZWZpbmVkLCBudWxsLCBOYU4sICJmb28iLCBldGMsIHNlYXJjaCB3aG9sZSBidWZmZXIKICAgICAgYnl0ZU9mZnNldCA9IGRpciA/IDAgOiAoYnVmZmVyLmxlbmd0aCAtIDEpCiAgICB9CiAgCiAgICAvLyBOb3JtYWxpemUgYnl0ZU9mZnNldDogbmVnYXRpdmUgb2Zmc2V0cyBzdGFydCBmcm9tIHRoZSBlbmQgb2YgdGhlIGJ1ZmZlcgogICAgaWYgKGJ5dGVPZmZzZXQgPCAwKSBieXRlT2Zmc2V0ID0gYnVmZmVyLmxlbmd0aCArIGJ5dGVPZmZzZXQKICAgIGlmIChieXRlT2Zmc2V0ID49IGJ1ZmZlci5sZW5ndGgpIHsKICAgICAgaWYgKGRpcikgcmV0dXJuIC0xCiAgICAgIGVsc2UgYnl0ZU9mZnNldCA9IGJ1ZmZlci5sZW5ndGggLSAxCiAgICB9IGVsc2UgaWYgKGJ5dGVPZmZzZXQgPCAwKSB7CiAgICAgIGlmIChkaXIpIGJ5dGVPZmZzZXQgPSAwCiAgICAgIGVsc2UgcmV0dXJuIC0xCiAgICB9CiAgCiAgICAvLyBOb3JtYWxpemUgdmFsCiAgICBpZiAodHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHsKICAgICAgdmFsID0gQnVmZmVyLmZyb20odmFsLCBlbmNvZGluZykKICAgIH0KICAKICAgIC8vIEZpbmFsbHksIHNlYXJjaCBlaXRoZXIgaW5kZXhPZiAoaWYgZGlyIGlzIHRydWUpIG9yIGxhc3RJbmRleE9mCiAgICBpZiAoQnVmZmVyLmlzQnVmZmVyKHZhbCkpIHsKICAgICAgLy8gU3BlY2lhbCBjYXNlOiBsb29raW5nIGZvciBlbXB0eSBzdHJpbmcvYnVmZmVyIGFsd2F5cyBmYWlscwogICAgICBpZiAodmFsLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiAtMQogICAgICB9CiAgICAgIHJldHVybiBhcnJheUluZGV4T2YoYnVmZmVyLCB2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCBkaXIpCiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICdudW1iZXInKSB7CiAgICAgIHZhbCA9IHZhbCAmIDB4RkYgLy8gU2VhcmNoIGZvciBhIGJ5dGUgdmFsdWUgWzAtMjU1XQogICAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQgJiYKICAgICAgICAgIHR5cGVvZiBVaW50OEFycmF5LnByb3RvdHlwZS5pbmRleE9mID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgaWYgKGRpcikgewogICAgICAgICAgcmV0dXJuIFVpbnQ4QXJyYXkucHJvdG90eXBlLmluZGV4T2YuY2FsbChidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIFVpbnQ4QXJyYXkucHJvdG90eXBlLmxhc3RJbmRleE9mLmNhbGwoYnVmZmVyLCB2YWwsIGJ5dGVPZmZzZXQpCiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBhcnJheUluZGV4T2YoYnVmZmVyLCBbIHZhbCBdLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZGlyKQogICAgfQogIAogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigndmFsIG11c3QgYmUgc3RyaW5nLCBudW1iZXIgb3IgQnVmZmVyJykKICB9CiAgCiAgZnVuY3Rpb24gYXJyYXlJbmRleE9mIChhcnIsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGRpcikgewogICAgdmFyIGluZGV4U2l6ZSA9IDEKICAgIHZhciBhcnJMZW5ndGggPSBhcnIubGVuZ3RoCiAgICB2YXIgdmFsTGVuZ3RoID0gdmFsLmxlbmd0aAogIAogICAgaWYgKGVuY29kaW5nICE9PSB1bmRlZmluZWQpIHsKICAgICAgZW5jb2RpbmcgPSBTdHJpbmcoZW5jb2RpbmcpLnRvTG93ZXJDYXNlKCkKICAgICAgaWYgKGVuY29kaW5nID09PSAndWNzMicgfHwgZW5jb2RpbmcgPT09ICd1Y3MtMicgfHwKICAgICAgICAgIGVuY29kaW5nID09PSAndXRmMTZsZScgfHwgZW5jb2RpbmcgPT09ICd1dGYtMTZsZScpIHsKICAgICAgICBpZiAoYXJyLmxlbmd0aCA8IDIgfHwgdmFsLmxlbmd0aCA8IDIpIHsKICAgICAgICAgIHJldHVybiAtMQogICAgICAgIH0KICAgICAgICBpbmRleFNpemUgPSAyCiAgICAgICAgYXJyTGVuZ3RoIC89IDIKICAgICAgICB2YWxMZW5ndGggLz0gMgogICAgICAgIGJ5dGVPZmZzZXQgLz0gMgogICAgICB9CiAgICB9CiAgCiAgICBmdW5jdGlvbiByZWFkIChidWYsIGkpIHsKICAgICAgaWYgKGluZGV4U2l6ZSA9PT0gMSkgewogICAgICAgIHJldHVybiBidWZbaV0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gYnVmLnJlYWRVSW50MTZCRShpICogaW5kZXhTaXplKQogICAgICB9CiAgICB9CiAgCiAgICB2YXIgaQogICAgaWYgKGRpcikgewogICAgICB2YXIgZm91bmRJbmRleCA9IC0xCiAgICAgIGZvciAoaSA9IGJ5dGVPZmZzZXQ7IGkgPCBhcnJMZW5ndGg7IGkrKykgewogICAgICAgIGlmIChyZWFkKGFyciwgaSkgPT09IHJlYWQodmFsLCBmb3VuZEluZGV4ID09PSAtMSA/IDAgOiBpIC0gZm91bmRJbmRleCkpIHsKICAgICAgICAgIGlmIChmb3VuZEluZGV4ID09PSAtMSkgZm91bmRJbmRleCA9IGkKICAgICAgICAgIGlmIChpIC0gZm91bmRJbmRleCArIDEgPT09IHZhbExlbmd0aCkgcmV0dXJuIGZvdW5kSW5kZXggKiBpbmRleFNpemUKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGZvdW5kSW5kZXggIT09IC0xKSBpIC09IGkgLSBmb3VuZEluZGV4CiAgICAgICAgICBmb3VuZEluZGV4ID0gLTEKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChieXRlT2Zmc2V0ICsgdmFsTGVuZ3RoID4gYXJyTGVuZ3RoKSBieXRlT2Zmc2V0ID0gYXJyTGVuZ3RoIC0gdmFsTGVuZ3RoCiAgICAgIGZvciAoaSA9IGJ5dGVPZmZzZXQ7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgdmFyIGZvdW5kID0gdHJ1ZQogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdmFsTGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGlmIChyZWFkKGFyciwgaSArIGopICE9PSByZWFkKHZhbCwgaikpIHsKICAgICAgICAgICAgZm91bmQgPSBmYWxzZQogICAgICAgICAgICBicmVhawogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZm91bmQpIHJldHVybiBpCiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiAtMQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLmluY2x1ZGVzID0gZnVuY3Rpb24gaW5jbHVkZXMgKHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpIHsKICAgIHJldHVybiB0aGlzLmluZGV4T2YodmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgIT09IC0xCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuaW5kZXhPZiA9IGZ1bmN0aW9uIGluZGV4T2YgKHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpIHsKICAgIHJldHVybiBiaWRpcmVjdGlvbmFsSW5kZXhPZih0aGlzLCB2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCB0cnVlKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLmxhc3RJbmRleE9mID0gZnVuY3Rpb24gbGFzdEluZGV4T2YgKHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpIHsKICAgIHJldHVybiBiaWRpcmVjdGlvbmFsSW5kZXhPZih0aGlzLCB2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCBmYWxzZSkKICB9CiAgCiAgZnVuY3Rpb24gaGV4V3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogICAgb2Zmc2V0ID0gTnVtYmVyKG9mZnNldCkgfHwgMAogICAgdmFyIHJlbWFpbmluZyA9IGJ1Zi5sZW5ndGggLSBvZmZzZXQKICAgIGlmICghbGVuZ3RoKSB7CiAgICAgIGxlbmd0aCA9IHJlbWFpbmluZwogICAgfSBlbHNlIHsKICAgICAgbGVuZ3RoID0gTnVtYmVyKGxlbmd0aCkKICAgICAgaWYgKGxlbmd0aCA+IHJlbWFpbmluZykgewogICAgICAgIGxlbmd0aCA9IHJlbWFpbmluZwogICAgICB9CiAgICB9CiAgCiAgICAvLyBtdXN0IGJlIGFuIGV2ZW4gbnVtYmVyIG9mIGRpZ2l0cwogICAgdmFyIHN0ckxlbiA9IHN0cmluZy5sZW5ndGgKICAgIGlmIChzdHJMZW4gJSAyICE9PSAwKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdJbnZhbGlkIGhleCBzdHJpbmcnKQogIAogICAgaWYgKGxlbmd0aCA+IHN0ckxlbiAvIDIpIHsKICAgICAgbGVuZ3RoID0gc3RyTGVuIC8gMgogICAgfQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICB2YXIgcGFyc2VkID0gcGFyc2VJbnQoc3RyaW5nLnN1YnN0cihpICogMiwgMiksIDE2KQogICAgICBpZiAoaXNOYU4ocGFyc2VkKSkgcmV0dXJuIGkKICAgICAgYnVmW29mZnNldCArIGldID0gcGFyc2VkCiAgICB9CiAgICByZXR1cm4gaQogIH0KICAKICBmdW5jdGlvbiB1dGY4V3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogICAgcmV0dXJuIGJsaXRCdWZmZXIodXRmOFRvQnl0ZXMoc3RyaW5nLCBidWYubGVuZ3RoIC0gb2Zmc2V0KSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKICB9CiAgCiAgZnVuY3Rpb24gYXNjaWlXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gYmxpdEJ1ZmZlcihhc2NpaVRvQnl0ZXMoc3RyaW5nKSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKICB9CiAgCiAgZnVuY3Rpb24gbGF0aW4xV3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogICAgcmV0dXJuIGFzY2lpV3JpdGUoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogIH0KICAKICBmdW5jdGlvbiBiYXNlNjRXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gYmxpdEJ1ZmZlcihiYXNlNjRUb0J5dGVzKHN0cmluZyksIGJ1Ziwgb2Zmc2V0LCBsZW5ndGgpCiAgfQogIAogIGZ1bmN0aW9uIHVjczJXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gYmxpdEJ1ZmZlcih1dGYxNmxlVG9CeXRlcyhzdHJpbmcsIGJ1Zi5sZW5ndGggLSBvZmZzZXQpLCBidWYsIG9mZnNldCwgbGVuZ3RoKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlID0gZnVuY3Rpb24gd3JpdGUgKHN0cmluZywgb2Zmc2V0LCBsZW5ndGgsIGVuY29kaW5nKSB7CiAgICAvLyBCdWZmZXIjd3JpdGUoc3RyaW5nKQogICAgaWYgKG9mZnNldCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGVuY29kaW5nID0gJ3V0ZjgnCiAgICAgIGxlbmd0aCA9IHRoaXMubGVuZ3RoCiAgICAgIG9mZnNldCA9IDAKICAgIC8vIEJ1ZmZlciN3cml0ZShzdHJpbmcsIGVuY29kaW5nKQogICAgfSBlbHNlIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCAmJiB0eXBlb2Ygb2Zmc2V0ID09PSAnc3RyaW5nJykgewogICAgICBlbmNvZGluZyA9IG9mZnNldAogICAgICBsZW5ndGggPSB0aGlzLmxlbmd0aAogICAgICBvZmZzZXQgPSAwCiAgICAvLyBCdWZmZXIjd3JpdGUoc3RyaW5nLCBvZmZzZXRbLCBsZW5ndGhdWywgZW5jb2RpbmddKQogICAgfSBlbHNlIGlmIChpc0Zpbml0ZShvZmZzZXQpKSB7CiAgICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgICAgaWYgKGlzRmluaXRlKGxlbmd0aCkpIHsKICAgICAgICBsZW5ndGggPSBsZW5ndGggfCAwCiAgICAgICAgaWYgKGVuY29kaW5nID09PSB1bmRlZmluZWQpIGVuY29kaW5nID0gJ3V0ZjgnCiAgICAgIH0gZWxzZSB7CiAgICAgICAgZW5jb2RpbmcgPSBsZW5ndGgKICAgICAgICBsZW5ndGggPSB1bmRlZmluZWQKICAgICAgfQogICAgLy8gbGVnYWN5IHdyaXRlKHN0cmluZywgZW5jb2RpbmcsIG9mZnNldCwgbGVuZ3RoKSAtIHJlbW92ZSBpbiB2MC4xMwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICdCdWZmZXIud3JpdGUoc3RyaW5nLCBlbmNvZGluZywgb2Zmc2V0WywgbGVuZ3RoXSkgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCcKICAgICAgKQogICAgfQogIAogICAgdmFyIHJlbWFpbmluZyA9IHRoaXMubGVuZ3RoIC0gb2Zmc2V0CiAgICBpZiAobGVuZ3RoID09PSB1bmRlZmluZWQgfHwgbGVuZ3RoID4gcmVtYWluaW5nKSBsZW5ndGggPSByZW1haW5pbmcKICAKICAgIGlmICgoc3RyaW5nLmxlbmd0aCA+IDAgJiYgKGxlbmd0aCA8IDAgfHwgb2Zmc2V0IDwgMCkpIHx8IG9mZnNldCA+IHRoaXMubGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdBdHRlbXB0IHRvIHdyaXRlIG91dHNpZGUgYnVmZmVyIGJvdW5kcycpCiAgICB9CiAgCiAgICBpZiAoIWVuY29kaW5nKSBlbmNvZGluZyA9ICd1dGY4JwogIAogICAgdmFyIGxvd2VyZWRDYXNlID0gZmFsc2UKICAgIGZvciAoOzspIHsKICAgICAgc3dpdGNoIChlbmNvZGluZykgewogICAgICAgIGNhc2UgJ2hleCc6CiAgICAgICAgICByZXR1cm4gaGV4V3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKICAKICAgICAgICBjYXNlICd1dGY4JzoKICAgICAgICBjYXNlICd1dGYtOCc6CiAgICAgICAgICByZXR1cm4gdXRmOFdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgCiAgICAgICAgY2FzZSAnYXNjaWknOgogICAgICAgICAgcmV0dXJuIGFzY2lpV3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKICAKICAgICAgICBjYXNlICdsYXRpbjEnOgogICAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgICByZXR1cm4gbGF0aW4xV3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKICAKICAgICAgICBjYXNlICdiYXNlNjQnOgogICAgICAgICAgLy8gV2FybmluZzogbWF4TGVuZ3RoIG5vdCB0YWtlbiBpbnRvIGFjY291bnQgaW4gYmFzZTY0V3JpdGUKICAgICAgICAgIHJldHVybiBiYXNlNjRXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogIAogICAgICAgIGNhc2UgJ3VjczInOgogICAgICAgIGNhc2UgJ3Vjcy0yJzoKICAgICAgICBjYXNlICd1dGYxNmxlJzoKICAgICAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgICAgICByZXR1cm4gdWNzMldyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGlmIChsb3dlcmVkQ2FzZSkgdGhyb3cgbmV3IFR5cGVFcnJvcignVW5rbm93biBlbmNvZGluZzogJyArIGVuY29kaW5nKQogICAgICAgICAgZW5jb2RpbmcgPSAoJycgKyBlbmNvZGluZykudG9Mb3dlckNhc2UoKQogICAgICAgICAgbG93ZXJlZENhc2UgPSB0cnVlCiAgICAgIH0KICAgIH0KICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiB0b0pTT04gKCkgewogICAgcmV0dXJuIHsKICAgICAgdHlwZTogJ0J1ZmZlcicsCiAgICAgIGRhdGE6IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKHRoaXMuX2FyciB8fCB0aGlzLCAwKQogICAgfQogIH0KICAKICBmdW5jdGlvbiBiYXNlNjRTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgICBpZiAoc3RhcnQgPT09IDAgJiYgZW5kID09PSBidWYubGVuZ3RoKSB7CiAgICAgIHJldHVybiBiYXNlNjQuZnJvbUJ5dGVBcnJheShidWYpCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gYmFzZTY0LmZyb21CeXRlQXJyYXkoYnVmLnNsaWNlKHN0YXJ0LCBlbmQpKQogICAgfQogIH0KICAKICBmdW5jdGlvbiB1dGY4U2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogICAgZW5kID0gTWF0aC5taW4oYnVmLmxlbmd0aCwgZW5kKQogICAgdmFyIHJlcyA9IFtdCiAgCiAgICB2YXIgaSA9IHN0YXJ0CiAgICB3aGlsZSAoaSA8IGVuZCkgewogICAgICB2YXIgZmlyc3RCeXRlID0gYnVmW2ldCiAgICAgIHZhciBjb2RlUG9pbnQgPSBudWxsCiAgICAgIHZhciBieXRlc1BlclNlcXVlbmNlID0gKGZpcnN0Qnl0ZSA+IDB4RUYpID8gNAogICAgICAgIDogKGZpcnN0Qnl0ZSA+IDB4REYpID8gMwogICAgICAgIDogKGZpcnN0Qnl0ZSA+IDB4QkYpID8gMgogICAgICAgIDogMQogIAogICAgICBpZiAoaSArIGJ5dGVzUGVyU2VxdWVuY2UgPD0gZW5kKSB7CiAgICAgICAgdmFyIHNlY29uZEJ5dGUsIHRoaXJkQnl0ZSwgZm91cnRoQnl0ZSwgdGVtcENvZGVQb2ludAogIAogICAgICAgIHN3aXRjaCAoYnl0ZXNQZXJTZXF1ZW5jZSkgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBpZiAoZmlyc3RCeXRlIDwgMHg4MCkgewogICAgICAgICAgICAgIGNvZGVQb2ludCA9IGZpcnN0Qnl0ZQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIHNlY29uZEJ5dGUgPSBidWZbaSArIDFdCiAgICAgICAgICAgIGlmICgoc2Vjb25kQnl0ZSAmIDB4QzApID09PSAweDgwKSB7CiAgICAgICAgICAgICAgdGVtcENvZGVQb2ludCA9IChmaXJzdEJ5dGUgJiAweDFGKSA8PCAweDYgfCAoc2Vjb25kQnl0ZSAmIDB4M0YpCiAgICAgICAgICAgICAgaWYgKHRlbXBDb2RlUG9pbnQgPiAweDdGKSB7CiAgICAgICAgICAgICAgICBjb2RlUG9pbnQgPSB0ZW1wQ29kZVBvaW50CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgIHNlY29uZEJ5dGUgPSBidWZbaSArIDFdCiAgICAgICAgICAgIHRoaXJkQnl0ZSA9IGJ1ZltpICsgMl0KICAgICAgICAgICAgaWYgKChzZWNvbmRCeXRlICYgMHhDMCkgPT09IDB4ODAgJiYgKHRoaXJkQnl0ZSAmIDB4QzApID09PSAweDgwKSB7CiAgICAgICAgICAgICAgdGVtcENvZGVQb2ludCA9IChmaXJzdEJ5dGUgJiAweEYpIDw8IDB4QyB8IChzZWNvbmRCeXRlICYgMHgzRikgPDwgMHg2IHwgKHRoaXJkQnl0ZSAmIDB4M0YpCiAgICAgICAgICAgICAgaWYgKHRlbXBDb2RlUG9pbnQgPiAweDdGRiAmJiAodGVtcENvZGVQb2ludCA8IDB4RDgwMCB8fCB0ZW1wQ29kZVBvaW50ID4gMHhERkZGKSkgewogICAgICAgICAgICAgICAgY29kZVBvaW50ID0gdGVtcENvZGVQb2ludAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICBzZWNvbmRCeXRlID0gYnVmW2kgKyAxXQogICAgICAgICAgICB0aGlyZEJ5dGUgPSBidWZbaSArIDJdCiAgICAgICAgICAgIGZvdXJ0aEJ5dGUgPSBidWZbaSArIDNdCiAgICAgICAgICAgIGlmICgoc2Vjb25kQnl0ZSAmIDB4QzApID09PSAweDgwICYmICh0aGlyZEJ5dGUgJiAweEMwKSA9PT0gMHg4MCAmJiAoZm91cnRoQnl0ZSAmIDB4QzApID09PSAweDgwKSB7CiAgICAgICAgICAgICAgdGVtcENvZGVQb2ludCA9IChmaXJzdEJ5dGUgJiAweEYpIDw8IDB4MTIgfCAoc2Vjb25kQnl0ZSAmIDB4M0YpIDw8IDB4QyB8ICh0aGlyZEJ5dGUgJiAweDNGKSA8PCAweDYgfCAoZm91cnRoQnl0ZSAmIDB4M0YpCiAgICAgICAgICAgICAgaWYgKHRlbXBDb2RlUG9pbnQgPiAweEZGRkYgJiYgdGVtcENvZGVQb2ludCA8IDB4MTEwMDAwKSB7CiAgICAgICAgICAgICAgICBjb2RlUG9pbnQgPSB0ZW1wQ29kZVBvaW50CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIGlmIChjb2RlUG9pbnQgPT09IG51bGwpIHsKICAgICAgICAvLyB3ZSBkaWQgbm90IGdlbmVyYXRlIGEgdmFsaWQgY29kZVBvaW50IHNvIGluc2VydCBhCiAgICAgICAgLy8gcmVwbGFjZW1lbnQgY2hhciAoVStGRkZEKSBhbmQgYWR2YW5jZSBvbmx5IDEgYnl0ZQogICAgICAgIGNvZGVQb2ludCA9IDB4RkZGRAogICAgICAgIGJ5dGVzUGVyU2VxdWVuY2UgPSAxCiAgICAgIH0gZWxzZSBpZiAoY29kZVBvaW50ID4gMHhGRkZGKSB7CiAgICAgICAgLy8gZW5jb2RlIHRvIHV0ZjE2IChzdXJyb2dhdGUgcGFpciBkYW5jZSkKICAgICAgICBjb2RlUG9pbnQgLT0gMHgxMDAwMAogICAgICAgIHJlcy5wdXNoKGNvZGVQb2ludCA+Pj4gMTAgJiAweDNGRiB8IDB4RDgwMCkKICAgICAgICBjb2RlUG9pbnQgPSAweERDMDAgfCBjb2RlUG9pbnQgJiAweDNGRgogICAgICB9CiAgCiAgICAgIHJlcy5wdXNoKGNvZGVQb2ludCkKICAgICAgaSArPSBieXRlc1BlclNlcXVlbmNlCiAgICB9CiAgCiAgICByZXR1cm4gZGVjb2RlQ29kZVBvaW50c0FycmF5KHJlcykKICB9CiAgCiAgLy8gQmFzZWQgb24gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMjI3NDcyNzIvNjgwNzQyLCB0aGUgYnJvd3NlciB3aXRoCiAgLy8gdGhlIGxvd2VzdCBsaW1pdCBpcyBDaHJvbWUsIHdpdGggMHgxMDAwMCBhcmdzLgogIC8vIFdlIGdvIDEgbWFnbml0dWRlIGxlc3MsIGZvciBzYWZldHkKICB2YXIgTUFYX0FSR1VNRU5UU19MRU5HVEggPSAweDEwMDAKICAKICBmdW5jdGlvbiBkZWNvZGVDb2RlUG9pbnRzQXJyYXkgKGNvZGVQb2ludHMpIHsKICAgIHZhciBsZW4gPSBjb2RlUG9pbnRzLmxlbmd0aAogICAgaWYgKGxlbiA8PSBNQVhfQVJHVU1FTlRTX0xFTkdUSCkgewogICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShTdHJpbmcsIGNvZGVQb2ludHMpIC8vIGF2b2lkIGV4dHJhIHNsaWNlKCkKICAgIH0KICAKICAgIC8vIERlY29kZSBpbiBjaHVua3MgdG8gYXZvaWQgImNhbGwgc3RhY2sgc2l6ZSBleGNlZWRlZCIuCiAgICB2YXIgcmVzID0gJycKICAgIHZhciBpID0gMAogICAgd2hpbGUgKGkgPCBsZW4pIHsKICAgICAgcmVzICs9IFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoCiAgICAgICAgU3RyaW5nLAogICAgICAgIGNvZGVQb2ludHMuc2xpY2UoaSwgaSArPSBNQVhfQVJHVU1FTlRTX0xFTkdUSCkKICAgICAgKQogICAgfQogICAgcmV0dXJuIHJlcwogIH0KICAKICBmdW5jdGlvbiBhc2NpaVNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICAgIHZhciByZXQgPSAnJwogICAgZW5kID0gTWF0aC5taW4oYnVmLmxlbmd0aCwgZW5kKQogIAogICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgZW5kOyArK2kpIHsKICAgICAgcmV0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnVmW2ldICYgMHg3RikKICAgIH0KICAgIHJldHVybiByZXQKICB9CiAgCiAgZnVuY3Rpb24gbGF0aW4xU2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogICAgdmFyIHJldCA9ICcnCiAgICBlbmQgPSBNYXRoLm1pbihidWYubGVuZ3RoLCBlbmQpCiAgCiAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7ICsraSkgewogICAgICByZXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShidWZbaV0pCiAgICB9CiAgICByZXR1cm4gcmV0CiAgfQogIAogIGZ1bmN0aW9uIGhleFNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICAgIHZhciBsZW4gPSBidWYubGVuZ3RoCiAgCiAgICBpZiAoIXN0YXJ0IHx8IHN0YXJ0IDwgMCkgc3RhcnQgPSAwCiAgICBpZiAoIWVuZCB8fCBlbmQgPCAwIHx8IGVuZCA+IGxlbikgZW5kID0gbGVuCiAgCiAgICB2YXIgb3V0ID0gJycKICAgIGZvciAodmFyIGkgPSBzdGFydDsgaSA8IGVuZDsgKytpKSB7CiAgICAgIG91dCArPSB0b0hleChidWZbaV0pCiAgICB9CiAgICByZXR1cm4gb3V0CiAgfQogIAogIGZ1bmN0aW9uIHV0ZjE2bGVTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgICB2YXIgYnl0ZXMgPSBidWYuc2xpY2Uoc3RhcnQsIGVuZCkKICAgIHZhciByZXMgPSAnJwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBieXRlcy5sZW5ndGg7IGkgKz0gMikgewogICAgICByZXMgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShieXRlc1tpXSArIGJ5dGVzW2kgKyAxXSAqIDI1NikKICAgIH0KICAgIHJldHVybiByZXMKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5zbGljZSA9IGZ1bmN0aW9uIHNsaWNlIChzdGFydCwgZW5kKSB7CiAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGgKICAgIHN0YXJ0ID0gfn5zdGFydAogICAgZW5kID0gZW5kID09PSB1bmRlZmluZWQgPyBsZW4gOiB+fmVuZAogIAogICAgaWYgKHN0YXJ0IDwgMCkgewogICAgICBzdGFydCArPSBsZW4KICAgICAgaWYgKHN0YXJ0IDwgMCkgc3RhcnQgPSAwCiAgICB9IGVsc2UgaWYgKHN0YXJ0ID4gbGVuKSB7CiAgICAgIHN0YXJ0ID0gbGVuCiAgICB9CiAgCiAgICBpZiAoZW5kIDwgMCkgewogICAgICBlbmQgKz0gbGVuCiAgICAgIGlmIChlbmQgPCAwKSBlbmQgPSAwCiAgICB9IGVsc2UgaWYgKGVuZCA+IGxlbikgewogICAgICBlbmQgPSBsZW4KICAgIH0KICAKICAgIGlmIChlbmQgPCBzdGFydCkgZW5kID0gc3RhcnQKICAKICAgIHZhciBuZXdCdWYKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICBuZXdCdWYgPSB0aGlzLnN1YmFycmF5KHN0YXJ0LCBlbmQpCiAgICAgIG5ld0J1Zi5fX3Byb3RvX18gPSBCdWZmZXIucHJvdG90eXBlCiAgICB9IGVsc2UgewogICAgICB2YXIgc2xpY2VMZW4gPSBlbmQgLSBzdGFydAogICAgICBuZXdCdWYgPSBuZXcgQnVmZmVyKHNsaWNlTGVuLCB1bmRlZmluZWQpCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2xpY2VMZW47ICsraSkgewogICAgICAgIG5ld0J1ZltpXSA9IHRoaXNbaSArIHN0YXJ0XQogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gbmV3QnVmCiAgfQogIAogIC8qCiAgICogTmVlZCB0byBtYWtlIHN1cmUgdGhhdCBidWZmZXIgaXNuJ3QgdHJ5aW5nIHRvIHdyaXRlIG91dCBvZiBib3VuZHMuCiAgICovCiAgZnVuY3Rpb24gY2hlY2tPZmZzZXQgKG9mZnNldCwgZXh0LCBsZW5ndGgpIHsKICAgIGlmICgob2Zmc2V0ICUgMSkgIT09IDAgfHwgb2Zmc2V0IDwgMCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ29mZnNldCBpcyBub3QgdWludCcpCiAgICBpZiAob2Zmc2V0ICsgZXh0ID4gbGVuZ3RoKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignVHJ5aW5nIHRvIGFjY2VzcyBiZXlvbmQgYnVmZmVyIGxlbmd0aCcpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnRMRSA9IGZ1bmN0aW9uIHJlYWRVSW50TEUgKG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCBieXRlTGVuZ3RoLCB0aGlzLmxlbmd0aCkKICAKICAgIHZhciB2YWwgPSB0aGlzW29mZnNldF0KICAgIHZhciBtdWwgPSAxCiAgICB2YXIgaSA9IDAKICAgIHdoaWxlICgrK2kgPCBieXRlTGVuZ3RoICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICAgIHZhbCArPSB0aGlzW29mZnNldCArIGldICogbXVsCiAgICB9CiAgCiAgICByZXR1cm4gdmFsCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnRCRSA9IGZ1bmN0aW9uIHJlYWRVSW50QkUgKG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogICAgaWYgKCFub0Fzc2VydCkgewogICAgICBjaGVja09mZnNldChvZmZzZXQsIGJ5dGVMZW5ndGgsIHRoaXMubGVuZ3RoKQogICAgfQogIAogICAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0ICsgLS1ieXRlTGVuZ3RoXQogICAgdmFyIG11bCA9IDEKICAgIHdoaWxlIChieXRlTGVuZ3RoID4gMCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICB2YWwgKz0gdGhpc1tvZmZzZXQgKyAtLWJ5dGVMZW5ndGhdICogbXVsCiAgICB9CiAgCiAgICByZXR1cm4gdmFsCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQ4ID0gZnVuY3Rpb24gcmVhZFVJbnQ4IChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDEsIHRoaXMubGVuZ3RoKQogICAgcmV0dXJuIHRoaXNbb2Zmc2V0XQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50MTZMRSA9IGZ1bmN0aW9uIHJlYWRVSW50MTZMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCkKICAgIHJldHVybiB0aGlzW29mZnNldF0gfCAodGhpc1tvZmZzZXQgKyAxXSA8PCA4KQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50MTZCRSA9IGZ1bmN0aW9uIHJlYWRVSW50MTZCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCkKICAgIHJldHVybiAodGhpc1tvZmZzZXRdIDw8IDgpIHwgdGhpc1tvZmZzZXQgKyAxXQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50MzJMRSA9IGZ1bmN0aW9uIHJlYWRVSW50MzJMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICAKICAgIHJldHVybiAoKHRoaXNbb2Zmc2V0XSkgfAogICAgICAgICh0aGlzW29mZnNldCArIDFdIDw8IDgpIHwKICAgICAgICAodGhpc1tvZmZzZXQgKyAyXSA8PCAxNikpICsKICAgICAgICAodGhpc1tvZmZzZXQgKyAzXSAqIDB4MTAwMDAwMCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDMyQkUgPSBmdW5jdGlvbiByZWFkVUludDMyQkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCiAgCiAgICByZXR1cm4gKHRoaXNbb2Zmc2V0XSAqIDB4MTAwMDAwMCkgKwogICAgICAoKHRoaXNbb2Zmc2V0ICsgMV0gPDwgMTYpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMl0gPDwgOCkgfAogICAgICB0aGlzW29mZnNldCArIDNdKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRJbnRMRSA9IGZ1bmN0aW9uIHJlYWRJbnRMRSAob2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIGJ5dGVMZW5ndGgsIHRoaXMubGVuZ3RoKQogIAogICAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0XQogICAgdmFyIG11bCA9IDEKICAgIHZhciBpID0gMAogICAgd2hpbGUgKCsraSA8IGJ5dGVMZW5ndGggJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgdmFsICs9IHRoaXNbb2Zmc2V0ICsgaV0gKiBtdWwKICAgIH0KICAgIG11bCAqPSAweDgwCiAgCiAgICBpZiAodmFsID49IG11bCkgdmFsIC09IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoKQogIAogICAgcmV0dXJuIHZhbAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRJbnRCRSA9IGZ1bmN0aW9uIHJlYWRJbnRCRSAob2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIGJ5dGVMZW5ndGgsIHRoaXMubGVuZ3RoKQogIAogICAgdmFyIGkgPSBieXRlTGVuZ3RoCiAgICB2YXIgbXVsID0gMQogICAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0ICsgLS1pXQogICAgd2hpbGUgKGkgPiAwICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICAgIHZhbCArPSB0aGlzW29mZnNldCArIC0taV0gKiBtdWwKICAgIH0KICAgIG11bCAqPSAweDgwCiAgCiAgICBpZiAodmFsID49IG11bCkgdmFsIC09IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoKQogIAogICAgcmV0dXJuIHZhbAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQ4ID0gZnVuY3Rpb24gcmVhZEludDggKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMSwgdGhpcy5sZW5ndGgpCiAgICBpZiAoISh0aGlzW29mZnNldF0gJiAweDgwKSkgcmV0dXJuICh0aGlzW29mZnNldF0pCiAgICByZXR1cm4gKCgweGZmIC0gdGhpc1tvZmZzZXRdICsgMSkgKiAtMSkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50MTZMRSA9IGZ1bmN0aW9uIHJlYWRJbnQxNkxFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDIsIHRoaXMubGVuZ3RoKQogICAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0XSB8ICh0aGlzW29mZnNldCArIDFdIDw8IDgpCiAgICByZXR1cm4gKHZhbCAmIDB4ODAwMCkgPyB2YWwgfCAweEZGRkYwMDAwIDogdmFsCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludDE2QkUgPSBmdW5jdGlvbiByZWFkSW50MTZCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCkKICAgIHZhciB2YWwgPSB0aGlzW29mZnNldCArIDFdIHwgKHRoaXNbb2Zmc2V0XSA8PCA4KQogICAgcmV0dXJuICh2YWwgJiAweDgwMDApID8gdmFsIHwgMHhGRkZGMDAwMCA6IHZhbAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQzMkxFID0gZnVuY3Rpb24gcmVhZEludDMyTEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCiAgCiAgICByZXR1cm4gKHRoaXNbb2Zmc2V0XSkgfAogICAgICAodGhpc1tvZmZzZXQgKyAxXSA8PCA4KSB8CiAgICAgICh0aGlzW29mZnNldCArIDJdIDw8IDE2KSB8CiAgICAgICh0aGlzW29mZnNldCArIDNdIDw8IDI0KQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQzMkJFID0gZnVuY3Rpb24gcmVhZEludDMyQkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCiAgCiAgICByZXR1cm4gKHRoaXNbb2Zmc2V0XSA8PCAyNCkgfAogICAgICAodGhpc1tvZmZzZXQgKyAxXSA8PCAxNikgfAogICAgICAodGhpc1tvZmZzZXQgKyAyXSA8PCA4KSB8CiAgICAgICh0aGlzW29mZnNldCArIDNdKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRGbG9hdExFID0gZnVuY3Rpb24gcmVhZEZsb2F0TEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCiAgICByZXR1cm4gaWVlZTc1NC5yZWFkKHRoaXMsIG9mZnNldCwgdHJ1ZSwgMjMsIDQpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEZsb2F0QkUgPSBmdW5jdGlvbiByZWFkRmxvYXRCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICAgIHJldHVybiBpZWVlNzU0LnJlYWQodGhpcywgb2Zmc2V0LCBmYWxzZSwgMjMsIDQpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZERvdWJsZUxFID0gZnVuY3Rpb24gcmVhZERvdWJsZUxFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDgsIHRoaXMubGVuZ3RoKQogICAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIHRydWUsIDUyLCA4KQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWREb3VibGVCRSA9IGZ1bmN0aW9uIHJlYWREb3VibGVCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA4LCB0aGlzLmxlbmd0aCkKICAgIHJldHVybiBpZWVlNzU0LnJlYWQodGhpcywgb2Zmc2V0LCBmYWxzZSwgNTIsIDgpCiAgfQogIAogIGZ1bmN0aW9uIGNoZWNrSW50IChidWYsIHZhbHVlLCBvZmZzZXQsIGV4dCwgbWF4LCBtaW4pIHsKICAgIGlmICghQnVmZmVyLmlzQnVmZmVyKGJ1ZikpIHRocm93IG5ldyBUeXBlRXJyb3IoJyJidWZmZXIiIGFyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXIgaW5zdGFuY2UnKQogICAgaWYgKHZhbHVlID4gbWF4IHx8IHZhbHVlIDwgbWluKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignInZhbHVlIiBhcmd1bWVudCBpcyBvdXQgb2YgYm91bmRzJykKICAgIGlmIChvZmZzZXQgKyBleHQgPiBidWYubGVuZ3RoKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW5kZXggb3V0IG9mIHJhbmdlJykKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnRMRSA9IGZ1bmN0aW9uIHdyaXRlVUludExFICh2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogICAgaWYgKCFub0Fzc2VydCkgewogICAgICB2YXIgbWF4Qnl0ZXMgPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCkgLSAxCiAgICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG1heEJ5dGVzLCAwKQogICAgfQogIAogICAgdmFyIG11bCA9IDEKICAgIHZhciBpID0gMAogICAgdGhpc1tvZmZzZXRdID0gdmFsdWUgJiAweEZGCiAgICB3aGlsZSAoKytpIDwgYnl0ZUxlbmd0aCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICB0aGlzW29mZnNldCArIGldID0gKHZhbHVlIC8gbXVsKSAmIDB4RkYKICAgIH0KICAKICAgIHJldHVybiBvZmZzZXQgKyBieXRlTGVuZ3RoCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50QkUgPSBmdW5jdGlvbiB3cml0ZVVJbnRCRSAodmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIHsKICAgICAgdmFyIG1heEJ5dGVzID0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgpIC0gMQogICAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBtYXhCeXRlcywgMCkKICAgIH0KICAKICAgIHZhciBpID0gYnl0ZUxlbmd0aCAtIDEKICAgIHZhciBtdWwgPSAxCiAgICB0aGlzW29mZnNldCArIGldID0gdmFsdWUgJiAweEZGCiAgICB3aGlsZSAoLS1pID49IDAgJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgdGhpc1tvZmZzZXQgKyBpXSA9ICh2YWx1ZSAvIG11bCkgJiAweEZGCiAgICB9CiAgCiAgICByZXR1cm4gb2Zmc2V0ICsgYnl0ZUxlbmd0aAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDggPSBmdW5jdGlvbiB3cml0ZVVJbnQ4ICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDEsIDB4ZmYsIDApCiAgICBpZiAoIUJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB2YWx1ZSA9IE1hdGguZmxvb3IodmFsdWUpCiAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogICAgcmV0dXJuIG9mZnNldCArIDEKICB9CiAgCiAgZnVuY3Rpb24gb2JqZWN0V3JpdGVVSW50MTYgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuKSB7CiAgICBpZiAodmFsdWUgPCAwKSB2YWx1ZSA9IDB4ZmZmZiArIHZhbHVlICsgMQogICAgZm9yICh2YXIgaSA9IDAsIGogPSBNYXRoLm1pbihidWYubGVuZ3RoIC0gb2Zmc2V0LCAyKTsgaSA8IGo7ICsraSkgewogICAgICBidWZbb2Zmc2V0ICsgaV0gPSAodmFsdWUgJiAoMHhmZiA8PCAoOCAqIChsaXR0bGVFbmRpYW4gPyBpIDogMSAtIGkpKSkpID4+PgogICAgICAgIChsaXR0bGVFbmRpYW4gPyBpIDogMSAtIGkpICogOAogICAgfQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDE2TEUgPSBmdW5jdGlvbiB3cml0ZVVJbnQxNkxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDIsIDB4ZmZmZiwgMCkKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyAyCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50MTZCRSA9IGZ1bmN0aW9uIHdyaXRlVUludDE2QkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMiwgMHhmZmZmLCAwKQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSA+Pj4gOCkKICAgICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQxNih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyAyCiAgfQogIAogIGZ1bmN0aW9uIG9iamVjdFdyaXRlVUludDMyIChidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbikgewogICAgaWYgKHZhbHVlIDwgMCkgdmFsdWUgPSAweGZmZmZmZmZmICsgdmFsdWUgKyAxCiAgICBmb3IgKHZhciBpID0gMCwgaiA9IE1hdGgubWluKGJ1Zi5sZW5ndGggLSBvZmZzZXQsIDQpOyBpIDwgajsgKytpKSB7CiAgICAgIGJ1ZltvZmZzZXQgKyBpXSA9ICh2YWx1ZSA+Pj4gKGxpdHRsZUVuZGlhbiA/IGkgOiAzIC0gaSkgKiA4KSAmIDB4ZmYKICAgIH0KICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnQzMkxFID0gZnVuY3Rpb24gd3JpdGVVSW50MzJMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweGZmZmZmZmZmLCAwKQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIHRoaXNbb2Zmc2V0ICsgM10gPSAodmFsdWUgPj4+IDI0KQogICAgICB0aGlzW29mZnNldCArIDJdID0gKHZhbHVlID4+PiAxNikKICAgICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gOCkKICAgICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICAgIH0gZWxzZSB7CiAgICAgIG9iamVjdFdyaXRlVUludDMyKHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUpCiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgNAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDMyQkUgPSBmdW5jdGlvbiB3cml0ZVVJbnQzMkJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDQsIDB4ZmZmZmZmZmYsIDApCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiAyNCkKICAgICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gMTYpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMl0gPSAodmFsdWUgPj4+IDgpCiAgICAgIHRoaXNbb2Zmc2V0ICsgM10gPSAodmFsdWUgJiAweGZmKQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MzIodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UpCiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgNAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlSW50TEUgPSBmdW5jdGlvbiB3cml0ZUludExFICh2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIHsKICAgICAgdmFyIGxpbWl0ID0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGggLSAxKQogIAogICAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBsaW1pdCAtIDEsIC1saW1pdCkKICAgIH0KICAKICAgIHZhciBpID0gMAogICAgdmFyIG11bCA9IDEKICAgIHZhciBzdWIgPSAwCiAgICB0aGlzW29mZnNldF0gPSB2YWx1ZSAmIDB4RkYKICAgIHdoaWxlICgrK2kgPCBieXRlTGVuZ3RoICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICAgIGlmICh2YWx1ZSA8IDAgJiYgc3ViID09PSAwICYmIHRoaXNbb2Zmc2V0ICsgaSAtIDFdICE9PSAwKSB7CiAgICAgICAgc3ViID0gMQogICAgICB9CiAgICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSAoKHZhbHVlIC8gbXVsKSA+PiAwKSAtIHN1YiAmIDB4RkYKICAgIH0KICAKICAgIHJldHVybiBvZmZzZXQgKyBieXRlTGVuZ3RoCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnRCRSA9IGZ1bmN0aW9uIHdyaXRlSW50QkUgKHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgewogICAgICB2YXIgbGltaXQgPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCAtIDEpCiAgCiAgICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIGxpbWl0IC0gMSwgLWxpbWl0KQogICAgfQogIAogICAgdmFyIGkgPSBieXRlTGVuZ3RoIC0gMQogICAgdmFyIG11bCA9IDEKICAgIHZhciBzdWIgPSAwCiAgICB0aGlzW29mZnNldCArIGldID0gdmFsdWUgJiAweEZGCiAgICB3aGlsZSAoLS1pID49IDAgJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgaWYgKHZhbHVlIDwgMCAmJiBzdWIgPT09IDAgJiYgdGhpc1tvZmZzZXQgKyBpICsgMV0gIT09IDApIHsKICAgICAgICBzdWIgPSAxCiAgICAgIH0KICAgICAgdGhpc1tvZmZzZXQgKyBpXSA9ICgodmFsdWUgLyBtdWwpID4+IDApIC0gc3ViICYgMHhGRgogICAgfQogIAogICAgcmV0dXJuIG9mZnNldCArIGJ5dGVMZW5ndGgKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDggPSBmdW5jdGlvbiB3cml0ZUludDggKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMSwgMHg3ZiwgLTB4ODApCiAgICBpZiAoIUJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB2YWx1ZSA9IE1hdGguZmxvb3IodmFsdWUpCiAgICBpZiAodmFsdWUgPCAwKSB2YWx1ZSA9IDB4ZmYgKyB2YWx1ZSArIDEKICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICByZXR1cm4gb2Zmc2V0ICsgMQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlSW50MTZMRSA9IGZ1bmN0aW9uIHdyaXRlSW50MTZMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweDdmZmYsIC0weDgwMDApCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICAgICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gOCkKICAgIH0gZWxzZSB7CiAgICAgIG9iamVjdFdyaXRlVUludDE2KHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUpCiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgMgogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlSW50MTZCRSA9IGZ1bmN0aW9uIHdyaXRlSW50MTZCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweDdmZmYsIC0weDgwMDApCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiA4KQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlICYgMHhmZikKICAgIH0gZWxzZSB7CiAgICAgIG9iamVjdFdyaXRlVUludDE2KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDIKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDMyTEUgPSBmdW5jdGlvbiB3cml0ZUludDMyTEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgNCwgMHg3ZmZmZmZmZiwgLTB4ODAwMDAwMDApCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICAgICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gOCkKICAgICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gMTYpCiAgICAgIHRoaXNbb2Zmc2V0ICsgM10gPSAodmFsdWUgPj4+IDI0KQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MzIodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyA0CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQzMkJFID0gZnVuY3Rpb24gd3JpdGVJbnQzMkJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDQsIDB4N2ZmZmZmZmYsIC0weDgwMDAwMDAwKQogICAgaWYgKHZhbHVlIDwgMCkgdmFsdWUgPSAweGZmZmZmZmZmICsgdmFsdWUgKyAxCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiAyNCkKICAgICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gMTYpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMl0gPSAodmFsdWUgPj4+IDgpCiAgICAgIHRoaXNbb2Zmc2V0ICsgM10gPSAodmFsdWUgJiAweGZmKQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MzIodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UpCiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgNAogIH0KICAKICBmdW5jdGlvbiBjaGVja0lFRUU3NTQgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgZXh0LCBtYXgsIG1pbikgewogICAgaWYgKG9mZnNldCArIGV4dCA+IGJ1Zi5sZW5ndGgpIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbmRleCBvdXQgb2YgcmFuZ2UnKQogICAgaWYgKG9mZnNldCA8IDApIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbmRleCBvdXQgb2YgcmFuZ2UnKQogIH0KICAKICBmdW5jdGlvbiB3cml0ZUZsb2F0IChidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbiwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIHsKICAgICAgY2hlY2tJRUVFNzU0KGJ1ZiwgdmFsdWUsIG9mZnNldCwgNCwgMy40MDI4MjM0NjYzODUyODg2ZSszOCwgLTMuNDAyODIzNDY2Mzg1Mjg4NmUrMzgpCiAgICB9CiAgICBpZWVlNzU0LndyaXRlKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCAyMywgNCkKICAgIHJldHVybiBvZmZzZXQgKyA0CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVGbG9hdExFID0gZnVuY3Rpb24gd3JpdGVGbG9hdExFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgcmV0dXJuIHdyaXRlRmxvYXQodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSwgbm9Bc3NlcnQpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVGbG9hdEJFID0gZnVuY3Rpb24gd3JpdGVGbG9hdEJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgcmV0dXJuIHdyaXRlRmxvYXQodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UsIG5vQXNzZXJ0KQogIH0KICAKICBmdW5jdGlvbiB3cml0ZURvdWJsZSAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIGNoZWNrSUVFRTc1NChidWYsIHZhbHVlLCBvZmZzZXQsIDgsIDEuNzk3NjkzMTM0ODYyMzE1N0UrMzA4LCAtMS43OTc2OTMxMzQ4NjIzMTU3RSszMDgpCiAgICB9CiAgICBpZWVlNzU0LndyaXRlKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCA1MiwgOCkKICAgIHJldHVybiBvZmZzZXQgKyA4CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVEb3VibGVMRSA9IGZ1bmN0aW9uIHdyaXRlRG91YmxlTEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICByZXR1cm4gd3JpdGVEb3VibGUodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSwgbm9Bc3NlcnQpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVEb3VibGVCRSA9IGZ1bmN0aW9uIHdyaXRlRG91YmxlQkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICByZXR1cm4gd3JpdGVEb3VibGUodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UsIG5vQXNzZXJ0KQogIH0KICAKICAvLyBjb3B5KHRhcmdldEJ1ZmZlciwgdGFyZ2V0U3RhcnQ9MCwgc291cmNlU3RhcnQ9MCwgc291cmNlRW5kPWJ1ZmZlci5sZW5ndGgpCiAgQnVmZmVyLnByb3RvdHlwZS5jb3B5ID0gZnVuY3Rpb24gY29weSAodGFyZ2V0LCB0YXJnZXRTdGFydCwgc3RhcnQsIGVuZCkgewogICAgaWYgKCFzdGFydCkgc3RhcnQgPSAwCiAgICBpZiAoIWVuZCAmJiBlbmQgIT09IDApIGVuZCA9IHRoaXMubGVuZ3RoCiAgICBpZiAodGFyZ2V0U3RhcnQgPj0gdGFyZ2V0Lmxlbmd0aCkgdGFyZ2V0U3RhcnQgPSB0YXJnZXQubGVuZ3RoCiAgICBpZiAoIXRhcmdldFN0YXJ0KSB0YXJnZXRTdGFydCA9IDAKICAgIGlmIChlbmQgPiAwICYmIGVuZCA8IHN0YXJ0KSBlbmQgPSBzdGFydAogIAogICAgLy8gQ29weSAwIGJ5dGVzOyB3ZSdyZSBkb25lCiAgICBpZiAoZW5kID09PSBzdGFydCkgcmV0dXJuIDAKICAgIGlmICh0YXJnZXQubGVuZ3RoID09PSAwIHx8IHRoaXMubGVuZ3RoID09PSAwKSByZXR1cm4gMAogIAogICAgLy8gRmF0YWwgZXJyb3IgY29uZGl0aW9ucwogICAgaWYgKHRhcmdldFN0YXJ0IDwgMCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigndGFyZ2V0U3RhcnQgb3V0IG9mIGJvdW5kcycpCiAgICB9CiAgICBpZiAoc3RhcnQgPCAwIHx8IHN0YXJ0ID49IHRoaXMubGVuZ3RoKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignc291cmNlU3RhcnQgb3V0IG9mIGJvdW5kcycpCiAgICBpZiAoZW5kIDwgMCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ3NvdXJjZUVuZCBvdXQgb2YgYm91bmRzJykKICAKICAgIC8vIEFyZSB3ZSBvb2I/CiAgICBpZiAoZW5kID4gdGhpcy5sZW5ndGgpIGVuZCA9IHRoaXMubGVuZ3RoCiAgICBpZiAodGFyZ2V0Lmxlbmd0aCAtIHRhcmdldFN0YXJ0IDwgZW5kIC0gc3RhcnQpIHsKICAgICAgZW5kID0gdGFyZ2V0Lmxlbmd0aCAtIHRhcmdldFN0YXJ0ICsgc3RhcnQKICAgIH0KICAKICAgIHZhciBsZW4gPSBlbmQgLSBzdGFydAogICAgdmFyIGkKICAKICAgIGlmICh0aGlzID09PSB0YXJnZXQgJiYgc3RhcnQgPCB0YXJnZXRTdGFydCAmJiB0YXJnZXRTdGFydCA8IGVuZCkgewogICAgICAvLyBkZXNjZW5kaW5nIGNvcHkgZnJvbSBlbmQKICAgICAgZm9yIChpID0gbGVuIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICB0YXJnZXRbaSArIHRhcmdldFN0YXJ0XSA9IHRoaXNbaSArIHN0YXJ0XQogICAgICB9CiAgICB9IGVsc2UgaWYgKGxlbiA8IDEwMDAgfHwgIUJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIC8vIGFzY2VuZGluZyBjb3B5IGZyb20gc3RhcnQKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgdGFyZ2V0W2kgKyB0YXJnZXRTdGFydF0gPSB0aGlzW2kgKyBzdGFydF0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgVWludDhBcnJheS5wcm90b3R5cGUuc2V0LmNhbGwoCiAgICAgICAgdGFyZ2V0LAogICAgICAgIHRoaXMuc3ViYXJyYXkoc3RhcnQsIHN0YXJ0ICsgbGVuKSwKICAgICAgICB0YXJnZXRTdGFydAogICAgICApCiAgICB9CiAgCiAgICByZXR1cm4gbGVuCiAgfQogIAogIC8vIFVzYWdlOgogIC8vICAgIGJ1ZmZlci5maWxsKG51bWJlclssIG9mZnNldFssIGVuZF1dKQogIC8vICAgIGJ1ZmZlci5maWxsKGJ1ZmZlclssIG9mZnNldFssIGVuZF1dKQogIC8vICAgIGJ1ZmZlci5maWxsKHN0cmluZ1ssIG9mZnNldFssIGVuZF1dWywgZW5jb2RpbmddKQogIEJ1ZmZlci5wcm90b3R5cGUuZmlsbCA9IGZ1bmN0aW9uIGZpbGwgKHZhbCwgc3RhcnQsIGVuZCwgZW5jb2RpbmcpIHsKICAgIC8vIEhhbmRsZSBzdHJpbmcgY2FzZXM6CiAgICBpZiAodHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHsKICAgICAgaWYgKHR5cGVvZiBzdGFydCA9PT0gJ3N0cmluZycpIHsKICAgICAgICBlbmNvZGluZyA9IHN0YXJ0CiAgICAgICAgc3RhcnQgPSAwCiAgICAgICAgZW5kID0gdGhpcy5sZW5ndGgKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZW5kID09PSAnc3RyaW5nJykgewogICAgICAgIGVuY29kaW5nID0gZW5kCiAgICAgICAgZW5kID0gdGhpcy5sZW5ndGgKICAgICAgfQogICAgICBpZiAodmFsLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHZhciBjb2RlID0gdmFsLmNoYXJDb2RlQXQoMCkKICAgICAgICBpZiAoY29kZSA8IDI1NikgewogICAgICAgICAgdmFsID0gY29kZQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZW5jb2RpbmcgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgZW5jb2RpbmcgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignZW5jb2RpbmcgbXVzdCBiZSBhIHN0cmluZycpCiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gJ3N0cmluZycgJiYgIUJ1ZmZlci5pc0VuY29kaW5nKGVuY29kaW5nKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1Vua25vd24gZW5jb2Rpbmc6ICcgKyBlbmNvZGluZykKICAgICAgfQogICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgICB2YWwgPSB2YWwgJiAyNTUKICAgIH0KICAKICAgIC8vIEludmFsaWQgcmFuZ2VzIGFyZSBub3Qgc2V0IHRvIGEgZGVmYXVsdCwgc28gY2FuIHJhbmdlIGNoZWNrIGVhcmx5LgogICAgaWYgKHN0YXJ0IDwgMCB8fCB0aGlzLmxlbmd0aCA8IHN0YXJ0IHx8IHRoaXMubGVuZ3RoIDwgZW5kKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdPdXQgb2YgcmFuZ2UgaW5kZXgnKQogICAgfQogIAogICAgaWYgKGVuZCA8PSBzdGFydCkgewogICAgICByZXR1cm4gdGhpcwogICAgfQogIAogICAgc3RhcnQgPSBzdGFydCA+Pj4gMAogICAgZW5kID0gZW5kID09PSB1bmRlZmluZWQgPyB0aGlzLmxlbmd0aCA6IGVuZCA+Pj4gMAogIAogICAgaWYgKCF2YWwpIHZhbCA9IDAKICAKICAgIHZhciBpCiAgICBpZiAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpIHsKICAgICAgZm9yIChpID0gc3RhcnQ7IGkgPCBlbmQ7ICsraSkgewogICAgICAgIHRoaXNbaV0gPSB2YWwKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGJ5dGVzID0gQnVmZmVyLmlzQnVmZmVyKHZhbCkKICAgICAgICA/IHZhbAogICAgICAgIDogdXRmOFRvQnl0ZXMobmV3IEJ1ZmZlcih2YWwsIGVuY29kaW5nKS50b1N0cmluZygpKQogICAgICB2YXIgbGVuID0gYnl0ZXMubGVuZ3RoCiAgICAgIGZvciAoaSA9IDA7IGkgPCBlbmQgLSBzdGFydDsgKytpKSB7CiAgICAgICAgdGhpc1tpICsgc3RhcnRdID0gYnl0ZXNbaSAlIGxlbl0KICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIHRoaXMKICB9CiAgCiAgLy8gSEVMUEVSIEZVTkNUSU9OUwogIC8vID09PT09PT09PT09PT09PT0KICAKICB2YXIgSU5WQUxJRF9CQVNFNjRfUkUgPSAvW14rXC8wLTlBLVphLXotX10vZwogIAogIGZ1bmN0aW9uIGJhc2U2NGNsZWFuIChzdHIpIHsKICAgIC8vIE5vZGUgc3RyaXBzIG91dCBpbnZhbGlkIGNoYXJhY3RlcnMgbGlrZSBcbiBhbmQgXHQgZnJvbSB0aGUgc3RyaW5nLCBiYXNlNjQtanMgZG9lcyBub3QKICAgIHN0ciA9IHN0cmluZ3RyaW0oc3RyKS5yZXBsYWNlKElOVkFMSURfQkFTRTY0X1JFLCAnJykKICAgIC8vIE5vZGUgY29udmVydHMgc3RyaW5ncyB3aXRoIGxlbmd0aCA8IDIgdG8gJycKICAgIGlmIChzdHIubGVuZ3RoIDwgMikgcmV0dXJuICcnCiAgICAvLyBOb2RlIGFsbG93cyBmb3Igbm9uLXBhZGRlZCBiYXNlNjQgc3RyaW5ncyAobWlzc2luZyB0cmFpbGluZyA9PT0pLCBiYXNlNjQtanMgZG9lcyBub3QKICAgIHdoaWxlIChzdHIubGVuZ3RoICUgNCAhPT0gMCkgewogICAgICBzdHIgPSBzdHIgKyAnPScKICAgIH0KICAgIHJldHVybiBzdHIKICB9CiAgCiAgZnVuY3Rpb24gc3RyaW5ndHJpbSAoc3RyKSB7CiAgICBpZiAoc3RyLnRyaW0pIHJldHVybiBzdHIudHJpbSgpCiAgICByZXR1cm4gc3RyLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJykKICB9CiAgCiAgZnVuY3Rpb24gdG9IZXggKG4pIHsKICAgIGlmIChuIDwgMTYpIHJldHVybiAnMCcgKyBuLnRvU3RyaW5nKDE2KQogICAgcmV0dXJuIG4udG9TdHJpbmcoMTYpCiAgfQogIAogIGZ1bmN0aW9uIHV0ZjhUb0J5dGVzIChzdHJpbmcsIHVuaXRzKSB7CiAgICB1bml0cyA9IHVuaXRzIHx8IEluZmluaXR5CiAgICB2YXIgY29kZVBvaW50CiAgICB2YXIgbGVuZ3RoID0gc3RyaW5nLmxlbmd0aAogICAgdmFyIGxlYWRTdXJyb2dhdGUgPSBudWxsCiAgICB2YXIgYnl0ZXMgPSBbXQogIAogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBjb2RlUG9pbnQgPSBzdHJpbmcuY2hhckNvZGVBdChpKQogIAogICAgICAvLyBpcyBzdXJyb2dhdGUgY29tcG9uZW50CiAgICAgIGlmIChjb2RlUG9pbnQgPiAweEQ3RkYgJiYgY29kZVBvaW50IDwgMHhFMDAwKSB7CiAgICAgICAgLy8gbGFzdCBjaGFyIHdhcyBhIGxlYWQKICAgICAgICBpZiAoIWxlYWRTdXJyb2dhdGUpIHsKICAgICAgICAgIC8vIG5vIGxlYWQgeWV0CiAgICAgICAgICBpZiAoY29kZVBvaW50ID4gMHhEQkZGKSB7CiAgICAgICAgICAgIC8vIHVuZXhwZWN0ZWQgdHJhaWwKICAgICAgICAgICAgaWYgKCh1bml0cyAtPSAzKSA+IC0xKSBieXRlcy5wdXNoKDB4RUYsIDB4QkYsIDB4QkQpCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICB9IGVsc2UgaWYgKGkgKyAxID09PSBsZW5ndGgpIHsKICAgICAgICAgICAgLy8gdW5wYWlyZWQgbGVhZAogICAgICAgICAgICBpZiAoKHVuaXRzIC09IDMpID4gLTEpIGJ5dGVzLnB1c2goMHhFRiwgMHhCRiwgMHhCRCkKICAgICAgICAgICAgY29udGludWUKICAgICAgICAgIH0KICAKICAgICAgICAgIC8vIHZhbGlkIGxlYWQKICAgICAgICAgIGxlYWRTdXJyb2dhdGUgPSBjb2RlUG9pbnQKICAKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQogIAogICAgICAgIC8vIDIgbGVhZHMgaW4gYSByb3cKICAgICAgICBpZiAoY29kZVBvaW50IDwgMHhEQzAwKSB7CiAgICAgICAgICBpZiAoKHVuaXRzIC09IDMpID4gLTEpIGJ5dGVzLnB1c2goMHhFRiwgMHhCRiwgMHhCRCkKICAgICAgICAgIGxlYWRTdXJyb2dhdGUgPSBjb2RlUG9pbnQKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQogIAogICAgICAgIC8vIHZhbGlkIHN1cnJvZ2F0ZSBwYWlyCiAgICAgICAgY29kZVBvaW50ID0gKGxlYWRTdXJyb2dhdGUgLSAweEQ4MDAgPDwgMTAgfCBjb2RlUG9pbnQgLSAweERDMDApICsgMHgxMDAwMAogICAgICB9IGVsc2UgaWYgKGxlYWRTdXJyb2dhdGUpIHsKICAgICAgICAvLyB2YWxpZCBibXAgY2hhciwgYnV0IGxhc3QgY2hhciB3YXMgYSBsZWFkCiAgICAgICAgaWYgKCh1bml0cyAtPSAzKSA+IC0xKSBieXRlcy5wdXNoKDB4RUYsIDB4QkYsIDB4QkQpCiAgICAgIH0KICAKICAgICAgbGVhZFN1cnJvZ2F0ZSA9IG51bGwKICAKICAgICAgLy8gZW5jb2RlIHV0ZjgKICAgICAgaWYgKGNvZGVQb2ludCA8IDB4ODApIHsKICAgICAgICBpZiAoKHVuaXRzIC09IDEpIDwgMCkgYnJlYWsKICAgICAgICBieXRlcy5wdXNoKGNvZGVQb2ludCkKICAgICAgfSBlbHNlIGlmIChjb2RlUG9pbnQgPCAweDgwMCkgewogICAgICAgIGlmICgodW5pdHMgLT0gMikgPCAwKSBicmVhawogICAgICAgIGJ5dGVzLnB1c2goCiAgICAgICAgICBjb2RlUG9pbnQgPj4gMHg2IHwgMHhDMCwKICAgICAgICAgIGNvZGVQb2ludCAmIDB4M0YgfCAweDgwCiAgICAgICAgKQogICAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA8IDB4MTAwMDApIHsKICAgICAgICBpZiAoKHVuaXRzIC09IDMpIDwgMCkgYnJlYWsKICAgICAgICBieXRlcy5wdXNoKAogICAgICAgICAgY29kZVBvaW50ID4+IDB4QyB8IDB4RTAsCiAgICAgICAgICBjb2RlUG9pbnQgPj4gMHg2ICYgMHgzRiB8IDB4ODAsCiAgICAgICAgICBjb2RlUG9pbnQgJiAweDNGIHwgMHg4MAogICAgICAgICkKICAgICAgfSBlbHNlIGlmIChjb2RlUG9pbnQgPCAweDExMDAwMCkgewogICAgICAgIGlmICgodW5pdHMgLT0gNCkgPCAwKSBicmVhawogICAgICAgIGJ5dGVzLnB1c2goCiAgICAgICAgICBjb2RlUG9pbnQgPj4gMHgxMiB8IDB4RjAsCiAgICAgICAgICBjb2RlUG9pbnQgPj4gMHhDICYgMHgzRiB8IDB4ODAsCiAgICAgICAgICBjb2RlUG9pbnQgPj4gMHg2ICYgMHgzRiB8IDB4ODAsCiAgICAgICAgICBjb2RlUG9pbnQgJiAweDNGIHwgMHg4MAogICAgICAgICkKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgY29kZSBwb2ludCcpCiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiBieXRlcwogIH0KICAKICBmdW5jdGlvbiBhc2NpaVRvQnl0ZXMgKHN0cikgewogICAgdmFyIGJ5dGVBcnJheSA9IFtdCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7ICsraSkgewogICAgICAvLyBOb2RlJ3MgY29kZSBzZWVtcyB0byBiZSBkb2luZyB0aGlzIGFuZCBub3QgJiAweDdGLi4KICAgICAgYnl0ZUFycmF5LnB1c2goc3RyLmNoYXJDb2RlQXQoaSkgJiAweEZGKQogICAgfQogICAgcmV0dXJuIGJ5dGVBcnJheQogIH0KICAKICBmdW5jdGlvbiB1dGYxNmxlVG9CeXRlcyAoc3RyLCB1bml0cykgewogICAgdmFyIGMsIGhpLCBsbwogICAgdmFyIGJ5dGVBcnJheSA9IFtdCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7ICsraSkgewogICAgICBpZiAoKHVuaXRzIC09IDIpIDwgMCkgYnJlYWsKICAKICAgICAgYyA9IHN0ci5jaGFyQ29kZUF0KGkpCiAgICAgIGhpID0gYyA+PiA4CiAgICAgIGxvID0gYyAlIDI1NgogICAgICBieXRlQXJyYXkucHVzaChsbykKICAgICAgYnl0ZUFycmF5LnB1c2goaGkpCiAgICB9CiAgCiAgICByZXR1cm4gYnl0ZUFycmF5CiAgfQogIAogIGZ1bmN0aW9uIGJhc2U2NFRvQnl0ZXMgKHN0cikgewogICAgcmV0dXJuIGJhc2U2NC50b0J5dGVBcnJheShiYXNlNjRjbGVhbihzdHIpKQogIH0KICAKICBmdW5jdGlvbiBibGl0QnVmZmVyIChzcmMsIGRzdCwgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKChpICsgb2Zmc2V0ID49IGRzdC5sZW5ndGgpIHx8IChpID49IHNyYy5sZW5ndGgpKSBicmVhawogICAgICBkc3RbaSArIG9mZnNldF0gPSBzcmNbaV0KICAgIH0KICAgIHJldHVybiBpCiAgfQogIAogIGZ1bmN0aW9uIGlzbmFuICh2YWwpIHsKICAgIHJldHVybiB2YWwgIT09IHZhbCAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXNlbGYtY29tcGFyZQogIH0KICAKICB9KS5jYWxsKHRoaXMsdHlwZW9mIGdsb2JhbCAhPT0gInVuZGVmaW5lZCIgPyBnbG9iYWwgOiB0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIgPyBzZWxmIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSxyZXF1aXJlKCJidWZmZXIiKS5CdWZmZXIpCiAgfSx7ImJhc2U2NC1qcyI6NzgsImJ1ZmZlciI6ODAsImllZWU3NTQiOjgyLCJpc2FycmF5Ijo4M31dLDgxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KICAvLwogIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCiAgLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQogIC8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKICAvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCiAgLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAogIC8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQogIC8vIGZvbGxvd2luZyBjb25kaXRpb25zOgogIC8vCiAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKICAvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAvLwogIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAgLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogIC8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KICAvLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKICAvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKICAvLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCiAgLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICAKICBmdW5jdGlvbiBFdmVudEVtaXR0ZXIoKSB7CiAgICB0aGlzLl9ldmVudHMgPSB0aGlzLl9ldmVudHMgfHwge307CiAgICB0aGlzLl9tYXhMaXN0ZW5lcnMgPSB0aGlzLl9tYXhMaXN0ZW5lcnMgfHwgdW5kZWZpbmVkOwogIH0KICBtb2R1bGUuZXhwb3J0cyA9IEV2ZW50RW1pdHRlcjsKICAKICAvLyBCYWNrd2FyZHMtY29tcGF0IHdpdGggbm9kZSAwLjEwLngKICBFdmVudEVtaXR0ZXIuRXZlbnRFbWl0dGVyID0gRXZlbnRFbWl0dGVyOwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuX2V2ZW50cyA9IHVuZGVmaW5lZDsKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLl9tYXhMaXN0ZW5lcnMgPSB1bmRlZmluZWQ7CiAgCiAgLy8gQnkgZGVmYXVsdCBFdmVudEVtaXR0ZXJzIHdpbGwgcHJpbnQgYSB3YXJuaW5nIGlmIG1vcmUgdGhhbiAxMCBsaXN0ZW5lcnMgYXJlCiAgLy8gYWRkZWQgdG8gaXQuIFRoaXMgaXMgYSB1c2VmdWwgZGVmYXVsdCB3aGljaCBoZWxwcyBmaW5kaW5nIG1lbW9yeSBsZWFrcy4KICBFdmVudEVtaXR0ZXIuZGVmYXVsdE1heExpc3RlbmVycyA9IDEwOwogIAogIC8vIE9idmlvdXNseSBub3QgYWxsIEVtaXR0ZXJzIHNob3VsZCBiZSBsaW1pdGVkIHRvIDEwLiBUaGlzIGZ1bmN0aW9uIGFsbG93cwogIC8vIHRoYXQgdG8gYmUgaW5jcmVhc2VkLiBTZXQgdG8gemVybyBmb3IgdW5saW1pdGVkLgogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuc2V0TWF4TGlzdGVuZXJzID0gZnVuY3Rpb24obikgewogICAgaWYgKCFpc051bWJlcihuKSB8fCBuIDwgMCB8fCBpc05hTihuKSkKICAgICAgdGhyb3cgVHlwZUVycm9yKCduIG11c3QgYmUgYSBwb3NpdGl2ZSBudW1iZXInKTsKICAgIHRoaXMuX21heExpc3RlbmVycyA9IG47CiAgICByZXR1cm4gdGhpczsKICB9OwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uKHR5cGUpIHsKICAgIHZhciBlciwgaGFuZGxlciwgbGVuLCBhcmdzLCBpLCBsaXN0ZW5lcnM7CiAgCiAgICBpZiAoIXRoaXMuX2V2ZW50cykKICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgCiAgICAvLyBJZiB0aGVyZSBpcyBubyAnZXJyb3InIGV2ZW50IGxpc3RlbmVyIHRoZW4gdGhyb3cuCiAgICBpZiAodHlwZSA9PT0gJ2Vycm9yJykgewogICAgICBpZiAoIXRoaXMuX2V2ZW50cy5lcnJvciB8fAogICAgICAgICAgKGlzT2JqZWN0KHRoaXMuX2V2ZW50cy5lcnJvcikgJiYgIXRoaXMuX2V2ZW50cy5lcnJvci5sZW5ndGgpKSB7CiAgICAgICAgZXIgPSBhcmd1bWVudHNbMV07CiAgICAgICAgaWYgKGVyIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICAgIHRocm93IGVyOyAvLyBVbmhhbmRsZWQgJ2Vycm9yJyBldmVudAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBBdCBsZWFzdCBnaXZlIHNvbWUga2luZCBvZiBjb250ZXh0IHRvIHRoZSB1c2VyCiAgICAgICAgICB2YXIgZXJyID0gbmV3IEVycm9yKCdVbmNhdWdodCwgdW5zcGVjaWZpZWQgImVycm9yIiBldmVudC4gKCcgKyBlciArICcpJyk7CiAgICAgICAgICBlcnIuY29udGV4dCA9IGVyOwogICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgIH0KICAgICAgfQogICAgfQogIAogICAgaGFuZGxlciA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKICAKICAgIGlmIChpc1VuZGVmaW5lZChoYW5kbGVyKSkKICAgICAgcmV0dXJuIGZhbHNlOwogIAogICAgaWYgKGlzRnVuY3Rpb24oaGFuZGxlcikpIHsKICAgICAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgLy8gZmFzdCBjYXNlcwogICAgICAgIGNhc2UgMToKICAgICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMjoKICAgICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzLCBhcmd1bWVudHNbMV0pOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAzOgogICAgICAgICAgaGFuZGxlci5jYWxsKHRoaXMsIGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vIHNsb3dlcgogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgIGhhbmRsZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNPYmplY3QoaGFuZGxlcikpIHsKICAgICAgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgIGxpc3RlbmVycyA9IGhhbmRsZXIuc2xpY2UoKTsKICAgICAgbGVuID0gbGlzdGVuZXJzLmxlbmd0aDsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKQogICAgICAgIGxpc3RlbmVyc1tpXS5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KICAKICAgIHJldHVybiB0cnVlOwogIH07CiAgCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgICB2YXIgbTsKICAKICAgIGlmICghaXNGdW5jdGlvbihsaXN0ZW5lcikpCiAgICAgIHRocm93IFR5cGVFcnJvcignbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgCiAgICBpZiAoIXRoaXMuX2V2ZW50cykKICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgCiAgICAvLyBUbyBhdm9pZCByZWN1cnNpb24gaW4gdGhlIGNhc2UgdGhhdCB0eXBlID09PSAibmV3TGlzdGVuZXIiISBCZWZvcmUKICAgIC8vIGFkZGluZyBpdCB0byB0aGUgbGlzdGVuZXJzLCBmaXJzdCBlbWl0ICJuZXdMaXN0ZW5lciIuCiAgICBpZiAodGhpcy5fZXZlbnRzLm5ld0xpc3RlbmVyKQogICAgICB0aGlzLmVtaXQoJ25ld0xpc3RlbmVyJywgdHlwZSwKICAgICAgICAgICAgICAgIGlzRnVuY3Rpb24obGlzdGVuZXIubGlzdGVuZXIpID8KICAgICAgICAgICAgICAgIGxpc3RlbmVyLmxpc3RlbmVyIDogbGlzdGVuZXIpOwogIAogICAgaWYgKCF0aGlzLl9ldmVudHNbdHlwZV0pCiAgICAgIC8vIE9wdGltaXplIHRoZSBjYXNlIG9mIG9uZSBsaXN0ZW5lci4gRG9uJ3QgbmVlZCB0aGUgZXh0cmEgYXJyYXkgb2JqZWN0LgogICAgICB0aGlzLl9ldmVudHNbdHlwZV0gPSBsaXN0ZW5lcjsKICAgIGVsc2UgaWYgKGlzT2JqZWN0KHRoaXMuX2V2ZW50c1t0eXBlXSkpCiAgICAgIC8vIElmIHdlJ3ZlIGFscmVhZHkgZ290IGFuIGFycmF5LCBqdXN0IGFwcGVuZC4KICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdLnB1c2gobGlzdGVuZXIpOwogICAgZWxzZQogICAgICAvLyBBZGRpbmcgdGhlIHNlY29uZCBlbGVtZW50LCBuZWVkIHRvIGNoYW5nZSB0byBhcnJheS4KICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdID0gW3RoaXMuX2V2ZW50c1t0eXBlXSwgbGlzdGVuZXJdOwogIAogICAgLy8gQ2hlY2sgZm9yIGxpc3RlbmVyIGxlYWsKICAgIGlmIChpc09iamVjdCh0aGlzLl9ldmVudHNbdHlwZV0pICYmICF0aGlzLl9ldmVudHNbdHlwZV0ud2FybmVkKSB7CiAgICAgIGlmICghaXNVbmRlZmluZWQodGhpcy5fbWF4TGlzdGVuZXJzKSkgewogICAgICAgIG0gPSB0aGlzLl9tYXhMaXN0ZW5lcnM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbSA9IEV2ZW50RW1pdHRlci5kZWZhdWx0TWF4TGlzdGVuZXJzOwogICAgICB9CiAgCiAgICAgIGlmIChtICYmIG0gPiAwICYmIHRoaXMuX2V2ZW50c1t0eXBlXS5sZW5ndGggPiBtKSB7CiAgICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdLndhcm5lZCA9IHRydWU7CiAgICAgICAgY29uc29sZS5lcnJvcignKG5vZGUpIHdhcm5pbmc6IHBvc3NpYmxlIEV2ZW50RW1pdHRlciBtZW1vcnkgJyArCiAgICAgICAgICAgICAgICAgICAgICAnbGVhayBkZXRlY3RlZC4gJWQgbGlzdGVuZXJzIGFkZGVkLiAnICsKICAgICAgICAgICAgICAgICAgICAgICdVc2UgZW1pdHRlci5zZXRNYXhMaXN0ZW5lcnMoKSB0byBpbmNyZWFzZSBsaW1pdC4nLAogICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdLmxlbmd0aCk7CiAgICAgICAgaWYgKHR5cGVvZiBjb25zb2xlLnRyYWNlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAvLyBub3Qgc3VwcG9ydGVkIGluIElFIDEwCiAgICAgICAgICBjb25zb2xlLnRyYWNlKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gdGhpczsKICB9OwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUub24gPSBFdmVudEVtaXR0ZXIucHJvdG90eXBlLmFkZExpc3RlbmVyOwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKQogICAgICB0aHJvdyBUeXBlRXJyb3IoJ2xpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbicpOwogIAogICAgdmFyIGZpcmVkID0gZmFsc2U7CiAgCiAgICBmdW5jdGlvbiBnKCkgewogICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGcpOwogIAogICAgICBpZiAoIWZpcmVkKSB7CiAgICAgICAgZmlyZWQgPSB0cnVlOwogICAgICAgIGxpc3RlbmVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH0KICAKICAgIGcubGlzdGVuZXIgPSBsaXN0ZW5lcjsKICAgIHRoaXMub24odHlwZSwgZyk7CiAgCiAgICByZXR1cm4gdGhpczsKICB9OwogIAogIC8vIGVtaXRzIGEgJ3JlbW92ZUxpc3RlbmVyJyBldmVudCBpZmYgdGhlIGxpc3RlbmVyIHdhcyByZW1vdmVkCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgICB2YXIgbGlzdCwgcG9zaXRpb24sIGxlbmd0aCwgaTsKICAKICAgIGlmICghaXNGdW5jdGlvbihsaXN0ZW5lcikpCiAgICAgIHRocm93IFR5cGVFcnJvcignbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgCiAgICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhdGhpcy5fZXZlbnRzW3R5cGVdKQogICAgICByZXR1cm4gdGhpczsKICAKICAgIGxpc3QgPSB0aGlzLl9ldmVudHNbdHlwZV07CiAgICBsZW5ndGggPSBsaXN0Lmxlbmd0aDsKICAgIHBvc2l0aW9uID0gLTE7CiAgCiAgICBpZiAobGlzdCA9PT0gbGlzdGVuZXIgfHwKICAgICAgICAoaXNGdW5jdGlvbihsaXN0Lmxpc3RlbmVyKSAmJiBsaXN0Lmxpc3RlbmVyID09PSBsaXN0ZW5lcikpIHsKICAgICAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKICAgICAgaWYgKHRoaXMuX2V2ZW50cy5yZW1vdmVMaXN0ZW5lcikKICAgICAgICB0aGlzLmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgdHlwZSwgbGlzdGVuZXIpOwogIAogICAgfSBlbHNlIGlmIChpc09iamVjdChsaXN0KSkgewogICAgICBmb3IgKGkgPSBsZW5ndGg7IGktLSA+IDA7KSB7CiAgICAgICAgaWYgKGxpc3RbaV0gPT09IGxpc3RlbmVyIHx8CiAgICAgICAgICAgIChsaXN0W2ldLmxpc3RlbmVyICYmIGxpc3RbaV0ubGlzdGVuZXIgPT09IGxpc3RlbmVyKSkgewogICAgICAgICAgcG9zaXRpb24gPSBpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIGlmIChwb3NpdGlvbiA8IDApCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgCiAgICAgIGlmIChsaXN0Lmxlbmd0aCA9PT0gMSkgewogICAgICAgIGxpc3QubGVuZ3RoID0gMDsKICAgICAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwogICAgICB9IGVsc2UgewogICAgICAgIGxpc3Quc3BsaWNlKHBvc2l0aW9uLCAxKTsKICAgICAgfQogIAogICAgICBpZiAodGhpcy5fZXZlbnRzLnJlbW92ZUxpc3RlbmVyKQogICAgICAgIHRoaXMuZW1pdCgncmVtb3ZlTGlzdGVuZXInLCB0eXBlLCBsaXN0ZW5lcik7CiAgICB9CiAgCiAgICByZXR1cm4gdGhpczsKICB9OwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlQWxsTGlzdGVuZXJzID0gZnVuY3Rpb24odHlwZSkgewogICAgdmFyIGtleSwgbGlzdGVuZXJzOwogIAogICAgaWYgKCF0aGlzLl9ldmVudHMpCiAgICAgIHJldHVybiB0aGlzOwogIAogICAgLy8gbm90IGxpc3RlbmluZyBmb3IgcmVtb3ZlTGlzdGVuZXIsIG5vIG5lZWQgdG8gZW1pdAogICAgaWYgKCF0aGlzLl9ldmVudHMucmVtb3ZlTGlzdGVuZXIpIHsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApCiAgICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgICAgIGVsc2UgaWYgKHRoaXMuX2V2ZW50c1t0eXBlXSkKICAgICAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAKICAgIC8vIGVtaXQgcmVtb3ZlTGlzdGVuZXIgZm9yIGFsbCBsaXN0ZW5lcnMgb24gYWxsIGV2ZW50cwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgZm9yIChrZXkgaW4gdGhpcy5fZXZlbnRzKSB7CiAgICAgICAgaWYgKGtleSA9PT0gJ3JlbW92ZUxpc3RlbmVyJykgY29udGludWU7CiAgICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoa2V5KTsKICAgICAgfQogICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygncmVtb3ZlTGlzdGVuZXInKTsKICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIAogICAgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW3R5cGVdOwogIAogICAgaWYgKGlzRnVuY3Rpb24obGlzdGVuZXJzKSkgewogICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGxpc3RlbmVycyk7CiAgICB9IGVsc2UgaWYgKGxpc3RlbmVycykgewogICAgICAvLyBMSUZPIG9yZGVyCiAgICAgIHdoaWxlIChsaXN0ZW5lcnMubGVuZ3RoKQogICAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgbGlzdGVuZXJzW2xpc3RlbmVycy5sZW5ndGggLSAxXSk7CiAgICB9CiAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwogIAogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLmxpc3RlbmVycyA9IGZ1bmN0aW9uKHR5cGUpIHsKICAgIHZhciByZXQ7CiAgICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhdGhpcy5fZXZlbnRzW3R5cGVdKQogICAgICByZXQgPSBbXTsKICAgIGVsc2UgaWYgKGlzRnVuY3Rpb24odGhpcy5fZXZlbnRzW3R5cGVdKSkKICAgICAgcmV0ID0gW3RoaXMuX2V2ZW50c1t0eXBlXV07CiAgICBlbHNlCiAgICAgIHJldCA9IHRoaXMuX2V2ZW50c1t0eXBlXS5zbGljZSgpOwogICAgcmV0dXJuIHJldDsKICB9OwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUubGlzdGVuZXJDb3VudCA9IGZ1bmN0aW9uKHR5cGUpIHsKICAgIGlmICh0aGlzLl9ldmVudHMpIHsKICAgICAgdmFyIGV2bGlzdGVuZXIgPSB0aGlzLl9ldmVudHNbdHlwZV07CiAgCiAgICAgIGlmIChpc0Z1bmN0aW9uKGV2bGlzdGVuZXIpKQogICAgICAgIHJldHVybiAxOwogICAgICBlbHNlIGlmIChldmxpc3RlbmVyKQogICAgICAgIHJldHVybiBldmxpc3RlbmVyLmxlbmd0aDsKICAgIH0KICAgIHJldHVybiAwOwogIH07CiAgCiAgRXZlbnRFbWl0dGVyLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbihlbWl0dGVyLCB0eXBlKSB7CiAgICByZXR1cm4gZW1pdHRlci5saXN0ZW5lckNvdW50KHR5cGUpOwogIH07CiAgCiAgZnVuY3Rpb24gaXNGdW5jdGlvbihhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnZnVuY3Rpb24nOwogIH0KICAKICBmdW5jdGlvbiBpc051bWJlcihhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnbnVtYmVyJzsKICB9CiAgCiAgZnVuY3Rpb24gaXNPYmplY3QoYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcgJiYgYXJnICE9PSBudWxsOwogIH0KICAKICBmdW5jdGlvbiBpc1VuZGVmaW5lZChhcmcpIHsKICAgIHJldHVybiBhcmcgPT09IHZvaWQgMDsKICB9CiAgCiAgfSx7fV0sODI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIGV4cG9ydHMucmVhZCA9IGZ1bmN0aW9uIChidWZmZXIsIG9mZnNldCwgaXNMRSwgbUxlbiwgbkJ5dGVzKSB7CiAgICB2YXIgZSwgbQogICAgdmFyIGVMZW4gPSAobkJ5dGVzICogOCkgLSBtTGVuIC0gMQogICAgdmFyIGVNYXggPSAoMSA8PCBlTGVuKSAtIDEKICAgIHZhciBlQmlhcyA9IGVNYXggPj4gMQogICAgdmFyIG5CaXRzID0gLTcKICAgIHZhciBpID0gaXNMRSA/IChuQnl0ZXMgLSAxKSA6IDAKICAgIHZhciBkID0gaXNMRSA/IC0xIDogMQogICAgdmFyIHMgPSBidWZmZXJbb2Zmc2V0ICsgaV0KICAKICAgIGkgKz0gZAogIAogICAgZSA9IHMgJiAoKDEgPDwgKC1uQml0cykpIC0gMSkKICAgIHMgPj49ICgtbkJpdHMpCiAgICBuQml0cyArPSBlTGVuCiAgICBmb3IgKDsgbkJpdHMgPiAwOyBlID0gKGUgKiAyNTYpICsgYnVmZmVyW29mZnNldCArIGldLCBpICs9IGQsIG5CaXRzIC09IDgpIHt9CiAgCiAgICBtID0gZSAmICgoMSA8PCAoLW5CaXRzKSkgLSAxKQogICAgZSA+Pj0gKC1uQml0cykKICAgIG5CaXRzICs9IG1MZW4KICAgIGZvciAoOyBuQml0cyA+IDA7IG0gPSAobSAqIDI1NikgKyBidWZmZXJbb2Zmc2V0ICsgaV0sIGkgKz0gZCwgbkJpdHMgLT0gOCkge30KICAKICAgIGlmIChlID09PSAwKSB7CiAgICAgIGUgPSAxIC0gZUJpYXMKICAgIH0gZWxzZSBpZiAoZSA9PT0gZU1heCkgewogICAgICByZXR1cm4gbSA/IE5hTiA6ICgocyA/IC0xIDogMSkgKiBJbmZpbml0eSkKICAgIH0gZWxzZSB7CiAgICAgIG0gPSBtICsgTWF0aC5wb3coMiwgbUxlbikKICAgICAgZSA9IGUgLSBlQmlhcwogICAgfQogICAgcmV0dXJuIChzID8gLTEgOiAxKSAqIG0gKiBNYXRoLnBvdygyLCBlIC0gbUxlbikKICB9CiAgCiAgZXhwb3J0cy53cml0ZSA9IGZ1bmN0aW9uIChidWZmZXIsIHZhbHVlLCBvZmZzZXQsIGlzTEUsIG1MZW4sIG5CeXRlcykgewogICAgdmFyIGUsIG0sIGMKICAgIHZhciBlTGVuID0gKG5CeXRlcyAqIDgpIC0gbUxlbiAtIDEKICAgIHZhciBlTWF4ID0gKDEgPDwgZUxlbikgLSAxCiAgICB2YXIgZUJpYXMgPSBlTWF4ID4+IDEKICAgIHZhciBydCA9IChtTGVuID09PSAyMyA/IE1hdGgucG93KDIsIC0yNCkgLSBNYXRoLnBvdygyLCAtNzcpIDogMCkKICAgIHZhciBpID0gaXNMRSA/IDAgOiAobkJ5dGVzIC0gMSkKICAgIHZhciBkID0gaXNMRSA/IDEgOiAtMQogICAgdmFyIHMgPSB2YWx1ZSA8IDAgfHwgKHZhbHVlID09PSAwICYmIDEgLyB2YWx1ZSA8IDApID8gMSA6IDAKICAKICAgIHZhbHVlID0gTWF0aC5hYnModmFsdWUpCiAgCiAgICBpZiAoaXNOYU4odmFsdWUpIHx8IHZhbHVlID09PSBJbmZpbml0eSkgewogICAgICBtID0gaXNOYU4odmFsdWUpID8gMSA6IDAKICAgICAgZSA9IGVNYXgKICAgIH0gZWxzZSB7CiAgICAgIGUgPSBNYXRoLmZsb29yKE1hdGgubG9nKHZhbHVlKSAvIE1hdGguTE4yKQogICAgICBpZiAodmFsdWUgKiAoYyA9IE1hdGgucG93KDIsIC1lKSkgPCAxKSB7CiAgICAgICAgZS0tCiAgICAgICAgYyAqPSAyCiAgICAgIH0KICAgICAgaWYgKGUgKyBlQmlhcyA+PSAxKSB7CiAgICAgICAgdmFsdWUgKz0gcnQgLyBjCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFsdWUgKz0gcnQgKiBNYXRoLnBvdygyLCAxIC0gZUJpYXMpCiAgICAgIH0KICAgICAgaWYgKHZhbHVlICogYyA+PSAyKSB7CiAgICAgICAgZSsrCiAgICAgICAgYyAvPSAyCiAgICAgIH0KICAKICAgICAgaWYgKGUgKyBlQmlhcyA+PSBlTWF4KSB7CiAgICAgICAgbSA9IDAKICAgICAgICBlID0gZU1heAogICAgICB9IGVsc2UgaWYgKGUgKyBlQmlhcyA+PSAxKSB7CiAgICAgICAgbSA9ICgodmFsdWUgKiBjKSAtIDEpICogTWF0aC5wb3coMiwgbUxlbikKICAgICAgICBlID0gZSArIGVCaWFzCiAgICAgIH0gZWxzZSB7CiAgICAgICAgbSA9IHZhbHVlICogTWF0aC5wb3coMiwgZUJpYXMgLSAxKSAqIE1hdGgucG93KDIsIG1MZW4pCiAgICAgICAgZSA9IDAKICAgICAgfQogICAgfQogIAogICAgZm9yICg7IG1MZW4gPj0gODsgYnVmZmVyW29mZnNldCArIGldID0gbSAmIDB4ZmYsIGkgKz0gZCwgbSAvPSAyNTYsIG1MZW4gLT0gOCkge30KICAKICAgIGUgPSAoZSA8PCBtTGVuKSB8IG0KICAgIGVMZW4gKz0gbUxlbgogICAgZm9yICg7IGVMZW4gPiAwOyBidWZmZXJbb2Zmc2V0ICsgaV0gPSBlICYgMHhmZiwgaSArPSBkLCBlIC89IDI1NiwgZUxlbiAtPSA4KSB7fQogIAogICAgYnVmZmVyW29mZnNldCArIGkgLSBkXSB8PSBzICogMTI4CiAgfQogIAogIH0se31dLDgzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdG9TdHJpbmcgPSB7fS50b1N0cmluZzsKICAKICBtb2R1bGUuZXhwb3J0cyA9IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24gKGFycikgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwoYXJyKSA9PSAnW29iamVjdCBBcnJheV0nOwogIH07CiAgCiAgfSx7fV0sODQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgCiAgICBmdW5jdGlvbiBpc0FycmF5KG9iaikgewogICAgICBpZiAob2JqICE9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopID09PSAiW29iamVjdCBBcnJheV0iOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogIAogICAgZnVuY3Rpb24gaXNPYmplY3Qob2JqKSB7CiAgICAgIGlmIChvYmogIT09IG51bGwpIHsKICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICJbb2JqZWN0IE9iamVjdF0iOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogIAogICAgZnVuY3Rpb24gc3RyaWN0RGVlcEVxdWFsKGZpcnN0LCBzZWNvbmQpIHsKICAgICAgLy8gQ2hlY2sgdGhlIHNjYWxhciBjYXNlIGZpcnN0LgogICAgICBpZiAoZmlyc3QgPT09IHNlY29uZCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgCiAgICAgIC8vIENoZWNrIGlmIHRoZXkgYXJlIHRoZSBzYW1lIHR5cGUuCiAgICAgIHZhciBmaXJzdFR5cGUgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZmlyc3QpOwogICAgICBpZiAoZmlyc3RUeXBlICE9PSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoc2Vjb25kKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvLyBXZSBrbm93IHRoYXQgZmlyc3QgYW5kIHNlY29uZCBoYXZlIHRoZSBzYW1lIHR5cGUgc28gd2UgY2FuIGp1c3QgY2hlY2sgdGhlCiAgICAgIC8vIGZpcnN0IHR5cGUgZnJvbSBub3cgb24uCiAgICAgIGlmIChpc0FycmF5KGZpcnN0KSA9PT0gdHJ1ZSkgewogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgdGhleSdyZSBub3QgdGhlIHNhbWUgbGVuZ3RoOwogICAgICAgIGlmIChmaXJzdC5sZW5ndGggIT09IHNlY29uZC5sZW5ndGgpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmaXJzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHN0cmljdERlZXBFcXVhbChmaXJzdFtpXSwgc2Vjb25kW2ldKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoaXNPYmplY3QoZmlyc3QpID09PSB0cnVlKSB7CiAgICAgICAgLy8gQW4gb2JqZWN0IGlzIGVxdWFsIGlmIGl0IGhhcyB0aGUgc2FtZSBrZXkvdmFsdWUgcGFpcnMuCiAgICAgICAgdmFyIGtleXNTZWVuID0ge307CiAgICAgICAgZm9yICh2YXIga2V5IGluIGZpcnN0KSB7CiAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChmaXJzdCwga2V5KSkgewogICAgICAgICAgICBpZiAoc3RyaWN0RGVlcEVxdWFsKGZpcnN0W2tleV0sIHNlY29uZFtrZXldKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAga2V5c1NlZW5ba2V5XSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIE5vdyBjaGVjayB0aGF0IHRoZXJlIGFyZW4ndCBhbnkga2V5cyBpbiBzZWNvbmQgdGhhdCB3ZXJlbid0CiAgICAgICAgLy8gaW4gZmlyc3QuCiAgICAgICAgZm9yICh2YXIga2V5MiBpbiBzZWNvbmQpIHsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHNlY29uZCwga2V5MikpIHsKICAgICAgICAgICAgaWYgKGtleXNTZWVuW2tleTJdICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAKICAgIGZ1bmN0aW9uIGlzRmFsc2Uob2JqKSB7CiAgICAgIC8vIEZyb20gdGhlIHNwZWM6CiAgICAgIC8vIEEgZmFsc2UgdmFsdWUgY29ycmVzcG9uZHMgdG8gdGhlIGZvbGxvd2luZyB2YWx1ZXM6CiAgICAgIC8vIEVtcHR5IGxpc3QKICAgICAgLy8gRW1wdHkgb2JqZWN0CiAgICAgIC8vIEVtcHR5IHN0cmluZwogICAgICAvLyBGYWxzZSBib29sZWFuCiAgICAgIC8vIG51bGwgdmFsdWUKICAKICAgICAgLy8gRmlyc3QgY2hlY2sgdGhlIHNjYWxhciB2YWx1ZXMuCiAgICAgIGlmIChvYmogPT09ICIiIHx8IG9iaiA9PT0gZmFsc2UgfHwgb2JqID09PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmIChpc0FycmF5KG9iaikgJiYgb2JqLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgLy8gQ2hlY2sgZm9yIGFuIGVtcHR5IGFycmF5LgogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qob2JqKSkgewogICAgICAgICAgLy8gQ2hlY2sgZm9yIGFuIGVtcHR5IG9iamVjdC4KICAgICAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICAgICAgICAvLyBJZiB0aGVyZSBhcmUgYW55IGtleXMsIHRoZW4KICAgICAgICAgICAgICAvLyB0aGUgb2JqZWN0IGlzIG5vdCBlbXB0eSBzbyB0aGUgb2JqZWN0CiAgICAgICAgICAgICAgLy8gaXMgbm90IGZhbHNlLgogICAgICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgCiAgICBmdW5jdGlvbiBvYmpWYWx1ZXMob2JqKSB7CiAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqKTsKICAgICAgdmFyIHZhbHVlcyA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YWx1ZXMucHVzaChvYmpba2V5c1tpXV0pOwogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZXM7CiAgICB9CiAgCiAgICBmdW5jdGlvbiBtZXJnZShhLCBiKSB7CiAgICAgICAgdmFyIG1lcmdlZCA9IHt9OwogICAgICAgIGZvciAodmFyIGtleSBpbiBhKSB7CiAgICAgICAgICAgIG1lcmdlZFtrZXldID0gYVtrZXldOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBrZXkyIGluIGIpIHsKICAgICAgICAgICAgbWVyZ2VkW2tleTJdID0gYltrZXkyXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lcmdlZDsKICAgIH0KICAKICAgIHZhciB0cmltTGVmdDsKICAgIGlmICh0eXBlb2YgU3RyaW5nLnByb3RvdHlwZS50cmltTGVmdCA9PT0gImZ1bmN0aW9uIikgewogICAgICB0cmltTGVmdCA9IGZ1bmN0aW9uKHN0cikgewogICAgICAgIHJldHVybiBzdHIudHJpbUxlZnQoKTsKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIHRyaW1MZWZ0ID0gZnVuY3Rpb24oc3RyKSB7CiAgICAgICAgcmV0dXJuIHN0ci5tYXRjaCgvXlxzKiguKikvKVsxXTsKICAgICAgfTsKICAgIH0KICAKICAgIC8vIFR5cGUgY29uc3RhbnRzIHVzZWQgdG8gZGVmaW5lIGZ1bmN0aW9ucy4KICAgIHZhciBUWVBFX05VTUJFUiA9IDA7CiAgICB2YXIgVFlQRV9BTlkgPSAxOwogICAgdmFyIFRZUEVfU1RSSU5HID0gMjsKICAgIHZhciBUWVBFX0FSUkFZID0gMzsKICAgIHZhciBUWVBFX09CSkVDVCA9IDQ7CiAgICB2YXIgVFlQRV9CT09MRUFOID0gNTsKICAgIHZhciBUWVBFX0VYUFJFRiA9IDY7CiAgICB2YXIgVFlQRV9OVUxMID0gNzsKICAgIHZhciBUWVBFX0FSUkFZX05VTUJFUiA9IDg7CiAgICB2YXIgVFlQRV9BUlJBWV9TVFJJTkcgPSA5OwogIAogICAgdmFyIFRPS19FT0YgPSAiRU9GIjsKICAgIHZhciBUT0tfVU5RVU9URURJREVOVElGSUVSID0gIlVucXVvdGVkSWRlbnRpZmllciI7CiAgICB2YXIgVE9LX1FVT1RFRElERU5USUZJRVIgPSAiUXVvdGVkSWRlbnRpZmllciI7CiAgICB2YXIgVE9LX1JCUkFDS0VUID0gIlJicmFja2V0IjsKICAgIHZhciBUT0tfUlBBUkVOID0gIlJwYXJlbiI7CiAgICB2YXIgVE9LX0NPTU1BID0gIkNvbW1hIjsKICAgIHZhciBUT0tfQ09MT04gPSAiQ29sb24iOwogICAgdmFyIFRPS19SQlJBQ0UgPSAiUmJyYWNlIjsKICAgIHZhciBUT0tfTlVNQkVSID0gIk51bWJlciI7CiAgICB2YXIgVE9LX0NVUlJFTlQgPSAiQ3VycmVudCI7CiAgICB2YXIgVE9LX0VYUFJFRiA9ICJFeHByZWYiOwogICAgdmFyIFRPS19QSVBFID0gIlBpcGUiOwogICAgdmFyIFRPS19PUiA9ICJPciI7CiAgICB2YXIgVE9LX0FORCA9ICJBbmQiOwogICAgdmFyIFRPS19FUSA9ICJFUSI7CiAgICB2YXIgVE9LX0dUID0gIkdUIjsKICAgIHZhciBUT0tfTFQgPSAiTFQiOwogICAgdmFyIFRPS19HVEUgPSAiR1RFIjsKICAgIHZhciBUT0tfTFRFID0gIkxURSI7CiAgICB2YXIgVE9LX05FID0gIk5FIjsKICAgIHZhciBUT0tfRkxBVFRFTiA9ICJGbGF0dGVuIjsKICAgIHZhciBUT0tfU1RBUiA9ICJTdGFyIjsKICAgIHZhciBUT0tfRklMVEVSID0gIkZpbHRlciI7CiAgICB2YXIgVE9LX0RPVCA9ICJEb3QiOwogICAgdmFyIFRPS19OT1QgPSAiTm90IjsKICAgIHZhciBUT0tfTEJSQUNFID0gIkxicmFjZSI7CiAgICB2YXIgVE9LX0xCUkFDS0VUID0gIkxicmFja2V0IjsKICAgIHZhciBUT0tfTFBBUkVOPSAiTHBhcmVuIjsKICAgIHZhciBUT0tfTElURVJBTD0gIkxpdGVyYWwiOwogIAogICAgLy8gVGhlICImIiwgIlsiLCAiPCIsICI+IiB0b2tlbnMKICAgIC8vIGFyZSBub3QgaW4gYmFzaWNUb2tlbiBiZWNhdXNlCiAgICAvLyB0aGVyZSBhcmUgdHdvIHRva2VuIHZhcmlhbnRzCiAgICAvLyAoIiYmIiwgIls/IiwgIjw9IiwgIj49IikuICBUaGlzIGlzIHNwZWNpYWxseSBoYW5kbGVkCiAgICAvLyBiZWxvdy4KICAKICAgIHZhciBiYXNpY1Rva2VucyA9IHsKICAgICAgIi4iOiBUT0tfRE9ULAogICAgICAiKiI6IFRPS19TVEFSLAogICAgICAiLCI6IFRPS19DT01NQSwKICAgICAgIjoiOiBUT0tfQ09MT04sCiAgICAgICJ7IjogVE9LX0xCUkFDRSwKICAgICAgIn0iOiBUT0tfUkJSQUNFLAogICAgICAiXSI6IFRPS19SQlJBQ0tFVCwKICAgICAgIigiOiBUT0tfTFBBUkVOLAogICAgICAiKSI6IFRPS19SUEFSRU4sCiAgICAgICJAIjogVE9LX0NVUlJFTlQKICAgIH07CiAgCiAgICB2YXIgb3BlcmF0b3JTdGFydFRva2VuID0gewogICAgICAgICI8IjogdHJ1ZSwKICAgICAgICAiPiI6IHRydWUsCiAgICAgICAgIj0iOiB0cnVlLAogICAgICAgICIhIjogdHJ1ZQogICAgfTsKICAKICAgIHZhciBza2lwQ2hhcnMgPSB7CiAgICAgICAgIiAiOiB0cnVlLAogICAgICAgICJcdCI6IHRydWUsCiAgICAgICAgIlxuIjogdHJ1ZQogICAgfTsKICAKICAKICAgIGZ1bmN0aW9uIGlzQWxwaGEoY2gpIHsKICAgICAgICByZXR1cm4gKGNoID49ICJhIiAmJiBjaCA8PSAieiIpIHx8CiAgICAgICAgICAgICAgIChjaCA+PSAiQSIgJiYgY2ggPD0gIloiKSB8fAogICAgICAgICAgICAgICBjaCA9PT0gIl8iOwogICAgfQogIAogICAgZnVuY3Rpb24gaXNOdW0oY2gpIHsKICAgICAgICByZXR1cm4gKGNoID49ICIwIiAmJiBjaCA8PSAiOSIpIHx8CiAgICAgICAgICAgICAgIGNoID09PSAiLSI7CiAgICB9CiAgICBmdW5jdGlvbiBpc0FscGhhTnVtKGNoKSB7CiAgICAgICAgcmV0dXJuIChjaCA+PSAiYSIgJiYgY2ggPD0gInoiKSB8fAogICAgICAgICAgICAgICAoY2ggPj0gIkEiICYmIGNoIDw9ICJaIikgfHwKICAgICAgICAgICAgICAgKGNoID49ICIwIiAmJiBjaCA8PSAiOSIpIHx8CiAgICAgICAgICAgICAgIGNoID09PSAiXyI7CiAgICB9CiAgCiAgICBmdW5jdGlvbiBMZXhlcigpIHsKICAgIH0KICAgIExleGVyLnByb3RvdHlwZSA9IHsKICAgICAgICB0b2tlbml6ZTogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHZhciB0b2tlbnMgPSBbXTsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCA9IDA7CiAgICAgICAgICAgIHZhciBzdGFydDsKICAgICAgICAgICAgdmFyIGlkZW50aWZpZXI7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2N1cnJlbnQgPCBzdHJlYW0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNBbHBoYShzdHJlYW1bdGhpcy5fY3VycmVudF0pKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICAgIGlkZW50aWZpZXIgPSB0aGlzLl9jb25zdW1lVW5xdW90ZWRJZGVudGlmaWVyKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19VTlFVT1RFRElERU5USUZJRVIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpZGVudGlmaWVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmFzaWNUb2tlbnNbc3RyZWFtW3RoaXMuX2N1cnJlbnRdXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IGJhc2ljVG9rZW5zW3N0cmVhbVt0aGlzLl9jdXJyZW50XV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHN0cmVhbVt0aGlzLl9jdXJyZW50XSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogdGhpcy5fY3VycmVudH0pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNOdW0oc3RyZWFtW3RoaXMuX2N1cnJlbnRdKSkgewogICAgICAgICAgICAgICAgICAgIHRva2VuID0gdGhpcy5fY29uc3VtZU51bWJlcihzdHJlYW0pOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiWyIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBObyBuZWVkIHRvIGluY3JlbWVudCB0aGlzLl9jdXJyZW50LiAgVGhpcyBoYXBwZW5zCiAgICAgICAgICAgICAgICAgICAgLy8gaW4gX2NvbnN1bWVMQnJhY2tldAogICAgICAgICAgICAgICAgICAgIHRva2VuID0gdGhpcy5fY29uc3VtZUxCcmFja2V0KHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJcIiIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgaWRlbnRpZmllciA9IHRoaXMuX2NvbnN1bWVRdW90ZWRJZGVudGlmaWVyKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19RVU9URURJREVOVElGSUVSLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaWRlbnRpZmllciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIiciKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICAgIGlkZW50aWZpZXIgPSB0aGlzLl9jb25zdW1lUmF3U3RyaW5nTGl0ZXJhbChzdHJlYW0pOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfTElURVJBTCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGlkZW50aWZpZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJgIikgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgICB2YXIgbGl0ZXJhbCA9IHRoaXMuX2NvbnN1bWVMaXRlcmFsKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19MSVRFUkFMLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbGl0ZXJhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yU3RhcnRUb2tlbltzdHJlYW1bdGhpcy5fY3VycmVudF1dICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh0aGlzLl9jb25zdW1lT3BlcmF0b3Ioc3RyZWFtKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNraXBDaGFyc1tzdHJlYW1bdGhpcy5fY3VycmVudF1dICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgd2hpdGVzcGFjZS4KICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIiYiKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiJiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX0FORCwgdmFsdWU6ICImJiIsIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfRVhQUkVGLCB2YWx1ZTogIiYiLCBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gInwiKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAifCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX09SLCB2YWx1ZTogInx8Iiwgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19QSVBFLCB2YWx1ZTogInwiLCBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiVW5rbm93biBjaGFyYWN0ZXI6IiArIHN0cmVhbVt0aGlzLl9jdXJyZW50XSk7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJMZXhlckVycm9yIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdG9rZW5zOwogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVVbnF1b3RlZElkZW50aWZpZXI6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHdoaWxlICh0aGlzLl9jdXJyZW50IDwgc3RyZWFtLmxlbmd0aCAmJiBpc0FscGhhTnVtKHN0cmVhbVt0aGlzLl9jdXJyZW50XSkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RyZWFtLnNsaWNlKHN0YXJ0LCB0aGlzLl9jdXJyZW50KTsKICAgICAgICB9LAogIAogICAgICAgIF9jb25zdW1lUXVvdGVkSWRlbnRpZmllcjogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgdmFyIG1heExlbmd0aCA9IHN0cmVhbS5sZW5ndGg7CiAgICAgICAgICAgIHdoaWxlIChzdHJlYW1bdGhpcy5fY3VycmVudF0gIT09ICJcIiIgJiYgdGhpcy5fY3VycmVudCA8IG1heExlbmd0aCkgewogICAgICAgICAgICAgICAgLy8gWW91IGNhbiBlc2NhcGUgYSBkb3VibGUgcXVvdGUgYW5kIHlvdSBjYW4gZXNjYXBlIGFuIGVzY2FwZS4KICAgICAgICAgICAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bY3VycmVudF0gPT09ICJcXCIgJiYgKHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICJcXCIgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICJcIiIpKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCArPSAyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50ID0gY3VycmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHN0cmVhbS5zbGljZShzdGFydCwgdGhpcy5fY3VycmVudCkpOwogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVSYXdTdHJpbmdMaXRlcmFsOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICB2YXIgbWF4TGVuZ3RoID0gc3RyZWFtLmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSAhPT0gIiciICYmIHRoaXMuX2N1cnJlbnQgPCBtYXhMZW5ndGgpIHsKICAgICAgICAgICAgICAgIC8vIFlvdSBjYW4gZXNjYXBlIGEgc2luZ2xlIHF1b3RlIGFuZCB5b3UgY2FuIGVzY2FwZSBhbiBlc2NhcGUuCiAgICAgICAgICAgICAgICB2YXIgY3VycmVudCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW2N1cnJlbnRdID09PSAiXFwiICYmIChzdHJlYW1bY3VycmVudCArIDFdID09PSAiXFwiIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW1bY3VycmVudCArIDFdID09PSAiJyIpKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCArPSAyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50ID0gY3VycmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHZhciBsaXRlcmFsID0gc3RyZWFtLnNsaWNlKHN0YXJ0ICsgMSwgdGhpcy5fY3VycmVudCAtIDEpOwogICAgICAgICAgICByZXR1cm4gbGl0ZXJhbC5yZXBsYWNlKCJcXCciLCAiJyIpOwogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVOdW1iZXI6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHZhciBtYXhMZW5ndGggPSBzdHJlYW0ubGVuZ3RoOwogICAgICAgICAgICB3aGlsZSAoaXNOdW0oc3RyZWFtW3RoaXMuX2N1cnJlbnRdKSAmJiB0aGlzLl9jdXJyZW50IDwgbWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHZhbHVlID0gcGFyc2VJbnQoc3RyZWFtLnNsaWNlKHN0YXJ0LCB0aGlzLl9jdXJyZW50KSk7CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX05VTUJFUiwgdmFsdWU6IHZhbHVlLCBzdGFydDogc3RhcnR9OwogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVMQnJhY2tldDogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIj8iKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19GSUxURVIsIHZhbHVlOiAiWz8iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIl0iKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19GTEFUVEVOLCB2YWx1ZTogIltdIiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0xCUkFDS0VULCB2YWx1ZTogIlsiLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBfY29uc3VtZU9wZXJhdG9yOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgdmFyIHN0YXJ0aW5nQ2hhciA9IHN0cmVhbVtzdGFydF07CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgaWYgKHN0YXJ0aW5nQ2hhciA9PT0gIiEiKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiPSIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTkUsIHZhbHVlOiAiIT0iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTk9ULCB2YWx1ZTogIiEiLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0aW5nQ2hhciA9PT0gIjwiKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiPSIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTFRFLCB2YWx1ZTogIjw9Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTFQsIHZhbHVlOiAiPCIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnRpbmdDaGFyID09PSAiPiIpIHsKICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICI9IikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19HVEUsIHZhbHVlOiAiPj0iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19HVCwgdmFsdWU6ICI+Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFydGluZ0NoYXIgPT09ICI9IikgewogICAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIj0iKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0VRLCB2YWx1ZTogIj09Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVMaXRlcmFsOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICB2YXIgbWF4TGVuZ3RoID0gc3RyZWFtLmxlbmd0aDsKICAgICAgICAgICAgdmFyIGxpdGVyYWw7CiAgICAgICAgICAgIHdoaWxlKHN0cmVhbVt0aGlzLl9jdXJyZW50XSAhPT0gImAiICYmIHRoaXMuX2N1cnJlbnQgPCBtYXhMZW5ndGgpIHsKICAgICAgICAgICAgICAgIC8vIFlvdSBjYW4gZXNjYXBlIGEgbGl0ZXJhbCBjaGFyIG9yIHlvdSBjYW4gZXNjYXBlIHRoZSBlc2NhcGUuCiAgICAgICAgICAgICAgICB2YXIgY3VycmVudCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW2N1cnJlbnRdID09PSAiXFwiICYmIChzdHJlYW1bY3VycmVudCArIDFdID09PSAiXFwiIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW1bY3VycmVudCArIDFdID09PSAiYCIpKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCArPSAyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50ID0gY3VycmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbGl0ZXJhbFN0cmluZyA9IHRyaW1MZWZ0KHN0cmVhbS5zbGljZShzdGFydCwgdGhpcy5fY3VycmVudCkpOwogICAgICAgICAgICBsaXRlcmFsU3RyaW5nID0gbGl0ZXJhbFN0cmluZy5yZXBsYWNlKCJcXGAiLCAiYCIpOwogICAgICAgICAgICBpZiAodGhpcy5fbG9va3NMaWtlSlNPTihsaXRlcmFsU3RyaW5nKSkgewogICAgICAgICAgICAgICAgbGl0ZXJhbCA9IEpTT04ucGFyc2UobGl0ZXJhbFN0cmluZyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBUcnkgdG8gSlNPTiBwYXJzZSBpdCBhcyAiPGxpdGVyYWw+IgogICAgICAgICAgICAgICAgbGl0ZXJhbCA9IEpTT04ucGFyc2UoIlwiIiArIGxpdGVyYWxTdHJpbmcgKyAiXCIiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyArMSBnZXRzIHVzIHRvIHRoZSBlbmRpbmcgImAiLCArMSB0byBtb3ZlIG9uIHRvIHRoZSBuZXh0IGNoYXIuCiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgcmV0dXJuIGxpdGVyYWw7CiAgICAgICAgfSwKICAKICAgICAgICBfbG9va3NMaWtlSlNPTjogZnVuY3Rpb24obGl0ZXJhbFN0cmluZykgewogICAgICAgICAgICB2YXIgc3RhcnRpbmdDaGFycyA9ICJbe1wiIjsKICAgICAgICAgICAgdmFyIGpzb25MaXRlcmFscyA9IFsidHJ1ZSIsICJmYWxzZSIsICJudWxsIl07CiAgICAgICAgICAgIHZhciBudW1iZXJMb29raW5nID0gIi0wMTIzNDU2Nzg5IjsKICAKICAgICAgICAgICAgaWYgKGxpdGVyYWxTdHJpbmcgPT09ICIiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnRpbmdDaGFycy5pbmRleE9mKGxpdGVyYWxTdHJpbmdbMF0pID49IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGpzb25MaXRlcmFscy5pbmRleE9mKGxpdGVyYWxTdHJpbmcpID49IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKG51bWJlckxvb2tpbmcuaW5kZXhPZihsaXRlcmFsU3RyaW5nWzBdKSA+PSAwKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIEpTT04ucGFyc2UobGl0ZXJhbFN0cmluZyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgCiAgICAgICAgdmFyIGJpbmRpbmdQb3dlciA9IHt9OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfRU9GXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19VTlFVT1RFRElERU5USUZJRVJdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX1FVT1RFRElERU5USUZJRVJdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX1JCUkFDS0VUXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19SUEFSRU5dID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0NPTU1BXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19SQlJBQ0VdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX05VTUJFUl0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfQ1VSUkVOVF0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfRVhQUkVGXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19QSVBFXSA9IDE7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19PUl0gPSAyOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfQU5EXSA9IDM7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19FUV0gPSA1OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfR1RdID0gNTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0xUXSA9IDU7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19HVEVdID0gNTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0xURV0gPSA1OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfTkVdID0gNTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0ZMQVRURU5dID0gOTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX1NUQVJdID0gMjA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19GSUxURVJdID0gMjE7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19ET1RdID0gNDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19OT1RdID0gNDU7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19MQlJBQ0VdID0gNTA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19MQlJBQ0tFVF0gPSA1NTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0xQQVJFTl0gPSA2MDsKICAKICAgIGZ1bmN0aW9uIFBhcnNlcigpIHsKICAgIH0KICAKICAgIFBhcnNlci5wcm90b3R5cGUgPSB7CiAgICAgICAgcGFyc2U6IGZ1bmN0aW9uKGV4cHJlc3Npb24pIHsKICAgICAgICAgICAgdGhpcy5fbG9hZFRva2VucyhleHByZXNzaW9uKTsKICAgICAgICAgICAgdGhpcy5pbmRleCA9IDA7CiAgICAgICAgICAgIHZhciBhc3QgPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgIT09IFRPS19FT0YpIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoCiAgICAgICAgICAgICAgICAgICAgIlVuZXhwZWN0ZWQgdG9rZW4gdHlwZTogIiArIHQudHlwZSArICIsIHZhbHVlOiAiICsgdC52YWx1ZSk7CiAgICAgICAgICAgICAgICBlcnJvci5uYW1lID0gIlBhcnNlckVycm9yIjsKICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhc3Q7CiAgICAgICAgfSwKICAKICAgICAgICBfbG9hZFRva2VuczogZnVuY3Rpb24oZXhwcmVzc2lvbikgewogICAgICAgICAgICB2YXIgbGV4ZXIgPSBuZXcgTGV4ZXIoKTsKICAgICAgICAgICAgdmFyIHRva2VucyA9IGxleGVyLnRva2VuaXplKGV4cHJlc3Npb24pOwogICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX0VPRiwgdmFsdWU6ICIiLCBzdGFydDogZXhwcmVzc2lvbi5sZW5ndGh9KTsKICAgICAgICAgICAgdGhpcy50b2tlbnMgPSB0b2tlbnM7CiAgICAgICAgfSwKICAKICAgICAgICBleHByZXNzaW9uOiBmdW5jdGlvbihyYnApIHsKICAgICAgICAgICAgdmFyIGxlZnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gdGhpcy5udWQobGVmdFRva2VuKTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgICAgd2hpbGUgKHJicCA8IGJpbmRpbmdQb3dlcltjdXJyZW50VG9rZW5dKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICBsZWZ0ID0gdGhpcy5sZWQoY3VycmVudFRva2VuLCBsZWZ0KTsKICAgICAgICAgICAgICAgIGN1cnJlbnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGVmdDsKICAgICAgICB9LAogIAogICAgICAgIF9sb29rYWhlYWQ6IGZ1bmN0aW9uKG51bWJlcikgewogICAgICAgICAgICByZXR1cm4gdGhpcy50b2tlbnNbdGhpcy5pbmRleCArIG51bWJlcl0udHlwZTsKICAgICAgICB9LAogIAogICAgICAgIF9sb29rYWhlYWRUb2tlbjogZnVuY3Rpb24obnVtYmVyKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRva2Vuc1t0aGlzLmluZGV4ICsgbnVtYmVyXTsKICAgICAgICB9LAogIAogICAgICAgIF9hZHZhbmNlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5pbmRleCsrOwogICAgICAgIH0sCiAgCiAgICAgICAgbnVkOiBmdW5jdGlvbih0b2tlbikgewogICAgICAgICAgdmFyIGxlZnQ7CiAgICAgICAgICB2YXIgcmlnaHQ7CiAgICAgICAgICB2YXIgZXhwcmVzc2lvbjsKICAgICAgICAgIHN3aXRjaCAodG9rZW4udHlwZSkgewogICAgICAgICAgICBjYXNlIFRPS19MSVRFUkFMOgogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIkxpdGVyYWwiLCB2YWx1ZTogdG9rZW4udmFsdWV9OwogICAgICAgICAgICBjYXNlIFRPS19VTlFVT1RFRElERU5USUZJRVI6CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiRmllbGQiLCBuYW1lOiB0b2tlbi52YWx1ZX07CiAgICAgICAgICAgIGNhc2UgVE9LX1FVT1RFRElERU5USUZJRVI6CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSB7dHlwZTogIkZpZWxkIiwgbmFtZTogdG9rZW4udmFsdWV9OwogICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19MUEFSRU4pIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJRdW90ZWQgaWRlbnRpZmllciBub3QgYWxsb3dlZCBmb3IgZnVuY3Rpb24gbmFtZXMuIik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRPS19OT1Q6CiAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyLk5vdCk7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiTm90RXhwcmVzc2lvbiIsIGNoaWxkcmVuOiBbcmlnaHRdfTsKICAgICAgICAgICAgY2FzZSBUT0tfU1RBUjoKICAgICAgICAgICAgICBsZWZ0ID0ge3R5cGU6ICJJZGVudGl0eSJ9OwogICAgICAgICAgICAgIHJpZ2h0ID0gbnVsbDsKICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfUkJSQUNLRVQpIHsKICAgICAgICAgICAgICAgICAgLy8gVGhpcyBjYW4gaGFwcGVuIGluIGEgbXVsdGlzZWxlY3QsCiAgICAgICAgICAgICAgICAgIC8vIFthLCBiLCAqXQogICAgICAgICAgICAgICAgICByaWdodCA9IHt0eXBlOiAiSWRlbnRpdHkifTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuU3Rhcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlZhbHVlUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgY2FzZSBUT0tfRklMVEVSOgogICAgICAgICAgICAgIHJldHVybiB0aGlzLmxlZCh0b2tlbi50eXBlLCB7dHlwZTogIklkZW50aXR5In0pOwogICAgICAgICAgICBjYXNlIFRPS19MQlJBQ0U6CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlTXVsdGlzZWxlY3RIYXNoKCk7CiAgICAgICAgICAgIGNhc2UgVE9LX0ZMQVRURU46CiAgICAgICAgICAgICAgbGVmdCA9IHt0eXBlOiBUT0tfRkxBVFRFTiwgY2hpbGRyZW46IFt7dHlwZTogIklkZW50aXR5In1dfTsKICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuRmxhdHRlbik7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgY2FzZSBUT0tfTEJSQUNLRVQ6CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX05VTUJFUiB8fCB0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DT0xPTikgewogICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlSW5kZXhFeHByZXNzaW9uKCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wcm9qZWN0SWZTbGljZSh7dHlwZTogIklkZW50aXR5In0sIHJpZ2h0KTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX1NUQVIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvb2thaGVhZCgxKSA9PT0gVE9LX1JCUkFDS0VUKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuU3Rhcik7CiAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlByb2plY3Rpb24iLAogICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbe3R5cGU6ICJJZGVudGl0eSJ9LCByaWdodF19OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZU11bHRpc2VsZWN0TGlzdCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUT0tfQ1VSUkVOVDoKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19DVVJSRU5UfTsKICAgICAgICAgICAgY2FzZSBUT0tfRVhQUkVGOgogICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyLkV4cHJlZik7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiRXhwcmVzc2lvblJlZmVyZW5jZSIsIGNoaWxkcmVuOiBbZXhwcmVzc2lvbl19OwogICAgICAgICAgICBjYXNlIFRPS19MUEFSRU46CiAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgICB3aGlsZSAodGhpcy5fbG9va2FoZWFkKDApICE9PSBUT0tfUlBBUkVOKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ1VSUkVOVCkgewogICAgICAgICAgICAgICAgICBleHByZXNzaW9uID0ge3R5cGU6IFRPS19DVVJSRU5UfTsKICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGFyZ3MucHVzaChleHByZXNzaW9uKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JQQVJFTik7CiAgICAgICAgICAgICAgcmV0dXJuIGFyZ3NbMF07CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGhpcy5fZXJyb3JUb2tlbih0b2tlbik7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBsZWQ6IGZ1bmN0aW9uKHRva2VuTmFtZSwgbGVmdCkgewogICAgICAgICAgdmFyIHJpZ2h0OwogICAgICAgICAgc3dpdGNoKHRva2VuTmFtZSkgewogICAgICAgICAgICBjYXNlIFRPS19ET1Q6CiAgICAgICAgICAgICAgdmFyIHJicCA9IGJpbmRpbmdQb3dlci5Eb3Q7CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSAhPT0gVE9LX1NUQVIpIHsKICAgICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZURvdFJIUyhyYnApOwogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJTdWJleHByZXNzaW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIC8vIENyZWF0aW5nIGEgcHJvamVjdGlvbi4KICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhyYnApOwogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJWYWx1ZVByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRPS19QSVBFOgogICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlci5QaXBlKTsKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19QSVBFLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgIGNhc2UgVE9LX09SOgogICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlci5Pcik7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiT3JFeHByZXNzaW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICBjYXNlIFRPS19BTkQ6CiAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyLkFuZCk7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiQW5kRXhwcmVzc2lvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgY2FzZSBUT0tfTFBBUkVOOgogICAgICAgICAgICAgIHZhciBuYW1lID0gbGVmdC5uYW1lOwogICAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgICAgdmFyIGV4cHJlc3Npb24sIG5vZGU7CiAgICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2xvb2thaGVhZCgwKSAhPT0gVE9LX1JQQVJFTikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NVUlJFTlQpIHsKICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHt0eXBlOiBUT0tfQ1VSUkVOVH07CiAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ09NTUEpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0NPTU1BKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGFyZ3MucHVzaChleHByZXNzaW9uKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JQQVJFTik7CiAgICAgICAgICAgICAgbm9kZSA9IHt0eXBlOiAiRnVuY3Rpb24iLCBuYW1lOiBuYW1lLCBjaGlsZHJlbjogYXJnc307CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgIGNhc2UgVE9LX0ZJTFRFUjoKICAgICAgICAgICAgICB2YXIgY29uZGl0aW9uID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0tFVCk7CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0ZMQVRURU4pIHsKICAgICAgICAgICAgICAgIHJpZ2h0ID0ge3R5cGU6ICJJZGVudGl0eSJ9OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuRmlsdGVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiRmlsdGVyUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHQsIGNvbmRpdGlvbl19OwogICAgICAgICAgICBjYXNlIFRPS19GTEFUVEVOOgogICAgICAgICAgICAgIHZhciBsZWZ0Tm9kZSA9IHt0eXBlOiBUT0tfRkxBVFRFTiwgY2hpbGRyZW46IFtsZWZ0XX07CiAgICAgICAgICAgICAgdmFyIHJpZ2h0Tm9kZSA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuRmxhdHRlbik7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdE5vZGUsIHJpZ2h0Tm9kZV19OwogICAgICAgICAgICBjYXNlIFRPS19FUToKICAgICAgICAgICAgY2FzZSBUT0tfTkU6CiAgICAgICAgICAgIGNhc2UgVE9LX0dUOgogICAgICAgICAgICBjYXNlIFRPS19HVEU6CiAgICAgICAgICAgIGNhc2UgVE9LX0xUOgogICAgICAgICAgICBjYXNlIFRPS19MVEU6CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlQ29tcGFyYXRvcihsZWZ0LCB0b2tlbk5hbWUpOwogICAgICAgICAgICBjYXNlIFRPS19MQlJBQ0tFVDoKICAgICAgICAgICAgICB2YXIgdG9rZW4gPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgICBpZiAodG9rZW4udHlwZSA9PT0gVE9LX05VTUJFUiB8fCB0b2tlbi50eXBlID09PSBUT0tfQ09MT04pIHsKICAgICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZUluZGV4RXhwcmVzc2lvbigpOwogICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcHJvamVjdElmU2xpY2UobGVmdCwgcmlnaHQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19TVEFSKTsKICAgICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDS0VUKTsKICAgICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLlN0YXIpOwogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aGlzLl9lcnJvclRva2VuKHRoaXMuX2xvb2thaGVhZFRva2VuKDApKTsKICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIF9tYXRjaDogZnVuY3Rpb24odG9rZW5UeXBlKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IHRva2VuVHlwZSkgewogICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiRXhwZWN0ZWQgIiArIHRva2VuVHlwZSArICIsIGdvdDogIiArIHQudHlwZSk7CiAgICAgICAgICAgICAgICBlcnJvci5uYW1lID0gIlBhcnNlckVycm9yIjsKICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBfZXJyb3JUb2tlbjogZnVuY3Rpb24odG9rZW4pIHsKICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJJbnZhbGlkIHRva2VuICgiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuLnR5cGUgKyAiKTogXCIiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuLnZhbHVlICsgIlwiIik7CiAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiUGFyc2VyRXJyb3IiOwogICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9LAogIAogIAogICAgICAgIF9wYXJzZUluZGV4RXhwcmVzc2lvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DT0xPTiB8fCB0aGlzLl9sb29rYWhlYWQoMSkgPT09IFRPS19DT0xPTikgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlU2xpY2VFeHByZXNzaW9uKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAiSW5kZXgiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiB0aGlzLl9sb29rYWhlYWRUb2tlbigwKS52YWx1ZX07CiAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNLRVQpOwogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIF9wcm9qZWN0SWZTbGljZTogZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICAgICAgdmFyIGluZGV4RXhwciA9IHt0eXBlOiAiSW5kZXhFeHByZXNzaW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICBpZiAocmlnaHQudHlwZSA9PT0gIlNsaWNlIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAiUHJvamVjdGlvbiIsCiAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFtpbmRleEV4cHIsIHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuU3RhcildCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGluZGV4RXhwcjsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgX3BhcnNlU2xpY2VFeHByZXNzaW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gW3N0YXJ0OmVuZDpzdGVwXSB3aGVyZSBlYWNoIHBhcnQgaXMgb3B0aW9uYWwsIGFzIHdlbGwgYXMgdGhlIGxhc3QKICAgICAgICAgICAgLy8gY29sb24uCiAgICAgICAgICAgIHZhciBwYXJ0cyA9IFtudWxsLCBudWxsLCBudWxsXTsKICAgICAgICAgICAgdmFyIGluZGV4ID0gMDsKICAgICAgICAgICAgdmFyIGN1cnJlbnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnRUb2tlbiAhPT0gVE9LX1JCUkFDS0VUICYmIGluZGV4IDwgMykgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUb2tlbiA9PT0gVE9LX0NPTE9OKSB7CiAgICAgICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnRUb2tlbiA9PT0gVE9LX05VTUJFUikgewogICAgICAgICAgICAgICAgICAgIHBhcnRzW2luZGV4XSA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJTeW50YXggZXJyb3IsIHVuZXhwZWN0ZWQgdG9rZW46ICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnZhbHVlICsgIigiICsgdC50eXBlICsgIikiKTsKICAgICAgICAgICAgICAgICAgICBlcnJvci5uYW1lID0gIlBhcnNlcmVycm9yIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNLRVQpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdHlwZTogIlNsaWNlIiwKICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBwYXJ0cwogICAgICAgICAgICB9OwogICAgICAgIH0sCiAgCiAgICAgICAgX3BhcnNlQ29tcGFyYXRvcjogZnVuY3Rpb24obGVmdCwgY29tcGFyYXRvcikgewogICAgICAgICAgdmFyIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlcltjb21wYXJhdG9yXSk7CiAgICAgICAgICByZXR1cm4ge3R5cGU6ICJDb21wYXJhdG9yIiwgbmFtZTogY29tcGFyYXRvciwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgIH0sCiAgCiAgICAgICAgX3BhcnNlRG90UkhTOiBmdW5jdGlvbihyYnApIHsKICAgICAgICAgICAgdmFyIGxvb2thaGVhZCA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgICAgdmFyIGV4cHJUb2tlbnMgPSBbVE9LX1VOUVVPVEVESURFTlRJRklFUiwgVE9LX1FVT1RFRElERU5USUZJRVIsIFRPS19TVEFSXTsKICAgICAgICAgICAgaWYgKGV4cHJUb2tlbnMuaW5kZXhPZihsb29rYWhlYWQpID49IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmV4cHJlc3Npb24ocmJwKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChsb29rYWhlYWQgPT09IFRPS19MQlJBQ0tFVCkgewogICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0xCUkFDS0VUKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZU11bHRpc2VsZWN0TGlzdCgpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGxvb2thaGVhZCA9PT0gVE9LX0xCUkFDRSkgewogICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0xCUkFDRSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VNdWx0aXNlbGVjdEhhc2goKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgX3BhcnNlUHJvamVjdGlvblJIUzogZnVuY3Rpb24ocmJwKSB7CiAgICAgICAgICAgIHZhciByaWdodDsKICAgICAgICAgICAgaWYgKGJpbmRpbmdQb3dlclt0aGlzLl9sb29rYWhlYWQoMCldIDwgMTApIHsKICAgICAgICAgICAgICAgIHJpZ2h0ID0ge3R5cGU6ICJJZGVudGl0eSJ9OwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0xCUkFDS0VUKSB7CiAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihyYnApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0ZJTFRFUikgewogICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24ocmJwKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19ET1QpIHsKICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19ET1QpOwogICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZURvdFJIUyhyYnApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiU3l0YW54IGVycm9yLCB1bmV4cGVjdGVkIHRva2VuOiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnZhbHVlICsgIigiICsgdC50eXBlICsgIikiKTsKICAgICAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiUGFyc2VyRXJyb3IiOwogICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJpZ2h0OwogICAgICAgIH0sCiAgCiAgICAgICAgX3BhcnNlTXVsdGlzZWxlY3RMaXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGV4cHJlc3Npb25zID0gW107CiAgICAgICAgICAgIHdoaWxlICh0aGlzLl9sb29rYWhlYWQoMCkgIT09IFRPS19SQlJBQ0tFVCkgewogICAgICAgICAgICAgICAgdmFyIGV4cHJlc3Npb24gPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgICAgICBleHByZXNzaW9ucy5wdXNoKGV4cHJlc3Npb24pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NPTU1BKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0NPTU1BKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfUkJSQUNLRVQpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCB0b2tlbiBSYnJhY2tldCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNLRVQpOwogICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJNdWx0aVNlbGVjdExpc3QiLCBjaGlsZHJlbjogZXhwcmVzc2lvbnN9OwogICAgICAgIH0sCiAgCiAgICAgICAgX3BhcnNlTXVsdGlzZWxlY3RIYXNoOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBwYWlycyA9IFtdOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJUeXBlcyA9IFtUT0tfVU5RVU9URURJREVOVElGSUVSLCBUT0tfUVVPVEVESURFTlRJRklFUl07CiAgICAgICAgICB2YXIga2V5VG9rZW4sIGtleU5hbWUsIHZhbHVlLCBub2RlOwogICAgICAgICAgZm9yICg7OykgewogICAgICAgICAgICBrZXlUb2tlbiA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgICBpZiAoaWRlbnRpZmllclR5cGVzLmluZGV4T2Yoa2V5VG9rZW4udHlwZSkgPCAwKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RpbmcgYW4gaWRlbnRpZmllciB0b2tlbiwgZ290OiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5VG9rZW4udHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAga2V5TmFtZSA9IGtleVRva2VuLnZhbHVlOwogICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19DT0xPTik7CiAgICAgICAgICAgIHZhbHVlID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgICBub2RlID0ge3R5cGU6ICJLZXlWYWx1ZVBhaXIiLCBuYW1lOiBrZXlOYW1lLCB2YWx1ZTogdmFsdWV9OwogICAgICAgICAgICBwYWlycy5wdXNoKG5vZGUpOwogICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ09NTUEpIHsKICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfQ09NTUEpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX1JCUkFDRSkgewogICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0UpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4ge3R5cGU6ICJNdWx0aVNlbGVjdEhhc2giLCBjaGlsZHJlbjogcGFpcnN9OwogICAgICAgIH0KICAgIH07CiAgCiAgCiAgICBmdW5jdGlvbiBUcmVlSW50ZXJwcmV0ZXIocnVudGltZSkgewogICAgICB0aGlzLnJ1bnRpbWUgPSBydW50aW1lOwogICAgfQogIAogICAgVHJlZUludGVycHJldGVyLnByb3RvdHlwZSA9IHsKICAgICAgICBzZWFyY2g6IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnZpc2l0KG5vZGUsIHZhbHVlKTsKICAgICAgICB9LAogIAogICAgICAgIHZpc2l0OiBmdW5jdGlvbihub2RlLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgbWF0Y2hlZCwgY3VycmVudCwgcmVzdWx0LCBmaXJzdCwgc2Vjb25kLCBmaWVsZCwgbGVmdCwgcmlnaHQsIGNvbGxlY3RlZCwgaTsKICAgICAgICAgICAgc3dpdGNoIChub2RlLnR5cGUpIHsKICAgICAgICAgICAgICBjYXNlICJGaWVsZCI6CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIGZpZWxkID0gdmFsdWVbbm9kZS5uYW1lXTsKICAgICAgICAgICAgICAgICAgICBpZiAoZmllbGQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmllbGQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJTdWJleHByZXNzaW9uIjoKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgZm9yIChpID0gMTsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIHJlc3VsdCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgIGNhc2UgIkluZGV4RXhwcmVzc2lvbiI6CiAgICAgICAgICAgICAgICBsZWZ0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgbGVmdCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmlnaHQ7CiAgICAgICAgICAgICAgY2FzZSAiSW5kZXgiOgogICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IG5vZGUudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgICAgICAgIGluZGV4ID0gdmFsdWUubGVuZ3RoICsgaW5kZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXN1bHQgPSB2YWx1ZVtpbmRleF07CiAgICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgICAgY2FzZSAiU2xpY2UiOgogICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBzbGljZVBhcmFtcyA9IG5vZGUuY2hpbGRyZW4uc2xpY2UoMCk7CiAgICAgICAgICAgICAgICB2YXIgY29tcHV0ZWQgPSB0aGlzLmNvbXB1dGVTbGljZVBhcmFtcyh2YWx1ZS5sZW5ndGgsIHNsaWNlUGFyYW1zKTsKICAgICAgICAgICAgICAgIHZhciBzdGFydCA9IGNvbXB1dGVkWzBdOwogICAgICAgICAgICAgICAgdmFyIHN0b3AgPSBjb21wdXRlZFsxXTsKICAgICAgICAgICAgICAgIHZhciBzdGVwID0gY29tcHV0ZWRbMl07CiAgICAgICAgICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICAgICAgICAgIGlmIChzdGVwID4gMCkgewogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IHN0YXJ0OyBpIDwgc3RvcDsgaSArPSBzdGVwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IHN0YXJ0OyBpID4gc3RvcDsgaSArPSBzdGVwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgIGNhc2UgIlByb2plY3Rpb24iOgogICAgICAgICAgICAgICAgLy8gRXZhbHVhdGUgbGVmdCBjaGlsZC4KICAgICAgICAgICAgICAgIHZhciBiYXNlID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkoYmFzZSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb2xsZWN0ZWQgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBiYXNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIGJhc2VbaV0pOwogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbGxlY3RlZC5wdXNoKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gY29sbGVjdGVkOwogICAgICAgICAgICAgIGNhc2UgIlZhbHVlUHJvamVjdGlvbiI6CiAgICAgICAgICAgICAgICAvLyBFdmFsdWF0ZSBsZWZ0IGNoaWxkLgogICAgICAgICAgICAgICAgYmFzZSA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKCFpc09iamVjdChiYXNlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbGxlY3RlZCA9IFtdOwogICAgICAgICAgICAgICAgdmFyIHZhbHVlcyA9IG9ialZhbHVlcyhiYXNlKTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB2YWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgdmFsdWVzW2ldKTsKICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb2xsZWN0ZWQucHVzaChjdXJyZW50KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3RlZDsKICAgICAgICAgICAgICBjYXNlICJGaWx0ZXJQcm9qZWN0aW9uIjoKICAgICAgICAgICAgICAgIGJhc2UgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIGlmICghaXNBcnJheShiYXNlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBmaWx0ZXJlZCA9IFtdOwogICAgICAgICAgICAgICAgdmFyIGZpbmFsUmVzdWx0cyA9IFtdOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGJhc2UubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgbWF0Y2hlZCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsyXSwgYmFzZVtpXSk7CiAgICAgICAgICAgICAgICAgIGlmICghaXNGYWxzZShtYXRjaGVkKSkgewogICAgICAgICAgICAgICAgICAgIGZpbHRlcmVkLnB1c2goYmFzZVtpXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZmlsdGVyZWQubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgZmlsdGVyZWRbal0pOwogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGZpbmFsUmVzdWx0cy5wdXNoKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZmluYWxSZXN1bHRzOwogICAgICAgICAgICAgIGNhc2UgIkNvbXBhcmF0b3IiOgogICAgICAgICAgICAgICAgZmlyc3QgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIHNlY29uZCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgc3dpdGNoKG5vZGUubmFtZSkgewogICAgICAgICAgICAgICAgICBjYXNlIFRPS19FUToKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBzdHJpY3REZWVwRXF1YWwoZmlyc3QsIHNlY29uZCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgVE9LX05FOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9ICFzdHJpY3REZWVwRXF1YWwoZmlyc3QsIHNlY29uZCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgVE9LX0dUOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZpcnN0ID4gc2Vjb25kOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIFRPS19HVEU6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZmlyc3QgPj0gc2Vjb25kOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIFRPS19MVDoKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBmaXJzdCA8IHNlY29uZDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBUT0tfTFRFOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZpcnN0IDw9IHNlY29uZDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gY29tcGFyYXRvcjogIiArIG5vZGUubmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgIGNhc2UgVE9LX0ZMQVRURU46CiAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWwgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIGlmICghaXNBcnJheShvcmlnaW5hbCkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgbWVyZ2VkID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgb3JpZ2luYWwubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgY3VycmVudCA9IG9yaWdpbmFsW2ldOwogICAgICAgICAgICAgICAgICBpZiAoaXNBcnJheShjdXJyZW50KSkgewogICAgICAgICAgICAgICAgICAgIG1lcmdlZC5wdXNoLmFwcGx5KG1lcmdlZCwgY3VycmVudCk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbWVyZ2VkLnB1c2goY3VycmVudCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBtZXJnZWQ7CiAgICAgICAgICAgICAgY2FzZSAiSWRlbnRpdHkiOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgIGNhc2UgIk11bHRpU2VsZWN0TGlzdCI6CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb2xsZWN0ZWQgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29sbGVjdGVkLnB1c2godGhpcy52aXNpdChub2RlLmNoaWxkcmVuW2ldLCB2YWx1ZSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3RlZDsKICAgICAgICAgICAgICBjYXNlICJNdWx0aVNlbGVjdEhhc2giOgogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29sbGVjdGVkID0ge307CiAgICAgICAgICAgICAgICB2YXIgY2hpbGQ7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBjaGlsZCA9IG5vZGUuY2hpbGRyZW5baV07CiAgICAgICAgICAgICAgICAgIGNvbGxlY3RlZFtjaGlsZC5uYW1lXSA9IHRoaXMudmlzaXQoY2hpbGQudmFsdWUsIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBjb2xsZWN0ZWQ7CiAgICAgICAgICAgICAgY2FzZSAiT3JFeHByZXNzaW9uIjoKICAgICAgICAgICAgICAgIG1hdGNoZWQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIGlmIChpc0ZhbHNlKG1hdGNoZWQpKSB7CiAgICAgICAgICAgICAgICAgICAgbWF0Y2hlZCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoZWQ7CiAgICAgICAgICAgICAgY2FzZSAiQW5kRXhwcmVzc2lvbiI6CiAgICAgICAgICAgICAgICBmaXJzdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogIAogICAgICAgICAgICAgICAgaWYgKGlzRmFsc2UoZmlyc3QpID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBmaXJzdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIHZhbHVlKTsKICAgICAgICAgICAgICBjYXNlICJOb3RFeHByZXNzaW9uIjoKICAgICAgICAgICAgICAgIGZpcnN0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gaXNGYWxzZShmaXJzdCk7CiAgICAgICAgICAgICAgY2FzZSAiTGl0ZXJhbCI6CiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS52YWx1ZTsKICAgICAgICAgICAgICBjYXNlIFRPS19QSVBFOgogICAgICAgICAgICAgICAgbGVmdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgbGVmdCk7CiAgICAgICAgICAgICAgY2FzZSBUT0tfQ1VSUkVOVDoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICBjYXNlICJGdW5jdGlvbiI6CiAgICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRBcmdzID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHJlc29sdmVkQXJncy5wdXNoKHRoaXMudmlzaXQobm9kZS5jaGlsZHJlbltpXSwgdmFsdWUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnJ1bnRpbWUuY2FsbEZ1bmN0aW9uKG5vZGUubmFtZSwgcmVzb2x2ZWRBcmdzKTsKICAgICAgICAgICAgICBjYXNlICJFeHByZXNzaW9uUmVmZXJlbmNlIjoKICAgICAgICAgICAgICAgIHZhciByZWZOb2RlID0gbm9kZS5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIC8vIFRhZyB0aGUgbm9kZSB3aXRoIGEgc3BlY2lmaWMgYXR0cmlidXRlIHNvIHRoZSB0eXBlCiAgICAgICAgICAgICAgICAvLyBjaGVja2VyIHZlcmlmeSB0aGUgdHlwZS4KICAgICAgICAgICAgICAgIHJlZk5vZGUuam1lc3BhdGhUeXBlID0gVE9LX0VYUFJFRjsKICAgICAgICAgICAgICAgIHJldHVybiByZWZOb2RlOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gbm9kZSB0eXBlOiAiICsgbm9kZS50eXBlKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgY29tcHV0ZVNsaWNlUGFyYW1zOiBmdW5jdGlvbihhcnJheUxlbmd0aCwgc2xpY2VQYXJhbXMpIHsKICAgICAgICAgIHZhciBzdGFydCA9IHNsaWNlUGFyYW1zWzBdOwogICAgICAgICAgdmFyIHN0b3AgPSBzbGljZVBhcmFtc1sxXTsKICAgICAgICAgIHZhciBzdGVwID0gc2xpY2VQYXJhbXNbMl07CiAgICAgICAgICB2YXIgY29tcHV0ZWQgPSBbbnVsbCwgbnVsbCwgbnVsbF07CiAgICAgICAgICBpZiAoc3RlcCA9PT0gbnVsbCkgewogICAgICAgICAgICBzdGVwID0gMTsKICAgICAgICAgIH0gZWxzZSBpZiAoc3RlcCA9PT0gMCkgewogICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIkludmFsaWQgc2xpY2UsIHN0ZXAgY2Fubm90IGJlIDAiKTsKICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJSdW50aW1lRXJyb3IiOwogICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGVwVmFsdWVOZWdhdGl2ZSA9IHN0ZXAgPCAwID8gdHJ1ZSA6IGZhbHNlOwogIAogICAgICAgICAgaWYgKHN0YXJ0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgc3RhcnQgPSBzdGVwVmFsdWVOZWdhdGl2ZSA/IGFycmF5TGVuZ3RoIC0gMSA6IDA7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5jYXBTbGljZVJhbmdlKGFycmF5TGVuZ3RoLCBzdGFydCwgc3RlcCk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBpZiAoc3RvcCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHN0b3AgPSBzdGVwVmFsdWVOZWdhdGl2ZSA/IC0xIDogYXJyYXlMZW5ndGg7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0b3AgPSB0aGlzLmNhcFNsaWNlUmFuZ2UoYXJyYXlMZW5ndGgsIHN0b3AsIHN0ZXApOwogICAgICAgICAgfQogICAgICAgICAgY29tcHV0ZWRbMF0gPSBzdGFydDsKICAgICAgICAgIGNvbXB1dGVkWzFdID0gc3RvcDsKICAgICAgICAgIGNvbXB1dGVkWzJdID0gc3RlcDsKICAgICAgICAgIHJldHVybiBjb21wdXRlZDsKICAgICAgICB9LAogIAogICAgICAgIGNhcFNsaWNlUmFuZ2U6IGZ1bmN0aW9uKGFycmF5TGVuZ3RoLCBhY3R1YWxWYWx1ZSwgc3RlcCkgewogICAgICAgICAgICBpZiAoYWN0dWFsVmFsdWUgPCAwKSB7CiAgICAgICAgICAgICAgICBhY3R1YWxWYWx1ZSArPSBhcnJheUxlbmd0aDsKICAgICAgICAgICAgICAgIGlmIChhY3R1YWxWYWx1ZSA8IDApIHsKICAgICAgICAgICAgICAgICAgICBhY3R1YWxWYWx1ZSA9IHN0ZXAgPCAwID8gLTEgOiAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGFjdHVhbFZhbHVlID49IGFycmF5TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBhY3R1YWxWYWx1ZSA9IHN0ZXAgPCAwID8gYXJyYXlMZW5ndGggLSAxIDogYXJyYXlMZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFjdHVhbFZhbHVlOwogICAgICAgIH0KICAKICAgIH07CiAgCiAgICBmdW5jdGlvbiBSdW50aW1lKGludGVycHJldGVyKSB7CiAgICAgIHRoaXMuX2ludGVycHJldGVyID0gaW50ZXJwcmV0ZXI7CiAgICAgIHRoaXMuZnVuY3Rpb25UYWJsZSA9IHsKICAgICAgICAgIC8vIG5hbWU6IFtmdW5jdGlvbiwgPHNpZ25hdHVyZT5dCiAgICAgICAgICAvLyBUaGUgPHNpZ25hdHVyZT4gY2FuIGJlOgogICAgICAgICAgLy8KICAgICAgICAgIC8vIHsKICAgICAgICAgIC8vICAgYXJnczogW1t0eXBlMSwgdHlwZTJdLCBbdHlwZTEsIHR5cGUyXV0sCiAgICAgICAgICAvLyAgIHZhcmlhZGljOiB0cnVlfGZhbHNlCiAgICAgICAgICAvLyB9CiAgICAgICAgICAvLwogICAgICAgICAgLy8gRWFjaCBhcmcgaW4gdGhlIGFyZyBsaXN0IGlzIGEgbGlzdCBvZiB2YWxpZCB0eXBlcwogICAgICAgICAgLy8gKGlmIHRoZSBmdW5jdGlvbiBpcyBvdmVybG9hZGVkIGFuZCBzdXBwb3J0cyBtdWx0aXBsZQogICAgICAgICAgLy8gdHlwZXMuICBJZiB0aGUgdHlwZSBpcyAiYW55IiB0aGVuIG5vIHR5cGUgY2hlY2tpbmcKICAgICAgICAgIC8vIG9jY3VycyBvbiB0aGUgYXJndW1lbnQuICBWYXJpYWRpYyBpcyBvcHRpb25hbAogICAgICAgICAgLy8gYW5kIGlmIG5vdCBwcm92aWRlZCBpcyBhc3N1bWVkIHRvIGJlIGZhbHNlLgogICAgICAgICAgYWJzOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uQWJzLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9OVU1CRVJdfV19LAogICAgICAgICAgYXZnOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uQXZnLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV9OVU1CRVJdfV19LAogICAgICAgICAgY2VpbDoge19mdW5jOiB0aGlzLl9mdW5jdGlvbkNlaWwsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX05VTUJFUl19XX0sCiAgICAgICAgICBjb250YWluczogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbkNvbnRhaW5zLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX1NUUklORywgVFlQRV9BUlJBWV19LAogICAgICAgICAgICAgICAgICAgICAgICAgIHt0eXBlczogW1RZUEVfQU5ZXX1dfSwKICAgICAgICAgICJlbmRzX3dpdGgiOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uRW5kc1dpdGgsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfU1RSSU5HXX0sIHt0eXBlczogW1RZUEVfU1RSSU5HXX1dfSwKICAgICAgICAgIGZsb29yOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uRmxvb3IsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX05VTUJFUl19XX0sCiAgICAgICAgICBsZW5ndGg6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25MZW5ndGgsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfU1RSSU5HLCBUWVBFX0FSUkFZLCBUWVBFX09CSkVDVF19XX0sCiAgICAgICAgICBtYXA6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NYXAsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfRVhQUkVGXX0sIHt0eXBlczogW1RZUEVfQVJSQVldfV19LAogICAgICAgICAgbWF4OiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWF4LAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZX05VTUJFUiwgVFlQRV9BUlJBWV9TVFJJTkddfV19LAogICAgICAgICAgIm1lcmdlIjogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1lcmdlLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX09CSkVDVF0sIHZhcmlhZGljOiB0cnVlfV0KICAgICAgICAgIH0sCiAgICAgICAgICAibWF4X2J5IjogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NYXhCeSwKICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVldfSwge3R5cGVzOiBbVFlQRV9FWFBSRUZdfV0KICAgICAgICAgIH0sCiAgICAgICAgICBzdW06IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25TdW0sIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZX05VTUJFUl19XX0sCiAgICAgICAgICAic3RhcnRzX3dpdGgiOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uU3RhcnRzV2l0aCwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9TVFJJTkddfSwge3R5cGVzOiBbVFlQRV9TVFJJTkddfV19LAogICAgICAgICAgbWluOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWluLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZX05VTUJFUiwgVFlQRV9BUlJBWV9TVFJJTkddfV19LAogICAgICAgICAgIm1pbl9ieSI6IHsKICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWluQnksCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZXX0sIHt0eXBlczogW1RZUEVfRVhQUkVGXX1dCiAgICAgICAgICB9LAogICAgICAgICAgdHlwZToge19mdW5jOiB0aGlzLl9mdW5jdGlvblR5cGUsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FOWV19XX0sCiAgICAgICAgICBrZXlzOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uS2V5cywgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfT0JKRUNUXX1dfSwKICAgICAgICAgIHZhbHVlczoge19mdW5jOiB0aGlzLl9mdW5jdGlvblZhbHVlcywgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfT0JKRUNUXX1dfSwKICAgICAgICAgIHNvcnQ6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25Tb3J0LCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV9TVFJJTkcsIFRZUEVfQVJSQVlfTlVNQkVSXX1dfSwKICAgICAgICAgICJzb3J0X2J5IjogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25Tb3J0QnksCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZXX0sIHt0eXBlczogW1RZUEVfRVhQUkVGXX1dCiAgICAgICAgICB9LAogICAgICAgICAgam9pbjogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbkpvaW4sCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogWwogICAgICAgICAgICAgICAgICB7dHlwZXM6IFtUWVBFX1NUUklOR119LAogICAgICAgICAgICAgICAgICB7dHlwZXM6IFtUWVBFX0FSUkFZX1NUUklOR119CiAgICAgICAgICAgICAgXQogICAgICAgICAgfSwKICAgICAgICAgIHJldmVyc2U6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25SZXZlcnNlLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX1NUUklORywgVFlQRV9BUlJBWV19XX0sCiAgICAgICAgICAidG9fYXJyYXkiOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uVG9BcnJheSwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQU5ZXX1dfSwKICAgICAgICAgICJ0b19zdHJpbmciOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uVG9TdHJpbmcsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FOWV19XX0sCiAgICAgICAgICAidG9fbnVtYmVyIjoge19mdW5jOiB0aGlzLl9mdW5jdGlvblRvTnVtYmVyLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BTlldfV19LAogICAgICAgICAgIm5vdF9udWxsIjogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk5vdE51bGwsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQU5ZXSwgdmFyaWFkaWM6IHRydWV9XQogICAgICAgICAgfQogICAgICB9OwogICAgfQogIAogICAgUnVudGltZS5wcm90b3R5cGUgPSB7CiAgICAgIGNhbGxGdW5jdGlvbjogZnVuY3Rpb24obmFtZSwgcmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIGZ1bmN0aW9uRW50cnkgPSB0aGlzLmZ1bmN0aW9uVGFibGVbbmFtZV07CiAgICAgICAgaWYgKGZ1bmN0aW9uRW50cnkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gZnVuY3Rpb246ICIgKyBuYW1lICsgIigpIik7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3ZhbGlkYXRlQXJncyhuYW1lLCByZXNvbHZlZEFyZ3MsIGZ1bmN0aW9uRW50cnkuX3NpZ25hdHVyZSk7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uRW50cnkuX2Z1bmMuY2FsbCh0aGlzLCByZXNvbHZlZEFyZ3MpOwogICAgICB9LAogIAogICAgICBfdmFsaWRhdGVBcmdzOiBmdW5jdGlvbihuYW1lLCBhcmdzLCBzaWduYXR1cmUpIHsKICAgICAgICAgIC8vIFZhbGlkYXRpbmcgdGhlIGFyZ3MgcmVxdWlyZXMgdmFsaWRhdGluZwogICAgICAgICAgLy8gdGhlIGNvcnJlY3QgYXJpdHkgYW5kIHRoZSBjb3JyZWN0IHR5cGUgb2YgZWFjaCBhcmcuCiAgICAgICAgICAvLyBJZiB0aGUgbGFzdCBhcmd1bWVudCBpcyBkZWNsYXJlZCBhcyB2YXJpYWRpYywgdGhlbiB3ZSBuZWVkCiAgICAgICAgICAvLyBhIG1pbmltdW0gbnVtYmVyIG9mIGFyZ3MgdG8gYmUgcmVxdWlyZWQuICBPdGhlcndpc2UgaXQgaGFzIHRvCiAgICAgICAgICAvLyBiZSBhbiBleGFjdCBhbW91bnQuCiAgICAgICAgICB2YXIgcGx1cmFsaXplZDsKICAgICAgICAgIGlmIChzaWduYXR1cmVbc2lnbmF0dXJlLmxlbmd0aCAtIDFdLnZhcmlhZGljKSB7CiAgICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDwgc2lnbmF0dXJlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICBwbHVyYWxpemVkID0gc2lnbmF0dXJlLmxlbmd0aCA9PT0gMSA/ICIgYXJndW1lbnQiIDogIiBhcmd1bWVudHMiOwogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFyZ3VtZW50RXJyb3I6ICIgKyBuYW1lICsgIigpICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRha2VzIGF0IGxlYXN0IiArIHNpZ25hdHVyZS5sZW5ndGggKyBwbHVyYWxpemVkICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgYnV0IHJlY2VpdmVkICIgKyBhcmdzLmxlbmd0aCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChhcmdzLmxlbmd0aCAhPT0gc2lnbmF0dXJlLmxlbmd0aCkgewogICAgICAgICAgICAgIHBsdXJhbGl6ZWQgPSBzaWduYXR1cmUubGVuZ3RoID09PSAxID8gIiBhcmd1bWVudCIgOiAiIGFyZ3VtZW50cyI7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBcmd1bWVudEVycm9yOiAiICsgbmFtZSArICIoKSAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRha2VzICIgKyBzaWduYXR1cmUubGVuZ3RoICsgcGx1cmFsaXplZCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgYnV0IHJlY2VpdmVkICIgKyBhcmdzLmxlbmd0aCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudFNwZWM7CiAgICAgICAgICB2YXIgYWN0dWFsVHlwZTsKICAgICAgICAgIHZhciB0eXBlTWF0Y2hlZDsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2lnbmF0dXJlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdHlwZU1hdGNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICBjdXJyZW50U3BlYyA9IHNpZ25hdHVyZVtpXS50eXBlczsKICAgICAgICAgICAgICBhY3R1YWxUeXBlID0gdGhpcy5fZ2V0VHlwZU5hbWUoYXJnc1tpXSk7CiAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBjdXJyZW50U3BlYy5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgICBpZiAodGhpcy5fdHlwZU1hdGNoZXMoYWN0dWFsVHlwZSwgY3VycmVudFNwZWNbal0sIGFyZ3NbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlTWF0Y2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIXR5cGVNYXRjaGVkKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVHlwZUVycm9yOiAiICsgbmFtZSArICIoKSAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJleHBlY3RlZCBhcmd1bWVudCAiICsgKGkgKyAxKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIHRvIGJlIHR5cGUgIiArIGN1cnJlbnRTcGVjICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgYnV0IHJlY2VpdmVkIHR5cGUgIiArIGFjdHVhbFR5cGUgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX3R5cGVNYXRjaGVzOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBhcmdWYWx1ZSkgewogICAgICAgICAgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FOWSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FSUkFZX1NUUklORyB8fAogICAgICAgICAgICAgIGV4cGVjdGVkID09PSBUWVBFX0FSUkFZX05VTUJFUiB8fAogICAgICAgICAgICAgIGV4cGVjdGVkID09PSBUWVBFX0FSUkFZKSB7CiAgICAgICAgICAgICAgLy8gVGhlIGV4cGVjdGVkIHR5cGUgY2FuIGVpdGhlciBqdXN0IGJlIGFycmF5LAogICAgICAgICAgICAgIC8vIG9yIGl0IGNhbiByZXF1aXJlIGEgc3BlY2lmaWMgc3VidHlwZSAoYXJyYXkgb2YgbnVtYmVycykuCiAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAvLyBUaGUgc2ltcGxlc3QgY2FzZSBpcyBpZiAiYXJyYXkiIHdpdGggbm8gc3VidHlwZSBpcyBzcGVjaWZpZWQuCiAgICAgICAgICAgICAgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FSUkFZKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBhY3R1YWwgPT09IFRZUEVfQVJSQVk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChhY3R1YWwgPT09IFRZUEVfQVJSQVkpIHsKICAgICAgICAgICAgICAgICAgLy8gT3RoZXJ3aXNlIHdlIG5lZWQgdG8gY2hlY2sgc3VidHlwZXMuCiAgICAgICAgICAgICAgICAgIC8vIEkgdGhpbmsgdGhpcyBoYXMgcG90ZW50aWFsIHRvIGJlIGltcHJvdmVkLgogICAgICAgICAgICAgICAgICB2YXIgc3VidHlwZTsKICAgICAgICAgICAgICAgICAgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FSUkFZX05VTUJFUikgewogICAgICAgICAgICAgICAgICAgIHN1YnR5cGUgPSBUWVBFX05VTUJFUjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChleHBlY3RlZCA9PT0gVFlQRV9BUlJBWV9TVFJJTkcpIHsKICAgICAgICAgICAgICAgICAgICBzdWJ0eXBlID0gVFlQRV9TVFJJTkc7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdWYWx1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl90eXBlTWF0Y2hlcygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZ2V0VHlwZU5hbWUoYXJnVmFsdWVbaV0pLCBzdWJ0eXBlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ1ZhbHVlW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBhY3R1YWwgPT09IGV4cGVjdGVkOwogICAgICAgICAgfQogICAgICB9LAogICAgICBfZ2V0VHlwZU5hbWU6IGZ1bmN0aW9uKG9iaikgewogICAgICAgICAgc3dpdGNoIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSkgewogICAgICAgICAgICAgIGNhc2UgIltvYmplY3QgU3RyaW5nXSI6CiAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9TVFJJTkc7CiAgICAgICAgICAgICAgY2FzZSAiW29iamVjdCBOdW1iZXJdIjoKICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX05VTUJFUjsKICAgICAgICAgICAgICBjYXNlICJbb2JqZWN0IEFycmF5XSI6CiAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9BUlJBWTsKICAgICAgICAgICAgICBjYXNlICJbb2JqZWN0IEJvb2xlYW5dIjoKICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX0JPT0xFQU47CiAgICAgICAgICAgICAgY2FzZSAiW29iamVjdCBOdWxsXSI6CiAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9OVUxMOwogICAgICAgICAgICAgIGNhc2UgIltvYmplY3QgT2JqZWN0XSI6CiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBpdCdzIGFuIGV4cHJlZi4gIElmIGl0IGhhcywgaXQncyBiZWVuCiAgICAgICAgICAgICAgICAvLyB0YWdnZWQgd2l0aCBhIGptZXNwYXRoVHlwZSBhdHRyIG9mICdFeHByZWYnOwogICAgICAgICAgICAgICAgaWYgKG9iai5qbWVzcGF0aFR5cGUgPT09IFRPS19FWFBSRUYpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfRVhQUkVGOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfT0JKRUNUOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25TdGFydHNXaXRoOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF0ubGFzdEluZGV4T2YocmVzb2x2ZWRBcmdzWzFdKSA9PT0gMDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uRW5kc1dpdGg6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIHNlYXJjaFN0ciA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIHZhciBzdWZmaXggPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgICAgICByZXR1cm4gc2VhcmNoU3RyLmluZGV4T2Yoc3VmZml4LCBzZWFyY2hTdHIubGVuZ3RoIC0gc3VmZml4Lmxlbmd0aCkgIT09IC0xOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25SZXZlcnNlOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciB0eXBlTmFtZSA9IHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXSk7CiAgICAgICAgICBpZiAodHlwZU5hbWUgPT09IFRZUEVfU1RSSU5HKSB7CiAgICAgICAgICAgIHZhciBvcmlnaW5hbFN0ciA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgICAgdmFyIHJldmVyc2VkU3RyID0gIiI7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSBvcmlnaW5hbFN0ci5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgcmV2ZXJzZWRTdHIgKz0gb3JpZ2luYWxTdHJbaV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJldmVyc2VkU3RyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJldmVyc2VkQXJyYXkgPSByZXNvbHZlZEFyZ3NbMF0uc2xpY2UoMCk7CiAgICAgICAgICAgIHJldmVyc2VkQXJyYXkucmV2ZXJzZSgpOwogICAgICAgICAgICByZXR1cm4gcmV2ZXJzZWRBcnJheTsKICAgICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uQWJzOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICByZXR1cm4gTWF0aC5hYnMocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uQ2VpbDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICByZXR1cm4gTWF0aC5jZWlsKHJlc29sdmVkQXJnc1swXSk7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkF2ZzogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICB2YXIgc3VtID0gMDsKICAgICAgICAgIHZhciBpbnB1dEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbnB1dEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgc3VtICs9IGlucHV0QXJyYXlbaV07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3VtIC8gaW5wdXRBcnJheS5sZW5ndGg7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkNvbnRhaW5zOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF0uaW5kZXhPZihyZXNvbHZlZEFyZ3NbMV0pID49IDA7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkZsb29yOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKHJlc29sdmVkQXJnc1swXSk7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkxlbmd0aDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgIGlmICghaXNPYmplY3QocmVzb2x2ZWRBcmdzWzBdKSkgewogICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF0ubGVuZ3RoOwogICAgICAgICB9IGVsc2UgewogICAgICAgICAgIC8vIEFzIGZhciBhcyBJIGNhbiB0ZWxsLCB0aGVyZSdzIG5vIHdheSB0byBnZXQgdGhlIGxlbmd0aAogICAgICAgICAgIC8vIG9mIGFuIG9iamVjdCB3aXRob3V0IE8obikgaXRlcmF0aW9uIHRocm91Z2ggdGhlIG9iamVjdC4KICAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMocmVzb2x2ZWRBcmdzWzBdKS5sZW5ndGg7CiAgICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTWFwOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgbWFwcGVkID0gW107CiAgICAgICAgdmFyIGludGVycHJldGVyID0gdGhpcy5faW50ZXJwcmV0ZXI7CiAgICAgICAgdmFyIGV4cHJlZk5vZGUgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgdmFyIGVsZW1lbnRzID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgbWFwcGVkLnB1c2goaW50ZXJwcmV0ZXIudmlzaXQoZXhwcmVmTm9kZSwgZWxlbWVudHNbaV0pKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1hcHBlZDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTWVyZ2U6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBtZXJnZWQgPSB7fTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc29sdmVkQXJncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGN1cnJlbnQgPSByZXNvbHZlZEFyZ3NbaV07CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gY3VycmVudCkgewogICAgICAgICAgICBtZXJnZWRba2V5XSA9IGN1cnJlbnRba2V5XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lcmdlZDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTWF4OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICBpZiAocmVzb2x2ZWRBcmdzWzBdLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHZhciB0eXBlTmFtZSA9IHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXVswXSk7CiAgICAgICAgICBpZiAodHlwZU5hbWUgPT09IFRZUEVfTlVNQkVSKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLm1heC5hcHBseShNYXRoLCByZXNvbHZlZEFyZ3NbMF0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnRzID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgICB2YXIgbWF4RWxlbWVudCA9IGVsZW1lbnRzWzBdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAobWF4RWxlbWVudC5sb2NhbGVDb21wYXJlKGVsZW1lbnRzW2ldKSA8IDApIHsKICAgICAgICAgICAgICAgICAgICBtYXhFbGVtZW50ID0gZWxlbWVudHNbaV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1heEVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25NaW46IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIGlmIChyZXNvbHZlZEFyZ3NbMF0ubGVuZ3RoID4gMCkgewogICAgICAgICAgdmFyIHR5cGVOYW1lID0gdGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdWzBdKTsKICAgICAgICAgIGlmICh0eXBlTmFtZSA9PT0gVFlQRV9OVU1CRVIpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGgubWluLmFwcGx5KE1hdGgsIHJlc29sdmVkQXJnc1swXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZWxlbWVudHMgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICAgIHZhciBtaW5FbGVtZW50ID0gZWxlbWVudHNbMF07CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50c1tpXS5sb2NhbGVDb21wYXJlKG1pbkVsZW1lbnQpIDwgMCkgewogICAgICAgICAgICAgICAgICAgIG1pbkVsZW1lbnQgPSBlbGVtZW50c1tpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWluRWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25TdW06IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBzdW0gPSAwOwogICAgICAgIHZhciBsaXN0VG9TdW0gPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0VG9TdW0ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHN1bSArPSBsaXN0VG9TdW1baV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdW07CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblR5cGU6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgc3dpdGNoICh0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF0pKSB7CiAgICAgICAgICAgIGNhc2UgVFlQRV9OVU1CRVI6CiAgICAgICAgICAgICAgcmV0dXJuICJudW1iZXIiOwogICAgICAgICAgICBjYXNlIFRZUEVfU1RSSU5HOgogICAgICAgICAgICAgIHJldHVybiAic3RyaW5nIjsKICAgICAgICAgICAgY2FzZSBUWVBFX0FSUkFZOgogICAgICAgICAgICAgIHJldHVybiAiYXJyYXkiOwogICAgICAgICAgICBjYXNlIFRZUEVfT0JKRUNUOgogICAgICAgICAgICAgIHJldHVybiAib2JqZWN0IjsKICAgICAgICAgICAgY2FzZSBUWVBFX0JPT0xFQU46CiAgICAgICAgICAgICAgcmV0dXJuICJib29sZWFuIjsKICAgICAgICAgICAgY2FzZSBUWVBFX0VYUFJFRjoKICAgICAgICAgICAgICByZXR1cm4gImV4cHJlZiI7CiAgICAgICAgICAgIGNhc2UgVFlQRV9OVUxMOgogICAgICAgICAgICAgIHJldHVybiAibnVsbCI7CiAgICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbktleXM6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHJlc29sdmVkQXJnc1swXSk7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblZhbHVlczogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICB2YXIgb2JqID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvYmopOwogICAgICAgICAgdmFyIHZhbHVlcyA9IFtdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFsdWVzLnB1c2gob2JqW2tleXNbaV1dKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZXM7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkpvaW46IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIGpvaW5DaGFyID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgdmFyIGxpc3RKb2luID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgICAgcmV0dXJuIGxpc3RKb2luLmpvaW4oam9pbkNoYXIpOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Ub0FycmF5OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIGlmICh0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF0pID09PSBUWVBFX0FSUkFZKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIFtyZXNvbHZlZEFyZ3NbMF1dOwogICAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Ub1N0cmluZzogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICBpZiAodGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdKSA9PT0gVFlQRV9TVFJJTkcpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uVG9OdW1iZXI6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIHR5cGVOYW1lID0gdGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgICAgIHZhciBjb252ZXJ0ZWRWYWx1ZTsKICAgICAgICAgIGlmICh0eXBlTmFtZSA9PT0gVFlQRV9OVU1CRVIpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlTmFtZSA9PT0gVFlQRV9TVFJJTkcpIHsKICAgICAgICAgICAgICBjb252ZXJ0ZWRWYWx1ZSA9ICtyZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICAgICAgaWYgKCFpc05hTihjb252ZXJ0ZWRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnZlcnRlZFZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Ob3ROdWxsOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzb2x2ZWRBcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1tpXSkgIT09IFRZUEVfTlVMTCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzW2ldOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Tb3J0OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciBzb3J0ZWRBcnJheSA9IHJlc29sdmVkQXJnc1swXS5zbGljZSgwKTsKICAgICAgICAgIHNvcnRlZEFycmF5LnNvcnQoKTsKICAgICAgICAgIHJldHVybiBzb3J0ZWRBcnJheTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uU29ydEJ5OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciBzb3J0ZWRBcnJheSA9IHJlc29sdmVkQXJnc1swXS5zbGljZSgwKTsKICAgICAgICAgIGlmIChzb3J0ZWRBcnJheS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICByZXR1cm4gc29ydGVkQXJyYXk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW50ZXJwcmV0ZXIgPSB0aGlzLl9pbnRlcnByZXRlcjsKICAgICAgICAgIHZhciBleHByZWZOb2RlID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgICAgdmFyIHJlcXVpcmVkVHlwZSA9IHRoaXMuX2dldFR5cGVOYW1lKAogICAgICAgICAgICAgIGludGVycHJldGVyLnZpc2l0KGV4cHJlZk5vZGUsIHNvcnRlZEFycmF5WzBdKSk7CiAgICAgICAgICBpZiAoW1RZUEVfTlVNQkVSLCBUWVBFX1NUUklOR10uaW5kZXhPZihyZXF1aXJlZFR5cGUpIDwgMCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVHlwZUVycm9yIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAvLyBJbiBvcmRlciB0byBnZXQgYSBzdGFibGUgc29ydCBvdXQgb2YgYW4gdW5zdGFibGUKICAgICAgICAgIC8vIHNvcnQgYWxnb3JpdGhtLCB3ZSBkZWNvcmF0ZS9zb3J0L3VuZGVjb3JhdGUgKERTVSkKICAgICAgICAgIC8vIGJ5IGNyZWF0aW5nIGEgbmV3IGxpc3Qgb2YgW2luZGV4LCBlbGVtZW50XSBwYWlycy4KICAgICAgICAgIC8vIEluIHRoZSBjbXAgZnVuY3Rpb24sIGlmIHRoZSBldmFsdWF0ZWQgZWxlbWVudHMgYXJlCiAgICAgICAgICAvLyBlcXVhbCwgdGhlbiB0aGUgaW5kZXggd2lsbCBiZSB1c2VkIGFzIHRoZSB0aWVicmVha2VyLgogICAgICAgICAgLy8gQWZ0ZXIgdGhlIGRlY29yYXRlZCBsaXN0IGhhcyBiZWVuIHNvcnRlZCwgaXQgd2lsbCBiZQogICAgICAgICAgLy8gdW5kZWNvcmF0ZWQgdG8gZXh0cmFjdCB0aGUgb3JpZ2luYWwgZWxlbWVudHMuCiAgICAgICAgICB2YXIgZGVjb3JhdGVkID0gW107CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNvcnRlZEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGRlY29yYXRlZC5wdXNoKFtpLCBzb3J0ZWRBcnJheVtpXV0pOwogICAgICAgICAgfQogICAgICAgICAgZGVjb3JhdGVkLnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgICAgICB2YXIgZXhwckEgPSBpbnRlcnByZXRlci52aXNpdChleHByZWZOb2RlLCBhWzFdKTsKICAgICAgICAgICAgdmFyIGV4cHJCID0gaW50ZXJwcmV0ZXIudmlzaXQoZXhwcmVmTm9kZSwgYlsxXSk7CiAgICAgICAgICAgIGlmICh0aGF0Ll9nZXRUeXBlTmFtZShleHByQSkgIT09IHJlcXVpcmVkVHlwZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAgICAgICAgICJUeXBlRXJyb3I6IGV4cGVjdGVkICIgKyByZXF1aXJlZFR5cGUgKyAiLCByZWNlaXZlZCAiICsKICAgICAgICAgICAgICAgICAgICB0aGF0Ll9nZXRUeXBlTmFtZShleHByQSkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoYXQuX2dldFR5cGVOYW1lKGV4cHJCKSAhPT0gcmVxdWlyZWRUeXBlKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgICAgICAgICAgIlR5cGVFcnJvcjogZXhwZWN0ZWQgIiArIHJlcXVpcmVkVHlwZSArICIsIHJlY2VpdmVkICIgKwogICAgICAgICAgICAgICAgICAgIHRoYXQuX2dldFR5cGVOYW1lKGV4cHJCKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV4cHJBID4gZXhwckIpIHsKICAgICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgICAgfSBlbHNlIGlmIChleHByQSA8IGV4cHJCKSB7CiAgICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIElmIHRoZXkncmUgZXF1YWwgY29tcGFyZSB0aGUgaXRlbXMgYnkgdGhlaXIKICAgICAgICAgICAgICAvLyBvcmRlciB0byBtYWludGFpbiByZWxhdGl2ZSBvcmRlciBvZiBlcXVhbCBrZXlzCiAgICAgICAgICAgICAgLy8gKGkuZS4gdG8gZ2V0IGEgc3RhYmxlIHNvcnQpLgogICAgICAgICAgICAgIHJldHVybiBhWzBdIC0gYlswXTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICAvLyBVbmRlY29yYXRlOiBleHRyYWN0IG91dCB0aGUgb3JpZ2luYWwgbGlzdCBlbGVtZW50cy4KICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZGVjb3JhdGVkLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIHNvcnRlZEFycmF5W2pdID0gZGVjb3JhdGVkW2pdWzFdOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHNvcnRlZEFycmF5OwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25NYXhCeTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIGV4cHJlZk5vZGUgPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgICAgdmFyIHJlc29sdmVkQXJyYXkgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgdmFyIGtleUZ1bmN0aW9uID0gdGhpcy5jcmVhdGVLZXlGdW5jdGlvbihleHByZWZOb2RlLCBbVFlQRV9OVU1CRVIsIFRZUEVfU1RSSU5HXSk7CiAgICAgICAgdmFyIG1heE51bWJlciA9IC1JbmZpbml0eTsKICAgICAgICB2YXIgbWF4UmVjb3JkOwogICAgICAgIHZhciBjdXJyZW50OwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzb2x2ZWRBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgY3VycmVudCA9IGtleUZ1bmN0aW9uKHJlc29sdmVkQXJyYXlbaV0pOwogICAgICAgICAgaWYgKGN1cnJlbnQgPiBtYXhOdW1iZXIpIHsKICAgICAgICAgICAgbWF4TnVtYmVyID0gY3VycmVudDsKICAgICAgICAgICAgbWF4UmVjb3JkID0gcmVzb2x2ZWRBcnJheVtpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1heFJlY29yZDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTWluQnk6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBleHByZWZOb2RlID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgIHZhciByZXNvbHZlZEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgIHZhciBrZXlGdW5jdGlvbiA9IHRoaXMuY3JlYXRlS2V5RnVuY3Rpb24oZXhwcmVmTm9kZSwgW1RZUEVfTlVNQkVSLCBUWVBFX1NUUklOR10pOwogICAgICAgIHZhciBtaW5OdW1iZXIgPSBJbmZpbml0eTsKICAgICAgICB2YXIgbWluUmVjb3JkOwogICAgICAgIHZhciBjdXJyZW50OwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzb2x2ZWRBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgY3VycmVudCA9IGtleUZ1bmN0aW9uKHJlc29sdmVkQXJyYXlbaV0pOwogICAgICAgICAgaWYgKGN1cnJlbnQgPCBtaW5OdW1iZXIpIHsKICAgICAgICAgICAgbWluTnVtYmVyID0gY3VycmVudDsKICAgICAgICAgICAgbWluUmVjb3JkID0gcmVzb2x2ZWRBcnJheVtpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1pblJlY29yZDsKICAgICAgfSwKICAKICAgICAgY3JlYXRlS2V5RnVuY3Rpb246IGZ1bmN0aW9uKGV4cHJlZk5vZGUsIGFsbG93ZWRUeXBlcykgewogICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICB2YXIgaW50ZXJwcmV0ZXIgPSB0aGlzLl9pbnRlcnByZXRlcjsKICAgICAgICB2YXIga2V5RnVuYyA9IGZ1bmN0aW9uKHgpIHsKICAgICAgICAgIHZhciBjdXJyZW50ID0gaW50ZXJwcmV0ZXIudmlzaXQoZXhwcmVmTm9kZSwgeCk7CiAgICAgICAgICBpZiAoYWxsb3dlZFR5cGVzLmluZGV4T2YodGhhdC5fZ2V0VHlwZU5hbWUoY3VycmVudCkpIDwgMCkgewogICAgICAgICAgICB2YXIgbXNnID0gIlR5cGVFcnJvcjogZXhwZWN0ZWQgb25lIG9mICIgKyBhbGxvd2VkVHlwZXMgKwogICAgICAgICAgICAgICAgICAgICAgIiwgcmVjZWl2ZWQgIiArIHRoYXQuX2dldFR5cGVOYW1lKGN1cnJlbnQpOwogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjdXJyZW50OwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGtleUZ1bmM7CiAgICAgIH0KICAKICAgIH07CiAgCiAgICBmdW5jdGlvbiBjb21waWxlKHN0cmVhbSkgewogICAgICB2YXIgcGFyc2VyID0gbmV3IFBhcnNlcigpOwogICAgICB2YXIgYXN0ID0gcGFyc2VyLnBhcnNlKHN0cmVhbSk7CiAgICAgIHJldHVybiBhc3Q7CiAgICB9CiAgCiAgICBmdW5jdGlvbiB0b2tlbml6ZShzdHJlYW0pIHsKICAgICAgICB2YXIgbGV4ZXIgPSBuZXcgTGV4ZXIoKTsKICAgICAgICByZXR1cm4gbGV4ZXIudG9rZW5pemUoc3RyZWFtKTsKICAgIH0KICAKICAgIGZ1bmN0aW9uIHNlYXJjaChkYXRhLCBleHByZXNzaW9uKSB7CiAgICAgICAgdmFyIHBhcnNlciA9IG5ldyBQYXJzZXIoKTsKICAgICAgICAvLyBUaGlzIG5lZWRzIHRvIGJlIGltcHJvdmVkLiAgQm90aCB0aGUgaW50ZXJwcmV0ZXIgYW5kIHJ1bnRpbWUgZGVwZW5kIG9uCiAgICAgICAgLy8gZWFjaCBvdGhlci4gIFRoZSBydW50aW1lIG5lZWRzIHRoZSBpbnRlcnByZXRlciB0byBzdXBwb3J0IGV4cHJlZnMuCiAgICAgICAgLy8gVGhlcmUncyBsaWtlbHkgYSBjbGVhbiB3YXkgdG8gYXZvaWQgdGhlIGN5Y2xpYyBkZXBlbmRlbmN5LgogICAgICAgIHZhciBydW50aW1lID0gbmV3IFJ1bnRpbWUoKTsKICAgICAgICB2YXIgaW50ZXJwcmV0ZXIgPSBuZXcgVHJlZUludGVycHJldGVyKHJ1bnRpbWUpOwogICAgICAgIHJ1bnRpbWUuX2ludGVycHJldGVyID0gaW50ZXJwcmV0ZXI7CiAgICAgICAgdmFyIG5vZGUgPSBwYXJzZXIucGFyc2UoZXhwcmVzc2lvbik7CiAgICAgICAgcmV0dXJuIGludGVycHJldGVyLnNlYXJjaChub2RlLCBkYXRhKTsKICAgIH0KICAKICAgIGV4cG9ydHMudG9rZW5pemUgPSB0b2tlbml6ZTsKICAgIGV4cG9ydHMuY29tcGlsZSA9IGNvbXBpbGU7CiAgICBleHBvcnRzLnNlYXJjaCA9IHNlYXJjaDsKICAgIGV4cG9ydHMuc3RyaWN0RGVlcEVxdWFsID0gc3RyaWN0RGVlcEVxdWFsOwogIH0pKHR5cGVvZiBleHBvcnRzID09PSAidW5kZWZpbmVkIiA/IHRoaXMuam1lc3BhdGggPSB7fSA6IGV4cG9ydHMpOwogIAogIH0se31dLDg1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBzaGltIGZvciB1c2luZyBwcm9jZXNzIGluIGJyb3dzZXIKICB2YXIgcHJvY2VzcyA9IG1vZHVsZS5leHBvcnRzID0ge307CiAgCiAgLy8gY2FjaGVkIGZyb20gd2hhdGV2ZXIgZ2xvYmFsIGlzIHByZXNlbnQgc28gdGhhdCB0ZXN0IHJ1bm5lcnMgdGhhdCBzdHViIGl0CiAgLy8gZG9uJ3QgYnJlYWsgdGhpbmdzLiAgQnV0IHdlIG5lZWQgdG8gd3JhcCBpdCBpbiBhIHRyeSBjYXRjaCBpbiBjYXNlIGl0IGlzCiAgLy8gd3JhcHBlZCBpbiBzdHJpY3QgbW9kZSBjb2RlIHdoaWNoIGRvZXNuJ3QgZGVmaW5lIGFueSBnbG9iYWxzLiAgSXQncyBpbnNpZGUgYQogIC8vIGZ1bmN0aW9uIGJlY2F1c2UgdHJ5L2NhdGNoZXMgZGVvcHRpbWl6ZSBpbiBjZXJ0YWluIGVuZ2luZXMuCiAgCiAgdmFyIGNhY2hlZFNldFRpbWVvdXQ7CiAgdmFyIGNhY2hlZENsZWFyVGltZW91dDsKICAKICBmdW5jdGlvbiBkZWZhdWx0U2V0VGltb3V0KCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NldFRpbWVvdXQgaGFzIG5vdCBiZWVuIGRlZmluZWQnKTsKICB9CiAgZnVuY3Rpb24gZGVmYXVsdENsZWFyVGltZW91dCAoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignY2xlYXJUaW1lb3V0IGhhcyBub3QgYmVlbiBkZWZpbmVkJyk7CiAgfQogIChmdW5jdGlvbiAoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgICBpZiAodHlwZW9mIHNldFRpbWVvdXQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICBjYWNoZWRTZXRUaW1lb3V0ID0gc2V0VGltZW91dDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2FjaGVkU2V0VGltZW91dCA9IGRlZmF1bHRTZXRUaW1vdXQ7CiAgICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNhY2hlZFNldFRpbWVvdXQgPSBkZWZhdWx0U2V0VGltb3V0OwogICAgICB9CiAgICAgIHRyeSB7CiAgICAgICAgICBpZiAodHlwZW9mIGNsZWFyVGltZW91dCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgIGNhY2hlZENsZWFyVGltZW91dCA9IGNsZWFyVGltZW91dDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2FjaGVkQ2xlYXJUaW1lb3V0ID0gZGVmYXVsdENsZWFyVGltZW91dDsKICAgICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY2FjaGVkQ2xlYXJUaW1lb3V0ID0gZGVmYXVsdENsZWFyVGltZW91dDsKICAgICAgfQogIH0gKCkpCiAgZnVuY3Rpb24gcnVuVGltZW91dChmdW4pIHsKICAgICAgaWYgKGNhY2hlZFNldFRpbWVvdXQgPT09IHNldFRpbWVvdXQpIHsKICAgICAgICAgIC8vbm9ybWFsIGVudmlyb21lbnRzIGluIHNhbmUgc2l0dWF0aW9ucwogICAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuLCAwKTsKICAgICAgfQogICAgICAvLyBpZiBzZXRUaW1lb3V0IHdhc24ndCBhdmFpbGFibGUgYnV0IHdhcyBsYXR0ZXIgZGVmaW5lZAogICAgICBpZiAoKGNhY2hlZFNldFRpbWVvdXQgPT09IGRlZmF1bHRTZXRUaW1vdXQgfHwgIWNhY2hlZFNldFRpbWVvdXQpICYmIHNldFRpbWVvdXQpIHsKICAgICAgICAgIGNhY2hlZFNldFRpbWVvdXQgPSBzZXRUaW1lb3V0OwogICAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuLCAwKTsKICAgICAgfQogICAgICB0cnkgewogICAgICAgICAgLy8gd2hlbiB3aGVuIHNvbWVib2R5IGhhcyBzY3Jld2VkIHdpdGggc2V0VGltZW91dCBidXQgbm8gSS5FLiBtYWRkbmVzcwogICAgICAgICAgcmV0dXJuIGNhY2hlZFNldFRpbWVvdXQoZnVuLCAwKTsKICAgICAgfSBjYXRjaChlKXsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgLy8gV2hlbiB3ZSBhcmUgaW4gSS5FLiBidXQgdGhlIHNjcmlwdCBoYXMgYmVlbiBldmFsZWQgc28gSS5FLiBkb2Vzbid0IHRydXN0IHRoZSBnbG9iYWwgb2JqZWN0IHdoZW4gY2FsbGVkIG5vcm1hbGx5CiAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlZFNldFRpbWVvdXQuY2FsbChudWxsLCBmdW4sIDApOwogICAgICAgICAgfSBjYXRjaChlKXsKICAgICAgICAgICAgICAvLyBzYW1lIGFzIGFib3ZlIGJ1dCB3aGVuIGl0J3MgYSB2ZXJzaW9uIG9mIEkuRS4gdGhhdCBtdXN0IGhhdmUgdGhlIGdsb2JhbCBvYmplY3QgZm9yICd0aGlzJywgaG9wZnVsbHkgb3VyIGNvbnRleHQgY29ycmVjdCBvdGhlcndpc2UgaXQgd2lsbCB0aHJvdyBhIGdsb2JhbCBlcnJvcgogICAgICAgICAgICAgIHJldHVybiBjYWNoZWRTZXRUaW1lb3V0LmNhbGwodGhpcywgZnVuLCAwKTsKICAgICAgICAgIH0KICAgICAgfQogIAogIAogIH0KICBmdW5jdGlvbiBydW5DbGVhclRpbWVvdXQobWFya2VyKSB7CiAgICAgIGlmIChjYWNoZWRDbGVhclRpbWVvdXQgPT09IGNsZWFyVGltZW91dCkgewogICAgICAgICAgLy9ub3JtYWwgZW52aXJvbWVudHMgaW4gc2FuZSBzaXR1YXRpb25zCiAgICAgICAgICByZXR1cm4gY2xlYXJUaW1lb3V0KG1hcmtlcik7CiAgICAgIH0KICAgICAgLy8gaWYgY2xlYXJUaW1lb3V0IHdhc24ndCBhdmFpbGFibGUgYnV0IHdhcyBsYXR0ZXIgZGVmaW5lZAogICAgICBpZiAoKGNhY2hlZENsZWFyVGltZW91dCA9PT0gZGVmYXVsdENsZWFyVGltZW91dCB8fCAhY2FjaGVkQ2xlYXJUaW1lb3V0KSAmJiBjbGVhclRpbWVvdXQpIHsKICAgICAgICAgIGNhY2hlZENsZWFyVGltZW91dCA9IGNsZWFyVGltZW91dDsKICAgICAgICAgIHJldHVybiBjbGVhclRpbWVvdXQobWFya2VyKTsKICAgICAgfQogICAgICB0cnkgewogICAgICAgICAgLy8gd2hlbiB3aGVuIHNvbWVib2R5IGhhcyBzY3Jld2VkIHdpdGggc2V0VGltZW91dCBidXQgbm8gSS5FLiBtYWRkbmVzcwogICAgICAgICAgcmV0dXJuIGNhY2hlZENsZWFyVGltZW91dChtYXJrZXIpOwogICAgICB9IGNhdGNoIChlKXsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgLy8gV2hlbiB3ZSBhcmUgaW4gSS5FLiBidXQgdGhlIHNjcmlwdCBoYXMgYmVlbiBldmFsZWQgc28gSS5FLiBkb2Vzbid0ICB0cnVzdCB0aGUgZ2xvYmFsIG9iamVjdCB3aGVuIGNhbGxlZCBub3JtYWxseQogICAgICAgICAgICAgIHJldHVybiBjYWNoZWRDbGVhclRpbWVvdXQuY2FsbChudWxsLCBtYXJrZXIpOwogICAgICAgICAgfSBjYXRjaCAoZSl7CiAgICAgICAgICAgICAgLy8gc2FtZSBhcyBhYm92ZSBidXQgd2hlbiBpdCdzIGEgdmVyc2lvbiBvZiBJLkUuIHRoYXQgbXVzdCBoYXZlIHRoZSBnbG9iYWwgb2JqZWN0IGZvciAndGhpcycsIGhvcGZ1bGx5IG91ciBjb250ZXh0IGNvcnJlY3Qgb3RoZXJ3aXNlIGl0IHdpbGwgdGhyb3cgYSBnbG9iYWwgZXJyb3IuCiAgICAgICAgICAgICAgLy8gU29tZSB2ZXJzaW9ucyBvZiBJLkUuIGhhdmUgZGlmZmVyZW50IHJ1bGVzIGZvciBjbGVhclRpbWVvdXQgdnMgc2V0VGltZW91dAogICAgICAgICAgICAgIHJldHVybiBjYWNoZWRDbGVhclRpbWVvdXQuY2FsbCh0aGlzLCBtYXJrZXIpOwogICAgICAgICAgfQogICAgICB9CiAgCiAgCiAgCiAgfQogIHZhciBxdWV1ZSA9IFtdOwogIHZhciBkcmFpbmluZyA9IGZhbHNlOwogIHZhciBjdXJyZW50UXVldWU7CiAgdmFyIHF1ZXVlSW5kZXggPSAtMTsKICAKICBmdW5jdGlvbiBjbGVhblVwTmV4dFRpY2soKSB7CiAgICAgIGlmICghZHJhaW5pbmcgfHwgIWN1cnJlbnRRdWV1ZSkgewogICAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGRyYWluaW5nID0gZmFsc2U7CiAgICAgIGlmIChjdXJyZW50UXVldWUubGVuZ3RoKSB7CiAgICAgICAgICBxdWV1ZSA9IGN1cnJlbnRRdWV1ZS5jb25jYXQocXVldWUpOwogICAgICB9IGVsc2UgewogICAgICAgICAgcXVldWVJbmRleCA9IC0xOwogICAgICB9CiAgICAgIGlmIChxdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgIGRyYWluUXVldWUoKTsKICAgICAgfQogIH0KICAKICBmdW5jdGlvbiBkcmFpblF1ZXVlKCkgewogICAgICBpZiAoZHJhaW5pbmcpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgdGltZW91dCA9IHJ1blRpbWVvdXQoY2xlYW5VcE5leHRUaWNrKTsKICAgICAgZHJhaW5pbmcgPSB0cnVlOwogIAogICAgICB2YXIgbGVuID0gcXVldWUubGVuZ3RoOwogICAgICB3aGlsZShsZW4pIHsKICAgICAgICAgIGN1cnJlbnRRdWV1ZSA9IHF1ZXVlOwogICAgICAgICAgcXVldWUgPSBbXTsKICAgICAgICAgIHdoaWxlICgrK3F1ZXVlSW5kZXggPCBsZW4pIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudFF1ZXVlKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRRdWV1ZVtxdWV1ZUluZGV4XS5ydW4oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZUluZGV4ID0gLTE7CiAgICAgICAgICBsZW4gPSBxdWV1ZS5sZW5ndGg7CiAgICAgIH0KICAgICAgY3VycmVudFF1ZXVlID0gbnVsbDsKICAgICAgZHJhaW5pbmcgPSBmYWxzZTsKICAgICAgcnVuQ2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogIH0KICAKICBwcm9jZXNzLm5leHRUaWNrID0gZnVuY3Rpb24gKGZ1bikgewogICAgICB2YXIgYXJncyA9IG5ldyBBcnJheShhcmd1bWVudHMubGVuZ3RoIC0gMSk7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBhcmdzW2kgLSAxXSA9IGFyZ3VtZW50c1tpXTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBxdWV1ZS5wdXNoKG5ldyBJdGVtKGZ1biwgYXJncykpOwogICAgICBpZiAocXVldWUubGVuZ3RoID09PSAxICYmICFkcmFpbmluZykgewogICAgICAgICAgcnVuVGltZW91dChkcmFpblF1ZXVlKTsKICAgICAgfQogIH07CiAgCiAgLy8gdjggbGlrZXMgcHJlZGljdGlibGUgb2JqZWN0cwogIGZ1bmN0aW9uIEl0ZW0oZnVuLCBhcnJheSkgewogICAgICB0aGlzLmZ1biA9IGZ1bjsKICAgICAgdGhpcy5hcnJheSA9IGFycmF5OwogIH0KICBJdGVtLnByb3RvdHlwZS5ydW4gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuZnVuLmFwcGx5KG51bGwsIHRoaXMuYXJyYXkpOwogIH07CiAgcHJvY2Vzcy50aXRsZSA9ICdicm93c2VyJzsKICBwcm9jZXNzLmJyb3dzZXIgPSB0cnVlOwogIHByb2Nlc3MuZW52ID0ge307CiAgcHJvY2Vzcy5hcmd2ID0gW107CiAgcHJvY2Vzcy52ZXJzaW9uID0gJyc7IC8vIGVtcHR5IHN0cmluZyB0byBhdm9pZCByZWdleHAgaXNzdWVzCiAgcHJvY2Vzcy52ZXJzaW9ucyA9IHt9OwogIAogIGZ1bmN0aW9uIG5vb3AoKSB7fQogIAogIHByb2Nlc3Mub24gPSBub29wOwogIHByb2Nlc3MuYWRkTGlzdGVuZXIgPSBub29wOwogIHByb2Nlc3Mub25jZSA9IG5vb3A7CiAgcHJvY2Vzcy5vZmYgPSBub29wOwogIHByb2Nlc3MucmVtb3ZlTGlzdGVuZXIgPSBub29wOwogIHByb2Nlc3MucmVtb3ZlQWxsTGlzdGVuZXJzID0gbm9vcDsKICBwcm9jZXNzLmVtaXQgPSBub29wOwogIHByb2Nlc3MucHJlcGVuZExpc3RlbmVyID0gbm9vcDsKICBwcm9jZXNzLnByZXBlbmRPbmNlTGlzdGVuZXIgPSBub29wOwogIAogIHByb2Nlc3MubGlzdGVuZXJzID0gZnVuY3Rpb24gKG5hbWUpIHsgcmV0dXJuIFtdIH0KICAKICBwcm9jZXNzLmJpbmRpbmcgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Byb2Nlc3MuYmluZGluZyBpcyBub3Qgc3VwcG9ydGVkJyk7CiAgfTsKICAKICBwcm9jZXNzLmN3ZCA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuICcvJyB9OwogIHByb2Nlc3MuY2hkaXIgPSBmdW5jdGlvbiAoZGlyKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigncHJvY2Vzcy5jaGRpciBpcyBub3Qgc3VwcG9ydGVkJyk7CiAgfTsKICBwcm9jZXNzLnVtYXNrID0gZnVuY3Rpb24oKSB7IHJldHVybiAwOyB9OwogIAogIH0se31dLDg2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKGdsb2JhbCl7CiAgLyohIGh0dHBzOi8vbXRocy5iZS9wdW55Y29kZSB2MS4zLjIgYnkgQG1hdGhpYXMgKi8KICA7KGZ1bmN0aW9uKHJvb3QpIHsKICAKICAgIC8qKiBEZXRlY3QgZnJlZSB2YXJpYWJsZXMgKi8KICAgIHZhciBmcmVlRXhwb3J0cyA9IHR5cGVvZiBleHBvcnRzID09ICdvYmplY3QnICYmIGV4cG9ydHMgJiYKICAgICAgIWV4cG9ydHMubm9kZVR5cGUgJiYgZXhwb3J0czsKICAgIHZhciBmcmVlTW9kdWxlID0gdHlwZW9mIG1vZHVsZSA9PSAnb2JqZWN0JyAmJiBtb2R1bGUgJiYKICAgICAgIW1vZHVsZS5ub2RlVHlwZSAmJiBtb2R1bGU7CiAgICB2YXIgZnJlZUdsb2JhbCA9IHR5cGVvZiBnbG9iYWwgPT0gJ29iamVjdCcgJiYgZ2xvYmFsOwogICAgaWYgKAogICAgICBmcmVlR2xvYmFsLmdsb2JhbCA9PT0gZnJlZUdsb2JhbCB8fAogICAgICBmcmVlR2xvYmFsLndpbmRvdyA9PT0gZnJlZUdsb2JhbCB8fAogICAgICBmcmVlR2xvYmFsLnNlbGYgPT09IGZyZWVHbG9iYWwKICAgICkgewogICAgICByb290ID0gZnJlZUdsb2JhbDsKICAgIH0KICAKICAgIC8qKgogICAgICogVGhlIGBwdW55Y29kZWAgb2JqZWN0LgogICAgICogQG5hbWUgcHVueWNvZGUKICAgICAqIEB0eXBlIE9iamVjdAogICAgICovCiAgICB2YXIgcHVueWNvZGUsCiAgCiAgICAvKiogSGlnaGVzdCBwb3NpdGl2ZSBzaWduZWQgMzItYml0IGZsb2F0IHZhbHVlICovCiAgICBtYXhJbnQgPSAyMTQ3NDgzNjQ3LCAvLyBha2EuIDB4N0ZGRkZGRkYgb3IgMl4zMS0xCiAgCiAgICAvKiogQm9vdHN0cmluZyBwYXJhbWV0ZXJzICovCiAgICBiYXNlID0gMzYsCiAgICB0TWluID0gMSwKICAgIHRNYXggPSAyNiwKICAgIHNrZXcgPSAzOCwKICAgIGRhbXAgPSA3MDAsCiAgICBpbml0aWFsQmlhcyA9IDcyLAogICAgaW5pdGlhbE4gPSAxMjgsIC8vIDB4ODAKICAgIGRlbGltaXRlciA9ICctJywgLy8gJ1x4MkQnCiAgCiAgICAvKiogUmVndWxhciBleHByZXNzaW9ucyAqLwogICAgcmVnZXhQdW55Y29kZSA9IC9eeG4tLS8sCiAgICByZWdleE5vbkFTQ0lJID0gL1teXHgyMC1ceDdFXS8sIC8vIHVucHJpbnRhYmxlIEFTQ0lJIGNoYXJzICsgbm9uLUFTQ0lJIGNoYXJzCiAgICByZWdleFNlcGFyYXRvcnMgPSAvW1x4MkVcdTMwMDJcdUZGMEVcdUZGNjFdL2csIC8vIFJGQyAzNDkwIHNlcGFyYXRvcnMKICAKICAgIC8qKiBFcnJvciBtZXNzYWdlcyAqLwogICAgZXJyb3JzID0gewogICAgICAnb3ZlcmZsb3cnOiAnT3ZlcmZsb3c6IGlucHV0IG5lZWRzIHdpZGVyIGludGVnZXJzIHRvIHByb2Nlc3MnLAogICAgICAnbm90LWJhc2ljJzogJ0lsbGVnYWwgaW5wdXQgPj0gMHg4MCAobm90IGEgYmFzaWMgY29kZSBwb2ludCknLAogICAgICAnaW52YWxpZC1pbnB1dCc6ICdJbnZhbGlkIGlucHV0JwogICAgfSwKICAKICAgIC8qKiBDb252ZW5pZW5jZSBzaG9ydGN1dHMgKi8KICAgIGJhc2VNaW51c1RNaW4gPSBiYXNlIC0gdE1pbiwKICAgIGZsb29yID0gTWF0aC5mbG9vciwKICAgIHN0cmluZ0Zyb21DaGFyQ29kZSA9IFN0cmluZy5mcm9tQ2hhckNvZGUsCiAgCiAgICAvKiogVGVtcG9yYXJ5IHZhcmlhYmxlICovCiAgICBrZXk7CiAgCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICAKICAgIC8qKgogICAgICogQSBnZW5lcmljIGVycm9yIHV0aWxpdHkgZnVuY3Rpb24uCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIGVycm9yIHR5cGUuCiAgICAgKiBAcmV0dXJucyB7RXJyb3J9IFRocm93cyBhIGBSYW5nZUVycm9yYCB3aXRoIHRoZSBhcHBsaWNhYmxlIGVycm9yIG1lc3NhZ2UuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVycm9yKHR5cGUpIHsKICAgICAgdGhyb3cgUmFuZ2VFcnJvcihlcnJvcnNbdHlwZV0pOwogICAgfQogIAogICAgLyoqCiAgICAgKiBBIGdlbmVyaWMgYEFycmF5I21hcGAgdXRpbGl0eSBmdW5jdGlvbi4KICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRoYXQgZ2V0cyBjYWxsZWQgZm9yIGV2ZXJ5IGFycmF5CiAgICAgKiBpdGVtLgogICAgICogQHJldHVybnMge0FycmF5fSBBIG5ldyBhcnJheSBvZiB2YWx1ZXMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBtYXAoYXJyYXksIGZuKSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBmbihhcnJheVtsZW5ndGhdKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIAogICAgLyoqCiAgICAgKiBBIHNpbXBsZSBgQXJyYXkjbWFwYC1saWtlIHdyYXBwZXIgdG8gd29yayB3aXRoIGRvbWFpbiBuYW1lIHN0cmluZ3Mgb3IgZW1haWwKICAgICAqIGFkZHJlc3Nlcy4KICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gZG9tYWluIFRoZSBkb21haW4gbmFtZSBvciBlbWFpbCBhZGRyZXNzLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRoYXQgZ2V0cyBjYWxsZWQgZm9yIGV2ZXJ5CiAgICAgKiBjaGFyYWN0ZXIuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IEEgbmV3IHN0cmluZyBvZiBjaGFyYWN0ZXJzIHJldHVybmVkIGJ5IHRoZSBjYWxsYmFjawogICAgICogZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1hcERvbWFpbihzdHJpbmcsIGZuKSB7CiAgICAgIHZhciBwYXJ0cyA9IHN0cmluZy5zcGxpdCgnQCcpOwogICAgICB2YXIgcmVzdWx0ID0gJyc7CiAgICAgIGlmIChwYXJ0cy5sZW5ndGggPiAxKSB7CiAgICAgICAgLy8gSW4gZW1haWwgYWRkcmVzc2VzLCBvbmx5IHRoZSBkb21haW4gbmFtZSBzaG91bGQgYmUgcHVueWNvZGVkLiBMZWF2ZQogICAgICAgIC8vIHRoZSBsb2NhbCBwYXJ0IChpLmUuIGV2ZXJ5dGhpbmcgdXAgdG8gYEBgKSBpbnRhY3QuCiAgICAgICAgcmVzdWx0ID0gcGFydHNbMF0gKyAnQCc7CiAgICAgICAgc3RyaW5nID0gcGFydHNbMV07CiAgICAgIH0KICAgICAgLy8gQXZvaWQgYHNwbGl0KHJlZ2V4KWAgZm9yIElFOCBjb21wYXRpYmlsaXR5LiBTZWUgIzE3LgogICAgICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZShyZWdleFNlcGFyYXRvcnMsICdceDJFJyk7CiAgICAgIHZhciBsYWJlbHMgPSBzdHJpbmcuc3BsaXQoJy4nKTsKICAgICAgdmFyIGVuY29kZWQgPSBtYXAobGFiZWxzLCBmbikuam9pbignLicpOwogICAgICByZXR1cm4gcmVzdWx0ICsgZW5jb2RlZDsKICAgIH0KICAKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSBjb250YWluaW5nIHRoZSBudW1lcmljIGNvZGUgcG9pbnRzIG9mIGVhY2ggVW5pY29kZQogICAgICogY2hhcmFjdGVyIGluIHRoZSBzdHJpbmcuIFdoaWxlIEphdmFTY3JpcHQgdXNlcyBVQ1MtMiBpbnRlcm5hbGx5LAogICAgICogdGhpcyBmdW5jdGlvbiB3aWxsIGNvbnZlcnQgYSBwYWlyIG9mIHN1cnJvZ2F0ZSBoYWx2ZXMgKGVhY2ggb2Ygd2hpY2gKICAgICAqIFVDUy0yIGV4cG9zZXMgYXMgc2VwYXJhdGUgY2hhcmFjdGVycykgaW50byBhIHNpbmdsZSBjb2RlIHBvaW50LAogICAgICogbWF0Y2hpbmcgVVRGLTE2LgogICAgICogQHNlZSBgcHVueWNvZGUudWNzMi5lbmNvZGVgCiAgICAgKiBAc2VlIDxodHRwczovL21hdGhpYXNieW5lbnMuYmUvbm90ZXMvamF2YXNjcmlwdC1lbmNvZGluZz4KICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZS51Y3MyCiAgICAgKiBAbmFtZSBkZWNvZGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzdHJpbmcgVGhlIFVuaWNvZGUgaW5wdXQgc3RyaW5nIChVQ1MtMikuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFRoZSBuZXcgYXJyYXkgb2YgY29kZSBwb2ludHMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHVjczJkZWNvZGUoc3RyaW5nKSB7CiAgICAgIHZhciBvdXRwdXQgPSBbXSwKICAgICAgICAgIGNvdW50ZXIgPSAwLAogICAgICAgICAgbGVuZ3RoID0gc3RyaW5nLmxlbmd0aCwKICAgICAgICAgIHZhbHVlLAogICAgICAgICAgZXh0cmE7CiAgICAgIHdoaWxlIChjb3VudGVyIDwgbGVuZ3RoKSB7CiAgICAgICAgdmFsdWUgPSBzdHJpbmcuY2hhckNvZGVBdChjb3VudGVyKyspOwogICAgICAgIGlmICh2YWx1ZSA+PSAweEQ4MDAgJiYgdmFsdWUgPD0gMHhEQkZGICYmIGNvdW50ZXIgPCBsZW5ndGgpIHsKICAgICAgICAgIC8vIGhpZ2ggc3Vycm9nYXRlLCBhbmQgdGhlcmUgaXMgYSBuZXh0IGNoYXJhY3RlcgogICAgICAgICAgZXh0cmEgPSBzdHJpbmcuY2hhckNvZGVBdChjb3VudGVyKyspOwogICAgICAgICAgaWYgKChleHRyYSAmIDB4RkMwMCkgPT0gMHhEQzAwKSB7IC8vIGxvdyBzdXJyb2dhdGUKICAgICAgICAgICAgb3V0cHV0LnB1c2goKCh2YWx1ZSAmIDB4M0ZGKSA8PCAxMCkgKyAoZXh0cmEgJiAweDNGRikgKyAweDEwMDAwKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIHVubWF0Y2hlZCBzdXJyb2dhdGU7IG9ubHkgYXBwZW5kIHRoaXMgY29kZSB1bml0LCBpbiBjYXNlIHRoZSBuZXh0CiAgICAgICAgICAgIC8vIGNvZGUgdW5pdCBpcyB0aGUgaGlnaCBzdXJyb2dhdGUgb2YgYSBzdXJyb2dhdGUgcGFpcgogICAgICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIGNvdW50ZXItLTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgb3V0cHV0LnB1c2godmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gb3V0cHV0OwogICAgfQogIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgc3RyaW5nIGJhc2VkIG9uIGFuIGFycmF5IG9mIG51bWVyaWMgY29kZSBwb2ludHMuCiAgICAgKiBAc2VlIGBwdW55Y29kZS51Y3MyLmRlY29kZWAKICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZS51Y3MyCiAgICAgKiBAbmFtZSBlbmNvZGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGNvZGVQb2ludHMgVGhlIGFycmF5IG9mIG51bWVyaWMgY29kZSBwb2ludHMuCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBUaGUgbmV3IFVuaWNvZGUgc3RyaW5nIChVQ1MtMikuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHVjczJlbmNvZGUoYXJyYXkpIHsKICAgICAgcmV0dXJuIG1hcChhcnJheSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgb3V0cHV0ID0gJyc7CiAgICAgICAgaWYgKHZhbHVlID4gMHhGRkZGKSB7CiAgICAgICAgICB2YWx1ZSAtPSAweDEwMDAwOwogICAgICAgICAgb3V0cHV0ICs9IHN0cmluZ0Zyb21DaGFyQ29kZSh2YWx1ZSA+Pj4gMTAgJiAweDNGRiB8IDB4RDgwMCk7CiAgICAgICAgICB2YWx1ZSA9IDB4REMwMCB8IHZhbHVlICYgMHgzRkY7CiAgICAgICAgfQogICAgICAgIG91dHB1dCArPSBzdHJpbmdGcm9tQ2hhckNvZGUodmFsdWUpOwogICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgIH0pLmpvaW4oJycpOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhIGJhc2ljIGNvZGUgcG9pbnQgaW50byBhIGRpZ2l0L2ludGVnZXIuCiAgICAgKiBAc2VlIGBkaWdpdFRvQmFzaWMoKWAKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge051bWJlcn0gY29kZVBvaW50IFRoZSBiYXNpYyBudW1lcmljIGNvZGUgcG9pbnQgdmFsdWUuCiAgICAgKiBAcmV0dXJucyB7TnVtYmVyfSBUaGUgbnVtZXJpYyB2YWx1ZSBvZiBhIGJhc2ljIGNvZGUgcG9pbnQgKGZvciB1c2UgaW4KICAgICAqIHJlcHJlc2VudGluZyBpbnRlZ2VycykgaW4gdGhlIHJhbmdlIGAwYCB0byBgYmFzZSAtIDFgLCBvciBgYmFzZWAgaWYKICAgICAqIHRoZSBjb2RlIHBvaW50IGRvZXMgbm90IHJlcHJlc2VudCBhIHZhbHVlLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNpY1RvRGlnaXQoY29kZVBvaW50KSB7CiAgICAgIGlmIChjb2RlUG9pbnQgLSA0OCA8IDEwKSB7CiAgICAgICAgcmV0dXJuIGNvZGVQb2ludCAtIDIyOwogICAgICB9CiAgICAgIGlmIChjb2RlUG9pbnQgLSA2NSA8IDI2KSB7CiAgICAgICAgcmV0dXJuIGNvZGVQb2ludCAtIDY1OwogICAgICB9CiAgICAgIGlmIChjb2RlUG9pbnQgLSA5NyA8IDI2KSB7CiAgICAgICAgcmV0dXJuIGNvZGVQb2ludCAtIDk3OwogICAgICB9CiAgICAgIHJldHVybiBiYXNlOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhIGRpZ2l0L2ludGVnZXIgaW50byBhIGJhc2ljIGNvZGUgcG9pbnQuCiAgICAgKiBAc2VlIGBiYXNpY1RvRGlnaXQoKWAKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge051bWJlcn0gZGlnaXQgVGhlIG51bWVyaWMgdmFsdWUgb2YgYSBiYXNpYyBjb2RlIHBvaW50LgogICAgICogQHJldHVybnMge051bWJlcn0gVGhlIGJhc2ljIGNvZGUgcG9pbnQgd2hvc2UgdmFsdWUgKHdoZW4gdXNlZCBmb3IKICAgICAqIHJlcHJlc2VudGluZyBpbnRlZ2VycykgaXMgYGRpZ2l0YCwgd2hpY2ggbmVlZHMgdG8gYmUgaW4gdGhlIHJhbmdlCiAgICAgKiBgMGAgdG8gYGJhc2UgLSAxYC4gSWYgYGZsYWdgIGlzIG5vbi16ZXJvLCB0aGUgdXBwZXJjYXNlIGZvcm0gaXMKICAgICAqIHVzZWQ7IGVsc2UsIHRoZSBsb3dlcmNhc2UgZm9ybSBpcyB1c2VkLiBUaGUgYmVoYXZpb3IgaXMgdW5kZWZpbmVkCiAgICAgKiBpZiBgZmxhZ2AgaXMgbm9uLXplcm8gYW5kIGBkaWdpdGAgaGFzIG5vIHVwcGVyY2FzZSBmb3JtLgogICAgICovCiAgICBmdW5jdGlvbiBkaWdpdFRvQmFzaWMoZGlnaXQsIGZsYWcpIHsKICAgICAgLy8gIDAuLjI1IG1hcCB0byBBU0NJSSBhLi56IG9yIEEuLloKICAgICAgLy8gMjYuLjM1IG1hcCB0byBBU0NJSSAwLi45CiAgICAgIHJldHVybiBkaWdpdCArIDIyICsgNzUgKiAoZGlnaXQgPCAyNikgLSAoKGZsYWcgIT0gMCkgPDwgNSk7CiAgICB9CiAgCiAgICAvKioKICAgICAqIEJpYXMgYWRhcHRhdGlvbiBmdW5jdGlvbiBhcyBwZXIgc2VjdGlvbiAzLjQgb2YgUkZDIDM0OTIuCiAgICAgKiBodHRwOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmMzNDkyI3NlY3Rpb24tMy40CiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBmdW5jdGlvbiBhZGFwdChkZWx0YSwgbnVtUG9pbnRzLCBmaXJzdFRpbWUpIHsKICAgICAgdmFyIGsgPSAwOwogICAgICBkZWx0YSA9IGZpcnN0VGltZSA/IGZsb29yKGRlbHRhIC8gZGFtcCkgOiBkZWx0YSA+PiAxOwogICAgICBkZWx0YSArPSBmbG9vcihkZWx0YSAvIG51bVBvaW50cyk7CiAgICAgIGZvciAoLyogbm8gaW5pdGlhbGl6YXRpb24gKi87IGRlbHRhID4gYmFzZU1pbnVzVE1pbiAqIHRNYXggPj4gMTsgayArPSBiYXNlKSB7CiAgICAgICAgZGVsdGEgPSBmbG9vcihkZWx0YSAvIGJhc2VNaW51c1RNaW4pOwogICAgICB9CiAgICAgIHJldHVybiBmbG9vcihrICsgKGJhc2VNaW51c1RNaW4gKyAxKSAqIGRlbHRhIC8gKGRlbHRhICsgc2tldykpOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhIFB1bnljb2RlIHN0cmluZyBvZiBBU0NJSS1vbmx5IHN5bWJvbHMgdG8gYSBzdHJpbmcgb2YgVW5pY29kZQogICAgICogc3ltYm9scy4KICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBQdW55Y29kZSBzdHJpbmcgb2YgQVNDSUktb25seSBzeW1ib2xzLgogICAgICogQHJldHVybnMge1N0cmluZ30gVGhlIHJlc3VsdGluZyBzdHJpbmcgb2YgVW5pY29kZSBzeW1ib2xzLgogICAgICovCiAgICBmdW5jdGlvbiBkZWNvZGUoaW5wdXQpIHsKICAgICAgLy8gRG9uJ3QgdXNlIFVDUy0yCiAgICAgIHZhciBvdXRwdXQgPSBbXSwKICAgICAgICAgIGlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoLAogICAgICAgICAgb3V0LAogICAgICAgICAgaSA9IDAsCiAgICAgICAgICBuID0gaW5pdGlhbE4sCiAgICAgICAgICBiaWFzID0gaW5pdGlhbEJpYXMsCiAgICAgICAgICBiYXNpYywKICAgICAgICAgIGosCiAgICAgICAgICBpbmRleCwKICAgICAgICAgIG9sZGksCiAgICAgICAgICB3LAogICAgICAgICAgaywKICAgICAgICAgIGRpZ2l0LAogICAgICAgICAgdCwKICAgICAgICAgIC8qKiBDYWNoZWQgY2FsY3VsYXRpb24gcmVzdWx0cyAqLwogICAgICAgICAgYmFzZU1pbnVzVDsKICAKICAgICAgLy8gSGFuZGxlIHRoZSBiYXNpYyBjb2RlIHBvaW50czogbGV0IGBiYXNpY2AgYmUgdGhlIG51bWJlciBvZiBpbnB1dCBjb2RlCiAgICAgIC8vIHBvaW50cyBiZWZvcmUgdGhlIGxhc3QgZGVsaW1pdGVyLCBvciBgMGAgaWYgdGhlcmUgaXMgbm9uZSwgdGhlbiBjb3B5CiAgICAgIC8vIHRoZSBmaXJzdCBiYXNpYyBjb2RlIHBvaW50cyB0byB0aGUgb3V0cHV0LgogIAogICAgICBiYXNpYyA9IGlucHV0Lmxhc3RJbmRleE9mKGRlbGltaXRlcik7CiAgICAgIGlmIChiYXNpYyA8IDApIHsKICAgICAgICBiYXNpYyA9IDA7CiAgICAgIH0KICAKICAgICAgZm9yIChqID0gMDsgaiA8IGJhc2ljOyArK2opIHsKICAgICAgICAvLyBpZiBpdCdzIG5vdCBhIGJhc2ljIGNvZGUgcG9pbnQKICAgICAgICBpZiAoaW5wdXQuY2hhckNvZGVBdChqKSA+PSAweDgwKSB7CiAgICAgICAgICBlcnJvcignbm90LWJhc2ljJyk7CiAgICAgICAgfQogICAgICAgIG91dHB1dC5wdXNoKGlucHV0LmNoYXJDb2RlQXQoaikpOwogICAgICB9CiAgCiAgICAgIC8vIE1haW4gZGVjb2RpbmcgbG9vcDogc3RhcnQganVzdCBhZnRlciB0aGUgbGFzdCBkZWxpbWl0ZXIgaWYgYW55IGJhc2ljIGNvZGUKICAgICAgLy8gcG9pbnRzIHdlcmUgY29waWVkOyBzdGFydCBhdCB0aGUgYmVnaW5uaW5nIG90aGVyd2lzZS4KICAKICAgICAgZm9yIChpbmRleCA9IGJhc2ljID4gMCA/IGJhc2ljICsgMSA6IDA7IGluZGV4IDwgaW5wdXRMZW5ndGg7IC8qIG5vIGZpbmFsIGV4cHJlc3Npb24gKi8pIHsKICAKICAgICAgICAvLyBgaW5kZXhgIGlzIHRoZSBpbmRleCBvZiB0aGUgbmV4dCBjaGFyYWN0ZXIgdG8gYmUgY29uc3VtZWQuCiAgICAgICAgLy8gRGVjb2RlIGEgZ2VuZXJhbGl6ZWQgdmFyaWFibGUtbGVuZ3RoIGludGVnZXIgaW50byBgZGVsdGFgLAogICAgICAgIC8vIHdoaWNoIGdldHMgYWRkZWQgdG8gYGlgLiBUaGUgb3ZlcmZsb3cgY2hlY2tpbmcgaXMgZWFzaWVyCiAgICAgICAgLy8gaWYgd2UgaW5jcmVhc2UgYGlgIGFzIHdlIGdvLCB0aGVuIHN1YnRyYWN0IG9mZiBpdHMgc3RhcnRpbmcKICAgICAgICAvLyB2YWx1ZSBhdCB0aGUgZW5kIHRvIG9idGFpbiBgZGVsdGFgLgogICAgICAgIGZvciAob2xkaSA9IGksIHcgPSAxLCBrID0gYmFzZTsgLyogbm8gY29uZGl0aW9uICovOyBrICs9IGJhc2UpIHsKICAKICAgICAgICAgIGlmIChpbmRleCA+PSBpbnB1dExlbmd0aCkgewogICAgICAgICAgICBlcnJvcignaW52YWxpZC1pbnB1dCcpOwogICAgICAgICAgfQogIAogICAgICAgICAgZGlnaXQgPSBiYXNpY1RvRGlnaXQoaW5wdXQuY2hhckNvZGVBdChpbmRleCsrKSk7CiAgCiAgICAgICAgICBpZiAoZGlnaXQgPj0gYmFzZSB8fCBkaWdpdCA+IGZsb29yKChtYXhJbnQgLSBpKSAvIHcpKSB7CiAgICAgICAgICAgIGVycm9yKCdvdmVyZmxvdycpOwogICAgICAgICAgfQogIAogICAgICAgICAgaSArPSBkaWdpdCAqIHc7CiAgICAgICAgICB0ID0gayA8PSBiaWFzID8gdE1pbiA6IChrID49IGJpYXMgKyB0TWF4ID8gdE1heCA6IGsgLSBiaWFzKTsKICAKICAgICAgICAgIGlmIChkaWdpdCA8IHQpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBiYXNlTWludXNUID0gYmFzZSAtIHQ7CiAgICAgICAgICBpZiAodyA+IGZsb29yKG1heEludCAvIGJhc2VNaW51c1QpKSB7CiAgICAgICAgICAgIGVycm9yKCdvdmVyZmxvdycpOwogICAgICAgICAgfQogIAogICAgICAgICAgdyAqPSBiYXNlTWludXNUOwogIAogICAgICAgIH0KICAKICAgICAgICBvdXQgPSBvdXRwdXQubGVuZ3RoICsgMTsKICAgICAgICBiaWFzID0gYWRhcHQoaSAtIG9sZGksIG91dCwgb2xkaSA9PSAwKTsKICAKICAgICAgICAvLyBgaWAgd2FzIHN1cHBvc2VkIHRvIHdyYXAgYXJvdW5kIGZyb20gYG91dGAgdG8gYDBgLAogICAgICAgIC8vIGluY3JlbWVudGluZyBgbmAgZWFjaCB0aW1lLCBzbyB3ZSdsbCBmaXggdGhhdCBub3c6CiAgICAgICAgaWYgKGZsb29yKGkgLyBvdXQpID4gbWF4SW50IC0gbikgewogICAgICAgICAgZXJyb3IoJ292ZXJmbG93Jyk7CiAgICAgICAgfQogIAogICAgICAgIG4gKz0gZmxvb3IoaSAvIG91dCk7CiAgICAgICAgaSAlPSBvdXQ7CiAgCiAgICAgICAgLy8gSW5zZXJ0IGBuYCBhdCBwb3NpdGlvbiBgaWAgb2YgdGhlIG91dHB1dAogICAgICAgIG91dHB1dC5zcGxpY2UoaSsrLCAwLCBuKTsKICAKICAgICAgfQogIAogICAgICByZXR1cm4gdWNzMmVuY29kZShvdXRwdXQpOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhIHN0cmluZyBvZiBVbmljb2RlIHN5bWJvbHMgKGUuZy4gYSBkb21haW4gbmFtZSBsYWJlbCkgdG8gYQogICAgICogUHVueWNvZGUgc3RyaW5nIG9mIEFTQ0lJLW9ubHkgc3ltYm9scy4KICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBzdHJpbmcgb2YgVW5pY29kZSBzeW1ib2xzLgogICAgICogQHJldHVybnMge1N0cmluZ30gVGhlIHJlc3VsdGluZyBQdW55Y29kZSBzdHJpbmcgb2YgQVNDSUktb25seSBzeW1ib2xzLgogICAgICovCiAgICBmdW5jdGlvbiBlbmNvZGUoaW5wdXQpIHsKICAgICAgdmFyIG4sCiAgICAgICAgICBkZWx0YSwKICAgICAgICAgIGhhbmRsZWRDUENvdW50LAogICAgICAgICAgYmFzaWNMZW5ndGgsCiAgICAgICAgICBiaWFzLAogICAgICAgICAgaiwKICAgICAgICAgIG0sCiAgICAgICAgICBxLAogICAgICAgICAgaywKICAgICAgICAgIHQsCiAgICAgICAgICBjdXJyZW50VmFsdWUsCiAgICAgICAgICBvdXRwdXQgPSBbXSwKICAgICAgICAgIC8qKiBgaW5wdXRMZW5ndGhgIHdpbGwgaG9sZCB0aGUgbnVtYmVyIG9mIGNvZGUgcG9pbnRzIGluIGBpbnB1dGAuICovCiAgICAgICAgICBpbnB1dExlbmd0aCwKICAgICAgICAgIC8qKiBDYWNoZWQgY2FsY3VsYXRpb24gcmVzdWx0cyAqLwogICAgICAgICAgaGFuZGxlZENQQ291bnRQbHVzT25lLAogICAgICAgICAgYmFzZU1pbnVzVCwKICAgICAgICAgIHFNaW51c1Q7CiAgCiAgICAgIC8vIENvbnZlcnQgdGhlIGlucHV0IGluIFVDUy0yIHRvIFVuaWNvZGUKICAgICAgaW5wdXQgPSB1Y3MyZGVjb2RlKGlucHV0KTsKICAKICAgICAgLy8gQ2FjaGUgdGhlIGxlbmd0aAogICAgICBpbnB1dExlbmd0aCA9IGlucHV0Lmxlbmd0aDsKICAKICAgICAgLy8gSW5pdGlhbGl6ZSB0aGUgc3RhdGUKICAgICAgbiA9IGluaXRpYWxOOwogICAgICBkZWx0YSA9IDA7CiAgICAgIGJpYXMgPSBpbml0aWFsQmlhczsKICAKICAgICAgLy8gSGFuZGxlIHRoZSBiYXNpYyBjb2RlIHBvaW50cwogICAgICBmb3IgKGogPSAwOyBqIDwgaW5wdXRMZW5ndGg7ICsraikgewogICAgICAgIGN1cnJlbnRWYWx1ZSA9IGlucHV0W2pdOwogICAgICAgIGlmIChjdXJyZW50VmFsdWUgPCAweDgwKSB7CiAgICAgICAgICBvdXRwdXQucHVzaChzdHJpbmdGcm9tQ2hhckNvZGUoY3VycmVudFZhbHVlKSk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIGhhbmRsZWRDUENvdW50ID0gYmFzaWNMZW5ndGggPSBvdXRwdXQubGVuZ3RoOwogIAogICAgICAvLyBgaGFuZGxlZENQQ291bnRgIGlzIHRoZSBudW1iZXIgb2YgY29kZSBwb2ludHMgdGhhdCBoYXZlIGJlZW4gaGFuZGxlZDsKICAgICAgLy8gYGJhc2ljTGVuZ3RoYCBpcyB0aGUgbnVtYmVyIG9mIGJhc2ljIGNvZGUgcG9pbnRzLgogIAogICAgICAvLyBGaW5pc2ggdGhlIGJhc2ljIHN0cmluZyAtIGlmIGl0IGlzIG5vdCBlbXB0eSAtIHdpdGggYSBkZWxpbWl0ZXIKICAgICAgaWYgKGJhc2ljTGVuZ3RoKSB7CiAgICAgICAgb3V0cHV0LnB1c2goZGVsaW1pdGVyKTsKICAgICAgfQogIAogICAgICAvLyBNYWluIGVuY29kaW5nIGxvb3A6CiAgICAgIHdoaWxlIChoYW5kbGVkQ1BDb3VudCA8IGlucHV0TGVuZ3RoKSB7CiAgCiAgICAgICAgLy8gQWxsIG5vbi1iYXNpYyBjb2RlIHBvaW50cyA8IG4gaGF2ZSBiZWVuIGhhbmRsZWQgYWxyZWFkeS4gRmluZCB0aGUgbmV4dAogICAgICAgIC8vIGxhcmdlciBvbmU6CiAgICAgICAgZm9yIChtID0gbWF4SW50LCBqID0gMDsgaiA8IGlucHV0TGVuZ3RoOyArK2opIHsKICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IGlucHV0W2pdOwogICAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSA+PSBuICYmIGN1cnJlbnRWYWx1ZSA8IG0pIHsKICAgICAgICAgICAgbSA9IGN1cnJlbnRWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgCiAgICAgICAgLy8gSW5jcmVhc2UgYGRlbHRhYCBlbm91Z2ggdG8gYWR2YW5jZSB0aGUgZGVjb2RlcidzIDxuLGk+IHN0YXRlIHRvIDxtLDA+LAogICAgICAgIC8vIGJ1dCBndWFyZCBhZ2FpbnN0IG92ZXJmbG93CiAgICAgICAgaGFuZGxlZENQQ291bnRQbHVzT25lID0gaGFuZGxlZENQQ291bnQgKyAxOwogICAgICAgIGlmIChtIC0gbiA+IGZsb29yKChtYXhJbnQgLSBkZWx0YSkgLyBoYW5kbGVkQ1BDb3VudFBsdXNPbmUpKSB7CiAgICAgICAgICBlcnJvcignb3ZlcmZsb3cnKTsKICAgICAgICB9CiAgCiAgICAgICAgZGVsdGEgKz0gKG0gLSBuKSAqIGhhbmRsZWRDUENvdW50UGx1c09uZTsKICAgICAgICBuID0gbTsKICAKICAgICAgICBmb3IgKGogPSAwOyBqIDwgaW5wdXRMZW5ndGg7ICsraikgewogICAgICAgICAgY3VycmVudFZhbHVlID0gaW5wdXRbal07CiAgCiAgICAgICAgICBpZiAoY3VycmVudFZhbHVlIDwgbiAmJiArK2RlbHRhID4gbWF4SW50KSB7CiAgICAgICAgICAgIGVycm9yKCdvdmVyZmxvdycpOwogICAgICAgICAgfQogIAogICAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSA9PSBuKSB7CiAgICAgICAgICAgIC8vIFJlcHJlc2VudCBkZWx0YSBhcyBhIGdlbmVyYWxpemVkIHZhcmlhYmxlLWxlbmd0aCBpbnRlZ2VyCiAgICAgICAgICAgIGZvciAocSA9IGRlbHRhLCBrID0gYmFzZTsgLyogbm8gY29uZGl0aW9uICovOyBrICs9IGJhc2UpIHsKICAgICAgICAgICAgICB0ID0gayA8PSBiaWFzID8gdE1pbiA6IChrID49IGJpYXMgKyB0TWF4ID8gdE1heCA6IGsgLSBiaWFzKTsKICAgICAgICAgICAgICBpZiAocSA8IHQpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBxTWludXNUID0gcSAtIHQ7CiAgICAgICAgICAgICAgYmFzZU1pbnVzVCA9IGJhc2UgLSB0OwogICAgICAgICAgICAgIG91dHB1dC5wdXNoKAogICAgICAgICAgICAgICAgc3RyaW5nRnJvbUNoYXJDb2RlKGRpZ2l0VG9CYXNpYyh0ICsgcU1pbnVzVCAlIGJhc2VNaW51c1QsIDApKQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcSA9IGZsb29yKHFNaW51c1QgLyBiYXNlTWludXNUKTsKICAgICAgICAgICAgfQogIAogICAgICAgICAgICBvdXRwdXQucHVzaChzdHJpbmdGcm9tQ2hhckNvZGUoZGlnaXRUb0Jhc2ljKHEsIDApKSk7CiAgICAgICAgICAgIGJpYXMgPSBhZGFwdChkZWx0YSwgaGFuZGxlZENQQ291bnRQbHVzT25lLCBoYW5kbGVkQ1BDb3VudCA9PSBiYXNpY0xlbmd0aCk7CiAgICAgICAgICAgIGRlbHRhID0gMDsKICAgICAgICAgICAgKytoYW5kbGVkQ1BDb3VudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgCiAgICAgICAgKytkZWx0YTsKICAgICAgICArK247CiAgCiAgICAgIH0KICAgICAgcmV0dXJuIG91dHB1dC5qb2luKCcnKTsKICAgIH0KICAKICAgIC8qKgogICAgICogQ29udmVydHMgYSBQdW55Y29kZSBzdHJpbmcgcmVwcmVzZW50aW5nIGEgZG9tYWluIG5hbWUgb3IgYW4gZW1haWwgYWRkcmVzcwogICAgICogdG8gVW5pY29kZS4gT25seSB0aGUgUHVueWNvZGVkIHBhcnRzIG9mIHRoZSBpbnB1dCB3aWxsIGJlIGNvbnZlcnRlZCwgaS5lLgogICAgICogaXQgZG9lc24ndCBtYXR0ZXIgaWYgeW91IGNhbGwgaXQgb24gYSBzdHJpbmcgdGhhdCBoYXMgYWxyZWFkeSBiZWVuCiAgICAgKiBjb252ZXJ0ZWQgdG8gVW5pY29kZS4KICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBQdW55Y29kZWQgZG9tYWluIG5hbWUgb3IgZW1haWwgYWRkcmVzcyB0bwogICAgICogY29udmVydCB0byBVbmljb2RlLgogICAgICogQHJldHVybnMge1N0cmluZ30gVGhlIFVuaWNvZGUgcmVwcmVzZW50YXRpb24gb2YgdGhlIGdpdmVuIFB1bnljb2RlCiAgICAgKiBzdHJpbmcuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvVW5pY29kZShpbnB1dCkgewogICAgICByZXR1cm4gbWFwRG9tYWluKGlucHV0LCBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgICByZXR1cm4gcmVnZXhQdW55Y29kZS50ZXN0KHN0cmluZykKICAgICAgICAgID8gZGVjb2RlKHN0cmluZy5zbGljZSg0KS50b0xvd2VyQ2FzZSgpKQogICAgICAgICAgOiBzdHJpbmc7CiAgICAgIH0pOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhIFVuaWNvZGUgc3RyaW5nIHJlcHJlc2VudGluZyBhIGRvbWFpbiBuYW1lIG9yIGFuIGVtYWlsIGFkZHJlc3MgdG8KICAgICAqIFB1bnljb2RlLiBPbmx5IHRoZSBub24tQVNDSUkgcGFydHMgb2YgdGhlIGRvbWFpbiBuYW1lIHdpbGwgYmUgY29udmVydGVkLAogICAgICogaS5lLiBpdCBkb2Vzbid0IG1hdHRlciBpZiB5b3UgY2FsbCBpdCB3aXRoIGEgZG9tYWluIHRoYXQncyBhbHJlYWR5IGluCiAgICAgKiBBU0NJSS4KICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBkb21haW4gbmFtZSBvciBlbWFpbCBhZGRyZXNzIHRvIGNvbnZlcnQsIGFzIGEKICAgICAqIFVuaWNvZGUgc3RyaW5nLgogICAgICogQHJldHVybnMge1N0cmluZ30gVGhlIFB1bnljb2RlIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBnaXZlbiBkb21haW4gbmFtZSBvcgogICAgICogZW1haWwgYWRkcmVzcy4KICAgICAqLwogICAgZnVuY3Rpb24gdG9BU0NJSShpbnB1dCkgewogICAgICByZXR1cm4gbWFwRG9tYWluKGlucHV0LCBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgICByZXR1cm4gcmVnZXhOb25BU0NJSS50ZXN0KHN0cmluZykKICAgICAgICAgID8gJ3huLS0nICsgZW5jb2RlKHN0cmluZykKICAgICAgICAgIDogc3RyaW5nOwogICAgICB9KTsKICAgIH0KICAKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIAogICAgLyoqIERlZmluZSB0aGUgcHVibGljIEFQSSAqLwogICAgcHVueWNvZGUgPSB7CiAgICAgIC8qKgogICAgICAgKiBBIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIGN1cnJlbnQgUHVueWNvZGUuanMgdmVyc2lvbiBudW1iZXIuCiAgICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZQogICAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAgICovCiAgICAgICd2ZXJzaW9uJzogJzEuMy4yJywKICAgICAgLyoqCiAgICAgICAqIEFuIG9iamVjdCBvZiBtZXRob2RzIHRvIGNvbnZlcnQgZnJvbSBKYXZhU2NyaXB0J3MgaW50ZXJuYWwgY2hhcmFjdGVyCiAgICAgICAqIHJlcHJlc2VudGF0aW9uIChVQ1MtMikgdG8gVW5pY29kZSBjb2RlIHBvaW50cywgYW5kIGJhY2suCiAgICAgICAqIEBzZWUgPGh0dHBzOi8vbWF0aGlhc2J5bmVucy5iZS9ub3Rlcy9qYXZhc2NyaXB0LWVuY29kaW5nPgogICAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUKICAgICAgICogQHR5cGUgT2JqZWN0CiAgICAgICAqLwogICAgICAndWNzMic6IHsKICAgICAgICAnZGVjb2RlJzogdWNzMmRlY29kZSwKICAgICAgICAnZW5jb2RlJzogdWNzMmVuY29kZQogICAgICB9LAogICAgICAnZGVjb2RlJzogZGVjb2RlLAogICAgICAnZW5jb2RlJzogZW5jb2RlLAogICAgICAndG9BU0NJSSc6IHRvQVNDSUksCiAgICAgICd0b1VuaWNvZGUnOiB0b1VuaWNvZGUKICAgIH07CiAgCiAgICAvKiogRXhwb3NlIGBwdW55Y29kZWAgKi8KICAgIC8vIFNvbWUgQU1EIGJ1aWxkIG9wdGltaXplcnMsIGxpa2Ugci5qcywgY2hlY2sgZm9yIHNwZWNpZmljIGNvbmRpdGlvbiBwYXR0ZXJucwogICAgLy8gbGlrZSB0aGUgZm9sbG93aW5nOgogICAgaWYgKAogICAgICB0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicgJiYKICAgICAgdHlwZW9mIGRlZmluZS5hbWQgPT0gJ29iamVjdCcgJiYKICAgICAgZGVmaW5lLmFtZAogICAgKSB7CiAgICAgIGRlZmluZSgncHVueWNvZGUnLCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gcHVueWNvZGU7CiAgICAgIH0pOwogICAgfSBlbHNlIGlmIChmcmVlRXhwb3J0cyAmJiBmcmVlTW9kdWxlKSB7CiAgICAgIGlmIChtb2R1bGUuZXhwb3J0cyA9PSBmcmVlRXhwb3J0cykgeyAvLyBpbiBOb2RlLmpzIG9yIFJpbmdvSlMgdjAuOC4wKwogICAgICAgIGZyZWVNb2R1bGUuZXhwb3J0cyA9IHB1bnljb2RlOwogICAgICB9IGVsc2UgeyAvLyBpbiBOYXJ3aGFsIG9yIFJpbmdvSlMgdjAuNy4wLQogICAgICAgIGZvciAoa2V5IGluIHB1bnljb2RlKSB7CiAgICAgICAgICBwdW55Y29kZS5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIChmcmVlRXhwb3J0c1trZXldID0gcHVueWNvZGVba2V5XSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgeyAvLyBpbiBSaGlubyBvciBhIHdlYiBicm93c2VyCiAgICAgIHJvb3QucHVueWNvZGUgPSBwdW55Y29kZTsKICAgIH0KICAKICB9KHRoaXMpKTsKICAKICB9KS5jYWxsKHRoaXMsdHlwZW9mIGdsb2JhbCAhPT0gInVuZGVmaW5lZCIgPyBnbG9iYWwgOiB0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIgPyBzZWxmIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSkKICB9LHt9XSw4NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCiAgLy8KICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQogIC8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKICAvLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCiAgLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAogIC8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKICAvLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKICAvLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAvLwogIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCiAgLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgLy8KICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwogIC8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICAvLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCiAgLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCiAgLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCiAgLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQogIC8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiAgCiAgJ3VzZSBzdHJpY3QnOwogIAogIC8vIElmIG9iai5oYXNPd25Qcm9wZXJ0eSBoYXMgYmVlbiBvdmVycmlkZGVuLCB0aGVuIGNhbGxpbmcKICAvLyBvYmouaGFzT3duUHJvcGVydHkocHJvcCkgd2lsbCBicmVhay4KICAvLyBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9qb3llbnQvbm9kZS9pc3N1ZXMvMTcwNwogIGZ1bmN0aW9uIGhhc093blByb3BlcnR5KG9iaiwgcHJvcCkgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApOwogIH0KICAKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKHFzLCBzZXAsIGVxLCBvcHRpb25zKSB7CiAgICBzZXAgPSBzZXAgfHwgJyYnOwogICAgZXEgPSBlcSB8fCAnPSc7CiAgICB2YXIgb2JqID0ge307CiAgCiAgICBpZiAodHlwZW9mIHFzICE9PSAnc3RyaW5nJyB8fCBxcy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIG9iajsKICAgIH0KICAKICAgIHZhciByZWdleHAgPSAvXCsvZzsKICAgIHFzID0gcXMuc3BsaXQoc2VwKTsKICAKICAgIHZhciBtYXhLZXlzID0gMTAwMDsKICAgIGlmIChvcHRpb25zICYmIHR5cGVvZiBvcHRpb25zLm1heEtleXMgPT09ICdudW1iZXInKSB7CiAgICAgIG1heEtleXMgPSBvcHRpb25zLm1heEtleXM7CiAgICB9CiAgCiAgICB2YXIgbGVuID0gcXMubGVuZ3RoOwogICAgLy8gbWF4S2V5cyA8PSAwIG1lYW5zIHRoYXQgd2Ugc2hvdWxkIG5vdCBsaW1pdCBrZXlzIGNvdW50CiAgICBpZiAobWF4S2V5cyA+IDAgJiYgbGVuID4gbWF4S2V5cykgewogICAgICBsZW4gPSBtYXhLZXlzOwogICAgfQogIAogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICB2YXIgeCA9IHFzW2ldLnJlcGxhY2UocmVnZXhwLCAnJTIwJyksCiAgICAgICAgICBpZHggPSB4LmluZGV4T2YoZXEpLAogICAgICAgICAga3N0ciwgdnN0ciwgaywgdjsKICAKICAgICAgaWYgKGlkeCA+PSAwKSB7CiAgICAgICAga3N0ciA9IHguc3Vic3RyKDAsIGlkeCk7CiAgICAgICAgdnN0ciA9IHguc3Vic3RyKGlkeCArIDEpOwogICAgICB9IGVsc2UgewogICAgICAgIGtzdHIgPSB4OwogICAgICAgIHZzdHIgPSAnJzsKICAgICAgfQogIAogICAgICBrID0gZGVjb2RlVVJJQ29tcG9uZW50KGtzdHIpOwogICAgICB2ID0gZGVjb2RlVVJJQ29tcG9uZW50KHZzdHIpOwogIAogICAgICBpZiAoIWhhc093blByb3BlcnR5KG9iaiwgaykpIHsKICAgICAgICBvYmpba10gPSB2OwogICAgICB9IGVsc2UgaWYgKGlzQXJyYXkob2JqW2tdKSkgewogICAgICAgIG9ialtrXS5wdXNoKHYpOwogICAgICB9IGVsc2UgewogICAgICAgIG9ialtrXSA9IFtvYmpba10sIHZdOwogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gb2JqOwogIH07CiAgCiAgdmFyIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5IHx8IGZ1bmN0aW9uICh4cykgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh4cykgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKICAKICB9LHt9XSw4ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCiAgLy8KICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQogIC8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKICAvLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCiAgLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAogIC8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKICAvLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKICAvLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAvLwogIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCiAgLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgLy8KICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwogIC8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICAvLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCiAgLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCiAgLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCiAgLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQogIC8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiAgCiAgJ3VzZSBzdHJpY3QnOwogIAogIHZhciBzdHJpbmdpZnlQcmltaXRpdmUgPSBmdW5jdGlvbih2KSB7CiAgICBzd2l0Y2ggKHR5cGVvZiB2KSB7CiAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgcmV0dXJuIHY7CiAgCiAgICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICAgIHJldHVybiB2ID8gJ3RydWUnIDogJ2ZhbHNlJzsKICAKICAgICAgY2FzZSAnbnVtYmVyJzoKICAgICAgICByZXR1cm4gaXNGaW5pdGUodikgPyB2IDogJyc7CiAgCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuICcnOwogICAgfQogIH07CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihvYmosIHNlcCwgZXEsIG5hbWUpIHsKICAgIHNlcCA9IHNlcCB8fCAnJic7CiAgICBlcSA9IGVxIHx8ICc9JzsKICAgIGlmIChvYmogPT09IG51bGwpIHsKICAgICAgb2JqID0gdW5kZWZpbmVkOwogICAgfQogIAogICAgaWYgKHR5cGVvZiBvYmogPT09ICdvYmplY3QnKSB7CiAgICAgIHJldHVybiBtYXAob2JqZWN0S2V5cyhvYmopLCBmdW5jdGlvbihrKSB7CiAgICAgICAgdmFyIGtzID0gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShrKSkgKyBlcTsKICAgICAgICBpZiAoaXNBcnJheShvYmpba10pKSB7CiAgICAgICAgICByZXR1cm4gbWFwKG9ialtrXSwgZnVuY3Rpb24odikgewogICAgICAgICAgICByZXR1cm4ga3MgKyBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKHYpKTsKICAgICAgICAgIH0pLmpvaW4oc2VwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGtzICsgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShvYmpba10pKTsKICAgICAgICB9CiAgICAgIH0pLmpvaW4oc2VwKTsKICAKICAgIH0KICAKICAgIGlmICghbmFtZSkgcmV0dXJuICcnOwogICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUobmFtZSkpICsgZXEgKwogICAgICAgICAgIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUob2JqKSk7CiAgfTsKICAKICB2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24gKHhzKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHhzKSA9PT0gJ1tvYmplY3QgQXJyYXldJzsKICB9OwogIAogIGZ1bmN0aW9uIG1hcCAoeHMsIGYpIHsKICAgIGlmICh4cy5tYXApIHJldHVybiB4cy5tYXAoZik7CiAgICB2YXIgcmVzID0gW107CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHhzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHJlcy5wdXNoKGYoeHNbaV0sIGkpKTsKICAgIH0KICAgIHJldHVybiByZXM7CiAgfQogIAogIHZhciBvYmplY3RLZXlzID0gT2JqZWN0LmtleXMgfHwgZnVuY3Rpb24gKG9iaikgewogICAgdmFyIHJlcyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgcmVzLnB1c2goa2V5KTsKICAgIH0KICAgIHJldHVybiByZXM7CiAgfTsKICAKICB9LHt9XSw4OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgJ3VzZSBzdHJpY3QnOwogIAogIGV4cG9ydHMuZGVjb2RlID0gZXhwb3J0cy5wYXJzZSA9IHJlcXVpcmUoJy4vZGVjb2RlJyk7CiAgZXhwb3J0cy5lbmNvZGUgPSBleHBvcnRzLnN0cmluZ2lmeSA9IHJlcXVpcmUoJy4vZW5jb2RlJyk7CiAgCiAgfSx7Ii4vZGVjb2RlIjo4NywiLi9lbmNvZGUiOjg4fV0sOTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgogIC8vCiAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKICAvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiAgLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwogIC8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKICAvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CiAgLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCiAgLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgLy8KICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAogIC8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogIC8vCiAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICAvLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiAgLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgogIC8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAogIC8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgogIC8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKICAvLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogIAogICd1c2Ugc3RyaWN0JzsKICAKICAvLyBJZiBvYmouaGFzT3duUHJvcGVydHkgaGFzIGJlZW4gb3ZlcnJpZGRlbiwgdGhlbiBjYWxsaW5nCiAgLy8gb2JqLmhhc093blByb3BlcnR5KHByb3ApIHdpbGwgYnJlYWsuCiAgLy8gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vam95ZW50L25vZGUvaXNzdWVzLzE3MDcKICBmdW5jdGlvbiBoYXNPd25Qcm9wZXJ0eShvYmosIHByb3ApIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBwcm9wKTsKICB9CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihxcywgc2VwLCBlcSwgb3B0aW9ucykgewogICAgc2VwID0gc2VwIHx8ICcmJzsKICAgIGVxID0gZXEgfHwgJz0nOwogICAgdmFyIG9iaiA9IHt9OwogIAogICAgaWYgKHR5cGVvZiBxcyAhPT0gJ3N0cmluZycgfHwgcXMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBvYmo7CiAgICB9CiAgCiAgICB2YXIgcmVnZXhwID0gL1wrL2c7CiAgICBxcyA9IHFzLnNwbGl0KHNlcCk7CiAgCiAgICB2YXIgbWF4S2V5cyA9IDEwMDA7CiAgICBpZiAob3B0aW9ucyAmJiB0eXBlb2Ygb3B0aW9ucy5tYXhLZXlzID09PSAnbnVtYmVyJykgewogICAgICBtYXhLZXlzID0gb3B0aW9ucy5tYXhLZXlzOwogICAgfQogIAogICAgdmFyIGxlbiA9IHFzLmxlbmd0aDsKICAgIC8vIG1heEtleXMgPD0gMCBtZWFucyB0aGF0IHdlIHNob3VsZCBub3QgbGltaXQga2V5cyBjb3VudAogICAgaWYgKG1heEtleXMgPiAwICYmIGxlbiA+IG1heEtleXMpIHsKICAgICAgbGVuID0gbWF4S2V5czsKICAgIH0KICAKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgICAgdmFyIHggPSBxc1tpXS5yZXBsYWNlKHJlZ2V4cCwgJyUyMCcpLAogICAgICAgICAgaWR4ID0geC5pbmRleE9mKGVxKSwKICAgICAgICAgIGtzdHIsIHZzdHIsIGssIHY7CiAgCiAgICAgIGlmIChpZHggPj0gMCkgewogICAgICAgIGtzdHIgPSB4LnN1YnN0cigwLCBpZHgpOwogICAgICAgIHZzdHIgPSB4LnN1YnN0cihpZHggKyAxKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBrc3RyID0geDsKICAgICAgICB2c3RyID0gJyc7CiAgICAgIH0KICAKICAgICAgayA9IGRlY29kZVVSSUNvbXBvbmVudChrc3RyKTsKICAgICAgdiA9IGRlY29kZVVSSUNvbXBvbmVudCh2c3RyKTsKICAKICAgICAgaWYgKCFoYXNPd25Qcm9wZXJ0eShvYmosIGspKSB7CiAgICAgICAgb2JqW2tdID0gdjsKICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KG9ialtrXSkpIHsKICAgICAgICBvYmpba10ucHVzaCh2KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvYmpba10gPSBbb2JqW2tdLCB2XTsKICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIG9iajsKICB9OwogIAogIH0se31dLDkxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KICAvLwogIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCiAgLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQogIC8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKICAvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCiAgLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAogIC8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQogIC8vIGZvbGxvd2luZyBjb25kaXRpb25zOgogIC8vCiAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKICAvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAvLwogIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAgLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogIC8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KICAvLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKICAvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKICAvLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCiAgLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICAKICAndXNlIHN0cmljdCc7CiAgCiAgdmFyIHN0cmluZ2lmeVByaW1pdGl2ZSA9IGZ1bmN0aW9uKHYpIHsKICAgIHN3aXRjaCAodHlwZW9mIHYpIHsKICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICByZXR1cm4gdjsKICAKICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgICAgcmV0dXJuIHYgPyAndHJ1ZScgOiAnZmFsc2UnOwogIAogICAgICBjYXNlICdudW1iZXInOgogICAgICAgIHJldHVybiBpc0Zpbml0ZSh2KSA/IHYgOiAnJzsKICAKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gJyc7CiAgICB9CiAgfTsKICAKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKG9iaiwgc2VwLCBlcSwgbmFtZSkgewogICAgc2VwID0gc2VwIHx8ICcmJzsKICAgIGVxID0gZXEgfHwgJz0nOwogICAgaWYgKG9iaiA9PT0gbnVsbCkgewogICAgICBvYmogPSB1bmRlZmluZWQ7CiAgICB9CiAgCiAgICBpZiAodHlwZW9mIG9iaiA9PT0gJ29iamVjdCcpIHsKICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKG9iaikubWFwKGZ1bmN0aW9uKGspIHsKICAgICAgICB2YXIga3MgPSBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKGspKSArIGVxOwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KG9ialtrXSkpIHsKICAgICAgICAgIHJldHVybiBvYmpba10ubWFwKGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgcmV0dXJuIGtzICsgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZSh2KSk7CiAgICAgICAgICB9KS5qb2luKHNlcCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBrcyArIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUob2JqW2tdKSk7CiAgICAgICAgfQogICAgICB9KS5qb2luKHNlcCk7CiAgCiAgICB9CiAgCiAgICBpZiAoIW5hbWUpIHJldHVybiAnJzsKICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG5hbWUpKSArIGVxICsKICAgICAgICAgICBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG9iaikpOwogIH07CiAgCiAgfSx7fV0sOTI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIGFyZ3VtZW50c1s0XVs4OV1bMF0uYXBwbHkoZXhwb3J0cyxhcmd1bWVudHMpCiAgfSx7Ii4vZGVjb2RlIjo5MCwiLi9lbmNvZGUiOjkxLCJkdXAiOjg5fV0sOTM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAoc2V0SW1tZWRpYXRlLGNsZWFySW1tZWRpYXRlKXsKICB2YXIgbmV4dFRpY2sgPSByZXF1aXJlKCdwcm9jZXNzL2Jyb3dzZXIuanMnKS5uZXh0VGljazsKICB2YXIgYXBwbHkgPSBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHk7CiAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwogIHZhciBpbW1lZGlhdGVJZHMgPSB7fTsKICB2YXIgbmV4dEltbWVkaWF0ZUlkID0gMDsKICAKICAvLyBET00gQVBJcywgZm9yIGNvbXBsZXRlbmVzcwogIAogIGV4cG9ydHMuc2V0VGltZW91dCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG5ldyBUaW1lb3V0KGFwcGx5LmNhbGwoc2V0VGltZW91dCwgd2luZG93LCBhcmd1bWVudHMpLCBjbGVhclRpbWVvdXQpOwogIH07CiAgZXhwb3J0cy5zZXRJbnRlcnZhbCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG5ldyBUaW1lb3V0KGFwcGx5LmNhbGwoc2V0SW50ZXJ2YWwsIHdpbmRvdywgYXJndW1lbnRzKSwgY2xlYXJJbnRlcnZhbCk7CiAgfTsKICBleHBvcnRzLmNsZWFyVGltZW91dCA9CiAgZXhwb3J0cy5jbGVhckludGVydmFsID0gZnVuY3Rpb24odGltZW91dCkgeyB0aW1lb3V0LmNsb3NlKCk7IH07CiAgCiAgZnVuY3Rpb24gVGltZW91dChpZCwgY2xlYXJGbikgewogICAgdGhpcy5faWQgPSBpZDsKICAgIHRoaXMuX2NsZWFyRm4gPSBjbGVhckZuOwogIH0KICBUaW1lb3V0LnByb3RvdHlwZS51bnJlZiA9IFRpbWVvdXQucHJvdG90eXBlLnJlZiA9IGZ1bmN0aW9uKCkge307CiAgVGltZW91dC5wcm90b3R5cGUuY2xvc2UgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2NsZWFyRm4uY2FsbCh3aW5kb3csIHRoaXMuX2lkKTsKICB9OwogIAogIC8vIERvZXMgbm90IHN0YXJ0IHRoZSB0aW1lLCBqdXN0IHNldHMgdXAgdGhlIG1lbWJlcnMgbmVlZGVkLgogIGV4cG9ydHMuZW5yb2xsID0gZnVuY3Rpb24oaXRlbSwgbXNlY3MpIHsKICAgIGNsZWFyVGltZW91dChpdGVtLl9pZGxlVGltZW91dElkKTsKICAgIGl0ZW0uX2lkbGVUaW1lb3V0ID0gbXNlY3M7CiAgfTsKICAKICBleHBvcnRzLnVuZW5yb2xsID0gZnVuY3Rpb24oaXRlbSkgewogICAgY2xlYXJUaW1lb3V0KGl0ZW0uX2lkbGVUaW1lb3V0SWQpOwogICAgaXRlbS5faWRsZVRpbWVvdXQgPSAtMTsKICB9OwogIAogIGV4cG9ydHMuX3VucmVmQWN0aXZlID0gZXhwb3J0cy5hY3RpdmUgPSBmdW5jdGlvbihpdGVtKSB7CiAgICBjbGVhclRpbWVvdXQoaXRlbS5faWRsZVRpbWVvdXRJZCk7CiAgCiAgICB2YXIgbXNlY3MgPSBpdGVtLl9pZGxlVGltZW91dDsKICAgIGlmIChtc2VjcyA+PSAwKSB7CiAgICAgIGl0ZW0uX2lkbGVUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uIG9uVGltZW91dCgpIHsKICAgICAgICBpZiAoaXRlbS5fb25UaW1lb3V0KQogICAgICAgICAgaXRlbS5fb25UaW1lb3V0KCk7CiAgICAgIH0sIG1zZWNzKTsKICAgIH0KICB9OwogIAogIC8vIFRoYXQncyBub3QgaG93IG5vZGUuanMgaW1wbGVtZW50cyBpdCBidXQgdGhlIGV4cG9zZWQgYXBpIGlzIHRoZSBzYW1lLgogIGV4cG9ydHMuc2V0SW1tZWRpYXRlID0gdHlwZW9mIHNldEltbWVkaWF0ZSA9PT0gImZ1bmN0aW9uIiA/IHNldEltbWVkaWF0ZSA6IGZ1bmN0aW9uKGZuKSB7CiAgICB2YXIgaWQgPSBuZXh0SW1tZWRpYXRlSWQrKzsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzLmxlbmd0aCA8IDIgPyBmYWxzZSA6IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAKICAgIGltbWVkaWF0ZUlkc1tpZF0gPSB0cnVlOwogIAogICAgbmV4dFRpY2soZnVuY3Rpb24gb25OZXh0VGljaygpIHsKICAgICAgaWYgKGltbWVkaWF0ZUlkc1tpZF0pIHsKICAgICAgICAvLyBmbi5jYWxsKCkgaXMgZmFzdGVyIHNvIHdlIG9wdGltaXplIGZvciB0aGUgY29tbW9uIHVzZS1jYXNlCiAgICAgICAgLy8gQHNlZSBodHRwOi8vanNwZXJmLmNvbS9jYWxsLWFwcGx5LXNlZ3UKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgZm4uYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZuLmNhbGwobnVsbCk7CiAgICAgICAgfQogICAgICAgIC8vIFByZXZlbnQgaWRzIGZyb20gbGVha2luZwogICAgICAgIGV4cG9ydHMuY2xlYXJJbW1lZGlhdGUoaWQpOwogICAgICB9CiAgICB9KTsKICAKICAgIHJldHVybiBpZDsKICB9OwogIAogIGV4cG9ydHMuY2xlYXJJbW1lZGlhdGUgPSB0eXBlb2YgY2xlYXJJbW1lZGlhdGUgPT09ICJmdW5jdGlvbiIgPyBjbGVhckltbWVkaWF0ZSA6IGZ1bmN0aW9uKGlkKSB7CiAgICBkZWxldGUgaW1tZWRpYXRlSWRzW2lkXTsKICB9OwogIH0pLmNhbGwodGhpcyxyZXF1aXJlKCJ0aW1lcnMiKS5zZXRJbW1lZGlhdGUscmVxdWlyZSgidGltZXJzIikuY2xlYXJJbW1lZGlhdGUpCiAgfSx7InByb2Nlc3MvYnJvd3Nlci5qcyI6ODUsInRpbWVycyI6OTN9XSw5NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCiAgLy8KICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQogIC8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKICAvLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCiAgLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAogIC8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKICAvLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKICAvLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAvLwogIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCiAgLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgLy8KICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwogIC8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICAvLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCiAgLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCiAgLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCiAgLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQogIC8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiAgCiAgdmFyIHB1bnljb2RlID0gcmVxdWlyZSgncHVueWNvZGUnKTsKICAKICBleHBvcnRzLnBhcnNlID0gdXJsUGFyc2U7CiAgZXhwb3J0cy5yZXNvbHZlID0gdXJsUmVzb2x2ZTsKICBleHBvcnRzLnJlc29sdmVPYmplY3QgPSB1cmxSZXNvbHZlT2JqZWN0OwogIGV4cG9ydHMuZm9ybWF0ID0gdXJsRm9ybWF0OwogIAogIGV4cG9ydHMuVXJsID0gVXJsOwogIAogIGZ1bmN0aW9uIFVybCgpIHsKICAgIHRoaXMucHJvdG9jb2wgPSBudWxsOwogICAgdGhpcy5zbGFzaGVzID0gbnVsbDsKICAgIHRoaXMuYXV0aCA9IG51bGw7CiAgICB0aGlzLmhvc3QgPSBudWxsOwogICAgdGhpcy5wb3J0ID0gbnVsbDsKICAgIHRoaXMuaG9zdG5hbWUgPSBudWxsOwogICAgdGhpcy5oYXNoID0gbnVsbDsKICAgIHRoaXMuc2VhcmNoID0gbnVsbDsKICAgIHRoaXMucXVlcnkgPSBudWxsOwogICAgdGhpcy5wYXRobmFtZSA9IG51bGw7CiAgICB0aGlzLnBhdGggPSBudWxsOwogICAgdGhpcy5ocmVmID0gbnVsbDsKICB9CiAgCiAgLy8gUmVmZXJlbmNlOiBSRkMgMzk4NiwgUkZDIDE4MDgsIFJGQyAyMzk2CiAgCiAgLy8gZGVmaW5lIHRoZXNlIGhlcmUgc28gYXQgbGVhc3QgdGhleSBvbmx5IGhhdmUgdG8gYmUKICAvLyBjb21waWxlZCBvbmNlIG9uIHRoZSBmaXJzdCBtb2R1bGUgbG9hZC4KICB2YXIgcHJvdG9jb2xQYXR0ZXJuID0gL14oW2EtejAtOS4rLV0rOikvaSwKICAgICAgcG9ydFBhdHRlcm4gPSAvOlswLTldKiQvLAogIAogICAgICAvLyBSRkMgMjM5NjogY2hhcmFjdGVycyByZXNlcnZlZCBmb3IgZGVsaW1pdGluZyBVUkxzLgogICAgICAvLyBXZSBhY3R1YWxseSBqdXN0IGF1dG8tZXNjYXBlIHRoZXNlLgogICAgICBkZWxpbXMgPSBbJzwnLCAnPicsICciJywgJ2AnLCAnICcsICdccicsICdcbicsICdcdCddLAogIAogICAgICAvLyBSRkMgMjM5NjogY2hhcmFjdGVycyBub3QgYWxsb3dlZCBmb3IgdmFyaW91cyByZWFzb25zLgogICAgICB1bndpc2UgPSBbJ3snLCAnfScsICd8JywgJ1xcJywgJ14nLCAnYCddLmNvbmNhdChkZWxpbXMpLAogIAogICAgICAvLyBBbGxvd2VkIGJ5IFJGQ3MsIGJ1dCBjYXVzZSBvZiBYU1MgYXR0YWNrcy4gIEFsd2F5cyBlc2NhcGUgdGhlc2UuCiAgICAgIGF1dG9Fc2NhcGUgPSBbJ1wnJ10uY29uY2F0KHVud2lzZSksCiAgICAgIC8vIENoYXJhY3RlcnMgdGhhdCBhcmUgbmV2ZXIgZXZlciBhbGxvd2VkIGluIGEgaG9zdG5hbWUuCiAgICAgIC8vIE5vdGUgdGhhdCBhbnkgaW52YWxpZCBjaGFycyBhcmUgYWxzbyBoYW5kbGVkLCBidXQgdGhlc2UKICAgICAgLy8gYXJlIHRoZSBvbmVzIHRoYXQgYXJlICpleHBlY3RlZCogdG8gYmUgc2Vlbiwgc28gd2UgZmFzdC1wYXRoCiAgICAgIC8vIHRoZW0uCiAgICAgIG5vbkhvc3RDaGFycyA9IFsnJScsICcvJywgJz8nLCAnOycsICcjJ10uY29uY2F0KGF1dG9Fc2NhcGUpLAogICAgICBob3N0RW5kaW5nQ2hhcnMgPSBbJy8nLCAnPycsICcjJ10sCiAgICAgIGhvc3RuYW1lTWF4TGVuID0gMjU1LAogICAgICBob3N0bmFtZVBhcnRQYXR0ZXJuID0gL15bYS16MC05QS1aXy1dezAsNjN9JC8sCiAgICAgIGhvc3RuYW1lUGFydFN0YXJ0ID0gL14oW2EtejAtOUEtWl8tXXswLDYzfSkoLiopJC8sCiAgICAgIC8vIHByb3RvY29scyB0aGF0IGNhbiBhbGxvdyAidW5zYWZlIiBhbmQgInVud2lzZSIgY2hhcnMuCiAgICAgIHVuc2FmZVByb3RvY29sID0gewogICAgICAgICdqYXZhc2NyaXB0JzogdHJ1ZSwKICAgICAgICAnamF2YXNjcmlwdDonOiB0cnVlCiAgICAgIH0sCiAgICAgIC8vIHByb3RvY29scyB0aGF0IG5ldmVyIGhhdmUgYSBob3N0bmFtZS4KICAgICAgaG9zdGxlc3NQcm90b2NvbCA9IHsKICAgICAgICAnamF2YXNjcmlwdCc6IHRydWUsCiAgICAgICAgJ2phdmFzY3JpcHQ6JzogdHJ1ZQogICAgICB9LAogICAgICAvLyBwcm90b2NvbHMgdGhhdCBhbHdheXMgY29udGFpbiBhIC8vIGJpdC4KICAgICAgc2xhc2hlZFByb3RvY29sID0gewogICAgICAgICdodHRwJzogdHJ1ZSwKICAgICAgICAnaHR0cHMnOiB0cnVlLAogICAgICAgICdmdHAnOiB0cnVlLAogICAgICAgICdnb3BoZXInOiB0cnVlLAogICAgICAgICdmaWxlJzogdHJ1ZSwKICAgICAgICAnaHR0cDonOiB0cnVlLAogICAgICAgICdodHRwczonOiB0cnVlLAogICAgICAgICdmdHA6JzogdHJ1ZSwKICAgICAgICAnZ29waGVyOic6IHRydWUsCiAgICAgICAgJ2ZpbGU6JzogdHJ1ZQogICAgICB9LAogICAgICBxdWVyeXN0cmluZyA9IHJlcXVpcmUoJ3F1ZXJ5c3RyaW5nJyk7CiAgCiAgZnVuY3Rpb24gdXJsUGFyc2UodXJsLCBwYXJzZVF1ZXJ5U3RyaW5nLCBzbGFzaGVzRGVub3RlSG9zdCkgewogICAgaWYgKHVybCAmJiBpc09iamVjdCh1cmwpICYmIHVybCBpbnN0YW5jZW9mIFVybCkgcmV0dXJuIHVybDsKICAKICAgIHZhciB1ID0gbmV3IFVybDsKICAgIHUucGFyc2UodXJsLCBwYXJzZVF1ZXJ5U3RyaW5nLCBzbGFzaGVzRGVub3RlSG9zdCk7CiAgICByZXR1cm4gdTsKICB9CiAgCiAgVXJsLnByb3RvdHlwZS5wYXJzZSA9IGZ1bmN0aW9uKHVybCwgcGFyc2VRdWVyeVN0cmluZywgc2xhc2hlc0Rlbm90ZUhvc3QpIHsKICAgIGlmICghaXNTdHJpbmcodXJsKSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJQYXJhbWV0ZXIgJ3VybCcgbXVzdCBiZSBhIHN0cmluZywgbm90ICIgKyB0eXBlb2YgdXJsKTsKICAgIH0KICAKICAgIHZhciByZXN0ID0gdXJsOwogIAogICAgLy8gdHJpbSBiZWZvcmUgcHJvY2VlZGluZy4KICAgIC8vIFRoaXMgaXMgdG8gc3VwcG9ydCBwYXJzZSBzdHVmZiBsaWtlICIgIGh0dHA6Ly9mb28uY29tICBcbiIKICAgIHJlc3QgPSByZXN0LnRyaW0oKTsKICAKICAgIHZhciBwcm90byA9IHByb3RvY29sUGF0dGVybi5leGVjKHJlc3QpOwogICAgaWYgKHByb3RvKSB7CiAgICAgIHByb3RvID0gcHJvdG9bMF07CiAgICAgIHZhciBsb3dlclByb3RvID0gcHJvdG8udG9Mb3dlckNhc2UoKTsKICAgICAgdGhpcy5wcm90b2NvbCA9IGxvd2VyUHJvdG87CiAgICAgIHJlc3QgPSByZXN0LnN1YnN0cihwcm90by5sZW5ndGgpOwogICAgfQogIAogICAgLy8gZmlndXJlIG91dCBpZiBpdCdzIGdvdCBhIGhvc3QKICAgIC8vIHVzZXJAc2VydmVyIGlzICphbHdheXMqIGludGVycHJldGVkIGFzIGEgaG9zdG5hbWUsIGFuZCB1cmwKICAgIC8vIHJlc29sdXRpb24gd2lsbCB0cmVhdCAvL2Zvby9iYXIgYXMgaG9zdD1mb28scGF0aD1iYXIgYmVjYXVzZSB0aGF0J3MKICAgIC8vIGhvdyB0aGUgYnJvd3NlciByZXNvbHZlcyByZWxhdGl2ZSBVUkxzLgogICAgaWYgKHNsYXNoZXNEZW5vdGVIb3N0IHx8IHByb3RvIHx8IHJlc3QubWF0Y2goL15cL1wvW15AXC9dK0BbXkBcL10rLykpIHsKICAgICAgdmFyIHNsYXNoZXMgPSByZXN0LnN1YnN0cigwLCAyKSA9PT0gJy8vJzsKICAgICAgaWYgKHNsYXNoZXMgJiYgIShwcm90byAmJiBob3N0bGVzc1Byb3RvY29sW3Byb3RvXSkpIHsKICAgICAgICByZXN0ID0gcmVzdC5zdWJzdHIoMik7CiAgICAgICAgdGhpcy5zbGFzaGVzID0gdHJ1ZTsKICAgICAgfQogICAgfQogIAogICAgaWYgKCFob3N0bGVzc1Byb3RvY29sW3Byb3RvXSAmJgogICAgICAgIChzbGFzaGVzIHx8IChwcm90byAmJiAhc2xhc2hlZFByb3RvY29sW3Byb3RvXSkpKSB7CiAgCiAgICAgIC8vIHRoZXJlJ3MgYSBob3N0bmFtZS4KICAgICAgLy8gdGhlIGZpcnN0IGluc3RhbmNlIG9mIC8sID8sIDssIG9yICMgZW5kcyB0aGUgaG9zdC4KICAgICAgLy8KICAgICAgLy8gSWYgdGhlcmUgaXMgYW4gQCBpbiB0aGUgaG9zdG5hbWUsIHRoZW4gbm9uLWhvc3QgY2hhcnMgKmFyZSogYWxsb3dlZAogICAgICAvLyB0byB0aGUgbGVmdCBvZiB0aGUgbGFzdCBAIHNpZ24sIHVubGVzcyBzb21lIGhvc3QtZW5kaW5nIGNoYXJhY3RlcgogICAgICAvLyBjb21lcyAqYmVmb3JlKiB0aGUgQC1zaWduLgogICAgICAvLyBVUkxzIGFyZSBvYm5veGlvdXMuCiAgICAgIC8vCiAgICAgIC8vIGV4OgogICAgICAvLyBodHRwOi8vYUBiQGMvID0+IHVzZXI6YUBiIGhvc3Q6YwogICAgICAvLyBodHRwOi8vYUBiP0BjID0+IHVzZXI6YSBob3N0OmMgcGF0aDovP0BjCiAgCiAgICAgIC8vIHYwLjEyIFRPRE8oaXNhYWNzKTogVGhpcyBpcyBub3QgcXVpdGUgaG93IENocm9tZSBkb2VzIHRoaW5ncy4KICAgICAgLy8gUmV2aWV3IG91ciB0ZXN0IGNhc2UgYWdhaW5zdCBicm93c2VycyBtb3JlIGNvbXByZWhlbnNpdmVseS4KICAKICAgICAgLy8gZmluZCB0aGUgZmlyc3QgaW5zdGFuY2Ugb2YgYW55IGhvc3RFbmRpbmdDaGFycwogICAgICB2YXIgaG9zdEVuZCA9IC0xOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhvc3RFbmRpbmdDaGFycy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBoZWMgPSByZXN0LmluZGV4T2YoaG9zdEVuZGluZ0NoYXJzW2ldKTsKICAgICAgICBpZiAoaGVjICE9PSAtMSAmJiAoaG9zdEVuZCA9PT0gLTEgfHwgaGVjIDwgaG9zdEVuZCkpCiAgICAgICAgICBob3N0RW5kID0gaGVjOwogICAgICB9CiAgCiAgICAgIC8vIGF0IHRoaXMgcG9pbnQsIGVpdGhlciB3ZSBoYXZlIGFuIGV4cGxpY2l0IHBvaW50IHdoZXJlIHRoZQogICAgICAvLyBhdXRoIHBvcnRpb24gY2Fubm90IGdvIHBhc3QsIG9yIHRoZSBsYXN0IEAgY2hhciBpcyB0aGUgZGVjaWRlci4KICAgICAgdmFyIGF1dGgsIGF0U2lnbjsKICAgICAgaWYgKGhvc3RFbmQgPT09IC0xKSB7CiAgICAgICAgLy8gYXRTaWduIGNhbiBiZSBhbnl3aGVyZS4KICAgICAgICBhdFNpZ24gPSByZXN0Lmxhc3RJbmRleE9mKCdAJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gYXRTaWduIG11c3QgYmUgaW4gYXV0aCBwb3J0aW9uLgogICAgICAgIC8vIGh0dHA6Ly9hQGIvY0BkID0+IGhvc3Q6YiBhdXRoOmEgcGF0aDovY0BkCiAgICAgICAgYXRTaWduID0gcmVzdC5sYXN0SW5kZXhPZignQCcsIGhvc3RFbmQpOwogICAgICB9CiAgCiAgICAgIC8vIE5vdyB3ZSBoYXZlIGEgcG9ydGlvbiB3aGljaCBpcyBkZWZpbml0ZWx5IHRoZSBhdXRoLgogICAgICAvLyBQdWxsIHRoYXQgb2ZmLgogICAgICBpZiAoYXRTaWduICE9PSAtMSkgewogICAgICAgIGF1dGggPSByZXN0LnNsaWNlKDAsIGF0U2lnbik7CiAgICAgICAgcmVzdCA9IHJlc3Quc2xpY2UoYXRTaWduICsgMSk7CiAgICAgICAgdGhpcy5hdXRoID0gZGVjb2RlVVJJQ29tcG9uZW50KGF1dGgpOwogICAgICB9CiAgCiAgICAgIC8vIHRoZSBob3N0IGlzIHRoZSByZW1haW5pbmcgdG8gdGhlIGxlZnQgb2YgdGhlIGZpcnN0IG5vbi1ob3N0IGNoYXIKICAgICAgaG9zdEVuZCA9IC0xOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vbkhvc3RDaGFycy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBoZWMgPSByZXN0LmluZGV4T2Yobm9uSG9zdENoYXJzW2ldKTsKICAgICAgICBpZiAoaGVjICE9PSAtMSAmJiAoaG9zdEVuZCA9PT0gLTEgfHwgaGVjIDwgaG9zdEVuZCkpCiAgICAgICAgICBob3N0RW5kID0gaGVjOwogICAgICB9CiAgICAgIC8vIGlmIHdlIHN0aWxsIGhhdmUgbm90IGhpdCBpdCwgdGhlbiB0aGUgZW50aXJlIHRoaW5nIGlzIGEgaG9zdC4KICAgICAgaWYgKGhvc3RFbmQgPT09IC0xKQogICAgICAgIGhvc3RFbmQgPSByZXN0Lmxlbmd0aDsKICAKICAgICAgdGhpcy5ob3N0ID0gcmVzdC5zbGljZSgwLCBob3N0RW5kKTsKICAgICAgcmVzdCA9IHJlc3Quc2xpY2UoaG9zdEVuZCk7CiAgCiAgICAgIC8vIHB1bGwgb3V0IHBvcnQuCiAgICAgIHRoaXMucGFyc2VIb3N0KCk7CiAgCiAgICAgIC8vIHdlJ3ZlIGluZGljYXRlZCB0aGF0IHRoZXJlIGlzIGEgaG9zdG5hbWUsCiAgICAgIC8vIHNvIGV2ZW4gaWYgaXQncyBlbXB0eSwgaXQgaGFzIHRvIGJlIHByZXNlbnQuCiAgICAgIHRoaXMuaG9zdG5hbWUgPSB0aGlzLmhvc3RuYW1lIHx8ICcnOwogIAogICAgICAvLyBpZiBob3N0bmFtZSBiZWdpbnMgd2l0aCBbIGFuZCBlbmRzIHdpdGggXQogICAgICAvLyBhc3N1bWUgdGhhdCBpdCdzIGFuIElQdjYgYWRkcmVzcy4KICAgICAgdmFyIGlwdjZIb3N0bmFtZSA9IHRoaXMuaG9zdG5hbWVbMF0gPT09ICdbJyAmJgogICAgICAgICAgdGhpcy5ob3N0bmFtZVt0aGlzLmhvc3RuYW1lLmxlbmd0aCAtIDFdID09PSAnXSc7CiAgCiAgICAgIC8vIHZhbGlkYXRlIGEgbGl0dGxlLgogICAgICBpZiAoIWlwdjZIb3N0bmFtZSkgewogICAgICAgIHZhciBob3N0cGFydHMgPSB0aGlzLmhvc3RuYW1lLnNwbGl0KC9cLi8pOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gaG9zdHBhcnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdmFyIHBhcnQgPSBob3N0cGFydHNbaV07CiAgICAgICAgICBpZiAoIXBhcnQpIGNvbnRpbnVlOwogICAgICAgICAgaWYgKCFwYXJ0Lm1hdGNoKGhvc3RuYW1lUGFydFBhdHRlcm4pKSB7CiAgICAgICAgICAgIHZhciBuZXdwYXJ0ID0gJyc7CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBrID0gcGFydC5sZW5ndGg7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgICBpZiAocGFydC5jaGFyQ29kZUF0KGopID4gMTI3KSB7CiAgICAgICAgICAgICAgICAvLyB3ZSByZXBsYWNlIG5vbi1BU0NJSSBjaGFyIHdpdGggYSB0ZW1wb3JhcnkgcGxhY2Vob2xkZXIKICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgdGhpcyB0byBtYWtlIHN1cmUgc2l6ZSBvZiBob3N0bmFtZSBpcyBub3QKICAgICAgICAgICAgICAgIC8vIGJyb2tlbiBieSByZXBsYWNpbmcgbm9uLUFTQ0lJIGJ5IG5vdGhpbmcKICAgICAgICAgICAgICAgIG5ld3BhcnQgKz0gJ3gnOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXdwYXJ0ICs9IHBhcnRbal07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHdlIHRlc3QgYWdhaW4gd2l0aCBBU0NJSSBjaGFyIG9ubHkKICAgICAgICAgICAgaWYgKCFuZXdwYXJ0Lm1hdGNoKGhvc3RuYW1lUGFydFBhdHRlcm4pKSB7CiAgICAgICAgICAgICAgdmFyIHZhbGlkUGFydHMgPSBob3N0cGFydHMuc2xpY2UoMCwgaSk7CiAgICAgICAgICAgICAgdmFyIG5vdEhvc3QgPSBob3N0cGFydHMuc2xpY2UoaSArIDEpOwogICAgICAgICAgICAgIHZhciBiaXQgPSBwYXJ0Lm1hdGNoKGhvc3RuYW1lUGFydFN0YXJ0KTsKICAgICAgICAgICAgICBpZiAoYml0KSB7CiAgICAgICAgICAgICAgICB2YWxpZFBhcnRzLnB1c2goYml0WzFdKTsKICAgICAgICAgICAgICAgIG5vdEhvc3QudW5zaGlmdChiaXRbMl0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm90SG9zdC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHJlc3QgPSAnLycgKyBub3RIb3N0LmpvaW4oJy4nKSArIHJlc3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuaG9zdG5hbWUgPSB2YWxpZFBhcnRzLmpvaW4oJy4nKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogIAogICAgICBpZiAodGhpcy5ob3N0bmFtZS5sZW5ndGggPiBob3N0bmFtZU1heExlbikgewogICAgICAgIHRoaXMuaG9zdG5hbWUgPSAnJzsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBob3N0bmFtZXMgYXJlIGFsd2F5cyBsb3dlciBjYXNlLgogICAgICAgIHRoaXMuaG9zdG5hbWUgPSB0aGlzLmhvc3RuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgIH0KICAKICAgICAgaWYgKCFpcHY2SG9zdG5hbWUpIHsKICAgICAgICAvLyBJRE5BIFN1cHBvcnQ6IFJldHVybnMgYSBwdW55IGNvZGVkIHJlcHJlc2VudGF0aW9uIG9mICJkb21haW4iLgogICAgICAgIC8vIEl0IG9ubHkgY29udmVydHMgdGhlIHBhcnQgb2YgdGhlIGRvbWFpbiBuYW1lIHRoYXQKICAgICAgICAvLyBoYXMgbm9uIEFTQ0lJIGNoYXJhY3RlcnMuIEkuZS4gaXQgZG9zZW50IG1hdHRlciBpZgogICAgICAgIC8vIHlvdSBjYWxsIGl0IHdpdGggYSBkb21haW4gdGhhdCBhbHJlYWR5IGlzIGluIEFTQ0lJLgogICAgICAgIHZhciBkb21haW5BcnJheSA9IHRoaXMuaG9zdG5hbWUuc3BsaXQoJy4nKTsKICAgICAgICB2YXIgbmV3T3V0ID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkb21haW5BcnJheS5sZW5ndGg7ICsraSkgewogICAgICAgICAgdmFyIHMgPSBkb21haW5BcnJheVtpXTsKICAgICAgICAgIG5ld091dC5wdXNoKHMubWF0Y2goL1teQS1aYS16MC05Xy1dLykgPwogICAgICAgICAgICAgICd4bi0tJyArIHB1bnljb2RlLmVuY29kZShzKSA6IHMpOwogICAgICAgIH0KICAgICAgICB0aGlzLmhvc3RuYW1lID0gbmV3T3V0LmpvaW4oJy4nKTsKICAgICAgfQogIAogICAgICB2YXIgcCA9IHRoaXMucG9ydCA/ICc6JyArIHRoaXMucG9ydCA6ICcnOwogICAgICB2YXIgaCA9IHRoaXMuaG9zdG5hbWUgfHwgJyc7CiAgICAgIHRoaXMuaG9zdCA9IGggKyBwOwogICAgICB0aGlzLmhyZWYgKz0gdGhpcy5ob3N0OwogIAogICAgICAvLyBzdHJpcCBbIGFuZCBdIGZyb20gdGhlIGhvc3RuYW1lCiAgICAgIC8vIHRoZSBob3N0IGZpZWxkIHN0aWxsIHJldGFpbnMgdGhlbSwgdGhvdWdoCiAgICAgIGlmIChpcHY2SG9zdG5hbWUpIHsKICAgICAgICB0aGlzLmhvc3RuYW1lID0gdGhpcy5ob3N0bmFtZS5zdWJzdHIoMSwgdGhpcy5ob3N0bmFtZS5sZW5ndGggLSAyKTsKICAgICAgICBpZiAocmVzdFswXSAhPT0gJy8nKSB7CiAgICAgICAgICByZXN0ID0gJy8nICsgcmVzdDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAKICAgIC8vIG5vdyByZXN0IGlzIHNldCB0byB0aGUgcG9zdC1ob3N0IHN0dWZmLgogICAgLy8gY2hvcCBvZmYgYW55IGRlbGltIGNoYXJzLgogICAgaWYgKCF1bnNhZmVQcm90b2NvbFtsb3dlclByb3RvXSkgewogIAogICAgICAvLyBGaXJzdCwgbWFrZSAxMDAlIHN1cmUgdGhhdCBhbnkgImF1dG9Fc2NhcGUiIGNoYXJzIGdldAogICAgICAvLyBlc2NhcGVkLCBldmVuIGlmIGVuY29kZVVSSUNvbXBvbmVudCBkb2Vzbid0IHRoaW5rIHRoZXkKICAgICAgLy8gbmVlZCB0byBiZS4KICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBhdXRvRXNjYXBlLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHZhciBhZSA9IGF1dG9Fc2NhcGVbaV07CiAgICAgICAgdmFyIGVzYyA9IGVuY29kZVVSSUNvbXBvbmVudChhZSk7CiAgICAgICAgaWYgKGVzYyA9PT0gYWUpIHsKICAgICAgICAgIGVzYyA9IGVzY2FwZShhZSk7CiAgICAgICAgfQogICAgICAgIHJlc3QgPSByZXN0LnNwbGl0KGFlKS5qb2luKGVzYyk7CiAgICAgIH0KICAgIH0KICAKICAKICAgIC8vIGNob3Agb2ZmIGZyb20gdGhlIHRhaWwgZmlyc3QuCiAgICB2YXIgaGFzaCA9IHJlc3QuaW5kZXhPZignIycpOwogICAgaWYgKGhhc2ggIT09IC0xKSB7CiAgICAgIC8vIGdvdCBhIGZyYWdtZW50IHN0cmluZy4KICAgICAgdGhpcy5oYXNoID0gcmVzdC5zdWJzdHIoaGFzaCk7CiAgICAgIHJlc3QgPSByZXN0LnNsaWNlKDAsIGhhc2gpOwogICAgfQogICAgdmFyIHFtID0gcmVzdC5pbmRleE9mKCc/Jyk7CiAgICBpZiAocW0gIT09IC0xKSB7CiAgICAgIHRoaXMuc2VhcmNoID0gcmVzdC5zdWJzdHIocW0pOwogICAgICB0aGlzLnF1ZXJ5ID0gcmVzdC5zdWJzdHIocW0gKyAxKTsKICAgICAgaWYgKHBhcnNlUXVlcnlTdHJpbmcpIHsKICAgICAgICB0aGlzLnF1ZXJ5ID0gcXVlcnlzdHJpbmcucGFyc2UodGhpcy5xdWVyeSk7CiAgICAgIH0KICAgICAgcmVzdCA9IHJlc3Quc2xpY2UoMCwgcW0pOwogICAgfSBlbHNlIGlmIChwYXJzZVF1ZXJ5U3RyaW5nKSB7CiAgICAgIC8vIG5vIHF1ZXJ5IHN0cmluZywgYnV0IHBhcnNlUXVlcnlTdHJpbmcgc3RpbGwgcmVxdWVzdGVkCiAgICAgIHRoaXMuc2VhcmNoID0gJyc7CiAgICAgIHRoaXMucXVlcnkgPSB7fTsKICAgIH0KICAgIGlmIChyZXN0KSB0aGlzLnBhdGhuYW1lID0gcmVzdDsKICAgIGlmIChzbGFzaGVkUHJvdG9jb2xbbG93ZXJQcm90b10gJiYKICAgICAgICB0aGlzLmhvc3RuYW1lICYmICF0aGlzLnBhdGhuYW1lKSB7CiAgICAgIHRoaXMucGF0aG5hbWUgPSAnLyc7CiAgICB9CiAgCiAgICAvL3RvIHN1cHBvcnQgaHR0cC5yZXF1ZXN0CiAgICBpZiAodGhpcy5wYXRobmFtZSB8fCB0aGlzLnNlYXJjaCkgewogICAgICB2YXIgcCA9IHRoaXMucGF0aG5hbWUgfHwgJyc7CiAgICAgIHZhciBzID0gdGhpcy5zZWFyY2ggfHwgJyc7CiAgICAgIHRoaXMucGF0aCA9IHAgKyBzOwogICAgfQogIAogICAgLy8gZmluYWxseSwgcmVjb25zdHJ1Y3QgdGhlIGhyZWYgYmFzZWQgb24gd2hhdCBoYXMgYmVlbiB2YWxpZGF0ZWQuCiAgICB0aGlzLmhyZWYgPSB0aGlzLmZvcm1hdCgpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICAvLyBmb3JtYXQgYSBwYXJzZWQgb2JqZWN0IGludG8gYSB1cmwgc3RyaW5nCiAgZnVuY3Rpb24gdXJsRm9ybWF0KG9iaikgewogICAgLy8gZW5zdXJlIGl0J3MgYW4gb2JqZWN0LCBhbmQgbm90IGEgc3RyaW5nIHVybC4KICAgIC8vIElmIGl0J3MgYW4gb2JqLCB0aGlzIGlzIGEgbm8tb3AuCiAgICAvLyB0aGlzIHdheSwgeW91IGNhbiBjYWxsIHVybF9mb3JtYXQoKSBvbiBzdHJpbmdzCiAgICAvLyB0byBjbGVhbiB1cCBwb3RlbnRpYWxseSB3b25reSB1cmxzLgogICAgaWYgKGlzU3RyaW5nKG9iaikpIG9iaiA9IHVybFBhcnNlKG9iaik7CiAgICBpZiAoIShvYmogaW5zdGFuY2VvZiBVcmwpKSByZXR1cm4gVXJsLnByb3RvdHlwZS5mb3JtYXQuY2FsbChvYmopOwogICAgcmV0dXJuIG9iai5mb3JtYXQoKTsKICB9CiAgCiAgVXJsLnByb3RvdHlwZS5mb3JtYXQgPSBmdW5jdGlvbigpIHsKICAgIHZhciBhdXRoID0gdGhpcy5hdXRoIHx8ICcnOwogICAgaWYgKGF1dGgpIHsKICAgICAgYXV0aCA9IGVuY29kZVVSSUNvbXBvbmVudChhdXRoKTsKICAgICAgYXV0aCA9IGF1dGgucmVwbGFjZSgvJTNBL2ksICc6Jyk7CiAgICAgIGF1dGggKz0gJ0AnOwogICAgfQogIAogICAgdmFyIHByb3RvY29sID0gdGhpcy5wcm90b2NvbCB8fCAnJywKICAgICAgICBwYXRobmFtZSA9IHRoaXMucGF0aG5hbWUgfHwgJycsCiAgICAgICAgaGFzaCA9IHRoaXMuaGFzaCB8fCAnJywKICAgICAgICBob3N0ID0gZmFsc2UsCiAgICAgICAgcXVlcnkgPSAnJzsKICAKICAgIGlmICh0aGlzLmhvc3QpIHsKICAgICAgaG9zdCA9IGF1dGggKyB0aGlzLmhvc3Q7CiAgICB9IGVsc2UgaWYgKHRoaXMuaG9zdG5hbWUpIHsKICAgICAgaG9zdCA9IGF1dGggKyAodGhpcy5ob3N0bmFtZS5pbmRleE9mKCc6JykgPT09IC0xID8KICAgICAgICAgIHRoaXMuaG9zdG5hbWUgOgogICAgICAgICAgJ1snICsgdGhpcy5ob3N0bmFtZSArICddJyk7CiAgICAgIGlmICh0aGlzLnBvcnQpIHsKICAgICAgICBob3N0ICs9ICc6JyArIHRoaXMucG9ydDsKICAgICAgfQogICAgfQogIAogICAgaWYgKHRoaXMucXVlcnkgJiYKICAgICAgICBpc09iamVjdCh0aGlzLnF1ZXJ5KSAmJgogICAgICAgIE9iamVjdC5rZXlzKHRoaXMucXVlcnkpLmxlbmd0aCkgewogICAgICBxdWVyeSA9IHF1ZXJ5c3RyaW5nLnN0cmluZ2lmeSh0aGlzLnF1ZXJ5KTsKICAgIH0KICAKICAgIHZhciBzZWFyY2ggPSB0aGlzLnNlYXJjaCB8fCAocXVlcnkgJiYgKCc/JyArIHF1ZXJ5KSkgfHwgJyc7CiAgCiAgICBpZiAocHJvdG9jb2wgJiYgcHJvdG9jb2wuc3Vic3RyKC0xKSAhPT0gJzonKSBwcm90b2NvbCArPSAnOic7CiAgCiAgICAvLyBvbmx5IHRoZSBzbGFzaGVkUHJvdG9jb2xzIGdldCB0aGUgLy8uICBOb3QgbWFpbHRvOiwgeG1wcDosIGV0Yy4KICAgIC8vIHVubGVzcyB0aGV5IGhhZCB0aGVtIHRvIGJlZ2luIHdpdGguCiAgICBpZiAodGhpcy5zbGFzaGVzIHx8CiAgICAgICAgKCFwcm90b2NvbCB8fCBzbGFzaGVkUHJvdG9jb2xbcHJvdG9jb2xdKSAmJiBob3N0ICE9PSBmYWxzZSkgewogICAgICBob3N0ID0gJy8vJyArIChob3N0IHx8ICcnKTsKICAgICAgaWYgKHBhdGhuYW1lICYmIHBhdGhuYW1lLmNoYXJBdCgwKSAhPT0gJy8nKSBwYXRobmFtZSA9ICcvJyArIHBhdGhuYW1lOwogICAgfSBlbHNlIGlmICghaG9zdCkgewogICAgICBob3N0ID0gJyc7CiAgICB9CiAgCiAgICBpZiAoaGFzaCAmJiBoYXNoLmNoYXJBdCgwKSAhPT0gJyMnKSBoYXNoID0gJyMnICsgaGFzaDsKICAgIGlmIChzZWFyY2ggJiYgc2VhcmNoLmNoYXJBdCgwKSAhPT0gJz8nKSBzZWFyY2ggPSAnPycgKyBzZWFyY2g7CiAgCiAgICBwYXRobmFtZSA9IHBhdGhuYW1lLnJlcGxhY2UoL1s/I10vZywgZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChtYXRjaCk7CiAgICB9KTsKICAgIHNlYXJjaCA9IHNlYXJjaC5yZXBsYWNlKCcjJywgJyUyMycpOwogIAogICAgcmV0dXJuIHByb3RvY29sICsgaG9zdCArIHBhdGhuYW1lICsgc2VhcmNoICsgaGFzaDsKICB9OwogIAogIGZ1bmN0aW9uIHVybFJlc29sdmUoc291cmNlLCByZWxhdGl2ZSkgewogICAgcmV0dXJuIHVybFBhcnNlKHNvdXJjZSwgZmFsc2UsIHRydWUpLnJlc29sdmUocmVsYXRpdmUpOwogIH0KICAKICBVcmwucHJvdG90eXBlLnJlc29sdmUgPSBmdW5jdGlvbihyZWxhdGl2ZSkgewogICAgcmV0dXJuIHRoaXMucmVzb2x2ZU9iamVjdCh1cmxQYXJzZShyZWxhdGl2ZSwgZmFsc2UsIHRydWUpKS5mb3JtYXQoKTsKICB9OwogIAogIGZ1bmN0aW9uIHVybFJlc29sdmVPYmplY3Qoc291cmNlLCByZWxhdGl2ZSkgewogICAgaWYgKCFzb3VyY2UpIHJldHVybiByZWxhdGl2ZTsKICAgIHJldHVybiB1cmxQYXJzZShzb3VyY2UsIGZhbHNlLCB0cnVlKS5yZXNvbHZlT2JqZWN0KHJlbGF0aXZlKTsKICB9CiAgCiAgVXJsLnByb3RvdHlwZS5yZXNvbHZlT2JqZWN0ID0gZnVuY3Rpb24ocmVsYXRpdmUpIHsKICAgIGlmIChpc1N0cmluZyhyZWxhdGl2ZSkpIHsKICAgICAgdmFyIHJlbCA9IG5ldyBVcmwoKTsKICAgICAgcmVsLnBhcnNlKHJlbGF0aXZlLCBmYWxzZSwgdHJ1ZSk7CiAgICAgIHJlbGF0aXZlID0gcmVsOwogICAgfQogIAogICAgdmFyIHJlc3VsdCA9IG5ldyBVcmwoKTsKICAgIE9iamVjdC5rZXlzKHRoaXMpLmZvckVhY2goZnVuY3Rpb24oaykgewogICAgICByZXN1bHRba10gPSB0aGlzW2tdOwogICAgfSwgdGhpcyk7CiAgCiAgICAvLyBoYXNoIGlzIGFsd2F5cyBvdmVycmlkZGVuLCBubyBtYXR0ZXIgd2hhdC4KICAgIC8vIGV2ZW4gaHJlZj0iIiB3aWxsIHJlbW92ZSBpdC4KICAgIHJlc3VsdC5oYXNoID0gcmVsYXRpdmUuaGFzaDsKICAKICAgIC8vIGlmIHRoZSByZWxhdGl2ZSB1cmwgaXMgZW1wdHksIHRoZW4gdGhlcmUncyBub3RoaW5nIGxlZnQgdG8gZG8gaGVyZS4KICAgIGlmIChyZWxhdGl2ZS5ocmVmID09PSAnJykgewogICAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAKICAgIC8vIGhyZWZzIGxpa2UgLy9mb28vYmFyIGFsd2F5cyBjdXQgdG8gdGhlIHByb3RvY29sLgogICAgaWYgKHJlbGF0aXZlLnNsYXNoZXMgJiYgIXJlbGF0aXZlLnByb3RvY29sKSB7CiAgICAgIC8vIHRha2UgZXZlcnl0aGluZyBleGNlcHQgdGhlIHByb3RvY29sIGZyb20gcmVsYXRpdmUKICAgICAgT2JqZWN0LmtleXMocmVsYXRpdmUpLmZvckVhY2goZnVuY3Rpb24oaykgewogICAgICAgIGlmIChrICE9PSAncHJvdG9jb2wnKQogICAgICAgICAgcmVzdWx0W2tdID0gcmVsYXRpdmVba107CiAgICAgIH0pOwogIAogICAgICAvL3VybFBhcnNlIGFwcGVuZHMgdHJhaWxpbmcgLyB0byB1cmxzIGxpa2UgaHR0cDovL3d3dy5leGFtcGxlLmNvbQogICAgICBpZiAoc2xhc2hlZFByb3RvY29sW3Jlc3VsdC5wcm90b2NvbF0gJiYKICAgICAgICAgIHJlc3VsdC5ob3N0bmFtZSAmJiAhcmVzdWx0LnBhdGhuYW1lKSB7CiAgICAgICAgcmVzdWx0LnBhdGggPSByZXN1bHQucGF0aG5hbWUgPSAnLyc7CiAgICAgIH0KICAKICAgICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgCiAgICBpZiAocmVsYXRpdmUucHJvdG9jb2wgJiYgcmVsYXRpdmUucHJvdG9jb2wgIT09IHJlc3VsdC5wcm90b2NvbCkgewogICAgICAvLyBpZiBpdCdzIGEga25vd24gdXJsIHByb3RvY29sLCB0aGVuIGNoYW5naW5nCiAgICAgIC8vIHRoZSBwcm90b2NvbCBkb2VzIHdlaXJkIHRoaW5ncwogICAgICAvLyBmaXJzdCwgaWYgaXQncyBub3QgZmlsZTosIHRoZW4gd2UgTVVTVCBoYXZlIGEgaG9zdCwKICAgICAgLy8gYW5kIGlmIHRoZXJlIHdhcyBhIHBhdGgKICAgICAgLy8gdG8gYmVnaW4gd2l0aCwgdGhlbiB3ZSBNVVNUIGhhdmUgYSBwYXRoLgogICAgICAvLyBpZiBpdCBpcyBmaWxlOiwgdGhlbiB0aGUgaG9zdCBpcyBkcm9wcGVkLAogICAgICAvLyBiZWNhdXNlIHRoYXQncyBrbm93biB0byBiZSBob3N0bGVzcy4KICAgICAgLy8gYW55dGhpbmcgZWxzZSBpcyBhc3N1bWVkIHRvIGJlIGFic29sdXRlLgogICAgICBpZiAoIXNsYXNoZWRQcm90b2NvbFtyZWxhdGl2ZS5wcm90b2NvbF0pIHsKICAgICAgICBPYmplY3Qua2V5cyhyZWxhdGl2ZSkuZm9yRWFjaChmdW5jdGlvbihrKSB7CiAgICAgICAgICByZXN1bHRba10gPSByZWxhdGl2ZVtrXTsKICAgICAgICB9KTsKICAgICAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgCiAgICAgIHJlc3VsdC5wcm90b2NvbCA9IHJlbGF0aXZlLnByb3RvY29sOwogICAgICBpZiAoIXJlbGF0aXZlLmhvc3QgJiYgIWhvc3RsZXNzUHJvdG9jb2xbcmVsYXRpdmUucHJvdG9jb2xdKSB7CiAgICAgICAgdmFyIHJlbFBhdGggPSAocmVsYXRpdmUucGF0aG5hbWUgfHwgJycpLnNwbGl0KCcvJyk7CiAgICAgICAgd2hpbGUgKHJlbFBhdGgubGVuZ3RoICYmICEocmVsYXRpdmUuaG9zdCA9IHJlbFBhdGguc2hpZnQoKSkpOwogICAgICAgIGlmICghcmVsYXRpdmUuaG9zdCkgcmVsYXRpdmUuaG9zdCA9ICcnOwogICAgICAgIGlmICghcmVsYXRpdmUuaG9zdG5hbWUpIHJlbGF0aXZlLmhvc3RuYW1lID0gJyc7CiAgICAgICAgaWYgKHJlbFBhdGhbMF0gIT09ICcnKSByZWxQYXRoLnVuc2hpZnQoJycpOwogICAgICAgIGlmIChyZWxQYXRoLmxlbmd0aCA8IDIpIHJlbFBhdGgudW5zaGlmdCgnJyk7CiAgICAgICAgcmVzdWx0LnBhdGhuYW1lID0gcmVsUGF0aC5qb2luKCcvJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0LnBhdGhuYW1lID0gcmVsYXRpdmUucGF0aG5hbWU7CiAgICAgIH0KICAgICAgcmVzdWx0LnNlYXJjaCA9IHJlbGF0aXZlLnNlYXJjaDsKICAgICAgcmVzdWx0LnF1ZXJ5ID0gcmVsYXRpdmUucXVlcnk7CiAgICAgIHJlc3VsdC5ob3N0ID0gcmVsYXRpdmUuaG9zdCB8fCAnJzsKICAgICAgcmVzdWx0LmF1dGggPSByZWxhdGl2ZS5hdXRoOwogICAgICByZXN1bHQuaG9zdG5hbWUgPSByZWxhdGl2ZS5ob3N0bmFtZSB8fCByZWxhdGl2ZS5ob3N0OwogICAgICByZXN1bHQucG9ydCA9IHJlbGF0aXZlLnBvcnQ7CiAgICAgIC8vIHRvIHN1cHBvcnQgaHR0cC5yZXF1ZXN0CiAgICAgIGlmIChyZXN1bHQucGF0aG5hbWUgfHwgcmVzdWx0LnNlYXJjaCkgewogICAgICAgIHZhciBwID0gcmVzdWx0LnBhdGhuYW1lIHx8ICcnOwogICAgICAgIHZhciBzID0gcmVzdWx0LnNlYXJjaCB8fCAnJzsKICAgICAgICByZXN1bHQucGF0aCA9IHAgKyBzOwogICAgICB9CiAgICAgIHJlc3VsdC5zbGFzaGVzID0gcmVzdWx0LnNsYXNoZXMgfHwgcmVsYXRpdmUuc2xhc2hlczsKICAgICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgCiAgICB2YXIgaXNTb3VyY2VBYnMgPSAocmVzdWx0LnBhdGhuYW1lICYmIHJlc3VsdC5wYXRobmFtZS5jaGFyQXQoMCkgPT09ICcvJyksCiAgICAgICAgaXNSZWxBYnMgPSAoCiAgICAgICAgICAgIHJlbGF0aXZlLmhvc3QgfHwKICAgICAgICAgICAgcmVsYXRpdmUucGF0aG5hbWUgJiYgcmVsYXRpdmUucGF0aG5hbWUuY2hhckF0KDApID09PSAnLycKICAgICAgICApLAogICAgICAgIG11c3RFbmRBYnMgPSAoaXNSZWxBYnMgfHwgaXNTb3VyY2VBYnMgfHwKICAgICAgICAgICAgICAgICAgICAgIChyZXN1bHQuaG9zdCAmJiByZWxhdGl2ZS5wYXRobmFtZSkpLAogICAgICAgIHJlbW92ZUFsbERvdHMgPSBtdXN0RW5kQWJzLAogICAgICAgIHNyY1BhdGggPSByZXN1bHQucGF0aG5hbWUgJiYgcmVzdWx0LnBhdGhuYW1lLnNwbGl0KCcvJykgfHwgW10sCiAgICAgICAgcmVsUGF0aCA9IHJlbGF0aXZlLnBhdGhuYW1lICYmIHJlbGF0aXZlLnBhdGhuYW1lLnNwbGl0KCcvJykgfHwgW10sCiAgICAgICAgcHN5Y2hvdGljID0gcmVzdWx0LnByb3RvY29sICYmICFzbGFzaGVkUHJvdG9jb2xbcmVzdWx0LnByb3RvY29sXTsKICAKICAgIC8vIGlmIHRoZSB1cmwgaXMgYSBub24tc2xhc2hlZCB1cmwsIHRoZW4gcmVsYXRpdmUKICAgIC8vIGxpbmtzIGxpa2UgLi4vLi4gc2hvdWxkIGJlIGFibGUKICAgIC8vIHRvIGNyYXdsIHVwIHRvIHRoZSBob3N0bmFtZSwgYXMgd2VsbC4gIFRoaXMgaXMgc3RyYW5nZS4KICAgIC8vIHJlc3VsdC5wcm90b2NvbCBoYXMgYWxyZWFkeSBiZWVuIHNldCBieSBub3cuCiAgICAvLyBMYXRlciBvbiwgcHV0IHRoZSBmaXJzdCBwYXRoIHBhcnQgaW50byB0aGUgaG9zdCBmaWVsZC4KICAgIGlmIChwc3ljaG90aWMpIHsKICAgICAgcmVzdWx0Lmhvc3RuYW1lID0gJyc7CiAgICAgIHJlc3VsdC5wb3J0ID0gbnVsbDsKICAgICAgaWYgKHJlc3VsdC5ob3N0KSB7CiAgICAgICAgaWYgKHNyY1BhdGhbMF0gPT09ICcnKSBzcmNQYXRoWzBdID0gcmVzdWx0Lmhvc3Q7CiAgICAgICAgZWxzZSBzcmNQYXRoLnVuc2hpZnQocmVzdWx0Lmhvc3QpOwogICAgICB9CiAgICAgIHJlc3VsdC5ob3N0ID0gJyc7CiAgICAgIGlmIChyZWxhdGl2ZS5wcm90b2NvbCkgewogICAgICAgIHJlbGF0aXZlLmhvc3RuYW1lID0gbnVsbDsKICAgICAgICByZWxhdGl2ZS5wb3J0ID0gbnVsbDsKICAgICAgICBpZiAocmVsYXRpdmUuaG9zdCkgewogICAgICAgICAgaWYgKHJlbFBhdGhbMF0gPT09ICcnKSByZWxQYXRoWzBdID0gcmVsYXRpdmUuaG9zdDsKICAgICAgICAgIGVsc2UgcmVsUGF0aC51bnNoaWZ0KHJlbGF0aXZlLmhvc3QpOwogICAgICAgIH0KICAgICAgICByZWxhdGl2ZS5ob3N0ID0gbnVsbDsKICAgICAgfQogICAgICBtdXN0RW5kQWJzID0gbXVzdEVuZEFicyAmJiAocmVsUGF0aFswXSA9PT0gJycgfHwgc3JjUGF0aFswXSA9PT0gJycpOwogICAgfQogIAogICAgaWYgKGlzUmVsQWJzKSB7CiAgICAgIC8vIGl0J3MgYWJzb2x1dGUuCiAgICAgIHJlc3VsdC5ob3N0ID0gKHJlbGF0aXZlLmhvc3QgfHwgcmVsYXRpdmUuaG9zdCA9PT0gJycpID8KICAgICAgICAgICAgICAgICAgICByZWxhdGl2ZS5ob3N0IDogcmVzdWx0Lmhvc3Q7CiAgICAgIHJlc3VsdC5ob3N0bmFtZSA9IChyZWxhdGl2ZS5ob3N0bmFtZSB8fCByZWxhdGl2ZS5ob3N0bmFtZSA9PT0gJycpID8KICAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRpdmUuaG9zdG5hbWUgOiByZXN1bHQuaG9zdG5hbWU7CiAgICAgIHJlc3VsdC5zZWFyY2ggPSByZWxhdGl2ZS5zZWFyY2g7CiAgICAgIHJlc3VsdC5xdWVyeSA9IHJlbGF0aXZlLnF1ZXJ5OwogICAgICBzcmNQYXRoID0gcmVsUGF0aDsKICAgICAgLy8gZmFsbCB0aHJvdWdoIHRvIHRoZSBkb3QtaGFuZGxpbmcgYmVsb3cuCiAgICB9IGVsc2UgaWYgKHJlbFBhdGgubGVuZ3RoKSB7CiAgICAgIC8vIGl0J3MgcmVsYXRpdmUKICAgICAgLy8gdGhyb3cgYXdheSB0aGUgZXhpc3RpbmcgZmlsZSwgYW5kIHRha2UgdGhlIG5ldyBwYXRoIGluc3RlYWQuCiAgICAgIGlmICghc3JjUGF0aCkgc3JjUGF0aCA9IFtdOwogICAgICBzcmNQYXRoLnBvcCgpOwogICAgICBzcmNQYXRoID0gc3JjUGF0aC5jb25jYXQocmVsUGF0aCk7CiAgICAgIHJlc3VsdC5zZWFyY2ggPSByZWxhdGl2ZS5zZWFyY2g7CiAgICAgIHJlc3VsdC5xdWVyeSA9IHJlbGF0aXZlLnF1ZXJ5OwogICAgfSBlbHNlIGlmICghaXNOdWxsT3JVbmRlZmluZWQocmVsYXRpdmUuc2VhcmNoKSkgewogICAgICAvLyBqdXN0IHB1bGwgb3V0IHRoZSBzZWFyY2guCiAgICAgIC8vIGxpa2UgaHJlZj0nP2ZvbycuCiAgICAgIC8vIFB1dCB0aGlzIGFmdGVyIHRoZSBvdGhlciB0d28gY2FzZXMgYmVjYXVzZSBpdCBzaW1wbGlmaWVzIHRoZSBib29sZWFucwogICAgICBpZiAocHN5Y2hvdGljKSB7CiAgICAgICAgcmVzdWx0Lmhvc3RuYW1lID0gcmVzdWx0Lmhvc3QgPSBzcmNQYXRoLnNoaWZ0KCk7CiAgICAgICAgLy9vY2NhdGlvbmFseSB0aGUgYXV0aCBjYW4gZ2V0IHN0dWNrIG9ubHkgaW4gaG9zdAogICAgICAgIC8vdGhpcyBlc3BlY2lhbHkgaGFwcGVucyBpbiBjYXNlcyBsaWtlCiAgICAgICAgLy91cmwucmVzb2x2ZU9iamVjdCgnbWFpbHRvOmxvY2FsMUBkb21haW4xJywgJ2xvY2FsMkBkb21haW4yJykKICAgICAgICB2YXIgYXV0aEluSG9zdCA9IHJlc3VsdC5ob3N0ICYmIHJlc3VsdC5ob3N0LmluZGV4T2YoJ0AnKSA+IDAgPwogICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lmhvc3Quc3BsaXQoJ0AnKSA6IGZhbHNlOwogICAgICAgIGlmIChhdXRoSW5Ib3N0KSB7CiAgICAgICAgICByZXN1bHQuYXV0aCA9IGF1dGhJbkhvc3Quc2hpZnQoKTsKICAgICAgICAgIHJlc3VsdC5ob3N0ID0gcmVzdWx0Lmhvc3RuYW1lID0gYXV0aEluSG9zdC5zaGlmdCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXN1bHQuc2VhcmNoID0gcmVsYXRpdmUuc2VhcmNoOwogICAgICByZXN1bHQucXVlcnkgPSByZWxhdGl2ZS5xdWVyeTsKICAgICAgLy90byBzdXBwb3J0IGh0dHAucmVxdWVzdAogICAgICBpZiAoIWlzTnVsbChyZXN1bHQucGF0aG5hbWUpIHx8ICFpc051bGwocmVzdWx0LnNlYXJjaCkpIHsKICAgICAgICByZXN1bHQucGF0aCA9IChyZXN1bHQucGF0aG5hbWUgPyByZXN1bHQucGF0aG5hbWUgOiAnJykgKwogICAgICAgICAgICAgICAgICAgICAgKHJlc3VsdC5zZWFyY2ggPyByZXN1bHQuc2VhcmNoIDogJycpOwogICAgICB9CiAgICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIAogICAgaWYgKCFzcmNQYXRoLmxlbmd0aCkgewogICAgICAvLyBubyBwYXRoIGF0IGFsbC4gIGVhc3kuCiAgICAgIC8vIHdlJ3ZlIGFscmVhZHkgaGFuZGxlZCB0aGUgb3RoZXIgc3R1ZmYgYWJvdmUuCiAgICAgIHJlc3VsdC5wYXRobmFtZSA9IG51bGw7CiAgICAgIC8vdG8gc3VwcG9ydCBodHRwLnJlcXVlc3QKICAgICAgaWYgKHJlc3VsdC5zZWFyY2gpIHsKICAgICAgICByZXN1bHQucGF0aCA9ICcvJyArIHJlc3VsdC5zZWFyY2g7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0LnBhdGggPSBudWxsOwogICAgICB9CiAgICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIAogICAgLy8gaWYgYSB1cmwgRU5EcyBpbiAuIG9yIC4uLCB0aGVuIGl0IG11c3QgZ2V0IGEgdHJhaWxpbmcgc2xhc2guCiAgICAvLyBob3dldmVyLCBpZiBpdCBlbmRzIGluIGFueXRoaW5nIGVsc2Ugbm9uLXNsYXNoeSwKICAgIC8vIHRoZW4gaXQgbXVzdCBOT1QgZ2V0IGEgdHJhaWxpbmcgc2xhc2guCiAgICB2YXIgbGFzdCA9IHNyY1BhdGguc2xpY2UoLTEpWzBdOwogICAgdmFyIGhhc1RyYWlsaW5nU2xhc2ggPSAoCiAgICAgICAgKHJlc3VsdC5ob3N0IHx8IHJlbGF0aXZlLmhvc3QpICYmIChsYXN0ID09PSAnLicgfHwgbGFzdCA9PT0gJy4uJykgfHwKICAgICAgICBsYXN0ID09PSAnJyk7CiAgCiAgICAvLyBzdHJpcCBzaW5nbGUgZG90cywgcmVzb2x2ZSBkb3VibGUgZG90cyB0byBwYXJlbnQgZGlyCiAgICAvLyBpZiB0aGUgcGF0aCB0cmllcyB0byBnbyBhYm92ZSB0aGUgcm9vdCwgYHVwYCBlbmRzIHVwID4gMAogICAgdmFyIHVwID0gMDsKICAgIGZvciAodmFyIGkgPSBzcmNQYXRoLmxlbmd0aDsgaSA+PSAwOyBpLS0pIHsKICAgICAgbGFzdCA9IHNyY1BhdGhbaV07CiAgICAgIGlmIChsYXN0ID09ICcuJykgewogICAgICAgIHNyY1BhdGguc3BsaWNlKGksIDEpOwogICAgICB9IGVsc2UgaWYgKGxhc3QgPT09ICcuLicpIHsKICAgICAgICBzcmNQYXRoLnNwbGljZShpLCAxKTsKICAgICAgICB1cCsrOwogICAgICB9IGVsc2UgaWYgKHVwKSB7CiAgICAgICAgc3JjUGF0aC5zcGxpY2UoaSwgMSk7CiAgICAgICAgdXAtLTsKICAgICAgfQogICAgfQogIAogICAgLy8gaWYgdGhlIHBhdGggaXMgYWxsb3dlZCB0byBnbyBhYm92ZSB0aGUgcm9vdCwgcmVzdG9yZSBsZWFkaW5nIC4ucwogICAgaWYgKCFtdXN0RW5kQWJzICYmICFyZW1vdmVBbGxEb3RzKSB7CiAgICAgIGZvciAoOyB1cC0tOyB1cCkgewogICAgICAgIHNyY1BhdGgudW5zaGlmdCgnLi4nKTsKICAgICAgfQogICAgfQogIAogICAgaWYgKG11c3RFbmRBYnMgJiYgc3JjUGF0aFswXSAhPT0gJycgJiYKICAgICAgICAoIXNyY1BhdGhbMF0gfHwgc3JjUGF0aFswXS5jaGFyQXQoMCkgIT09ICcvJykpIHsKICAgICAgc3JjUGF0aC51bnNoaWZ0KCcnKTsKICAgIH0KICAKICAgIGlmIChoYXNUcmFpbGluZ1NsYXNoICYmIChzcmNQYXRoLmpvaW4oJy8nKS5zdWJzdHIoLTEpICE9PSAnLycpKSB7CiAgICAgIHNyY1BhdGgucHVzaCgnJyk7CiAgICB9CiAgCiAgICB2YXIgaXNBYnNvbHV0ZSA9IHNyY1BhdGhbMF0gPT09ICcnIHx8CiAgICAgICAgKHNyY1BhdGhbMF0gJiYgc3JjUGF0aFswXS5jaGFyQXQoMCkgPT09ICcvJyk7CiAgCiAgICAvLyBwdXQgdGhlIGhvc3QgYmFjawogICAgaWYgKHBzeWNob3RpYykgewogICAgICByZXN1bHQuaG9zdG5hbWUgPSByZXN1bHQuaG9zdCA9IGlzQWJzb2x1dGUgPyAnJyA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjUGF0aC5sZW5ndGggPyBzcmNQYXRoLnNoaWZ0KCkgOiAnJzsKICAgICAgLy9vY2NhdGlvbmFseSB0aGUgYXV0aCBjYW4gZ2V0IHN0dWNrIG9ubHkgaW4gaG9zdAogICAgICAvL3RoaXMgZXNwZWNpYWx5IGhhcHBlbnMgaW4gY2FzZXMgbGlrZQogICAgICAvL3VybC5yZXNvbHZlT2JqZWN0KCdtYWlsdG86bG9jYWwxQGRvbWFpbjEnLCAnbG9jYWwyQGRvbWFpbjInKQogICAgICB2YXIgYXV0aEluSG9zdCA9IHJlc3VsdC5ob3N0ICYmIHJlc3VsdC5ob3N0LmluZGV4T2YoJ0AnKSA+IDAgPwogICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5ob3N0LnNwbGl0KCdAJykgOiBmYWxzZTsKICAgICAgaWYgKGF1dGhJbkhvc3QpIHsKICAgICAgICByZXN1bHQuYXV0aCA9IGF1dGhJbkhvc3Quc2hpZnQoKTsKICAgICAgICByZXN1bHQuaG9zdCA9IHJlc3VsdC5ob3N0bmFtZSA9IGF1dGhJbkhvc3Quc2hpZnQoKTsKICAgICAgfQogICAgfQogIAogICAgbXVzdEVuZEFicyA9IG11c3RFbmRBYnMgfHwgKHJlc3VsdC5ob3N0ICYmIHNyY1BhdGgubGVuZ3RoKTsKICAKICAgIGlmIChtdXN0RW5kQWJzICYmICFpc0Fic29sdXRlKSB7CiAgICAgIHNyY1BhdGgudW5zaGlmdCgnJyk7CiAgICB9CiAgCiAgICBpZiAoIXNyY1BhdGgubGVuZ3RoKSB7CiAgICAgIHJlc3VsdC5wYXRobmFtZSA9IG51bGw7CiAgICAgIHJlc3VsdC5wYXRoID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdC5wYXRobmFtZSA9IHNyY1BhdGguam9pbignLycpOwogICAgfQogIAogICAgLy90byBzdXBwb3J0IHJlcXVlc3QuaHR0cAogICAgaWYgKCFpc051bGwocmVzdWx0LnBhdGhuYW1lKSB8fCAhaXNOdWxsKHJlc3VsdC5zZWFyY2gpKSB7CiAgICAgIHJlc3VsdC5wYXRoID0gKHJlc3VsdC5wYXRobmFtZSA/IHJlc3VsdC5wYXRobmFtZSA6ICcnKSArCiAgICAgICAgICAgICAgICAgICAgKHJlc3VsdC5zZWFyY2ggPyByZXN1bHQuc2VhcmNoIDogJycpOwogICAgfQogICAgcmVzdWx0LmF1dGggPSByZWxhdGl2ZS5hdXRoIHx8IHJlc3VsdC5hdXRoOwogICAgcmVzdWx0LnNsYXNoZXMgPSByZXN1bHQuc2xhc2hlcyB8fCByZWxhdGl2ZS5zbGFzaGVzOwogICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CiAgCiAgVXJsLnByb3RvdHlwZS5wYXJzZUhvc3QgPSBmdW5jdGlvbigpIHsKICAgIHZhciBob3N0ID0gdGhpcy5ob3N0OwogICAgdmFyIHBvcnQgPSBwb3J0UGF0dGVybi5leGVjKGhvc3QpOwogICAgaWYgKHBvcnQpIHsKICAgICAgcG9ydCA9IHBvcnRbMF07CiAgICAgIGlmIChwb3J0ICE9PSAnOicpIHsKICAgICAgICB0aGlzLnBvcnQgPSBwb3J0LnN1YnN0cigxKTsKICAgICAgfQogICAgICBob3N0ID0gaG9zdC5zdWJzdHIoMCwgaG9zdC5sZW5ndGggLSBwb3J0Lmxlbmd0aCk7CiAgICB9CiAgICBpZiAoaG9zdCkgdGhpcy5ob3N0bmFtZSA9IGhvc3Q7CiAgfTsKICAKICBmdW5jdGlvbiBpc1N0cmluZyhhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAic3RyaW5nIjsKICB9CiAgCiAgZnVuY3Rpb24gaXNPYmplY3QoYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcgJiYgYXJnICE9PSBudWxsOwogIH0KICAKICBmdW5jdGlvbiBpc051bGwoYXJnKSB7CiAgICByZXR1cm4gYXJnID09PSBudWxsOwogIH0KICBmdW5jdGlvbiBpc051bGxPclVuZGVmaW5lZChhcmcpIHsKICAgIHJldHVybiAgYXJnID09IG51bGw7CiAgfQogIAogIH0seyJwdW55Y29kZSI6ODYsInF1ZXJ5c3RyaW5nIjo4OX1dLDk1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBpZiAodHlwZW9mIE9iamVjdC5jcmVhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgIC8vIGltcGxlbWVudGF0aW9uIGZyb20gc3RhbmRhcmQgbm9kZS5qcyAndXRpbCcgbW9kdWxlCiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGluaGVyaXRzKGN0b3IsIHN1cGVyQ3RvcikgewogICAgICBjdG9yLnN1cGVyXyA9IHN1cGVyQ3RvcgogICAgICBjdG9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDdG9yLnByb3RvdHlwZSwgewogICAgICAgIGNvbnN0cnVjdG9yOiB7CiAgICAgICAgICB2YWx1ZTogY3RvciwKICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKICB9IGVsc2UgewogICAgLy8gb2xkIHNjaG9vbCBzaGltIGZvciBvbGQgYnJvd3NlcnMKICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gaW5oZXJpdHMoY3Rvciwgc3VwZXJDdG9yKSB7CiAgICAgIGN0b3Iuc3VwZXJfID0gc3VwZXJDdG9yCiAgICAgIHZhciBUZW1wQ3RvciA9IGZ1bmN0aW9uICgpIHt9CiAgICAgIFRlbXBDdG9yLnByb3RvdHlwZSA9IHN1cGVyQ3Rvci5wcm90b3R5cGUKICAgICAgY3Rvci5wcm90b3R5cGUgPSBuZXcgVGVtcEN0b3IoKQogICAgICBjdG9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGN0b3IKICAgIH0KICB9CiAgCiAgfSx7fV0sOTY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gaXNCdWZmZXIoYXJnKSB7CiAgICByZXR1cm4gYXJnICYmIHR5cGVvZiBhcmcgPT09ICdvYmplY3QnCiAgICAgICYmIHR5cGVvZiBhcmcuY29weSA9PT0gJ2Z1bmN0aW9uJwogICAgICAmJiB0eXBlb2YgYXJnLmZpbGwgPT09ICdmdW5jdGlvbicKICAgICAgJiYgdHlwZW9mIGFyZy5yZWFkVUludDggPT09ICdmdW5jdGlvbic7CiAgfQogIH0se31dLDk3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKHByb2Nlc3MsZ2xvYmFsKXsKICAvLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KICAvLwogIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCiAgLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQogIC8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKICAvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCiAgLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAogIC8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQogIC8vIGZvbGxvd2luZyBjb25kaXRpb25zOgogIC8vCiAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKICAvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAvLwogIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAgLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogIC8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KICAvLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKICAvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKICAvLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCiAgLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICAKICB2YXIgZm9ybWF0UmVnRXhwID0gLyVbc2RqJV0vZzsKICBleHBvcnRzLmZvcm1hdCA9IGZ1bmN0aW9uKGYpIHsKICAgIGlmICghaXNTdHJpbmcoZikpIHsKICAgICAgdmFyIG9iamVjdHMgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBvYmplY3RzLnB1c2goaW5zcGVjdChhcmd1bWVudHNbaV0pKTsKICAgICAgfQogICAgICByZXR1cm4gb2JqZWN0cy5qb2luKCcgJyk7CiAgICB9CiAgCiAgICB2YXIgaSA9IDE7CiAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgIHZhciBsZW4gPSBhcmdzLmxlbmd0aDsKICAgIHZhciBzdHIgPSBTdHJpbmcoZikucmVwbGFjZShmb3JtYXRSZWdFeHAsIGZ1bmN0aW9uKHgpIHsKICAgICAgaWYgKHggPT09ICclJScpIHJldHVybiAnJSc7CiAgICAgIGlmIChpID49IGxlbikgcmV0dXJuIHg7CiAgICAgIHN3aXRjaCAoeCkgewogICAgICAgIGNhc2UgJyVzJzogcmV0dXJuIFN0cmluZyhhcmdzW2krK10pOwogICAgICAgIGNhc2UgJyVkJzogcmV0dXJuIE51bWJlcihhcmdzW2krK10pOwogICAgICAgIGNhc2UgJyVqJzoKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShhcmdzW2krK10pOwogICAgICAgICAgfSBjYXRjaCAoXykgewogICAgICAgICAgICByZXR1cm4gJ1tDaXJjdWxhcl0nOwogICAgICAgICAgfQogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4geDsKICAgICAgfQogICAgfSk7CiAgICBmb3IgKHZhciB4ID0gYXJnc1tpXTsgaSA8IGxlbjsgeCA9IGFyZ3NbKytpXSkgewogICAgICBpZiAoaXNOdWxsKHgpIHx8ICFpc09iamVjdCh4KSkgewogICAgICAgIHN0ciArPSAnICcgKyB4OwogICAgICB9IGVsc2UgewogICAgICAgIHN0ciArPSAnICcgKyBpbnNwZWN0KHgpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gc3RyOwogIH07CiAgCiAgCiAgLy8gTWFyayB0aGF0IGEgbWV0aG9kIHNob3VsZCBub3QgYmUgdXNlZC4KICAvLyBSZXR1cm5zIGEgbW9kaWZpZWQgZnVuY3Rpb24gd2hpY2ggd2FybnMgb25jZSBieSBkZWZhdWx0LgogIC8vIElmIC0tbm8tZGVwcmVjYXRpb24gaXMgc2V0LCB0aGVuIGl0IGlzIGEgbm8tb3AuCiAgZXhwb3J0cy5kZXByZWNhdGUgPSBmdW5jdGlvbihmbiwgbXNnKSB7CiAgICAvLyBBbGxvdyBmb3IgZGVwcmVjYXRpbmcgdGhpbmdzIGluIHRoZSBwcm9jZXNzIG9mIHN0YXJ0aW5nIHVwLgogICAgaWYgKGlzVW5kZWZpbmVkKGdsb2JhbC5wcm9jZXNzKSkgewogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuZGVwcmVjYXRlKGZuLCBtc2cpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9CiAgCiAgICBpZiAocHJvY2Vzcy5ub0RlcHJlY2F0aW9uID09PSB0cnVlKSB7CiAgICAgIHJldHVybiBmbjsKICAgIH0KICAKICAgIHZhciB3YXJuZWQgPSBmYWxzZTsKICAgIGZ1bmN0aW9uIGRlcHJlY2F0ZWQoKSB7CiAgICAgIGlmICghd2FybmVkKSB7CiAgICAgICAgaWYgKHByb2Nlc3MudGhyb3dEZXByZWNhdGlvbikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7CiAgICAgICAgfSBlbHNlIGlmIChwcm9jZXNzLnRyYWNlRGVwcmVjYXRpb24pIHsKICAgICAgICAgIGNvbnNvbGUudHJhY2UobXNnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc29sZS5lcnJvcihtc2cpOwogICAgICAgIH0KICAgICAgICB3YXJuZWQgPSB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIAogICAgcmV0dXJuIGRlcHJlY2F0ZWQ7CiAgfTsKICAKICAKICB2YXIgZGVidWdzID0ge307CiAgdmFyIGRlYnVnRW52aXJvbjsKICBleHBvcnRzLmRlYnVnbG9nID0gZnVuY3Rpb24oc2V0KSB7CiAgICBpZiAoaXNVbmRlZmluZWQoZGVidWdFbnZpcm9uKSkKICAgICAgZGVidWdFbnZpcm9uID0gcHJvY2Vzcy5lbnYuTk9ERV9ERUJVRyB8fCAnJzsKICAgIHNldCA9IHNldC50b1VwcGVyQ2FzZSgpOwogICAgaWYgKCFkZWJ1Z3Nbc2V0XSkgewogICAgICBpZiAobmV3IFJlZ0V4cCgnXFxiJyArIHNldCArICdcXGInLCAnaScpLnRlc3QoZGVidWdFbnZpcm9uKSkgewogICAgICAgIHZhciBwaWQgPSBwcm9jZXNzLnBpZDsKICAgICAgICBkZWJ1Z3Nbc2V0XSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIG1zZyA9IGV4cG9ydHMuZm9ybWF0LmFwcGx5KGV4cG9ydHMsIGFyZ3VtZW50cyk7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCclcyAlZDogJXMnLCBzZXQsIHBpZCwgbXNnKTsKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIGRlYnVnc1tzZXRdID0gZnVuY3Rpb24oKSB7fTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGRlYnVnc1tzZXRdOwogIH07CiAgCiAgCiAgLyoqCiAgICogRWNob3MgdGhlIHZhbHVlIG9mIGEgdmFsdWUuIFRyeXMgdG8gcHJpbnQgdGhlIHZhbHVlIG91dAogICAqIGluIHRoZSBiZXN0IHdheSBwb3NzaWJsZSBnaXZlbiB0aGUgZGlmZmVyZW50IHR5cGVzLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgb2JqZWN0IHRvIHByaW50IG91dC4KICAgKiBAcGFyYW0ge09iamVjdH0gb3B0cyBPcHRpb25hbCBvcHRpb25zIG9iamVjdCB0aGF0IGFsdGVycyB0aGUgb3V0cHV0LgogICAqLwogIC8qIGxlZ2FjeTogb2JqLCBzaG93SGlkZGVuLCBkZXB0aCwgY29sb3JzKi8KICBmdW5jdGlvbiBpbnNwZWN0KG9iaiwgb3B0cykgewogICAgLy8gZGVmYXVsdCBvcHRpb25zCiAgICB2YXIgY3R4ID0gewogICAgICBzZWVuOiBbXSwKICAgICAgc3R5bGl6ZTogc3R5bGl6ZU5vQ29sb3IKICAgIH07CiAgICAvLyBsZWdhY3kuLi4KICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID49IDMpIGN0eC5kZXB0aCA9IGFyZ3VtZW50c1syXTsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID49IDQpIGN0eC5jb2xvcnMgPSBhcmd1bWVudHNbM107CiAgICBpZiAoaXNCb29sZWFuKG9wdHMpKSB7CiAgICAgIC8vIGxlZ2FjeS4uLgogICAgICBjdHguc2hvd0hpZGRlbiA9IG9wdHM7CiAgICB9IGVsc2UgaWYgKG9wdHMpIHsKICAgICAgLy8gZ290IGFuICJvcHRpb25zIiBvYmplY3QKICAgICAgZXhwb3J0cy5fZXh0ZW5kKGN0eCwgb3B0cyk7CiAgICB9CiAgICAvLyBzZXQgZGVmYXVsdCBvcHRpb25zCiAgICBpZiAoaXNVbmRlZmluZWQoY3R4LnNob3dIaWRkZW4pKSBjdHguc2hvd0hpZGRlbiA9IGZhbHNlOwogICAgaWYgKGlzVW5kZWZpbmVkKGN0eC5kZXB0aCkpIGN0eC5kZXB0aCA9IDI7CiAgICBpZiAoaXNVbmRlZmluZWQoY3R4LmNvbG9ycykpIGN0eC5jb2xvcnMgPSBmYWxzZTsKICAgIGlmIChpc1VuZGVmaW5lZChjdHguY3VzdG9tSW5zcGVjdCkpIGN0eC5jdXN0b21JbnNwZWN0ID0gdHJ1ZTsKICAgIGlmIChjdHguY29sb3JzKSBjdHguc3R5bGl6ZSA9IHN0eWxpemVXaXRoQ29sb3I7CiAgICByZXR1cm4gZm9ybWF0VmFsdWUoY3R4LCBvYmosIGN0eC5kZXB0aCk7CiAgfQogIGV4cG9ydHMuaW5zcGVjdCA9IGluc3BlY3Q7CiAgCiAgCiAgLy8gaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9BTlNJX2VzY2FwZV9jb2RlI2dyYXBoaWNzCiAgaW5zcGVjdC5jb2xvcnMgPSB7CiAgICAnYm9sZCcgOiBbMSwgMjJdLAogICAgJ2l0YWxpYycgOiBbMywgMjNdLAogICAgJ3VuZGVybGluZScgOiBbNCwgMjRdLAogICAgJ2ludmVyc2UnIDogWzcsIDI3XSwKICAgICd3aGl0ZScgOiBbMzcsIDM5XSwKICAgICdncmV5JyA6IFs5MCwgMzldLAogICAgJ2JsYWNrJyA6IFszMCwgMzldLAogICAgJ2JsdWUnIDogWzM0LCAzOV0sCiAgICAnY3lhbicgOiBbMzYsIDM5XSwKICAgICdncmVlbicgOiBbMzIsIDM5XSwKICAgICdtYWdlbnRhJyA6IFszNSwgMzldLAogICAgJ3JlZCcgOiBbMzEsIDM5XSwKICAgICd5ZWxsb3cnIDogWzMzLCAzOV0KICB9OwogIAogIC8vIERvbid0IHVzZSAnYmx1ZScgbm90IHZpc2libGUgb24gY21kLmV4ZQogIGluc3BlY3Quc3R5bGVzID0gewogICAgJ3NwZWNpYWwnOiAnY3lhbicsCiAgICAnbnVtYmVyJzogJ3llbGxvdycsCiAgICAnYm9vbGVhbic6ICd5ZWxsb3cnLAogICAgJ3VuZGVmaW5lZCc6ICdncmV5JywKICAgICdudWxsJzogJ2JvbGQnLAogICAgJ3N0cmluZyc6ICdncmVlbicsCiAgICAnZGF0ZSc6ICdtYWdlbnRhJywKICAgIC8vICJuYW1lIjogaW50ZW50aW9uYWxseSBub3Qgc3R5bGluZwogICAgJ3JlZ2V4cCc6ICdyZWQnCiAgfTsKICAKICAKICBmdW5jdGlvbiBzdHlsaXplV2l0aENvbG9yKHN0ciwgc3R5bGVUeXBlKSB7CiAgICB2YXIgc3R5bGUgPSBpbnNwZWN0LnN0eWxlc1tzdHlsZVR5cGVdOwogIAogICAgaWYgKHN0eWxlKSB7CiAgICAgIHJldHVybiAnXHUwMDFiWycgKyBpbnNwZWN0LmNvbG9yc1tzdHlsZV1bMF0gKyAnbScgKyBzdHIgKwogICAgICAgICAgICAgJ1x1MDAxYlsnICsgaW5zcGVjdC5jb2xvcnNbc3R5bGVdWzFdICsgJ20nOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHN0cjsKICAgIH0KICB9CiAgCiAgCiAgZnVuY3Rpb24gc3R5bGl6ZU5vQ29sb3Ioc3RyLCBzdHlsZVR5cGUpIHsKICAgIHJldHVybiBzdHI7CiAgfQogIAogIAogIGZ1bmN0aW9uIGFycmF5VG9IYXNoKGFycmF5KSB7CiAgICB2YXIgaGFzaCA9IHt9OwogIAogICAgYXJyYXkuZm9yRWFjaChmdW5jdGlvbih2YWwsIGlkeCkgewogICAgICBoYXNoW3ZhbF0gPSB0cnVlOwogICAgfSk7CiAgCiAgICByZXR1cm4gaGFzaDsKICB9CiAgCiAgCiAgZnVuY3Rpb24gZm9ybWF0VmFsdWUoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzKSB7CiAgICAvLyBQcm92aWRlIGEgaG9vayBmb3IgdXNlci1zcGVjaWZpZWQgaW5zcGVjdCBmdW5jdGlvbnMuCiAgICAvLyBDaGVjayB0aGF0IHZhbHVlIGlzIGFuIG9iamVjdCB3aXRoIGFuIGluc3BlY3QgZnVuY3Rpb24gb24gaXQKICAgIGlmIChjdHguY3VzdG9tSW5zcGVjdCAmJgogICAgICAgIHZhbHVlICYmCiAgICAgICAgaXNGdW5jdGlvbih2YWx1ZS5pbnNwZWN0KSAmJgogICAgICAgIC8vIEZpbHRlciBvdXQgdGhlIHV0aWwgbW9kdWxlLCBpdCdzIGluc3BlY3QgZnVuY3Rpb24gaXMgc3BlY2lhbAogICAgICAgIHZhbHVlLmluc3BlY3QgIT09IGV4cG9ydHMuaW5zcGVjdCAmJgogICAgICAgIC8vIEFsc28gZmlsdGVyIG91dCBhbnkgcHJvdG90eXBlIG9iamVjdHMgdXNpbmcgdGhlIGNpcmN1bGFyIGNoZWNrLgogICAgICAgICEodmFsdWUuY29uc3RydWN0b3IgJiYgdmFsdWUuY29uc3RydWN0b3IucHJvdG90eXBlID09PSB2YWx1ZSkpIHsKICAgICAgdmFyIHJldCA9IHZhbHVlLmluc3BlY3QocmVjdXJzZVRpbWVzLCBjdHgpOwogICAgICBpZiAoIWlzU3RyaW5nKHJldCkpIHsKICAgICAgICByZXQgPSBmb3JtYXRWYWx1ZShjdHgsIHJldCwgcmVjdXJzZVRpbWVzKTsKICAgICAgfQogICAgICByZXR1cm4gcmV0OwogICAgfQogIAogICAgLy8gUHJpbWl0aXZlIHR5cGVzIGNhbm5vdCBoYXZlIHByb3BlcnRpZXMKICAgIHZhciBwcmltaXRpdmUgPSBmb3JtYXRQcmltaXRpdmUoY3R4LCB2YWx1ZSk7CiAgICBpZiAocHJpbWl0aXZlKSB7CiAgICAgIHJldHVybiBwcmltaXRpdmU7CiAgICB9CiAgCiAgICAvLyBMb29rIHVwIHRoZSBrZXlzIG9mIHRoZSBvYmplY3QuCiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHZhbHVlKTsKICAgIHZhciB2aXNpYmxlS2V5cyA9IGFycmF5VG9IYXNoKGtleXMpOwogIAogICAgaWYgKGN0eC5zaG93SGlkZGVuKSB7CiAgICAgIGtleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh2YWx1ZSk7CiAgICB9CiAgCiAgICAvLyBJRSBkb2Vzbid0IG1ha2UgZXJyb3IgZmllbGRzIG5vbi1lbnVtZXJhYmxlCiAgICAvLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvaWUvZHd3NTJzYnQodj12cy45NCkuYXNweAogICAgaWYgKGlzRXJyb3IodmFsdWUpCiAgICAgICAgJiYgKGtleXMuaW5kZXhPZignbWVzc2FnZScpID49IDAgfHwga2V5cy5pbmRleE9mKCdkZXNjcmlwdGlvbicpID49IDApKSB7CiAgICAgIHJldHVybiBmb3JtYXRFcnJvcih2YWx1ZSk7CiAgICB9CiAgCiAgICAvLyBTb21lIHR5cGUgb2Ygb2JqZWN0IHdpdGhvdXQgcHJvcGVydGllcyBjYW4gYmUgc2hvcnRjdXR0ZWQuCiAgICBpZiAoa2V5cy5sZW5ndGggPT09IDApIHsKICAgICAgaWYgKGlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgdmFyIG5hbWUgPSB2YWx1ZS5uYW1lID8gJzogJyArIHZhbHVlLm5hbWUgOiAnJzsKICAgICAgICByZXR1cm4gY3R4LnN0eWxpemUoJ1tGdW5jdGlvbicgKyBuYW1lICsgJ10nLCAnc3BlY2lhbCcpOwogICAgICB9CiAgICAgIGlmIChpc1JlZ0V4cCh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gY3R4LnN0eWxpemUoUmVnRXhwLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSwgJ3JlZ2V4cCcpOwogICAgICB9CiAgICAgIGlmIChpc0RhdGUodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKERhdGUucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpLCAnZGF0ZScpOwogICAgICB9CiAgICAgIGlmIChpc0Vycm9yKHZhbHVlKSkgewogICAgICAgIHJldHVybiBmb3JtYXRFcnJvcih2YWx1ZSk7CiAgICAgIH0KICAgIH0KICAKICAgIHZhciBiYXNlID0gJycsIGFycmF5ID0gZmFsc2UsIGJyYWNlcyA9IFsneycsICd9J107CiAgCiAgICAvLyBNYWtlIEFycmF5IHNheSB0aGF0IHRoZXkgYXJlIEFycmF5CiAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgYXJyYXkgPSB0cnVlOwogICAgICBicmFjZXMgPSBbJ1snLCAnXSddOwogICAgfQogIAogICAgLy8gTWFrZSBmdW5jdGlvbnMgc2F5IHRoYXQgdGhleSBhcmUgZnVuY3Rpb25zCiAgICBpZiAoaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgdmFyIG4gPSB2YWx1ZS5uYW1lID8gJzogJyArIHZhbHVlLm5hbWUgOiAnJzsKICAgICAgYmFzZSA9ICcgW0Z1bmN0aW9uJyArIG4gKyAnXSc7CiAgICB9CiAgCiAgICAvLyBNYWtlIFJlZ0V4cHMgc2F5IHRoYXQgdGhleSBhcmUgUmVnRXhwcwogICAgaWYgKGlzUmVnRXhwKHZhbHVlKSkgewogICAgICBiYXNlID0gJyAnICsgUmVnRXhwLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKTsKICAgIH0KICAKICAgIC8vIE1ha2UgZGF0ZXMgd2l0aCBwcm9wZXJ0aWVzIGZpcnN0IHNheSB0aGUgZGF0ZQogICAgaWYgKGlzRGF0ZSh2YWx1ZSkpIHsKICAgICAgYmFzZSA9ICcgJyArIERhdGUucHJvdG90eXBlLnRvVVRDU3RyaW5nLmNhbGwodmFsdWUpOwogICAgfQogIAogICAgLy8gTWFrZSBlcnJvciB3aXRoIG1lc3NhZ2UgZmlyc3Qgc2F5IHRoZSBlcnJvcgogICAgaWYgKGlzRXJyb3IodmFsdWUpKSB7CiAgICAgIGJhc2UgPSAnICcgKyBmb3JtYXRFcnJvcih2YWx1ZSk7CiAgICB9CiAgCiAgICBpZiAoa2V5cy5sZW5ndGggPT09IDAgJiYgKCFhcnJheSB8fCB2YWx1ZS5sZW5ndGggPT0gMCkpIHsKICAgICAgcmV0dXJuIGJyYWNlc1swXSArIGJhc2UgKyBicmFjZXNbMV07CiAgICB9CiAgCiAgICBpZiAocmVjdXJzZVRpbWVzIDwgMCkgewogICAgICBpZiAoaXNSZWdFeHAodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKFJlZ0V4cC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSksICdyZWdleHAnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gY3R4LnN0eWxpemUoJ1tPYmplY3RdJywgJ3NwZWNpYWwnKTsKICAgICAgfQogICAgfQogIAogICAgY3R4LnNlZW4ucHVzaCh2YWx1ZSk7CiAgCiAgICB2YXIgb3V0cHV0OwogICAgaWYgKGFycmF5KSB7CiAgICAgIG91dHB1dCA9IGZvcm1hdEFycmF5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsIGtleXMpOwogICAgfSBlbHNlIHsKICAgICAgb3V0cHV0ID0ga2V5cy5tYXAoZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgcmV0dXJuIGZvcm1hdFByb3BlcnR5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsIGtleSwgYXJyYXkpOwogICAgICB9KTsKICAgIH0KICAKICAgIGN0eC5zZWVuLnBvcCgpOwogIAogICAgcmV0dXJuIHJlZHVjZVRvU2luZ2xlU3RyaW5nKG91dHB1dCwgYmFzZSwgYnJhY2VzKTsKICB9CiAgCiAgCiAgZnVuY3Rpb24gZm9ybWF0UHJpbWl0aXZlKGN0eCwgdmFsdWUpIHsKICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpCiAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgndW5kZWZpbmVkJywgJ3VuZGVmaW5lZCcpOwogICAgaWYgKGlzU3RyaW5nKHZhbHVlKSkgewogICAgICB2YXIgc2ltcGxlID0gJ1wnJyArIEpTT04uc3RyaW5naWZ5KHZhbHVlKS5yZXBsYWNlKC9eInwiJC9nLCAnJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvJy9nLCAiXFwnIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFwiL2csICciJykgKyAnXCcnOwogICAgICByZXR1cm4gY3R4LnN0eWxpemUoc2ltcGxlLCAnc3RyaW5nJyk7CiAgICB9CiAgICBpZiAoaXNOdW1iZXIodmFsdWUpKQogICAgICByZXR1cm4gY3R4LnN0eWxpemUoJycgKyB2YWx1ZSwgJ251bWJlcicpOwogICAgaWYgKGlzQm9vbGVhbih2YWx1ZSkpCiAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgnJyArIHZhbHVlLCAnYm9vbGVhbicpOwogICAgLy8gRm9yIHNvbWUgcmVhc29uIHR5cGVvZiBudWxsIGlzICJvYmplY3QiLCBzbyBzcGVjaWFsIGNhc2UgaGVyZS4KICAgIGlmIChpc051bGwodmFsdWUpKQogICAgICByZXR1cm4gY3R4LnN0eWxpemUoJ251bGwnLCAnbnVsbCcpOwogIH0KICAKICAKICBmdW5jdGlvbiBmb3JtYXRFcnJvcih2YWx1ZSkgewogICAgcmV0dXJuICdbJyArIEVycm9yLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSArICddJzsKICB9CiAgCiAgCiAgZnVuY3Rpb24gZm9ybWF0QXJyYXkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywga2V5cykgewogICAgdmFyIG91dHB1dCA9IFtdOwogICAgZm9yICh2YXIgaSA9IDAsIGwgPSB2YWx1ZS5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgICAgaWYgKGhhc093blByb3BlcnR5KHZhbHVlLCBTdHJpbmcoaSkpKSB7CiAgICAgICAgb3V0cHV0LnB1c2goZm9ybWF0UHJvcGVydHkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywKICAgICAgICAgICAgU3RyaW5nKGkpLCB0cnVlKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3V0cHV0LnB1c2goJycpOwogICAgICB9CiAgICB9CiAgICBrZXlzLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgIGlmICgha2V5Lm1hdGNoKC9eXGQrJC8pKSB7CiAgICAgICAgb3V0cHV0LnB1c2goZm9ybWF0UHJvcGVydHkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywKICAgICAgICAgICAga2V5LCB0cnVlKSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG91dHB1dDsKICB9CiAgCiAgCiAgZnVuY3Rpb24gZm9ybWF0UHJvcGVydHkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywga2V5LCBhcnJheSkgewogICAgdmFyIG5hbWUsIHN0ciwgZGVzYzsKICAgIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHZhbHVlLCBrZXkpIHx8IHsgdmFsdWU6IHZhbHVlW2tleV0gfTsKICAgIGlmIChkZXNjLmdldCkgewogICAgICBpZiAoZGVzYy5zZXQpIHsKICAgICAgICBzdHIgPSBjdHguc3R5bGl6ZSgnW0dldHRlci9TZXR0ZXJdJywgJ3NwZWNpYWwnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdHIgPSBjdHguc3R5bGl6ZSgnW0dldHRlcl0nLCAnc3BlY2lhbCcpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoZGVzYy5zZXQpIHsKICAgICAgICBzdHIgPSBjdHguc3R5bGl6ZSgnW1NldHRlcl0nLCAnc3BlY2lhbCcpOwogICAgICB9CiAgICB9CiAgICBpZiAoIWhhc093blByb3BlcnR5KHZpc2libGVLZXlzLCBrZXkpKSB7CiAgICAgIG5hbWUgPSAnWycgKyBrZXkgKyAnXSc7CiAgICB9CiAgICBpZiAoIXN0cikgewogICAgICBpZiAoY3R4LnNlZW4uaW5kZXhPZihkZXNjLnZhbHVlKSA8IDApIHsKICAgICAgICBpZiAoaXNOdWxsKHJlY3Vyc2VUaW1lcykpIHsKICAgICAgICAgIHN0ciA9IGZvcm1hdFZhbHVlKGN0eCwgZGVzYy52YWx1ZSwgbnVsbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0ciA9IGZvcm1hdFZhbHVlKGN0eCwgZGVzYy52YWx1ZSwgcmVjdXJzZVRpbWVzIC0gMSk7CiAgICAgICAgfQogICAgICAgIGlmIChzdHIuaW5kZXhPZignXG4nKSA+IC0xKSB7CiAgICAgICAgICBpZiAoYXJyYXkpIHsKICAgICAgICAgICAgc3RyID0gc3RyLnNwbGl0KCdcbicpLm1hcChmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICcgICcgKyBsaW5lOwogICAgICAgICAgICB9KS5qb2luKCdcbicpLnN1YnN0cigyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0ciA9ICdcbicgKyBzdHIuc3BsaXQoJ1xuJykubWFwKGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gJyAgICcgKyBsaW5lOwogICAgICAgICAgICB9KS5qb2luKCdcbicpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzdHIgPSBjdHguc3R5bGl6ZSgnW0NpcmN1bGFyXScsICdzcGVjaWFsJyk7CiAgICAgIH0KICAgIH0KICAgIGlmIChpc1VuZGVmaW5lZChuYW1lKSkgewogICAgICBpZiAoYXJyYXkgJiYga2V5Lm1hdGNoKC9eXGQrJC8pKSB7CiAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgfQogICAgICBuYW1lID0gSlNPTi5zdHJpbmdpZnkoJycgKyBrZXkpOwogICAgICBpZiAobmFtZS5tYXRjaCgvXiIoW2EtekEtWl9dW2EtekEtWl8wLTldKikiJC8pKSB7CiAgICAgICAgbmFtZSA9IG5hbWUuc3Vic3RyKDEsIG5hbWUubGVuZ3RoIC0gMik7CiAgICAgICAgbmFtZSA9IGN0eC5zdHlsaXplKG5hbWUsICduYW1lJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbmFtZSA9IG5hbWUucmVwbGFjZSgvJy9nLCAiXFwnIikKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXCIvZywgJyInKQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoLyheInwiJCkvZywgIiciKTsKICAgICAgICBuYW1lID0gY3R4LnN0eWxpemUobmFtZSwgJ3N0cmluZycpOwogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gbmFtZSArICc6ICcgKyBzdHI7CiAgfQogIAogIAogIGZ1bmN0aW9uIHJlZHVjZVRvU2luZ2xlU3RyaW5nKG91dHB1dCwgYmFzZSwgYnJhY2VzKSB7CiAgICB2YXIgbnVtTGluZXNFc3QgPSAwOwogICAgdmFyIGxlbmd0aCA9IG91dHB1dC5yZWR1Y2UoZnVuY3Rpb24ocHJldiwgY3VyKSB7CiAgICAgIG51bUxpbmVzRXN0Kys7CiAgICAgIGlmIChjdXIuaW5kZXhPZignXG4nKSA+PSAwKSBudW1MaW5lc0VzdCsrOwogICAgICByZXR1cm4gcHJldiArIGN1ci5yZXBsYWNlKC9cdTAwMWJcW1xkXGQ/bS9nLCAnJykubGVuZ3RoICsgMTsKICAgIH0sIDApOwogIAogICAgaWYgKGxlbmd0aCA+IDYwKSB7CiAgICAgIHJldHVybiBicmFjZXNbMF0gKwogICAgICAgICAgICAgKGJhc2UgPT09ICcnID8gJycgOiBiYXNlICsgJ1xuICcpICsKICAgICAgICAgICAgICcgJyArCiAgICAgICAgICAgICBvdXRwdXQuam9pbignLFxuICAnKSArCiAgICAgICAgICAgICAnICcgKwogICAgICAgICAgICAgYnJhY2VzWzFdOwogICAgfQogIAogICAgcmV0dXJuIGJyYWNlc1swXSArIGJhc2UgKyAnICcgKyBvdXRwdXQuam9pbignLCAnKSArICcgJyArIGJyYWNlc1sxXTsKICB9CiAgCiAgCiAgLy8gTk9URTogVGhlc2UgdHlwZSBjaGVja2luZyBmdW5jdGlvbnMgaW50ZW50aW9uYWxseSBkb24ndCB1c2UgYGluc3RhbmNlb2ZgCiAgLy8gYmVjYXVzZSBpdCBpcyBmcmFnaWxlIGFuZCBjYW4gYmUgZWFzaWx5IGZha2VkIHdpdGggYE9iamVjdC5jcmVhdGUoKWAuCiAgZnVuY3Rpb24gaXNBcnJheShhcikgewogICAgcmV0dXJuIEFycmF5LmlzQXJyYXkoYXIpOwogIH0KICBleHBvcnRzLmlzQXJyYXkgPSBpc0FycmF5OwogIAogIGZ1bmN0aW9uIGlzQm9vbGVhbihhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnYm9vbGVhbic7CiAgfQogIGV4cG9ydHMuaXNCb29sZWFuID0gaXNCb29sZWFuOwogIAogIGZ1bmN0aW9uIGlzTnVsbChhcmcpIHsKICAgIHJldHVybiBhcmcgPT09IG51bGw7CiAgfQogIGV4cG9ydHMuaXNOdWxsID0gaXNOdWxsOwogIAogIGZ1bmN0aW9uIGlzTnVsbE9yVW5kZWZpbmVkKGFyZykgewogICAgcmV0dXJuIGFyZyA9PSBudWxsOwogIH0KICBleHBvcnRzLmlzTnVsbE9yVW5kZWZpbmVkID0gaXNOdWxsT3JVbmRlZmluZWQ7CiAgCiAgZnVuY3Rpb24gaXNOdW1iZXIoYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ251bWJlcic7CiAgfQogIGV4cG9ydHMuaXNOdW1iZXIgPSBpc051bWJlcjsKICAKICBmdW5jdGlvbiBpc1N0cmluZyhhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnc3RyaW5nJzsKICB9CiAgZXhwb3J0cy5pc1N0cmluZyA9IGlzU3RyaW5nOwogIAogIGZ1bmN0aW9uIGlzU3ltYm9sKGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdzeW1ib2wnOwogIH0KICBleHBvcnRzLmlzU3ltYm9sID0gaXNTeW1ib2w7CiAgCiAgZnVuY3Rpb24gaXNVbmRlZmluZWQoYXJnKSB7CiAgICByZXR1cm4gYXJnID09PSB2b2lkIDA7CiAgfQogIGV4cG9ydHMuaXNVbmRlZmluZWQgPSBpc1VuZGVmaW5lZDsKICAKICBmdW5jdGlvbiBpc1JlZ0V4cChyZSkgewogICAgcmV0dXJuIGlzT2JqZWN0KHJlKSAmJiBvYmplY3RUb1N0cmluZyhyZSkgPT09ICdbb2JqZWN0IFJlZ0V4cF0nOwogIH0KICBleHBvcnRzLmlzUmVnRXhwID0gaXNSZWdFeHA7CiAgCiAgZnVuY3Rpb24gaXNPYmplY3QoYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcgJiYgYXJnICE9PSBudWxsOwogIH0KICBleHBvcnRzLmlzT2JqZWN0ID0gaXNPYmplY3Q7CiAgCiAgZnVuY3Rpb24gaXNEYXRlKGQpIHsKICAgIHJldHVybiBpc09iamVjdChkKSAmJiBvYmplY3RUb1N0cmluZyhkKSA9PT0gJ1tvYmplY3QgRGF0ZV0nOwogIH0KICBleHBvcnRzLmlzRGF0ZSA9IGlzRGF0ZTsKICAKICBmdW5jdGlvbiBpc0Vycm9yKGUpIHsKICAgIHJldHVybiBpc09iamVjdChlKSAmJgogICAgICAgIChvYmplY3RUb1N0cmluZyhlKSA9PT0gJ1tvYmplY3QgRXJyb3JdJyB8fCBlIGluc3RhbmNlb2YgRXJyb3IpOwogIH0KICBleHBvcnRzLmlzRXJyb3IgPSBpc0Vycm9yOwogIAogIGZ1bmN0aW9uIGlzRnVuY3Rpb24oYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ2Z1bmN0aW9uJzsKICB9CiAgZXhwb3J0cy5pc0Z1bmN0aW9uID0gaXNGdW5jdGlvbjsKICAKICBmdW5jdGlvbiBpc1ByaW1pdGl2ZShhcmcpIHsKICAgIHJldHVybiBhcmcgPT09IG51bGwgfHwKICAgICAgICAgICB0eXBlb2YgYXJnID09PSAnYm9vbGVhbicgfHwKICAgICAgICAgICB0eXBlb2YgYXJnID09PSAnbnVtYmVyJyB8fAogICAgICAgICAgIHR5cGVvZiBhcmcgPT09ICdzdHJpbmcnIHx8CiAgICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ3N5bWJvbCcgfHwgIC8vIEVTNiBzeW1ib2wKICAgICAgICAgICB0eXBlb2YgYXJnID09PSAndW5kZWZpbmVkJzsKICB9CiAgZXhwb3J0cy5pc1ByaW1pdGl2ZSA9IGlzUHJpbWl0aXZlOwogIAogIGV4cG9ydHMuaXNCdWZmZXIgPSByZXF1aXJlKCcuL3N1cHBvcnQvaXNCdWZmZXInKTsKICAKICBmdW5jdGlvbiBvYmplY3RUb1N0cmluZyhvKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG8pOwogIH0KICAKICAKICBmdW5jdGlvbiBwYWQobikgewogICAgcmV0dXJuIG4gPCAxMCA/ICcwJyArIG4udG9TdHJpbmcoMTApIDogbi50b1N0cmluZygxMCk7CiAgfQogIAogIAogIHZhciBtb250aHMgPSBbJ0phbicsICdGZWInLCAnTWFyJywgJ0FwcicsICdNYXknLCAnSnVuJywgJ0p1bCcsICdBdWcnLCAnU2VwJywKICAgICAgICAgICAgICAgICdPY3QnLCAnTm92JywgJ0RlYyddOwogIAogIC8vIDI2IEZlYiAxNjoxOTozNAogIGZ1bmN0aW9uIHRpbWVzdGFtcCgpIHsKICAgIHZhciBkID0gbmV3IERhdGUoKTsKICAgIHZhciB0aW1lID0gW3BhZChkLmdldEhvdXJzKCkpLAogICAgICAgICAgICAgICAgcGFkKGQuZ2V0TWludXRlcygpKSwKICAgICAgICAgICAgICAgIHBhZChkLmdldFNlY29uZHMoKSldLmpvaW4oJzonKTsKICAgIHJldHVybiBbZC5nZXREYXRlKCksIG1vbnRoc1tkLmdldE1vbnRoKCldLCB0aW1lXS5qb2luKCcgJyk7CiAgfQogIAogIAogIC8vIGxvZyBpcyBqdXN0IGEgdGhpbiB3cmFwcGVyIHRvIGNvbnNvbGUubG9nIHRoYXQgcHJlcGVuZHMgYSB0aW1lc3RhbXAKICBleHBvcnRzLmxvZyA9IGZ1bmN0aW9uKCkgewogICAgY29uc29sZS5sb2coJyVzIC0gJXMnLCB0aW1lc3RhbXAoKSwgZXhwb3J0cy5mb3JtYXQuYXBwbHkoZXhwb3J0cywgYXJndW1lbnRzKSk7CiAgfTsKICAKICAKICAvKioKICAgKiBJbmhlcml0IHRoZSBwcm90b3R5cGUgbWV0aG9kcyBmcm9tIG9uZSBjb25zdHJ1Y3RvciBpbnRvIGFub3RoZXIuCiAgICoKICAgKiBUaGUgRnVuY3Rpb24ucHJvdG90eXBlLmluaGVyaXRzIGZyb20gbGFuZy5qcyByZXdyaXR0ZW4gYXMgYSBzdGFuZGFsb25lCiAgICogZnVuY3Rpb24gKG5vdCBvbiBGdW5jdGlvbi5wcm90b3R5cGUpLiBOT1RFOiBJZiB0aGlzIGZpbGUgaXMgdG8gYmUgbG9hZGVkCiAgICogZHVyaW5nIGJvb3RzdHJhcHBpbmcgdGhpcyBmdW5jdGlvbiBuZWVkcyB0byBiZSByZXdyaXR0ZW4gdXNpbmcgc29tZSBuYXRpdmUKICAgKiBmdW5jdGlvbnMgYXMgcHJvdG90eXBlIHNldHVwIHVzaW5nIG5vcm1hbCBKYXZhU2NyaXB0IGRvZXMgbm90IHdvcmsgYXMKICAgKiBleHBlY3RlZCBkdXJpbmcgYm9vdHN0cmFwcGluZyAoc2VlIG1pcnJvci5qcyBpbiByMTE0OTAzKS4KICAgKgogICAqIEBwYXJhbSB7ZnVuY3Rpb259IGN0b3IgQ29uc3RydWN0b3IgZnVuY3Rpb24gd2hpY2ggbmVlZHMgdG8gaW5oZXJpdCB0aGUKICAgKiAgICAgcHJvdG90eXBlLgogICAqIEBwYXJhbSB7ZnVuY3Rpb259IHN1cGVyQ3RvciBDb25zdHJ1Y3RvciBmdW5jdGlvbiB0byBpbmhlcml0IHByb3RvdHlwZSBmcm9tLgogICAqLwogIGV4cG9ydHMuaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwogIAogIGV4cG9ydHMuX2V4dGVuZCA9IGZ1bmN0aW9uKG9yaWdpbiwgYWRkKSB7CiAgICAvLyBEb24ndCBkbyBhbnl0aGluZyBpZiBhZGQgaXNuJ3QgYW4gb2JqZWN0CiAgICBpZiAoIWFkZCB8fCAhaXNPYmplY3QoYWRkKSkgcmV0dXJuIG9yaWdpbjsKICAKICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoYWRkKTsKICAgIHZhciBpID0ga2V5cy5sZW5ndGg7CiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIG9yaWdpbltrZXlzW2ldXSA9IGFkZFtrZXlzW2ldXTsKICAgIH0KICAgIHJldHVybiBvcmlnaW47CiAgfTsKICAKICBmdW5jdGlvbiBoYXNPd25Qcm9wZXJ0eShvYmosIHByb3ApIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBwcm9wKTsKICB9CiAgCiAgfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJyksdHlwZW9mIGdsb2JhbCAhPT0gInVuZGVmaW5lZCIgPyBnbG9iYWwgOiB0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIgPyBzZWxmIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSkKICB9LHsiLi9zdXBwb3J0L2lzQnVmZmVyIjo5NiwiX3Byb2Nlc3MiOjg1LCJpbmhlcml0cyI6OTV9XSw5ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHYxID0gcmVxdWlyZSgnLi92MScpOwogIHZhciB2NCA9IHJlcXVpcmUoJy4vdjQnKTsKICAKICB2YXIgdXVpZCA9IHY0OwogIHV1aWQudjEgPSB2MTsKICB1dWlkLnY0ID0gdjQ7CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSB1dWlkOwogIAogIH0seyIuL3YxIjoxMDEsIi4vdjQiOjEwMn1dLDk5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvKioKICAgKiBDb252ZXJ0IGFycmF5IG9mIDE2IGJ5dGUgdmFsdWVzIHRvIFVVSUQgc3RyaW5nIGZvcm1hdCBvZiB0aGUgZm9ybToKICAgKiBYWFhYWFhYWC1YWFhYLVhYWFgtWFhYWC1YWFhYWFhYWFhYWFgKICAgKi8KICB2YXIgYnl0ZVRvSGV4ID0gW107CiAgZm9yICh2YXIgaSA9IDA7IGkgPCAyNTY7ICsraSkgewogICAgYnl0ZVRvSGV4W2ldID0gKGkgKyAweDEwMCkudG9TdHJpbmcoMTYpLnN1YnN0cigxKTsKICB9CiAgCiAgZnVuY3Rpb24gYnl0ZXNUb1V1aWQoYnVmLCBvZmZzZXQpIHsKICAgIHZhciBpID0gb2Zmc2V0IHx8IDA7CiAgICB2YXIgYnRoID0gYnl0ZVRvSGV4OwogICAgLy8gam9pbiB1c2VkIHRvIGZpeCBtZW1vcnkgaXNzdWUgY2F1c2VkIGJ5IGNvbmNhdGVuYXRpb246IGh0dHBzOi8vYnVncy5jaHJvbWl1bS5vcmcvcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTMxNzUjYzQKICAgIHJldHVybiAoW2J0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sIAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgJy0nLAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgJy0nLAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgJy0nLAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgJy0nLAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwKICAgIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sCiAgICBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dXSkuam9pbignJyk7CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gYnl0ZXNUb1V1aWQ7CiAgCiAgfSx7fV0sMTAwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBVbmlxdWUgSUQgY3JlYXRpb24gcmVxdWlyZXMgYSBoaWdoIHF1YWxpdHkgcmFuZG9tICMgZ2VuZXJhdG9yLiAgSW4gdGhlCiAgLy8gYnJvd3NlciB0aGlzIGlzIGEgbGl0dGxlIGNvbXBsaWNhdGVkIGR1ZSB0byB1bmtub3duIHF1YWxpdHkgb2YgTWF0aC5yYW5kb20oKQogIC8vIGFuZCBpbmNvbnNpc3RlbnQgc3VwcG9ydCBmb3IgdGhlIGBjcnlwdG9gIEFQSS4gIFdlIGRvIHRoZSBiZXN0IHdlIGNhbiB2aWEKICAvLyBmZWF0dXJlLWRldGVjdGlvbgogIAogIC8vIGdldFJhbmRvbVZhbHVlcyBuZWVkcyB0byBiZSBpbnZva2VkIGluIGEgY29udGV4dCB3aGVyZSAidGhpcyIgaXMgYSBDcnlwdG8KICAvLyBpbXBsZW1lbnRhdGlvbi4gQWxzbywgZmluZCB0aGUgY29tcGxldGUgaW1wbGVtZW50YXRpb24gb2YgY3J5cHRvIG9uIElFMTEuCiAgdmFyIGdldFJhbmRvbVZhbHVlcyA9ICh0eXBlb2YoY3J5cHRvKSAhPSAndW5kZWZpbmVkJyAmJiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzICYmIGNyeXB0by5nZXRSYW5kb21WYWx1ZXMuYmluZChjcnlwdG8pKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAodHlwZW9mKG1zQ3J5cHRvKSAhPSAndW5kZWZpbmVkJyAmJiB0eXBlb2Ygd2luZG93Lm1zQ3J5cHRvLmdldFJhbmRvbVZhbHVlcyA9PSAnZnVuY3Rpb24nICYmIG1zQ3J5cHRvLmdldFJhbmRvbVZhbHVlcy5iaW5kKG1zQ3J5cHRvKSk7CiAgCiAgaWYgKGdldFJhbmRvbVZhbHVlcykgewogICAgLy8gV0hBVFdHIGNyeXB0byBSTkcgLSBodHRwOi8vd2lraS53aGF0d2cub3JnL3dpa2kvQ3J5cHRvCiAgICB2YXIgcm5kczggPSBuZXcgVWludDhBcnJheSgxNik7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdW5kZWYKICAKICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gd2hhdHdnUk5HKCkgewogICAgICBnZXRSYW5kb21WYWx1ZXMocm5kczgpOwogICAgICByZXR1cm4gcm5kczg7CiAgICB9OwogIH0gZWxzZSB7CiAgICAvLyBNYXRoLnJhbmRvbSgpLWJhc2VkIChSTkcpCiAgICAvLwogICAgLy8gSWYgYWxsIGVsc2UgZmFpbHMsIHVzZSBNYXRoLnJhbmRvbSgpLiAgSXQncyBmYXN0LCBidXQgaXMgb2YgdW5zcGVjaWZpZWQKICAgIC8vIHF1YWxpdHkuCiAgICB2YXIgcm5kcyA9IG5ldyBBcnJheSgxNik7CiAgCiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIG1hdGhSTkcoKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCByOyBpIDwgMTY7IGkrKykgewogICAgICAgIGlmICgoaSAmIDB4MDMpID09PSAwKSByID0gTWF0aC5yYW5kb20oKSAqIDB4MTAwMDAwMDAwOwogICAgICAgIHJuZHNbaV0gPSByID4+PiAoKGkgJiAweDAzKSA8PCAzKSAmIDB4ZmY7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHJuZHM7CiAgICB9OwogIH0KICAKICB9LHt9XSwxMDE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBybmcgPSByZXF1aXJlKCcuL2xpYi9ybmcnKTsKICB2YXIgYnl0ZXNUb1V1aWQgPSByZXF1aXJlKCcuL2xpYi9ieXRlc1RvVXVpZCcpOwogIAogIC8vICoqYHYxKClgIC0gR2VuZXJhdGUgdGltZS1iYXNlZCBVVUlEKioKICAvLwogIC8vIEluc3BpcmVkIGJ5IGh0dHBzOi8vZ2l0aHViLmNvbS9MaW9zSy9VVUlELmpzCiAgLy8gYW5kIGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS91dWlkLmh0bWwKICAKICB2YXIgX25vZGVJZDsKICB2YXIgX2Nsb2Nrc2VxOwogIAogIC8vIFByZXZpb3VzIHV1aWQgY3JlYXRpb24gdGltZQogIHZhciBfbGFzdE1TZWNzID0gMDsKICB2YXIgX2xhc3ROU2VjcyA9IDA7CiAgCiAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9icm9vZmEvbm9kZS11dWlkIGZvciBBUEkgZGV0YWlscwogIGZ1bmN0aW9uIHYxKG9wdGlvbnMsIGJ1Ziwgb2Zmc2V0KSB7CiAgICB2YXIgaSA9IGJ1ZiAmJiBvZmZzZXQgfHwgMDsKICAgIHZhciBiID0gYnVmIHx8IFtdOwogIAogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB2YXIgbm9kZSA9IG9wdGlvbnMubm9kZSB8fCBfbm9kZUlkOwogICAgdmFyIGNsb2Nrc2VxID0gb3B0aW9ucy5jbG9ja3NlcSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5jbG9ja3NlcSA6IF9jbG9ja3NlcTsKICAKICAgIC8vIG5vZGUgYW5kIGNsb2Nrc2VxIG5lZWQgdG8gYmUgaW5pdGlhbGl6ZWQgdG8gcmFuZG9tIHZhbHVlcyBpZiB0aGV5J3JlIG5vdAogICAgLy8gc3BlY2lmaWVkLiAgV2UgZG8gdGhpcyBsYXppbHkgdG8gbWluaW1pemUgaXNzdWVzIHJlbGF0ZWQgdG8gaW5zdWZmaWNpZW50CiAgICAvLyBzeXN0ZW0gZW50cm9weS4gIFNlZSAjMTg5CiAgICBpZiAobm9kZSA9PSBudWxsIHx8IGNsb2Nrc2VxID09IG51bGwpIHsKICAgICAgdmFyIHNlZWRCeXRlcyA9IHJuZygpOwogICAgICBpZiAobm9kZSA9PSBudWxsKSB7CiAgICAgICAgLy8gUGVyIDQuNSwgY3JlYXRlIGFuZCA0OC1iaXQgbm9kZSBpZCwgKDQ3IHJhbmRvbSBiaXRzICsgbXVsdGljYXN0IGJpdCA9IDEpCiAgICAgICAgbm9kZSA9IF9ub2RlSWQgPSBbCiAgICAgICAgICBzZWVkQnl0ZXNbMF0gfCAweDAxLAogICAgICAgICAgc2VlZEJ5dGVzWzFdLCBzZWVkQnl0ZXNbMl0sIHNlZWRCeXRlc1szXSwgc2VlZEJ5dGVzWzRdLCBzZWVkQnl0ZXNbNV0KICAgICAgICBdOwogICAgICB9CiAgICAgIGlmIChjbG9ja3NlcSA9PSBudWxsKSB7CiAgICAgICAgLy8gUGVyIDQuMi4yLCByYW5kb21pemUgKDE0IGJpdCkgY2xvY2tzZXEKICAgICAgICBjbG9ja3NlcSA9IF9jbG9ja3NlcSA9IChzZWVkQnl0ZXNbNl0gPDwgOCB8IHNlZWRCeXRlc1s3XSkgJiAweDNmZmY7CiAgICAgIH0KICAgIH0KICAKICAgIC8vIFVVSUQgdGltZXN0YW1wcyBhcmUgMTAwIG5hbm8tc2Vjb25kIHVuaXRzIHNpbmNlIHRoZSBHcmVnb3JpYW4gZXBvY2gsCiAgICAvLyAoMTU4Mi0xMC0xNSAwMDowMCkuICBKU051bWJlcnMgYXJlbid0IHByZWNpc2UgZW5vdWdoIGZvciB0aGlzLCBzbwogICAgLy8gdGltZSBpcyBoYW5kbGVkIGludGVybmFsbHkgYXMgJ21zZWNzJyAoaW50ZWdlciBtaWxsaXNlY29uZHMpIGFuZCAnbnNlY3MnCiAgICAvLyAoMTAwLW5hbm9zZWNvbmRzIG9mZnNldCBmcm9tIG1zZWNzKSBzaW5jZSB1bml4IGVwb2NoLCAxOTcwLTAxLTAxIDAwOjAwLgogICAgdmFyIG1zZWNzID0gb3B0aW9ucy5tc2VjcyAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5tc2VjcyA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogIAogICAgLy8gUGVyIDQuMi4xLjIsIHVzZSBjb3VudCBvZiB1dWlkJ3MgZ2VuZXJhdGVkIGR1cmluZyB0aGUgY3VycmVudCBjbG9jawogICAgLy8gY3ljbGUgdG8gc2ltdWxhdGUgaGlnaGVyIHJlc29sdXRpb24gY2xvY2sKICAgIHZhciBuc2VjcyA9IG9wdGlvbnMubnNlY3MgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubnNlY3MgOiBfbGFzdE5TZWNzICsgMTsKICAKICAgIC8vIFRpbWUgc2luY2UgbGFzdCB1dWlkIGNyZWF0aW9uIChpbiBtc2VjcykKICAgIHZhciBkdCA9IChtc2VjcyAtIF9sYXN0TVNlY3MpICsgKG5zZWNzIC0gX2xhc3ROU2VjcykvMTAwMDA7CiAgCiAgICAvLyBQZXIgNC4yLjEuMiwgQnVtcCBjbG9ja3NlcSBvbiBjbG9jayByZWdyZXNzaW9uCiAgICBpZiAoZHQgPCAwICYmIG9wdGlvbnMuY2xvY2tzZXEgPT09IHVuZGVmaW5lZCkgewogICAgICBjbG9ja3NlcSA9IGNsb2Nrc2VxICsgMSAmIDB4M2ZmZjsKICAgIH0KICAKICAgIC8vIFJlc2V0IG5zZWNzIGlmIGNsb2NrIHJlZ3Jlc3NlcyAobmV3IGNsb2Nrc2VxKSBvciB3ZSd2ZSBtb3ZlZCBvbnRvIGEgbmV3CiAgICAvLyB0aW1lIGludGVydmFsCiAgICBpZiAoKGR0IDwgMCB8fCBtc2VjcyA+IF9sYXN0TVNlY3MpICYmIG9wdGlvbnMubnNlY3MgPT09IHVuZGVmaW5lZCkgewogICAgICBuc2VjcyA9IDA7CiAgICB9CiAgCiAgICAvLyBQZXIgNC4yLjEuMiBUaHJvdyBlcnJvciBpZiB0b28gbWFueSB1dWlkcyBhcmUgcmVxdWVzdGVkCiAgICBpZiAobnNlY3MgPj0gMTAwMDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCd1dWlkLnYxKCk6IENhblwndCBjcmVhdGUgbW9yZSB0aGFuIDEwTSB1dWlkcy9zZWMnKTsKICAgIH0KICAKICAgIF9sYXN0TVNlY3MgPSBtc2VjczsKICAgIF9sYXN0TlNlY3MgPSBuc2VjczsKICAgIF9jbG9ja3NlcSA9IGNsb2Nrc2VxOwogIAogICAgLy8gUGVyIDQuMS40IC0gQ29udmVydCBmcm9tIHVuaXggZXBvY2ggdG8gR3JlZ29yaWFuIGVwb2NoCiAgICBtc2VjcyArPSAxMjIxOTI5MjgwMDAwMDsKICAKICAgIC8vIGB0aW1lX2xvd2AKICAgIHZhciB0bCA9ICgobXNlY3MgJiAweGZmZmZmZmYpICogMTAwMDAgKyBuc2VjcykgJSAweDEwMDAwMDAwMDsKICAgIGJbaSsrXSA9IHRsID4+PiAyNCAmIDB4ZmY7CiAgICBiW2krK10gPSB0bCA+Pj4gMTYgJiAweGZmOwogICAgYltpKytdID0gdGwgPj4+IDggJiAweGZmOwogICAgYltpKytdID0gdGwgJiAweGZmOwogIAogICAgLy8gYHRpbWVfbWlkYAogICAgdmFyIHRtaCA9IChtc2VjcyAvIDB4MTAwMDAwMDAwICogMTAwMDApICYgMHhmZmZmZmZmOwogICAgYltpKytdID0gdG1oID4+PiA4ICYgMHhmZjsKICAgIGJbaSsrXSA9IHRtaCAmIDB4ZmY7CiAgCiAgICAvLyBgdGltZV9oaWdoX2FuZF92ZXJzaW9uYAogICAgYltpKytdID0gdG1oID4+PiAyNCAmIDB4ZiB8IDB4MTA7IC8vIGluY2x1ZGUgdmVyc2lvbgogICAgYltpKytdID0gdG1oID4+PiAxNiAmIDB4ZmY7CiAgCiAgICAvLyBgY2xvY2tfc2VxX2hpX2FuZF9yZXNlcnZlZGAgKFBlciA0LjIuMiAtIGluY2x1ZGUgdmFyaWFudCkKICAgIGJbaSsrXSA9IGNsb2Nrc2VxID4+PiA4IHwgMHg4MDsKICAKICAgIC8vIGBjbG9ja19zZXFfbG93YAogICAgYltpKytdID0gY2xvY2tzZXEgJiAweGZmOwogIAogICAgLy8gYG5vZGVgCiAgICBmb3IgKHZhciBuID0gMDsgbiA8IDY7ICsrbikgewogICAgICBiW2kgKyBuXSA9IG5vZGVbbl07CiAgICB9CiAgCiAgICByZXR1cm4gYnVmID8gYnVmIDogYnl0ZXNUb1V1aWQoYik7CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gdjE7CiAgCiAgfSx7Ii4vbGliL2J5dGVzVG9VdWlkIjo5OSwiLi9saWIvcm5nIjoxMDB9XSwxMDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBybmcgPSByZXF1aXJlKCcuL2xpYi9ybmcnKTsKICB2YXIgYnl0ZXNUb1V1aWQgPSByZXF1aXJlKCcuL2xpYi9ieXRlc1RvVXVpZCcpOwogIAogIGZ1bmN0aW9uIHY0KG9wdGlvbnMsIGJ1Ziwgb2Zmc2V0KSB7CiAgICB2YXIgaSA9IGJ1ZiAmJiBvZmZzZXQgfHwgMDsKICAKICAgIGlmICh0eXBlb2Yob3B0aW9ucykgPT0gJ3N0cmluZycpIHsKICAgICAgYnVmID0gb3B0aW9ucyA9PT0gJ2JpbmFyeScgPyBuZXcgQXJyYXkoMTYpIDogbnVsbDsKICAgICAgb3B0aW9ucyA9IG51bGw7CiAgICB9CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAKICAgIHZhciBybmRzID0gb3B0aW9ucy5yYW5kb20gfHwgKG9wdGlvbnMucm5nIHx8IHJuZykoKTsKICAKICAgIC8vIFBlciA0LjQsIHNldCBiaXRzIGZvciB2ZXJzaW9uIGFuZCBgY2xvY2tfc2VxX2hpX2FuZF9yZXNlcnZlZGAKICAgIHJuZHNbNl0gPSAocm5kc1s2XSAmIDB4MGYpIHwgMHg0MDsKICAgIHJuZHNbOF0gPSAocm5kc1s4XSAmIDB4M2YpIHwgMHg4MDsKICAKICAgIC8vIENvcHkgYnl0ZXMgdG8gYnVmZmVyLCBpZiBwcm92aWRlZAogICAgaWYgKGJ1ZikgewogICAgICBmb3IgKHZhciBpaSA9IDA7IGlpIDwgMTY7ICsraWkpIHsKICAgICAgICBidWZbaSArIGlpXSA9IHJuZHNbaWldOwogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gYnVmIHx8IGJ5dGVzVG9VdWlkKHJuZHMpOwogIH0KICAKICBtb2R1bGUuZXhwb3J0cyA9IHY0OwogIAogIH0seyIuL2xpYi9ieXRlc1RvVXVpZCI6OTksIi4vbGliL3JuZyI6MTAwfV0sMTAzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAidXNlIHN0cmljdCI7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKICB2YXIgTFJVXzEgPSByZXF1aXJlKCIuL3V0aWxzL0xSVSIpOwogIHZhciBDQUNIRV9TSVpFID0gMTAwMDsKICAvKioKICAgKiBJbnNwaXJlZCBub2RlLWxydS1jYWNoZVtodHRwczovL2dpdGh1Yi5jb20vaXNhYWNzL25vZGUtbHJ1LWNhY2hlXQogICAqLwogIHZhciBFbmRwb2ludENhY2hlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgewogICAgICBmdW5jdGlvbiBFbmRwb2ludENhY2hlKG1heFNpemUpIHsKICAgICAgICAgIGlmIChtYXhTaXplID09PSB2b2lkIDApIHsgbWF4U2l6ZSA9IENBQ0hFX1NJWkU7IH0KICAgICAgICAgIHRoaXMubWF4U2l6ZSA9IG1heFNpemU7CiAgICAgICAgICB0aGlzLmNhY2hlID0gbmV3IExSVV8xLkxSVUNhY2hlKG1heFNpemUpOwogICAgICB9CiAgICAgIDsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLCAic2l6ZSIsIHsKICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLmNhY2hlLmxlbmd0aDsKICAgICAgICAgIH0sCiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgIH0pOwogICAgICBFbmRwb2ludENhY2hlLnByb3RvdHlwZS5wdXQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBrZXlTdHJpbmcgPSB0eXBlb2Yga2V5ICE9PSAnc3RyaW5nJyA/IEVuZHBvaW50Q2FjaGUuZ2V0S2V5U3RyaW5nKGtleSkgOiBrZXk7CiAgICAgICAgICB2YXIgZW5kcG9pbnRSZWNvcmQgPSB0aGlzLnBvcHVsYXRlVmFsdWUodmFsdWUpOwogICAgICAgICAgdGhpcy5jYWNoZS5wdXQoa2V5U3RyaW5nLCBlbmRwb2ludFJlY29yZCk7CiAgICAgIH07CiAgICAgIEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIga2V5U3RyaW5nID0gdHlwZW9mIGtleSAhPT0gJ3N0cmluZycgPyBFbmRwb2ludENhY2hlLmdldEtleVN0cmluZyhrZXkpIDoga2V5OwogICAgICAgICAgdmFyIG5vdyA9IERhdGUubm93KCk7CiAgICAgICAgICB2YXIgcmVjb3JkcyA9IHRoaXMuY2FjaGUuZ2V0KGtleVN0cmluZyk7CiAgICAgICAgICBpZiAocmVjb3JkcykgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVjb3Jkcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICB2YXIgcmVjb3JkID0gcmVjb3Jkc1tpXTsKICAgICAgICAgICAgICAgICAgaWYgKHJlY29yZC5FeHBpcmUgPCBub3cpIHsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2FjaGUucmVtb3ZlKGtleVN0cmluZyk7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlY29yZHM7CiAgICAgIH07CiAgICAgIEVuZHBvaW50Q2FjaGUuZ2V0S2V5U3RyaW5nID0gZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgdmFyIGlkZW50aWZpZXJzID0gW107CiAgICAgICAgICB2YXIgaWRlbnRpZmllck5hbWVzID0gT2JqZWN0LmtleXMoa2V5KS5zb3J0KCk7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGlkZW50aWZpZXJOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBpZGVudGlmaWVyTmFtZSA9IGlkZW50aWZpZXJOYW1lc1tpXTsKICAgICAgICAgICAgICBpZiAoa2V5W2lkZW50aWZpZXJOYW1lXSA9PT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICBpZGVudGlmaWVycy5wdXNoKGtleVtpZGVudGlmaWVyTmFtZV0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGlkZW50aWZpZXJzLmpvaW4oJyAnKTsKICAgICAgfTsKICAgICAgRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUucG9wdWxhdGVWYWx1ZSA9IGZ1bmN0aW9uIChlbmRwb2ludHMpIHsKICAgICAgICAgIHZhciBub3cgPSBEYXRlLm5vdygpOwogICAgICAgICAgcmV0dXJuIGVuZHBvaW50cy5tYXAoZnVuY3Rpb24gKGVuZHBvaW50KSB7IHJldHVybiAoewogICAgICAgICAgICAgIEFkZHJlc3M6IGVuZHBvaW50LkFkZHJlc3MgfHwgJycsCiAgICAgICAgICAgICAgRXhwaXJlOiBub3cgKyAoZW5kcG9pbnQuQ2FjaGVQZXJpb2RJbk1pbnV0ZXMgfHwgMSkgKiA2MCAqIDEwMDAKICAgICAgICAgIH0pOyB9KTsKICAgICAgfTsKICAgICAgRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUuZW1wdHkgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB0aGlzLmNhY2hlLmVtcHR5KCk7CiAgICAgIH07CiAgICAgIEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIga2V5U3RyaW5nID0gdHlwZW9mIGtleSAhPT0gJ3N0cmluZycgPyBFbmRwb2ludENhY2hlLmdldEtleVN0cmluZyhrZXkpIDoga2V5OwogICAgICAgICAgdGhpcy5jYWNoZS5yZW1vdmUoa2V5U3RyaW5nKTsKICAgICAgfTsKICAgICAgcmV0dXJuIEVuZHBvaW50Q2FjaGU7CiAgfSgpKTsKICBleHBvcnRzLkVuZHBvaW50Q2FjaGUgPSBFbmRwb2ludENhY2hlOwogIH0seyIuL3V0aWxzL0xSVSI6MTA0fV0sMTA0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAidXNlIHN0cmljdCI7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKICB2YXIgTGlua2VkTGlzdE5vZGUgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7CiAgICAgIGZ1bmN0aW9uIExpbmtlZExpc3ROb2RlKGtleSwgdmFsdWUpIHsKICAgICAgICAgIHRoaXMua2V5ID0ga2V5OwogICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICB9CiAgICAgIHJldHVybiBMaW5rZWRMaXN0Tm9kZTsKICB9KCkpOwogIHZhciBMUlVDYWNoZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsKICAgICAgZnVuY3Rpb24gTFJVQ2FjaGUoc2l6ZSkgewogICAgICAgICAgdGhpcy5ub2RlTWFwID0ge307CiAgICAgICAgICB0aGlzLnNpemUgPSAwOwogICAgICAgICAgaWYgKHR5cGVvZiBzaXplICE9PSAnbnVtYmVyJyB8fCBzaXplIDwgMSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2FjaGUgc2l6ZSBjYW4gb25seSBiZSBwb3NpdGl2ZSBudW1iZXInKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuc2l6ZUxpbWl0ID0gc2l6ZTsKICAgICAgfQogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTFJVQ2FjaGUucHJvdG90eXBlLCAibGVuZ3RoIiwgewogICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2l6ZTsKICAgICAgICAgIH0sCiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgIH0pOwogICAgICBMUlVDYWNoZS5wcm90b3R5cGUucHJlcGVuZFRvTGlzdCA9IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICBpZiAoIXRoaXMuaGVhZGVyTm9kZSkgewogICAgICAgICAgICAgIHRoaXMudGFpbE5vZGUgPSBub2RlOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5oZWFkZXJOb2RlLnByZXYgPSBub2RlOwogICAgICAgICAgICAgIG5vZGUubmV4dCA9IHRoaXMuaGVhZGVyTm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuaGVhZGVyTm9kZSA9IG5vZGU7CiAgICAgICAgICB0aGlzLnNpemUrKzsKICAgICAgfTsKICAgICAgTFJVQ2FjaGUucHJvdG90eXBlLnJlbW92ZUZyb21UYWlsID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKCF0aGlzLnRhaWxOb2RlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBub2RlID0gdGhpcy50YWlsTm9kZTsKICAgICAgICAgIHZhciBwcmV2Tm9kZSA9IG5vZGUucHJldjsKICAgICAgICAgIGlmIChwcmV2Tm9kZSkgewogICAgICAgICAgICAgIHByZXZOb2RlLm5leHQgPSB1bmRlZmluZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLnByZXYgPSB1bmRlZmluZWQ7CiAgICAgICAgICB0aGlzLnRhaWxOb2RlID0gcHJldk5vZGU7CiAgICAgICAgICB0aGlzLnNpemUtLTsKICAgICAgICAgIHJldHVybiBub2RlOwogICAgICB9OwogICAgICBMUlVDYWNoZS5wcm90b3R5cGUuZGV0YWNoRnJvbUxpc3QgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgaWYgKHRoaXMuaGVhZGVyTm9kZSA9PT0gbm9kZSkgewogICAgICAgICAgICAgIHRoaXMuaGVhZGVyTm9kZSA9IG5vZGUubmV4dDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLnRhaWxOb2RlID09PSBub2RlKSB7CiAgICAgICAgICAgICAgdGhpcy50YWlsTm9kZSA9IG5vZGUucHJldjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChub2RlLnByZXYpIHsKICAgICAgICAgICAgICBub2RlLnByZXYubmV4dCA9IG5vZGUubmV4dDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChub2RlLm5leHQpIHsKICAgICAgICAgICAgICBub2RlLm5leHQucHJldiA9IG5vZGUucHJldjsKICAgICAgICAgIH0KICAgICAgICAgIG5vZGUubmV4dCA9IHVuZGVmaW5lZDsKICAgICAgICAgIG5vZGUucHJldiA9IHVuZGVmaW5lZDsKICAgICAgICAgIHRoaXMuc2l6ZS0tOwogICAgICB9OwogICAgICBMUlVDYWNoZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgaWYgKHRoaXMubm9kZU1hcFtrZXldKSB7CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzLm5vZGVNYXBba2V5XTsKICAgICAgICAgICAgICB0aGlzLmRldGFjaEZyb21MaXN0KG5vZGUpOwogICAgICAgICAgICAgIHRoaXMucHJlcGVuZFRvTGlzdChub2RlKTsKICAgICAgICAgICAgICByZXR1cm4gbm9kZS52YWx1ZTsKICAgICAgICAgIH0KICAgICAgfTsKICAgICAgTFJVQ2FjaGUucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIGlmICh0aGlzLm5vZGVNYXBba2V5XSkgewogICAgICAgICAgICAgIHZhciBub2RlID0gdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgICAgICAgdGhpcy5kZXRhY2hGcm9tTGlzdChub2RlKTsKICAgICAgICAgICAgICBkZWxldGUgdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIExSVUNhY2hlLnByb3RvdHlwZS5wdXQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgaWYgKHRoaXMubm9kZU1hcFtrZXldKSB7CiAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoa2V5KTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKHRoaXMuc2l6ZSA9PT0gdGhpcy5zaXplTGltaXQpIHsKICAgICAgICAgICAgICB2YXIgdGFpbE5vZGUgPSB0aGlzLnJlbW92ZUZyb21UYWlsKCk7CiAgICAgICAgICAgICAgdmFyIGtleV8xID0gdGFpbE5vZGUua2V5OwogICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm5vZGVNYXBba2V5XzFdOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld05vZGUgPSBuZXcgTGlua2VkTGlzdE5vZGUoa2V5LCB2YWx1ZSk7CiAgICAgICAgICB0aGlzLm5vZGVNYXBba2V5XSA9IG5ld05vZGU7CiAgICAgICAgICB0aGlzLnByZXBlbmRUb0xpc3QobmV3Tm9kZSk7CiAgICAgIH07CiAgICAgIExSVUNhY2hlLnByb3RvdHlwZS5lbXB0eSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXModGhpcy5ub2RlTWFwKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICAgICAgICAgIHZhciBub2RlID0gdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgICAgICAgdGhpcy5kZXRhY2hGcm9tTGlzdChub2RlKTsKICAgICAgICAgICAgICBkZWxldGUgdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIHJldHVybiBMUlVDYWNoZTsKICB9KCkpOwogIGV4cG9ydHMuTFJVQ2FjaGUgPSBMUlVDYWNoZTsKICB9LHt9XSwxMDU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIEFXUyBTREsgZm9yIEphdmFTY3JpcHQgdjIuNTUzLjAKICAvLyBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICAvLyBMaWNlbnNlIGF0IGh0dHBzOi8vc2RrLmFtYXpvbmF3cy5jb20vanMvQlVORExFX0xJQ0VOU0UudHh0CiAgcmVxdWlyZSgnLi9icm93c2VyX2xvYWRlcicpOwogIAogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICAKICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHdpbmRvdy5BV1MgPSBBV1M7CiAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIC8qKgogICAgICAgKiBAYXBpIHByaXZhdGUKICAgICAgICovCiAgICAgIG1vZHVsZS5leHBvcnRzID0gQVdTOwogIH0KICBpZiAodHlwZW9mIHNlbGYgIT09ICd1bmRlZmluZWQnKSBzZWxmLkFXUyA9IEFXUzsKICAKICAvKioKICAgKiBAcHJpdmF0ZQogICAqIERPIE5PVCBSRU1PVkUKICAgKiBicm93c2VyIGJ1aWxkZXIgd2lsbCBzdHJpcCBvdXQgdGhpcyBsaW5lIGlmIHNlcnZpY2VzIGFyZSBzdXBwbGllZCBvbiB0aGUgY29tbWFuZCBsaW5lLgogICAqL2lmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKEFXUywgJ0Nvbm5lY3QnKSkgewogICAgQVdTLmFwaUxvYWRlci5zZXJ2aWNlc1snY29ubmVjdCddID0ge307CiAgICBBV1MuQ29ubmVjdCA9IEFXUy5TZXJ2aWNlLmRlZmluZVNlcnZpY2UoJ2Nvbm5lY3QnLCBbICcyMDE3LTAyLTE1JyBdKTsKICB9CiAgQVdTLmFwaUxvYWRlci5zZXJ2aWNlc1snY29ubmVjdCddWycyMDE3LTAyLTE1J10gPSByZXF1aXJlKCcuLi9hcGlzL2Nvbm5lY3QtMjAxNy0wMi0xNS5taW4nKTsKICAKICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChBV1MsICdTVFMnKSkgewogICAgQVdTLmFwaUxvYWRlci5zZXJ2aWNlc1snc3RzJ10gPSB7fTsKICAgIEFXUy5TVFMgPSBBV1MuU2VydmljZS5kZWZpbmVTZXJ2aWNlKCdzdHMnLCBbICcyMDExLTA2LTE1JyBdKTsKICAgIHJlcXVpcmUoJy4vc2VydmljZXMvc3RzJyk7CiAgfQogIEFXUy5hcGlMb2FkZXIuc2VydmljZXNbJ3N0cyddWycyMDExLTA2LTE1J10gPSByZXF1aXJlKCcuLi9hcGlzL3N0cy0yMDExLTA2LTE1Lm1pbicpOwogIAogIAogIH0seyIuLi9hcGlzL2Nvbm5lY3QtMjAxNy0wMi0xNS5taW4iOjMsIi4uL2FwaXMvc3RzLTIwMTEtMDYtMTUubWluIjo1LCIuL2Jyb3dzZXJfbG9hZGVyIjoxNiwiLi9jb3JlIjoxOCwiLi9zZXJ2aWNlcy9zdHMiOjYxfV19LHt9LFsxMDVdKTsKICAKICAKLyohIEBsaWNlbnNlIHNwcmludGYuanMgfCBDb3B5cmlnaHQgKGMpIDIwMDctMjAxMyBBbGV4YW5kcnUgTWFyYXN0ZWFudSA8aGVsbG8gYXQgYWxleGVpIGRvdCBybz4gfCAzIGNsYXVzZSBCU0QgbGljZW5zZSAqLwoKKGZ1bmN0aW9uKCkgewogICB2YXIgY3R4ID0gdGhpczsKCgl2YXIgc3ByaW50ZiA9IGZ1bmN0aW9uKCkgewoJCWlmICghc3ByaW50Zi5jYWNoZS5oYXNPd25Qcm9wZXJ0eShhcmd1bWVudHNbMF0pKSB7CgkJCXNwcmludGYuY2FjaGVbYXJndW1lbnRzWzBdXSA9IHNwcmludGYucGFyc2UoYXJndW1lbnRzWzBdKTsKCQl9CgkJcmV0dXJuIHNwcmludGYuZm9ybWF0LmNhbGwobnVsbCwgc3ByaW50Zi5jYWNoZVthcmd1bWVudHNbMF1dLCBhcmd1bWVudHMpOwoJfTsKCglzcHJpbnRmLmZvcm1hdCA9IGZ1bmN0aW9uKHBhcnNlX3RyZWUsIGFyZ3YpIHsKCQl2YXIgY3Vyc29yID0gMSwgdHJlZV9sZW5ndGggPSBwYXJzZV90cmVlLmxlbmd0aCwgbm9kZV90eXBlID0gJycsIGFyZywgb3V0cHV0ID0gW10sIGksIGssIG1hdGNoLCBwYWQsIHBhZF9jaGFyYWN0ZXIsIHBhZF9sZW5ndGg7CgkJZm9yIChpID0gMDsgaSA8IHRyZWVfbGVuZ3RoOyBpKyspIHsKCQkJbm9kZV90eXBlID0gZ2V0X3R5cGUocGFyc2VfdHJlZVtpXSk7CgkJCWlmIChub2RlX3R5cGUgPT09ICdzdHJpbmcnKSB7CgkJCQlvdXRwdXQucHVzaChwYXJzZV90cmVlW2ldKTsKCQkJfQoJCQllbHNlIGlmIChub2RlX3R5cGUgPT09ICdhcnJheScpIHsKCQkJCW1hdGNoID0gcGFyc2VfdHJlZVtpXTsgLy8gY29udmVuaWVuY2UgcHVycG9zZXMgb25seQoJCQkJaWYgKG1hdGNoWzJdKSB7IC8vIGtleXdvcmQgYXJndW1lbnQKCQkJCQlhcmcgPSBhcmd2W2N1cnNvcl07CgkJCQkJZm9yIChrID0gMDsgayA8IG1hdGNoWzJdLmxlbmd0aDsgaysrKSB7CgkJCQkJCWlmICghYXJnLmhhc093blByb3BlcnR5KG1hdGNoWzJdW2tdKSkgewoJCQkJCQkJdGhyb3coc3ByaW50ZignW3NwcmludGZdIHByb3BlcnR5ICIlcyIgZG9lcyBub3QgZXhpc3QnLCBtYXRjaFsyXVtrXSkpOwoJCQkJCQl9CgkJCQkJCWFyZyA9IGFyZ1ttYXRjaFsyXVtrXV07CgkJCQkJfQoJCQkJfQoJCQkJZWxzZSBpZiAobWF0Y2hbMV0pIHsgLy8gcG9zaXRpb25hbCBhcmd1bWVudCAoZXhwbGljaXQpCgkJCQkJYXJnID0gYXJndlttYXRjaFsxXV07CgkJCQl9CgkJCQllbHNlIHsgLy8gcG9zaXRpb25hbCBhcmd1bWVudCAoaW1wbGljaXQpCgkJCQkJYXJnID0gYXJndltjdXJzb3IrK107CgkJCQl9CgoJCQkJaWYgKC9bXnNdLy50ZXN0KG1hdGNoWzhdKSAmJiAoZ2V0X3R5cGUoYXJnKSAhPSAnbnVtYmVyJykpIHsKCQkJCQl0aHJvdyhzcHJpbnRmKCdbc3ByaW50Zl0gZXhwZWN0aW5nIG51bWJlciBidXQgZm91bmQgJXMnLCBnZXRfdHlwZShhcmcpKSk7CgkJCQl9CgkJCQlzd2l0Y2ggKG1hdGNoWzhdKSB7CgkJCQkJY2FzZSAnYic6IGFyZyA9IGFyZy50b1N0cmluZygyKTsgYnJlYWs7CgkJCQkJY2FzZSAnYyc6IGFyZyA9IFN0cmluZy5mcm9tQ2hhckNvZGUoYXJnKTsgYnJlYWs7CgkJCQkJY2FzZSAnZCc6IGFyZyA9IHBhcnNlSW50KGFyZywgMTApOyBicmVhazsKCQkJCQljYXNlICdlJzogYXJnID0gbWF0Y2hbN10gPyBhcmcudG9FeHBvbmVudGlhbChtYXRjaFs3XSkgOiBhcmcudG9FeHBvbmVudGlhbCgpOyBicmVhazsKCQkJCQljYXNlICdmJzogYXJnID0gbWF0Y2hbN10gPyBwYXJzZUZsb2F0KGFyZykudG9GaXhlZChtYXRjaFs3XSkgOiBwYXJzZUZsb2F0KGFyZyk7IGJyZWFrOwoJCQkJCWNhc2UgJ28nOiBhcmcgPSBhcmcudG9TdHJpbmcoOCk7IGJyZWFrOwoJCQkJCWNhc2UgJ3MnOiBhcmcgPSAoKGFyZyA9IFN0cmluZyhhcmcpKSAmJiBtYXRjaFs3XSA/IGFyZy5zdWJzdHJpbmcoMCwgbWF0Y2hbN10pIDogYXJnKTsgYnJlYWs7CgkJCQkJY2FzZSAndSc6IGFyZyA9IGFyZyA+Pj4gMDsgYnJlYWs7CgkJCQkJY2FzZSAneCc6IGFyZyA9IGFyZy50b1N0cmluZygxNik7IGJyZWFrOwoJCQkJCWNhc2UgJ1gnOiBhcmcgPSBhcmcudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCk7IGJyZWFrOwoJCQkJfQoJCQkJYXJnID0gKC9bZGVmXS8udGVzdChtYXRjaFs4XSkgJiYgbWF0Y2hbM10gJiYgYXJnID49IDAgPyAnKycrIGFyZyA6IGFyZyk7CgkJCQlwYWRfY2hhcmFjdGVyID0gbWF0Y2hbNF0gPyBtYXRjaFs0XSA9PSAnMCcgPyAnMCcgOiBtYXRjaFs0XS5jaGFyQXQoMSkgOiAnICc7CgkJCQlwYWRfbGVuZ3RoID0gbWF0Y2hbNl0gLSBTdHJpbmcoYXJnKS5sZW5ndGg7CgkJCQlwYWQgPSBtYXRjaFs2XSA/IHN0cl9yZXBlYXQocGFkX2NoYXJhY3RlciwgcGFkX2xlbmd0aCkgOiAnJzsKCQkJCW91dHB1dC5wdXNoKG1hdGNoWzVdID8gYXJnICsgcGFkIDogcGFkICsgYXJnKTsKCQkJfQoJCX0KCQlyZXR1cm4gb3V0cHV0LmpvaW4oJycpOwoJfTsKCglzcHJpbnRmLmNhY2hlID0ge307CgoJc3ByaW50Zi5wYXJzZSA9IGZ1bmN0aW9uKGZtdCkgewoJCXZhciBfZm10ID0gZm10LCBtYXRjaCA9IFtdLCBwYXJzZV90cmVlID0gW10sIGFyZ19uYW1lcyA9IDA7CgkJd2hpbGUgKF9mbXQpIHsKCQkJaWYgKChtYXRjaCA9IC9eW15ceDI1XSsvLmV4ZWMoX2ZtdCkpICE9PSBudWxsKSB7CgkJCQlwYXJzZV90cmVlLnB1c2gobWF0Y2hbMF0pOwoJCQl9CgkJCWVsc2UgaWYgKChtYXRjaCA9IC9eXHgyNXsyfS8uZXhlYyhfZm10KSkgIT09IG51bGwpIHsKCQkJCXBhcnNlX3RyZWUucHVzaCgnJScpOwoJCQl9CgkJCWVsc2UgaWYgKChtYXRjaCA9IC9eXHgyNSg/OihbMS05XVxkKilcJHxcKChbXlwpXSspXCkpPyhcKyk/KDB8J1teJF0pPygtKT8oXGQrKT8oPzpcLihcZCspKT8oW2ItZm9zdXhYXSkvLmV4ZWMoX2ZtdCkpICE9PSBudWxsKSB7CgkJCQlpZiAobWF0Y2hbMl0pIHsKCQkJCQlhcmdfbmFtZXMgfD0gMTsKCQkJCQl2YXIgZmllbGRfbGlzdCA9IFtdLCByZXBsYWNlbWVudF9maWVsZCA9IG1hdGNoWzJdLCBmaWVsZF9tYXRjaCA9IFtdOwoJCQkJCWlmICgoZmllbGRfbWF0Y2ggPSAvXihbYS16X11bYS16X1xkXSopL2kuZXhlYyhyZXBsYWNlbWVudF9maWVsZCkpICE9PSBudWxsKSB7CgkJCQkJCWZpZWxkX2xpc3QucHVzaChmaWVsZF9tYXRjaFsxXSk7CgkJCQkJCXdoaWxlICgocmVwbGFjZW1lbnRfZmllbGQgPSByZXBsYWNlbWVudF9maWVsZC5zdWJzdHJpbmcoZmllbGRfbWF0Y2hbMF0ubGVuZ3RoKSkgIT09ICcnKSB7CgkJCQkJCQlpZiAoKGZpZWxkX21hdGNoID0gL15cLihbYS16X11bYS16X1xkXSopL2kuZXhlYyhyZXBsYWNlbWVudF9maWVsZCkpICE9PSBudWxsKSB7CgkJCQkJCQkJZmllbGRfbGlzdC5wdXNoKGZpZWxkX21hdGNoWzFdKTsKCQkJCQkJCX0KCQkJCQkJCWVsc2UgaWYgKChmaWVsZF9tYXRjaCA9IC9eXFsoXGQrKVxdLy5leGVjKHJlcGxhY2VtZW50X2ZpZWxkKSkgIT09IG51bGwpIHsKCQkJCQkJCQlmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwoJCQkJCQkJfQoJCQkJCQkJZWxzZSB7CgkJCQkJCQkJdGhyb3coJ1tzcHJpbnRmXSBodWg/Jyk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQkJZWxzZSB7CgkJCQkJCXRocm93KCdbc3ByaW50Zl0gaHVoPycpOwoJCQkJCX0KCQkJCQltYXRjaFsyXSA9IGZpZWxkX2xpc3Q7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQlhcmdfbmFtZXMgfD0gMjsKCQkJCX0KCQkJCWlmIChhcmdfbmFtZXMgPT09IDMpIHsKCQkJCQl0aHJvdygnW3NwcmludGZdIG1peGluZyBwb3NpdGlvbmFsIGFuZCBuYW1lZCBwbGFjZWhvbGRlcnMgaXMgbm90ICh5ZXQpIHN1cHBvcnRlZCcpOwoJCQkJfQoJCQkJcGFyc2VfdHJlZS5wdXNoKG1hdGNoKTsKCQkJfQoJCQllbHNlIHsKCQkJCXRocm93KCdbc3ByaW50Zl0gaHVoPycpOwoJCQl9CgkJCV9mbXQgPSBfZm10LnN1YnN0cmluZyhtYXRjaFswXS5sZW5ndGgpOwoJCX0KCQlyZXR1cm4gcGFyc2VfdHJlZTsKCX07CgoJdmFyIHZzcHJpbnRmID0gZnVuY3Rpb24oZm10LCBhcmd2LCBfYXJndikgewoJCV9hcmd2ID0gYXJndi5zbGljZSgwKTsKCQlfYXJndi5zcGxpY2UoMCwgMCwgZm10KTsKCQlyZXR1cm4gc3ByaW50Zi5hcHBseShudWxsLCBfYXJndik7Cgl9OwoKCS8qKgoJICogaGVscGVycwoJICovCglmdW5jdGlvbiBnZXRfdHlwZSh2YXJpYWJsZSkgewoJCXJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFyaWFibGUpLnNsaWNlKDgsIC0xKS50b0xvd2VyQ2FzZSgpOwoJfQoKCWZ1bmN0aW9uIHN0cl9yZXBlYXQoaW5wdXQsIG11bHRpcGxpZXIpIHsKCQlmb3IgKHZhciBvdXRwdXQgPSBbXTsgbXVsdGlwbGllciA+IDA7IG91dHB1dFstLW11bHRpcGxpZXJdID0gaW5wdXQpIHsvKiBkbyBub3RoaW5nICovfQoJCXJldHVybiBvdXRwdXQuam9pbignJyk7Cgl9CgoJLyoqCgkgKiBleHBvcnQgdG8gZWl0aGVyIGJyb3dzZXIgb3Igbm9kZS5qcwoJICovCgljdHguc3ByaW50ZiA9IHNwcmludGY7CgljdHgudnNwcmludGYgPSB2c3ByaW50ZjsKfSkoKTsKCgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICAvLyBIb3cgZnJlcXVlbnRseSBsb2dzIHNob3VsZCBiZSBjb2xsZWN0ZWQgYW5kIHJlcG9ydGVkIHRvIHNoYXJlZCB3b3JrZXIuCiAgdmFyIExPR19SRVBPUlRfSU5URVJWQUxfTUlMTElTID0gNTAwMDsKCiAgLy8gVGhlIGRlZmF1bHQgbG9nIHJvbGwgaW50ZXJ2YWwgKDMwbWluKQogIHZhciBERUZBVUxUX0xPR19ST0xMX0lOVEVSVkFMID0gMTgwMDAwMDsKCiAgLyoqCiAgICogQW4gZW51bWVyYXRpb24gb2YgY29tbW9uIGxvZ2dpbmcgbGV2ZWxzLgogICAqLwogIHZhciBMb2dMZXZlbCA9IHsKICAgIFRFU1Q6ICJURVNUIiwKICAgIFRSQUNFOiAiVFJBQ0UiLAogICAgREVCVUc6ICJERUJVRyIsCiAgICBJTkZPOiAiSU5GTyIsCiAgICBMT0c6ICJMT0ciLAogICAgV0FSTjogIldBUk4iLAogICAgRVJST1I6ICJFUlJPUiIsCiAgICBDUklUSUNBTDogIkNSSVRJQ0FMIgogIH07CgogIC8qKgogICAqIEFuIGVudW1lcmF0aW9uIG9mIGNvbW1vbiBsb2dnaW5nIGNvbXBvbmVudHMuCiAgICovCiAgdmFyIExvZ0NvbXBvbmVudCA9IHsKICAgIENDUDogImNjcCIsCiAgICBTT0ZUUEhPTkU6ICJzb2Z0cGhvbmUiLAogICAgQ0hBVDogImNoYXQiLAogICAgVEFTSzogInRhc2siCiAgfTsKCiAgLyoqCiAgICogVGhlIG51bWVyaWMgb3JkZXIgb2YgdGhlIGxvZ2dpbmcgbGV2ZWxzIGFib3ZlLgogICAqIFRoZXkgYXJlIHNwYWNlZCB0byBhbGxvdyB0aGUgYWRkaXRpb24gb2Ygb3RoZXIgbG9nCiAgICogbGV2ZWxzIGF0IGEgbGF0ZXIgdGltZS4KICAgKi8KICB2YXIgTG9nTGV2ZWxPcmRlciA9IHsKICAgIFRFU1Q6IDAsCiAgICBUUkFDRTogMTAsCiAgICBERUJVRzogMjAsCiAgICBJTkZPOiAzMCwKICAgIExPRzogNDAsCiAgICBXQVJOOiA1MCwKICAgIEVSUk9SOiAxMDAsCiAgICBDUklUSUNBTDogMjAwCgogIH07CgogIC8qKgogICAqIEEgbWFwIGZyb20gbG9nIGxldmVsIHRvIGNvbnNvbGUgbG9nZ2VyIGZ1bmN0aW9uLgogICAqLwogIHZhciBDT05TT0xFX0xPR0dFUl9NQVAgPSB7CiAgICBUUkFDRTogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5pbmZvKHRleHQpOyB9LAogICAgREVCVUc6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuaW5mbyh0ZXh0KTsgfSwKICAgIElORk86IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuaW5mbyh0ZXh0KTsgfSwKICAgIExPRzogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5sb2codGV4dCk7IH0sCiAgICBURVNUOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmxvZyh0ZXh0KTsgfSwKICAgIFdBUk46IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUud2Fybih0ZXh0KTsgfSwKICAgIEVSUk9SOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmVycm9yKHRleHQpOyB9LAogICAgQ1JJVElDQUw6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuZXJyb3IodGV4dCk7IH0KICB9OwoKICAvKioKICAqIENoZWNrcyBpZiBpdCBpcyBhIHZhbGlkIGxvZyBjb21wb25lbnQgZW51bQogICovCgogIHZhciBpc1ZhbGlkTG9nQ29tcG9uZW50ID0gZnVuY3Rpb24gKGNvbXBvbmVudCkgewogICAgcmV0dXJuIE9iamVjdC52YWx1ZXMoTG9nQ29tcG9uZW50KS5pbmRleE9mKGNvbXBvbmVudCkgIT09IC0xOwogIH07CgogIC8qKgogICogRXh0cmFjdCB0aGUgY3VzdG9tIGFyZ3VtZW50cyBhcyByZXF1aXJlZCBieSB0aGUgbG9nZ2VyCiAgKi8KICB2YXIgZXh0cmFjdExvZ2dlckFyZ3MgPSBmdW5jdGlvbiAobG9nZ2VyQXJncykgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChsb2dnZXJBcmdzLCAwKTsKICAgIHZhciBmaXJzdEFyZyA9IGFyZ3Muc2hpZnQoKTsKICAgIHZhciBmb3JtYXQ7CiAgICB2YXIgY29tcG9uZW50OwogICAgaWYgKGlzVmFsaWRMb2dDb21wb25lbnQoZmlyc3RBcmcpKSB7CiAgICAgIGNvbXBvbmVudCA9IGZpcnN0QXJnOwogICAgICBmb3JtYXQgPSBhcmdzLnNoaWZ0KCk7CiAgICB9IGVsc2UgewogICAgICAvL2RlZmF1bHQgdG8gQ0NQIGNvbXBvbmVudAogICAgICBmb3JtYXQgPSBmaXJzdEFyZzsKICAgICAgY29tcG9uZW50ID0gTG9nQ29tcG9uZW50LkNDUDsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIGZvcm1hdDogZm9ybWF0LAogICAgICBjb21wb25lbnQ6IGNvbXBvbmVudCwKICAgICAgYXJnczogYXJncwogICAgfTsKICB9OwoKICAvKioKICAgKiBBIGxvZyBlbnRyeS4KICAgKgogICAqIEBwYXJhbSBjb21wb25lbnQgVGhlIGxvZ2dpbmcgY29tcG9uZW50LgogICAqIEBwYXJhbSBsZXZlbCBUaGUgbG9nIGxldmVsIG9mIHRoaXMgbG9nIGVudHJ5LgogICAqIEBwYXJhbSB0ZXh0IFRoZSB0ZXh0IGNvbnRhaW5lZCBpbiB0aGUgbG9nIGVudHJ5LgogICAqIEBwYXJhbSBsb2dnZXJJZCBUaGUgcm9vdCBsb2dnZXIgaWQuCiAgICoKICAgKiBMb2cgZW50cmllcyBhcmUgYXdhcmUgb2YgdGhlaXIgdGltZXN0YW1wLCBvcmRlciwKICAgKiBhbmQgY2FuIGNvbnRhaW4gb2JqZWN0cyBhbmQgZXhjZXB0aW9uIHN0YWNrIHRyYWNlcy4KICAgKi8KICB2YXIgTG9nRW50cnkgPSBmdW5jdGlvbiAoY29tcG9uZW50LCBsZXZlbCwgdGV4dCwgbG9nZ2VySWQpIHsKICAgIHRoaXMuY29tcG9uZW50ID0gY29tcG9uZW50OwogICAgdGhpcy5sZXZlbCA9IGxldmVsOwogICAgdGhpcy50ZXh0ID0gdGV4dDsKICAgIHRoaXMudGltZSA9IG5ldyBEYXRlKCk7CiAgICB0aGlzLmV4Y2VwdGlvbiA9IG51bGw7CiAgICB0aGlzLm9iamVjdHMgPSBbXTsKICAgIHRoaXMubGluZSA9IDA7CiAgICB0aGlzLmxvZ2dlcklkID0gbG9nZ2VySWQ7CiAgfTsKCiAgTG9nRW50cnkuZnJvbU9iamVjdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBlbnRyeSA9IG5ldyBMb2dFbnRyeShMb2dDb21wb25lbnQuQ0NQLCBvYmoubGV2ZWwsIG9iai50ZXh0LCBvYmoubG9nZ2VySWQpOwoKICAgIC8vIFJlcXVpcmVkIHRvIGNoZWNrIGZvciBEYXRlIG9iamVjdHMgc2VudCBhY3Jvc3MgZnJhbWUgYm91bmRhcmllcwogICAgaWYgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmoudGltZSkgPT09ICdbb2JqZWN0IERhdGVdJykgewogICAgICBlbnRyeS50aW1lID0gbmV3IERhdGUob2JqLnRpbWUuZ2V0VGltZSgpKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iai50aW1lID09PSAnbnVtYmVyJykgewogICAgICBlbnRyeS50aW1lID0gbmV3IERhdGUob2JqLnRpbWUpOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygb2JqLnRpbWUgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVudHJ5LnRpbWUgPSBEYXRlLnBhcnNlKG9iai50aW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIGVudHJ5LnRpbWUgPSBuZXcgRGF0ZSgpOwogICAgfQogICAgZW50cnkuZXhjZXB0aW9uID0gb2JqLmV4Y2VwdGlvbjsKICAgIGVudHJ5Lm9iamVjdHMgPSBvYmoub2JqZWN0czsKICAgIHJldHVybiBlbnRyeTsKICB9OwoKICAvKioKICAgKiBQdWxscyB0aGUgdHlwZSwgbWVzc2FnZSwgYW5kIHN0YWNrIHRyYWNlCiAgICogb3V0IG9mIHRoZSBnaXZlbiBleGNlcHRpb24gZm9yIEpTT04gc2VyaWFsaXphdGlvbi4KICAgKi8KICB2YXIgTG9nZ2VkRXhjZXB0aW9uID0gZnVuY3Rpb24gKGUpIHsKICAgIHRoaXMudHlwZSA9IChlIGluc3RhbmNlb2YgRXJyb3IpID8gZS5uYW1lIDogZS5jb2RlIHx8IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChlKTsKICAgIHRoaXMubWVzc2FnZSA9IGUubWVzc2FnZTsKICAgIHRoaXMuc3RhY2sgPSBlLnN0YWNrID8gZS5zdGFjay5zcGxpdCgnXG4nKSA6IFtdOwogIH07CgogIC8qKgogICAqIE1pbmltYWxseSBzdHJpbmdpZnkgdGhpcyBsb2cgZW50cnkgZm9yIHByaW50aW5nCiAgICogdG8gdGhlIGNvbnNvbGUuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Quc3ByaW50ZigiWyVzXSBbJXNdOiAlcyIsCiAgICAgIHRoaXMuZ2V0VGltZSgpICYmIHRoaXMuZ2V0VGltZSgpLnRvSVNPU3RyaW5nID8gdGhpcy5nZXRUaW1lKCkudG9JU09TdHJpbmcoKSA6ICI/Pz8iLAogICAgICB0aGlzLmdldExldmVsKCksCiAgICAgIHRoaXMuZ2V0VGV4dCgpKTsKICB9OwoKICAvKioKICAgKiBHZXQgdGhlIGxvZyBlbnRyeSB0aW1lc3RhbXAuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLmdldFRpbWUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy50aW1lOwogIH07CgogIC8qKgogICAqIEdldCB0aGUgbGV2ZWwgb2YgdGhlIGxvZyBlbnRyeS4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUuZ2V0TGV2ZWwgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5sZXZlbDsKICB9OwoKICAvKioKICAgKiBHZXQgdGhlIGxvZyBlbnRyeSB0ZXh0LgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS5nZXRUZXh0ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMudGV4dDsKICB9OwoKICAvKioKICAgKiBHZXQgdGhlIGxvZyBlbnRyeSBjb21wb25lbnQuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLmdldENvbXBvbmVudCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbXBvbmVudDsKICB9OwoKICAvKioKICAgKiBBZGQgYW4gZXhjZXB0aW9uIHN0YWNrIHRyYWNlIHRvIHRoaXMgbG9nIGVudHJ5LgogICAqIEEgbG9nIGVudHJ5IG1heSBjb250YWluIG9ubHkgb25lIGV4Y2VwdGlvbiBzdGFjayB0cmFjZS4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUud2l0aEV4Y2VwdGlvbiA9IGZ1bmN0aW9uIChlKSB7CiAgICB0aGlzLmV4Y2VwdGlvbiA9IG5ldyBMb2dnZWRFeGNlcHRpb24oZSk7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvKioKICAgKiBBZGQgYW4gYXJiaXRyYXJ5IG9iamVjdCB0byB0aGUgbG9nIGVudHJ5LiAgQSBsb2cgZW50cnkKICAgKiBtYXkgY29udGFpbiBhbnkgbnVtYmVyIG9mIG9iamVjdHMuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLndpdGhPYmplY3QgPSBmdW5jdGlvbiAob2JqKSB7CiAgICB0aGlzLm9iamVjdHMucHVzaChjb25uZWN0LmRlZXBjb3B5KG9iaikpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLyoqCiAgICogVGhlIGxvZ2dlciBpbnN0YW5jZS4KICAgKi8KICB2YXIgTG9nZ2VyID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5fbG9ncyA9IFtdOwogICAgdGhpcy5fcm9sbGVkTG9ncyA9IFtdOwogICAgdGhpcy5fbG9nc1RvUHVzaCA9IFtdOwogICAgdGhpcy5fZWNob0xldmVsID0gTG9nTGV2ZWxPcmRlci5JTkZPOwogICAgdGhpcy5fbG9nTGV2ZWwgPSBMb2dMZXZlbE9yZGVyLklORk87CiAgICB0aGlzLl9saW5lQ291bnQgPSAwOwogICAgdGhpcy5fbG9nUm9sbEludGVydmFsID0gMDsKICAgIHRoaXMuX2xvZ1JvbGxUaW1lciA9IG51bGw7CiAgICB0aGlzLl9sb2dnZXJJZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpICsgIi0iICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMik7CiAgICB0aGlzLnNldExvZ1JvbGxJbnRlcnZhbChERUZBVUxUX0xPR19ST0xMX0lOVEVSVkFMKTsKICB9OwoKICAvKioKICAgKiBTZXRzIHRoZSBpbnRlcnZhbCBpbiBtaWxsaXNlY29uZHMgdGhhdCB0aGUgbG9ncyB3aWxsIGJlIHJvdGF0ZWQuCiAgICogTG9ncyBhcmUgcm90YXRlZCBvdXQgY29tcGxldGVseSBhdCB0aGUgZW5kIG9mIHRoZSBzZWNvbmQgcm9sbAogICAqIGFuZCB3aWxsIGV2ZW50dWFsbHkgYmUgZ2FyYmFnZSBjb2xsZWN0ZWQuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5zZXRMb2dSb2xsSW50ZXJ2YWwgPSBmdW5jdGlvbiAoaW50ZXJ2YWwpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBpZiAoISh0aGlzLl9sb2dSb2xsVGltZXIpIHx8IGludGVydmFsICE9PSB0aGlzLl9sb2dSb2xsSW50ZXJ2YWwpIHsKICAgICAgaWYgKHRoaXMuX2xvZ1JvbGxUaW1lcikgewogICAgICAgIGdsb2JhbC5jbGVhckludGVydmFsKHRoaXMuX2xvZ1JvbGxUaW1lcik7CiAgICAgIH0KICAgICAgdGhpcy5fbG9nUm9sbEludGVydmFsID0gaW50ZXJ2YWw7CiAgICAgIHRoaXMuX2xvZ1JvbGxUaW1lciA9IGdsb2JhbC5zZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5fcm9sbGVkTG9ncyA9IHRoaXMuX2xvZ3M7CiAgICAgICAgdGhpcy5fbG9ncyA9IFtdOwogICAgICAgIHNlbGYuaW5mbygiTG9nIHJvbGwgaW50ZXJ2YWwgb2NjdXJyZWQuIik7CiAgICAgIH0sIHRoaXMuX2xvZ1JvbGxJbnRlcnZhbCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLndhcm4oIkxvZ2dlciBpcyBhbHJlYWR5IHNldCB0byB0aGUgZ2l2ZW4gaW50ZXJ2YWw6ICVkIiwgdGhpcy5fbG9nUm9sbEludGVydmFsKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBTZXQgdGhlIGxvZyBsZXZlbC4gIFRoaXMgaXMgdGhlIG1pbmltdW0gbGV2ZWwgYXQgd2hpY2ggbG9ncyB3aWxsCiAgICogYmUga2VwdCBmb3IgbGF0ZXIgYXJjaGl2aW5nLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUuc2V0TG9nTGV2ZWwgPSBmdW5jdGlvbiAobGV2ZWwpIHsKICAgIGlmIChsZXZlbCBpbiBMb2dMZXZlbE9yZGVyKSB7CiAgICAgIHRoaXMuX2xvZ0xldmVsID0gTG9nTGV2ZWxPcmRlcltsZXZlbF07CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gbG9nZ2luZyBsZXZlbDogIiArIGxldmVsKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBTZXQgdGhlIGVjaG8gbGV2ZWwuICBUaGlzIGlzIHRoZSBtaW5pbXVtIGxldmVsIGF0IHdoaWNoIGxvZ3Mgd2lsbAogICAqIGJlIHByaW50ZWQgdG8gdGhlIGphdmFzY3JpcHQgY29uc29sZS4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLnNldEVjaG9MZXZlbCA9IGZ1bmN0aW9uIChsZXZlbCkgewogICAgaWYgKGxldmVsIGluIExvZ0xldmVsT3JkZXIpIHsKICAgICAgdGhpcy5fZWNob0xldmVsID0gTG9nTGV2ZWxPcmRlcltsZXZlbF07CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gbG9nZ2luZyBsZXZlbDogIiArIGxldmVsKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBXcml0ZSBhIHBhcnRpY3VsYXIgbG9nIGVudHJ5LgogICAqCiAgICogQHBhcmFtIGxldmVsIFRoZSBsb2dnaW5nIGxldmVsIG9mIHRoZSBlbnRyeS4KICAgKiBAcGFyYW0gdGV4dCBUaGUgdGV4dCBjb250ZW50cyBvZiB0aGUgZW50cnkuCiAgICoKICAgKiBAcmV0dXJucyBUaGUgbmV3IGxvZyBlbnRyeS4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLndyaXRlID0gZnVuY3Rpb24gKGNvbXBvbmVudCwgbGV2ZWwsIHRleHQpIHsKICAgIHZhciBsb2dFbnRyeSA9IG5ldyBMb2dFbnRyeShjb21wb25lbnQsIGxldmVsLCB0ZXh0LCB0aGlzLmdldExvZ2dlcklkKCkpOwogICAgdGhpcy5hZGRMb2dFbnRyeShsb2dFbnRyeSk7CiAgICByZXR1cm4gbG9nRW50cnk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5hZGRMb2dFbnRyeSA9IGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgdGhpcy5fbG9ncy5wdXNoKGxvZ0VudHJ5KTsKICAgIC8vRm9yIG5vdyBvbmx5IHNlbmQgc29mdHBob25lIGxvZ3Mgb25seS4KICAgIC8vVE9ETyBhZGQgQ0NQIGxvZ3Mgb25jZSB3ZSBhcmUgc3VyZSB0aGF0IG5vIHNlbnNpdGl2ZSBkYXRhIGlzIGJlaW5nIGxvZ2dlZC4KICAgIGlmIChMb2dDb21wb25lbnQuU09GVFBIT05FID09PSBsb2dFbnRyeS5jb21wb25lbnQpIHsKICAgICAgdGhpcy5fbG9nc1RvUHVzaC5wdXNoKGxvZ0VudHJ5KTsKICAgIH0KCiAgICBpZiAobG9nRW50cnkubGV2ZWwgaW4gTG9nTGV2ZWxPcmRlciAmJgogICAgICBMb2dMZXZlbE9yZGVyW2xvZ0VudHJ5LmxldmVsXSA+PSB0aGlzLl9sb2dMZXZlbCkgewoKICAgICAgaWYgKExvZ0xldmVsT3JkZXJbbG9nRW50cnkubGV2ZWxdID49IHRoaXMuX2VjaG9MZXZlbCkgewogICAgICAgIENPTlNPTEVfTE9HR0VSX01BUFtsb2dFbnRyeS5nZXRMZXZlbCgpXShsb2dFbnRyeS50b1N0cmluZygpKTsKICAgICAgfQoKICAgICAgbG9nRW50cnkubGluZSA9IHRoaXMuX2xpbmVDb3VudCsrOwogICAgfQogIH07CgogIC8qKgogICAqIFJlbW92ZSBhbGwgb2JqZWN0cyBmcm9tIGFsbCBsb2cgZW50cmllcy4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLmNsZWFyT2JqZWN0cyA9IGZ1bmN0aW9uICgpIHsKICAgIGZvciAodmFyIHggPSAwOyB4IDwgdGhpcy5fbG9ncy5sZW5ndGg7IHgrKykgewogICAgICBpZiAodGhpcy5fbG9nc1t4XS5vYmplY3RzKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2xvZ3NbeF0ub2JqZWN0czsKICAgICAgfQogICAgfQogIH07CgogIC8qKgogICAqIFJlbW92ZSBhbGwgZXhjZXB0aW9uIHN0YWNrIHRyYWNlcyBmcm9tIHRoZSBsb2cgZW50cmllcy4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLmNsZWFyRXhjZXB0aW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgIGZvciAodmFyIHggPSAwOyB4IDwgdGhpcy5fbG9ncy5sZW5ndGg7IHgrKykgewogICAgICBpZiAodGhpcy5fbG9nc1t4XS5leGNlcHRpb24pIHsKICAgICAgICBkZWxldGUgdGhpcy5fbG9nc1t4XS5leGNlcHRpb247CiAgICAgIH0KICAgIH0KICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnRyYWNlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLlRSQUNFLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmRlYnVnID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLkRFQlVHLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuSU5GTywgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5sb2cgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuTE9HLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnRlc3QgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuVEVTVCwgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS53YXJuID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLldBUk4sIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuZXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuRVJST1IsIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuY3JpdGljYWwgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuRVJST1IsIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIC8qKgogICAqIENyZWF0ZSBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgbG9nZ2VyIGNvbnRlbnRzLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbGluZXMgPSBbXTsKICAgIGZvciAodmFyIHggPSAwOyB4IDwgdGhpcy5fbG9ncy5sZW5ndGg7IHgrKykgewogICAgICBsaW5lcy5wdXNoKHRoaXMuX2xvZ3NbeF0udG9TdHJpbmcoKSk7CiAgICB9CgogICAgcmV0dXJuIGxpbmVzLmpvaW4oIlxuIik7CiAgfTsKICAKICAvKioKICAgKiBEb3dubG9hZC9BcmNoaXZlIGxvZ3MgdG8gYSBmaWxlLCAKICAgKiBCeSBkZWZhdWx0LCBpdCByZXR1cm5zIGFsbCBsb2dzLgogICAqIFRvIGZpbHRlciBsb2dzIGJ5IHRoZSBtaW5pbXVtIGxvZyBsZXZlbCBzZXQgYnkgc2V0TG9nTGV2ZWwgb3IgdGhlIGRlZmF1bHQgc2V0IGluIF9sb2dMZXZlbCwgCiAgICogcGFzcyBpbiBmaWx0ZXJCeUxvZ0xldmVsIHRvIHRydWUgaW4gb3B0aW9ucwogICAqIAogICAqIEBwYXJhbSBvcHRpb25zIGRvd25sb2FkIG9wdGlvbnMgW09iamVjdHxTdHJpbmddLiAKICAgKiAtIG9mIHR5cGUgT2JqZWN0OiAKICAgKiAgIHsgbG9nTmFtZTogJ215LWxvZy1uYW1lJywKICAgKiAgICAgZmlsdGVyQnlMb2dMZXZlbDogZmFsc2UsIC8vZG93bmxvYWQgYWxsIGxvZ3MKICAgKiAgIH0KICAgKiAtIG9mIHR5cGUgU3RyaW5nIChmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSksIHRoZSBmaWxlJ3MgbmFtZQogICAqLwogIExvZ2dlci5wcm90b3R5cGUuZG93bmxvYWQgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgbG9nTmFtZSA9ICdhZ2VudC1sb2cnOwogICAgdmFyIGZpbHRlckJ5TG9nTGV2ZWwgPSBmYWxzZTsKCiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdvYmplY3QnKSB7CiAgICAgIGxvZ05hbWUgPSBvcHRpb25zLmxvZ05hbWUgfHwgbG9nTmFtZTsKICAgICAgZmlsdGVyQnlMb2dMZXZlbCA9IG9wdGlvbnMuZmlsdGVyQnlMb2dMZXZlbCB8fCBmaWx0ZXJCeUxvZ0xldmVsOwogICAgfQogICAgZWxzZSBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7CiAgICAgIGxvZ05hbWUgPSBvcHRpb25zIHx8IGxvZ05hbWU7IAogICAgfQoKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBsb2dzID0gdGhpcy5fcm9sbGVkTG9ncy5jb25jYXQodGhpcy5fbG9ncyk7CiAgICBpZiAoZmlsdGVyQnlMb2dMZXZlbCkgewogICAgICBsb2dzID0gbG9ncy5maWx0ZXIoZnVuY3Rpb24oZW50cnkpIHsKICAgICAgICByZXR1cm4gTG9nTGV2ZWxPcmRlcltlbnRyeS5sZXZlbF0gPj0gc2VsZi5fbG9nTGV2ZWw7CiAgICAgIH0pOwogICAgfQoKICAgIHZhciBsb2dCbG9iID0gbmV3IGdsb2JhbC5CbG9iKFtKU09OLnN0cmluZ2lmeShsb2dzLCB1bmRlZmluZWQsIDQpXSwgWyd0ZXh0L3BsYWluJ10pOwogICAgdmFyIGRvd25sb2FkTGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgIHZhciBsb2dOYW1lID0gbG9nTmFtZSB8fCAnYWdlbnQtbG9nJzsKICAgIGRvd25sb2FkTGluay5ocmVmID0gZ2xvYmFsLlVSTC5jcmVhdGVPYmplY3RVUkwobG9nQmxvYik7CiAgICBkb3dubG9hZExpbmsuZG93bmxvYWQgPSBsb2dOYW1lICsgJy50eHQnOwogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChkb3dubG9hZExpbmspOwogICAgZG93bmxvYWRMaW5rLmNsaWNrKCk7CiAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGRvd25sb2FkTGluayk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5zY2hlZHVsZVVwc3RyZWFtTG9nUHVzaCA9IGZ1bmN0aW9uIChjb25kdWl0KSB7CiAgICBpZiAoIWNvbm5lY3QudXBzdHJlYW1Mb2dQdXNoU2NoZWR1bGVkKSB7CiAgICAgIGNvbm5lY3QudXBzdHJlYW1Mb2dQdXNoU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgLyoqIFNjaGVkdWxlIHB1c2hpbmcgbG9ncyBmcmVxdWVudGx5IHRvIHNoYXJlZHdvcmtlciB1cHN0cmVhbSwgc2hhcmVkd29ya2VyIHdpbGwgcmVwb3J0IHRvIExBUlMqLwogICAgICBnbG9iYWwuc2V0SW50ZXJ2YWwoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnJlcG9ydE1hc3RlckxvZ3NVcFN0cmVhbSwgY29uZHVpdCksIExPR19SRVBPUlRfSU5URVJWQUxfTUlMTElTKTsKICAgIH0KICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnJlcG9ydE1hc3RlckxvZ3NVcFN0cmVhbSA9IGZ1bmN0aW9uIChjb25kdWl0KSB7CiAgICB2YXIgbG9nc1RvUHVzaCA9IHRoaXMuX2xvZ3NUb1B1c2guc2xpY2UoKTsKICAgIHRoaXMuX2xvZ3NUb1B1c2ggPSBbXTsKICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU0VORF9MT0dTLCBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChsb2dzVG9QdXNoLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TRU5EX0xPR1MsIGxvZ3NUb1B1c2gpOwogICAgICB9CiAgICB9KTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmdldExvZ2dlcklkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2xvZ2dlcklkOwogIH07CgogIHZhciBEb3duc3RyZWFtQ29uZHVpdExvZ2dlciA9IGZ1bmN0aW9uIChjb25kdWl0KSB7CiAgICBMb2dnZXIuY2FsbCh0aGlzKTsKICAgIHRoaXMuY29uZHVpdCA9IGNvbmR1aXQ7CiAgICBnbG9iYWwuc2V0SW50ZXJ2YWwoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLl9wdXNoTG9nc0Rvd25zdHJlYW0pLAogICAgICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5MT0dfUFVTSF9JTlRFUlZBTCk7CgogICAgLy8gRGlzYWJsZSBsb2cgcm9sbGluZywgd2Ugd2lsbCBwdXJnZSBvdXIgb3duIGxvZ3Mgb25jZSB0aGV5IGhhdmUKICAgIC8vIGJlZW4gcHVzaGVkIGRvd25zdHJlYW0uCiAgICBnbG9iYWwuY2xlYXJJbnRlcnZhbCh0aGlzLl9sb2dSb2xsVGltZXIpOwogICAgdGhpcy5fbG9nUm9sbFRpbWVyID0gbnVsbDsKICB9OwogIC8vIEhvdyBmcmVxdWVudGx5IGxvZ3Mgc2hvdWxkIGJlIGNvbGxlY3RlZCBhbmQgZGVsaXZlcmVkIGRvd25zdHJlYW0uCiAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIuTE9HX1BVU0hfSU5URVJWQUwgPSAxMDAwOwogIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoTG9nZ2VyLnByb3RvdHlwZSk7CiAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRG93bnN0cmVhbUNvbmR1aXRMb2dnZXI7CgogIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLnByb3RvdHlwZS5wdXNoTG9nc0Rvd25zdHJlYW0gPSBmdW5jdGlvbiAobG9ncykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgbG9ncy5mb3JFYWNoKGZ1bmN0aW9uIChsb2cpIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgbG9nKTsKICAgIH0pOwogIH07CgogIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLnByb3RvdHlwZS5fcHVzaExvZ3NEb3duc3RyZWFtID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdGhpcy5fbG9ncy5mb3JFYWNoKGZ1bmN0aW9uIChsb2cpIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgbG9nKTsKICAgIH0pOwogICAgdGhpcy5fbG9ncyA9IFtdOwogIH07CgogIC8qKiBDcmVhdGUgdGhlIHNpbmdsZXRvbiBsb2dnZXIgaW5zdGFuY2UuICovCiAgY29ubmVjdC5yb290TG9nZ2VyID0gbmV3IExvZ2dlcigpOwoKICAvKiogRmV0Y2ggdGhlIHNpbmdsZXRvbiBsb2dnZXIgaW5zdGFuY2UuICovCiAgdmFyIGdldExvZyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LnJvb3RMb2dnZXI7CiAgfTsKCiAgY29ubmVjdCA9IGNvbm5lY3QgfHwge307CiAgY29ubmVjdC5nZXRMb2cgPSBnZXRMb2c7CiAgY29ubmVjdC5Mb2dFbnRyeSA9IExvZ0VudHJ5OwogIGNvbm5lY3QuTG9nZ2VyID0gTG9nZ2VyOwogIGNvbm5lY3QuTG9nTGV2ZWwgPSBMb2dMZXZlbDsKICBjb25uZWN0LkxvZ0NvbXBvbmVudCA9IExvZ0NvbXBvbmVudDsKICBjb25uZWN0LkRvd25zdHJlYW1Db25kdWl0TG9nZ2VyID0gRG93bnN0cmVhbUNvbmR1aXRMb2dnZXI7Cn0pKCk7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICB2YXIgdXNlckFnZW50ID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKICB2YXIgT05FX0RBWV9NSUxMSVMgPSAyNCAqIDYwICogNjAgKiAxMDAwOwoKICAvKioKICAgKiBVbnBvbGx1dGUgc3ByaW50ZiBmdW5jdGlvbnMgZnJvbSB0aGUgZ2xvYmFsIG5hbWVzcGFjZS4KICAgKi8KICBjb25uZWN0LnNwcmludGYgPSBnbG9iYWwuc3ByaW50ZjsKICBjb25uZWN0LnZzcHJpbnRmID0gZ2xvYmFsLnZzcHJpbnRmOwogIGRlbGV0ZSBnbG9iYWwuc3ByaW50ZjsKICBkZWxldGUgZ2xvYmFsLnZzcHJpbnRmOwoKICBjb25uZWN0LkhUVFBfU1RBVFVTX0NPREVTID0gewogICAgU1VDQ0VTUzogMjAwLAogICAgVE9PX01BTllfUkVRVUVTVFM6IDQyOSwKICAgIElOVEVSTkFMX1NFUlZFUl9FUlJPUjogNTAwCiAgfTsKCiAgY29ubmVjdC5UUkFOU1BPUlRfVFlQRVMgPSB7CiAgICBDSEFUX1RPS0VOOiAiY2hhdF90b2tlbiIsCiAgICBXRUJfU09DS0VUOiAid2ViX3NvY2tldCIKICB9OwoKICAvKioKICAgKiBCaW5kcyB0aGUgZ2l2ZW4gaW5zdGFuY2Ugb2JqZWN0IGFzIHRoZSBjb250ZXh0IGZvcgogICAqIHRoZSBtZXRob2QgcHJvdmlkZWQuCiAgICoKICAgKiBAcGFyYW0gc2NvcGUgVGhlIGluc3RhbmNlIG9iamVjdCB0byBiZSBzZXQgYXMgdGhlIHNjb3BlCiAgICogICAgb2YgdGhlIGZ1bmN0aW9uLgogICAqIEBwYXJhbSBtZXRob2QgVGhlIG1ldGhvZCB0byBiZSBlbmNhcHN1bGF0ZWQuCiAgICoKICAgKiBBbGwgb3RoZXIgYXJndW1lbnRzLCBpZiBhbnksIGFyZSBib3VuZCB0byB0aGUgbWV0aG9kCiAgICogaW52b2NhdGlvbiBpbnNpZGUgdGhlIGNsb3N1cmUuCiAgICoKICAgKiBAcmV0dXJuIEEgY2xvc3VyZSBlbmNhcHN1bGF0aW5nIHRoZSBpbnZvY2F0aW9uIG9mIHRoZQogICAqICAgIG1ldGhvZCBwcm92aWRlZCBpbiBjb250ZXh0IG9mIHRoZSBnaXZlbiBpbnN0YW5jZS4KICAgKi8KICBjb25uZWN0LmhpdGNoID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgdmFyIHNjb3BlID0gYXJncy5zaGlmdCgpOwogICAgdmFyIG1ldGhvZCA9IGFyZ3Muc2hpZnQoKTsKCiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoc2NvcGUsICdzY29wZScpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKG1ldGhvZCwgJ21ldGhvZCcpOwogICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihtZXRob2QpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwoKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBjbG9zdXJlQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBtZXRob2QuYXBwbHkoc2NvcGUsIGFyZ3MuY29uY2F0KGNsb3N1cmVBcmdzKSk7CiAgICB9OwogIH07CgogIC8qKgogICAqIERldGVybWluZSBpZiB0aGUgZ2l2ZW4gdmFsdWUgaXMgYSBjYWxsYWJsZSBmdW5jdGlvbiB0eXBlLgogICAqIEJvcnJvd2VkIGZyb20gVW5kZXJzY29yZS5qcy4KICAgKi8KICBjb25uZWN0LmlzRnVuY3Rpb24gPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gISEob2JqICYmIG9iai5jb25zdHJ1Y3RvciAmJiBvYmouY2FsbCAmJiBvYmouYXBwbHkpOwogIH07CgogIC8qKgogICAqIERldGVybWluZSBpZiB0aGUgZ2l2ZW4gdmFsdWUgaXMgYW4gYXJyYXkuCiAgICovCiAgY29ubmVjdC5pc0FycmF5ID0gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCBBcnJheV0nOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2Yga2V5cyBmcm9tIGEgSmF2YXNjcmlwdCBvYmplY3QgdXNlZAogICAqIGFzIGEgaGFzaCBtYXAuCiAgICovCiAgY29ubmVjdC5rZXlzID0gZnVuY3Rpb24gKG1hcCkgewogICAgdmFyIGtleXMgPSBbXTsKCiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwobWFwLCAnbWFwJyk7CgogICAgZm9yICh2YXIgayBpbiBtYXApIHsKICAgICAga2V5cy5wdXNoKGspOwogICAgfQoKICAgIHJldHVybiBrZXlzOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2YgdmFsdWVzIGZyb20gYSBKYXZhc2NyaXB0IG9iamVjdCB1c2VkCiAgICogYXMgYSBoYXNoIG1hcC4KICAgKi8KICBjb25uZWN0LnZhbHVlcyA9IGZ1bmN0aW9uIChtYXApIHsKICAgIHZhciB2YWx1ZXMgPSBbXTsKCiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwobWFwLCAnbWFwJyk7CgogICAgZm9yICh2YXIgayBpbiBtYXApIHsKICAgICAgdmFsdWVzLnB1c2gobWFwW2tdKTsKICAgIH0KCiAgICByZXR1cm4gdmFsdWVzOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2Yga2V5L3ZhbHVlIHBhaXJzIGZyb20gdGhlIGdpdmVuIG1hcC4KICAgKi8KICBjb25uZWN0LmVudHJpZXMgPSBmdW5jdGlvbiAobWFwKSB7CiAgICB2YXIgZW50cmllcyA9IFtdOwoKICAgIGZvciAodmFyIGsgaW4gbWFwKSB7CiAgICAgIGVudHJpZXMucHVzaCh7IGtleTogaywgdmFsdWU6IG1hcFtrXSB9KTsKICAgIH0KCiAgICByZXR1cm4gZW50cmllczsKICB9OwoKICAvKioKICAgKiBNZXJnZSB0d28gb3IgbW9yZSBtYXBzIHRvZ2V0aGVyIGludG8gYSBuZXcgbWFwLAogICAqIG9yIHNpbXBseSBjb3B5IGEgc2luZ2xlIG1hcC4KICAgKi8KICBjb25uZWN0Lm1lcmdlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ01hcHMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgdmFyIHJlc3VsdE1hcCA9IHt9OwoKICAgIGFyZ01hcHMuZm9yRWFjaChmdW5jdGlvbiAobWFwKSB7CiAgICAgIGNvbm5lY3QuZW50cmllcyhtYXApLmZvckVhY2goZnVuY3Rpb24gKGt2KSB7CiAgICAgICAgcmVzdWx0TWFwW2t2LmtleV0gPSBrdi52YWx1ZTsKICAgICAgfSk7CiAgICB9KTsKCiAgICByZXR1cm4gcmVzdWx0TWFwOwogIH07CgogIGNvbm5lY3Qubm93ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogIH07CgogIGNvbm5lY3QuZmluZCA9IGZ1bmN0aW9uIChhcnJheSwgcHJlZGljYXRlKSB7CiAgICBmb3IgKHZhciB4ID0gMDsgeCA8IGFycmF5Lmxlbmd0aDsgeCsrKSB7CiAgICAgIGlmIChwcmVkaWNhdGUoYXJyYXlbeF0pKSB7CiAgICAgICAgcmV0dXJuIGFycmF5W3hdOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG51bGw7CiAgfTsKCiAgY29ubmVjdC5jb250YWlucyA9IGZ1bmN0aW9uIChvYmosIHZhbHVlKSB7CiAgICBpZiAob2JqIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgcmV0dXJuIGNvbm5lY3QuZmluZChvYmosIGZ1bmN0aW9uICh2KSB7IHJldHVybiB2ID09PSB2YWx1ZTsgfSkgIT0gbnVsbDsKCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gKHZhbHVlIGluIG9iaik7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5jb250YWluc1ZhbHVlID0gZnVuY3Rpb24gKG9iaiwgdmFsdWUpIHsKICAgIGlmIChvYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICByZXR1cm4gY29ubmVjdC5maW5kKG9iaiwgZnVuY3Rpb24gKHYpIHsgcmV0dXJuIHYgPT09IHZhbHVlOyB9KSAhPSBudWxsOwoKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBjb25uZWN0LmZpbmQoY29ubmVjdC52YWx1ZXMob2JqKSwgZnVuY3Rpb24gKHYpIHsgcmV0dXJuIHYgPT09IHZhbHVlOyB9KSAhPSBudWxsOwogICAgfQogIH07CgogIC8qKgogICAqIEdlbmVyYXRlIGEgcmFuZG9tIElEIGNvbnNpc3Rpbmcgb2YgdGhlIGN1cnJlbnQgdGltZXN0YW1wCiAgICogYW5kIGEgcmFuZG9tIGJhc2UtMzYgbnVtYmVyIGJhc2VkIG9uIE1hdGgucmFuZG9tKCkuCiAgICovCiAgY29ubmVjdC5yYW5kb21JZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LnNwcmludGYoIiVzLSVzIiwgY29ubmVjdC5ub3coKSwgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMikpOwogIH07CgogIC8qKgogICAqIEdlbmVyYXRlIGFuIGVudW0gZnJvbSB0aGUgZ2l2ZW4gbGlzdCBvZiBsb3dlci1jYXNlIGVudW0gdmFsdWVzLAogICAqIHdoZXJlIHRoZSBlbnVtIGtleXMgd2lsbCBiZSB1cHBlciBjYXNlLgogICAqCiAgICogQ29udmVyc2lvbiBmcm9tIHBhc2NhbCBjYXNlIGJhc2VkIG9uIGNvZGUgZnJvbSBoZXJlOgogICAqIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzA1MjEyMjQKICAgKi8KICBjb25uZWN0Lm1ha2VFbnVtID0gZnVuY3Rpb24gKHZhbHVlcykgewogICAgdmFyIGVudW1PYmogPSB7fTsKCiAgICB2YWx1ZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgdmFyIGtleSA9IHZhbHVlLnJlcGxhY2UoL1wuPyhbYS16XSspXz8vZywgZnVuY3Rpb24gKHgsIHkpIHsgcmV0dXJuIHkudG9VcHBlckNhc2UoKSArICJfIjsgfSkKICAgICAgICAucmVwbGFjZSgvXyQvLCAiIik7CgogICAgICBlbnVtT2JqW2tleV0gPSB2YWx1ZTsKICAgIH0pOwoKICAgIHJldHVybiBlbnVtT2JqOwogIH07CgogIGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtID0gZnVuY3Rpb24gKHByZWZpeCwgdmFsdWVzKSB7CiAgICB2YXIgZW51bU9iaiA9IGNvbm5lY3QubWFrZUVudW0odmFsdWVzKTsKICAgIGNvbm5lY3Qua2V5cyhlbnVtT2JqKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgZW51bU9ialtrZXldID0gY29ubmVjdC5zcHJpbnRmKCIlczo6JXMiLCBwcmVmaXgsIGVudW1PYmpba2V5XSk7CiAgICB9KTsKICAgIHJldHVybiBlbnVtT2JqOwogIH07CgogIC8qKgogICogTWV0aG9kcyB0byBkZXRlcm1pbmUgYnJvd3NlciB0eXBlIGFuZCB2ZXJzaW9ucywgdXNlZCBmb3Igc29mdHBob25lIGluaXRpYWxpemF0aW9uLgogICovCiAgY29ubmVjdC5pc0Nocm9tZUJyb3dzZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdXNlckFnZW50LmluZGV4T2YoIkNocm9tZSIpICE9PSAtMTsKICB9OwoKICBjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdXNlckFnZW50LmluZGV4T2YoIkZpcmVmb3giKSAhPT0gLTE7CiAgfTsKCiAgY29ubmVjdC5pc09wZXJhQnJvd3NlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB1c2VyQWdlbnQuaW5kZXhPZigiT3BlcmEiKSAhPT0gLTE7CiAgfTsKCiAgY29ubmVjdC5nZXRDaHJvbWVCcm93c2VyVmVyc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBjaHJvbWVWZXJzaW9uID0gdXNlckFnZW50LnN1YnN0cmluZyh1c2VyQWdlbnQuaW5kZXhPZigiQ2hyb21lIikgKyA3KTsKICAgIGlmIChjaHJvbWVWZXJzaW9uKSB7CiAgICAgIHJldHVybiBwYXJzZUZsb2F0KGNocm9tZVZlcnNpb24pOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIC0xOwogICAgfQogIH07CgogIGNvbm5lY3QuZ2V0RmlyZWZveEJyb3dzZXJWZXJzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGZpcmVmb3hWZXJzaW9uID0gdXNlckFnZW50LnN1YnN0cmluZyh1c2VyQWdlbnQuaW5kZXhPZigiRmlyZWZveCIpICsgOCk7CiAgICBpZiAoZmlyZWZveFZlcnNpb24pIHsKICAgICAgcmV0dXJuIHBhcnNlRmxvYXQoZmlyZWZveFZlcnNpb24pOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIC0xOwogICAgfQogIH07CgogIGNvbm5lY3QuZ2V0T3BlcmFCcm93c2VyVmVyc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciB2ZXJzaW9uT2Zmc2V0ID0gdXNlckFnZW50LmluZGV4T2YoIk9wZXJhIik7CiAgICB2YXIgb3BlcmFWZXJzaW9uID0gKHVzZXJBZ2VudC5pbmRleE9mKCJWZXJzaW9uIikgIT09IC0xKSA/IHVzZXJBZ2VudC5zdWJzdHJpbmcodmVyc2lvbk9mZnNldCArIDgpIDogdXNlckFnZW50LnN1YnN0cmluZyh2ZXJzaW9uT2Zmc2V0ICsgNik7CiAgICBpZiAob3BlcmFWZXJzaW9uKSB7CiAgICAgIHJldHVybiBwYXJzZUZsb2F0KG9wZXJhVmVyc2lvbik7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gLTE7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogUmV0dXJuIGEgbWFwIG9mIGl0ZW1zIGluIHRoZSBnaXZlbiBsaXN0IGluZGV4ZWQgYnkKICAgKiBrZXlzIGRldGVybWluZWQgYnkgdGhlIGNsb3N1cmUgcHJvdmlkZWQuCiAgICoKICAgKiBAcGFyYW0gaXRlcmFibGUgQSBsaXN0LWxpa2Ugb2JqZWN0LgogICAqIEBwYXJhbSBjbG9zdXJlIEEgY2xvc3VyZSB0byBkZXRlcm1pbmUgdGhlIGluZGV4IGZvciB0aGUKICAgKiAgICBpdGVtcyBpbiB0aGUgaXRlcmFibGUuCiAgICogQHJldHVybiBBIG1hcCBmcm9tIGluZGV4IHRvIGl0ZW0gZm9yIGVhY2ggaXRlbSBpbiB0aGUgaXRlcmFibGUuCiAgICovCiAgY29ubmVjdC5pbmRleCA9IGZ1bmN0aW9uIChpdGVyYWJsZSwgY2xvc3VyZSkgewogICAgdmFyIG1hcCA9IHt9OwoKICAgIGl0ZXJhYmxlLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgbWFwW2Nsb3N1cmUoaXRlbSldID0gaXRlbTsKICAgIH0pOwoKICAgIHJldHVybiBtYXA7CiAgfTsKCiAgLyoqCiAgICogQ29udmVydHMgdGhlIGdpdmVuIGFycmF5IGludG8gYSBtYXAgYXMgYSBzZXQsCiAgICogd2hlcmUgZWxlbWVudHMgaW4gdGhlIGFycmF5IGFyZSBtYXBwZWQgdG8gMS4KICAgKi8KICBjb25uZWN0LnNldCA9IGZ1bmN0aW9uIChhcnJheUluKSB7CiAgICB2YXIgc2V0TWFwID0ge307CgogICAgYXJyYXlJbi5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgc2V0TWFwW2tleV0gPSAxOwogICAgfSk7CgogICAgcmV0dXJuIHNldE1hcDsKICB9OwoKICAvKioKICAgKiBSZXR1cm5zIGEgbWFwIGZvciBlYWNoIGtleSBpbiBtYXBCIHdoaWNoCiAgICogaXMgTk9UIGluIG1hcEEuCiAgICovCiAgY29ubmVjdC5yZWxhdGl2ZUNvbXBsZW1lbnQgPSBmdW5jdGlvbiAobWFwQSwgbWFwQikgewogICAgdmFyIGNvbXBNYXAgPSB7fTsKCiAgICBjb25uZWN0LmtleXMobWFwQikuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIGlmICghKGtleSBpbiBtYXBBKSkgewogICAgICAgIGNvbXBNYXBba2V5XSA9IG1hcEJba2V5XTsKICAgICAgfQogICAgfSk7CgogICAgcmV0dXJuIGNvbXBNYXA7CiAgfTsKCiAgLyoqCiAgICogQXNzZXJ0cyB0aGF0IGEgcHJlbWlzZSBpcyB0cnVlLgogICAqLwogIGNvbm5lY3QuYXNzZXJ0VHJ1ZSA9IGZ1bmN0aW9uIChwcmVtaXNlLCBtZXNzYWdlKSB7CiAgICBpZiAoIXByZW1pc2UpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuVmFsdWVFcnJvcihtZXNzYWdlKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBBc3NlcnRzIHRoYXQgYSB2YWx1ZSBpcyBub3QgbnVsbCBvciB1bmRlZmluZWQuCiAgICovCiAgY29ubmVjdC5hc3NlcnROb3ROdWxsID0gZnVuY3Rpb24gKHZhbHVlLCBuYW1lKSB7CiAgICBjb25uZWN0LmFzc2VydFRydWUodmFsdWUgIT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgIT09IHVuZGVmaW5lZCwKICAgICAgY29ubmVjdC5zcHJpbnRmKCIlcyBtdXN0IGJlIHByb3ZpZGVkIiwgbmFtZSB8fCAnQSB2YWx1ZScpKTsKICAgIHJldHVybiB2YWx1ZTsKICB9OwoKICBjb25uZWN0LmRlZXBjb3B5ID0gZnVuY3Rpb24gKHNyYykgewogICAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoc3JjKSk7CiAgfTsKCiAgLyoqCiAgICogR2V0IHRoZSBjdXJyZW50IGJhc2UgdXJsIG9mIHRoZSBvcGVuIHBhZ2UsIGUuZy4gaWYgdGhlIHBhZ2UgaXMKICAgKiBodHRwczovL2V4YW1wbGUuY29tOjk0OTQvb3JhbmdlcywgdGhpcyB3aWxsIGJlICJodHRwczovL2V4YW1wbGUuY29tOjk0OTQiLgogICAqLwogIGNvbm5lY3QuZ2V0QmFzZVVybCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2NhdGlvbiA9IGdsb2JhbC5sb2NhdGlvbjsKICAgIHJldHVybiBjb25uZWN0LnNwcmludGYoIiVzLy8lczolcyIsIGxvY2F0aW9uLnByb3RvY29sLCBsb2NhdGlvbi5ob3N0bmFtZSwgbG9jYXRpb24ucG9ydCk7CiAgfTsKCiAgLyoqCiAgICogRGV0ZXJtaW5lIGlmIHRoZSBjdXJyZW50IHdpbmRvdyBpcyBpbiBhbiBpZnJhbWUuCiAgICogQ291cnRlc3k6IGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzI2MDY5LwogICAqLwogIGNvbm5lY3QuaXNGcmFtZWQgPSBmdW5jdGlvbiAoKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gd2luZG93LnNlbGYgIT09IHdpbmRvdy50b3A7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH07CgogIGNvbm5lY3QuZmV0Y2ggPSBmdW5jdGlvbiAoZW5kcG9pbnQsIG9wdGlvbnMsIG1pbGxpSW50ZXJ2YWwsIG1heFJldHJ5KSB7CiAgICBtYXhSZXRyeSA9IG1heFJldHJ5IHx8IDU7CiAgICBtaWxsaUludGVydmFsID0gbWlsbGlJbnRlcnZhbCB8fCAxMDAwOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBmdW5jdGlvbiBmZXRjaERhdGEobWF4UmV0cnkpIHsKICAgICAgICBmZXRjaChlbmRwb2ludCwgb3B0aW9ucykudGhlbihmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgICBpZiAocmVzLnN0YXR1cyA9PT0gY29ubmVjdC5IVFRQX1NUQVRVU19DT0RFUy5TVUNDRVNTKSB7CiAgICAgICAgICAgIHJlc29sdmUocmVzLmpzb24oKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKG1heFJldHJ5ICE9PSAxICYmIChyZXMuc3RhdHVzID49IGNvbm5lY3QuSFRUUF9TVEFUVVNfQ09ERVMuSU5URVJOQUxfU0VSVkVSX0VSUk9SIHx8IHJlcy5zdGF0dXMgPT09IGNvbm5lY3QuSFRUUF9TVEFUVVNfQ09ERVMuVE9PX01BTllfUkVRVUVTVFMpKSB7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGZldGNoRGF0YSgtLW1heFJldHJ5KTsKICAgICAgICAgICAgfSwgbWlsbGlJbnRlcnZhbCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZWplY3QocmVzKTsKICAgICAgICAgIH0KICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICAgICAgcmVqZWN0KGUpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGZldGNoRGF0YShtYXhSZXRyeSk7CiAgICB9KTsKICB9OwoKICAvKioKICAgKiBDYWxsaW5nIGEgZnVuY3Rpb24gd2l0aCBleHBvbmVudGlhbCBiYWNrb2ZmIHdpdGggZnVsbCBqaXR0ZXIgcmV0cnkgc3RyYXRlZ3kKICAgKiBJdCB3aWxsIHJldHJ5IGNhbGxpbmcgdGhlIGZ1bmN0aW9uIGZvciBtYXhpbXVtIG1heFJldHJ5IHRpbWVzIGlmIGl0IGZhaWxzLgogICAqIFN1Y2Nlc3MgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIGZ1bmN0aW9uIHN1Y2NlZWRlZC4KICAgKiBGYWlsdXJlIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIG9ubHkgaWYgdGhlIGxhc3QgdHJ5IGZhaWxlZC4KICAgKi8KICBjb25uZWN0LmJhY2tvZmYgPSBmdW5jdGlvbiAoZnVuYywgbWlsbGlJbnRlcnZhbCwgbWF4UmV0cnksIGNhbGxiYWNrcykgewogICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmdW5jKSwgImZ1bmMgbXVzdCBiZSBhIEZ1bmN0aW9uIik7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcmF0aW8gPSAyOwoKICAgIGZ1bmMoewogICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGlmIChjYWxsYmFja3MgJiYgY2FsbGJhY2tzLnN1Y2Nlc3MpIHsKICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIGlmIChtYXhSZXRyeSA+IDApIHsKICAgICAgICAgIHZhciBpbnRlcnZhbCA9IG1pbGxpSW50ZXJ2YWwgKiAyICogTWF0aC5yYW5kb20oKTsKICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2VsZi5iYWNrb2ZmKGZ1bmMsIGludGVydmFsICogcmF0aW8sIC0tbWF4UmV0cnksIGNhbGxiYWNrcyk7CiAgICAgICAgICB9LCBpbnRlcnZhbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChjYWxsYmFja3MgJiYgY2FsbGJhY2tzLmZhaWx1cmUpIHsKICAgICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZXJyLCBkYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH07CgogIGNvbm5lY3QucHVibGlzaE1ldHJpYyA9IGZ1bmN0aW9uIChtZXRyaWNEYXRhKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5DTElFTlRfTUVUUklDLCBtZXRyaWNEYXRhKTsKICB9OwoKICBjb25uZWN0LnB1Ymxpc2hTb2Z0cGhvbmVTdGF0cyA9IGZ1bmN0aW9uKHN0YXRzKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5TT0ZUUEhPTkVfU1RBVFMsIHN0YXRzKTsKICB9OwoKICBjb25uZWN0LnB1Ymxpc2hTb2Z0cGhvbmVSZXBvcnQgPSBmdW5jdGlvbihyZXBvcnQpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLlNPRlRQSE9ORV9SRVBPUlQsIHJlcG9ydCk7CiAgfTsKCiAgLyoqCiAgICogQSB3cmFwcGVyIGFyb3VuZCBXaW5kb3cub3BlbigpIGZvciBtYW5hZ2luZyBzaW5nbGUgaW5zdGFuY2UgcG9wdXBzLgogICAqLwogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyID0gZnVuY3Rpb24gKCkgeyB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUub3BlbiA9IGZ1bmN0aW9uKHVybCwgbmFtZSkgewogICAgdmFyIHRoZW4gPSB0aGlzLl9nZXRMYXN0T3BlbmVkVGltZXN0YW1wKG5hbWUpOwogICAgdmFyIG5vdyA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgdmFyIHdpbiA9IG51bGw7ICAgICAgCiAgICBpZiAobm93IC0gdGhlbiA+IE9ORV9EQVlfTUlMTElTKSB7CiAgICAgICB3aW4gPSB3aW5kb3cub3BlbignJywgbmFtZSk7CiAgICAgICBpZiAod2luLmxvY2F0aW9uICE9PSB1cmwpIHsKICAgICAgICAgIHdpbiA9IHdpbmRvdy5vcGVuKHVybCwgbmFtZSk7CiAgICAgICB9CiAgICAgICB0aGlzLl9zZXRMYXN0T3BlbmVkVGltZXN0YW1wKG5hbWUsIG5vdyk7CiAgICB9CiAgICByZXR1cm4gd2luOwogfTsKCiAgY29ubmVjdC5Qb3B1cE1hbmFnZXIucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgIHZhciBrZXkgPSB0aGlzLl9nZXRMb2NhbFN0b3JhZ2VLZXkobmFtZSk7CiAgICBnbG9iYWwubG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oa2V5KTsKICB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUuX2dldExhc3RPcGVuZWRUaW1lc3RhbXAgPSBmdW5jdGlvbiAobmFtZSkgewogICAgdmFyIGtleSA9IHRoaXMuX2dldExvY2FsU3RvcmFnZUtleShuYW1lKTsKICAgIHZhciB2YWx1ZSA9IGdsb2JhbC5sb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXkpOwoKICAgIGlmICh2YWx1ZSkgewogICAgICByZXR1cm4gcGFyc2VJbnQodmFsdWUsIDEwKTsKCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gMDsKICAgIH0KICB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUuX3NldExhc3RPcGVuZWRUaW1lc3RhbXAgPSBmdW5jdGlvbiAobmFtZSwgdHMpIHsKICAgIHZhciBrZXkgPSB0aGlzLl9nZXRMb2NhbFN0b3JhZ2VLZXkobmFtZSk7CiAgICBnbG9iYWwubG9jYWxTdG9yYWdlLnNldEl0ZW0oa2V5LCAnJyArIHRzKTsKICB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUuX2dldExvY2FsU3RvcmFnZUtleSA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICByZXR1cm4gImNvbm5lY3RQb3B1cE1hbmFnZXI6OiIgKyBuYW1lOwogIH07CgogIC8qKgogICAqIEFuIGVudW1lcmF0aW9uIG9mIHRoZSBIVE1MNSBub3RpZmljYXRpb24gcGVybWlzc2lvbiB2YWx1ZXMuCiAgICovCiAgdmFyIE5vdGlmaWNhdGlvblBlcm1pc3Npb24gPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdncmFudGVkJywKICAgICdkZW5pZWQnLAogICAgJ2RlZmF1bHQnCiAgXSk7CgogIC8qKgogICAqIEEgc2ltcGxlIGVuZ2luZSBmb3Igc2hvd2luZyBub3RpZmljYXRpb24gcG9wdXBzLgogICAqLwogIGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlciA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMucXVldWUgPSBbXTsKICAgIHRoaXMucGVybWlzc2lvbiA9IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uREVGQVVMVDsKICB9OwoKICBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIucHJvdG90eXBlLnJlcXVlc3RQZXJtaXNzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYgKCEoIk5vdGlmaWNhdGlvbiIgaW4gZ2xvYmFsKSkgewogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIlRoaXMgYnJvd3NlciBkb2Vzbid0IHN1cHBvcnQgbm90aWZpY2F0aW9ucy4iKTsKICAgICAgdGhpcy5wZXJtaXNzaW9uID0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5ERU5JRUQ7CgogICAgfSBlbHNlIGlmIChnbG9iYWwuTm90aWZpY2F0aW9uLnBlcm1pc3Npb24gPT09IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uREVOSUVEKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiVGhlIHVzZXIgaGFzIHJlcXVlc3RlZCB0byBub3QgcmVjZWl2ZSBub3RpZmljYXRpb25zLiIpOwogICAgICB0aGlzLnBlcm1pc3Npb24gPSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkRFTklFRDsKCiAgICB9IGVsc2UgaWYgKHRoaXMucGVybWlzc2lvbiAhPT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5HUkFOVEVEKSB7CiAgICAgIGdsb2JhbC5Ob3RpZmljYXRpb24ucmVxdWVzdFBlcm1pc3Npb24oKS50aGVuKGZ1bmN0aW9uIChwZXJtaXNzaW9uKSB7CiAgICAgICAgc2VsZi5wZXJtaXNzaW9uID0gcGVybWlzc2lvbjsKICAgICAgICBpZiAocGVybWlzc2lvbiA9PT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5HUkFOVEVEKSB7CiAgICAgICAgICBzZWxmLl9zaG93UXVldWVkKCk7CgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxmLnF1ZXVlID0gW107CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwoKICBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIucHJvdG90eXBlLnNob3cgPSBmdW5jdGlvbiAodGl0bGUsIG9wdGlvbnMpIHsKICAgIGlmICh0aGlzLnBlcm1pc3Npb24gPT09IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uR1JBTlRFRCkgewogICAgICByZXR1cm4gdGhpcy5fc2hvd0ltcGwoeyB0aXRsZTogdGl0bGUsIG9wdGlvbnM6IG9wdGlvbnMgfSk7CgogICAgfSBlbHNlIGlmICh0aGlzLnBlcm1pc3Npb24gPT09IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uREVOSUVEKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiVW5hYmxlIHRvIHNob3cgbm90aWZpY2F0aW9uLiIpLndpdGhPYmplY3QoewogICAgICAgIHRpdGxlOiB0aXRsZSwKICAgICAgICBvcHRpb25zOiBvcHRpb25zCiAgICAgIH0pOwoKICAgIH0gZWxzZSB7CiAgICAgIHZhciBwYXJhbXMgPSB7IHRpdGxlOiB0aXRsZSwgb3B0aW9uczogb3B0aW9ucyB9OwogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIkRlZmVycmluZyBub3RpZmljYXRpb24gdW50aWwgdXNlciBkZWNpZGVzIHRvIGFsbG93IG9yIGRlbnkuIikKICAgICAgICAud2l0aE9iamVjdChwYXJhbXMpOwogICAgICB0aGlzLnF1ZXVlLnB1c2gocGFyYW1zKTsKICAgIH0KICB9OwoKICBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIucHJvdG90eXBlLl9zaG93UXVldWVkID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIG5vdGlmaWNhdGlvbnMgPSB0aGlzLnF1ZXVlLm1hcChmdW5jdGlvbiAocGFyYW1zKSB7CiAgICAgIHJldHVybiBzZWxmLl9zaG93SW1wbChwYXJhbXMpOwogICAgfSk7CiAgICB0aGlzLnF1ZXVlID0gW107CiAgICByZXR1cm4gbm90aWZpY2F0aW9uczsKICB9OwoKICBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIucHJvdG90eXBlLl9zaG93SW1wbCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIHZhciBub3RpZmljYXRpb24gPSBuZXcgZ2xvYmFsLk5vdGlmaWNhdGlvbihwYXJhbXMudGl0bGUsIHBhcmFtcy5vcHRpb25zKTsKICAgIGlmIChwYXJhbXMub3B0aW9ucy5jbGlja2VkKSB7CiAgICAgIG5vdGlmaWNhdGlvbi5vbmNsaWNrID0gZnVuY3Rpb24gKCkgewogICAgICAgIHBhcmFtcy5vcHRpb25zLmNsaWNrZWQuY2FsbChub3RpZmljYXRpb24pOwogICAgICB9OwogICAgfQogICAgcmV0dXJuIG5vdGlmaWNhdGlvbjsKICB9OwoKICBjb25uZWN0LkJhc2VFcnJvciA9IGZ1bmN0aW9uIChmb3JtYXQsIGFyZ3MpIHsKICAgIGdsb2JhbC5FcnJvci5jYWxsKHRoaXMsIGNvbm5lY3QudnNwcmludGYoZm9ybWF0LCBhcmdzKSk7CiAgfTsKICBjb25uZWN0LkJhc2VFcnJvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEVycm9yLnByb3RvdHlwZSk7CiAgY29ubmVjdC5CYXNlRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gY29ubmVjdC5CYXNlRXJyb3I7CgogIGNvbm5lY3QuVmFsdWVFcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgIHZhciBmb3JtYXQgPSBhcmdzLnNoaWZ0KCk7CiAgICBjb25uZWN0LkJhc2VFcnJvci5jYWxsKHRoaXMsIGZvcm1hdCwgYXJncyk7CiAgfTsKICBjb25uZWN0LlZhbHVlRXJyb3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShjb25uZWN0LkJhc2VFcnJvci5wcm90b3R5cGUpOwogIGNvbm5lY3QuVmFsdWVFcnJvci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjb25uZWN0LlZhbHVlRXJyb3I7CgogIGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgIHZhciBmb3JtYXQgPSBhcmdzLnNoaWZ0KCk7CiAgICBjb25uZWN0LkJhc2VFcnJvci5jYWxsKHRoaXMsIGZvcm1hdCwgYXJncyk7CiAgfTsKICBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShjb25uZWN0LkJhc2VFcnJvci5wcm90b3R5cGUpOwogIGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3I7CgogIGNvbm5lY3QuU3RhdGVFcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgIHZhciBmb3JtYXQgPSBhcmdzLnNoaWZ0KCk7CiAgICBjb25uZWN0LkJhc2VFcnJvci5jYWxsKHRoaXMsIGZvcm1hdCwgYXJncyk7CiAgfTsKICBjb25uZWN0LlN0YXRlRXJyb3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShjb25uZWN0LkJhc2VFcnJvci5wcm90b3R5cGUpOwogIGNvbm5lY3QuU3RhdGVFcnJvci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjb25uZWN0LlN0YXRlRXJyb3I7Cgp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwoKICB2YXIgQUxMX0VWRU5UUyA9ICc8PGFsbD4+JzsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBFdmVudFR5cGUKICAgKi8KICB2YXIgRXZlbnRUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnYWNrbm93bGVkZ2UnLAogICAgJ2Fja190aW1lb3V0JywKICAgICdhcGlfcmVxdWVzdCcsCiAgICAnYXBpX3Jlc3BvbnNlJywKICAgICdhdXRoX2ZhaWwnLAogICAgJ2FjY2Vzc19kZW5pZWQnLAogICAgJ2Nsb3NlJywKICAgICdjb25maWd1cmUnLAogICAgJ2xvZycsCiAgICAnbWFzdGVyX3JlcXVlc3QnLAogICAgJ21hc3Rlcl9yZXNwb25zZScsCiAgICAnc3luY2hyb25pemUnLAogICAgJ3Rlcm1pbmF0ZScsCiAgICAndGVybWluYXRlZCcsCiAgICAnc2VuZF9sb2dzJywKICAgICdyZWxvYWRfYWdlbnRfY29uZmlndXJhdGlvbicsCiAgICAnYnJvYWRjYXN0JywKICAgICdhcGlfbWV0cmljJywKICAgICdjbGllbnRfbWV0cmljJywKICAgICdzb2Z0cGhvbmVfc3RhdHMnLAogICAgJ3NvZnRwaG9uZV9yZXBvcnQnLAogICAgJ211dGUnLAogICAgImlmcmFtZV9zdHlsZSIKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBNYXN0ZXJUb3BpY3MKICAgKi8KICB2YXIgTWFzdGVyVG9waWNzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2Nvbm5lY3QnLCBbCiAgICAnbG9naW5Qb3B1cCcsCiAgICAnc2VuZExvZ3MnLAogICAgJ3NvZnRwaG9uZScsCiAgICAncmluZ3RvbmUnLAogICAgJ21ldHJpY3MnCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQWdlbnRFdmVudHMKICAgKi8KICB2YXIgQWdlbnRFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnYWdlbnQnLCBbCiAgICAnaW5pdCcsCiAgICAndXBkYXRlJywKICAgICdyZWZyZXNoJywKICAgICdyb3V0YWJsZScsCiAgICAnbm90X3JvdXRhYmxlJywKICAgICdwZW5kaW5nJywKICAgICdjb250YWN0X3BlbmRpbmcnLAogICAgJ29mZmxpbmUnLAogICAgJ2Vycm9yJywKICAgICdzb2Z0cGhvbmVfZXJyb3InLAogICAgJ3dlYnNvY2tldF9jb25uZWN0aW9uX2xvc3QnLAogICAgJ3dlYnNvY2tldF9jb25uZWN0aW9uX2dhaW5lZCcsCiAgICAnc3RhdGVfY2hhbmdlJywKICAgICdhY3cnLAogICAgJ211dGVfdG9nZ2xlJywKICAgICdsb2NhbF9tZWRpYV9zdHJlYW1fY3JlYXRlZCcKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBlbnVtIFdlYlNvY2tldEV2ZW50cwogICovCiAgdmFyIFdlYlNvY2tldEV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCd3ZWJTb2NrZXQnLCBbCiAgICAnaW5pdF9mYWlsdXJlJywKICAgICdjb25uZWN0aW9uX29wZW4nLAogICAgJ2Nvbm5lY3Rpb25fY2xvc2UnLAogICAgJ2Nvbm5lY3Rpb25fZXJyb3InLAogICAgJ2Nvbm5lY3Rpb25fZ2FpbicsCiAgICAnY29ubmVjdGlvbl9sb3N0JywKICAgICdzdWJzY3JpcHRpb25fdXBkYXRlJywKICAgICdzdWJzY3JpcHRpb25fZmFpbHVyZScsCiAgICAnYWxsX21lc3NhZ2UnLAogICAgJ3NlbmQnLAogICAgJ3N1YnNjcmliZScKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGVudW0gQ29udGFjdEV2ZW50cwogICAgKi8KICB2YXIgQ29udGFjdEV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdjb250YWN0JywgWwogICAgJ2luaXQnLAogICAgJ3JlZnJlc2gnLAogICAgJ2Rlc3Ryb3llZCcsCiAgICAnaW5jb21pbmcnLAogICAgJ3BlbmRpbmcnLAogICAgJ2Nvbm5lY3RpbmcnLAogICAgJ2Nvbm5lY3RlZCcsCiAgICAnbWlzc2VkJywKICAgICdhY3cnLAogICAgJ3ZpZXcnLAogICAgJ2VuZGVkJywKICAgICdlcnJvcicsCiAgICAnYWNjZXB0ZWQnCiAgXSk7CgoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIGVudW0gQ29ubm5lY3Rpb25FdmVudHMKICAqLwogIHZhciBDb25ubmVjdGlvbkV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdjb25uZWN0aW9uJywgWwogICAgJ3Nlc3Npb25faW5pdCcKICBdKTsKCiAgdmFyIERpc2FzdGVyUmVjb3ZlcnlFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnZGlzYXN0ZXJSZWNvdmVyeScsIFsKICAgICdzdXBwcmVzcycsCiAgICAnZm9yY2Vfb2ZmbGluZScsIC8vIGxldHRpbmcgdGhlIHNoYXJlZHdvcmtlciBrbm93IHRvIGZvcmNlIG9mZmxpbmUgCiAgICAnc2V0X29mZmxpbmUnLCAvLyBpZnJhbWUgbGV0dGluZyB0aGUgbmF0aXZlIGNjcCB0byBzZXQgb2ZmbGluZQogICAgJ2luaXRfZGlzYXN0ZXJfcmVjb3ZlcnknLAogICAgJ2ZhaWxvdmVyJyAvLyB1c2VkIHRvIHByb3BhZ2F0ZSBmYWlsb3ZlciBzdGF0ZSB0byBvdGhlciB3aW5kb3dzCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIEV2ZW50RmFjdG9yeQogICAqLwogIHZhciBFdmVudEZhY3RvcnkgPSBmdW5jdGlvbiAoKSB7IH07CiAgRXZlbnRGYWN0b3J5LmNyZWF0ZVJlcXVlc3QgPSBmdW5jdGlvbiAodHlwZSwgbWV0aG9kLCBwYXJhbXMpIHsKICAgIHJldHVybiB7CiAgICAgIGV2ZW50OiB0eXBlLAogICAgICByZXF1ZXN0SWQ6IGNvbm5lY3QucmFuZG9tSWQoKSwKICAgICAgbWV0aG9kOiBtZXRob2QsCiAgICAgIHBhcmFtczogcGFyYW1zCiAgICB9OwogIH07CgogIEV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZSA9IGZ1bmN0aW9uICh0eXBlLCByZXF1ZXN0LCBkYXRhLCBlcnIpIHsKICAgIHJldHVybiB7CiAgICAgIGV2ZW50OiB0eXBlLAogICAgICByZXF1ZXN0SWQ6IHJlcXVlc3QucmVxdWVzdElkLAogICAgICBkYXRhOiBkYXRhLAogICAgICBlcnI6IGVyciB8fCBudWxsCiAgICB9OwogIH07CgogIC8qKgogICAqIEFuIG9iamVjdCByZXByZXNlbnRpbmcgYW4gZXZlbnQgc3Vic2NyaXB0aW9uIGluIGFuIEV2ZW50QnVzLgogICAqLwogIHZhciBTdWJzY3JpcHRpb24gPSBmdW5jdGlvbiAoc3ViTWFwLCBldmVudE5hbWUsIGYpIHsKICAgIHRoaXMuc3ViTWFwID0gc3ViTWFwOwogICAgdGhpcy5pZCA9IGNvbm5lY3QucmFuZG9tSWQoKTsKICAgIHRoaXMuZXZlbnROYW1lID0gZXZlbnROYW1lOwogICAgdGhpcy5mID0gZjsKICB9OwoKICAvKioKICAgKiBVbnN1YnNjcmliZSB0aGUgaGFuZGxlciBvZiB0aGlzIHN1YnNjcmlwdGlvbiBmcm9tIHRoZSBFdmVudEJ1cwogICAqIGZyb20gd2hpY2ggaXQgd2FzIGNyZWF0ZWQuCiAgICovCiAgU3Vic2NyaXB0aW9uLnByb3RvdHlwZS51bnN1YnNjcmliZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuc3ViTWFwLnVuc3Vic2NyaWJlKHRoaXMuZXZlbnROYW1lLCB0aGlzLmlkKTsKICB9OwoKICAvKioKICAgKiBBIG1hcCBvZiBldmVudCBzdWJzY3JpcHRpb25zLCB1c2VkIGJ5IHRoZSBFdmVudEJ1cy4KICAgKi8KICB2YXIgU3Vic2NyaXB0aW9uTWFwID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5zdWJJZE1hcCA9IHt9OwogICAgdGhpcy5zdWJFdmVudE5hbWVNYXAgPSB7fTsKICB9OwoKICAvKioKICAgKiBBZGQgYSBzdWJzY3JpcHRpb24gZm9yIHRoZSBuYW1lZCBldmVudC4gIENyZWF0ZXMgYSBuZXcgU3Vic2NyaXB0aW9uCiAgICogb2JqZWN0IGFuZCByZXR1cm5zIGl0LiAgVGhpcyBvYmplY3QgY2FuIGJlIHVzZWQgdG8gdW5zdWJzY3JpYmUuCiAgICovCiAgU3Vic2NyaXB0aW9uTWFwLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBmKSB7CiAgICB2YXIgc3ViID0gbmV3IFN1YnNjcmlwdGlvbih0aGlzLCBldmVudE5hbWUsIGYpOwoKICAgIHRoaXMuc3ViSWRNYXBbc3ViLmlkXSA9IHN1YjsKICAgIHZhciBzdWJMaXN0ID0gdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXSB8fCBbXTsKICAgIHN1Ykxpc3QucHVzaChzdWIpOwogICAgdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXSA9IHN1Ykxpc3Q7CiAgICByZXR1cm4gc3ViOwogIH07CgogIC8qKgogICAqIFVuc3Vic2NyaWJlIGEgc3Vic2NyaXB0aW9uIG1hdGNoaW5nIHRoZSBnaXZlbiBldmVudCBuYW1lIGFuZCBpZC4KICAgKi8KICBTdWJzY3JpcHRpb25NYXAucHJvdG90eXBlLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgc3ViSWQpIHsKICAgIGlmIChjb25uZWN0LmNvbnRhaW5zKHRoaXMuc3ViRXZlbnROYW1lTWFwLCBldmVudE5hbWUpKSB7CiAgICAgIHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0gPSB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdLmZpbHRlcihmdW5jdGlvbiAocykgeyByZXR1cm4gcy5pZCAhPT0gc3ViSWQ7IH0pOwoKICAgICAgaWYgKHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0ubGVuZ3RoIDwgMSkgewogICAgICAgIGRlbGV0ZSB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdOwogICAgICB9CiAgICB9CgogICAgaWYgKGNvbm5lY3QuY29udGFpbnModGhpcy5zdWJJZE1hcCwgc3ViSWQpKSB7CiAgICAgIGRlbGV0ZSB0aGlzLnN1YklkTWFwW3N1YklkXTsKICAgIH0KICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIGFsbCBzdWJzY3JpcHRpb25zIGluIHRoZSBzdWJzY3JpcHRpb24gbWFwLgogICAqLwogIFN1YnNjcmlwdGlvbk1hcC5wcm90b3R5cGUuZ2V0QWxsU3Vic2NyaXB0aW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LnZhbHVlcyh0aGlzLnN1YkV2ZW50TmFtZU1hcCkucmVkdWNlKGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgIHJldHVybiBhLmNvbmNhdChiKTsKICAgIH0sIFtdKTsKICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIHN1YnNjcmlwdGlvbnMgZm9yIHRoZSBnaXZlbiBldmVudCBuYW1lLCBvciBhbiBlbXB0eQogICAqIGxpc3QgaWYgdGhlcmUgYXJlIG5vIHN1YnNjcmlwdGlvbnMuCiAgICovCiAgU3Vic2NyaXB0aW9uTWFwLnByb3RvdHlwZS5nZXRTdWJzY3JpcHRpb25zID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgcmV0dXJuIHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0gfHwgW107CiAgfTsKCiAgLyoqCiAgICogQW4gb2JqZWN0IHdoaWNoIG1haW50YWlucyBhIG1hcCBvZiBzdWJzY3JpcHRpb25zIGFuZCBzZXJ2ZXMgYXMgdGhlCiAgICogbWVjaGFuaXNtIGZvciB0cmlnZ2VyaW5nIGV2ZW50cyB0byBiZSBoYW5kbGVkIGJ5IHN1YnNjcmliZXJzLgogICAqLwogIHZhciBFdmVudEJ1cyA9IGZ1bmN0aW9uIChwYXJhbXNJbikgewogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwoKICAgIHRoaXMuc3ViTWFwID0gbmV3IFN1YnNjcmlwdGlvbk1hcCgpOwogICAgdGhpcy5sb2dFdmVudHMgPSBwYXJhbXMubG9nRXZlbnRzIHx8IGZhbHNlOwogIH07CgogIC8qKgogICAqIFN1YnNjcmliZSB0byB0aGUgbmFtZWQgZXZlbnQuICBSZXR1cm5zIGEgbmV3IFN1YnNjcmlwdGlvbiBvYmplY3QKICAgKiB3aGljaCBjYW4gYmUgdXNlZCB0byB1bnN1YnNjcmliZS4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgZikgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgIHJldHVybiB0aGlzLnN1Yk1hcC5zdWJzY3JpYmUoZXZlbnROYW1lLCBmKTsKICB9OwoKICAvKioKICAgKiBTdWJzY3JpYmUgYSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgb24gYWxsIGV2ZW50cy4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuc3Vic2NyaWJlQWxsID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICByZXR1cm4gdGhpcy5zdWJNYXAuc3Vic2NyaWJlKEFMTF9FVkVOVFMsIGYpOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2Ygc3Vic2NyaXB0aW9ucyBmb3IgdGhlIGdpdmVuIGV2ZW50IG5hbWUsIG9yIGFuIGVtcHR5CiAgICogbGlzdCBpZiB0aGVyZSBhcmUgbm8gc3Vic2NyaXB0aW9ucy4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuZ2V0U3Vic2NyaXB0aW9ucyA9IGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgIHJldHVybiB0aGlzLnN1Yk1hcC5nZXRTdWJzY3JpcHRpb25zKGV2ZW50TmFtZSk7CiAgfTsKCiAgLyoqCiAgICogVHJpZ2dlciB0aGUgZ2l2ZW4gZXZlbnQgd2l0aCB0aGUgZ2l2ZW4gZGF0YS4gIEFsbCBtZXRob2RzIHN1YnNjcmliZWQKICAgKiB0byB0aGlzIGV2ZW50IHdpbGwgYmUgY2FsbGVkIGFuZCBhcmUgcHJvdmlkZWQgd2l0aCB0aGUgZ2l2ZW4gYXJiaXRyYXJ5CiAgICogZGF0YSBvYmplY3QgYW5kIHRoZSBuYW1lIG9mIHRoZSBldmVudCwgaW4gdGhhdCBvcmRlci4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUudHJpZ2dlciA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGRhdGEpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBhbGxFdmVudFN1YnMgPSB0aGlzLnN1Yk1hcC5nZXRTdWJzY3JpcHRpb25zKEFMTF9FVkVOVFMpOwogICAgdmFyIGV2ZW50U3VicyA9IHRoaXMuc3ViTWFwLmdldFN1YnNjcmlwdGlvbnMoZXZlbnROYW1lKTsKCiAgICBpZiAodGhpcy5sb2dFdmVudHMgJiYgKGV2ZW50TmFtZSAhPT0gY29ubmVjdC5FdmVudFR5cGUuTE9HICYmIGV2ZW50TmFtZSAhPT0gY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFU1BPTlNFICYmIGV2ZW50TmFtZSAhPT0gY29ubmVjdC5FdmVudFR5cGUuQVBJX01FVFJJQykpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiUHVibGlzaGluZyBldmVudDogJXMiLCBldmVudE5hbWUpOwogICAgfQogICAgYWxsRXZlbnRTdWJzLmNvbmNhdChldmVudFN1YnMpLmZvckVhY2goZnVuY3Rpb24gKHN1YikgewogICAgICB0cnkgewogICAgICAgIHN1Yi5mKGRhdGEgfHwgbnVsbCwgZXZlbnROYW1lLCBzZWxmKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIiclcycgZXZlbnQgaGFuZGxlciBmYWlsZWQuIiwgZXZlbnROYW1lKS53aXRoRXhjZXB0aW9uKGUpOwogICAgICB9CiAgICB9KTsKICB9OwoKICAvKioKICAgKiBSZXR1cm5zIGEgY2xvc3VyZSB3aGljaCBicmlkZ2VzIGFuIGV2ZW50IGZyb20gYW5vdGhlciBFdmVudEJ1cyB0byB0aGlzIGJ1cy4KICAgKgogICAqIFVzYWdlOgogICAqIGNvbmR1aXQub25VcHN0cmVhbSgiTXlFdmVudCIsIGJ1cy5icmlkZ2UoKSk7CiAgICovCiAgRXZlbnRCdXMucHJvdG90eXBlLmJyaWRnZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHJldHVybiBmdW5jdGlvbiAoZGF0YSwgZXZlbnQpIHsKICAgICAgc2VsZi50cmlnZ2VyKGV2ZW50LCBkYXRhKTsKICAgIH07CiAgfTsKCiAgLyoqCiAgICogVW5zdWJzY3JpYmUgYWxsIGV2ZW50cyBpbiB0aGUgZXZlbnQgYnVzLgogICAqLwogIEV2ZW50QnVzLnByb3RvdHlwZS51bnN1YnNjcmliZUFsbCA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuc3ViTWFwLmdldEFsbFN1YnNjcmlwdGlvbnMoKS5mb3JFYWNoKGZ1bmN0aW9uIChzdWIpIHsKICAgICAgc3ViLnVuc3Vic2NyaWJlKCk7CiAgICB9KTsKICB9OwoKICBjb25uZWN0LkV2ZW50QnVzID0gRXZlbnRCdXM7CiAgY29ubmVjdC5FdmVudEZhY3RvcnkgPSBFdmVudEZhY3Rvcnk7CiAgY29ubmVjdC5FdmVudFR5cGUgPSBFdmVudFR5cGU7CiAgY29ubmVjdC5BZ2VudEV2ZW50cyA9IEFnZW50RXZlbnRzOwogIGNvbm5lY3QuQ29ubm5lY3Rpb25FdmVudHMgPSBDb25ubmVjdGlvbkV2ZW50czsKICBjb25uZWN0LkNvbnRhY3RFdmVudHMgPSBDb250YWN0RXZlbnRzOwogIGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzID0gV2ViU29ja2V0RXZlbnRzOwogIGNvbm5lY3QuTWFzdGVyVG9waWNzID0gTWFzdGVyVG9waWNzOwogIGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cyA9IERpc2FzdGVyUmVjb3ZlcnlFdmVudHM7Cn0pKCk7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24oKSB7CiAgIHZhciBnbG9iYWwgPSB0aGlzOwogICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFN0cmVhbQogICAgKgogICAgKiBSZXByZXNlbnRzIGFuIG9iamVjdCBmcm9tIHdoaWNoIG1lc3NhZ2VzIGNhbiBiZSByZWFkIGFuZCB0byB3aGljaAogICAgKiBtZXNzYWdlcyBjYW4gYmUgc2VudC4KICAgICovCiAgIHZhciBTdHJlYW0gPSBmdW5jdGlvbigpIHt9OwoKICAgLyoqCiAgICAqIFNlbmQgYSBtZXNzYWdlIHRvIHRoZSBzdHJlYW0uICBUaGlzIG1ldGhvZCBtdXN0IGJlIGltcGxlbWVudGVkIGJ5IHN1YmNsYXNzZXMuCiAgICAqLwogICBTdHJlYW0ucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IoKTsKICAgfTsKCiAgIC8qKgogICAgKiBQcm92aWRlIGEgbWV0aG9kIHRvIGJlIGNhbGxlZCB3aGVuIG1lc3NhZ2VzIGFyZSByZWNlaXZlZCBmcm9tIHRoaXMgc3RyZWFtLgogICAgKiBUaGlzIG1ldGhvZCBtdXN0IGJlIGltcGxlbWVudGVkIGJ5IHN1YmNsYXNzZXMuCiAgICAqLwogICBTdHJlYW0ucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvcigpOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIE51bGxTdHJlYW0gZXh0ZW5kcyBTdHJlYW0KICAgICoKICAgICogQSBudWxsIHN0cmVhbSB3aGljaCBwcm92aWRlcyBubyBtZXNzYWdlIHNlbmRpbmcgb3IgcmVjZWl2aW5nIGZhY2lsaXRpZXMuCiAgICAqLwogICB2YXIgTnVsbFN0cmVhbSA9IGZ1bmN0aW9uKCkgewogICAgICBTdHJlYW0uY2FsbCh0aGlzKTsKICAgfTsKICAgTnVsbFN0cmVhbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUpOwogICBOdWxsU3RyZWFtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IE51bGxTdHJlYW07CgogICBOdWxsU3RyZWFtLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7fTsKICAgTnVsbFN0cmVhbS5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHt9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFdpbmRvd1N0cmVhbSBleHRlbmRzIFN0cmVhbQogICAgKgogICAgKiBBIHN0cmVhbSBmb3IgY29tbXVuaWNhdGluZyB3aXRoIGEgd2luZG93IG9iamVjdC4gIFRoZSBkb21haW4gcHJvdmlkZWQKICAgICogbXVzdCBtYXRjaCB0aGUgYWxsb3dlZCBtZXNzYWdlIGRvbWFpbnMgb2YgdGhlIGRvd25zdHJlYW0gcmVjZWl2ZXIKICAgICogb3IgbWVzc2FnZXMgd2lsbCBiZSByZWplY3RlZCwgc2VlIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9XaW5kb3cvcG9zdE1lc3NhZ2UKICAgICogZm9yIG1vcmUgaW5mby4KICAgICovCiAgIHZhciBXaW5kb3dTdHJlYW0gPSBmdW5jdGlvbih3aW4sIGRvbWFpbikgewogICAgICBTdHJlYW0uY2FsbCh0aGlzKTsKICAgICAgdGhpcy53aW5kb3cgPSB3aW47CiAgICAgIHRoaXMuZG9tYWluID0gZG9tYWluIHx8ICcqJzsKICAgfTsKICAgV2luZG93U3RyZWFtLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoU3RyZWFtLnByb3RvdHlwZSk7CiAgIFdpbmRvd1N0cmVhbS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBXaW5kb3dTdHJlYW07CgogICBXaW5kb3dTdHJlYW0ucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgIHRoaXMud2luZG93LnBvc3RNZXNzYWdlKG1lc3NhZ2UsIHRoaXMuZG9tYWluKTsKICAgfTsKCiAgIFdpbmRvd1N0cmVhbS5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikgewogICAgICB0aGlzLndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgZik7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgV2luZG93SU9TdHJlYW0gZXh0ZW5kcyBTdHJlYW0KICAgICoKICAgICogQSBzdHJlYW0gdXNlZCBieSBJRnJhbWUvcG9wdXAgd2luZG93cyB0byBjb21tdW5pY2F0ZSB3aXRoIHRoZWlyIHBhcmVudHMKICAgICogYW5kIHZpc2UgdmVyc2EuCiAgICAqCiAgICAqIFRoaXMgb2JqZWN0IGVuY2Fwc3VsYXRlcyB0aGUgZmFjdCB0aGF0IGluY29taW5nIGFuZCBvdXRnb2luZyBtZXNzYWdlcwogICAgKiBhcnJpdmUgb24gZGlmZmVyZW50IHdpbmRvd3MgYW5kIGFsbG93cyB0aGlzIHRvIGJlIG1hbmFnZWQgYXMgYSBzaW5nbGUKICAgICogU3RyZWFtIG9iamVjdC4KICAgICovCiAgIHZhciBXaW5kb3dJT1N0cmVhbSA9IGZ1bmN0aW9uKGlucHV0d2luLCBvdXRwdXR3aW4sIGRvbWFpbikgewogICAgICBTdHJlYW0uY2FsbCh0aGlzKTsKICAgICAgdGhpcy5pbnB1dCA9IGlucHV0d2luOwogICAgICB0aGlzLm91dHB1dCA9IG91dHB1dHdpbjsKICAgICAgdGhpcy5kb21haW4gPSBkb21haW4gfHwgJyonOwogICB9OwogICBXaW5kb3dJT1N0cmVhbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUpOwogICBXaW5kb3dJT1N0cmVhbS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBXaW5kb3dJT1N0cmVhbTsKCiAgIFdpbmRvd0lPU3RyZWFtLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aGlzLm91dHB1dC5wb3N0TWVzc2FnZShtZXNzYWdlLCB0aGlzLmRvbWFpbik7CiAgIH07CgogICBXaW5kb3dJT1N0cmVhbS5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikgewogICAgICB0aGlzLmlucHV0LmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBmKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBQb3J0U3RyZWFtIGV4dGVuZHMgU3RyZWFtCiAgICAqCiAgICAqIEEgc3RyZWFtIHdyYXBwaW5nIGFuIEhUTUw1IFdvcmtlciBwb3J0LiAgVGhpcyBjb3VsZCBiZSB0aGUgcG9ydAogICAgKiB1c2VkIHRvIGNvbm5lY3QgdG8gYSBXb3JrZXIgb3Igb25lIG9mIHRoZSBtdWx0aXR1ZGUgb2YgcG9ydHMKICAgICogbWFkZSBhdmFpbGFibGUgdG8gYSBTaGFyZWRXb3JrZXIgZm9yIGNvbW11bmljYXRpb24gYmFjayB0bwogICAgKiBpdHMgY29ubmVjdGVkIGNsaWVudHMuCiAgICAqLwogICB2YXIgUG9ydFN0cmVhbSA9IGZ1bmN0aW9uKHBvcnQpIHsKICAgICAgU3RyZWFtLmNhbGwodGhpcyk7CiAgICAgIHRoaXMucG9ydCA9IHBvcnQ7CiAgICAgIHRoaXMuaWQgPSBjb25uZWN0LnJhbmRvbUlkKCk7CiAgIH07CiAgIFBvcnRTdHJlYW0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdHJlYW0ucHJvdG90eXBlKTsKICAgUG9ydFN0cmVhbS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQb3J0U3RyZWFtOwoKICAgUG9ydFN0cmVhbS5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgdGhpcy5wb3J0LnBvc3RNZXNzYWdlKG1lc3NhZ2UpOwogICB9OwoKICAgUG9ydFN0cmVhbS5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikgewogICAgICB0aGlzLnBvcnQuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIGYpOwogICB9OwoKICAgUG9ydFN0cmVhbS5wcm90b3R5cGUuZ2V0SWQgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuaWQ7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgU3RyZWFtTXVsdGlwbGV4ZXIgZXh0ZW5kcyBTdHJlYW0KICAgICoKICAgICogQSB3cmFwcGVyIGZvciBtdWx0aXBsZXhlZCBkb3duc3RyZWFtIGNvbW11bmljYXRpb24gd2l0aAogICAgKiBtdWx0aXBsZSBzdHJlYW1zIGF0IG9uY2UuICBNYWlubHkgdXNlZnVsIGZvciB0aGUgU2hhcmVkV29ya2VyIHRvCiAgICAqIGJyb2FkY2FzdCBldmVudHMgdG8gbWFueSBQb3J0U3RyZWFtIG9iamVjdHMgYXQgb25jZS4KICAgICovCiAgIHZhciBTdHJlYW1NdWx0aXBsZXhlciA9IGZ1bmN0aW9uKHN0cmVhbXMpIHsKICAgICAgU3RyZWFtLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuc3RyZWFtTWFwID0gc3RyZWFtcyA/CiAgICAgICAgIGNvbm5lY3QuaW5kZXgoc3RyZWFtcywgZnVuY3Rpb24ocykgeyByZXR1cm4gcy5nZXRJZCgpOyB9KSA6IHt9OwogICAgICB0aGlzLm1lc3NhZ2VMaXN0ZW5lcnMgPSBbXTsKICAgfTsKICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdHJlYW0ucHJvdG90eXBlKTsKICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gU3RyZWFtTXVsdGlwbGV4ZXI7CgogICAvKioKICAgICogU2VuZCBhIG1lc3NhZ2UgdG8gYWxsIHBvcnRzIGluIHRoZSBtdWx0aXBsZXhlci4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aGlzLmdldFN0cmVhbXMoKS5mb3JFYWNoKGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICB0cnkgewogICAgICAgICAgICBzdHJlYW0uc2VuZChtZXNzYWdlKTsKCiAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgLy8gQ291bGRuJ3Qgc2VuZCBtZXNzYWdlIHRvIG9uZSBvZiB0aGUgZG93bnN0cmVhbXMgZm9yIHNvbWUgcmVhc29uLi4uCiAgICAgICAgICAgIC8vIE5vIHJlbGlhYmxlIGxvZ2dpbmcgcG9zc2libGUgd2l0aG91dCBmdXJ0aGVyIGZhaWx1cmVzLAogICAgICAgICAgICAvLyBubyByZWNvdmVyeSwganVzdCBlYXQgaXQuCiAgICAgICAgIH0KICAgICAgfSk7CiAgIH07CgogICAvKioKICAgICogUmVnaXN0ZXIgYSBtZXRob2Qgd2hpY2ggd2lsbCBiZSBjYWxsZWQgd2hlbiBhIG1lc3NhZ2UgaXMgcmVjZWl2ZWQgZnJvbQogICAgKiBhbnkgb2YgdGhlIGRvd25zdHJlYW1zLgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgdGhpcy5tZXNzYWdlTGlzdGVuZXJzLnB1c2goZik7CgogICAgICAvLyBVcGRhdGUgZXhpc3Rpbmcgc3RyZWFtcyB3aXRoIHRoZSBuZXcgbGlzdGVuZXIuCiAgICAgIHRoaXMuZ2V0U3RyZWFtcygpLmZvckVhY2goZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgIHN0cmVhbS5vbk1lc3NhZ2UoZik7CiAgICAgIH0pOwogICB9OwoKICAgLyoqCiAgICAqIEFkZCBhIHN0cmVhbSB0byB0aGUgbXVsdGlwbGV4ZXIuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUuYWRkU3RyZWFtID0gZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdGhpcy5zdHJlYW1NYXBbc3RyZWFtLmdldElkKCldID0gc3RyZWFtOwoKICAgICAgLy8gVXBkYXRlIHN0cmVhbSB3aXRoIGV4aXN0aW5nIGxpc3RlbmVycy4KICAgICAgdGhpcy5tZXNzYWdlTGlzdGVuZXJzLmZvckVhY2goZnVuY3Rpb24obWVzc2FnZUxpc3RlbmVyKSB7CiAgICAgICAgIHN0cmVhbS5vbk1lc3NhZ2UobWVzc2FnZUxpc3RlbmVyKTsKICAgICAgfSk7CiAgIH07CgogICAvKioKICAgICogUmVtb3ZlIHRoZSBnaXZlbiBkb3duc3RyZWFtLiAgVGhpcyBpcyB0eXBpY2FsbHkgdXNlZCBpbiByZXNwb25zZQogICAgKiB0byB0aGUgU2hhcmVkV29ya2VyJ3Mgb25jbG9zZSBldmVudCwgaW5kaWNhdGluZyB0aGF0IGEgY29uc3VtZXIKICAgICogdGFiIGhhcyBiZWVuIGNsb3NlZC4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5yZW1vdmVTdHJlYW0gPSBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgZGVsZXRlIHRoaXMuc3RyZWFtTWFwW3N0cmVhbS5nZXRJZCgpXTsKICAgfTsKCiAgIC8qKgogICAgKiBHZXQgYSBsaXN0IG9mIHN0cmVhbXMgaW4gdGhlIG11bHRpcGxleGVyLgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLmdldFN0cmVhbXMgPSBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgcmV0dXJuIGNvbm5lY3QudmFsdWVzKHRoaXMuc3RyZWFtTWFwKTsKICAgfTsKCiAgIC8qKgogICAgKiBHZXQgdGhlIHN0cmVhbSBtYXRjaGluZyB0aGUgZ2l2ZW4gcG9ydC4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5nZXRTdHJlYW1Gb3JQb3J0ID0gZnVuY3Rpb24ocG9ydCkgewogICAgICByZXR1cm4gY29ubmVjdC5maW5kKHRoaXMuZ2V0U3RyZWFtcygpLCBmdW5jdGlvbihzKSB7CiAgICAgICAgIHJldHVybiBzLnBvcnQgPT09IHBvcnQ7CiAgICAgIH0pOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIENvbmR1aXQKICAgICoKICAgICogQW4gb2JqZWN0IHdoaWNoIGJyaWRnZXMgYW4gdXBzdHJlYW0gYW5kIGEgZG93bnN0cmVhbSwgYWxsb3dpbmcgbWVzc2FnZXMKICAgICogdG8gYmUgcGFzc2VkIHRvIGFuZCBmcm9tIGVhY2ggYW5kIHByb3ZpZGluZyBhbiBldmVudCBidXMgZm9yIGV2ZW50CiAgICAqIHN1YnNjcmlwdGlvbnMgdG8gYmUgbWFkZSB1cHN0cmVhbSBhbmQgZG93bnN0cmVhbS4KICAgICovCiAgIHZhciBDb25kdWl0ID0gZnVuY3Rpb24obmFtZSwgdXBzdHJlYW0sIGRvd25zdHJlYW0pIHsKICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgdGhpcy51cHN0cmVhbSA9IHVwc3RyZWFtIHx8IG5ldyBOdWxsU3RyZWFtKCk7CiAgICAgIHRoaXMuZG93bnN0cmVhbSA9IGRvd25zdHJlYW0gfHwgbmV3IE51bGxTdHJlYW0oKTsKICAgICAgdGhpcy5kb3duc3RyZWFtQnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoKTsKICAgICAgdGhpcy51cHN0cmVhbUJ1cyA9IG5ldyBjb25uZWN0LkV2ZW50QnVzKCk7CgogICAgICB0aGlzLnVwc3RyZWFtLm9uTWVzc2FnZShjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMuX2Rpc3BhdGNoRXZlbnQsIHRoaXMudXBzdHJlYW1CdXMpKTsKICAgICAgdGhpcy5kb3duc3RyZWFtLm9uTWVzc2FnZShjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMuX2Rpc3BhdGNoRXZlbnQsIHRoaXMuZG93bnN0cmVhbUJ1cykpOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUub25VcHN0cmVhbSA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgcmV0dXJuIHRoaXMudXBzdHJlYW1CdXMuc3Vic2NyaWJlKGV2ZW50TmFtZSwgZik7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5vbkFsbFVwc3RyZWFtID0gZnVuY3Rpb24oZikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZiwgJ2YnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIHJldHVybiB0aGlzLnVwc3RyZWFtQnVzLnN1YnNjcmliZUFsbChmKTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLm9uRG93bnN0cmVhbSA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgcmV0dXJuIHRoaXMuZG93bnN0cmVhbUJ1cy5zdWJzY3JpYmUoZXZlbnROYW1lLCBmKTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLm9uQWxsRG93bnN0cmVhbSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICByZXR1cm4gdGhpcy5kb3duc3RyZWFtQnVzLnN1YnNjcmliZUFsbChmKTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLnNlbmRVcHN0cmVhbSA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZGF0YSkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICAgIHRoaXMudXBzdHJlYW0uc2VuZCh7ZXZlbnQ6IGV2ZW50TmFtZSwgZGF0YTogZGF0YX0pOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUuc2VuZERvd25zdHJlYW0gPSBmdW5jdGlvbihldmVudE5hbWUsIGRhdGEpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgICB0aGlzLmRvd25zdHJlYW0uc2VuZCh7ZXZlbnQ6IGV2ZW50TmFtZSwgZGF0YTogZGF0YX0pOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUuX2Rpc3BhdGNoRXZlbnQgPSBmdW5jdGlvbihidXMsIG1lc3NhZ2VFdmVudCkgewogICAgICB2YXIgbWVzc2FnZSA9IG1lc3NhZ2VFdmVudC5kYXRhOwogICAgICBpZiAobWVzc2FnZS5ldmVudCkgewogICAgICAgICBidXMudHJpZ2dlcihtZXNzYWdlLmV2ZW50LCBtZXNzYWdlLmRhdGEpOwogICAgICB9CiAgIH07CgogICAvKioKICAgICogUmV0dXJucyBhIGNsb3N1cmUgd2hpY2ggcGFzc2VzIGV2ZW50cyB1cHN0cmVhbS4KICAgICoKICAgICogVXNhZ2U6CiAgICAqIGNvbmR1aXQub25Eb3duc3RyZWFtKCJNeUV2ZW50IiwgY29uZHVpdC5wYXNzVXBzdHJlYW0oKSk7CiAgICAqLwogICBDb25kdWl0LnByb3RvdHlwZS5wYXNzVXBzdHJlYW0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICByZXR1cm4gZnVuY3Rpb24oZGF0YSwgZXZlbnROYW1lKSB7CiAgICAgICAgIHNlbGYudXBzdHJlYW0uc2VuZCh7ZXZlbnQ6IGV2ZW50TmFtZSwgZGF0YTogZGF0YX0pOwogICAgICB9OwogICB9OwoKICAgLyoqCiAgICAqIFJldHVybnMgYSBjbG9zdXJlIHdoaWNoIHBhc3NlcyBldmVudHMgZG93bnN0cmVhbS4KICAgICoKICAgICogVXNhZ2U6CiAgICAqIGNvbmR1aXQub25VcHN0cmVhbSgiTXlFdmVudCIsIGNvbmR1aXQucGFzc0Rvd25zdHJlYW0oKSk7CiAgICAqLwogICBDb25kdWl0LnByb3RvdHlwZS5wYXNzRG93bnN0cmVhbSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHJldHVybiBmdW5jdGlvbihkYXRhLCBldmVudE5hbWUpIHsKICAgICAgICAgc2VsZi5kb3duc3RyZWFtLnNlbmQoe2V2ZW50OiBldmVudE5hbWUsIGRhdGE6IGRhdGF9KTsKICAgICAgfTsKICAgfTsKCiAgIC8qKgogICAgKiBTaHV0ZG93biB0aGUgY29uZHVpdCdzIGV2ZW50IGJ1c3NlcyBhbmQgcmVtb3ZlIGFsbCBzdWJzY3JpcHRpb25zLgogICAgKi8KICAgQ29uZHVpdC5wcm90b3R5cGUuc2h1dGRvd24gPSBmdW5jdGlvbigpIHsKICAgICAgdGhpcy51cHN0cmVhbUJ1cy51bnN1YnNjcmliZUFsbCgpOwogICAgICB0aGlzLmRvd25zdHJlYW1CdXMudW5zdWJzY3JpYmVBbGwoKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBJRnJhbWVDb25kdWl0IGV4dGVuZHMgQ29uZHVpdAogICAgKgogICAgKiBDcmVhdGVzIGEgY29uZHVpdCBmb3IgdGhlIGdpdmVuIElGcmFtZSBlbGVtZW50LgogICAgKi8KICAgdmFyIElGcmFtZUNvbmR1aXQgPSBmdW5jdGlvbihuYW1lLCB3aW5kb3csIGlmcmFtZSwgZG9tYWluKSB7CiAgICAgIENvbmR1aXQuY2FsbCh0aGlzLCBuYW1lLCBuZXcgV2luZG93SU9TdHJlYW0od2luZG93LCBpZnJhbWUuY29udGVudFdpbmRvdywgZG9tYWluIHx8ICcqJyksIG51bGwpOwogICB9OwogICBJRnJhbWVDb25kdWl0LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29uZHVpdC5wcm90b3R5cGUpOwogICBJRnJhbWVDb25kdWl0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IElGcmFtZUNvbmR1aXQ7CgogICBjb25uZWN0LlN0cmVhbSA9IFN0cmVhbTsKICAgY29ubmVjdC5OdWxsU3RyZWFtID0gTnVsbFN0cmVhbTsKICAgY29ubmVjdC5XaW5kb3dTdHJlYW0gPSBXaW5kb3dTdHJlYW07CiAgIGNvbm5lY3QuV2luZG93SU9TdHJlYW0gPSBXaW5kb3dJT1N0cmVhbTsKICAgY29ubmVjdC5Qb3J0U3RyZWFtID0gUG9ydFN0cmVhbTsKICAgY29ubmVjdC5TdHJlYW1NdWx0aXBsZXhlciA9IFN0cmVhbU11bHRpcGxleGVyOwogICBjb25uZWN0LkNvbmR1aXQgPSBDb25kdWl0OwogICBjb25uZWN0LklGcmFtZUNvbmR1aXQgPSBJRnJhbWVDb25kdWl0Owp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uKCkgewogICB2YXIgZ2xvYmFsID0gdGhpczsKICAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBlbnVtIENsaWVudE1ldGhvZHMKICAgICovCiAgIGNvbm5lY3QuQ2xpZW50TWV0aG9kcyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgICAgICAnZ2V0QWdlbnRTbmFwc2hvdCcsCiAgICAgICAgICdwdXRBZ2VudFN0YXRlJywKICAgICAgICAgJ2dldEFnZW50U3RhdGVzJywKICAgICAgICAgJ2dldERpYWxhYmxlQ291bnRyeUNvZGVzJywKICAgICAgICAgJ2dldFJvdXRpbmdQcm9maWxlUXVldWVzJywKICAgICAgICAgJ2dldEFnZW50UGVybWlzc2lvbnMnLAogICAgICAgICAnZ2V0QWdlbnRDb25maWd1cmF0aW9uJywKICAgICAgICAgJ3VwZGF0ZUFnZW50Q29uZmlndXJhdGlvbicsCiAgICAgICAgICdhY2NlcHRDb250YWN0JywKICAgICAgICAgJ2NyZWF0ZU91dGJvdW5kQ29udGFjdCcsCiAgICAgICAgICdjcmVhdGVUYXNrQ29udGFjdCcsCiAgICAgICAgICdjbGVhckNvbnRhY3QnLAogICAgICAgICAnY29tcGxldGVDb250YWN0JywKICAgICAgICAgJ2Rlc3Ryb3lDb250YWN0JywKICAgICAgICAgJ3JlamVjdENvbnRhY3QnLAogICAgICAgICAnbm90aWZ5Q29udGFjdElzc3VlJywKICAgICAgICAgJ3VwZGF0ZUNvbnRhY3RBdHRyaWJ1dGVzJywKICAgICAgICAgJ2NyZWF0ZUFkZGl0aW9uYWxDb25uZWN0aW9uJywKICAgICAgICAgJ2Rlc3Ryb3lDb25uZWN0aW9uJywKICAgICAgICAgJ2hvbGRDb25uZWN0aW9uJywKICAgICAgICAgJ3Jlc3VtZUNvbm5lY3Rpb24nLAogICAgICAgICAndG9nZ2xlQWN0aXZlQ29ubmVjdGlvbnMnLAogICAgICAgICAnY29uZmVyZW5jZUNvbm5lY3Rpb25zJywKICAgICAgICAgJ3NlbmRDbGllbnRMb2dzJywKICAgICAgICAgJ3NlbmREaWdpdHMnLAogICAgICAgICAnc2VuZFNvZnRwaG9uZUNhbGxSZXBvcnQnLAogICAgICAgICAnc2VuZFNvZnRwaG9uZUNhbGxNZXRyaWNzJywKICAgICAgICAgJ2dldEVuZHBvaW50cycsCiAgICAgICAgICdnZXROZXdBdXRoVG9rZW4nLAogICAgICAgICAnY3JlYXRlVHJhbnNwb3J0JwogICBdKTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBlbnVtIE1hc3Rlck1ldGhvZHMKICAgICovCiAgIGNvbm5lY3QuTWFzdGVyTWV0aG9kcyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgICAgICAnYmVjb21lTWFzdGVyJywKICAgICAgICAgJ2NoZWNrTWFzdGVyJwogICBdKTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBhYnN0cmFjdCBjbGFzcyBDbGllbnRCYXNlCiAgICAqLwogICB2YXIgQ2xpZW50QmFzZSA9IGZ1bmN0aW9uKCkge307CiAgIENsaWVudEJhc2UuRU1QVFlfQ0FMTEJBQ0tTID0gewogICAgICBzdWNjZXNzOiBmdW5jdGlvbigpIHsgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24oKSB7IH0KICAgfTsKCiAgIENsaWVudEJhc2UucHJvdG90eXBlLmNhbGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtc0luLCBjYWxsYmFja3NJbikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwobWV0aG9kLCAnbWV0aG9kJyk7CiAgICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgICAgdmFyIGNhbGxiYWNrcyA9IGNhbGxiYWNrc0luIHx8IENsaWVudEJhc2UuRU1QVFlfQ0FMTEJBQ0tTOwogICAgICB0aGlzLl9jYWxsSW1wbChtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKTsKICAgfTsKCiAgIENsaWVudEJhc2UucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvcigpOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIE51bGxDbGllbnQgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICAqLwogICB2YXIgTnVsbENsaWVudCA9IGZ1bmN0aW9uKCkgewogICAgICBDbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgIH07CiAgIE51bGxDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIE51bGxDbGllbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gTnVsbENsaWVudDsKCiAgIE51bGxDbGllbnQucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3MuZmFpbHVyZSkgewogICAgICAgICB2YXIgbWVzc2FnZSA9IGNvbm5lY3Quc3ByaW50ZignTm8gc3VjaCBtZXRob2QgZXhpc3RzIG9uIE5VTEwgY2xpZW50OiAlcycsIG1ldGhvZCk7CiAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKG5ldyBjb25uZWN0LlZhbHVlRXJyb3IobWVzc2FnZSksIHttZXNzYWdlOiBtZXNzYWdlfSk7CiAgICAgIH0KICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBhYnN0cmFjdCBjbGFzcyBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlIGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UgPSBmdW5jdGlvbihjb25kdWl0LCByZXF1ZXN0RXZlbnQsIHJlc3BvbnNlRXZlbnQpIHsKICAgICAgQ2xpZW50QmFzZS5jYWxsKHRoaXMpOwogICAgICB0aGlzLmNvbmR1aXQgPSBjb25kdWl0OwogICAgICB0aGlzLnJlcXVlc3RFdmVudCA9IHJlcXVlc3RFdmVudDsKICAgICAgdGhpcy5yZXNwb25zZUV2ZW50ID0gcmVzcG9uc2VFdmVudDsKICAgICAgdGhpcy5fcmVxdWVzdElkQ2FsbGJhY2tzTWFwID0ge307CgogICAgICB0aGlzLmNvbmR1aXQub25VcHN0cmVhbShyZXNwb25zZUV2ZW50LCBjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMuX2hhbmRsZVJlc3BvbnNlKSk7CiAgIH07CgogICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ2xpZW50QmFzZS5wcm90b3R5cGUpOwogICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2U7CgogICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CiAgICAgIHZhciByZXF1ZXN0ID0gY29ubmVjdC5FdmVudEZhY3RvcnkuY3JlYXRlUmVxdWVzdCh0aGlzLnJlcXVlc3RFdmVudCwgbWV0aG9kLCBwYXJhbXMpOwogICAgICB0aGlzLl9yZXF1ZXN0SWRDYWxsYmFja3NNYXBbcmVxdWVzdC5yZXF1ZXN0SWRdID0gY2FsbGJhY2tzOwogICAgICB0aGlzLmNvbmR1aXQuc2VuZFVwc3RyZWFtKHJlcXVlc3QuZXZlbnQsIHJlcXVlc3QpOwogICB9OwoKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUuX2dldENhbGxiYWNrc0ZvclJlcXVlc3QgPSBmdW5jdGlvbihyZXF1ZXN0SWQpIHsKICAgICAgdmFyIGNhbGxiYWNrcyA9IHRoaXMuX3JlcXVlc3RJZENhbGxiYWNrc01hcFtyZXF1ZXN0SWRdIHx8IG51bGw7CgogICAgICBpZiAoY2FsbGJhY2tzICE9IG51bGwpIHsKICAgICAgICAgZGVsZXRlIHRoaXMuX3JlcXVlc3RJZENhbGxiYWNrc01hcFtyZXF1ZXN0SWRdOwogICAgICB9CgogICAgICByZXR1cm4gY2FsbGJhY2tzOwogICB9OwoKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUuX2hhbmRsZVJlc3BvbnNlID0gZnVuY3Rpb24oZGF0YSkgewogICAgICB2YXIgY2FsbGJhY2tzID0gdGhpcy5fZ2V0Q2FsbGJhY2tzRm9yUmVxdWVzdChkYXRhLnJlcXVlc3RJZCk7CiAgICAgIGlmIChjYWxsYmFja3MgPT0gbnVsbCkgewogICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmIChkYXRhLmVyciAmJiBjYWxsYmFja3MuZmFpbHVyZSkgewogICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShkYXRhLmVyciwgZGF0YS5kYXRhKTsKCiAgICAgIH0gZWxzZSBpZiAoY2FsbGJhY2tzLnN1Y2Nlc3MpIHsKICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YS5kYXRhKTsKICAgICAgfQogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFVwc3RyZWFtQ29uZHVpdENsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBVcHN0cmVhbUNvbmR1aXRDbGllbnQgPSBmdW5jdGlvbihjb25kdWl0KSB7CiAgICAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UuY2FsbCh0aGlzLCBjb25kdWl0LCBjb25uZWN0LkV2ZW50VHlwZS5BUElfUkVRVUVTVCwgY29ubmVjdC5FdmVudFR5cGUuQVBJX1JFU1BPTlNFKTsKICAgfTsKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUpOwogICBVcHN0cmVhbUNvbmR1aXRDbGllbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVXBzdHJlYW1Db25kdWl0Q2xpZW50OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBVcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQgPSBmdW5jdGlvbihjb25kdWl0KSB7CiAgICAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UuY2FsbCh0aGlzLCBjb25kdWl0LCBjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVRVUVTVCwgY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFU1BPTlNFKTsKICAgfTsKICAgVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUpOwogICBVcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIEFXU0NsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBBV1NDbGllbnQgPSBmdW5jdGlvbihhdXRoVG9rZW4sIHJlZ2lvbiwgZW5kcG9pbnRJbikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoYXV0aFRva2VuLCAnYXV0aFRva2VuJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChyZWdpb24sICdyZWdpb24nKTsKICAgICAgQ2xpZW50QmFzZS5jYWxsKHRoaXMpOwogICAgICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5DcmVkZW50aWFscyh7fSk7CiAgICAgIEFXUy5jb25maWcucmVnaW9uID0gcmVnaW9uOwogICAgICB0aGlzLmF1dGhUb2tlbiA9IGF1dGhUb2tlbjsKICAgICAgdmFyIGVuZHBvaW50VXJsID0gZW5kcG9pbnRJbiB8fCBjb25uZWN0LmdldEJhc2VVcmwoKSArICcvY29ubmVjdC9hcGknOwogICAgICB2YXIgZW5kcG9pbnQgPSBuZXcgQVdTLkVuZHBvaW50KGVuZHBvaW50VXJsKTsKICAgICAgdGhpcy5jbGllbnQgPSBuZXcgQVdTLkNvbm5lY3Qoe2VuZHBvaW50OiBlbmRwb2ludH0pOwogICB9OwogICBBV1NDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIEFXU0NsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBBV1NDbGllbnQ7CgogICBBV1NDbGllbnQucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgbG9nID0gY29ubmVjdC5nZXRMb2coKTsKCiAgICAgIGlmICghIGNvbm5lY3QuY29udGFpbnModGhpcy5jbGllbnQsIG1ldGhvZCkpIHsKICAgICAgICAgdmFyIG1lc3NhZ2UgPSBjb25uZWN0LnNwcmludGYoJ05vIHN1Y2ggbWV0aG9kIGV4aXN0cyBvbiBBV1MgY2xpZW50OiAlcycsIG1ldGhvZCk7CiAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKG5ldyBjb25uZWN0LlZhbHVlRXJyb3IobWVzc2FnZSksIHttZXNzYWdlOiBtZXNzYWdlfSk7CgogICAgICB9IGVsc2UgewogICAgICAgICBwYXJhbXMgPSB0aGlzLl90cmFuc2xhdGVQYXJhbXMobWV0aG9kLCBwYXJhbXMpOwoKICAgICAgICAgbG9nLnRyYWNlKCJBV1NDbGllbnQ6IC0tPiBDYWxsaW5nIG9wZXJhdGlvbiAnJXMnIiwgbWV0aG9kKTsKCiAgICAgICAgIHRoaXMuY2xpZW50W21ldGhvZF0ocGFyYW1zKQogICAgICAgICAgICAub24oJ2J1aWxkJywgZnVuY3Rpb24ocmVxdWVzdCkgewogICAgICAgICAgICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LUJlYXJlciddID0gc2VsZi5hdXRoVG9rZW47CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIuY29kZSA9PT0gY29ubmVjdC5DVElFeGNlcHRpb25zLlVOQVVUSE9SSVpFRF9FWENFUFRJT04pIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLmF1dGhGYWlsdXJlKCk7CiAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2FsbGJhY2tzLmFjY2Vzc0RlbmllZCAmJiAoZXJyLmNvZGUgPT09IGNvbm5lY3QuQ1RJRXhjZXB0aW9ucy5BQ0NFU1NfREVOSUVEX0VYQ0VQVElPTiB8fCBlcnIuc3RhdHVzQ29kZSA9PT0gNDAzKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3MuYWNjZXNzRGVuaWVkKCk7CiAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENhbid0IHBhc3MgZXJyIGRpcmVjdGx5IHRvIHBvc3RNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBvc3RNZXNzYWdlKCkgdHJpZXMgdG8gY2xvbmUgdGhlIGVyciBvYmplY3QgYW5kIGZhaWxlZC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVmZXIgdG8gaHR0cHM6Ly9naXRodWIuY29tL2dvYXRzbGFja2VyL2FsdC1kZXZ0b29sL2lzc3Vlcy81CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICBlcnJvci50eXBlID0gZXJyLmNvZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLm1lc3NhZ2UgPSBlcnIubWVzc2FnZTsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3Iuc3RhY2sgPSBlcnIuc3RhY2sgPyBlcnIuc3RhY2suc3BsaXQoJ1xuJykgOiBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZXJyb3IsIGRhdGEpOwogICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICBsb2cudHJhY2UoIkFXU0NsaWVudDogPC0tIE9wZXJhdGlvbiAnJXMnIGZhaWxlZDogJXMiLCBtZXRob2QsIEpTT04uc3RyaW5naWZ5KGVycikpOwoKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgbG9nLnRyYWNlKCJBV1NDbGllbnQ6IDwtLSBPcGVyYXRpb24gJyVzJyBzdWNjZWVkZWQuIiwgbWV0aG9kKS53aXRoT2JqZWN0KGRhdGEpOwogICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBoYW5kbGUgQVdTIEFQSSByZXF1ZXN0IGZvciBtZXRob2QgJXMiLCBtZXRob2QpCiAgICAgICAgICAgICAgICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGUpOwogICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICB9CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl9yZXF1aXJlc0F1dGhlbnRpY2F0aW9uUGFyYW0gPSBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgIHJldHVybiBtZXRob2QgIT09IGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DT01QTEVURV9DT05UQUNUICYmCiAgICAgICAgIG1ldGhvZCAhPT0gY29ubmVjdC5DbGllbnRNZXRob2RzLkNMRUFSX0NPTlRBQ1QgJiYKICAgICAgICAgbWV0aG9kICE9PSBjb25uZWN0LkNsaWVudE1ldGhvZHMuUkVKRUNUX0NPTlRBQ1QgJiYKICAgICAgICAgbWV0aG9kICE9PSBjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX1RBU0tfQ09OVEFDVDsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZVBhcmFtcyA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zKSB7CiAgICAgIHN3aXRjaCAobWV0aG9kKSB7CiAgICAgICAgIGNhc2UgY29ubmVjdC5DbGllbnRNZXRob2RzLlVQREFURV9BR0VOVF9DT05GSUdVUkFUSU9OOgogICAgICAgICAgICBwYXJhbXMuY29uZmlndXJhdGlvbiA9IHRoaXMuX3RyYW5zbGF0ZUFnZW50Q29uZmlndXJhdGlvbihwYXJhbXMuY29uZmlndXJhdGlvbik7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgY2FzZSBjb25uZWN0LkNsaWVudE1ldGhvZHMuU0VORF9TT0ZUUEhPTkVfQ0FMTF9NRVRSSUNTOgogICAgICAgICAgICBwYXJhbXMuc29mdHBob25lU3RyZWFtU3RhdGlzdGljcyA9IHRoaXMuX3RyYW5zbGF0ZVNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MoCiAgICAgICAgICAgICAgICAgIHBhcmFtcy5zb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICBjYXNlIGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX1NPRlRQSE9ORV9DQUxMX1JFUE9SVDoKICAgICAgICAgICAgcGFyYW1zLnJlcG9ydCA9IHRoaXMuX3RyYW5zbGF0ZVNvZnRwaG9uZUNhbGxSZXBvcnQocGFyYW1zLnJlcG9ydCk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgYnJlYWs7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9yZXF1aXJlc0F1dGhlbnRpY2F0aW9uUGFyYW0obWV0aG9kKSkgewogICAgICAgICBwYXJhbXMuYXV0aGVudGljYXRpb24gPSB7CiAgICAgICAgICAgIGF1dGhUb2tlbjogdGhpcy5hdXRoVG9rZW4KICAgICAgICAgfTsKICAgICAgfQoKICAgICAgcmV0dXJuIHBhcmFtczsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZUFnZW50Q29uZmlndXJhdGlvbiA9IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICByZXR1cm4gewogICAgICAgICBuYW1lOiBjb25maWcubmFtZSwKICAgICAgICAgc29mdHBob25lRW5hYmxlZDogY29uZmlnLnNvZnRwaG9uZUVuYWJsZWQsCiAgICAgICAgIHNvZnRwaG9uZUF1dG9BY2NlcHQ6IGNvbmZpZy5zb2Z0cGhvbmVBdXRvQWNjZXB0LAogICAgICAgICBleHRlbnNpb246IGNvbmZpZy5leHRlbnNpb24sCiAgICAgICAgIHJvdXRpbmdQcm9maWxlOiB0aGlzLl90cmFuc2xhdGVSb3V0aW5nUHJvZmlsZShjb25maWcucm91dGluZ1Byb2ZpbGUpLAogICAgICAgICBhZ2VudFByZWZlcmVuY2VzOiBjb25maWcuYWdlbnRQcmVmZXJlbmNlcwogICAgICB9OwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlUm91dGluZ1Byb2ZpbGUgPSBmdW5jdGlvbihwcm9maWxlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgIG5hbWU6IHByb2ZpbGUubmFtZSwKICAgICAgICAgcm91dGluZ1Byb2ZpbGVBUk46IHByb2ZpbGUucm91dGluZ1Byb2ZpbGVBUk4sCiAgICAgICAgIGRlZmF1bHRPdXRib3VuZFF1ZXVlOiB0aGlzLl90cmFuc2xhdGVRdWV1ZShwcm9maWxlLmRlZmF1bHRPdXRib3VuZFF1ZXVlKQogICAgICB9OwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlUXVldWUgPSBmdW5jdGlvbihxdWV1ZSkgewogICAgICByZXR1cm4gewogICAgICAgICBxdWV1ZUFSTjogICBxdWV1ZS5xdWV1ZUFSTiwKICAgICAgICAgbmFtZTogICAgICAgcXVldWUubmFtZQogICAgICB9OwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlU29mdHBob25lU3RyZWFtU3RhdGlzdGljcyA9IGZ1bmN0aW9uKHN0YXRzKSB7CiAgICAgIHN0YXRzLmZvckVhY2goZnVuY3Rpb24oc3RhdCkgewogICAgICAgICBpZiAoJ3BhY2tldHNDb3VudCcgaW4gc3RhdCkgewogICAgICAgICAgICBzdGF0LnBhY2tldENvdW50ID0gc3RhdC5wYWNrZXRzQ291bnQ7CiAgICAgICAgICAgIGRlbGV0ZSBzdGF0LnBhY2tldHNDb3VudDsKICAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHJldHVybiBzdGF0czsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZVNvZnRwaG9uZUNhbGxSZXBvcnQgPSBmdW5jdGlvbihyZXBvcnQpIHsKICAgICAgaWYgKCdoYW5kc2hha2luZ1RpbWVNaWxsaXMnIGluIHJlcG9ydCkgewogICAgICAgICByZXBvcnQuaGFuZHNoYWtlVGltZU1pbGxpcyA9IHJlcG9ydC5oYW5kc2hha2luZ1RpbWVNaWxsaXM7CiAgICAgICAgIGRlbGV0ZSByZXBvcnQuaGFuZHNoYWtpbmdUaW1lTWlsbGlzOwogICAgICB9CgogICAgICBpZiAoJ3ByZVRhbGtpbmdUaW1lTWlsbGlzJyBpbiByZXBvcnQpIHsKICAgICAgICAgcmVwb3J0LnByZVRhbGtUaW1lTWlsbGlzID0gcmVwb3J0LnByZVRhbGtpbmdUaW1lTWlsbGlzOwogICAgICAgICBkZWxldGUgcmVwb3J0LnByZVRhbGtpbmdUaW1lTWlsbGlzOwogICAgICB9CgogICAgICBpZiAoJ2hhbmRzaGFraW5nRmFpbHVyZScgaW4gcmVwb3J0KSB7CiAgICAgICAgIHJlcG9ydC5oYW5kc2hha2VGYWlsdXJlID0gcmVwb3J0LmhhbmRzaGFraW5nRmFpbHVyZTsKICAgICAgICAgZGVsZXRlIHJlcG9ydC5oYW5kc2hha2luZ0ZhaWx1cmU7CiAgICAgIH0KCiAgICAgIGlmICgndGFsa2luZ1RpbWVNaWxsaXMnIGluIHJlcG9ydCkgewogICAgICAgICByZXBvcnQudGFsa1RpbWVNaWxsaXMgPSByZXBvcnQudGFsa2luZ1RpbWVNaWxsaXM7CiAgICAgICAgIGRlbGV0ZSByZXBvcnQudGFsa2luZ1RpbWVNaWxsaXM7CiAgICAgIH0KCiAgICAgIHJlcG9ydC5zb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzID0gdGhpcy5fdHJhbnNsYXRlU29mdHBob25lU3RyZWFtU3RhdGlzdGljcygKICAgICAgICAgICAgcmVwb3J0LnNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MpOwoKICAgICAgcmV0dXJuIHJlcG9ydDsKICAgfTsKCiAgIGNvbm5lY3QuQ2xpZW50QmFzZSA9IENsaWVudEJhc2U7CiAgIGNvbm5lY3QuTnVsbENsaWVudCA9IE51bGxDbGllbnQ7CiAgIGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0Q2xpZW50ID0gVXBzdHJlYW1Db25kdWl0Q2xpZW50OwogICBjb25uZWN0LlVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudCA9IFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudDsKICAgY29ubmVjdC5BV1NDbGllbnQgPSBBV1NDbGllbnQ7Cgp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uKCkgewogICB2YXIgZ2xvYmFsID0gdGhpczsKICAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogR3JhcGhMaW5rIDw8YWJzdHJhY3QgY2xhc3M+PgogICAgKgogICAgKiBSZXByZXNlbnRzIHRoZSBhc3NvY2lhdGlvbiBvZiBvbmUgb3IgbW9yZSBhdHRyaWJ1dGVzIHRvIGEgc3RhdGUgdHJhbnNpdGlvbi4KICAgICovCiAgIHZhciBHcmFwaExpbmsgPSBmdW5jdGlvbihmcm9tU3RhdGUsIHRvU3RhdGUpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGZyb21TdGF0ZSwgJ2Zyb21TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9TdGF0ZSwgJ3RvU3RhdGUnKTsKICAgICAgdGhpcy5mcm9tU3RhdGUgPSBmcm9tU3RhdGU7CiAgICAgIHRoaXMudG9TdGF0ZSA9IHRvU3RhdGU7CiAgIH07CgogICBHcmFwaExpbmsucHJvdG90eXBlLmdldEFzc29jaWF0aW9ucyA9IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgdGhyb3cgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7CiAgIH07CgogICBHcmFwaExpbmsucHJvdG90eXBlLmdldEZyb21TdGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5mcm9tU3RhdGU7CiAgIH07CgogICBHcmFwaExpbmsucHJvdG90eXBlLmdldFRvU3RhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMudG9TdGF0ZTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogRGlyZWN0R3JhcGhMaW5rIDw8Y29uY3JldGUgY2xhc3M+PiBleHRlbmRzIEdyYXBoTGluawogICAgKgogICAgKiBSZXByZXNlbnRzIHRoZSBieS12YWx1ZSByZXByZXNlbnRhdGlvbiBvZiBvbmUgb3IgbW9yZSBhdHRyaWJ1dGVzIHRvIGEKICAgICogc3RhdGUgdHJhbnNpdGlvbi4KICAgICovCiAgIHZhciBEaXJlY3RHcmFwaExpbmsgPSBmdW5jdGlvbihmcm9tU3RhdGUsIHRvU3RhdGUsIGFzc29jaWF0aW9ucykgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZnJvbVN0YXRlLCAnZnJvbVN0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b1N0YXRlLCAndG9TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoYXNzb2NpYXRpb25zLCAnYXNzb2NpYXRpb25zJyk7CiAgICAgIEdyYXBoTGluay5jYWxsKHRoaXMsIGZyb21TdGF0ZSwgdG9TdGF0ZSk7CiAgICAgIHRoaXMuYXNzb2NpYXRpb25zID0gYXNzb2NpYXRpb25zOwogICB9OwogICBEaXJlY3RHcmFwaExpbmsucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShHcmFwaExpbmsucHJvdG90eXBlKTsKICAgRGlyZWN0R3JhcGhMaW5rLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IERpcmVjdEdyYXBoTGluazsKCiAgIERpcmVjdEdyYXBoTGluay5wcm90b3R5cGUuZ2V0QXNzb2NpYXRpb25zID0gZnVuY3Rpb24oY29udGV4dCkgewogICAgICByZXR1cm4gdGhpcy5hc3NvY2lhdGlvbnM7CiAgIH07CgogICAvKioKICAgICogRnVuY3Rpb25hbEdyYXBoTGluayA8PGNvbmNyZXRlIGNsYXNzPj4gZXh0ZW5kcyBHcmFwaExpbmsKICAgICoKICAgICogUmVwcmVzZW50cyBhIGZ1bmN0aW9uYWwgYXNzb2NpYXRpb24gb2Ygb25lIG9yIG1vcmUgYXR0cmlidXRlcyB0byBhCiAgICAqIHN0YXRlIHRyYW5zaXRpb24uCiAgICAqLwogICB2YXIgRnVuY3Rpb25hbEdyYXBoTGluayA9IGZ1bmN0aW9uKGZyb21TdGF0ZSwgdG9TdGF0ZSwgY2xvc3VyZSkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZnJvbVN0YXRlLCAnZnJvbVN0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b1N0YXRlLCAndG9TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY2xvc3VyZSwgJ2Nsb3N1cmUnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjbG9zdXJlKSwgJ2Nsb3N1cmUgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIEdyYXBoTGluay5jYWxsKHRoaXMsIGZyb21TdGF0ZSwgdG9TdGF0ZSk7CiAgICAgIHRoaXMuY2xvc3VyZSA9IGNsb3N1cmU7CiAgIH07CiAgIEZ1bmN0aW9uYWxHcmFwaExpbmsucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShHcmFwaExpbmsucHJvdG90eXBlKTsKICAgRnVuY3Rpb25hbEdyYXBoTGluay5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBGdW5jdGlvbmFsR3JhcGhMaW5rOwoKICAgRnVuY3Rpb25hbEdyYXBoTGluay5wcm90b3R5cGUuZ2V0QXNzb2NpYXRpb25zID0gZnVuY3Rpb24oY29udGV4dCkgewogICAgICByZXR1cm4gdGhpcy5jbG9zdXJlKGNvbnRleHQsIHRoaXMuZ2V0RnJvbVN0YXRlKCksIHRoaXMuZ2V0VG9TdGF0ZSgpKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogRXZlbnRHcmFwaCA8PGNsYXNzPj4KICAgICoKICAgICogQnVpbGRzIGEgbWFwIG9mIGFzc29jaWF0aW9ucyBmcm9tIG9uZSBzdGF0ZSB0byBhbm90aGVyIGluIGNvbnRleHQgb2YgYQogICAgKiBwYXJ0aWN1bGFyIG9iamVjdC4gIFRoZSBhc3NvY2lhdGlvbnMgY2FuIGJlIGRpcmVjdCAob25lIG9yIG1vcmUgdmFsdWVzKQogICAgKiBvciBmdW5jdGlvbmFsIChhIG1ldGhvZCByZXR1cm5pbmcgb25lIG9yIG1vcmUgdmFsdWVzKSwgYW5kIGFyZSB1c2VkIHRvCiAgICAqIHByb3ZpZGUgYWRkaXRpb25hbCBjb250ZXh0dWFsIGV2ZW50IGhvb2tzIGZvciB0aGUgVUkgdG8gY29uc3VtZS4KICAgICovCiAgIHZhciBFdmVudEdyYXBoID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuZnJvbU1hcCA9IHt9OwogICB9OwogICBFdmVudEdyYXBoLkFOWSA9ICI8PGFueT4+IjsKCiAgIEV2ZW50R3JhcGgucHJvdG90eXBlLmFzc29jID0gZnVuY3Rpb24oZnJvbVN0YXRlT2JqLCB0b1N0YXRlT2JqLCBhc3NvY09iaikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICBpZiAoISBmcm9tU3RhdGVPYmopIHsKICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJmcm9tU3RhdGVPYmogaXMgbm90IGRlZmluZWQuIik7CiAgICAgIH0KCiAgICAgIGlmICghIHRvU3RhdGVPYmopIHsKICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ0b1N0YXRlT2JqIGlzIG5vdCBkZWZpbmVkLiIpOwogICAgICB9CgogICAgICBpZiAoISBhc3NvY09iaikgewogICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImFzc29jT2JqIGlzIG5vdCBkZWZpbmVkLiIpOwogICAgICB9CgogICAgICBpZiAoZnJvbVN0YXRlT2JqIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgZnJvbVN0YXRlT2JqLmZvckVhY2goZnVuY3Rpb24oZnJvbVN0YXRlKSB7CiAgICAgICAgICAgIHNlbGYuYXNzb2MoZnJvbVN0YXRlLCB0b1N0YXRlT2JqLCBhc3NvY09iaik7CiAgICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKHRvU3RhdGVPYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICB0b1N0YXRlT2JqLmZvckVhY2goZnVuY3Rpb24odG9TdGF0ZSkgewogICAgICAgICAgICBzZWxmLmFzc29jKGZyb21TdGF0ZU9iaiwgdG9TdGF0ZSwgYXNzb2NPYmopOwogICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAgaWYgKHR5cGVvZiBhc3NvY09iaiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aGlzLl9hZGRBc3NvY2lhdGlvbihuZXcgRnVuY3Rpb25hbEdyYXBoTGluayhmcm9tU3RhdGVPYmosIHRvU3RhdGVPYmosIGFzc29jT2JqKSk7CiAgICAgICAgIH0gZWxzZSBpZiAoYXNzb2NPYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICAgICB0aGlzLl9hZGRBc3NvY2lhdGlvbihuZXcgRGlyZWN0R3JhcGhMaW5rKGZyb21TdGF0ZU9iaiwgdG9TdGF0ZU9iaiwgYXNzb2NPYmopKTsKICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fYWRkQXNzb2NpYXRpb24obmV3IERpcmVjdEdyYXBoTGluayhmcm9tU3RhdGVPYmosIHRvU3RhdGVPYmosIFthc3NvY09ial0pKTsKICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICB9OwoKICAgRXZlbnRHcmFwaC5wcm90b3R5cGUuZ2V0QXNzb2NpYXRpb25zID0gZnVuY3Rpb24oY29udGV4dCwgZnJvbVN0YXRlLCB0b1N0YXRlKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmcm9tU3RhdGUsICdmcm9tU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvU3RhdGUsICd0b1N0YXRlJyk7CiAgICAgIHZhciBhc3NvY2lhdGlvbnMgPSBbXTsKCiAgICAgIHZhciB0b01hcEZyb21BbnkgPSB0aGlzLmZyb21NYXBbRXZlbnRHcmFwaC5BTlldIHx8IHt9OwogICAgICB2YXIgdG9NYXAgPSB0aGlzLmZyb21NYXBbZnJvbVN0YXRlXSB8fCB7fTsKCiAgICAgIGFzc29jaWF0aW9ucyA9IGFzc29jaWF0aW9ucy5jb25jYXQodGhpcy5fZ2V0QXNzb2NpYXRpb25zRnJvbU1hcCgKICAgICAgICAgICAgICAgdG9NYXBGcm9tQW55LCBjb250ZXh0LCBmcm9tU3RhdGUsIHRvU3RhdGUpKTsKICAgICAgYXNzb2NpYXRpb25zID0gYXNzb2NpYXRpb25zLmNvbmNhdCh0aGlzLl9nZXRBc3NvY2lhdGlvbnNGcm9tTWFwKAogICAgICAgICAgICAgICB0b01hcCwgY29udGV4dCwgZnJvbVN0YXRlLCB0b1N0YXRlKSk7CgogICAgICByZXR1cm4gYXNzb2NpYXRpb25zOwogICB9OwoKICAgRXZlbnRHcmFwaC5wcm90b3R5cGUuX2FkZEFzc29jaWF0aW9uID0gZnVuY3Rpb24oYXNzb2MpIHsKICAgICAgdmFyIHRvTWFwID0gdGhpcy5mcm9tTWFwW2Fzc29jLmdldEZyb21TdGF0ZSgpXTsKCiAgICAgIGlmICghIHRvTWFwKSB7CiAgICAgICAgIHRvTWFwID0gdGhpcy5mcm9tTWFwW2Fzc29jLmdldEZyb21TdGF0ZSgpXSA9IHt9OwogICAgICB9CgogICAgICB2YXIgYXNzb2NMaXN0ID0gdG9NYXBbYXNzb2MuZ2V0VG9TdGF0ZSgpXTsKCiAgICAgIGlmICghIGFzc29jTGlzdCkgewogICAgICAgICBhc3NvY0xpc3QgPSB0b01hcFthc3NvYy5nZXRUb1N0YXRlKCldID0gW107CiAgICAgIH0KCiAgICAgIGFzc29jTGlzdC5wdXNoKGFzc29jKTsKICAgfTsKCiAgIEV2ZW50R3JhcGgucHJvdG90eXBlLl9nZXRBc3NvY2lhdGlvbnNGcm9tTWFwID0gZnVuY3Rpb24obWFwLCBjb250ZXh0LCBmcm9tU3RhdGUsIHRvU3RhdGUpIHsKICAgICAgdmFyIGFzc29jTGlzdCA9IChtYXBbRXZlbnRHcmFwaC5BTlldIHx8IFtdKS5jb25jYXQobWFwW3RvU3RhdGVdIHx8IFtdKTsKICAgICAgcmV0dXJuIGFzc29jTGlzdC5yZWR1Y2UoZnVuY3Rpb24ocHJldiwgYXNzb2MpIHsKICAgICAgICAgcmV0dXJuIHByZXYuY29uY2F0KGFzc29jLmdldEFzc29jaWF0aW9ucyhjb250ZXh0KSk7CiAgICAgIH0sIFtdKTsKICAgfTsKCiAgIGNvbm5lY3QuRXZlbnRHcmFwaCA9IEV2ZW50R3JhcGg7Cgp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBBZ2VudFN0YXRlVHlwZQogICAqLwogIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdyb3V0YWJsZScsCiAgICAnbm90X3JvdXRhYmxlJywKICAgICdvZmZsaW5lJwogIF0pOwogIGNvbm5lY3QuQWdlbnRTdGF0dXNUeXBlID0gY29ubmVjdC5BZ2VudFN0YXRlVHlwZTsKCiAgLyoqCiAgICogZW51bSBBZ2VudEF2YWlsU3RhdGVzCiAgICovCiAgY29ubmVjdC5BZ2VudEF2YWlsU3RhdGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnSW5pdCcsCiAgICAnQnVzeScsCiAgICAnQWZ0ZXJDYWxsV29yaycsCiAgICAnQ2FsbGluZ0N1c3RvbWVyJywKICAgICdEaWFsaW5nJywKICAgICdKb2luaW5nJywKICAgICdQZW5kaW5nQXZhaWxhYmxlJywKICAgICdQZW5kaW5nQnVzeScKICBdKTsKCiAgLyoqCiAgICogZW51bSBBZ2VudEVycm9yU3RhdGVzCiAgICovCiAgY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnRXJyb3InLAogICAgJ0FnZW50SHVuZ1VwJywKICAgICdCYWRBZGRyZXNzQWdlbnQnLAogICAgJ0JhZEFkZHJlc3NDdXN0b21lcicsCiAgICAnRGVmYXVsdCcsCiAgICAnRmFpbGVkQ29ubmVjdEFnZW50JywKICAgICdGYWlsZWRDb25uZWN0Q3VzdG9tZXInLAogICAgJ0xpbmVFbmdhZ2VkQWdlbnQnLAogICAgJ0xpbmVFbmdhZ2VkQ3VzdG9tZXInLAogICAgJ01pc3NlZENhbGxBZ2VudCcsCiAgICAnTWlzc2VkQ2FsbEN1c3RvbWVyJywKICAgICdNdWx0aXBsZUNjcFdpbmRvd3MnLAogICAgJ1JlYWx0aW1lQ29tbXVuaWNhdGlvbkVycm9yJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIEFkZHJlc3NUeXBlCiAgICovCiAgY29ubmVjdC5FbmRwb2ludFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdwaG9uZV9udW1iZXInLAogICAgJ2FnZW50JywKICAgICdxdWV1ZScKICBdKTsKICBjb25uZWN0LkFkZHJlc3NUeXBlID0gY29ubmVjdC5FbmRwb2ludFR5cGU7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29ubmVjdGlvblR5cGUKICAgKi8KICBjb25uZWN0LkNvbm5lY3Rpb25UeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnYWdlbnQnLAogICAgJ2luYm91bmQnLAogICAgJ291dGJvdW5kJywKICAgICdtb25pdG9yaW5nJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIENvbm5lY3Rpb25TdGF0ZVR5cGUKICAgKi8KICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ2hvbGQnLAogICAgJ2Rpc2Nvbm5lY3RlZCcKICBdKTsKICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0dXNUeXBlID0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlOwoKICBjb25uZWN0LkNPTk5FQ1RJT05fQUNUSVZFX1NUQVRFUyA9IGNvbm5lY3Quc2V0KFsKICAgIGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNUSU5HLAogICAgY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RFRCwKICAgIGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5IT0xECiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdFN0YXRlVHlwZQogICAqLwogIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2luaXQnLAogICAgJ2luY29taW5nJywKICAgICdwZW5kaW5nJywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ21pc3NlZCcsCiAgICAnZXJyb3InLAogICAgJ2VuZGVkJwogIF0pOwogIGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUgPSBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGU7CgogIGNvbm5lY3QuQ09OVEFDVF9BQ1RJVkVfU1RBVEVTID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5jb21pbmcnLAogICAgJ3BlbmRpbmcnLAogICAgJ2Nvbm5lY3RpbmcnLAogICAgJ2Nvbm5lY3RlZCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBDb250YWN0VHlwZQogICAqLwogIGNvbm5lY3QuQ29udGFjdFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICd2b2ljZScsCiAgICAncXVldWVfY2FsbGJhY2snLAogICAgJ2NoYXQnLAogICAgJ3Rhc2snCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdEluaXRpYXRpb25NZXRob2QKICAgKi8KICBjb25uZWN0LkNvbnRhY3RJbml0aWF0aW9uTWV0aG9kID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5ib3VuZCcsCiAgICAnb3V0Ym91bmQnLAogICAgJ3RyYW5zZmVyJywKICAgICdxdWV1ZV90cmFuc2ZlcicsCiAgICAnY2FsbGJhY2snLAogICAgJ2FwaScsCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogZW51bSBDaGFubmVsVHlwZQogICovCiAgY29ubmVjdC5DaGFubmVsVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ1ZPSUNFJywKICAgICdDSEFUJywKICAgICdUQVNLJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIGVudW0gTWVkaWFUeXBlCiAgKi8KICBjb25uZWN0Lk1lZGlhVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ3NvZnRwaG9uZScsCiAgICAnY2hhdCcsCiAgICAndGFzaycKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBTb2Z0cGhvbmVDYWxsVHlwZQogICAqLwogIGNvbm5lY3QuU29mdHBob25lQ2FsbFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdhdWRpb192aWRlbycsCiAgICAndmlkZW9fb25seScsCiAgICAnYXVkaW9fb25seScsCiAgICAnbm9uZScKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgU29mdHBob25lRXJyb3JUeXBlcwogICAqLwogIGNvbm5lY3QuU29mdHBob25lRXJyb3JUeXBlcyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ3Vuc3VwcG9ydGVkX2Jyb3dzZXInLAogICAgJ21pY3JvcGhvbmVfbm90X3NoYXJlZCcsCiAgICAnc2lnbmFsbGluZ19oYW5kc2hha2VfZmFpbHVyZScsCiAgICAnc2lnbmFsbGluZ19jb25uZWN0aW9uX2ZhaWx1cmUnLAogICAgJ2ljZV9jb2xsZWN0aW9uX3RpbWVvdXQnLAogICAgJ3VzZXJfYnVzeV9lcnJvcicsCiAgICAnd2VicnRjX2Vycm9yJywKICAgICdyZWFsdGltZV9jb21tdW5pY2F0aW9uX2Vycm9yJywKICAgICdvdGhlcicKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgQ1RJIGV4Y2VwdGlvbnMKICAgKi8KICBjb25uZWN0LkNUSUV4Y2VwdGlvbnMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJBY2Nlc3NEZW5pZWRFeGNlcHRpb24iLAogICAgIkludmFsaWRTdGF0ZUV4Y2VwdGlvbiIsCiAgICAiQmFkRW5kcG9pbnRFeGNlcHRpb24iLAogICAgIkludmFsaWRBZ2VudEFSTkV4Y2VwdGlvbiIsCiAgICAiSW52YWxpZENvbmZpZ3VyYXRpb25FeGNlcHRpb24iLAogICAgIkludmFsaWRDb250YWN0VHlwZUV4Y2VwdGlvbiIsCiAgICAiUGFnaW5hdGlvbkV4Y2VwdGlvbiIsCiAgICAiUmVmcmVzaFRva2VuRXhwaXJlZEV4Y2VwdGlvbiIsCiAgICAiU2VuZERhdGFGYWlsZWRFeGNlcHRpb24iLAogICAgIlVuYXV0aG9yaXplZEV4Y2VwdGlvbiIsCiAgICAiUXVvdGFFeGNlZWRlZEV4Y2VwdGlvbiIKICBdKTsKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBBZ2VudAogICAqLwogIHZhciBBZ2VudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCJUaGUgYWdlbnQgaXMgbm90IHlldCBpbml0aWFsaXplZCEiKTsKICAgIH0KICB9OwoKICBBZ2VudC5wcm90b3R5cGUuX2dldERhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0QWdlbnREYXRhKCk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLl9jcmVhdGVDb250YWN0QVBJID0gZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0RGF0YS5jb250YWN0SWQpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbkNvbnRhY3RQZW5kaW5nID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5DT05UQUNUX1BFTkRJTkcsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblJlZnJlc2ggPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLlJFRlJFU0gsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblJvdXRhYmxlID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5ST1VUQUJMRSwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uTm90Um91dGFibGUgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLk5PVF9ST1VUQUJMRSwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uT2ZmbGluZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuT0ZGTElORSwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uRXJyb3IgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLkVSUk9SLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25Tb2Z0cGhvbmVFcnJvciA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuU09GVFBIT05FX0VSUk9SLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25XZWJTb2NrZXRDb25uZWN0aW9uTG9zdCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuV0VCU09DS0VUX0NPTk5FQ1RJT05fTE9TVCwgZik7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUub25XZWJTb2NrZXRDb25uZWN0aW9uR2FpbmVkID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5XRUJTT0NLRVRfQ09OTkVDVElPTl9HQUlORUQsIGYpOwogIH0KCiAgQWdlbnQucHJvdG90eXBlLm9uQWZ0ZXJDYWxsV29yayA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuQUNXLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25TdGF0ZUNoYW5nZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuU1RBVEVfQ0hBTkdFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25NdXRlVG9nZ2xlID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5BZ2VudEV2ZW50cy5NVVRFX1RPR0dMRSwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uTG9jYWxNZWRpYVN0cmVhbUNyZWF0ZWQgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkFnZW50RXZlbnRzLkxPQ0FMX01FRElBX1NUUkVBTV9DUkVBVEVELCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUubXV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsCiAgICAgIHsKICAgICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuTVVURSwKICAgICAgICBkYXRhOiB7IG11dGU6IHRydWUgfQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUudW5tdXRlID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwKICAgICAgewogICAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5NVVRFLAogICAgICAgIGRhdGE6IHsgbXV0ZTogZmFsc2UgfQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNuYXBzaG90LnN0YXRlOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRBdmFpbGFiaWxpdHlTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc25hcHNob3QuYWdlbnRBdmFpbGFiaWxpdHlTdGF0ZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdHVzID0gQWdlbnQucHJvdG90eXBlLmdldFN0YXRlOwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdGVEdXJhdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0Lm5vdygpIC0gdGhpcy5fZ2V0RGF0YSgpLnNuYXBzaG90LnN0YXRlLnN0YXJ0VGltZXN0YW1wLmdldFRpbWUoKSArIGNvbm5lY3QuY29yZS5nZXRTa2V3KCk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldFN0YXR1c0R1cmF0aW9uID0gQWdlbnQucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb247CgogIEFnZW50LnByb3RvdHlwZS5nZXRQZXJtaXNzaW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5wZXJtaXNzaW9uczsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0Q29udGFjdHMgPSBmdW5jdGlvbiAoY29udGFjdFR5cGVGaWx0ZXIpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc25hcHNob3QuY29udGFjdHMubWFwKGZ1bmN0aW9uIChjb250YWN0RGF0YSkgewogICAgICByZXR1cm4gc2VsZi5fY3JlYXRlQ29udGFjdEFQSShjb250YWN0RGF0YSk7CiAgICB9KS5maWx0ZXIoZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgcmV0dXJuICghY29udGFjdFR5cGVGaWx0ZXIpIHx8IGNvbnRhY3QuZ2V0VHlwZSgpID09PSBjb250YWN0VHlwZUZpbHRlcjsKICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRDb25maWd1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb25maWd1cmF0aW9uOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRBZ2VudFN0YXRlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5hZ2VudFN0YXRlczsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0Um91dGluZ1Byb2ZpbGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25maWd1cmF0aW9uKCkucm91dGluZ1Byb2ZpbGU7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldENoYW5uZWxDb25jdXJyZW5jeSA9IGZ1bmN0aW9uIChjaGFubmVsKSB7CiAgICB2YXIgY2hhbm5lbENvbmN1cnJlbmN5TWFwID0gdGhpcy5nZXRSb3V0aW5nUHJvZmlsZSgpLmNoYW5uZWxDb25jdXJyZW5jeU1hcDsKICAgIGlmICghY2hhbm5lbENvbmN1cnJlbmN5TWFwKSB7CiAgICAgIGNoYW5uZWxDb25jdXJyZW5jeU1hcCA9IE9iamVjdC5rZXlzKGNvbm5lY3QuQ2hhbm5lbFR5cGUpLnJlZHVjZShmdW5jdGlvbiAoYWNjLCBrZXkpIHsKICAgICAgICAvLyBFeGNsdWRlIFRBU0sgZnJvbSBkZWZhdWx0IGNvbmN1cnJlbmN5LgogICAgICAgIGlmIChrZXkgIT09ICdUQVNLJykgewogICAgICAgICAgYWNjW2Nvbm5lY3QuQ2hhbm5lbFR5cGVba2V5XV0gPSAxOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYWNjOwogICAgICB9LCB7fSk7CiAgICB9CiAgICByZXR1cm4gY2hhbm5lbAogICAgICA/IChjaGFubmVsQ29uY3VycmVuY3lNYXBbY2hhbm5lbF0gfHwgMCkKICAgICAgOiBjaGFubmVsQ29uY3VycmVuY3lNYXA7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldE5hbWUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25maWd1cmF0aW9uKCkubmFtZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0RXh0ZW5zaW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLmV4dGVuc2lvbjsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0RGlhbGFibGVDb3VudHJpZXMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25maWd1cmF0aW9uKCkuZGlhbGFibGVDb3VudHJpZXM7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmlzU29mdHBob25lRW5hYmxlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5zb2Z0cGhvbmVFbmFibGVkOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRDb25maWd1cmF0aW9uID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24sIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5VUERBVEVfQUdFTlRfQ09ORklHVVJBVElPTiwgewogICAgICBjb25maWd1cmF0aW9uOiBjb25uZWN0LmFzc2VydE5vdE51bGwoY29uZmlndXJhdGlvbiwgJ2NvbmZpZ3VyYXRpb24nKQogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAvLyBXZSBuZWVkIHRvIGFzayB0aGUgc2hhcmVkIHdvcmtlciB0byByZWxvYWQgYWdlbnQgY29uZmlnCiAgICAgICAgICAvLyBvbmNlIHdlIGNoYW5nZSBpdCBzbyBldmVyeSB0YWIgaGFzIGFjY3VyYXRlIGNvbmZpZy4KICAgICAgICAgIHZhciBjb25kdWl0ID0gY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCk7CiAgICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5SRUxPQURfQUdFTlRfQ09ORklHVVJBVElPTik7CgogICAgICAgICAgaWYgKGNhbGxiYWNrcy5zdWNjZXNzKSB7CiAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlCiAgICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRTdGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlBVVF9BR0VOVF9TVEFURSwgewogICAgICBzdGF0ZTogY29ubmVjdC5hc3NlcnROb3ROdWxsKHN0YXRlLCAnc3RhdGUnKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuc2V0U3RhdHVzID0gQWdlbnQucHJvdG90eXBlLnNldFN0YXRlOwoKICBBZ2VudC5wcm90b3R5cGUuY29ubmVjdCA9IGZ1bmN0aW9uIChlbmRwb2ludEluLCBwYXJhbXMpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgZW5kcG9pbnQgPSBuZXcgY29ubmVjdC5FbmRwb2ludChlbmRwb2ludEluKTsKICAgIC8vIEhhdmUgdG8gcmVtb3ZlIHRoZSBlbmRwb2ludElkIGZpZWxkIG9yIEFXUyBKUyBTREsgZ2V0cyBtYWQuCiAgICBkZWxldGUgZW5kcG9pbnQuZW5kcG9pbnRJZDsKCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX09VVEJPVU5EX0NPTlRBQ1QsIHsKICAgICAgZW5kcG9pbnQ6IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChlbmRwb2ludCwgJ2VuZHBvaW50JyksCiAgICAgIHF1ZXVlQVJOOiAocGFyYW1zICYmIChwYXJhbXMucXVldWVBUk4gfHwgcGFyYW1zLnF1ZXVlSWQpKSB8fCB0aGlzLmdldFJvdXRpbmdQcm9maWxlKCkuZGVmYXVsdE91dGJvdW5kUXVldWUucXVldWVBUk4KICAgIH0sIHBhcmFtcyAmJiB7CiAgICAgICAgc3VjY2VzczogcGFyYW1zLnN1Y2Nlc3MsCiAgICAgICAgZmFpbHVyZTogcGFyYW1zLmZhaWx1cmUKICAgICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmNyZWF0ZVRhc2sgPSBmdW5jdGlvbih0YXNrQ29udGFjdCwgY2FsbGJhY2tzKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodGFza0NvbnRhY3QsICdUYXNrIGNvbnRhY3Qgb2JqZWN0Jyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodGFza0NvbnRhY3QubmFtZSwgJ1Rhc2sgbmFtZScpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRhc2tDb250YWN0LmVuZHBvaW50LCAnVGFzayBlbmRwb2ludCcpOwoKICAgIHRhc2tDb250YWN0LmlkZW1wb3RlbmN5VG9rZW4gPSBBV1MudXRpbC51dWlkLnY0KCk7CiAgICBkZWxldGUgdGFza0NvbnRhY3QuZW5kcG9pbnQuZW5kcG9pbnRJZDsKCiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfVEFTS19DT05UQUNULCB0YXNrQ29udGFjdCwgY2FsbGJhY2tzKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0QWxsUXVldWVBUk5zID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnJvdXRpbmdQcm9maWxlLnF1ZXVlcy5tYXAoZnVuY3Rpb24gKHF1ZXVlKSB7CiAgICAgIHJldHVybiBxdWV1ZS5xdWV1ZUFSTjsKICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRFbmRwb2ludHMgPSBmdW5jdGlvbiAocXVldWVBUk5zLCBjYWxsYmFja3MsIHBhZ2VJbmZvSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY2FsbGJhY2tzLCAiY2FsbGJhY2tzIik7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY2FsbGJhY2tzLnN1Y2Nlc3MsICJjYWxsYmFja3Muc3VjY2VzcyIpOwogICAgdmFyIHBhZ2VJbmZvID0gcGFnZUluZm9JbiB8fCB7IH07CgogICAgcGFnZUluZm8uZW5kcG9pbnRzID0gcGFnZUluZm8uZW5kcG9pbnRzIHx8IFtdOwogICAgcGFnZUluZm8ubWF4UmVzdWx0cyA9IHBhZ2VJbmZvLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkgYWxsb3dpbmcgYSBzaW5nbGUgcXVldWVBUk4gdG8gYmUgc3BlY2lmaWVkCiAgICAvLyBpbnN0ZWFkIG9mIGFuIGFycmF5LgogICAgaWYgKCFjb25uZWN0LmlzQXJyYXkocXVldWVBUk5zKSkgewogICAgICBxdWV1ZUFSTnMgPSBbcXVldWVBUk5zXTsKICAgIH0KCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0VORFBPSU5UUywgewogICAgICBxdWV1ZUFSTnM6IHF1ZXVlQVJOcywKICAgICAgbmV4dFRva2VuOiBwYWdlSW5mby5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFnZUluZm8ubWF4UmVzdWx0cwogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5nZXRFbmRwb2ludHMocXVldWVBUk5zLCBjYWxsYmFja3MsIHsKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhZ2VJbmZvLm1heFJlc3VsdHMsCiAgICAgICAgICAgICAgZW5kcG9pbnRzOiBwYWdlSW5mby5lbmRwb2ludHMuY29uY2F0KGRhdGEuZW5kcG9pbnRzKQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhZ2VJbmZvLmVuZHBvaW50cyA9IHBhZ2VJbmZvLmVuZHBvaW50cy5jb25jYXQoZGF0YS5lbmRwb2ludHMpOwogICAgICAgICAgICB2YXIgZW5kcG9pbnRzID0gcGFnZUluZm8uZW5kcG9pbnRzLm1hcChmdW5jdGlvbiAoZW5kcG9pbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuRW5kcG9pbnQoZW5kcG9pbnQpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKHsKICAgICAgICAgICAgICBlbmRwb2ludHM6IGVuZHBvaW50cywKICAgICAgICAgICAgICBhZGRyZXNzZXM6IGVuZHBvaW50cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGNhbGxiYWNrcy5mYWlsdXJlCiAgICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRBZGRyZXNzZXMgPSBBZ2VudC5wcm90b3R5cGUuZ2V0RW5kcG9pbnRzOwoKICBBZ2VudC5wcm90b3R5cGUudG9TbmFwc2hvdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5BZ2VudFNuYXBzaG90KHRoaXMuX2dldERhdGEoKSk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQWdlbnRTbmFwc2hvdAogICAqLwogIHZhciBBZ2VudFNuYXBzaG90ID0gZnVuY3Rpb24gKGFnZW50RGF0YSkgewogICAgY29ubmVjdC5BZ2VudC5jYWxsKHRoaXMpOwogICAgdGhpcy5hZ2VudERhdGEgPSBhZ2VudERhdGE7CiAgfTsKICBBZ2VudFNuYXBzaG90LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQWdlbnQucHJvdG90eXBlKTsKICBBZ2VudFNuYXBzaG90LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEFnZW50U25hcHNob3Q7CgogIEFnZW50U25hcHNob3QucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuYWdlbnREYXRhOwogIH07CgogIEFnZW50U25hcHNob3QucHJvdG90eXBlLl9jcmVhdGVDb250YWN0QVBJID0gZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ29udGFjdFNuYXBzaG90KGNvbnRhY3REYXRhKTsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBDb250YWN0CiAgICovCiAgdmFyIENvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICB0aGlzLmNvbnRhY3RJZCA9IGNvbnRhY3RJZDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmdldENvbnRhY3RJZCgpKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5fY3JlYXRlQ29ubmVjdGlvbkFQSSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uRGF0YSkgewogICAgaWYgKHRoaXMuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLkNIQVQpIHsKICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LkNoYXRDb25uZWN0aW9uKHRoaXMuY29udGFjdElkLCBjb25uZWN0aW9uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgfSBlbHNlIGlmICh0aGlzLmdldFR5cGUoKSA9PT0gY29ubmVjdC5Db250YWN0VHlwZS5UQVNLKSB7CiAgICAgIHJldHVybiBuZXcgY29ubmVjdC5UYXNrQ29ubmVjdGlvbih0aGlzLmNvbnRhY3RJZCwgY29ubmVjdGlvbkRhdGEuY29ubmVjdGlvbklkKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBuZXcgY29ubmVjdC5Wb2ljZUNvbm5lY3Rpb24odGhpcy5jb250YWN0SWQsIGNvbm5lY3Rpb25EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICB9CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0RXZlbnROYW1lID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGV2ZW50TmFtZSwgdGhpcy5nZXRDb250YWN0SWQoKSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25SZWZyZXNoID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLlJFRlJFU0gpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkluY29taW5nID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLklOQ09NSU5HKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25Db25uZWN0aW5nID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkNPTk5FQ1RJTkcpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vblBlbmRpbmcgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuUEVORElORyksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uQWNjZXB0ZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbk1pc3NlZCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkVuZGVkID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkVOREVEKSwgZik7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5ERVNUUk9ZRUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkRlc3Ryb3kgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuREVTVFJPWUVEKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25BQ1cgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNXKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25Db25uZWN0ZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQ09OTkVDVEVEKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25FcnJvciA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5FUlJPUiksIGYpOwogIH0KCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29udGFjdElkOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldE9yaWdpbmFsQ29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5pbml0aWFsQ29udGFjdElkOwogIH07CiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0SW5pdGlhbENvbnRhY3RJZCA9IENvbnRhY3QucHJvdG90eXBlLmdldE9yaWdpbmFsQ29udGFjdElkOwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS50eXBlOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENvbnRhY3REdXJhdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb250YWN0RHVyYXRpb247CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc3RhdGU7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdHVzID0gQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdGU7CgogIENvbnRhY3QucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5ub3coKSAtIHRoaXMuX2dldERhdGEoKS5zdGF0ZS50aW1lc3RhbXAuZ2V0VGltZSgpICsgY29ubmVjdC5jb3JlLmdldFNrZXcoKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0dXNEdXJhdGlvbiA9IENvbnRhY3QucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb247CgogIENvbnRhY3QucHJvdG90eXBlLmdldFF1ZXVlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5xdWV1ZTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRRdWV1ZVRpbWVzdGFtcCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkucXVldWVUaW1lc3RhbXA7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNvbm5lY3Rpb25zLm1hcChmdW5jdGlvbiAoY29ubkRhdGEpIHsKICAgICAgaWYgKHNlbGYuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLkNIQVQpIHsKICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ2hhdENvbm5lY3Rpb24oc2VsZi5jb250YWN0SWQsIGNvbm5EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICAgIH0gZWxzZSBpZiAoc2VsZi5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29udGFjdFR5cGUuVEFTSykgewogICAgICAgIHJldHVybiBuZXcgY29ubmVjdC5UYXNrQ29ubmVjdGlvbihzZWxmLmNvbnRhY3RJZCwgY29ubkRhdGEuY29ubmVjdGlvbklkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuVm9pY2VDb25uZWN0aW9uKHNlbGYuY29udGFjdElkLCBjb25uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgICB9CiAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRJbml0aWFsQ29ubmVjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmZpbmQodGhpcy5nZXRDb25uZWN0aW9ucygpLCBmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubi5pc0luaXRpYWxDb25uZWN0aW9uKCk7CiAgICB9KSB8fCBudWxsOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldEFjdGl2ZUluaXRpYWxDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGluaXRpYWxDb25uID0gdGhpcy5nZXRJbml0aWFsQ29ubmVjdGlvbigpOwogICAgaWYgKGluaXRpYWxDb25uICE9IG51bGwgJiYgaW5pdGlhbENvbm4uaXNBY3RpdmUoKSkgewogICAgICByZXR1cm4gaW5pdGlhbENvbm47CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRUaGlyZFBhcnR5Q29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25uZWN0aW9ucygpLmZpbHRlcihmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gIWNvbm4uaXNJbml0aWFsQ29ubmVjdGlvbigpICYmIGNvbm4uZ2V0VHlwZSgpICE9PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLkFHRU5UOwogICAgfSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0U2luZ2xlQWN0aXZlVGhpcmRQYXJ0eUNvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRUaGlyZFBhcnR5Q29ubmVjdGlvbnMoKS5maWx0ZXIoZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm4uaXNBY3RpdmUoKTsKICAgIH0pWzBdIHx8IG51bGw7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0QWdlbnRDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuZmluZCh0aGlzLmdldENvbm5lY3Rpb25zKCksIGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHZhciBjb25uVHlwZSA9IGNvbm4uZ2V0VHlwZSgpOwogICAgICByZXR1cm4gY29ublR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuQUdFTlQgfHwgY29ublR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuTU9OSVRPUklORzsKICAgIH0pOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldE5hbWUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLm5hbWU7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29udGFjdE1ldGFkYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb250YWN0TWV0YWRhdGE7CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5nZXREZXNjcmlwdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuZGVzY3JpcHRpb247CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0UmVmZXJlbmNlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkucmVmZXJlbmNlczsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRBdHRyaWJ1dGVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5hdHRyaWJ1dGVzOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENvbnRhY3RGZWF0dXJlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuY29udGFjdEZlYXR1cmVzOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmlzU29mdHBob25lQ2FsbCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmZpbmQodGhpcy5nZXRDb25uZWN0aW9ucygpLCBmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubi5nZXRTb2Z0cGhvbmVNZWRpYUluZm8oKSAhPSBudWxsOwogICAgfSkgIT0gbnVsbDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5faXNJbmJvdW5kID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGluaXRpYXRpb25NZXRob2QgPSB0aGlzLl9nZXREYXRhKCkuaW5pdGlhdGlvbk1ldGhvZDsKICAgIHJldHVybiAoaW5pdGlhdGlvbk1ldGhvZCA9PT0gY29ubmVjdC5Db250YWN0SW5pdGlhdGlvbk1ldGhvZC5PVVRCT1VORCkgPyBmYWxzZSA6IHRydWU7CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5pc0luYm91bmQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29ubiA9IHRoaXMuZ2V0SW5pdGlhbENvbm5lY3Rpb24oKTsKCiAgICAvLyBXZSB3aWxsIGdyYWR1YWxseSBjaGFuZ2UgY2hlY2tpbmcgaW5ib3VuZCBieSByZWx5aW5nIG9uIGNvbnRhY3QgaW5pdGlhdGlvbk1ldGhvZAogICAgaWYgKGNvbm4uZ2V0TWVkaWFUeXBlKCkgPT09IGNvbm5lY3QuTWVkaWFUeXBlLlRBU0spIHsKICAgICAgcmV0dXJuIHRoaXMuX2lzSW5ib3VuZCgpOwogICAgfQoKICAgIHJldHVybiBjb25uID8gY29ubi5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuSU5CT1VORCA6IGZhbHNlOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmlzQ29ubmVjdGVkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkNPTk5FQ1RFRDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5hY2NlcHQgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNvbnRhY3RJZCA9IHRoaXMuZ2V0Q29udGFjdElkKCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQUNDRVBUX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiBjb250YWN0SWQKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgICAgICBldmVudDogY29ubmVjdC5Db250YWN0RXZlbnRzLkFDQ0VQVEVELAogICAgICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkKICAgICAgICAgIH0pOwogICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgICAgIGV2ZW50OiBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQsCiAgICAgICAgICAgICAgc2VsZi5nZXRDb250YWN0SWQoKSksCiAgICAgICAgICAgIGRhdGE6IG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKQogICAgICAgICAgfSk7CgogICAgICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3Muc3VjY2VzcykgewogICAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGNhbGxiYWNrcyA/IGNhbGxiYWNrcy5mYWlsdXJlIDogbnVsbAogICAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5ERVNUUk9ZX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnJlamVjdCA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuUkVKRUNUX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmNvbXBsZXRlID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DT01QTEVURV9DT05UQUNULCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ0xFQVJfQ09OVEFDVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUubm90aWZ5SXNzdWUgPSBmdW5jdGlvbiAoaXNzdWVDb2RlLCBkZXNjcmlwdGlvbiwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLk5PVElGWV9DT05UQUNUX0lTU1VFLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgaXNzdWVDb2RlOiBpc3N1ZUNvZGUsCiAgICAgIGRlc2NyaXB0aW9uOiBkZXNjcmlwdGlvbgogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5hZGRDb25uZWN0aW9uID0gZnVuY3Rpb24gKGVuZHBvaW50SW4sIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBlbmRwb2ludCA9IG5ldyBjb25uZWN0LkVuZHBvaW50KGVuZHBvaW50SW4pOwogICAgLy8gSGF2ZSB0byByZW1vdmUgdGhlIGVuZHBvaW50SWQgZmllbGQgb3IgQVdTIEpTIFNESyBnZXRzIG1hZC4KICAgIGRlbGV0ZSBlbmRwb2ludC5lbmRwb2ludElkOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfQURESVRJT05BTF9DT05ORUNUSU9OLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgZW5kcG9pbnQ6IGVuZHBvaW50CiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnRvZ2dsZUFjdGl2ZUNvbm5lY3Rpb25zID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBjb25uZWN0aW9uSWQgPSBudWxsOwogICAgdmFyIGhvbGRpbmdDb25uID0gY29ubmVjdC5maW5kKHRoaXMuZ2V0Q29ubmVjdGlvbnMoKSwgZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm4uZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkhPTEQ7CiAgICB9KTsKCiAgICBpZiAoaG9sZGluZ0Nvbm4gIT0gbnVsbCkgewogICAgICBjb25uZWN0aW9uSWQgPSBob2xkaW5nQ29ubi5nZXRDb25uZWN0aW9uSWQoKTsKCiAgICB9IGVsc2UgewogICAgICB2YXIgYWN0aXZlQ29ubnMgPSB0aGlzLmdldENvbm5lY3Rpb25zKCkuZmlsdGVyKGZ1bmN0aW9uIChjb25uKSB7CiAgICAgICAgcmV0dXJuIGNvbm4uaXNBY3RpdmUoKTsKICAgICAgfSk7CiAgICAgIGlmIChhY3RpdmVDb25ucy5sZW5ndGggPiAwKSB7CiAgICAgICAgY29ubmVjdGlvbklkID0gYWN0aXZlQ29ubnNbMF0uZ2V0Q29ubmVjdGlvbklkKCk7CiAgICAgIH0KICAgIH0KCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuVE9HR0xFX0FDVElWRV9DT05ORUNUSU9OUywgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogY29ubmVjdGlvbklkCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnNlbmRTb2Z0cGhvbmVNZXRyaWNzID0gZnVuY3Rpb24gKHNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MsIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuU0VORF9TT0ZUUEhPTkVfQ0FMTF9NRVRSSUNTLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2NwVmVyc2lvbjogZ2xvYmFsLmNjcFZlcnNpb24sCiAgICAgIHNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3M6IHNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MKICAgIH0sIGNhbGxiYWNrcyk7CgogICAgY29ubmVjdC5wdWJsaXNoU29mdHBob25lU3RhdHMoewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNjcFZlcnNpb246IGdsb2JhbC5jY3BWZXJzaW9uLAogICAgICBzdGF0czogc29mdHBob25lU3RyZWFtU3RhdGlzdGljcwogICAgfSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuc2VuZFNvZnRwaG9uZVJlcG9ydCA9IGZ1bmN0aW9uIChyZXBvcnQsIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX1NPRlRQSE9ORV9DQUxMX1JFUE9SVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNjcFZlcnNpb246IGdsb2JhbC5jY3BWZXJzaW9uLAogICAgICByZXBvcnQ6IHJlcG9ydAogICAgfSwgY2FsbGJhY2tzKTsKCiAgICBjb25uZWN0LnB1Ymxpc2hTb2Z0cGhvbmVSZXBvcnQoewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNjcFZlcnNpb246IGdsb2JhbC5jY3BWZXJzaW9uLAogICAgICByZXBvcnQ6IHJlcG9ydAogICAgfSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuY29uZmVyZW5jZUNvbm5lY3Rpb25zID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DT05GRVJFTkNFX0NPTk5FQ1RJT05TLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS50b1NuYXBzaG90ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkNvbnRhY3RTbmFwc2hvdCh0aGlzLl9nZXREYXRhKCkpOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbnRhY3RTbmFwc2hvdAogICAqLwogIHZhciBDb250YWN0U25hcHNob3QgPSBmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgIGNvbm5lY3QuQ29udGFjdC5jYWxsKHRoaXMsIGNvbnRhY3REYXRhLmNvbnRhY3RJZCk7CiAgICB0aGlzLmNvbnRhY3REYXRhID0gY29udGFjdERhdGE7CiAgfTsKICBDb250YWN0U25hcHNob3QucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb250YWN0LnByb3RvdHlwZSk7CiAgQ29udGFjdFNuYXBzaG90LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENvbnRhY3RTbmFwc2hvdDsKCiAgQ29udGFjdFNuYXBzaG90LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbnRhY3REYXRhOwogIH07CgogIENvbnRhY3RTbmFwc2hvdC5wcm90b3R5cGUuX2NyZWF0ZUNvbm5lY3Rpb25BUEkgPSBmdW5jdGlvbiAoY29ubmVjdGlvbkRhdGEpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db25uZWN0aW9uU25hcHNob3QoY29ubmVjdGlvbkRhdGEpOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbm5lY3Rpb24KICAgKi8KICB2YXIgQ29ubmVjdGlvbiA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgdGhpcy5jb250YWN0SWQgPSBjb250YWN0SWQ7CiAgICB0aGlzLmNvbm5lY3Rpb25JZCA9IGNvbm5lY3Rpb25JZDsKICAgIHRoaXMuX2luaXRNZWRpYUNvbnRyb2xsZXIoKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb25uZWN0aW9uRGF0YSgKICAgICAgdGhpcy5nZXRDb250YWN0SWQoKSwgdGhpcy5nZXRDb25uZWN0aW9uSWQoKSk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Q29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29udGFjdElkOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldENvbm5lY3Rpb25JZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbm5lY3Rpb25JZDsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRFbmRwb2ludCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5FbmRwb2ludCh0aGlzLl9nZXREYXRhKCkuZW5kcG9pbnQpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldEFkZHJlc3MgPSBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRFbmRwb2ludDsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnN0YXRlOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXR1cyA9IENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXRlOwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Qubm93KCkgLSB0aGlzLl9nZXREYXRhKCkuc3RhdGUudGltZXN0YW1wLmdldFRpbWUoKSArIGNvbm5lY3QuY29yZS5nZXRTa2V3KCk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdHVzRHVyYXRpb24gPSBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uOwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS50eXBlOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmlzSW5pdGlhbENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmluaXRpYWw7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNBY3RpdmUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb250YWlucyhjb25uZWN0LkNPTk5FQ1RJT05fQUNUSVZFX1NUQVRFUywgdGhpcy5nZXRTdGF0dXMoKS50eXBlKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5pc0Nvbm5lY3RlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNURUQ7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNDb25uZWN0aW5nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RJTkc7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNPbkhvbGQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuSE9MRDsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTb2Z0cGhvbmVNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNvZnRwaG9uZU1lZGlhSW5mbzsKICB9OwoKICAvKioKICAgKiBHZXRzIHRoZSBjdXJyZW50bHkgbW9uaXRvcmVkIGNvbnRhY3QgaW5mbywgUmV0dXJucyBudWxsIGlmIGRvZXMgbm90IGV4aXN0cy4KICAgKiBAcmV0dXJuIHt7YWdlbnROYW1lOnN0cmluZywgY3VzdG9tZXJOYW1lOnN0cmluZywgam9pblRpbWU6RGF0ZX19CiAgICovCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TW9uaXRvckluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLm1vbml0b3JpbmdJbmZvOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkRFU1RST1lfQ09OTkVDVElPTiwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5zZW5kRGlnaXRzID0gZnVuY3Rpb24gKGRpZ2l0cywgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfRElHSVRTLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY29ubmVjdGlvbklkOiB0aGlzLmdldENvbm5lY3Rpb25JZCgpLAogICAgICBkaWdpdHM6IGRpZ2l0cwogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5ob2xkID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5IT0xEX0NPTk5FQ1RJT04sIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUucmVzdW1lID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5SRVNVTUVfQ09OTkVDVElPTiwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS50b1NuYXBzaG90ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkNvbm5lY3Rpb25TbmFwc2hvdCh0aGlzLl9nZXREYXRhKCkpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLl9pbml0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMuZ2V0TWVkaWFJbmZvKCkpIHsKICAgICAgY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcykuY2F0Y2goZnVuY3Rpb24gKCkgeyB9KTsKICAgIH0KICB9CgogIC8vIE1ldGhvZCBmb3IgY2hlY2tpbmcgd2hldGhlciB0aGlzIGNvbm5lY3Rpb24gaXMgYW4gYWdlbnQtc2lkZSBjb25uZWN0aW9uIAogIC8vICh0eXBlIEFHRU5UIG9yIE1PTklUT1JJTkcpCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuX2lzQWdlbnRDb25uZWN0aW9uVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBjb25uZWN0aW9uVHlwZSA9IHRoaXMuZ2V0VHlwZSgpOwogICAgcmV0dXJuIGNvbm5lY3Rpb25UeXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLkFHRU5UIAogICAgICB8fCBjb25uZWN0aW9uVHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5NT05JVE9SSU5HOwogIH0KCiAgLyoqCiAgICogVXRpbGl0eSBtZXRob2QgZm9yIGNoZWNraW5nIHdoZXRoZXIgdGhpcyBjb25uZWN0aW9uIGlzIGFuIGFnZW50LXNpZGUgY29ubmVjdGlvbiAKICAgKiAodHlwZSBBR0VOVCBvciBNT05JVE9SSU5HKQogICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhpcyBjb25uZWN0aW9uIGlzIGFuIGFnZW50LXNpZGUgY29ubmVjdGlvbi4gRmFsc2Ugb3RoZXJ3aXNlLgogICAqLwogIENvbm5lY3Rpb24ucHJvdG90eXBlLl9pc0FnZW50Q29ubmVjdGlvblR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29ubmVjdGlvblR5cGUgPSB0aGlzLmdldFR5cGUoKTsKICAgIHJldHVybiBjb25uZWN0aW9uVHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5BR0VOVCAKICAgICAgfHwgY29ubmVjdGlvblR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuTU9OSVRPUklORzsKICB9CgogIC8qKgogICAqIEBjbGFzcyBWb2ljZUNvbm5lY3Rpb24KICAgKiBAcGFyYW0ge251bWJlcn0gY29udGFjdElkIAogICAqIEBwYXJhbSB7bnVtYmVyfSBjb25uZWN0aW9uSWQgCiAgICogQGRlc2NyaXB0aW9uIC0gUHJvdmlkZXMgdm9pY2UgbWVkaWEgc3BlY2lmaWMgb3BlcmF0aW9ucwogICAqLwogIHZhciBWb2ljZUNvbm5lY3Rpb24gPSBmdW5jdGlvbiAoY29udGFjdElkLCBjb25uZWN0aW9uSWQpIHsKICAgIENvbm5lY3Rpb24uY2FsbCh0aGlzLCBjb250YWN0SWQsIGNvbm5lY3Rpb25JZCk7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29ubmVjdGlvbi5wcm90b3R5cGUpOwogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBWb2ljZUNvbm5lY3Rpb247CgogIC8qKgogICogQGRlcHJlY2F0ZWQKICAqIFBsZWFzZSB1c2UgZ2V0TWVkaWFJbmZvIAogICovCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTb2Z0cGhvbmVNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNvZnRwaG9uZU1lZGlhSW5mbzsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhSW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc29mdHBob25lTWVkaWFJbmZvOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuTWVkaWFUeXBlLlNPRlRQSE9ORTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5LmdldCh0aGlzKTsKICB9CgoKICAvKioKICAgKiBAY2xhc3MgQ2hhdENvbm5lY3Rpb24KICAgKiBAcGFyYW0geyp9IGNvbnRhY3RJZCAKICAgKiBAcGFyYW0geyp9IGNvbm5lY3Rpb25JZCAKICAgKiBAZGVzY3JpcHRpb24gYWRkcyB0aGUgY2hhdCBtZWRpYSBzcGVjaWZpYyBmdW5jdGlvbmFsaXR5CiAgICovCiAgdmFyIENoYXRDb25uZWN0aW9uID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKSB7CiAgICBDb25uZWN0aW9uLmNhbGwodGhpcywgY29udGFjdElkLCBjb25uZWN0aW9uSWQpOwogIH07CgogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29ubmVjdGlvbi5wcm90b3R5cGUpOwogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENoYXRDb25uZWN0aW9uOwoKICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFJbmZvID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGRhdGEgPSB0aGlzLl9nZXREYXRhKCkuY2hhdE1lZGlhSW5mbzsKICAgIGlmICghZGF0YSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuY29udGFjdElkKTsKICAgICAgdmFyIG1lZGlhT2JqZWN0ID0gewogICAgICAgIGNvbnRhY3RJZDogdGhpcy5jb250YWN0SWQsCiAgICAgICAgaW5pdGlhbENvbnRhY3RJZDogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCB0aGlzLmNvbnRhY3RJZCwKICAgICAgICBwYXJ0aWNpcGFudElkOiB0aGlzLmNvbm5lY3Rpb25JZCwKICAgICAgICBnZXRDb25uZWN0aW9uVG9rZW46IGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5nZXRDb25uZWN0aW9uVG9rZW4pCiAgICAgIH07CiAgICAgIGlmIChkYXRhLmNvbm5lY3Rpb25EYXRhKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIG1lZGlhT2JqZWN0LnBhcnRpY2lwYW50VG9rZW4gPSBKU09OLnBhcnNlKGRhdGEuY29ubmVjdGlvbkRhdGEpLkNvbm5lY3Rpb25BdXRoZW50aWNhdGlvblRva2VuOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoY29ubmVjdC5Mb2dDb21wb25lbnQuQ0hBVCwgIkNvbm5lY3Rpb24gZGF0YSBpcyBpbnZhbGlkIikud2l0aE9iamVjdChkYXRhKS53aXRoRXhjZXB0aW9uKGUpOwogICAgICAgICAgbWVkaWFPYmplY3QucGFydGljaXBhbnRUb2tlbiA9IG51bGw7CiAgICAgICAgfQogICAgICB9CiAgICAgIG1lZGlhT2JqZWN0LnBhcnRpY2lwYW50VG9rZW4gPSBtZWRpYU9iamVjdC5wYXJ0aWNpcGFudFRva2VuIHx8IG51bGw7CiAgICAgIC8qKiBKdXN0IHRvIGtlZXAgdGhlIGRhdGEgYWNjZXNzaWJsZSAqLwogICAgICBtZWRpYU9iamVjdC5vcmlnaW5hbEluZm8gPSB0aGlzLl9nZXREYXRhKCkuY2hhdE1lZGlhSW5mbzsKICAgICAgcmV0dXJuIG1lZGlhT2JqZWN0OwogICAgfQogIH07CgogIC8qKgogICogUHJvdmlkZXMgdGhlIGNoYXQgY29ubmVjdGlvblRva2VuIHRocm91Z2ggdGhlIGNyZWF0ZV90cmFuc3BvcnQgQVBJIGZvciBhIHNwZWNpZmljIGNvbnRhY3QgYW5kIHBhcnRpY2lwYW50IElkLiAKICAqIEByZXR1cm5zIGEgcHJvbWlzZSB3aGljaCwgdXBvbiBzdWNjZXNzLCByZXR1cm5zIHRoZSByZXNwb25zZSBmcm9tIHRoZSBjcmVhdGVUcmFuc3BvcnQgQVBJLgogICogVXNhZ2U6CiAgKiBjb25uZWN0aW9uLmdldENvbm5lY3Rpb25Ub2tlbigpCiAgKiAgLnRoZW4ocmVzcG9uc2UgPT4ge30pCiAgKiAgLmNhdGNoKGVycm9yID0+IHt9KQogICovCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmdldENvbm5lY3Rpb25Ub2tlbiA9IGZ1bmN0aW9uICgpIHsKICAgIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuY29udGFjdElkKTsKICAgIHZhciB0cmFuc3BvcnREZXRhaWxzID0gewogICAgICB0cmFuc3BvcnRUeXBlOiBjb25uZWN0LlRSQU5TUE9SVF9UWVBFUy5DSEFUX1RPS0VOLAogICAgICBwYXJ0aWNpcGFudElkOiB0aGlzLmNvbm5lY3Rpb25JZCwKICAgICAgY29udGFjdElkOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkCiAgICB9OwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNSRUFURV9UUkFOU1BPUlQsIHRyYW5zcG9ydERldGFpbHMsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXRDb25uZWN0aW9uVG9rZW4gc3VjY2VlZGVkIik7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0Q29ubmVjdGlvblRva2VuIGZhaWxlZCIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJnZXRDb25uZWN0aW9uVG9rZW4gZmFpbGVkIikpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuTWVkaWFUeXBlLkNIQVQ7CiAgfTsKCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5LmdldCh0aGlzKTsKICB9OwoKICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuX2luaXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAvLyBOb3RlIHRoYXQgYSBjaGF0IG1lZGlhIGNvbnRyb2xsZXIgb25seSBuZWVkcyB0byBiZSBwcm9kdWNlZCBmb3IgYWdlbnQgdHlwZSBjb25uZWN0aW9ucy4KICAgIGlmICh0aGlzLl9pc0FnZW50Q29ubmVjdGlvblR5cGUoKSkgewogICAgICBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5LmdldCh0aGlzKS5jYXRjaChmdW5jdGlvbiAoKSB7IH0pOwogICAgfQogIH0KCiAgLyoqCiAgICogQGNsYXNzIFRhc2tDb25uZWN0aW9uCiAgICogQHBhcmFtIHsqfSBjb250YWN0SWQgCiAgICogQHBhcmFtIHsqfSBjb25uZWN0aW9uSWQgCiAgICogQGRlc2NyaXB0aW9uIGFkZHMgdGhlIHRhc2sgbWVkaWEgc3BlY2lmaWMgZnVuY3Rpb25hbGl0eQogICAqLwogIHZhciBUYXNrQ29ubmVjdGlvbiA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgQ29ubmVjdGlvbi5jYWxsKHRoaXMsIGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKTsKICB9OwogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29ubmVjdGlvbi5wcm90b3R5cGUpOwogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFRhc2tDb25uZWN0aW9uOwoKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuTWVkaWFUeXBlLlRBU0s7CiAgfQoKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFJbmZvID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICAgIHZhciBtZWRpYU9iamVjdCA9IHsKICAgICAgICBjb250YWN0SWQ6IHRoaXMuY29udGFjdElkLAogICAgICAgIGluaXRpYWxDb250YWN0SWQ6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgdGhpcy5jb250YWN0SWQsCiAgICAgIH07CiAgICAgIHJldHVybiBtZWRpYU9iamVjdDsKICB9OwoKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkuZ2V0KHRoaXMpOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbm5lY3Rpb25TbmFwc2hvdAogICAqLwogIHZhciBDb25uZWN0aW9uU25hcHNob3QgPSBmdW5jdGlvbiAoY29ubmVjdGlvbkRhdGEpIHsKICAgIGNvbm5lY3QuQ29ubmVjdGlvbi5jYWxsKHRoaXMsIGNvbm5lY3Rpb25EYXRhLmNvbnRhY3RJZCwgY29ubmVjdGlvbkRhdGEuY29ubmVjdGlvbklkKTsKICAgIHRoaXMuY29ubmVjdGlvbkRhdGEgPSBjb25uZWN0aW9uRGF0YTsKICB9OwogIENvbm5lY3Rpb25TbmFwc2hvdC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbm5lY3Rpb24ucHJvdG90eXBlKTsKICBDb25uZWN0aW9uU25hcHNob3QucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQ29ubmVjdGlvblNuYXBzaG90OwoKICBDb25uZWN0aW9uU25hcHNob3QucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvbkRhdGE7CiAgfTsKCiAgQ29ubmVjdGlvblNuYXBzaG90LnByb3RvdHlwZS5faW5pdE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsgfTsKCiAgdmFyIEVuZHBvaW50ID0gZnVuY3Rpb24gKHBhcmFtc0luKSB7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICB0aGlzLmVuZHBvaW50QVJOID0gcGFyYW1zLmVuZHBvaW50SWQgfHwgcGFyYW1zLmVuZHBvaW50QVJOIHx8IG51bGw7CiAgICB0aGlzLmVuZHBvaW50SWQgPSB0aGlzLmVuZHBvaW50QVJOOwogICAgdGhpcy50eXBlID0gcGFyYW1zLnR5cGUgfHwgbnVsbDsKICAgIHRoaXMubmFtZSA9IHBhcmFtcy5uYW1lIHx8IG51bGw7CiAgICB0aGlzLnBob25lTnVtYmVyID0gcGFyYW1zLnBob25lTnVtYmVyIHx8IG51bGw7CiAgICB0aGlzLmFnZW50TG9naW4gPSBwYXJhbXMuYWdlbnRMb2dpbiB8fCBudWxsOwogICAgdGhpcy5xdWV1ZSA9IHBhcmFtcy5xdWV1ZSB8fCBudWxsOwogIH07CgogIC8qKgogICAqIFN0cmlwIHRoZSBTSVAgZW5kcG9pbnQgY29tcG9uZW50cyBmcm9tIHRoZSBwaG9uZU51bWJlciBmaWVsZC4KICAgKi8KICBFbmRwb2ludC5wcm90b3R5cGUuc3RyaXBQaG9uZU51bWJlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLnBob25lTnVtYmVyID8gdGhpcy5waG9uZU51bWJlci5yZXBsYWNlKC9zaXA6KFteQF0qKUAuKi8sICIkMSIpIDogIiI7CiAgfTsKCiAgLyoqCiAgICogQ3JlYXRlIGFuIEVuZHBvaW50IG9iamVjdCBmcm9tIHRoZSBnaXZlbiBwaG9uZSBudW1iZXIgYW5kIG5hbWUuCiAgICovCiAgRW5kcG9pbnQuYnlQaG9uZU51bWJlciA9IGZ1bmN0aW9uIChudW1iZXIsIG5hbWUpIHsKICAgIHJldHVybiBuZXcgRW5kcG9pbnQoewogICAgICB0eXBlOiBjb25uZWN0LkVuZHBvaW50VHlwZS5QSE9ORV9OVU1CRVIsCiAgICAgIHBob25lTnVtYmVyOiBudW1iZXIsCiAgICAgIG5hbWU6IG5hbWUgfHwgbnVsbAogICAgfSk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgU29mdHBob25lRXJyb3IKICAgKi8KICB2YXIgU29mdHBob25lRXJyb3IgPSBmdW5jdGlvbiAoZXJyb3JUeXBlLCBlcnJvck1lc3NhZ2UsIGVuZFBvaW50VXJsKSB7CiAgICB0aGlzLmVycm9yVHlwZSA9IGVycm9yVHlwZTsKICAgIHRoaXMuZXJyb3JNZXNzYWdlID0gZXJyb3JNZXNzYWdlOwogICAgdGhpcy5lbmRQb2ludFVybCA9IGVuZFBvaW50VXJsOwogIH07CiAgU29mdHBob25lRXJyb3IucHJvdG90eXBlLmdldEVycm9yVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmVycm9yVHlwZTsKICB9OwogIFNvZnRwaG9uZUVycm9yLnByb3RvdHlwZS5nZXRFcnJvck1lc3NhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5lcnJvck1lc3NhZ2U7CiAgfTsKICBTb2Z0cGhvbmVFcnJvci5wcm90b3R5cGUuZ2V0RW5kUG9pbnRVcmwgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5lbmRQb2ludFVybDsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBSb290IFN1YnNjcmlwdGlvbiBBUElzLgogICAqLwogIGNvbm5lY3QuYWdlbnQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgdmFyIHN1YiA9IGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5JTklULCBmKTsKICAgIGlmIChjb25uZWN0LmFnZW50LmluaXRpYWxpemVkKSB7CiAgICAgIGYobmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICB9CiAgICByZXR1cm4gc3ViOwogIH07CiAgY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCA9IGZhbHNlOwoKICBjb25uZWN0LmNvbnRhY3QgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgcmV0dXJuIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5Db250YWN0RXZlbnRzLklOSVQsIGYpOwogIH07CgogIGNvbm5lY3Qub25XZWJzb2NrZXRJbml0RmFpbHVyZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICB2YXIgc3ViID0gYnVzLnN1YnNjcmliZShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5JTklUX0ZBSUxVUkUsIGYpOwogICAgaWYgKGNvbm5lY3Qud2ViU29ja2V0SW5pdEZhaWxlZCkgewogICAgICBmKCk7CiAgICB9CiAgICByZXR1cm4gc3ViOwogIH07CgogIC8qKgogICAqIEV4ZWN1dGUgdGhlIGdpdmVuIGZ1bmN0aW9uIGFzeW5jaHJvbm91c2x5IG9ubHkgaWYgdGhlIHNoYXJlZCB3b3JrZXIKICAgKiBzYXlzIHdlIGFyZSB0aGUgbWFzdGVyIGZvciB0aGUgZ2l2ZW4gdG9waWMuICBJZiB0aGVyZSBpcyBubyBtYXN0ZXIgZm9yCiAgICogdGhlIGdpdmVuIHRvcGljLCB3ZSBiZWNvbWUgdGhlIG1hc3RlciBhbmQgZXhlY3V0ZSB0aGUgZnVuY3Rpb24uCiAgICoKICAgKiBAcGFyYW0gdG9waWMgVGhlIG1hc3RlciB0b3BpYyB3ZSBhcmUgY29uY2VybmVkIGFib3V0LgogICAqIEBwYXJhbSBmX3RydWUgVGhlIGNhbGxiYWNrIHRvIGJlIGludm9rZWQgaWYgd2UgYXJlIHRoZSBtYXN0ZXIuCiAgICogQHBhcmFtIGZfZWxzZSBbb3B0aW9uYWxdIEEgY2FsbGJhY2sgdG8gYmUgaW52b2tlZCBpZiB3ZSBhcmUgbm90IHRoZSBtYXN0ZXIuCiAgICovCiAgY29ubmVjdC5pZk1hc3RlciA9IGZ1bmN0aW9uICh0b3BpYywgZl90cnVlLCBmX2Vsc2UpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b3BpYywgIkEgdG9waWMgbXVzdCBiZSBwcm92aWRlZC4iKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmX3RydWUsICJBIHRydWUgY2FsbGJhY2sgbXVzdCBiZSBwcm92aWRlZC4iKTsKCiAgICBpZiAoIWNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQpIHsKICAgICAgLy8gV2UgY2FuJ3QgYmUgdGhlIG1hc3RlciBiZWNhdXNlIHRoZXJlIGlzIG5vIG1hc3RlciBjbGllbnQhCiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiV2UgY2FuJ3QgYmUgdGhlIG1hc3RlciBmb3IgdG9waWMgJyVzJyBiZWNhdXNlIHRoZXJlIGlzIG5vIG1hc3RlciBjbGllbnQhIiwgdG9waWMpOwogICAgICBpZiAoZl9lbHNlKSB7CiAgICAgICAgZl9lbHNlKCk7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBtYXN0ZXJDbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0TWFzdGVyQ2xpZW50KCk7CiAgICBtYXN0ZXJDbGllbnQuY2FsbChjb25uZWN0Lk1hc3Rlck1ldGhvZHMuQ0hFQ0tfTUFTVEVSLCB7CiAgICAgIHRvcGljOiB0b3BpYwogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5pc01hc3RlcikgewogICAgICAgICAgICBmX3RydWUoKTsKCiAgICAgICAgICB9IGVsc2UgaWYgKGZfZWxzZSkgewogICAgICAgICAgICBmX2Vsc2UoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogIH07CgogIC8qKgogICAqIE5vdGlmeSB0aGUgc2hhcmVkIHdvcmtlciB0aGF0IHdlIGFyZSBub3cgdGhlIG1hc3RlciBmb3IgdGhlIGdpdmVuIHRvcGljLgogICAqLwogIGNvbm5lY3QuYmVjb21lTWFzdGVyID0gZnVuY3Rpb24gKHRvcGljKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWMsICJBIHRvcGljIG11c3QgYmUgcHJvdmlkZWQuIik7CiAgICB2YXIgbWFzdGVyQ2xpZW50ID0gY29ubmVjdC5jb3JlLmdldE1hc3RlckNsaWVudCgpOwogICAgbWFzdGVyQ2xpZW50LmNhbGwoY29ubmVjdC5NYXN0ZXJNZXRob2RzLkJFQ09NRV9NQVNURVIsIHsKICAgICAgdG9waWM6IHRvcGljCiAgICB9KTsKICB9OwoKICBjb25uZWN0LkFnZW50ID0gQWdlbnQ7CiAgY29ubmVjdC5BZ2VudFNuYXBzaG90ID0gQWdlbnRTbmFwc2hvdDsKICBjb25uZWN0LkNvbnRhY3QgPSBDb250YWN0OwogIGNvbm5lY3QuQ29udGFjdFNuYXBzaG90ID0gQ29udGFjdFNuYXBzaG90OwogIC8qKiBEZWZhdWx0IHdpbGwgZ2V0IHRoZSBWb2ljZSBjb25uZWN0aW9uICovCiAgY29ubmVjdC5Db25uZWN0aW9uID0gVm9pY2VDb25uZWN0aW9uOwogIGNvbm5lY3QuQmFzZUNvbm5lY3Rpb24gPSBDb25uZWN0aW9uOwogIGNvbm5lY3QuVm9pY2VDb25uZWN0aW9uID0gVm9pY2VDb25uZWN0aW9uOwogIGNvbm5lY3QuQ2hhdENvbm5lY3Rpb24gPSBDaGF0Q29ubmVjdGlvbjsKICBjb25uZWN0LlRhc2tDb25uZWN0aW9uID0gVGFza0Nvbm5lY3Rpb247CiAgY29ubmVjdC5Db25uZWN0aW9uU25hcHNob3QgPSBDb25uZWN0aW9uU25hcHNob3Q7CiAgY29ubmVjdC5FbmRwb2ludCA9IEVuZHBvaW50OwogIGNvbm5lY3QuQWRkcmVzcyA9IEVuZHBvaW50OwogIGNvbm5lY3QuU29mdHBob25lRXJyb3IgPSBTb2Z0cGhvbmVFcnJvcjsKCn0pKCk7CgoKIWZ1bmN0aW9uKGUpe3ZhciBuPXt9O2Z1bmN0aW9uIHQobyl7aWYobltvXSlyZXR1cm4gbltvXS5leHBvcnRzO3ZhciByPW5bb109e2k6byxsOiExLGV4cG9ydHM6e319O3JldHVybiBlW29dLmNhbGwoci5leHBvcnRzLHIsci5leHBvcnRzLHQpLHIubD0hMCxyLmV4cG9ydHN9dC5tPWUsdC5jPW4sdC5kPWZ1bmN0aW9uKGUsbixvKXt0Lm8oZSxuKXx8T2JqZWN0LmRlZmluZVByb3BlcnR5KGUsbix7ZW51bWVyYWJsZTohMCxnZXQ6b30pfSx0LnI9ZnVuY3Rpb24oZSl7InVuZGVmaW5lZCIhPXR5cGVvZiBTeW1ib2wmJlN5bWJvbC50b1N0cmluZ1RhZyYmT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsU3ltYm9sLnRvU3RyaW5nVGFnLHt2YWx1ZToiTW9kdWxlIn0pLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KX0sdC50PWZ1bmN0aW9uKGUsbil7aWYoMSZuJiYoZT10KGUpKSw4Jm4pcmV0dXJuIGU7aWYoNCZuJiYib2JqZWN0Ij09dHlwZW9mIGUmJmUmJmUuX19lc01vZHVsZSlyZXR1cm4gZTt2YXIgbz1PYmplY3QuY3JlYXRlKG51bGwpO2lmKHQucihvKSxPYmplY3QuZGVmaW5lUHJvcGVydHkobywiZGVmYXVsdCIse2VudW1lcmFibGU6ITAsdmFsdWU6ZX0pLDImbiYmInN0cmluZyIhPXR5cGVvZiBlKWZvcih2YXIgciBpbiBlKXQuZChvLHIsZnVuY3Rpb24obil7cmV0dXJuIGVbbl19LmJpbmQobnVsbCxyKSk7cmV0dXJuIG99LHQubj1mdW5jdGlvbihlKXt2YXIgbj1lJiZlLl9fZXNNb2R1bGU/ZnVuY3Rpb24oKXtyZXR1cm4gZS5kZWZhdWx0fTpmdW5jdGlvbigpe3JldHVybiBlfTtyZXR1cm4gdC5kKG4sImEiLG4pLG59LHQubz1mdW5jdGlvbihlLG4pe3JldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoZSxuKX0sdC5wPSIiLHQodC5zPTIpfShbZnVuY3Rpb24oZSxuLHQpeyJ1c2Ugc3RyaWN0Ijt2YXIgbz10KDEpO2Z1bmN0aW9uIHIoZSl7cmV0dXJuKHI9ImZ1bmN0aW9uIj09dHlwZW9mIFN5bWJvbCYmInN5bWJvbCI9PXR5cGVvZiBTeW1ib2wuaXRlcmF0b3I/ZnVuY3Rpb24oZSl7cmV0dXJuIHR5cGVvZiBlfTpmdW5jdGlvbihlKXtyZXR1cm4gZSYmImZ1bmN0aW9uIj09dHlwZW9mIFN5bWJvbCYmZS5jb25zdHJ1Y3Rvcj09PVN5bWJvbCYmZSE9PVN5bWJvbC5wcm90b3R5cGU/InN5bWJvbCI6dHlwZW9mIGV9KShlKX12YXIgaT17YXNzZXJ0VHJ1ZTpmdW5jdGlvbihlLG4pe2lmKCFlKXRocm93IG5ldyBFcnJvcihuKX0sYXNzZXJ0Tm90TnVsbDpmdW5jdGlvbihlLG4pe3JldHVybiBpLmFzc2VydFRydWUobnVsbCE9PWUmJnZvaWQgMCE9PXIoZSksT2JqZWN0KG8uc3ByaW50ZikoIiVzIG11c3QgYmUgcHJvdmlkZWQiLG58fCJBIHZhbHVlIikpLGV9LGlzTm9uRW1wdHlTdHJpbmc6ZnVuY3Rpb24oZSl7cmV0dXJuInN0cmluZyI9PXR5cGVvZiBlJiZlLmxlbmd0aD4wfSxhc3NlcnRJc0xpc3Q6ZnVuY3Rpb24oZSxuKXtpZighQXJyYXkuaXNBcnJheShlKSl0aHJvdyBuZXcgRXJyb3IobisiIGlzIG5vdCBhbiBhcnJheSIpfSxpc0Z1bmN0aW9uOmZ1bmN0aW9uKGUpe3JldHVybiEhKGUmJmUuY29uc3RydWN0b3ImJmUuY2FsbCYmZS5hcHBseSl9LGlzT2JqZWN0OmZ1bmN0aW9uKGUpe3JldHVybiEoIm9iamVjdCIhPT1yKGUpfHxudWxsPT09ZSl9LGlzU3RyaW5nOmZ1bmN0aW9uKGUpe3JldHVybiJzdHJpbmciPT10eXBlb2YgZX0saXNOdW1iZXI6ZnVuY3Rpb24oZSl7cmV0dXJuIm51bWJlciI9PXR5cGVvZiBlfX0sYz1uZXcgUmVnRXhwKCJeKHdzczovLylcXHcqIik7aS52YWxpZFdTVXJsPWZ1bmN0aW9uKGUpe3JldHVybiBjLnRlc3QoZSl9LGkuZ2V0U3Vic2NyaXB0aW9uUmVzcG9uc2U9ZnVuY3Rpb24oZSxuLHQpe3JldHVybnt0b3BpYzplLGNvbnRlbnQ6e3N0YXR1czpuPyJzdWNjZXNzIjoiZmFpbHVyZSIsdG9waWNzOnR9fX0saS5hc3NlcnRJc09iamVjdD1mdW5jdGlvbihlLG4pe2lmKCFpLmlzT2JqZWN0KGUpKXRocm93IG5ldyBFcnJvcihuKyIgaXMgbm90IGFuIG9iamVjdCEiKX0saS5hZGRKaXR0ZXI9ZnVuY3Rpb24oZSl7dmFyIG49YXJndW1lbnRzLmxlbmd0aD4xJiZ2b2lkIDAhPT1hcmd1bWVudHNbMV0/YXJndW1lbnRzWzFdOjE7bj1NYXRoLm1pbihuLDEpO3ZhciB0PU1hdGgucmFuZG9tKCk+LjU/MTotMTtyZXR1cm4gTWF0aC5mbG9vcihlK3QqZSpNYXRoLnJhbmRvbSgpKm4pfSxpLmlzTmV0d29ya09ubGluZT1mdW5jdGlvbigpe3JldHVybiBuYXZpZ2F0b3Iub25MaW5lfTt2YXIgcz1pLGE9Ik5VTEwiLHU9IkNMSUVOVF9MT0dHRVIiLGw9IkRFQlVHIixmPSJhd3Mvc3Vic2NyaWJlIixwPSJhd3MvdW5zdWJzY3JpYmUiLGQ9ImF3cy9oZWFydGJlYXQiLGI9ImNvbm5lY3RlZCIsZz0iZGlzY29ubmVjdGVkIjtmdW5jdGlvbiBtKGUpe3JldHVybihtPSJmdW5jdGlvbiI9PXR5cGVvZiBTeW1ib2wmJiJzeW1ib2wiPT10eXBlb2YgU3ltYm9sLml0ZXJhdG9yP2Z1bmN0aW9uKGUpe3JldHVybiB0eXBlb2YgZX06ZnVuY3Rpb24oZSl7cmV0dXJuIGUmJiJmdW5jdGlvbiI9PXR5cGVvZiBTeW1ib2wmJmUuY29uc3RydWN0b3I9PT1TeW1ib2wmJmUhPT1TeW1ib2wucHJvdG90eXBlPyJzeW1ib2wiOnR5cGVvZiBlfSkoZSl9ZnVuY3Rpb24geShlLG4pe3JldHVybiFufHwib2JqZWN0IiE9PW0obikmJiJmdW5jdGlvbiIhPXR5cGVvZiBuP2Z1bmN0aW9uKGUpe2lmKHZvaWQgMD09PWUpdGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCJ0aGlzIGhhc24ndCBiZWVuIGluaXRpYWxpc2VkIC0gc3VwZXIoKSBoYXNuJ3QgYmVlbiBjYWxsZWQiKTtyZXR1cm4gZX0oZSk6bn1mdW5jdGlvbiBTKGUpe3JldHVybihTPU9iamVjdC5zZXRQcm90b3R5cGVPZj9PYmplY3QuZ2V0UHJvdG90eXBlT2Y6ZnVuY3Rpb24oZSl7cmV0dXJuIGUuX19wcm90b19ffHxPYmplY3QuZ2V0UHJvdG90eXBlT2YoZSl9KShlKX1mdW5jdGlvbiBrKGUsbil7cmV0dXJuKGs9T2JqZWN0LnNldFByb3RvdHlwZU9mfHxmdW5jdGlvbihlLG4pe3JldHVybiBlLl9fcHJvdG9fXz1uLGV9KShlLG4pfWZ1bmN0aW9uIGgoZSxuKXtpZighKGUgaW5zdGFuY2VvZiBuKSl0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKX1mdW5jdGlvbiB2KGUsbil7Zm9yKHZhciB0PTA7dDxuLmxlbmd0aDt0Kyspe3ZhciBvPW5bdF07by5lbnVtZXJhYmxlPW8uZW51bWVyYWJsZXx8ITEsby5jb25maWd1cmFibGU9ITAsInZhbHVlImluIG8mJihvLndyaXRhYmxlPSEwKSxPYmplY3QuZGVmaW5lUHJvcGVydHkoZSxvLmtleSxvKX19ZnVuY3Rpb24gdyhlLG4sdCl7cmV0dXJuIG4mJnYoZS5wcm90b3R5cGUsbiksdCYmdihlLHQpLGV9dmFyIEM9ZnVuY3Rpb24oKXtmdW5jdGlvbiBlKCl7aCh0aGlzLGUpfXJldHVybiB3KGUsW3trZXk6ImRlYnVnIix2YWx1ZTpmdW5jdGlvbihlKXt9fSx7a2V5OiJpbmZvIix2YWx1ZTpmdW5jdGlvbihlKXt9fSx7a2V5OiJ3YXJuIix2YWx1ZTpmdW5jdGlvbihlKXt9fSx7a2V5OiJlcnJvciIsdmFsdWU6ZnVuY3Rpb24oZSl7fX1dKSxlfSgpLFQ9e0RFQlVHOjEwLElORk86MjAsV0FSTjozMCxFUlJPUjo0MH0sTz1mdW5jdGlvbigpe2Z1bmN0aW9uIGUoKXtoKHRoaXMsZSksdGhpcy51cGRhdGVMb2dnZXJDb25maWcoKSx0aGlzLmNvbnNvbGVMb2dnZXJXcmFwcGVyPU4oKX1yZXR1cm4gdyhlLFt7a2V5OiJ3cml0ZVRvQ2xpZW50TG9nZ2VyIix2YWx1ZTpmdW5jdGlvbihlLG4pe2lmKHRoaXMuaGFzQ2xpZW50TG9nZ2VyKCkpc3dpdGNoKGUpe2Nhc2UgVC5ERUJVRzpyZXR1cm4gdGhpcy5fY2xpZW50TG9nZ2VyLmRlYnVnKG4pO2Nhc2UgVC5JTkZPOnJldHVybiB0aGlzLl9jbGllbnRMb2dnZXIuaW5mbyhuKTtjYXNlIFQuV0FSTjpyZXR1cm4gdGhpcy5fY2xpZW50TG9nZ2VyLndhcm4obik7Y2FzZSBULkVSUk9SOnJldHVybiB0aGlzLl9jbGllbnRMb2dnZXIuZXJyb3Iobil9fX0se2tleToiaXNMZXZlbEVuYWJsZWQiLHZhbHVlOmZ1bmN0aW9uKGUpe3JldHVybiBlPj10aGlzLl9sZXZlbH19LHtrZXk6Imhhc0NsaWVudExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oKXtyZXR1cm4gbnVsbCE9PXRoaXMuX2NsaWVudExvZ2dlcn19LHtrZXk6ImdldExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oZSl7dmFyIG49ZS5wcmVmaXh8fCIiO3JldHVybiB0aGlzLl9sb2dzRGVzdGluYXRpb249PT1sP3RoaXMuY29uc29sZUxvZ2dlcldyYXBwZXI6bmV3IFcobil9fSx7a2V5OiJ1cGRhdGVMb2dnZXJDb25maWciLHZhbHVlOmZ1bmN0aW9uKGUpe3ZhciBuPWV8fHt9O3RoaXMuX2xldmVsPW4ubGV2ZWx8fFQuREVCVUcsdGhpcy5fY2xpZW50TG9nZ2VyPW4ubG9nZ2VyfHxudWxsLHRoaXMuX2xvZ3NEZXN0aW5hdGlvbj1hLG4uZGVidWcmJih0aGlzLl9sb2dzRGVzdGluYXRpb249bCksbi5sb2dnZXImJih0aGlzLl9sb2dzRGVzdGluYXRpb249dSl9fV0pLGV9KCksST1mdW5jdGlvbigpe2Z1bmN0aW9uIGUoKXtoKHRoaXMsZSl9cmV0dXJuIHcoZSxbe2tleToiZGVidWciLHZhbHVlOmZ1bmN0aW9uKCl7fX0se2tleToiaW5mbyIsdmFsdWU6ZnVuY3Rpb24oKXt9fSx7a2V5OiJ3YXJuIix2YWx1ZTpmdW5jdGlvbigpe319LHtrZXk6ImVycm9yIix2YWx1ZTpmdW5jdGlvbigpe319XSksZX0oKSxXPWZ1bmN0aW9uKGUpe2Z1bmN0aW9uIG4oZSl7dmFyIHQ7cmV0dXJuIGgodGhpcyxuKSwodD15KHRoaXMsUyhuKS5jYWxsKHRoaXMpKSkucHJlZml4PWV8fCIiLHR9cmV0dXJuIGZ1bmN0aW9uKGUsbil7aWYoImZ1bmN0aW9uIiE9dHlwZW9mIG4mJm51bGwhPT1uKXRocm93IG5ldyBUeXBlRXJyb3IoIlN1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uIik7ZS5wcm90b3R5cGU9T2JqZWN0LmNyZWF0ZShuJiZuLnByb3RvdHlwZSx7Y29uc3RydWN0b3I6e3ZhbHVlOmUsd3JpdGFibGU6ITAsY29uZmlndXJhYmxlOiEwfX0pLG4mJmsoZSxuKX0obixJKSx3KG4sW3trZXk6ImRlYnVnIix2YWx1ZTpmdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3RoaXMuX2xvZyhULkRFQlVHLG4pfX0se2tleToiaW5mbyIsdmFsdWU6ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTt0aGlzLl9sb2coVC5JTkZPLG4pfX0se2tleToid2FybiIsdmFsdWU6ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTt0aGlzLl9sb2coVC5XQVJOLG4pfX0se2tleToiZXJyb3IiLHZhbHVlOmZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07dGhpcy5fbG9nKFQuRVJST1Isbil9fSx7a2V5OiJfc2hvdWxkTG9nIix2YWx1ZTpmdW5jdGlvbihlKXtyZXR1cm4gXy5oYXNDbGllbnRMb2dnZXIoKSYmXy5pc0xldmVsRW5hYmxlZChlKX19LHtrZXk6Il93cml0ZVRvQ2xpZW50TG9nZ2VyIix2YWx1ZTpmdW5jdGlvbihlLG4pe18ud3JpdGVUb0NsaWVudExvZ2dlcihlLG4pfX0se2tleToiX2xvZyIsdmFsdWU6ZnVuY3Rpb24oZSxuKXtpZih0aGlzLl9zaG91bGRMb2coZSkpe3ZhciB0PXRoaXMuX2NvbnZlcnRUb1NpbmdsZVN0YXRlbWVudChuKTt0aGlzLl93cml0ZVRvQ2xpZW50TG9nZ2VyKGUsdCl9fX0se2tleToiX2NvbnZlcnRUb1NpbmdsZVN0YXRlbWVudCIsdmFsdWU6ZnVuY3Rpb24oZSl7dmFyIG49IiI7dGhpcy5wcmVmaXgmJihuKz10aGlzLnByZWZpeCsiICIpO2Zvcih2YXIgdD0wO3Q8ZS5sZW5ndGg7dCsrKXt2YXIgbz1lW3RdO24rPXRoaXMuX2NvbnZlcnRUb1N0cmluZyhvKSsiICJ9cmV0dXJuIG59fSx7a2V5OiJfY29udmVydFRvU3RyaW5nIix2YWx1ZTpmdW5jdGlvbihlKXt0cnl7aWYoIWUpcmV0dXJuIiI7aWYocy5pc1N0cmluZyhlKSlyZXR1cm4gZTtpZihzLmlzT2JqZWN0KGUpJiZzLmlzRnVuY3Rpb24oZS50b1N0cmluZykpe3ZhciBuPWUudG9TdHJpbmcoKTtpZigiW29iamVjdCBPYmplY3RdIiE9PW4pcmV0dXJuIG59cmV0dXJuIEpTT04uc3RyaW5naWZ5KGUpfWNhdGNoKG4pe3JldHVybiBjb25zb2xlLmVycm9yKCJFcnJvciB3aGlsZSBjb252ZXJ0aW5nIGFyZ3VtZW50IHRvIHN0cmluZyIsZSxuKSwiIn19fV0pLG59KCksTj1mdW5jdGlvbigpe3ZhciBlPW5ldyBJO3JldHVybiBlLmRlYnVnPWNvbnNvbGUuZGVidWcsZS5pbmZvPWNvbnNvbGUuaW5mbyxlLndhcm49Y29uc29sZS53YXJuLGUuZXJyb3I9Y29uc29sZS5lcnJvcixlfSxfPW5ldyBPO3QuZChuLCJhIixmdW5jdGlvbigpe3JldHVybiBMfSk7dmFyIEU9ZnVuY3Rpb24oKXt2YXIgZT1fLmdldExvZ2dlcih7fSksbj1zLmlzTmV0d29ya09ubGluZSgpLHQ9e3ByaW1hcnk6bnVsbCxzZWNvbmRhcnk6bnVsbH0sbz17cmVjb25uZWN0V2ViU29ja2V0OiEwLHdlYnNvY2tldEluaXRGYWlsZWQ6ITEsZXhwb25lbnRpYWxCYWNrT2ZmVGltZToxZTMsZXhwb25lbnRpYWxUaW1lb3V0SGFuZGxlOm51bGwsbGlmZVRpbWVUaW1lb3V0SGFuZGxlOm51bGwsd2ViU29ja2V0SW5pdENoZWNrZXJUaW1lb3V0SWQ6bnVsbCxjb25uU3RhdGU6bnVsbH0scj17Y29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQ6MCxjb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZTpudWxsLG5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wOm51bGx9LGk9e3BlbmRpbmdSZXNwb25zZTohMSxpbnRlcnZhbEhhbmRsZTpudWxsfSxjPXtpbml0RmFpbHVyZTpuZXcgU2V0LGdldFdlYlNvY2tldFRyYW5zcG9ydDpudWxsLHN1YnNjcmlwdGlvblVwZGF0ZTpuZXcgU2V0LHN1YnNjcmlwdGlvbkZhaWx1cmU6bmV3IFNldCx0b3BpYzpuZXcgTWFwLGFsbE1lc3NhZ2U6bmV3IFNldCxjb25uZWN0aW9uR2FpbjpuZXcgU2V0LGNvbm5lY3Rpb25Mb3N0Om5ldyBTZXQsY29ubmVjdGlvbk9wZW46bmV3IFNldCxjb25uZWN0aW9uQ2xvc2U6bmV3IFNldH0sYT17Y29ubkNvbmZpZzpudWxsLHByb21pc2VIYW5kbGU6bnVsbCxwcm9taXNlQ29tcGxldGVkOiEwfSx1PXtzdWJzY3JpYmVkOm5ldyBTZXQscGVuZGluZzpuZXcgU2V0LHN1YnNjcmlwdGlvbkhpc3Rvcnk6bmV3IFNldH0sbD17cmVzcG9uc2VDaGVja0ludGVydmFsSWQ6bnVsbCxyZXF1ZXN0Q29tcGxldGVkOiEwLHJlU3Vic2NyaWJlSW50ZXJ2YWxJZDpudWxsLGNvbnNlY3V0aXZlRmFpbGVkU3Vic2NyaWJlQXR0ZW1wdHM6MCxjb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0OjB9LG09bmV3IFNldChbZixwLGRdKSx5PXNldEludGVydmFsKGZ1bmN0aW9uKCl7aWYobiE9PXMuaXNOZXR3b3JrT25saW5lKCkpe2lmKCEobj1zLmlzTmV0d29ya09ubGluZSgpKSlyZXR1cm4gdm9pZCBlLmluZm8oIk5ldHdvcmsgb2ZmbGluZSIpO3ZhciB0PVQoKTtuJiYoIXR8fHYodCxXZWJTb2NrZXQuQ0xPU0lORyl8fHYodCxXZWJTb2NrZXQuQ0xPU0VEKSkmJihlLmluZm8oIk5ldHdvcmsgb25saW5lLCBjb25uZWN0aW5nIHRvIFdlYlNvY2tldCBzZXJ2ZXIiKSxHKCkpfX0sMjUwKSxTPWZ1bmN0aW9uKG4sdCl7bi5mb3JFYWNoKGZ1bmN0aW9uKG4pe3RyeXtuKHQpfWNhdGNoKG4pe2UuZXJyb3IoIkVycm9yIGV4ZWN1dGluZyBjYWxsYmFjayIsbil9fSl9LGs9ZnVuY3Rpb24oZSl7aWYobnVsbD09PWUpcmV0dXJuIk5VTEwiO3N3aXRjaChlLnJlYWR5U3RhdGUpe2Nhc2UgV2ViU29ja2V0LkNPTk5FQ1RJTkc6cmV0dXJuIkNPTk5FQ1RJTkciO2Nhc2UgV2ViU29ja2V0Lk9QRU46cmV0dXJuIk9QRU4iO2Nhc2UgV2ViU29ja2V0LkNMT1NJTkc6cmV0dXJuIkNMT1NJTkciO2Nhc2UgV2ViU29ja2V0LkNMT1NFRDpyZXR1cm4iQ0xPU0VEIjtkZWZhdWx0OnJldHVybiJVTkRFRklORUQifX0saD1mdW5jdGlvbigpe3ZhciBuPWFyZ3VtZW50cy5sZW5ndGg+MCYmdm9pZCAwIT09YXJndW1lbnRzWzBdP2FyZ3VtZW50c1swXToiIjtlLmRlYnVnKCJbIituKyJdIFByaW1hcnkgV2ViU29ja2V0OiAiK2sodC5wcmltYXJ5KSsiIHwgU2Vjb25kYXJ5IFdlYlNvY2tldDogIitrKHQuc2Vjb25kYXJ5KSl9LHY9ZnVuY3Rpb24oZSxuKXtyZXR1cm4gZSYmZS5yZWFkeVN0YXRlPT09bn0sdz1mdW5jdGlvbihlKXtyZXR1cm4gdihlLFdlYlNvY2tldC5PUEVOKX0sQz1mdW5jdGlvbihlKXtyZXR1cm4gbnVsbD09PWV8fHZvaWQgMD09PWUucmVhZHlTdGF0ZXx8dihlLFdlYlNvY2tldC5DTE9TRUQpfSxUPWZ1bmN0aW9uKCl7cmV0dXJuIG51bGwhPT10LnNlY29uZGFyeT90LnNlY29uZGFyeTp0LnByaW1hcnl9LE89ZnVuY3Rpb24oKXtyZXR1cm4gdyhUKCkpfSxJPWZ1bmN0aW9uKCl7aWYoaS5wZW5kaW5nUmVzcG9uc2UpcmV0dXJuIGUud2FybigiSGVhcnRiZWF0IHJlc3BvbnNlIG5vdCByZWNlaXZlZCIpLGNsZWFySW50ZXJ2YWwoaS5pbnRlcnZhbEhhbmRsZSksaS5wZW5kaW5nUmVzcG9uc2U9ITEsdm9pZCBHKCk7TygpPyhlLmRlYnVnKCJTZW5kaW5nIGhlYXJ0YmVhdCIpLFQoKS5zZW5kKFAoZCkpLGkucGVuZGluZ1Jlc3BvbnNlPSEwKTooZS53YXJuKCJGYWlsZWQgdG8gc2VuZCBoZWFydGJlYXQgc2luY2UgV2ViU29ja2V0IGlzIG5vdCBvcGVuIiksaCgic2VuZEhlYXJ0QmVhdCIpLEcoKSl9LFc9ZnVuY3Rpb24oKXtvLmV4cG9uZW50aWFsQmFja09mZlRpbWU9MWUzLGkucGVuZGluZ1Jlc3BvbnNlPSExLG8ucmVjb25uZWN0V2ViU29ja2V0PSEwLGNsZWFyVGltZW91dChvLmxpZmVUaW1lVGltZW91dEhhbmRsZSksY2xlYXJJbnRlcnZhbChpLmludGVydmFsSGFuZGxlKSxjbGVhclRpbWVvdXQoby5leHBvbmVudGlhbFRpbWVvdXRIYW5kbGUpLGNsZWFyVGltZW91dChvLndlYlNvY2tldEluaXRDaGVja2VyVGltZW91dElkKX0sTj1mdW5jdGlvbigpe2wuY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0cz0wLGwuY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdD0wLGNsZWFySW50ZXJ2YWwobC5yZXNwb25zZUNoZWNrSW50ZXJ2YWxJZCksY2xlYXJJbnRlcnZhbChsLnJlU3Vic2NyaWJlSW50ZXJ2YWxJZCl9LEU9ZnVuY3Rpb24oKXtyLmNvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50PTAsci5jb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZT1udWxsLHIubm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA9bnVsbH0sTD1mdW5jdGlvbigpe3RyeXtlLmluZm8oIldlYlNvY2tldCBjb25uZWN0aW9uIGVzdGFibGlzaGVkISIpLGgoIndlYlNvY2tldE9uT3BlbiIpLG51bGwhPT1vLmNvbm5TdGF0ZSYmby5jb25uU3RhdGUhPT1nfHxTKGMuY29ubmVjdGlvbkdhaW4pLG8uY29ublN0YXRlPWI7dmFyIG49RGF0ZS5ub3coKTtTKGMuY29ubmVjdGlvbk9wZW4se2Nvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50OnIuY29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQsY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU6ci5jb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZSxub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcDpyLm5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wLGNvbm5lY3Rpb25Fc3RhYmxpc2hlZFRpbWU6bix0aW1lVG9Db25uZWN0Om4tci5jb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZSx0aW1lV2l0aG91dENvbm5lY3Rpb246ci5ub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcD9uLXIubm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA6bnVsbH0pLEUoKSxXKCksVCgpLm9wZW5UaW1lc3RhbXA9RGF0ZS5ub3coKSwwPT09dS5zdWJzY3JpYmVkLnNpemUmJncodC5zZWNvbmRhcnkpJiZqKHQucHJpbWFyeSwiW1ByaW1hcnkgV2ViU29ja2V0XSBDbG9zaW5nIFdlYlNvY2tldCIpLCh1LnN1YnNjcmliZWQuc2l6ZT4wfHx1LnBlbmRpbmcuc2l6ZT4wKSYmKHcodC5zZWNvbmRhcnkpJiZlLmluZm8oIlN1YnNjcmliaW5nIHNlY29uZGFyeSB3ZWJzb2NrZXQgdG8gdG9waWNzIG9mIHByaW1hcnkgd2Vic29ja2V0IiksdS5zdWJzY3JpYmVkLmZvckVhY2goZnVuY3Rpb24oZSl7dS5zdWJzY3JpcHRpb25IaXN0b3J5LmFkZChlKSx1LnBlbmRpbmcuYWRkKGUpfSksdS5zdWJzY3JpYmVkLmNsZWFyKCksUigpKSxJKCksaS5pbnRlcnZhbEhhbmRsZT1zZXRJbnRlcnZhbChJLDFlNCk7dmFyIGw9TWF0aC5taW4ocy5hZGRKaXR0ZXIoM2U2LC4xKSwxZTMqYS5jb25uQ29uZmlnLndlYlNvY2tldFRyYW5zcG9ydC50cmFuc3BvcnRMaWZlVGltZUluU2Vjb25kcyk7ZS5kZWJ1ZygiU2NoZWR1bGluZyBXZWJTb2NrZXQgbWFuYWdlciByZWNvbm5lY3Rpb24sIGFmdGVyIGRlbGF5ICIrbCsiIG1zIiksby5saWZlVGltZVRpbWVvdXRIYW5kbGU9c2V0VGltZW91dChmdW5jdGlvbigpe2UuZGVidWcoIlN0YXJ0aW5nIHNjaGVkdWxlZCBXZWJTb2NrZXQgbWFuYWdlciByZWNvbm5lY3Rpb24iKSxHKCl9LGwpfWNhdGNoKG4pe2UuZXJyb3IoIkVycm9yIGFmdGVyIGVzdGFibGlzaGluZyBXZWJTb2NrZXQgY29ubmVjdGlvbiIsbil9fSxGPWZ1bmN0aW9uKG4pe2goIndlYlNvY2tldE9uRXJyb3IiKSxlLmVycm9yKCJXZWJTb2NrZXRNYW5hZ2VyIEVycm9yLCBlcnJvcl9ldmVudDogIixKU09OLnN0cmluZ2lmeShuKSksRygpfSx4PWZ1bmN0aW9uKG4pe3ZhciBvPUpTT04ucGFyc2Uobi5kYXRhKTtzd2l0Y2goby50b3BpYyl7Y2FzZSBmOmlmKGUuZGVidWcoIlN1YnNjcmlwdGlvbiBNZXNzYWdlIHJlY2VpdmVkIGZyb20gd2ViU29ja2V0IHNlcnZlciIsbi5kYXRhKSxsLnJlcXVlc3RDb21wbGV0ZWQ9ITAsbC5jb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0PTAsInN1Y2Nlc3MiPT09by5jb250ZW50LnN0YXR1cylsLmNvbnNlY3V0aXZlRmFpbGVkU3Vic2NyaWJlQXR0ZW1wdHM9MCxvLmNvbnRlbnQudG9waWNzLmZvckVhY2goZnVuY3Rpb24oZSl7dS5zdWJzY3JpcHRpb25IaXN0b3J5LmRlbGV0ZShlKSx1LnBlbmRpbmcuZGVsZXRlKGUpLHUuc3Vic2NyaWJlZC5hZGQoZSl9KSwwPT09dS5zdWJzY3JpcHRpb25IaXN0b3J5LnNpemU/dyh0LnNlY29uZGFyeSkmJihlLmluZm8oIlN1Y2Nlc3NmdWxseSBzdWJzY3JpYmVkIHNlY29uZGFyeSB3ZWJzb2NrZXQgdG8gYWxsIHRvcGljcyBvZiBwcmltYXJ5IHdlYnNvY2tldCIpLGoodC5wcmltYXJ5LCJbUHJpbWFyeSBXZWJTb2NrZXRdIENsb3NpbmcgV2ViU29ja2V0IikpOlIoKSxTKGMuc3Vic2NyaXB0aW9uVXBkYXRlLG8pO2Vsc2V7aWYoY2xlYXJJbnRlcnZhbChsLnJlU3Vic2NyaWJlSW50ZXJ2YWxJZCksKytsLmNvbnNlY3V0aXZlRmFpbGVkU3Vic2NyaWJlQXR0ZW1wdHMsNT09PWwuY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0cylyZXR1cm4gUyhjLnN1YnNjcmlwdGlvbkZhaWx1cmUsbyksdm9pZChsLmNvbnNlY3V0aXZlRmFpbGVkU3Vic2NyaWJlQXR0ZW1wdHM9MCk7bC5yZVN1YnNjcmliZUludGVydmFsSWQ9c2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXtSKCl9LDUwMCl9YnJlYWs7Y2FzZSBkOmUuZGVidWcoIkhlYXJ0YmVhdCByZXNwb25zZSByZWNlaXZlZCIpLGkucGVuZGluZ1Jlc3BvbnNlPSExO2JyZWFrO2RlZmF1bHQ6aWYoby50b3BpYyl7aWYoZS5kZWJ1ZygiTWVzc2FnZSByZWNlaXZlZCBmb3IgdG9waWMgIitvLnRvcGljKSx3KHQucHJpbWFyeSkmJncodC5zZWNvbmRhcnkpJiYwPT09dS5zdWJzY3JpcHRpb25IaXN0b3J5LnNpemUmJnRoaXM9PT10LnByaW1hcnkpcmV0dXJuIHZvaWQgZS53YXJuKCJJZ25vcmluZyBNZXNzYWdlIGZvciBUb3BpYyAiK28udG9waWMrIiwgdG8gYXZvaWQgZHVwbGljYXRlcyIpO2lmKDA9PT1jLmFsbE1lc3NhZ2Uuc2l6ZSYmMD09PWMudG9waWMuc2l6ZSlyZXR1cm4gdm9pZCBlLndhcm4oIk5vIHJlZ2lzdGVyZWQgY2FsbGJhY2sgbGlzdGVuZXIgZm9yIFRvcGljIixvLnRvcGljKTtTKGMuYWxsTWVzc2FnZSxvKSxjLnRvcGljLmhhcyhvLnRvcGljKSYmUyhjLnRvcGljLmdldChvLnRvcGljKSxvKX1lbHNlIG8ubWVzc2FnZT9lLndhcm4oIldlYlNvY2tldE1hbmFnZXIgTWVzc2FnZSBFcnJvciIsbyk6ZS53YXJuKCJJbnZhbGlkIGluY29taW5nIG1lc3NhZ2UiLG8pfX0sUj1mdW5jdGlvbiBuKCl7aWYobC5jb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0PjMpcmV0dXJuIGUud2FybigiSWdub3Jpbmcgc3Vic2NyaWJlUGVuZGluZ1RvcGljcyBzaW5jZSB3ZSBoYXZlIGV4aGF1c3RlZCBtYXggc3Vic2NyaXB0aW9uIHJldHJpZXMgd2l0aCBubyByZXNwb25zZSIpLHZvaWQgUyhjLnN1YnNjcmlwdGlvbkZhaWx1cmUscy5nZXRTdWJzY3JpcHRpb25SZXNwb25zZShmLCExLEFycmF5LmZyb20odS5wZW5kaW5nKSkpO08oKT8oY2xlYXJJbnRlcnZhbChsLnJlc3BvbnNlQ2hlY2tJbnRlcnZhbElkKSxUKCkuc2VuZChQKGYse3RvcGljczpBcnJheS5mcm9tKHUucGVuZGluZyl9KSksbC5yZXF1ZXN0Q29tcGxldGVkPSExLGwucmVzcG9uc2VDaGVja0ludGVydmFsSWQ9c2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXtsLnJlcXVlc3RDb21wbGV0ZWR8fCgrK2wuY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdCxuKCkpfSwxZTMpKTplLndhcm4oIklnbm9yaW5nIHN1YnNjcmliZVBlbmRpbmdUb3BpY3MgY2FsbCBzaW5jZSBEZWZhdWx0IFdlYlNvY2tldCBpcyBub3Qgb3BlbiIpfSxqPWZ1bmN0aW9uKG4sdCl7dihuLFdlYlNvY2tldC5DT05ORUNUSU5HKXx8dihuLFdlYlNvY2tldC5PUEVOKT9uLmNsb3NlKDFlMyx0KTplLndhcm4oIklnbm9yaW5nIFdlYlNvY2tldCBDbG9zZSByZXF1ZXN0LCBXZWJTb2NrZXQgU3RhdGU6ICIrayhuKSl9LE09ZnVuY3Rpb24oZSl7aih0LnByaW1hcnksIltQcmltYXJ5XSBXZWJTb2NrZXQgIitlKSxqKHQuc2Vjb25kYXJ5LCJbU2Vjb25kYXJ5XSBXZWJTb2NrZXQgIitlKX0sQT1mdW5jdGlvbigpe3IuY29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQrKzt2YXIgbj1zLmFkZEppdHRlcihvLmV4cG9uZW50aWFsQmFja09mZlRpbWUsLjMpO0RhdGUubm93KCkrbjw9YS5jb25uQ29uZmlnLnVybENvbm5WYWxpZFRpbWU/KGUuZGVidWcoIlNjaGVkdWxpbmcgV2ViU29ja2V0IHJlaW5pdGlhbGl6YXRpb24sIGFmdGVyIGRlbGF5ICIrbisiIG1zIiksby5leHBvbmVudGlhbFRpbWVvdXRIYW5kbGU9c2V0VGltZW91dChmdW5jdGlvbigpe3JldHVybiB6KCl9LG4pLG8uZXhwb25lbnRpYWxCYWNrT2ZmVGltZSo9Mik6KGUud2FybigiV2ViU29ja2V0IFVSTCBjYW5ub3QgYmUgdXNlZCB0byBlc3RhYmxpc2ggY29ubmVjdGlvbiIpLEcoKSl9LEQ9ZnVuY3Rpb24obil7VygpLE4oKSxlLmVycm9yKCJXZWJTb2NrZXQgSW5pdGlhbGl6YXRpb24gZmFpbGVkIiksby53ZWJzb2NrZXRJbml0RmFpbGVkPSEwLE0oIlRlcm1pbmF0aW5nIFdlYlNvY2tldCBNYW5hZ2VyIiksY2xlYXJJbnRlcnZhbCh5KSxTKGMuaW5pdEZhaWx1cmUse2Nvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50OnIuY29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQsY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU6ci5jb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZSxyZWFzb246bn0pLEUoKX0sUD1mdW5jdGlvbihlLG4pe3JldHVybiBKU09OLnN0cmluZ2lmeSh7dG9waWM6ZSxjb250ZW50Om59KX0sSD1mdW5jdGlvbihuKXtyZXR1cm4hIShzLmlzT2JqZWN0KG4pJiZzLmlzT2JqZWN0KG4ud2ViU29ja2V0VHJhbnNwb3J0KSYmcy5pc05vbkVtcHR5U3RyaW5nKG4ud2ViU29ja2V0VHJhbnNwb3J0LnVybCkmJnMudmFsaWRXU1VybChuLndlYlNvY2tldFRyYW5zcG9ydC51cmwpJiYxZTMqbi53ZWJTb2NrZXRUcmFuc3BvcnQudHJhbnNwb3J0TGlmZVRpbWVJblNlY29uZHM+PTNlNSl8fChlLmVycm9yKCJJbnZhbGlkIFdlYlNvY2tldCBDb25uZWN0aW9uIENvbmZpZ3VyYXRpb24iLG4pLCExKX0sRz1mdW5jdGlvbigpe2lmKHMuaXNOZXR3b3JrT25saW5lKCkpaWYoby53ZWJzb2NrZXRJbml0RmFpbGVkKWUuZGVidWcoIldlYlNvY2tldCBJbml0IGhhZCBmYWlsZWQsIGlnbm9yaW5nIHRoaXMgZ2V0V2ViU29ja2V0Q29ubkNvbmZpZyByZXF1ZXN0Iik7ZWxzZXtpZihhLnByb21pc2VDb21wbGV0ZWQpcmV0dXJuIFcoKSxlLmluZm8oIkZldGNoaW5nIG5ldyBXZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uIiksci5jb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZT1yLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lfHxEYXRlLm5vdygpLGEucHJvbWlzZUNvbXBsZXRlZD0hMSxhLnByb21pc2VIYW5kbGU9Yy5nZXRXZWJTb2NrZXRUcmFuc3BvcnQoKSxhLnByb21pc2VIYW5kbGUudGhlbihmdW5jdGlvbihuKXtyZXR1cm4gYS5wcm9taXNlQ29tcGxldGVkPSEwLGUuZGVidWcoIlN1Y2Nlc3NmdWxseSBmZXRjaGVkIHdlYlNvY2tldCBjb25uZWN0aW9uIGNvbmZpZ3VyYXRpb24iLG4pLEgobik/KGEuY29ubkNvbmZpZz1uLGEuY29ubkNvbmZpZy51cmxDb25uVmFsaWRUaW1lPURhdGUubm93KCkrODVlMyx6KCkpOihEKCJJbnZhbGlkIFdlYlNvY2tldCBjb25uZWN0aW9uIGNvbmZpZ3VyYXRpb246ICIrbikse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITB9KX0sZnVuY3Rpb24obil7cmV0dXJuIGEucHJvbWlzZUNvbXBsZXRlZD0hMCxlLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggd2ViU29ja2V0IGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbiIsbikse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITB9fSk7ZS5kZWJ1ZygiVGhlcmUgaXMgYW4gb25nb2luZyBnZXRXZWJTb2NrZXRDb25uQ29uZmlnIHJlcXVlc3QsIHRoaXMgcmVxdWVzdCB3aWxsIGJlIGlnbm9yZWQiKX1lbHNlIGUuaW5mbygiTmV0d29yayBvZmZsaW5lLCBpZ25vcmluZyB0aGlzIGdldFdlYlNvY2tldENvbm5Db25maWcgcmVxdWVzdCIpfSx6PWZ1bmN0aW9uKCl7aWYoby53ZWJzb2NrZXRJbml0RmFpbGVkKXJldHVybiBlLmluZm8oIndlYi1zb2NrZXQgaW5pdGlhbGl6aW5nIGhhZCBmYWlsZWQsIGFib3J0aW5nIHJlLWluaXQiKSx7d2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZDohMH07aWYoIXMuaXNOZXR3b3JrT25saW5lKCkpcmV0dXJuIGUud2FybigiU3lzdGVtIGlzIG9mZmxpbmUgYWJvcnRpbmcgd2ViLXNvY2tldCBpbml0Iikse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITB9O2UuaW5mbygiSW5pdGlhbGl6aW5nIFdlYnNvY2tldCBNYW5hZ2VyIiksaCgiaW5pdFdlYlNvY2tldCIpO3RyeXtpZihIKGEuY29ubkNvbmZpZykpe3ZhciBuPW51bGw7cmV0dXJuIHcodC5wcmltYXJ5KT8oZS5kZWJ1ZygiUHJpbWFyeSBTb2NrZXQgY29ubmVjdGlvbiBpcyBhbHJlYWR5IG9wZW4iKSx2KHQuc2Vjb25kYXJ5LFdlYlNvY2tldC5DT05ORUNUSU5HKXx8KGUuZGVidWcoIkVzdGFibGlzaGluZyBhIHNlY29uZGFyeSB3ZWItc29ja2V0IGNvbm5lY3Rpb24iKSx0LnNlY29uZGFyeT1VKCkpLG49dC5zZWNvbmRhcnkpOih2KHQucHJpbWFyeSxXZWJTb2NrZXQuQ09OTkVDVElORyl8fChlLmRlYnVnKCJFc3RhYmxpc2hpbmcgYSBwcmltYXJ5IHdlYi1zb2NrZXQgY29ubmVjdGlvbiIpLHQucHJpbWFyeT1VKCkpLG49dC5wcmltYXJ5KSxvLndlYlNvY2tldEluaXRDaGVja2VyVGltZW91dElkPXNldFRpbWVvdXQoZnVuY3Rpb24oKXt3KG4pfHxBKCl9LDFlMykse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITF9fX1jYXRjaChuKXtyZXR1cm4gZS5lcnJvcigiRXJyb3IgSW5pdGlhbGl6aW5nIHdlYi1zb2NrZXQtbWFuYWdlciIsbiksRCgiRmFpbGVkIHRvIGluaXRpYWxpemUgbmV3IFdlYlNvY2tldDogIituLm1lc3NhZ2UpLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfX19LFU9ZnVuY3Rpb24oKXt2YXIgbj1uZXcgV2ViU29ja2V0KGEuY29ubkNvbmZpZy53ZWJTb2NrZXRUcmFuc3BvcnQudXJsKTtyZXR1cm4gbi5hZGRFdmVudExpc3RlbmVyKCJvcGVuIixMKSxuLmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLHgpLG4uYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLEYpLG4uYWRkRXZlbnRMaXN0ZW5lcigiY2xvc2UiLGZ1bmN0aW9uKGkpe3JldHVybiBmdW5jdGlvbihuLGkpe2UuaW5mbygiU29ja2V0IGNvbm5lY3Rpb24gaXMgY2xvc2VkIixuKSxoKCJ3ZWJTb2NrZXRPbkNsb3NlIGJlZm9yZS1jbGVhbnVwIiksUyhjLmNvbm5lY3Rpb25DbG9zZSx7b3BlblRpbWVzdGFtcDppLm9wZW5UaW1lc3RhbXAsY2xvc2VUaW1lc3RhbXA6RGF0ZS5ub3coKSxjb25uZWN0aW9uRHVyYXRpb246RGF0ZS5ub3coKS1pLm9wZW5UaW1lc3RhbXAsY29kZTpuLmNvZGUscmVhc29uOm4ucmVhc29ufSksQyh0LnByaW1hcnkpJiYodC5wcmltYXJ5PW51bGwpLEModC5zZWNvbmRhcnkpJiYodC5zZWNvbmRhcnk9bnVsbCksby5yZWNvbm5lY3RXZWJTb2NrZXQmJih3KHQucHJpbWFyeSl8fHcodC5zZWNvbmRhcnkpP0ModC5wcmltYXJ5KSYmdyh0LnNlY29uZGFyeSkmJihlLmluZm8oIltQcmltYXJ5XSBXZWJTb2NrZXQgQ2xlYW5seSBDbG9zZWQiKSx0LnByaW1hcnk9dC5zZWNvbmRhcnksdC5zZWNvbmRhcnk9bnVsbCk6KGUud2FybigiTmVpdGhlciBwcmltYXJ5IHdlYnNvY2tldCBhbmQgbm9yIHNlY29uZGFyeSB3ZWJzb2NrZXQgaGF2ZSBvcGVuIGNvbm5lY3Rpb25zLCBhdHRlbXB0aW5nIHRvIHJlLWVzdGFibGlzaCBjb25uZWN0aW9uIiksby5jb25uU3RhdGU9PT1nP2UuaW5mbygiSWdub3JpbmcgY29ubmVjdGlvbkxvc3QgY2FsbGJhY2sgaW52b2NhdGlvbiIpOihTKGMuY29ubmVjdGlvbkxvc3Qse29wZW5UaW1lc3RhbXA6aS5vcGVuVGltZXN0YW1wLGNsb3NlVGltZXN0YW1wOkRhdGUubm93KCksY29ubmVjdGlvbkR1cmF0aW9uOkRhdGUubm93KCktaS5vcGVuVGltZXN0YW1wLGNvZGU6bi5jb2RlLHJlYXNvbjpuLnJlYXNvbn0pLHIubm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA9RGF0ZS5ub3coKSksby5jb25uU3RhdGU9ZyxHKCkpLGgoIndlYlNvY2tldE9uQ2xvc2UgYWZ0ZXItY2xlYW51cCIpKX0oaSxuKX0pLG59O3RoaXMuaW5pdD1mdW5jdGlvbihuKXtpZihzLmFzc2VydFRydWUocy5pc0Z1bmN0aW9uKG4pLCJ0cmFuc3BvcnRIYW5kbGUgbXVzdCBiZSBhIGZ1bmN0aW9uIiksbnVsbD09PWMuZ2V0V2ViU29ja2V0VHJhbnNwb3J0KXJldHVybiBjLmdldFdlYlNvY2tldFRyYW5zcG9ydD1uLEcoKTtlLndhcm4oIldlYiBTb2NrZXQgTWFuYWdlciB3YXMgYWxyZWFkeSBpbml0aWFsaXplZCIpfSx0aGlzLm9uSW5pdEZhaWx1cmU9ZnVuY3Rpb24oZSl7cmV0dXJuIHMuYXNzZXJ0VHJ1ZShzLmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuaW5pdEZhaWx1cmUuYWRkKGUpLG8ud2Vic29ja2V0SW5pdEZhaWxlZCYmZSgpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuaW5pdEZhaWx1cmUuZGVsZXRlKGUpfX0sdGhpcy5vbkNvbm5lY3Rpb25PcGVuPWZ1bmN0aW9uKGUpe3JldHVybiBzLmFzc2VydFRydWUocy5pc0Z1bmN0aW9uKGUpLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmNvbm5lY3Rpb25PcGVuLmFkZChlKSxmdW5jdGlvbigpe3JldHVybiBjLmNvbm5lY3Rpb25PcGVuLmRlbGV0ZShlKX19LHRoaXMub25Db25uZWN0aW9uQ2xvc2U9ZnVuY3Rpb24oZSl7cmV0dXJuIHMuYXNzZXJ0VHJ1ZShzLmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuY29ubmVjdGlvbkNsb3NlLmFkZChlKSxmdW5jdGlvbigpe3JldHVybiBjLmNvbm5lY3Rpb25DbG9zZS5kZWxldGUoZSl9fSx0aGlzLm9uQ29ubmVjdGlvbkdhaW49ZnVuY3Rpb24oZSl7cmV0dXJuIHMuYXNzZXJ0VHJ1ZShzLmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuY29ubmVjdGlvbkdhaW4uYWRkKGUpLE8oKSYmZSgpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuY29ubmVjdGlvbkdhaW4uZGVsZXRlKGUpfX0sdGhpcy5vbkNvbm5lY3Rpb25Mb3N0PWZ1bmN0aW9uKGUpe3JldHVybiBzLmFzc2VydFRydWUocy5pc0Z1bmN0aW9uKGUpLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmNvbm5lY3Rpb25Mb3N0LmFkZChlKSxvLmNvbm5TdGF0ZT09PWcmJmUoKSxmdW5jdGlvbigpe3JldHVybiBjLmNvbm5lY3Rpb25Mb3N0LmRlbGV0ZShlKX19LHRoaXMub25TdWJzY3JpcHRpb25VcGRhdGU9ZnVuY3Rpb24oZSl7cmV0dXJuIHMuYXNzZXJ0VHJ1ZShzLmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuc3Vic2NyaXB0aW9uVXBkYXRlLmFkZChlKSxmdW5jdGlvbigpe3JldHVybiBjLnN1YnNjcmlwdGlvblVwZGF0ZS5kZWxldGUoZSl9fSx0aGlzLm9uU3Vic2NyaXB0aW9uRmFpbHVyZT1mdW5jdGlvbihlKXtyZXR1cm4gcy5hc3NlcnRUcnVlKHMuaXNGdW5jdGlvbihlKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5zdWJzY3JpcHRpb25GYWlsdXJlLmFkZChlKSxmdW5jdGlvbigpe3JldHVybiBjLnN1YnNjcmlwdGlvbkZhaWx1cmUuZGVsZXRlKGUpfX0sdGhpcy5vbk1lc3NhZ2U9ZnVuY3Rpb24oZSxuKXtyZXR1cm4gcy5hc3NlcnROb3ROdWxsKGUsInRvcGljTmFtZSIpLHMuYXNzZXJ0VHJ1ZShzLmlzRnVuY3Rpb24obiksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMudG9waWMuaGFzKGUpP2MudG9waWMuZ2V0KGUpLmFkZChuKTpjLnRvcGljLnNldChlLG5ldyBTZXQoW25dKSksZnVuY3Rpb24oKXtyZXR1cm4gYy50b3BpYy5nZXQoZSkuZGVsZXRlKG4pfX0sdGhpcy5vbkFsbE1lc3NhZ2U9ZnVuY3Rpb24oZSl7cmV0dXJuIHMuYXNzZXJ0VHJ1ZShzLmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuYWxsTWVzc2FnZS5hZGQoZSksZnVuY3Rpb24oKXtyZXR1cm4gYy5hbGxNZXNzYWdlLmRlbGV0ZShlKX19LHRoaXMuc3Vic2NyaWJlVG9waWNzPWZ1bmN0aW9uKGUpe3MuYXNzZXJ0Tm90TnVsbChlLCJ0b3BpY3MiKSxzLmFzc2VydElzTGlzdChlKSxlLmZvckVhY2goZnVuY3Rpb24oZSl7dS5zdWJzY3JpYmVkLmhhcyhlKXx8dS5wZW5kaW5nLmFkZChlKX0pLGwuY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdD0wLFIoKX0sdGhpcy5zZW5kTWVzc2FnZT1mdW5jdGlvbihuKXtpZihzLmFzc2VydElzT2JqZWN0KG4sInBheWxvYWQiKSx2b2lkIDA9PT1uLnRvcGljfHxtLmhhcyhuLnRvcGljKSllLndhcm4oIkNhbm5vdCBzZW5kIG1lc3NhZ2UsIEludmFsaWQgdG9waWMiLG4pO2Vsc2V7dHJ5e249SlNPTi5zdHJpbmdpZnkobil9Y2F0Y2godCl7cmV0dXJuIHZvaWQgZS53YXJuKCJFcnJvciBzdHJpbmdpZnkgbWVzc2FnZSIsbil9TygpP1QoKS5zZW5kKG4pOmUud2FybigiQ2Fubm90IHNlbmQgbWVzc2FnZSwgd2ViIHNvY2tldCBjb25uZWN0aW9uIGlzIG5vdCBvcGVuIil9fSx0aGlzLmNsb3NlV2ViU29ja2V0PWZ1bmN0aW9uKCl7VygpLE4oKSxvLnJlY29ubmVjdFdlYlNvY2tldD0hMSxjbGVhckludGVydmFsKHkpLE0oIlVzZXIgcmVxdWVzdCB0byBjbG9zZSBXZWJTb2NrZXQiKX0sdGhpcy50ZXJtaW5hdGVXZWJTb2NrZXRNYW5hZ2VyPUR9LEw9e2NyZWF0ZTpmdW5jdGlvbigpe3JldHVybiBuZXcgRX0sc2V0R2xvYmFsQ29uZmlnOmZ1bmN0aW9uKGUpe3ZhciBuPWUubG9nZ2VyQ29uZmlnO18udXBkYXRlTG9nZ2VyQ29uZmlnKG4pfSxMb2dMZXZlbDpULExvZ2dlcjpDfX0sZnVuY3Rpb24oZSxuLHQpe3ZhciBvOyFmdW5jdGlvbigpeyJ1c2Ugc3RyaWN0Ijt2YXIgcj17bm90X3N0cmluZzovW15zXS8sbm90X2Jvb2w6L1tedF0vLG5vdF90eXBlOi9bXlRdLyxub3RfcHJpbWl0aXZlOi9bXnZdLyxudW1iZXI6L1tkaWVmZ10vLG51bWVyaWNfYXJnOi9bYmNkaWVmZ3V4WF0vLGpzb246L1tqXS8sbm90X2pzb246L1teal0vLHRleHQ6L15bXlx4MjVdKy8sbW9kdWxvOi9eXHgyNXsyfS8scGxhY2Vob2xkZXI6L15ceDI1KD86KFsxLTldXGQqKVwkfFwoKFteKV0rKVwpKT8oXCspPygwfCdbXiRdKT8oLSk/KFxkKyk/KD86XC4oXGQrKSk/KFtiLWdpam9zdFR1dnhYXSkvLGtleTovXihbYS16X11bYS16X1xkXSopL2ksa2V5X2FjY2VzczovXlwuKFthLXpfXVthLXpfXGRdKikvaSxpbmRleF9hY2Nlc3M6L15cWyhcZCspXF0vLHNpZ246L15bKy1dL307ZnVuY3Rpb24gaShlKXtyZXR1cm4gZnVuY3Rpb24oZSxuKXt2YXIgdCxvLGMscyxhLHUsbCxmLHAsZD0xLGI9ZS5sZW5ndGgsZz0iIjtmb3Iobz0wO288YjtvKyspaWYoInN0cmluZyI9PXR5cGVvZiBlW29dKWcrPWVbb107ZWxzZSBpZigib2JqZWN0Ij09dHlwZW9mIGVbb10pe2lmKChzPWVbb10pLmtleXMpZm9yKHQ9bltkXSxjPTA7YzxzLmtleXMubGVuZ3RoO2MrKyl7aWYobnVsbD09dCl0aHJvdyBuZXcgRXJyb3IoaSgnW3NwcmludGZdIENhbm5vdCBhY2Nlc3MgcHJvcGVydHkgIiVzIiBvZiB1bmRlZmluZWQgdmFsdWUgIiVzIicscy5rZXlzW2NdLHMua2V5c1tjLTFdKSk7dD10W3Mua2V5c1tjXV19ZWxzZSB0PXMucGFyYW1fbm8/bltzLnBhcmFtX25vXTpuW2QrK107aWYoci5ub3RfdHlwZS50ZXN0KHMudHlwZSkmJnIubm90X3ByaW1pdGl2ZS50ZXN0KHMudHlwZSkmJnQgaW5zdGFuY2VvZiBGdW5jdGlvbiYmKHQ9dCgpKSxyLm51bWVyaWNfYXJnLnRlc3Qocy50eXBlKSYmIm51bWJlciIhPXR5cGVvZiB0JiZpc05hTih0KSl0aHJvdyBuZXcgVHlwZUVycm9yKGkoIltzcHJpbnRmXSBleHBlY3RpbmcgbnVtYmVyIGJ1dCBmb3VuZCAlVCIsdCkpO3N3aXRjaChyLm51bWJlci50ZXN0KHMudHlwZSkmJihmPXQ+PTApLHMudHlwZSl7Y2FzZSJiIjp0PXBhcnNlSW50KHQsMTApLnRvU3RyaW5nKDIpO2JyZWFrO2Nhc2UiYyI6dD1TdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KHQsMTApKTticmVhaztjYXNlImQiOmNhc2UiaSI6dD1wYXJzZUludCh0LDEwKTticmVhaztjYXNlImoiOnQ9SlNPTi5zdHJpbmdpZnkodCxudWxsLHMud2lkdGg/cGFyc2VJbnQocy53aWR0aCk6MCk7YnJlYWs7Y2FzZSJlIjp0PXMucHJlY2lzaW9uP3BhcnNlRmxvYXQodCkudG9FeHBvbmVudGlhbChzLnByZWNpc2lvbik6cGFyc2VGbG9hdCh0KS50b0V4cG9uZW50aWFsKCk7YnJlYWs7Y2FzZSJmIjp0PXMucHJlY2lzaW9uP3BhcnNlRmxvYXQodCkudG9GaXhlZChzLnByZWNpc2lvbik6cGFyc2VGbG9hdCh0KTticmVhaztjYXNlImciOnQ9cy5wcmVjaXNpb24/U3RyaW5nKE51bWJlcih0LnRvUHJlY2lzaW9uKHMucHJlY2lzaW9uKSkpOnBhcnNlRmxvYXQodCk7YnJlYWs7Y2FzZSJvIjp0PShwYXJzZUludCh0LDEwKT4+PjApLnRvU3RyaW5nKDgpO2JyZWFrO2Nhc2UicyI6dD1TdHJpbmcodCksdD1zLnByZWNpc2lvbj90LnN1YnN0cmluZygwLHMucHJlY2lzaW9uKTp0O2JyZWFrO2Nhc2UidCI6dD1TdHJpbmcoISF0KSx0PXMucHJlY2lzaW9uP3Quc3Vic3RyaW5nKDAscy5wcmVjaXNpb24pOnQ7YnJlYWs7Y2FzZSJUIjp0PU9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh0KS5zbGljZSg4LC0xKS50b0xvd2VyQ2FzZSgpLHQ9cy5wcmVjaXNpb24/dC5zdWJzdHJpbmcoMCxzLnByZWNpc2lvbik6dDticmVhaztjYXNlInUiOnQ9cGFyc2VJbnQodCwxMCk+Pj4wO2JyZWFrO2Nhc2UidiI6dD10LnZhbHVlT2YoKSx0PXMucHJlY2lzaW9uP3Quc3Vic3RyaW5nKDAscy5wcmVjaXNpb24pOnQ7YnJlYWs7Y2FzZSJ4Ijp0PShwYXJzZUludCh0LDEwKT4+PjApLnRvU3RyaW5nKDE2KTticmVhaztjYXNlIlgiOnQ9KHBhcnNlSW50KHQsMTApPj4+MCkudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCl9ci5qc29uLnRlc3Qocy50eXBlKT9nKz10Oighci5udW1iZXIudGVzdChzLnR5cGUpfHxmJiYhcy5zaWduP3A9IiI6KHA9Zj8iKyI6Ii0iLHQ9dC50b1N0cmluZygpLnJlcGxhY2Uoci5zaWduLCIiKSksdT1zLnBhZF9jaGFyPyIwIj09PXMucGFkX2NoYXI/IjAiOnMucGFkX2NoYXIuY2hhckF0KDEpOiIgIixsPXMud2lkdGgtKHArdCkubGVuZ3RoLGE9cy53aWR0aCYmbD4wP3UucmVwZWF0KGwpOiIiLGcrPXMuYWxpZ24/cCt0K2E6IjAiPT09dT9wK2ErdDphK3ArdCl9cmV0dXJuIGd9KGZ1bmN0aW9uKGUpe2lmKHNbZV0pcmV0dXJuIHNbZV07dmFyIG4sdD1lLG89W10saT0wO2Zvcig7dDspe2lmKG51bGwhPT0obj1yLnRleHQuZXhlYyh0KSkpby5wdXNoKG5bMF0pO2Vsc2UgaWYobnVsbCE9PShuPXIubW9kdWxvLmV4ZWModCkpKW8ucHVzaCgiJSIpO2Vsc2V7aWYobnVsbD09PShuPXIucGxhY2Vob2xkZXIuZXhlYyh0KSkpdGhyb3cgbmV3IFN5bnRheEVycm9yKCJbc3ByaW50Zl0gdW5leHBlY3RlZCBwbGFjZWhvbGRlciIpO2lmKG5bMl0pe2l8PTE7dmFyIGM9W10sYT1uWzJdLHU9W107aWYobnVsbD09PSh1PXIua2V5LmV4ZWMoYSkpKXRocm93IG5ldyBTeW50YXhFcnJvcigiW3NwcmludGZdIGZhaWxlZCB0byBwYXJzZSBuYW1lZCBhcmd1bWVudCBrZXkiKTtmb3IoYy5wdXNoKHVbMV0pOyIiIT09KGE9YS5zdWJzdHJpbmcodVswXS5sZW5ndGgpKTspaWYobnVsbCE9PSh1PXIua2V5X2FjY2Vzcy5leGVjKGEpKSljLnB1c2godVsxXSk7ZWxzZXtpZihudWxsPT09KHU9ci5pbmRleF9hY2Nlc3MuZXhlYyhhKSkpdGhyb3cgbmV3IFN5bnRheEVycm9yKCJbc3ByaW50Zl0gZmFpbGVkIHRvIHBhcnNlIG5hbWVkIGFyZ3VtZW50IGtleSIpO2MucHVzaCh1WzFdKX1uWzJdPWN9ZWxzZSBpfD0yO2lmKDM9PT1pKXRocm93IG5ldyBFcnJvcigiW3NwcmludGZdIG1peGluZyBwb3NpdGlvbmFsIGFuZCBuYW1lZCBwbGFjZWhvbGRlcnMgaXMgbm90ICh5ZXQpIHN1cHBvcnRlZCIpO28ucHVzaCh7cGxhY2Vob2xkZXI6blswXSxwYXJhbV9ubzpuWzFdLGtleXM6blsyXSxzaWduOm5bM10scGFkX2NoYXI6bls0XSxhbGlnbjpuWzVdLHdpZHRoOm5bNl0scHJlY2lzaW9uOm5bN10sdHlwZTpuWzhdfSl9dD10LnN1YnN0cmluZyhuWzBdLmxlbmd0aCl9cmV0dXJuIHNbZV09b30oZSksYXJndW1lbnRzKX1mdW5jdGlvbiBjKGUsbil7cmV0dXJuIGkuYXBwbHkobnVsbCxbZV0uY29uY2F0KG58fFtdKSl9dmFyIHM9T2JqZWN0LmNyZWF0ZShudWxsKTtuLnNwcmludGY9aSxuLnZzcHJpbnRmPWMsInVuZGVmaW5lZCIhPXR5cGVvZiB3aW5kb3cmJih3aW5kb3cuc3ByaW50Zj1pLHdpbmRvdy52c3ByaW50Zj1jLHZvaWQgMD09PShvPWZ1bmN0aW9uKCl7cmV0dXJue3NwcmludGY6aSx2c3ByaW50ZjpjfX0uY2FsbChuLHQsbixlKSl8fChlLmV4cG9ydHM9bykpfSgpfSxmdW5jdGlvbihlLG4sdCl7InVzZSBzdHJpY3QiO3QucihuKSxmdW5jdGlvbihlKXt0LmQobiwiV2ViU29ja2V0TWFuYWdlciIsZnVuY3Rpb24oKXtyZXR1cm4gcn0pO3ZhciBvPXQoMCk7ZS5jb25uZWN0PWUuY29ubmVjdHx8e30sY29ubmVjdC5XZWJTb2NrZXRNYW5hZ2VyPW8uYTt2YXIgcj1vLmF9LmNhbGwodGhpcyx0KDMpKX0sZnVuY3Rpb24oZSxuKXt2YXIgdDt0PWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXN9KCk7dHJ5e3Q9dHx8bmV3IEZ1bmN0aW9uKCJyZXR1cm4gdGhpcyIpKCl9Y2F0Y2goZSl7Im9iamVjdCI9PXR5cGVvZiB3aW5kb3cmJih0PXdpbmRvdyl9ZS5leHBvcnRzPXR9XSk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPWFtYXpvbi1jb25uZWN0LXdlYnNvY2tldC1tYW5hZ2VyLmpzLm1hcAoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgY29ubmVjdC5jb3JlID0ge307CiAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gZmFsc2U7CiAgY29ubmVjdC52ZXJzaW9uID0gIjEuNi4wIjsKICBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRSA9IDUwMDsKIAogIHZhciBDQ1BfU1lOX1RJTUVPVVQgPSAxMDAwOyAvLyAxIHNlYwogIHZhciBDQ1BfQUNLX1RJTUVPVVQgPSAzMDAwOyAvLyAzIHNlYwogIHZhciBDQ1BfTE9BRF9USU1FT1VUID0gMzAwMDsgLy8gMyBzZWMKICB2YXIgQ0NQX0lGUkFNRV9SRUZSRVNIX0lOVEVSVkFMID0gNTAwMDsgLy8gNSBzZWMKICB2YXIgQ0NQX0RSX0lGUkFNRV9SRUZSRVNIX0lOVEVSVkFMID0gMTAwMDA7IC8vMTAgcwogCiAgdmFyIExPR0lOX1VSTF9QQVRURVJOID0gImh0dHBzOi8ve2FsaWFzfS5hd3NhcHBzLmNvbS9hdXRoLz9jbGllbnRfaWQ9e2NsaWVudF9pZH0mcmVkaXJlY3RfdXJpPXtyZWRpcmVjdH0iOwogIHZhciBDTElFTlRfSURfTUFQID0gewogICAgInVzLWVhc3QtMSI6ICIwNjkxOWY0ZmQ4ZWQzMjRlIgogIH07CiAKICB2YXIgQVVUSE9SSVpFX0VORFBPSU5UID0gIi9jb25uZWN0L2F1dGgvYXV0aG9yaXplIjsKICB2YXIgQVVUSE9SSVpFX1JFVFJZX0lOVEVSVkFMID0gMjAwMDsKICB2YXIgQVVUSE9SSVpFX01BWF9SRVRSWSA9IDU7CiAKICB2YXIgV0hJVEVMSVNURURfT1JJR0lOU19FTkRQT0lOVCA9ICIvY29ubmVjdC93aGl0ZWxpc3RlZC1vcmlnaW5zIjsKICB2YXIgV0hJVEVMSVNURURfT1JJR0lOU19SRVRSWV9JTlRFUlZBTCA9IDIwMDA7CiAgdmFyIFdISVRFTElTVEVEX09SSUdJTlNfTUFYX1JFVFJZID0gNTsKIAogIC8qKgogICAqIEBkZXByZWNhdGVkCiAgICogV2Ugd2lsbCBubyBsb25nZXIgbmVlZCB0aGlzIGZ1bmN0aW9uIHNvb24uCiAgICovCiAgdmFyIGNyZWF0ZUxvZ2luVXJsID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgdmFyIHJlZGlyZWN0ID0gImh0dHBzOi8vbGlseS51cy1lYXN0LTEuYW1hem9uYXdzLmNvbS90YXcvYXV0aC9jb2RlIjsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChyZWRpcmVjdCk7CiAKICAgIGlmIChwYXJhbXMubG9naW5VcmwpIHsKICAgICAgcmV0dXJuIHBhcmFtcy5sb2dpblVybAogICAgfSBlbHNlIGlmIChwYXJhbXMuYWxpYXMpIHsKICAgICAgcmV0dXJuIExPR0lOX1VSTF9QQVRURVJOCiAgICAgICAgLnJlcGxhY2UoInthbGlhc30iLCBwYXJhbXMuYWxpYXMpCiAgICAgICAgLnJlcGxhY2UoIntjbGllbnRfaWR9IiwgQ0xJRU5UX0lEX01BUFsidXMtZWFzdC0xIl0pCiAgICAgICAgLnJlcGxhY2UoIntyZWRpcmVjdH0iLCBnbG9iYWwuZW5jb2RlVVJJQ29tcG9uZW50KAogICAgICAgICAgcmVkaXJlY3QpKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBwYXJhbXMuY2NwVXJsOwogICAgfQogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBSZXR1cm5zIHNjaGVtZTovL2hvc3Q6cG9ydCBmb3IgYSBnaXZlbiB1cmwKICAqLwogIGZ1bmN0aW9uIHNhbml0aXplRG9tYWluKHVybCkgewogICAgdmFyIGRvbWFpbiA9IHVybC5tYXRjaCgvXig/Omh0dHBzPzpcL1wvKT8oPzpbXkBcbl0rQCk/KD86d3d3XC4pPyhbXjpcL1xuP10rKS9pZyk7CiAgICByZXR1cm4gZG9tYWluLmxlbmd0aCA/IGRvbWFpblswXSA6ICIiOwogIH0KIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogUHJpbnQgYSB3YXJuaW5nIG1lc3NhZ2UgaWYgdGhlIENvbm5lY3QgY29yZSBpcyBub3QgaW5pdGlhbGl6ZWQuCiAgICAqLwogIGNvbm5lY3QuY29yZS5jaGVja05vdEluaXRpYWxpemVkID0gZnVuY3Rpb24gKCkgewogICAgaWYgKGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCkgewogICAgICB2YXIgbG9nID0gY29ubmVjdC5nZXRMb2coKTsKICAgICAgbG9nLndhcm4oIkNvbm5lY3QgY29yZSBhbHJlYWR5IGluaXRpYWxpemVkLCBvbmx5IG5lZWRzIHRvIGJlIGluaXRpYWxpemVkIG9uY2UuIik7CiAgICB9CiAgfTsKIAogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogRElTQVNURVIgUkVDT1ZFUlkgCiAgKi8KICAKICB2YXIgbWFrZUFnZW50T2ZmbGluZSA9IGZ1bmN0aW9uKGFnZW50LCBjYWxsYmFja3MpIHsKICAgIHZhciBvZmZsaW5lU3RhdGUgPSBhZ2VudC5nZXRBZ2VudFN0YXRlcygpLmZpbmQoZnVuY3Rpb24gKHN0YXRlKSB7CiAgICAgIHJldHVybiBzdGF0ZS50eXBlID09PSBjb25uZWN0LkFnZW50U3RhdGVUeXBlLk9GRkxJTkU7CiAgICB9KTsKICAgIGFnZW50LnNldFN0YXRlKG9mZmxpbmVTdGF0ZSwgY2FsbGJhY2tzKTsgICAKICB9CiAKICAvLyBTdXBwcmVzcyBDb250YWN0cyBmdW5jdGlvbiAKICAvLyBUaGlzIGlzIHVzZWQgYnkgRGlzYXN0ZXIgUmVjb3ZlcnkgYXMgYSBzYWZlZ3VhcmQgdG8gbm90IHN1cmZhY2UgaW5jb21pbmcgY2FsbHMvY2hhdHMgdG8gVUkKICAvLyAKICB2YXIgc3VwcHJlc3NDb250YWN0cyA9IGZ1bmN0aW9uIChpc1N1cHByZXNzZWQpIHsKICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBTaWduYWwgc2hhcmVkd29ya2VyIHRvIHNldCBjb250YWN0cyBzdXBwcmVzc29yIHRvICVzIGZvciBpbnN0YW5jZSAlcy4iLCAKICAgICAgaXNTdXBwcmVzc2VkLCBjb25uZWN0LmNvcmUucmVnaW9uCiAgICApOwogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5TVVBQUkVTUywgewogICAgICBzdXBwcmVzczogaXNTdXBwcmVzc2VkCiAgICB9KTsKICB9CiAKICB2YXIgc2V0Rm9yY2VPZmZsaW5lVXBzdHJlYW0gPSBmdW5jdGlvbihvZmZsaW5lKSB7CiAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltESVNBU1RFUiBSRUNPVkVSWV0gU2lnbmFsIHNoYXJlZHdvcmtlciB0byBzZXQgZm9yY2VPZmZsaW5lIHRvICVzIGZvciBpbnN0YW5jZSAlcy4iLCAKICAgICAgb2ZmbGluZSwgY29ubmVjdC5jb3JlLnJlZ2lvbgogICAgKTsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuRk9SQ0VfT0ZGTElORSwgewogICAgICBvZmZsaW5lOiBvZmZsaW5lCiAgICB9KTsKICB9CiAKICAvLyBGb3JjZSB0aGUgaW5zdGFuY2UgdG8gYmUgb2ZmbGluZS4gCiAgLy8gVGhpcyB0cmllcyB0byBkaXNjb25uZWN0IGFsbCBjb250YWN0cyAoSGFyZCBzdG9wKQogIC8vIGlmIGR1ZSB0byBhIGZhaWx1cmUgKHRoZSBiYWNrZW5kIGlzIG5vdCByZWFjaGFibGUpLCBzaWduYWwgdGhlIHNoYXJlZCB3b3JrZXIgdG8gZm9yY2Vfb2ZmbGluZSB3aGVuIGl0IHdha2VzIHVwIGFnYWluCiAgLy8gVGhpcyBmdW5jdGlvbiBzaG91bGQgb25seSBiZSByYW4gZnJvbSBuYXRpdmUgQ0NQIGZvciBkaXNjb25uZWN0aW5nIGNoYXRzLgogIHZhciBmb3JjZU9mZmxpbmUgPSBmdW5jdGlvbigpIHsKICAgIHZhciBsb2cgPSBjb25uZWN0LmdldExvZygpOwogICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gQXR0ZW1wdGluZyB0byBmb3JjZSBpbnN0YW5jZSAlcyBvZmZsaW5lIiwgY29ubmVjdC5jb3JlLnJlZ2lvbik7CiAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uKGFnZW50KSB7CiAgICAgIHZhciBjb250YWN0Q2xvc2VkID0gMDsKICAgICAgdmFyIGNvbnRhY3RzID0gYWdlbnQuZ2V0Q29udGFjdHMoKTsKICAgICAgaWYgKGNvbnRhY3RzLmxlbmd0aCkgewogICAgICAgIGNvbnRhY3RzLmZvckVhY2goZnVuY3Rpb24oY29udGFjdCkgCiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbnRhY3QuZ2V0QWdlbnRDb25uZWN0aW9uKCkuZGVzdHJveSh7CiAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAvLyBjaGVjayBpZiBhbGwgYWN0aXZlIGNvbnRhY3RzIGFyZSBjbG9zZWQKICAgICAgICAgICAgICAgIGlmICgrK2NvbnRhY3RDbG9zZWQgPT09IGNvbnRhY3RzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICBzZXRGb3JjZU9mZmxpbmVVcHN0cmVhbShmYWxzZSk7CiAgICAgICAgICAgICAgICAgIC8vIEl0J3Mgb2sgaWYgd2UncmUgbm90IGFibGUgdG8gcHV0IHRoZSBhZ2VudCBvZmZsaW5lLiAKICAgICAgICAgICAgICAgICAgLy8gc2luY2Ugd2UncmUgc3VwcHJlc3NpbmcgdGhlIGFnZW50cyBjb250YWN0cyBhbHJlYWR5LiAKICAgICAgICAgICAgICAgICAgbWFrZUFnZW50T2ZmbGluZShhZ2VudCk7CiAgICAgICAgICAgICAgICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIEluc3RhbmNlICVzIGlzIG5vdyBvZmZsaW5lIiwgY29ubmVjdC5jb3JlLnJlZ2lvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICAgIGxvZy53YXJuKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIEFuIGVycm9yIG9jY3VyZWQgd2hpbGUgYXR0ZW1wdGluZyB0byBmb3JjZSB0aGlzIGluc3RhbmNlIHRvIG9mZmxpbmUgaW4gcmVnaW9uICVzIiwgY29ubmVjdC5jb3JlLnJlZ2lvbik7CiAgICAgICAgICAgICAgICBsb2cud2FybihlcnIpOwogICAgICAgICAgICAgICAgLy8gc2lnbmFsIHRoZSBzaGFyZWR3b3JrZXIgdG8gY2FsbCBmb3JjZU9mZmxpbmUgYWdhaW4gd2hlbiBuZXR3b3JrIGNvbm5lY3Rpb24gCiAgICAgICAgICAgICAgICAvLyBoYXMgYmVlbiByZS1lc3RhYmxpc2hlZCAodGhpcyBoYXBwZW5zIGluIGNhc2Ugb2YgbmV0d29yayBvciBiYWNrZW5kIGZhaWx1cmVzKQogICAgICAgICAgICAgICAgc2V0Rm9yY2VPZmZsaW5lVXBzdHJlYW0odHJ1ZSk7CiAgICAgICAgICAgIH19KTsKICAgICAgICAgIH0KICAgICAgICApICAgICAgICAKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXRGb3JjZU9mZmxpbmVVcHN0cmVhbShmYWxzZSk7CiAgICAgICAgbWFrZUFnZW50T2ZmbGluZShhZ2VudCk7CiAgICAgICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gSW5zdGFuY2UgJXMgaXMgbm93IG9mZmxpbmUiLCBjb25uZWN0LmNvcmUucmVnaW9uKTsgIAogICAgICB9CiAgICB9KTsKICB9CiAKICAvL0luaXRpYXRlIERpc2FzdGVyIFJlY292ZXJ5IChUaGlzIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBmcm9tIGN1c3RvbUNDUCB0aGF0IGFyZSBEUiBlbmFibGVkKQogIGNvbm5lY3QuY29yZS5pbml0RGlzYXN0ZXJSZWNvdmVyeSA9IGZ1bmN0aW9uKHBhcmFtcykgewogICAgdmFyIGxvZyA9IGNvbm5lY3QuZ2V0TG9nKCk7CiAgICBjb25uZWN0LmNvcmUucmVnaW9uID0gcGFyYW1zLnJlZ2lvbjsKICAgIGNvbm5lY3QuY29yZS5zdXBwcmVzc0NvbnRhY3RzID0gc3VwcHJlc3NDb250YWN0czsgIAogICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSA9IGZvcmNlT2ZmbGluZTsKCiAgICAvL1JlZ2lzdGVyIGlmcmFtZSBsaXN0bmVyIHRvIHNldCBuYXRpdmUgQ0NQIG9mZmxpbmUKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuU0VUX09GRkxJTkUsIGZ1bmN0aW9uKCkgewogICAgICBjb25uZWN0LmNvcmUuZm9yY2VPZmZsaW5lKCk7CiAgICB9KTsKIAogICAgLy8gUmVnaXN0ZXIgRXZlbnQgbGlzdG5lciB0byBGb3JjZSB0aGUgQWdlbnQgdG8gYmUgb2ZmbGluZSB3aGVuIHNoYXJlZCB3b3JrZXIgcmVjb3ZlcnMgZnJvbSBuZXR3b3JrIGZhaWx1cmUKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLkZPUkNFX09GRkxJTkUsIGZ1bmN0aW9uKCkgewogICAgICBjb25uZWN0LmNvcmUuZm9yY2VPZmZsaW5lKCk7CiAgICB9KTsKCiAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNPRlRQSE9ORSwgCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIEluaXRpYWxpemluZyByZWdpb24gJXMgYXMgcGFydCBvZiBhIERpc2FzdGVyIFJlY292ZXJ5IGZsZWV0IiwgY29ubmVjdC5jb3JlLnJlZ2lvbik7CiAgICAgIH0sIAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSAlcyBhbHJlYWR5IHBhcnQgb2YgYSBEaXNhc3RlciBSZWNvdmVyeSBmbGVldCIsIGNvbm5lY3QuY29yZS5yZWdpb24pOwogICAgICB9KTsKCiAgICBpZiAoIXBhcmFtcy5pc1ByaW1hcnkpIHsKICAgICAgY29ubmVjdC5jb3JlLnN1cHByZXNzQ29udGFjdHModHJ1ZSk7CiAgICAgIGNvbm5lY3QuY29yZS5mb3JjZU9mZmxpbmUoKTsKICAgICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gJXMgaW5zdGFuY2UgaXMgc2V0IHRvIHN0YW5kLWJ5IiwgY29ubmVjdC5jb3JlLnJlZ2lvbik7CiAgICB9IGVsc2UgewogICAgICBjb25uZWN0LmNvcmUuc3VwcHJlc3NDb250YWN0cyhmYWxzZSk7CiAgICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldICVzIGluc3RhbmNlIGlzIHNldCB0byBwcmltYXJ5IiwgY29ubmVjdC5jb3JlLnJlZ2lvbik7CiAgICB9CiAgfQogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEJhc2ljIENvbm5lY3QgY2xpZW50IGluaXRpYWxpemF0aW9uLgogICAqIFNob3VsZCBiZSB1c2VkIG9ubHkgYnkgdGhlIEFQSSBTaGFyZWQgV29ya2VyLgogICAqLwogIGNvbm5lY3QuY29yZS5pbml0ID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5jb3JlLmV2ZW50QnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoKTsKICAgIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlciA9IG5ldyBBZ2VudERhdGFQcm92aWRlcihjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKSk7CiAgICBjb25uZWN0LmNvcmUuaW5pdENsaWVudChwYXJhbXMpOwogICAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gdHJ1ZTsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEluaXRpYWxpemVkIEFXUyBjbGllbnQKICAgKiBTaG91bGQgYmUgdXNlZCBieSBTaGFyZWQgV29ya2VyIHRvIHVwZGF0ZSBBV1MgY2xpZW50IHdpdGggbmV3IGNyZWRlbnRpYWxzCiAgICogYWZ0ZXIgcmVmcmVzaGVkIGF1dGhlbnRpY2F0aW9uLgogICAqLwogIGNvbm5lY3QuY29yZS5pbml0Q2xpZW50ID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcywgJ3BhcmFtcycpOwogCiAgICB2YXIgYXV0aFRva2VuID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5hdXRoVG9rZW4sICdwYXJhbXMuYXV0aFRva2VuJyk7CiAgICB2YXIgcmVnaW9uID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5yZWdpb24sICdwYXJhbXMucmVnaW9uJyk7CiAgICB2YXIgZW5kcG9pbnQgPSBwYXJhbXMuZW5kcG9pbnQgfHwgbnVsbDsKIAogICAgY29ubmVjdC5jb3JlLmNsaWVudCA9IG5ldyBjb25uZWN0LkFXU0NsaWVudChhdXRoVG9rZW4sIHJlZ2lvbiwgZW5kcG9pbnQpOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogVW5pbml0aWFsaXplIENvbm5lY3QuCiAgICovCiAgY29ubmVjdC5jb3JlLnRlcm1pbmF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3QuY29yZS5jbGllbnQgPSBuZXcgY29ubmVjdC5OdWxsQ2xpZW50KCk7CiAgICBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50ID0gbmV3IGNvbm5lY3QuTnVsbENsaWVudCgpOwogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgaWYgKGJ1cykgYnVzLnVuc3Vic2NyaWJlQWxsKCk7CiAgICBjb25uZWN0LmNvcmUuYnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoKTsKICAgIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlciA9IG51bGw7CiAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciA9IG51bGw7CiAgICBjb25uZWN0LmNvcmUudXBzdHJlYW0gPSBudWxsOwogICAgY29ubmVjdC5jb3JlLmtlZXBhbGl2ZU1hbmFnZXIgPSBudWxsOwogICAgY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCA9IGZhbHNlOwogICAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gZmFsc2U7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBTZXR1cCB0aGUgU29mdHBob25lTWFuYWdlciB0byBiZSBpbml0aWFsaXplZCB3aGVuIHRoZSBhZ2VudAogICAqIGlzIGRldGVybWluZWQgdG8gaGF2ZSBzb2Z0cGhvbmUgZW5hYmxlZC4KICAgKi8KICBjb25uZWN0LmNvcmUuc29mdHBob25lVXNlck1lZGlhU3RyZWFtID0gbnVsbDsKIAogIGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLnNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbTsKICB9OwogCiAgY29ubmVjdC5jb3JlLnNldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uIChzdHJlYW0pIHsKICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0gPSBzdHJlYW07CiAgfTsKIAogIGNvbm5lY3QuY29yZS5pbml0UmluZ3RvbmVFbmdpbmVzID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcywgInBhcmFtcyIpOwogCiAgICB2YXIgc2V0dXBSaW5ndG9uZUVuZ2luZXMgPSBmdW5jdGlvbiAocmluZ3RvbmVTZXR0aW5ncykgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmluZ3RvbmVTZXR0aW5ncywgInJpbmd0b25lU2V0dGluZ3MiKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJpbmd0b25lU2V0dGluZ3Mudm9pY2UsICJyaW5ndG9uZVNldHRpbmdzLnZvaWNlIik7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShyaW5ndG9uZVNldHRpbmdzLnZvaWNlLnJpbmd0b25lVXJsIHx8IHJpbmd0b25lU2V0dGluZ3Mudm9pY2UuZGlzYWJsZWQsICJyaW5ndG9uZVNldHRpbmdzLnZvaWNlLnJpbmd0b25lVXJsIG11c3QgYmUgcHJvdmlkZWQgb3IgcmluZ3RvbmVTZXR0aW5ncy52b2ljZS5kaXNhYmxlZCBtdXN0IGJlIHRydWUiKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2ssICJyaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrIik7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShyaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrLnJpbmd0b25lVXJsIHx8IHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2suZGlzYWJsZWQsICJyaW5ndG9uZVNldHRpbmdzLnZvaWNlLnJpbmd0b25lVXJsIG11c3QgYmUgcHJvdmlkZWQgb3IgcmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjay5kaXNhYmxlZCBtdXN0IGJlIHRydWUiKTsKIAogICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzID0ge307CiAKICAgICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbiAoYWdlbnQpIHsKICAgICAgICBhZ2VudC5vblJlZnJlc2goZnVuY3Rpb24gKCkgewogICAgICAgICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5SSU5HVE9ORSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoIXJpbmd0b25lU2V0dGluZ3Mudm9pY2UuZGlzYWJsZWQgJiYgIWNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMudm9pY2UpIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnZvaWNlID0KICAgICAgICAgICAgICAgIG5ldyBjb25uZWN0LlZvaWNlUmluZ3RvbmVFbmdpbmUocmluZ3RvbmVTZXR0aW5ncy52b2ljZSk7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJWb2ljZVJpbmd0b25lRW5naW5lIGluaXRpYWxpemVkLiIpOwogICAgICAgICAgICB9CiAKICAgICAgICAgICAgaWYgKCFyaW5ndG9uZVNldHRpbmdzLmNoYXQuZGlzYWJsZWQgJiYgIWNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMuY2hhdCkgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMuY2hhdCA9CiAgICAgICAgICAgICAgICBuZXcgY29ubmVjdC5DaGF0UmluZ3RvbmVFbmdpbmUocmluZ3RvbmVTZXR0aW5ncy5jaGF0KTsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkNoYXRSaW5ndG9uZUVuZ2luZSBpbml0aWFsaXplZC4iKTsKICAgICAgICAgICAgfQogCiAgICAgICAgICAgIGlmICghcmluZ3RvbmVTZXR0aW5ncy50YXNrLmRpc2FibGVkICYmICFjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnRhc2spIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnRhc2sgPQogICAgICAgICAgICAgICAgbmV3IGNvbm5lY3QuVGFza1Jpbmd0b25lRW5naW5lKHJpbmd0b25lU2V0dGluZ3MudGFzayk7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlRhc2tSaW5ndG9uZUVuZ2luZSBpbml0aWFsaXplZC4iKTsKICAgICAgICAgICAgfQogCiAgICAgICAgICAgIGlmICghcmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjay5kaXNhYmxlZCAmJiAhY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5xdWV1ZV9jYWxsYmFjaykgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMucXVldWVfY2FsbGJhY2sgPQogICAgICAgICAgICAgICAgbmV3IGNvbm5lY3QuUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lKHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2spOwogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lIGluaXRpYWxpemVkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9OwogCiAgICB2YXIgbWVyZ2VQYXJhbXMgPSBmdW5jdGlvbiAocGFyYW1zLCBvdGhlclBhcmFtcykgewogICAgICAvLyBGb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHk6IHN1cHBvcnQgcHVsbGluZyBkaXNhYmxlZCBmbGFnIGFuZCByaW5ndG9uZVVybAogICAgICAvLyBmcm9tIHNvZnRwaG9uZSBjb25maWcgaWYgaXQgZXhpc3RzIGZyb20gZG93bnN0cmVhbSBpbnRvIHRoZSByaW5ndG9uZSBjb25maWcuCiAgICAgIHBhcmFtcy5yaW5ndG9uZSA9IHBhcmFtcy5yaW5ndG9uZSB8fCB7fTsKICAgICAgcGFyYW1zLnJpbmd0b25lLnZvaWNlID0gcGFyYW1zLnJpbmd0b25lLnZvaWNlIHx8IHt9OwogICAgICBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2sgPSBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2sgfHwge307CiAgICAgIHBhcmFtcy5yaW5ndG9uZS5jaGF0ID0gcGFyYW1zLnJpbmd0b25lLmNoYXQgfHwgeyBkaXNhYmxlZDogdHJ1ZSB9OwogICAgICBwYXJhbXMucmluZ3RvbmUudGFzayA9IHBhcmFtcy5yaW5ndG9uZS50YXNrIHx8IHsgZGlzYWJsZWQ6IHRydWUgfTsKIAogICAgICBpZiAob3RoZXJQYXJhbXMuc29mdHBob25lKSB7CiAgICAgICAgaWYgKG90aGVyUGFyYW1zLnNvZnRwaG9uZS5kaXNhYmxlUmluZ3RvbmUpIHsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS52b2ljZS5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2suZGlzYWJsZWQgPSB0cnVlOwogICAgICAgIH0KIAogICAgICAgIGlmIChvdGhlclBhcmFtcy5zb2Z0cGhvbmUucmluZ3RvbmVVcmwpIHsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS52b2ljZS5yaW5ndG9uZVVybCA9IG90aGVyUGFyYW1zLnNvZnRwaG9uZS5yaW5ndG9uZVVybDsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS5xdWV1ZV9jYWxsYmFjay5yaW5ndG9uZVVybCA9IG90aGVyUGFyYW1zLnNvZnRwaG9uZS5yaW5ndG9uZVVybDsKICAgICAgICB9CiAgICAgIH0KIAogICAgICBpZiAob3RoZXJQYXJhbXMuY2hhdCkgewogICAgICAgIGlmIChvdGhlclBhcmFtcy5jaGF0LmRpc2FibGVSaW5ndG9uZSkgewogICAgICAgICAgcGFyYW1zLnJpbmd0b25lLmNoYXQuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgIH0KIAogICAgICAgIGlmIChvdGhlclBhcmFtcy5jaGF0LnJpbmd0b25lVXJsKSB7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUuY2hhdC5yaW5ndG9uZVVybCA9IG90aGVyUGFyYW1zLmNoYXQucmluZ3RvbmVVcmw7CiAgICAgICAgfQogICAgICB9CiAKICAgICAgLy8gTWVyZ2UgaW4gcmluZ3RvbmUgc2V0dGluZ3MgZnJvbSBkb3duc3RyZWFtLgogICAgICBpZiAob3RoZXJQYXJhbXMucmluZ3RvbmUpIHsKICAgICAgICBwYXJhbXMucmluZ3RvbmUudm9pY2UgPSBjb25uZWN0Lm1lcmdlKHBhcmFtcy5yaW5ndG9uZS52b2ljZSwKICAgICAgICAgIG90aGVyUGFyYW1zLnJpbmd0b25lLnZvaWNlIHx8IHt9KTsKICAgICAgICBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2sgPSBjb25uZWN0Lm1lcmdlKHBhcmFtcy5yaW5ndG9uZS5xdWV1ZV9jYWxsYmFjaywKICAgICAgICAgIG90aGVyUGFyYW1zLnJpbmd0b25lLnZvaWNlIHx8IHt9KTsKICAgICAgICBwYXJhbXMucmluZ3RvbmUuY2hhdCA9IGNvbm5lY3QubWVyZ2UocGFyYW1zLnJpbmd0b25lLmNoYXQsCiAgICAgICAgICBvdGhlclBhcmFtcy5yaW5ndG9uZS5jaGF0IHx8IHt9KTsKICAgICAgfQogICAgfTsKIAogICAgLy8gTWVyZ2UgcGFyYW1zIGZyb20gcGFyYW1zLnNvZnRwaG9uZSBhbmQgcGFyYW1zLmNoYXQgaW50byBwYXJhbXMucmluZ3RvbmUKICAgIC8vIGZvciBlbWJlZGRlZCBhbmQgbm9uLWVtYmVkZGVkIHVzZSBjYXNlcyBzbyB0aGF0IGRlZmF1bHRzIGFyZSBwaWNrZWQgdXAuCiAgICBtZXJnZVBhcmFtcyhwYXJhbXMsIHBhcmFtcyk7CiAKICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkpIHsKICAgICAgLy8gSWYgdGhlIENDUCBpcyBpbiBhIGZyYW1lLCB3YWl0IGZvciBjb25maWd1cmF0aW9uIGZyb20gZG93bnN0cmVhbS4KICAgICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgLy8gTWVyZ2UgYWxsIHBhcmFtcyBmcm9tIGRhdGEgaW50byBwYXJhbXMgZm9yIGFueSBvdmVycmlkZGVuCiAgICAgICAgLy8gdmFsdWVzIGluIGVpdGhlciBsZWdhY3kgInNvZnRwaG9uZSIgb3IgInJpbmd0b25lIiBzZXR0aW5ncy4KICAgICAgICBtZXJnZVBhcmFtcyhwYXJhbXMsIGRhdGEpOwogICAgICAgIHNldHVwUmluZ3RvbmVFbmdpbmVzKHBhcmFtcy5yaW5ndG9uZSk7CiAgICAgIH0pOwogCiAgICB9IGVsc2UgewogICAgICBzZXR1cFJpbmd0b25lRW5naW5lcyhwYXJhbXMucmluZ3RvbmUpOwogICAgfQogIH07CiAKICBjb25uZWN0LmNvcmUuaW5pdFNvZnRwaG9uZU1hbmFnZXIgPSBmdW5jdGlvbiAocGFyYW1zSW4pIHsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKIAogICAgdmFyIGNvbXBldGVGb3JNYXN0ZXJPbkFnZW50VXBkYXRlID0gZnVuY3Rpb24gKHNvZnRwaG9uZVBhcmFtc0luKSB7CiAgICAgIHZhciBzb2Z0cGhvbmVQYXJhbXMgPSBjb25uZWN0Lm1lcmdlKHBhcmFtcy5zb2Z0cGhvbmUgfHwge30sIHNvZnRwaG9uZVBhcmFtc0luKTsKIAogICAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uIChhZ2VudCkgewogICAgICAgIGlmICghYWdlbnQuZ2V0Q2hhbm5lbENvbmN1cnJlbmN5KGNvbm5lY3QuQ2hhbm5lbFR5cGUuVk9JQ0UpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGFnZW50Lm9uUmVmcmVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgc3ViID0gdGhpczsKIAogICAgICAgICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKCFjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciAmJiBhZ2VudC5pc1NvZnRwaG9uZUVuYWJsZWQoKSkgewogICAgICAgICAgICAgIC8vIEJlY29tZSBtYXN0ZXIgdG8gc2VuZCBsb2dzLCBzaW5jZSB3ZSBuZWVkIGxvZ3MgZnJvbSBzb2Z0cGhvbmUgdGFiLgogICAgICAgICAgICAgIGNvbm5lY3QuYmVjb21lTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNFTkRfTE9HUyk7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIgPSBuZXcgY29ubmVjdC5Tb2Z0cGhvbmVNYW5hZ2VyKHNvZnRwaG9uZVBhcmFtcyk7CiAgICAgICAgICAgICAgc3ViLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH07CiAKICAgIC8qKgogICAgICogSWYgdGhlIHdpbmRvdyBpcyBmcmFtZWQsIHdlIG5lZWQgdG8gd2FpdCBmb3IgYSBDT05GSUdVUkUgbWVzc2FnZSBmcm9tCiAgICAgKiBkb3duc3RyZWFtIGJlZm9yZSB3ZSB0cnkgdG8gaW5pdGlhbGl6ZSwgdW5sZXNzIHBhcmFtcy5hbGxvd0ZyYW1lZFNvZnRwaG9uZSBpcyB0cnVlLgogICAgICovCiAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpICYmICFwYXJhbXMuYWxsb3dGcmFtZWRTb2Z0cGhvbmUpIHsKICAgICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBpZiAoZGF0YS5zb2Z0cGhvbmUgJiYgZGF0YS5zb2Z0cGhvbmUuYWxsb3dGcmFtZWRTb2Z0cGhvbmUpIHsKICAgICAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKICAgICAgICAgIGNvbXBldGVGb3JNYXN0ZXJPbkFnZW50VXBkYXRlKGRhdGEuc29mdHBob25lKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgY29tcGV0ZUZvck1hc3Rlck9uQWdlbnRVcGRhdGUocGFyYW1zKTsKICAgIH0KIAogICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbiAoYWdlbnQpIHsKICAgICAgLy8gU3luYyBtdXRlIGFjcm9zcyBhbGwgdGFicyAKICAgICAgaWYgKGFnZW50LmlzU29mdHBob25lRW5hYmxlZCgpICYmIGFnZW50LmdldENoYW5uZWxDb25jdXJyZW5jeShjb25uZWN0LkNoYW5uZWxUeXBlLlZPSUNFKSkgewogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsCiAgICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5NVVRFCiAgICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfTsKIAogIGNvbm5lY3QuY29yZS5hdXRob3JpemUgPSBmdW5jdGlvbiAoZW5kcG9pbnQpIHsKICAgIHZhciBvcHRpb25zID0gewogICAgICBjcmVkZW50aWFsczogJ2luY2x1ZGUnCiAgICB9OwogICAgcmV0dXJuIGNvbm5lY3QuZmV0Y2goZW5kcG9pbnQgfHwgQVVUSE9SSVpFX0VORFBPSU5ULCBvcHRpb25zLCBBVVRIT1JJWkVfUkVUUllfSU5URVJWQUwsIEFVVEhPUklaRV9NQVhfUkVUUlkpOwogIH07CiAKICBjb25uZWN0LmNvcmUudmVyaWZ5RG9tYWluQWNjZXNzID0gZnVuY3Rpb24gKGF1dGhUb2tlbiwgZW5kcG9pbnQpIHsKICAgIGlmICghY29ubmVjdC5pc0ZyYW1lZCgpKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTsKICAgIH0KICAgIHZhciBvcHRpb25zID0gewogICAgICBoZWFkZXJzOiB7CiAgICAgICAgJ1gtQW16LUJlYXJlcic6IGF1dGhUb2tlbgogICAgICB9CiAgICB9OwogICAgcmV0dXJuIGNvbm5lY3QuZmV0Y2goZW5kcG9pbnQgfHwgV0hJVEVMSVNURURfT1JJR0lOU19FTkRQT0lOVCwgb3B0aW9ucywgV0hJVEVMSVNURURfT1JJR0lOU19SRVRSWV9JTlRFUlZBTCwgV0hJVEVMSVNURURfT1JJR0lOU19NQVhfUkVUUlkpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIHZhciB0b3BEb21haW4gPSBzYW5pdGl6ZURvbWFpbih3aW5kb3cuZG9jdW1lbnQucmVmZXJyZXIpOwogICAgICB2YXIgaXNBbGxvd2VkID0gcmVzcG9uc2Uud2hpdGVsaXN0ZWRPcmlnaW5zLnNvbWUoZnVuY3Rpb24gKG9yaWdpbikgewogICAgICAgIHJldHVybiB0b3BEb21haW4gPT09IHNhbml0aXplRG9tYWluKG9yaWdpbik7CiAgICAgIH0pOwogICAgICByZXR1cm4gaXNBbGxvd2VkID8gUHJvbWlzZS5yZXNvbHZlKCkgOiBQcm9taXNlLnJlamVjdCgpOwogICAgfSk7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJbml0aWFsaXplcyBDb25uZWN0IGJ5IGNyZWF0aW5nIG9yIGNvbm5lY3RpbmcgdG8gdGhlIEFQSSBTaGFyZWQgV29ya2VyLgogICAqIFVzZWQgcHJpbWFyaWx5IGJ5IHRoZSBDQ1AuCiAgICovCiAgY29ubmVjdC5jb3JlLmluaXRTaGFyZWRXb3JrZXIgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmNvcmUuY2hlY2tOb3RJbml0aWFsaXplZCgpOwogICAgaWYgKGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAncGFyYW1zJyk7CiAKICAgIHZhciBzaGFyZWRXb3JrZXJVcmwgPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnNoYXJlZFdvcmtlclVybCwgJ3BhcmFtcy5zaGFyZWRXb3JrZXJVcmwnKTsKICAgIHZhciBhdXRoVG9rZW4gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmF1dGhUb2tlbiwgJ3BhcmFtcy5hdXRoVG9rZW4nKTsKICAgIHZhciByZWZyZXNoVG9rZW4gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnJlZnJlc2hUb2tlbiwgJ3BhcmFtcy5yZWZyZXNoVG9rZW4nKTsKICAgIHZhciBhdXRoVG9rZW5FeHBpcmF0aW9uID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5hdXRoVG9rZW5FeHBpcmF0aW9uLCAncGFyYW1zLmF1dGhUb2tlbkV4cGlyYXRpb24nKTsKICAgIHZhciByZWdpb24gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnJlZ2lvbiwgJ3BhcmFtcy5yZWdpb24nKTsKICAgIHZhciBlbmRwb2ludCA9IHBhcmFtcy5lbmRwb2ludCB8fCBudWxsOwogICAgdmFyIGF1dGhvcml6ZUVuZHBvaW50ID0gcGFyYW1zLmF1dGhvcml6ZUVuZHBvaW50IHx8ICIvY29ubmVjdC9hdXRoL2F1dGhvcml6ZSI7CiAKICAgIHRyeSB7CiAgICAgIC8vIEluaXRpYWxpemUgdGhlIGV2ZW50IGJ1cyBhbmQgYWdlbnQgZGF0YSBwcm92aWRlcnMuCiAgICAgIGNvbm5lY3QuY29yZS5ldmVudEJ1cyA9IG5ldyBjb25uZWN0LkV2ZW50QnVzKHsgbG9nRXZlbnRzOiB0cnVlIH0pOwogICAgICBjb25uZWN0LmNvcmUuYWdlbnREYXRhUHJvdmlkZXIgPSBuZXcgQWdlbnREYXRhUHJvdmlkZXIoY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkpOwogICAgICBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5ID0gbmV3IGNvbm5lY3QuTWVkaWFGYWN0b3J5KHBhcmFtcyk7CiAgICAgIC8vIENyZWF0ZSB0aGUgc2hhcmVkIHdvcmtlciBhbmQgdXBzdHJlYW0gY29uZHVpdC4KICAgICAgdmFyIHdvcmtlciA9IG5ldyBTaGFyZWRXb3JrZXIoc2hhcmVkV29ya2VyVXJsLCAiQ29ubmVjdFNoYXJlZFdvcmtlciIpOwogICAgICB2YXIgY29uZHVpdCA9IG5ldyBjb25uZWN0LkNvbmR1aXQoIkNvbm5lY3RTaGFyZWRXb3JrZXJDb25kdWl0IiwKICAgICAgICBuZXcgY29ubmVjdC5Qb3J0U3RyZWFtKHdvcmtlci5wb3J0KSwKICAgICAgICBuZXcgY29ubmVjdC5XaW5kb3dJT1N0cmVhbSh3aW5kb3csIHBhcmVudCkpOwogCiAgICAgIC8vIFNldCB0aGUgZ2xvYmFsIHVwc3RyZWFtIGNvbmR1aXQgZm9yIGV4dGVybmFsIHVzZS4KICAgICAgY29ubmVjdC5jb3JlLnVwc3RyZWFtID0gY29uZHVpdDsKIAogICAgICBjb25uZWN0LmNvcmUud2ViU29ja2V0UHJvdmlkZXIgPSBuZXcgV2ViU29ja2V0UHJvdmlkZXIoKTsKIAogICAgICAvLyBDbG9zZSBvdXIgcG9ydCB0byB0aGUgc2hhcmVkIHdvcmtlciBiZWZvcmUgdGhlIHdpbmRvdyBjbG9zZXMuCiAgICAgIGdsb2JhbC5vbnVubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5DTE9TRSk7CiAgICAgICAgd29ya2VyLnBvcnQuY2xvc2UoKTsKICAgICAgfTsKIAogICAgICBjb25uZWN0LmdldExvZygpLnNjaGVkdWxlVXBzdHJlYW1Mb2dQdXNoKGNvbmR1aXQpOwogICAgICAvLyBCcmlkZ2UgYWxsIHVwc3RyZWFtIG1lc3NhZ2VzIGludG8gdGhlIGV2ZW50IGJ1cy4KICAgICAgY29uZHVpdC5vbkFsbFVwc3RyZWFtKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLmJyaWRnZSgpKTsKICAgICAgLy8gQnJpZGdlIGFsbCBkb3duc3RyZWFtIG1lc3NhZ2VzIGludG8gdGhlIGV2ZW50IGJ1cy4KICAgICAgY29uZHVpdC5vbkFsbERvd25zdHJlYW0oY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuYnJpZGdlKCkpOwogICAgICAvLyBQYXNzIGFsbCB1cHN0cmVhbSBtZXNzYWdlcyAoZnJvbSBzaGFyZWQgd29ya2VyKSBkb3duc3RyZWFtICh0byBDQ1AgY29uc3VtZXIpLgogICAgICBjb25kdWl0Lm9uQWxsVXBzdHJlYW0oY29uZHVpdC5wYXNzRG93bnN0cmVhbSgpKTsKICAgICAgLy8gUGFzcyBhbGwgZG93bnN0cmVhbSBtZXNzYWdlcyAoZnJvbSBDQ1AgY29uc3VtZXIpIHVwc3RyZWFtICh0byBzaGFyZWQgd29ya2VyKS4KICAgICAgY29uZHVpdC5vbkFsbERvd25zdHJlYW0oY29uZHVpdC5wYXNzVXBzdHJlYW0oKSk7CiAgICAgIC8vIFNlbmQgY29uZmlndXJhdGlvbiB1cCB0byB0aGUgc2hhcmVkIHdvcmtlci4KIAogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIHsKICAgICAgICBhdXRoVG9rZW46IGF1dGhUb2tlbiwKICAgICAgICBhdXRoVG9rZW5FeHBpcmF0aW9uOiBhdXRoVG9rZW5FeHBpcmF0aW9uLAogICAgICAgIGVuZHBvaW50OiBlbmRwb2ludCwKICAgICAgICByZWZyZXNoVG9rZW46IHJlZnJlc2hUb2tlbiwKICAgICAgICByZWdpb246IHJlZ2lvbiwKICAgICAgICBhdXRob3JpemVFbmRwb2ludDogYXV0aG9yaXplRW5kcG9pbnQKICAgICAgfSk7CiAKICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJBY2tub3dsZWRnZWQgYnkgdGhlIENvbm5lY3RTaGFyZWRXb3JrZXIhIik7CiAgICAgICAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgIH0pOwogICAgICAvLyBBZGQgYWxsIHVwc3RyZWFtIGxvZyBlbnRyaWVzIHRvIG91ciBvd24gbG9nZ2VyLgogICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTE9HLCBmdW5jdGlvbiAobG9nRW50cnkpIHsKICAgICAgICBpZiAobG9nRW50cnkubG9nZ2VySWQgIT09IGNvbm5lY3QuZ2V0TG9nKCkuZ2V0TG9nZ2VySWQoKSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5hZGRMb2dFbnRyeShjb25uZWN0LkxvZ0VudHJ5LmZyb21PYmplY3QobG9nRW50cnkpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAvLyBSZWxvYWQgdGhlIHBhZ2UgaWYgdGhlIHNoYXJlZCB3b3JrZXIgZGV0ZWN0cyBhbiBBUEkgYXV0aCBmYWlsdXJlLgogICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVVUSF9GQUlMLCBmdW5jdGlvbiAobG9nRW50cnkpIHsKICAgICAgICBsb2NhdGlvbi5yZWxvYWQoKTsKICAgICAgfSk7CiAKICAgICAgY29ubmVjdC5jb3JlLmNsaWVudCA9IG5ldyBjb25uZWN0LlVwc3RyZWFtQ29uZHVpdENsaWVudChjb25kdWl0KTsKICAgICAgY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCA9IG5ldyBjb25uZWN0LlVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudChjb25kdWl0KTsKIAogICAgICAvLyBQYXNzIHRoZSBURVJNSU5BVEUgcmVxdWVzdCB1cHN0cmVhbSB0byB0aGUgc2hhcmVkIHdvcmtlci4KICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURSwKICAgICAgICBjb25kdWl0LnBhc3NVcHN0cmVhbSgpKTsKIAogICAgICAvLyBSZWZyZXNoIHRoZSBwYWdlIHdoZW4gd2UgcmVjZWl2ZSB0aGUgVEVSTUlOQVRFRCByZXNwb25zZSBmcm9tIHRoZQogICAgICAvLyBzaGFyZWQgd29ya2VyLgogICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFRCwgZnVuY3Rpb24gKCkgewogICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQodHJ1ZSk7CiAgICAgIH0pOwogCiAgICAgIHdvcmtlci5wb3J0LnN0YXJ0KCk7CiAKICAgICAgLy8gQXR0ZW1wdCB0byBnZXQgcGVybWlzc2lvbiB0byBzaG93IG5vdGlmaWNhdGlvbnMuCiAgICAgIHZhciBubSA9IGNvbm5lY3QuY29yZS5nZXROb3RpZmljYXRpb25NYW5hZ2VyKCk7CiAgICAgIG5tLnJlcXVlc3RQZXJtaXNzaW9uKCk7CiAKICAgICAgY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLklOSVRfRElTQVNURVJfUkVDT1ZFUlksIGZ1bmN0aW9uKHBhcmFtcykgewogICAgICAgIGNvbm5lY3QuY29yZS5pbml0RGlzYXN0ZXJSZWNvdmVyeShwYXJhbXMpOwogICAgICB9KQogCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBpbml0aWFsaXplIHRoZSBBUEkgc2hhcmVkIHdvcmtlciwgd2UncmUgZGVhZCEiKQogICAgICAgIC53aXRoRXhjZXB0aW9uKGUpOwogICAgfQogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogSW5pdGlhbGl6ZXMgQ29ubmVjdCBieSBjcmVhdGluZyBvciBjb25uZWN0aW5nIHRvIHRoZSBBUEkgU2hhcmVkIFdvcmtlci4KICAgKiBJbml0aWFsaXplcyBDb25uZWN0IGJ5IGxvYWRpbmcgdGhlIENDUCBpbiBhbiBpZnJhbWUgYW5kIGNvbm5lY3RpbmcgdG8gaXQuCiAgICovCiAgY29ubmVjdC5jb3JlLmluaXRDQ1AgPSBmdW5jdGlvbiAoY29udGFpbmVyRGl2LCBwYXJhbXNJbikgewogICAgY29ubmVjdC5jb3JlLmNoZWNrTm90SW5pdGlhbGl6ZWQoKTsKICAgIGlmIChjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogCiAgICAvLyBGb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHksIHdoZW4gaW5zdGVhZCBvZiB0YWtpbmcgYSBwYXJhbXMgb2JqZWN0CiAgICAvLyBhcyBpbnB1dCB3ZSBvbmx5IGFjY2VwdGVkIGNjcFVybC4KICAgIHZhciBwYXJhbXMgPSB7fTsKICAgIGlmICh0eXBlb2YgKHBhcmFtc0luKSA9PT0gJ3N0cmluZycpIHsKICAgICAgcGFyYW1zLmNjcFVybCA9IHBhcmFtc0luOwogICAgfSBlbHNlIHsKICAgICAgcGFyYW1zID0gcGFyYW1zSW47CiAgICB9CiAKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChjb250YWluZXJEaXYsICdjb250YWluZXJEaXYnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuY2NwVXJsLCAncGFyYW1zLmNjcFVybCcpOwogCiAgICAvLyBDcmVhdGUgdGhlIENDUCBpZnJhbWUgYW5kIGFwcGVuZCBpdCB0byB0aGUgY29udGFpbmVyIGRpdi4KICAgIHZhciBpZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpZnJhbWUnKTsKICAgIGlmcmFtZS5zcmMgPSBwYXJhbXMuY2NwVXJsOwogICAgaWZyYW1lLmFsbG93ID0gIm1pY3JvcGhvbmU7IGF1dG9wbGF5IjsKICAgIGlmcmFtZS5zdHlsZSA9ICJ3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlIjsKICAgIGNvbnRhaW5lckRpdi5hcHBlbmRDaGlsZChpZnJhbWUpOwogCiAgICAvLyBJbml0aWFsaXplIHRoZSBldmVudCBidXMgYW5kIGFnZW50IGRhdGEgcHJvdmlkZXJzLgogICAgLy8gTk9URTogU2V0dGluZyBsb2dFdmVudHMgaGVyZSB0byBGQUxTRSBpbiBvcmRlciB0byBhdm9pZCBkdXBsaWNhdGluZwogICAgLy8gZXZlbnRzIHdoaWNoIGFyZSBsb2dnZWQgaW4gQ0NQLgogICAgY29ubmVjdC5jb3JlLmV2ZW50QnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoeyBsb2dFdmVudHM6IGZhbHNlIH0pOwogICAgY29ubmVjdC5jb3JlLmFnZW50RGF0YVByb3ZpZGVyID0gbmV3IEFnZW50RGF0YVByb3ZpZGVyKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpKTsKICAgIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkgPSBuZXcgY29ubmVjdC5NZWRpYUZhY3RvcnkocGFyYW1zKTsKIAogICAgLy8gQnVpbGQgdGhlIHVwc3RyZWFtIGNvbmR1aXQgY29tbXVuaWNhdGluZyB3aXRoIHRoZSBDQ1AgaWZyYW1lLgogICAgdmFyIGNvbmR1aXQgPSBuZXcgY29ubmVjdC5JRnJhbWVDb25kdWl0KHBhcmFtcy5jY3BVcmwsIHdpbmRvdywgaWZyYW1lKTsKIAogICAgLy8gTGV0IENDUCBrbm93IGlmIGlmcmFtZSBpcyB2aXNpYmxlCiAgICBpZnJhbWUub25sb2FkID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgdmFyIHN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoaWZyYW1lLCBudWxsKTsKICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgZGlzcGxheTogc3R5bGUuZGlzcGxheSwKICAgICAgICBvZmZzZXRXaWR0aDogaWZyYW1lLm9mZnNldFdpZHRoLAogICAgICAgIG9mZnNldEhlaWdodDogaWZyYW1lLm9mZnNldEhlaWdodCwKICAgICAgICBjbGllbnRSZWN0c0xlbmd0aDogaWZyYW1lLmdldENsaWVudFJlY3RzKCkubGVuZ3RoCiAgICAgIH07CiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLklGUkFNRV9TVFlMRSwgZGF0YSk7CiAgICB9LCAxMDAwMCk7CiAKICAgIC8vIFNldCB0aGUgZ2xvYmFsIHVwc3RyZWFtIGNvbmR1aXQgZm9yIGV4dGVybmFsIHVzZS4KICAgIGNvbm5lY3QuY29yZS51cHN0cmVhbSA9IGNvbmR1aXQ7CiAKICAgIC8vIEluaXQgd2ViU29ja2V0UHJvdmlkZXIKICAgIGNvbm5lY3QuY29yZS53ZWJTb2NrZXRQcm92aWRlciA9IG5ldyBXZWJTb2NrZXRQcm92aWRlcigpOwogCiAgICBjb25kdWl0Lm9uQWxsVXBzdHJlYW0oY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuYnJpZGdlKCkpOwogCiAgICAvLyBJbml0aWFsaXplIHRoZSBrZWVwYWxpdmUgbWFuYWdlci4KICAgIGNvbm5lY3QuY29yZS5rZWVwYWxpdmVNYW5hZ2VyID0gbmV3IEtlZXBhbGl2ZU1hbmFnZXIoY29uZHVpdCwKICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCksCiAgICAgIHBhcmFtcy5jY3BTeW5UaW1lb3V0IHx8IENDUF9TWU5fVElNRU9VVCwKICAgICAgcGFyYW1zLmNjcEFja1RpbWVvdXQgfHwgQ0NQX0FDS19USU1FT1VUKQogICAgICA7CiAgICBjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEludGVydmFsID0gbnVsbDsKIAogICAgLy8gQWxsb3cgMTAgc2VjIChkZWZhdWx0KSBiZWZvcmUgcmVjZWl2aW5nIHRoZSBmaXJzdCBBQ0sgZnJvbSB0aGUgQ0NQLgogICAgY29ubmVjdC5jb3JlLmNjcExvYWRUaW1lb3V0SW5zdGFuY2UgPSBnbG9iYWwuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIGNvbm5lY3QuY29yZS5jY3BMb2FkVGltZW91dEluc3RhbmNlID0gbnVsbDsKICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5BQ0tfVElNRU9VVCk7CiAgICB9LCBwYXJhbXMuY2NwTG9hZFRpbWVvdXQgfHwgQ0NQX0xPQURfVElNRU9VVCk7CiAKICAgIC8vIE9uY2Ugd2UgcmVjZWl2ZSB0aGUgZmlyc3QgQUNLLCBzZXR1cCBvdXIgdXBzdHJlYW0gQVBJIGNsaWVudCBhbmQgZXN0YWJsaXNoCiAgICAvLyB0aGUgU1lOL0FDSyByZWZyZXNoIGZsb3cuCiAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsIGZ1bmN0aW9uICgpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJBY2tub3dsZWRnZWQgYnkgdGhlIENDUCEiKTsKICAgICAgY29ubmVjdC5jb3JlLmNsaWVudCA9IG5ldyBjb25uZWN0LlVwc3RyZWFtQ29uZHVpdENsaWVudChjb25kdWl0KTsKICAgICAgY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCA9IG5ldyBjb25uZWN0LlVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudChjb25kdWl0KTsKICAgICAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gdHJ1ZTsKIAogICAgICBpZiAocGFyYW1zLnNvZnRwaG9uZSB8fCBwYXJhbXMuY2hhdCkgewogICAgICAgIC8vIFNlbmQgY29uZmlndXJhdGlvbiB1cCB0byB0aGUgQ0NQLgogICAgICAgIC8vc2V0IGl0IHRvIGZhbHNlIGlmIHNlY29uZGFyeQogICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgewogICAgICAgICAgc29mdHBob25lOiBwYXJhbXMuc29mdHBob25lLAogICAgICAgICAgY2hhdDogcGFyYW1zLmNoYXQKICAgICAgICB9KTsKICAgICAgfQogCiAgICAgIC8vIElmIERSIGVuYWJsZWQsIHNldCB0aGlzIENDUCBpbnN0YW5jZSBhcyBwYXJ0IG9mIGEgRGlzYXN0ZXIgUmVjb3ZlcnkgZmxlZXQKICAgICAgaWYgKHBhcmFtcy5kaXNhc3RlclJlY292ZXJ5T24pIHsKICAgICAgICBjb25uZWN0LmNvcmUucmVnaW9uID0gcGFyYW1zLnJlZ2lvbjsKICAgICAgICBjb25uZWN0LmNvcmUuc3VwcHJlc3NDb250YWN0cyA9IHN1cHByZXNzQ29udGFjdHM7CiAgICAgICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLlNFVF9PRkZMSU5FKTsKICAgICAgICB9ICAgICAgIAogICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5JTklUX0RJU0FTVEVSX1JFQ09WRVJZLCBwYXJhbXMpOwogICAgICB9CiAKICAgICAgaWYgKGNvbm5lY3QuY29yZS5jY3BMb2FkVGltZW91dEluc3RhbmNlKSB7CiAgICAgICAgZ2xvYmFsLmNsZWFyVGltZW91dChjb25uZWN0LmNvcmUuY2NwTG9hZFRpbWVvdXRJbnN0YW5jZSk7CiAgICAgICAgY29ubmVjdC5jb3JlLmNjcExvYWRUaW1lb3V0SW5zdGFuY2UgPSBudWxsOwogICAgICB9CiAKICAgICAgY29ubmVjdC5jb3JlLmtlZXBhbGl2ZU1hbmFnZXIuc3RhcnQoKTsKICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwogICAgfSk7CiAKICAgIC8vIEFkZCBhbnkgbG9ncyBmcm9tIHRoZSB1cHN0cmVhbSB0byBvdXIgb3duIGxvZ2dlci4KICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgICBpZiAobG9nRW50cnkubG9nZ2VySWQgIT09IGNvbm5lY3QuZ2V0TG9nKCkuZ2V0TG9nZ2VySWQoKSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuYWRkTG9nRW50cnkoY29ubmVjdC5Mb2dFbnRyeS5mcm9tT2JqZWN0KGxvZ0VudHJ5KSk7CiAgICAgIH0KICAgIH0pOwogCiAgICAvLyBQb3AgYSBsb2dpbiBwYWdlIHdoZW4gd2UgZW5jb3VudGVyIGFuIEFDSyB0aW1lb3V0LgogICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkFDS19USU1FT1VULCBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIGxvZ2luUG9wdXAgaXMgdHJ1ZSBieSBkZWZhdWx0LCBvbmx5IGZhbHNlIGlmIGV4cGxpY2l0bHkgc2V0IHRvIGZhbHNlLgogICAgICBpZiAocGFyYW1zLmxvZ2luUG9wdXAgIT09IGZhbHNlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBsb2dpblVybCA9IGNyZWF0ZUxvZ2luVXJsKHBhcmFtcyk7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIkFDS19USU1FT1VUIG9jY3VycmVkLCBhdHRlbXB0aW5nIHRvIHBvcCB0aGUgbG9naW4gcGFnZSBpZiBub3QgYWxyZWFkeSBvcGVuLiIpOwogICAgICAgICAgLy8gY2xlYXIgb3V0IGxhc3Qgb3BlbmVkIHRpbWVzdGFtcCBmb3IgU0FNTCBhdXRoZW50aWNhdGlvbiB3aGVuIHRoZXJlIGlzIEFDS19USU1FT1VUCiAgICAgICAgICBpZiAocGFyYW1zLmxvZ2luVXJsKSB7CiAgICAgICAgICAgICBjb25uZWN0LmNvcmUuZ2V0UG9wdXBNYW5hZ2VyKCkuY2xlYXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuTE9HSU5fUE9QVVApOwogICAgICAgICAgfQogICAgICAgICAgY29ubmVjdC5jb3JlLmxvZ2luV2luZG93ID0gY29ubmVjdC5jb3JlLmdldFBvcHVwTWFuYWdlcigpLm9wZW4obG9naW5VcmwsIGNvbm5lY3QuTWFzdGVyVG9waWNzLkxPR0lOX1BPUFVQKTsKIAogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkFDS19USU1FT1VUIG9jY3VycmVkIGJ1dCB3ZSBhcmUgdW5hYmxlIHRvIG9wZW4gdGhlIGxvZ2luIHBvcHVwLiIpLndpdGhFeGNlcHRpb24oZSk7CiAgICAgICAgfQogICAgICB9CiAKICAgICAgaWYgKGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoSW50ZXJ2YWwgPT0gbnVsbCkgewogICAgICAgIHZhciBjY3BfaWZyYW1lX3JlZnJlc2hfaW50ZXJ2YWwgPSAocGFyYW1zLmRpc2FzdGVyUmVjb3ZlcnlPbikgPyBDQ1BfRFJfSUZSQU1FX1JFRlJFU0hfSU5URVJWQUwgOiBDQ1BfSUZSQU1FX1JFRlJFU0hfSU5URVJWQUw7CiAgICAgICAgY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hJbnRlcnZhbCA9IHdpbmRvdy5zZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZnJhbWUuc3JjID0gKHBhcmFtcy5kaXNhc3RlclJlY292ZXJ5T24pID8gcGFyYW1zLmxvZ2luVXJsIDogcGFyYW1zLmNjcFVybDsKICAgICAgICB9LCBjY3BfaWZyYW1lX3JlZnJlc2hfaW50ZXJ2YWwpOwogCiAgICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgICBnbG9iYWwuY2xlYXJJbnRlcnZhbChjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEludGVydmFsKTsKICAgICAgICAgIGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoSW50ZXJ2YWwgPSBudWxsOwogICAgICAgICAgY29ubmVjdC5jb3JlLmdldFBvcHVwTWFuYWdlcigpLmNsZWFyKGNvbm5lY3QuTWFzdGVyVG9waWNzLkxPR0lOX1BPUFVQKTsKICAgICAgICAgIGlmIChwYXJhbXMubG9naW5Qb3B1cEF1dG9DbG9zZSAmJiBjb25uZWN0LmNvcmUubG9naW5XaW5kb3cpIHsKICAgICAgICAgICAgY29ubmVjdC5jb3JlLmxvZ2luV2luZG93LmNsb3NlKCk7CiAgICAgICAgICAgIGNvbm5lY3QuY29yZS5sb2dpbldpbmRvdyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogCiAgICBpZiAocGFyYW1zLm9uVmlld0NvbnRhY3QpIHsKICAgICAgY29ubmVjdC5jb3JlLm9uVmlld0NvbnRhY3QocGFyYW1zLm9uVmlld0NvbnRhY3QpOwogICAgfQogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgdmFyIEtlZXBhbGl2ZU1hbmFnZXIgPSBmdW5jdGlvbiAoY29uZHVpdCwgZXZlbnRCdXMsIHN5blRpbWVvdXQsIGFja1RpbWVvdXQpIHsKICAgIHRoaXMuY29uZHVpdCA9IGNvbmR1aXQ7CiAgICB0aGlzLmV2ZW50QnVzID0gZXZlbnRCdXM7CiAgICB0aGlzLnN5blRpbWVvdXQgPSBzeW5UaW1lb3V0OwogICAgdGhpcy5hY2tUaW1lb3V0ID0gYWNrVGltZW91dDsKICAgIHRoaXMuYWNrVGltZXIgPSBudWxsOwogICAgdGhpcy5zeW5UaW1lciA9IG51bGw7CiAgICB0aGlzLmFja1N1YiA9IG51bGw7CiAgfTsKIAogIEtlZXBhbGl2ZU1hbmFnZXIucHJvdG90eXBlLnN0YXJ0ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogCiAgICB0aGlzLmNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNZTkNIUk9OSVpFKTsKICAgIHRoaXMuYWNrU3ViID0gdGhpcy5jb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsIGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwogICAgICBnbG9iYWwuY2xlYXJUaW1lb3V0KHNlbGYuYWNrVGltZXIpOwogICAgICBzZWxmLmRlZmVyU3RhcnQoKTsKICAgIH0pOwogICAgdGhpcy5hY2tUaW1lciA9IGdsb2JhbC5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgc2VsZi5hY2tTdWIudW5zdWJzY3JpYmUoKTsKICAgICAgc2VsZi5ldmVudEJ1cy50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLkFDS19USU1FT1VUKTsKICAgICAgc2VsZi5kZWZlclN0YXJ0KCk7CiAgICB9LCB0aGlzLmFja1RpbWVvdXQpOwogIH07CiAKICBLZWVwYWxpdmVNYW5hZ2VyLnByb3RvdHlwZS5kZWZlclN0YXJ0ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMuc3luVGltZXIgPT0gbnVsbCkgewogICAgICB0aGlzLnN5blRpbWVyID0gZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnN0YXJ0KSwgdGhpcy5zeW5UaW1lb3V0KTsKICAgIH0KICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogCiAgdmFyIFdlYlNvY2tldFByb3ZpZGVyID0gZnVuY3Rpb24gKCkgewogCiAgICB2YXIgY2FsbGJhY2tzID0gewogICAgICBpbml0RmFpbHVyZTogbmV3IFNldCgpLAogICAgICBzdWJzY3JpcHRpb25VcGRhdGU6IG5ldyBTZXQoKSwKICAgICAgc3Vic2NyaXB0aW9uRmFpbHVyZTogbmV3IFNldCgpLAogICAgICB0b3BpYzogbmV3IE1hcCgpLAogICAgICBhbGxNZXNzYWdlOiBuZXcgU2V0KCksCiAgICAgIGNvbm5lY3Rpb25HYWluOiBuZXcgU2V0KCksCiAgICAgIGNvbm5lY3Rpb25Mb3N0OiBuZXcgU2V0KCksCiAgICAgIGNvbm5lY3Rpb25PcGVuOiBuZXcgU2V0KCksCiAgICAgIGNvbm5lY3Rpb25DbG9zZTogbmV3IFNldCgpCiAgICB9OwogCiAgICB2YXIgaW52b2tlQ2FsbGJhY2tzID0gZnVuY3Rpb24gKGNhbGxiYWNrcywgcmVzcG9uc2UpIHsKICAgICAgY2FsbGJhY2tzLmZvckVhY2goZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2socmVzcG9uc2UpOwogICAgICB9KTsKICAgIH07CiAKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuSU5JVF9GQUlMVVJFLCBmdW5jdGlvbiAoKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuaW5pdEZhaWx1cmUpOwogICAgfSk7CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX09QRU4sIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmNvbm5lY3Rpb25PcGVuLCByZXNwb25zZSk7CiAgICB9KTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fQ0xPU0UsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmNvbm5lY3Rpb25DbG9zZSwgcmVzcG9uc2UpOwogICAgfSk7CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0dBSU4sIGZ1bmN0aW9uICgpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5jb25uZWN0aW9uR2Fpbik7CiAgICB9KTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fTE9TVCwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuY29ubmVjdGlvbkxvc3QsIHJlc3BvbnNlKTsKICAgIH0pOwogCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNVQlNDUklQVElPTl9VUERBVEUsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLnN1YnNjcmlwdGlvblVwZGF0ZSwgcmVzcG9uc2UpOwogICAgfSk7CiAKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSVBUSU9OX0ZBSUxVUkUsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLnN1YnNjcmlwdGlvbkZhaWx1cmUsIHJlc3BvbnNlKTsKICAgIH0pOwogCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkFMTF9NRVNTQUdFLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5hbGxNZXNzYWdlLCByZXNwb25zZSk7CiAgICAgIGlmIChjYWxsYmFja3MudG9waWMuaGFzKHJlc3BvbnNlLnRvcGljKSkgewogICAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MudG9waWMuZ2V0KHJlc3BvbnNlLnRvcGljKSwgcmVzcG9uc2UpOwogICAgICB9CiAgICB9KTsKIAogICAgdGhpcy5zZW5kTWVzc2FnZSA9IGZ1bmN0aW9uICh3ZWJTb2NrZXRQYXlsb2FkKSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TRU5ELCB3ZWJTb2NrZXRQYXlsb2FkKTsKICAgIH07CiAKICAgIHRoaXMub25Jbml0RmFpbHVyZSA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmluaXRGYWlsdXJlLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5pbml0RmFpbHVyZS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKCiAgICB0aGlzLm9uQ29ubmVjdGlvbk9wZW4gPSBmdW5jdGlvbihjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmNvbm5lY3Rpb25PcGVuLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5jb25uZWN0aW9uT3Blbi5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKCiAgICB0aGlzLm9uQ29ubmVjdGlvbkNsb3NlID0gZnVuY3Rpb24oY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5jb25uZWN0aW9uQ2xvc2UuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmNvbm5lY3Rpb25DbG9zZS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKCiAgICB0aGlzLm9uQ29ubmVjdGlvbkdhaW4gPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5jb25uZWN0aW9uR2Fpbi5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuY29ubmVjdGlvbkdhaW4uZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICAgIHRoaXMub25Db25uZWN0aW9uTG9zdCA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmNvbm5lY3Rpb25Mb3N0LmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5jb25uZWN0aW9uTG9zdC5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogICAgdGhpcy5vblN1YnNjcmlwdGlvblVwZGF0ZSA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLnN1YnNjcmlwdGlvblVwZGF0ZS5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3Muc3Vic2NyaXB0aW9uVXBkYXRlLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgICB0aGlzLm9uU3Vic2NyaXB0aW9uRmFpbHVyZSA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLnN1YnNjcmlwdGlvbkZhaWx1cmUuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLnN1YnNjcmlwdGlvbkZhaWx1cmUuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICAgIHRoaXMuc3Vic2NyaWJlVG9waWNzID0gZnVuY3Rpb24gKHRvcGljcykgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWNzLCAndG9waWNzJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzQXJyYXkodG9waWNzKSwgJ3RvcGljcyBtdXN0IGJlIGEgYXJyYXknKTsKICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNVQlNDUklCRSwgdG9waWNzKTsKICAgIH07CiAKICAgIHRoaXMub25NZXNzYWdlID0gZnVuY3Rpb24gKHRvcGljTmFtZSwgY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljTmFtZSwgJ3RvcGljTmFtZScpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgaWYgKGNhbGxiYWNrcy50b3BpYy5oYXModG9waWNOYW1lKSkgewogICAgICAgIGNhbGxiYWNrcy50b3BpYy5nZXQodG9waWNOYW1lKS5hZGQoY2IpOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrcy50b3BpYy5zZXQodG9waWNOYW1lLCBuZXcgU2V0KFtjYl0pKTsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MudG9waWMuZ2V0KHRvcGljTmFtZSkuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICAgIHRoaXMub25BbGxNZXNzYWdlID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuYWxsTWVzc2FnZS5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuYWxsTWVzc2FnZS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgdmFyIEFnZW50RGF0YVByb3ZpZGVyID0gZnVuY3Rpb24gKGJ1cykgewogICAgdmFyIGFnZW50RGF0YSA9IG51bGw7CiAgICB0aGlzLmJ1cyA9IGJ1czsKICAgIHRoaXMuYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLlVQREFURSwgY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnVwZGF0ZUFnZW50RGF0YSkpOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUudXBkYXRlQWdlbnREYXRhID0gZnVuY3Rpb24gKGFnZW50RGF0YSkgewogICAgdmFyIG9sZEFnZW50RGF0YSA9IHRoaXMuYWdlbnREYXRhOwogICAgdGhpcy5hZ2VudERhdGEgPSBhZ2VudERhdGE7CiAKICAgIGlmIChvbGRBZ2VudERhdGEgPT0gbnVsbCkgewogICAgICBjb25uZWN0LmFnZW50LmluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgdGhpcy5idXMudHJpZ2dlcihjb25uZWN0LkFnZW50RXZlbnRzLklOSVQsIG5ldyBjb25uZWN0LkFnZW50KCkpOwogICAgfQogCiAgICB0aGlzLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQWdlbnRFdmVudHMuUkVGUkVTSCwgbmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAKICAgIHRoaXMuX2ZpcmVBZ2VudFVwZGF0ZUV2ZW50cyhvbGRBZ2VudERhdGEpOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuZ2V0QWdlbnREYXRhID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMuYWdlbnREYXRhID09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignTm8gYWdlbnQgZGF0YSBpcyBhdmFpbGFibGUgeWV0IScpOwogICAgfQogCiAgICByZXR1cm4gdGhpcy5hZ2VudERhdGE7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5nZXRDb250YWN0RGF0YSA9IGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgIHZhciBhZ2VudERhdGEgPSB0aGlzLmdldEFnZW50RGF0YSgpOwogICAgdmFyIGNvbnRhY3REYXRhID0gY29ubmVjdC5maW5kKGFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGN0ZGF0YSkgewogICAgICByZXR1cm4gY3RkYXRhLmNvbnRhY3RJZCA9PT0gY29udGFjdElkOwogICAgfSk7CiAKICAgIGlmIChjb250YWN0RGF0YSA9PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ0NvbnRhY3QgJXMgbm8gbG9uZ2VyIGV4aXN0cy4nLCBjb250YWN0SWQpOwogICAgfQogCiAgICByZXR1cm4gY29udGFjdERhdGE7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5nZXRDb25uZWN0aW9uRGF0YSA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgdmFyIGNvbnRhY3REYXRhID0gdGhpcy5nZXRDb250YWN0RGF0YShjb250YWN0SWQpOwogICAgdmFyIGNvbm5lY3Rpb25EYXRhID0gY29ubmVjdC5maW5kKGNvbnRhY3REYXRhLmNvbm5lY3Rpb25zLCBmdW5jdGlvbiAoY2RhdGEpIHsKICAgICAgcmV0dXJuIGNkYXRhLmNvbm5lY3Rpb25JZCA9PT0gY29ubmVjdGlvbklkOwogICAgfSk7CiAKICAgIGlmIChjb25uZWN0aW9uRGF0YSA9PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ0Nvbm5lY3Rpb24gJXMgZm9yIGNvbnRhY3QgJXMgbm8gbG9uZ2VyIGV4aXN0cy4nLCBjb25uZWN0aW9uSWQsIGNvbnRhY3RJZCk7CiAgICB9CiAKICAgIHJldHVybiBjb25uZWN0aW9uRGF0YTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLl9kaWZmQ29udGFjdHMgPSBmdW5jdGlvbiAob2xkQWdlbnREYXRhKSB7CiAgICB2YXIgZGlmZiA9IHsKICAgICAgYWRkZWQ6IHt9LAogICAgICByZW1vdmVkOiB7fSwKICAgICAgY29tbW9uOiB7fSwKICAgICAgb2xkTWFwOiBjb25uZWN0LmluZGV4KG9sZEFnZW50RGF0YSA9PSBudWxsID8gW10gOiBvbGRBZ2VudERhdGEuc25hcHNob3QuY29udGFjdHMsIGZ1bmN0aW9uIChjb250YWN0KSB7IHJldHVybiBjb250YWN0LmNvbnRhY3RJZDsgfSksCiAgICAgIG5ld01hcDogY29ubmVjdC5pbmRleCh0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGNvbnRhY3QpIHsgcmV0dXJuIGNvbnRhY3QuY29udGFjdElkOyB9KQogICAgfTsKIAogICAgY29ubmVjdC5rZXlzKGRpZmYub2xkTWFwKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgICAgaWYgKGNvbm5lY3QuY29udGFpbnMoZGlmZi5uZXdNYXAsIGNvbnRhY3RJZCkpIHsKICAgICAgICBkaWZmLmNvbW1vbltjb250YWN0SWRdID0gZGlmZi5uZXdNYXBbY29udGFjdElkXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkaWZmLnJlbW92ZWRbY29udGFjdElkXSA9IGRpZmYub2xkTWFwW2NvbnRhY3RJZF07CiAgICAgIH0KICAgIH0pOwogCiAgICBjb25uZWN0LmtleXMoZGlmZi5uZXdNYXApLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgICBpZiAoIWNvbm5lY3QuY29udGFpbnMoZGlmZi5vbGRNYXAsIGNvbnRhY3RJZCkpIHsKICAgICAgICBkaWZmLmFkZGVkW2NvbnRhY3RJZF0gPSBkaWZmLm5ld01hcFtjb250YWN0SWRdOwogICAgICB9CiAgICB9KTsKIAogICAgcmV0dXJuIGRpZmY7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5fZmlyZUFnZW50VXBkYXRlRXZlbnRzID0gZnVuY3Rpb24gKG9sZEFnZW50RGF0YSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGRpZmYgPSBudWxsOwogICAgdmFyIG9sZEFnZW50U3RhdGUgPSBvbGRBZ2VudERhdGEgPT0gbnVsbCA/IGNvbm5lY3QuQWdlbnRBdmFpbFN0YXRlcy5JTklUIDogb2xkQWdlbnREYXRhLnNuYXBzaG90LnN0YXRlLm5hbWU7CiAgICB2YXIgbmV3QWdlbnRTdGF0ZSA9IHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LnN0YXRlLm5hbWU7CiAgICB2YXIgb2xkUm91dGluZ1N0YXRlID0gb2xkQWdlbnREYXRhID09IG51bGwgPyBjb25uZWN0LkFnZW50U3RhdGVUeXBlLklOSVQgOiBvbGRBZ2VudERhdGEuc25hcHNob3Quc3RhdGUudHlwZTsKICAgIHZhciBuZXdSb3V0aW5nU3RhdGUgPSB0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5zdGF0ZS50eXBlOwogCiAgICBpZiAob2xkUm91dGluZ1N0YXRlICE9PSBuZXdSb3V0aW5nU3RhdGUpIHsKICAgICAgY29ubmVjdC5jb3JlLmdldEFnZW50Um91dGluZ0V2ZW50R3JhcGgoKS5nZXRBc3NvY2lhdGlvbnModGhpcywgb2xkUm91dGluZ1N0YXRlLCBuZXdSb3V0aW5nU3RhdGUpLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgc2VsZi5idXMudHJpZ2dlcihldmVudCwgbmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICAgIH0pOwogICAgfQogCiAgICBpZiAob2xkQWdlbnRTdGF0ZSAhPT0gbmV3QWdlbnRTdGF0ZSkgewogICAgICB0aGlzLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQWdlbnRFdmVudHMuU1RBVEVfQ0hBTkdFLCB7CiAgICAgICAgYWdlbnQ6IG5ldyBjb25uZWN0LkFnZW50KCksCiAgICAgICAgb2xkU3RhdGU6IG9sZEFnZW50U3RhdGUsCiAgICAgICAgbmV3U3RhdGU6IG5ld0FnZW50U3RhdGUKIAogICAgICB9KTsKICAgICAgY29ubmVjdC5jb3JlLmdldEFnZW50U3RhdGVFdmVudEdyYXBoKCkuZ2V0QXNzb2NpYXRpb25zKHRoaXMsIG9sZEFnZW50U3RhdGUsIG5ld0FnZW50U3RhdGUpLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgc2VsZi5idXMudHJpZ2dlcihldmVudCwgbmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICAgIH0pOwogICAgfQogCiAgICBpZiAob2xkQWdlbnREYXRhICE9PSBudWxsKSB7CiAgICAgIGRpZmYgPSB0aGlzLl9kaWZmQ29udGFjdHMob2xkQWdlbnREYXRhKTsKIAogICAgfSBlbHNlIHsKICAgICAgZGlmZiA9IHsKICAgICAgICBhZGRlZDogY29ubmVjdC5pbmRleCh0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGNvbnRhY3QpIHsgcmV0dXJuIGNvbnRhY3QuY29udGFjdElkOyB9KSwKICAgICAgICByZW1vdmVkOiB7fSwKICAgICAgICBjb21tb246IHt9LAogICAgICAgIG9sZE1hcDoge30sCiAgICAgICAgbmV3TWFwOiBjb25uZWN0LmluZGV4KHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LmNvbnRhY3RzLCBmdW5jdGlvbiAoY29udGFjdCkgeyByZXR1cm4gY29udGFjdC5jb250YWN0SWQ7IH0pCiAgICAgIH07CiAgICB9CiAKICAgIGNvbm5lY3QudmFsdWVzKGRpZmYuYWRkZWQpLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5Db250YWN0RXZlbnRzLklOSVQsIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdERhdGEuY29udGFjdElkKSk7CiAgICAgIHNlbGYuX2ZpcmVDb250YWN0VXBkYXRlRXZlbnRzKGNvbnRhY3REYXRhLmNvbnRhY3RJZCwgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLklOSVQsIGNvbnRhY3REYXRhLnN0YXRlLnR5cGUpOwogICAgfSk7CiAKICAgIGNvbm5lY3QudmFsdWVzKGRpZmYucmVtb3ZlZCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LkNvbnRhY3RFdmVudHMuREVTVFJPWUVELCBuZXcgY29ubmVjdC5Db250YWN0U25hcHNob3QoY29udGFjdERhdGEpKTsKICAgICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuREVTVFJPWUVELCBjb250YWN0RGF0YS5jb250YWN0SWQpLCBuZXcgY29ubmVjdC5Db250YWN0U25hcHNob3QoY29udGFjdERhdGEpKTsKICAgICAgc2VsZi5fdW5zdWJBbGxDb250YWN0RXZlbnRzRm9yQ29udGFjdChjb250YWN0RGF0YS5jb250YWN0SWQpOwogICAgfSk7CiAKICAgIGNvbm5lY3Qua2V5cyhkaWZmLmNvbW1vbikuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICAgIHNlbGYuX2ZpcmVDb250YWN0VXBkYXRlRXZlbnRzKGNvbnRhY3RJZCwgZGlmZi5vbGRNYXBbY29udGFjdElkXS5zdGF0ZS50eXBlLCBkaWZmLm5ld01hcFtjb250YWN0SWRdLnN0YXRlLnR5cGUpOwogICAgfSk7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5fZmlyZUNvbnRhY3RVcGRhdGVFdmVudHMgPSBmdW5jdGlvbiAoY29udGFjdElkLCBvbGRDb250YWN0U3RhdGUsIG5ld0NvbnRhY3RTdGF0ZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYgKG9sZENvbnRhY3RTdGF0ZSAhPT0gbmV3Q29udGFjdFN0YXRlKSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnRHcmFwaCgpLmdldEFzc29jaWF0aW9ucyh0aGlzLCBvbGRDb250YWN0U3RhdGUsIG5ld0NvbnRhY3RTdGF0ZSkuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBzZWxmLmJ1cy50cmlnZ2VyKGV2ZW50LCBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkpOwogICAgICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUoZXZlbnQsIGNvbnRhY3RJZCksIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKSk7CiAgICAgIH0pOwogICAgfQogCiAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5SRUZSRVNILCBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkpOwogICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuUkVGUkVTSCwgY29udGFjdElkKSwgbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0SWQpKTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLl91bnN1YkFsbENvbnRhY3RFdmVudHNGb3JDb250YWN0ID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgY29ubmVjdC52YWx1ZXMoY29ubmVjdC5Db250YWN0RXZlbnRzKS5mb3JFYWNoKGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgICAgc2VsZi5idXMuZ2V0U3Vic2NyaXB0aW9ucyhjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShldmVudE5hbWUsIGNvbnRhY3RJZCkpCiAgICAgICAgLm1hcChmdW5jdGlvbiAoc3ViKSB7IHN1Yi51bnN1YnNjcmliZSgpOyB9KTsKICAgIH0pOwogIH07CiAKICAvKiogLS0tLS0gbWluaW1hbCB2aWV3IGxheWVyIGV2ZW50IGhhbmRsaW5nICoqLwogCiAgY29ubmVjdC5jb3JlLm9uVmlld0NvbnRhY3QgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkNvbnRhY3RFdmVudHMuVklFVywgZik7CiAgfTsKIAogIC8qKgogICAqIFVzZWQgb2YgYWdlbnQgaW50ZXJmYWNlIGNvbnRyb2wuIAogICAqIGNvbm5lY3QuY29yZS52aWV3Q29udGFjdCgiY29udGFjdElkIikgLT4gIHRoaXMgaXMgY3VyZW50bHkgcHJvZ3JhbW1lZCB0byBnZXQgdGhlIGNvbnRhY3QgaW50byB2aWV3LgogICAqLwogIGNvbm5lY3QuY29yZS52aWV3Q29udGFjdCA9IGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29udGFjdEV2ZW50cy5WSUVXLAogICAgICBkYXRhOiB7CiAgICAgICAgY29udGFjdElkOiBjb250YWN0SWQKICAgICAgfQogICAgfSk7CiAgfTsKIAogIC8qKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCiAKICAvKioKICAqIFRoaXMgd2lsbCBiZSBoZWxwZnVsIGZvciB0aGUgY3VzdG9tIGFuZCBlbWJlZGRlZCBDQ1BzIAogICogdG8gaGFuZGxlIHRoZSBhY2Nlc3MgZGVuaWVkIHVzZSBjYXNlLiAKICAqLwogIGNvbm5lY3QuY29yZS5vbkFjY2Vzc0RlbmllZCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDQ0VTU19ERU5JRUQsIGYpOwogIH07CiAKICAvKioKICAqIFRoaXMgd2lsbCBiZSBoZWxwZnVsIGZvciBTQU1MIHVzZSBjYXNlcyB0byBoYW5kbGUgdGhlIGN1c3RvbSBsb2dpbnMuIAogICovCiAgY29ubmVjdC5jb3JlLm9uQXV0aEZhaWwgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BVVRIX0ZBSUwsIGYpOwogIH07CiAKICAvKiogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwogCiAgLyoqCiAgICogVXNlZCBmb3IgaGFuZGxpbmcgdGhlIHJ0YyBzZXNzaW9uIHN0YXRzLgogICAqIFVzYWdlCiAgICogY29ubmVjdC5jb3JlLm9uU29mdHBob25lU2Vzc2lvbkluaXQoZnVuY3Rpb24oeyBjb25uZWN0aW9uSWQgfSkgewogICAqICAgICB2YXIgc29mdHBob25lTWFuYWdlciA9IGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVNYW5hZ2VyKCk7CiAgICogICAgIGlmKHNvZnRwaG9uZU1hbmFnZXIpewogICAqICAgICAgICAvLyBhY2Nlc3Mgc2Vzc2lvbgogICAqICAgICAgICB2YXIgc2Vzc2lvbiA9IHNvZnRwaG9uZU1hbmFnZXIuZ2V0U2Vzc2lvbihjb25uZWN0aW9uSWQpOyAKICAgKiAgICAgIH0KICAgKiB9KTsKICAgKi8KIAogIGNvbm5lY3QuY29yZS5vblNvZnRwaG9uZVNlc3Npb25Jbml0ID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5Db25ubmVjdGlvbkV2ZW50cy5TRVNTSU9OX0lOSVQsIGYpOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBjb250YWN0SWQpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChjb250YWN0SWQsICdjb250YWN0SWQnKTsKICAgIGlmICghY29ubmVjdC5jb250YWlucyhjb25uZWN0LnZhbHVlcyhjb25uZWN0LkNvbnRhY3RFdmVudHMpLCBldmVudE5hbWUpKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlZhbHVlRXJyb3IoJyVzIGlzIG5vdCBhIHZhbGlkIGNvbnRhY3QgZXZlbnQuJywgZXZlbnROYW1lKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LnNwcmludGYoJyVzOjolcycsIGV2ZW50TmFtZSwgY29udGFjdElkKTsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZXZlbnRCdXM7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0V2ViU29ja2V0TWFuYWdlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUud2ViU29ja2V0UHJvdmlkZXI7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmFnZW50RGF0YVByb3ZpZGVyOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldExvY2FsVGltZXN0YW1wID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFnZW50RGF0YSgpLnNuYXBzaG90LmxvY2FsVGltZXN0YW1wOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldFNrZXcgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0QWdlbnREYXRhKCkuc25hcHNob3Quc2tldzsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRBZ2VudFJvdXRpbmdFdmVudEdyYXBoID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5hZ2VudFJvdXRpbmdFdmVudEdyYXBoOwogIH07CiAgY29ubmVjdC5jb3JlLmFnZW50Um91dGluZ0V2ZW50R3JhcGggPSBuZXcgY29ubmVjdC5FdmVudEdyYXBoKCkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLCBjb25uZWN0LkFnZW50U3RhdGVUeXBlLlJPVVRBQkxFLAogICAgICBjb25uZWN0LkFnZW50RXZlbnRzLlJPVVRBQkxFKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUuTk9UX1JPVVRBQkxFLAogICAgICBjb25uZWN0LkFnZW50RXZlbnRzLk5PVF9ST1VUQUJMRSkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLCBjb25uZWN0LkFnZW50U3RhdGVUeXBlLk9GRkxJTkUsCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuT0ZGTElORSk7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldEFnZW50U3RhdGVFdmVudEdyYXBoID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5hZ2VudFN0YXRlRXZlbnRHcmFwaDsKICB9OwogIGNvbm5lY3QuY29yZS5hZ2VudFN0YXRlRXZlbnRHcmFwaCA9IG5ldyBjb25uZWN0LkV2ZW50R3JhcGgoKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QudmFsdWVzKGNvbm5lY3QuQWdlbnRFcnJvclN0YXRlcyksCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuRVJST1IpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwgY29ubmVjdC5BZ2VudEF2YWlsU3RhdGVzLkFGVEVSX0NBTExfV09SSywKICAgICAgY29ubmVjdC5BZ2VudEV2ZW50cy5BQ1cpOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnRHcmFwaCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuY29udGFjdEV2ZW50R3JhcGg7CiAgfTsKIAogIGNvbm5lY3QuY29yZS5jb250YWN0RXZlbnRHcmFwaCA9IG5ldyBjb25uZWN0LkV2ZW50R3JhcGgoKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5JTkNPTUlORywKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLklOQ09NSU5HKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5QRU5ESU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuUEVORElORykKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuQ09OTkVDVElORywKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLkNPTk5FQ1RJTkcpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkNPTk5FQ1RFRCwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLkNPTk5FQ1RFRCkKICAgIC5hc3NvYyhjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuQ09OTkVDVElORywKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkVSUk9SLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuTUlTU0VEKQogICAgLmFzc29jKGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5JTkNPTUlORywKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkVSUk9SLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuTUlTU0VEKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5FTkRFRCwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLkFDVykKICAgIC5hc3NvYyhjb25uZWN0LnZhbHVlcyhjb25uZWN0LkNPTlRBQ1RfQUNUSVZFX1NUQVRFUyksCiAgICAgIGNvbm5lY3QudmFsdWVzKGNvbm5lY3QucmVsYXRpdmVDb21wbGVtZW50KGNvbm5lY3QuQ09OVEFDVF9BQ1RJVkVfU1RBVEVTLCBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUpKSwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLkVOREVEKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QudmFsdWVzKGNvbm5lY3QuQWdlbnRFcnJvclN0YXRlcyksCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5FUlJPUik7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmNvcmUuY2xpZW50KSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ1RoZSBjb25uZWN0IGNvcmUgaGFzIG5vdCBiZWVuIGluaXRpYWxpemVkIScpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5jbGllbnQ7CiAgfTsKICBjb25uZWN0LmNvcmUuY2xpZW50ID0gbnVsbDsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0TWFzdGVyQ2xpZW50ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50KSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ1RoZSBjb25uZWN0IG1hc3RlciBjbGllbnQgaGFzIG5vdCBiZWVuIGluaXRpYWxpemVkIScpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQ7CiAgfTsKICBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50ID0gbnVsbDsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lTWFuYWdlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlcjsKICB9OwogIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyID0gbnVsbDsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0Tm90aWZpY2F0aW9uTWFuYWdlciA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLm5vdGlmaWNhdGlvbk1hbmFnZXIpIHsKICAgICAgY29ubmVjdC5jb3JlLm5vdGlmaWNhdGlvbk1hbmFnZXIgPSBuZXcgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyKCk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLm5vdGlmaWNhdGlvbk1hbmFnZXI7CiAgfTsKICBjb25uZWN0LmNvcmUubm90aWZpY2F0aW9uTWFuYWdlciA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldFBvcHVwTWFuYWdlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUucG9wdXBNYW5hZ2VyOwogIH07CiAgY29ubmVjdC5jb3JlLnBvcHVwTWFuYWdlciA9IG5ldyBjb25uZWN0LlBvcHVwTWFuYWdlcigpOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLnVwc3RyZWFtKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ1RoZXJlIGlzIG5vIHVwc3RyZWFtIGNvbmR1aXQhJyk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLnVwc3RyZWFtOwogIH07CiAgY29ubmVjdC5jb3JlLnVwc3RyZWFtID0gbnVsbDsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuQWdlbnREYXRhUHJvdmlkZXIgPSBBZ2VudERhdGFQcm92aWRlcjsKIAp9KSgpOwovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgdmFyIFJpbmd0b25lRW5naW5lQmFzZSA9IGZ1bmN0aW9uIChyaW5ndG9uZUNvbmZpZykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdGhpcy5fcHJldkNvbnRhY3RJZCA9IG51bGw7CgogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJpbmd0b25lQ29uZmlnLCAicmluZ3RvbmVDb25maWciKTsKICAgIGlmICghcmluZ3RvbmVDb25maWcucmluZ3RvbmVVcmwpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJyaW5ndG9uZVVybCBpcyByZXF1aXJlZCEiKTsKICAgIH0KCiAgICBpZiAoZ2xvYmFsLkF1ZGlvICYmIHR5cGVvZiBnbG9iYWwuUHJvbWlzZSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgdGhpcy5fcGxheWFibGVBdWRpb1Byb21pc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgc2VsZi5fYXVkaW8gPSBuZXcgQXVkaW8ocmluZ3RvbmVDb25maWcucmluZ3RvbmVVcmwpOwogICAgICAgIHNlbGYuX2F1ZGlvLmxvb3AgPSB0cnVlOwogICAgICAgIHNlbGYuX2F1ZGlvLmFkZEV2ZW50TGlzdGVuZXIoImNhbnBsYXkiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBzZWxmLl9hdWRpb1BsYXlhYmxlID0gdHJ1ZTsKICAgICAgICAgIHJlc29sdmUoc2VsZi5fYXVkaW8pOwogICAgICAgIH0pOwogICAgICB9KTsKCiAgICB9IGVsc2UgewogICAgICB0aGlzLl9hdWRpbyA9IG51bGw7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIlVuYWJsZSB0byBwcm92aWRlIGEgcmluZ3RvbmUuIik7CiAgICB9CgogICAgc2VsZi5fZHJpdmVSaW5ndG9uZSgpOwogIH07CgogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIk5vdCBpbXBsZW1lbnRlZC4iKTsKICB9OwoKICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLl9zdGFydFJpbmd0b25lID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIGlmICh0aGlzLl9hdWRpbykgewogICAgICB0aGlzLl9hdWRpby5wbGF5KCk7CiAgICAgIHRoaXMuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiUmluZ3RvbmUgU3RhcnQiLCBjb250YWN0KTsKICAgIH0KICB9OwoKICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLl9zdG9wUmluZ3RvbmUgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgaWYgKHRoaXMuX2F1ZGlvKSB7CiAgICAgIHRoaXMuX2F1ZGlvLnBhdXNlKCk7CiAgICAgIHRoaXMuX2F1ZGlvLmN1cnJlbnRUaW1lID0gMDsKICAgICAgdGhpcy5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJSaW5ndG9uZSBTdG9wIiwgY29udGFjdCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogU3RvcCByaW5ndG9uZS4KICAgKi8KICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLnN0b3BSaW5ndG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuX3N0b3BSaW5ndG9uZSgpOwogIH07CgogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuX3Jpbmd0b25lU2V0dXAgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5SSU5HVE9ORSwgZnVuY3Rpb24gKCkgewogICAgICBzZWxmLl9zdGFydFJpbmd0b25lKGNvbnRhY3QpOwogICAgICBzZWxmLl9wcmV2Q29udGFjdElkID0gY29udGFjdC5nZXRDb250YWN0SWQoKTsKCiAgICAgIGNvbnRhY3Qub25Db25uZWN0ZWQobGlseS5oaXRjaChzZWxmLCBzZWxmLl9zdG9wUmluZ3RvbmUpKTsKICAgICAgY29udGFjdC5vbkFjY2VwdGVkKGxpbHkuaGl0Y2goc2VsZiwgc2VsZi5fc3RvcFJpbmd0b25lKSk7CiAgICAgIGNvbnRhY3Qub25FbmRlZChsaWx5LmhpdGNoKHNlbGYsIHNlbGYuX3N0b3BSaW5ndG9uZSkpOwogICAgICAvLyBKdXN0IHRvIG1ha2Ugc3VyZSB0byBzdG9wIHRoZSByaW5ndG9uZSBpbiBjYXNlIG9mIHRoZSBmYWlsdXJlcyBvZiBzcGVjaWZpYyBjYWxsYmFja3Mob25BY2NlcHRlZCxvbkNvbm5lY3RlZCk7CiAgICAgIGNvbnRhY3Qub25SZWZyZXNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgICAgaWYgKGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSAhPT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5DT05ORUNUSU5HICYmCiAgICAgICAgICBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgIT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuSU5DT01JTkcpIHsKICAgICAgICAgIHNlbGYuX3N0b3BSaW5ndG9uZSgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBjb250YWN0KSB7CiAgICBpZiAoY29udGFjdCAmJiBjb250YWN0LmdldENvbnRhY3RJZCgpKSB7CiAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgbmFtZTogZXZlbnROYW1lLAogICAgICAgIGNvbnRhY3RJZDogY29udGFjdC5nZXRDb250YWN0SWQoKQogICAgICB9KTsKICAgIH0KICB9OwoKICAvKioKICAgKiBDaGFuZ2UgdGhlIGF1ZGlvIGRldmljZSB1c2VkIHRvIHBsYXkgcmluZ3RvbmUuCiAgICogSWYgYXVkaW8gZWxlbWVudCBpcyBub3QgZnVsbHkgaW5pdGlhbGl6ZWQsIHRoZSBBUEkgd2lsbCB3YWl0IF9hdWRpb1BsYXlhYmxlUHJvbWlzZSBmb3IgMyBzZWNvbmRzIGFuZCBmYWlsIG9uIHRpbWVvdXQuCiAgICogVGhpcyBBUEkgaXMgc3VwcG9ydGVkIG9ubHkgYnkgYnJvd3NlcnMgdGhhdCBpbXBsZW1lbnRlZCBFUzYgUHJvbWlzZSBhbmQgaHR0cDovL3d3dy53My5vcmcvVFIvYXVkaW8tb3V0cHV0LwogICAqIFJldHVybiBhIFByb21pc2UgdGhhdCBpbmRpY2F0ZXMgdGhlIHJlc3VsdCBvZiBjaGFuZ2luZyBvdXRwdXQgZGV2aWNlLgogICAqLwogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuc2V0T3V0cHV0RGV2aWNlID0gZnVuY3Rpb24gKGRldmljZUlkKSB7CiAgICBpZiAodGhpcy5fcGxheWFibGVBdWRpb1Byb21pc2UpIHsKICAgICAgdmFyIHBsYXlhYmxlQXVkaW9XaXRoVGltZW91dCA9IFByb21pc2UucmFjZShbCiAgICAgICAgdGhpcy5fcGxheWFibGVBdWRpb1Byb21pc2UsCiAgICAgICAgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyByZWplY3QoIlRpbWVkIG91dCB3YWl0aW5nIGZvciBwbGF5YWJsZSBhdWRpbyIpOyB9LCAzMDAwLyptcyovKTsKICAgICAgICB9KQogICAgICBdKTsKICAgICAgcmV0dXJuIHBsYXlhYmxlQXVkaW9XaXRoVGltZW91dC50aGVuKGZ1bmN0aW9uIChhdWRpbykgewogICAgICAgIGlmIChhdWRpby5zZXRTaW5rSWQpIHsKICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoYXVkaW8uc2V0U2lua0lkKGRldmljZUlkKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgiTm90IHN1cHBvcnRlZCIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgaWYgKGdsb2JhbC5Qcm9taXNlKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgiTm90IGVsaWdpYmxlIHJpbmd0b25lIG93bmVyIik7CiAgICB9CiAgfTsKCiAgdmFyIFZvaWNlUmluZ3RvbmVFbmdpbmUgPSBmdW5jdGlvbiAocmluZ3RvbmVDb25maWcpIHsKICAgIFJpbmd0b25lRW5naW5lQmFzZS5jYWxsKHRoaXMsIHJpbmd0b25lQ29uZmlnKTsKICB9OwogIFZvaWNlUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlKTsKICBWb2ljZVJpbmd0b25lRW5naW5lLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFZvaWNlUmluZ3RvbmVFbmdpbmU7CgogIFZvaWNlUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLl9kcml2ZVJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHZhciBvbkNvbnRhY3RDb25uZWN0ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgaWYgKGNvbnRhY3QuZ2V0VHlwZSgpID09PSBsaWx5LkNvbnRhY3RUeXBlLlZPSUNFICYmCiAgICAgICAgY29udGFjdC5pc1NvZnRwaG9uZUNhbGwoKSAmJiBjb250YWN0LmlzSW5ib3VuZCgpKSB7CiAgICAgICAgc2VsZi5fcmluZ3RvbmVTZXR1cChjb250YWN0KTsKICAgICAgICBzZWxmLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlJpbmd0b25lIENvbm5lY3RpbmciLCBjb250YWN0KTsKICAgICAgfQogICAgfTsKCiAgICBjb25uZWN0LmNvbnRhY3QoZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgY29udGFjdC5vbkNvbm5lY3Rpbmcob25Db250YWN0Q29ubmVjdCk7CiAgICB9KTsKCiAgICBuZXcgY29ubmVjdC5BZ2VudCgpLmdldENvbnRhY3RzKCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBpZiAoY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkNPTk5FQ1RJTkcpIHsKICAgICAgICBvbkNvbnRhY3RDb25uZWN0KGNvbnRhY3QpOwogICAgICB9CiAgICB9KTsKICB9OwoKCiAgdmFyIENoYXRSaW5ndG9uZUVuZ2luZSA9IGZ1bmN0aW9uIChyaW5ndG9uZUNvbmZpZykgewogICAgUmluZ3RvbmVFbmdpbmVCYXNlLmNhbGwodGhpcywgcmluZ3RvbmVDb25maWcpOwogIH07CiAgQ2hhdFJpbmd0b25lRW5naW5lLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZSk7CiAgQ2hhdFJpbmd0b25lRW5naW5lLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENoYXRSaW5ndG9uZUVuZ2luZTsKCiAgQ2hhdFJpbmd0b25lRW5naW5lLnByb3RvdHlwZS5fZHJpdmVSaW5ndG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB2YXIgb25Db250YWN0Q29ubmVjdCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGlmIChjb250YWN0LmdldFR5cGUoKSA9PT0gbGlseS5Db250YWN0VHlwZS5DSEFUICYmIGNvbnRhY3QuaXNJbmJvdW5kKCkpIHsKICAgICAgICBzZWxmLl9yaW5ndG9uZVNldHVwKGNvbnRhY3QpOwogICAgICAgIHNlbGYuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBSaW5ndG9uZSBDb25uZWN0aW5nIiwgY29udGFjdCk7CiAgICAgIH0KICAgIH07CgogICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGNvbnRhY3Qub25Db25uZWN0aW5nKG9uQ29udGFjdENvbm5lY3QpOwogICAgfSk7CiAgfTsKCiAgdmFyIFRhc2tSaW5ndG9uZUVuZ2luZSA9IGZ1bmN0aW9uIChyaW5ndG9uZUNvbmZpZykgewogICAgUmluZ3RvbmVFbmdpbmVCYXNlLmNhbGwodGhpcywgcmluZ3RvbmVDb25maWcpOwogIH07CiAgVGFza1Jpbmd0b25lRW5naW5lLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZSk7CiAgVGFza1Jpbmd0b25lRW5naW5lLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFRhc2tSaW5ndG9uZUVuZ2luZTsKCiAgVGFza1Jpbmd0b25lRW5naW5lLnByb3RvdHlwZS5fZHJpdmVSaW5ndG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB2YXIgb25Db250YWN0Q29ubmVjdCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGlmIChjb250YWN0LmdldFR5cGUoKSA9PT0gbGlseS5Db250YWN0VHlwZS5UQVNLICYmIGNvbnRhY3QuaXNJbmJvdW5kKCkpIHsKICAgICAgICBzZWxmLl9yaW5ndG9uZVNldHVwKGNvbnRhY3QpOwogICAgICAgIHNlbGYuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiVGFzayBSaW5ndG9uZSBDb25uZWN0aW5nIiwgY29udGFjdCk7CiAgICAgIH0KICAgIH07CgogICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGNvbnRhY3Qub25Db25uZWN0aW5nKG9uQ29udGFjdENvbm5lY3QpOwogICAgfSk7CiAgfTsKCgogIHZhciBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUgPSBmdW5jdGlvbiAocmluZ3RvbmVDb25maWcpIHsKICAgIFJpbmd0b25lRW5naW5lQmFzZS5jYWxsKHRoaXMsIHJpbmd0b25lQ29uZmlnKTsKICB9OwogIFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUpOwogIFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmU7CgogIFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGNvbnRhY3Qub25JbmNvbWluZyhmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKGNvbnRhY3QuZ2V0VHlwZSgpID09PSBsaWx5LkNvbnRhY3RUeXBlLlFVRVVFX0NBTExCQUNLKSB7CiAgICAgICAgICBzZWxmLl9yaW5ndG9uZVNldHVwKGNvbnRhY3QpOwogICAgICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDYWxsYmFjayBSaW5ndG9uZSBDb25uZWN0aW5nIiwgY29udGFjdCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH07CgogIC8qIGV4cG9ydCBjb25uZWN0LlJpbmd0b25lRW5naW5lICovCiAgY29ubmVjdC5Wb2ljZVJpbmd0b25lRW5naW5lID0gVm9pY2VSaW5ndG9uZUVuZ2luZTsKICBjb25uZWN0LkNoYXRSaW5ndG9uZUVuZ2luZSA9IENoYXRSaW5ndG9uZUVuZ2luZTsKICBjb25uZWN0LlRhc2tSaW5ndG9uZUVuZ2luZSA9IFRhc2tSaW5ndG9uZUVuZ2luZTsKICBjb25uZWN0LlF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZSA9IFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZTsKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmNjcFZlcnNpb24gPSAiVjIiOwoKICB2YXIgUlRQSm9iSW50ZXJ2YWxNcyA9IDEwMDA7CiAgdmFyIHN0YXRzUmVwb3J0aW5nSm9iSW50ZXJ2YWxNcyA9IDMwMDAwOwogIHZhciBzdHJlYW1CdWZmZXJTaXplID0gNTAwOwogIHZhciBDYWxsVHlwZU1hcCA9IHt9OwogIENhbGxUeXBlTWFwW2Nvbm5lY3QuU29mdHBob25lQ2FsbFR5cGUuQVVESU9fT05MWV0gPSAnQXVkaW8nOwogIENhbGxUeXBlTWFwW2Nvbm5lY3QuU29mdHBob25lQ2FsbFR5cGUuVklERU9fT05MWV0gPSAnVmlkZW8nOwogIENhbGxUeXBlTWFwW2Nvbm5lY3QuU29mdHBob25lQ2FsbFR5cGUuQVVESU9fVklERU9dID0gJ0F1ZGlvVmlkZW8nOwogIENhbGxUeXBlTWFwW2Nvbm5lY3QuU29mdHBob25lQ2FsbFR5cGUuTk9ORV0gPSAnTm9uZSc7CiAgdmFyIEFVRElPX0lOUFVUID0gJ2F1ZGlvX2lucHV0JzsKICB2YXIgQVVESU9fT1VUUFVUID0gJ2F1ZGlvX291dHB1dCc7CgogIHZhciBNZWRpYVR5cGVNYXAgPSB7fTsKICBNZWRpYVR5cGVNYXBbY29ubmVjdC5Db250YWN0VHlwZS5WT0lDRV0gPSAiVm9pY2UiOwogIHZhciBVTktOT1dOX01FRElBX1RZUEUgPSAiVW5rbm93biI7CgogIHZhciB0aW1lU2VyaWVzU3RyZWFtU3RhdHNCdWZmZXIgPSBbXTsKICB2YXIgYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzID0ge307CiAgdmFyIGFnZ3JlZ2F0ZWRSZW1vdGVBdWRpb1N0YXRzID0ge307CiAgdmFyIHJ0cFN0YXRzSm9iID0gbnVsbDsKICB2YXIgcmVwb3J0U3RhdHNKb2IgPSBudWxsOwogIC8vTG9nZ2VyIHNwZWNpZmljIHRvIHNvZnRwaG9uZS4KICB2YXIgbG9nZ2VyID0gbnVsbDsKICB2YXIgU29mdHBob25lRXJyb3JUeXBlcyA9IGNvbm5lY3QuU29mdHBob25lRXJyb3JUeXBlczsKICB2YXIgSEFOR19VUF9NVUxUSVBMRV9TRVNTSU9OU19FVkVOVCA9ICJNdWx0aVNlc3Npb25IYW5nVXAiOwogIHZhciBNVUxUSVBMRV9TRVNTSU9OU19FVkVOVCA9ICJNdWx0aVNlc3Npb25zIjsKCiAgdmFyIGxvY2FsTWVkaWFTdHJlYW0gPSB7fTsKCiAgdmFyIHNvZnRwaG9uZUNsaWVudElkID0gY29ubmVjdC5yYW5kb21JZCgpOwoKICB2YXIgcmVxdWVzdEljZUFjY2VzcyA9IGZ1bmN0aW9uICh0cmFuc3BvcnQpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKS5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfVFJBTlNQT1JULCB0cmFuc3BvcnQsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgcmVzb2x2ZShkYXRhLnNvZnRwaG9uZVRyYW5zcG9ydC5zb2Z0cGhvbmVNZWRpYUNvbm5lY3Rpb25zKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgIGlmIChyZWFzb24ubWVzc2FnZSAmJiByZWFzb24ubWVzc2FnZS5pbmNsdWRlcygiU29mdHBob25lQ29ubmVjdGlvbkxpbWl0QnJlYWNoZWRFeGNlcHRpb24iKSkgewogICAgICAgICAgICBwdWJsaXNoRXJyb3IoIm11bHRpcGxlX3NvZnRwaG9uZV9hY3RpdmVfc2Vzc2lvbnMiLCAiTnVtYmVyIG9mIGFjdGl2ZSBzZXNzaW9ucyBhcmUgbW9yZSB0aGVuIGFsbG93ZWQgbGltaXQuIiwgIiIpOwogICAgICAgICAgfQogICAgICAgICAgcmVqZWN0KEVycm9yKCJyZXF1ZXN0SWNlQWNjZXNzIGZhaWxlZCIpKTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZWplY3QoRXJyb3IoIkF1dGhlbnRpY2F0aW9uIGZhaWxlZCB3aGlsZSByZXF1ZXN0SWNlQWNjZXNzIikpOwogICAgICAgIH0sCiAgICAgICAgYWNjZXNzRGVuaWVkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZWplY3QoRXJyb3IoIkFjY2VzcyBEZW5pZWQgd2hpbGUgcmVxdWVzdEljZUFjY2VzcyIpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgdmFyIFNvZnRwaG9uZU1hbmFnZXIgPSBmdW5jdGlvbiAoc29mdHBob25lUGFyYW1zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBsb2dnZXIgPSBuZXcgU29mdHBob25lTG9nZ2VyKGNvbm5lY3QuZ2V0TG9nKCkpOwogICAgdmFyIHJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeTsKICAgIGlmIChjb25uZWN0LlJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeSkgewogICAgICBydGNQZWVyQ29ubmVjdGlvbkZhY3RvcnkgPSBuZXcgY29ubmVjdC5SdGNQZWVyQ29ubmVjdGlvbkZhY3RvcnkobG9nZ2VyLAogICAgICAgIGNvbm5lY3QuY29yZS5nZXRXZWJTb2NrZXRNYW5hZ2VyKCksCiAgICAgICAgc29mdHBob25lQ2xpZW50SWQsCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCByZXF1ZXN0SWNlQWNjZXNzLCB7CiAgICAgICAgICB0cmFuc3BvcnRUeXBlOiAic29mdHBob25lIiwKICAgICAgICAgIHNvZnRwaG9uZUNsaWVudElkOiBzb2Z0cGhvbmVDbGllbnRJZAogICAgICAgIH0pLAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgcHVibGlzaEVycm9yKSk7CiAgICB9CiAgICBpZiAoIWlzQnJvd3NlclNvZnRQaG9uZVN1cHBvcnRlZCgpKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLlVOU1VQUE9SVEVEX0JST1dTRVIsCiAgICAgICAgIkNvbm5lY3QgZG9lcyBub3Qgc3VwcG9ydCB0aGlzIGJyb3dzZXIuIFNvbWUgZnVuY3Rpb25hbGl0eSBtYXkgbm90IHdvcmsuICIsCiAgICAgICAgIiIpOwogICAgfQogICAgdmFyIGd1bVByb21pc2UgPSBmZXRjaFVzZXJNZWRpYSh7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChzdHJlYW0pIHsKICAgICAgICBpZiAoY29ubmVjdC5pc0ZpcmVmb3hCcm93c2VyKCkpIHsKICAgICAgICAgIGNvbm5lY3QuY29yZS5zZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0oc3RyZWFtKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICBwdWJsaXNoRXJyb3IoZXJyLCAiWW91ciBtaWNyb3Bob25lIGlzIG5vdCBlbmFibGVkIGluIHlvdXIgYnJvd3Nlci4gIiwgIiIpOwogICAgICB9CiAgICB9KTsKICAgIGhhbmRsZVNvZnRQaG9uZU11dGVUb2dnbGUoKTsKCiAgICB0aGlzLnJpbmd0b25lRW5naW5lID0gbnVsbDsKICAgIHZhciBjbGVhbk11bHRpcGxlU2Vzc2lvbnMgPSAndHJ1ZScgPT09IHNvZnRwaG9uZVBhcmFtcy5jbGVhbk11bHRpcGxlU2Vzc2lvbnM7CiAgICB2YXIgcnRjU2Vzc2lvbnMgPSB7fTsKICAgIC8vIFRyYWNrcyB0aGUgYWdlbnQgY29ubmVjdGlvbiBJRCwgc28gdGhhdCBpZiB0aGUgc2FtZSBjb250YWN0IGdldHMgcmUtcm91dGVkIHRvIHRoZSBzYW1lIGFnZW50LCBpdCdsbCBzdGlsbCBzZXQgdXAgc29mdHBob25lCiAgICB2YXIgY2FsbHNEZXRlY3RlZCA9IHt9OwoKICAgIC8vIGhlbHBlciBtZXRob2QgdG8gcHJvdmlkZSBhY2Nlc3MgdG8gcnRjIHNlc3Npb25zCiAgICB0aGlzLmdldFNlc3Npb24gPSBmdW5jdGlvbiAoY29ubmVjdGlvbklkKSB7CiAgICAgIHJldHVybiBydGNTZXNzaW9uc1tjb25uZWN0aW9uSWRdOwogICAgfQoKICAgIHZhciBpc0NvbnRhY3RUZXJtaW5hdGVkID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgcmV0dXJuIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5FTkRFRCB8fAogICAgICAgIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5FUlJPUiB8fAogICAgICAgIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5NSVNTRUQ7CiAgICB9OwoKICAgIHZhciBkZXN0cm95U2Vzc2lvbiA9IGZ1bmN0aW9uIChhZ2VudENvbm5lY3Rpb25JZCkgewogICAgICBpZiAocnRjU2Vzc2lvbnMuaGFzT3duUHJvcGVydHkoYWdlbnRDb25uZWN0aW9uSWQpKSB7CiAgICAgICAgdmFyIHNlc3Npb24gPSBydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgLy8gQ3VycmVudGx5IHRoZSBhc3N1bXB0aW9uIGlzIGl0IHdpbGwgdGhyb3cgYW4gZXhjZXB0aW9uIG9ubHkgYW5kIGlmIG9ubHkgaXQgYWxyZWFkeSBoYXMgYmVlbiBodW5nIHVwLgogICAgICAgIC8vIFRPRE86IFVwZGF0ZSBvbmNlIHRoZSBoYW5ndXAgQVBJIGRvZXMgbm90IHRocm93IGV4Y2VwdGlvbnMKICAgICAgICBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICBkZWxldGUgcnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgICAgZGVsZXRlIGNhbGxzRGV0ZWN0ZWRbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgICAgc2Vzc2lvbi5oYW5ndXAoKTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICBsaWx5LmdldExvZygpLndhcm4oIkNsZWFuIHVwIHRoZSBzZXNzaW9uIGxvY2FsbHkgIiArIGFnZW50Q29ubmVjdGlvbklkLCBlcnIubWVzc2FnZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CgogICAgLy8gV2hlbiBmZWF0dXJlIGFjY2VzcyBjb250cm9sIGZsYWcgaXMgb24sIGlnbm9yZSB0aGUgbmV3IGNhbGwgYW5kIGhhbmcgdXAgdGhlIHByZXZpb3VzIHNlc3Npb25zLgogICAgLy8gT3RoZXJ3aXNlIGp1c3QgbG9nIHRoZSBjb250YWN0IGFuZCBhZ2VudCBpbiB0aGUgY2xpZW50IHNpZGUgbWV0cmljcy4KICAgIC8vIFRPRE86IFVwZGF0ZSB3aGVuIGNvbm5lY3QtcnRjIGV4cG9zZXMgYW4gQVBJIHRvIGRldGVjdCBzZXNzaW9uIHN0YXR1cy4KICAgIHZhciBzYW5pdHlDaGVja0FjdGl2ZVNlc3Npb25zID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb25zKSB7CiAgICAgIGlmIChPYmplY3Qua2V5cyhydGNTZXNzaW9ucykubGVuZ3RoID4gMCkgewogICAgICAgIGlmIChjbGVhbk11bHRpcGxlU2Vzc2lvbnMpIHsKICAgICAgICAgIC8vIEVycm9yISBvdXIgc3RhdGUgZG9lc24ndCBtYXRjaCwgdGVhciBpdCBhbGwgZG93bi4KICAgICAgICAgIGZvciAodmFyIGNvbm5lY3Rpb25JZCBpbiBydGNTZXNzaW9ucykgewogICAgICAgICAgICBpZiAocnRjU2Vzc2lvbnMuaGFzT3duUHJvcGVydHkoY29ubmVjdGlvbklkKSkgewogICAgICAgICAgICAgIC8vIExvZyBhbiBlcnJvciBmb3IgdGhlIHNlc3Npb24gd2UgYXJlIGFib3V0IHRvIGtpbGwuCiAgICAgICAgICAgICAgcHVibGlzaE11bHRpcGxlU2Vzc2lvbnNFdmVudChIQU5HX1VQX01VTFRJUExFX1NFU1NJT05TX0VWRU5ULCBydGNTZXNzaW9uc1tjb25uZWN0aW9uSWRdLmNhbGxJZCwgY29ubmVjdGlvbklkKTsKICAgICAgICAgICAgICBkZXN0cm95U2Vzc2lvbihjb25uZWN0aW9uSWQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImR1cGxpY2F0ZSBzZXNzaW9uIGRldGVjdGVkLCByZWZ1c2luZyB0byBzZXR1cCBuZXcgY29ubmVjdGlvbiIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3IgKHZhciBfY29ubmVjdGlvbklkIGluIHJ0Y1Nlc3Npb25zKSB7CiAgICAgICAgICAgIGlmIChydGNTZXNzaW9ucy5oYXNPd25Qcm9wZXJ0eShfY29ubmVjdGlvbklkKSkgewogICAgICAgICAgICAgIHB1Ymxpc2hNdWx0aXBsZVNlc3Npb25zRXZlbnQoTVVMVElQTEVfU0VTU0lPTlNfRVZFTlQsIHJ0Y1Nlc3Npb25zW19jb25uZWN0aW9uSWRdLmNhbGxJZCwgX2Nvbm5lY3Rpb25JZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgdmFyIG9uUmVmcmVzaENvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpIHsKICAgICAgaWYgKHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXSAmJiBpc0NvbnRhY3RUZXJtaW5hdGVkKGNvbnRhY3QpKSB7CiAgICAgICAgZGVzdHJveVNlc3Npb24oYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICB9CiAgICAgIGlmIChjb250YWN0LmlzU29mdHBob25lQ2FsbCgpICYmICFjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXSAmJiAoCiAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkNPTk5FQ1RJTkcgfHwKICAgICAgICBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuSU5DT01JTkcpKSB7CgogICAgICAgIC8vIFNldCB0byB0cnVlLCB0aGlzIHdpbGwgYmxvY2sgc3Vic2VxdWVudCBpbnZva2VzIGZyb20gZW50ZXJpbmcuCiAgICAgICAgY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF0gPSB0cnVlOwogICAgICAgIGxvZ2dlci5pbmZvKCJTb2Z0cGhvbmUgY2FsbCBkZXRlY3RlZDoiLCAiY29udGFjdElkICIgKyBjb250YWN0LmdldENvbnRhY3RJZCgpLCAiYWdlbnQgY29ubmVjdGlvbklkICIgKyBhZ2VudENvbm5lY3Rpb25JZCk7CgogICAgICAgIC8vIEVuc3VyZSBvdXIgc2Vzc2lvbiBzdGF0ZSBtYXRjaGVzIG91ciBjb250YWN0IHN0YXRlIHRvIHByZXZlbnQgaXNzdWVzIHNob3VsZCB3ZSBsb3NlIHRyYWNrIG9mIGEgY29udGFjdC4KICAgICAgICBzYW5pdHlDaGVja0FjdGl2ZVNlc3Npb25zKHJ0Y1Nlc3Npb25zKTsKCiAgICAgICAgaWYgKGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5DT05ORUNUSU5HKSB7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlNvZnRwaG9uZSBDb25uZWN0aW5nIiwgY29udGFjdC5nZXRDb250YWN0SWQoKSk7CiAgICAgICAgfQoKICAgICAgICBpbml0aWFsaXplUGFyYW1zKCk7CiAgICAgICAgdmFyIHNvZnRwaG9uZUluZm8gPSBjb250YWN0LmdldEFnZW50Q29ubmVjdGlvbigpLmdldFNvZnRwaG9uZU1lZGlhSW5mbygpOwogICAgICAgIHZhciBjYWxsQ29uZmlnID0gcGFyc2VDYWxsQ29uZmlnKHNvZnRwaG9uZUluZm8uY2FsbENvbmZpZ0pzb24pOwogICAgICAgIHZhciB3ZWJTb2NrZXRQcm92aWRlcjsKICAgICAgICBpZiAoY2FsbENvbmZpZy51c2VXZWJTb2NrZXRQcm92aWRlcikgewogICAgICAgICAgd2ViU29ja2V0UHJvdmlkZXIgPSBjb25uZWN0LmNvcmUuZ2V0V2ViU29ja2V0TWFuYWdlcigpOwogICAgICAgIH0KICAgICAgICB2YXIgc2Vzc2lvbiA9IG5ldyBjb25uZWN0LlJUQ1Nlc3Npb24oCiAgICAgICAgICBjYWxsQ29uZmlnLnNpZ25hbGluZ0VuZHBvaW50LAogICAgICAgICAgY2FsbENvbmZpZy5pY2VTZXJ2ZXJzLAogICAgICAgICAgc29mdHBob25lSW5mby5jYWxsQ29udGV4dFRva2VuLAogICAgICAgICAgbG9nZ2VyLAogICAgICAgICAgY29udGFjdC5nZXRDb250YWN0SWQoKSwKICAgICAgICAgIGFnZW50Q29ubmVjdGlvbklkLAogICAgICAgICAgd2ViU29ja2V0UHJvdmlkZXIpOwoKICAgICAgICBydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF0gPSBzZXNzaW9uOwoKICAgICAgICBpZiAoY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSgpKSB7CiAgICAgICAgICBzZXNzaW9uLm1lZGlhU3RyZWFtID0gY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gQ3VzdG9tIEV2ZW50IHRvIGluZGljYXRlIHRoZSBzZXNzaW9uIGluaXQgb3BlcmF0aW9ucwogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgICAgIGV2ZW50OiBjb25uZWN0LkNvbm5uZWN0aW9uRXZlbnRzLlNFU1NJT05fSU5JVCwKICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgY29ubmVjdGlvbklkOiBhZ2VudENvbm5lY3Rpb25JZAogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBzZXNzaW9uLm9uU2Vzc2lvbkZhaWxlZCA9IGZ1bmN0aW9uIChydGNTZXNzaW9uLCByZWFzb24pIHsKICAgICAgICAgIGRlbGV0ZSBydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgICBkZWxldGUgY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgICBwdWJsaXNoU29mdHBob25lRmFpbHVyZUxvZ3MocnRjU2Vzc2lvbiwgcmVhc29uKTsKICAgICAgICAgIHB1Ymxpc2hTZXNzaW9uRmFpbHVyZVRlbGVtZXRyeUV2ZW50KGNvbnRhY3QuZ2V0Q29udGFjdElkKCksIHJlYXNvbik7CiAgICAgICAgICBzdG9wSm9ic0FuZFJlcG9ydChjb250YWN0LCBydGNTZXNzaW9uLnNlc3Npb25SZXBvcnQpOwogICAgICAgIH07CiAgICAgICAgc2Vzc2lvbi5vblNlc3Npb25Db25uZWN0ZWQgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbikgewogICAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJTb2Z0cGhvbmUgU2Vzc2lvbiBDb25uZWN0ZWQiLCBjb250YWN0LmdldENvbnRhY3RJZCgpKTsKICAgICAgICAgIC8vIEJlY29tZSBtYXN0ZXIgdG8gc2VuZCBsb2dzLCBzaW5jZSB3ZSBuZWVkIGxvZ3MgZnJvbSBzb2Z0cGhvbmUgdGFiLgogICAgICAgICAgY29ubmVjdC5iZWNvbWVNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU0VORF9MT0dTKTsKICAgICAgICAgIC8vc3RhcnQgc3RhdHMgY29sbGVjdGlvbiBhbmQgcmVwb3J0aW5nIGpvYnMKICAgICAgICAgIHN0YXJ0U3RhdHNDb2xsZWN0aW9uSm9iKHJ0Y1Nlc3Npb24pOwogICAgICAgICAgc3RhcnRTdGF0c1JlcG9ydGluZ0pvYihjb250YWN0KTsKICAgICAgICAgIGZpcmVDb250YWN0QWNjZXB0ZWRFdmVudChjb250YWN0KTsKICAgICAgICB9OwoKICAgICAgICBzZXNzaW9uLm9uU2Vzc2lvbkNvbXBsZXRlZCA9IGZ1bmN0aW9uIChydGNTZXNzaW9uKSB7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlNvZnRwaG9uZSBTZXNzaW9uIENvbXBsZXRlZCIsIGNvbnRhY3QuZ2V0Q29udGFjdElkKCkpOwoKICAgICAgICAgIGRlbGV0ZSBydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgICBkZWxldGUgY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgICAvLyBTdG9wIGFsbCBqb2JzIGFuZCBwZXJmb3JtIG9uZSBsYXN0IGpvYi4KICAgICAgICAgIHN0b3BKb2JzQW5kUmVwb3J0KGNvbnRhY3QsIHJ0Y1Nlc3Npb24uc2Vzc2lvblJlcG9ydCk7CgogICAgICAgICAgLy8gQ2xlYW51cCB0aGUgY2FjaGVkIHN0cmVhbXMKICAgICAgICAgIGRlbGV0ZUxvY2FsTWVkaWFTdHJlYW0oYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICAgIH07CgogICAgICAgIHNlc3Npb24ub25Mb2NhbFN0cmVhbUFkZGVkID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24sIHN0cmVhbSkgewogICAgICAgICAgLy8gQ2FjaGUgdGhlIHN0cmVhbXMgZm9yIG11dGUvdW5tdXRlCiAgICAgICAgICBsb2NhbE1lZGlhU3RyZWFtW2FnZW50Q29ubmVjdGlvbklkXSA9IHsKICAgICAgICAgICAgc3RyZWFtOiBzdHJlYW0KICAgICAgICAgIH07CiAgICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgICAgIGV2ZW50OiBjb25uZWN0LkFnZW50RXZlbnRzLkxPQ0FMX01FRElBX1NUUkVBTV9DUkVBVEVELAogICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgY29ubmVjdGlvbklkOiBhZ2VudENvbm5lY3Rpb25JZAogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBzZXNzaW9uLnJlbW90ZUF1ZGlvRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZW1vdGUtYXVkaW8nKTsKICAgICAgICBpZiAocnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5KSB7CiAgICAgICAgICBzZXNzaW9uLmNvbm5lY3QocnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5LmdldChjYWxsQ29uZmlnLmljZVNlcnZlcnMpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2Vzc2lvbi5jb25uZWN0KCk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIHZhciBvbkluaXRDb250YWN0ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgdmFyIGFnZW50Q29ubmVjdGlvbklkID0gY29udGFjdC5nZXRBZ2VudENvbm5lY3Rpb24oKS5jb25uZWN0aW9uSWQ7CiAgICAgIGxvZ2dlci5pbmZvKCJDb250YWN0IGRldGVjdGVkOiIsICJjb250YWN0SWQgIiArIGNvbnRhY3QuZ2V0Q29udGFjdElkKCksICJhZ2VudCBjb25uZWN0aW9uSWQgIiArIGFnZW50Q29ubmVjdGlvbklkKTsKCiAgICAgIGlmICghY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF0pIHsKICAgICAgICBjb250YWN0Lm9uUmVmcmVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBvblJlZnJlc2hDb250YWN0KGNvbnRhY3QsIGFnZW50Q29ubmVjdGlvbklkKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKCiAgICBjb25uZWN0LmNvbnRhY3Qob25Jbml0Q29udGFjdCk7CgogICAgLy8gQ29udGFjdCBhbHJlYWR5IGluIGNvbm5lY3Rpbmcgc3RhdGUgc2NlbmFyaW8gLSBJbiB0aGlzIGNhc2UgY29udGFjdCBJTklUIGlzIG1pc3NlZCBoZW5jZSB0aGUgT25SZWZyZXNoIGNhbGxiYWNrIGlzIG1pc3NlZC4gCiAgICBuZXcgY29ubmVjdC5BZ2VudCgpLmdldENvbnRhY3RzKCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICB2YXIgYWdlbnRDb25uZWN0aW9uSWQgPSBjb250YWN0LmdldEFnZW50Q29ubmVjdGlvbigpLmNvbm5lY3Rpb25JZDsKICAgICAgbG9nZ2VyLmluZm8oIkNvbnRhY3QgZXhpc3QgaW4gdGhlIHNuYXBzaG90LiBSZWluaXRpYXRlIHRoZSBDb250YWN0IGFuZCBSVEMgc2Vzc2lvbiBjcmVhdGlvbiBmb3IgY29udGFjdElkIiArIGNvbnRhY3QuZ2V0Q29udGFjdElkKCksICJhZ2VudCBjb25uZWN0aW9uSWQgIiArIGFnZW50Q29ubmVjdGlvbklkKTsKICAgICAgb25Jbml0Q29udGFjdChjb250YWN0KTsKICAgICAgb25SZWZyZXNoQ29udGFjdChjb250YWN0LCBhZ2VudENvbm5lY3Rpb25JZCk7CiAgICB9KTsKICB9OwoKICB2YXIgZmlyZUNvbnRhY3RBY2NlcHRlZEV2ZW50ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIHZhciBjb25kdWl0ID0gY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCk7CiAgICB2YXIgYWdlbnRDb25uZWN0aW9uID0gY29udGFjdC5nZXRBZ2VudENvbm5lY3Rpb24oKTsKICAgIGlmICghYWdlbnRDb25uZWN0aW9uKSB7CiAgICAgIGxvZ2dlci5pbmZvKCJOb3QgYWJsZSB0byByZXRyaWV2ZSB0aGUgYXV0by1hY2NlcHQgc2V0dGluZyBmcm9tIG51bGwgQWdlbnRDb25uZWN0aW9uLCBpZ25vcmluZyBldmVudCBwdWJsaXNoLi4iKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHNvZnRwaG9uZU1lZGlhSW5mbyA9IGFnZW50Q29ubmVjdGlvbi5nZXRTb2Z0cGhvbmVNZWRpYUluZm8oKTsKICAgIGlmICghc29mdHBob25lTWVkaWFJbmZvKSB7CiAgICAgIGxvZ2dlci5pbmZvKCJOb3QgYWJsZSB0byByZXRyaWV2ZSB0aGUgYXV0by1hY2NlcHQgc2V0dGluZyBmcm9tIG51bGwgU29mdHBob25lTWVkaWFJbmZvLCBpZ25vcmluZyBldmVudCBwdWJsaXNoLi4iKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHNvZnRwaG9uZU1lZGlhSW5mby5hdXRvQWNjZXB0ID09PSB0cnVlKSB7CiAgICAgIGxvZ2dlci5pbmZvKCJBdXRvLWFjY2VwdCBpcyBlbmFibGVkLCBzZW5kaW5nIG91dCBBY2NlcHRlZCBldmVudCB0byBzdG9wIHJpbmd0b25lLi4iKTsKICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29udGFjdEV2ZW50cy5BQ0NFUFRFRAogICAgICB9KTsKICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgZXZlbnQ6IGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5BQ0NFUFRFRCwgY29udGFjdC5jb250YWN0SWQpCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgbG9nZ2VyLmluZm8oIkF1dG8tYWNjZXB0IGlzIGRpc2FibGVkLCByaW5ndG9uZSB3aWxsIGJlIHN0b3BwZWQgYnkgdXNlciBhY3Rpb24uIik7CiAgICB9CiAgfTsKCiAgLy8gQmluZCBldmVudHMgZm9yIG11dGUKICB2YXIgaGFuZGxlU29mdFBob25lTXV0ZVRvZ2dsZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuTVVURSwgbXV0ZVRvZ2dsZSk7CiAgfTsKCiAgLy8gTWFrZSBzdXJlIG9uY2Ugd2UgZGlzY29ubmVjdGVkIHdlIGdldCB0aGUgbXV0ZSBzdGF0ZSBiYWNrIHRvIG5vcm1hbAogIHZhciBkZWxldGVMb2NhbE1lZGlhU3RyZWFtID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25JZCkgewogICAgZGVsZXRlIGxvY2FsTWVkaWFTdHJlYW1bY29ubmVjdGlvbklkXTsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQWdlbnRFdmVudHMuTVVURV9UT0dHTEUsCiAgICAgIGRhdGE6IHsgbXV0ZWQ6IGZhbHNlIH0KICAgIH0pOwogIH07CgogIC8vIENoZWNrIGZvciB0aGUgbG9jYWwgc3RyZWFtcyBpZiBleGlzdHMgIC0gIHJldmVydCBpdAogIC8vIEFuZCBpbmZvcm0gb3RoZXIgY2xpZW50cyBhYm91dCB0aGUgY2hhbmdlIAogIHZhciBtdXRlVG9nZ2xlID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgIHZhciBzdGF0dXM7CiAgICBpZiAoY29ubmVjdC5rZXlzKGxvY2FsTWVkaWFTdHJlYW0pLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKGRhdGEgJiYgZGF0YS5tdXRlICE9PSB1bmRlZmluZWQpIHsKICAgICAgc3RhdHVzID0gZGF0YS5tdXRlOwogICAgfQoKICAgIGZvciAodmFyIGNvbm5lY3Rpb25JZCBpbiBsb2NhbE1lZGlhU3RyZWFtKSB7CiAgICAgIGlmIChsb2NhbE1lZGlhU3RyZWFtLmhhc093blByb3BlcnR5KGNvbm5lY3Rpb25JZCkpIHsKICAgICAgICB2YXIgbG9jYWxNZWRpYSA9IGxvY2FsTWVkaWFTdHJlYW1bY29ubmVjdGlvbklkXS5zdHJlYW07CiAgICAgICAgaWYgKGxvY2FsTWVkaWEpIHsKICAgICAgICAgIHZhciBhdWRpb1RyYWNrcyA9IGxvY2FsTWVkaWEuZ2V0QXVkaW9UcmFja3MoKVswXTsKICAgICAgICAgIGlmIChzdGF0dXMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBhdWRpb1RyYWNrcy5lbmFibGVkID0gIXN0YXR1czsKICAgICAgICAgICAgbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLm11dGVkID0gc3RhdHVzOwoKICAgICAgICAgICAgaWYgKHN0YXR1cykgewogICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJBZ2VudCBoYXMgbXV0ZWQgdGhlIGNvbnRhY3QsIGNvbm5lY3Rpb25JZCAtICAiICsgY29ubmVjdGlvbklkKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQWdlbnQgaGFzIHVubXV0ZWQgdGhlIGNvbnRhY3QsIGNvbm5lY3Rpb25JZCAtICIgKyBjb25uZWN0aW9uSWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdHVzID0gbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLm11dGVkIHx8IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQWdlbnRFdmVudHMuTVVURV9UT0dHTEUsCiAgICAgIGRhdGE6IHsgbXV0ZWQ6IHN0YXR1cyB9CiAgICB9KTsKICB9OwoKICB2YXIgcHVibGlzaFNvZnRwaG9uZUZhaWx1cmVMb2dzID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24sIHJlYXNvbikgewogICAgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuSUNFX0NPTExFQ1RJT05fVElNRU9VVCkgewogICAgICB2YXIgZW5kUG9pbnRVcmwgPSAiXG4iOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJ0Y1Nlc3Npb24uX2ljZVNlcnZlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJ0Y1Nlc3Npb24uX2ljZVNlcnZlcnNbaV0udXJscy5sZW5ndGg7IGorKykgewogICAgICAgICAgZW5kUG9pbnRVcmwgPSBlbmRQb2ludFVybCArIHJ0Y1Nlc3Npb24uX2ljZVNlcnZlcnNbaV0udXJsc1tqXSArICJcbiI7CiAgICAgICAgfQogICAgICB9CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLklDRV9DT0xMRUNUSU9OX1RJTUVPVVQsICJJY2UgY29sbGVjdGlvbiB0aW1lZG91dC4gIiwgZW5kUG9pbnRVcmwpOwogICAgfSBlbHNlIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLlVTRVJfQlVTWSkgewogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5VU0VSX0JVU1lfRVJST1IsCiAgICAgICAgIlNvZnRwaG9uZSBjYWxsIFVzZXJCdXN5IGVycm9yLiAiLAogICAgICAgICIiKTsKICAgIH0gZWxzZSBpZiAocmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5TSUdOQUxMSU5HX0hBTkRTSEFLRV9GQUlMVVJFKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLlNJR05BTExJTkdfSEFORFNIQUtFX0ZBSUxVUkUsCiAgICAgICAgIkhhbmRzaGFraW5nIHdpdGggU2lnbmFsbGluZyBTZXJ2ZXIgIiArIHJ0Y1Nlc3Npb24uX3NpZ25hbGluZ1VyaSArICIgZmFpbGVkLiAiLAogICAgICAgIHJ0Y1Nlc3Npb24uX3NpZ25hbGluZ1VyaSk7CiAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuR1VNX1RJTUVPVVRfRkFJTFVSRSB8fCByZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLkdVTV9PVEhFUl9GQUlMVVJFKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLk1JQ1JPUEhPTkVfTk9UX1NIQVJFRCwKICAgICAgICAiWW91ciBtaWNyb3Bob25lIGlzIG5vdCBlbmFibGVkIGluIHlvdXIgYnJvd3Nlci4gIiwKICAgICAgICAiIik7CiAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuU0lHTkFMTElOR19DT05ORUNUSU9OX0ZBSUxVUkUpIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuU0lHTkFMTElOR19DT05ORUNUSU9OX0ZBSUxVUkUsCiAgICAgICAgIlVSTCAiICsgcnRjU2Vzc2lvbi5fc2lnbmFsaW5nVXJpICsgIiBjYW5ub3QgYmUgcmVhY2hlZC4gIiwKICAgICAgICBydGNTZXNzaW9uLl9zaWduYWxpbmdVcmkpOwogICAgfSBlbHNlIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLkNBTExfTk9UX0ZPVU5EKSB7CiAgICAgIC8vIE5vIG5lZWQgdG8gcHVibGlzaCBhbnkgc29mdHBob25lIGVycm9yIGZvciB0aGlzIGNhc2UuIENDUCBVWCB3aWxsIGhhbmRsZSB0aGlzIGNhc2UuCiAgICAgIGxvZ2dlci5lcnJvcigiU29mdHBob25lIGNhbGwgZmFpbGVkIGR1ZSB0byBDYWxsTm90Rm91bmRFeGNlcHRpb24uIik7CiAgICB9IGVsc2UgewogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5XRUJSVENfRVJST1IsCiAgICAgICAgIndlYnJ0YyBzeXN0ZW0gZXJyb3IuICIsCiAgICAgICAgIiIpOwogICAgfQogIH07CgogIC8qKiBQYXJzZSB0aGUgSlNPTiBlbmNvZGVkIHdlYiBjYWxsIGNvbmZpZyBpbnRvIHRoZSBkYXRhIGl0IHJlcHJlc2VudHMuICovCiAgdmFyIHBhcnNlQ2FsbENvbmZpZyA9IGZ1bmN0aW9uIChzZXJpYWxpemVkQ29uZmlnKSB7CiAgICAvLyBPdXIgdW5kZXJzY29yZSBpcyB0b28gb2xkIGZvciB1bmVzY2FwZQogICAgLy8gaHR0cHM6Ly9pc3N1ZXMuYW1hem9uLmNvbS9pc3N1ZXMvQ1NXRi0xNDY3CiAgICB2YXIgZGVjb2RlZEpTT04gPSBzZXJpYWxpemVkQ29uZmlnLnJlcGxhY2UoLyZxdW90Oy9nLCAnIicpOwogICAgcmV0dXJuIEpTT04ucGFyc2UoZGVjb2RlZEpTT04pOwogIH07CgogIHZhciBmZXRjaFVzZXJNZWRpYSA9IGZ1bmN0aW9uIChjYWxsYmFja3NJbikgewogICAgdmFyIGNhbGxiYWNrcyA9IGNhbGxiYWNrc0luIHx8IHt9OwogICAgY2FsbGJhY2tzLnN1Y2Nlc3MgPSBjYWxsYmFja3Muc3VjY2VzcyB8fCBmdW5jdGlvbiAoKSB7IH07CiAgICBjYWxsYmFja3MuZmFpbHVyZSA9IGNhbGxiYWNrcy5mYWlsdXJlIHx8IGZ1bmN0aW9uICgpIHsgfTsKCiAgICB2YXIgQ09OU1RSQUlOVCA9IHsKICAgICAgYXVkaW86IHRydWUKICAgIH07CgogICAgdmFyIHByb21pc2UgPSBudWxsOwoKICAgIGlmICh0eXBlb2YgUHJvbWlzZSAhPT0gImZ1bmN0aW9uIikgewogICAgICBjYWxsYmFja3MuZmFpbHVyZShTb2Z0cGhvbmVFcnJvclR5cGVzLlVOU1VQUE9SVEVEX0JST1dTRVIpOwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKHR5cGVvZiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzID09PSAib2JqZWN0IiAmJiB0eXBlb2YgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcHJvbWlzZSA9IG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKENPTlNUUkFJTlQpOwoKICAgIH0gZWxzZSBpZiAodHlwZW9mIG5hdmlnYXRvci53ZWJraXRHZXRVc2VyTWVkaWEgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBuYXZpZ2F0b3Iud2Via2l0R2V0VXNlck1lZGlhKENPTlNUUkFJTlQsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgIH0pOwoKICAgIH0gZWxzZSB7CiAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKFNvZnRwaG9uZUVycm9yVHlwZXMuVU5TVVBQT1JURURfQlJPV1NFUik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKHN0cmVhbSkgewogICAgICB2YXIgYXVkaW9UcmFja3MgPSBzdHJlYW0uZ2V0QXVkaW9UcmFja3MoKTsKICAgICAgaWYgKGF1ZGlvVHJhY2tzICYmIGF1ZGlvVHJhY2tzLmxlbmd0aCA+IDApIHsKICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhzdHJlYW0pOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKFNvZnRwaG9uZUVycm9yVHlwZXMuTUlDUk9QSE9ORV9OT1RfU0hBUkVEKTsKICAgICAgfQogICAgfSwgZnVuY3Rpb24gKGVycikgewogICAgICBjYWxsYmFja3MuZmFpbHVyZShTb2Z0cGhvbmVFcnJvclR5cGVzLk1JQ1JPUEhPTkVfTk9UX1NIQVJFRCk7CiAgICB9KTsKICAgIHJldHVybiBwcm9taXNlOwogIH07CgogIHZhciBwdWJsaXNoRXJyb3IgPSBmdW5jdGlvbiAoZXJyb3JUeXBlLCBtZXNzYWdlLCBlbmRQb2ludFVybCkgewogICAgbG9nZ2VyLmVycm9yKCJTb2Z0cGhvbmUgZXJyb3Igb2NjdXJyZWQgOiAiLCBlcnJvclR5cGUsCiAgICAgIG1lc3NhZ2UgfHwgIiIpOwoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQWdlbnRFdmVudHMuU09GVFBIT05FX0VSUk9SLAogICAgICBkYXRhOiBuZXcgY29ubmVjdC5Tb2Z0cGhvbmVFcnJvcihlcnJvclR5cGUsIG1lc3NhZ2UsIGVuZFBvaW50VXJsKQogICAgfSk7CiAgfTsKCiAgdmFyIHB1Ymxpc2hTZXNzaW9uRmFpbHVyZVRlbGVtZXRyeUV2ZW50ID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgcmVhc29uKSB7CiAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlNvZnRwaG9uZSBTZXNzaW9uIEZhaWxlZCIsIGNvbnRhY3RJZCwgewogICAgICBmYWlsZWRSZWFzb246IHJlYXNvbgogICAgfSk7CiAgfTsKCiAgdmFyIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGNvbnRhY3RJZCwgZGF0YSkgewogICAgaWYgKGNvbnRhY3RJZCkgewogICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgIG5hbWU6IGV2ZW50TmFtZSwKICAgICAgICBjb250YWN0SWQ6IGNvbnRhY3RJZCwKICAgICAgICBkYXRhOiBkYXRhCiAgICAgIH0pOwogICAgfQogIH07CgogIC8vIFB1Ymxpc2ggdGhlIGNvbnRhY3QgYW5kIGFnZW50IGluZm9ybWF0aW9uIGluIGEgbXVsdGlwbGUgc2Vzc2lvbnMgc2NlbmFyaW9zCiAgdmFyIHB1Ymxpc2hNdWx0aXBsZVNlc3Npb25zRXZlbnQgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBjb250YWN0SWQsIGFnZW50Q29ubmVjdGlvbklkKSB7CiAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoZXZlbnROYW1lLCBjb250YWN0SWQsIFt7CiAgICAgIG5hbWU6ICJBZ2VudENvbm5lY3Rpb25JZCIsCiAgICAgIHZhbHVlOiBhZ2VudENvbm5lY3Rpb25JZAogICAgfV0pOwogICAgbG9nZ2VyLmluZm8oIlB1Ymxpc2ggbXVsdGlwbGUgc2Vzc2lvbiBlcnJvciBtZXRyaWNzIiwgZXZlbnROYW1lLCAiY29udGFjdElkICIgKyBjb250YWN0SWQsICJhZ2VudCBjb25uZWN0aW9uSWQgIiArIGFnZW50Q29ubmVjdGlvbklkKTsKICB9OwoKICB2YXIgaXNCcm93c2VyU29mdFBob25lU3VwcG9ydGVkID0gZnVuY3Rpb24gKCkgewogICAgLy8gSW4gT3BlcmEsIHRoZSB0cnVlIHZlcnNpb24gaXMgYWZ0ZXIgIk9wZXJhIiBvciBhZnRlciAiVmVyc2lvbiIKICAgIGlmIChjb25uZWN0LmlzT3BlcmFCcm93c2VyKCkgJiYgY29ubmVjdC5nZXRPcGVyYUJyb3dzZXJWZXJzaW9uKCkgPiAxNykgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8vIEluIENocm9tZSwgdGhlIHRydWUgdmVyc2lvbiBpcyBhZnRlciAiQ2hyb21lIgogICAgZWxzZSBpZiAoY29ubmVjdC5pc0Nocm9tZUJyb3dzZXIoKSAmJiBjb25uZWN0LmdldENocm9tZUJyb3dzZXJWZXJzaW9uKCkgPiAyMikgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8vIEluIEZpcmVmb3gsIHRoZSB0cnVlIHZlcnNpb24gaXMgYWZ0ZXIgIkZpcmVmb3giCiAgICBlbHNlIGlmIChjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIoKSAmJiBjb25uZWN0LmdldEZpcmVmb3hCcm93c2VyVmVyc2lvbigpID4gMjEpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfTsKCiAgdmFyIHNlbmRTb2Z0cGhvbmVNZXRyaWNzID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIHZhciBzdHJlYW1TdGF0cyA9IHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlci5zbGljZSgpOwogICAgdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyID0gW107CiAgICBpZiAoc3RyZWFtU3RhdHMubGVuZ3RoID4gMCkgewogICAgICBjb250YWN0LnNlbmRTb2Z0cGhvbmVNZXRyaWNzKHN0cmVhbVN0YXRzLCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKCkgewogICAgICAgICAgbG9nZ2VyLmluZm8oInNlbmRTb2Z0cGhvbmVNZXRyaWNzIHN1Y2Nlc3MiICsgSlNPTi5zdHJpbmdpZnkoc3RyZWFtU3RhdHMpKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBsb2dnZXIuZXJyb3IoInNlbmRTb2Z0cGhvbmVNZXRyaWNzIGZhaWxlZC4iKQogICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH07CgogIHZhciBzZW5kU29mdHBob25lUmVwb3J0ID0gZnVuY3Rpb24gKGNvbnRhY3QsIHJlcG9ydCwgdXNlckF1ZGlvU3RhdHMsIHJlbW90ZUF1ZGlvU3RhdHMpIHsKICAgIHJlcG9ydC5zdHJlYW1TdGF0cyA9IFthZGRTdHJlYW1UeXBlVG9TdGF0cyh1c2VyQXVkaW9TdGF0cywgQVVESU9fSU5QVVQpLAogICAgYWRkU3RyZWFtVHlwZVRvU3RhdHMocmVtb3RlQXVkaW9TdGF0cywgQVVESU9fT1VUUFVUKV07CiAgICB2YXIgY2FsbFJlcG9ydCA9IHsKICAgICAgY2FsbFN0YXJ0VGltZTogcmVwb3J0LnNlc3Npb25TdGFydFRpbWUsCiAgICAgIGNhbGxFbmRUaW1lOiByZXBvcnQuc2Vzc2lvbkVuZFRpbWUsCiAgICAgIGd1bVRpbWVNaWxsaXM6IHJlcG9ydC5ndW1UaW1lTWlsbGlzLAogICAgICBpbml0aWFsaXphdGlvblRpbWVNaWxsaXM6IHJlcG9ydC5pbml0aWFsaXphdGlvblRpbWVNaWxsaXMsCiAgICAgIGljZUNvbGxlY3Rpb25UaW1lTWlsbGlzOiByZXBvcnQuaWNlQ29sbGVjdGlvblRpbWVNaWxsaXMsCiAgICAgIHNpZ25hbGxpbmdDb25uZWN0VGltZU1pbGxpczogcmVwb3J0LnNpZ25hbGxpbmdDb25uZWN0VGltZU1pbGxpcywKICAgICAgaGFuZHNoYWtpbmdUaW1lTWlsbGlzOiByZXBvcnQuaGFuZHNoYWtpbmdUaW1lTWlsbGlzLAogICAgICBwcmVUYWxraW5nVGltZU1pbGxpczogcmVwb3J0LnByZVRhbGtpbmdUaW1lTWlsbGlzLAogICAgICB0YWxraW5nVGltZU1pbGxpczogcmVwb3J0LnRhbGtpbmdUaW1lTWlsbGlzLAogICAgICBjbGVhbnVwVGltZU1pbGxpczogcmVwb3J0LmNsZWFudXBUaW1lTWlsbGlzLAogICAgICBpY2VDb2xsZWN0aW9uRmFpbHVyZTogcmVwb3J0LmljZUNvbGxlY3Rpb25GYWlsdXJlLAogICAgICBzaWduYWxsaW5nQ29ubmVjdGlvbkZhaWx1cmU6IHJlcG9ydC5zaWduYWxsaW5nQ29ubmVjdGlvbkZhaWx1cmUsCiAgICAgIGhhbmRzaGFraW5nRmFpbHVyZTogcmVwb3J0LmhhbmRzaGFraW5nRmFpbHVyZSwKICAgICAgZ3VtT3RoZXJGYWlsdXJlOiByZXBvcnQuZ3VtT3RoZXJGYWlsdXJlLAogICAgICBndW1UaW1lb3V0RmFpbHVyZTogcmVwb3J0Lmd1bVRpbWVvdXRGYWlsdXJlLAogICAgICBjcmVhdGVPZmZlckZhaWx1cmU6IHJlcG9ydC5jcmVhdGVPZmZlckZhaWx1cmUsCiAgICAgIHNldExvY2FsRGVzY3JpcHRpb25GYWlsdXJlOiByZXBvcnQuc2V0TG9jYWxEZXNjcmlwdGlvbkZhaWx1cmUsCiAgICAgIHVzZXJCdXN5RmFpbHVyZTogcmVwb3J0LnVzZXJCdXN5RmFpbHVyZSwKICAgICAgaW52YWxpZFJlbW90ZVNEUEZhaWx1cmU6IHJlcG9ydC5pbnZhbGlkUmVtb3RlU0RQRmFpbHVyZSwKICAgICAgbm9SZW1vdGVJY2VDYW5kaWRhdGVGYWlsdXJlOiByZXBvcnQubm9SZW1vdGVJY2VDYW5kaWRhdGVGYWlsdXJlLAogICAgICBzZXRSZW1vdGVEZXNjcmlwdGlvbkZhaWx1cmU6IHJlcG9ydC5zZXRSZW1vdGVEZXNjcmlwdGlvbkZhaWx1cmUsCiAgICAgIHNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3M6IHJlcG9ydC5zdHJlYW1TdGF0cwogICAgfTsKICAgIGNvbnRhY3Quc2VuZFNvZnRwaG9uZVJlcG9ydChjYWxsUmVwb3J0LCB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uICgpIHsKICAgICAgICBsb2dnZXIuaW5mbygic2VuZFNvZnRwaG9uZVJlcG9ydCBzdWNjZXNzIiArIEpTT04uc3RyaW5naWZ5KGNhbGxSZXBvcnQpKTsKICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBsb2dnZXIuZXJyb3IoInNlbmRTb2Z0cGhvbmVSZXBvcnQgZmFpbGVkLiIpCiAgICAgICAgICAud2l0aE9iamVjdChkYXRhKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgdmFyIHN0YXJ0U3RhdHNDb2xsZWN0aW9uSm9iID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24pIHsKICAgIHJ0cFN0YXRzSm9iID0gd2luZG93LnNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgcnRjU2Vzc2lvbi5nZXRVc2VyQXVkaW9TdGF0cygpLnRoZW4oZnVuY3Rpb24gKHN0YXRzKSB7CiAgICAgICAgdmFyIHByZXZpb3VzVXNlclN0YXRzID0gYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzOwogICAgICAgIGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cyA9IHN0YXRzOwogICAgICAgIHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlci5wdXNoKGdldFRpbWVTZXJpZXNTdGF0cyhhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHMsIHByZXZpb3VzVXNlclN0YXRzLCBBVURJT19JTlBVVCkpOwogICAgICB9LCBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICBsb2dnZXIuZGVidWcoIkZhaWxlZCB0byBnZXQgdXNlciBhdWRpbyBzdGF0cy4iLCBlcnJvcik7CiAgICAgIH0pOwogICAgICBydGNTZXNzaW9uLmdldFJlbW90ZUF1ZGlvU3RhdHMoKS50aGVuKGZ1bmN0aW9uIChzdGF0cykgewogICAgICAgIHZhciBwcmV2aW91c1JlbW90ZVN0YXRzID0gYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHM7CiAgICAgICAgYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHMgPSBzdGF0czsKICAgICAgICB0aW1lU2VyaWVzU3RyZWFtU3RhdHNCdWZmZXIucHVzaChnZXRUaW1lU2VyaWVzU3RhdHMoYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHMsIHByZXZpb3VzUmVtb3RlU3RhdHMsIEFVRElPX09VVFBVVCkpOwogICAgICB9LCBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICBsb2dnZXIuZGVidWcoIkZhaWxlZCB0byBnZXQgcmVtb3RlIGF1ZGlvIHN0YXRzLiIsIGVycm9yKTsKICAgICAgfSk7CiAgICB9LCAxMDAwKTsKICB9OwoKICB2YXIgc3RhcnRTdGF0c1JlcG9ydGluZ0pvYiA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICByZXBvcnRTdGF0c0pvYiA9IHdpbmRvdy5zZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgIHNlbmRTb2Z0cGhvbmVNZXRyaWNzKGNvbnRhY3QpOwogICAgfSwgc3RhdHNSZXBvcnRpbmdKb2JJbnRlcnZhbE1zKTsKICB9OwoKICB2YXIgaW5pdGlhbGl6ZVBhcmFtcyA9IGZ1bmN0aW9uICgpIHsKICAgIGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cyA9IG51bGw7CiAgICBhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cyA9IG51bGw7CiAgICB0aW1lU2VyaWVzU3RyZWFtU3RhdHNCdWZmZXIgPSBbXTsKICAgIHJ0cFN0YXRzSm9iID0gbnVsbDsKICAgIHJlcG9ydFN0YXRzSm9iID0gbnVsbDsKICB9OwoKICB2YXIgZ2V0VGltZVNlcmllc1N0YXRzID0gZnVuY3Rpb24gKGN1cnJlbnRTdGF0cywgcHJldmlvdXNTdGF0cywgc3RyZWFtVHlwZSkgewogICAgaWYgKHByZXZpb3VzU3RhdHMgJiYgY3VycmVudFN0YXRzKSB7CiAgICAgIHZhciBwYWNrZXRzTG9zdCA9IGN1cnJlbnRTdGF0cy5wYWNrZXRzTG9zdCA+IHByZXZpb3VzU3RhdHMucGFja2V0c0xvc3QgPyBjdXJyZW50U3RhdHMucGFja2V0c0xvc3QgLSBwcmV2aW91c1N0YXRzLnBhY2tldHNMb3N0IDogMDsKICAgICAgdmFyIHBhY2tldHNDb3VudCA9IGN1cnJlbnRTdGF0cy5wYWNrZXRzQ291bnQgPiBwcmV2aW91c1N0YXRzLnBhY2tldHNDb3VudCA/IGN1cnJlbnRTdGF0cy5wYWNrZXRzQ291bnQgLSBwcmV2aW91c1N0YXRzLnBhY2tldHNDb3VudCA6IDA7CiAgICAgIHJldHVybiBuZXcgUlRQU3RyZWFtU3RhdHMoY3VycmVudFN0YXRzLnRpbWVzdGFtcCwKICAgICAgICBwYWNrZXRzTG9zdCwKICAgICAgICBwYWNrZXRzQ291bnQsCiAgICAgICAgc3RyZWFtVHlwZSwKICAgICAgICBjdXJyZW50U3RhdHMuYXVkaW9MZXZlbCwKICAgICAgICBjdXJyZW50U3RhdHMuamJNaWxsaXNlY29uZHMsCiAgICAgICAgY3VycmVudFN0YXRzLnJ0dE1pbGxpc2Vjb25kcyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmV3IFJUUFN0cmVhbVN0YXRzKGN1cnJlbnRTdGF0cy50aW1lc3RhbXAsCiAgICAgICAgY3VycmVudFN0YXRzLnBhY2tldHNMb3N0LAogICAgICAgIGN1cnJlbnRTdGF0cy5wYWNrZXRzQ291bnQsCiAgICAgICAgc3RyZWFtVHlwZSwKICAgICAgICBjdXJyZW50U3RhdHMuYXVkaW9MZXZlbCwKICAgICAgICBjdXJyZW50U3RhdHMuamJNaWxsaXNlY29uZHMsCiAgICAgICAgY3VycmVudFN0YXRzLnJ0dE1pbGxpc2Vjb25kcyk7CiAgICB9CiAgfTsKCiAgdmFyIHN0b3BKb2IgPSBmdW5jdGlvbiAodGFzaykgewogICAgaWYgKHRhc2sgIT09IG51bGwpIHsKICAgICAgd2luZG93LmNsZWFySW50ZXJ2YWwodGFzayk7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9OwoKICB2YXIgc3RvcEpvYnNBbmRSZXBvcnQgPSBmdW5jdGlvbiAoY29udGFjdCwgc2Vzc2lvblJlcG9ydCkgewogICAgcnRwU3RhdHNKb2IgPSBzdG9wSm9iKHJ0cFN0YXRzSm9iKTsKICAgIHJlcG9ydFN0YXRzSm9iID0gc3RvcEpvYihyZXBvcnRTdGF0c0pvYik7CiAgICBzZW5kU29mdHBob25lUmVwb3J0KGNvbnRhY3QsIHNlc3Npb25SZXBvcnQsIGFkZFN0cmVhbVR5cGVUb1N0YXRzKGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cywgQVVESU9fSU5QVVQpLCBhZGRTdHJlYW1UeXBlVG9TdGF0cyhhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cywgQVVESU9fT1VUUFVUKSk7CiAgICBzZW5kU29mdHBob25lTWV0cmljcyhjb250YWN0KTsKICB9OwoKICAvKioKICAqICAgQWRkaW5nIHN0cmVhbXR5cGUgcGFyYW1ldGVyIG9uIHRvcCBvZiBSVENKUyBSVFN0YXRzIG9iamVjdC4KICAqLwogIHZhciBSVFBTdHJlYW1TdGF0cyA9IGZ1bmN0aW9uICh0aW1lc3RhbXAsIHBhY2tldHNMb3N0LCBwYWNrZXRzQ291bnQsIHN0cmVhbVR5cGUsIGF1ZGlvTGV2ZWwsIGppdHRlckJ1ZmZlck1pbGxpcywgcm91bmRUcmlwVGltZU1pbGxpcykgewogICAgdGhpcy5zb2Z0cGhvbmVTdHJlYW1UeXBlID0gc3RyZWFtVHlwZTsKICAgIHRoaXMudGltZXN0YW1wID0gdGltZXN0YW1wOwogICAgdGhpcy5wYWNrZXRzTG9zdCA9IHBhY2tldHNMb3N0OwogICAgdGhpcy5wYWNrZXRzQ291bnQgPSBwYWNrZXRzQ291bnQ7CiAgICB0aGlzLmF1ZGlvTGV2ZWwgPSBhdWRpb0xldmVsOwogICAgdGhpcy5qaXR0ZXJCdWZmZXJNaWxsaXMgPSBqaXR0ZXJCdWZmZXJNaWxsaXM7CiAgICB0aGlzLnJvdW5kVHJpcFRpbWVNaWxsaXMgPSByb3VuZFRyaXBUaW1lTWlsbGlzOwogIH07CgogIHZhciBhZGRTdHJlYW1UeXBlVG9TdGF0cyA9IGZ1bmN0aW9uIChzdGF0cywgc3RyZWFtVHlwZSkgewogICAgc3RhdHMgPSBzdGF0cyB8fCB7fTsKICAgIHJldHVybiBuZXcgUlRQU3RyZWFtU3RhdHMoc3RhdHMudGltZXN0YW1wLCBzdGF0cy5wYWNrZXRzTG9zdCwgc3RhdHMucGFja2V0c0NvdW50LCBzdHJlYW1UeXBlLCBzdGF0cy5hdWRpb0xldmVsKTsKICB9OwoKICB2YXIgU29mdHBob25lTG9nZ2VyID0gZnVuY3Rpb24gKGxvZ2dlcikgewogICAgdGhpcy5fb3JpZ2luYWxMb2dnZXIgPSBsb2dnZXI7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0aGlzLl90ZWUgPSBmdW5jdGlvbiAobGV2ZWwsIG1ldGhvZCkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIC8vIGNhbGwgdGhlIG9yaWdpbmFsIGxvZ2dlciBvYmplY3QgdG8gb3V0cHV0IHRvIGJyb3dzZXIKICAgICAgICAvL0Nvbm5lY3QgbG9nZ2VyIGZvbGxvd3MgJXMgZm9ybWF0IHRvIHByaW50IG9iamVjdHMgdG8gY29uc29sZS4KICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50c1swXSk7CiAgICAgICAgdmFyIGZvcm1hdCA9ICIiOwogICAgICAgIGFyZ3MuZm9yRWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBmb3JtYXQgPSBmb3JtYXQgKyAiICVzIjsKICAgICAgICB9KTsKICAgICAgICBtZXRob2QuYXBwbHkoc2VsZi5fb3JpZ2luYWxMb2dnZXIsIFtjb25uZWN0LkxvZ0NvbXBvbmVudC5TT0ZUUEhPTkUsIGZvcm1hdF0uY29uY2F0KGFyZ3MpKTsKICAgICAgfTsKICAgIH07CiAgfTsKCiAgU29mdHBob25lTG9nZ2VyLnByb3RvdHlwZS5kZWJ1ZyA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuX3RlZSgxLCB0aGlzLl9vcmlnaW5hbExvZ2dlci5kZWJ1ZykoYXJndW1lbnRzKTsKICB9OwogIFNvZnRwaG9uZUxvZ2dlci5wcm90b3R5cGUuaW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuX3RlZSgyLCB0aGlzLl9vcmlnaW5hbExvZ2dlci5pbmZvKShhcmd1bWVudHMpOwogIH07CiAgU29mdHBob25lTG9nZ2VyLnByb3RvdHlwZS5sb2cgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLl90ZWUoMywgdGhpcy5fb3JpZ2luYWxMb2dnZXIubG9nKShhcmd1bWVudHMpOwogIH07CiAgU29mdHBob25lTG9nZ2VyLnByb3RvdHlwZS53YXJuID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5fdGVlKDQsIHRoaXMuX29yaWdpbmFsTG9nZ2VyLndhcm4pKGFyZ3VtZW50cyk7CiAgfTsKICBTb2Z0cGhvbmVMb2dnZXIucHJvdG90eXBlLmVycm9yID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5fdGVlKDUsIHRoaXMuX29yaWdpbmFsTG9nZ2VyLmVycm9yKShhcmd1bWVudHMpOwogIH07CgogIGNvbm5lY3QuU29mdHBob25lTWFuYWdlciA9IFNvZnRwaG9uZU1hbmFnZXI7Cn0pKCk7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICBjb25uZWN0LndvcmtlciA9IHt9OwoKICB2YXIgR0VUX0FHRU5UX1RJTUVPVVRfTVMgPSAzMDAwMDsKICB2YXIgR0VUX0FHRU5UX1JFQ09WRVJZX1RJTUVPVVRfTVMgPSA1MDAwOwogIHZhciBHRVRfQUdFTlRfU1VDQ0VTU19USU1FT1VUX01TID0gMTAwOwogIHZhciBMT0dfQlVGRkVSX0NBUF9TSVpFID0gNDAwOwoKICB2YXIgQ0hFQ0tfQVVUSF9UT0tFTl9JTlRFUlZBTF9NUyA9IDMwMDAwMDsgLy8gNSBtaW51dHMKICB2YXIgUkVGUkVTSF9BVVRIX1RPS0VOX0lOVEVSVkFMX01TID0gMTAwMDA7IC8vIDEwIHNlY29uZHMKICB2YXIgUkVGUkVTSF9BVVRIX1RPS0VOX01BWF9UUlkgPSA0OwoKICB2YXIgR0VUX0FHRU5UX0NPTkZJR1VSQVRJT05fSU5URVJWQUxfTVMgPSAzMDAwMDsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIHZhciBNYXN0ZXJUb3BpY0Nvb3JkaW5hdG9yID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy50b3BpY01hc3Rlck1hcCA9IHt9OwogIH07CgogIE1hc3RlclRvcGljQ29vcmRpbmF0b3IucHJvdG90eXBlLmdldE1hc3RlciA9IGZ1bmN0aW9uICh0b3BpYykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljLCAndG9waWMnKTsKICAgIHJldHVybiB0aGlzLnRvcGljTWFzdGVyTWFwW3RvcGljXSB8fCBudWxsOwogIH07CgogIE1hc3RlclRvcGljQ29vcmRpbmF0b3IucHJvdG90eXBlLnNldE1hc3RlciA9IGZ1bmN0aW9uICh0b3BpYywgaWQpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b3BpYywgJ3RvcGljJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoaWQsICdpZCcpOwogICAgdGhpcy50b3BpY01hc3Rlck1hcFt0b3BpY10gPSBpZDsKICB9OwoKICBNYXN0ZXJUb3BpY0Nvb3JkaW5hdG9yLnByb3RvdHlwZS5yZW1vdmVNYXN0ZXIgPSBmdW5jdGlvbiAoaWQpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChpZCwgJ2lkJyk7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgY29ubmVjdC5lbnRyaWVzKHRoaXMudG9waWNNYXN0ZXJNYXApLmZpbHRlcihmdW5jdGlvbiAoZW50cnkpIHsKICAgICAgcmV0dXJuIGVudHJ5LnZhbHVlID09PSBpZDsKICAgIH0pLmZvckVhY2goZnVuY3Rpb24gKGVudHJ5KSB7CiAgICAgIGRlbGV0ZSBzZWxmLnRvcGljTWFzdGVyTWFwW2VudHJ5LmtleV07CiAgICB9KTsKICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBXb3JrZXJDbGllbnQgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICovCiAgdmFyIFdvcmtlckNsaWVudCA9IGZ1bmN0aW9uIChjb25kdWl0KSB7CiAgICBjb25uZWN0LkNsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgIHRoaXMuY29uZHVpdCA9IGNvbmR1aXQ7CiAgfTsKICBXb3JrZXJDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShjb25uZWN0LkNsaWVudEJhc2UucHJvdG90eXBlKTsKICBXb3JrZXJDbGllbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gV29ya2VyQ2xpZW50OwoKICBXb3JrZXJDbGllbnQucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uIChtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcmVxdWVzdF9zdGFydCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgY29ubmVjdC5jb3JlLmdldENsaWVudCgpLl9jYWxsSW1wbChtZXRob2QsIHBhcmFtcywgewogICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIHNlbGYuX3JlY29yZEFQSUxhdGVuY3kobWV0aG9kLCByZXF1ZXN0X3N0YXJ0KTsKICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycm9yLCBkYXRhKSB7CiAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQsIGVycm9yKTsKICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvciwgZGF0YSk7CiAgICAgIH0sCiAgICAgIGF1dGhGYWlsdXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQpOwogICAgICAgIGNhbGxiYWNrcy5hdXRoRmFpbHVyZSgpOwogICAgICB9LAogICAgICBhY2Nlc3NEZW5pZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICBjYWxsYmFja3MuYWNjZXNzRGVuaWVkICYmIGNhbGxiYWNrcy5hY2Nlc3NEZW5pZWQoKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgV29ya2VyQ2xpZW50LnByb3RvdHlwZS5fcmVjb3JkQVBJTGF0ZW5jeSA9IGZ1bmN0aW9uIChtZXRob2QsIHJlcXVlc3Rfc3RhcnQsIGVycikgewogICAgdmFyIHJlcXVlc3RfZW5kID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICB2YXIgcmVxdWVzdF90aW1lID0gcmVxdWVzdF9lbmQgLSByZXF1ZXN0X3N0YXJ0OwogICAgdGhpcy5fc2VuZEFQSU1ldHJpY3MobWV0aG9kLCByZXF1ZXN0X3RpbWUsIGVycik7CiAgfTsKCiAgV29ya2VyQ2xpZW50LnByb3RvdHlwZS5fc2VuZEFQSU1ldHJpY3MgPSBmdW5jdGlvbiAobWV0aG9kLCB0aW1lLCBlcnIpIHsKICAgIHRoaXMuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BUElfTUVUUklDLCB7CiAgICAgIG5hbWU6IG1ldGhvZCwKICAgICAgdGltZTogdGltZSwKICAgICAgZGltZW5zaW9uczogWwogICAgICAgIHsKICAgICAgICAgIG5hbWU6ICJDYXRlZ29yeSIsCiAgICAgICAgICB2YWx1ZTogIkFQSSIKICAgICAgICB9CiAgICAgIF0sCiAgICAgIGVycm9yOiBlcnIKICAgIH0pOwogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBUaGUgb2JqZWN0IHJlc3BvbnNpYmxlIGZvciBwb2xsaW5nIGFuZCBwYXNzaW5nIGRhdGEgZG93bnN0cmVhbSB0byBhbGwKICAgKiBjb25zdW1lciBwb3J0cy4KICAgKi8KICB2YXIgQ2xpZW50RW5naW5lID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHRoaXMubXVsdGlwbGV4ZXIgPSBuZXcgY29ubmVjdC5TdHJlYW1NdWx0aXBsZXhlcigpOwogICAgdGhpcy5jb25kdWl0ID0gbmV3IGNvbm5lY3QuQ29uZHVpdCgiQW1hem9uQ29ubmVjdFNoYXJlZFdvcmtlciIsIG51bGwsIHRoaXMubXVsdGlwbGV4ZXIpOwogICAgdGhpcy5jbGllbnQgPSBuZXcgV29ya2VyQ2xpZW50KHRoaXMuY29uZHVpdCk7CiAgICB0aGlzLnRpbWVvdXQgPSBudWxsOwogICAgdGhpcy5hZ2VudCA9IG51bGw7CiAgICB0aGlzLm5leHRUb2tlbiA9IG51bGw7CiAgICB0aGlzLmluaXREYXRhID0ge307CiAgICB0aGlzLnBvcnRDb25kdWl0TWFwID0ge307CiAgICB0aGlzLm1hc3RlckNvb3JkID0gbmV3IE1hc3RlclRvcGljQ29vcmRpbmF0b3IoKTsKICAgIHRoaXMubG9nc0J1ZmZlciA9IFtdOwogICAgdGhpcy5zdXBwcmVzcyA9IGZhbHNlOwogICAgdGhpcy5mb3JjZU9mZmxpbmUgPSBmYWxzZTsKCiAgICB2YXIgd2ViU29ja2V0TWFuYWdlciA9IG51bGw7CgogICAgY29ubmVjdC5yb290TG9nZ2VyID0gbmV3IGNvbm5lY3QuRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIodGhpcy5jb25kdWl0KTsKCiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNFTkRfTE9HUywgZnVuY3Rpb24gKGxvZ3NUb1VwbG9hZCkgewogICAgICAvLyBBZGQgc29mdHBob25lIGxvZ3MgZG93bnN0cmVhbQogICAgICBjb25uZWN0LmdldExvZygpLnB1c2hMb2dzRG93bnN0cmVhbShsb2dzVG9VcGxvYWQpOwoKICAgICAgc2VsZi5sb2dzQnVmZmVyID0gc2VsZi5sb2dzQnVmZmVyLmNvbmNhdChsb2dzVG9VcGxvYWQpOwogICAgICAvL29ubHkgY2FsbCBBUEkgdG8gc2VuZCBsb2dzIGlmIGJ1ZmZlciByZWFjaGVkIGNhcAogICAgICBpZiAoc2VsZi5sb2dzQnVmZmVyLmxlbmd0aCA+IExPR19CVUZGRVJfQ0FQX1NJWkUpIHsKICAgICAgICBzZWxmLmhhbmRsZVNlbmRMb2dzUmVxdWVzdChzZWxmLmxvZ3NCdWZmZXIpOwogICAgICB9CiAgICB9KTsKCiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5TVVBQUkVTUywgZnVuY3Rpb24gKGRhdGEpewogICAgICBjb25uZWN0LmdldExvZygpLmRlYnVnKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIFNldHRpbmcgU3VwcHJlc3MgdG8gJXMiLCBkYXRhLnN1cHByZXNzKTsKICAgICAgc2VsZi5zdXBwcmVzcyA9IGRhdGEuc3VwcHJlc3MgfHwgZmFsc2U7CiAgICAgIC8vc2lnbmFsIG90aGVyIHdpbmRvd3MgdGhhdCBhIGZhaWxvdmVyIGhhcHBlbmVkCiAgICAgIGlmIChzZWxmLm1hc3RlckNvb3JkLmdldE1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUpKSB7CiAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GQUlMT1ZFUiwgewogICAgICAgICAgaXNQcmltYXJ5OiAhc2VsZi5zdXBwcmVzcwogICAgICAgIH0pOyAgICAgIAogICAgICB9CiAgICB9KTsKCiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GT1JDRV9PRkZMSU5FLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBjb25uZWN0LmdldExvZygpLmRlYnVnKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIFNldHRpbmcgRk9SQ0VfT0ZGTElORSB0byAlcyIsIGRhdGEub2ZmbGluZSk7CiAgICAgIHNlbGYuZm9yY2VPZmZsaW5lID0gZGF0YS5vZmZsaW5lIHx8IGZhbHNlOwogICAgfSk7CgogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGlmIChkYXRhLmF1dGhUb2tlbiAmJiBkYXRhLmF1dGhUb2tlbiAhPT0gc2VsZi5pbml0RGF0YS5hdXRoVG9rZW4pIHsKICAgICAgICBzZWxmLmluaXREYXRhID0gZGF0YTsKICAgICAgICBjb25uZWN0LmNvcmUuaW5pdChkYXRhKTsKICAgICAgICAvLyBpbml0IG9ubHkgb25jZS4KICAgICAgICBpZiAoIXdlYlNvY2tldE1hbmFnZXIpIHsKCiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkNyZWF0aW5nIGEgbmV3IFdlYnNvY2tldCBjb25uZWN0aW9uIGZvciBDQ1AiKTsKCiAgICAgICAgICBjb25uZWN0LldlYlNvY2tldE1hbmFnZXIuc2V0R2xvYmFsQ29uZmlnKHsKICAgICAgICAgICAgbG9nZ2VyQ29uZmlnOiB7IGxvZ2dlcjogY29ubmVjdC5nZXRMb2coKSB9CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyID0gY29ubmVjdC5XZWJTb2NrZXRNYW5hZ2VyLmNyZWF0ZSgpOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25Jbml0RmFpbHVyZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5JTklUX0ZBSUxVUkUpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkNvbm5lY3Rpb25PcGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9PUEVOLCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uQ29ubmVjdGlvbkNsb3NlKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9DTE9TRSwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkNvbm5lY3Rpb25HYWluKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuQWdlbnRFdmVudHMuV0VCU09DS0VUX0NPTk5FQ1RJT05fR0FJTkVEKTsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fR0FJTik7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uQ29ubmVjdGlvbkxvc3QoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkFnZW50RXZlbnRzLldFQlNPQ0tFVF9DT05ORUNUSU9OX0xPU1QsIHJlc3BvbnNlKTsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fTE9TVCwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vblN1YnNjcmlwdGlvblVwZGF0ZShmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNVQlNDUklQVElPTl9VUERBVEUsIHJlc3BvbnNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25TdWJzY3JpcHRpb25GYWlsdXJlKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSVBUSU9OX0ZBSUxVUkUsIHJlc3BvbnNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25BbGxNZXNzYWdlKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQUxMX01FU1NBR0UsIHJlc3BvbnNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHNlbGYuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU0VORCwgZnVuY3Rpb24gKG1lc3NhZ2UpIHsKICAgICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5zZW5kTWVzc2FnZShtZXNzYWdlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHNlbGYuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSUJFLCBmdW5jdGlvbiAodG9waWNzKSB7CiAgICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIuc3Vic2NyaWJlVG9waWNzKHRvcGljcyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLmluaXQoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmdldFdlYlNvY2tldFVybCkpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgaWYgKHJlc3BvbnNlICYmICFyZXNwb25zZS53ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkKSB7CiAgICAgICAgICAgICAgLy8gU3RhcnQgcG9sbGluZyBmb3IgYWdlbnQgZGF0YS4KICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIktpY2tpbmcgb2ZmIGFnZW50IHBvbGxpbmciKTsKICAgICAgICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudCgpOwoKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIktpY2tpbmcgb2ZmIGNvbmZpZyBwb2xsaW5nIik7CiAgICAgICAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnRDb25maWd1cmF0aW9uKHsgcmVwZWF0Rm9yZXZlcjogdHJ1ZSB9KTsKCiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJLaWNraW5nIG9mZiBhdXRoIHRva2VuIHBvbGxpbmciKTsKICAgICAgICAgICAgICBnbG9iYWwuc2V0SW50ZXJ2YWwoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmNoZWNrQXV0aFRva2VuKSwgQ0hFQ0tfQVVUSF9UT0tFTl9JTlRFUlZBTF9NUyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKCFjb25uZWN0LndlYlNvY2tldEluaXRGYWlsZWQpIHsKICAgICAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5JTklUX0ZBSUxVUkUpOwogICAgICAgICAgICAgICAgY29ubmVjdC53ZWJTb2NrZXRJbml0RmFpbGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIk5vdCBJbml0aWFsaXppbmcgYSBuZXcgV2Vic29ja2V0TWFuYWdlciBpbnN0YW5jZSwgc2luY2Ugb25lIGFscmVhZHkgZXhpc3RzIik7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFLCBmdW5jdGlvbiAoKSB7CiAgICAgIC8vdXBsb2FkIHBlbmRpbmcgbG9ncyBiZWZvcmUgdGVybWluYXRpbmcuCiAgICAgIHNlbGYuaGFuZGxlU2VuZExvZ3NSZXF1ZXN0KHNlbGYubG9nc0J1ZmZlcik7CiAgICAgIGNvbm5lY3QuY29yZS50ZXJtaW5hdGUoKTsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURUQpOwogICAgfSk7CiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNZTkNIUk9OSVpFLCBmdW5jdGlvbiAoKSB7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSk7CiAgICB9KTsKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oZGF0YS5ldmVudCwgZGF0YS5kYXRhKTsKICAgIH0pOwoKICAgIC8qKgogICAgICogQ2FsbGVkIHdoZW4gYSBjb25zdW1lciBwb3J0IGNvbm5lY3RzIHRvIHRoaXMgU2hhcmVkV29ya2VyLgogICAgICogTGV0J3MgYWRkIHRoZW0gdG8gb3VyIG11bHRpcGxleGVyLgogICAgICovCiAgICBnbG9iYWwub25jb25uZWN0ID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIHZhciBwb3J0ID0gZXZlbnQucG9ydHNbMF07CiAgICAgIHZhciBzdHJlYW0gPSBuZXcgY29ubmVjdC5Qb3J0U3RyZWFtKHBvcnQpOwogICAgICBzZWxmLm11bHRpcGxleGVyLmFkZFN0cmVhbShzdHJlYW0pOwogICAgICBwb3J0LnN0YXJ0KCk7CgogICAgICB2YXIgcG9ydENvbmR1aXQgPSBuZXcgY29ubmVjdC5Db25kdWl0KHN0cmVhbS5nZXRJZCgpLCBudWxsLCBzdHJlYW0pOwogICAgICBwb3J0Q29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSwgeyBpZDogc3RyZWFtLmdldElkKCkgfSk7CgogICAgICBzZWxmLnBvcnRDb25kdWl0TWFwW3N0cmVhbS5nZXRJZCgpXSA9IHBvcnRDb25kdWl0OwoKICAgICAgaWYgKHNlbGYuYWdlbnQgIT09IG51bGwpIHsKICAgICAgICBzZWxmLnVwZGF0ZUFnZW50KCk7CiAgICAgIH0KCiAgICAgIHBvcnRDb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BUElfUkVRVUVTVCwKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQVBJUmVxdWVzdCwgcG9ydENvbmR1aXQpKTsKICAgICAgcG9ydENvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVFVRVNULAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVNYXN0ZXJSZXF1ZXN0LCBwb3J0Q29uZHVpdCwgc3RyZWFtLmdldElkKCkpKTsKICAgICAgcG9ydENvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlJFTE9BRF9BR0VOVF9DT05GSUdVUkFUSU9OLAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5wb2xsRm9yQWdlbnRDb25maWd1cmF0aW9uKSk7CiAgICAgIHBvcnRDb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5DTE9TRSwgZnVuY3Rpb24gKCkgewogICAgICAgIHNlbGYubXVsdGlwbGV4ZXIucmVtb3ZlU3RyZWFtKHN0cmVhbSk7CiAgICAgICAgZGVsZXRlIHNlbGYucG9ydENvbmR1aXRNYXBbc3RyZWFtLmdldElkKCldOwogICAgICAgIHNlbGYubWFzdGVyQ29vcmQucmVtb3ZlTWFzdGVyKHN0cmVhbS5nZXRJZCgpKTsKICAgICAgfSk7CiAgICB9OwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvckFnZW50ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIG9uQXV0aEZhaWwgPSBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9BR0VOVF9TTkFQU0hPVCwgewogICAgICBuZXh0VG9rZW46IHNlbGYubmV4dFRva2VuLAogICAgICB0aW1lb3V0OiBHRVRfQUdFTlRfVElNRU9VVF9NUwogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZWxmLmFnZW50ID0gc2VsZi5hZ2VudCB8fCB7fTsKICAgICAgICAgICAgc2VsZi5hZ2VudC5zbmFwc2hvdCA9IGRhdGEuc25hcHNob3Q7CiAgICAgICAgICAgIHNlbGYuYWdlbnQuc25hcHNob3QubG9jYWxUaW1lc3RhbXAgPSBjb25uZWN0Lm5vdygpOwogICAgICAgICAgICBzZWxmLmFnZW50LnNuYXBzaG90LnNrZXcgPSBzZWxmLmFnZW50LnNuYXBzaG90LnNuYXBzaG90VGltZXN0YW1wIC0gc2VsZi5hZ2VudC5zbmFwc2hvdC5sb2NhbFRpbWVzdGFtcDsKICAgICAgICAgICAgc2VsZi5uZXh0VG9rZW4gPSBkYXRhLm5leHRUb2tlbjsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiR0VUX0FHRU5UX1NOQVBTSE9UIHN1Y2NlZWRlZC4iKS53aXRoT2JqZWN0KGRhdGEpOwogICAgICAgICAgICBzZWxmLnVwZGF0ZUFnZW50KCk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkxvbmcgcG9sbCBmYWlsZWQgdG8gdXBkYXRlIGFnZW50LiIpLndpdGhPYmplY3QoZGF0YSkud2l0aEV4Y2VwdGlvbihlKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5wb2xsRm9yQWdlbnQpLCBHRVRfQUdFTlRfU1VDQ0VTU19USU1FT1VUX01TKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBnZXQgYWdlbnQgZGF0YS4iKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5wb2xsRm9yQWdlbnQpLCBHRVRfQUdFTlRfUkVDT1ZFUllfVElNRU9VVF9NUyk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgb25BdXRoRmFpbCgpOwogICAgICAgIH0sCiAgICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQoKICAgICAgfSk7CgogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvckFnZW50Q29uZmlndXJhdGlvbiA9IGZ1bmN0aW9uIChwYXJhbXNJbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgdmFyIG9uQXV0aEZhaWwgPSBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9BR0VOVF9DT05GSUdVUkFUSU9OLCB7fSwgewogICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIHZhciBjb25maWd1cmF0aW9uID0gZGF0YS5jb25maWd1cmF0aW9uOwogICAgICAgIHNlbGYucG9sbEZvckFnZW50UGVybWlzc2lvbnMoY29uZmlndXJhdGlvbik7CiAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnRTdGF0ZXMoY29uZmlndXJhdGlvbik7CiAgICAgICAgc2VsZi5wb2xsRm9yRGlhbGFibGVDb3VudHJ5Q29kZXMoY29uZmlndXJhdGlvbik7CiAgICAgICAgc2VsZi5wb2xsRm9yUm91dGluZ1Byb2ZpbGVRdWV1ZXMoY29uZmlndXJhdGlvbik7CiAgICAgICAgaWYgKHBhcmFtcy5yZXBlYXRGb3JldmVyKSB7CiAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYucG9sbEZvckFnZW50Q29uZmlndXJhdGlvbiwgcGFyYW1zKSwKICAgICAgICAgICAgR0VUX0FHRU5UX0NPTkZJR1VSQVRJT05fSU5URVJWQUxfTVMpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggYWdlbnQgY29uZmlndXJhdGlvbiBkYXRhLiIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpZiAocGFyYW1zLnJlcGVhdEZvcmV2ZXIpIHsKICAgICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLnBvbGxGb3JBZ2VudENvbmZpZ3VyYXRpb24pLAogICAgICAgICAgICAgIEdFVF9BR0VOVF9DT05GSUdVUkFUSU9OX0lOVEVSVkFMX01TLCBwYXJhbXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgYXV0aEZhaWx1cmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICBvbkF1dGhGYWlsKCk7CiAgICAgIH0sCiAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvckFnZW50U3RhdGVzID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24sIHBhcmFtc0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICBwYXJhbXMubWF4UmVzdWx0cyA9IHBhcmFtcy5tYXhSZXN1bHRzIHx8IGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9BR0VOVF9TVEFURVMsIHsKICAgICAgbmV4dFRva2VuOiBwYXJhbXMubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCgogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnRTdGF0ZXMoY29uZmlndXJhdGlvbiwgewogICAgICAgICAgICAgIHN0YXRlczogKHBhcmFtcy5zdGF0ZXMgfHwgW10pLmNvbmNhdChkYXRhLnN0YXRlcyksCiAgICAgICAgICAgICAgbmV4dFRva2VuOiBkYXRhLm5leHRUb2tlbiwKICAgICAgICAgICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgICAgICAgICB9KTsKCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25maWd1cmF0aW9uLmFnZW50U3RhdGVzID0gKHBhcmFtcy5zdGF0ZXMgfHwgW10pLmNvbmNhdChkYXRhLnN0YXRlcyk7CiAgICAgICAgICAgIHNlbGYudXBkYXRlQWdlbnRDb25maWd1cmF0aW9uKGNvbmZpZ3VyYXRpb24pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIGFnZW50IHN0YXRlcyBsaXN0LiIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCksCiAgICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQogICAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JBZ2VudFBlcm1pc3Npb25zID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24sIHBhcmFtc0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICBwYXJhbXMubWF4UmVzdWx0cyA9IHBhcmFtcy5tYXhSZXN1bHRzIHx8IGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9BR0VOVF9QRVJNSVNTSU9OUywgewogICAgICBuZXh0VG9rZW46IHBhcmFtcy5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLm5leHRUb2tlbikgewogICAgICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudFBlcm1pc3Npb25zKGNvbmZpZ3VyYXRpb24sIHsKICAgICAgICAgICAgICBwZXJtaXNzaW9uczogKHBhcmFtcy5wZXJtaXNzaW9ucyB8fCBbXSkuY29uY2F0KGRhdGEucGVybWlzc2lvbnMpLAogICAgICAgICAgICAgIG5leHRUb2tlbjogZGF0YS5uZXh0VG9rZW4sCiAgICAgICAgICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgICAgICAgICAgfSk7CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uZmlndXJhdGlvbi5wZXJtaXNzaW9ucyA9IChwYXJhbXMucGVybWlzc2lvbnMgfHwgW10pLmNvbmNhdChkYXRhLnBlcm1pc3Npb25zKTsKICAgICAgICAgICAgc2VsZi51cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24oY29uZmlndXJhdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggYWdlbnQgcGVybWlzc2lvbnMgbGlzdC4iKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpLAogICAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKICAgICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yRGlhbGFibGVDb3VudHJ5Q29kZXMgPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgcGFyYW1zSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHBhcmFtcy5tYXhSZXN1bHRzID0gcGFyYW1zLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0RJQUxBQkxFX0NPVU5UUllfQ09ERVMsIHsKICAgICAgbmV4dFRva2VuOiBwYXJhbXMubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLm5leHRUb2tlbikgewogICAgICAgICAgICBzZWxmLnBvbGxGb3JEaWFsYWJsZUNvdW50cnlDb2Rlcyhjb25maWd1cmF0aW9uLCB7CiAgICAgICAgICAgICAgY291bnRyeUNvZGVzOiAocGFyYW1zLmNvdW50cnlDb2RlcyB8fCBbXSkuY29uY2F0KGRhdGEuY291bnRyeUNvZGVzKSwKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24uZGlhbGFibGVDb3VudHJpZXMgPSAocGFyYW1zLmNvdW50cnlDb2RlcyB8fCBbXSkuY29uY2F0KGRhdGEuY291bnRyeUNvZGVzKTsKICAgICAgICAgICAgc2VsZi51cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24oY29uZmlndXJhdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggZGlhbGFibGUgY291bnRyeSBjb2RlcyBsaXN0LiIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCksCiAgICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQogICAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JSb3V0aW5nUHJvZmlsZVF1ZXVlcyA9IGZ1bmN0aW9uIChjb25maWd1cmF0aW9uLCBwYXJhbXNJbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgcGFyYW1zLm1heFJlc3VsdHMgPSBwYXJhbXMubWF4UmVzdWx0cyB8fCBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfUk9VVElOR19QUk9GSUxFX1FVRVVFUywgewogICAgICByb3V0aW5nUHJvZmlsZUFSTjogY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5yb3V0aW5nUHJvZmlsZUFSTiwKICAgICAgbmV4dFRva2VuOiBwYXJhbXMubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLm5leHRUb2tlbikgewogICAgICAgICAgICBzZWxmLnBvbGxGb3JSb3V0aW5nUHJvZmlsZVF1ZXVlcyhjb25maWd1cmF0aW9uLCB7CiAgICAgICAgICAgICAgY291bnRyeUNvZGVzOiAocGFyYW1zLnF1ZXVlcyB8fCBbXSkuY29uY2F0KGRhdGEucXVldWVzKSwKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucXVldWVzID0gKHBhcmFtcy5xdWV1ZXMgfHwgW10pLmNvbmNhdChkYXRhLnF1ZXVlcyk7CiAgICAgICAgICAgIHNlbGYudXBkYXRlQWdlbnRDb25maWd1cmF0aW9uKGNvbmZpZ3VyYXRpb24pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIHJvdXRpbmcgcHJvZmlsZSBxdWV1ZXMgbGlzdC4iKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpLAogICAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKICAgICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVBUElSZXF1ZXN0ID0gZnVuY3Rpb24gKHBvcnRDb25kdWl0LCByZXF1ZXN0KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdGhpcy5jbGllbnQuY2FsbChyZXF1ZXN0Lm1ldGhvZCwgcmVxdWVzdC5wYXJhbXMsIHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICB2YXIgcmVzcG9uc2UgPSBjb25uZWN0LkV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZShjb25uZWN0LkV2ZW50VHlwZS5BUElfUkVTUE9OU0UsIHJlcXVlc3QsIGRhdGEpOwogICAgICAgIHBvcnRDb25kdWl0LnNlbmREb3duc3RyZWFtKHJlc3BvbnNlLmV2ZW50LCByZXNwb25zZSk7CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICB2YXIgcmVzcG9uc2UgPSBjb25uZWN0LkV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZShjb25uZWN0LkV2ZW50VHlwZS5BUElfUkVTUE9OU0UsIHJlcXVlc3QsIGRhdGEsIEpTT04uc3RyaW5naWZ5KGVycikpOwogICAgICAgIHBvcnRDb25kdWl0LnNlbmREb3duc3RyZWFtKHJlc3BvbnNlLmV2ZW50LCByZXNwb25zZSk7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiJyVzJyBBUEkgcmVxdWVzdCBmYWlsZWQiLCByZXF1ZXN0Lm1ldGhvZCkKICAgICAgICAgIC53aXRoT2JqZWN0KHsgcmVxdWVzdDogc2VsZi5maWx0ZXJBdXRoVG9rZW4ocmVxdWVzdCksIHJlc3BvbnNlOiByZXNwb25zZSB9KS53aXRoRXhjZXB0aW9uKGVycik7CiAgICAgIH0sCiAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpCiAgICB9KTsKICB9OwoKICAvKioKICAgKiBIYW5kbGUgaW5jb21pbmcgbWFzdGVyIHF1ZXJ5IG9yIG1vZGlmaWNhdGlvbiByZXF1ZXN0cyBmcm9tIGNvbm5lY3RlZCB0YWIgcG9ydHMuCiAgICovCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVNYXN0ZXJSZXF1ZXN0ID0gZnVuY3Rpb24gKHBvcnRDb25kdWl0LCBwb3J0SWQsIHJlcXVlc3QpIHsKICAgIHZhciByZXNwb25zZSA9IG51bGw7CgogICAgc3dpdGNoIChyZXF1ZXN0Lm1ldGhvZCkgewogICAgICBjYXNlIGNvbm5lY3QuTWFzdGVyTWV0aG9kcy5CRUNPTUVfTUFTVEVSOgogICAgICAgIHRoaXMubWFzdGVyQ29vcmQuc2V0TWFzdGVyKHJlcXVlc3QucGFyYW1zLnRvcGljLCBwb3J0SWQpOwogICAgICAgIHJlc3BvbnNlID0gY29ubmVjdC5FdmVudEZhY3RvcnkuY3JlYXRlUmVzcG9uc2UoY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFU1BPTlNFLCByZXF1ZXN0LCB7CiAgICAgICAgICBtYXN0ZXJJZDogcG9ydElkLAogICAgICAgICAgaXNNYXN0ZXI6IHRydWUsCiAgICAgICAgICB0b3BpYzogcmVxdWVzdC5wYXJhbXMudG9waWMKICAgICAgICB9KTsKCiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIGNvbm5lY3QuTWFzdGVyTWV0aG9kcy5DSEVDS19NQVNURVI6CiAgICAgICAgdmFyIG1hc3RlcklkID0gdGhpcy5tYXN0ZXJDb29yZC5nZXRNYXN0ZXIocmVxdWVzdC5wYXJhbXMudG9waWMpOwogICAgICAgIGlmICghbWFzdGVySWQpIHsKICAgICAgICAgIHRoaXMubWFzdGVyQ29vcmQuc2V0TWFzdGVyKHJlcXVlc3QucGFyYW1zLnRvcGljLCBwb3J0SWQpOwogICAgICAgICAgbWFzdGVySWQgPSBwb3J0SWQ7CiAgICAgICAgfQoKICAgICAgICByZXNwb25zZSA9IGNvbm5lY3QuRXZlbnRGYWN0b3J5LmNyZWF0ZVJlc3BvbnNlKGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVNQT05TRSwgcmVxdWVzdCwgewogICAgICAgICAgbWFzdGVySWQ6IG1hc3RlcklkLAogICAgICAgICAgaXNNYXN0ZXI6IHBvcnRJZCA9PT0gbWFzdGVySWQsCiAgICAgICAgICB0b3BpYzogcmVxdWVzdC5wYXJhbXMudG9waWMKICAgICAgICB9KTsKCiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBtYXN0ZXIgbWV0aG9kOiAiICsgcmVxdWVzdC5tZXRob2QpOwogICAgfQoKICAgIHBvcnRDb25kdWl0LnNlbmREb3duc3RyZWFtKHJlc3BvbnNlLmV2ZW50LCByZXNwb25zZSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS51cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbikgewogICAgaWYgKGNvbmZpZ3VyYXRpb24ucGVybWlzc2lvbnMgJiYKICAgICAgY29uZmlndXJhdGlvbi5kaWFsYWJsZUNvdW50cmllcyAmJgogICAgICBjb25maWd1cmF0aW9uLmFnZW50U3RhdGVzICYmCiAgICAgIGNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucXVldWVzKSB7CgogICAgICB0aGlzLmFnZW50ID0gdGhpcy5hZ2VudCB8fCB7fTsKICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uID0gY29uZmlndXJhdGlvbjsKICAgICAgdGhpcy51cGRhdGVBZ2VudCgpOwoKICAgIH0gZWxzZSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIldhaXRpbmcgdG8gdXBkYXRlIGFnZW50IGNvbmZpZ3VyYXRpb24gdW50aWwgYWxsIGNvbmZpZyBkYXRhIGhhcyBiZWVuIGZldGNoZWQuIik7CiAgICB9CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS51cGRhdGVBZ2VudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghdGhpcy5hZ2VudCkgewogICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJXYWl0aW5nIHRvIHVwZGF0ZSBhZ2VudCB1bnRpbCB0aGUgYWdlbnQgaGFzIGJlZW4gZnVsbHkgY29uc3RydWN0ZWQuIik7CgogICAgfSBlbHNlIGlmICghdGhpcy5hZ2VudC5zbmFwc2hvdCkgewogICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJXYWl0aW5nIHRvIHVwZGF0ZSBhZ2VudCB1bnRpbCB0aGUgYWdlbnQgc25hcHNob3QgaXMgYXZhaWxhYmxlLiIpOwoKICAgIH0gZWxzZSBpZiAoIXRoaXMuYWdlbnQuY29uZmlndXJhdGlvbikgewogICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJXYWl0aW5nIHRvIHVwZGF0ZSBhZ2VudCB1bnRpbCB0aGUgYWdlbnQgY29uZmlndXJhdGlvbiBpcyBhdmFpbGFibGUuIik7CgogICAgfSBlbHNlIHsKICAgICAgLy8gQWxpYXMgc29tZSBvZiB0aGUgcHJvcGVydGllcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCiAgICAgIHRoaXMuYWdlbnQuc25hcHNob3Quc3RhdHVzID0gdGhpcy5hZ2VudC5zdGF0ZTsKCiAgICAgIC8vIFNvcnQgdGhlIGNvbnRhY3RzIG9uIHRoZSB0aW1lc3RhbXAKICAgICAgaWYgKHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMgJiYgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cy5sZW5ndGggPiAxKSB7CiAgICAgICAgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cy5zb3J0KGZ1bmN0aW9uIChjb250YWN0QSwgY29udGFjdEIpIHsKICAgICAgICAgIHJldHVybiBjb250YWN0QS5zdGF0ZS50aW1lc3RhbXAuZ2V0VGltZSgpIC0gY29udGFjdEIuc3RhdGUudGltZXN0YW1wLmdldFRpbWUoKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cy5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgICAgY29udGFjdC5zdGF0dXMgPSBjb250YWN0LnN0YXRlOwoKICAgICAgICBjb250YWN0LmNvbm5lY3Rpb25zLmZvckVhY2goZnVuY3Rpb24gKGNvbm5lY3Rpb24pIHsKICAgICAgICAgIGNvbm5lY3Rpb24uYWRkcmVzcyA9IGNvbm5lY3Rpb24uZW5kcG9pbnQ7CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLmRlZmF1bHRPdXRib3VuZFF1ZXVlLnF1ZXVlSWQgPQogICAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5kZWZhdWx0T3V0Ym91bmRRdWV1ZS5xdWV1ZUFSTjsKICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnF1ZXVlcy5mb3JFYWNoKGZ1bmN0aW9uIChxdWV1ZSkgewogICAgICAgIHF1ZXVlLnF1ZXVlSWQgPSBxdWV1ZS5xdWV1ZUFSTjsKICAgICAgfSk7CiAgICAgIHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgIC8vY29udGFjdC5xdWV1ZSBpcyBudWxsIHdoZW4gbW9uaXRvcmluZwogICAgICAgIGlmIChjb250YWN0LnF1ZXVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGNvbnRhY3QucXVldWUucXVldWVJZCA9IGNvbnRhY3QucXVldWUucXVldWVBUk47CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnJvdXRpbmdQcm9maWxlSWQgPQogICAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5yb3V0aW5nUHJvZmlsZUFSTjsKICAgICAgCiAgICAgIGlmICh0aGlzLnN1cHByZXNzKSB7CiAgICAgICAgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cyA9IHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMuZmlsdGVyKGZ1bmN0aW9uKGNvbnRhY3QpewogICAgICAgICAgcmV0dXJuIChjb250YWN0LnN0YXRlLnR5cGUgPT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkhPTEQgfHwgY29udGFjdC5zdGF0ZS50eXBlID09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNURUQpOwogICAgICAgIH0pOwogICAgICAgIGlmICh0aGlzLmZvcmNlT2ZmbGluZSkgewogICAgICAgICAgdGhpcy5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GT1JDRV9PRkZMSU5FKTsKICAgICAgICB9CiAgICAgIH0gCiAgICAgIHRoaXMuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkFnZW50RXZlbnRzLlVQREFURSwgdGhpcy5hZ2VudCk7CiAgICB9CiAgfTsKCi8qKgogKiBQcm92aWRlcyBhIHdlYnNvY2tldCB1cmwgdGhyb3VnaCB0aGUgY3JlYXRlX3RyYW5zcG9ydCBBUEkuCiAqIEByZXR1cm5zIGEgcHJvbWlzZSB3aGljaCwgdXBvbiBzdWNjZXNzLCByZXR1cm5zIHRoZSByZXNwb25zZSBmcm9tIHRoZSBjcmVhdGVUcmFuc3BvcnQgQVBJLgogKi8KICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmdldFdlYlNvY2tldFVybCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgb25BdXRoRmFpbCA9IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCk7CiAgICB2YXIgb25BY2Nlc3NEZW5pZWQgPSBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfVFJBTlNQT1JULCB7IHRyYW5zcG9ydFR5cGU6IGNvbm5lY3QuVFJBTlNQT1JUX1RZUEVTLldFQl9TT0NLRVQgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImdldFdlYlNvY2tldFVybCBzdWNjZWVkZWQiKTsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJnZXRXZWJTb2NrZXRVcmwgZmFpbGVkIikKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICByZWplY3QoRXJyb3IoImdldFdlYlNvY2tldFVybCBmYWlsZWQiKSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0V2ViU29ja2V0VXJsIEF1dGggRmFpbHVyZSIpOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJBdXRoZW50aWNhdGlvbiBmYWlsZWQgd2hpbGUgZ2V0dGluZyBnZXRXZWJTb2NrZXRVcmwiKSk7CiAgICAgICAgICBvbkF1dGhGYWlsKCk7CiAgICAgICAgfSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldFdlYlNvY2tldFVybCBBY2Nlc3MgRGVuaWVkIEZhaWx1cmUiKTsKICAgICAgICAgIHJlamVjdChFcnJvcigiQWNjZXNzIERlbmllZCBGYWlsdXJlIHdoaWxlIGdldHRpbmcgZ2V0V2ViU29ja2V0VXJsIikpOwogICAgICAgICAgb25BY2Nlc3NEZW5pZWQoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCgogIC8qKgogICAgKiBTZW5kIGEgbWVzc2FnZSBkb3duc3RyZWFtIHRvIGFsbCBjb25zdW1lcnMgd2hlbiB3ZSBkZXRlY3QgdGhhdCBhdXRoZW50aWNhdGlvbgogICAgKiBhZ2FpbnN0IG9uZSBvZiBvdXIgQVBJcyBoYXMgZmFpbGVkLgogICAgKi8KICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZVNlbmRMb2dzUmVxdWVzdCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBsb2dFdmVudHMgPSBbXTsKICAgIHZhciBsb2dzVG9TZW5kID0gc2VsZi5sb2dzQnVmZmVyLnNsaWNlKCk7CiAgICBzZWxmLmxvZ3NCdWZmZXIgPSBbXTsKICAgIGxvZ3NUb1NlbmQuZm9yRWFjaChmdW5jdGlvbiAobG9nKSB7CiAgICAgIGxvZ0V2ZW50cy5wdXNoKHsKICAgICAgICB0aW1lc3RhbXA6IGxvZy50aW1lLAogICAgICAgIGNvbXBvbmVudDogbG9nLmNvbXBvbmVudCwKICAgICAgICBtZXNzYWdlOiBsb2cudGV4dAogICAgICB9KTsKICAgIH0pOwogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuU0VORF9DTElFTlRfTE9HUywgeyBsb2dFdmVudHM6IGxvZ0V2ZW50cyB9LCB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJTZW5kTG9ncyByZXF1ZXN0IHN1Y2NlZWRlZC4iKTsKICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIlNlbmRMb2dzIHJlcXVlc3QgZmFpbGVkLiIpLndpdGhPYmplY3QoZGF0YSkud2l0aEV4Y2VwdGlvbihlcnIpOwogICAgICB9LAogICAgICBhdXRoRmFpbHVyZTogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKQogICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVBdXRoRmFpbCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BVVRIX0ZBSUwpOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlQWNjZXNzRGVuaWVkID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDQ0VTU19ERU5JRUQpOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuY2hlY2tBdXRoVG9rZW4gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgZXhwaXJhdGlvbkRhdGUgPSBuZXcgRGF0ZShzZWxmLmluaXREYXRhLmF1dGhUb2tlbkV4cGlyYXRpb24pOwogICAgdmFyIGN1cnJlbnRUaW1lU3RhbXAgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIHZhciB0aGlydHlNaW5zID0gMzAgKiA2MCAqIDEwMDA7CgogICAgLy8gcmVmcmVzaCB0b2tlbiAzMCBtaW51dGVzIGJlZm9yZSBleHBpcmF0aW9uCiAgICBpZiAoZXhwaXJhdGlvbkRhdGUuZ2V0VGltZSgpIDwgKGN1cnJlbnRUaW1lU3RhbXAgKyB0aGlydHlNaW5zKSkgewogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkF1dGggdG9rZW4gZXhwaXJlcyBhdCAiICsgZXhwaXJhdGlvbkRhdGUgKyAiIFN0YXJ0IHJlZnJlc2hpbmcgdG9rZW4gd2l0aCByZXRyeS4iKTsKICAgICAgY29ubmVjdC5iYWNrb2ZmKGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5hdXRob3JpemUpLCBSRUZSRVNIX0FVVEhfVE9LRU5fSU5URVJWQUxfTVMsIFJFRlJFU0hfQVVUSF9UT0tFTl9NQVhfVFJZKTsKICAgIH0KICB9OwoKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5hdXRob3JpemUgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBjb25uZWN0LmNvcmUuYXV0aG9yaXplKHRoaXMuaW5pdERhdGEuYXV0aG9yaXplRW5kcG9pbnQpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIHZhciBleHBpcmF0aW9uID0gbmV3IERhdGUocmVzcG9uc2UuZXhwaXJhdGlvbik7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQXV0aG9yaXphdGlvbiBzdWNjZWVkZWQgYW5kIHRoZSB0b2tlbiBleHBpcmVzIGF0ICVzIiwgZXhwaXJhdGlvbik7CiAgICAgIHNlbGYuaW5pdERhdGEuYXV0aFRva2VuID0gcmVzcG9uc2UuYWNjZXNzVG9rZW47CiAgICAgIHNlbGYuaW5pdERhdGEuYXV0aFRva2VuRXhwaXJhdGlvbiA9IGV4cGlyYXRpb247CiAgICAgIGNvbm5lY3QuY29yZS5pbml0Q2xpZW50KHNlbGYuaW5pdERhdGEpOwogICAgICBjYWxsYmFja3Muc3VjY2VzcygpOwogICAgfSkuY2F0Y2goZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkF1dGhvcml6YXRpb24gZmFpbGVkIHdpdGggY29kZSAlcyIsIHJlc3BvbnNlLnN0YXR1cyk7CiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDQwMSkgewogICAgICAgIHNlbGYuaGFuZGxlQXV0aEZhaWwoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFja3MuZmFpbHVyZSgpOwogICAgICB9CiAgICB9KTsKICB9OwoKICAvKioKICAgKiBGaWx0ZXIgdGhlICdhdXRoZW50aWNhdGlvbicgZmllbGQgb2YgdGhlIHJlcXVlc3QgcGFyYW1zIGZyb20gdGhlIGdpdmVuIEFQSV9SRVFVRVNUIGV2ZW50LgogICAqLwogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuZmlsdGVyQXV0aFRva2VuID0gZnVuY3Rpb24gKHJlcXVlc3QpIHsKICAgIHZhciBuZXdfcmVxdWVzdCA9IHt9OwoKICAgIGZvciAodmFyIGtleUEgaW4gcmVxdWVzdCkgewogICAgICBpZiAoa2V5QSA9PT0gJ3BhcmFtcycpIHsKICAgICAgICB2YXIgbmV3X3BhcmFtcyA9IHt9OwogICAgICAgIGZvciAodmFyIGtleUIgaW4gcmVxdWVzdC5wYXJhbXMpIHsKICAgICAgICAgIGlmIChrZXlCICE9PSAnYXV0aGVudGljYXRpb24nKSB7CiAgICAgICAgICAgIG5ld19wYXJhbXNba2V5Ql0gPSByZXF1ZXN0LnBhcmFtc1trZXlCXTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIG5ld19yZXF1ZXN0LnBhcmFtcyA9IG5ld19wYXJhbXM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbmV3X3JlcXVlc3Rba2V5QV0gPSByZXF1ZXN0W2tleUFdOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG5ld19yZXF1ZXN0OwogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0Lndvcmtlci5tYWluID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC53b3JrZXIuY2xpZW50RW5naW5lID0gbmV3IENsaWVudEVuZ2luZSgpOwogIH07Cgp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQW1hem9uIFNvZnR3YXJlIExpY2Vuc2UgKHRoZSAiTGljZW5zZSIpLiBZb3UgbWF5IG5vdCB1c2UKICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcwogKiBsb2NhdGVkIGF0CiAqCiAqICAgIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hc2wvCiAqCiAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQKICogb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3MKICogb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zCiAqIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIGNvbm5lY3QuQ2hhdE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uIChtZWRpYUluZm8sIG1ldGFkYXRhKSB7CiAgICB2YXIgbG9nZ2VyID0gY29ubmVjdC5nZXRMb2coKTsKICAgIHZhciBsb2dDb21wb25lbnQgPSBjb25uZWN0LkxvZ0NvbXBvbmVudC5DSEFUOwoKICAgIHZhciBjcmVhdGVNZWRpYUluc3RhbmNlID0gZnVuY3Rpb24gKCkgewogICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgbWVkaWEgY29udHJvbGxlciBpbml0IiwgbWVkaWFJbmZvLmNvbnRhY3RJZCk7CiAgICAgIGxvZ2dlci5pbmZvKGxvZ0NvbXBvbmVudCwgIkNoYXQgbWVkaWEgY29udHJvbGxlciBpbml0Iikud2l0aE9iamVjdChtZWRpYUluZm8pOwoKICAgICAgY29ubmVjdC5DaGF0U2Vzc2lvbi5zZXRHbG9iYWxDb25maWcoewogICAgICAgIGxvZ2dlckNvbmZpZzogewogICAgICAgICAgbG9nZ2VyOiBsb2dnZXIKICAgICAgICB9LAogICAgICAgIHJlZ2lvbjogbWV0YWRhdGEucmVnaW9uCiAgICAgIH0pOwoKICAgICAgLyoqIENvdWxkIGJlIGFsc28gQ1VTVE9NRVIgLSAgRm9yIG5vdyB3ZSBhcmUgY3JlYXRpbmcgb25seSBBZ2VudCBjb25uZWN0aW9uIG1lZGlhIG9iamVjdCAqLwogICAgICB2YXIgY29udHJvbGxlciA9IGNvbm5lY3QuQ2hhdFNlc3Npb24uY3JlYXRlKHsKICAgICAgICBjaGF0RGV0YWlsczogbWVkaWFJbmZvLAogICAgICAgIHR5cGU6ICJBR0VOVCIsCiAgICAgICAgd2Vic29ja2V0TWFuYWdlcjogY29ubmVjdC5jb3JlLmdldFdlYlNvY2tldE1hbmFnZXIoKQogICAgICB9KTsKICAgICAgCiAgICAgIHRyYWNrQ2hhdENvbm5lY3Rpb25TdGF0dXMoY29udHJvbGxlcik7CiAgICAgIHJldHVybiBjb250cm9sbGVyCiAgICAgICAgLmNvbm5lY3QoKQogICAgICAgIC50aGVuKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBsb2dnZXIuaW5mbyhsb2dDb21wb25lbnQsICJDaGF0IFNlc3Npb24gU3VjY2Vzc2Z1bGx5IGVzdGFibGlzaGVkIGZvciBjb250YWN0SWQgJXMiLCBtZWRpYUluZm8uY29udGFjdElkKTsKICAgICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBTZXNzaW9uIFN1Y2Nlc3NmdWxseSBlc3RhYmxpc2hlZCIsIG1lZGlhSW5mby5jb250YWN0SWQpOwogICAgICAgICAgcmV0dXJuIGNvbnRyb2xsZXI7CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICBsb2dnZXIuZXJyb3IobG9nQ29tcG9uZW50LCAiQ2hhdCBTZXNzaW9uIGVzdGFibGlzaGVtZW50IGZhaWxlZCBmb3IgY29udGFjdCAlcyIsIG1lZGlhSW5mby5jb250YWN0SWQpLndpdGhFeGNlcHRpb24oZXJyb3IpOwogICAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDaGF0IFNlc3Npb24gZXN0YWJsaXNoZW1lbnQgZmFpbGVkIiwgbWVkaWFJbmZvLmNvbnRhY3RJZCwgZXJyb3IpOwogICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgfSk7CiAgICB9OwoKICAgIHZhciBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBkYXRhKSB7CiAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgbmFtZTogZXZlbnROYW1lLAogICAgICAgIGNvbnRhY3RJZDogbWVkaWFJbmZvLmNvbnRhY3RJZCwKICAgICAgICBkYXRhOiBkYXRhIHx8IG1lZGlhSW5mbwogICAgICB9KTsKICAgIH07CgogICAgdmFyIHRyYWNrQ2hhdENvbm5lY3Rpb25TdGF0dXMgPSBmdW5jdGlvbiAoY29udHJvbGxlcikgewogICAgICBjb250cm9sbGVyLm9uQ29ubmVjdGlvbkJyb2tlbihmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGxvZ2dlci5lcnJvcihsb2dDb21wb25lbnQsICJDaGF0IFNlc3Npb24gY29ubmVjdGlvbiBicm9rZW4iKS53aXRoRXhjZXB0aW9uKGRhdGEpOwogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBTZXNzaW9uIGNvbm5lY3Rpb24gYnJva2VuIiwgZGF0YSk7CiAgICAgIH0pOwoKICAgICAgY29udHJvbGxlci5vbkNvbm5lY3Rpb25Fc3RhYmxpc2hlZChmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGxvZ2dlci5pbmZvKGxvZ0NvbXBvbmVudCwgIkNoYXQgU2Vzc2lvbiBjb25uZWN0aW9uIGVzdGFibGlzaGVkIikud2l0aE9iamVjdChkYXRhKTsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgU2Vzc2lvbiBjb25uZWN0aW9uIGVzdGFibGlzaGVkIiwgZGF0YSk7CiAgICAgIH0pOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjcmVhdGVNZWRpYUluc3RhbmNlKCk7CiAgICAgIH0KICAgIH0KICB9Cn0pKCk7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBbWF6b24gU29mdHdhcmUgTGljZW5zZSAodGhlICJMaWNlbnNlIikuIFlvdSBtYXkgbm90IHVzZQogKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzCiAqIGxvY2F0ZWQgYXQKICoKICogICAgaHR0cDovL2F3cy5hbWF6b24uY29tL2FzbC8KICoKICogb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZAogKiBvbiBhbiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcwogKiBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMKICogYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKi8KCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKCiAgY29ubmVjdC5NZWRpYUZhY3RvcnkgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICAvKiogY29udHJvbGxlciBob2xkZXIgKi8KICAgIHZhciBtZWRpYUNvbnRyb2xsZXJzID0ge307CiAgICB2YXIgdG9CZURlc3Ryb3llZCA9IG5ldyBTZXQoKTsKCiAgICB2YXIgbG9nZ2VyID0gY29ubmVjdC5nZXRMb2coKTsKICAgIHZhciBsb2dDb21wb25lbnQgPSBjb25uZWN0LkxvZ0NvbXBvbmVudC5DSEFUOwoKICAgIHZhciBtZXRhZGF0YSA9IHBhcmFtcyB8fCB7fTsKICAgIG1ldGFkYXRhLnJlZ2lvbiA9ICBtZXRhZGF0YS5yZWdpb24gfHwgInVzLXdlc3QtMiI7IC8vIERlZmF1bHQgaXQgdG8gdXMtd2VzdC0yCgogICAgdmFyIGdldE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uIChjb25uZWN0aW9uT2JqKSB7CiAgICAgIHZhciBjb25uZWN0aW9uSWQgPSBjb25uZWN0aW9uT2JqLmdldENvbm5lY3Rpb25JZCgpOwogICAgICB2YXIgbWVkaWFJbmZvID0gY29ubmVjdGlvbk9iai5nZXRNZWRpYUluZm8oKTsKICAgICAgLyoqIGlmIHdlIGRvIG5vdCBoYXZlIHRoZSBtZWRpYSBpbmZvIHRoZW4ganVzdCByZWplY3QgdGhlIHJlcXVlc3QgKi8KICAgICAgaWYgKCFtZWRpYUluZm8pIHsKICAgICAgICBsb2dnZXIuZXJyb3IobG9nQ29tcG9uZW50LCAiTWVkaWEgaW5mbyBkb2VzIG5vdCBleGlzdHMgZm9yIGEgbWVkaWEgdHlwZSAlcyIpLndpdGhPYmplY3QoY29ubmVjdGlvbk9iaik7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJNZWRpYSBpbmZvIGRvZXMgbm90IGV4aXN0cyBmb3IgdGhpcyBjb25uZWN0aW9uIik7CiAgICAgIH0KCiAgICAgIGlmICghbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdKSB7CiAgICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAibWVkaWEgY29udHJvbGxlciBvZiB0eXBlICVzIGluaXQiLCBjb25uZWN0aW9uT2JqLmdldE1lZGlhVHlwZSgpKS53aXRoT2JqZWN0KGNvbm5lY3Rpb25PYmopOwogICAgICAgIHN3aXRjaCAoY29ubmVjdGlvbk9iai5nZXRNZWRpYVR5cGUoKSkgewogICAgICAgICAgY2FzZSBjb25uZWN0Lk1lZGlhVHlwZS5DSEFUOgogICAgICAgICAgICByZXR1cm4gbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdID0gbmV3IGNvbm5lY3QuQ2hhdE1lZGlhQ29udHJvbGxlcihjb25uZWN0aW9uT2JqLmdldE1lZGlhSW5mbygpLCBtZXRhZGF0YSkuZ2V0KCk7CiAgICAgICAgICBjYXNlIGNvbm5lY3QuTWVkaWFUeXBlLlNPRlRQSE9ORToKICAgICAgICAgICAgcmV0dXJuIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXSA9IG5ldyBjb25uZWN0LlNvZnRwaG9uZU1lZGlhQ29udHJvbGxlcihjb25uZWN0aW9uT2JqLmdldE1lZGlhSW5mbygpKS5nZXQoKTsKICAgICAgICAgIGNhc2UgY29ubmVjdC5NZWRpYVR5cGUuVEFTSzoKICAgICAgICAgICAgcmV0dXJuIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXSA9IG5ldyBjb25uZWN0LlRhc2tNZWRpYUNvbnRyb2xsZXIoY29ubmVjdGlvbk9iai5nZXRNZWRpYUluZm8oKSkuZ2V0KCk7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBsb2dnZXIuZXJyb3IobG9nQ29tcG9uZW50LCAiVW5yZWNvZ25pemVkIG1lZGlhIHR5cGUgJXMgIiwgY29ubmVjdGlvbk9iai5nZXRNZWRpYVR5cGUoKSk7CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdOwogICAgICB9CiAgICB9OwoKICAgIC8qKiBDaGVjayBhbGwgdGhlIGFjdGl2ZSBzdGF0ZXMgZm9yIHRoZSBjb25uZWN0aW9uICovCiAgICB2YXIgaWZDb25uZWN0aW9uQWN0aXZlID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25PYmopIHsKICAgICAgcmV0dXJuIGNvbm5lY3Rpb25PYmouaXNBY3RpdmUoKTsKICAgIH07CgogICAgdmFyIGdldCA9IGZ1bmN0aW9uIChjb25uZWN0aW9uT2JqKSB7CiAgICAgIGlmIChpZkNvbm5lY3Rpb25BY3RpdmUoY29ubmVjdGlvbk9iaikpIHsKICAgICAgICByZXR1cm4gZ2V0TWVkaWFDb250cm9sbGVyKGNvbm5lY3Rpb25PYmopOwogICAgICB9IGVsc2UgewogICAgICAgIGRlc3Ryb3koY29ubmVjdGlvbk9iai5nZXRDb25uZWN0aW9uSWQoKSk7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJNZWRpYSBDb250cm9sbGVyIGlzIG5vIGxvbmdlciBhdmFpbGFibGUgZm9yIHRoaXMgY29ubmVjdGlvbiIpOwogICAgICB9CiAgICB9OwoKICAgIHZhciBkZXN0cm95ID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25JZCkgewogICAgICBpZiAobWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdICYmICF0b0JlRGVzdHJveWVkLmhhcyhjb25uZWN0aW9uSWQpKSB7CiAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICBsb2dDb21wb25lbnQsCiAgICAgICAgICAiRGVzdHJveWluZyBtZWRpYUNvbnRyb2xsZXIgZm9yICVzIiwKICAgICAgICAgIGNvbm5lY3Rpb25JZAogICAgICAgICk7CiAgICAgICAgdG9CZURlc3Ryb3llZC5hZGQoY29ubmVjdGlvbklkKTsKICAgICAgICBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0KICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRyb2xsZXIuY2xlYW5VcCA9PT0gImZ1bmN0aW9uIikgY29udHJvbGxlci5jbGVhblVwKCk7CiAgICAgICAgICAgIGRlbGV0ZSBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF07CiAgICAgICAgICAgIHRvQmVEZXN0cm95ZWQuZGVsZXRlKGNvbm5lY3Rpb25JZCk7CiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBkZWxldGUgbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdOwogICAgICAgICAgICB0b0JlRGVzdHJveWVkLmRlbGV0ZShjb25uZWN0aW9uSWQpOwogICAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIHsKICAgICAgZ2V0OiBnZXQsCiAgICAgIGRlc3Ryb3k6IGRlc3Ryb3kKICAgIH07CiAgfQp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQW1hem9uIFNvZnR3YXJlIExpY2Vuc2UgKHRoZSAiTGljZW5zZSIpLiBZb3UgbWF5IG5vdCB1c2UKICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcwogKiBsb2NhdGVkIGF0CiAqCiAqICAgIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hc2wvCiAqCiAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQKICogb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3MKICogb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zCiAqIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIC8vIFRPRE8gbW92ZSBzb2Z0cGhvbmUgaW1wbGVtZW50YXRpb25zIGhlcmUgLSBXaWwgZG8gdGhpcyBmb3IgR0EKICBjb25uZWN0LlNvZnRwaG9uZU1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uIChtZWRpYUluZm8pIHsKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobWVkaWFJbmZvKQogICAgICB9CiAgICB9CiAgfQp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQW1hem9uIFNvZnR3YXJlIExpY2Vuc2UgKHRoZSAiTGljZW5zZSIpLiBZb3UgbWF5IG5vdCB1c2UKICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcwogKiBsb2NhdGVkIGF0CiAqCiAqICAgIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hc2wvCiAqCiAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQKICogb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3MKICogb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zCiAqIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIGNvbm5lY3QuVGFza01lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uIChtZWRpYUluZm8pIHsKICAgIHZhciBsb2dnZXIgPSBjb25uZWN0LmdldExvZygpOwogICAgdmFyIGxvZ0NvbXBvbmVudCA9IGNvbm5lY3QuTG9nQ29tcG9uZW50LlRBU0s7CgogICAgdmFyIGNyZWF0ZU1lZGlhSW5zdGFuY2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiVGFzayBtZWRpYSBjb250cm9sbGVyIGluaXQiLCBtZWRpYUluZm8uY29udGFjdElkKTsKICAgICAgbG9nZ2VyCiAgICAgICAgLmluZm8obG9nQ29tcG9uZW50LCAiVGFzayBtZWRpYSBjb250cm9sbGVyIGluaXQiKQogICAgICAgIC53aXRoT2JqZWN0KG1lZGlhSW5mbyk7CgogICAgICB2YXIgY29udHJvbGxlciA9IGNvbm5lY3QuVGFza1Nlc3Npb24uY3JlYXRlKHsKICAgICAgICBjb250YWN0SWQ6IG1lZGlhSW5mby5jb250YWN0SWQsCiAgICAgICAgaW5pdGlhbENvbnRhY3RJZDogbWVkaWFJbmZvLmluaXRpYWxDb250YWN0SWQsCiAgICAgICAgd2Vic29ja2V0TWFuYWdlcjogY29ubmVjdC5jb3JlLmdldFdlYlNvY2tldE1hbmFnZXIoKSwKICAgICAgfSk7CgogICAgICB0cmFja1Rhc2tDb25uZWN0aW9uU3RhdHVzKGNvbnRyb2xsZXIpOwoKICAgICAgcmV0dXJuIGNvbnRyb2xsZXIKICAgICAgICAuY29ubmVjdCgpCiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICAgIGxvZ0NvbXBvbmVudCwKICAgICAgICAgICAgIlRhc2sgU2Vzc2lvbiBTdWNjZXNzZnVsbHkgZXN0YWJsaXNoZWQgZm9yIGNvbnRhY3RJZCAlcyIsCiAgICAgICAgICAgIG1lZGlhSW5mby5jb250YWN0SWQKICAgICAgICAgICk7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoCiAgICAgICAgICAgICJUYXNrIFNlc3Npb24gU3VjY2Vzc2Z1bGx5IGVzdGFibGlzaGVkIiwKICAgICAgICAgICAgbWVkaWFJbmZvLmNvbnRhY3RJZAogICAgICAgICAgKTsKICAgICAgICAgIHJldHVybiBjb250cm9sbGVyOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgbG9nZ2VyCiAgICAgICAgICAgIC5lcnJvcigKICAgICAgICAgICAgICBsb2dDb21wb25lbnQsCiAgICAgICAgICAgICAgIlRhc2sgU2Vzc2lvbiBlc3RhYmxpc2hlbWVudCBmYWlsZWQgZm9yIGNvbnRhY3QgJXMiLAogICAgICAgICAgICAgIG1lZGlhSW5mby5jb250YWN0SWQKICAgICAgICAgICAgKQogICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlcnJvcik7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoCiAgICAgICAgICAgICJDaGF0IFNlc3Npb24gZXN0YWJsaXNoZW1lbnQgZmFpbGVkIiwKICAgICAgICAgICAgbWVkaWFJbmZvLmNvbnRhY3RJZCwKICAgICAgICAgICAgZXJyb3IKICAgICAgICAgICk7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9KTsKICAgIH07CgogICAgdmFyIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGRhdGEpIHsKICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICBuYW1lOiBldmVudE5hbWUsCiAgICAgICAgY29udGFjdElkOiBtZWRpYUluZm8uY29udGFjdElkLAogICAgICAgIGRhdGE6IGRhdGEgfHwgbWVkaWFJbmZvLAogICAgICB9KTsKICAgIH07CgogICAgdmFyIHRyYWNrVGFza0Nvbm5lY3Rpb25TdGF0dXMgPSBmdW5jdGlvbiAoY29udHJvbGxlcikgewogICAgICBjb250cm9sbGVyLm9uQ29ubmVjdGlvbkJyb2tlbihmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGxvZ2dlcgogICAgICAgICAgLmVycm9yKGxvZ0NvbXBvbmVudCwgIlRhc2sgU2Vzc2lvbiBjb25uZWN0aW9uIGJyb2tlbiIpCiAgICAgICAgICAud2l0aEV4Y2VwdGlvbihkYXRhKTsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlRhc2sgU2Vzc2lvbiBjb25uZWN0aW9uIGJyb2tlbiIsIGRhdGEpOwogICAgICB9KTsKCiAgICAgIGNvbnRyb2xsZXIub25Db25uZWN0aW9uRXN0YWJsaXNoZWQoZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBsb2dnZXIKICAgICAgICAgIC5pbmZvKGxvZ0NvbXBvbmVudCwgIlRhc2sgU2Vzc2lvbiBjb25uZWN0aW9uIGVzdGFibGlzaGVkIikKICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpOwogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiVGFzayBTZXNzaW9uIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQiLCBkYXRhKTsKICAgICAgfSk7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjcmVhdGVNZWRpYUluc3RhbmNlKCk7CiAgICAgIH0sCiAgICB9OwogIH07Cn0pKCk7Cg==");I.prototype._createFramedCcp=function(I){var g=this.style||"margin: 0; border: 0; padding: 0px; width: 0px; height: 0px",C=document.createElement("iframe");return C.srcdoc=this.getContent(I),C.allow="microphone; autoplay",C.id=this.id,C.style=g,C.scrolling="no",C},I.prototype.getContent=function(I){return["<!DOCTYPE html>","<meta charset='UTF-8'>","<html>","<head>","<script type='text/javascript'>",g,"<\/script>","</head>","<body onload='init()'>","<div id=containerDiv style='width: 100%;height: "+this.height+"'></div>","<script type='text/javascript'>","function init() {","connect.core.initCCP(containerDiv,"+I+");","}","<\/script>","</body>","</html>"].join("")},globalConnect.Container=I}(),function(){var I=this;connect=I.connect||{},globalConnect=I.globalConnect||{},I.connect=connect,I.globalConnect=globalConnect,I.lily=connect,connect.core={},globalConnect.core={regions:{}};function G(I,g){if(connect.assertTrue("string"==typeof I,"Region provided "+I+" is not a valid string"),!(g||globalConnect.core.regions).hasOwnProperty(I)){I="Region provided "+I+" is not found!";throw new connect.ValueError(I)}}var Z="465px",c=!0,d=function(I){I=window.getComputedStyle(I);return{height:I.getPropertyValue("height"),width:I.getPropertyValue("width"),display:I.getPropertyValue("display")}};globalConnect.core.initCCP=function(l,I){connect.assertNotNull(I.getPrimaryRegion,"getPrimaryRegion"),connect.assertTrue(connect.isFunction(I.getPrimaryRegion),"getPrimaryRegion must be a function");var g=I.getPrimaryRegion;delete I.getPrimaryRegion;var b=function(I,g){connect.assertNotNull(g.standByRegion,"ccpBackupResource"),connect.assertNotNull(g.standByRegion.ccpUrl,"ccpUrl"),connect.assertNotNull(g.standByRegion.loginUrl,"loginUrl"),connect.assertNotNull(g.standByRegion.region,"region");var C=g,g=Object.assign({},g,{ccpUrl:g.standByRegion.ccpUrl,loginUrl:g.standByRegion.loginUrl,region:g.standByRegion.region}),A=d(I);return"none"==A.display&&(c=!1),parseInt(A.height)<=0&&(I.style.height=Z,A.height=Z),[C,g].map(function(I){return connect.assertNotNull(I.ccpUrl,"ccpUrl"),connect.assertNotNull(I.loginUrl,"loginUrl"),connect.assertNotNull(I.region,"region"),delete I.standByRegion,I.loginPopup=!1,I.disasterRecoveryOn=!0,I.iframe_style="margin: 0; border: 0; padding:0px;width: 0px;height: 0px",I.height=A.height,I})}(l,I);g(function(A){var I=b.reduce(function(I,g){return I[g.region]=null,I},{});G(A,I);var g=b.map(function(I){return I.region===A&&(I.isPrimary=!0),new globalConnect.Container(I)}),C=g.map(function(I){return I.ccp.outerHTML}),Z=document.createElement("iframe");Z.style="margin: 0; border: 0; padding:0px;width: 100%;height: 100%",Z.id="globalCCP",Z.scrolling="no",Z.onload=function(){var C;c&&(C=Object.keys(I).find(function(I){return I!=A}),W(A,Z.id),B(C,Z.id)),g.map(function(I){globalConnect.core.regions[I.region]=Z.contentDocument.getElementById(I.id).contentWindow.connect;var g=globalConnect.core.regions[I.region];g.core.getUpstream().onUpstream(g.DisasterRecoveryEvents.FAILOVER,function(I){I.isPrimary?(connect=g,A=connect.core.region,c&&W(A,Z.id)):c&&(C=g.core.region,B(C,Z.id))})}),connect=globalConnect.core.regions[A]},Z.srcdoc=C.join(""),l.appendChild(Z)},function(){console.log("[Disaster Recovery] An error occured, while attempting to retrieve your primary region;")})};function C(g){return g=g||connect.core.region,Object.keys(globalConnect.core.regions).find(function(I){return I!==g})}var B=function(I,g){I=I.replace(/-/g,"_"),document.getElementById(g).contentDocument.getElementById(I).style="height: 0; width: 0; border: 0px"},W=function(I,g){I=I.replace(/-/g,"_"),document.getElementById(g).contentDocument.getElementById(I).style="height:800px;width:100%;border:0px"};globalConnect.core.failover=function(){globalConnect.core.failoverTo(C())},globalConnect.core.failoverTo=function(I){G(I);var g=C(I);A(g),l(I),connect=globalConnect.core.regions[I]};var A=function(I){I=globalConnect.core.regions[I];I.getLog().info("[Disaster Recovery] Deactivating %s region.",I.core.region),I.core.suppressContacts(!0),I.core.forceOffline()},l=function(I){I=globalConnect.core.regions[I];I.getLog().info("[Disaster Recovery] Activating %s region.",I.core.region),I.core.suppressContacts(!1)};connect.core.initCCP=globalConnect.core.initCCP}();