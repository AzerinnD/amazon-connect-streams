!function(){var m=function(){return m.cache.hasOwnProperty(arguments[0])||(m.cache[arguments[0]]=m.parse(arguments[0])),m.format.call(null,m.cache[arguments[0]],arguments)};m.format=function(I,g){for(var C,A,Z,l,b,G,d=1,c=I.length,V=[],W=0;W<c;W++)if("string"===(C=B(I[W])))V.push(I[W]);else if("array"===C){if((l=I[W])[2])for(A=g[d],Z=0;Z<l[2].length;Z++){if(!A.hasOwnProperty(l[2][Z]))throw m('[sprintf] property "%s" does not exist',l[2][Z]);A=A[l[2][Z]]}else A=l[1]?g[l[1]]:g[d++];if(/[^s]/.test(l[8])&&"number"!=B(A))throw m("[sprintf] expecting number but found %s",B(A));switch(l[8]){case"b":A=A.toString(2);break;case"c":A=String.fromCharCode(A);break;case"d":A=parseInt(A,10);break;case"e":A=l[7]?A.toExponential(l[7]):A.toExponential();break;case"f":A=l[7]?parseFloat(A).toFixed(l[7]):parseFloat(A);break;case"o":A=A.toString(8);break;case"s":A=(A=String(A))&&l[7]?A.substring(0,l[7]):A;break;case"u":A>>>=0;break;case"x":A=A.toString(16);break;case"X":A=A.toString(16).toUpperCase()}A=/[def]/.test(l[8])&&l[3]&&0<=A?"+"+A:A,b=l[4]?"0"==l[4]?"0":l[4].charAt(1):" ",G=l[6]-String(A).length,G=l[6]?function(I,g){for(var C=[];0<g;C[--g]=I);return C.join("")}(b,G):"",V.push(l[5]?A+G:G+A)}return V.join("")},m.cache={},m.parse=function(I){for(var g=I,C=[],A=[],Z=0;g;){if(null!==(C=/^[^\x25]+/.exec(g)))A.push(C[0]);else if(null!==(C=/^\x25{2}/.exec(g)))A.push("%");else{if(null===(C=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(g)))throw"[sprintf] huh?";if(C[2]){Z|=1;var l=[],b=C[2],G=[];if(null===(G=/^([a-z_][a-z_\d]*)/i.exec(b)))throw"[sprintf] huh?";for(l.push(G[1]);""!==(b=b.substring(G[0].length));)if(null!==(G=/^\.([a-z_][a-z_\d]*)/i.exec(b)))l.push(G[1]);else{if(null===(G=/^\[(\d+)\]/.exec(b)))throw"[sprintf] huh?";l.push(G[1])}C[2]=l}else Z|=2;if(3===Z)throw"[sprintf] mixing positional and named placeholders is not (yet) supported";A.push(C)}g=g.substring(C[0].length)}return A};function B(I){return Object.prototype.toString.call(I).slice(8,-1).toLowerCase()}this.sprintf=m,this.vsprintf=function(I,g,C){return(C=g.slice(0)).splice(0,0,I),m.apply(null,C)}}(),function(){var d=this;connect=d.connect||{},d.connect=connect,d.lily=connect;var g=navigator.userAgent;connect.sprintf=d.sprintf,connect.vsprintf=d.vsprintf,delete d.sprintf,delete d.vsprintf,connect.HTTP_STATUS_CODES={SUCCESS:200,TOO_MANY_REQUESTS:429,INTERNAL_SERVER_ERROR:500},connect.TRANSPORT_TYPES={CHAT_TOKEN:"chat_token",WEB_SOCKET:"web_socket"},connect.hitch=function(){var g=Array.prototype.slice.call(arguments),C=g.shift(),A=g.shift();return connect.assertNotNull(C,"scope"),connect.assertNotNull(A,"method"),connect.assertTrue(connect.isFunction(A),"method must be a function"),function(){var I=Array.prototype.slice.call(arguments);return A.apply(C,g.concat(I))}},connect.isFunction=function(I){return!!(I&&I.constructor&&I.call&&I.apply)},connect.isArray=function(I){return"[object Array]"===Object.prototype.toString.call(I)},connect.keys=function(I){var g,C=[];for(g in connect.assertNotNull(I,"map"),I)C.push(g);return C},connect.values=function(I){var g,C=[];for(g in connect.assertNotNull(I,"map"),I)C.push(I[g]);return C},connect.entries=function(I){var g,C=[];for(g in I)C.push({key:g,value:I[g]});return C},connect.merge=function(){var I=Array.prototype.slice.call(arguments,0),g={};return I.forEach(function(I){connect.entries(I).forEach(function(I){g[I.key]=I.value})}),g},connect.now=function(){return(new Date).getTime()},connect.find=function(I,g){for(var C=0;C<I.length;C++)if(g(I[C]))return I[C];return null},connect.contains=function(I,g){return I instanceof Array?null!=connect.find(I,function(I){return I===g}):g in I},connect.containsValue=function(I,g){return I instanceof Array?null!=connect.find(I,function(I){return I===g}):null!=connect.find(connect.values(I),function(I){return I===g})},connect.randomId=function(){return connect.sprintf("%s-%s",connect.now(),Math.random().toString(36).slice(2))},connect.makeEnum=function(I){var C={};return I.forEach(function(I){var g=I.replace(/\.?([a-z]+)_?/g,function(I,g){return g.toUpperCase()+"_"}).replace(/_$/,"");C[g]=I}),C},connect.makeNamespacedEnum=function(g,I){var C=connect.makeEnum(I);return connect.keys(C).forEach(function(I){C[I]=connect.sprintf("%s::%s",g,C[I])}),C},connect.makeGenericNamespacedEnum=function(g,I,C){var A=connect.makeEnum(I);return connect.keys(A).forEach(function(I){A[I]=connect.sprintf("%s"+C+"%s",g,A[I])}),A},connect.isChromeBrowser=function(){return-1!==g.indexOf("Chrome")},connect.isFirefoxBrowser=function(){return-1!==g.indexOf("Firefox")},connect.isOperaBrowser=function(){return-1!==g.indexOf("Opera")},connect.getChromeBrowserVersion=function(){var I=g.substring(g.indexOf("Chrome")+7);return I?parseFloat(I):-1},connect.getFirefoxBrowserVersion=function(){var I=g.substring(g.indexOf("Firefox")+8);return I?parseFloat(I):-1},connect.isValidLocale=function(I){return[{id:"en_US",label:"English"},{id:"de_DE",label:"Deutsch"},{id:"es_ES",label:"Español"},{id:"fr_FR",label:"Français"},{id:"ja_JP",label:"日本語"},{id:"it_IT",label:"Italiano"},{id:"ko_KR",label:"한국어"},{id:"pt_BR",label:"Português"},{id:"zh_CN",label:"中文(简体)"},{id:"zh_TW",label:"中文(繁體)"}].map(function(I){return I.id}).includes(I)},connect.getOperaBrowserVersion=function(){var I=g.indexOf("Opera"),I=-1!==g.indexOf("Version")?g.substring(I+8):g.substring(I+6);return I?parseFloat(I):-1},connect.index=function(I,g){var C={};return I.forEach(function(I){C[g(I)]=I}),C},connect.set=function(I){var g={};return I.forEach(function(I){g[I]=1}),g},connect.relativeComplement=function(g,C){var A={};return connect.keys(C).forEach(function(I){I in g||(A[I]=C[I])}),A},connect.assertTrue=function(I,g){if(!I)throw new connect.ValueError(g)},connect.assertNotNull=function(I,g){return connect.assertTrue(null!=I&&!0,connect.sprintf("%s must be provided",g||"A value")),I},connect.deepcopy=function(I){return JSON.parse(JSON.stringify(I))},connect.getBaseUrl=function(){var I=d.location;return connect.sprintf("%s//%s:%s",I.protocol,I.hostname,I.port)},connect.getUrlWithProtocol=function(I){var g=d.location.protocol;return I.substr(0,g.length)!==g?connect.sprintf("%s//%s",g,I):I},connect.isFramed=function(){try{return window.self!==window.top}catch(I){return!0}},connect.hasOtherConnectedCCPs=function(){return 1<connect.numberOfConnectedCCPs},connect.fetch=function(I,l,b,g){return g=g||5,b=b||1e3,l=l||{},new Promise(function(A,Z){!function g(C){fetch(I,l).then(function(I){I.status===connect.HTTP_STATUS_CODES.SUCCESS?I.json().then(I=>A(I)).catch(()=>A({})):1!==C&&(I.status>=connect.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR||I.status===connect.HTTP_STATUS_CODES.TOO_MANY_REQUESTS)?setTimeout(function(){g(--C)},b):Z(I)}).catch(function(I){Z(I)})}(g)})},connect.backoff=function(A,Z,l,b){connect.assertTrue(connect.isFunction(A),"func must be a Function");var G=this;A({success:function(I){b&&b.success&&b.success(I)},failure:function(I,g){var C;0<l?(C=2*Z*Math.random(),d.setTimeout(function(){G.backoff(A,2*C,--l,b)},C)):b&&b.failure&&b.failure(I,g)}})},connect.publishMetric=function(I){connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST,{event:connect.EventType.CLIENT_METRIC,data:I})},connect.publishSoftphoneStats=function(I){connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST,{event:connect.EventType.SOFTPHONE_STATS,data:I})},connect.publishSoftphoneReport=function(I){connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST,{event:connect.EventType.SOFTPHONE_REPORT,data:I})},connect.publishClientSideLogs=function(I){connect.core.getEventBus().trigger(connect.EventType.CLIENT_SIDE_LOGS,I)},connect.PopupManager=function(){},connect.PopupManager.prototype.open=function(I,g,C){var A,Z,l=this._getLastOpenedTimestamp(g),b=(new Date).getTime(),G=null;return 864e5<b-l&&(C?(A=C.height||578,Z=C.width||433,l=C.top||0,C=C.left||0,(G=window.open("",g,"width="+Z+", height="+A+", top="+l+", left="+C)).location!==I&&(G=window.open(I,g,"width="+Z+", height="+A+", top="+l+", left="+C))):(G=window.open("",g)).location!==I&&(G=window.open(I,g)),this._setLastOpenedTimestamp(g,b)),G},connect.PopupManager.prototype.clear=function(I){I=this._getLocalStorageKey(I);d.localStorage.removeItem(I)},connect.PopupManager.prototype._getLastOpenedTimestamp=function(I){I=this._getLocalStorageKey(I),I=d.localStorage.getItem(I);return I?parseInt(I,10):0},connect.PopupManager.prototype._setLastOpenedTimestamp=function(I,g){I=this._getLocalStorageKey(I);d.localStorage.setItem(I,""+g)},connect.PopupManager.prototype._getLocalStorageKey=function(I){return"connectPopupManager::"+I};var C=connect.makeEnum(["granted","denied","default"]);connect.NotificationManager=function(){this.queue=[],this.permission=C.DEFAULT},connect.NotificationManager.prototype.requestPermission=function(){var g=this;"Notification"in d?d.Notification.permission===C.DENIED?(connect.getLog().warn("The user has requested to not receive notifications.").sendInternalLogToServer(),this.permission=C.DENIED):this.permission!==C.GRANTED&&d.Notification.requestPermission().then(function(I){(g.permission=I)===C.GRANTED?g._showQueued():g.queue=[]}):(connect.getLog().warn("This browser doesn't support notifications.").sendInternalLogToServer(),this.permission=C.DENIED)},connect.NotificationManager.prototype.show=function(I,g){if(this.permission===C.GRANTED)return this._showImpl({title:I,options:g});this.permission===C.DENIED?connect.getLog().warn("Unable to show notification.").sendInternalLogToServer().withObject({title:I,options:g}):(g={title:I,options:g},connect.getLog().warn("Deferring notification until user decides to allow or deny.").withObject(g).sendInternalLogToServer(),this.queue.push(g))},connect.NotificationManager.prototype._showQueued=function(){var g=this,I=this.queue.map(function(I){return g._showImpl(I)});return this.queue=[],I},connect.NotificationManager.prototype._showImpl=function(I){var g=new d.Notification(I.title,I.options);return I.options.clicked&&(g.onclick=function(){I.options.clicked.call(g)}),g},connect.BaseError=function(I,g){d.Error.call(this,connect.vsprintf(I,g))},connect.BaseError.prototype=Object.create(Error.prototype),connect.BaseError.prototype.constructor=connect.BaseError,connect.ValueError=function(){var I=Array.prototype.slice.call(arguments,0),g=I.shift();connect.BaseError.call(this,g,I)},connect.ValueError.prototype=Object.create(connect.BaseError.prototype),connect.ValueError.prototype.constructor=connect.ValueError,connect.NotImplementedError=function(){var I=Array.prototype.slice.call(arguments,0),g=I.shift();connect.BaseError.call(this,g,I)},connect.NotImplementedError.prototype=Object.create(connect.BaseError.prototype),connect.NotImplementedError.prototype.constructor=connect.NotImplementedError,connect.StateError=function(){var I=Array.prototype.slice.call(arguments,0),g=I.shift();connect.BaseError.call(this,g,I)},connect.StateError.prototype=Object.create(connect.BaseError.prototype),connect.StateError.prototype.constructor=connect.StateError,connect.VoiceIdError=function(I,g,C){var A={};return A.type=I,A.message=g,A.stack=Error(g).stack,A.err=C,A},connect.isCCP=function(){return"ConnectSharedWorkerConduit"===connect.core.getUpstream().name}}(),function(){connect=this.connect||{},this.connect=connect,this.globalConnect={},this.lily=connect,globalConnect.Container=null;function I(I){this.region=I.region,this.id=this.region.replace(/-/g,"_"),this.height=I.height,this.style=I.iframe_style,this.ccp=this._createFramedCcp(JSON.stringify(I))}var g=window.atob("Ly8gQVdTIFNESyBmb3IgSmF2YVNjcmlwdCB2Mi41NTMuMAovLyBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KLy8gTGljZW5zZSBhdCBodHRwczovL3Nkay5hbWF6b25hd3MuY29tL2pzL0JVTkRMRV9MSUNFTlNFLnR4dAooZnVuY3Rpb24oKXtmdW5jdGlvbiByKGUsbix0KXtmdW5jdGlvbiBvKGksZil7aWYoIW5baV0pe2lmKCFlW2ldKXt2YXIgYz0iZnVuY3Rpb24iPT10eXBlb2YgcmVxdWlyZSYmcmVxdWlyZTtpZighZiYmYylyZXR1cm4gYyhpLCEwKTtpZih1KXJldHVybiB1KGksITApO3ZhciBhPW5ldyBFcnJvcigiQ2Fubm90IGZpbmQgbW9kdWxlICciK2krIiciKTt0aHJvdyBhLmNvZGU9Ik1PRFVMRV9OT1RfRk9VTkQiLGF9dmFyIHA9bltpXT17ZXhwb3J0czp7fX07ZVtpXVswXS5jYWxsKHAuZXhwb3J0cyxmdW5jdGlvbihyKXt2YXIgbj1lW2ldWzFdW3JdO3JldHVybiBvKG58fHIpfSxwLHAuZXhwb3J0cyxyLGUsbix0KX1yZXR1cm4gbltpXS5leHBvcnRzfWZvcih2YXIgdT0iZnVuY3Rpb24iPT10eXBlb2YgcmVxdWlyZSYmcmVxdWlyZSxpPTA7aTx0Lmxlbmd0aDtpKyspbyh0W2ldKTtyZXR1cm4gb31yZXR1cm4gcn0pKCkoezE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzPXsKICAgICJ2ZXJzaW9uIjogIjIuMCIsCiAgICAibWV0YWRhdGEiOiB7CiAgICAgICJhcGlWZXJzaW9uIjogIjIwMTQtMDYtMzAiLAogICAgICAiZW5kcG9pbnRQcmVmaXgiOiAiY29nbml0by1pZGVudGl0eSIsCiAgICAgICJqc29uVmVyc2lvbiI6ICIxLjEiLAogICAgICAicHJvdG9jb2wiOiAianNvbiIsCiAgICAgICJzZXJ2aWNlRnVsbE5hbWUiOiAiQW1hem9uIENvZ25pdG8gSWRlbnRpdHkiLAogICAgICAic2VydmljZUlkIjogIkNvZ25pdG8gSWRlbnRpdHkiLAogICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJ2NCIsCiAgICAgICJ0YXJnZXRQcmVmaXgiOiAiQVdTQ29nbml0b0lkZW50aXR5U2VydmljZSIsCiAgICAgICJ1aWQiOiAiY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwIgogICAgfSwKICAgICJvcGVyYXRpb25zIjogewogICAgICAiQ3JlYXRlSWRlbnRpdHlQb29sIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xOYW1lIiwKICAgICAgICAgICAgIkFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiOiB7fSwKICAgICAgICAgICAgIkFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiU3VwcG9ydGVkTG9naW5Qcm92aWRlcnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAgICJPcGVuSWRDb25uZWN0UHJvdmlkZXJBUk5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTOCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkNvZ25pdG9JZGVudGl0eVByb3ZpZGVycyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2EiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJTYW1sUHJvdmlkZXJBUk5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTZiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIklkZW50aXR5UG9vbFRhZ3MiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNnIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInNoYXBlIjogIlNqIgogICAgICAgIH0KICAgICAgfSwKICAgICAgIkRlbGV0ZUlkZW50aXRpZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWRzVG9EZWxldGUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkc1RvRGVsZXRlIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiVW5wcm9jZXNzZWRJZGVudGl0eUlkcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAgICAgICAiRXJyb3JDb2RlIjoge30KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJEZWxldGVJZGVudGl0eVBvb2wiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkRlc2NyaWJlSWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAic2hhcGUiOiAiU3UiCiAgICAgICAgfQogICAgICB9LAogICAgICAiRGVzY3JpYmVJZGVudGl0eVBvb2wiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTaiIKICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eUlkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTeiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkN1c3RvbVJvbGVBcm4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAiQWNjZXNzS2V5SWQiOiB7fSwKICAgICAgICAgICAgICAgICJTZWNyZXRLZXkiOiB7fSwKICAgICAgICAgICAgICAgICJTZXNzaW9uVG9rZW4iOiB7fSwKICAgICAgICAgICAgICAgICJFeHBpcmF0aW9uIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0SWQiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQWNjb3VudElkIjoge30sCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTeiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldElkZW50aXR5UG9vbFJvbGVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiUm9sZXMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMxYiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlJvbGVNYXBwaW5ncyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzFkIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0T3BlbklkVG9rZW4iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlN6IgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiVG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldE9wZW5JZFRva2VuRm9yRGV2ZWxvcGVySWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICAgIkxvZ2lucyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlN6IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiVG9rZW5EdXJhdGlvbiI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiVG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkxpc3RJZGVudGl0aWVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgICAgICJNYXhSZXN1bHRzIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICAgIk1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIk5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAiSGlkZURpc2FibGVkIjogewogICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiSWRlbnRpdGllcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlN1IgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTGlzdElkZW50aXR5UG9vbHMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIk1heFJlc3VsdHMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJNYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJOZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICAgICAgICJJZGVudGl0eVBvb2xOYW1lIjoge30KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJOZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkxpc3RUYWdzRm9yUmVzb3VyY2UiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJlc291cmNlQXJuIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUmVzb3VyY2VBcm4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlRhZ3MiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNnIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTG9va3VwRGV2ZWxvcGVySWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIkRldmVsb3BlclVzZXJJZGVudGlmaWVyIjoge30sCiAgICAgICAgICAgICJNYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJOZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIkRldmVsb3BlclVzZXJJZGVudGlmaWVyTGlzdCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTWVyZ2VEZXZlbG9wZXJJZGVudGl0aWVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJTb3VyY2VVc2VySWRlbnRpZmllciIsCiAgICAgICAgICAgICJEZXN0aW5hdGlvblVzZXJJZGVudGlmaWVyIiwKICAgICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSIsCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlNvdXJjZVVzZXJJZGVudGlmaWVyIjoge30sCiAgICAgICAgICAgICJEZXN0aW5hdGlvblVzZXJJZGVudGlmaWVyIjoge30sCiAgICAgICAgICAgICJEZXZlbG9wZXJQcm92aWRlck5hbWUiOiB7fSwKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTZXRJZGVudGl0eVBvb2xSb2xlcyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiLAogICAgICAgICAgICAiUm9sZXMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiUm9sZXMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMxYiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlJvbGVNYXBwaW5ncyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzFkIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVGFnUmVzb3VyY2UiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJlc291cmNlQXJuIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUmVzb3VyY2VBcm4iOiB7fSwKICAgICAgICAgICAgIlRhZ3MiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNnIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJVbmxpbmtEZXZlbG9wZXJJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlJZCIsCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgICAgICJEZXZlbG9wZXJQcm92aWRlck5hbWUiLAogICAgICAgICAgICAiRGV2ZWxvcGVyVXNlcklkZW50aWZpZXIiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAgICJEZXZlbG9wZXJVc2VySWRlbnRpZmllciI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVW5saW5rSWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWQiLAogICAgICAgICAgICAiTG9naW5zIiwKICAgICAgICAgICAgIkxvZ2luc1RvUmVtb3ZlIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTeiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkxvZ2luc1RvUmVtb3ZlIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTdiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlVudGFnUmVzb3VyY2UiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJlc291cmNlQXJuIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUmVzb3VyY2VBcm4iOiB7fSwKICAgICAgICAgICAgIlRhZ0tleXMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlVwZGF0ZUlkZW50aXR5UG9vbCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAic2hhcGUiOiAiU2oiCiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInNoYXBlIjogIlNqIgogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJzaGFwZXMiOiB7CiAgICAgICJTNCI6IHsKICAgICAgICAidHlwZSI6ICJtYXAiLAogICAgICAgICJrZXkiOiB7fSwKICAgICAgICAidmFsdWUiOiB7fQogICAgICB9LAogICAgICAiUzgiOiB7CiAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgIH0sCiAgICAgICJTYSI6IHsKICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAgICJDbGllbnRJZCI6IHt9LAogICAgICAgICAgICAiU2VydmVyU2lkZVRva2VuQ2hlY2siOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNmIjogewogICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICJtZW1iZXIiOiB7fQogICAgICB9LAogICAgICAiU2ciOiB7CiAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAia2V5Ijoge30sCiAgICAgICAgInZhbHVlIjoge30KICAgICAgfSwKICAgICAgIlNqIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICJJZGVudGl0eVBvb2xOYW1lIiwKICAgICAgICAgICJBbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiOiB7fSwKICAgICAgICAgICJBbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICB9LAogICAgICAgICAgIlN1cHBvcnRlZExvZ2luUHJvdmlkZXJzIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICB9LAogICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgIk9wZW5JZENvbm5lY3RQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTOCIKICAgICAgICAgIH0sCiAgICAgICAgICAiQ29nbml0b0lkZW50aXR5UHJvdmlkZXJzIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2EiCiAgICAgICAgICB9LAogICAgICAgICAgIlNhbWxQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTZiIKICAgICAgICAgIH0sCiAgICAgICAgICAiSWRlbnRpdHlQb29sVGFncyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNnIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlN1IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgIkxvZ2lucyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlN2IgogICAgICAgICAgfSwKICAgICAgICAgICJDcmVhdGlvbkRhdGUiOiB7CiAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgIH0sCiAgICAgICAgICAiTGFzdE1vZGlmaWVkRGF0ZSI6IHsKICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlN2IjogewogICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICJtZW1iZXIiOiB7fQogICAgICB9LAogICAgICAiU3oiOiB7CiAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAia2V5Ijoge30sCiAgICAgICAgInZhbHVlIjoge30KICAgICAgfSwKICAgICAgIlMxYiI6IHsKICAgICAgICAidHlwZSI6ICJtYXAiLAogICAgICAgICJrZXkiOiB7fSwKICAgICAgICAidmFsdWUiOiB7fQogICAgICB9LAogICAgICAiUzFkIjogewogICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgImtleSI6IHt9LAogICAgICAgICJ2YWx1ZSI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJUeXBlIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiVHlwZSI6IHt9LAogICAgICAgICAgICAiQW1iaWd1b3VzUm9sZVJlc29sdXRpb24iOiB7fSwKICAgICAgICAgICAgIlJ1bGVzQ29uZmlndXJhdGlvbiI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICJSdWxlcyIKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgIlJ1bGVzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICJDbGFpbSIsCiAgICAgICAgICAgICAgICAgICAgICAiTWF0Y2hUeXBlIiwKICAgICAgICAgICAgICAgICAgICAgICJWYWx1ZSIsCiAgICAgICAgICAgICAgICAgICAgICAiUm9sZUFSTiIKICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgIkNsYWltIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAiTWF0Y2hUeXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAiVmFsdWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJSb2xlQVJOIjoge30KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgfSx7fV0sMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHM9ewogICAgInBhZ2luYXRpb24iOiB7CiAgICB9CiAgfQogIAogIH0se31dLDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzPXsKICAgICJ2ZXJzaW9uIjogIjIuMCIsCiAgICAibWV0YWRhdGEiOiB7CiAgICAgICJhcGlWZXJzaW9uIjogIjIwMTctMDItMTUiLAogICAgICAiZW5kcG9pbnRQcmVmaXgiOiAiY29ubmVjdCIsCiAgICAgICJqc29uVmVyc2lvbiI6ICIxLjAiLAogICAgICAicHJvdG9jb2wiOiAianNvbiIsCiAgICAgICJzZXJ2aWNlQWJicmV2aWF0aW9uIjogIkNvbm5lY3QiLAogICAgICAic2VydmljZUZ1bGxOYW1lIjogIkFtYXpvbkNvbm5lY3RDVElTZXJ2aWNlIiwKICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAiIiwKICAgICAgInRhcmdldFByZWZpeCI6ICJBbWF6b25Db25uZWN0Q1RJU2VydmljZSIsCiAgICAgICJ1aWQiOiAiY29ubmVjdC0yMDE3LTAyLTE1IgogICAgfSwKICAgICJvcGVyYXRpb25zIjogewogICAgICAiQWNjZXB0Q29udGFjdCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNsZWFyQ29udGFjdCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiY29udGFjdElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNvbXBsZXRlQ29udGFjdCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiY29udGFjdElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNvbmZlcmVuY2VDb25uZWN0aW9ucyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNyZWF0ZUFkZGl0aW9uYWxDb25uZWN0aW9uIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiZW5kcG9pbnQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImVuZHBvaW50IjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQ3JlYXRlT3V0Ym91bmRDb250YWN0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJlbmRwb2ludCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImVuZHBvaW50IjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInF1ZXVlQVJOIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNyZWF0ZVRhc2tDb250YWN0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJlbmRwb2ludCIsCiAgICAgICAgICAgICJuYW1lIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiZW5kcG9pbnQiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNlIgogICAgICAgICAgICB9LAogICAgICAgICAgICAicHJldmlvdXNDb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICAgImRlc2NyaXB0aW9uIjoge30sCiAgICAgICAgICAgICJyZWZlcmVuY2VzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInNjaGVkdWxlZFRpbWUiOiB7fSwKICAgICAgICAgICAgImlkZW1wb3RlbmN5VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQ3JlYXRlVHJhbnNwb3J0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJ0cmFuc3BvcnRUeXBlIiwKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAidHJhbnNwb3J0VHlwZSI6IHt9LAogICAgICAgICAgICAicGFydGljaXBhbnRJZCI6IHt9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICJzb2Z0cGhvbmVDbGllbnRJZCI6IHt9LAogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAid2ViU29ja2V0VHJhbnNwb3J0IjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgInVybCIsCiAgICAgICAgICAgICAgICAidHJhbnNwb3J0TGlmZVRpbWVJblNlY29uZHMiCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJ1cmwiOiB7fSwKICAgICAgICAgICAgICAgICJ0cmFuc3BvcnRMaWZlVGltZUluU2Vjb25kcyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiZXhwaXJ5Ijoge30KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjaGF0VG9rZW5UcmFuc3BvcnQiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAicGFydGljaXBhbnRUb2tlbiIsCiAgICAgICAgICAgICAgICAiZXhwaXJ5IgogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAicGFydGljaXBhbnRUb2tlbiI6IHt9LAogICAgICAgICAgICAgICAgImV4cGlyeSI6IHt9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAic29mdHBob25lVHJhbnNwb3J0IjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgInNvZnRwaG9uZU1lZGlhQ29ubmVjdGlvbnMiCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJzb2Z0cGhvbmVNZWRpYUNvbm5lY3Rpb25zIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICJ1c2VybmFtZSIsCiAgICAgICAgICAgICAgICAgICAgICAiY3JlZGVudGlhbCIsCiAgICAgICAgICAgICAgICAgICAgICAidXJscyIKICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgInVzZXJuYW1lIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAiY3JlZGVudGlhbCI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgInVybHMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJEZXN0cm95Q29ubmVjdGlvbiI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldEFnZW50Q29uZmlndXJhdGlvbiI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiY29uZmlndXJhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImNvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMxaCIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldEFnZW50UGVybWlzc2lvbnMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30sCiAgICAgICAgICAgICJtYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAicGVybWlzc2lvbnMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJwZXJtaXNzaW9ucyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0QWdlbnRTbmFwc2hvdCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgInRpbWVvdXQiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJzbmFwc2hvdCIsCiAgICAgICAgICAgICJuZXh0VG9rZW4iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJzbmFwc2hvdCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICJzdGF0ZSIsCiAgICAgICAgICAgICAgICAiY29udGFjdHMiLAogICAgICAgICAgICAgICAgInNuYXBzaG90VGltZXN0YW1wIgogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAic3RhdGUiOiB7CiAgICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTMXoiCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgIm5leHRTdGF0ZSI6IHsKICAgICAgICAgICAgICAgICAgInNoYXBlIjogIlMxeiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiYWdlbnRBdmFpbGFiaWxpdHlTdGF0ZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgInN0YXRlIjoge30sCiAgICAgICAgICAgICAgICAgICAgInRpbWVTdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiY29udGFjdHMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICAgICAgICAgICAidHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAic3RhdGUiLAogICAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25zIiwKICAgICAgICAgICAgICAgICAgICAgICJhdHRyaWJ1dGVzIgogICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAiaW5pdGlhbENvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgImNvbnRhY3RGZWF0dXJlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgImF0dGFjaG1lbnRzRW5hYmxlZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJzdGF0ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgInF1ZXVlIjogewogICAgICAgICAgICAgICAgICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgInF1ZXVlVGltZXN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25zIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjb25uZWN0aW9uSWQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXRlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpbml0aWFsIgogICAgICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZW5kcG9pbnQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaW5pdGlhbCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic29mdHBob25lTWVkaWFJbmZvIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2FsbFR5cGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYXV0b0FjY2VwdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVkaWFMZWdDb250ZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2FsbENvbnRleHRUb2tlbiI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjYWxsQ29uZmlnSnNvbiI6IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2hhdE1lZGlhSW5mbyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNoYXRBdXRvQWNjZXB0IjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjb25uZWN0aW9uRGF0YSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjdXN0b21lck5hbWUiOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1vbml0b3JpbmdJbmZvIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYWdlbnQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJhZ2VudE5hbWUiOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImpvaW5UaW1lU3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgImF0dHJpYnV0ZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJrZXkiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgInZhbHVlIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiCiAgICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICJjb250YWN0RHVyYXRpb24iOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJyZWZlcmVuY2VzIjogewogICAgICAgICAgICAgICAgICAgICAgICAic2hhcGUiOiAiU3IiCiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgImluaXRpYXRpb25NZXRob2QiOiB7fQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJzbmFwc2hvdFRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0QWdlbnRTdGF0ZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30sCiAgICAgICAgICAgICJtYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAic3RhdGVzIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAic3RhdGVzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAic2hhcGUiOiAiUzF6IgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0RGlhbGFibGVDb3VudHJ5Q29kZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30sCiAgICAgICAgICAgICJtYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiY291bnRyeUNvZGVzIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiY291bnRyeUNvZGVzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRFbmRwb2ludHMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgInF1ZXVlQVJOcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInF1ZXVlQVJOcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiZW5kcG9pbnRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAic2hhcGUiOiAiU2UiCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXROZXdBdXRoVG9rZW4iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgInJlZnJlc2hUb2tlbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInJlZnJlc2hUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAibmV3QXV0aFRva2VuIjoge30sCiAgICAgICAgICAgICJleHBpcmF0aW9uRGF0ZVRpbWUiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0Um91dGluZ1Byb2ZpbGVRdWV1ZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgInJvdXRpbmdQcm9maWxlQVJOIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAicm91dGluZ1Byb2ZpbGVBUk4iOiB7fSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgInF1ZXVlcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgInF1ZXVlcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlNrIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiSG9sZENvbm5lY3Rpb24iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJOb3RpZnlDb250YWN0SXNzdWUiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiaXNzdWVDb2RlIjoge30sCiAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6IHt9LAogICAgICAgICAgICAiY2xpZW50TG9ncyI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJQdXRBZ2VudFN0YXRlIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJzdGF0ZSIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInN0YXRlIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMXoiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJlbnF1ZXVlTmV4dFN0YXRlIjogewogICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlJlamVjdENvbnRhY3QiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJSZXN1bWVDb25uZWN0aW9uIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2VuZENsaWVudExvZ3MiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImxvZ0V2ZW50cyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImxvZ0V2ZW50cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgImNvbXBvbmVudCI6IHt9LAogICAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHt9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTZW5kRGlnaXRzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiY29ubmVjdGlvbklkIiwKICAgICAgICAgICAgImRpZ2l0cyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30sCiAgICAgICAgICAgICJkaWdpdHMiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2VuZFNvZnRwaG9uZUNhbGxNZXRyaWNzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAic29mdHBob25lU3RyZWFtU3RhdGlzdGljcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY2NwVmVyc2lvbiI6IHt9LAogICAgICAgICAgICAic29mdHBob25lU3RyZWFtU3RhdGlzdGljcyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzNuIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTZW5kU29mdHBob25lQ2FsbFJlcG9ydCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgInJlcG9ydCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY2NwVmVyc2lvbiI6IHt9LAogICAgICAgICAgICAicmVwb3J0IjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAiY2FsbFN0YXJ0VGltZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJjYWxsRW5kVGltZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzIjogewogICAgICAgICAgICAgICAgICAic2hhcGUiOiAiUzNuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJndW1UaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJpbml0aWFsaXphdGlvblRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImljZUNvbGxlY3Rpb25UaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJzaWduYWxsaW5nQ29ubmVjdFRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImhhbmRzaGFrZVRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgInByZVRhbGtUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJ0YWxrVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiY2xlYW51cFRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImljZUNvbGxlY3Rpb25GYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJzaWduYWxsaW5nQ29ubmVjdGlvbkZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImhhbmRzaGFrZUZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImd1bU90aGVyRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiZ3VtVGltZW91dEZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImNyZWF0ZU9mZmVyRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic2V0TG9jYWxEZXNjcmlwdGlvbkZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgInVzZXJCdXN5RmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiaW52YWxpZFJlbW90ZVNEUEZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgIm5vUmVtb3RlSWNlQ2FuZGlkYXRlRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic2V0UmVtb3RlRGVzY3JpcHRpb25GYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVG9nZ2xlQWN0aXZlQ29ubmVjdGlvbnMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJVcGRhdGVBZ2VudENvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbmZpZ3VyYXRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb25maWd1cmF0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMWgiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJzaGFwZXMiOiB7CiAgICAgICJTMiI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImFnZW50QVJOIjoge30sCiAgICAgICAgICAiYXV0aFRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTZSI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJ0eXBlIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiZW5kcG9pbnRBUk4iOiB7fSwKICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICAgInBob25lTnVtYmVyIjoge30sCiAgICAgICAgICAiYWdlbnRMb2dpbiI6IHt9LAogICAgICAgICAgInF1ZXVlIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2siOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJxdWV1ZUFSTiI6IHt9LAogICAgICAgICAgIm5hbWUiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNyIjogewogICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgImtleSI6IHt9LAogICAgICAgICJ2YWx1ZSI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJ2YWx1ZSIsCiAgICAgICAgICAgICJ0eXBlIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAidmFsdWUiOiB7fSwKICAgICAgICAgICAgInR5cGUiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlMxaCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJuYW1lIiwKICAgICAgICAgICJzb2Z0cGhvbmVFbmFibGVkIiwKICAgICAgICAgICJzb2Z0cGhvbmVBdXRvQWNjZXB0IiwKICAgICAgICAgICJleHRlbnNpb24iLAogICAgICAgICAgInJvdXRpbmdQcm9maWxlIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICAgInVzZXJuYW1lIjoge30sCiAgICAgICAgICAic29mdHBob25lRW5hYmxlZCI6IHsKICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgIH0sCiAgICAgICAgICAic29mdHBob25lQXV0b0FjY2VwdCI6IHsKICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgIH0sCiAgICAgICAgICAiZXh0ZW5zaW9uIjoge30sCiAgICAgICAgICAicm91dGluZ1Byb2ZpbGUiOiB7CiAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAgICAgInJvdXRpbmdQcm9maWxlQVJOIjoge30sCiAgICAgICAgICAgICAgImRlZmF1bHRPdXRib3VuZFF1ZXVlIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlNrIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImNoYW5uZWxDb25jdXJyZW5jeU1hcCI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgICAgICAgICAia2V5Ijoge30sCiAgICAgICAgICAgICAgICAidmFsdWUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgImFnZW50UHJlZmVyZW5jZXMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgICAgICJrZXkiOiB7fSwKICAgICAgICAgICAgInZhbHVlIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTMXoiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAidHlwZSIsCiAgICAgICAgICAibmFtZSIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImFnZW50U3RhdGVBUk4iOiB7fSwKICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICAgInN0YXJ0VGltZXN0YW1wIjogewogICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiUzNuIjogewogICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJ0aW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICB9LAogICAgICAgICAgICAic29mdHBob25lU3RyZWFtVHlwZSI6IHt9LAogICAgICAgICAgICAicGFja2V0Q291bnQiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInBhY2tldHNMb3N0IjogewogICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJhdWRpb0xldmVsIjogewogICAgICAgICAgICAgICJ0eXBlIjogImRvdWJsZSIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImppdHRlckJ1ZmZlck1pbGxpcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9LAogICAgICAgICAgICAicm91bmRUcmlwVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIH0se31dLDQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzPXsKICAgICJhY20iOiB7CiAgICAgICJuYW1lIjogIkFDTSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJhcGlnYXRld2F5IjogewogICAgICAibmFtZSI6ICJBUElHYXRld2F5IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFwcGxpY2F0aW9uYXV0b3NjYWxpbmciOiB7CiAgICAgICJwcmVmaXgiOiAiYXBwbGljYXRpb24tYXV0b3NjYWxpbmciLAogICAgICAibmFtZSI6ICJBcHBsaWNhdGlvbkF1dG9TY2FsaW5nIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFwcHN0cmVhbSI6IHsKICAgICAgIm5hbWUiOiAiQXBwU3RyZWFtIgogICAgfSwKICAgICJhdXRvc2NhbGluZyI6IHsKICAgICAgIm5hbWUiOiAiQXV0b1NjYWxpbmciLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiYmF0Y2giOiB7CiAgICAgICJuYW1lIjogIkJhdGNoIgogICAgfSwKICAgICJidWRnZXRzIjogewogICAgICAibmFtZSI6ICJCdWRnZXRzIgogICAgfSwKICAgICJjbG91ZGRpcmVjdG9yeSI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWREaXJlY3RvcnkiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTYtMDUtMTAqIgogICAgICBdCiAgICB9LAogICAgImNsb3VkZm9ybWF0aW9uIjogewogICAgICAibmFtZSI6ICJDbG91ZEZvcm1hdGlvbiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjbG91ZGZyb250IjogewogICAgICAibmFtZSI6ICJDbG91ZEZyb250IiwKICAgICAgInZlcnNpb25zIjogWwogICAgICAgICIyMDEzLTA1LTEyKiIsCiAgICAgICAgIjIwMTMtMTEtMTEqIiwKICAgICAgICAiMjAxNC0wNS0zMSoiLAogICAgICAgICIyMDE0LTEwLTIxKiIsCiAgICAgICAgIjIwMTQtMTEtMDYqIiwKICAgICAgICAiMjAxNS0wNC0xNyoiLAogICAgICAgICIyMDE1LTA3LTI3KiIsCiAgICAgICAgIjIwMTUtMDktMTcqIiwKICAgICAgICAiMjAxNi0wMS0xMyoiLAogICAgICAgICIyMDE2LTAxLTI4KiIsCiAgICAgICAgIjIwMTYtMDgtMDEqIiwKICAgICAgICAiMjAxNi0wOC0yMCoiLAogICAgICAgICIyMDE2LTA5LTA3KiIsCiAgICAgICAgIjIwMTYtMDktMjkqIiwKICAgICAgICAiMjAxNi0xMS0yNSoiLAogICAgICAgICIyMDE3LTAzLTI1KiIsCiAgICAgICAgIjIwMTctMTAtMzAqIiwKICAgICAgICAiMjAxOC0wNi0xOCoiLAogICAgICAgICIyMDE4LTExLTA1KiIKICAgICAgXSwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNsb3VkaHNtIjogewogICAgICAibmFtZSI6ICJDbG91ZEhTTSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjbG91ZHNlYXJjaCI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWRTZWFyY2giCiAgICB9LAogICAgImNsb3Vkc2VhcmNoZG9tYWluIjogewogICAgICAibmFtZSI6ICJDbG91ZFNlYXJjaERvbWFpbiIKICAgIH0sCiAgICAiY2xvdWR0cmFpbCI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWRUcmFpbCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjbG91ZHdhdGNoIjogewogICAgICAicHJlZml4IjogIm1vbml0b3JpbmciLAogICAgICAibmFtZSI6ICJDbG91ZFdhdGNoIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNsb3Vkd2F0Y2hldmVudHMiOiB7CiAgICAgICJwcmVmaXgiOiAiZXZlbnRzIiwKICAgICAgIm5hbWUiOiAiQ2xvdWRXYXRjaEV2ZW50cyIsCiAgICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgICAiMjAxNC0wMi0wMyoiCiAgICAgIF0sCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjbG91ZHdhdGNobG9ncyI6IHsKICAgICAgInByZWZpeCI6ICJsb2dzIiwKICAgICAgIm5hbWUiOiAiQ2xvdWRXYXRjaExvZ3MiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29kZWJ1aWxkIjogewogICAgICAibmFtZSI6ICJDb2RlQnVpbGQiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29kZWNvbW1pdCI6IHsKICAgICAgIm5hbWUiOiAiQ29kZUNvbW1pdCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb2RlZGVwbG95IjogewogICAgICAibmFtZSI6ICJDb2RlRGVwbG95IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvZGVwaXBlbGluZSI6IHsKICAgICAgIm5hbWUiOiAiQ29kZVBpcGVsaW5lIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvZ25pdG9pZGVudGl0eSI6IHsKICAgICAgInByZWZpeCI6ICJjb2duaXRvLWlkZW50aXR5IiwKICAgICAgIm5hbWUiOiAiQ29nbml0b0lkZW50aXR5IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvZ25pdG9pZGVudGl0eXNlcnZpY2Vwcm92aWRlciI6IHsKICAgICAgInByZWZpeCI6ICJjb2duaXRvLWlkcCIsCiAgICAgICJuYW1lIjogIkNvZ25pdG9JZGVudGl0eVNlcnZpY2VQcm92aWRlciIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb2duaXRvc3luYyI6IHsKICAgICAgInByZWZpeCI6ICJjb2duaXRvLXN5bmMiLAogICAgICAibmFtZSI6ICJDb2duaXRvU3luYyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb25maWdzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogImNvbmZpZyIsCiAgICAgICJuYW1lIjogIkNvbmZpZ1NlcnZpY2UiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY3VyIjogewogICAgICAibmFtZSI6ICJDVVIiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZGF0YXBpcGVsaW5lIjogewogICAgICAibmFtZSI6ICJEYXRhUGlwZWxpbmUiCiAgICB9LAogICAgImRldmljZWZhcm0iOiB7CiAgICAgICJuYW1lIjogIkRldmljZUZhcm0iLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZGlyZWN0Y29ubmVjdCI6IHsKICAgICAgIm5hbWUiOiAiRGlyZWN0Q29ubmVjdCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJkaXJlY3RvcnlzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogImRzIiwKICAgICAgIm5hbWUiOiAiRGlyZWN0b3J5U2VydmljZSIKICAgIH0sCiAgICAiZGlzY292ZXJ5IjogewogICAgICAibmFtZSI6ICJEaXNjb3ZlcnkiCiAgICB9LAogICAgImRtcyI6IHsKICAgICAgIm5hbWUiOiAiRE1TIgogICAgfSwKICAgICJkeW5hbW9kYiI6IHsKICAgICAgIm5hbWUiOiAiRHluYW1vREIiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZHluYW1vZGJzdHJlYW1zIjogewogICAgICAicHJlZml4IjogInN0cmVhbXMuZHluYW1vZGIiLAogICAgICAibmFtZSI6ICJEeW5hbW9EQlN0cmVhbXMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZWMyIjogewogICAgICAibmFtZSI6ICJFQzIiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTMtMDYtMTUqIiwKICAgICAgICAiMjAxMy0xMC0xNSoiLAogICAgICAgICIyMDE0LTAyLTAxKiIsCiAgICAgICAgIjIwMTQtMDUtMDEqIiwKICAgICAgICAiMjAxNC0wNi0xNSoiLAogICAgICAgICIyMDE0LTA5LTAxKiIsCiAgICAgICAgIjIwMTQtMTAtMDEqIiwKICAgICAgICAiMjAxNS0wMy0wMSoiLAogICAgICAgICIyMDE1LTA0LTE1KiIsCiAgICAgICAgIjIwMTUtMTAtMDEqIiwKICAgICAgICAiMjAxNi0wNC0wMSoiLAogICAgICAgICIyMDE2LTA5LTE1KiIKICAgICAgXSwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVjciI6IHsKICAgICAgIm5hbWUiOiAiRUNSIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVjcyI6IHsKICAgICAgIm5hbWUiOiAiRUNTIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVmcyI6IHsKICAgICAgInByZWZpeCI6ICJlbGFzdGljZmlsZXN5c3RlbSIsCiAgICAgICJuYW1lIjogIkVGUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlbGFzdGljYWNoZSI6IHsKICAgICAgIm5hbWUiOiAiRWxhc3RpQ2FjaGUiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTItMTEtMTUqIiwKICAgICAgICAiMjAxNC0wMy0yNCoiLAogICAgICAgICIyMDE0LTA3LTE1KiIsCiAgICAgICAgIjIwMTQtMDktMzAqIgogICAgICBdLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZWxhc3RpY2JlYW5zdGFsayI6IHsKICAgICAgIm5hbWUiOiAiRWxhc3RpY0JlYW5zdGFsayIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlbGIiOiB7CiAgICAgICJwcmVmaXgiOiAiZWxhc3RpY2xvYWRiYWxhbmNpbmciLAogICAgICAibmFtZSI6ICJFTEIiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZWxidjIiOiB7CiAgICAgICJwcmVmaXgiOiAiZWxhc3RpY2xvYWRiYWxhbmNpbmd2MiIsCiAgICAgICJuYW1lIjogIkVMQnYyIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVtciI6IHsKICAgICAgInByZWZpeCI6ICJlbGFzdGljbWFwcmVkdWNlIiwKICAgICAgIm5hbWUiOiAiRU1SIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVzIjogewogICAgICAibmFtZSI6ICJFUyIKICAgIH0sCiAgICAiZWxhc3RpY3RyYW5zY29kZXIiOiB7CiAgICAgICJuYW1lIjogIkVsYXN0aWNUcmFuc2NvZGVyIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImZpcmVob3NlIjogewogICAgICAibmFtZSI6ICJGaXJlaG9zZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJnYW1lbGlmdCI6IHsKICAgICAgIm5hbWUiOiAiR2FtZUxpZnQiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZ2xhY2llciI6IHsKICAgICAgIm5hbWUiOiAiR2xhY2llciIKICAgIH0sCiAgICAiaGVhbHRoIjogewogICAgICAibmFtZSI6ICJIZWFsdGgiCiAgICB9LAogICAgImlhbSI6IHsKICAgICAgIm5hbWUiOiAiSUFNIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImltcG9ydGV4cG9ydCI6IHsKICAgICAgIm5hbWUiOiAiSW1wb3J0RXhwb3J0IgogICAgfSwKICAgICJpbnNwZWN0b3IiOiB7CiAgICAgICJuYW1lIjogIkluc3BlY3RvciIsCiAgICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgICAiMjAxNS0wOC0xOCoiCiAgICAgIF0sCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJpb3QiOiB7CiAgICAgICJuYW1lIjogIklvdCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJpb3RkYXRhIjogewogICAgICAicHJlZml4IjogImlvdC1kYXRhIiwKICAgICAgIm5hbWUiOiAiSW90RGF0YSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJraW5lc2lzIjogewogICAgICAibmFtZSI6ICJLaW5lc2lzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImtpbmVzaXNhbmFseXRpY3MiOiB7CiAgICAgICJuYW1lIjogIktpbmVzaXNBbmFseXRpY3MiCiAgICB9LAogICAgImttcyI6IHsKICAgICAgIm5hbWUiOiAiS01TIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImxhbWJkYSI6IHsKICAgICAgIm5hbWUiOiAiTGFtYmRhIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImxleHJ1bnRpbWUiOiB7CiAgICAgICJwcmVmaXgiOiAicnVudGltZS5sZXgiLAogICAgICAibmFtZSI6ICJMZXhSdW50aW1lIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImxpZ2h0c2FpbCI6IHsKICAgICAgIm5hbWUiOiAiTGlnaHRzYWlsIgogICAgfSwKICAgICJtYWNoaW5lbGVhcm5pbmciOiB7CiAgICAgICJuYW1lIjogIk1hY2hpbmVMZWFybmluZyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJtYXJrZXRwbGFjZWNvbW1lcmNlYW5hbHl0aWNzIjogewogICAgICAibmFtZSI6ICJNYXJrZXRwbGFjZUNvbW1lcmNlQW5hbHl0aWNzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIm1hcmtldHBsYWNlbWV0ZXJpbmciOiB7CiAgICAgICJwcmVmaXgiOiAibWV0ZXJpbmdtYXJrZXRwbGFjZSIsCiAgICAgICJuYW1lIjogIk1hcmtldHBsYWNlTWV0ZXJpbmciCiAgICB9LAogICAgIm10dXJrIjogewogICAgICAicHJlZml4IjogIm10dXJrLXJlcXVlc3RlciIsCiAgICAgICJuYW1lIjogIk1UdXJrIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIm1vYmlsZWFuYWx5dGljcyI6IHsKICAgICAgIm5hbWUiOiAiTW9iaWxlQW5hbHl0aWNzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIm9wc3dvcmtzIjogewogICAgICAibmFtZSI6ICJPcHNXb3JrcyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJvcHN3b3Jrc2NtIjogewogICAgICAibmFtZSI6ICJPcHNXb3Jrc0NNIgogICAgfSwKICAgICJvcmdhbml6YXRpb25zIjogewogICAgICAibmFtZSI6ICJPcmdhbml6YXRpb25zIgogICAgfSwKICAgICJwaW5wb2ludCI6IHsKICAgICAgIm5hbWUiOiAiUGlucG9pbnQiCiAgICB9LAogICAgInBvbGx5IjogewogICAgICAibmFtZSI6ICJQb2xseSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJyZHMiOiB7CiAgICAgICJuYW1lIjogIlJEUyIsCiAgICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgICAiMjAxNC0wOS0wMSoiCiAgICAgIF0sCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJyZWRzaGlmdCI6IHsKICAgICAgIm5hbWUiOiAiUmVkc2hpZnQiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAicmVrb2duaXRpb24iOiB7CiAgICAgICJuYW1lIjogIlJla29nbml0aW9uIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInJlc291cmNlZ3JvdXBzdGFnZ2luZ2FwaSI6IHsKICAgICAgIm5hbWUiOiAiUmVzb3VyY2VHcm91cHNUYWdnaW5nQVBJIgogICAgfSwKICAgICJyb3V0ZTUzIjogewogICAgICAibmFtZSI6ICJSb3V0ZTUzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInJvdXRlNTNkb21haW5zIjogewogICAgICAibmFtZSI6ICJSb3V0ZTUzRG9tYWlucyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzMyI6IHsKICAgICAgIm5hbWUiOiAiUzMiLAogICAgICAiZHVhbHN0YWNrQXZhaWxhYmxlIjogdHJ1ZSwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInMzY29udHJvbCI6IHsKICAgICAgIm5hbWUiOiAiUzNDb250cm9sIiwKICAgICAgImR1YWxzdGFja0F2YWlsYWJsZSI6IHRydWUKICAgIH0sCiAgICAic2VydmljZWNhdGFsb2ciOiB7CiAgICAgICJuYW1lIjogIlNlcnZpY2VDYXRhbG9nIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInNlcyI6IHsKICAgICAgInByZWZpeCI6ICJlbWFpbCIsCiAgICAgICJuYW1lIjogIlNFUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzaGllbGQiOiB7CiAgICAgICJuYW1lIjogIlNoaWVsZCIKICAgIH0sCiAgICAic2ltcGxlZGIiOiB7CiAgICAgICJwcmVmaXgiOiAic2RiIiwKICAgICAgIm5hbWUiOiAiU2ltcGxlREIiCiAgICB9LAogICAgInNtcyI6IHsKICAgICAgIm5hbWUiOiAiU01TIgogICAgfSwKICAgICJzbm93YmFsbCI6IHsKICAgICAgIm5hbWUiOiAiU25vd2JhbGwiCiAgICB9LAogICAgInNucyI6IHsKICAgICAgIm5hbWUiOiAiU05TIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInNxcyI6IHsKICAgICAgIm5hbWUiOiAiU1FTIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInNzbSI6IHsKICAgICAgIm5hbWUiOiAiU1NNIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInN0b3JhZ2VnYXRld2F5IjogewogICAgICAibmFtZSI6ICJTdG9yYWdlR2F0ZXdheSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzdGVwZnVuY3Rpb25zIjogewogICAgICAicHJlZml4IjogInN0YXRlcyIsCiAgICAgICJuYW1lIjogIlN0ZXBGdW5jdGlvbnMiCiAgICB9LAogICAgInN0cyI6IHsKICAgICAgIm5hbWUiOiAiU1RTIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInN1cHBvcnQiOiB7CiAgICAgICJuYW1lIjogIlN1cHBvcnQiCiAgICB9LAogICAgInN3ZiI6IHsKICAgICAgIm5hbWUiOiAiU1dGIgogICAgfSwKICAgICJ4cmF5IjogewogICAgICAibmFtZSI6ICJYUmF5IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIndhZiI6IHsKICAgICAgIm5hbWUiOiAiV0FGIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIndhZnJlZ2lvbmFsIjogewogICAgICAicHJlZml4IjogIndhZi1yZWdpb25hbCIsCiAgICAgICJuYW1lIjogIldBRlJlZ2lvbmFsIgogICAgfSwKICAgICJ3b3JrZG9jcyI6IHsKICAgICAgIm5hbWUiOiAiV29ya0RvY3MiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAid29ya3NwYWNlcyI6IHsKICAgICAgIm5hbWUiOiAiV29ya1NwYWNlcyIKICAgIH0sCiAgICAiY29kZXN0YXIiOiB7CiAgICAgICJuYW1lIjogIkNvZGVTdGFyIgogICAgfSwKICAgICJsZXhtb2RlbGJ1aWxkaW5nc2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJsZXgtbW9kZWxzIiwKICAgICAgIm5hbWUiOiAiTGV4TW9kZWxCdWlsZGluZ1NlcnZpY2UiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAibWFya2V0cGxhY2VlbnRpdGxlbWVudHNlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAiZW50aXRsZW1lbnQubWFya2V0cGxhY2UiLAogICAgICAibmFtZSI6ICJNYXJrZXRwbGFjZUVudGl0bGVtZW50U2VydmljZSIKICAgIH0sCiAgICAiYXRoZW5hIjogewogICAgICAibmFtZSI6ICJBdGhlbmEiCiAgICB9LAogICAgImdyZWVuZ3Jhc3MiOiB7CiAgICAgICJuYW1lIjogIkdyZWVuZ3Jhc3MiCiAgICB9LAogICAgImRheCI6IHsKICAgICAgIm5hbWUiOiAiREFYIgogICAgfSwKICAgICJtaWdyYXRpb25odWIiOiB7CiAgICAgICJwcmVmaXgiOiAiQVdTTWlncmF0aW9uSHViIiwKICAgICAgIm5hbWUiOiAiTWlncmF0aW9uSHViIgogICAgfSwKICAgICJjbG91ZGhzbXYyIjogewogICAgICAibmFtZSI6ICJDbG91ZEhTTVYyIgogICAgfSwKICAgICJnbHVlIjogewogICAgICAibmFtZSI6ICJHbHVlIgogICAgfSwKICAgICJtb2JpbGUiOiB7CiAgICAgICJuYW1lIjogIk1vYmlsZSIKICAgIH0sCiAgICAicHJpY2luZyI6IHsKICAgICAgIm5hbWUiOiAiUHJpY2luZyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb3N0ZXhwbG9yZXIiOiB7CiAgICAgICJwcmVmaXgiOiAiY2UiLAogICAgICAibmFtZSI6ICJDb3N0RXhwbG9yZXIiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAibWVkaWFjb252ZXJ0IjogewogICAgICAibmFtZSI6ICJNZWRpYUNvbnZlcnQiCiAgICB9LAogICAgIm1lZGlhbGl2ZSI6IHsKICAgICAgIm5hbWUiOiAiTWVkaWFMaXZlIgogICAgfSwKICAgICJtZWRpYXBhY2thZ2UiOiB7CiAgICAgICJuYW1lIjogIk1lZGlhUGFja2FnZSIKICAgIH0sCiAgICAibWVkaWFzdG9yZSI6IHsKICAgICAgIm5hbWUiOiAiTWVkaWFTdG9yZSIKICAgIH0sCiAgICAibWVkaWFzdG9yZWRhdGEiOiB7CiAgICAgICJwcmVmaXgiOiAibWVkaWFzdG9yZS1kYXRhIiwKICAgICAgIm5hbWUiOiAiTWVkaWFTdG9yZURhdGEiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiYXBwc3luYyI6IHsKICAgICAgIm5hbWUiOiAiQXBwU3luYyIKICAgIH0sCiAgICAiZ3VhcmRkdXR5IjogewogICAgICAibmFtZSI6ICJHdWFyZER1dHkiCiAgICB9LAogICAgIm1xIjogewogICAgICAibmFtZSI6ICJNUSIKICAgIH0sCiAgICAiY29tcHJlaGVuZCI6IHsKICAgICAgIm5hbWUiOiAiQ29tcHJlaGVuZCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJpb3Rqb2JzZGF0YXBsYW5lIjogewogICAgICAicHJlZml4IjogImlvdC1qb2JzLWRhdGEiLAogICAgICAibmFtZSI6ICJJb1RKb2JzRGF0YVBsYW5lIgogICAgfSwKICAgICJraW5lc2lzdmlkZW9hcmNoaXZlZG1lZGlhIjogewogICAgICAicHJlZml4IjogImtpbmVzaXMtdmlkZW8tYXJjaGl2ZWQtbWVkaWEiLAogICAgICAibmFtZSI6ICJLaW5lc2lzVmlkZW9BcmNoaXZlZE1lZGlhIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImtpbmVzaXN2aWRlb21lZGlhIjogewogICAgICAicHJlZml4IjogImtpbmVzaXMtdmlkZW8tbWVkaWEiLAogICAgICAibmFtZSI6ICJLaW5lc2lzVmlkZW9NZWRpYSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJraW5lc2lzdmlkZW8iOiB7CiAgICAgICJuYW1lIjogIktpbmVzaXNWaWRlbyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzYWdlbWFrZXJydW50aW1lIjogewogICAgICAicHJlZml4IjogInJ1bnRpbWUuc2FnZW1ha2VyIiwKICAgICAgIm5hbWUiOiAiU2FnZU1ha2VyUnVudGltZSIKICAgIH0sCiAgICAic2FnZW1ha2VyIjogewogICAgICAibmFtZSI6ICJTYWdlTWFrZXIiCiAgICB9LAogICAgInRyYW5zbGF0ZSI6IHsKICAgICAgIm5hbWUiOiAiVHJhbnNsYXRlIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInJlc291cmNlZ3JvdXBzIjogewogICAgICAicHJlZml4IjogInJlc291cmNlLWdyb3VwcyIsCiAgICAgICJuYW1lIjogIlJlc291cmNlR3JvdXBzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFsZXhhZm9yYnVzaW5lc3MiOiB7CiAgICAgICJuYW1lIjogIkFsZXhhRm9yQnVzaW5lc3MiCiAgICB9LAogICAgImNsb3VkOSI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWQ5IgogICAgfSwKICAgICJzZXJ2ZXJsZXNzYXBwbGljYXRpb25yZXBvc2l0b3J5IjogewogICAgICAicHJlZml4IjogInNlcnZlcmxlc3NyZXBvIiwKICAgICAgIm5hbWUiOiAiU2VydmVybGVzc0FwcGxpY2F0aW9uUmVwb3NpdG9yeSIKICAgIH0sCiAgICAic2VydmljZWRpc2NvdmVyeSI6IHsKICAgICAgIm5hbWUiOiAiU2VydmljZURpc2NvdmVyeSIKICAgIH0sCiAgICAid29ya21haWwiOiB7CiAgICAgICJuYW1lIjogIldvcmtNYWlsIgogICAgfSwKICAgICJhdXRvc2NhbGluZ3BsYW5zIjogewogICAgICAicHJlZml4IjogImF1dG9zY2FsaW5nLXBsYW5zIiwKICAgICAgIm5hbWUiOiAiQXV0b1NjYWxpbmdQbGFucyIKICAgIH0sCiAgICAidHJhbnNjcmliZXNlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAidHJhbnNjcmliZSIsCiAgICAgICJuYW1lIjogIlRyYW5zY3JpYmVTZXJ2aWNlIgogICAgfSwKICAgICJjb25uZWN0IjogewogICAgICAibmFtZSI6ICJDb25uZWN0IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFjbXBjYSI6IHsKICAgICAgInByZWZpeCI6ICJhY20tcGNhIiwKICAgICAgIm5hbWUiOiAiQUNNUENBIgogICAgfSwKICAgICJmbXMiOiB7CiAgICAgICJuYW1lIjogIkZNUyIKICAgIH0sCiAgICAic2VjcmV0c21hbmFnZXIiOiB7CiAgICAgICJuYW1lIjogIlNlY3JldHNNYW5hZ2VyIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImlvdGFuYWx5dGljcyI6IHsKICAgICAgIm5hbWUiOiAiSW9UQW5hbHl0aWNzIiwKICAgICAgImNvcnMiOiB0cnVlCQogICAgfSwKICAgICJpb3QxY2xpY2tkZXZpY2Vzc2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJpb3QxY2xpY2stZGV2aWNlcyIsCiAgICAgICJuYW1lIjogIklvVDFDbGlja0RldmljZXNTZXJ2aWNlIgogICAgfSwKICAgICJpb3QxY2xpY2twcm9qZWN0cyI6IHsKICAgICAgInByZWZpeCI6ICJpb3QxY2xpY2stcHJvamVjdHMiLAogICAgICAibmFtZSI6ICJJb1QxQ2xpY2tQcm9qZWN0cyIKICAgIH0sCiAgICAicGkiOiB7CiAgICAgICJuYW1lIjogIlBJIgogICAgfSwKICAgICJuZXB0dW5lIjogewogICAgICAibmFtZSI6ICJOZXB0dW5lIgogICAgfSwKICAgICJtZWRpYXRhaWxvciI6IHsKICAgICAgIm5hbWUiOiAiTWVkaWFUYWlsb3IiCiAgICB9LAogICAgImVrcyI6IHsKICAgICAgIm5hbWUiOiAiRUtTIgogICAgfSwKICAgICJtYWNpZSI6IHsKICAgICAgIm5hbWUiOiAiTWFjaWUiCiAgICB9LAogICAgImRsbSI6IHsKICAgICAgIm5hbWUiOiAiRExNIgogICAgfSwKICAgICJzaWduZXIiOiB7CiAgICAgICJuYW1lIjogIlNpZ25lciIKICAgIH0sCiAgICAiY2hpbWUiOiB7CiAgICAgICJuYW1lIjogIkNoaW1lIgogICAgfSwKICAgICJwaW5wb2ludGVtYWlsIjogewogICAgICAicHJlZml4IjogInBpbnBvaW50LWVtYWlsIiwKICAgICAgIm5hbWUiOiAiUGlucG9pbnRFbWFpbCIKICAgIH0sCiAgICAicmFtIjogewogICAgICAibmFtZSI6ICJSQU0iCiAgICB9LAogICAgInJvdXRlNTNyZXNvbHZlciI6IHsKICAgICAgIm5hbWUiOiAiUm91dGU1M1Jlc29sdmVyIgogICAgfSwKICAgICJwaW5wb2ludHNtc3ZvaWNlIjogewogICAgICAicHJlZml4IjogInNtcy12b2ljZSIsCiAgICAgICJuYW1lIjogIlBpbnBvaW50U01TVm9pY2UiCiAgICB9LAogICAgInF1aWNrc2lnaHQiOiB7CiAgICAgICJuYW1lIjogIlF1aWNrU2lnaHQiCiAgICB9LAogICAgInJkc2RhdGFzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogInJkcy1kYXRhIiwKICAgICAgIm5hbWUiOiAiUkRTRGF0YVNlcnZpY2UiCiAgICB9LAogICAgImFtcGxpZnkiOiB7CiAgICAgICJuYW1lIjogIkFtcGxpZnkiCiAgICB9LAogICAgImRhdGFzeW5jIjogewogICAgICAibmFtZSI6ICJEYXRhU3luYyIKICAgIH0sCiAgICAicm9ib21ha2VyIjogewogICAgICAibmFtZSI6ICJSb2JvTWFrZXIiCiAgICB9LAogICAgInRyYW5zZmVyIjogewogICAgICAibmFtZSI6ICJUcmFuc2ZlciIKICAgIH0sCiAgICAiZ2xvYmFsYWNjZWxlcmF0b3IiOiB7CiAgICAgICJuYW1lIjogIkdsb2JhbEFjY2VsZXJhdG9yIgogICAgfSwKICAgICJjb21wcmVoZW5kbWVkaWNhbCI6IHsKICAgICAgIm5hbWUiOiAiQ29tcHJlaGVuZE1lZGljYWwiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAia2luZXNpc2FuYWx5dGljc3YyIjogewogICAgICAibmFtZSI6ICJLaW5lc2lzQW5hbHl0aWNzVjIiCiAgICB9LAogICAgIm1lZGlhY29ubmVjdCI6IHsKICAgICAgIm5hbWUiOiAiTWVkaWFDb25uZWN0IgogICAgfSwKICAgICJmc3giOiB7CiAgICAgICJuYW1lIjogIkZTeCIKICAgIH0sCiAgICAic2VjdXJpdHlodWIiOiB7CiAgICAgICJuYW1lIjogIlNlY3VyaXR5SHViIgogICAgfSwKICAgICJhcHBtZXNoIjogewogICAgICAibmFtZSI6ICJBcHBNZXNoIiwKICAgICAgInZlcnNpb25zIjogWwogICAgICAgICIyMDE4LTEwLTAxKiIKICAgICAgXQogICAgfSwKICAgICJsaWNlbnNlbWFuYWdlciI6IHsKICAgICAgInByZWZpeCI6ICJsaWNlbnNlLW1hbmFnZXIiLAogICAgICAibmFtZSI6ICJMaWNlbnNlTWFuYWdlciIKICAgIH0sCiAgICAia2Fma2EiOiB7CiAgICAgICJuYW1lIjogIkthZmthIgogICAgfSwKICAgICJhcGlnYXRld2F5bWFuYWdlbWVudGFwaSI6IHsKICAgICAgIm5hbWUiOiAiQXBpR2F0ZXdheU1hbmFnZW1lbnRBcGkiCiAgICB9LAogICAgImFwaWdhdGV3YXl2MiI6IHsKICAgICAgIm5hbWUiOiAiQXBpR2F0ZXdheVYyIgogICAgfSwKICAgICJkb2NkYiI6IHsKICAgICAgIm5hbWUiOiAiRG9jREIiCiAgICB9LAogICAgImJhY2t1cCI6IHsKICAgICAgIm5hbWUiOiAiQmFja3VwIgogICAgfSwKICAgICJ3b3JrbGluayI6IHsKICAgICAgIm5hbWUiOiAiV29ya0xpbmsiCiAgICB9LAogICAgInRleHRyYWN0IjogewogICAgICAibmFtZSI6ICJUZXh0cmFjdCIKICAgIH0sCiAgICAibWFuYWdlZGJsb2NrY2hhaW4iOiB7CiAgICAgICJuYW1lIjogIk1hbmFnZWRCbG9ja2NoYWluIgogICAgfSwKICAgICJtZWRpYXBhY2thZ2V2b2QiOiB7CiAgICAgICJwcmVmaXgiOiAibWVkaWFwYWNrYWdlLXZvZCIsCiAgICAgICJuYW1lIjogIk1lZGlhUGFja2FnZVZvZCIKICAgIH0sCiAgICAiZ3JvdW5kc3RhdGlvbiI6IHsKICAgICAgIm5hbWUiOiAiR3JvdW5kU3RhdGlvbiIKICAgIH0sCiAgICAiaW90dGhpbmdzZ3JhcGgiOiB7CiAgICAgICJuYW1lIjogIklvVFRoaW5nc0dyYXBoIgogICAgfSwKICAgICJpb3RldmVudHMiOiB7CiAgICAgICJuYW1lIjogIklvVEV2ZW50cyIKICAgIH0sCiAgICAiaW90ZXZlbnRzZGF0YSI6IHsKICAgICAgInByZWZpeCI6ICJpb3RldmVudHMtZGF0YSIsCiAgICAgICJuYW1lIjogIklvVEV2ZW50c0RhdGEiCiAgICB9LAogICAgInBlcnNvbmFsaXplIjogewogICAgICAibmFtZSI6ICJQZXJzb25hbGl6ZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJwZXJzb25hbGl6ZWV2ZW50cyI6IHsKICAgICAgInByZWZpeCI6ICJwZXJzb25hbGl6ZS1ldmVudHMiLAogICAgICAibmFtZSI6ICJQZXJzb25hbGl6ZUV2ZW50cyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJwZXJzb25hbGl6ZXJ1bnRpbWUiOiB7CiAgICAgICJwcmVmaXgiOiAicGVyc29uYWxpemUtcnVudGltZSIsCiAgICAgICJuYW1lIjogIlBlcnNvbmFsaXplUnVudGltZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJhcHBsaWNhdGlvbmluc2lnaHRzIjogewogICAgICAicHJlZml4IjogImFwcGxpY2F0aW9uLWluc2lnaHRzIiwKICAgICAgIm5hbWUiOiAiQXBwbGljYXRpb25JbnNpZ2h0cyIKICAgIH0sCiAgICAic2VydmljZXF1b3RhcyI6IHsKICAgICAgInByZWZpeCI6ICJzZXJ2aWNlLXF1b3RhcyIsCiAgICAgICJuYW1lIjogIlNlcnZpY2VRdW90YXMiCiAgICB9LAogICAgImVjMmluc3RhbmNlY29ubmVjdCI6IHsKICAgICAgInByZWZpeCI6ICJlYzItaW5zdGFuY2UtY29ubmVjdCIsCiAgICAgICJuYW1lIjogIkVDMkluc3RhbmNlQ29ubmVjdCIKICAgIH0sCiAgICAiZXZlbnRicmlkZ2UiOiB7CiAgICAgICJuYW1lIjogIkV2ZW50QnJpZGdlIgogICAgfSwKICAgICJsYWtlZm9ybWF0aW9uIjogewogICAgICAibmFtZSI6ICJMYWtlRm9ybWF0aW9uIgogICAgfSwKICAgICJmb3JlY2FzdHNlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAiZm9yZWNhc3QiLAogICAgICAibmFtZSI6ICJGb3JlY2FzdFNlcnZpY2UiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZm9yZWNhc3RxdWVyeXNlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAiZm9yZWNhc3RxdWVyeSIsCiAgICAgICJuYW1lIjogIkZvcmVjYXN0UXVlcnlTZXJ2aWNlIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInFsZGIiOiB7CiAgICAgICJuYW1lIjogIlFMREIiCiAgICB9LAogICAgInFsZGJzZXNzaW9uIjogewogICAgICAicHJlZml4IjogInFsZGItc2Vzc2lvbiIsCiAgICAgICJuYW1lIjogIlFMREJTZXNzaW9uIgogICAgfSwKICAgICJ3b3JrbWFpbG1lc3NhZ2VmbG93IjogewogICAgICAibmFtZSI6ICJXb3JrTWFpbE1lc3NhZ2VGbG93IgogICAgfQogIH0KICAKICB9LHt9XSw1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBtb2R1bGUuZXhwb3J0cz17CiAgICAidmVyc2lvbiI6ICIyLjAiLAogICAgIm1ldGFkYXRhIjogewogICAgICAiYXBpVmVyc2lvbiI6ICIyMDExLTA2LTE1IiwKICAgICAgImVuZHBvaW50UHJlZml4IjogInN0cyIsCiAgICAgICJnbG9iYWxFbmRwb2ludCI6ICJzdHMuYW1hem9uYXdzLmNvbSIsCiAgICAgICJwcm90b2NvbCI6ICJxdWVyeSIsCiAgICAgICJzZXJ2aWNlQWJicmV2aWF0aW9uIjogIkFXUyBTVFMiLAogICAgICAic2VydmljZUZ1bGxOYW1lIjogIkFXUyBTZWN1cml0eSBUb2tlbiBTZXJ2aWNlIiwKICAgICAgInNlcnZpY2VJZCI6ICJTVFMiLAogICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJ2NCIsCiAgICAgICJ1aWQiOiAic3RzLTIwMTEtMDYtMTUiLAogICAgICAieG1sTmFtZXNwYWNlIjogImh0dHBzOi8vc3RzLmFtYXpvbmF3cy5jb20vZG9jLzIwMTEtMDYtMTUvIgogICAgfSwKICAgICJvcGVyYXRpb25zIjogewogICAgICAiQXNzdW1lUm9sZSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiUm9sZUFybiIsCiAgICAgICAgICAgICJSb2xlU2Vzc2lvbk5hbWUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJSb2xlQXJuIjoge30sCiAgICAgICAgICAgICJSb2xlU2Vzc2lvbk5hbWUiOiB7fSwKICAgICAgICAgICAgIlBvbGljeUFybnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUG9saWN5Ijoge30sCiAgICAgICAgICAgICJEdXJhdGlvblNlY29uZHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkV4dGVybmFsSWQiOiB7fSwKICAgICAgICAgICAgIlNlcmlhbE51bWJlciI6IHt9LAogICAgICAgICAgICAiVG9rZW5Db2RlIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJBc3N1bWVSb2xlUmVzdWx0IiwKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTYyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkFzc3VtZWRSb2xlVXNlciI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2giCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQYWNrZWRQb2xpY3lTaXplIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJBc3N1bWVSb2xlV2l0aFNBTUwiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJvbGVBcm4iLAogICAgICAgICAgICAiUHJpbmNpcGFsQXJuIiwKICAgICAgICAgICAgIlNBTUxBc3NlcnRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJSb2xlQXJuIjoge30sCiAgICAgICAgICAgICJQcmluY2lwYWxBcm4iOiB7fSwKICAgICAgICAgICAgIlNBTUxBc3NlcnRpb24iOiB7fSwKICAgICAgICAgICAgIlBvbGljeUFybnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUG9saWN5Ijoge30sCiAgICAgICAgICAgICJEdXJhdGlvblNlY29uZHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkFzc3VtZVJvbGVXaXRoU0FNTFJlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJDcmVkZW50aWFscyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2MiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJBc3N1bWVkUm9sZVVzZXIiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNoIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUGFja2VkUG9saWN5U2l6ZSI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiU3ViamVjdCI6IHt9LAogICAgICAgICAgICAiU3ViamVjdFR5cGUiOiB7fSwKICAgICAgICAgICAgIklzc3VlciI6IHt9LAogICAgICAgICAgICAiQXVkaWVuY2UiOiB7fSwKICAgICAgICAgICAgIk5hbWVRdWFsaWZpZXIiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJvbGVBcm4iLAogICAgICAgICAgICAiUm9sZVNlc3Npb25OYW1lIiwKICAgICAgICAgICAgIldlYklkZW50aXR5VG9rZW4iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJSb2xlQXJuIjoge30sCiAgICAgICAgICAgICJSb2xlU2Vzc2lvbk5hbWUiOiB7fSwKICAgICAgICAgICAgIldlYklkZW50aXR5VG9rZW4iOiB7fSwKICAgICAgICAgICAgIlByb3ZpZGVySWQiOiB7fSwKICAgICAgICAgICAgIlBvbGljeUFybnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUG9saWN5Ijoge30sCiAgICAgICAgICAgICJEdXJhdGlvblNlY29uZHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHlSZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNjIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiU3ViamVjdEZyb21XZWJJZGVudGl0eVRva2VuIjoge30sCiAgICAgICAgICAgICJBc3N1bWVkUm9sZVVzZXIiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNoIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUGFja2VkUG9saWN5U2l6ZSI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUHJvdmlkZXIiOiB7fSwKICAgICAgICAgICAgIkF1ZGllbmNlIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJEZWNvZGVBdXRob3JpemF0aW9uTWVzc2FnZSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiRW5jb2RlZE1lc3NhZ2UiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJFbmNvZGVkTWVzc2FnZSI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiRGVjb2RlQXV0aG9yaXphdGlvbk1lc3NhZ2VSZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiRGVjb2RlZE1lc3NhZ2UiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldEFjY2Vzc0tleUluZm8iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIkFjY2Vzc0tleUlkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQWNjZXNzS2V5SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkdldEFjY2Vzc0tleUluZm9SZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQWNjb3VudCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0Q2FsbGVySWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJHZXRDYWxsZXJJZGVudGl0eVJlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJVc2VySWQiOiB7fSwKICAgICAgICAgICAgIkFjY291bnQiOiB7fSwKICAgICAgICAgICAgIkFybiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0RmVkZXJhdGlvblRva2VuIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJOYW1lIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiTmFtZSI6IHt9LAogICAgICAgICAgICAiUG9saWN5Ijoge30sCiAgICAgICAgICAgICJQb2xpY3lBcm5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTNCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiR2V0RmVkZXJhdGlvblRva2VuUmVzdWx0IiwKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTYyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkZlZGVyYXRlZFVzZXIiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAiRmVkZXJhdGVkVXNlcklkIiwKICAgICAgICAgICAgICAgICJBcm4iCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJGZWRlcmF0ZWRVc2VySWQiOiB7fSwKICAgICAgICAgICAgICAgICJBcm4iOiB7fQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlBhY2tlZFBvbGljeVNpemUiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldFNlc3Npb25Ub2tlbiI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJEdXJhdGlvblNlY29uZHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlNlcmlhbE51bWJlciI6IHt9LAogICAgICAgICAgICAiVG9rZW5Db2RlIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJHZXRTZXNzaW9uVG9rZW5SZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNjIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgInNoYXBlcyI6IHsKICAgICAgIlM0IjogewogICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhcm4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNjIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIkFjY2Vzc0tleUlkIiwKICAgICAgICAgICJTZWNyZXRBY2Nlc3NLZXkiLAogICAgICAgICAgIlNlc3Npb25Ub2tlbiIsCiAgICAgICAgICAiRXhwaXJhdGlvbiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIkFjY2Vzc0tleUlkIjoge30sCiAgICAgICAgICAiU2VjcmV0QWNjZXNzS2V5Ijoge30sCiAgICAgICAgICAiU2Vzc2lvblRva2VuIjoge30sCiAgICAgICAgICAiRXhwaXJhdGlvbiI6IHsKICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNoIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIkFzc3VtZWRSb2xlSWQiLAogICAgICAgICAgIkFybiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIkFzc3VtZWRSb2xlSWQiOiB7fSwKICAgICAgICAgICJBcm4iOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICB9LHt9XSw2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBhcmd1bWVudHNbNF1bMl1bMF0uYXBwbHkoZXhwb3J0cyxhcmd1bWVudHMpCiAgfSx7ImR1cCI6Mn1dLDc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHJlcXVpcmUoJy4uL2xpYi9ub2RlX2xvYWRlcicpOwogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9saWIvY29yZScpOwogIHZhciBTZXJ2aWNlID0gQVdTLlNlcnZpY2U7CiAgdmFyIGFwaUxvYWRlciA9IEFXUy5hcGlMb2FkZXI7CiAgCiAgYXBpTG9hZGVyLnNlcnZpY2VzWydjb2duaXRvaWRlbnRpdHknXSA9IHt9OwogIEFXUy5Db2duaXRvSWRlbnRpdHkgPSBTZXJ2aWNlLmRlZmluZVNlcnZpY2UoJ2NvZ25pdG9pZGVudGl0eScsIFsnMjAxNC0wNi0zMCddKTsKICByZXF1aXJlKCcuLi9saWIvc2VydmljZXMvY29nbml0b2lkZW50aXR5Jyk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGFwaUxvYWRlci5zZXJ2aWNlc1snY29nbml0b2lkZW50aXR5J10sICcyMDE0LTA2LTMwJywgewogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHZhciBtb2RlbCA9IHJlcXVpcmUoJy4uL2FwaXMvY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwLm1pbi5qc29uJyk7CiAgICAgIG1vZGVsLnBhZ2luYXRvcnMgPSByZXF1aXJlKCcuLi9hcGlzL2NvZ25pdG8taWRlbnRpdHktMjAxNC0wNi0zMC5wYWdpbmF0b3JzLmpzb24nKS5wYWdpbmF0aW9uOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogIH0pOwogIAogIG1vZHVsZS5leHBvcnRzID0gQVdTLkNvZ25pdG9JZGVudGl0eTsKICAKICB9LHsiLi4vYXBpcy9jb2duaXRvLWlkZW50aXR5LTIwMTQtMDYtMzAubWluLmpzb24iOjEsIi4uL2FwaXMvY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwLnBhZ2luYXRvcnMuanNvbiI6MiwiLi4vbGliL2NvcmUiOjE4LCIuLi9saWIvbm9kZV9sb2FkZXIiOjE2LCIuLi9saWIvc2VydmljZXMvY29nbml0b2lkZW50aXR5Ijo2MH1dLDg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHJlcXVpcmUoJy4uL2xpYi9ub2RlX2xvYWRlcicpOwogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9saWIvY29yZScpOwogIHZhciBTZXJ2aWNlID0gQVdTLlNlcnZpY2U7CiAgdmFyIGFwaUxvYWRlciA9IEFXUy5hcGlMb2FkZXI7CiAgCiAgYXBpTG9hZGVyLnNlcnZpY2VzWydzdHMnXSA9IHt9OwogIEFXUy5TVFMgPSBTZXJ2aWNlLmRlZmluZVNlcnZpY2UoJ3N0cycsIFsnMjAxMS0wNi0xNSddKTsKICByZXF1aXJlKCcuLi9saWIvc2VydmljZXMvc3RzJyk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGFwaUxvYWRlci5zZXJ2aWNlc1snc3RzJ10sICcyMDExLTA2LTE1JywgewogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHZhciBtb2RlbCA9IHJlcXVpcmUoJy4uL2FwaXMvc3RzLTIwMTEtMDYtMTUubWluLmpzb24nKTsKICAgICAgbW9kZWwucGFnaW5hdG9ycyA9IHJlcXVpcmUoJy4uL2FwaXMvc3RzLTIwMTEtMDYtMTUucGFnaW5hdG9ycy5qc29uJykucGFnaW5hdGlvbjsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBjb25maWd1cmFibGU6IHRydWUKICB9KTsKICAKICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TVFM7CiAgCiAgfSx7Ii4uL2FwaXMvc3RzLTIwMTEtMDYtMTUubWluLmpzb24iOjUsIi4uL2FwaXMvc3RzLTIwMTEtMDYtMTUucGFnaW5hdG9ycy5qc29uIjo2LCIuLi9saWIvY29yZSI6MTgsIi4uL2xpYi9ub2RlX2xvYWRlciI6MTYsIi4uL2xpYi9zZXJ2aWNlcy9zdHMiOjYxfV0sOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgZnVuY3Rpb24gYXBpTG9hZGVyKHN2YywgdmVyc2lvbikgewogICAgaWYgKCFhcGlMb2FkZXIuc2VydmljZXMuaGFzT3duUHJvcGVydHkoc3ZjKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWRTZXJ2aWNlOiBGYWlsZWQgdG8gbG9hZCBhcGkgZm9yICcgKyBzdmMpOwogICAgfQogICAgcmV0dXJuIGFwaUxvYWRlci5zZXJ2aWNlc1tzdmNdW3ZlcnNpb25dOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKgogICAqIFRoaXMgbWVtYmVyIG9mIEFXUy5hcGlMb2FkZXIgaXMgcHJpdmF0ZSwgYnV0IGNoYW5naW5nIGl0IHdpbGwgbmVjZXNzaXRhdGUgYQogICAqIGNoYW5nZSB0byAuLi9zY3JpcHRzL3NlcnZpY2VzLXRhYmxlLWdlbmVyYXRvci50cwogICAqLwogIGFwaUxvYWRlci5zZXJ2aWNlcyA9IHt9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gYXBpTG9hZGVyOwogIAogIH0se31dLDEwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgSG1hYyA9IHJlcXVpcmUoJy4vYnJvd3NlckhtYWMnKTsKICB2YXIgTWQ1ID0gcmVxdWlyZSgnLi9icm93c2VyTWQ1Jyk7CiAgdmFyIFNoYTEgPSByZXF1aXJlKCcuL2Jyb3dzZXJTaGExJyk7CiAgdmFyIFNoYTI1NiA9IHJlcXVpcmUoJy4vYnJvd3NlclNoYTI1NicpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IHsKICAgICAgY3JlYXRlSGFzaDogZnVuY3Rpb24gY3JlYXRlSGFzaChhbGcpIHsKICAgICAgICBhbGcgPSBhbGcudG9Mb3dlckNhc2UoKTsKICAgICAgICBpZiAoYWxnID09PSAnbWQ1JykgewogICAgICAgICAgcmV0dXJuIG5ldyBNZDUoKTsKICAgICAgICB9IGVsc2UgaWYgKGFsZyA9PT0gJ3NoYTI1NicpIHsKICAgICAgICAgIHJldHVybiBuZXcgU2hhMjU2KCk7CiAgICAgICAgfSBlbHNlIGlmIChhbGcgPT09ICdzaGExJykgewogICAgICAgICAgcmV0dXJuIG5ldyBTaGExKCk7CiAgICAgICAgfQogIAogICAgICAgIHRocm93IG5ldyBFcnJvcignSGFzaCBhbGdvcml0aG0gJyArIGFsZyArICcgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGUgYnJvd3NlciBTREsnKTsKICAgICAgfSwKICAgICAgY3JlYXRlSG1hYzogZnVuY3Rpb24gY3JlYXRlSG1hYyhhbGcsIGtleSkgewogICAgICAgIGFsZyA9IGFsZy50b0xvd2VyQ2FzZSgpOwogICAgICAgIGlmIChhbGcgPT09ICdtZDUnKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEhtYWMoTWQ1LCBrZXkpOwogICAgICAgIH0gZWxzZSBpZiAoYWxnID09PSAnc2hhMjU2JykgewogICAgICAgICAgcmV0dXJuIG5ldyBIbWFjKFNoYTI1Niwga2V5KTsKICAgICAgICB9IGVsc2UgaWYgKGFsZyA9PT0gJ3NoYTEnKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEhtYWMoU2hhMSwga2V5KTsKICAgICAgICB9CiAgCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdITUFDIGFsZ29yaXRobSAnICsgYWxnICsgJyBpcyBub3Qgc3VwcG9ydGVkIGluIHRoZSBicm93c2VyIFNESycpOwogICAgICB9LAogICAgICBjcmVhdGVTaWduOiBmdW5jdGlvbigpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NyZWF0ZVNpZ24gaXMgbm90IGltcGxlbWVudGVkIGluIHRoZSBicm93c2VyJyk7CiAgICAgIH0KICAgIH07CiAgCiAgfSx7Ii4vYnJvd3NlckhtYWMiOjEyLCIuL2Jyb3dzZXJNZDUiOjEzLCIuL2Jyb3dzZXJTaGExIjoxNCwiLi9icm93c2VyU2hhMjU2IjoxNX1dLDExOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKICAKICAvKioKICAgKiBUaGlzIGlzIGEgcG9seWZpbGwgZm9yIHRoZSBzdGF0aWMgbWV0aG9kIGBpc1ZpZXdgIG9mIGBBcnJheUJ1ZmZlcmAsIHdoaWNoIGlzCiAgICogZS5nLiBtaXNzaW5nIGluIElFIDEwLgogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgaWYgKAogICAgICB0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmCiAgICAgIHR5cGVvZiBBcnJheUJ1ZmZlci5pc1ZpZXcgPT09ICd1bmRlZmluZWQnCiAgKSB7CiAgICAgIEFycmF5QnVmZmVyLmlzVmlldyA9IGZ1bmN0aW9uKGFyZykgewogICAgICAgICAgcmV0dXJuIHZpZXdTdHJpbmdzLmluZGV4T2YoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGFyZykpID4gLTE7CiAgICAgIH07CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciB2aWV3U3RyaW5ncyA9IFsKICAgICAgJ1tvYmplY3QgSW50OEFycmF5XScsCiAgICAgICdbb2JqZWN0IFVpbnQ4QXJyYXldJywKICAgICAgJ1tvYmplY3QgVWludDhDbGFtcGVkQXJyYXldJywKICAgICAgJ1tvYmplY3QgSW50MTZBcnJheV0nLAogICAgICAnW29iamVjdCBVaW50MTZBcnJheV0nLAogICAgICAnW29iamVjdCBJbnQzMkFycmF5XScsCiAgICAgICdbb2JqZWN0IFVpbnQzMkFycmF5XScsCiAgICAgICdbb2JqZWN0IEZsb2F0MzJBcnJheV0nLAogICAgICAnW29iamVjdCBGbG9hdDY0QXJyYXldJywKICAgICAgJ1tvYmplY3QgRGF0YVZpZXddJywKICBdOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGlzRW1wdHlEYXRhKGRhdGEpIHsKICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgewogICAgICAgICAgcmV0dXJuIGRhdGEubGVuZ3RoID09PSAwOwogICAgICB9CiAgICAgIHJldHVybiBkYXRhLmJ5dGVMZW5ndGggPT09IDA7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGNvbnZlcnRUb0J1ZmZlcihkYXRhKSB7CiAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGRhdGEgPSBuZXcgQnVmZmVyKGRhdGEsICd1dGY4Jyk7CiAgICAgIH0KICAKICAgICAgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhkYXRhKSkgewogICAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQsIGRhdGEuYnl0ZUxlbmd0aCAvIFVpbnQ4QXJyYXkuQllURVNfUEVSX0VMRU1FTlQpOwogICAgICB9CiAgCiAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShkYXRhKTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gewogICAgICBpc0VtcHR5RGF0YTogaXNFbXB0eURhdGEsCiAgICAgIGNvbnZlcnRUb0J1ZmZlcjogY29udmVydFRvQnVmZmVyLAogIH07CiAgCiAgfSx7ImJ1ZmZlci8iOjgwfV0sMTI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBoYXNoVXRpbHMgPSByZXF1aXJlKCcuL2Jyb3dzZXJIYXNoVXRpbHMnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBIbWFjKGhhc2hDdG9yLCBzZWNyZXQpIHsKICAgICAgdGhpcy5oYXNoID0gbmV3IGhhc2hDdG9yKCk7CiAgICAgIHRoaXMub3V0ZXIgPSBuZXcgaGFzaEN0b3IoKTsKICAKICAgICAgdmFyIGlubmVyID0gYnVmZmVyRnJvbVNlY3JldChoYXNoQ3Rvciwgc2VjcmV0KTsKICAgICAgdmFyIG91dGVyID0gbmV3IFVpbnQ4QXJyYXkoaGFzaEN0b3IuQkxPQ0tfU0laRSk7CiAgICAgIG91dGVyLnNldChpbm5lcik7CiAgCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaGFzaEN0b3IuQkxPQ0tfU0laRTsgaSsrKSB7CiAgICAgICAgICBpbm5lcltpXSBePSAweDM2OwogICAgICAgICAgb3V0ZXJbaV0gXj0gMHg1YzsKICAgICAgfQogIAogICAgICB0aGlzLmhhc2gudXBkYXRlKGlubmVyKTsKICAgICAgdGhpcy5vdXRlci51cGRhdGUob3V0ZXIpOwogIAogICAgICAvLyBaZXJvIG91dCB0aGUgY29waWVkIGtleSBidWZmZXIuCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5uZXIuYnl0ZUxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpbm5lcltpXSA9IDA7CiAgICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gSG1hYzsKICAKICBIbWFjLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAodG9IYXNoKSB7CiAgICAgIGlmIChoYXNoVXRpbHMuaXNFbXB0eURhdGEodG9IYXNoKSB8fCB0aGlzLmVycm9yKSB7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogIAogICAgICB0cnkgewogICAgICAgICAgdGhpcy5oYXNoLnVwZGF0ZShoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKHRvSGFzaCkpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICB0aGlzLmVycm9yID0gZTsKICAgICAgfQogIAogICAgICByZXR1cm4gdGhpczsKICB9OwogIAogIEhtYWMucHJvdG90eXBlLmRpZ2VzdCA9IGZ1bmN0aW9uIChlbmNvZGluZykgewogICAgICBpZiAoIXRoaXMub3V0ZXIuZmluaXNoZWQpIHsKICAgICAgICAgIHRoaXMub3V0ZXIudXBkYXRlKHRoaXMuaGFzaC5kaWdlc3QoKSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXMub3V0ZXIuZGlnZXN0KGVuY29kaW5nKTsKICB9OwogIAogIGZ1bmN0aW9uIGJ1ZmZlckZyb21TZWNyZXQoaGFzaEN0b3IsIHNlY3JldCkgewogICAgICB2YXIgaW5wdXQgPSBoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKHNlY3JldCk7CiAgICAgIGlmIChpbnB1dC5ieXRlTGVuZ3RoID4gaGFzaEN0b3IuQkxPQ0tfU0laRSkgewogICAgICAgICAgdmFyIGJ1ZmZlckhhc2ggPSBuZXcgaGFzaEN0b3I7CiAgICAgICAgICBidWZmZXJIYXNoLnVwZGF0ZShpbnB1dCk7CiAgICAgICAgICBpbnB1dCA9IGJ1ZmZlckhhc2guZGlnZXN0KCk7CiAgICAgIH0KICAgICAgdmFyIGJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KGhhc2hDdG9yLkJMT0NLX1NJWkUpOwogICAgICBidWZmZXIuc2V0KGlucHV0KTsKICAgICAgcmV0dXJuIGJ1ZmZlcjsKICB9CiAgCiAgfSx7Ii4vYnJvd3Nlckhhc2hVdGlscyI6MTF9XSwxMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIGhhc2hVdGlscyA9IHJlcXVpcmUoJy4vYnJvd3Nlckhhc2hVdGlscycpOwogIHZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwogIAogIHZhciBCTE9DS19TSVpFID0gNjQ7CiAgCiAgdmFyIERJR0VTVF9MRU5HVEggPSAxNjsKICAKICB2YXIgSU5JVCA9IFsKICAgICAgMHg2NzQ1MjMwMSwKICAgICAgMHhlZmNkYWI4OSwKICAgICAgMHg5OGJhZGNmZSwKICAgICAgMHgxMDMyNTQ3NiwKICBdOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIE1kNSgpIHsKICAgICAgdGhpcy5zdGF0ZSA9IFsKICAgICAgICAgIDB4Njc0NTIzMDEsCiAgICAgICAgICAweGVmY2RhYjg5LAogICAgICAgICAgMHg5OGJhZGNmZSwKICAgICAgICAgIDB4MTAzMjU0NzYsCiAgICAgIF07CiAgICAgIHRoaXMuYnVmZmVyID0gbmV3IERhdGFWaWV3KG5ldyBBcnJheUJ1ZmZlcihCTE9DS19TSVpFKSk7CiAgICAgIHRoaXMuYnVmZmVyTGVuZ3RoID0gMDsKICAgICAgdGhpcy5ieXRlc0hhc2hlZCA9IDA7CiAgICAgIHRoaXMuZmluaXNoZWQgPSBmYWxzZTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gTWQ1OwogIAogIE1kNS5CTE9DS19TSVpFID0gQkxPQ0tfU0laRTsKICAKICBNZDUucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIChzb3VyY2VEYXRhKSB7CiAgICAgIGlmIChoYXNoVXRpbHMuaXNFbXB0eURhdGEoc291cmNlRGF0YSkpIHsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICB9IGVsc2UgaWYgKHRoaXMuZmluaXNoZWQpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQXR0ZW1wdGVkIHRvIHVwZGF0ZSBhbiBhbHJlYWR5IGZpbmlzaGVkIGhhc2guJyk7CiAgICAgIH0KICAKICAgICAgdmFyIGRhdGEgPSBoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKHNvdXJjZURhdGEpOwogICAgICB2YXIgcG9zaXRpb24gPSAwOwogICAgICB2YXIgYnl0ZUxlbmd0aCA9IGRhdGEuYnl0ZUxlbmd0aDsKICAgICAgdGhpcy5ieXRlc0hhc2hlZCArPSBieXRlTGVuZ3RoOwogICAgICB3aGlsZSAoYnl0ZUxlbmd0aCA+IDApIHsKICAgICAgICAgIHRoaXMuYnVmZmVyLnNldFVpbnQ4KHRoaXMuYnVmZmVyTGVuZ3RoKyssIGRhdGFbcG9zaXRpb24rK10pOwogICAgICAgICAgYnl0ZUxlbmd0aC0tOwogICAgICAgICAgaWYgKHRoaXMuYnVmZmVyTGVuZ3RoID09PSBCTE9DS19TSVpFKSB7CiAgICAgICAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgTWQ1LnByb3RvdHlwZS5kaWdlc3QgPSBmdW5jdGlvbiAoZW5jb2RpbmcpIHsKICAgICAgaWYgKCF0aGlzLmZpbmlzaGVkKSB7CiAgICAgICAgICB2YXIgX2EgPSB0aGlzLCBidWZmZXIgPSBfYS5idWZmZXIsIHVuZGVjb3JhdGVkTGVuZ3RoID0gX2EuYnVmZmVyTGVuZ3RoLCBieXRlc0hhc2hlZCA9IF9hLmJ5dGVzSGFzaGVkOwogICAgICAgICAgdmFyIGJpdHNIYXNoZWQgPSBieXRlc0hhc2hlZCAqIDg7CiAgICAgICAgICBidWZmZXIuc2V0VWludDgodGhpcy5idWZmZXJMZW5ndGgrKywgMTI4KTsKICAgICAgICAgIC8vIEVuc3VyZSB0aGUgZmluYWwgYmxvY2sgaGFzIGVub3VnaCByb29tIGZvciB0aGUgaGFzaGVkIGxlbmd0aAogICAgICAgICAgaWYgKHVuZGVjb3JhdGVkTGVuZ3RoICUgQkxPQ0tfU0laRSA+PSBCTE9DS19TSVpFIC0gOCkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmJ1ZmZlckxlbmd0aDsgaSA8IEJMT0NLX1NJWkU7IGkrKykgewogICAgICAgICAgICAgICAgICBidWZmZXIuc2V0VWludDgoaSwgMCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuaGFzaEJ1ZmZlcigpOwogICAgICAgICAgICAgIHRoaXMuYnVmZmVyTGVuZ3RoID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmJ1ZmZlckxlbmd0aDsgaSA8IEJMT0NLX1NJWkUgLSA4OyBpKyspIHsKICAgICAgICAgICAgICBidWZmZXIuc2V0VWludDgoaSwgMCk7CiAgICAgICAgICB9CiAgICAgICAgICBidWZmZXIuc2V0VWludDMyKEJMT0NLX1NJWkUgLSA4LCBiaXRzSGFzaGVkID4+PiAwLCB0cnVlKTsKICAgICAgICAgIGJ1ZmZlci5zZXRVaW50MzIoQkxPQ0tfU0laRSAtIDQsIE1hdGguZmxvb3IoYml0c0hhc2hlZCAvIDB4MTAwMDAwMDAwKSwgdHJ1ZSk7CiAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgIHRoaXMuZmluaXNoZWQgPSB0cnVlOwogICAgICB9CiAgICAgIHZhciBvdXQgPSBuZXcgRGF0YVZpZXcobmV3IEFycmF5QnVmZmVyKERJR0VTVF9MRU5HVEgpKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCA0OyBpKyspIHsKICAgICAgICAgIG91dC5zZXRVaW50MzIoaSAqIDQsIHRoaXMuc3RhdGVbaV0sIHRydWUpOwogICAgICB9CiAgICAgIHZhciBidWZmID0gbmV3IEJ1ZmZlcihvdXQuYnVmZmVyLCBvdXQuYnl0ZU9mZnNldCwgb3V0LmJ5dGVMZW5ndGgpOwogICAgICByZXR1cm4gZW5jb2RpbmcgPyBidWZmLnRvU3RyaW5nKGVuY29kaW5nKSA6IGJ1ZmY7CiAgfTsKICAKICBNZDUucHJvdG90eXBlLmhhc2hCdWZmZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfYSA9IHRoaXMsIGJ1ZmZlciA9IF9hLmJ1ZmZlciwgc3RhdGUgPSBfYS5zdGF0ZTsKICAgICAgdmFyIGEgPSBzdGF0ZVswXSwgYiA9IHN0YXRlWzFdLCBjID0gc3RhdGVbMl0sIGQgPSBzdGF0ZVszXTsKICAgICAgYSA9IGZmKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMCwgdHJ1ZSksIDcsIDB4ZDc2YWE0NzgpOwogICAgICBkID0gZmYoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig0LCB0cnVlKSwgMTIsIDB4ZThjN2I3NTYpOwogICAgICBjID0gZmYoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig4LCB0cnVlKSwgMTcsIDB4MjQyMDcwZGIpOwogICAgICBiID0gZmYoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigxMiwgdHJ1ZSksIDIyLCAweGMxYmRjZWVlKTsKICAgICAgYSA9IGZmKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMTYsIHRydWUpLCA3LCAweGY1N2MwZmFmKTsKICAgICAgZCA9IGZmKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMjAsIHRydWUpLCAxMiwgMHg0Nzg3YzYyYSk7CiAgICAgIGMgPSBmZihjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDI0LCB0cnVlKSwgMTcsIDB4YTgzMDQ2MTMpOwogICAgICBiID0gZmYoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigyOCwgdHJ1ZSksIDIyLCAweGZkNDY5NTAxKTsKICAgICAgYSA9IGZmKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMzIsIHRydWUpLCA3LCAweDY5ODA5OGQ4KTsKICAgICAgZCA9IGZmKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMzYsIHRydWUpLCAxMiwgMHg4YjQ0ZjdhZik7CiAgICAgIGMgPSBmZihjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDQwLCB0cnVlKSwgMTcsIDB4ZmZmZjViYjEpOwogICAgICBiID0gZmYoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig0NCwgdHJ1ZSksIDIyLCAweDg5NWNkN2JlKTsKICAgICAgYSA9IGZmKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNDgsIHRydWUpLCA3LCAweDZiOTAxMTIyKTsKICAgICAgZCA9IGZmKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNTIsIHRydWUpLCAxMiwgMHhmZDk4NzE5Myk7CiAgICAgIGMgPSBmZihjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDU2LCB0cnVlKSwgMTcsIDB4YTY3OTQzOGUpOwogICAgICBiID0gZmYoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig2MCwgdHJ1ZSksIDIyLCAweDQ5YjQwODIxKTsKICAgICAgYSA9IGdnKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNCwgdHJ1ZSksIDUsIDB4ZjYxZTI1NjIpOwogICAgICBkID0gZ2coZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigyNCwgdHJ1ZSksIDksIDB4YzA0MGIzNDApOwogICAgICBjID0gZ2coYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig0NCwgdHJ1ZSksIDE0LCAweDI2NWU1YTUxKTsKICAgICAgYiA9IGdnKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMCwgdHJ1ZSksIDIwLCAweGU5YjZjN2FhKTsKICAgICAgYSA9IGdnKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMjAsIHRydWUpLCA1LCAweGQ2MmYxMDVkKTsKICAgICAgZCA9IGdnKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNDAsIHRydWUpLCA5LCAweDAyNDQxNDUzKTsKICAgICAgYyA9IGdnKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNjAsIHRydWUpLCAxNCwgMHhkOGExZTY4MSk7CiAgICAgIGIgPSBnZyhiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDE2LCB0cnVlKSwgMjAsIDB4ZTdkM2ZiYzgpOwogICAgICBhID0gZ2coYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigzNiwgdHJ1ZSksIDUsIDB4MjFlMWNkZTYpOwogICAgICBkID0gZ2coZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig1NiwgdHJ1ZSksIDksIDB4YzMzNzA3ZDYpOwogICAgICBjID0gZ2coYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMigxMiwgdHJ1ZSksIDE0LCAweGY0ZDUwZDg3KTsKICAgICAgYiA9IGdnKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMzIsIHRydWUpLCAyMCwgMHg0NTVhMTRlZCk7CiAgICAgIGEgPSBnZyhhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDUyLCB0cnVlKSwgNSwgMHhhOWUzZTkwNSk7CiAgICAgIGQgPSBnZyhkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDgsIHRydWUpLCA5LCAweGZjZWZhM2Y4KTsKICAgICAgYyA9IGdnKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMjgsIHRydWUpLCAxNCwgMHg2NzZmMDJkOSk7CiAgICAgIGIgPSBnZyhiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDQ4LCB0cnVlKSwgMjAsIDB4OGQyYTRjOGEpOwogICAgICBhID0gaGgoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigyMCwgdHJ1ZSksIDQsIDB4ZmZmYTM5NDIpOwogICAgICBkID0gaGgoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigzMiwgdHJ1ZSksIDExLCAweDg3NzFmNjgxKTsKICAgICAgYyA9IGhoKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNDQsIHRydWUpLCAxNiwgMHg2ZDlkNjEyMik7CiAgICAgIGIgPSBoaChiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDU2LCB0cnVlKSwgMjMsIDB4ZmRlNTM4MGMpOwogICAgICBhID0gaGgoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMig0LCB0cnVlKSwgNCwgMHhhNGJlZWE0NCk7CiAgICAgIGQgPSBoaChkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDE2LCB0cnVlKSwgMTEsIDB4NGJkZWNmYTkpOwogICAgICBjID0gaGgoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMigyOCwgdHJ1ZSksIDE2LCAweGY2YmI0YjYwKTsKICAgICAgYiA9IGhoKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNDAsIHRydWUpLCAyMywgMHhiZWJmYmM3MCk7CiAgICAgIGEgPSBoaChhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDUyLCB0cnVlKSwgNCwgMHgyODliN2VjNik7CiAgICAgIGQgPSBoaChkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDAsIHRydWUpLCAxMSwgMHhlYWExMjdmYSk7CiAgICAgIGMgPSBoaChjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDEyLCB0cnVlKSwgMTYsIDB4ZDRlZjMwODUpOwogICAgICBiID0gaGgoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigyNCwgdHJ1ZSksIDIzLCAweDA0ODgxZDA1KTsKICAgICAgYSA9IGhoKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMzYsIHRydWUpLCA0LCAweGQ5ZDRkMDM5KTsKICAgICAgZCA9IGhoKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNDgsIHRydWUpLCAxMSwgMHhlNmRiOTllNSk7CiAgICAgIGMgPSBoaChjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDYwLCB0cnVlKSwgMTYsIDB4MWZhMjdjZjgpOwogICAgICBiID0gaGgoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig4LCB0cnVlKSwgMjMsIDB4YzRhYzU2NjUpOwogICAgICBhID0gaWkoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigwLCB0cnVlKSwgNiwgMHhmNDI5MjI0NCk7CiAgICAgIGQgPSBpaShkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDI4LCB0cnVlKSwgMTAsIDB4NDMyYWZmOTcpOwogICAgICBjID0gaWkoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig1NiwgdHJ1ZSksIDE1LCAweGFiOTQyM2E3KTsKICAgICAgYiA9IGlpKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMjAsIHRydWUpLCAyMSwgMHhmYzkzYTAzOSk7CiAgICAgIGEgPSBpaShhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDQ4LCB0cnVlKSwgNiwgMHg2NTViNTljMyk7CiAgICAgIGQgPSBpaShkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDEyLCB0cnVlKSwgMTAsIDB4OGYwY2NjOTIpOwogICAgICBjID0gaWkoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig0MCwgdHJ1ZSksIDE1LCAweGZmZWZmNDdkKTsKICAgICAgYiA9IGlpKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNCwgdHJ1ZSksIDIxLCAweDg1ODQ1ZGQxKTsKICAgICAgYSA9IGlpKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMzIsIHRydWUpLCA2LCAweDZmYTg3ZTRmKTsKICAgICAgZCA9IGlpKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNjAsIHRydWUpLCAxMCwgMHhmZTJjZTZlMCk7CiAgICAgIGMgPSBpaShjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDI0LCB0cnVlKSwgMTUsIDB4YTMwMTQzMTQpOwogICAgICBiID0gaWkoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig1MiwgdHJ1ZSksIDIxLCAweDRlMDgxMWExKTsKICAgICAgYSA9IGlpKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMTYsIHRydWUpLCA2LCAweGY3NTM3ZTgyKTsKICAgICAgZCA9IGlpKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNDQsIHRydWUpLCAxMCwgMHhiZDNhZjIzNSk7CiAgICAgIGMgPSBpaShjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDgsIHRydWUpLCAxNSwgMHgyYWQ3ZDJiYik7CiAgICAgIGIgPSBpaShiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDM2LCB0cnVlKSwgMjEsIDB4ZWI4NmQzOTEpOwogICAgICBzdGF0ZVswXSA9IChhICsgc3RhdGVbMF0pICYgMHhGRkZGRkZGRjsKICAgICAgc3RhdGVbMV0gPSAoYiArIHN0YXRlWzFdKSAmIDB4RkZGRkZGRkY7CiAgICAgIHN0YXRlWzJdID0gKGMgKyBzdGF0ZVsyXSkgJiAweEZGRkZGRkZGOwogICAgICBzdGF0ZVszXSA9IChkICsgc3RhdGVbM10pICYgMHhGRkZGRkZGRjsKICB9OwogIAogIGZ1bmN0aW9uIGNtbihxLCBhLCBiLCB4LCBzLCB0KSB7CiAgICAgIGEgPSAoKChhICsgcSkgJiAweEZGRkZGRkZGKSArICgoeCArIHQpICYgMHhGRkZGRkZGRikpICYgMHhGRkZGRkZGRjsKICAgICAgcmV0dXJuICgoKGEgPDwgcykgfCAoYSA+Pj4gKDMyIC0gcykpKSArIGIpICYgMHhGRkZGRkZGRjsKICB9CiAgCiAgZnVuY3Rpb24gZmYoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICByZXR1cm4gY21uKChiICYgYykgfCAoKH5iKSAmIGQpLCBhLCBiLCB4LCBzLCB0KTsKICB9CiAgCiAgZnVuY3Rpb24gZ2coYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICByZXR1cm4gY21uKChiICYgZCkgfCAoYyAmICh+ZCkpLCBhLCBiLCB4LCBzLCB0KTsKICB9CiAgCiAgZnVuY3Rpb24gaGgoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICByZXR1cm4gY21uKGIgXiBjIF4gZCwgYSwgYiwgeCwgcywgdCk7CiAgfQogIAogIGZ1bmN0aW9uIGlpKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgICAgcmV0dXJuIGNtbihjIF4gKGIgfCAofmQpKSwgYSwgYiwgeCwgcywgdCk7CiAgfQogIAogIH0seyIuL2Jyb3dzZXJIYXNoVXRpbHMiOjExLCJidWZmZXIvIjo4MH1dLDE0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKICB2YXIgaGFzaFV0aWxzID0gcmVxdWlyZSgnLi9icm93c2VySGFzaFV0aWxzJyk7CiAgCiAgdmFyIEJMT0NLX1NJWkUgPSA2NDsKICAKICB2YXIgRElHRVNUX0xFTkdUSCA9IDIwOwogIAogIHZhciBLRVkgPSBuZXcgVWludDMyQXJyYXkoWwogICAgICAweDVhODI3OTk5LAogICAgICAweDZlZDllYmExLAogICAgICAweDhmMWJiY2RjIHwgMCwKICAgICAgMHhjYTYyYzFkNiB8IDAKICBdKTsKICAKICB2YXIgSU5JVCA9IFsKICAgICAgMHg2YTA5ZTY2NywKICAgICAgMHhiYjY3YWU4NSwKICAgICAgMHgzYzZlZjM3MiwKICAgICAgMHhhNTRmZjUzYSwKICAgICAgMHg1MTBlNTI3ZiwKICAgICAgMHg5YjA1Njg4YywKICAgICAgMHgxZjgzZDlhYiwKICAgICAgMHg1YmUwY2QxOSwKICBdOwogIAogIHZhciBNQVhfSEFTSEFCTEVfTEVOR1RIID0gTWF0aC5wb3coMiwgNTMpIC0gMTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBTaGExKCkgewogICAgICB0aGlzLmgwID0gMHg2NzQ1MjMwMTsKICAgICAgdGhpcy5oMSA9IDB4RUZDREFCODk7CiAgICAgIHRoaXMuaDIgPSAweDk4QkFEQ0ZFOwogICAgICB0aGlzLmgzID0gMHgxMDMyNTQ3NjsKICAgICAgdGhpcy5oNCA9IDB4QzNEMkUxRjA7CiAgICAgIC8vIFRoZSBmaXJzdCA2NCBieXRlcyAoMTYgd29yZHMpIGlzIHRoZSBkYXRhIGNodW5rCiAgICAgIHRoaXMuYmxvY2sgPSBuZXcgVWludDMyQXJyYXkoODApOwogICAgICB0aGlzLm9mZnNldCA9IDA7CiAgICAgIHRoaXMuc2hpZnQgPSAyNDsKICAgICAgdGhpcy50b3RhbExlbmd0aCA9IDA7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IFNoYTE7CiAgCiAgU2hhMS5CTE9DS19TSVpFID0gQkxPQ0tfU0laRTsKICAKICBTaGExLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICBpZiAodGhpcy5maW5pc2hlZCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdHRlbXB0ZWQgdG8gdXBkYXRlIGFuIGFscmVhZHkgZmluaXNoZWQgaGFzaC4nKTsKICAgICAgfQogIAogICAgICBpZiAoaGFzaFV0aWxzLmlzRW1wdHlEYXRhKGRhdGEpKSB7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogIAogICAgICBkYXRhID0gaGFzaFV0aWxzLmNvbnZlcnRUb0J1ZmZlcihkYXRhKTsKICAKICAgICAgdmFyIGxlbmd0aCA9IGRhdGEubGVuZ3RoOwogICAgICB0aGlzLnRvdGFsTGVuZ3RoICs9IGxlbmd0aCAqIDg7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHRoaXMud3JpdGUoZGF0YVtpXSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBTaGExLnByb3RvdHlwZS53cml0ZSA9IGZ1bmN0aW9uIHdyaXRlKGJ5dGUpIHsKICAgICAgdGhpcy5ibG9ja1t0aGlzLm9mZnNldF0gfD0gKGJ5dGUgJiAweGZmKSA8PCB0aGlzLnNoaWZ0OwogICAgICBpZiAodGhpcy5zaGlmdCkgewogICAgICAgICAgdGhpcy5zaGlmdCAtPSA4OwogICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5vZmZzZXQrKzsKICAgICAgICAgIHRoaXMuc2hpZnQgPSAyNDsKICAgICAgfQogIAogICAgICBpZiAodGhpcy5vZmZzZXQgPT09IDE2KSB0aGlzLnByb2Nlc3NCbG9jaygpOwogIH07CiAgCiAgU2hhMS5wcm90b3R5cGUuZGlnZXN0ID0gZnVuY3Rpb24gKGVuY29kaW5nKSB7CiAgICAgIC8vIFBhZAogICAgICB0aGlzLndyaXRlKDB4ODApOwogICAgICBpZiAodGhpcy5vZmZzZXQgPiAxNCB8fCAodGhpcy5vZmZzZXQgPT09IDE0ICYmIHRoaXMuc2hpZnQgPCAyNCkpIHsKICAgICAgICB0aGlzLnByb2Nlc3NCbG9jaygpOwogICAgICB9CiAgICAgIHRoaXMub2Zmc2V0ID0gMTQ7CiAgICAgIHRoaXMuc2hpZnQgPSAyNDsKICAKICAgICAgLy8gNjQtYml0IGxlbmd0aCBiaWctZW5kaWFuCiAgICAgIHRoaXMud3JpdGUoMHgwMCk7IC8vIG51bWJlcnMgdGhpcyBiaWcgYXJlbid0IGFjY3VyYXRlIGluIGphdmFzY3JpcHQgYW55d2F5CiAgICAgIHRoaXMud3JpdGUoMHgwMCk7IC8vIC4uU28ganVzdCBoYXJkLWNvZGUgdG8gemVyby4KICAgICAgdGhpcy53cml0ZSh0aGlzLnRvdGFsTGVuZ3RoID4gMHhmZmZmZmZmZmZmID8gdGhpcy50b3RhbExlbmd0aCAvIDB4MTAwMDAwMDAwMDAgOiAweDAwKTsKICAgICAgdGhpcy53cml0ZSh0aGlzLnRvdGFsTGVuZ3RoID4gMHhmZmZmZmZmZiA/IHRoaXMudG90YWxMZW5ndGggLyAweDEwMDAwMDAwMCA6IDB4MDApOwogICAgICBmb3IgKHZhciBzID0gMjQ7IHMgPj0gMDsgcyAtPSA4KSB7CiAgICAgICAgICB0aGlzLndyaXRlKHRoaXMudG90YWxMZW5ndGggPj4gcyk7CiAgICAgIH0KICAgICAgLy8gVGhlIHZhbHVlIGluIHN0YXRlIGlzIGxpdHRsZS1lbmRpYW4gcmF0aGVyIHRoYW4gYmlnLWVuZGlhbiwgc28gZmxpcAogICAgICAvLyBlYWNoIHdvcmQgaW50byBhIG5ldyBVaW50OEFycmF5CiAgICAgIHZhciBvdXQgPSBuZXcgQnVmZmVyKERJR0VTVF9MRU5HVEgpOwogICAgICB2YXIgb3V0VmlldyA9IG5ldyBEYXRhVmlldyhvdXQuYnVmZmVyKTsKICAgICAgb3V0Vmlldy5zZXRVaW50MzIoMCwgdGhpcy5oMCwgZmFsc2UpOwogICAgICBvdXRWaWV3LnNldFVpbnQzMig0LCB0aGlzLmgxLCBmYWxzZSk7CiAgICAgIG91dFZpZXcuc2V0VWludDMyKDgsIHRoaXMuaDIsIGZhbHNlKTsKICAgICAgb3V0Vmlldy5zZXRVaW50MzIoMTIsIHRoaXMuaDMsIGZhbHNlKTsKICAgICAgb3V0Vmlldy5zZXRVaW50MzIoMTYsIHRoaXMuaDQsIGZhbHNlKTsKICAKICAgICAgcmV0dXJuIGVuY29kaW5nID8gb3V0LnRvU3RyaW5nKGVuY29kaW5nKSA6IG91dDsKICB9OwogIAogIFNoYTEucHJvdG90eXBlLnByb2Nlc3NCbG9jayA9IGZ1bmN0aW9uIHByb2Nlc3NCbG9jaygpIHsKICAgICAgLy8gRXh0ZW5kIHRoZSBzaXh0ZWVuIDMyLWJpdCB3b3JkcyBpbnRvIGVpZ2h0eSAzMi1iaXQgd29yZHM6CiAgICAgIGZvciAodmFyIGkgPSAxNjsgaSA8IDgwOyBpKyspIHsKICAgICAgICB2YXIgdyA9IHRoaXMuYmxvY2tbaSAtIDNdIF4gdGhpcy5ibG9ja1tpIC0gOF0gXiB0aGlzLmJsb2NrW2kgLSAxNF0gXiB0aGlzLmJsb2NrW2kgLSAxNl07CiAgICAgICAgdGhpcy5ibG9ja1tpXSA9ICh3IDw8IDEpIHwgKHcgPj4+IDMxKTsKICAgICAgfQogIAogICAgICAvLyBJbml0aWFsaXplIGhhc2ggdmFsdWUgZm9yIHRoaXMgY2h1bms6CiAgICAgIHZhciBhID0gdGhpcy5oMDsKICAgICAgdmFyIGIgPSB0aGlzLmgxOwogICAgICB2YXIgYyA9IHRoaXMuaDI7CiAgICAgIHZhciBkID0gdGhpcy5oMzsKICAgICAgdmFyIGUgPSB0aGlzLmg0OwogICAgICB2YXIgZiwgazsKICAKICAgICAgLy8gTWFpbiBsb29wOgogICAgICBmb3IgKGkgPSAwOyBpIDwgODA7IGkrKykgewogICAgICAgIGlmIChpIDwgMjApIHsKICAgICAgICAgIGYgPSBkIF4gKGIgJiAoYyBeIGQpKTsKICAgICAgICAgIGsgPSAweDVBODI3OTk5OwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChpIDwgNDApIHsKICAgICAgICAgIGYgPSBiIF4gYyBeIGQ7CiAgICAgICAgICBrID0gMHg2RUQ5RUJBMTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoaSA8IDYwKSB7CiAgICAgICAgICBmID0gKGIgJiBjKSB8IChkICYgKGIgfCBjKSk7CiAgICAgICAgICBrID0gMHg4RjFCQkNEQzsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICBmID0gYiBeIGMgXiBkOwogICAgICAgICAgayA9IDB4Q0E2MkMxRDY7CiAgICAgICAgfQogICAgICAgIHZhciB0ZW1wID0gKGEgPDwgNSB8IGEgPj4+IDI3KSArIGYgKyBlICsgayArICh0aGlzLmJsb2NrW2ldfDApOwogICAgICAgIGUgPSBkOwogICAgICAgIGQgPSBjOwogICAgICAgIGMgPSAoYiA8PCAzMCB8IGIgPj4+IDIpOwogICAgICAgIGIgPSBhOwogICAgICAgIGEgPSB0ZW1wOwogICAgICB9CiAgCiAgICAgIC8vIEFkZCB0aGlzIGNodW5rJ3MgaGFzaCB0byByZXN1bHQgc28gZmFyOgogICAgICB0aGlzLmgwID0gKHRoaXMuaDAgKyBhKSB8IDA7CiAgICAgIHRoaXMuaDEgPSAodGhpcy5oMSArIGIpIHwgMDsKICAgICAgdGhpcy5oMiA9ICh0aGlzLmgyICsgYykgfCAwOwogICAgICB0aGlzLmgzID0gKHRoaXMuaDMgKyBkKSB8IDA7CiAgICAgIHRoaXMuaDQgPSAodGhpcy5oNCArIGUpIHwgMDsKICAKICAgICAgLy8gVGhlIGJsb2NrIGlzIG5vdyByZXVzYWJsZS4KICAgICAgdGhpcy5vZmZzZXQgPSAwOwogICAgICBmb3IgKGkgPSAwOyBpIDwgMTY7IGkrKykgewogICAgICAgICAgdGhpcy5ibG9ja1tpXSA9IDA7CiAgICAgIH0KICB9OwogIAogIH0seyIuL2Jyb3dzZXJIYXNoVXRpbHMiOjExLCJidWZmZXIvIjo4MH1dLDE1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKICB2YXIgaGFzaFV0aWxzID0gcmVxdWlyZSgnLi9icm93c2VySGFzaFV0aWxzJyk7CiAgCiAgdmFyIEJMT0NLX1NJWkUgPSA2NDsKICAKICB2YXIgRElHRVNUX0xFTkdUSCA9IDMyOwogIAogIHZhciBLRVkgPSBuZXcgVWludDMyQXJyYXkoWwogICAgICAweDQyOGEyZjk4LAogICAgICAweDcxMzc0NDkxLAogICAgICAweGI1YzBmYmNmLAogICAgICAweGU5YjVkYmE1LAogICAgICAweDM5NTZjMjViLAogICAgICAweDU5ZjExMWYxLAogICAgICAweDkyM2Y4MmE0LAogICAgICAweGFiMWM1ZWQ1LAogICAgICAweGQ4MDdhYTk4LAogICAgICAweDEyODM1YjAxLAogICAgICAweDI0MzE4NWJlLAogICAgICAweDU1MGM3ZGMzLAogICAgICAweDcyYmU1ZDc0LAogICAgICAweDgwZGViMWZlLAogICAgICAweDliZGMwNmE3LAogICAgICAweGMxOWJmMTc0LAogICAgICAweGU0OWI2OWMxLAogICAgICAweGVmYmU0Nzg2LAogICAgICAweDBmYzE5ZGM2LAogICAgICAweDI0MGNhMWNjLAogICAgICAweDJkZTkyYzZmLAogICAgICAweDRhNzQ4NGFhLAogICAgICAweDVjYjBhOWRjLAogICAgICAweDc2Zjk4OGRhLAogICAgICAweDk4M2U1MTUyLAogICAgICAweGE4MzFjNjZkLAogICAgICAweGIwMDMyN2M4LAogICAgICAweGJmNTk3ZmM3LAogICAgICAweGM2ZTAwYmYzLAogICAgICAweGQ1YTc5MTQ3LAogICAgICAweDA2Y2E2MzUxLAogICAgICAweDE0MjkyOTY3LAogICAgICAweDI3YjcwYTg1LAogICAgICAweDJlMWIyMTM4LAogICAgICAweDRkMmM2ZGZjLAogICAgICAweDUzMzgwZDEzLAogICAgICAweDY1MGE3MzU0LAogICAgICAweDc2NmEwYWJiLAogICAgICAweDgxYzJjOTJlLAogICAgICAweDkyNzIyYzg1LAogICAgICAweGEyYmZlOGExLAogICAgICAweGE4MWE2NjRiLAogICAgICAweGMyNGI4YjcwLAogICAgICAweGM3NmM1MWEzLAogICAgICAweGQxOTJlODE5LAogICAgICAweGQ2OTkwNjI0LAogICAgICAweGY0MGUzNTg1LAogICAgICAweDEwNmFhMDcwLAogICAgICAweDE5YTRjMTE2LAogICAgICAweDFlMzc2YzA4LAogICAgICAweDI3NDg3NzRjLAogICAgICAweDM0YjBiY2I1LAogICAgICAweDM5MWMwY2IzLAogICAgICAweDRlZDhhYTRhLAogICAgICAweDViOWNjYTRmLAogICAgICAweDY4MmU2ZmYzLAogICAgICAweDc0OGY4MmVlLAogICAgICAweDc4YTU2MzZmLAogICAgICAweDg0Yzg3ODE0LAogICAgICAweDhjYzcwMjA4LAogICAgICAweDkwYmVmZmZhLAogICAgICAweGE0NTA2Y2ViLAogICAgICAweGJlZjlhM2Y3LAogICAgICAweGM2NzE3OGYyCiAgXSk7CiAgCiAgdmFyIElOSVQgPSBbCiAgICAgIDB4NmEwOWU2NjcsCiAgICAgIDB4YmI2N2FlODUsCiAgICAgIDB4M2M2ZWYzNzIsCiAgICAgIDB4YTU0ZmY1M2EsCiAgICAgIDB4NTEwZTUyN2YsCiAgICAgIDB4OWIwNTY4OGMsCiAgICAgIDB4MWY4M2Q5YWIsCiAgICAgIDB4NWJlMGNkMTksCiAgXTsKICAKICB2YXIgTUFYX0hBU0hBQkxFX0xFTkdUSCA9IE1hdGgucG93KDIsIDUzKSAtIDE7CiAgCiAgLyoqCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBTaGEyNTYoKSB7CiAgICAgIHRoaXMuc3RhdGUgPSBbCiAgICAgICAgICAweDZhMDllNjY3LAogICAgICAgICAgMHhiYjY3YWU4NSwKICAgICAgICAgIDB4M2M2ZWYzNzIsCiAgICAgICAgICAweGE1NGZmNTNhLAogICAgICAgICAgMHg1MTBlNTI3ZiwKICAgICAgICAgIDB4OWIwNTY4OGMsCiAgICAgICAgICAweDFmODNkOWFiLAogICAgICAgICAgMHg1YmUwY2QxOSwKICAgICAgXTsKICAgICAgdGhpcy50ZW1wID0gbmV3IEludDMyQXJyYXkoNjQpOwogICAgICB0aGlzLmJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KDY0KTsKICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICB0aGlzLmJ5dGVzSGFzaGVkID0gMDsKICAgICAgLyoqCiAgICAgICAqIEBwcml2YXRlCiAgICAgICAqLwogICAgICB0aGlzLmZpbmlzaGVkID0gZmFsc2U7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IFNoYTI1NjsKICAKICBTaGEyNTYuQkxPQ0tfU0laRSA9IEJMT0NLX1NJWkU7CiAgCiAgU2hhMjU2LnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICBpZiAodGhpcy5maW5pc2hlZCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdHRlbXB0ZWQgdG8gdXBkYXRlIGFuIGFscmVhZHkgZmluaXNoZWQgaGFzaC4nKTsKICAgICAgfQogIAogICAgICBpZiAoaGFzaFV0aWxzLmlzRW1wdHlEYXRhKGRhdGEpKSB7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogIAogICAgICBkYXRhID0gaGFzaFV0aWxzLmNvbnZlcnRUb0J1ZmZlcihkYXRhKTsKICAKICAgICAgdmFyIHBvc2l0aW9uID0gMDsKICAgICAgdmFyIGJ5dGVMZW5ndGggPSBkYXRhLmJ5dGVMZW5ndGg7CiAgICAgIHRoaXMuYnl0ZXNIYXNoZWQgKz0gYnl0ZUxlbmd0aDsKICAgICAgaWYgKHRoaXMuYnl0ZXNIYXNoZWQgKiA4ID4gTUFYX0hBU0hBQkxFX0xFTkdUSCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgaGFzaCBtb3JlIHRoYW4gMl41MyAtIDEgYml0cycpOwogICAgICB9CiAgCiAgICAgIHdoaWxlIChieXRlTGVuZ3RoID4gMCkgewogICAgICAgICAgdGhpcy5idWZmZXJbdGhpcy5idWZmZXJMZW5ndGgrK10gPSBkYXRhW3Bvc2l0aW9uKytdOwogICAgICAgICAgYnl0ZUxlbmd0aC0tOwogICAgICAgICAgaWYgKHRoaXMuYnVmZmVyTGVuZ3RoID09PSBCTE9DS19TSVpFKSB7CiAgICAgICAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgU2hhMjU2LnByb3RvdHlwZS5kaWdlc3QgPSBmdW5jdGlvbiAoZW5jb2RpbmcpIHsKICAgICAgaWYgKCF0aGlzLmZpbmlzaGVkKSB7CiAgICAgICAgICB2YXIgYml0c0hhc2hlZCA9IHRoaXMuYnl0ZXNIYXNoZWQgKiA4OwogICAgICAgICAgdmFyIGJ1ZmZlclZpZXcgPSBuZXcgRGF0YVZpZXcodGhpcy5idWZmZXIuYnVmZmVyLCB0aGlzLmJ1ZmZlci5ieXRlT2Zmc2V0LCB0aGlzLmJ1ZmZlci5ieXRlTGVuZ3RoKTsKICAgICAgICAgIHZhciB1bmRlY29yYXRlZExlbmd0aCA9IHRoaXMuYnVmZmVyTGVuZ3RoOwogICAgICAgICAgYnVmZmVyVmlldy5zZXRVaW50OCh0aGlzLmJ1ZmZlckxlbmd0aCsrLCAweDgwKTsKICAgICAgICAgIC8vIEVuc3VyZSB0aGUgZmluYWwgYmxvY2sgaGFzIGVub3VnaCByb29tIGZvciB0aGUgaGFzaGVkIGxlbmd0aAogICAgICAgICAgaWYgKHVuZGVjb3JhdGVkTGVuZ3RoICUgQkxPQ0tfU0laRSA+PSBCTE9DS19TSVpFIC0gOCkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmJ1ZmZlckxlbmd0aDsgaSA8IEJMT0NLX1NJWkU7IGkrKykgewogICAgICAgICAgICAgICAgICBidWZmZXJWaWV3LnNldFVpbnQ4KGksIDApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgICAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5idWZmZXJMZW5ndGg7IGkgPCBCTE9DS19TSVpFIC0gODsgaSsrKSB7CiAgICAgICAgICAgICAgYnVmZmVyVmlldy5zZXRVaW50OChpLCAwKTsKICAgICAgICAgIH0KICAgICAgICAgIGJ1ZmZlclZpZXcuc2V0VWludDMyKEJMT0NLX1NJWkUgLSA4LCBNYXRoLmZsb29yKGJpdHNIYXNoZWQgLyAweDEwMDAwMDAwMCksIHRydWUpOwogICAgICAgICAgYnVmZmVyVmlldy5zZXRVaW50MzIoQkxPQ0tfU0laRSAtIDQsIGJpdHNIYXNoZWQpOwogICAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgICB0aGlzLmZpbmlzaGVkID0gdHJ1ZTsKICAgICAgfQogICAgICAvLyBUaGUgdmFsdWUgaW4gc3RhdGUgaXMgbGl0dGxlLWVuZGlhbiByYXRoZXIgdGhhbiBiaWctZW5kaWFuLCBzbyBmbGlwCiAgICAgIC8vIGVhY2ggd29yZCBpbnRvIGEgbmV3IFVpbnQ4QXJyYXkKICAgICAgdmFyIG91dCA9IG5ldyBCdWZmZXIoRElHRVNUX0xFTkdUSCk7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgODsgaSsrKSB7CiAgICAgICAgICBvdXRbaSAqIDRdID0gKHRoaXMuc3RhdGVbaV0gPj4+IDI0KSAmIDB4ZmY7CiAgICAgICAgICBvdXRbaSAqIDQgKyAxXSA9ICh0aGlzLnN0YXRlW2ldID4+PiAxNikgJiAweGZmOwogICAgICAgICAgb3V0W2kgKiA0ICsgMl0gPSAodGhpcy5zdGF0ZVtpXSA+Pj4gOCkgJiAweGZmOwogICAgICAgICAgb3V0W2kgKiA0ICsgM10gPSAodGhpcy5zdGF0ZVtpXSA+Pj4gMCkgJiAweGZmOwogICAgICB9CiAgICAgIHJldHVybiBlbmNvZGluZyA/IG91dC50b1N0cmluZyhlbmNvZGluZykgOiBvdXQ7CiAgfTsKICAKICBTaGEyNTYucHJvdG90eXBlLmhhc2hCdWZmZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfYSA9IHRoaXMsCiAgICAgICAgICBidWZmZXIgPSBfYS5idWZmZXIsCiAgICAgICAgICBzdGF0ZSA9IF9hLnN0YXRlOwogICAgICB2YXIgc3RhdGUwID0gc3RhdGVbMF0sCiAgICAgICAgICBzdGF0ZTEgPSBzdGF0ZVsxXSwKICAgICAgICAgIHN0YXRlMiA9IHN0YXRlWzJdLAogICAgICAgICAgc3RhdGUzID0gc3RhdGVbM10sCiAgICAgICAgICBzdGF0ZTQgPSBzdGF0ZVs0XSwKICAgICAgICAgIHN0YXRlNSA9IHN0YXRlWzVdLAogICAgICAgICAgc3RhdGU2ID0gc3RhdGVbNl0sCiAgICAgICAgICBzdGF0ZTcgPSBzdGF0ZVs3XTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBCTE9DS19TSVpFOyBpKyspIHsKICAgICAgICAgIGlmIChpIDwgMTYpIHsKICAgICAgICAgICAgICB0aGlzLnRlbXBbaV0gPSAoKChidWZmZXJbaSAqIDRdICYgMHhmZikgPDwgMjQpIHwKICAgICAgICAgICAgICAgICAgKChidWZmZXJbKGkgKiA0KSArIDFdICYgMHhmZikgPDwgMTYpIHwKICAgICAgICAgICAgICAgICAgKChidWZmZXJbKGkgKiA0KSArIDJdICYgMHhmZikgPDwgOCkgfAogICAgICAgICAgICAgICAgICAoYnVmZmVyWyhpICogNCkgKyAzXSAmIDB4ZmYpKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHZhciB1ID0gdGhpcy50ZW1wW2kgLSAyXTsKICAgICAgICAgICAgICB2YXIgdDFfMSA9ICh1ID4+PiAxNyB8IHUgPDwgMTUpIF4KICAgICAgICAgICAgICAgICAgKHUgPj4+IDE5IHwgdSA8PCAxMykgXgogICAgICAgICAgICAgICAgICAodSA+Pj4gMTApOwogICAgICAgICAgICAgIHUgPSB0aGlzLnRlbXBbaSAtIDE1XTsKICAgICAgICAgICAgICB2YXIgdDJfMSA9ICh1ID4+PiA3IHwgdSA8PCAyNSkgXgogICAgICAgICAgICAgICAgICAodSA+Pj4gMTggfCB1IDw8IDE0KSBeCiAgICAgICAgICAgICAgICAgICh1ID4+PiAzKTsKICAgICAgICAgICAgICB0aGlzLnRlbXBbaV0gPSAodDFfMSArIHRoaXMudGVtcFtpIC0gN10gfCAwKSArCiAgICAgICAgICAgICAgICAgICh0Ml8xICsgdGhpcy50ZW1wW2kgLSAxNl0gfCAwKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0MSA9ICgoKCgoc3RhdGU0ID4+PiA2IHwgc3RhdGU0IDw8IDI2KSBeCiAgICAgICAgICAgICAgKHN0YXRlNCA+Pj4gMTEgfCBzdGF0ZTQgPDwgMjEpIF4KICAgICAgICAgICAgICAoc3RhdGU0ID4+PiAyNSB8IHN0YXRlNCA8PCA3KSkKICAgICAgICAgICAgICArICgoc3RhdGU0ICYgc3RhdGU1KSBeICh+c3RhdGU0ICYgc3RhdGU2KSkpIHwgMCkKICAgICAgICAgICAgICArICgoc3RhdGU3ICsgKChLRVlbaV0gKyB0aGlzLnRlbXBbaV0pIHwgMCkpIHwgMCkpIHwgMDsKICAgICAgICAgIHZhciB0MiA9ICgoKHN0YXRlMCA+Pj4gMiB8IHN0YXRlMCA8PCAzMCkgXgogICAgICAgICAgICAgIChzdGF0ZTAgPj4+IDEzIHwgc3RhdGUwIDw8IDE5KSBeCiAgICAgICAgICAgICAgKHN0YXRlMCA+Pj4gMjIgfCBzdGF0ZTAgPDwgMTApKSArICgoc3RhdGUwICYgc3RhdGUxKSBeIChzdGF0ZTAgJiBzdGF0ZTIpIF4gKHN0YXRlMSAmIHN0YXRlMikpKSB8IDA7CiAgICAgICAgICBzdGF0ZTcgPSBzdGF0ZTY7CiAgICAgICAgICBzdGF0ZTYgPSBzdGF0ZTU7CiAgICAgICAgICBzdGF0ZTUgPSBzdGF0ZTQ7CiAgICAgICAgICBzdGF0ZTQgPSAoc3RhdGUzICsgdDEpIHwgMDsKICAgICAgICAgIHN0YXRlMyA9IHN0YXRlMjsKICAgICAgICAgIHN0YXRlMiA9IHN0YXRlMTsKICAgICAgICAgIHN0YXRlMSA9IHN0YXRlMDsKICAgICAgICAgIHN0YXRlMCA9ICh0MSArIHQyKSB8IDA7CiAgICAgIH0KICAgICAgc3RhdGVbMF0gKz0gc3RhdGUwOwogICAgICBzdGF0ZVsxXSArPSBzdGF0ZTE7CiAgICAgIHN0YXRlWzJdICs9IHN0YXRlMjsKICAgICAgc3RhdGVbM10gKz0gc3RhdGUzOwogICAgICBzdGF0ZVs0XSArPSBzdGF0ZTQ7CiAgICAgIHN0YXRlWzVdICs9IHN0YXRlNTsKICAgICAgc3RhdGVbNl0gKz0gc3RhdGU2OwogICAgICBzdGF0ZVs3XSArPSBzdGF0ZTc7CiAgfTsKICAKICB9LHsiLi9icm93c2VySGFzaFV0aWxzIjoxMSwiYnVmZmVyLyI6ODB9XSwxNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChwcm9jZXNzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4vdXRpbCcpOwogIAogIC8vIGJyb3dzZXIgc3BlY2lmaWMgbW9kdWxlcwogIHV0aWwuY3J5cHRvLmxpYiA9IHJlcXVpcmUoJy4vYnJvd3NlckNyeXB0b0xpYicpOwogIHV0aWwuQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKICB1dGlsLnVybCA9IHJlcXVpcmUoJ3VybC8nKTsKICB1dGlsLnF1ZXJ5c3RyaW5nID0gcmVxdWlyZSgncXVlcnlzdHJpbmcvJyk7CiAgdXRpbC5yZWFsQ2xvY2sgPSByZXF1aXJlKCcuL3JlYWxjbG9jay9icm93c2VyQ2xvY2snKTsKICB1dGlsLmVudmlyb25tZW50ID0gJ2pzJzsKICB1dGlsLmNyZWF0ZUV2ZW50U3RyZWFtID0gcmVxdWlyZSgnLi9ldmVudC1zdHJlYW0vYnVmZmVyZWQtY3JlYXRlLWV2ZW50LXN0cmVhbScpLmNyZWF0ZUV2ZW50U3RyZWFtOwogIHV0aWwuaXNCcm93c2VyID0gZnVuY3Rpb24oKSB7IHJldHVybiB0cnVlOyB9OwogIHV0aWwuaXNOb2RlID0gZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZTsgfTsKICAKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1M7CiAgCiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscycpOwogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMvY3JlZGVudGlhbF9wcm92aWRlcl9jaGFpbicpOwogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMvdGVtcG9yYXJ5X2NyZWRlbnRpYWxzJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscy9jaGFpbmFibGVfdGVtcG9yYXJ5X2NyZWRlbnRpYWxzJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscy93ZWJfaWRlbnRpdHlfY3JlZGVudGlhbHMnKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzL2NvZ25pdG9faWRlbnRpdHlfY3JlZGVudGlhbHMnKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzL3NhbWxfY3JlZGVudGlhbHMnKTsKICAKICAvLyBMb2FkIHRoZSBET01QYXJzZXIgWE1MIHBhcnNlcgogIEFXUy5YTUwuUGFyc2VyID0gcmVxdWlyZSgnLi94bWwvYnJvd3Nlcl9wYXJzZXInKTsKICAKICAvLyBMb2FkIHRoZSBYSFIgSHR0cENsaWVudAogIHJlcXVpcmUoJy4vaHR0cC94aHInKTsKICAKICBpZiAodHlwZW9mIHByb2Nlc3MgPT09ICd1bmRlZmluZWQnKSB7CiAgICB2YXIgcHJvY2VzcyA9IHsKICAgICAgYnJvd3NlcjogdHJ1ZQogICAgfTsKICB9CiAgCiAgfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCiAgfSx7Ii4vYnJvd3NlckNyeXB0b0xpYiI6MTAsIi4vY29yZSI6MTgsIi4vY3JlZGVudGlhbHMiOjE5LCIuL2NyZWRlbnRpYWxzL2NoYWluYWJsZV90ZW1wb3JhcnlfY3JlZGVudGlhbHMiOjIwLCIuL2NyZWRlbnRpYWxzL2NvZ25pdG9faWRlbnRpdHlfY3JlZGVudGlhbHMiOjIxLCIuL2NyZWRlbnRpYWxzL2NyZWRlbnRpYWxfcHJvdmlkZXJfY2hhaW4iOjIyLCIuL2NyZWRlbnRpYWxzL3NhbWxfY3JlZGVudGlhbHMiOjIzLCIuL2NyZWRlbnRpYWxzL3RlbXBvcmFyeV9jcmVkZW50aWFscyI6MjQsIi4vY3JlZGVudGlhbHMvd2ViX2lkZW50aXR5X2NyZWRlbnRpYWxzIjoyNSwiLi9ldmVudC1zdHJlYW0vYnVmZmVyZWQtY3JlYXRlLWV2ZW50LXN0cmVhbSI6MjcsIi4vaHR0cC94aHIiOjM1LCIuL3JlYWxjbG9jay9icm93c2VyQ2xvY2siOjUyLCIuL3V0aWwiOjcxLCIuL3htbC9icm93c2VyX3BhcnNlciI6NzIsIl9wcm9jZXNzIjo4NSwiYnVmZmVyLyI6ODAsInF1ZXJ5c3RyaW5nLyI6OTIsInVybC8iOjk0fV0sMTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscy9jcmVkZW50aWFsX3Byb3ZpZGVyX2NoYWluJyk7CiAgdmFyIFByb21pc2VzRGVwZW5kZW5jeTsKICAKICAvKioKICAgKiBUaGUgbWFpbiBjb25maWd1cmF0aW9uIGNsYXNzIHVzZWQgYnkgYWxsIHNlcnZpY2Ugb2JqZWN0cyB0byBzZXQKICAgKiB0aGUgcmVnaW9uLCBjcmVkZW50aWFscywgYW5kIG90aGVyIG9wdGlvbnMgZm9yIHJlcXVlc3RzLgogICAqCiAgICogQnkgZGVmYXVsdCwgY3JlZGVudGlhbHMgYW5kIHJlZ2lvbiBzZXR0aW5ncyBhcmUgbGVmdCB1bmNvbmZpZ3VyZWQuCiAgICogVGhpcyBzaG91bGQgYmUgY29uZmlndXJlZCBieSB0aGUgYXBwbGljYXRpb24gYmVmb3JlIHVzaW5nIGFueQogICAqIEFXUyBzZXJ2aWNlIEFQSXMuCiAgICoKICAgKiBJbiBvcmRlciB0byBzZXQgZ2xvYmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9ucywgcHJvcGVydGllcyBzaG91bGQKICAgKiBiZSBhc3NpZ25lZCB0byB0aGUgZ2xvYmFsIHtBV1MuY29uZmlnfSBvYmplY3QuCiAgICoKICAgKiBAc2VlIEFXUy5jb25maWcKICAgKgogICAqIEAhZ3JvdXAgR2VuZXJhbCBDb25maWd1cmF0aW9uIE9wdGlvbnMKICAgKgogICAqIEAhYXR0cmlidXRlIGNyZWRlbnRpYWxzCiAgICogICBAcmV0dXJuIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBBV1MgY3JlZGVudGlhbHMgdG8gc2lnbiByZXF1ZXN0cyB3aXRoLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcmVnaW9uCiAgICogICBAZXhhbXBsZSBTZXQgdGhlIGdsb2JhbCByZWdpb24gc2V0dGluZyB0byB1cy13ZXN0LTIKICAgKiAgICAgQVdTLmNvbmZpZy51cGRhdGUoe3JlZ2lvbjogJ3VzLXdlc3QtMid9KTsKICAgKiAgIEByZXR1cm4gW0FXUy5DcmVkZW50aWFsc10gVGhlIHJlZ2lvbiB0byBzZW5kIHNlcnZpY2UgcmVxdWVzdHMgdG8uCiAgICogICBAc2VlIGh0dHA6Ly9kb2NzLmFtYXpvbndlYnNlcnZpY2VzLmNvbS9nZW5lcmFsL2xhdGVzdC9nci9yYW5kZS5odG1sCiAgICogICAgIEEgbGlzdCBvZiBhdmFpbGFibGUgZW5kcG9pbnRzIGZvciBlYWNoIEFXUyBzZXJ2aWNlCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBtYXhSZXRyaWVzCiAgICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbWF4aW11bSBhbW91bnQgb2YgcmV0cmllcyB0byBwZXJmb3JtIGZvciBhCiAgICogICAgIHNlcnZpY2UgcmVxdWVzdC4gQnkgZGVmYXVsdCB0aGlzIHZhbHVlIGlzIGNhbGN1bGF0ZWQgYnkgdGhlIHNwZWNpZmljCiAgICogICAgIHNlcnZpY2Ugb2JqZWN0IHRoYXQgdGhlIHJlcXVlc3QgaXMgYmVpbmcgbWFkZSB0by4KICAgKgogICAqIEAhYXR0cmlidXRlIG1heFJlZGlyZWN0cwogICAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIG1heGltdW0gYW1vdW50IG9mIHJlZGlyZWN0cyB0byBmb2xsb3cgZm9yIGEKICAgKiAgICAgc2VydmljZSByZXF1ZXN0LiBEZWZhdWx0cyB0byAxMC4KICAgKgogICAqIEAhYXR0cmlidXRlIHBhcmFtVmFsaWRhdGlvbgogICAqICAgQHJldHVybiBbQm9vbGVhbnxtYXBdIHdoZXRoZXIgaW5wdXQgcGFyYW1ldGVycyBzaG91bGQgYmUgdmFsaWRhdGVkIGFnYWluc3QKICAgKiAgICAgdGhlIG9wZXJhdGlvbiBkZXNjcmlwdGlvbiBiZWZvcmUgc2VuZGluZyB0aGUgcmVxdWVzdC4gRGVmYXVsdHMgdG8gdHJ1ZS4KICAgKiAgICAgUGFzcyBhIG1hcCB0byBlbmFibGUgYW55IG9mIHRoZSBmb2xsb3dpbmcgc3BlY2lmaWMgdmFsaWRhdGlvbiBmZWF0dXJlczoKICAgKgogICAqICAgICAqICoqbWluKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWluCiAgICogICAgICAgY29uc3RyYWludC4gVGhpcyBpcyBlbmFibGVkIGJ5IGRlZmF1bHQgd2hlbiBwYXJhbVZhbGlkYXRpb24gaXMgc2V0CiAgICogICAgICAgdG8gYHRydWVgLgogICAqICAgICAqICoqbWF4KiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWF4CiAgICogICAgICAgY29uc3RyYWludC4KICAgKiAgICAgKiAqKnBhdHRlcm4qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIGEKICAgKiAgICAgICByZWd1bGFyIGV4cHJlc3Npb24uCiAgICogICAgICogKiplbnVtKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBvbmUKICAgKiAgICAgICBvZiB0aGUgYWxsb3dhYmxlIGVudW0gdmFsdWVzLgogICAqCiAgICogQCFhdHRyaWJ1dGUgY29tcHV0ZUNoZWNrc3VtcwogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBjb21wdXRlIGNoZWNrc3VtcyBmb3IgcGF5bG9hZCBib2RpZXMgd2hlbgogICAqICAgICB0aGUgc2VydmljZSBhY2NlcHRzIGl0IChjdXJyZW50bHkgc3VwcG9ydGVkIGluIFMzIG9ubHkpLgogICAqCiAgICogQCFhdHRyaWJ1dGUgY29udmVydFJlc3BvbnNlVHlwZXMKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdHlwZXMgYXJlIGNvbnZlcnRlZCB3aGVuIHBhcnNpbmcgcmVzcG9uc2UgZGF0YS4KICAgKiAgICAgQ3VycmVudGx5IG9ubHkgc3VwcG9ydGVkIGZvciBKU09OIGJhc2VkIHNlcnZpY2VzLiBUdXJuaW5nIHRoaXMgb2ZmIG1heQogICAqICAgICBpbXByb3ZlIHBlcmZvcm1hbmNlIG9uIGxhcmdlIHJlc3BvbnNlIHBheWxvYWRzLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBjb3JyZWN0Q2xvY2tTa2V3CiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIGFwcGx5IGEgY2xvY2sgc2tldyBjb3JyZWN0aW9uIGFuZCByZXRyeQogICAqICAgICByZXF1ZXN0cyB0aGF0IGZhaWwgYmVjYXVzZSBvZiBhbiBza2V3ZWQgY2xpZW50IGNsb2NrLiBEZWZhdWx0cyB0bwogICAqICAgICBgZmFsc2VgLgogICAqCiAgICogQCFhdHRyaWJ1dGUgc3NsRW5hYmxlZAogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciBTU0wgaXMgZW5hYmxlZCBmb3IgcmVxdWVzdHMKICAgKgogICAqIEAhYXR0cmlidXRlIHMzRm9yY2VQYXRoU3R5bGUKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gZm9yY2UgcGF0aCBzdHlsZSBVUkxzIGZvciBTMyBvYmplY3RzCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzM0J1Y2tldEVuZHBvaW50CiAgICogICBAbm90ZSBTZXR0aW5nIHRoaXMgY29uZmlndXJhdGlvbiBvcHRpb24gcmVxdWlyZXMgYW4gYGVuZHBvaW50YCB0byBiZQogICAqICAgICBwcm92aWRlZCBleHBsaWNpdGx5IHRvIHRoZSBzZXJ2aWNlIGNvbnN0cnVjdG9yLgogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0aGUgcHJvdmlkZWQgZW5kcG9pbnQgYWRkcmVzc2VzIGFuIGluZGl2aWR1YWwKICAgKiAgICAgYnVja2V0IChmYWxzZSBpZiBpdCBhZGRyZXNzZXMgdGhlIHJvb3QgQVBJIGVuZHBvaW50KS4KICAgKgogICAqIEAhYXR0cmlidXRlIHMzRGlzYWJsZUJvZHlTaWduaW5nCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIGRpc2FibGUgUzMgYm9keSBzaWduaW5nIHdoZW4gdXNpbmcgc2lnbmF0dXJlIHZlcnNpb24gYHY0YC4KICAgKiAgICAgQm9keSBzaWduaW5nIGNhbiBvbmx5IGJlIGRpc2FibGVkIHdoZW4gdXNpbmcgaHR0cHMuIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgKgogICAqIEAhYXR0cmlidXRlIHVzZUFjY2VsZXJhdGVFbmRwb2ludAogICAqICAgQG5vdGUgVGhpcyBjb25maWd1cmF0aW9uIG9wdGlvbiBpcyBvbmx5IGNvbXBhdGlibGUgd2l0aCBTMyB3aGlsZSBhY2Nlc3NpbmcKICAgKiAgICAgZG5zLWNvbXBhdGlibGUgYnVja2V0cy4KICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIFdoZXRoZXIgdG8gdXNlIHRoZSBBY2NlbGVyYXRlIGVuZHBvaW50IHdpdGggdGhlIFMzIHNlcnZpY2UuCiAgICogICAgIERlZmF1bHRzIHRvIGBmYWxzZWAuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSByZXRyeURlbGF5T3B0aW9ucwogICAqICAgQGV4YW1wbGUgU2V0IHRoZSBiYXNlIHJldHJ5IGRlbGF5IGZvciBhbGwgc2VydmljZXMgdG8gMzAwIG1zCiAgICogICAgIEFXUy5jb25maWcudXBkYXRlKHtyZXRyeURlbGF5T3B0aW9uczoge2Jhc2U6IDMwMH19KTsKICAgKiAgICAgLy8gRGVsYXlzIHdpdGggbWF4UmV0cmllcyA9IDM6IDMwMCwgNjAwLCAxMjAwCiAgICogICBAZXhhbXBsZSBTZXQgYSBjdXN0b20gYmFja29mZiBmdW5jdGlvbiB0byBwcm92aWRlIGRlbGF5IHZhbHVlcyBvbiByZXRyaWVzCiAgICogICAgIEFXUy5jb25maWcudXBkYXRlKHtyZXRyeURlbGF5T3B0aW9uczoge2N1c3RvbUJhY2tvZmY6IGZ1bmN0aW9uKHJldHJ5Q291bnQpIHsKICAgKiAgICAgICAvLyByZXR1cm5zIGRlbGF5IGluIG1zCiAgICogICAgIH19fSk7CiAgICogICBAcmV0dXJuIFttYXBdIEEgc2V0IG9mIG9wdGlvbnMgdG8gY29uZmlndXJlIHRoZSByZXRyeSBkZWxheSBvbiByZXRyeWFibGUgZXJyb3JzLgogICAqICAgICBDdXJyZW50bHkgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogICAqCiAgICogICAgICogKipiYXNlKiogW0ludGVnZXJdICZtZGFzaDsgVGhlIGJhc2UgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB1c2UgaW4gdGhlCiAgICogICAgICAgZXhwb25lbnRpYWwgYmFja29mZiBmb3Igb3BlcmF0aW9uIHJldHJpZXMuIERlZmF1bHRzIHRvIDEwMCBtcyBmb3IgYWxsIHNlcnZpY2VzIGV4Y2VwdAogICAqICAgICAgIER5bmFtb0RCLCB3aGVyZSBpdCBkZWZhdWx0cyB0byA1MG1zLgogICAqICAgICAqICoqY3VzdG9tQmFja29mZiAqKiBbZnVuY3Rpb25dICZtZGFzaDsgQSBjdXN0b20gZnVuY3Rpb24gdGhhdCBhY2NlcHRzIGEgcmV0cnkgY291bnQKICAgKiAgICAgICBhbmQgcmV0dXJucyB0aGUgYW1vdW50IG9mIHRpbWUgdG8gZGVsYXkgaW4gbWlsbGlzZWNvbmRzLiBUaGUgYGJhc2VgIG9wdGlvbiB3aWxsIGJlCiAgICogICAgICAgaWdub3JlZCBpZiB0aGlzIG9wdGlvbiBpcyBzdXBwbGllZC4KICAgKgogICAqIEAhYXR0cmlidXRlIGh0dHBPcHRpb25zCiAgICogICBAcmV0dXJuIFttYXBdIEEgc2V0IG9mIG9wdGlvbnMgdG8gcGFzcyB0byB0aGUgbG93LWxldmVsIEhUVFAgcmVxdWVzdC4KICAgKiAgICAgQ3VycmVudGx5IHN1cHBvcnRlZCBvcHRpb25zIGFyZToKICAgKgogICAqICAgICAqICoqcHJveHkqKiBbU3RyaW5nXSAmbWRhc2g7IHRoZSBVUkwgdG8gcHJveHkgcmVxdWVzdHMgdGhyb3VnaAogICAqICAgICAqICoqYWdlbnQqKiBbaHR0cC5BZ2VudCwgaHR0cHMuQWdlbnRdICZtZGFzaDsgdGhlIEFnZW50IG9iamVjdCB0byBwZXJmb3JtCiAgICogICAgICAgSFRUUCByZXF1ZXN0cyB3aXRoLiBVc2VkIGZvciBjb25uZWN0aW9uIHBvb2xpbmcuIE5vdGUgdGhhdCBmb3IKICAgKiAgICAgICBTU0wgY29ubmVjdGlvbnMsIGEgc3BlY2lhbCBBZ2VudCBvYmplY3QgaXMgdXNlZCBpbiBvcmRlciB0byBlbmFibGUKICAgKiAgICAgICBwZWVyIGNlcnRpZmljYXRlIHZlcmlmaWNhdGlvbi4gVGhpcyBmZWF0dXJlIGlzIG9ubHkgc3VwcG9ydGVkIGluIHRoZQogICAqICAgICAgIE5vZGUuanMgZW52aXJvbm1lbnQuCiAgICogICAgICogKipjb25uZWN0VGltZW91dCoqIFtJbnRlZ2VyXSAmbWRhc2g7IFNldHMgdGhlIHNvY2tldCB0byB0aW1lb3V0IGFmdGVyCiAgICogICAgICAgZmFpbGluZyB0byBlc3RhYmxpc2ggYSBjb25uZWN0aW9uIHdpdGggdGhlIHNlcnZlciBhZnRlcgogICAqICAgICAgIGBjb25uZWN0VGltZW91dGAgbWlsbGlzZWNvbmRzLiBUaGlzIHRpbWVvdXQgaGFzIG5vIGVmZmVjdCBvbmNlIGEgc29ja2V0CiAgICogICAgICAgY29ubmVjdGlvbiBoYXMgYmVlbiBlc3RhYmxpc2hlZC4KICAgKiAgICAgKiAqKnRpbWVvdXQqKiBbSW50ZWdlcl0gJm1kYXNoOyBTZXRzIHRoZSBzb2NrZXQgdG8gdGltZW91dCBhZnRlciB0aW1lb3V0CiAgICogICAgICAgbWlsbGlzZWNvbmRzIG9mIGluYWN0aXZpdHkgb24gdGhlIHNvY2tldC4gRGVmYXVsdHMgdG8gdHdvIG1pbnV0ZXMKICAgKiAgICAgICAoMTIwMDAwKQogICAqICAgICAqICoqeGhyQXN5bmMqKiBbQm9vbGVhbl0gJm1kYXNoOyBXaGV0aGVyIHRoZSBTREsgd2lsbCBzZW5kIGFzeW5jaHJvbm91cwogICAqICAgICAgIEhUVFAgcmVxdWVzdHMuIFVzZWQgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQgb25seS4gU2V0IHRvIGZhbHNlIHRvCiAgICogICAgICAgc2VuZCByZXF1ZXN0cyBzeW5jaHJvbm91c2x5LiBEZWZhdWx0cyB0byB0cnVlIChhc3luYyBvbikuCiAgICogICAgICogKip4aHJXaXRoQ3JlZGVudGlhbHMqKiBbQm9vbGVhbl0gJm1kYXNoOyBTZXRzIHRoZSAid2l0aENyZWRlbnRpYWxzIgogICAqICAgICAgIHByb3BlcnR5IG9mIGFuIFhNTEh0dHBSZXF1ZXN0IG9iamVjdC4gVXNlZCBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudAogICAqICAgICAgIG9ubHkuIERlZmF1bHRzIHRvIGZhbHNlLgogICAqIEAhYXR0cmlidXRlIGxvZ2dlcgogICAqICAgQHJldHVybiBbI3dyaXRlLCNsb2ddIGFuIG9iamVjdCB0aGF0IHJlc3BvbmRzIHRvIC53cml0ZSgpIChsaWtlIGEgc3RyZWFtKQogICAqICAgICBvciAubG9nKCkgKGxpa2UgdGhlIGNvbnNvbGUgb2JqZWN0KSBpbiBvcmRlciB0byBsb2cgaW5mb3JtYXRpb24gYWJvdXQKICAgKiAgICAgcmVxdWVzdHMKICAgKgogICAqIEAhYXR0cmlidXRlIHN5c3RlbUNsb2NrT2Zmc2V0CiAgICogICBAcmV0dXJuIFtOdW1iZXJdIGFuIG9mZnNldCB2YWx1ZSBpbiBtaWxsaXNlY29uZHMgdG8gYXBwbHkgdG8gYWxsIHNpZ25pbmcKICAgKiAgICAgdGltZXMuIFVzZSB0aGlzIHRvIGNvbXBlbnNhdGUgZm9yIGNsb2NrIHNrZXcgd2hlbiB5b3VyIHN5c3RlbSBtYXkgYmUKICAgKiAgICAgb3V0IG9mIHN5bmMgd2l0aCB0aGUgc2VydmljZSB0aW1lLiBOb3RlIHRoYXQgdGhpcyBjb25maWd1cmF0aW9uIG9wdGlvbgogICAqICAgICBjYW4gb25seSBiZSBhcHBsaWVkIHRvIHRoZSBnbG9iYWwgYEFXUy5jb25maWdgIG9iamVjdCBhbmQgY2Fubm90IGJlCiAgICogICAgIG92ZXJyaWRkZW4gaW4gc2VydmljZS1zcGVjaWZpYyBjb25maWd1cmF0aW9uLiBEZWZhdWx0cyB0byAwIG1pbGxpc2Vjb25kcy4KICAgKgogICAqIEAhYXR0cmlidXRlIHNpZ25hdHVyZVZlcnNpb24KICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIHNpZ25hdHVyZSB2ZXJzaW9uIHRvIHNpZ24gcmVxdWVzdHMgd2l0aCAob3ZlcnJpZGluZwogICAqICAgICB0aGUgQVBJIGNvbmZpZ3VyYXRpb24pLiBQb3NzaWJsZSB2YWx1ZXMgYXJlOiAndjInLCAndjMnLCAndjQnLgogICAqCiAgICogQCFhdHRyaWJ1dGUgc2lnbmF0dXJlQ2FjaGUKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIHNpZ25hdHVyZSB0byBzaWduIHJlcXVlc3RzIHdpdGggKG92ZXJyaWRpbmcKICAgKiAgICAgdGhlIEFQSSBjb25maWd1cmF0aW9uKSBpcyBjYWNoZWQuIE9ubHkgYXBwbGllcyB0byB0aGUgc2lnbmF0dXJlIHZlcnNpb24gJ3Y0Jy4KICAgKiAgICAgRGVmYXVsdHMgdG8gYHRydWVgLgogICAqCiAgICogQCFhdHRyaWJ1dGUgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIGVuYWJsZSBlbmRwb2ludCBkaXNjb3ZlcnkgZm9yIG9wZXJhdGlvbnMgdGhhdAogICAqICAgICBhbGxvdyBvcHRpb25hbGx5IHVzaW5nIGFuIGVuZHBvaW50IHJldHVybmVkIGJ5IHRoZSBzZXJ2aWNlLgogICAqICAgICBEZWZhdWx0cyB0byAnZmFsc2UnCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBlbmRwb2ludENhY2hlU2l6ZQogICAqICAgQHJldHVybiBbTnVtYmVyXSB0aGUgc2l6ZSBvZiB0aGUgZ2xvYmFsIGNhY2hlIHN0b3JpbmcgZW5kcG9pbnRzIGZyb20gZW5kcG9pbnQKICAgKiAgICAgZGlzY292ZXJ5IG9wZXJhdGlvbnMuIE9uY2UgZW5kcG9pbnQgY2FjaGUgaXMgY3JlYXRlZCwgdXBkYXRpbmcgdGhpcyBzZXR0aW5nCiAgICogICAgIGNhbm5vdCBjaGFuZ2UgZXhpc3RpbmcgY2FjaGUgc2l6ZS4KICAgKiAgICAgRGVmYXVsdHMgdG8gMTAwMAogICAqCiAgICogQCFhdHRyaWJ1dGUgaG9zdFByZWZpeEVuYWJsZWQKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gbWFyc2hhbCByZXF1ZXN0IHBhcmFtZXRlcnMgdG8gdGhlIHByZWZpeCBvZgogICAqICAgICBob3N0bmFtZS4gRGVmYXVsdHMgdG8gYHRydWVgLgogICAqCiAgICogQCFhdHRyaWJ1dGUgc3RzUmVnaW9uYWxFbmRwb2ludHMKICAgKiAgIEByZXR1cm4gWydsZWdhY3knfCdyZWdpb25hbCddIHdoZXRoZXIgdG8gc2VuZCBzdHMgcmVxdWVzdCB0byBnbG9iYWwgZW5kcG9pbnRzIG9yCiAgICogICAgIHJlZ2lvbmFsIGVuZHBvaW50cy4KICAgKiAgICAgRGVmYXVsdHMgdG8gJ2xlZ2FjeScKICAgKi8KICBBV1MuQ29uZmlnID0gQVdTLnV0aWwuaW5oZXJpdCh7CiAgICAvKioKICAgICAqIEAhZW5kZ3JvdXAKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IGNvbmZpZ3VyYXRpb24gb2JqZWN0LiBUaGlzIGlzIHRoZSBvYmplY3QgdGhhdCBwYXNzZXMKICAgICAqIG9wdGlvbiBkYXRhIGFsb25nIHRvIHNlcnZpY2UgcmVxdWVzdHMsIGluY2x1ZGluZyBjcmVkZW50aWFscywgc2VjdXJpdHksCiAgICAgKiByZWdpb24gaW5mb3JtYXRpb24sIGFuZCBzb21lIHNlcnZpY2Ugc3BlY2lmaWMgc2V0dGluZ3MuCiAgICAgKgogICAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY29uZmlndXJhdGlvbiBvYmplY3Qgd2l0aCBjcmVkZW50aWFscyBhbmQgcmVnaW9uCiAgICAgKiAgIHZhciBjb25maWcgPSBuZXcgQVdTLkNvbmZpZyh7CiAgICAgKiAgICAgYWNjZXNzS2V5SWQ6ICdBS0lEJywgc2VjcmV0QWNjZXNzS2V5OiAnU0VDUkVUJywgcmVnaW9uOiAndXMtd2VzdC0yJwogICAgICogICB9KTsKICAgICAqIEBvcHRpb24gb3B0aW9ucyBhY2Nlc3NLZXlJZCBbU3RyaW5nXSB5b3VyIEFXUyBhY2Nlc3Mga2V5IElELgogICAgICogQG9wdGlvbiBvcHRpb25zIHNlY3JldEFjY2Vzc0tleSBbU3RyaW5nXSB5b3VyIEFXUyBzZWNyZXQgYWNjZXNzIGtleS4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzZXNzaW9uVG9rZW4gW0FXUy5DcmVkZW50aWFsc10gdGhlIG9wdGlvbmFsIEFXUwogICAgICogICBzZXNzaW9uIHRva2VuIHRvIHNpZ24gcmVxdWVzdHMgd2l0aC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBjcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgQVdTIGNyZWRlbnRpYWxzCiAgICAgKiAgIHRvIHNpZ24gcmVxdWVzdHMgd2l0aC4gWW91IGNhbiBlaXRoZXIgc3BlY2lmeSB0aGlzIG9iamVjdCwgb3IKICAgICAqICAgc3BlY2lmeSB0aGUgYWNjZXNzS2V5SWQgYW5kIHNlY3JldEFjY2Vzc0tleSBvcHRpb25zIGRpcmVjdGx5LgogICAgICogQG9wdGlvbiBvcHRpb25zIGNyZWRlbnRpYWxQcm92aWRlciBbQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluXSB0aGUKICAgICAqICAgcHJvdmlkZXIgY2hhaW4gdXNlZCB0byByZXNvbHZlIGNyZWRlbnRpYWxzIGlmIG5vIHN0YXRpYyBgY3JlZGVudGlhbHNgCiAgICAgKiAgIHByb3BlcnR5IGlzIHNldC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyByZWdpb24gW1N0cmluZ10gdGhlIHJlZ2lvbiB0byBzZW5kIHNlcnZpY2UgcmVxdWVzdHMgdG8uCiAgICAgKiAgIFNlZSB7cmVnaW9ufSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBtYXhSZXRyaWVzIFtJbnRlZ2VyXSB0aGUgbWF4aW11bSBhbW91bnQgb2YgcmV0cmllcyB0bwogICAgICogICBhdHRlbXB0IHdpdGggYSByZXF1ZXN0LiBTZWUge21heFJldHJpZXN9IGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICogQG9wdGlvbiBvcHRpb25zIG1heFJlZGlyZWN0cyBbSW50ZWdlcl0gdGhlIG1heGltdW0gYW1vdW50IG9mIHJlZGlyZWN0cyB0bwogICAgICogICBmb2xsb3cgd2l0aCBhIHJlcXVlc3QuIFNlZSB7bWF4UmVkaXJlY3RzfSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzc2xFbmFibGVkIFtCb29sZWFuXSB3aGV0aGVyIHRvIGVuYWJsZSBTU0wgZm9yCiAgICAgKiAgIHJlcXVlc3RzLgogICAgICogQG9wdGlvbiBvcHRpb25zIHBhcmFtVmFsaWRhdGlvbiBbQm9vbGVhbnxtYXBdIHdoZXRoZXIgaW5wdXQgcGFyYW1ldGVycwogICAgICogICBzaG91bGQgYmUgdmFsaWRhdGVkIGFnYWluc3QgdGhlIG9wZXJhdGlvbiBkZXNjcmlwdGlvbiBiZWZvcmUgc2VuZGluZwogICAgICogICB0aGUgcmVxdWVzdC4gRGVmYXVsdHMgdG8gdHJ1ZS4gUGFzcyBhIG1hcCB0byBlbmFibGUgYW55IG9mIHRoZQogICAgICogICBmb2xsb3dpbmcgc3BlY2lmaWMgdmFsaWRhdGlvbiBmZWF0dXJlczoKICAgICAqCiAgICAgKiAgICogKiptaW4qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHZhbHVlIG1lZXRzIHRoZSBtaW4KICAgICAqICAgICBjb25zdHJhaW50LiBUaGlzIGlzIGVuYWJsZWQgYnkgZGVmYXVsdCB3aGVuIHBhcmFtVmFsaWRhdGlvbiBpcyBzZXQKICAgICAqICAgICB0byBgdHJ1ZWAuCiAgICAgKiAgICogKiptYXgqKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHZhbHVlIG1lZXRzIHRoZSBtYXgKICAgICAqICAgICBjb25zdHJhaW50LgogICAgICogICAqICoqcGF0dGVybioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgYQogICAgICogICAgIHJlZ3VsYXIgZXhwcmVzc2lvbi4KICAgICAqICAgKiAqKmVudW0qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIG9uZQogICAgICogICAgIG9mIHRoZSBhbGxvd2FibGUgZW51bSB2YWx1ZXMuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgY29tcHV0ZUNoZWNrc3VtcyBbQm9vbGVhbl0gd2hldGhlciB0byBjb21wdXRlIGNoZWNrc3VtcwogICAgICogICBmb3IgcGF5bG9hZCBib2RpZXMgd2hlbiB0aGUgc2VydmljZSBhY2NlcHRzIGl0IChjdXJyZW50bHkgc3VwcG9ydGVkCiAgICAgKiAgIGluIFMzIG9ubHkpCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgY29udmVydFJlc3BvbnNlVHlwZXMgW0Jvb2xlYW5dIHdoZXRoZXIgdHlwZXMgYXJlIGNvbnZlcnRlZAogICAgICogICAgIHdoZW4gcGFyc2luZyByZXNwb25zZSBkYXRhLiBDdXJyZW50bHkgb25seSBzdXBwb3J0ZWQgZm9yIEpTT04gYmFzZWQKICAgICAqICAgICBzZXJ2aWNlcy4gVHVybmluZyB0aGlzIG9mZiBtYXkgaW1wcm92ZSBwZXJmb3JtYW5jZSBvbiBsYXJnZSByZXNwb25zZQogICAgICogICAgIHBheWxvYWRzLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgY29ycmVjdENsb2NrU2tldyBbQm9vbGVhbl0gd2hldGhlciB0byBhcHBseSBhIGNsb2NrIHNrZXcKICAgICAqICAgICBjb3JyZWN0aW9uIGFuZCByZXRyeSByZXF1ZXN0cyB0aGF0IGZhaWwgYmVjYXVzZSBvZiBhbiBza2V3ZWQgY2xpZW50CiAgICAgKiAgICAgY2xvY2suIERlZmF1bHRzIHRvIGBmYWxzZWAuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgczNGb3JjZVBhdGhTdHlsZSBbQm9vbGVhbl0gd2hldGhlciB0byBmb3JjZSBwYXRoCiAgICAgKiAgIHN0eWxlIFVSTHMgZm9yIFMzIG9iamVjdHMuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgczNCdWNrZXRFbmRwb2ludCBbQm9vbGVhbl0gd2hldGhlciB0aGUgcHJvdmlkZWQgZW5kcG9pbnQKICAgICAqICAgYWRkcmVzc2VzIGFuIGluZGl2aWR1YWwgYnVja2V0IChmYWxzZSBpZiBpdCBhZGRyZXNzZXMgdGhlIHJvb3QgQVBJCiAgICAgKiAgIGVuZHBvaW50KS4gTm90ZSB0aGF0IHNldHRpbmcgdGhpcyBjb25maWd1cmF0aW9uIG9wdGlvbiByZXF1aXJlcyBhbgogICAgICogICBgZW5kcG9pbnRgIHRvIGJlIHByb3ZpZGVkIGV4cGxpY2l0bHkgdG8gdGhlIHNlcnZpY2UgY29uc3RydWN0b3IuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgczNEaXNhYmxlQm9keVNpZ25pbmcgW0Jvb2xlYW5dIHdoZXRoZXIgUzMgYm9keSBzaWduaW5nCiAgICAgKiAgIHNob3VsZCBiZSBkaXNhYmxlZCB3aGVuIHVzaW5nIHNpZ25hdHVyZSB2ZXJzaW9uIGB2NGAuIEJvZHkgc2lnbmluZwogICAgICogICBjYW4gb25seSBiZSBkaXNhYmxlZCB3aGVuIHVzaW5nIGh0dHBzLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICAgKgogICAgICogQG9wdGlvbiBvcHRpb25zIHJldHJ5RGVsYXlPcHRpb25zIFttYXBdIEEgc2V0IG9mIG9wdGlvbnMgdG8gY29uZmlndXJlCiAgICAgKiAgIHRoZSByZXRyeSBkZWxheSBvbiByZXRyeWFibGUgZXJyb3JzLiBDdXJyZW50bHkgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogICAgICoKICAgICAqICAgKiAqKmJhc2UqKiBbSW50ZWdlcl0gJm1kYXNoOyBUaGUgYmFzZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHVzZSBpbiB0aGUKICAgICAqICAgICBleHBvbmVudGlhbCBiYWNrb2ZmIGZvciBvcGVyYXRpb24gcmV0cmllcy4gRGVmYXVsdHMgdG8gMTAwIG1zIGZvciBhbGwKICAgICAqICAgICBzZXJ2aWNlcyBleGNlcHQgRHluYW1vREIsIHdoZXJlIGl0IGRlZmF1bHRzIHRvIDUwbXMuCiAgICAgKiAgICogKipjdXN0b21CYWNrb2ZmICoqIFtmdW5jdGlvbl0gJm1kYXNoOyBBIGN1c3RvbSBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgYSByZXRyeSBjb3VudAogICAgICogICAgIGFuZCByZXR1cm5zIHRoZSBhbW91bnQgb2YgdGltZSB0byBkZWxheSBpbiBtaWxsaXNlY29uZHMuIFRoZSBgYmFzZWAgb3B0aW9uIHdpbGwgYmUKICAgICAqICAgICBpZ25vcmVkIGlmIHRoaXMgb3B0aW9uIGlzIHN1cHBsaWVkLgogICAgICogQG9wdGlvbiBvcHRpb25zIGh0dHBPcHRpb25zIFttYXBdIEEgc2V0IG9mIG9wdGlvbnMgdG8gcGFzcyB0byB0aGUgbG93LWxldmVsCiAgICAgKiAgIEhUVFAgcmVxdWVzdC4gQ3VycmVudGx5IHN1cHBvcnRlZCBvcHRpb25zIGFyZToKICAgICAqCiAgICAgKiAgICogKipwcm94eSoqIFtTdHJpbmddICZtZGFzaDsgdGhlIFVSTCB0byBwcm94eSByZXF1ZXN0cyB0aHJvdWdoCiAgICAgKiAgICogKiphZ2VudCoqIFtodHRwLkFnZW50LCBodHRwcy5BZ2VudF0gJm1kYXNoOyB0aGUgQWdlbnQgb2JqZWN0IHRvIHBlcmZvcm0KICAgICAqICAgICBIVFRQIHJlcXVlc3RzIHdpdGguIFVzZWQgZm9yIGNvbm5lY3Rpb24gcG9vbGluZy4gRGVmYXVsdHMgdG8gdGhlIGdsb2JhbAogICAgICogICAgIGFnZW50IChgaHR0cC5nbG9iYWxBZ2VudGApIGZvciBub24tU1NMIGNvbm5lY3Rpb25zLiBOb3RlIHRoYXQgZm9yCiAgICAgKiAgICAgU1NMIGNvbm5lY3Rpb25zLCBhIHNwZWNpYWwgQWdlbnQgb2JqZWN0IGlzIHVzZWQgaW4gb3JkZXIgdG8gZW5hYmxlCiAgICAgKiAgICAgcGVlciBjZXJ0aWZpY2F0ZSB2ZXJpZmljYXRpb24uIFRoaXMgZmVhdHVyZSBpcyBvbmx5IGF2YWlsYWJsZSBpbiB0aGUKICAgICAqICAgICBOb2RlLmpzIGVudmlyb25tZW50LgogICAgICogICAqICoqY29ubmVjdFRpbWVvdXQqKiBbSW50ZWdlcl0gJm1kYXNoOyBTZXRzIHRoZSBzb2NrZXQgdG8gdGltZW91dCBhZnRlcgogICAgICogICAgIGZhaWxpbmcgdG8gZXN0YWJsaXNoIGEgY29ubmVjdGlvbiB3aXRoIHRoZSBzZXJ2ZXIgYWZ0ZXIKICAgICAqICAgICBgY29ubmVjdFRpbWVvdXRgIG1pbGxpc2Vjb25kcy4gVGhpcyB0aW1lb3V0IGhhcyBubyBlZmZlY3Qgb25jZSBhIHNvY2tldAogICAgICogICAgIGNvbm5lY3Rpb24gaGFzIGJlZW4gZXN0YWJsaXNoZWQuCiAgICAgKiAgICogKip0aW1lb3V0KiogW0ludGVnZXJdICZtZGFzaDsgU2V0cyB0aGUgc29ja2V0IHRvIHRpbWVvdXQgYWZ0ZXIgdGltZW91dAogICAgICogICAgIG1pbGxpc2Vjb25kcyBvZiBpbmFjdGl2aXR5IG9uIHRoZSBzb2NrZXQuIERlZmF1bHRzIHRvIHR3byBtaW51dGVzCiAgICAgKiAgICAgKDEyMDAwMCkuCiAgICAgKiAgICogKip4aHJBc3luYyoqIFtCb29sZWFuXSAmbWRhc2g7IFdoZXRoZXIgdGhlIFNESyB3aWxsIHNlbmQgYXN5bmNocm9ub3VzCiAgICAgKiAgICAgSFRUUCByZXF1ZXN0cy4gVXNlZCBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudCBvbmx5LiBTZXQgdG8gZmFsc2UgdG8KICAgICAqICAgICBzZW5kIHJlcXVlc3RzIHN5bmNocm9ub3VzbHkuIERlZmF1bHRzIHRvIHRydWUgKGFzeW5jIG9uKS4KICAgICAqICAgKiAqKnhocldpdGhDcmVkZW50aWFscyoqIFtCb29sZWFuXSAmbWRhc2g7IFNldHMgdGhlICJ3aXRoQ3JlZGVudGlhbHMiCiAgICAgKiAgICAgcHJvcGVydHkgb2YgYW4gWE1MSHR0cFJlcXVlc3Qgb2JqZWN0LiBVc2VkIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50CiAgICAgKiAgICAgb25seS4gRGVmYXVsdHMgdG8gZmFsc2UuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgYXBpVmVyc2lvbiBbU3RyaW5nLCBEYXRlXSBhIFN0cmluZyBpbiBZWVlZLU1NLUREIGZvcm1hdAogICAgICogICAob3IgYSBkYXRlKSB0aGF0IHJlcHJlc2VudHMgdGhlIGxhdGVzdCBwb3NzaWJsZSBBUEkgdmVyc2lvbiB0aGF0IGNhbiBiZQogICAgICogICB1c2VkIGluIGFsbCBzZXJ2aWNlcyAodW5sZXNzIG92ZXJyaWRkZW4gYnkgYGFwaVZlcnNpb25zYCkuIFNwZWNpZnkKICAgICAqICAgJ2xhdGVzdCcgdG8gdXNlIHRoZSBsYXRlc3QgcG9zc2libGUgdmVyc2lvbi4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBhcGlWZXJzaW9ucyBbbWFwPFN0cmluZywgU3RyaW5nfERhdGU+XSBhIG1hcCBvZiBzZXJ2aWNlCiAgICAgKiAgIGlkZW50aWZpZXJzICh0aGUgbG93ZXJjYXNlIHNlcnZpY2UgY2xhc3MgbmFtZSkgd2l0aCB0aGUgQVBJIHZlcnNpb24gdG8KICAgICAqICAgdXNlIHdoZW4gaW5zdGFudGlhdGluZyBhIHNlcnZpY2UuIFNwZWNpZnkgJ2xhdGVzdCcgZm9yIGVhY2ggaW5kaXZpZHVhbAogICAgICogICB0aGF0IGNhbiB1c2UgdGhlIGxhdGVzdCBhdmFpbGFibGUgdmVyc2lvbi4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBsb2dnZXIgWyN3cml0ZSwjbG9nXSBhbiBvYmplY3QgdGhhdCByZXNwb25kcyB0byAud3JpdGUoKQogICAgICogICAobGlrZSBhIHN0cmVhbSkgb3IgLmxvZygpIChsaWtlIHRoZSBjb25zb2xlIG9iamVjdCkgaW4gb3JkZXIgdG8gbG9nCiAgICAgKiAgIGluZm9ybWF0aW9uIGFib3V0IHJlcXVlc3RzCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgc3lzdGVtQ2xvY2tPZmZzZXQgW051bWJlcl0gYW4gb2Zmc2V0IHZhbHVlIGluIG1pbGxpc2Vjb25kcwogICAgICogICB0byBhcHBseSB0byBhbGwgc2lnbmluZyB0aW1lcy4gVXNlIHRoaXMgdG8gY29tcGVuc2F0ZSBmb3IgY2xvY2sgc2tldwogICAgICogICB3aGVuIHlvdXIgc3lzdGVtIG1heSBiZSBvdXQgb2Ygc3luYyB3aXRoIHRoZSBzZXJ2aWNlIHRpbWUuIE5vdGUgdGhhdAogICAgICogICB0aGlzIGNvbmZpZ3VyYXRpb24gb3B0aW9uIGNhbiBvbmx5IGJlIGFwcGxpZWQgdG8gdGhlIGdsb2JhbCBgQVdTLmNvbmZpZ2AKICAgICAqICAgb2JqZWN0IGFuZCBjYW5ub3QgYmUgb3ZlcnJpZGRlbiBpbiBzZXJ2aWNlLXNwZWNpZmljIGNvbmZpZ3VyYXRpb24uCiAgICAgKiAgIERlZmF1bHRzIHRvIDAgbWlsbGlzZWNvbmRzLgogICAgICogQG9wdGlvbiBvcHRpb25zIHNpZ25hdHVyZVZlcnNpb24gW1N0cmluZ10gdGhlIHNpZ25hdHVyZSB2ZXJzaW9uIHRvIHNpZ24KICAgICAqICAgcmVxdWVzdHMgd2l0aCAob3ZlcnJpZGluZyB0aGUgQVBJIGNvbmZpZ3VyYXRpb24pLiBQb3NzaWJsZSB2YWx1ZXMgYXJlOgogICAgICogICAndjInLCAndjMnLCAndjQnLgogICAgICogQG9wdGlvbiBvcHRpb25zIHNpZ25hdHVyZUNhY2hlIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBzaWduYXR1cmUgdG8gc2lnbgogICAgICogICByZXF1ZXN0cyB3aXRoIChvdmVycmlkaW5nIHRoZSBBUEkgY29uZmlndXJhdGlvbikgaXMgY2FjaGVkLiBPbmx5IGFwcGxpZXMKICAgICAqICAgdG8gdGhlIHNpZ25hdHVyZSB2ZXJzaW9uICd2NCcuIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBkeW5hbW9EYkNyYzMyIFtCb29sZWFuXSB3aGV0aGVyIHRvIHZhbGlkYXRlIHRoZSBDUkMzMgogICAgICogICBjaGVja3N1bSBvZiBIVFRQIHJlc3BvbnNlIGJvZGllcyByZXR1cm5lZCBieSBEeW5hbW9EQi4gRGVmYXVsdDogYHRydWVgLgogICAgICogQG9wdGlvbiBvcHRpb25zIHVzZUFjY2VsZXJhdGVFbmRwb2ludCBbQm9vbGVhbl0gV2hldGhlciB0byB1c2UgdGhlCiAgICAgKiAgIFMzIFRyYW5zZmVyIEFjY2VsZXJhdGlvbiBlbmRwb2ludCB3aXRoIHRoZSBTMyBzZXJ2aWNlLiBEZWZhdWx0OiBgZmFsc2VgLgogICAgICogQG9wdGlvbiBvcHRpb25zIGNsaWVudFNpZGVNb25pdG9yaW5nIFtCb29sZWFuXSB3aGV0aGVyIHRvIGNvbGxlY3QgYW5kCiAgICAgKiAgIHB1Ymxpc2ggdGhpcyBjbGllbnQncyBwZXJmb3JtYW5jZSBtZXRyaWNzIG9mIGFsbCBpdHMgQVBJIHJlcXVlc3RzLgogICAgICogQG9wdGlvbiBvcHRpb25zIGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZCBbQm9vbGVhbl0gd2hldGhlciB0byBlbmFibGUgZW5kcG9pbnQKICAgICAqICAgZGlzY292ZXJ5IGZvciBvcGVyYXRpb25zIHRoYXQgYWxsb3cgb3B0aW9uYWxseSB1c2luZyBhbiBlbmRwb2ludCByZXR1cm5lZCBieQogICAgICogICB0aGUgc2VydmljZS4KICAgICAqICAgRGVmYXVsdHMgdG8gJ2ZhbHNlJwogICAgICogQG9wdGlvbiBvcHRpb25zIGVuZHBvaW50Q2FjaGVTaXplIFtOdW1iZXJdIHRoZSBzaXplIG9mIHRoZSBnbG9iYWwgY2FjaGUgc3RvcmluZwogICAgICogICBlbmRwb2ludHMgZnJvbSBlbmRwb2ludCBkaXNjb3Zlcnkgb3BlcmF0aW9ucy4gT25jZSBlbmRwb2ludCBjYWNoZSBpcyBjcmVhdGVkLAogICAgICogICB1cGRhdGluZyB0aGlzIHNldHRpbmcgY2Fubm90IGNoYW5nZSBleGlzdGluZyBjYWNoZSBzaXplLgogICAgICogICBEZWZhdWx0cyB0byAxMDAwCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgaG9zdFByZWZpeEVuYWJsZWQgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gbWFyc2hhbCByZXF1ZXN0CiAgICAgKiAgIHBhcmFtZXRlcnMgdG8gdGhlIHByZWZpeCBvZiBob3N0bmFtZS4KICAgICAqICAgRGVmYXVsdHMgdG8gYHRydWVgLgogICAgICogQG9wdGlvbiBvcHRpb25zIHN0c1JlZ2lvbmFsRW5kcG9pbnRzIFsnbGVnYWN5J3wncmVnaW9uYWwnXSB3aGV0aGVyIHRvIHNlbmQgc3RzIHJlcXVlc3QKICAgICAqICAgdG8gZ2xvYmFsIGVuZHBvaW50cyBvciByZWdpb25hbCBlbmRwb2ludHMuCiAgICAgKiAgIERlZmF1bHRzIHRvICdsZWdhY3knLgogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gQ29uZmlnKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHVuZGVmaW5lZCkgb3B0aW9ucyA9IHt9OwogICAgICBvcHRpb25zID0gdGhpcy5leHRyYWN0Q3JlZGVudGlhbHMob3B0aW9ucyk7CiAgCiAgICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLmtleXMsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgdGhpcy5zZXQoa2V5LCBvcHRpb25zW2tleV0sIHZhbHVlKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAIWdyb3VwIE1hbmFnaW5nIENyZWRlbnRpYWxzCiAgICAgKi8KICAKICAgIC8qKgogICAgICogTG9hZHMgY3JlZGVudGlhbHMgZnJvbSB0aGUgY29uZmlndXJhdGlvbiBvYmplY3QuIFRoaXMgaXMgdXNlZCBpbnRlcm5hbGx5CiAgICAgKiBieSB0aGUgU0RLIHRvIGVuc3VyZSB0aGF0IHJlZnJlc2hhYmxlIHtDcmVkZW50aWFsc30gb2JqZWN0cyBhcmUgcHJvcGVybHkKICAgICAqIHJlZnJlc2hlZCBhbmQgbG9hZGVkIHdoZW4gc2VuZGluZyBhIHJlcXVlc3QuIElmIHlvdSB3YW50IHRvIGVuc3VyZSB0aGF0CiAgICAgKiB5b3VyIGNyZWRlbnRpYWxzIGFyZSBsb2FkZWQgcHJpb3IgdG8gYSByZXF1ZXN0LCB5b3UgY2FuIHVzZSB0aGlzIG1ldGhvZAogICAgICogZGlyZWN0bHkgdG8gcHJvdmlkZSBhY2N1cmF0ZSBjcmVkZW50aWFsIGRhdGEgc3RvcmVkIGluIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogQG5vdGUgSWYgeW91IGNvbmZpZ3VyZSB0aGUgU0RLIHdpdGggc3RhdGljIG9yIGVudmlyb25tZW50IGNyZWRlbnRpYWxzLAogICAgICogICB0aGUgY3JlZGVudGlhbCBkYXRhIHNob3VsZCBhbHJlYWR5IGJlIHByZXNlbnQgaW4ge2NyZWRlbnRpYWxzfSBhdHRyaWJ1dGUuCiAgICAgKiAgIFRoaXMgbWV0aG9kIGlzIHByaW1hcmlseSBuZWNlc3NhcnkgdG8gbG9hZCBjcmVkZW50aWFscyBmcm9tIGFzeW5jaHJvbm91cwogICAgICogICBzb3VyY2VzLCBvciBzb3VyY2VzIHRoYXQgY2FuIHJlZnJlc2ggY3JlZGVudGlhbHMgcGVyaW9kaWNhbGx5LgogICAgICogQGV4YW1wbGUgR2V0dGluZyB5b3VyIGFjY2VzcyBrZXkKICAgICAqICAgQVdTLmNvbmZpZy5nZXRDcmVkZW50aWFscyhmdW5jdGlvbihlcnIpIHsKICAgICAqICAgICBpZiAoZXJyKSBjb25zb2xlLmxvZyhlcnIuc3RhY2spOyAvLyBjcmVkZW50aWFscyBub3QgbG9hZGVkCiAgICAgKiAgICAgZWxzZSBjb25zb2xlLmxvZygiQWNjZXNzIEtleToiLCBBV1MuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkKTsKICAgICAqICAgfSkKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIENhbGxlZCB3aGVuIHRoZSB7Y3JlZGVudGlhbHN9IGhhdmUgYmVlbiBwcm9wZXJseSBzZXQgb24gdGhlIGNvbmZpZ3VyYXRpb24KICAgICAqICAgb2JqZWN0LgogICAgICoKICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIHRoaXMgaXMgc2V0LCBjcmVkZW50aWFscyB3ZXJlIG5vdCBzdWNjZXNzZnVsbHkKICAgICAqICAgICBsb2FkZWQgYW5kIHRoaXMgZXJyb3IgcHJvdmlkZXMgaW5mb3JtYXRpb24gd2h5LgogICAgICogQHNlZSBjcmVkZW50aWFscwogICAgICogQHNlZSBDcmVkZW50aWFscwogICAgICovCiAgICBnZXRDcmVkZW50aWFsczogZnVuY3Rpb24gZ2V0Q3JlZGVudGlhbHMoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogIAogICAgICBmdW5jdGlvbiBmaW5pc2goZXJyKSB7CiAgICAgICAgY2FsbGJhY2soZXJyLCBlcnIgPyBudWxsIDogc2VsZi5jcmVkZW50aWFscyk7CiAgICAgIH0KICAKICAgICAgZnVuY3Rpb24gY3JlZEVycm9yKG1zZywgZXJyKSB7CiAgICAgICAgcmV0dXJuIG5ldyBBV1MudXRpbC5lcnJvcihlcnIgfHwgbmV3IEVycm9yKCksIHsKICAgICAgICAgIGNvZGU6ICdDcmVkZW50aWFsc0Vycm9yJywKICAgICAgICAgIG1lc3NhZ2U6IG1zZywKICAgICAgICAgIG5hbWU6ICdDcmVkZW50aWFsc0Vycm9yJwogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIGZ1bmN0aW9uIGdldEFzeW5jQ3JlZGVudGlhbHMoKSB7CiAgICAgICAgc2VsZi5jcmVkZW50aWFscy5nZXQoZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIHZhciBtc2cgPSAnQ291bGQgbm90IGxvYWQgY3JlZGVudGlhbHMgZnJvbSAnICsKICAgICAgICAgICAgICBzZWxmLmNyZWRlbnRpYWxzLmNvbnN0cnVjdG9yLm5hbWU7CiAgICAgICAgICAgIGVyciA9IGNyZWRFcnJvcihtc2csIGVycik7CiAgICAgICAgICB9CiAgICAgICAgICBmaW5pc2goZXJyKTsKICAgICAgICB9KTsKICAgICAgfQogIAogICAgICBmdW5jdGlvbiBnZXRTdGF0aWNDcmVkZW50aWFscygpIHsKICAgICAgICB2YXIgZXJyID0gbnVsbDsKICAgICAgICBpZiAoIXNlbGYuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgfHwgIXNlbGYuY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5KSB7CiAgICAgICAgICBlcnIgPSBjcmVkRXJyb3IoJ01pc3NpbmcgY3JlZGVudGlhbHMnKTsKICAgICAgICB9CiAgICAgICAgZmluaXNoKGVycik7CiAgICAgIH0KICAKICAgICAgaWYgKHNlbGYuY3JlZGVudGlhbHMpIHsKICAgICAgICBpZiAodHlwZW9mIHNlbGYuY3JlZGVudGlhbHMuZ2V0ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBnZXRBc3luY0NyZWRlbnRpYWxzKCk7CiAgICAgICAgfSBlbHNlIHsgLy8gc3RhdGljIGNyZWRlbnRpYWxzCiAgICAgICAgICBnZXRTdGF0aWNDcmVkZW50aWFscygpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChzZWxmLmNyZWRlbnRpYWxQcm92aWRlcikgewogICAgICAgIHNlbGYuY3JlZGVudGlhbFByb3ZpZGVyLnJlc29sdmUoZnVuY3Rpb24oZXJyLCBjcmVkcykgewogICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICBlcnIgPSBjcmVkRXJyb3IoJ0NvdWxkIG5vdCBsb2FkIGNyZWRlbnRpYWxzIGZyb20gYW55IHByb3ZpZGVycycsIGVycik7CiAgICAgICAgICB9CiAgICAgICAgICBzZWxmLmNyZWRlbnRpYWxzID0gY3JlZHM7CiAgICAgICAgICBmaW5pc2goZXJyKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmaW5pc2goY3JlZEVycm9yKCdObyBjcmVkZW50aWFscyB0byBsb2FkJykpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAIWdyb3VwIExvYWRpbmcgYW5kIFNldHRpbmcgQ29uZmlndXJhdGlvbiBPcHRpb25zCiAgICAgKi8KICAKICAgIC8qKgogICAgICogQG92ZXJsb2FkIHVwZGF0ZShvcHRpb25zLCBhbGxvd1Vua25vd25LZXlzID0gZmFsc2UpCiAgICAgKiAgIFVwZGF0ZXMgdGhlIGN1cnJlbnQgY29uZmlndXJhdGlvbiBvYmplY3Qgd2l0aCBuZXcgb3B0aW9ucy4KICAgICAqCiAgICAgKiAgIEBleGFtcGxlIFVwZGF0ZSBtYXhSZXRyaWVzIHByb3BlcnR5IG9mIGEgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAqICAgICBjb25maWcudXBkYXRlKHttYXhSZXRyaWVzOiAxMH0pOwogICAgICogICBAcGFyYW0gW09iamVjdF0gb3B0aW9ucyBhIG1hcCBvZiBvcHRpb24ga2V5cyBhbmQgdmFsdWVzLgogICAgICogICBAcGFyYW0gW0Jvb2xlYW5dIGFsbG93VW5rbm93bktleXMgd2hldGhlciB1bmtub3duIGtleXMgY2FuIGJlIHNldCBvbgogICAgICogICAgIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdC4gRGVmYXVsdHMgdG8gYGZhbHNlYC4KICAgICAqICAgQHNlZSBjb25zdHJ1Y3RvcgogICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShvcHRpb25zLCBhbGxvd1Vua25vd25LZXlzKSB7CiAgICAgIGFsbG93VW5rbm93bktleXMgPSBhbGxvd1Vua25vd25LZXlzIHx8IGZhbHNlOwogICAgICBvcHRpb25zID0gdGhpcy5leHRyYWN0Q3JlZGVudGlhbHMob3B0aW9ucyk7CiAgICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCBvcHRpb25zLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgIGlmIChhbGxvd1Vua25vd25LZXlzIHx8IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLmtleXMsIGtleSkgfHwKICAgICAgICAgICAgQVdTLlNlcnZpY2UuaGFzU2VydmljZShrZXkpKSB7CiAgICAgICAgICB0aGlzLnNldChrZXksIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogTG9hZHMgY29uZmlndXJhdGlvbiBkYXRhIGZyb20gYSBKU09OIGZpbGUgaW50byB0aGlzIGNvbmZpZyBvYmplY3QuCiAgICAgKiBAbm90ZSBMb2FkaW5nIGNvbmZpZ3VyYXRpb24gd2lsbCByZXNldCBhbGwgZXhpc3RpbmcgY29uZmlndXJhdGlvbgogICAgICogICBvbiB0aGUgb2JqZWN0LgogICAgICogQCFtYWNybyBub2Jyb3dzZXIKICAgICAqIEBwYXJhbSBwYXRoIFtTdHJpbmddIHRoZSBwYXRoIHJlbGF0aXZlIHRvIHlvdXIgcHJvY2VzcydzIGN1cnJlbnQKICAgICAqICAgIHdvcmtpbmcgZGlyZWN0b3J5IHRvIGxvYWQgY29uZmlndXJhdGlvbiBmcm9tLgogICAgICogQHJldHVybiBbQVdTLkNvbmZpZ10gdGhlIHNhbWUgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAqLwogICAgbG9hZEZyb21QYXRoOiBmdW5jdGlvbiBsb2FkRnJvbVBhdGgocGF0aCkgewogICAgICB0aGlzLmNsZWFyKCk7CiAgCiAgICAgIHZhciBvcHRpb25zID0gSlNPTi5wYXJzZShBV1MudXRpbC5yZWFkRmlsZVN5bmMocGF0aCkpOwogICAgICB2YXIgZmlsZVN5c3RlbUNyZWRzID0gbmV3IEFXUy5GaWxlU3lzdGVtQ3JlZGVudGlhbHMocGF0aCk7CiAgICAgIHZhciBjaGFpbiA9IG5ldyBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4oKTsKICAgICAgY2hhaW4ucHJvdmlkZXJzLnVuc2hpZnQoZmlsZVN5c3RlbUNyZWRzKTsKICAgICAgY2hhaW4ucmVzb2x2ZShmdW5jdGlvbiAoZXJyLCBjcmVkcykgewogICAgICAgIGlmIChlcnIpIHRocm93IGVycjsKICAgICAgICBlbHNlIG9wdGlvbnMuY3JlZGVudGlhbHMgPSBjcmVkczsKICAgICAgfSk7CiAgCiAgICAgIHRoaXMuY29uc3RydWN0b3Iob3B0aW9ucyk7CiAgCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8qKgogICAgICogQ2xlYXJzIGNvbmZpZ3VyYXRpb24gZGF0YSBvbiB0aGlzIG9iamVjdAogICAgICoKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjbGVhcjogZnVuY3Rpb24gY2xlYXIoKSB7CiAgICAgIC8qanNoaW50IGZvcmluOmZhbHNlICovCiAgICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLmtleXMsIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBkZWxldGUgdGhpc1trZXldOwogICAgICB9KTsKICAKICAgICAgLy8gcmVzZXQgY3JlZGVudGlhbCBwcm92aWRlcgogICAgICB0aGlzLnNldCgnY3JlZGVudGlhbHMnLCB1bmRlZmluZWQpOwogICAgICB0aGlzLnNldCgnY3JlZGVudGlhbFByb3ZpZGVyJywgdW5kZWZpbmVkKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFNldHMgYSBwcm9wZXJ0eSBvbiB0aGUgY29uZmlndXJhdGlvbiBvYmplY3QsIGFsbG93aW5nIGZvciBhCiAgICAgKiBkZWZhdWx0IHZhbHVlCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc2V0OiBmdW5jdGlvbiBzZXQocHJvcGVydHksIHZhbHVlLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAoZGVmYXVsdFZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGRlZmF1bHRWYWx1ZSA9IHRoaXMua2V5c1twcm9wZXJ0eV07CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgZGVmYXVsdFZhbHVlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICB0aGlzW3Byb3BlcnR5XSA9IGRlZmF1bHRWYWx1ZS5jYWxsKHRoaXMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzW3Byb3BlcnR5XSA9IGRlZmF1bHRWYWx1ZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAocHJvcGVydHkgPT09ICdodHRwT3B0aW9ucycgJiYgdGhpc1twcm9wZXJ0eV0pIHsKICAgICAgICAvLyBkZWVwIG1lcmdlIGh0dHBPcHRpb25zCiAgICAgICAgdGhpc1twcm9wZXJ0eV0gPSBBV1MudXRpbC5tZXJnZSh0aGlzW3Byb3BlcnR5XSwgdmFsdWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXNbcHJvcGVydHldID0gdmFsdWU7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEFsbCBvZiB0aGUga2V5cyB3aXRoIHRoZWlyIGRlZmF1bHQgdmFsdWVzLgogICAgICoKICAgICAqIEBjb25zdGFudAogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGtleXM6IHsKICAgICAgY3JlZGVudGlhbHM6IG51bGwsCiAgICAgIGNyZWRlbnRpYWxQcm92aWRlcjogbnVsbCwKICAgICAgcmVnaW9uOiBudWxsLAogICAgICBsb2dnZXI6IG51bGwsCiAgICAgIGFwaVZlcnNpb25zOiB7fSwKICAgICAgYXBpVmVyc2lvbjogbnVsbCwKICAgICAgZW5kcG9pbnQ6IHVuZGVmaW5lZCwKICAgICAgaHR0cE9wdGlvbnM6IHsKICAgICAgICB0aW1lb3V0OiAxMjAwMDAKICAgICAgfSwKICAgICAgbWF4UmV0cmllczogdW5kZWZpbmVkLAogICAgICBtYXhSZWRpcmVjdHM6IDEwLAogICAgICBwYXJhbVZhbGlkYXRpb246IHRydWUsCiAgICAgIHNzbEVuYWJsZWQ6IHRydWUsCiAgICAgIHMzRm9yY2VQYXRoU3R5bGU6IGZhbHNlLAogICAgICBzM0J1Y2tldEVuZHBvaW50OiBmYWxzZSwKICAgICAgczNEaXNhYmxlQm9keVNpZ25pbmc6IHRydWUsCiAgICAgIGNvbXB1dGVDaGVja3N1bXM6IHRydWUsCiAgICAgIGNvbnZlcnRSZXNwb25zZVR5cGVzOiB0cnVlLAogICAgICBjb3JyZWN0Q2xvY2tTa2V3OiBmYWxzZSwKICAgICAgY3VzdG9tVXNlckFnZW50OiBudWxsLAogICAgICBkeW5hbW9EYkNyYzMyOiB0cnVlLAogICAgICBzeXN0ZW1DbG9ja09mZnNldDogMCwKICAgICAgc2lnbmF0dXJlVmVyc2lvbjogbnVsbCwKICAgICAgc2lnbmF0dXJlQ2FjaGU6IHRydWUsCiAgICAgIHJldHJ5RGVsYXlPcHRpb25zOiB7fSwKICAgICAgdXNlQWNjZWxlcmF0ZUVuZHBvaW50OiBmYWxzZSwKICAgICAgY2xpZW50U2lkZU1vbml0b3Jpbmc6IGZhbHNlLAogICAgICBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWQ6IGZhbHNlLAogICAgICBlbmRwb2ludENhY2hlU2l6ZTogMTAwMCwKICAgICAgaG9zdFByZWZpeEVuYWJsZWQ6IHRydWUsCiAgICAgIHN0c1JlZ2lvbmFsRW5kcG9pbnRzOiBudWxsCiAgICB9LAogIAogICAgLyoqCiAgICAgKiBFeHRyYWN0cyBhY2Nlc3NLZXlJZCwgc2VjcmV0QWNjZXNzS2V5IGFuZCBzZXNzaW9uVG9rZW4KICAgICAqIGZyb20gYSBjb25maWd1cmF0aW9uIGhhc2guCiAgICAgKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGV4dHJhY3RDcmVkZW50aWFsczogZnVuY3Rpb24gZXh0cmFjdENyZWRlbnRpYWxzKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMuYWNjZXNzS2V5SWQgJiYgb3B0aW9ucy5zZWNyZXRBY2Nlc3NLZXkpIHsKICAgICAgICBvcHRpb25zID0gQVdTLnV0aWwuY29weShvcHRpb25zKTsKICAgICAgICBvcHRpb25zLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5DcmVkZW50aWFscyhvcHRpb25zKTsKICAgICAgfQogICAgICByZXR1cm4gb3B0aW9uczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFNldHMgdGhlIHByb21pc2UgZGVwZW5kZW5jeSB0aGUgU0RLIHdpbGwgdXNlIHdoZXJldmVyIFByb21pc2VzIGFyZSByZXR1cm5lZC4KICAgICAqIFBhc3NpbmcgYG51bGxgIHdpbGwgZm9yY2UgdGhlIFNESyB0byB1c2UgbmF0aXZlIFByb21pc2VzIGlmIHRoZXkgYXJlIGF2YWlsYWJsZS4KICAgICAqIElmIG5hdGl2ZSBQcm9taXNlcyBhcmUgbm90IGF2YWlsYWJsZSwgcGFzc2luZyBgbnVsbGAgd2lsbCBoYXZlIG5vIGVmZmVjdC4KICAgICAqIEBwYXJhbSBbQ29uc3RydWN0b3JdIGRlcCBBIHJlZmVyZW5jZSB0byBhIFByb21pc2UgY29uc3RydWN0b3IKICAgICAqLwogICAgc2V0UHJvbWlzZXNEZXBlbmRlbmN5OiBmdW5jdGlvbiBzZXRQcm9taXNlc0RlcGVuZGVuY3koZGVwKSB7CiAgICAgIFByb21pc2VzRGVwZW5kZW5jeSA9IGRlcDsKICAgICAgLy8gaWYgbnVsbCB3YXMgcGFzc2VkIGluLCB3ZSBzaG91bGQgdHJ5IHRvIHVzZSBuYXRpdmUgcHJvbWlzZXMKICAgICAgaWYgKGRlcCA9PT0gbnVsbCAmJiB0eXBlb2YgUHJvbWlzZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIFByb21pc2VzRGVwZW5kZW5jeSA9IFByb21pc2U7CiAgICAgIH0KICAgICAgdmFyIGNvbnN0cnVjdG9ycyA9IFtBV1MuUmVxdWVzdCwgQVdTLkNyZWRlbnRpYWxzLCBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW5dOwogICAgICBpZiAoQVdTLlMzKSB7CiAgICAgICAgY29uc3RydWN0b3JzLnB1c2goQVdTLlMzKTsKICAgICAgICBpZiAoQVdTLlMzLk1hbmFnZWRVcGxvYWQpIHsKICAgICAgICAgIGNvbnN0cnVjdG9ycy5wdXNoKEFXUy5TMy5NYW5hZ2VkVXBsb2FkKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgQVdTLnV0aWwuYWRkUHJvbWlzZXMoY29uc3RydWN0b3JzLCBQcm9taXNlc0RlcGVuZGVuY3kpOwogICAgfSwKICAKICAgIC8qKgogICAgICogR2V0cyB0aGUgcHJvbWlzZSBkZXBlbmRlbmN5IHNldCBieSBgQVdTLmNvbmZpZy5zZXRQcm9taXNlc0RlcGVuZGVuY3lgLgogICAgICovCiAgICBnZXRQcm9taXNlc0RlcGVuZGVuY3k6IGZ1bmN0aW9uIGdldFByb21pc2VzRGVwZW5kZW5jeSgpIHsKICAgICAgcmV0dXJuIFByb21pc2VzRGVwZW5kZW5jeTsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAcmV0dXJuIFtBV1MuQ29uZmlnXSBUaGUgZ2xvYmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0IHNpbmdsZXRvbiBpbnN0YW5jZQogICAqIEByZWFkb25seQogICAqIEBzZWUgQVdTLkNvbmZpZwogICAqLwogIEFXUy5jb25maWcgPSBuZXcgQVdTLkNvbmZpZygpOwogIAogIH0seyIuL2NvcmUiOjE4LCIuL2NyZWRlbnRpYWxzIjoxOSwiLi9jcmVkZW50aWFscy9jcmVkZW50aWFsX3Byb3ZpZGVyX2NoYWluIjoyMn1dLDE4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvKioKICAgKiBUaGUgbWFpbiBBV1MgbmFtZXNwYWNlCiAgICovCiAgdmFyIEFXUyA9IHsgdXRpbDogcmVxdWlyZSgnLi91dGlsJykgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAIW1hY3JvIFtuZXddIG5vYnJvd3NlcgogICAqICAgQG5vdGUgVGhpcyBmZWF0dXJlIGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQgb2YgdGhlIFNESy4KICAgKi8KICB2YXIgX2hpZGRlbiA9IHt9OyBfaGlkZGVuLnRvU3RyaW5nKCk7IC8vIGhhY2sgdG8gcGFyc2UgbWFjcm8KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUzsKICAKICBBV1MudXRpbC51cGRhdGUoQVdTLCB7CiAgCiAgICAvKioKICAgICAqIEBjb25zdGFudAogICAgICovCiAgICBWRVJTSU9OOiAnMi41NTMuMCcsCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBTaWduZXJzOiB7fSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIFByb3RvY29sOiB7CiAgICAgIEpzb246IHJlcXVpcmUoJy4vcHJvdG9jb2wvanNvbicpLAogICAgICBRdWVyeTogcmVxdWlyZSgnLi9wcm90b2NvbC9xdWVyeScpLAogICAgICBSZXN0OiByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3QnKSwKICAgICAgUmVzdEpzb246IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdF9qc29uJyksCiAgICAgIFJlc3RYbWw6IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdF94bWwnKQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIFhNTDogewogICAgICBCdWlsZGVyOiByZXF1aXJlKCcuL3htbC9idWlsZGVyJyksCiAgICAgIFBhcnNlcjogbnVsbCAvLyBjb25kaXRpb25hbGx5IHNldCBiYXNlZCBvbiBlbnZpcm9ubWVudAogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIEpTT046IHsKICAgICAgQnVpbGRlcjogcmVxdWlyZSgnLi9qc29uL2J1aWxkZXInKSwKICAgICAgUGFyc2VyOiByZXF1aXJlKCcuL2pzb24vcGFyc2VyJykKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBNb2RlbDogewogICAgICBBcGk6IHJlcXVpcmUoJy4vbW9kZWwvYXBpJyksCiAgICAgIE9wZXJhdGlvbjogcmVxdWlyZSgnLi9tb2RlbC9vcGVyYXRpb24nKSwKICAgICAgU2hhcGU6IHJlcXVpcmUoJy4vbW9kZWwvc2hhcGUnKSwKICAgICAgUGFnaW5hdG9yOiByZXF1aXJlKCcuL21vZGVsL3BhZ2luYXRvcicpLAogICAgICBSZXNvdXJjZVdhaXRlcjogcmVxdWlyZSgnLi9tb2RlbC9yZXNvdXJjZV93YWl0ZXInKQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwaUxvYWRlcjogcmVxdWlyZSgnLi9hcGlfbG9hZGVyJyksCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBFbmRwb2ludENhY2hlOiByZXF1aXJlKCcuLi92ZW5kb3IvZW5kcG9pbnQtY2FjaGUnKS5FbmRwb2ludENhY2hlCiAgfSk7CiAgcmVxdWlyZSgnLi9zZXF1ZW50aWFsX2V4ZWN1dG9yJyk7CiAgcmVxdWlyZSgnLi9zZXJ2aWNlJyk7CiAgcmVxdWlyZSgnLi9jb25maWcnKTsKICByZXF1aXJlKCcuL2h0dHAnKTsKICByZXF1aXJlKCcuL2V2ZW50X2xpc3RlbmVycycpOwogIHJlcXVpcmUoJy4vcmVxdWVzdCcpOwogIHJlcXVpcmUoJy4vcmVzcG9uc2UnKTsKICByZXF1aXJlKCcuL3Jlc291cmNlX3dhaXRlcicpOwogIHJlcXVpcmUoJy4vc2lnbmVycy9yZXF1ZXN0X3NpZ25lcicpOwogIHJlcXVpcmUoJy4vcGFyYW1fdmFsaWRhdG9yJyk7CiAgCiAgLyoqCiAgICogQHJlYWRvbmx5CiAgICogQHJldHVybiBbQVdTLlNlcXVlbnRpYWxFeGVjdXRvcl0gYSBjb2xsZWN0aW9uIG9mIGdsb2JhbCBldmVudCBsaXN0ZW5lcnMgdGhhdAogICAqICAgYXJlIGF0dGFjaGVkIHRvIGV2ZXJ5IHNlbnQgcmVxdWVzdC4KICAgKiBAc2VlIEFXUy5SZXF1ZXN0IEFXUy5SZXF1ZXN0IGZvciBhIGxpc3Qgb2YgZXZlbnRzIHRvIGxpc3RlbiBmb3IKICAgKiBAZXhhbXBsZSBMb2dnaW5nIHRoZSB0aW1lIHRha2VuIHRvIHNlbmQgYSByZXF1ZXN0CiAgICogICBBV1MuZXZlbnRzLm9uKCdzZW5kJywgZnVuY3Rpb24gc3RhcnRTZW5kKHJlc3ApIHsKICAgKiAgICAgcmVzcC5zdGFydFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgKiAgIH0pLm9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uIGNhbGN1bGF0ZVRpbWUocmVzcCkgewogICAqICAgICB2YXIgdGltZSA9IChuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHJlc3Auc3RhcnRUaW1lKSAvIDEwMDA7CiAgICogICAgIGNvbnNvbGUubG9nKCdSZXF1ZXN0IHRvb2sgJyArIHRpbWUgKyAnIHNlY29uZHMnKTsKICAgKiAgIH0pOwogICAqCiAgICogICBuZXcgQVdTLlMzKCkubGlzdEJ1Y2tldHMoKTsgLy8gcHJpbnRzICdSZXF1ZXN0IHRvb2sgMC4yODUgc2Vjb25kcycKICAgKi8KICBBV1MuZXZlbnRzID0gbmV3IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IoKTsKICAKICAvL2NyZWF0ZSBlbmRwb2ludCBjYWNoZSBsYXppbHkKICBBV1MudXRpbC5tZW1vaXplZFByb3BlcnR5KEFXUywgJ2VuZHBvaW50Q2FjaGUnLCBmdW5jdGlvbigpIHsKICAgIHJldHVybiBuZXcgQVdTLkVuZHBvaW50Q2FjaGUoQVdTLmNvbmZpZy5lbmRwb2ludENhY2hlU2l6ZSk7CiAgfSwgdHJ1ZSk7CiAgCiAgfSx7Ii4uL3ZlbmRvci9lbmRwb2ludC1jYWNoZSI6MTAzLCIuL2FwaV9sb2FkZXIiOjksIi4vY29uZmlnIjoxNywiLi9ldmVudF9saXN0ZW5lcnMiOjMzLCIuL2h0dHAiOjM0LCIuL2pzb24vYnVpbGRlciI6MzYsIi4vanNvbi9wYXJzZXIiOjM3LCIuL21vZGVsL2FwaSI6MzgsIi4vbW9kZWwvb3BlcmF0aW9uIjo0MCwiLi9tb2RlbC9wYWdpbmF0b3IiOjQxLCIuL21vZGVsL3Jlc291cmNlX3dhaXRlciI6NDIsIi4vbW9kZWwvc2hhcGUiOjQzLCIuL3BhcmFtX3ZhbGlkYXRvciI6NDQsIi4vcHJvdG9jb2wvanNvbiI6NDYsIi4vcHJvdG9jb2wvcXVlcnkiOjQ3LCIuL3Byb3RvY29sL3Jlc3QiOjQ4LCIuL3Byb3RvY29sL3Jlc3RfanNvbiI6NDksIi4vcHJvdG9jb2wvcmVzdF94bWwiOjUwLCIuL3JlcXVlc3QiOjU1LCIuL3Jlc291cmNlX3dhaXRlciI6NTYsIi4vcmVzcG9uc2UiOjU3LCIuL3NlcXVlbnRpYWxfZXhlY3V0b3IiOjU4LCIuL3NlcnZpY2UiOjU5LCIuL3NpZ25lcnMvcmVxdWVzdF9zaWduZXIiOjYzLCIuL3V0aWwiOjcxLCIuL3htbC9idWlsZGVyIjo3M31dLDE5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyB5b3VyIEFXUyBzZWN1cml0eSBjcmVkZW50aWFscywgc3BlY2lmaWNhbGx5IHRoZQogICAqIHthY2Nlc3NLZXlJZH0sIHtzZWNyZXRBY2Nlc3NLZXl9LCBhbmQgb3B0aW9uYWwge3Nlc3Npb25Ub2tlbn0uCiAgICogQ3JlYXRpbmcgYSBgQ3JlZGVudGlhbHNgIG9iamVjdCBhbGxvd3MgeW91IHRvIHBhc3MgYXJvdW5kIHlvdXIKICAgKiBzZWN1cml0eSBpbmZvcm1hdGlvbiB0byBjb25maWd1cmF0aW9uIGFuZCBzZXJ2aWNlIG9iamVjdHMuCiAgICoKICAgKiBOb3RlIHRoYXQgdGhpcyBjbGFzcyB0eXBpY2FsbHkgZG9lcyBub3QgbmVlZCB0byBiZSBjb25zdHJ1Y3RlZCBtYW51YWxseSwKICAgKiBhcyB0aGUge0FXUy5Db25maWd9IGFuZCB7QVdTLlNlcnZpY2V9IGNsYXNzZXMgYm90aCBhY2NlcHQgc2ltcGxlCiAgICogb3B0aW9ucyBoYXNoZXMgd2l0aCB0aGUgdGhyZWUga2V5cy4gVGhlc2Ugc3RydWN0dXJlcyB3aWxsIGJlIGNvbnZlcnRlZAogICAqIGludG8gQ3JlZGVudGlhbHMgb2JqZWN0cyBhdXRvbWF0aWNhbGx5LgogICAqCiAgICogIyMgRXhwaXJpbmcgYW5kIFJlZnJlc2hpbmcgQ3JlZGVudGlhbHMKICAgKgogICAqIE9jY2FzaW9uYWxseSBjcmVkZW50aWFscyBjYW4gZXhwaXJlIGluIHRoZSBtaWRkbGUgb2YgYSBsb25nLXJ1bm5pbmcKICAgKiBhcHBsaWNhdGlvbi4gSW4gdGhpcyBjYXNlLCB0aGUgU0RLIHdpbGwgYXV0b21hdGljYWxseSBhdHRlbXB0IHRvCiAgICogcmVmcmVzaCB0aGUgY3JlZGVudGlhbHMgZnJvbSB0aGUgc3RvcmFnZSBsb2NhdGlvbiBpZiB0aGUgQ3JlZGVudGlhbHMKICAgKiBjbGFzcyBpbXBsZW1lbnRzIHRoZSB7cmVmcmVzaH0gbWV0aG9kLgogICAqCiAgICogSWYgeW91IGFyZSBpbXBsZW1lbnRpbmcgYSBjcmVkZW50aWFsIHN0b3JhZ2UgbG9jYXRpb24sIHlvdQogICAqIHdpbGwgd2FudCB0byBjcmVhdGUgYSBzdWJjbGFzcyBvZiB0aGUgYENyZWRlbnRpYWxzYCBjbGFzcyBhbmQKICAgKiBvdmVycmlkZSB0aGUge3JlZnJlc2h9IG1ldGhvZC4gVGhpcyBtZXRob2QgYWxsb3dzIGNyZWRlbnRpYWxzIHRvIGJlCiAgICogcmV0cmlldmVkIGZyb20gdGhlIGJhY2tpbmcgc3RvcmUsIGJlIGl0IGEgZmlsZSBzeXN0ZW0sIGRhdGFiYXNlLCBvcgogICAqIHNvbWUgbmV0d29yayBzdG9yYWdlLiBUaGUgbWV0aG9kIHNob3VsZCByZXNldCB0aGUgY3JlZGVudGlhbCBhdHRyaWJ1dGVzCiAgICogb24gdGhlIG9iamVjdC4KICAgKgogICAqIEAhYXR0cmlidXRlIGV4cGlyZWQKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIGNyZWRlbnRpYWxzIGhhdmUgYmVlbiBleHBpcmVkIGFuZAogICAqICAgICByZXF1aXJlIGEgcmVmcmVzaC4gVXNlZCBpbiBjb25qdW5jdGlvbiB3aXRoIHtleHBpcmVUaW1lfS4KICAgKiBAIWF0dHJpYnV0ZSBleHBpcmVUaW1lCiAgICogICBAcmV0dXJuIFtEYXRlXSBhIHRpbWUgd2hlbiBjcmVkZW50aWFscyBzaG91bGQgYmUgY29uc2lkZXJlZCBleHBpcmVkLiBVc2VkCiAgICogICAgIGluIGNvbmp1bmN0aW9uIHdpdGgge2V4cGlyZWR9LgogICAqIEAhYXR0cmlidXRlIGFjY2Vzc0tleUlkCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBBV1MgYWNjZXNzIGtleSBJRAogICAqIEAhYXR0cmlidXRlIHNlY3JldEFjY2Vzc0tleQogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgQVdTIHNlY3JldCBhY2Nlc3Mga2V5CiAgICogQCFhdHRyaWJ1dGUgc2Vzc2lvblRva2VuCiAgICogICBAcmV0dXJuIFtTdHJpbmddIGFuIG9wdGlvbmFsIEFXUyBzZXNzaW9uIHRva2VuCiAgICovCiAgQVdTLkNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdCh7CiAgICAvKioKICAgICAqIEEgY3JlZGVudGlhbHMgb2JqZWN0IGNhbiBiZSBjcmVhdGVkIHVzaW5nIHBvc2l0aW9uYWwgYXJndW1lbnRzIG9yIGFuIG9wdGlvbnMKICAgICAqIGhhc2guCiAgICAgKgogICAgICogQG92ZXJsb2FkIEFXUy5DcmVkZW50aWFscyhhY2Nlc3NLZXlJZCwgc2VjcmV0QWNjZXNzS2V5LCBzZXNzaW9uVG9rZW49bnVsbCkKICAgICAqICAgQ3JlYXRlcyBhIENyZWRlbnRpYWxzIG9iamVjdCB3aXRoIGEgZ2l2ZW4gc2V0IG9mIGNyZWRlbnRpYWwgaW5mb3JtYXRpb24KICAgICAqICAgYXMgcG9zaXRpb25hbCBhcmd1bWVudHMuCiAgICAgKiAgIEBwYXJhbSBhY2Nlc3NLZXlJZCBbU3RyaW5nXSB0aGUgQVdTIGFjY2VzcyBrZXkgSUQKICAgICAqICAgQHBhcmFtIHNlY3JldEFjY2Vzc0tleSBbU3RyaW5nXSB0aGUgQVdTIHNlY3JldCBhY2Nlc3Mga2V5CiAgICAgKiAgIEBwYXJhbSBzZXNzaW9uVG9rZW4gW1N0cmluZ10gdGhlIG9wdGlvbmFsIEFXUyBzZXNzaW9uIHRva2VuCiAgICAgKiAgIEBleGFtcGxlIENyZWF0ZSBhIGNyZWRlbnRpYWxzIG9iamVjdCB3aXRoIEFXUyBjcmVkZW50aWFscwogICAgICogICAgIHZhciBjcmVkcyA9IG5ldyBBV1MuQ3JlZGVudGlhbHMoJ2FraWQnLCAnc2VjcmV0JywgJ3Nlc3Npb24nKTsKICAgICAqIEBvdmVybG9hZCBBV1MuQ3JlZGVudGlhbHMob3B0aW9ucykKICAgICAqICAgQ3JlYXRlcyBhIENyZWRlbnRpYWxzIG9iamVjdCB3aXRoIGEgZ2l2ZW4gc2V0IG9mIGNyZWRlbnRpYWwgaW5mb3JtYXRpb24KICAgICAqICAgYXMgYW4gb3B0aW9ucyBoYXNoLgogICAgICogICBAb3B0aW9uIG9wdGlvbnMgYWNjZXNzS2V5SWQgW1N0cmluZ10gdGhlIEFXUyBhY2Nlc3Mga2V5IElECiAgICAgKiAgIEBvcHRpb24gb3B0aW9ucyBzZWNyZXRBY2Nlc3NLZXkgW1N0cmluZ10gdGhlIEFXUyBzZWNyZXQgYWNjZXNzIGtleQogICAgICogICBAb3B0aW9uIG9wdGlvbnMgc2Vzc2lvblRva2VuIFtTdHJpbmddIHRoZSBvcHRpb25hbCBBV1Mgc2Vzc2lvbiB0b2tlbgogICAgICogICBAZXhhbXBsZSBDcmVhdGUgYSBjcmVkZW50aWFscyBvYmplY3Qgd2l0aCBBV1MgY3JlZGVudGlhbHMKICAgICAqICAgICB2YXIgY3JlZHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKHsKICAgICAqICAgICAgIGFjY2Vzc0tleUlkOiAnYWtpZCcsIHNlY3JldEFjY2Vzc0tleTogJ3NlY3JldCcsIHNlc3Npb25Ub2tlbjogJ3Nlc3Npb24nCiAgICAgKiAgICAgfSk7CiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDcmVkZW50aWFscygpIHsKICAgICAgLy8gaGlkZSBzZWNyZXRBY2Nlc3NLZXkgZnJvbSBiZWluZyBkaXNwbGF5ZWQgd2l0aCB1dGlsLmluc3BlY3QKICAgICAgQVdTLnV0aWwuaGlkZVByb3BlcnRpZXModGhpcywgWydzZWNyZXRBY2Nlc3NLZXknXSk7CiAgCiAgICAgIHRoaXMuZXhwaXJlZCA9IGZhbHNlOwogICAgICB0aGlzLmV4cGlyZVRpbWUgPSBudWxsOwogICAgICB0aGlzLnJlZnJlc2hDYWxsYmFja3MgPSBbXTsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEgJiYgdHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gJ29iamVjdCcpIHsKICAgICAgICB2YXIgY3JlZHMgPSBhcmd1bWVudHNbMF0uY3JlZGVudGlhbHMgfHwgYXJndW1lbnRzWzBdOwogICAgICAgIHRoaXMuYWNjZXNzS2V5SWQgPSBjcmVkcy5hY2Nlc3NLZXlJZDsKICAgICAgICB0aGlzLnNlY3JldEFjY2Vzc0tleSA9IGNyZWRzLnNlY3JldEFjY2Vzc0tleTsKICAgICAgICB0aGlzLnNlc3Npb25Ub2tlbiA9IGNyZWRzLnNlc3Npb25Ub2tlbjsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmFjY2Vzc0tleUlkID0gYXJndW1lbnRzWzBdOwogICAgICAgIHRoaXMuc2VjcmV0QWNjZXNzS2V5ID0gYXJndW1lbnRzWzFdOwogICAgICAgIHRoaXMuc2Vzc2lvblRva2VuID0gYXJndW1lbnRzWzJdOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbnVtYmVyIG9mIHNlY29uZHMgYmVmb3JlIHtleHBpcmVUaW1lfSBkdXJpbmcgd2hpY2gKICAgICAqICAgdGhlIGNyZWRlbnRpYWxzIHdpbGwgYmUgY29uc2lkZXJlZCBleHBpcmVkLgogICAgICovCiAgICBleHBpcnlXaW5kb3c6IDE1LAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBjcmVkZW50aWFscyBvYmplY3Qgc2hvdWxkIGNhbGwge3JlZnJlc2h9CiAgICAgKiBAbm90ZSBTdWJjbGFzc2VzIHNob3VsZCBvdmVycmlkZSB0aGlzIG1ldGhvZCB0byBwcm92aWRlIGN1c3RvbSByZWZyZXNoCiAgICAgKiAgIGxvZ2ljLgogICAgICovCiAgICBuZWVkc1JlZnJlc2g6IGZ1bmN0aW9uIG5lZWRzUmVmcmVzaCgpIHsKICAgICAgdmFyIGN1cnJlbnRUaW1lID0gQVdTLnV0aWwuZGF0ZS5nZXREYXRlKCkuZ2V0VGltZSgpOwogICAgICB2YXIgYWRqdXN0ZWRUaW1lID0gbmV3IERhdGUoY3VycmVudFRpbWUgKyB0aGlzLmV4cGlyeVdpbmRvdyAqIDEwMDApOwogIAogICAgICBpZiAodGhpcy5leHBpcmVUaW1lICYmIGFkanVzdGVkVGltZSA+IHRoaXMuZXhwaXJlVGltZSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmV4cGlyZWQgfHwgIXRoaXMuYWNjZXNzS2V5SWQgfHwgIXRoaXMuc2VjcmV0QWNjZXNzS2V5OwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBleGlzdGluZyBjcmVkZW50aWFscywgcmVmcmVzaGluZyB0aGVtIGlmIHRoZXkgYXJlIG5vdCB5ZXQgbG9hZGVkCiAgICAgKiBvciBoYXZlIGV4cGlyZWQuIFVzZXJzIHNob3VsZCBjYWxsIHRoaXMgbWV0aG9kIGJlZm9yZSB1c2luZyB7cmVmcmVzaH0sCiAgICAgKiBhcyB0aGlzIHdpbGwgbm90IGF0dGVtcHQgdG8gcmVsb2FkIGNyZWRlbnRpYWxzIHdoZW4gdGhleSBhcmUgYWxyZWFkeQogICAgICogbG9hZGVkIGludG8gdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICBXaGVuIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIGVpdGhlciBjcmVkZW50aWFscwogICAgICogICBkbyBub3QgbmVlZCB0byBiZSByZWZyZXNoZWQgb3IgcmVmcmVzaGVkIGNyZWRlbnRpYWxzIGluZm9ybWF0aW9uIGhhcwogICAgICogICBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLCBgc2VjcmV0QWNjZXNzS2V5YCwKICAgICAqICAgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqLwogICAgZ2V0OiBmdW5jdGlvbiBnZXQoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZiAodGhpcy5uZWVkc1JlZnJlc2goKSkgewogICAgICAgIHRoaXMucmVmcmVzaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIGlmICghZXJyKSBzZWxmLmV4cGlyZWQgPSBmYWxzZTsgLy8gcmVzZXQgZXhwaXJlZCBmbGFnCiAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKGVycik7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAoY2FsbGJhY2spIHsKICAgICAgICBjYWxsYmFjaygpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAIW1ldGhvZCAgZ2V0UHJvbWlzZSgpCiAgICAgKiAgIFJldHVybnMgYSAndGhlbmFibGUnIHByb21pc2UuCiAgICAgKiAgIEdldHMgdGhlIGV4aXN0aW5nIGNyZWRlbnRpYWxzLCByZWZyZXNoaW5nIHRoZW0gaWYgdGhleSBhcmUgbm90IHlldCBsb2FkZWQKICAgICAqICAgb3IgaGF2ZSBleHBpcmVkLiBVc2VycyBzaG91bGQgY2FsbCB0aGlzIG1ldGhvZCBiZWZvcmUgdXNpbmcge3JlZnJlc2h9LAogICAgICogICBhcyB0aGlzIHdpbGwgbm90IGF0dGVtcHQgdG8gcmVsb2FkIGNyZWRlbnRpYWxzIHdoZW4gdGhleSBhcmUgYWxyZWFkeQogICAgICogICBsb2FkZWQgaW50byB0aGUgb2JqZWN0LgogICAgICoKICAgICAqICAgVHdvIGNhbGxiYWNrcyBjYW4gYmUgcHJvdmlkZWQgdG8gdGhlIGB0aGVuYCBtZXRob2Qgb24gdGhlIHJldHVybmVkIHByb21pc2UuCiAgICAgKiAgIFRoZSBmaXJzdCBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQsIGFuZCB0aGUgc2Vjb25kCiAgICAgKiAgIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICBAY2FsbGJhY2sgZnVsZmlsbGVkQ2FsbGJhY2sgZnVuY3Rpb24oKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQuIFdoZW4gdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQsIGl0CiAgICAgKiAgICAgbWVhbnMgZWl0aGVyIGNyZWRlbnRpYWxzIGRvIG5vdCBuZWVkIHRvIGJlIHJlZnJlc2hlZCBvciByZWZyZXNoZWQKICAgICAqICAgICBjcmVkZW50aWFscyBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUKICAgICAqICAgICBgYWNjZXNzS2V5SWRgLCBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAY2FsbGJhY2sgcmVqZWN0ZWRDYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogICBAcmV0dXJuIFtQcm9taXNlXSBBIHByb21pc2UgdGhhdCByZXByZXNlbnRzIHRoZSBzdGF0ZSBvZiB0aGUgYGdldGAgY2FsbC4KICAgICAqICAgQGV4YW1wbGUgQ2FsbGluZyB0aGUgYGdldFByb21pc2VgIG1ldGhvZC4KICAgICAqICAgICB2YXIgcHJvbWlzZSA9IGNyZWRQcm92aWRlci5nZXRQcm9taXNlKCk7CiAgICAgKiAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKCkgeyAuLi4gfSwgZnVuY3Rpb24oZXJyKSB7IC4uLiB9KTsKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBAIW1ldGhvZCAgcmVmcmVzaFByb21pc2UoKQogICAgICogICBSZXR1cm5zIGEgJ3RoZW5hYmxlJyBwcm9taXNlLgogICAgICogICBSZWZyZXNoZXMgdGhlIGNyZWRlbnRpYWxzLiBVc2VycyBzaG91bGQgY2FsbCB7Z2V0fSBiZWZvcmUgYXR0ZW1wdGluZwogICAgICogICB0byBmb3JjaWJseSByZWZyZXNoIGNyZWRlbnRpYWxzLgogICAgICoKICAgICAqICAgVHdvIGNhbGxiYWNrcyBjYW4gYmUgcHJvdmlkZWQgdG8gdGhlIGB0aGVuYCBtZXRob2Qgb24gdGhlIHJldHVybmVkIHByb21pc2UuCiAgICAgKiAgIFRoZSBmaXJzdCBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQsIGFuZCB0aGUgc2Vjb25kCiAgICAgKiAgIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICBAY2FsbGJhY2sgZnVsZmlsbGVkQ2FsbGJhY2sgZnVuY3Rpb24oKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQuIFdoZW4gdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQsIGl0CiAgICAgKiAgICAgbWVhbnMgcmVmcmVzaGVkIGNyZWRlbnRpYWxzIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QKICAgICAqICAgICAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBjYWxsYmFjayByZWplY3RlZENhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICAgKiAgICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKiAgIEByZXR1cm4gW1Byb21pc2VdIEEgcHJvbWlzZSB0aGF0IHJlcHJlc2VudHMgdGhlIHN0YXRlIG9mIHRoZSBgcmVmcmVzaGAgY2FsbC4KICAgICAqICAgQGV4YW1wbGUgQ2FsbGluZyB0aGUgYHJlZnJlc2hQcm9taXNlYCBtZXRob2QuCiAgICAgKiAgICAgdmFyIHByb21pc2UgPSBjcmVkUHJvdmlkZXIucmVmcmVzaFByb21pc2UoKTsKICAgICAqICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24oKSB7IC4uLiB9LCBmdW5jdGlvbihlcnIpIHsgLi4uIH0pOwogICAgICovCiAgCiAgICAvKioKICAgICAqIFJlZnJlc2hlcyB0aGUgY3JlZGVudGlhbHMuIFVzZXJzIHNob3VsZCBjYWxsIHtnZXR9IGJlZm9yZSBhdHRlbXB0aW5nCiAgICAgKiB0byBmb3JjaWJseSByZWZyZXNoIGNyZWRlbnRpYWxzLgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIFdoZW4gdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgcmVmcmVzaGVkCiAgICAgKiAgIGNyZWRlbnRpYWxzIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZQogICAgICogICBgYWNjZXNzS2V5SWRgLCBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqIEBub3RlIFN1YmNsYXNzZXMgc2hvdWxkIG92ZXJyaWRlIHRoaXMgY2xhc3MgdG8gcmVzZXQgdGhlCiAgICAgKiAgIHthY2Nlc3NLZXlJZH0sIHtzZWNyZXRBY2Nlc3NLZXl9IGFuZCBvcHRpb25hbCB7c2Vzc2lvblRva2VufQogICAgICogICBvbiB0aGUgY3JlZGVudGlhbHMgb2JqZWN0IGFuZCB0aGVuIGNhbGwgdGhlIGNhbGxiYWNrIHdpdGgKICAgICAqICAgYW55IGVycm9yIGluZm9ybWF0aW9uLgogICAgICogQHNlZSBnZXQKICAgICAqLwogICAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaChjYWxsYmFjaykgewogICAgICB0aGlzLmV4cGlyZWQgPSBmYWxzZTsKICAgICAgY2FsbGJhY2soKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICogQHBhcmFtIGNhbGxiYWNrCiAgICAgKi8KICAgIGNvYWxlc2NlUmVmcmVzaDogZnVuY3Rpb24gY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrLCBzeW5jKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgaWYgKHNlbGYucmVmcmVzaENhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKSA9PT0gMSkgewogICAgICAgIHNlbGYubG9hZChmdW5jdGlvbiBvbkxvYWQoZXJyKSB7CiAgICAgICAgICBBV1MudXRpbC5hcnJheUVhY2goc2VsZi5yZWZyZXNoQ2FsbGJhY2tzLCBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgICBpZiAoc3luYykgewogICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gY2FsbGJhY2sgY291bGQgdGhyb3csIHNvIGRlZmVyIHRvIGVuc3VyZSBhbGwgY2FsbGJhY2tzIGFyZSBub3RpZmllZAogICAgICAgICAgICAgIEFXUy51dGlsLmRlZmVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgc2VsZi5yZWZyZXNoQ2FsbGJhY2tzLmxlbmd0aCA9IDA7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICogQHBhcmFtIGNhbGxiYWNrCiAgICAgKi8KICAgIGxvYWQ6IGZ1bmN0aW9uIGxvYWQoY2FsbGJhY2spIHsKICAgICAgY2FsbGJhY2soKTsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuQ3JlZGVudGlhbHMuYWRkUHJvbWlzZXNUb0NsYXNzID0gZnVuY3Rpb24gYWRkUHJvbWlzZXNUb0NsYXNzKFByb21pc2VEZXBlbmRlbmN5KSB7CiAgICB0aGlzLnByb3RvdHlwZS5nZXRQcm9taXNlID0gQVdTLnV0aWwucHJvbWlzaWZ5TWV0aG9kKCdnZXQnLCBQcm9taXNlRGVwZW5kZW5jeSk7CiAgICB0aGlzLnByb3RvdHlwZS5yZWZyZXNoUHJvbWlzZSA9IEFXUy51dGlsLnByb21pc2lmeU1ldGhvZCgncmVmcmVzaCcsIFByb21pc2VEZXBlbmRlbmN5KTsKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5DcmVkZW50aWFscy5kZWxldGVQcm9taXNlc0Zyb21DbGFzcyA9IGZ1bmN0aW9uIGRlbGV0ZVByb21pc2VzRnJvbUNsYXNzKCkgewogICAgZGVsZXRlIHRoaXMucHJvdG90eXBlLmdldFByb21pc2U7CiAgICBkZWxldGUgdGhpcy5wcm90b3R5cGUucmVmcmVzaFByb21pc2U7CiAgfTsKICAKICBBV1MudXRpbC5hZGRQcm9taXNlcyhBV1MuQ3JlZGVudGlhbHMpOwogIAogIH0seyIuL2NvcmUiOjE4fV0sMjA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIFNUUyA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvc3RzJyk7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgcmV0cmlldmVkIGZyb20ge0FXUy5TVFN9LiBXaXRob3V0IGFueQogICAqIGV4dHJhIHBhcmFtZXRlcnMsIGNyZWRlbnRpYWxzIHdpbGwgYmUgZmV0Y2hlZCBmcm9tIHRoZQogICAqIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0gb3BlcmF0aW9uLiBJZiBhbiBJQU0gcm9sZSBpcyBwcm92aWRlZCwgdGhlCiAgICoge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3BlcmF0aW9uIHdpbGwgYmUgdXNlZCB0byBmZXRjaCBjcmVkZW50aWFscyBmb3IgdGhlCiAgICogcm9sZSBpbnN0ZWFkLgogICAqCiAgICogQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzIGRpZmZlcnMgZnJvbSBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgaW4KICAgKiB0aGUgd2F5IG1hc3RlckNyZWRlbnRpYWxzIGFuZCByZWZyZXNoZXMgYXJlIGhhbmRsZWQuCiAgICogQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzIHJlZnJlc2hlcyBleHBpcmVkIGNyZWRlbnRpYWxzIHVzaW5nIHRoZQogICAqIG1hc3RlckNyZWRlbnRpYWxzIHBhc3NlZCBieSB0aGUgdXNlciB0byBzdXBwb3J0IGNoYWluaW5nIG9mIFNUUyBjcmVkZW50aWFscy4KICAgKiBIb3dldmVyLCBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgcmVjdXJzaXZlbHkgY29sbGFwc2VzIHRoZSBtYXN0ZXJDcmVkZW50aWFscwogICAqIGR1cmluZyBpbnN0YW50aWF0aW9uLCBwcmVjbHVkaW5nIHRoZSBhYmlsaXR5IHRvIHJlZnJlc2ggY3JlZGVudGlhbHMgd2hpY2gKICAgKiByZXF1aXJlIGludGVybWVkaWF0ZSwgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLgogICAqCiAgICogRm9yIGV4YW1wbGUsIGlmIHRoZSBhcHBsaWNhdGlvbiBzaG91bGQgdXNlIFJvbGVBLCB3aGljaCBtdXN0IGJlIGFzc3VtZWQgZnJvbQogICAqIFJvbGVCLCBhbmQgdGhlIGVudmlyb25tZW50IHByb3ZpZGVzIGNyZWRlbnRpYWxzIHdoaWNoIGNhbiBhc3N1bWUgUm9sZUIsIHRoZW4KICAgKiBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgbXVzdCBiZSB1c2VkIHRvIHN1cHBvcnQgcmVmcmVzaGluZyB0aGUKICAgKiB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZm9yIFJvbGVBOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIHZhciByb2xlQUNyZWRzID0gbmV3IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyh7CiAgICogICBwYXJhbXM6IHtSb2xlQXJuOiAnUm9sZUEnfSwKICAgKiAgIG1hc3RlckNyZWRlbnRpYWxzOiBuZXcgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICAgKiAgICAgcGFyYW1zOiB7Um9sZUFybjogJ1JvbGVCJ30sCiAgICogICAgIG1hc3RlckNyZWRlbnRpYWxzOiBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FXUycpCiAgICogICB9KQogICAqIH0pOwogICAqIGBgYAogICAqCiAgICogSWYgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzIGhhZCBiZWVuIHVzZWQgaW4gdGhlIHByZXZpb3VzIGV4YW1wbGUsCiAgICogYHJvbGVBQ3JlZHNgIHdvdWxkIGZhaWwgdG8gcmVmcmVzaCBiZWNhdXNlIGByb2xlQUNyZWRzYCB3b3VsZAogICAqIHVzZSB0aGUgZW52aXJvbm1lbnQgY3JlZGVudGlhbHMgZm9yIHRoZSBBc3N1bWVSb2xlIHJlcXVlc3QuCiAgICoKICAgKiBBbm90aGVyIGRpZmZlcmVuY2UgaXMgdGhhdCBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgY3JlYXRlcyB0aGUgU1RTCiAgICogc2VydmljZSBpbnN0YW5jZSBkdXJpbmcgaW5zdGFudGlhdGlvbiB3aGlsZSBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgY3JlYXRlcwogICAqIHRoZSBTVFMgc2VydmljZSBpbnN0YW5jZSBkdXJpbmcgdGhlIGZpcnN0IHJlZnJlc2guIENyZWF0aW5nIHRoZSBzZXJ2aWNlCiAgICogaW5zdGFuY2UgZHVyaW5nIGluc3RhbnRpYXRpb24gZWZmZWN0aXZlbHkgY2FwdHVyZXMgdGhlIG1hc3RlciBjcmVkZW50aWFscwogICAqIGZyb20gdGhlIGdsb2JhbCBjb25maWcsIHNvIHRoYXQgc3Vic2VxdWVudCBjaGFuZ2VzIHRvIHRoZSBnbG9iYWwgY29uZmlnIGRvCiAgICogbm90IGFmZmVjdCB0aGUgbWFzdGVyIGNyZWRlbnRpYWxzIHVzZWQgdG8gcmVmcmVzaCB0aGUgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLgogICAqCiAgICogVGhpcyBhbGxvd3MgYW4gaW5zdGFuY2Ugb2YgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzIHRvIGJlIGFzc2lnbmVkCiAgICogdG8gQVdTLmNvbmZpZy5jcmVkZW50aWFsczoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiB2YXIgZW52Q3JlZHMgPSBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FXUycpOwogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBlbnZDcmVkczsKICAgKiAvLyBtYXN0ZXJDcmVkZW50aWFscyB3aWxsIGJlIGVudkNyZWRzCiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogICAqICAgcGFyYW1zOiB7Um9sZUFybjogJy4uLid9CiAgICogfSk7CiAgICogYGBgCiAgICoKICAgKiBTaW1pbGFybHksIHRvIHVzZSB0aGUgQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4ncyBkZWZhdWx0IHByb3ZpZGVycyBhcyB0aGUKICAgKiBtYXN0ZXIgY3JlZGVudGlhbHMsIHNpbXBseSBjcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YKICAgKiBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHM6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBDaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyh7CiAgICogICBwYXJhbXM6IHtSb2xlQXJuOiAnLi4uJ30KICAgKiB9KTsKICAgKiBgYGAKICAgKgogICAqIEAhYXR0cmlidXRlIHNlcnZpY2UKICAgKiAgIEByZXR1cm4gW0FXUy5TVFNdIHRoZSBTVFMgc2VydmljZSBpbnN0YW5jZSB1c2VkIHRvCiAgICogICAgIGdldCBhbmQgcmVmcmVzaCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZnJvbSBBV1MgU1RTLgogICAqIEBub3RlIChzZWUgY29uc3RydWN0b3IpCiAgICovCiAgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgb2JqZWN0LgogICAgICoKICAgICAqIEBwYXJhbSBvcHRpb25zIFttYXBdIGEgc2V0IG9mIG9wdGlvbnMKICAgICAqIEBvcHRpb24gb3B0aW9ucyBwYXJhbXMgW21hcF0gKHt9KSBhIG1hcCBvZiBvcHRpb25zIHRoYXQgYXJlIHBhc3NlZCB0byB0aGUKICAgICAqICAge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3Ige0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSBvcGVyYXRpb25zLgogICAgICogICBJZiBhIGBSb2xlQXJuYCBwYXJhbWV0ZXIgaXMgcGFzc2VkIGluLCBjcmVkZW50aWFscyB3aWxsIGJlIGJhc2VkIG9uIHRoZQogICAgICogICBJQU0gcm9sZS4gSWYgYSBgU2VyaWFsTnVtYmVyYCBwYXJhbWV0ZXIgaXMgcGFzc2VkIGluLCB7dG9rZW5Db2RlRm59IG11c3QKICAgICAqICAgYWxzbyBiZSBwYXNzZWQgaW4gb3IgYW4gZXJyb3Igd2lsbCBiZSB0aHJvd24uCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgbWFzdGVyQ3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gdGhlIG1hc3RlciBjcmVkZW50aWFscwogICAgICogICB1c2VkIHRvIGdldCBhbmQgcmVmcmVzaCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZnJvbSBBV1MgU1RTLiBCeSBkZWZhdWx0LAogICAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzIG9yIEFXUy5jb25maWcuY3JlZGVudGlhbFByb3ZpZGVyIHdpbGwgYmUgdXNlZC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyB0b2tlbkNvZGVGbiBbRnVuY3Rpb25dIChudWxsKSBGdW5jdGlvbiB0byBwcm92aWRlCiAgICAgKiAgIGBUb2tlbkNvZGVgLCBpZiBgU2VyaWFsTnVtYmVyYCBpcyBwcm92aWRlZCBmb3IgcHJvZmlsZSBpbiB7cGFyYW1zfS4gRnVuY3Rpb24KICAgICAqICAgaXMgY2FsbGVkIHdpdGggdmFsdWUgb2YgYFNlcmlhbE51bWJlcmAgYW5kIGBjYWxsYmFja2AsIGFuZCBzaG91bGQgcHJvdmlkZQogICAgICogICB0aGUgYFRva2VuQ29kZWAgb3IgYW4gZXJyb3IgdG8gdGhlIGNhbGxiYWNrIGluIHRoZSBmb3JtYXQKICAgICAqICAgYGNhbGxiYWNrKGVyciwgdG9rZW4pYC4KICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdCBmb3IgZ2VuZXJpYyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoKTsKICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdCBmb3IgYW4gSUFNIHJvbGUKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogICAgICogICAgIHBhcmFtczogewogICAgICogICAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvVGVtcG9yYXJ5Q3JlZGVudGlhbHMnCiAgICAgKiAgICAgfQogICAgICogICB9KTsKICAgICAqIEBzZWUgQVdTLlNUUy5hc3N1bWVSb2xlCiAgICAgKiBAc2VlIEFXUy5TVFMuZ2V0U2Vzc2lvblRva2VuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyhvcHRpb25zKSB7CiAgICAgIEFXUy5DcmVkZW50aWFscy5jYWxsKHRoaXMpOwogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgdGhpcy5lcnJvckNvZGUgPSAnQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHNQcm92aWRlckZhaWx1cmUnOwogICAgICB0aGlzLmV4cGlyZWQgPSB0cnVlOwogICAgICB0aGlzLnRva2VuQ29kZUZuID0gbnVsbDsKICAKICAgICAgdmFyIHBhcmFtcyA9IEFXUy51dGlsLmNvcHkob3B0aW9ucy5wYXJhbXMpIHx8IHt9OwogICAgICBpZiAocGFyYW1zLlJvbGVBcm4pIHsKICAgICAgICBwYXJhbXMuUm9sZVNlc3Npb25OYW1lID0gcGFyYW1zLlJvbGVTZXNzaW9uTmFtZSB8fCAndGVtcG9yYXJ5LWNyZWRlbnRpYWxzJzsKICAgICAgfQogICAgICBpZiAocGFyYW1zLlNlcmlhbE51bWJlcikgewogICAgICAgIGlmICghb3B0aW9ucy50b2tlbkNvZGVGbiB8fCAodHlwZW9mIG9wdGlvbnMudG9rZW5Db2RlRm4gIT09ICdmdW5jdGlvbicpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgQVdTLnV0aWwuZXJyb3IoCiAgICAgICAgICAgIG5ldyBFcnJvcigndG9rZW5Db2RlRm4gbXVzdCBiZSBhIGZ1bmN0aW9uIHdoZW4gcGFyYW1zLlNlcmlhbE51bWJlciBpcyBnaXZlbicpLAogICAgICAgICAgICB7Y29kZTogdGhpcy5lcnJvckNvZGV9CiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnRva2VuQ29kZUZuID0gb3B0aW9ucy50b2tlbkNvZGVGbjsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIGNvbmZpZyA9IEFXUy51dGlsLm1lcmdlKAogICAgICAgIHsKICAgICAgICAgIHBhcmFtczogcGFyYW1zLAogICAgICAgICAgY3JlZGVudGlhbHM6IG9wdGlvbnMubWFzdGVyQ3JlZGVudGlhbHMgfHwgQVdTLmNvbmZpZy5jcmVkZW50aWFscwogICAgICAgIH0sCiAgICAgICAgb3B0aW9ucy5zdHNDb25maWcgfHwge30KICAgICAgKTsKICAgICAgdGhpcy5zZXJ2aWNlID0gbmV3IFNUUyhjb25maWcpOwogICAgfSwKICAKICAgIC8qKgogICAgICogUmVmcmVzaGVzIGNyZWRlbnRpYWxzIHVzaW5nIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9yCiAgICAgKiB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59LCBkZXBlbmRpbmcgb24gd2hldGhlciBhbiBJQU0gcm9sZSBBUk4gd2FzIHBhc3NlZAogICAgICogdG8gdGhlIGNyZWRlbnRpYWxzIHtjb25zdHJ1Y3Rvcn0uCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgQ2FsbGVkIHdoZW4gdGhlIFNUUyBzZXJ2aWNlIHJlc3BvbmRzIChvciBmYWlscykuIFdoZW4KICAgICAqICAgdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgdGhhdCB0aGUgY3JlZGVudGlhbHMKICAgICAqICAgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsCiAgICAgKiAgIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogQHNlZSBBV1MuQ3JlZGVudGlhbHMuZ2V0CiAgICAgKi8KICAgIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2goY2FsbGJhY2spIHsKICAgICAgdGhpcy5jb2FsZXNjZVJlZnJlc2goY2FsbGJhY2sgfHwgQVdTLnV0aWwuZm4uY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgICAqLwogICAgbG9hZDogZnVuY3Rpb24gbG9hZChjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBvcGVyYXRpb24gPSBzZWxmLnNlcnZpY2UuY29uZmlnLnBhcmFtcy5Sb2xlQXJuID8gJ2Fzc3VtZVJvbGUnIDogJ2dldFNlc3Npb25Ub2tlbic7CiAgICAgIHRoaXMuZ2V0VG9rZW5Db2RlKGZ1bmN0aW9uIChlcnIsIHRva2VuQ29kZSkgewogICAgICAgIHZhciBwYXJhbXMgPSB7fTsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodG9rZW5Db2RlKSB7CiAgICAgICAgICBwYXJhbXMuVG9rZW5Db2RlID0gdG9rZW5Db2RlOwogICAgICAgIH0KICAgICAgICBzZWxmLnNlcnZpY2Vbb3BlcmF0aW9uXShwYXJhbXMsIGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICAgIHNlbGYuc2VydmljZS5jcmVkZW50aWFsc0Zyb20oZGF0YSwgc2VsZik7CiAgICAgICAgICB9CiAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRUb2tlbkNvZGU6IGZ1bmN0aW9uIGdldFRva2VuQ29kZShjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmICh0aGlzLnRva2VuQ29kZUZuKSB7CiAgICAgICAgdGhpcy50b2tlbkNvZGVGbih0aGlzLnNlcnZpY2UuY29uZmlnLnBhcmFtcy5TZXJpYWxOdW1iZXIsIGZ1bmN0aW9uIChlcnIsIHRva2VuKSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gZXJyOwogICAgICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICAgICAgICBtZXNzYWdlID0gZXJyLm1lc3NhZ2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FsbGJhY2soCiAgICAgICAgICAgICAgQVdTLnV0aWwuZXJyb3IoCiAgICAgICAgICAgICAgICBuZXcgRXJyb3IoJ0Vycm9yIGZldGNoaW5nIE1GQSB0b2tlbjogJyArIG1lc3NhZ2UpLAogICAgICAgICAgICAgICAgeyBjb2RlOiBzZWxmLmVycm9yQ29kZX0KICAgICAgICAgICAgICApCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHRva2VuKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFjayhudWxsKTsKICAgICAgfQogICAgfQogIH0pOwogIAogIH0seyIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTh9XSwyMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgQ29nbml0b0lkZW50aXR5ID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9jb2duaXRvaWRlbnRpdHknKTsKICB2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIGNyZWRlbnRpYWxzIHJldHJpZXZlZCBmcm9tIFNUUyBXZWIgSWRlbnRpdHkgRmVkZXJhdGlvbiB1c2luZwogICAqIHRoZSBBbWF6b24gQ29nbml0byBJZGVudGl0eSBzZXJ2aWNlLgogICAqCiAgICogQnkgZGVmYXVsdCB0aGlzIHByb3ZpZGVyIGdldHMgY3JlZGVudGlhbHMgdXNpbmcgdGhlCiAgICoge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eX0gc2VydmljZSBvcGVyYXRpb24sIHdoaWNoCiAgICogcmVxdWlyZXMgZWl0aGVyIGFuIGBJZGVudGl0eUlkYCBvciBhbiBgSWRlbnRpdHlQb29sSWRgIChBbWF6b24gQ29nbml0bwogICAqIElkZW50aXR5IFBvb2wgSUQpLCB3aGljaCBpcyB1c2VkIHRvIGNhbGwge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0SWR9IHRvCiAgICogb2J0YWluIGFuIGBJZGVudGl0eUlkYC4gSWYgdGhlIGlkZW50aXR5IG9yIGlkZW50aXR5IHBvb2wgaXMgbm90IGNvbmZpZ3VyZWQgaW4KICAgKiB0aGUgQW1hem9uIENvZ25pdG8gQ29uc29sZSB0byB1c2UgSUFNIHJvbGVzIHdpdGggdGhlIGFwcHJvcHJpYXRlIHBlcm1pc3Npb25zLAogICAqIHRoZW4gYWRkaXRpb25hbGx5IGEgYFJvbGVBcm5gIGlzIHJlcXVpcmVkIGNvbnRhaW5pbmcgdGhlIEFSTiBvZiB0aGUgSUFNIHRydXN0CiAgICogcG9saWN5IGZvciB0aGUgQW1hem9uIENvZ25pdG8gcm9sZSB0aGF0IHRoZSB1c2VyIHdpbGwgbG9nIGludG8uIElmIGEgYFJvbGVBcm5gCiAgICogaXMgcHJvdmlkZWQsIHRoZW4gdGhpcyBwcm92aWRlciBnZXRzIGNyZWRlbnRpYWxzIHVzaW5nIHRoZQogICAqIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9IHNlcnZpY2Ugb3BlcmF0aW9uLCBhZnRlciBmaXJzdCBnZXR0aW5nIGFuCiAgICogT3BlbiBJRCB0b2tlbiBmcm9tIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldE9wZW5JZFRva2VufS4KICAgKgogICAqIEluIGFkZGl0aW9uLCBpZiB0aGlzIGNyZWRlbnRpYWwgcHJvdmlkZXIgaXMgdXNlZCB0byBwcm92aWRlIGF1dGhlbnRpY2F0ZWQKICAgKiBsb2dpbiwgdGhlIGBMb2dpbnNgIG1hcCBtYXkgYmUgc2V0IHRvIHRoZSB0b2tlbnMgcHJvdmlkZWQgYnkgdGhlIHJlc3BlY3RpdmUKICAgKiBpZGVudGl0eSBwcm92aWRlcnMuIFNlZSB7Y29uc3RydWN0b3J9IGZvciBhbiBleGFtcGxlIG9uIGNyZWF0aW5nIGEgY3JlZGVudGlhbHMKICAgKiBvYmplY3Qgd2l0aCBwcm9wZXIgcHJvcGVydHkgdmFsdWVzLgogICAqCiAgICogIyMgUmVmcmVzaGluZyBDcmVkZW50aWFscyBmcm9tIElkZW50aXR5IFNlcnZpY2UKICAgKgogICAqIEluIGFkZGl0aW9uIHRvIEFXUyBjcmVkZW50aWFscyBleHBpcmluZyBhZnRlciBhIGdpdmVuIGFtb3VudCBvZiB0aW1lLCB0aGUKICAgKiBsb2dpbiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlciB3aWxsIGFsc28gZXhwaXJlLiBPbmNlIHRoaXMgdG9rZW4KICAgKiBleHBpcmVzLCBpdCB3aWxsIG5vdCBiZSB1c2FibGUgdG8gcmVmcmVzaCBBV1MgY3JlZGVudGlhbHMsIGFuZCBhbm90aGVyCiAgICogdG9rZW4gd2lsbCBiZSBuZWVkZWQuIFRoZSBTREsgZG9lcyBub3QgbWFuYWdlIHJlZnJlc2hpbmcgb2YgdGhlIHRva2VuIHZhbHVlLAogICAqIGJ1dCB0aGlzIGNhbiBiZSBkb25lIHRocm91Z2ggYSAicmVmcmVzaCB0b2tlbiIgc3VwcG9ydGVkIGJ5IG1vc3QgaWRlbnRpdHkKICAgKiBwcm92aWRlcnMuIENvbnN1bHQgdGhlIGRvY3VtZW50YXRpb24gZm9yIHRoZSBpZGVudGl0eSBwcm92aWRlciBmb3IgcmVmcmVzaGluZwogICAqIHRva2Vucy4gT25jZSB0aGUgcmVmcmVzaGVkIHRva2VuIGlzIGFjcXVpcmVkLCB5b3Ugc2hvdWxkIG1ha2Ugc3VyZSB0byB1cGRhdGUKICAgKiB0aGlzIG5ldyB0b2tlbiBpbiB0aGUgY3JlZGVudGlhbHMgb2JqZWN0J3Mge3BhcmFtc30gcHJvcGVydHkuIFRoZSBmb2xsb3dpbmcKICAgKiBjb2RlIHdpbGwgdXBkYXRlIHRoZSBXZWJJZGVudGl0eVRva2VuLCBhc3N1bWluZyB5b3UgaGF2ZSByZXRyaWV2ZWQgYW4gdXBkYXRlZAogICAqIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMucGFyYW1zLkxvZ2luc1snZ3JhcGguZmFjZWJvb2suY29tJ10gPSB1cGRhdGVkVG9rZW47CiAgICogYGBgCiAgICoKICAgKiBGdXR1cmUgY2FsbHMgdG8gYGNyZWRlbnRpYWxzLnJlZnJlc2goKWAgd2lsbCBub3cgdXNlIHRoZSBuZXcgdG9rZW4uCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBwYXJhbXMKICAgKiAgIEByZXR1cm4gW21hcF0gdGhlIG1hcCBvZiBwYXJhbXMgcGFzc2VkIHRvCiAgICogICAgIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldElkfSwKICAgKiAgICAge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0T3BlbklkVG9rZW59LCBhbmQKICAgKiAgICAge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uIFRvIHVwZGF0ZSB0aGUgdG9rZW4sIHNldCB0aGUKICAgKiAgICAgYHBhcmFtcy5XZWJJZGVudGl0eVRva2VuYCBwcm9wZXJ0eS4KICAgKiBAIWF0dHJpYnV0ZSBkYXRhCiAgICogICBAcmV0dXJuIFttYXBdIHRoZSByYXcgZGF0YSByZXNwb25zZSBmcm9tIHRoZSBjYWxsIHRvCiAgICogICAgIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHl9LCBvcgogICAqICAgICB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4gVXNlIHRoaXMgaWYgeW91IHdhbnQgdG8gZ2V0CiAgICogICAgIGFjY2VzcyB0byBvdGhlciBwcm9wZXJ0aWVzIGZyb20gdGhlIHJlc3BvbnNlLgogICAqIEAhYXR0cmlidXRlIGlkZW50aXR5SWQKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIENvZ25pdG8gSUQgcmV0dXJuZWQgYnkgdGhlIGxhc3QgY2FsbCB0bwogICAqICAgICB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRPcGVuSWRUb2tlbn0uIFRoaXMgSUQgcmVwcmVzZW50cyB0aGUgYWN0dWFsCiAgICogICAgIGZpbmFsIHJlc29sdmVkIGlkZW50aXR5IElEIGZyb20gQW1hem9uIENvZ25pdG8uCiAgICovCiAgQVdTLkNvZ25pdG9JZGVudGl0eUNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxvY2FsU3RvcmFnZUtleTogewogICAgICBpZDogJ2F3cy5jb2duaXRvLmlkZW50aXR5LWlkLicsCiAgICAgIHByb3ZpZGVyczogJ2F3cy5jb2duaXRvLmlkZW50aXR5LXByb3ZpZGVycy4nCiAgICB9LAogIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdC4KICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdAogICAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5Db2duaXRvSWRlbnRpdHlDcmVkZW50aWFscyh7CiAgICAgKgogICAgICogICAgIC8vIGVpdGhlciBJZGVudGl0eVBvb2xJZCBvciBJZGVudGl0eUlkIGlzIHJlcXVpcmVkCiAgICAgKiAgICAgLy8gU2VlIHRoZSBJZGVudGl0eVBvb2xJZCBwYXJhbSBmb3IgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRJRCAobGlua2VkIGJlbG93KQogICAgICogICAgIC8vIFNlZSB0aGUgSWRlbnRpdHlJZCBwYXJhbSBmb3IgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5CiAgICAgKiAgICAgLy8gb3IgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRPcGVuSWRUb2tlbiAobGlua2VkIGJlbG93KQogICAgICogICAgIElkZW50aXR5UG9vbElkOiAndXMtZWFzdC0xOjE2OTllYmMwLTc5MDAtNDA5OS1iOTEwLTJkZjk0ZjUyYTAzMCcsCiAgICAgKiAgICAgSWRlbnRpdHlJZDogJ3VzLWVhc3QtMToxMjhkMGE3NC1jODJmLTQ1NTMtOTE2ZC05MDA1M2U0YThiMGYnCiAgICAgKgogICAgICogICAgIC8vIG9wdGlvbmFsLCBvbmx5IG5lY2Vzc2FyeSB3aGVuIHRoZSBpZGVudGl0eSBwb29sIGlzIG5vdCBjb25maWd1cmVkCiAgICAgKiAgICAgLy8gdG8gdXNlIElBTSByb2xlcyBpbiB0aGUgQW1hem9uIENvZ25pdG8gQ29uc29sZQogICAgICogICAgIC8vIFNlZSB0aGUgUm9sZUFybiBwYXJhbSBmb3IgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5IChsaW5rZWQgYmVsb3cpCiAgICAgKiAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvTVlBUFAtQ29nbml0b0lkZW50aXR5JywKICAgICAqCiAgICAgKiAgICAgLy8gb3B0aW9uYWwgdG9rZW5zLCB1c2VkIGZvciBhdXRoZW50aWNhdGVkIGxvZ2luCiAgICAgKiAgICAgLy8gU2VlIHRoZSBMb2dpbnMgcGFyYW0gZm9yIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0SUQgKGxpbmtlZCBiZWxvdykKICAgICAqICAgICBMb2dpbnM6IHsKICAgICAqICAgICAgICdncmFwaC5mYWNlYm9vay5jb20nOiAnRkJUT0tFTicsCiAgICAgKiAgICAgICAnd3d3LmFtYXpvbi5jb20nOiAnQU1BWk9OVE9LRU4nLAogICAgICogICAgICAgJ2FjY291bnRzLmdvb2dsZS5jb20nOiAnR09PR0xFVE9LRU4nLAogICAgICogICAgICAgJ2FwaS50d2l0dGVyLmNvbSc6ICdUV0lUVEVSVE9LRU4nLAogICAgICogICAgICAgJ3d3dy5kaWdpdHMuY29tJzogJ0RJR0lUU1RPS0VOJwogICAgICogICAgIH0sCiAgICAgKgogICAgICogICAgIC8vIG9wdGlvbmFsIG5hbWUsIGRlZmF1bHRzIHRvIHdlYi1pZGVudGl0eQogICAgICogICAgIC8vIFNlZSB0aGUgUm9sZVNlc3Npb25OYW1lIHBhcmFtIGZvciBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkgKGxpbmtlZCBiZWxvdykKICAgICAqICAgICBSb2xlU2Vzc2lvbk5hbWU6ICd3ZWInLAogICAgICoKICAgICAqICAgICAvLyBvcHRpb25hbCwgb25seSBuZWNlc3Nhcnkgd2hlbiBhcHBsaWNhdGlvbiBydW5zIGluIGEgYnJvd3NlcgogICAgICogICAgIC8vIGFuZCBtdWx0aXBsZSB1c2VycyBhcmUgc2lnbmVkIGluIGF0IG9uY2UsIHVzZWQgZm9yIGNhY2hpbmcKICAgICAqICAgICBMb2dpbklkOiAnZXhhbXBsZUBnbWFpbC5jb20nCiAgICAgKgogICAgICogICB9LCB7CiAgICAgKiAgICAgIC8vIG9wdGlvbmFsbHkgcHJvdmlkZSBjb25maWd1cmF0aW9uIHRvIGFwcGx5IHRvIHRoZSB1bmRlcmx5aW5nIHNlcnZpY2UgY2xpZW50cwogICAgICogICAgICAvLyBpZiBjb25maWd1cmF0aW9uIGlzIG5vdCBwcm92aWRlZCwgdGhlbiBjb25maWd1cmF0aW9uIHdpbGwgYmUgcHVsbGVkIGZyb20gQVdTLmNvbmZpZwogICAgICoKICAgICAqICAgICAgLy8gcmVnaW9uIHNob3VsZCBtYXRjaCB0aGUgcmVnaW9uIHlvdXIgaWRlbnRpdHkgcG9vbCBpcyBsb2NhdGVkIGluCiAgICAgKiAgICAgIHJlZ2lvbjogJ3VzLWVhc3QtMScsCiAgICAgKgogICAgICogICAgICAvLyBzcGVjaWZ5IHRpbWVvdXQgb3B0aW9ucwogICAgICogICAgICBodHRwT3B0aW9uczogewogICAgICogICAgICAgIHRpbWVvdXQ6IDEwMAogICAgICogICAgICB9CiAgICAgKiAgIH0pOwogICAgICogQHNlZSBBV1MuQ29nbml0b0lkZW50aXR5LmdldElkCiAgICAgKiBAc2VlIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eQogICAgICogQHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkKICAgICAqIEBzZWUgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRPcGVuSWRUb2tlbgogICAgICogQHNlZSBBV1MuQ29uZmlnCiAgICAgKiBAbm90ZSBJZiBhIHJlZ2lvbiBpcyBub3QgcHJvdmlkZWQgaW4gdGhlIGdsb2JhbCBBV1MuY29uZmlnLCBvcgogICAgICogICBzcGVjaWZpZWQgaW4gdGhlIGBjbGllbnRDb25maWdgIHRvIHRoZSBDb2duaXRvSWRlbnRpdHlDcmVkZW50aWFscwogICAgICogICBjb25zdHJ1Y3RvciwgeW91IG1heSBlbmNvdW50ZXIgYSAnTWlzc2luZyBjcmVkZW50aWFscyBpbiBjb25maWcnIGVycm9yCiAgICAgKiAgIHdoZW4gY2FsbGluZyBtYWtpbmcgYSBzZXJ2aWNlIGNhbGwuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDb2duaXRvSWRlbnRpdHlDcmVkZW50aWFscyhwYXJhbXMsIGNsaWVudENvbmZpZykgewogICAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKICAgICAgdGhpcy5wYXJhbXMgPSBwYXJhbXM7CiAgICAgIHRoaXMuZGF0YSA9IG51bGw7CiAgICAgIHRoaXMuX2lkZW50aXR5SWQgPSBudWxsOwogICAgICB0aGlzLl9jbGllbnRDb25maWcgPSBBV1MudXRpbC5jb3B5KGNsaWVudENvbmZpZyB8fCB7fSk7CiAgICAgIHRoaXMubG9hZENhY2hlZElkKCk7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdpZGVudGl0eUlkJywgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICBzZWxmLmxvYWRDYWNoZWRJZCgpOwogICAgICAgICAgcmV0dXJuIHNlbGYuX2lkZW50aXR5SWQgfHwgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZDsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24oaWRlbnRpdHlJZCkgewogICAgICAgICAgc2VsZi5faWRlbnRpdHlJZCA9IGlkZW50aXR5SWQ7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFJlZnJlc2hlcyBjcmVkZW50aWFscyB1c2luZyB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5fSwKICAgICAqIG9yIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIENhbGxlZCB3aGVuIHRoZSBTVFMgc2VydmljZSByZXNwb25kcyAob3IgZmFpbHMpLiBXaGVuCiAgICAgKiAgIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHRoYXQgdGhlIGNyZWRlbnRpYWxzCiAgICAgKiAgIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLAogICAgICogICBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqIEBzZWUgQVdTLkNyZWRlbnRpYWxzLmdldAogICAgICovCiAgICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrIHx8IEFXUy51dGlsLmZuLmNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICogQHBhcmFtIGNhbGxiYWNrCiAgICAgKi8KICAgIGxvYWQ6IGZ1bmN0aW9uIGxvYWQoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzZWxmLmNyZWF0ZUNsaWVudHMoKTsKICAgICAgc2VsZi5kYXRhID0gbnVsbDsKICAgICAgc2VsZi5faWRlbnRpdHlJZCA9IG51bGw7CiAgICAgIHNlbGYuZ2V0SWQoZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgIGlmICghc2VsZi5wYXJhbXMuUm9sZUFybikgewogICAgICAgICAgICBzZWxmLmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkoY2FsbGJhY2spOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZi5nZXRDcmVkZW50aWFsc0Zyb21TVFMoY2FsbGJhY2spOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxmLmNsZWFySWRPbk5vdEF1dGhvcml6ZWQoZXJyKTsKICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIENsZWFycyB0aGUgY2FjaGVkIENvZ25pdG8gSUQgYXNzb2NpYXRlZCB3aXRoIHRoZSBjdXJyZW50bHkgY29uZmlndXJlZAogICAgICogaWRlbnRpdHkgcG9vbCBJRC4gVXNlIHRoaXMgdG8gbWFudWFsbHkgaW52YWxpZGF0ZSB5b3VyIGNhY2hlIGlmCiAgICAgKiB0aGUgaWRlbnRpdHkgcG9vbCBJRCB3YXMgZGVsZXRlZC4KICAgICAqLwogICAgY2xlYXJDYWNoZWRJZDogZnVuY3Rpb24gY2xlYXJDYWNoZSgpIHsKICAgICAgdGhpcy5faWRlbnRpdHlJZCA9IG51bGw7CiAgICAgIGRlbGV0ZSB0aGlzLnBhcmFtcy5JZGVudGl0eUlkOwogIAogICAgICB2YXIgcG9vbElkID0gdGhpcy5wYXJhbXMuSWRlbnRpdHlQb29sSWQ7CiAgICAgIHZhciBsb2dpbklkID0gdGhpcy5wYXJhbXMuTG9naW5JZCB8fCAnJzsKICAgICAgZGVsZXRlIHRoaXMuc3RvcmFnZVt0aGlzLmxvY2FsU3RvcmFnZUtleS5pZCArIHBvb2xJZCArIGxvZ2luSWRdOwogICAgICBkZWxldGUgdGhpcy5zdG9yYWdlW3RoaXMubG9jYWxTdG9yYWdlS2V5LnByb3ZpZGVycyArIHBvb2xJZCArIGxvZ2luSWRdOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNsZWFySWRPbk5vdEF1dGhvcml6ZWQ6IGZ1bmN0aW9uIGNsZWFySWRPbk5vdEF1dGhvcml6ZWQoZXJyKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgaWYgKGVyci5jb2RlID09ICdOb3RBdXRob3JpemVkRXhjZXB0aW9uJykgewogICAgICAgIHNlbGYuY2xlYXJDYWNoZWRJZCgpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBSZXRyaWV2ZXMgYSBDb2duaXRvIElELCBsb2FkaW5nIGZyb20gY2FjaGUgaWYgaXQgd2FzIGFscmVhZHkgcmV0cmlldmVkCiAgICAgKiBvbiB0aGlzIGRldmljZS4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBpZGVudGl0eUlkKQogICAgICogICBAcGFyYW0gZXJyIFtFcnJvciwgbnVsbF0gYW4gZXJyb3Igb2JqZWN0IGlmIHRoZSBjYWxsIGZhaWxlZCBvciBudWxsIGlmCiAgICAgKiAgICAgaXQgc3VjY2VlZGVkLgogICAgICogICBAcGFyYW0gaWRlbnRpdHlJZCBbU3RyaW5nLCBudWxsXSBpZiBzdWNjZXNzZnVsLCB0aGUgY2FsbGJhY2sgd2lsbCByZXR1cm4KICAgICAqICAgICB0aGUgQ29nbml0byBJRC4KICAgICAqIEBub3RlIElmIG5vdCBsb2FkZWQgZXhwbGljaXRseSwgdGhlIENvZ25pdG8gSUQgaXMgbG9hZGVkIGFuZCBzdG9yZWQgaW4KICAgICAqICAgbG9jYWxTdG9yYWdlIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50IG9mIGEgZGV2aWNlLgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldElkOiBmdW5jdGlvbiBnZXRJZChjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmICh0eXBlb2Ygc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCA9PT0gJ3N0cmluZycpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCk7CiAgICAgIH0KICAKICAgICAgc2VsZi5jb2duaXRvLmdldElkKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgIGlmICghZXJyICYmIGRhdGEuSWRlbnRpdHlJZCkgewogICAgICAgICAgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCA9IGRhdGEuSWRlbnRpdHlJZDsKICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGRhdGEuSWRlbnRpdHlJZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkQ3JlZGVudGlhbHM6IGZ1bmN0aW9uIGxvYWRDcmVkZW50aWFscyhkYXRhLCBjcmVkZW50aWFscykgewogICAgICBpZiAoIWRhdGEgfHwgIWNyZWRlbnRpYWxzKSByZXR1cm47CiAgICAgIGNyZWRlbnRpYWxzLmV4cGlyZWQgPSBmYWxzZTsKICAgICAgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgPSBkYXRhLkNyZWRlbnRpYWxzLkFjY2Vzc0tleUlkOwogICAgICBjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXkgPSBkYXRhLkNyZWRlbnRpYWxzLlNlY3JldEtleTsKICAgICAgY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuID0gZGF0YS5DcmVkZW50aWFscy5TZXNzaW9uVG9rZW47CiAgICAgIGNyZWRlbnRpYWxzLmV4cGlyZVRpbWUgPSBkYXRhLkNyZWRlbnRpYWxzLkV4cGlyYXRpb247CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eTogZnVuY3Rpb24gZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eShjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHNlbGYuY29nbml0by5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5KGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICBzZWxmLmNhY2hlSWQoZGF0YSk7CiAgICAgICAgICBzZWxmLmRhdGEgPSBkYXRhOwogICAgICAgICAgc2VsZi5sb2FkQ3JlZGVudGlhbHMoc2VsZi5kYXRhLCBzZWxmKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5jbGVhcklkT25Ob3RBdXRob3JpemVkKGVycik7CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldENyZWRlbnRpYWxzRnJvbVNUUzogZnVuY3Rpb24gZ2V0Q3JlZGVudGlhbHNGcm9tU1RTKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgc2VsZi5jb2duaXRvLmdldE9wZW5JZFRva2VuKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICBzZWxmLmNhY2hlSWQoZGF0YSk7CiAgICAgICAgICBzZWxmLnBhcmFtcy5XZWJJZGVudGl0eVRva2VuID0gZGF0YS5Ub2tlbjsKICAgICAgICAgIHNlbGYud2ViSWRlbnRpdHlDcmVkZW50aWFscy5yZWZyZXNoKGZ1bmN0aW9uKHdlYkVycikgewogICAgICAgICAgICBpZiAoIXdlYkVycikgewogICAgICAgICAgICAgIHNlbGYuZGF0YSA9IHNlbGYud2ViSWRlbnRpdHlDcmVkZW50aWFscy5kYXRhOwogICAgICAgICAgICAgIHNlbGYuc3RzLmNyZWRlbnRpYWxzRnJvbShzZWxmLmRhdGEsIHNlbGYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbGxiYWNrKHdlYkVycik7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5jbGVhcklkT25Ob3RBdXRob3JpemVkKGVycik7CiAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZENhY2hlZElkOiBmdW5jdGlvbiBsb2FkQ2FjaGVkSWQoKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAKICAgICAgLy8gaW4gdGhlIGJyb3dzZXIgd2Ugc291cmNlIGRlZmF1bHQgSWRlbnRpdHlJZCBmcm9tIGxvY2FsU3RvcmFnZQogICAgICBpZiAoQVdTLnV0aWwuaXNCcm93c2VyKCkgJiYgIXNlbGYucGFyYW1zLklkZW50aXR5SWQpIHsKICAgICAgICB2YXIgaWQgPSBzZWxmLmdldFN0b3JhZ2UoJ2lkJyk7CiAgICAgICAgaWYgKGlkICYmIHNlbGYucGFyYW1zLkxvZ2lucykgewogICAgICAgICAgdmFyIGFjdHVhbFByb3ZpZGVycyA9IE9iamVjdC5rZXlzKHNlbGYucGFyYW1zLkxvZ2lucyk7CiAgICAgICAgICB2YXIgY2FjaGVkUHJvdmlkZXJzID0KICAgICAgICAgICAgKHNlbGYuZ2V0U3RvcmFnZSgncHJvdmlkZXJzJykgfHwgJycpLnNwbGl0KCcsJyk7CiAgCiAgICAgICAgICAvLyBvbmx5IGxvYWQgSUQgaWYgYXQgbGVhc3Qgb25lIHByb3ZpZGVyIHVzZWQgdGhpcyBJRCBiZWZvcmUKICAgICAgICAgIHZhciBpbnRlcnNlY3QgPSBjYWNoZWRQcm92aWRlcnMuZmlsdGVyKGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgcmV0dXJuIGFjdHVhbFByb3ZpZGVycy5pbmRleE9mKG4pICE9PSAtMTsKICAgICAgICAgIH0pOwogICAgICAgICAgaWYgKGludGVyc2VjdC5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCA9IGlkOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoaWQpIHsKICAgICAgICAgIHNlbGYucGFyYW1zLklkZW50aXR5SWQgPSBpZDsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjcmVhdGVDbGllbnRzOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNsaWVudENvbmZpZyA9IHRoaXMuX2NsaWVudENvbmZpZzsKICAgICAgdGhpcy53ZWJJZGVudGl0eUNyZWRlbnRpYWxzID0gdGhpcy53ZWJJZGVudGl0eUNyZWRlbnRpYWxzIHx8CiAgICAgICAgbmV3IEFXUy5XZWJJZGVudGl0eUNyZWRlbnRpYWxzKHRoaXMucGFyYW1zLCBjbGllbnRDb25maWcpOwogICAgICBpZiAoIXRoaXMuY29nbml0bykgewogICAgICAgIHZhciBjb2duaXRvQ29uZmlnID0gQVdTLnV0aWwubWVyZ2Uoe30sIGNsaWVudENvbmZpZyk7CiAgICAgICAgY29nbml0b0NvbmZpZy5wYXJhbXMgPSB0aGlzLnBhcmFtczsKICAgICAgICB0aGlzLmNvZ25pdG8gPSBuZXcgQ29nbml0b0lkZW50aXR5KGNvZ25pdG9Db25maWcpOwogICAgICB9CiAgICAgIHRoaXMuc3RzID0gdGhpcy5zdHMgfHwgbmV3IFNUUyhjbGllbnRDb25maWcpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNhY2hlSWQ6IGZ1bmN0aW9uIGNhY2hlSWQoZGF0YSkgewogICAgICB0aGlzLl9pZGVudGl0eUlkID0gZGF0YS5JZGVudGl0eUlkOwogICAgICB0aGlzLnBhcmFtcy5JZGVudGl0eUlkID0gdGhpcy5faWRlbnRpdHlJZDsKICAKICAgICAgLy8gY2FjaGUgdGhpcyBJZGVudGl0eUlkIGluIGJyb3dzZXIgbG9jYWxTdG9yYWdlIGlmIHBvc3NpYmxlCiAgICAgIGlmIChBV1MudXRpbC5pc0Jyb3dzZXIoKSkgewogICAgICAgIHRoaXMuc2V0U3RvcmFnZSgnaWQnLCBkYXRhLklkZW50aXR5SWQpOwogIAogICAgICAgIGlmICh0aGlzLnBhcmFtcy5Mb2dpbnMpIHsKICAgICAgICAgIHRoaXMuc2V0U3RvcmFnZSgncHJvdmlkZXJzJywgT2JqZWN0LmtleXModGhpcy5wYXJhbXMuTG9naW5zKS5qb2luKCcsJykpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldFN0b3JhZ2U6IGZ1bmN0aW9uIGdldFN0b3JhZ2Uoa2V5KSB7CiAgICAgIHJldHVybiB0aGlzLnN0b3JhZ2VbdGhpcy5sb2NhbFN0b3JhZ2VLZXlba2V5XSArIHRoaXMucGFyYW1zLklkZW50aXR5UG9vbElkICsgKHRoaXMucGFyYW1zLkxvZ2luSWQgfHwgJycpXTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzZXRTdG9yYWdlOiBmdW5jdGlvbiBzZXRTdG9yYWdlKGtleSwgdmFsKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdGhpcy5zdG9yYWdlW3RoaXMubG9jYWxTdG9yYWdlS2V5W2tleV0gKyB0aGlzLnBhcmFtcy5JZGVudGl0eVBvb2xJZCArICh0aGlzLnBhcmFtcy5Mb2dpbklkIHx8ICcnKV0gPSB2YWw7CiAgICAgIH0gY2F0Y2ggKF8pIHt9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc3RvcmFnZTogKGZ1bmN0aW9uKCkgewogICAgICB0cnkgewogICAgICAgIHZhciBzdG9yYWdlID0gQVdTLnV0aWwuaXNCcm93c2VyKCkgJiYgd2luZG93LmxvY2FsU3RvcmFnZSAhPT0gbnVsbCAmJiB0eXBlb2Ygd2luZG93LmxvY2FsU3RvcmFnZSA9PT0gJ29iamVjdCcgPwogICAgICAgICAgICB3aW5kb3cubG9jYWxTdG9yYWdlIDoge307CiAgCiAgICAgICAgLy8gVGVzdCBzZXQvcmVtb3ZlIHdoaWNoIHdvdWxkIHRocm93IGFuIGVycm9yIGluIFNhZmFyaSdzIHByaXZhdGUgYnJvd3NpbmcKICAgICAgICBzdG9yYWdlWydhd3MudGVzdC1zdG9yYWdlJ10gPSAnZm9vYmFyJzsKICAgICAgICBkZWxldGUgc3RvcmFnZVsnYXdzLnRlc3Qtc3RvcmFnZSddOwogIAogICAgICAgIHJldHVybiBzdG9yYWdlOwogICAgICB9IGNhdGNoIChfKSB7CiAgICAgICAgcmV0dXJuIHt9OwogICAgICB9CiAgICB9KSgpCiAgfSk7CiAgCiAgfSx7Ii4uLy4uL2NsaWVudHMvY29nbml0b2lkZW50aXR5Ijo3LCIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTh9XSwyMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICAKICAvKioKICAgKiBDcmVhdGVzIGEgY3JlZGVudGlhbCBwcm92aWRlciBjaGFpbiB0aGF0IHNlYXJjaGVzIGZvciBBV1MgY3JlZGVudGlhbHMKICAgKiBpbiBhIGxpc3Qgb2YgY3JlZGVudGlhbCBwcm92aWRlcnMgc3BlY2lmaWVkIGJ5IHRoZSB7cHJvdmlkZXJzfSBwcm9wZXJ0eS4KICAgKgogICAqIEJ5IGRlZmF1bHQsIHRoZSBjaGFpbiB3aWxsIHVzZSB0aGUge2RlZmF1bHRQcm92aWRlcnN9IHRvIHJlc29sdmUgY3JlZGVudGlhbHMuCiAgICogVGhlc2UgcHJvdmlkZXJzIHdpbGwgbG9vayBpbiB0aGUgZW52aXJvbm1lbnQgdXNpbmcgdGhlCiAgICoge0FXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzfSBjbGFzcyB3aXRoIHRoZSAnQVdTJyBhbmQgJ0FNQVpPTicgcHJlZml4ZXMuCiAgICoKICAgKiAjIyBTZXR0aW5nIFByb3ZpZGVycwogICAqCiAgICogRWFjaCBwcm92aWRlciBpbiB0aGUge3Byb3ZpZGVyc30gbGlzdCBzaG91bGQgYmUgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMKICAgKiBhIHtBV1MuQ3JlZGVudGlhbHN9IG9iamVjdCwgb3IgYSBoYXJkY29kZWQgY3JlZGVudGlhbHMgb2JqZWN0LiBUaGUgZnVuY3Rpb24KICAgKiBmb3JtIGFsbG93cyBmb3IgZGVsYXllZCBleGVjdXRpb24gb2YgdGhlIGNyZWRlbnRpYWwgY29uc3RydWN0aW9uLgogICAqCiAgICogIyMgUmVzb2x2aW5nIENyZWRlbnRpYWxzIGZyb20gYSBDaGFpbgogICAqCiAgICogQ2FsbCB7cmVzb2x2ZX0gdG8gcmV0dXJuIHRoZSBmaXJzdCB2YWxpZCBjcmVkZW50aWFsIG9iamVjdCB0aGF0IGNhbiBiZQogICAqIGxvYWRlZCBieSB0aGUgcHJvdmlkZXIgY2hhaW4uCiAgICoKICAgKiBGb3IgZXhhbXBsZSwgdG8gcmVzb2x2ZSBhIGNoYWluIHdpdGggYSBjdXN0b20gcHJvdmlkZXIgdGhhdCBjaGVja3MgYSBmaWxlCiAgICogb24gZGlzayBhZnRlciB0aGUgc2V0IG9mIHtkZWZhdWx0UHJvdmlkZXJzfToKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiB2YXIgZGlza1Byb3ZpZGVyID0gbmV3IEFXUy5GaWxlU3lzdGVtQ3JlZGVudGlhbHMoJy4vY3JlZHMuanNvbicpOwogICAqIHZhciBjaGFpbiA9IG5ldyBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4oKTsKICAgKiBjaGFpbi5wcm92aWRlcnMucHVzaChkaXNrUHJvdmlkZXIpOwogICAqIGNoYWluLnJlc29sdmUoKTsKICAgKiBgYGAKICAgKgogICAqIFRoZSBhYm92ZSBjb2RlIHdpbGwgcmV0dXJuIHRoZSBgZGlza1Byb3ZpZGVyYCBvYmplY3QgaWYgdGhlCiAgICogZmlsZSBjb250YWlucyBjcmVkZW50aWFscyBhbmQgdGhlIGBkZWZhdWx0UHJvdmlkZXJzYCBkbyBub3QgY29udGFpbgogICAqIGFueSBjcmVkZW50aWFsIHNldHRpbmdzLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcHJvdmlkZXJzCiAgICogICBAcmV0dXJuIFtBcnJheTxBV1MuQ3JlZGVudGlhbHMsIEZ1bmN0aW9uPl0KICAgKiAgICAgYSBsaXN0IG9mIGNyZWRlbnRpYWxzIG9iamVjdHMgb3IgZnVuY3Rpb25zIHRoYXQgcmV0dXJuIGNyZWRlbnRpYWxzCiAgICogICAgIG9iamVjdHMuIElmIHRoZSBwcm92aWRlciBpcyBhIGZ1bmN0aW9uLCB0aGUgZnVuY3Rpb24gd2lsbCBiZQogICAqICAgICBleGVjdXRlZCBsYXppbHkgd2hlbiB0aGUgcHJvdmlkZXIgbmVlZHMgdG8gYmUgY2hlY2tlZCBmb3IgdmFsaWQKICAgKiAgICAgY3JlZGVudGlhbHMuIEJ5IGRlZmF1bHQsIHRoaXMgb2JqZWN0IHdpbGwgYmUgc2V0IHRvIHRoZQogICAqICAgICB7ZGVmYXVsdFByb3ZpZGVyc30uCiAgICogICBAc2VlIGRlZmF1bHRQcm92aWRlcnMKICAgKi8KICBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4gPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IENyZWRlbnRpYWxQcm92aWRlckNoYWluIHdpdGggYSBkZWZhdWx0IHNldCBvZiBwcm92aWRlcnMKICAgICAqIHNwZWNpZmllZCBieSB7ZGVmYXVsdFByb3ZpZGVyc30uCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDcmVkZW50aWFsUHJvdmlkZXJDaGFpbihwcm92aWRlcnMpIHsKICAgICAgaWYgKHByb3ZpZGVycykgewogICAgICAgIHRoaXMucHJvdmlkZXJzID0gcHJvdmlkZXJzOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucHJvdmlkZXJzID0gQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmRlZmF1bHRQcm92aWRlcnMuc2xpY2UoMCk7CiAgICAgIH0KICAgICAgdGhpcy5yZXNvbHZlQ2FsbGJhY2tzID0gW107CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAIW1ldGhvZCAgcmVzb2x2ZVByb21pc2UoKQogICAgICogICBSZXR1cm5zIGEgJ3RoZW5hYmxlJyBwcm9taXNlLgogICAgICogICBSZXNvbHZlcyB0aGUgcHJvdmlkZXIgY2hhaW4gYnkgc2VhcmNoaW5nIGZvciB0aGUgZmlyc3Qgc2V0IG9mCiAgICAgKiAgIGNyZWRlbnRpYWxzIGluIHtwcm92aWRlcnN9LgogICAgICoKICAgICAqICAgVHdvIGNhbGxiYWNrcyBjYW4gYmUgcHJvdmlkZWQgdG8gdGhlIGB0aGVuYCBtZXRob2Qgb24gdGhlIHJldHVybmVkIHByb21pc2UuCiAgICAgKiAgIFRoZSBmaXJzdCBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQsIGFuZCB0aGUgc2Vjb25kCiAgICAgKiAgIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICBAY2FsbGJhY2sgZnVsZmlsbGVkQ2FsbGJhY2sgZnVuY3Rpb24oY3JlZGVudGlhbHMpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZCBhbmQgdGhlIHByb3ZpZGVyIHJlc29sdmVzIHRoZSBjaGFpbgogICAgICogICAgIHRvIGEgY3JlZGVudGlhbHMgb2JqZWN0CiAgICAgKiAgICAgQHBhcmFtIGNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBjcmVkZW50aWFscyBvYmplY3QgcmVzb2x2ZWQKICAgICAqICAgICAgIGJ5IHRoZSBwcm92aWRlciBjaGFpbi4KICAgICAqICAgQGNhbGxiYWNrIHJlamVjdGVkQ2FsbGJhY2sgZnVuY3Rpb24oZXJyb3IpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGlmIG5vIGNyZWRlbnRpYWxzIGFyZSBmb3VuZC4KICAgICAqICAgQHJldHVybiBbUHJvbWlzZV0gQSBwcm9taXNlIHRoYXQgcmVwcmVzZW50cyB0aGUgc3RhdGUgb2YgdGhlIGByZXNvbHZlYCBtZXRob2QgY2FsbC4KICAgICAqICAgQGV4YW1wbGUgQ2FsbGluZyB0aGUgYHJlc29sdmVQcm9taXNlYCBtZXRob2QuCiAgICAgKiAgICAgdmFyIHByb21pc2UgPSBjaGFpbi5yZXNvbHZlUHJvbWlzZSgpOwogICAgICogICAgIHByb21pc2UudGhlbihmdW5jdGlvbihjcmVkZW50aWFscykgeyAuLi4gfSwgZnVuY3Rpb24oZXJyKSB7IC4uLiB9KTsKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBSZXNvbHZlcyB0aGUgcHJvdmlkZXIgY2hhaW4gYnkgc2VhcmNoaW5nIGZvciB0aGUgZmlyc3Qgc2V0IG9mCiAgICAgKiBjcmVkZW50aWFscyBpbiB7cHJvdmlkZXJzfS4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBjcmVkZW50aWFscykKICAgICAqICAgQ2FsbGVkIHdoZW4gdGhlIHByb3ZpZGVyIHJlc29sdmVzIHRoZSBjaGFpbiB0byBhIGNyZWRlbnRpYWxzIG9iamVjdAogICAgICogICBvciBudWxsIGlmIG5vIGNyZWRlbnRpYWxzIGNhbiBiZSBmb3VuZC4KICAgICAqCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGlmIG5vIGNyZWRlbnRpYWxzIGFyZQogICAgICogICAgIGZvdW5kLgogICAgICogICBAcGFyYW0gY3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCByZXNvbHZlZAogICAgICogICAgIGJ5IHRoZSBwcm92aWRlciBjaGFpbi4KICAgICAqIEByZXR1cm4gW0FXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbl0gdGhlIHByb3ZpZGVyLCBmb3IgY2hhaW5pbmcuCiAgICAgKi8KICAgIHJlc29sdmU6IGZ1bmN0aW9uIHJlc29sdmUoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZiAoc2VsZi5wcm92aWRlcnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgY2FsbGJhY2sobmV3IEVycm9yKCdObyBwcm92aWRlcnMnKSk7CiAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgIH0KICAKICAgICAgaWYgKHNlbGYucmVzb2x2ZUNhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKSA9PT0gMSkgewogICAgICAgIHZhciBpbmRleCA9IDA7CiAgICAgICAgdmFyIHByb3ZpZGVycyA9IHNlbGYucHJvdmlkZXJzLnNsaWNlKDApOwogIAogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVOZXh0KGVyciwgY3JlZHMpIHsKICAgICAgICAgIGlmICgoIWVyciAmJiBjcmVkcykgfHwgaW5kZXggPT09IHByb3ZpZGVycy5sZW5ndGgpIHsKICAgICAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHNlbGYucmVzb2x2ZUNhbGxiYWNrcywgZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2soZXJyLCBjcmVkcyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzZWxmLnJlc29sdmVDYWxsYmFja3MubGVuZ3RoID0gMDsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogIAogICAgICAgICAgdmFyIHByb3ZpZGVyID0gcHJvdmlkZXJzW2luZGV4KytdOwogICAgICAgICAgaWYgKHR5cGVvZiBwcm92aWRlciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBjcmVkcyA9IHByb3ZpZGVyLmNhbGwoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNyZWRzID0gcHJvdmlkZXI7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBpZiAoY3JlZHMuZ2V0KSB7CiAgICAgICAgICAgIGNyZWRzLmdldChmdW5jdGlvbiAoZ2V0RXJyKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZU5leHQoZ2V0RXJyLCBnZXRFcnIgPyBudWxsIDogY3JlZHMpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc29sdmVOZXh0KG51bGwsIGNyZWRzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgCiAgICAgICAgcmVzb2x2ZU5leHQoKTsKICAgICAgfQogIAogICAgICByZXR1cm4gc2VsZjsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBUaGUgZGVmYXVsdCBzZXQgb2YgcHJvdmlkZXJzIHVzZWQgYnkgYSB2YW5pbGxhIENyZWRlbnRpYWxQcm92aWRlckNoYWluLgogICAqCiAgICogSW4gdGhlIGJyb3dzZXI6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmRlZmF1bHRQcm92aWRlcnMgPSBbXQogICAqIGBgYAogICAqCiAgICogSW4gTm9kZS5qczoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uZGVmYXVsdFByb3ZpZGVycyA9IFsKICAgKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFscygnQVdTJyk7IH0sCiAgICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FNQVpPTicpOyB9LAogICAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5TaGFyZWRJbmlGaWxlQ3JlZGVudGlhbHMoKTsgfSwKICAgKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuRUNTQ3JlZGVudGlhbHMoKTsgfSwKICAgKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuUHJvY2Vzc0NyZWRlbnRpYWxzKCk7IH0sCiAgICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLlRva2VuRmlsZVdlYklkZW50aXR5Q3JlZGVudGlhbHMoKTsgfSwKICAgKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuRUMyTWV0YWRhdGFDcmVkZW50aWFscygpIH0KICAgKiBdCiAgICogYGBgCiAgICovCiAgQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmRlZmF1bHRQcm92aWRlcnMgPSBbXTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uYWRkUHJvbWlzZXNUb0NsYXNzID0gZnVuY3Rpb24gYWRkUHJvbWlzZXNUb0NsYXNzKFByb21pc2VEZXBlbmRlbmN5KSB7CiAgICB0aGlzLnByb3RvdHlwZS5yZXNvbHZlUHJvbWlzZSA9IEFXUy51dGlsLnByb21pc2lmeU1ldGhvZCgncmVzb2x2ZScsIFByb21pc2VEZXBlbmRlbmN5KTsKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5kZWxldGVQcm9taXNlc0Zyb21DbGFzcyA9IGZ1bmN0aW9uIGRlbGV0ZVByb21pc2VzRnJvbUNsYXNzKCkgewogICAgZGVsZXRlIHRoaXMucHJvdG90eXBlLnJlc29sdmVQcm9taXNlOwogIH07CiAgCiAgQVdTLnV0aWwuYWRkUHJvbWlzZXMoQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluKTsKICAKICB9LHsiLi4vY29yZSI6MTh9XSwyMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIGNyZWRlbnRpYWxzIHJldHJpZXZlZCBmcm9tIFNUUyBTQU1MIHN1cHBvcnQuCiAgICoKICAgKiBCeSBkZWZhdWx0IHRoaXMgcHJvdmlkZXIgZ2V0cyBjcmVkZW50aWFscyB1c2luZyB0aGUKICAgKiB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFNBTUx9IHNlcnZpY2Ugb3BlcmF0aW9uLiBUaGlzIG9wZXJhdGlvbgogICAqIHJlcXVpcmVzIGEgYFJvbGVBcm5gIGNvbnRhaW5pbmcgdGhlIEFSTiBvZiB0aGUgSUFNIHRydXN0IHBvbGljeSBmb3IgdGhlCiAgICogYXBwbGljYXRpb24gZm9yIHdoaWNoIGNyZWRlbnRpYWxzIHdpbGwgYmUgZ2l2ZW4sIGFzIHdlbGwgYXMgYSBgUHJpbmNpcGFsQXJuYAogICAqIHJlcHJlc2VudGluZyB0aGUgQVJOIGZvciB0aGUgU0FNTCBpZGVudGl0eSBwcm92aWRlci4gSW4gYWRkaXRpb24sIHRoZQogICAqIGBTQU1MQXNzZXJ0aW9uYCBtdXN0IGJlIHNldCB0byB0aGUgdG9rZW4gcHJvdmlkZWQgYnkgdGhlIGlkZW50aXR5CiAgICogcHJvdmlkZXIuIFNlZSB7Y29uc3RydWN0b3J9IGZvciBhbiBleGFtcGxlIG9uIGNyZWF0aW5nIGEgY3JlZGVudGlhbHMKICAgKiBvYmplY3Qgd2l0aCBwcm9wZXIgYFJvbGVBcm5gLCBgUHJpbmNpcGFsQXJuYCwgYW5kIGBTQU1MQXNzZXJ0aW9uYCB2YWx1ZXMuCiAgICoKICAgKiAjIyBSZWZyZXNoaW5nIENyZWRlbnRpYWxzIGZyb20gSWRlbnRpdHkgU2VydmljZQogICAqCiAgICogSW4gYWRkaXRpb24gdG8gQVdTIGNyZWRlbnRpYWxzIGV4cGlyaW5nIGFmdGVyIGEgZ2l2ZW4gYW1vdW50IG9mIHRpbWUsIHRoZQogICAqIGxvZ2luIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyIHdpbGwgYWxzbyBleHBpcmUuIE9uY2UgdGhpcyB0b2tlbgogICAqIGV4cGlyZXMsIGl0IHdpbGwgbm90IGJlIHVzYWJsZSB0byByZWZyZXNoIEFXUyBjcmVkZW50aWFscywgYW5kIGFub3RoZXIKICAgKiB0b2tlbiB3aWxsIGJlIG5lZWRlZC4gVGhlIFNESyBkb2VzIG5vdCBtYW5hZ2UgcmVmcmVzaGluZyBvZiB0aGUgdG9rZW4gdmFsdWUsCiAgICogYnV0IHRoaXMgY2FuIGJlIGRvbmUgdGhyb3VnaCBhICJyZWZyZXNoIHRva2VuIiBzdXBwb3J0ZWQgYnkgbW9zdCBpZGVudGl0eQogICAqIHByb3ZpZGVycy4gQ29uc3VsdCB0aGUgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIGlkZW50aXR5IHByb3ZpZGVyIGZvciByZWZyZXNoaW5nCiAgICogdG9rZW5zLiBPbmNlIHRoZSByZWZyZXNoZWQgdG9rZW4gaXMgYWNxdWlyZWQsIHlvdSBzaG91bGQgbWFrZSBzdXJlIHRvIHVwZGF0ZQogICAqIHRoaXMgbmV3IHRva2VuIGluIHRoZSBjcmVkZW50aWFscyBvYmplY3QncyB7cGFyYW1zfSBwcm9wZXJ0eS4gVGhlIGZvbGxvd2luZwogICAqIGNvZGUgd2lsbCB1cGRhdGUgdGhlIFNBTUxBc3NlcnRpb24sIGFzc3VtaW5nIHlvdSBoYXZlIHJldHJpZXZlZCBhbiB1cGRhdGVkCiAgICogdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXI6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscy5wYXJhbXMuU0FNTEFzc2VydGlvbiA9IHVwZGF0ZWRUb2tlbjsKICAgKiBgYGAKICAgKgogICAqIEZ1dHVyZSBjYWxscyB0byBgY3JlZGVudGlhbHMucmVmcmVzaCgpYCB3aWxsIG5vdyB1c2UgdGhlIG5ldyB0b2tlbi4KICAgKgogICAqIEAhYXR0cmlidXRlIHBhcmFtcwogICAqICAgQHJldHVybiBbbWFwXSB0aGUgbWFwIG9mIHBhcmFtcyBwYXNzZWQgdG8KICAgKiAgICAge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhTQU1MfS4gVG8gdXBkYXRlIHRoZSB0b2tlbiwgc2V0IHRoZQogICAqICAgICBgcGFyYW1zLlNBTUxBc3NlcnRpb25gIHByb3BlcnR5LgogICAqLwogIEFXUy5TQU1MQ3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdC4KICAgICAqIEBwYXJhbSAoc2VlIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhTQU1MKQogICAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0CiAgICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLlNBTUxDcmVkZW50aWFscyh7CiAgICAgKiAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvU0FNTFJvbGUnLAogICAgICogICAgIFByaW5jaXBhbEFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvU0FNTFByaW5jaXBhbCcsCiAgICAgKiAgICAgU0FNTEFzc2VydGlvbjogJ2Jhc2U2NC10b2tlbicsIC8vIGJhc2U2NC1lbmNvZGVkIHRva2VuIGZyb20gSWRQCiAgICAgKiAgIH0pOwogICAgICogQHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoU0FNTAogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gU0FNTENyZWRlbnRpYWxzKHBhcmFtcykgewogICAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKICAgICAgdGhpcy5wYXJhbXMgPSBwYXJhbXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBSZWZyZXNoZXMgY3JlZGVudGlhbHMgdXNpbmcge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhTQU1MfQogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIENhbGxlZCB3aGVuIHRoZSBTVFMgc2VydmljZSByZXNwb25kcyAob3IgZmFpbHMpLiBXaGVuCiAgICAgKiAgIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHRoYXQgdGhlIGNyZWRlbnRpYWxzCiAgICAgKiAgIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLAogICAgICogICBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqIEBzZWUgZ2V0CiAgICAgKi8KICAgIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2goY2FsbGJhY2spIHsKICAgICAgdGhpcy5jb2FsZXNjZVJlZnJlc2goY2FsbGJhY2sgfHwgQVdTLnV0aWwuZm4uY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxvYWQ6IGZ1bmN0aW9uIGxvYWQoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzZWxmLmNyZWF0ZUNsaWVudHMoKTsKICAgICAgc2VsZi5zZXJ2aWNlLmFzc3VtZVJvbGVXaXRoU0FNTChmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgIHNlbGYuc2VydmljZS5jcmVkZW50aWFsc0Zyb20oZGF0YSwgc2VsZik7CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNyZWF0ZUNsaWVudHM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnNlcnZpY2UgPSB0aGlzLnNlcnZpY2UgfHwgbmV3IFNUUyh7cGFyYW1zOiB0aGlzLnBhcmFtc30pOwogICAgfQogIAogIH0pOwogIAogIH0seyIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTh9XSwyNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIHRlbXBvcmFyeSBjcmVkZW50aWFscyByZXRyaWV2ZWQgZnJvbSB7QVdTLlNUU30uIFdpdGhvdXQgYW55CiAgICogZXh0cmEgcGFyYW1ldGVycywgY3JlZGVudGlhbHMgd2lsbCBiZSBmZXRjaGVkIGZyb20gdGhlCiAgICoge0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSBvcGVyYXRpb24uIElmIGFuIElBTSByb2xlIGlzIHByb3ZpZGVkLCB0aGUKICAgKiB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvcGVyYXRpb24gd2lsbCBiZSB1c2VkIHRvIGZldGNoIGNyZWRlbnRpYWxzIGZvciB0aGUKICAgKiByb2xlIGluc3RlYWQuCiAgICoKICAgKiBAbm90ZSBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgaXMgZGVwcmVjYXRlZCwgYnV0IHJlbWFpbnMgYXZhaWxhYmxlIGZvcgogICAqICAgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuIHtBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHN9IGlzIHRoZQogICAqICAgcHJlZmVycmVkIGNsYXNzIGZvciB0ZW1wb3JhcnkgY3JlZGVudGlhbHMuCiAgICoKICAgKiBUbyBzZXR1cCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMsIGNvbmZpZ3VyZSBhIHNldCBvZiBtYXN0ZXIgY3JlZGVudGlhbHMKICAgKiB1c2luZyB0aGUgc3RhbmRhcmQgY3JlZGVudGlhbHMgcHJvdmlkZXJzIChlbnZpcm9ubWVudCwgRUMyIGluc3RhbmNlIG1ldGFkYXRhLAogICAqIG9yIGZyb20gdGhlIGZpbGVzeXN0ZW0pLCB0aGVuIHNldCB0aGUgZ2xvYmFsIGNyZWRlbnRpYWxzIHRvIGEgbmV3CiAgICogdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIG9iamVjdDoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiAvLyBOb3RlIHRoYXQgZW52aXJvbm1lbnQgY3JlZGVudGlhbHMgYXJlIGxvYWRlZCBieSBkZWZhdWx0LAogICAqIC8vIHRoZSBmb2xsb3dpbmcgbGluZSBpcyBzaG93biBmb3IgY2xhcml0eToKICAgKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzKCdBV1MnKTsKICAgKgogICAqIC8vIE5vdyBzZXQgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIHNlZWRlZCBmcm9tIHRoZSBtYXN0ZXIgY3JlZGVudGlhbHMKICAgKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscygpOwogICAqCiAgICogLy8gc3Vic2VxdWVudCByZXF1ZXN0cyB3aWxsIG5vdyB1c2UgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZyb20gQVdTIFNUUy4KICAgKiBuZXcgQVdTLlMzKCkubGlzdEJ1Y2tldChmdW5jdGlvbihlcnIsIGRhdGEpIHsgLi4uIH0pOwogICAqIGBgYAogICAqCiAgICogQCFhdHRyaWJ1dGUgbWFzdGVyQ3JlZGVudGlhbHMKICAgKiAgIEByZXR1cm4gW0FXUy5DcmVkZW50aWFsc10gdGhlIG1hc3RlciAobm9uLXRlbXBvcmFyeSkgY3JlZGVudGlhbHMgdXNlZCB0bwogICAqICAgICBnZXQgYW5kIHJlZnJlc2ggdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZyb20gQVdTIFNUUy4KICAgKiBAbm90ZSAoc2VlIGNvbnN0cnVjdG9yKQogICAqLwogIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIG9iamVjdC4KICAgICAqCiAgICAgKiBAbm90ZSBJbiBvcmRlciB0byBjcmVhdGUgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLCB5b3UgZmlyc3QgbmVlZCB0byBoYXZlCiAgICAgKiAgICJtYXN0ZXIiIGNyZWRlbnRpYWxzIGNvbmZpZ3VyZWQgaW4ge0FXUy5Db25maWcuY3JlZGVudGlhbHN9LiBUaGVzZQogICAgICogICBtYXN0ZXIgY3JlZGVudGlhbHMgYXJlIG5lY2Vzc2FyeSB0byByZXRyaWV2ZSB0aGUgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLAogICAgICogICBhcyB3ZWxsIGFzIHJlZnJlc2ggdGhlIGNyZWRlbnRpYWxzIHdoZW4gdGhleSBleHBpcmUuCiAgICAgKiBAcGFyYW0gcGFyYW1zIFttYXBdIGEgbWFwIG9mIG9wdGlvbnMgdGhhdCBhcmUgcGFzc2VkIHRvIHRoZQogICAgICogICB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvciB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59IG9wZXJhdGlvbnMuCiAgICAgKiAgIElmIGEgYFJvbGVBcm5gIHBhcmFtZXRlciBpcyBwYXNzZWQgaW4sIGNyZWRlbnRpYWxzIHdpbGwgYmUgYmFzZWQgb24gdGhlCiAgICAgKiAgIElBTSByb2xlLgogICAgICogQHBhcmFtIG1hc3RlckNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBtYXN0ZXIgKG5vbi10ZW1wb3JhcnkpIGNyZWRlbnRpYWxzCiAgICAgKiAgdXNlZCB0byBnZXQgYW5kIHJlZnJlc2ggdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZyb20gQVdTIFNUUy4KICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdCBmb3IgZ2VuZXJpYyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMoKTsKICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdCBmb3IgYW4gSUFNIHJvbGUKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogICAgICogICAgIFJvbGVBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL1RlbXBvcmFyeUNyZWRlbnRpYWxzJywKICAgICAqICAgfSk7CiAgICAgKiBAc2VlIEFXUy5TVFMuYXNzdW1lUm9sZQogICAgICogQHNlZSBBV1MuU1RTLmdldFNlc3Npb25Ub2tlbgogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gVGVtcG9yYXJ5Q3JlZGVudGlhbHMocGFyYW1zLCBtYXN0ZXJDcmVkZW50aWFscykgewogICAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5sb2FkTWFzdGVyQ3JlZGVudGlhbHMobWFzdGVyQ3JlZGVudGlhbHMpOwogICAgICB0aGlzLmV4cGlyZWQgPSB0cnVlOwogIAogICAgICB0aGlzLnBhcmFtcyA9IHBhcmFtcyB8fCB7fTsKICAgICAgaWYgKHRoaXMucGFyYW1zLlJvbGVBcm4pIHsKICAgICAgICB0aGlzLnBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgPQogICAgICAgICAgdGhpcy5wYXJhbXMuUm9sZVNlc3Npb25OYW1lIHx8ICd0ZW1wb3JhcnktY3JlZGVudGlhbHMnOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBSZWZyZXNoZXMgY3JlZGVudGlhbHMgdXNpbmcge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3IKICAgICAqIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0sIGRlcGVuZGluZyBvbiB3aGV0aGVyIGFuIElBTSByb2xlIEFSTiB3YXMgcGFzc2VkCiAgICAgKiB0byB0aGUgY3JlZGVudGlhbHMge2NvbnN0cnVjdG9yfS4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICBDYWxsZWQgd2hlbiB0aGUgU1RTIHNlcnZpY2UgcmVzcG9uZHMgKG9yIGZhaWxzKS4gV2hlbgogICAgICogICB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyB0aGF0IHRoZSBjcmVkZW50aWFscwogICAgICogICBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwKICAgICAqICAgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKiBAc2VlIGdldAogICAgICovCiAgICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoIChjYWxsYmFjaykgewogICAgICB0aGlzLmNvYWxlc2NlUmVmcmVzaChjYWxsYmFjayB8fCBBV1MudXRpbC5mbi5jYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZDogZnVuY3Rpb24gbG9hZCAoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzZWxmLmNyZWF0ZUNsaWVudHMoKTsKICAgICAgc2VsZi5tYXN0ZXJDcmVkZW50aWFscy5nZXQoZnVuY3Rpb24gKCkgewogICAgICAgIHNlbGYuc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMgPSBzZWxmLm1hc3RlckNyZWRlbnRpYWxzOwogICAgICAgIHZhciBvcGVyYXRpb24gPSBzZWxmLnBhcmFtcy5Sb2xlQXJuID8KICAgICAgICAgIHNlbGYuc2VydmljZS5hc3N1bWVSb2xlIDogc2VsZi5zZXJ2aWNlLmdldFNlc3Npb25Ub2tlbjsKICAgICAgICBvcGVyYXRpb24uY2FsbChzZWxmLnNlcnZpY2UsIGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICAgIHNlbGYuc2VydmljZS5jcmVkZW50aWFsc0Zyb20oZGF0YSwgc2VsZik7CiAgICAgICAgICB9CiAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkTWFzdGVyQ3JlZGVudGlhbHM6IGZ1bmN0aW9uIGxvYWRNYXN0ZXJDcmVkZW50aWFscyAobWFzdGVyQ3JlZGVudGlhbHMpIHsKICAgICAgdGhpcy5tYXN0ZXJDcmVkZW50aWFscyA9IG1hc3RlckNyZWRlbnRpYWxzIHx8IEFXUy5jb25maWcuY3JlZGVudGlhbHM7CiAgICAgIHdoaWxlICh0aGlzLm1hc3RlckNyZWRlbnRpYWxzLm1hc3RlckNyZWRlbnRpYWxzKSB7CiAgICAgICAgdGhpcy5tYXN0ZXJDcmVkZW50aWFscyA9IHRoaXMubWFzdGVyQ3JlZGVudGlhbHMubWFzdGVyQ3JlZGVudGlhbHM7CiAgICAgIH0KICAKICAgICAgaWYgKHR5cGVvZiB0aGlzLm1hc3RlckNyZWRlbnRpYWxzLmdldCAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRoaXMubWFzdGVyQ3JlZGVudGlhbHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKHRoaXMubWFzdGVyQ3JlZGVudGlhbHMpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY3JlYXRlQ2xpZW50czogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLnNlcnZpY2UgPSB0aGlzLnNlcnZpY2UgfHwgbmV3IFNUUyh7cGFyYW1zOiB0aGlzLnBhcmFtc30pOwogICAgfQogIAogIH0pOwogIAogIH0seyIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTh9XSwyNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIGNyZWRlbnRpYWxzIHJldHJpZXZlZCBmcm9tIFNUUyBXZWIgSWRlbnRpdHkgRmVkZXJhdGlvbiBzdXBwb3J0LgogICAqCiAgICogQnkgZGVmYXVsdCB0aGlzIHByb3ZpZGVyIGdldHMgY3JlZGVudGlhbHMgdXNpbmcgdGhlCiAgICoge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0gc2VydmljZSBvcGVyYXRpb24uIFRoaXMgb3BlcmF0aW9uCiAgICogcmVxdWlyZXMgYSBgUm9sZUFybmAgY29udGFpbmluZyB0aGUgQVJOIG9mIHRoZSBJQU0gdHJ1c3QgcG9saWN5IGZvciB0aGUKICAgKiBhcHBsaWNhdGlvbiBmb3Igd2hpY2ggY3JlZGVudGlhbHMgd2lsbCBiZSBnaXZlbi4gSW4gYWRkaXRpb24sIHRoZQogICAqIGBXZWJJZGVudGl0eVRva2VuYCBtdXN0IGJlIHNldCB0byB0aGUgdG9rZW4gcHJvdmlkZWQgYnkgdGhlIGlkZW50aXR5CiAgICogcHJvdmlkZXIuIFNlZSB7Y29uc3RydWN0b3J9IGZvciBhbiBleGFtcGxlIG9uIGNyZWF0aW5nIGEgY3JlZGVudGlhbHMKICAgKiBvYmplY3Qgd2l0aCBwcm9wZXIgYFJvbGVBcm5gIGFuZCBgV2ViSWRlbnRpdHlUb2tlbmAgdmFsdWVzLgogICAqCiAgICogIyMgUmVmcmVzaGluZyBDcmVkZW50aWFscyBmcm9tIElkZW50aXR5IFNlcnZpY2UKICAgKgogICAqIEluIGFkZGl0aW9uIHRvIEFXUyBjcmVkZW50aWFscyBleHBpcmluZyBhZnRlciBhIGdpdmVuIGFtb3VudCBvZiB0aW1lLCB0aGUKICAgKiBsb2dpbiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlciB3aWxsIGFsc28gZXhwaXJlLiBPbmNlIHRoaXMgdG9rZW4KICAgKiBleHBpcmVzLCBpdCB3aWxsIG5vdCBiZSB1c2FibGUgdG8gcmVmcmVzaCBBV1MgY3JlZGVudGlhbHMsIGFuZCBhbm90aGVyCiAgICogdG9rZW4gd2lsbCBiZSBuZWVkZWQuIFRoZSBTREsgZG9lcyBub3QgbWFuYWdlIHJlZnJlc2hpbmcgb2YgdGhlIHRva2VuIHZhbHVlLAogICAqIGJ1dCB0aGlzIGNhbiBiZSBkb25lIHRocm91Z2ggYSAicmVmcmVzaCB0b2tlbiIgc3VwcG9ydGVkIGJ5IG1vc3QgaWRlbnRpdHkKICAgKiBwcm92aWRlcnMuIENvbnN1bHQgdGhlIGRvY3VtZW50YXRpb24gZm9yIHRoZSBpZGVudGl0eSBwcm92aWRlciBmb3IgcmVmcmVzaGluZwogICAqIHRva2Vucy4gT25jZSB0aGUgcmVmcmVzaGVkIHRva2VuIGlzIGFjcXVpcmVkLCB5b3Ugc2hvdWxkIG1ha2Ugc3VyZSB0byB1cGRhdGUKICAgKiB0aGlzIG5ldyB0b2tlbiBpbiB0aGUgY3JlZGVudGlhbHMgb2JqZWN0J3Mge3BhcmFtc30gcHJvcGVydHkuIFRoZSBmb2xsb3dpbmcKICAgKiBjb2RlIHdpbGwgdXBkYXRlIHRoZSBXZWJJZGVudGl0eVRva2VuLCBhc3N1bWluZyB5b3UgaGF2ZSByZXRyaWV2ZWQgYW4gdXBkYXRlZAogICAqIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMucGFyYW1zLldlYklkZW50aXR5VG9rZW4gPSB1cGRhdGVkVG9rZW47CiAgICogYGBgCiAgICoKICAgKiBGdXR1cmUgY2FsbHMgdG8gYGNyZWRlbnRpYWxzLnJlZnJlc2goKWAgd2lsbCBub3cgdXNlIHRoZSBuZXcgdG9rZW4uCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBwYXJhbXMKICAgKiAgIEByZXR1cm4gW21hcF0gdGhlIG1hcCBvZiBwYXJhbXMgcGFzc2VkIHRvCiAgICogICAgIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LiBUbyB1cGRhdGUgdGhlIHRva2VuLCBzZXQgdGhlCiAgICogICAgIGBwYXJhbXMuV2ViSWRlbnRpdHlUb2tlbmAgcHJvcGVydHkuCiAgICogQCFhdHRyaWJ1dGUgZGF0YQogICAqICAgQHJldHVybiBbbWFwXSB0aGUgcmF3IGRhdGEgcmVzcG9uc2UgZnJvbSB0aGUgY2FsbCB0bwogICAqICAgICB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4gVXNlIHRoaXMgaWYgeW91IHdhbnQgdG8gZ2V0CiAgICogICAgIGFjY2VzcyB0byBvdGhlciBwcm9wZXJ0aWVzIGZyb20gdGhlIHJlc3BvbnNlLgogICAqLwogIEFXUy5XZWJJZGVudGl0eUNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QuCiAgICAgKiBAcGFyYW0gKHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkpCiAgICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuV2ViSWRlbnRpdHlDcmVkZW50aWFscyh7CiAgICAgKiAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvV2ViSWRlbnRpdHknLAogICAgICogICAgIFdlYklkZW50aXR5VG9rZW46ICdBQkNERUZHSElKS0xNTk9QJywgLy8gdG9rZW4gZnJvbSBpZGVudGl0eSBzZXJ2aWNlCiAgICAgKiAgICAgUm9sZVNlc3Npb25OYW1lOiAnd2ViJyAvLyBvcHRpb25hbCBuYW1lLCBkZWZhdWx0cyB0byB3ZWItaWRlbnRpdHkKICAgICAqICAgfSwgewogICAgICogICAgIC8vIG9wdGlvbmFsbHkgcHJvdmlkZSBjb25maWd1cmF0aW9uIHRvIGFwcGx5IHRvIHRoZSB1bmRlcmx5aW5nIEFXUy5TVFMgc2VydmljZSBjbGllbnQKICAgICAqICAgICAvLyBpZiBjb25maWd1cmF0aW9uIGlzIG5vdCBwcm92aWRlZCwgdGhlbiBjb25maWd1cmF0aW9uIHdpbGwgYmUgcHVsbGVkIGZyb20gQVdTLmNvbmZpZwogICAgICoKICAgICAqICAgICAvLyBzcGVjaWZ5IHRpbWVvdXQgb3B0aW9ucwogICAgICogICAgIGh0dHBPcHRpb25zOiB7CiAgICAgKiAgICAgICB0aW1lb3V0OiAxMDAKICAgICAqICAgICB9CiAgICAgKiAgIH0pOwogICAgICogQHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkKICAgICAqIEBzZWUgQVdTLkNvbmZpZwogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gV2ViSWRlbnRpdHlDcmVkZW50aWFscyhwYXJhbXMsIGNsaWVudENvbmZpZykgewogICAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKICAgICAgdGhpcy5wYXJhbXMgPSBwYXJhbXM7CiAgICAgIHRoaXMucGFyYW1zLlJvbGVTZXNzaW9uTmFtZSA9IHRoaXMucGFyYW1zLlJvbGVTZXNzaW9uTmFtZSB8fCAnd2ViLWlkZW50aXR5JzsKICAgICAgdGhpcy5kYXRhID0gbnVsbDsKICAgICAgdGhpcy5fY2xpZW50Q29uZmlnID0gQVdTLnV0aWwuY29weShjbGllbnRDb25maWcgfHwge30pOwogICAgfSwKICAKICAgIC8qKgogICAgICogUmVmcmVzaGVzIGNyZWRlbnRpYWxzIHVzaW5nIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9CiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgQ2FsbGVkIHdoZW4gdGhlIFNUUyBzZXJ2aWNlIHJlc3BvbmRzIChvciBmYWlscykuIFdoZW4KICAgICAqICAgdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgdGhhdCB0aGUgY3JlZGVudGlhbHMKICAgICAqICAgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsCiAgICAgKiAgIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogQHNlZSBnZXQKICAgICAqLwogICAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaChjYWxsYmFjaykgewogICAgICB0aGlzLmNvYWxlc2NlUmVmcmVzaChjYWxsYmFjayB8fCBBV1MudXRpbC5mbi5jYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZDogZnVuY3Rpb24gbG9hZChjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHNlbGYuY3JlYXRlQ2xpZW50cygpOwogICAgICBzZWxmLnNlcnZpY2UuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eShmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgc2VsZi5kYXRhID0gbnVsbDsKICAgICAgICBpZiAoIWVycikgewogICAgICAgICAgc2VsZi5kYXRhID0gZGF0YTsKICAgICAgICAgIHNlbGYuc2VydmljZS5jcmVkZW50aWFsc0Zyb20oZGF0YSwgc2VsZik7CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNyZWF0ZUNsaWVudHM6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMuc2VydmljZSkgewogICAgICAgIHZhciBzdHNDb25maWcgPSBBV1MudXRpbC5tZXJnZSh7fSwgdGhpcy5fY2xpZW50Q29uZmlnKTsKICAgICAgICBzdHNDb25maWcucGFyYW1zID0gdGhpcy5wYXJhbXM7CiAgICAgICAgdGhpcy5zZXJ2aWNlID0gbmV3IFNUUyhzdHNDb25maWcpOwogICAgICB9CiAgICB9CiAgCiAgfSk7CiAgCiAgfSx7Ii4uLy4uL2NsaWVudHMvc3RzIjo4LCIuLi9jb3JlIjoxOH1dLDI2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKHByb2Nlc3MpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4vdXRpbCcpOwogIHZhciBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWRFbnZzID0gWydBV1NfRU5BQkxFX0VORFBPSU5UX0RJU0NPVkVSWScsICdBV1NfRU5EUE9JTlRfRElTQ09WRVJZX0VOQUJMRUQnXTsKICAKICAvKioKICAgKiBHZW5lcmF0ZSBrZXkgKGV4Y2VwdCByZXNvdXJjZXMgYW5kIG9wZXJhdGlvbiBwYXJ0KSB0byBpbmRleCB0aGUgZW5kcG9pbnRzIGluIHRoZSBjYWNoZQogICAqIElmIGlucHV0IHNoYXBlIGhhcyBlbmRwb2ludGRpc2NvdmVyeWlkIHRyYWl0IHRoZW4gdXNlCiAgICogICBhY2Nlc3NLZXkgKyBvcGVyYXRpb24gKyByZXNvdXJjZXMgKyByZWdpb24gKyBzZXJ2aWNlIGFzIGNhY2hlIGtleQogICAqIElmIGlucHV0IHNoYXBlIGRvZXNuJ3QgaGF2ZSBlbmRwb2ludGRpc2NvdmVyeWlkIHRyYWl0IHRoZW4gdXNlCiAgICogICBhY2Nlc3NLZXkgKyByZWdpb24gKyBzZXJ2aWNlIGFzIGNhY2hlIGtleQogICAqIEByZXR1cm4gW21hcDxTdHJpbmcsU3RyaW5nPl0gb2JqZWN0IHdpdGgga2V5cyB0byBpbmRleCBlbmRwb2ludHMuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gZ2V0Q2FjaGVLZXkocmVxdWVzdCkgewogICAgdmFyIHNlcnZpY2UgPSByZXF1ZXN0LnNlcnZpY2U7CiAgICB2YXIgYXBpID0gc2VydmljZS5hcGkgfHwge307CiAgICB2YXIgb3BlcmF0aW9ucyA9IGFwaS5vcGVyYXRpb25zOwogICAgdmFyIGlkZW50aWZpZXJzID0ge307CiAgICBpZiAoc2VydmljZS5jb25maWcucmVnaW9uKSB7CiAgICAgIGlkZW50aWZpZXJzLnJlZ2lvbiA9IHNlcnZpY2UuY29uZmlnLnJlZ2lvbjsKICAgIH0KICAgIGlmIChhcGkuc2VydmljZUlkKSB7CiAgICAgIGlkZW50aWZpZXJzLnNlcnZpY2VJZCA9IGFwaS5zZXJ2aWNlSWQ7CiAgICB9CiAgICBpZiAoc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQpIHsKICAgICAgaWRlbnRpZmllcnMuYWNjZXNzS2V5SWQgPSBzZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscy5hY2Nlc3NLZXlJZDsKICAgIH0KICAgIHJldHVybiBpZGVudGlmaWVyczsKICB9CiAgCiAgLyoqCiAgICogUmVjdXJzaXZlIGhlbHBlciBmb3IgbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycygpLgogICAqIExvb2tzIGZvciByZXF1aXJlZCBzdHJpbmcgaW5wdXQgbWVtYmVycyB0aGF0IGhhdmUgJ2VuZHBvaW50ZGlzY292ZXJ5aWQnIHRyYWl0LgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnNIZWxwZXIocmVzdWx0LCBwYXJhbXMsIHNoYXBlKSB7CiAgICBpZiAoIXNoYXBlIHx8IHBhcmFtcyA9PT0gdW5kZWZpbmVkIHx8IHBhcmFtcyA9PT0gbnVsbCkgcmV0dXJuOwogICAgaWYgKHNoYXBlLnR5cGUgPT09ICdzdHJ1Y3R1cmUnICYmIHNoYXBlLnJlcXVpcmVkICYmIHNoYXBlLnJlcXVpcmVkLmxlbmd0aCA+IDApIHsKICAgICAgdXRpbC5hcnJheUVhY2goc2hhcGUucmVxdWlyZWQsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICB2YXIgbWVtYmVyU2hhcGUgPSBzaGFwZS5tZW1iZXJzW25hbWVdOwogICAgICAgIGlmIChtZW1iZXJTaGFwZS5lbmRwb2ludERpc2NvdmVyeUlkID09PSB0cnVlKSB7CiAgICAgICAgICB2YXIgbG9jYXRpb25OYW1lID0gbWVtYmVyU2hhcGUuaXNMb2NhdGlvbk5hbWUgPyBtZW1iZXJTaGFwZS5uYW1lIDogbmFtZTsKICAgICAgICAgIHJlc3VsdFtsb2NhdGlvbk5hbWVdID0gU3RyaW5nKHBhcmFtc1tuYW1lXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnNIZWxwZXIocmVzdWx0LCBwYXJhbXNbbmFtZV0sIG1lbWJlclNoYXBlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KICAKICAvKioKICAgKiBHZXQgY3VzdG9tIGlkZW50aWZpZXJzIGZvciBjYWNoZSBrZXkuCiAgICogSWRlbnRpZmllcyBjdXN0b20gaWRlbnRpZmllcnMgYnkgY2hlY2tpbmcgZWFjaCBzaGFwZSdzIGBlbmRwb2ludERpc2NvdmVyeUlkYCB0cmFpdC4KICAgKiBAcGFyYW0gW29iamVjdF0gcmVxdWVzdCBvYmplY3QKICAgKiBAcGFyYW0gW29iamVjdF0gaW5wdXQgc2hhcGUgb2YgdGhlIGdpdmVuIG9wZXJhdGlvbidzIGFwaQogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnMocmVxdWVzdCwgc2hhcGUpIHsKICAgIHZhciBpZGVudGlmaWVycyA9IHt9OwogICAgbWFyc2hhbGxDdXN0b21JZGVudGlmaWVyc0hlbHBlcihpZGVudGlmaWVycywgcmVxdWVzdC5wYXJhbXMsIHNoYXBlKTsKICAgIHJldHVybiBpZGVudGlmaWVyczsKICB9CiAgCiAgLyoqCiAgICogQ2FsbCBlbmRwb2ludCBkaXNjb3Zlcnkgb3BlcmF0aW9uIHdoZW4gaXQncyBvcHRpb25hbC4KICAgKiBXaGVuIGVuZHBvaW50IGlzIGF2YWlsYWJsZSBpbiBjYWNoZSB0aGVuIHVzZSB0aGUgY2FjaGVkIGVuZHBvaW50cy4gSWYgZW5kcG9pbnRzCiAgICogYXJlIHVuYXZhaWxhYmxlIHRoZW4gdXNlIHJlZ2lvbmFsIGVuZHBvaW50cyBhbmQgY2FsbCBlbmRwb2ludCBkaXNjb3Zlcnkgb3BlcmF0aW9uCiAgICogYXN5bmNocm9ub3VzbHkuIFRoaXMgaXMgdHVybmVkIG9mZiBieSBkZWZhdWx0LgogICAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0IG9iamVjdAogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG9wdGlvbmFsRGlzY292ZXJFbmRwb2ludChyZXF1ZXN0KSB7CiAgICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZTsKICAgIHZhciBhcGkgPSBzZXJ2aWNlLmFwaTsKICAgIHZhciBvcGVyYXRpb25Nb2RlbCA9IGFwaS5vcGVyYXRpb25zID8gYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dIDogdW5kZWZpbmVkOwogICAgdmFyIGlucHV0U2hhcGUgPSBvcGVyYXRpb25Nb2RlbCA/IG9wZXJhdGlvbk1vZGVsLmlucHV0IDogdW5kZWZpbmVkOwogIAogICAgdmFyIGlkZW50aWZpZXJzID0gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycyhyZXF1ZXN0LCBpbnB1dFNoYXBlKTsKICAgIHZhciBjYWNoZUtleSA9IGdldENhY2hlS2V5KHJlcXVlc3QpOwogICAgaWYgKE9iamVjdC5rZXlzKGlkZW50aWZpZXJzKS5sZW5ndGggPiAwKSB7CiAgICAgIGNhY2hlS2V5ID0gdXRpbC51cGRhdGUoY2FjaGVLZXksIGlkZW50aWZpZXJzKTsKICAgICAgaWYgKG9wZXJhdGlvbk1vZGVsKSBjYWNoZUtleS5vcGVyYXRpb24gPSBvcGVyYXRpb25Nb2RlbC5uYW1lOwogICAgfQogICAgdmFyIGVuZHBvaW50cyA9IEFXUy5lbmRwb2ludENhY2hlLmdldChjYWNoZUtleSk7CiAgICBpZiAoZW5kcG9pbnRzICYmIGVuZHBvaW50cy5sZW5ndGggPT09IDEgJiYgZW5kcG9pbnRzWzBdLkFkZHJlc3MgPT09ICcnKSB7CiAgICAgIC8vZW5kcG9pbnQgb3BlcmF0aW9uIGlzIGJlaW5nIG1hZGUgYnV0IHJlc3BvbnNlIG5vdCB5ZXQgcmVjZWl2ZWQKICAgICAgLy9vciBlbmRwb2ludCBvcGVyYXRpb24ganVzdCBmYWlsZWQgaW4gMSBtaW51dGUKICAgICAgcmV0dXJuOwogICAgfSBlbHNlIGlmIChlbmRwb2ludHMgJiYgZW5kcG9pbnRzLmxlbmd0aCA+IDApIHsKICAgICAgLy9mb3VuZCBlbmRwb2ludCByZWNvcmQgZnJvbSBjYWNoZQogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnVwZGF0ZUVuZHBvaW50KGVuZHBvaW50c1swXS5BZGRyZXNzKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vZW5kcG9pbnQgcmVjb3JkIG5vdCBpbiBjYWNoZSBvciBvdXRkYXRlZC4gbWFrZSBkaXNjb3Zlcnkgb3BlcmF0aW9uCiAgICAgIHZhciBlbmRwb2ludFJlcXVlc3QgPSBzZXJ2aWNlLm1ha2VSZXF1ZXN0KGFwaS5lbmRwb2ludE9wZXJhdGlvbiwgewogICAgICAgIE9wZXJhdGlvbjogb3BlcmF0aW9uTW9kZWwubmFtZSwKICAgICAgICBJZGVudGlmaWVyczogaWRlbnRpZmllcnMsCiAgICAgIH0pOwogICAgICBhZGRBcGlWZXJzaW9uSGVhZGVyKGVuZHBvaW50UmVxdWVzdCk7CiAgICAgIGVuZHBvaW50UmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9QQVJBTUVURVJTKTsKICAgICAgZW5kcG9pbnRSZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdyZXRyeScsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlJFVFJZX0NIRUNLKTsKICAgICAgLy9wdXQgaW4gYSBwbGFjZWhvbGRlciBmb3IgZW5kcG9pbnRzIGFscmVhZHkgcmVxdWVzdGVkLCBwcmV2ZW50CiAgICAgIC8vdG9vIG11Y2ggaW4tZmxpZ2h0IGNhbGxzCiAgICAgIEFXUy5lbmRwb2ludENhY2hlLnB1dChjYWNoZUtleSwgW3sKICAgICAgICBBZGRyZXNzOiAnJywKICAgICAgICBDYWNoZVBlcmlvZEluTWludXRlczogMQogICAgICB9XSk7CiAgICAgIGVuZHBvaW50UmVxdWVzdC5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgIGlmIChkYXRhICYmIGRhdGEuRW5kcG9pbnRzKSB7CiAgICAgICAgICBBV1MuZW5kcG9pbnRDYWNoZS5wdXQoY2FjaGVLZXksIGRhdGEuRW5kcG9pbnRzKTsKICAgICAgICB9IGVsc2UgaWYgKGVycikgewogICAgICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucHV0KGNhY2hlS2V5LCBbewogICAgICAgICAgICBBZGRyZXNzOiAnJywKICAgICAgICAgICAgQ2FjaGVQZXJpb2RJbk1pbnV0ZXM6IDEgLy9ub3QgdG8gbWFrZSBtb3JlIGVuZHBvaW50IG9wZXJhdGlvbiBpbiBuZXh0IDEgbWludXRlCiAgICAgICAgICB9XSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9CiAgCiAgdmFyIHJlcXVlc3RRdWV1ZSA9IHt9OwogIAogIC8qKgogICAqIENhbGwgZW5kcG9pbnQgZGlzY292ZXJ5IG9wZXJhdGlvbiB3aGVuIGl0J3MgcmVxdWlyZWQuCiAgICogV2hlbiBlbmRwb2ludCBpcyBhdmFpbGFibGUgaW4gY2FjaGUgdGhlbiB1c2UgY2FjaGVkIG9uZXMuIElmIGVuZHBvaW50cyBhcmUKICAgKiB1bmF2YWlsYWJsZSB0aGVuIFNESyBzaG91bGQgY2FsbCBlbmRwb2ludCBvcGVyYXRpb24gdGhlbiB1c2UgcmV0dXJuZWQgbmV3CiAgICogZW5kcG9pbnQgZm9yIHRoZSBhcGkgY2FsbC4gU0RLIHdpbGwgYXV0b21hdGljYWxseSBhdHRlbXB0IHRvIGRvIGVuZHBvaW50CiAgICogZGlzY292ZXJ5LiBUaGlzIGlzIHR1cm5lZCBvZmYgYnkgZGVmYXVsdAogICAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0IG9iamVjdAogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHJlcXVpcmVkRGlzY292ZXJFbmRwb2ludChyZXF1ZXN0LCBkb25lKSB7CiAgICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZTsKICAgIHZhciBhcGkgPSBzZXJ2aWNlLmFwaTsKICAgIHZhciBvcGVyYXRpb25Nb2RlbCA9IGFwaS5vcGVyYXRpb25zID8gYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dIDogdW5kZWZpbmVkOwogICAgdmFyIGlucHV0U2hhcGUgPSBvcGVyYXRpb25Nb2RlbCA/IG9wZXJhdGlvbk1vZGVsLmlucHV0IDogdW5kZWZpbmVkOwogIAogICAgdmFyIGlkZW50aWZpZXJzID0gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycyhyZXF1ZXN0LCBpbnB1dFNoYXBlKTsKICAgIHZhciBjYWNoZUtleSA9IGdldENhY2hlS2V5KHJlcXVlc3QpOwogICAgaWYgKE9iamVjdC5rZXlzKGlkZW50aWZpZXJzKS5sZW5ndGggPiAwKSB7CiAgICAgIGNhY2hlS2V5ID0gdXRpbC51cGRhdGUoY2FjaGVLZXksIGlkZW50aWZpZXJzKTsKICAgICAgaWYgKG9wZXJhdGlvbk1vZGVsKSBjYWNoZUtleS5vcGVyYXRpb24gPSBvcGVyYXRpb25Nb2RlbC5uYW1lOwogICAgfQogICAgdmFyIGNhY2hlS2V5U3RyID0gQVdTLkVuZHBvaW50Q2FjaGUuZ2V0S2V5U3RyaW5nKGNhY2hlS2V5KTsKICAgIHZhciBlbmRwb2ludHMgPSBBV1MuZW5kcG9pbnRDYWNoZS5nZXQoY2FjaGVLZXlTdHIpOyAvL2VuZHBvaW50IGNhY2hlIGFsc28gYWNjZXB0cyBzdHJpbmcga2V5cwogICAgaWYgKGVuZHBvaW50cyAmJiBlbmRwb2ludHMubGVuZ3RoID09PSAxICYmIGVuZHBvaW50c1swXS5BZGRyZXNzID09PSAnJykgewogICAgICAvL2VuZHBvaW50IG9wZXJhdGlvbiBpcyBiZWluZyBtYWRlIGJ1dCByZXNwb25zZSBub3QgeWV0IHJlY2VpdmVkCiAgICAgIC8vcHVzaCByZXF1ZXN0IG9iamVjdCB0byBhIHBlbmRpbmcgcXVldWUKICAgICAgaWYgKCFyZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdKSByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdID0gW107CiAgICAgIHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0ucHVzaCh7cmVxdWVzdDogcmVxdWVzdCwgY2FsbGJhY2s6IGRvbmV9KTsKICAgICAgcmV0dXJuOwogICAgfSBlbHNlIGlmIChlbmRwb2ludHMgJiYgZW5kcG9pbnRzLmxlbmd0aCA+IDApIHsKICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC51cGRhdGVFbmRwb2ludChlbmRwb2ludHNbMF0uQWRkcmVzcyk7CiAgICAgIGRvbmUoKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBlbmRwb2ludFJlcXVlc3QgPSBzZXJ2aWNlLm1ha2VSZXF1ZXN0KGFwaS5lbmRwb2ludE9wZXJhdGlvbiwgewogICAgICAgIE9wZXJhdGlvbjogb3BlcmF0aW9uTW9kZWwubmFtZSwKICAgICAgICBJZGVudGlmaWVyczogaWRlbnRpZmllcnMsCiAgICAgIH0pOwogICAgICBlbmRwb2ludFJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUEFSQU1FVEVSUyk7CiAgICAgIGFkZEFwaVZlcnNpb25IZWFkZXIoZW5kcG9pbnRSZXF1ZXN0KTsKICAKICAgICAgLy9wdXQgaW4gYSBwbGFjZWhvbGRlciBmb3IgZW5kcG9pbnRzIGFscmVhZHkgcmVxdWVzdGVkLCBwcmV2ZW50CiAgICAgIC8vdG9vIG11Y2ggaW4tZmxpZ2h0IGNhbGxzCiAgICAgIEFXUy5lbmRwb2ludENhY2hlLnB1dChjYWNoZUtleVN0ciwgW3sKICAgICAgICBBZGRyZXNzOiAnJywKICAgICAgICBDYWNoZVBlcmlvZEluTWludXRlczogNjAgLy9sb25nLWxpdmUgY2FjaGUKICAgICAgfV0pOwogICAgICBlbmRwb2ludFJlcXVlc3Quc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICB2YXIgZXJyb3JQYXJhbXMgPSB7CiAgICAgICAgICAgIGNvZGU6ICdFbmRwb2ludERpc2NvdmVyeUV4Y2VwdGlvbicsCiAgICAgICAgICAgIG1lc3NhZ2U6ICdSZXF1ZXN0IGNhbm5vdCBiZSBmdWxmaWxsZWQgd2l0aG91dCBzcGVjaWZ5aW5nIGFuIGVuZHBvaW50JywKICAgICAgICAgICAgcmV0cnlhYmxlOiBmYWxzZQogICAgICAgICAgfTsKICAgICAgICAgIHJlcXVlc3QucmVzcG9uc2UuZXJyb3IgPSB1dGlsLmVycm9yKGVyciwgZXJyb3JQYXJhbXMpOwogICAgICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucmVtb3ZlKGNhY2hlS2V5KTsKICAKICAgICAgICAgIC8vZmFpbCBhbGwgdGhlIHBlbmRpbmcgcmVxdWVzdHMgaW4gYmF0Y2gKICAgICAgICAgIGlmIChyZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdKSB7CiAgICAgICAgICAgIHZhciBwZW5kaW5nUmVxdWVzdHMgPSByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdOwogICAgICAgICAgICB1dGlsLmFycmF5RWFjaChwZW5kaW5nUmVxdWVzdHMsIGZ1bmN0aW9uKHJlcXVlc3RDb250ZXh0KSB7CiAgICAgICAgICAgICAgcmVxdWVzdENvbnRleHQucmVxdWVzdC5yZXNwb25zZS5lcnJvciA9IHV0aWwuZXJyb3IoZXJyLCBlcnJvclBhcmFtcyk7CiAgICAgICAgICAgICAgcmVxdWVzdENvbnRleHQuY2FsbGJhY2soKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRlbGV0ZSByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoZGF0YSkgewogICAgICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucHV0KGNhY2hlS2V5U3RyLCBkYXRhLkVuZHBvaW50cyk7CiAgICAgICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnVwZGF0ZUVuZHBvaW50KGRhdGEuRW5kcG9pbnRzWzBdLkFkZHJlc3MpOwogIAogICAgICAgICAgLy91cGRhdGUgdGhlIGVuZHBvaW50IGZvciBhbGwgdGhlIHBlbmRpbmcgcmVxdWVzdHMgaW4gYmF0Y2gKICAgICAgICAgIGlmIChyZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdKSB7CiAgICAgICAgICAgIHZhciBwZW5kaW5nUmVxdWVzdHMgPSByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdOwogICAgICAgICAgICB1dGlsLmFycmF5RWFjaChwZW5kaW5nUmVxdWVzdHMsIGZ1bmN0aW9uKHJlcXVlc3RDb250ZXh0KSB7CiAgICAgICAgICAgICAgcmVxdWVzdENvbnRleHQucmVxdWVzdC5odHRwUmVxdWVzdC51cGRhdGVFbmRwb2ludChkYXRhLkVuZHBvaW50c1swXS5BZGRyZXNzKTsKICAgICAgICAgICAgICByZXF1ZXN0Q29udGV4dC5jYWxsYmFjaygpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZGVsZXRlIHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGRvbmUoKTsKICAgICAgfSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIGFkZCBhcGkgdmVyc2lvbiBoZWFkZXIgdG8gZW5kcG9pbnQgb3BlcmF0aW9uCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gYWRkQXBpVmVyc2lvbkhlYWRlcihlbmRwb2ludFJlcXVlc3QpIHsKICAgIHZhciBhcGkgPSBlbmRwb2ludFJlcXVlc3Quc2VydmljZS5hcGk7CiAgICB2YXIgYXBpVmVyc2lvbiA9IGFwaS5hcGlWZXJzaW9uOwogICAgaWYgKGFwaVZlcnNpb24gJiYgIWVuZHBvaW50UmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWyd4LWFtei1hcGktdmVyc2lvbiddKSB7CiAgICAgIGVuZHBvaW50UmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWyd4LWFtei1hcGktdmVyc2lvbiddID0gYXBpVmVyc2lvbjsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogSWYgYXBpIGNhbGwgZ2V0cyBpbnZhbGlkIGVuZHBvaW50IGV4Y2VwdGlvbiwgU0RLIHNob3VsZCBhdHRlbXB0IHRvIHJlbW92ZSB0aGUgaW52YWxpZAogICAqIGVuZHBvaW50IGZyb20gY2FjaGUuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50cyhyZXNwb25zZSkgewogICAgdmFyIGVycm9yID0gcmVzcG9uc2UuZXJyb3I7CiAgICB2YXIgaHR0cFJlc3BvbnNlID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlOwogICAgaWYgKGVycm9yICYmCiAgICAgIChlcnJvci5jb2RlID09PSAnSW52YWxpZEVuZHBvaW50RXhjZXB0aW9uJyB8fCBodHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gNDIxKQogICAgKSB7CiAgICAgIHZhciByZXF1ZXN0ID0gcmVzcG9uc2UucmVxdWVzdDsKICAgICAgdmFyIG9wZXJhdGlvbnMgPSByZXF1ZXN0LnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMgfHwge307CiAgICAgIHZhciBpbnB1dFNoYXBlID0gb3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0gPyBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXS5pbnB1dCA6IHVuZGVmaW5lZDsKICAgICAgdmFyIGlkZW50aWZpZXJzID0gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycyhyZXF1ZXN0LCBpbnB1dFNoYXBlKTsKICAgICAgdmFyIGNhY2hlS2V5ID0gZ2V0Q2FjaGVLZXkocmVxdWVzdCk7CiAgICAgIGlmIChPYmplY3Qua2V5cyhpZGVudGlmaWVycykubGVuZ3RoID4gMCkgewogICAgICAgIGNhY2hlS2V5ID0gdXRpbC51cGRhdGUoY2FjaGVLZXksIGlkZW50aWZpZXJzKTsKICAgICAgICBpZiAob3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0pIGNhY2hlS2V5Lm9wZXJhdGlvbiA9IG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dLm5hbWU7CiAgICAgIH0KICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucmVtb3ZlKGNhY2hlS2V5KTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogSWYgZW5kcG9pbnQgaXMgZXhwbGljaXRseSBjb25maWd1cmVkLCBTREsgc2hvdWxkIG5vdCBkbyBlbmRwb2ludCBkaXNjb3ZlcnkgaW4gYW55dGltZS4KICAgKiBAcGFyYW0gW29iamVjdF0gY2xpZW50IFNlcnZpY2UgY2xpZW50IG9iamVjdC4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBoYXNDdXN0b21FbmRwb2ludChjbGllbnQpIHsKICAgIC8vaWYgc2V0IGVuZHBvaW50IGlzIHNldCBmb3Igc3BlY2lmaWMgY2xpZW50LCBlbmFibGUgZW5kcG9pbnQgZGlzY292ZXJ5IHdpbGwgcmFpc2UgYW4gZXJyb3IuCiAgICBpZiAoY2xpZW50Ll9vcmlnaW5hbENvbmZpZyAmJiBjbGllbnQuX29yaWdpbmFsQ29uZmlnLmVuZHBvaW50ICYmIGNsaWVudC5fb3JpZ2luYWxDb25maWcuZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkID09PSB0cnVlKSB7CiAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiAnQ29uZmlndXJhdGlvbkV4Y2VwdGlvbicsCiAgICAgICAgbWVzc2FnZTogJ0N1c3RvbSBlbmRwb2ludCBpcyBzdXBwbGllZDsgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkIG11c3Qgbm90IGJlIHRydWUuJwogICAgICB9KTsKICAgIH07CiAgICB2YXIgc3ZjQ29uZmlnID0gQVdTLmNvbmZpZ1tjbGllbnQuc2VydmljZUlkZW50aWZpZXJdIHx8IHt9OwogICAgcmV0dXJuIEJvb2xlYW4oQVdTLmNvbmZpZy5lbmRwb2ludCB8fCBzdmNDb25maWcuZW5kcG9pbnQgfHwgKGNsaWVudC5fb3JpZ2luYWxDb25maWcgJiYgY2xpZW50Ll9vcmlnaW5hbENvbmZpZy5lbmRwb2ludCkpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBpc0ZhbHN5KHZhbHVlKSB7CiAgICByZXR1cm4gWydmYWxzZScsICcwJ10uaW5kZXhPZih2YWx1ZSkgPj0gMDsKICB9CiAgCiAgLyoqCiAgICogSWYgZW5kcG9pbnQgZGlzY292ZXJ5IHNob3VsZCBwZXJmb3JtIGZvciB0aGlzIHJlcXVlc3Qgd2hlbiBlbmRwb2ludCBkaXNjb3ZlcnkgaXMgb3B0aW9uYWwuCiAgICogU0RLIHBlcmZvcm1zIGNvbmZpZyByZXNvbHV0aW9uIGluIG9yZGVyIGxpa2UgYmVsb3c6CiAgICogMS4gSWYgdHVybmVkIG9uIGNsaWVudCBjb25maWd1cmF0aW9uKGRlZmF1bHQgdG8gb2ZmKSB0aGVuIHR1cm4gb24gZW5kcG9pbnQgZGlzY292ZXJ5LgogICAqIDIuIElmIHR1cm5lZCBvbiBpbiBlbnYgQVdTX0VOQUJMRV9FTkRQT0lOVF9ESVNDT1ZFUlkgdGhlbiB0dXJuIG9uIGVuZHBvaW50IGRpc2NvdmVyeS4KICAgKiAzLiBJZiB0dXJuZWQgb24gaW4gc2hhcmVkIGluaSBjb25maWcgZmlsZSB3aXRoIGtleSAnZW5kcG9pbnRfZGlzY292ZXJ5X2VuYWJsZWQnLCB0aGVuCiAgICogICB0dXJuIG9uIGVuZHBvaW50IGRpc2NvdmVyeS4KICAgKiBAcGFyYW0gW29iamVjdF0gcmVxdWVzdCByZXF1ZXN0IG9iamVjdC4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBpc0VuZHBvaW50RGlzY292ZXJ5QXBwbGljYWJsZShyZXF1ZXN0KSB7CiAgICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZSB8fCB7fTsKICAgIGlmIChzZXJ2aWNlLmNvbmZpZy5lbmRwb2ludERpc2NvdmVyeUVuYWJsZWQgPT09IHRydWUpIHJldHVybiB0cnVlOwogIAogICAgLy9zaGFyZWQgaW5pIGZpbGUgaXMgb25seSBhdmFpbGFibGUgaW4gTm9kZQogICAgLy9ub3QgdG8gY2hlY2sgZW52IGluIGJyb3dzZXIKICAgIGlmICh1dGlsLmlzQnJvd3NlcigpKSByZXR1cm4gZmFsc2U7CiAgCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZEVudnMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGVudiA9IGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZEVudnNbaV07CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocHJvY2Vzcy5lbnYsIGVudikpIHsKICAgICAgICBpZiAocHJvY2Vzcy5lbnZbZW52XSA9PT0gJycgfHwgcHJvY2Vzcy5lbnZbZW52XSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICAgIGNvZGU6ICdDb25maWd1cmF0aW9uRXhjZXB0aW9uJywKICAgICAgICAgICAgbWVzc2FnZTogJ2Vudmlyb25tZW50YWwgdmFyaWFibGUgJyArIGVudiArICcgY2Fubm90IGJlIHNldCB0byBub3RoaW5nJwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICghaXNGYWxzeShwcm9jZXNzLmVudltlbnZdKSkgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KICAKICAgIHZhciBjb25maWdGaWxlID0ge307CiAgICB0cnkgewogICAgICBjb25maWdGaWxlID0gQVdTLnV0aWwuaW5pTG9hZGVyID8gQVdTLnV0aWwuaW5pTG9hZGVyLmxvYWRGcm9tKHsKICAgICAgICBpc0NvbmZpZzogdHJ1ZSwKICAgICAgICBmaWxlbmFtZTogcHJvY2Vzcy5lbnZbQVdTLnV0aWwuc2hhcmVkQ29uZmlnRmlsZUVudl0KICAgICAgfSkgOiB7fTsKICAgIH0gY2F0Y2ggKGUpIHt9CiAgICB2YXIgc2hhcmVkRmlsZUNvbmZpZyA9IGNvbmZpZ0ZpbGVbCiAgICAgIHByb2Nlc3MuZW52LkFXU19QUk9GSUxFIHx8IEFXUy51dGlsLmRlZmF1bHRQcm9maWxlCiAgICBdIHx8IHt9OwogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzaGFyZWRGaWxlQ29uZmlnLCAnZW5kcG9pbnRfZGlzY292ZXJ5X2VuYWJsZWQnKSkgewogICAgICBpZiAoc2hhcmVkRmlsZUNvbmZpZy5lbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgICAgY29kZTogJ0NvbmZpZ3VyYXRpb25FeGNlcHRpb24nLAogICAgICAgICAgbWVzc2FnZTogJ2NvbmZpZyBmaWxlIGVudHJ5IFwnZW5kcG9pbnRfZGlzY292ZXJ5X2VuYWJsZWRcJyBjYW5ub3QgYmUgc2V0IHRvIG5vdGhpbmcnCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKCFpc0ZhbHN5KHNoYXJlZEZpbGVDb25maWcuZW5kcG9pbnRfZGlzY292ZXJ5X2VuYWJsZWQpKSByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgCiAgLyoqCiAgICogYXR0YWNoIGVuZHBvaW50IGRpc2NvdmVyeSBsb2dpYyB0byByZXF1ZXN0IG9iamVjdAogICAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0CiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gZGlzY292ZXJFbmRwb2ludChyZXF1ZXN0LCBkb25lKSB7CiAgICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZSB8fCB7fTsKICAgIGlmIChoYXNDdXN0b21FbmRwb2ludChzZXJ2aWNlKSB8fCByZXF1ZXN0LmlzUHJlc2lnbmVkKCkpIHJldHVybiBkb25lKCk7CiAgCiAgICBpZiAoIWlzRW5kcG9pbnREaXNjb3ZlcnlBcHBsaWNhYmxlKHJlcXVlc3QpKSByZXR1cm4gZG9uZSgpOwogIAogICAgcmVxdWVzdC5odHRwUmVxdWVzdC5hcHBlbmRUb1VzZXJBZ2VudCgnZW5kcG9pbnQtZGlzY292ZXJ5Jyk7CiAgCiAgICB2YXIgb3BlcmF0aW9ucyA9IHNlcnZpY2UuYXBpLm9wZXJhdGlvbnMgfHwge307CiAgICB2YXIgb3BlcmF0aW9uTW9kZWwgPSBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXTsKICAgIHZhciBpc0VuZHBvaW50RGlzY292ZXJ5UmVxdWlyZWQgPSBvcGVyYXRpb25Nb2RlbCA/IG9wZXJhdGlvbk1vZGVsLmVuZHBvaW50RGlzY292ZXJ5UmVxdWlyZWQgOiAnTlVMTCc7CiAgICBzd2l0Y2ggKGlzRW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCkgewogICAgICBjYXNlICdPUFRJT05BTCc6CiAgICAgICAgb3B0aW9uYWxEaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QpOwogICAgICAgIHJlcXVlc3QuYWRkTmFtZWRMaXN0ZW5lcignSU5WQUxJREFURV9DQUNIRURfRU5EUE9JTlRTJywgJ2V4dHJhY3RFcnJvcicsIGludmFsaWRhdGVDYWNoZWRFbmRwb2ludHMpOwogICAgICAgIGRvbmUoKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnUkVRVUlSRUQnOgogICAgICAgIHJlcXVlc3QuYWRkTmFtZWRMaXN0ZW5lcignSU5WQUxJREFURV9DQUNIRURfRU5EUE9JTlRTJywgJ2V4dHJhY3RFcnJvcicsIGludmFsaWRhdGVDYWNoZWRFbmRwb2ludHMpOwogICAgICAgIHJlcXVpcmVkRGlzY292ZXJFbmRwb2ludChyZXF1ZXN0LCBkb25lKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnTlVMTCc6CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgZG9uZSgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KICAKICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIGRpc2NvdmVyRW5kcG9pbnQ6IGRpc2NvdmVyRW5kcG9pbnQsCiAgICByZXF1aXJlZERpc2NvdmVyRW5kcG9pbnQ6IHJlcXVpcmVkRGlzY292ZXJFbmRwb2ludCwKICAgIG9wdGlvbmFsRGlzY292ZXJFbmRwb2ludDogb3B0aW9uYWxEaXNjb3ZlckVuZHBvaW50LAogICAgbWFyc2hhbGxDdXN0b21JZGVudGlmaWVyczogbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycywKICAgIGdldENhY2hlS2V5OiBnZXRDYWNoZUtleSwKICAgIGludmFsaWRhdGVDYWNoZWRFbmRwb2ludDogaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50cywKICB9OwogIAogIH0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQogIH0seyIuL2NvcmUiOjE4LCIuL3V0aWwiOjcxLCJfcHJvY2VzcyI6ODV9XSwyNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIGV2ZW50TWVzc2FnZUNodW5rZXIgPSByZXF1aXJlKCcuLi9ldmVudC1zdHJlYW0vZXZlbnQtbWVzc2FnZS1jaHVua2VyJykuZXZlbnRNZXNzYWdlQ2h1bmtlcjsKICB2YXIgcGFyc2VFdmVudCA9IHJlcXVpcmUoJy4vcGFyc2UtZXZlbnQnKS5wYXJzZUV2ZW50OwogIAogIGZ1bmN0aW9uIGNyZWF0ZUV2ZW50U3RyZWFtKGJvZHksIHBhcnNlciwgbW9kZWwpIHsKICAgICAgdmFyIGV2ZW50TWVzc2FnZXMgPSBldmVudE1lc3NhZ2VDaHVua2VyKGJvZHkpOwogIAogICAgICB2YXIgZXZlbnRzID0gW107CiAgCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnRNZXNzYWdlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgZXZlbnRzLnB1c2gocGFyc2VFdmVudChwYXJzZXIsIGV2ZW50TWVzc2FnZXNbaV0sIG1vZGVsKSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIGV2ZW50czsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGNyZWF0ZUV2ZW50U3RyZWFtOiBjcmVhdGVFdmVudFN0cmVhbQogIH07CiAgCiAgfSx7Ii4uL2V2ZW50LXN0cmVhbS9ldmVudC1tZXNzYWdlLWNodW5rZXIiOjI4LCIuL3BhcnNlLWV2ZW50IjozMH1dLDI4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvKioKICAgKiBUYWtlcyBpbiBhIGJ1ZmZlciBvZiBldmVudCBtZXNzYWdlcyBhbmQgc3BsaXRzIHRoZW0gaW50byBpbmRpdmlkdWFsIG1lc3NhZ2VzLgogICAqIEBwYXJhbSB7QnVmZmVyfSBidWZmZXIKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBldmVudE1lc3NhZ2VDaHVua2VyKGJ1ZmZlcikgewogICAgICAvKiogQHR5cGUgQnVmZmVyW10gKi8KICAgICAgdmFyIG1lc3NhZ2VzID0gW107CiAgICAgIHZhciBvZmZzZXQgPSAwOwogIAogICAgICB3aGlsZSAob2Zmc2V0IDwgYnVmZmVyLmxlbmd0aCkgewogICAgICAgICAgdmFyIHRvdGFsTGVuZ3RoID0gYnVmZmVyLnJlYWRJbnQzMkJFKG9mZnNldCk7CiAgCiAgICAgICAgICAvLyBjcmVhdGUgbmV3IGJ1ZmZlciBmb3IgaW5kaXZpZHVhbCBtZXNzYWdlIChzaGFyZXMgbWVtb3J5IHdpdGggb3JpZ2luYWwpCiAgICAgICAgICB2YXIgbWVzc2FnZSA9IGJ1ZmZlci5zbGljZShvZmZzZXQsIHRvdGFsTGVuZ3RoICsgb2Zmc2V0KTsKICAgICAgICAgIC8vIGluY3JlbWVudCBvZmZzZXQgdG8gaXQgc3RhcnRzIGF0IHRoZSBuZXh0IG1lc3NhZ2UKICAgICAgICAgIG9mZnNldCArPSB0b3RhbExlbmd0aDsKICAKICAgICAgICAgIG1lc3NhZ2VzLnB1c2gobWVzc2FnZSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIG1lc3NhZ2VzOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgZXZlbnRNZXNzYWdlQ2h1bmtlcjogZXZlbnRNZXNzYWdlQ2h1bmtlcgogIH07CiAgCiAgfSx7fV0sMjk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vY29yZScpLnV0aWw7CiAgdmFyIHRvQnVmZmVyID0gdXRpbC5idWZmZXIudG9CdWZmZXI7CiAgCiAgLyoqCiAgICogQSBsb3NzbGVzcyByZXByZXNlbnRhdGlvbiBvZiBhIHNpZ25lZCwgNjQtYml0IGludGVnZXIuIEluc3RhbmNlcyBvZiB0aGlzCiAgICogY2xhc3MgbWF5IGJlIHVzZWQgaW4gYXJpdGhtZXRpYyBleHByZXNzaW9ucyBhcyBpZiB0aGV5IHdlcmUgbnVtZXJpYwogICAqIHByaW1pdGl2ZXMsIGJ1dCB0aGUgYmluYXJ5IHJlcHJlc2VudGF0aW9uIHdpbGwgYmUgcHJlc2VydmVkIHVuY2hhbmdlZCBhcyB0aGUKICAgKiBgYnl0ZXNgIHByb3BlcnR5IG9mIHRoZSBvYmplY3QuIFRoZSBieXRlcyBzaG91bGQgYmUgZW5jb2RlZCBhcyBiaWctZW5kaWFuLAogICAqIHR3bydzIGNvbXBsZW1lbnQgaW50ZWdlcnMuCiAgICogQHBhcmFtIHtCdWZmZXJ9IGJ5dGVzCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBJbnQ2NChieXRlcykgewogICAgICBpZiAoYnl0ZXMubGVuZ3RoICE9PSA4KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludDY0IGJ1ZmZlcnMgbXVzdCBiZSBleGFjdGx5IDggYnl0ZXMnKTsKICAgICAgfQogICAgICBpZiAoIXV0aWwuQnVmZmVyLmlzQnVmZmVyKGJ5dGVzKSkgYnl0ZXMgPSB0b0J1ZmZlcihieXRlcyk7CiAgCiAgICAgIHRoaXMuYnl0ZXMgPSBieXRlczsKICB9CiAgCiAgLyoqCiAgICogQHBhcmFtIHtudW1iZXJ9IG51bWJlcgogICAqIEByZXR1cm5zIHtJbnQ2NH0KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEludDY0LmZyb21OdW1iZXIgPSBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgaWYgKG51bWJlciA+IDkyMjMzNzIwMzY4NTQ3NzU4MDcgfHwgbnVtYmVyIDwgLTkyMjMzNzIwMzY4NTQ3NzU4MDgpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICBudW1iZXIgKyAnIGlzIHRvbyBsYXJnZSAob3IsIGlmIG5lZ2F0aXZlLCB0b28gc21hbGwpIHRvIHJlcHJlc2VudCBhcyBhbiBJbnQ2NCcKICAgICAgICAgICk7CiAgICAgIH0KICAKICAgICAgdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkoOCk7CiAgICAgIGZvciAoCiAgICAgICAgICB2YXIgaSA9IDcsIHJlbWFpbmluZyA9IE1hdGguYWJzKE1hdGgucm91bmQobnVtYmVyKSk7CiAgICAgICAgICBpID4gLTEgJiYgcmVtYWluaW5nID4gMDsKICAgICAgICAgIGktLSwgcmVtYWluaW5nIC89IDI1NgogICAgICApIHsKICAgICAgICAgIGJ5dGVzW2ldID0gcmVtYWluaW5nOwogICAgICB9CiAgCiAgICAgIGlmIChudW1iZXIgPCAwKSB7CiAgICAgICAgICBuZWdhdGUoYnl0ZXMpOwogICAgICB9CiAgCiAgICAgIHJldHVybiBuZXcgSW50NjQoYnl0ZXMpOwogIH07CiAgCiAgLyoqCiAgICogQHJldHVybnMge251bWJlcn0KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEludDY0LnByb3RvdHlwZS52YWx1ZU9mID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBieXRlcyA9IHRoaXMuYnl0ZXMuc2xpY2UoMCk7CiAgICAgIHZhciBuZWdhdGl2ZSA9IGJ5dGVzWzBdICYgMTI4OwogICAgICBpZiAobmVnYXRpdmUpIHsKICAgICAgICAgIG5lZ2F0ZShieXRlcyk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHBhcnNlSW50KGJ5dGVzLnRvU3RyaW5nKCdoZXgnKSwgMTYpICogKG5lZ2F0aXZlID8gLTEgOiAxKTsKICB9OwogIAogIEludDY0LnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gU3RyaW5nKHRoaXMudmFsdWVPZigpKTsKICB9OwogIAogIC8qKgogICAqIEBwYXJhbSB7QnVmZmVyfSBieXRlcwogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gbmVnYXRlKGJ5dGVzKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgODsgaSsrKSB7CiAgICAgICAgICBieXRlc1tpXSBePSAweEZGOwogICAgICB9CiAgICAgIGZvciAodmFyIGkgPSA3OyBpID4gLTE7IGktLSkgewogICAgICAgICAgYnl0ZXNbaV0rKzsKICAgICAgICAgIGlmIChieXRlc1tpXSAhPT0gMCkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBJbnQ2NDogSW50NjQKICB9OwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDMwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgcGFyc2VNZXNzYWdlID0gcmVxdWlyZSgnLi9wYXJzZS1tZXNzYWdlJykucGFyc2VNZXNzYWdlOwogIAogIC8qKgogICAqCiAgICogQHBhcmFtIHsqfSBwYXJzZXIKICAgKiBAcGFyYW0ge0J1ZmZlcn0gbWVzc2FnZQogICAqIEBwYXJhbSB7Kn0gc2hhcGUKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBwYXJzZUV2ZW50KHBhcnNlciwgbWVzc2FnZSwgc2hhcGUpIHsKICAgICAgdmFyIHBhcnNlZE1lc3NhZ2UgPSBwYXJzZU1lc3NhZ2UobWVzc2FnZSk7CiAgCiAgICAgIC8vIGNoZWNrIGlmIG1lc3NhZ2UgaXMgYW4gZXZlbnQgb3IgZXJyb3IKICAgICAgdmFyIG1lc3NhZ2VUeXBlID0gcGFyc2VkTWVzc2FnZS5oZWFkZXJzWyc6bWVzc2FnZS10eXBlJ107CiAgICAgIGlmIChtZXNzYWdlVHlwZSkgewogICAgICAgICAgaWYgKG1lc3NhZ2VUeXBlLnZhbHVlID09PSAnZXJyb3InKSB7CiAgICAgICAgICAgICAgdGhyb3cgcGFyc2VFcnJvcihwYXJzZWRNZXNzYWdlKTsKICAgICAgICAgIH0gZWxzZSBpZiAobWVzc2FnZVR5cGUudmFsdWUgIT09ICdldmVudCcpIHsKICAgICAgICAgICAgICAvLyBub3Qgc3VyZSBob3cgdG8gcGFyc2Ugbm9uLWV2ZW50cy9ub24tZXJyb3JzLCBpZ25vcmUgZm9yIG5vdwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgfQogIAogICAgICAvLyBkZXRlcm1pbmUgZXZlbnQgdHlwZQogICAgICB2YXIgZXZlbnRUeXBlID0gcGFyc2VkTWVzc2FnZS5oZWFkZXJzWyc6ZXZlbnQtdHlwZSddOwogICAgICAvLyBjaGVjayB0aGF0IHRoZSBldmVudCB0eXBlIGlzIG1vZGVsZWQKICAgICAgdmFyIGV2ZW50TW9kZWwgPSBzaGFwZS5tZW1iZXJzW2V2ZW50VHlwZS52YWx1ZV07CiAgICAgIGlmICghZXZlbnRNb2RlbCkgewogICAgICAgICAgcmV0dXJuOwogICAgICB9CiAgCiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgLy8gY2hlY2sgaWYgYW4gZXZlbnQgcGF5bG9hZCBleGlzdHMKICAgICAgdmFyIGV2ZW50UGF5bG9hZE1lbWJlck5hbWUgPSBldmVudE1vZGVsLmV2ZW50UGF5bG9hZE1lbWJlck5hbWU7CiAgICAgIGlmIChldmVudFBheWxvYWRNZW1iZXJOYW1lKSB7CiAgICAgICAgICB2YXIgcGF5bG9hZFNoYXBlID0gZXZlbnRNb2RlbC5tZW1iZXJzW2V2ZW50UGF5bG9hZE1lbWJlck5hbWVdOwogICAgICAgICAgLy8gaWYgdGhlIHNoYXBlIGlzIGJpbmFyeSwgcmV0dXJuIHRoZSBieXRlIGFycmF5CiAgICAgICAgICBpZiAocGF5bG9hZFNoYXBlLnR5cGUgPT09ICdiaW5hcnknKSB7CiAgICAgICAgICAgICAgcmVzdWx0W2V2ZW50UGF5bG9hZE1lbWJlck5hbWVdID0gcGFyc2VkTWVzc2FnZS5ib2R5OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXN1bHRbZXZlbnRQYXlsb2FkTWVtYmVyTmFtZV0gPSBwYXJzZXIucGFyc2UocGFyc2VkTWVzc2FnZS5ib2R5LnRvU3RyaW5nKCksIHBheWxvYWRTaGFwZSk7CiAgICAgICAgICB9CiAgICAgIH0KICAKICAgICAgLy8gcmVhZCBldmVudCBoZWFkZXJzCiAgICAgIHZhciBldmVudEhlYWRlck5hbWVzID0gZXZlbnRNb2RlbC5ldmVudEhlYWRlck1lbWJlck5hbWVzOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50SGVhZGVyTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBuYW1lID0gZXZlbnRIZWFkZXJOYW1lc1tpXTsKICAgICAgICAgIGlmIChwYXJzZWRNZXNzYWdlLmhlYWRlcnNbbmFtZV0pIHsKICAgICAgICAgICAgICAvLyBwYXJzZSB0aGUgaGVhZGVyIQogICAgICAgICAgICAgIHJlc3VsdFtuYW1lXSA9IGV2ZW50TW9kZWwubWVtYmVyc1tuYW1lXS50b1R5cGUocGFyc2VkTWVzc2FnZS5oZWFkZXJzW25hbWVdLnZhbHVlKTsKICAgICAgICAgIH0KICAgICAgfQogIAogICAgICB2YXIgb3V0cHV0ID0ge307CiAgICAgIG91dHB1dFtldmVudFR5cGUudmFsdWVdID0gcmVzdWx0OwogICAgICByZXR1cm4gb3V0cHV0OwogIH0KICAKICBmdW5jdGlvbiBwYXJzZUVycm9yKG1lc3NhZ2UpIHsKICAgICAgdmFyIGVycm9yQ29kZSA9IG1lc3NhZ2UuaGVhZGVyc1snOmVycm9yLWNvZGUnXTsKICAgICAgdmFyIGVycm9yTWVzc2FnZSA9IG1lc3NhZ2UuaGVhZGVyc1snOmVycm9yLW1lc3NhZ2UnXTsKICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKGVycm9yTWVzc2FnZS52YWx1ZSB8fCBlcnJvck1lc3NhZ2UpOwogICAgICBlcnJvci5jb2RlID0gZXJyb3IubmFtZSA9IGVycm9yQ29kZS52YWx1ZSB8fCBlcnJvckNvZGU7CiAgICAgIHJldHVybiBlcnJvcjsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIHBhcnNlRXZlbnQ6IHBhcnNlRXZlbnQKICB9OwogIAogIH0seyIuL3BhcnNlLW1lc3NhZ2UiOjMxfV0sMzE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBJbnQ2NCA9IHJlcXVpcmUoJy4vaW50NjQnKS5JbnQ2NDsKICAKICB2YXIgc3BsaXRNZXNzYWdlID0gcmVxdWlyZSgnLi9zcGxpdC1tZXNzYWdlJykuc3BsaXRNZXNzYWdlOwogIAogIHZhciBCT09MRUFOX1RBRyA9ICdib29sZWFuJzsKICB2YXIgQllURV9UQUcgPSAnYnl0ZSc7CiAgdmFyIFNIT1JUX1RBRyA9ICdzaG9ydCc7CiAgdmFyIElOVF9UQUcgPSAnaW50ZWdlcic7CiAgdmFyIExPTkdfVEFHID0gJ2xvbmcnOwogIHZhciBCSU5BUllfVEFHID0gJ2JpbmFyeSc7CiAgdmFyIFNUUklOR19UQUcgPSAnc3RyaW5nJzsKICB2YXIgVElNRVNUQU1QX1RBRyA9ICd0aW1lc3RhbXAnOwogIHZhciBVVUlEX1RBRyA9ICd1dWlkJzsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKgogICAqIEBwYXJhbSB7QnVmZmVyfSBoZWFkZXJzCiAgICovCiAgZnVuY3Rpb24gcGFyc2VIZWFkZXJzKGhlYWRlcnMpIHsKICAgICAgdmFyIG91dCA9IHt9OwogICAgICB2YXIgcG9zaXRpb24gPSAwOwogICAgICB3aGlsZSAocG9zaXRpb24gPCBoZWFkZXJzLmxlbmd0aCkgewogICAgICAgICAgdmFyIG5hbWVMZW5ndGggPSBoZWFkZXJzLnJlYWRVSW50OChwb3NpdGlvbisrKTsKICAgICAgICAgIHZhciBuYW1lID0gaGVhZGVycy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyBuYW1lTGVuZ3RoKS50b1N0cmluZygpOwogICAgICAgICAgcG9zaXRpb24gKz0gbmFtZUxlbmd0aDsKICAgICAgICAgIHN3aXRjaCAoaGVhZGVycy5yZWFkVUludDgocG9zaXRpb24rKykpIHsKICAgICAgICAgICAgICBjYXNlIDAgLyogYm9vbFRydWUgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IEJPT0xFQU5fVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHRydWUKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAxIC8qIGJvb2xGYWxzZSAqLzoKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogQk9PTEVBTl9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZmFsc2UKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAyIC8qIGJ5dGUgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IEJZVEVfVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGhlYWRlcnMucmVhZEludDgocG9zaXRpb24rKykKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAzIC8qIHNob3J0ICovOgogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBTSE9SVF9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5yZWFkSW50MTZCRShwb3NpdGlvbikKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gMjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA0IC8qIGludGVnZXIgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IElOVF9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5yZWFkSW50MzJCRShwb3NpdGlvbikKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gNDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA1IC8qIGxvbmcgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IExPTkdfVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG5ldyBJbnQ2NChoZWFkZXJzLnNsaWNlKHBvc2l0aW9uLCBwb3NpdGlvbiArIDgpKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSA4OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDYgLyogYnl0ZUFycmF5ICovOgogICAgICAgICAgICAgICAgICB2YXIgYmluYXJ5TGVuZ3RoID0gaGVhZGVycy5yZWFkVUludDE2QkUocG9zaXRpb24pOwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSAyOwogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBCSU5BUllfVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGhlYWRlcnMuc2xpY2UocG9zaXRpb24sIHBvc2l0aW9uICsgYmluYXJ5TGVuZ3RoKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSBiaW5hcnlMZW5ndGg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgNyAvKiBzdHJpbmcgKi86CiAgICAgICAgICAgICAgICAgIHZhciBzdHJpbmdMZW5ndGggPSBoZWFkZXJzLnJlYWRVSW50MTZCRShwb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDI7CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFNUUklOR19UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5zbGljZSgKICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiArIHN0cmluZ0xlbmd0aAogICAgICAgICAgICAgICAgICAgICAgKS50b1N0cmluZygpCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IHN0cmluZ0xlbmd0aDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA4IC8qIHRpbWVzdGFtcCAqLzoKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogVElNRVNUQU1QX1RBRywKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBuZXcgRGF0ZSgKICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgSW50NjQoaGVhZGVycy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyA4KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnZhbHVlT2YoKQogICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSA4OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDkgLyogdXVpZCAqLzoKICAgICAgICAgICAgICAgICAgdmFyIHV1aWRDaGFycyA9IGhlYWRlcnMuc2xpY2UocG9zaXRpb24sIHBvc2l0aW9uICsgMTYpCiAgICAgICAgICAgICAgICAgICAgICAudG9TdHJpbmcoJ2hleCcpOwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSAxNjsKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogVVVJRF9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdXVpZENoYXJzLnN1YnN0cigwLCA4KSArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgdXVpZENoYXJzLnN1YnN0cig4LCA0KSArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgdXVpZENoYXJzLnN1YnN0cigxMiwgNCkgKyAnLScgKwogICAgICAgICAgICAgICAgICAgICAgICAgIHV1aWRDaGFycy5zdWJzdHIoMTYsIDQpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgICB1dWlkQ2hhcnMuc3Vic3RyKDIwKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VucmVjb2duaXplZCBoZWFkZXIgdHlwZSB0YWcnKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gb3V0OwogIH0KICAKICBmdW5jdGlvbiBwYXJzZU1lc3NhZ2UobWVzc2FnZSkgewogICAgICB2YXIgcGFyc2VkID0gc3BsaXRNZXNzYWdlKG1lc3NhZ2UpOwogICAgICByZXR1cm4geyBoZWFkZXJzOiBwYXJzZUhlYWRlcnMocGFyc2VkLmhlYWRlcnMpLCBib2R5OiBwYXJzZWQuYm9keSB9OwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgcGFyc2VNZXNzYWdlOiBwYXJzZU1lc3NhZ2UKICB9OwogIAogIH0seyIuL2ludDY0IjoyOSwiLi9zcGxpdC1tZXNzYWdlIjozMn1dLDMyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL2NvcmUnKS51dGlsOwogIHZhciB0b0J1ZmZlciA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyOwogIAogIC8vIEFsbCBwcmVsdWRlIGNvbXBvbmVudHMgYXJlIHVuc2lnbmVkLCAzMi1iaXQgaW50ZWdlcnMKICB2YXIgUFJFTFVERV9NRU1CRVJfTEVOR1RIID0gNDsKICAvLyBUaGUgcHJlbHVkZSBjb25zaXN0cyBvZiB0d28gY29tcG9uZW50cwogIHZhciBQUkVMVURFX0xFTkdUSCA9IFBSRUxVREVfTUVNQkVSX0xFTkdUSCAqIDI7CiAgLy8gQ2hlY2tzdW1zIGFyZSBhbHdheXMgQ1JDMzIgaGFzaGVzLgogIHZhciBDSEVDS1NVTV9MRU5HVEggPSA0OwogIC8vIE1lc3NhZ2VzIG11c3QgaW5jbHVkZSBhIGZ1bGwgcHJlbHVkZSwgYSBwcmVsdWRlIGNoZWNrc3VtLCBhbmQgYSBtZXNzYWdlIGNoZWNrc3VtCiAgdmFyIE1JTklNVU1fTUVTU0FHRV9MRU5HVEggPSBQUkVMVURFX0xFTkdUSCArIENIRUNLU1VNX0xFTkdUSCAqIDI7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICoKICAgKiBAcGFyYW0ge0J1ZmZlcn0gbWVzc2FnZQogICAqLwogIGZ1bmN0aW9uIHNwbGl0TWVzc2FnZShtZXNzYWdlKSB7CiAgICAgIGlmICghdXRpbC5CdWZmZXIuaXNCdWZmZXIobWVzc2FnZSkpIG1lc3NhZ2UgPSB0b0J1ZmZlcihtZXNzYWdlKTsKICAKICAgICAgaWYgKG1lc3NhZ2UubGVuZ3RoIDwgTUlOSU1VTV9NRVNTQUdFX0xFTkdUSCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQcm92aWRlZCBtZXNzYWdlIHRvbyBzaG9ydCB0byBhY2NvbW1vZGF0ZSBldmVudCBzdHJlYW0gbWVzc2FnZSBvdmVyaGVhZCcpOwogICAgICB9CiAgCiAgICAgIGlmIChtZXNzYWdlLmxlbmd0aCAhPT0gbWVzc2FnZS5yZWFkVUludDMyQkUoMCkpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUmVwb3J0ZWQgbWVzc2FnZSBsZW5ndGggZG9lcyBub3QgbWF0Y2ggcmVjZWl2ZWQgbWVzc2FnZSBsZW5ndGgnKTsKICAgICAgfQogIAogICAgICB2YXIgZXhwZWN0ZWRQcmVsdWRlQ2hlY2tzdW0gPSBtZXNzYWdlLnJlYWRVSW50MzJCRShQUkVMVURFX0xFTkdUSCk7CiAgCiAgICAgIGlmICgKICAgICAgICAgIGV4cGVjdGVkUHJlbHVkZUNoZWNrc3VtICE9PSB1dGlsLmNyeXB0by5jcmMzMigKICAgICAgICAgICAgICBtZXNzYWdlLnNsaWNlKDAsIFBSRUxVREVfTEVOR1RIKQogICAgICAgICAgKQogICAgICApIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAnVGhlIHByZWx1ZGUgY2hlY2tzdW0gc3BlY2lmaWVkIGluIHRoZSBtZXNzYWdlICgnICsKICAgICAgICAgICAgICBleHBlY3RlZFByZWx1ZGVDaGVja3N1bSArCiAgICAgICAgICAgICAgJykgZG9lcyBub3QgbWF0Y2ggdGhlIGNhbGN1bGF0ZWQgQ1JDMzIgY2hlY2tzdW0uJwogICAgICAgICAgKTsKICAgICAgfQogIAogICAgICB2YXIgZXhwZWN0ZWRNZXNzYWdlQ2hlY2tzdW0gPSBtZXNzYWdlLnJlYWRVSW50MzJCRShtZXNzYWdlLmxlbmd0aCAtIENIRUNLU1VNX0xFTkdUSCk7CiAgCiAgICAgIGlmICgKICAgICAgICAgIGV4cGVjdGVkTWVzc2FnZUNoZWNrc3VtICE9PSB1dGlsLmNyeXB0by5jcmMzMigKICAgICAgICAgICAgICBtZXNzYWdlLnNsaWNlKDAsIG1lc3NhZ2UubGVuZ3RoIC0gQ0hFQ0tTVU1fTEVOR1RIKQogICAgICAgICAgKQogICAgICApIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAnVGhlIG1lc3NhZ2UgY2hlY2tzdW0gZGlkIG5vdCBtYXRjaCB0aGUgZXhwZWN0ZWQgdmFsdWUgb2YgJyArCiAgICAgICAgICAgICAgICAgIGV4cGVjdGVkTWVzc2FnZUNoZWNrc3VtCiAgICAgICAgICApOwogICAgICB9CiAgCiAgICAgIHZhciBoZWFkZXJzU3RhcnQgPSBQUkVMVURFX0xFTkdUSCArIENIRUNLU1VNX0xFTkdUSDsKICAgICAgdmFyIGhlYWRlcnNFbmQgPSBoZWFkZXJzU3RhcnQgKyBtZXNzYWdlLnJlYWRVSW50MzJCRShQUkVMVURFX01FTUJFUl9MRU5HVEgpOwogIAogICAgICByZXR1cm4gewogICAgICAgICAgaGVhZGVyczogbWVzc2FnZS5zbGljZShoZWFkZXJzU3RhcnQsIGhlYWRlcnNFbmQpLAogICAgICAgICAgYm9keTogbWVzc2FnZS5zbGljZShoZWFkZXJzRW5kLCBtZXNzYWdlLmxlbmd0aCAtIENIRUNLU1VNX0xFTkdUSCksCiAgICAgIH07CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBzcGxpdE1lc3NhZ2U6IHNwbGl0TWVzc2FnZQogIH07CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sMzM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICB2YXIgU2VxdWVudGlhbEV4ZWN1dG9yID0gcmVxdWlyZSgnLi9zZXF1ZW50aWFsX2V4ZWN1dG9yJyk7CiAgdmFyIERJU0NPVkVSX0VORFBPSU5UID0gcmVxdWlyZSgnLi9kaXNjb3Zlcl9lbmRwb2ludCcpLmRpc2NvdmVyRW5kcG9pbnQ7CiAgLyoqCiAgICogVGhlIG5hbWVzcGFjZSB1c2VkIHRvIHJlZ2lzdGVyIGdsb2JhbCBldmVudCBsaXN0ZW5lcnMgZm9yIHJlcXVlc3QgYnVpbGRpbmcKICAgKiBhbmQgc2VuZGluZy4KICAgKi8KICBBV1MuRXZlbnRMaXN0ZW5lcnMgPSB7CiAgICAvKioKICAgICAqIEAhYXR0cmlidXRlIFZBTElEQVRFX0NSRURFTlRJQUxTCiAgICAgKiAgIEEgcmVxdWVzdCBsaXN0ZW5lciB0aGF0IHZhbGlkYXRlcyB3aGV0aGVyIHRoZSByZXF1ZXN0IGlzIGJlaW5nCiAgICAgKiAgIHNlbnQgd2l0aCBjcmVkZW50aWFscy4KICAgICAqICAgSGFuZGxlcyB0aGUge0FXUy5SZXF1ZXN0fnZhbGlkYXRlICd2YWxpZGF0ZScgUmVxdWVzdCBldmVudH0KICAgICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3Qgd2l0aG91dCB2YWxpZGF0aW5nIGNyZWRlbnRpYWxzCiAgICAgKiAgICAgdmFyIGxpc3RlbmVyID0gQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfQ1JFREVOVElBTFM7CiAgICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBsaXN0ZW5lcik7CiAgICAgKiAgIEByZWFkb25seQogICAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgICAqIEAhYXR0cmlidXRlIFZBTElEQVRFX1JFR0lPTgogICAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCB2YWxpZGF0ZXMgd2hldGhlciB0aGUgcmVnaW9uIGlzIHNldAogICAgICogICBmb3IgYSByZXF1ZXN0LgogICAgICogICBIYW5kbGVzIHRoZSB7QVdTLlJlcXVlc3R+dmFsaWRhdGUgJ3ZhbGlkYXRlJyBSZXF1ZXN0IGV2ZW50fQogICAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRob3V0IHZhbGlkYXRpbmcgcmVnaW9uIGNvbmZpZ3VyYXRpb24KICAgICAqICAgICB2YXIgbGlzdGVuZXIgPSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9SRUdJT047CiAgICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBsaXN0ZW5lcik7CiAgICAgKiAgIEByZWFkb25seQogICAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgICAqIEAhYXR0cmlidXRlIFZBTElEQVRFX1BBUkFNRVRFUlMKICAgICAqICAgQSByZXF1ZXN0IGxpc3RlbmVyIHRoYXQgdmFsaWRhdGVzIGlucHV0IHBhcmFtZXRlcnMgaW4gYSByZXF1ZXN0LgogICAgICogICBIYW5kbGVzIHRoZSB7QVdTLlJlcXVlc3R+dmFsaWRhdGUgJ3ZhbGlkYXRlJyBSZXF1ZXN0IGV2ZW50fQogICAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRob3V0IHZhbGlkYXRpbmcgcGFyYW1ldGVycwogICAgICogICAgIHZhciBsaXN0ZW5lciA9IEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1BBUkFNRVRFUlM7CiAgICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBsaXN0ZW5lcik7CiAgICAgKiAgIEBleGFtcGxlIERpc2FibGUgcGFyYW1ldGVyIHZhbGlkYXRpb24gZ2xvYmFsbHkKICAgICAqICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLAogICAgICogICAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUkVHSU9OKTsKICAgICAqICAgQHJlYWRvbmx5CiAgICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAgICogQCFhdHRyaWJ1dGUgU0VORAogICAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCBpbml0aWF0ZXMgdGhlIEhUVFAgY29ubmVjdGlvbiBmb3IgYQogICAgICogICByZXF1ZXN0IGJlaW5nIHNlbnQuIEhhbmRsZXMgdGhlIHtBV1MuUmVxdWVzdH5zZW5kICdzZW5kJyBSZXF1ZXN0IGV2ZW50fQogICAgICogICBAZXhhbXBsZSBSZXBsYWNpbmcgdGhlIEhUVFAgaGFuZGxlcgogICAgICogICAgIHZhciBsaXN0ZW5lciA9IEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlNFTkQ7CiAgICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcignc2VuZCcsIGxpc3RlbmVyKTsKICAgICAqICAgICByZXF1ZXN0Lm9uKCdzZW5kJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAqICAgICAgIGN1c3RvbUhhbmRsZXIuc2VuZChyZXNwb25zZSk7CiAgICAgKiAgICAgfSk7CiAgICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAgICogICBAcmVhZG9ubHkKICAgICAqIEAhYXR0cmlidXRlIEhUVFBfREFUQQogICAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCByZWFkcyBkYXRhIGZyb20gdGhlIEhUVFAgY29ubmVjdGlvbiBpbiBvcmRlcgogICAgICogICB0byBidWlsZCB0aGUgcmVzcG9uc2UgZGF0YS4KICAgICAqICAgSGFuZGxlcyB0aGUge0FXUy5SZXF1ZXN0fmh0dHBEYXRhICdodHRwRGF0YScgUmVxdWVzdCBldmVudH0uCiAgICAgKiAgIFJlbW92ZSB0aGlzIGhhbmRsZXIgaWYgeW91IGFyZSBvdmVycmlkaW5nIHRoZSAnaHR0cERhdGEnIGV2ZW50IGFuZAogICAgICogICBkbyBub3Qgd2FudCBleHRyYSBkYXRhIHByb2Nlc3NpbmcgYW5kIGJ1ZmZlcmluZyBvdmVyaGVhZC4KICAgICAqICAgQGV4YW1wbGUgRGlzYWJsaW5nIGRlZmF1bHQgZGF0YSBwcm9jZXNzaW5nCiAgICAgKiAgICAgdmFyIGxpc3RlbmVyID0gQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuSFRUUF9EQVRBOwogICAgICogICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ2h0dHBEYXRhJywgbGlzdGVuZXIpOwogICAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgICAqICAgQHJlYWRvbmx5CiAgICAgKi8KICAgIENvcmU6IHt9IC8qIGRvYyBoYWNrICovCiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBnZXRPcGVyYXRpb25BdXRodHlwZShyZXEpIHsKICAgIGlmICghcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMpIHsKICAgICAgcmV0dXJuICcnOwogICAgfQogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgcmV0dXJuIG9wZXJhdGlvbiA/IG9wZXJhdGlvbi5hdXRodHlwZSA6ICcnOwogIH0KICAKICBBV1MuRXZlbnRMaXN0ZW5lcnMgPSB7CiAgICBDb3JlOiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkLCBhZGRBc3luYykgewogICAgICBhZGRBc3luYygnVkFMSURBVEVfQ1JFREVOVElBTFMnLCAndmFsaWRhdGUnLAogICAgICAgICAgZnVuY3Rpb24gVkFMSURBVEVfQ1JFREVOVElBTFMocmVxLCBkb25lKSB7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkuc2lnbmF0dXJlVmVyc2lvbiAmJiAhcmVxLnNlcnZpY2UuY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIHJldHVybiBkb25lKCk7IC8vIG5vbmUKICAgICAgICByZXEuc2VydmljZS5jb25maWcuZ2V0Q3JlZGVudGlhbHMoZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIHJlcS5yZXNwb25zZS5lcnJvciA9IEFXUy51dGlsLmVycm9yKGVyciwKICAgICAgICAgICAgICB7Y29kZTogJ0NyZWRlbnRpYWxzRXJyb3InLCBtZXNzYWdlOiAnTWlzc2luZyBjcmVkZW50aWFscyBpbiBjb25maWcnfSk7CiAgICAgICAgICB9CiAgICAgICAgICBkb25lKCk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1ZBTElEQVRFX1JFR0lPTicsICd2YWxpZGF0ZScsIGZ1bmN0aW9uIFZBTElEQVRFX1JFR0lPTihyZXEpIHsKICAgICAgICBpZiAoIXJlcS5zZXJ2aWNlLmNvbmZpZy5yZWdpb24gJiYgIXJlcS5zZXJ2aWNlLmlzR2xvYmFsRW5kcG9pbnQpIHsKICAgICAgICAgIHJlcS5yZXNwb25zZS5lcnJvciA9IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAgICB7Y29kZTogJ0NvbmZpZ0Vycm9yJywgbWVzc2FnZTogJ01pc3NpbmcgcmVnaW9uIGluIGNvbmZpZyd9KTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0JVSUxEX0lERU1QT1RFTkNZX1RPS0VOUycsICd2YWxpZGF0ZScsIGZ1bmN0aW9uIEJVSUxEX0lERU1QT1RFTkNZX1RPS0VOUyhyZXEpIHsKICAgICAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgICAgICBpZiAoIW9wZXJhdGlvbikgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgaWRlbXBvdGVudE1lbWJlcnMgPSBvcGVyYXRpb24uaWRlbXBvdGVudE1lbWJlcnM7CiAgICAgICAgaWYgKCFpZGVtcG90ZW50TWVtYmVycy5sZW5ndGgpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgLy8gY3JlYXRlcyBhIGNvcHkgb2YgcGFyYW1zIHNvIHVzZXIncyBwYXJhbSBvYmplY3QgaXNuJ3QgbXV0YXRlZAogICAgICAgIHZhciBwYXJhbXMgPSBBV1MudXRpbC5jb3B5KHJlcS5wYXJhbXMpOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gaWRlbXBvdGVudE1lbWJlcnMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICBpZiAoIXBhcmFtc1tpZGVtcG90ZW50TWVtYmVyc1tpXV0pIHsKICAgICAgICAgICAgLy8gYWRkIHRoZSBtZW1iZXIKICAgICAgICAgICAgcGFyYW1zW2lkZW1wb3RlbnRNZW1iZXJzW2ldXSA9IEFXUy51dGlsLnV1aWQudjQoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVxLnBhcmFtcyA9IHBhcmFtczsKICAgICAgfSk7CiAgCiAgICAgIGFkZCgnVkFMSURBVEVfUEFSQU1FVEVSUycsICd2YWxpZGF0ZScsIGZ1bmN0aW9uIFZBTElEQVRFX1BBUkFNRVRFUlMocmVxKSB7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgcnVsZXMgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dDsKICAgICAgICB2YXIgdmFsaWRhdGlvbiA9IHJlcS5zZXJ2aWNlLmNvbmZpZy5wYXJhbVZhbGlkYXRpb247CiAgICAgICAgbmV3IEFXUy5QYXJhbVZhbGlkYXRvcih2YWxpZGF0aW9uKS52YWxpZGF0ZShydWxlcywgcmVxLnBhcmFtcyk7CiAgICAgIH0pOwogIAogICAgICBhZGRBc3luYygnQ09NUFVURV9TSEEyNTYnLCAnYWZ0ZXJCdWlsZCcsIGZ1bmN0aW9uIENPTVBVVEVfU0hBMjU2KHJlcSwgZG9uZSkgewogICAgICAgIHJlcS5oYWx0SGFuZGxlcnNPbkVycm9yKCk7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICAgICAgdmFyIGF1dGh0eXBlID0gb3BlcmF0aW9uID8gb3BlcmF0aW9uLmF1dGh0eXBlIDogJyc7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkuc2lnbmF0dXJlVmVyc2lvbiAmJiAhYXV0aHR5cGUgJiYgIXJlcS5zZXJ2aWNlLmNvbmZpZy5zaWduYXR1cmVWZXJzaW9uKSByZXR1cm4gZG9uZSgpOyAvLyBub25lCiAgICAgICAgaWYgKHJlcS5zZXJ2aWNlLmdldFNpZ25lckNsYXNzKHJlcSkgPT09IEFXUy5TaWduZXJzLlY0KSB7CiAgICAgICAgICB2YXIgYm9keSA9IHJlcS5odHRwUmVxdWVzdC5ib2R5IHx8ICcnOwogICAgICAgICAgaWYgKGF1dGh0eXBlLmluZGV4T2YoJ3Vuc2lnbmVkLWJvZHknKSA+PSAwKSB7CiAgICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1Db250ZW50LVNoYTI1NiddID0gJ1VOU0lHTkVELVBBWUxPQUQnOwogICAgICAgICAgICByZXR1cm4gZG9uZSgpOwogICAgICAgICAgfQogICAgICAgICAgQVdTLnV0aWwuY29tcHV0ZVNoYTI1Nihib2R5LCBmdW5jdGlvbihlcnIsIHNoYSkgewogICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgZG9uZShlcnIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1Db250ZW50LVNoYTI1NiddID0gc2hhOwogICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRvbmUoKTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1NFVF9DT05URU5UX0xFTkdUSCcsICdhZnRlckJ1aWxkJywgZnVuY3Rpb24gU0VUX0NPTlRFTlRfTEVOR1RIKHJlcSkgewogICAgICAgIHZhciBhdXRodHlwZSA9IGdldE9wZXJhdGlvbkF1dGh0eXBlKHJlcSk7CiAgICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBBV1MudXRpbC5nZXRSZXF1ZXN0UGF5bG9hZFNoYXBlKHJlcSk7CiAgICAgICAgaWYgKHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LUxlbmd0aCddID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBsZW5ndGggPSBBV1MudXRpbC5zdHJpbmcuYnl0ZUxlbmd0aChyZXEuaHR0cFJlcXVlc3QuYm9keSk7CiAgICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LUxlbmd0aCddID0gbGVuZ3RoOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGlmIChwYXlsb2FkTWVtYmVyICYmIHBheWxvYWRNZW1iZXIuaXNTdHJlYW1pbmcpIHsKICAgICAgICAgICAgICBpZiAocGF5bG9hZE1lbWJlci5yZXF1aXJlc0xlbmd0aCkgewogICAgICAgICAgICAgICAgLy9zdHJlYW1pbmcgcGF5bG9hZCByZXF1aXJlcyBsZW5ndGgoczMsIGdsYWNpZXIpCiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChhdXRodHlwZS5pbmRleE9mKCd1bnNpZ25lZC1ib2R5JykgPj0gMCkgewogICAgICAgICAgICAgICAgLy91bmJvdW5kZWQgc3RyZWFtaW5nIHBheWxvYWQobGV4LCBtZWRpYXN0b3JlKQogICAgICAgICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1RyYW5zZmVyLUVuY29kaW5nJ10gPSAnY2h1bmtlZCc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnU0VUX0hUVFBfSE9TVCcsICdhZnRlckJ1aWxkJywgZnVuY3Rpb24gU0VUX0hUVFBfSE9TVChyZXEpIHsKICAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snSG9zdCddID0gcmVxLmh0dHBSZXF1ZXN0LmVuZHBvaW50Lmhvc3Q7CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1JFU1RBUlQnLCAncmVzdGFydCcsIGZ1bmN0aW9uIFJFU1RBUlQoKSB7CiAgICAgICAgdmFyIGVyciA9IHRoaXMucmVzcG9uc2UuZXJyb3I7CiAgICAgICAgaWYgKCFlcnIgfHwgIWVyci5yZXRyeWFibGUpIHJldHVybjsKICAKICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0ID0gbmV3IEFXUy5IdHRwUmVxdWVzdCgKICAgICAgICAgIHRoaXMuc2VydmljZS5lbmRwb2ludCwKICAgICAgICAgIHRoaXMuc2VydmljZS5yZWdpb24KICAgICAgICApOwogIAogICAgICAgIGlmICh0aGlzLnJlc3BvbnNlLnJldHJ5Q291bnQgPCB0aGlzLnNlcnZpY2UuY29uZmlnLm1heFJldHJpZXMpIHsKICAgICAgICAgIHRoaXMucmVzcG9uc2UucmV0cnlDb3VudCsrOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnJlc3BvbnNlLmVycm9yID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICB2YXIgYWRkVG9IZWFkID0gdHJ1ZTsKICAgICAgYWRkQXN5bmMoJ0RJU0NPVkVSX0VORFBPSU5UJywgJ3NpZ24nLCBESVNDT1ZFUl9FTkRQT0lOVCwgYWRkVG9IZWFkKTsKICAKICAgICAgYWRkQXN5bmMoJ1NJR04nLCAnc2lnbicsIGZ1bmN0aW9uIFNJR04ocmVxLCBkb25lKSB7CiAgICAgICAgdmFyIHNlcnZpY2UgPSByZXEuc2VydmljZTsKICAgICAgICB2YXIgb3BlcmF0aW9ucyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zIHx8IHt9OwogICAgICAgIHZhciBvcGVyYXRpb24gPSBvcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgICAgIHZhciBhdXRodHlwZSA9IG9wZXJhdGlvbiA/IG9wZXJhdGlvbi5hdXRodHlwZSA6ICcnOwogICAgICAgIGlmICghc2VydmljZS5hcGkuc2lnbmF0dXJlVmVyc2lvbiAmJiAhYXV0aHR5cGUgJiYgIXNlcnZpY2UuY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIHJldHVybiBkb25lKCk7IC8vIG5vbmUKICAKICAgICAgICBzZXJ2aWNlLmNvbmZpZy5nZXRDcmVkZW50aWFscyhmdW5jdGlvbiAoZXJyLCBjcmVkZW50aWFscykgewogICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICByZXEucmVzcG9uc2UuZXJyb3IgPSBlcnI7CiAgICAgICAgICAgIHJldHVybiBkb25lKCk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgZGF0ZSA9IHNlcnZpY2UuZ2V0U2tld0NvcnJlY3RlZERhdGUoKTsKICAgICAgICAgICAgdmFyIFNpZ25lckNsYXNzID0gc2VydmljZS5nZXRTaWduZXJDbGFzcyhyZXEpOwogICAgICAgICAgICB2YXIgc2lnbmVyID0gbmV3IFNpZ25lckNsYXNzKHJlcS5odHRwUmVxdWVzdCwKICAgICAgICAgICAgICBzZXJ2aWNlLmFwaS5zaWduaW5nTmFtZSB8fCBzZXJ2aWNlLmFwaS5lbmRwb2ludFByZWZpeCwKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzaWduYXR1cmVDYWNoZTogc2VydmljZS5jb25maWcuc2lnbmF0dXJlQ2FjaGUsCiAgICAgICAgICAgICAgICBvcGVyYXRpb246IG9wZXJhdGlvbiwKICAgICAgICAgICAgICAgIHNpZ25hdHVyZVZlcnNpb246IHNlcnZpY2UuYXBpLnNpZ25hdHVyZVZlcnNpb24KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgc2lnbmVyLnNldFNlcnZpY2VDbGllbnRJZChzZXJ2aWNlLl9jbGllbnRJZCk7CiAgCiAgICAgICAgICAgIC8vIGNsZWFyIG9sZCBhdXRob3JpemF0aW9uIGhlYWRlcnMKICAgICAgICAgICAgZGVsZXRlIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydBdXRob3JpemF0aW9uJ107CiAgICAgICAgICAgIGRlbGV0ZSByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snRGF0ZSddOwogICAgICAgICAgICBkZWxldGUgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXTsKICAKICAgICAgICAgICAgLy8gYWRkIG5ldyBhdXRob3JpemF0aW9uCiAgICAgICAgICAgIHNpZ25lci5hZGRBdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRlKTsKICAgICAgICAgICAgcmVxLnNpZ25lZEF0ID0gZGF0ZTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmVxLnJlc3BvbnNlLmVycm9yID0gZTsKICAgICAgICAgIH0KICAgICAgICAgIGRvbmUoKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgCiAgICAgIGFkZCgnVkFMSURBVEVfUkVTUE9OU0UnLCAndmFsaWRhdGVSZXNwb25zZScsIGZ1bmN0aW9uIFZBTElEQVRFX1JFU1BPTlNFKHJlc3ApIHsKICAgICAgICBpZiAodGhpcy5zZXJ2aWNlLnN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwLCB0aGlzKSkgewogICAgICAgICAgcmVzcC5kYXRhID0ge307CiAgICAgICAgICByZXNwLmVycm9yID0gbnVsbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzcC5kYXRhID0gbnVsbDsKICAgICAgICAgIHJlc3AuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgICAge2NvZGU6ICdVbmtub3duRXJyb3InLCBtZXNzYWdlOiAnQW4gdW5rbm93biBlcnJvciBvY2N1cnJlZC4nfSk7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkQXN5bmMoJ1NFTkQnLCAnc2VuZCcsIGZ1bmN0aW9uIFNFTkQocmVzcCwgZG9uZSkgewogICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLl9hYm9ydENhbGxiYWNrID0gZG9uZTsKICAgICAgICByZXNwLmVycm9yID0gbnVsbDsKICAgICAgICByZXNwLmRhdGEgPSBudWxsOwogIAogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKGh0dHBSZXNwKSB7CiAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5zdHJlYW0gPSBodHRwUmVzcDsKICAgICAgICAgIHZhciBzdHJlYW0gPSByZXNwLnJlcXVlc3QuaHR0cFJlcXVlc3Quc3RyZWFtOwogICAgICAgICAgdmFyIHNlcnZpY2UgPSByZXNwLnJlcXVlc3Quc2VydmljZTsKICAgICAgICAgIHZhciBhcGkgPSBzZXJ2aWNlLmFwaTsKICAgICAgICAgIHZhciBvcGVyYXRpb25OYW1lID0gcmVzcC5yZXF1ZXN0Lm9wZXJhdGlvbjsKICAgICAgICAgIHZhciBvcGVyYXRpb24gPSBhcGkub3BlcmF0aW9uc1tvcGVyYXRpb25OYW1lXSB8fCB7fTsKICAKICAgICAgICAgIGh0dHBSZXNwLm9uKCdoZWFkZXJzJywgZnVuY3Rpb24gb25IZWFkZXJzKHN0YXR1c0NvZGUsIGhlYWRlcnMsIHN0YXR1c01lc3NhZ2UpIHsKICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoCiAgICAgICAgICAgICAgJ2h0dHBIZWFkZXJzJywKICAgICAgICAgICAgICBbc3RhdHVzQ29kZSwgaGVhZGVycywgcmVzcCwgc3RhdHVzTWVzc2FnZV0KICAgICAgICAgICAgKTsKICAKICAgICAgICAgICAgaWYgKCFyZXNwLmh0dHBSZXNwb25zZS5zdHJlYW1pbmcpIHsKICAgICAgICAgICAgICBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIpIHsgLy8gc3RyZWFtczIgQVBJIGNoZWNrCiAgICAgICAgICAgICAgICAvLyBpZiB3ZSBkZXRlY3QgZXZlbnQgc3RyZWFtcywgd2UncmUgZ29pbmcgdG8gaGF2ZSB0bwogICAgICAgICAgICAgICAgLy8gcmV0dXJuIHRoZSBzdHJlYW0gaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIGlmIChvcGVyYXRpb24uaGFzRXZlbnRPdXRwdXQgJiYgc2VydmljZS5zdWNjZXNzZnVsUmVzcG9uc2UocmVzcCkpIHsKICAgICAgICAgICAgICAgICAgLy8gc2tpcCByZWFkaW5nIHRoZSBJbmNvbWluZ1N0cmVhbQogICAgICAgICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERvbmUnKTsKICAgICAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgCiAgICAgICAgICAgICAgICBodHRwUmVzcC5vbigncmVhZGFibGUnLCBmdW5jdGlvbiBvblJlYWRhYmxlKCkgewogICAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IGh0dHBSZXNwLnJlYWQoKTsKICAgICAgICAgICAgICAgICAgaWYgKGRhdGEgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERhdGEnLCBbZGF0YSwgcmVzcF0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBsZWdhY3kgc3RyZWFtcyBBUEkKICAgICAgICAgICAgICAgIGh0dHBSZXNwLm9uKCdkYXRhJywgZnVuY3Rpb24gb25EYXRhKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEYXRhJywgW2RhdGEsIHJlc3BdKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgCiAgICAgICAgICBodHRwUmVzcC5vbignZW5kJywgZnVuY3Rpb24gb25FbmQoKSB7CiAgICAgICAgICAgIGlmICghc3RyZWFtIHx8ICFzdHJlYW0uZGlkQ2FsbGJhY2spIHsKICAgICAgICAgICAgICBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIgJiYgKG9wZXJhdGlvbi5oYXNFdmVudE91dHB1dCAmJiBzZXJ2aWNlLnN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwKSkpIHsKICAgICAgICAgICAgICAgIC8vIGRvbid0IGNvbmNhdGVuYXRlIHJlc3BvbnNlIGNodW5rcyB3aGVuIHN0cmVhbWluZyBldmVudCBzdHJlYW0gZGF0YSB3aGVuIHJlc3BvbnNlIGlzIHN1Y2Nlc3NmdWwKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEb25lJyk7CiAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgCiAgICAgICAgZnVuY3Rpb24gcHJvZ3Jlc3MoaHR0cFJlc3ApIHsKICAgICAgICAgIGh0dHBSZXNwLm9uKCdzZW5kUHJvZ3Jlc3MnLCBmdW5jdGlvbiBvblNlbmRQcm9ncmVzcyh2YWx1ZSkgewogICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cFVwbG9hZFByb2dyZXNzJywgW3ZhbHVlLCByZXNwXSk7CiAgICAgICAgICB9KTsKICAKICAgICAgICAgIGh0dHBSZXNwLm9uKCdyZWNlaXZlUHJvZ3Jlc3MnLCBmdW5jdGlvbiBvblJlY2VpdmVQcm9ncmVzcyh2YWx1ZSkgewogICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERvd25sb2FkUHJvZ3Jlc3MnLCBbdmFsdWUsIHJlc3BdKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAKICAgICAgICBmdW5jdGlvbiBlcnJvcihlcnIpIHsKICAgICAgICAgIGlmIChlcnIuY29kZSAhPT0gJ1JlcXVlc3RBYm9ydGVkRXJyb3InKSB7CiAgICAgICAgICAgIHZhciBlcnJDb2RlID0gZXJyLmNvZGUgPT09ICdUaW1lb3V0RXJyb3InID8gZXJyLmNvZGUgOiAnTmV0d29ya2luZ0Vycm9yJzsKICAgICAgICAgICAgZXJyID0gQVdTLnV0aWwuZXJyb3IoZXJyLCB7CiAgICAgICAgICAgICAgY29kZTogZXJyQ29kZSwKICAgICAgICAgICAgICByZWdpb246IHJlc3AucmVxdWVzdC5odHRwUmVxdWVzdC5yZWdpb24sCiAgICAgICAgICAgICAgaG9zdG5hbWU6IHJlc3AucmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludC5ob3N0bmFtZSwKICAgICAgICAgICAgICByZXRyeWFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXNwLmVycm9yID0gZXJyOwogICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBFcnJvcicsIFtyZXNwLmVycm9yLCByZXNwXSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAKICAgICAgICBmdW5jdGlvbiBleGVjdXRlU2VuZCgpIHsKICAgICAgICAgIHZhciBodHRwID0gQVdTLkh0dHBDbGllbnQuZ2V0SW5zdGFuY2UoKTsKICAgICAgICAgIHZhciBodHRwT3B0aW9ucyA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5odHRwT3B0aW9ucyB8fCB7fTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBzdHJlYW0gPSBodHRwLmhhbmRsZVJlcXVlc3QocmVzcC5yZXF1ZXN0Lmh0dHBSZXF1ZXN0LCBodHRwT3B0aW9ucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaywgZXJyb3IpOwogICAgICAgICAgICBwcm9ncmVzcyhzdHJlYW0pOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGVycm9yKGVycik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB0aW1lRGlmZiA9IChyZXNwLnJlcXVlc3Quc2VydmljZS5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpIC0gdGhpcy5zaWduZWRBdCkgLyAxMDAwOwogICAgICAgIGlmICh0aW1lRGlmZiA+PSA2MCAqIDEwKSB7IC8vIGlmIHdlIHNpZ25lZCAxMG1pbiBhZ28sIHJlLXNpZ24KICAgICAgICAgIHRoaXMuZW1pdCgnc2lnbicsIFt0aGlzXSwgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgIGlmIChlcnIpIGRvbmUoZXJyKTsKICAgICAgICAgICAgZWxzZSBleGVjdXRlU2VuZCgpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGV4ZWN1dGVTZW5kKCk7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdIVFRQX0hFQURFUlMnLCAnaHR0cEhlYWRlcnMnLAogICAgICAgICAgZnVuY3Rpb24gSFRUUF9IRUFERVJTKHN0YXR1c0NvZGUsIGhlYWRlcnMsIHJlc3AsIHN0YXR1c01lc3NhZ2UpIHsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlID0gc3RhdHVzQ29kZTsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNNZXNzYWdlID0gc3RhdHVzTWVzc2FnZTsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzID0gaGVhZGVyczsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5ib2R5ID0gQVdTLnV0aWwuYnVmZmVyLnRvQnVmZmVyKCcnKTsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzID0gW107CiAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UubnVtQnl0ZXMgPSAwOwogICAgICAgIHZhciBkYXRlSGVhZGVyID0gaGVhZGVycy5kYXRlIHx8IGhlYWRlcnMuRGF0ZTsKICAgICAgICB2YXIgc2VydmljZSA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlOwogICAgICAgIGlmIChkYXRlSGVhZGVyKSB7CiAgICAgICAgICB2YXIgc2VydmVyVGltZSA9IERhdGUucGFyc2UoZGF0ZUhlYWRlcik7CiAgICAgICAgICBpZiAoc2VydmljZS5jb25maWcuY29ycmVjdENsb2NrU2tldwogICAgICAgICAgICAgICYmIHNlcnZpY2UuaXNDbG9ja1NrZXdlZChzZXJ2ZXJUaW1lKSkgewogICAgICAgICAgICBzZXJ2aWNlLmFwcGx5Q2xvY2tPZmZzZXQoc2VydmVyVGltZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdIVFRQX0RBVEEnLCAnaHR0cERhdGEnLCBmdW5jdGlvbiBIVFRQX0RBVEEoY2h1bmssIHJlc3ApIHsKICAgICAgICBpZiAoY2h1bmspIHsKICAgICAgICAgIGlmIChBV1MudXRpbC5pc05vZGUoKSkgewogICAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5udW1CeXRlcyArPSBjaHVuay5sZW5ndGg7CiAgCiAgICAgICAgICAgIHZhciB0b3RhbCA9IHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ2NvbnRlbnQtbGVuZ3RoJ107CiAgICAgICAgICAgIHZhciBwcm9ncmVzcyA9IHsgbG9hZGVkOiByZXNwLmh0dHBSZXNwb25zZS5udW1CeXRlcywgdG90YWw6IHRvdGFsIH07CiAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRG93bmxvYWRQcm9ncmVzcycsIFtwcm9ncmVzcywgcmVzcF0pOwogICAgICAgICAgfQogIAogICAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycy5wdXNoKEFXUy51dGlsLmJ1ZmZlci50b0J1ZmZlcihjaHVuaykpOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnSFRUUF9ET05FJywgJ2h0dHBEb25lJywgZnVuY3Rpb24gSFRUUF9ET05FKHJlc3ApIHsKICAgICAgICAvLyBjb252ZXJ0IGJ1ZmZlcnMgYXJyYXkgaW50byBzaW5nbGUgYnVmZmVyCiAgICAgICAgaWYgKHJlc3AuaHR0cFJlc3BvbnNlLmJ1ZmZlcnMgJiYgcmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICB2YXIgYm9keSA9IEFXUy51dGlsLmJ1ZmZlci5jb25jYXQocmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycyk7CiAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5ib2R5ID0gYm9keTsKICAgICAgICB9CiAgICAgICAgZGVsZXRlIHJlc3AuaHR0cFJlc3BvbnNlLm51bUJ5dGVzOwogICAgICAgIGRlbGV0ZSByZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzOwogICAgICB9KTsKICAKICAgICAgYWRkKCdGSU5BTElaRV9FUlJPUicsICdyZXRyeScsIGZ1bmN0aW9uIEZJTkFMSVpFX0VSUk9SKHJlc3ApIHsKICAgICAgICBpZiAocmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSkgewogICAgICAgICAgcmVzcC5lcnJvci5zdGF0dXNDb2RlID0gcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICAgIGlmIChyZXNwLmVycm9yLnJldHJ5YWJsZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gdGhpcy5zZXJ2aWNlLnJldHJ5YWJsZUVycm9yKHJlc3AuZXJyb3IsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnSU5WQUxJREFURV9DUkVERU5USUFMUycsICdyZXRyeScsIGZ1bmN0aW9uIElOVkFMSURBVEVfQ1JFREVOVElBTFMocmVzcCkgewogICAgICAgIGlmICghcmVzcC5lcnJvcikgcmV0dXJuOwogICAgICAgIHN3aXRjaCAocmVzcC5lcnJvci5jb2RlKSB7CiAgICAgICAgICBjYXNlICdSZXF1ZXN0RXhwaXJlZCc6IC8vIEVDMiBvbmx5CiAgICAgICAgICBjYXNlICdFeHBpcmVkVG9rZW5FeGNlcHRpb24nOgogICAgICAgICAgY2FzZSAnRXhwaXJlZFRva2VuJzoKICAgICAgICAgICAgcmVzcC5lcnJvci5yZXRyeWFibGUgPSB0cnVlOwogICAgICAgICAgICByZXNwLnJlcXVlc3Quc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMuZXhwaXJlZCA9IHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdFWFBJUkVEX1NJR05BVFVSRScsICdyZXRyeScsIGZ1bmN0aW9uIEVYUElSRURfU0lHTkFUVVJFKHJlc3ApIHsKICAgICAgICB2YXIgZXJyID0gcmVzcC5lcnJvcjsKICAgICAgICBpZiAoIWVycikgcmV0dXJuOwogICAgICAgIGlmICh0eXBlb2YgZXJyLmNvZGUgPT09ICdzdHJpbmcnICYmIHR5cGVvZiBlcnIubWVzc2FnZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGlmIChlcnIuY29kZS5tYXRjaCgvU2lnbmF0dXJlLykgJiYgZXJyLm1lc3NhZ2UubWF0Y2goL2V4cGlyZWQvKSkgewogICAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdDTE9DS19TS0VXRUQnLCAncmV0cnknLCBmdW5jdGlvbiBDTE9DS19TS0VXRUQocmVzcCkgewogICAgICAgIGlmICghcmVzcC5lcnJvcikgcmV0dXJuOwogICAgICAgIGlmICh0aGlzLnNlcnZpY2UuY2xvY2tTa2V3RXJyb3IocmVzcC5lcnJvcikKICAgICAgICAgICAgJiYgdGhpcy5zZXJ2aWNlLmNvbmZpZy5jb3JyZWN0Q2xvY2tTa2V3KSB7CiAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdSRURJUkVDVCcsICdyZXRyeScsIGZ1bmN0aW9uIFJFRElSRUNUKHJlc3ApIHsKICAgICAgICBpZiAocmVzcC5lcnJvciAmJiByZXNwLmVycm9yLnN0YXR1c0NvZGUgPj0gMzAwICYmCiAgICAgICAgICAgIHJlc3AuZXJyb3Iuc3RhdHVzQ29kZSA8IDQwMCAmJiByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWydsb2NhdGlvbiddKSB7CiAgICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0LmVuZHBvaW50ID0KICAgICAgICAgICAgbmV3IEFXUy5FbmRwb2ludChyZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWydsb2NhdGlvbiddKTsKICAgICAgICAgIHRoaXMuaHR0cFJlcXVlc3QuaGVhZGVyc1snSG9zdCddID0gdGhpcy5odHRwUmVxdWVzdC5lbmRwb2ludC5ob3N0OwogICAgICAgICAgcmVzcC5lcnJvci5yZWRpcmVjdCA9IHRydWU7CiAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdSRVRSWV9DSEVDSycsICdyZXRyeScsIGZ1bmN0aW9uIFJFVFJZX0NIRUNLKHJlc3ApIHsKICAgICAgICBpZiAocmVzcC5lcnJvcikgewogICAgICAgICAgaWYgKHJlc3AuZXJyb3IucmVkaXJlY3QgJiYgcmVzcC5yZWRpcmVjdENvdW50IDwgcmVzcC5tYXhSZWRpcmVjdHMpIHsKICAgICAgICAgICAgcmVzcC5lcnJvci5yZXRyeURlbGF5ID0gMDsKICAgICAgICAgIH0gZWxzZSBpZiAocmVzcC5yZXRyeUNvdW50IDwgcmVzcC5tYXhSZXRyaWVzKSB7CiAgICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlEZWxheSA9IHRoaXMuc2VydmljZS5yZXRyeURlbGF5cyhyZXNwLnJldHJ5Q291bnQpIHx8IDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkQXN5bmMoJ1JFU0VUX1JFVFJZX1NUQVRFJywgJ2FmdGVyUmV0cnknLCBmdW5jdGlvbiBSRVNFVF9SRVRSWV9TVEFURShyZXNwLCBkb25lKSB7CiAgICAgICAgdmFyIGRlbGF5LCB3aWxsUmV0cnkgPSBmYWxzZTsKICAKICAgICAgICBpZiAocmVzcC5lcnJvcikgewogICAgICAgICAgZGVsYXkgPSByZXNwLmVycm9yLnJldHJ5RGVsYXkgfHwgMDsKICAgICAgICAgIGlmIChyZXNwLmVycm9yLnJldHJ5YWJsZSAmJiByZXNwLnJldHJ5Q291bnQgPCByZXNwLm1heFJldHJpZXMpIHsKICAgICAgICAgICAgcmVzcC5yZXRyeUNvdW50Kys7CiAgICAgICAgICAgIHdpbGxSZXRyeSA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3AuZXJyb3IucmVkaXJlY3QgJiYgcmVzcC5yZWRpcmVjdENvdW50IDwgcmVzcC5tYXhSZWRpcmVjdHMpIHsKICAgICAgICAgICAgcmVzcC5yZWRpcmVjdENvdW50Kys7CiAgICAgICAgICAgIHdpbGxSZXRyeSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogIAogICAgICAgIGlmICh3aWxsUmV0cnkpIHsKICAgICAgICAgIHJlc3AuZXJyb3IgPSBudWxsOwogICAgICAgICAgc2V0VGltZW91dChkb25lLCBkZWxheSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRvbmUoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSksCiAgCiAgICBDb3JlUG9zdDogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICBhZGQoJ0VYVFJBQ1RfUkVRVUVTVF9JRCcsICdleHRyYWN0RGF0YScsIEFXUy51dGlsLmV4dHJhY3RSZXF1ZXN0SWQpOwogICAgICBhZGQoJ0VYVFJBQ1RfUkVRVUVTVF9JRCcsICdleHRyYWN0RXJyb3InLCBBV1MudXRpbC5leHRyYWN0UmVxdWVzdElkKTsKICAKICAgICAgYWRkKCdFTk9URk9VTkRfRVJST1InLCAnaHR0cEVycm9yJywgZnVuY3Rpb24gRU5PVEZPVU5EX0VSUk9SKGVycikgewogICAgICAgIGlmIChlcnIuY29kZSA9PT0gJ05ldHdvcmtpbmdFcnJvcicgJiYgZXJyLmVycm5vID09PSAnRU5PVEZPVU5EJykgewogICAgICAgICAgdmFyIG1lc3NhZ2UgPSAnSW5hY2Nlc3NpYmxlIGhvc3Q6IGAnICsgZXJyLmhvc3RuYW1lICsKICAgICAgICAgICAgJ1wnLiBUaGlzIHNlcnZpY2UgbWF5IG5vdCBiZSBhdmFpbGFibGUgaW4gdGhlIGAnICsgZXJyLnJlZ2lvbiArCiAgICAgICAgICAgICdcJyByZWdpb24uJzsKICAgICAgICAgIHRoaXMucmVzcG9uc2UuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IobWVzc2FnZSksIHsKICAgICAgICAgICAgY29kZTogJ1Vua25vd25FbmRwb2ludCcsCiAgICAgICAgICAgIHJlZ2lvbjogZXJyLnJlZ2lvbiwKICAgICAgICAgICAgaG9zdG5hbWU6IGVyci5ob3N0bmFtZSwKICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlLAogICAgICAgICAgICBvcmlnaW5hbEVycm9yOiBlcnIKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KSwKICAKICAgIExvZ2dlcjogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICBhZGQoJ0xPR19SRVFVRVNUJywgJ2NvbXBsZXRlJywgZnVuY3Rpb24gTE9HX1JFUVVFU1QocmVzcCkgewogICAgICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICAgICAgdmFyIGxvZ2dlciA9IHJlcS5zZXJ2aWNlLmNvbmZpZy5sb2dnZXI7CiAgICAgICAgaWYgKCFsb2dnZXIpIHJldHVybjsKICAgICAgICBmdW5jdGlvbiBmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZSwgc2hhcGUpIHsKICAgICAgICAgIGlmICghc2hhcGUpIHsKICAgICAgICAgICAgcmV0dXJuIHNoYXBlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoIChpbnB1dFNoYXBlLnR5cGUpIHsKICAgICAgICAgICAgY2FzZSAnc3RydWN0dXJlJzoKICAgICAgICAgICAgICB2YXIgc3RydWN0ID0ge307CiAgICAgICAgICAgICAgQVdTLnV0aWwuZWFjaChzaGFwZSwgZnVuY3Rpb24oc3ViU2hhcGVOYW1lLCBzdWJTaGFwZSkgewogICAgICAgICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChpbnB1dFNoYXBlLm1lbWJlcnMsIHN1YlNoYXBlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgc3RydWN0W3N1YlNoYXBlTmFtZV0gPSBmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZS5tZW1iZXJzW3N1YlNoYXBlTmFtZV0sIHN1YlNoYXBlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHN0cnVjdFtzdWJTaGFwZU5hbWVdID0gc3ViU2hhcGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmV0dXJuIHN0cnVjdDsKICAgICAgICAgICAgY2FzZSAnbGlzdCc6CiAgICAgICAgICAgICAgdmFyIGxpc3QgPSBbXTsKICAgICAgICAgICAgICBBV1MudXRpbC5hcnJheUVhY2goc2hhcGUsIGZ1bmN0aW9uKHN1YlNoYXBlLCBpbmRleCkgewogICAgICAgICAgICAgICAgbGlzdC5wdXNoKGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLm1lbWJlciwgc3ViU2hhcGUpKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXR1cm4gbGlzdDsKICAgICAgICAgICAgY2FzZSAnbWFwJzoKICAgICAgICAgICAgICB2YXIgbWFwID0ge307CiAgICAgICAgICAgICAgQVdTLnV0aWwuZWFjaChzaGFwZSwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgbWFwW2tleV0gPSBmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZS52YWx1ZSwgdmFsdWUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybiBtYXA7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgaWYgKGlucHV0U2hhcGUuaXNTZW5zaXRpdmUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAnKioqU2Vuc2l0aXZlSW5mb3JtYXRpb24qKionOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2hhcGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAKICAgICAgICBmdW5jdGlvbiBidWlsZE1lc3NhZ2UoKSB7CiAgICAgICAgICB2YXIgdGltZSA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlLmdldFNrZXdDb3JyZWN0ZWREYXRlKCkuZ2V0VGltZSgpOwogICAgICAgICAgdmFyIGRlbHRhID0gKHRpbWUgLSByZXEuc3RhcnRUaW1lLmdldFRpbWUoKSkgLyAxMDAwOwogICAgICAgICAgdmFyIGFuc2kgPSBsb2dnZXIuaXNUVFkgPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICB2YXIgc3RhdHVzID0gcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICAgIHZhciBjZW5zb3JlZFBhcmFtcyA9IHJlcS5wYXJhbXM7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zICYmCiAgICAgICAgICAgICAgICByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXSAmJgogICAgICAgICAgICAgICAgcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQKICAgICAgICAgICkgewogICAgICAgICAgICB2YXIgaW5wdXRTaGFwZSA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmlucHV0OwogICAgICAgICAgICBjZW5zb3JlZFBhcmFtcyA9IGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLCByZXEucGFyYW1zKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwYXJhbXMgPSByZXF1aXJlKCd1dGlsJykuaW5zcGVjdChjZW5zb3JlZFBhcmFtcywgdHJ1ZSwgbnVsbCk7CiAgICAgICAgICB2YXIgbWVzc2FnZSA9ICcnOwogICAgICAgICAgaWYgKGFuc2kpIG1lc3NhZ2UgKz0gJ1x4MUJbMzNtJzsKICAgICAgICAgIG1lc3NhZ2UgKz0gJ1tBV1MgJyArIHJlcS5zZXJ2aWNlLnNlcnZpY2VJZGVudGlmaWVyICsgJyAnICsgc3RhdHVzOwogICAgICAgICAgbWVzc2FnZSArPSAnICcgKyBkZWx0YS50b1N0cmluZygpICsgJ3MgJyArIHJlc3AucmV0cnlDb3VudCArICcgcmV0cmllc10nOwogICAgICAgICAgaWYgKGFuc2kpIG1lc3NhZ2UgKz0gJ1x4MUJbMDsxbSc7CiAgICAgICAgICBtZXNzYWdlICs9ICcgJyArIEFXUy51dGlsLnN0cmluZy5sb3dlckZpcnN0KHJlcS5vcGVyYXRpb24pOwogICAgICAgICAgbWVzc2FnZSArPSAnKCcgKyBwYXJhbXMgKyAnKSc7CiAgICAgICAgICBpZiAoYW5zaSkgbWVzc2FnZSArPSAnXHgxQlswbSc7CiAgICAgICAgICByZXR1cm4gbWVzc2FnZTsKICAgICAgICB9CiAgCiAgICAgICAgdmFyIGxpbmUgPSBidWlsZE1lc3NhZ2UoKTsKICAgICAgICBpZiAodHlwZW9mIGxvZ2dlci5sb2cgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGxvZ2dlci5sb2cobGluZSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbG9nZ2VyLndyaXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBsb2dnZXIud3JpdGUobGluZSArICdcbicpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KSwKICAKICAgIEpzb246IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvanNvbicpOwogICAgICBhZGQoJ0JVSUxEJywgJ2J1aWxkJywgc3ZjLmJ1aWxkUmVxdWVzdCk7CiAgICAgIGFkZCgnRVhUUkFDVF9EQVRBJywgJ2V4dHJhY3REYXRhJywgc3ZjLmV4dHJhY3REYXRhKTsKICAgICAgYWRkKCdFWFRSQUNUX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIHN2Yy5leHRyYWN0RXJyb3IpOwogICAgfSksCiAgCiAgICBSZXN0OiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICAgIHZhciBzdmMgPSByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3QnKTsKICAgICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICAgIH0pLAogIAogICAgUmVzdEpzb246IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdF9qc29uJyk7CiAgICAgIGFkZCgnQlVJTEQnLCAnYnVpbGQnLCBzdmMuYnVpbGRSZXF1ZXN0KTsKICAgICAgYWRkKCdFWFRSQUNUX0RBVEEnLCAnZXh0cmFjdERhdGEnLCBzdmMuZXh0cmFjdERhdGEpOwogICAgICBhZGQoJ0VYVFJBQ1RfRVJST1InLCAnZXh0cmFjdEVycm9yJywgc3ZjLmV4dHJhY3RFcnJvcik7CiAgICB9KSwKICAKICAgIFJlc3RYbWw6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdF94bWwnKTsKICAgICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICAgIH0pLAogIAogICAgUXVlcnk6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvcXVlcnknKTsKICAgICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICAgIH0pCiAgfTsKICAKICB9LHsiLi9jb3JlIjoxOCwiLi9kaXNjb3Zlcl9lbmRwb2ludCI6MjYsIi4vcHJvdG9jb2wvanNvbiI6NDYsIi4vcHJvdG9jb2wvcXVlcnkiOjQ3LCIuL3Byb3RvY29sL3Jlc3QiOjQ4LCIuL3Byb3RvY29sL3Jlc3RfanNvbiI6NDksIi4vcHJvdG9jb2wvcmVzdF94bWwiOjUwLCIuL3NlcXVlbnRpYWxfZXhlY3V0b3IiOjU4LCJ1dGlsIjo5N31dLDM0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIAogIC8qKgogICAqIFRoZSBlbmRwb2ludCB0aGF0IGEgc2VydmljZSB3aWxsIHRhbGsgdG8sIGZvciBleGFtcGxlLAogICAqIGAnaHR0cHM6Ly9lYzIuYXAtc291dGhlYXN0LTEuYW1hem9uYXdzLmNvbSdgLiBJZgogICAqIHlvdSBuZWVkIHRvIG92ZXJyaWRlIGFuIGVuZHBvaW50IGZvciBhIHNlcnZpY2UsIHlvdSBjYW4KICAgKiBzZXQgdGhlIGVuZHBvaW50IG9uIGEgc2VydmljZSBieSBwYXNzaW5nIHRoZSBlbmRwb2ludAogICAqIG9iamVjdCB3aXRoIHRoZSBgZW5kcG9pbnRgIG9wdGlvbiBrZXk6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogdmFyIGVwID0gbmV3IEFXUy5FbmRwb2ludCgnYXdzcHJveHkuZXhhbXBsZS5jb20nKTsKICAgKiB2YXIgczMgPSBuZXcgQVdTLlMzKHtlbmRwb2ludDogZXB9KTsKICAgKiBzMy5zZXJ2aWNlLmVuZHBvaW50Lmhvc3RuYW1lID09ICdhd3Nwcm94eS5leGFtcGxlLmNvbScKICAgKiBgYGAKICAgKgogICAqIE5vdGUgdGhhdCBpZiB5b3UgZG8gbm90IHNwZWNpZnkgYSBwcm90b2NvbCwgdGhlIHByb3RvY29sIHdpbGwKICAgKiBiZSBzZWxlY3RlZCBiYXNlZCBvbiB5b3VyIGN1cnJlbnQge0FXUy5jb25maWd9IGNvbmZpZ3VyYXRpb24uCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBwcm90b2NvbAogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcHJvdG9jb2wgKGh0dHAgb3IgaHR0cHMpIG9mIHRoZSBlbmRwb2ludAogICAqICAgICBVUkwKICAgKiBAIWF0dHJpYnV0ZSBob3N0bmFtZQogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgaG9zdCBwb3J0aW9uIG9mIHRoZSBlbmRwb2ludCwgZS5nLiwKICAgKiAgICAgZXhhbXBsZS5jb20KICAgKiBAIWF0dHJpYnV0ZSBob3N0CiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBob3N0IHBvcnRpb24gb2YgdGhlIGVuZHBvaW50IGluY2x1ZGluZwogICAqICAgICB0aGUgcG9ydCwgZS5nLiwgZXhhbXBsZS5jb206ODAKICAgKiBAIWF0dHJpYnV0ZSBwb3J0CiAgICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgcG9ydCBvZiB0aGUgZW5kcG9pbnQKICAgKiBAIWF0dHJpYnV0ZSBocmVmCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBmdWxsIFVSTCBvZiB0aGUgZW5kcG9pbnQKICAgKi8KICBBV1MuRW5kcG9pbnQgPSBpbmhlcml0KHsKICAKICAgIC8qKgogICAgICogQG92ZXJsb2FkIEVuZHBvaW50KGVuZHBvaW50KQogICAgICogICBDb25zdHJ1Y3RzIGEgbmV3IGVuZHBvaW50IGdpdmVuIGFuIGVuZHBvaW50IFVSTC4gSWYgdGhlCiAgICAgKiAgIFVSTCBvbWl0cyBhIHByb3RvY29sIChodHRwIG9yIGh0dHBzKSwgdGhlIGRlZmF1bHQgcHJvdG9jb2wKICAgICAqICAgc2V0IGluIHRoZSBnbG9iYWwge0FXUy5jb25maWd9IHdpbGwgYmUgdXNlZC4KICAgICAqICAgQHBhcmFtIGVuZHBvaW50IFtTdHJpbmddIHRoZSBVUkwgdG8gY29uc3RydWN0IGFuIGVuZHBvaW50IGZyb20KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIEVuZHBvaW50KGVuZHBvaW50LCBjb25maWcpIHsKICAgICAgQVdTLnV0aWwuaGlkZVByb3BlcnRpZXModGhpcywgWydzbGFzaGVzJywgJ2F1dGgnLCAnaGFzaCcsICdzZWFyY2gnLCAncXVlcnknXSk7CiAgCiAgICAgIGlmICh0eXBlb2YgZW5kcG9pbnQgPT09ICd1bmRlZmluZWQnIHx8IGVuZHBvaW50ID09PSBudWxsKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGVuZHBvaW50OiAnICsgZW5kcG9pbnQpOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmRwb2ludCAhPT0gJ3N0cmluZycpIHsKICAgICAgICByZXR1cm4gQVdTLnV0aWwuY29weShlbmRwb2ludCk7CiAgICAgIH0KICAKICAgICAgaWYgKCFlbmRwb2ludC5tYXRjaCgvXmh0dHAvKSkgewogICAgICAgIHZhciB1c2VTU0wgPSBjb25maWcgJiYgY29uZmlnLnNzbEVuYWJsZWQgIT09IHVuZGVmaW5lZCA/CiAgICAgICAgICBjb25maWcuc3NsRW5hYmxlZCA6IEFXUy5jb25maWcuc3NsRW5hYmxlZDsKICAgICAgICBlbmRwb2ludCA9ICh1c2VTU0wgPyAnaHR0cHMnIDogJ2h0dHAnKSArICc6Ly8nICsgZW5kcG9pbnQ7CiAgICAgIH0KICAKICAgICAgQVdTLnV0aWwudXBkYXRlKHRoaXMsIEFXUy51dGlsLnVybFBhcnNlKGVuZHBvaW50KSk7CiAgCiAgICAgIC8vIEVuc3VyZSB0aGUgcG9ydCBwcm9wZXJ0eSBpcyBzZXQgYXMgYW4gaW50ZWdlcgogICAgICBpZiAodGhpcy5wb3J0KSB7CiAgICAgICAgdGhpcy5wb3J0ID0gcGFyc2VJbnQodGhpcy5wb3J0LCAxMCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5wb3J0ID0gdGhpcy5wcm90b2NvbCA9PT0gJ2h0dHBzOicgPyA0NDMgOiA4MDsKICAgICAgfQogICAgfQogIAogIH0pOwogIAogIC8qKgogICAqIFRoZSBsb3cgbGV2ZWwgSFRUUCByZXF1ZXN0IG9iamVjdCwgZW5jYXBzdWxhdGluZyBhbGwgSFRUUCBoZWFkZXIKICAgKiBhbmQgYm9keSBkYXRhIHNlbnQgYnkgYSBzZXJ2aWNlIHJlcXVlc3QuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBtZXRob2QKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIEhUVFAgbWV0aG9kIG9mIHRoZSByZXF1ZXN0CiAgICogQCFhdHRyaWJ1dGUgcGF0aAogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcGF0aCBwb3J0aW9uIG9mIHRoZSBVUkksIGUuZy4sCiAgICogICAgICIvbGlzdC8/c3RhcnQ9NSZudW09MTAiCiAgICogQCFhdHRyaWJ1dGUgaGVhZGVycwogICAqICAgQHJldHVybiBbbWFwPFN0cmluZyxTdHJpbmc+XQogICAqICAgICBhIG1hcCBvZiBoZWFkZXIga2V5cyBhbmQgdGhlaXIgcmVzcGVjdGl2ZSB2YWx1ZXMKICAgKiBAIWF0dHJpYnV0ZSBib2R5CiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSByZXF1ZXN0IGJvZHkgcGF5bG9hZAogICAqIEAhYXR0cmlidXRlIGVuZHBvaW50CiAgICogICBAcmV0dXJuIFtBV1MuRW5kcG9pbnRdIHRoZSBlbmRwb2ludCBmb3IgdGhlIHJlcXVlc3QKICAgKiBAIWF0dHJpYnV0ZSByZWdpb24KICAgKiAgIEBhcGkgcHJpdmF0ZQogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcmVnaW9uLCBmb3Igc2lnbmluZyBwdXJwb3NlcyBvbmx5LgogICAqLwogIEFXUy5IdHRwUmVxdWVzdCA9IGluaGVyaXQoewogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIEh0dHBSZXF1ZXN0KGVuZHBvaW50LCByZWdpb24pIHsKICAgICAgZW5kcG9pbnQgPSBuZXcgQVdTLkVuZHBvaW50KGVuZHBvaW50KTsKICAgICAgdGhpcy5tZXRob2QgPSAnUE9TVCc7CiAgICAgIHRoaXMucGF0aCA9IGVuZHBvaW50LnBhdGggfHwgJy8nOwogICAgICB0aGlzLmhlYWRlcnMgPSB7fTsKICAgICAgdGhpcy5ib2R5ID0gJyc7CiAgICAgIHRoaXMuZW5kcG9pbnQgPSBlbmRwb2ludDsKICAgICAgdGhpcy5yZWdpb24gPSByZWdpb247CiAgICAgIHRoaXMuX3VzZXJBZ2VudCA9ICcnOwogICAgICB0aGlzLnNldFVzZXJBZ2VudCgpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNldFVzZXJBZ2VudDogZnVuY3Rpb24gc2V0VXNlckFnZW50KCkgewogICAgICB0aGlzLl91c2VyQWdlbnQgPSB0aGlzLmhlYWRlcnNbdGhpcy5nZXRVc2VyQWdlbnRIZWFkZXJOYW1lKCldID0gQVdTLnV0aWwudXNlckFnZW50KCk7CiAgICB9LAogIAogICAgZ2V0VXNlckFnZW50SGVhZGVyTmFtZTogZnVuY3Rpb24gZ2V0VXNlckFnZW50SGVhZGVyTmFtZSgpIHsKICAgICAgdmFyIHByZWZpeCA9IEFXUy51dGlsLmlzQnJvd3NlcigpID8gJ1gtQW16LScgOiAnJzsKICAgICAgcmV0dXJuIHByZWZpeCArICdVc2VyLUFnZW50JzsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhcHBlbmRUb1VzZXJBZ2VudDogZnVuY3Rpb24gYXBwZW5kVG9Vc2VyQWdlbnQoYWdlbnRQYXJ0aWFsKSB7CiAgICAgIGlmICh0eXBlb2YgYWdlbnRQYXJ0aWFsID09PSAnc3RyaW5nJyAmJiBhZ2VudFBhcnRpYWwpIHsKICAgICAgICB0aGlzLl91c2VyQWdlbnQgKz0gJyAnICsgYWdlbnRQYXJ0aWFsOwogICAgICB9CiAgICAgIHRoaXMuaGVhZGVyc1t0aGlzLmdldFVzZXJBZ2VudEhlYWRlck5hbWUoKV0gPSB0aGlzLl91c2VyQWdlbnQ7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0VXNlckFnZW50OiBmdW5jdGlvbiBnZXRVc2VyQWdlbnQoKSB7CiAgICAgIHJldHVybiB0aGlzLl91c2VyQWdlbnQ7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtTdHJpbmddIHRoZSBwYXJ0IG9mIHRoZSB7cGF0aH0gZXhjbHVkaW5nIHRoZQogICAgICogICBxdWVyeSBzdHJpbmcKICAgICAqLwogICAgcGF0aG5hbWU6IGZ1bmN0aW9uIHBhdGhuYW1lKCkgewogICAgICByZXR1cm4gdGhpcy5wYXRoLnNwbGl0KCc/JywgMSlbMF07CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtTdHJpbmddIHRoZSBxdWVyeSBzdHJpbmcgcG9ydGlvbiBvZiB0aGUge3BhdGh9CiAgICAgKi8KICAgIHNlYXJjaDogZnVuY3Rpb24gc2VhcmNoKCkgewogICAgICB2YXIgcXVlcnkgPSB0aGlzLnBhdGguc3BsaXQoJz8nLCAyKVsxXTsKICAgICAgaWYgKHF1ZXJ5KSB7CiAgICAgICAgcXVlcnkgPSBBV1MudXRpbC5xdWVyeVN0cmluZ1BhcnNlKHF1ZXJ5KTsKICAgICAgICByZXR1cm4gQVdTLnV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhxdWVyeSk7CiAgICAgIH0KICAgICAgcmV0dXJuICcnOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKiB1cGRhdGUgaHR0cFJlcXVlc3QgZW5kcG9pbnQgd2l0aCBlbmRwb2ludCBzdHJpbmcKICAgICAqLwogICAgdXBkYXRlRW5kcG9pbnQ6IGZ1bmN0aW9uIHVwZGF0ZUVuZHBvaW50KGVuZHBvaW50U3RyKSB7CiAgICAgIHZhciBuZXdFbmRwb2ludCA9IG5ldyBBV1MuRW5kcG9pbnQoZW5kcG9pbnRTdHIpOwogICAgICB0aGlzLmVuZHBvaW50ID0gbmV3RW5kcG9pbnQ7CiAgICAgIHRoaXMucGF0aCA9IG5ld0VuZHBvaW50LnBhdGggfHwgJy8nOwogICAgfQogIH0pOwogIAogIC8qKgogICAqIFRoZSBsb3cgbGV2ZWwgSFRUUCByZXNwb25zZSBvYmplY3QsIGVuY2Fwc3VsYXRpbmcgYWxsIEhUVFAgaGVhZGVyCiAgICogYW5kIGJvZHkgZGF0YSByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAqCiAgICogQCFhdHRyaWJ1dGUgc3RhdHVzQ29kZQogICAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIEhUVFAgc3RhdHVzIGNvZGUgb2YgdGhlIHJlc3BvbnNlIChlLmcuLCAyMDAsIDQwNCkKICAgKiBAIWF0dHJpYnV0ZSBoZWFkZXJzCiAgICogICBAcmV0dXJuIFttYXA8U3RyaW5nLFN0cmluZz5dCiAgICogICAgICBhIG1hcCBvZiByZXNwb25zZSBoZWFkZXIga2V5cyBhbmQgdGhlaXIgcmVzcGVjdGl2ZSB2YWx1ZXMKICAgKiBAIWF0dHJpYnV0ZSBib2R5CiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSByZXNwb25zZSBib2R5IHBheWxvYWQKICAgKiBAIWF0dHJpYnV0ZSBbcl0gc3RyZWFtaW5nCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoaXMgcmVzcG9uc2UgaXMgYmVpbmcgc3RyZWFtZWQgYXQgYSBsb3ctbGV2ZWwuCiAgICogICAgIERlZmF1bHRzIHRvIGBmYWxzZWAgKGJ1ZmZlcmVkIHJlYWRzKS4gRG8gbm90IG1vZGlmeSB0aGlzIG1hbnVhbGx5LCB1c2UKICAgKiAgICAge2NyZWF0ZVVuYnVmZmVyZWRTdHJlYW19IHRvIGNvbnZlcnQgdGhlIHN0cmVhbSB0byB1bmJ1ZmZlcmVkIG1vZGUKICAgKiAgICAgaW5zdGVhZC4KICAgKi8KICBBV1MuSHR0cFJlc3BvbnNlID0gaW5oZXJpdCh7CiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gSHR0cFJlc3BvbnNlKCkgewogICAgICB0aGlzLnN0YXR1c0NvZGUgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuaGVhZGVycyA9IHt9OwogICAgICB0aGlzLmJvZHkgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuc3RyZWFtaW5nID0gZmFsc2U7CiAgICAgIHRoaXMuc3RyZWFtID0gbnVsbDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIERpc2FibGVzIGJ1ZmZlcmluZyBvbiB0aGUgSFRUUCByZXNwb25zZSBhbmQgcmV0dXJucyB0aGUgc3RyZWFtIGZvciByZWFkaW5nLgogICAgICogQHJldHVybiBbU3RyZWFtLCBYTUxIdHRwUmVxdWVzdCwgbnVsbF0gdGhlIHVuZGVybHlpbmcgc3RyZWFtIG9iamVjdC4KICAgICAqICAgVXNlIHRoaXMgb2JqZWN0IHRvIGRpcmVjdGx5IHJlYWQgZGF0YSBvZmYgb2YgdGhlIHN0cmVhbS4KICAgICAqIEBub3RlIFRoaXMgb2JqZWN0IGlzIG9ubHkgYXZhaWxhYmxlIGFmdGVyIHRoZSB7QVdTLlJlcXVlc3R+aHR0cEhlYWRlcnN9CiAgICAgKiAgIGV2ZW50IGhhcyBmaXJlZC4gVGhpcyBtZXRob2QgbXVzdCBiZSBjYWxsZWQgcHJpb3IgdG8KICAgICAqICAge0FXUy5SZXF1ZXN0fmh0dHBEYXRhfS4KICAgICAqIEBleGFtcGxlIFRha2luZyBjb250cm9sIG9mIGEgc3RyZWFtCiAgICAgKiAgIHJlcXVlc3Qub24oJ2h0dHBIZWFkZXJzJywgZnVuY3Rpb24oc3RhdHVzQ29kZSwgaGVhZGVycykgewogICAgICogICAgIGlmIChzdGF0dXNDb2RlIDwgMzAwKSB7CiAgICAgKiAgICAgICBpZiAoaGVhZGVycy5ldGFnID09PSAneHl6JykgewogICAgICogICAgICAgICAvLyBwaXBlIHRoZSBzdHJlYW0sIGRpc2FibGluZyBidWZmZXJpbmcKICAgICAqICAgICAgICAgdmFyIHN0cmVhbSA9IHRoaXMucmVzcG9uc2UuaHR0cFJlc3BvbnNlLmNyZWF0ZVVuYnVmZmVyZWRTdHJlYW0oKTsKICAgICAqICAgICAgICAgc3RyZWFtLnBpcGUocHJvY2Vzcy5zdGRvdXQpOwogICAgICogICAgICAgfSBlbHNlIHsgLy8gYWJvcnQgdGhpcyByZXF1ZXN0IGFuZCBzZXQgYSBiZXR0ZXIgZXJyb3IgbWVzc2FnZQogICAgICogICAgICAgICB0aGlzLmFib3J0KCk7CiAgICAgKiAgICAgICAgIHRoaXMucmVzcG9uc2UuZXJyb3IgPSBuZXcgRXJyb3IoJ0ludmFsaWQgRVRhZycpOwogICAgICogICAgICAgfQogICAgICogICAgIH0KICAgICAqICAgfSkuc2VuZChjb25zb2xlLmxvZyk7CiAgICAgKi8KICAgIGNyZWF0ZVVuYnVmZmVyZWRTdHJlYW06IGZ1bmN0aW9uIGNyZWF0ZVVuYnVmZmVyZWRTdHJlYW0oKSB7CiAgICAgIHRoaXMuc3RyZWFtaW5nID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXMuc3RyZWFtOwogICAgfQogIH0pOwogIAogIAogIEFXUy5IdHRwQ2xpZW50ID0gaW5oZXJpdCh7fSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLkh0dHBDbGllbnQuZ2V0SW5zdGFuY2UgPSBmdW5jdGlvbiBnZXRJbnN0YW5jZSgpIHsKICAgIGlmICh0aGlzLnNpbmdsZXRvbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHRoaXMuc2luZ2xldG9uID0gbmV3IHRoaXMoKTsKICAgIH0KICAgIHJldHVybiB0aGlzLnNpbmdsZXRvbjsKICB9OwogIAogIH0seyIuL2NvcmUiOjE4fV0sMzU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKICByZXF1aXJlKCcuLi9odHRwJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlhIUkNsaWVudCA9IEFXUy51dGlsLmluaGVyaXQoewogICAgaGFuZGxlUmVxdWVzdDogZnVuY3Rpb24gaGFuZGxlUmVxdWVzdChodHRwUmVxdWVzdCwgaHR0cE9wdGlvbnMsIGNhbGxiYWNrLCBlcnJDYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBlbmRwb2ludCA9IGh0dHBSZXF1ZXN0LmVuZHBvaW50OwogICAgICB2YXIgZW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTsKICAgICAgdmFyIGhyZWYgPSBlbmRwb2ludC5wcm90b2NvbCArICcvLycgKyBlbmRwb2ludC5ob3N0bmFtZTsKICAgICAgaWYgKGVuZHBvaW50LnBvcnQgIT09IDgwICYmIGVuZHBvaW50LnBvcnQgIT09IDQ0MykgewogICAgICAgIGhyZWYgKz0gJzonICsgZW5kcG9pbnQucG9ydDsKICAgICAgfQogICAgICBocmVmICs9IGh0dHBSZXF1ZXN0LnBhdGg7CiAgCiAgICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKSwgaGVhZGVyc0VtaXR0ZWQgPSBmYWxzZTsKICAgICAgaHR0cFJlcXVlc3Quc3RyZWFtID0geGhyOwogIAogICAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoeGhyLnN0YXR1cyA9PT0gMCkgcmV0dXJuOyAvLyAwIGNvZGUgaXMgaW52YWxpZAogICAgICAgIH0gY2F0Y2ggKGUpIHsgcmV0dXJuOyB9CiAgCiAgICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA+PSB0aGlzLkhFQURFUlNfUkVDRUlWRUQgJiYgIWhlYWRlcnNFbWl0dGVkKSB7CiAgICAgICAgICBlbWl0dGVyLnN0YXR1c0NvZGUgPSB4aHIuc3RhdHVzOwogICAgICAgICAgZW1pdHRlci5oZWFkZXJzID0gc2VsZi5wYXJzZUhlYWRlcnMoeGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpKTsKICAgICAgICAgIGVtaXR0ZXIuZW1pdCgKICAgICAgICAgICAgJ2hlYWRlcnMnLAogICAgICAgICAgICBlbWl0dGVyLnN0YXR1c0NvZGUsCiAgICAgICAgICAgIGVtaXR0ZXIuaGVhZGVycywKICAgICAgICAgICAgeGhyLnN0YXR1c1RleHQKICAgICAgICAgICk7CiAgICAgICAgICBoZWFkZXJzRW1pdHRlZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLnJlYWR5U3RhdGUgPT09IHRoaXMuRE9ORSkgewogICAgICAgICAgc2VsZi5maW5pc2hSZXF1ZXN0KHhociwgZW1pdHRlcik7CiAgICAgICAgfQogICAgICB9LCBmYWxzZSk7CiAgICAgIHhoci51cGxvYWQuYWRkRXZlbnRMaXN0ZW5lcigncHJvZ3Jlc3MnLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgZW1pdHRlci5lbWl0KCdzZW5kUHJvZ3Jlc3MnLCBldnQpOwogICAgICB9KTsKICAgICAgeGhyLmFkZEV2ZW50TGlzdGVuZXIoJ3Byb2dyZXNzJywgZnVuY3Rpb24gKGV2dCkgewogICAgICAgIGVtaXR0ZXIuZW1pdCgncmVjZWl2ZVByb2dyZXNzJywgZXZ0KTsKICAgICAgfSwgZmFsc2UpOwogICAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcigndGltZW91dCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICBlcnJDYWxsYmFjayhBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ1RpbWVvdXQnKSwge2NvZGU6ICdUaW1lb3V0RXJyb3InfSkpOwogICAgICB9LCBmYWxzZSk7CiAgICAgIHhoci5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIGZ1bmN0aW9uICgpIHsKICAgICAgICBlcnJDYWxsYmFjayhBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ05ldHdvcmsgRmFpbHVyZScpLCB7CiAgICAgICAgICBjb2RlOiAnTmV0d29ya2luZ0Vycm9yJwogICAgICAgIH0pKTsKICAgICAgfSwgZmFsc2UpOwogICAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcignYWJvcnQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgZXJyQ2FsbGJhY2soQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCdSZXF1ZXN0IGFib3J0ZWQnKSwgewogICAgICAgICAgY29kZTogJ1JlcXVlc3RBYm9ydGVkRXJyb3InCiAgICAgICAgfSkpOwogICAgICB9LCBmYWxzZSk7CiAgCiAgICAgIGNhbGxiYWNrKGVtaXR0ZXIpOwogICAgICB4aHIub3BlbihodHRwUmVxdWVzdC5tZXRob2QsIGhyZWYsIGh0dHBPcHRpb25zLnhockFzeW5jICE9PSBmYWxzZSk7CiAgICAgIEFXUy51dGlsLmVhY2goaHR0cFJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICBpZiAoa2V5ICE9PSAnQ29udGVudC1MZW5ndGgnICYmIGtleSAhPT0gJ1VzZXItQWdlbnQnICYmIGtleSAhPT0gJ0hvc3QnKSB7CiAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBpZiAoaHR0cE9wdGlvbnMudGltZW91dCAmJiBodHRwT3B0aW9ucy54aHJBc3luYyAhPT0gZmFsc2UpIHsKICAgICAgICB4aHIudGltZW91dCA9IGh0dHBPcHRpb25zLnRpbWVvdXQ7CiAgICAgIH0KICAKICAgICAgaWYgKGh0dHBPcHRpb25zLnhocldpdGhDcmVkZW50aWFscykgewogICAgICAgIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwogICAgICB9CiAgICAgIHRyeSB7IHhoci5yZXNwb25zZVR5cGUgPSAnYXJyYXlidWZmZXInOyB9IGNhdGNoIChlKSB7fQogIAogICAgICB0cnkgewogICAgICAgIGlmIChodHRwUmVxdWVzdC5ib2R5KSB7CiAgICAgICAgICB4aHIuc2VuZChodHRwUmVxdWVzdC5ib2R5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgeGhyLnNlbmQoKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGlmIChodHRwUmVxdWVzdC5ib2R5ICYmIHR5cGVvZiBodHRwUmVxdWVzdC5ib2R5LmJ1ZmZlciA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgIHhoci5zZW5kKGh0dHBSZXF1ZXN0LmJvZHkuYnVmZmVyKTsgLy8gc2VuZCBBcnJheUJ1ZmZlciBkaXJlY3RseQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiBlbWl0dGVyOwogICAgfSwKICAKICAgIHBhcnNlSGVhZGVyczogZnVuY3Rpb24gcGFyc2VIZWFkZXJzKHJhd0hlYWRlcnMpIHsKICAgICAgdmFyIGhlYWRlcnMgPSB7fTsKICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHJhd0hlYWRlcnMuc3BsaXQoL1xyP1xuLyksIGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgICAgdmFyIGtleSA9IGxpbmUuc3BsaXQoJzonLCAxKVswXTsKICAgICAgICB2YXIgdmFsdWUgPSBsaW5lLnN1YnN0cmluZyhrZXkubGVuZ3RoICsgMik7CiAgICAgICAgaWYgKGtleS5sZW5ndGggPiAwKSBoZWFkZXJzW2tleS50b0xvd2VyQ2FzZSgpXSA9IHZhbHVlOwogICAgICB9KTsKICAgICAgcmV0dXJuIGhlYWRlcnM7CiAgICB9LAogIAogICAgZmluaXNoUmVxdWVzdDogZnVuY3Rpb24gZmluaXNoUmVxdWVzdCh4aHIsIGVtaXR0ZXIpIHsKICAgICAgdmFyIGJ1ZmZlcjsKICAgICAgaWYgKHhoci5yZXNwb25zZVR5cGUgPT09ICdhcnJheWJ1ZmZlcicgJiYgeGhyLnJlc3BvbnNlKSB7CiAgICAgICAgdmFyIGFiID0geGhyLnJlc3BvbnNlOwogICAgICAgIGJ1ZmZlciA9IG5ldyBBV1MudXRpbC5CdWZmZXIoYWIuYnl0ZUxlbmd0aCk7CiAgICAgICAgdmFyIHZpZXcgPSBuZXcgVWludDhBcnJheShhYik7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBidWZmZXIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGJ1ZmZlcltpXSA9IHZpZXdbaV07CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHRyeSB7CiAgICAgICAgaWYgKCFidWZmZXIgJiYgdHlwZW9mIHhoci5yZXNwb25zZVRleHQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBidWZmZXIgPSBuZXcgQVdTLnV0aWwuQnVmZmVyKHhoci5yZXNwb25zZVRleHQpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkge30KICAKICAgICAgaWYgKGJ1ZmZlcikgZW1pdHRlci5lbWl0KCdkYXRhJywgYnVmZmVyKTsKICAgICAgZW1pdHRlci5lbWl0KCdlbmQnKTsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuSHR0cENsaWVudC5wcm90b3R5cGUgPSBBV1MuWEhSQ2xpZW50LnByb3RvdHlwZTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9IDE7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuLi9odHRwIjozNCwiZXZlbnRzIjo4MX1dLDM2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICAKICBmdW5jdGlvbiBKc29uQnVpbGRlcigpIHsgfQogIAogIEpzb25CdWlsZGVyLnByb3RvdHlwZS5idWlsZCA9IGZ1bmN0aW9uKHZhbHVlLCBzaGFwZSkgewogICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUpKTsKICB9OwogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUpIHsKICAgIGlmICghc2hhcGUgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAKICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICBjYXNlICdzdHJ1Y3R1cmUnOiByZXR1cm4gdHJhbnNsYXRlU3RydWN0dXJlKHZhbHVlLCBzaGFwZSk7CiAgICAgIGNhc2UgJ21hcCc6IHJldHVybiB0cmFuc2xhdGVNYXAodmFsdWUsIHNoYXBlKTsKICAgICAgY2FzZSAnbGlzdCc6IHJldHVybiB0cmFuc2xhdGVMaXN0KHZhbHVlLCBzaGFwZSk7CiAgICAgIGRlZmF1bHQ6IHJldHVybiB0cmFuc2xhdGVTY2FsYXIodmFsdWUsIHNoYXBlKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlU3RydWN0dXJlKHN0cnVjdHVyZSwgc2hhcGUpIHsKICAgIHZhciBzdHJ1Y3QgPSB7fTsKICAgIHV0aWwuZWFjaChzdHJ1Y3R1cmUsIGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgIHZhciBtZW1iZXJTaGFwZSA9IHNoYXBlLm1lbWJlcnNbbmFtZV07CiAgICAgIGlmIChtZW1iZXJTaGFwZSkgewogICAgICAgIGlmIChtZW1iZXJTaGFwZS5sb2NhdGlvbiAhPT0gJ2JvZHknKSByZXR1cm47CiAgICAgICAgdmFyIGxvY2F0aW9uTmFtZSA9IG1lbWJlclNoYXBlLmlzTG9jYXRpb25OYW1lID8gbWVtYmVyU2hhcGUubmFtZSA6IG5hbWU7CiAgICAgICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgbWVtYmVyU2hhcGUpOwogICAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgc3RydWN0W2xvY2F0aW9uTmFtZV0gPSByZXN1bHQ7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHN0cnVjdDsKICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlTGlzdChsaXN0LCBzaGFwZSkgewogICAgdmFyIG91dCA9IFtdOwogICAgdXRpbC5hcnJheUVhY2gobGlzdCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUubWVtYmVyKTsKICAgICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSBvdXQucHVzaChyZXN1bHQpOwogICAgfSk7CiAgICByZXR1cm4gb3V0OwogIH0KICAKICBmdW5jdGlvbiB0cmFuc2xhdGVNYXAobWFwLCBzaGFwZSkgewogICAgdmFyIG91dCA9IHt9OwogICAgdXRpbC5lYWNoKG1hcCwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZS52YWx1ZSk7CiAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgb3V0W2tleV0gPSByZXN1bHQ7CiAgICB9KTsKICAgIHJldHVybiBvdXQ7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZVNjYWxhcih2YWx1ZSwgc2hhcGUpIHsKICAgIHJldHVybiBzaGFwZS50b1dpcmVGb3JtYXQodmFsdWUpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEpzb25CdWlsZGVyOwogIAogIH0seyIuLi91dGlsIjo3MX1dLDM3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICAKICBmdW5jdGlvbiBKc29uUGFyc2VyKCkgeyB9CiAgCiAgSnNvblBhcnNlci5wcm90b3R5cGUucGFyc2UgPSBmdW5jdGlvbih2YWx1ZSwgc2hhcGUpIHsKICAgIHJldHVybiB0cmFuc2xhdGUoSlNPTi5wYXJzZSh2YWx1ZSksIHNoYXBlKTsKICB9OwogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUpIHsKICAgIGlmICghc2hhcGUgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHVuZGVmaW5lZDsKICAKICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICBjYXNlICdzdHJ1Y3R1cmUnOiByZXR1cm4gdHJhbnNsYXRlU3RydWN0dXJlKHZhbHVlLCBzaGFwZSk7CiAgICAgIGNhc2UgJ21hcCc6IHJldHVybiB0cmFuc2xhdGVNYXAodmFsdWUsIHNoYXBlKTsKICAgICAgY2FzZSAnbGlzdCc6IHJldHVybiB0cmFuc2xhdGVMaXN0KHZhbHVlLCBzaGFwZSk7CiAgICAgIGRlZmF1bHQ6IHJldHVybiB0cmFuc2xhdGVTY2FsYXIodmFsdWUsIHNoYXBlKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlU3RydWN0dXJlKHN0cnVjdHVyZSwgc2hhcGUpIHsKICAgIGlmIChzdHJ1Y3R1cmUgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAKICAgIHZhciBzdHJ1Y3QgPSB7fTsKICAgIHZhciBzaGFwZU1lbWJlcnMgPSBzaGFwZS5tZW1iZXJzOwogICAgdXRpbC5lYWNoKHNoYXBlTWVtYmVycywgZnVuY3Rpb24obmFtZSwgbWVtYmVyU2hhcGUpIHsKICAgICAgdmFyIGxvY2F0aW9uTmFtZSA9IG1lbWJlclNoYXBlLmlzTG9jYXRpb25OYW1lID8gbWVtYmVyU2hhcGUubmFtZSA6IG5hbWU7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc3RydWN0dXJlLCBsb2NhdGlvbk5hbWUpKSB7CiAgICAgICAgdmFyIHZhbHVlID0gc3RydWN0dXJlW2xvY2F0aW9uTmFtZV07CiAgICAgICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgbWVtYmVyU2hhcGUpOwogICAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgc3RydWN0W25hbWVdID0gcmVzdWx0OwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBzdHJ1Y3Q7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZUxpc3QobGlzdCwgc2hhcGUpIHsKICAgIGlmIChsaXN0ID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgCiAgICB2YXIgb3V0ID0gW107CiAgICB1dGlsLmFycmF5RWFjaChsaXN0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZS5tZW1iZXIpOwogICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIG91dC5wdXNoKG51bGwpOwogICAgICBlbHNlIG91dC5wdXNoKHJlc3VsdCk7CiAgICB9KTsKICAgIHJldHVybiBvdXQ7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZU1hcChtYXAsIHNoYXBlKSB7CiAgICBpZiAobWFwID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgCiAgICB2YXIgb3V0ID0ge307CiAgICB1dGlsLmVhY2gobWFwLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIHZhciByZXN1bHQgPSB0cmFuc2xhdGUodmFsdWUsIHNoYXBlLnZhbHVlKTsKICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSBvdXRba2V5XSA9IG51bGw7CiAgICAgIGVsc2Ugb3V0W2tleV0gPSByZXN1bHQ7CiAgICB9KTsKICAgIHJldHVybiBvdXQ7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZVNjYWxhcih2YWx1ZSwgc2hhcGUpIHsKICAgIHJldHVybiBzaGFwZS50b1R5cGUodmFsdWUpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEpzb25QYXJzZXI7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxfV0sMzg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBDb2xsZWN0aW9uID0gcmVxdWlyZSgnLi9jb2xsZWN0aW9uJyk7CiAgdmFyIE9wZXJhdGlvbiA9IHJlcXVpcmUoJy4vb3BlcmF0aW9uJyk7CiAgdmFyIFNoYXBlID0gcmVxdWlyZSgnLi9zaGFwZScpOwogIHZhciBQYWdpbmF0b3IgPSByZXF1aXJlKCcuL3BhZ2luYXRvcicpOwogIHZhciBSZXNvdXJjZVdhaXRlciA9IHJlcXVpcmUoJy4vcmVzb3VyY2Vfd2FpdGVyJyk7CiAgCiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIHByb3BlcnR5ID0gdXRpbC5wcm9wZXJ0eTsKICB2YXIgbWVtb2l6ZWRQcm9wZXJ0eSA9IHV0aWwubWVtb2l6ZWRQcm9wZXJ0eTsKICAKICBmdW5jdGlvbiBBcGkoYXBpLCBvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBhcGkgPSBhcGkgfHwge307CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIG9wdGlvbnMuYXBpID0gdGhpczsKICAKICAgIGFwaS5tZXRhZGF0YSA9IGFwaS5tZXRhZGF0YSB8fCB7fTsKICAKICAgIHByb3BlcnR5KHRoaXMsICdpc0FwaScsIHRydWUsIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdhcGlWZXJzaW9uJywgYXBpLm1ldGFkYXRhLmFwaVZlcnNpb24pOwogICAgcHJvcGVydHkodGhpcywgJ2VuZHBvaW50UHJlZml4JywgYXBpLm1ldGFkYXRhLmVuZHBvaW50UHJlZml4KTsKICAgIHByb3BlcnR5KHRoaXMsICdzaWduaW5nTmFtZScsIGFwaS5tZXRhZGF0YS5zaWduaW5nTmFtZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZ2xvYmFsRW5kcG9pbnQnLCBhcGkubWV0YWRhdGEuZ2xvYmFsRW5kcG9pbnQpOwogICAgcHJvcGVydHkodGhpcywgJ3NpZ25hdHVyZVZlcnNpb24nLCBhcGkubWV0YWRhdGEuc2lnbmF0dXJlVmVyc2lvbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnanNvblZlcnNpb24nLCBhcGkubWV0YWRhdGEuanNvblZlcnNpb24pOwogICAgcHJvcGVydHkodGhpcywgJ3RhcmdldFByZWZpeCcsIGFwaS5tZXRhZGF0YS50YXJnZXRQcmVmaXgpOwogICAgcHJvcGVydHkodGhpcywgJ3Byb3RvY29sJywgYXBpLm1ldGFkYXRhLnByb3RvY29sKTsKICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCBhcGkubWV0YWRhdGEudGltZXN0YW1wRm9ybWF0KTsKICAgIHByb3BlcnR5KHRoaXMsICd4bWxOYW1lc3BhY2VVcmknLCBhcGkubWV0YWRhdGEueG1sTmFtZXNwYWNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdhYmJyZXZpYXRpb24nLCBhcGkubWV0YWRhdGEuc2VydmljZUFiYnJldmlhdGlvbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZnVsbE5hbWUnLCBhcGkubWV0YWRhdGEuc2VydmljZUZ1bGxOYW1lKTsKICAgIHByb3BlcnR5KHRoaXMsICdzZXJ2aWNlSWQnLCBhcGkubWV0YWRhdGEuc2VydmljZUlkKTsKICAKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2NsYXNzTmFtZScsIGZ1bmN0aW9uKCkgewogICAgICB2YXIgbmFtZSA9IGFwaS5tZXRhZGF0YS5zZXJ2aWNlQWJicmV2aWF0aW9uIHx8IGFwaS5tZXRhZGF0YS5zZXJ2aWNlRnVsbE5hbWU7CiAgICAgIGlmICghbmFtZSkgcmV0dXJuIG51bGw7CiAgCiAgICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UoL15BbWF6b258QVdTXHMqfFwoLip8XHMrfFxXKy9nLCAnJyk7CiAgICAgIGlmIChuYW1lID09PSAnRWxhc3RpY0xvYWRCYWxhbmNpbmcnKSBuYW1lID0gJ0VMQic7CiAgICAgIHJldHVybiBuYW1lOwogICAgfSk7CiAgCiAgICBmdW5jdGlvbiBhZGRFbmRwb2ludE9wZXJhdGlvbihuYW1lLCBvcGVyYXRpb24pIHsKICAgICAgaWYgKG9wZXJhdGlvbi5lbmRwb2ludG9wZXJhdGlvbiA9PT0gdHJ1ZSkgewogICAgICAgIHByb3BlcnR5KHNlbGYsICdlbmRwb2ludE9wZXJhdGlvbicsIHV0aWwuc3RyaW5nLmxvd2VyRmlyc3QobmFtZSkpOwogICAgICB9CiAgICB9CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAnb3BlcmF0aW9ucycsIG5ldyBDb2xsZWN0aW9uKGFwaS5vcGVyYXRpb25zLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCBvcGVyYXRpb24pIHsKICAgICAgcmV0dXJuIG5ldyBPcGVyYXRpb24obmFtZSwgb3BlcmF0aW9uLCBvcHRpb25zKTsKICAgIH0sIHV0aWwuc3RyaW5nLmxvd2VyRmlyc3QsIGFkZEVuZHBvaW50T3BlcmF0aW9uKSk7CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAnc2hhcGVzJywgbmV3IENvbGxlY3Rpb24oYXBpLnNoYXBlcywgb3B0aW9ucywgZnVuY3Rpb24obmFtZSwgc2hhcGUpIHsKICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShzaGFwZSwgb3B0aW9ucyk7CiAgICB9KSk7CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAncGFnaW5hdG9ycycsIG5ldyBDb2xsZWN0aW9uKGFwaS5wYWdpbmF0b3JzLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCBwYWdpbmF0b3IpIHsKICAgICAgcmV0dXJuIG5ldyBQYWdpbmF0b3IobmFtZSwgcGFnaW5hdG9yLCBvcHRpb25zKTsKICAgIH0pKTsKICAKICAgIHByb3BlcnR5KHRoaXMsICd3YWl0ZXJzJywgbmV3IENvbGxlY3Rpb24oYXBpLndhaXRlcnMsIG9wdGlvbnMsIGZ1bmN0aW9uKG5hbWUsIHdhaXRlcikgewogICAgICByZXR1cm4gbmV3IFJlc291cmNlV2FpdGVyKG5hbWUsIHdhaXRlciwgb3B0aW9ucyk7CiAgICB9LCB1dGlsLnN0cmluZy5sb3dlckZpcnN0KSk7CiAgCiAgICBpZiAob3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uJywgYXBpLmRvY3VtZW50YXRpb24pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAnZG9jdW1lbnRhdGlvblVybCcsIGFwaS5kb2N1bWVudGF0aW9uVXJsKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBcGk7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxLCIuL2NvbGxlY3Rpb24iOjM5LCIuL29wZXJhdGlvbiI6NDAsIi4vcGFnaW5hdG9yIjo0MSwiLi9yZXNvdXJjZV93YWl0ZXIiOjQyLCIuL3NoYXBlIjo0M31dLDM5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgbWVtb2l6ZWRQcm9wZXJ0eSA9IHJlcXVpcmUoJy4uL3V0aWwnKS5tZW1vaXplZFByb3BlcnR5OwogIAogIGZ1bmN0aW9uIG1lbW9pemUobmFtZSwgdmFsdWUsIGZhY3RvcnksIG5hbWVUcikgewogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCBuYW1lVHIobmFtZSksIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZmFjdG9yeShuYW1lLCB2YWx1ZSk7CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gQ29sbGVjdGlvbihpdGVyYWJsZSwgb3B0aW9ucywgZmFjdG9yeSwgbmFtZVRyLCBjYWxsYmFjaykgewogICAgbmFtZVRyID0gbmFtZVRyIHx8IFN0cmluZzsKICAgIHZhciBzZWxmID0gdGhpczsKICAKICAgIGZvciAodmFyIGlkIGluIGl0ZXJhYmxlKSB7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoaXRlcmFibGUsIGlkKSkgewogICAgICAgIG1lbW9pemUuY2FsbChzZWxmLCBpZCwgaXRlcmFibGVbaWRdLCBmYWN0b3J5LCBuYW1lVHIpOwogICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soaWQsIGl0ZXJhYmxlW2lkXSk7CiAgICAgIH0KICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBDb2xsZWN0aW9uOwogIAogIH0seyIuLi91dGlsIjo3MX1dLDQwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgU2hhcGUgPSByZXF1aXJlKCcuL3NoYXBlJyk7CiAgCiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIHByb3BlcnR5ID0gdXRpbC5wcm9wZXJ0eTsKICB2YXIgbWVtb2l6ZWRQcm9wZXJ0eSA9IHV0aWwubWVtb2l6ZWRQcm9wZXJ0eTsKICAKICBmdW5jdGlvbiBPcGVyYXRpb24obmFtZSwgb3BlcmF0aW9uLCBvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAKICAgIHByb3BlcnR5KHRoaXMsICduYW1lJywgb3BlcmF0aW9uLm5hbWUgfHwgbmFtZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnYXBpJywgb3B0aW9ucy5hcGksIGZhbHNlKTsKICAKICAgIG9wZXJhdGlvbi5odHRwID0gb3BlcmF0aW9uLmh0dHAgfHwge307CiAgICBwcm9wZXJ0eSh0aGlzLCAnZW5kcG9pbnQnLCBvcGVyYXRpb24uZW5kcG9pbnQpOwogICAgcHJvcGVydHkodGhpcywgJ2h0dHBNZXRob2QnLCBvcGVyYXRpb24uaHR0cC5tZXRob2QgfHwgJ1BPU1QnKTsKICAgIHByb3BlcnR5KHRoaXMsICdodHRwUGF0aCcsIG9wZXJhdGlvbi5odHRwLnJlcXVlc3RVcmkgfHwgJy8nKTsKICAgIHByb3BlcnR5KHRoaXMsICdhdXRodHlwZScsIG9wZXJhdGlvbi5hdXRodHlwZSB8fCAnJyk7CiAgICBwcm9wZXJ0eSgKICAgICAgdGhpcywKICAgICAgJ2VuZHBvaW50RGlzY292ZXJ5UmVxdWlyZWQnLAogICAgICBvcGVyYXRpb24uZW5kcG9pbnRkaXNjb3ZlcnkgPwogICAgICAgIChvcGVyYXRpb24uZW5kcG9pbnRkaXNjb3ZlcnkucmVxdWlyZWQgPyAnUkVRVUlSRUQnIDogJ09QVElPTkFMJykgOgogICAgICAnTlVMTCcKICAgICk7CiAgCiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdpbnB1dCcsIGZ1bmN0aW9uKCkgewogICAgICBpZiAoIW9wZXJhdGlvbi5pbnB1dCkgewogICAgICAgIHJldHVybiBuZXcgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RydWN0dXJlJ30sIG9wdGlvbnMpOwogICAgICB9CiAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUob3BlcmF0aW9uLmlucHV0LCBvcHRpb25zKTsKICAgIH0pOwogIAogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnb3V0cHV0JywgZnVuY3Rpb24oKSB7CiAgICAgIGlmICghb3BlcmF0aW9uLm91dHB1dCkgewogICAgICAgIHJldHVybiBuZXcgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RydWN0dXJlJ30sIG9wdGlvbnMpOwogICAgICB9CiAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUob3BlcmF0aW9uLm91dHB1dCwgb3B0aW9ucyk7CiAgICB9KTsKICAKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2Vycm9ycycsIGZ1bmN0aW9uKCkgewogICAgICB2YXIgbGlzdCA9IFtdOwogICAgICBpZiAoIW9wZXJhdGlvbi5lcnJvcnMpIHJldHVybiBudWxsOwogIAogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9wZXJhdGlvbi5lcnJvcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBsaXN0LnB1c2goU2hhcGUuY3JlYXRlKG9wZXJhdGlvbi5lcnJvcnNbaV0sIG9wdGlvbnMpKTsKICAgICAgfQogIAogICAgICByZXR1cm4gbGlzdDsKICAgIH0pOwogIAogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAncGFnaW5hdG9yJywgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBvcHRpb25zLmFwaS5wYWdpbmF0b3JzW25hbWVdOwogICAgfSk7CiAgCiAgICBpZiAob3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uJywgb3BlcmF0aW9uLmRvY3VtZW50YXRpb24pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAnZG9jdW1lbnRhdGlvblVybCcsIG9wZXJhdGlvbi5kb2N1bWVudGF0aW9uVXJsKTsKICAgIH0KICAKICAgIC8vIGlkZW1wb3RlbnRNZW1iZXJzIG9ubHkgdHJhY2tzIHRvcC1sZXZlbCBpbnB1dCBzaGFwZXMKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2lkZW1wb3RlbnRNZW1iZXJzJywgZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpZGVtcG90ZW50TWVtYmVycyA9IFtdOwogICAgICB2YXIgaW5wdXQgPSBzZWxmLmlucHV0OwogICAgICB2YXIgbWVtYmVycyA9IGlucHV0Lm1lbWJlcnM7CiAgICAgIGlmICghaW5wdXQubWVtYmVycykgewogICAgICAgIHJldHVybiBpZGVtcG90ZW50TWVtYmVyczsKICAgICAgfQogICAgICBmb3IgKHZhciBuYW1lIGluIG1lbWJlcnMpIHsKICAgICAgICBpZiAoIW1lbWJlcnMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBpZiAobWVtYmVyc1tuYW1lXS5pc0lkZW1wb3RlbnQgPT09IHRydWUpIHsKICAgICAgICAgIGlkZW1wb3RlbnRNZW1iZXJzLnB1c2gobmFtZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBpZGVtcG90ZW50TWVtYmVyczsKICAgIH0pOwogIAogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnaGFzRXZlbnRPdXRwdXQnLCBmdW5jdGlvbigpIHsKICAgICAgdmFyIG91dHB1dCA9IHNlbGYub3V0cHV0OwogICAgICByZXR1cm4gaGFzRXZlbnRTdHJlYW0ob3V0cHV0KTsKICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBoYXNFdmVudFN0cmVhbSh0b3BMZXZlbFNoYXBlKSB7CiAgICB2YXIgbWVtYmVycyA9IHRvcExldmVsU2hhcGUubWVtYmVyczsKICAgIHZhciBwYXlsb2FkID0gdG9wTGV2ZWxTaGFwZS5wYXlsb2FkOwogIAogICAgaWYgKCF0b3BMZXZlbFNoYXBlLm1lbWJlcnMpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIAogICAgaWYgKHBheWxvYWQpIHsKICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBtZW1iZXJzW3BheWxvYWRdOwogICAgICByZXR1cm4gcGF5bG9hZE1lbWJlci5pc0V2ZW50U3RyZWFtOwogICAgfQogIAogICAgLy8gY2hlY2sgaWYgYW55IG1lbWJlciBpcyBhbiBldmVudCBzdHJlYW0KICAgIGZvciAodmFyIG5hbWUgaW4gbWVtYmVycykgewogICAgICBpZiAoIW1lbWJlcnMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICBpZiAobWVtYmVyc1tuYW1lXS5pc0V2ZW50U3RyZWFtID09PSB0cnVlKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBPcGVyYXRpb247CiAgCiAgfSx7Ii4uL3V0aWwiOjcxLCIuL3NoYXBlIjo0M31dLDQxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgcHJvcGVydHkgPSByZXF1aXJlKCcuLi91dGlsJykucHJvcGVydHk7CiAgCiAgZnVuY3Rpb24gUGFnaW5hdG9yKG5hbWUsIHBhZ2luYXRvcikgewogICAgcHJvcGVydHkodGhpcywgJ2lucHV0VG9rZW4nLCBwYWdpbmF0b3IuaW5wdXRfdG9rZW4pOwogICAgcHJvcGVydHkodGhpcywgJ2xpbWl0S2V5JywgcGFnaW5hdG9yLmxpbWl0X2tleSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnbW9yZVJlc3VsdHMnLCBwYWdpbmF0b3IubW9yZV9yZXN1bHRzKTsKICAgIHByb3BlcnR5KHRoaXMsICdvdXRwdXRUb2tlbicsIHBhZ2luYXRvci5vdXRwdXRfdG9rZW4pOwogICAgcHJvcGVydHkodGhpcywgJ3Jlc3VsdEtleScsIHBhZ2luYXRvci5yZXN1bHRfa2V5KTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBQYWdpbmF0b3I7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxfV0sNDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBwcm9wZXJ0eSA9IHV0aWwucHJvcGVydHk7CiAgCiAgZnVuY3Rpb24gUmVzb3VyY2VXYWl0ZXIobmFtZSwgd2FpdGVyLCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHByb3BlcnR5KHRoaXMsICduYW1lJywgbmFtZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnYXBpJywgb3B0aW9ucy5hcGksIGZhbHNlKTsKICAKICAgIGlmICh3YWl0ZXIub3BlcmF0aW9uKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdvcGVyYXRpb24nLCB1dGlsLnN0cmluZy5sb3dlckZpcnN0KHdhaXRlci5vcGVyYXRpb24pKTsKICAgIH0KICAKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBrZXlzID0gWwogICAgICAndHlwZScsCiAgICAgICdkZXNjcmlwdGlvbicsCiAgICAgICdkZWxheScsCiAgICAgICdtYXhBdHRlbXB0cycsCiAgICAgICdhY2NlcHRvcnMnCiAgICBdOwogIAogICAga2V5cy5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgICB2YXIgdmFsdWUgPSB3YWl0ZXJba2V5XTsKICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgcHJvcGVydHkoc2VsZiwga2V5LCB2YWx1ZSk7CiAgICAgIH0KICAgIH0pOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IFJlc291cmNlV2FpdGVyOwogIAogIH0seyIuLi91dGlsIjo3MX1dLDQzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQ29sbGVjdGlvbiA9IHJlcXVpcmUoJy4vY29sbGVjdGlvbicpOwogIAogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIAogIGZ1bmN0aW9uIHByb3BlcnR5KG9iaiwgbmFtZSwgdmFsdWUpIHsKICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHV0aWwucHJvcGVydHkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gbWVtb2l6ZWRQcm9wZXJ0eShvYmosIG5hbWUpIHsKICAgIGlmICghb2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZVtuYW1lXSkgewogICAgICB1dGlsLm1lbW9pemVkUHJvcGVydHkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gU2hhcGUoc2hhcGUsIG9wdGlvbnMsIG1lbWJlck5hbWUpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIAogICAgcHJvcGVydHkodGhpcywgJ3NoYXBlJywgc2hhcGUuc2hhcGUpOwogICAgcHJvcGVydHkodGhpcywgJ2FwaScsIG9wdGlvbnMuYXBpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAndHlwZScsIHNoYXBlLnR5cGUpOwogICAgcHJvcGVydHkodGhpcywgJ2VudW0nLCBzaGFwZS5lbnVtKTsKICAgIHByb3BlcnR5KHRoaXMsICdtaW4nLCBzaGFwZS5taW4pOwogICAgcHJvcGVydHkodGhpcywgJ21heCcsIHNoYXBlLm1heCk7CiAgICBwcm9wZXJ0eSh0aGlzLCAncGF0dGVybicsIHNoYXBlLnBhdHRlcm4pOwogICAgcHJvcGVydHkodGhpcywgJ2xvY2F0aW9uJywgc2hhcGUubG9jYXRpb24gfHwgdGhpcy5sb2NhdGlvbiB8fCAnYm9keScpOwogICAgcHJvcGVydHkodGhpcywgJ25hbWUnLCB0aGlzLm5hbWUgfHwgc2hhcGUueG1sTmFtZSB8fCBzaGFwZS5xdWVyeU5hbWUgfHwKICAgICAgc2hhcGUubG9jYXRpb25OYW1lIHx8IG1lbWJlck5hbWUpOwogICAgcHJvcGVydHkodGhpcywgJ2lzU3RyZWFtaW5nJywgc2hhcGUuc3RyZWFtaW5nIHx8IHRoaXMuaXNTdHJlYW1pbmcgfHwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ3JlcXVpcmVzTGVuZ3RoJywgc2hhcGUucmVxdWlyZXNMZW5ndGgsIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0NvbXBvc2l0ZScsIHNoYXBlLmlzQ29tcG9zaXRlIHx8IGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc1NoYXBlJywgdHJ1ZSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzUXVlcnlOYW1lJywgQm9vbGVhbihzaGFwZS5xdWVyeU5hbWUpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNMb2NhdGlvbk5hbWUnLCBCb29sZWFuKHNoYXBlLmxvY2F0aW9uTmFtZSksIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0lkZW1wb3RlbnQnLCBzaGFwZS5pZGVtcG90ZW5jeVRva2VuID09PSB0cnVlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0pzb25WYWx1ZScsIHNoYXBlLmpzb252YWx1ZSA9PT0gdHJ1ZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNTZW5zaXRpdmUnLCBzaGFwZS5zZW5zaXRpdmUgPT09IHRydWUgfHwgc2hhcGUucHJvdG90eXBlICYmIHNoYXBlLnByb3RvdHlwZS5zZW5zaXRpdmUgPT09IHRydWUpOwogICAgcHJvcGVydHkodGhpcywgJ2lzRXZlbnRTdHJlYW0nLCBCb29sZWFuKHNoYXBlLmV2ZW50c3RyZWFtKSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzRXZlbnQnLCBCb29sZWFuKHNoYXBlLmV2ZW50KSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzRXZlbnRQYXlsb2FkJywgQm9vbGVhbihzaGFwZS5ldmVudHBheWxvYWQpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNFdmVudEhlYWRlcicsIEJvb2xlYW4oc2hhcGUuZXZlbnRoZWFkZXIpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNUaW1lc3RhbXBGb3JtYXRTZXQnLCBCb29sZWFuKHNoYXBlLnRpbWVzdGFtcEZvcm1hdCkgfHwgc2hhcGUucHJvdG90eXBlICYmIHNoYXBlLnByb3RvdHlwZS5pc1RpbWVzdGFtcEZvcm1hdFNldCA9PT0gdHJ1ZSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2VuZHBvaW50RGlzY292ZXJ5SWQnLCBCb29sZWFuKHNoYXBlLmVuZHBvaW50ZGlzY292ZXJ5aWQpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaG9zdExhYmVsJywgQm9vbGVhbihzaGFwZS5ob3N0TGFiZWwpLCBmYWxzZSk7CiAgCiAgICBpZiAob3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uJywgc2hhcGUuZG9jdW1lbnRhdGlvbik7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uVXJsJywgc2hhcGUuZG9jdW1lbnRhdGlvblVybCk7CiAgICB9CiAgCiAgICBpZiAoc2hhcGUueG1sQXR0cmlidXRlKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdpc1htbEF0dHJpYnV0ZScsIHNoYXBlLnhtbEF0dHJpYnV0ZSB8fCBmYWxzZSk7CiAgICB9CiAgCiAgICAvLyB0eXBlIGNvbnZlcnNpb24gYW5kIHBhcnNpbmcKICAgIHByb3BlcnR5KHRoaXMsICdkZWZhdWx0VmFsdWUnLCBudWxsKTsKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiAnJzsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfTsKICAgIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsgcmV0dXJuIHZhbHVlOyB9OwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBTaGFwZS5ub3JtYWxpemVkVHlwZXMgPSB7CiAgICBjaGFyYWN0ZXI6ICdzdHJpbmcnLAogICAgZG91YmxlOiAnZmxvYXQnLAogICAgbG9uZzogJ2ludGVnZXInLAogICAgc2hvcnQ6ICdpbnRlZ2VyJywKICAgIGJpZ2ludGVnZXI6ICdpbnRlZ2VyJywKICAgIGJpZ2RlY2ltYWw6ICdmbG9hdCcsCiAgICBibG9iOiAnYmluYXJ5JwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgU2hhcGUudHlwZXMgPSB7CiAgICAnc3RydWN0dXJlJzogU3RydWN0dXJlU2hhcGUsCiAgICAnbGlzdCc6IExpc3RTaGFwZSwKICAgICdtYXAnOiBNYXBTaGFwZSwKICAgICdib29sZWFuJzogQm9vbGVhblNoYXBlLAogICAgJ3RpbWVzdGFtcCc6IFRpbWVzdGFtcFNoYXBlLAogICAgJ2Zsb2F0JzogRmxvYXRTaGFwZSwKICAgICdpbnRlZ2VyJzogSW50ZWdlclNoYXBlLAogICAgJ3N0cmluZyc6IFN0cmluZ1NoYXBlLAogICAgJ2Jhc2U2NCc6IEJhc2U2NFNoYXBlLAogICAgJ2JpbmFyeSc6IEJpbmFyeVNoYXBlCiAgfTsKICAKICBTaGFwZS5yZXNvbHZlID0gZnVuY3Rpb24gcmVzb2x2ZShzaGFwZSwgb3B0aW9ucykgewogICAgaWYgKHNoYXBlLnNoYXBlKSB7CiAgICAgIHZhciByZWZTaGFwZSA9IG9wdGlvbnMuYXBpLnNoYXBlc1tzaGFwZS5zaGFwZV07CiAgICAgIGlmICghcmVmU2hhcGUpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBmaW5kIHNoYXBlIHJlZmVyZW5jZTogJyArIHNoYXBlLnNoYXBlKTsKICAgICAgfQogIAogICAgICByZXR1cm4gcmVmU2hhcGU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9OwogIAogIFNoYXBlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShzaGFwZSwgb3B0aW9ucywgbWVtYmVyTmFtZSkgewogICAgaWYgKHNoYXBlLmlzU2hhcGUpIHJldHVybiBzaGFwZTsKICAKICAgIHZhciByZWZTaGFwZSA9IFNoYXBlLnJlc29sdmUoc2hhcGUsIG9wdGlvbnMpOwogICAgaWYgKHJlZlNoYXBlKSB7CiAgICAgIHZhciBmaWx0ZXJlZEtleXMgPSBPYmplY3Qua2V5cyhzaGFwZSk7CiAgICAgIGlmICghb3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICAgICAgZmlsdGVyZWRLZXlzID0gZmlsdGVyZWRLZXlzLmZpbHRlcihmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICByZXR1cm4gIW5hbWUubWF0Y2goL2RvY3VtZW50YXRpb24vKTsKICAgICAgICB9KTsKICAgICAgfQogIAogICAgICAvLyBjcmVhdGUgYW4gaW5saW5lIHNoYXBlIHdpdGggZXh0cmEgbWVtYmVycwogICAgICB2YXIgSW5saW5lU2hhcGUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZWZTaGFwZS5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIHNoYXBlLCBvcHRpb25zLCBtZW1iZXJOYW1lKTsKICAgICAgfTsKICAgICAgSW5saW5lU2hhcGUucHJvdG90eXBlID0gcmVmU2hhcGU7CiAgICAgIHJldHVybiBuZXcgSW5saW5lU2hhcGUoKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHNldCB0eXBlIGlmIG5vdCBzZXQKICAgICAgaWYgKCFzaGFwZS50eXBlKSB7CiAgICAgICAgaWYgKHNoYXBlLm1lbWJlcnMpIHNoYXBlLnR5cGUgPSAnc3RydWN0dXJlJzsKICAgICAgICBlbHNlIGlmIChzaGFwZS5tZW1iZXIpIHNoYXBlLnR5cGUgPSAnbGlzdCc7CiAgICAgICAgZWxzZSBpZiAoc2hhcGUua2V5KSBzaGFwZS50eXBlID0gJ21hcCc7CiAgICAgICAgZWxzZSBzaGFwZS50eXBlID0gJ3N0cmluZyc7CiAgICAgIH0KICAKICAgICAgLy8gbm9ybWFsaXplIHR5cGVzCiAgICAgIHZhciBvcmlnVHlwZSA9IHNoYXBlLnR5cGU7CiAgICAgIGlmIChTaGFwZS5ub3JtYWxpemVkVHlwZXNbc2hhcGUudHlwZV0pIHsKICAgICAgICBzaGFwZS50eXBlID0gU2hhcGUubm9ybWFsaXplZFR5cGVzW3NoYXBlLnR5cGVdOwogICAgICB9CiAgCiAgICAgIGlmIChTaGFwZS50eXBlc1tzaGFwZS50eXBlXSkgewogICAgICAgIHJldHVybiBuZXcgU2hhcGUudHlwZXNbc2hhcGUudHlwZV0oc2hhcGUsIG9wdGlvbnMsIG1lbWJlck5hbWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5yZWNvZ25pemVkIHNoYXBlIHR5cGU6ICcgKyBvcmlnVHlwZSk7CiAgICAgIH0KICAgIH0KICB9OwogIAogIGZ1bmN0aW9uIENvbXBvc2l0ZVNoYXBlKHNoYXBlKSB7CiAgICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgcHJvcGVydHkodGhpcywgJ2lzQ29tcG9zaXRlJywgdHJ1ZSk7CiAgCiAgICBpZiAoc2hhcGUuZmxhdHRlbmVkKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdmbGF0dGVuZWQnLCBzaGFwZS5mbGF0dGVuZWQgfHwgZmFsc2UpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBTdHJ1Y3R1cmVTaGFwZShzaGFwZSwgb3B0aW9ucykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHJlcXVpcmVkTWFwID0gbnVsbCwgZmlyc3RJbml0ID0gIXRoaXMuaXNTaGFwZTsKICAKICAgIENvbXBvc2l0ZVNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICBpZiAoZmlyc3RJbml0KSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkZWZhdWx0VmFsdWUnLCBmdW5jdGlvbigpIHsgcmV0dXJuIHt9OyB9KTsKICAgICAgcHJvcGVydHkodGhpcywgJ21lbWJlcnMnLCB7fSk7CiAgICAgIHByb3BlcnR5KHRoaXMsICdtZW1iZXJOYW1lcycsIFtdKTsKICAgICAgcHJvcGVydHkodGhpcywgJ3JlcXVpcmVkJywgW10pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAnaXNSZXF1aXJlZCcsIGZ1bmN0aW9uKCkgeyByZXR1cm4gZmFsc2U7IH0pOwogICAgfQogIAogICAgaWYgKHNoYXBlLm1lbWJlcnMpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ21lbWJlcnMnLCBuZXcgQ29sbGVjdGlvbihzaGFwZS5tZW1iZXJzLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCBtZW1iZXIpIHsKICAgICAgICByZXR1cm4gU2hhcGUuY3JlYXRlKG1lbWJlciwgb3B0aW9ucywgbmFtZSk7CiAgICAgIH0pKTsKICAgICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnbWVtYmVyTmFtZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc2hhcGUueG1sT3JkZXIgfHwgT2JqZWN0LmtleXMoc2hhcGUubWVtYmVycyk7CiAgICAgIH0pOwogIAogICAgICBpZiAoc2hhcGUuZXZlbnQpIHsKICAgICAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdldmVudFBheWxvYWRNZW1iZXJOYW1lJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgbWVtYmVycyA9IHNlbGYubWVtYmVyczsKICAgICAgICAgIHZhciBtZW1iZXJOYW1lcyA9IHNlbGYubWVtYmVyTmFtZXM7CiAgICAgICAgICAvLyBpdGVyYXRlIG92ZXIgbWVtYmVycyB0byBmaW5kIG9uZXMgdGhhdCBhcmUgZXZlbnQgcGF5bG9hZHMKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gbWVtYmVyTmFtZXMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmIChtZW1iZXJzW21lbWJlck5hbWVzW2ldXS5pc0V2ZW50UGF5bG9hZCkgewogICAgICAgICAgICAgIHJldHVybiBtZW1iZXJOYW1lc1tpXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogIAogICAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2V2ZW50SGVhZGVyTWVtYmVyTmFtZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBtZW1iZXJzID0gc2VsZi5tZW1iZXJzOwogICAgICAgICAgdmFyIG1lbWJlck5hbWVzID0gc2VsZi5tZW1iZXJOYW1lczsKICAgICAgICAgIHZhciBldmVudEhlYWRlck1lbWJlck5hbWVzID0gW107CiAgICAgICAgICAvLyBpdGVyYXRlIG92ZXIgbWVtYmVycyB0byBmaW5kIG9uZXMgdGhhdCBhcmUgZXZlbnQgaGVhZGVycwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBtZW1iZXJOYW1lcy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgICAgaWYgKG1lbWJlcnNbbWVtYmVyTmFtZXNbaV1dLmlzRXZlbnRIZWFkZXIpIHsKICAgICAgICAgICAgICBldmVudEhlYWRlck1lbWJlck5hbWVzLnB1c2gobWVtYmVyTmFtZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZXZlbnRIZWFkZXJNZW1iZXJOYW1lczsKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIAogICAgaWYgKHNoYXBlLnJlcXVpcmVkKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdyZXF1aXJlZCcsIHNoYXBlLnJlcXVpcmVkKTsKICAgICAgcHJvcGVydHkodGhpcywgJ2lzUmVxdWlyZWQnLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgaWYgKCFyZXF1aXJlZE1hcCkgewogICAgICAgICAgcmVxdWlyZWRNYXAgPSB7fTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2hhcGUucmVxdWlyZWQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcmVxdWlyZWRNYXBbc2hhcGUucmVxdWlyZWRbaV1dID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgCiAgICAgICAgcmV0dXJuIHJlcXVpcmVkTWFwW25hbWVdOwogICAgICB9LCBmYWxzZSwgdHJ1ZSk7CiAgICB9CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAncmVzdWx0V3JhcHBlcicsIHNoYXBlLnJlc3VsdFdyYXBwZXIgfHwgbnVsbCk7CiAgCiAgICBpZiAoc2hhcGUucGF5bG9hZCkgewogICAgICBwcm9wZXJ0eSh0aGlzLCAncGF5bG9hZCcsIHNoYXBlLnBheWxvYWQpOwogICAgfQogIAogICAgaWYgKHR5cGVvZiBzaGFwZS54bWxOYW1lc3BhY2UgPT09ICdzdHJpbmcnKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd4bWxOYW1lc3BhY2VVcmknLCBzaGFwZS54bWxOYW1lc3BhY2UpOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygc2hhcGUueG1sTmFtZXNwYWNlID09PSAnb2JqZWN0JykgewogICAgICBwcm9wZXJ0eSh0aGlzLCAneG1sTmFtZXNwYWNlUHJlZml4Jywgc2hhcGUueG1sTmFtZXNwYWNlLnByZWZpeCk7CiAgICAgIHByb3BlcnR5KHRoaXMsICd4bWxOYW1lc3BhY2VVcmknLCBzaGFwZS54bWxOYW1lc3BhY2UudXJpKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gTGlzdFNoYXBlKHNoYXBlLCBvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXMsIGZpcnN0SW5pdCA9ICF0aGlzLmlzU2hhcGU7CiAgICBDb21wb3NpdGVTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgaWYgKGZpcnN0SW5pdCkgewogICAgICBwcm9wZXJ0eSh0aGlzLCAnZGVmYXVsdFZhbHVlJywgZnVuY3Rpb24oKSB7IHJldHVybiBbXTsgfSk7CiAgICB9CiAgCiAgICBpZiAoc2hhcGUubWVtYmVyKSB7CiAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ21lbWJlcicsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUoc2hhcGUubWVtYmVyLCBvcHRpb25zKTsKICAgICAgfSk7CiAgICB9CiAgCiAgICBpZiAodGhpcy5mbGF0dGVuZWQpIHsKICAgICAgdmFyIG9sZE5hbWUgPSB0aGlzLm5hbWU7CiAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ25hbWUnLCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc2VsZi5tZW1iZXIubmFtZSB8fCBvbGROYW1lOwogICAgICB9KTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gTWFwU2hhcGUoc2hhcGUsIG9wdGlvbnMpIHsKICAgIHZhciBmaXJzdEluaXQgPSAhdGhpcy5pc1NoYXBlOwogICAgQ29tcG9zaXRlU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAKICAgIGlmIChmaXJzdEluaXQpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ2RlZmF1bHRWYWx1ZScsIGZ1bmN0aW9uKCkgeyByZXR1cm4ge307IH0pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAna2V5JywgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RyaW5nJ30sIG9wdGlvbnMpKTsKICAgICAgcHJvcGVydHkodGhpcywgJ3ZhbHVlJywgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RyaW5nJ30sIG9wdGlvbnMpKTsKICAgIH0KICAKICAgIGlmIChzaGFwZS5rZXkpIHsKICAgICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAna2V5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShzaGFwZS5rZXksIG9wdGlvbnMpOwogICAgICB9KTsKICAgIH0KICAgIGlmIChzaGFwZS52YWx1ZSkgewogICAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICd2YWx1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUoc2hhcGUudmFsdWUsIG9wdGlvbnMpOwogICAgICB9KTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gVGltZXN0YW1wU2hhcGUoc2hhcGUpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICBpZiAoc2hhcGUudGltZXN0YW1wRm9ybWF0KSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCBzaGFwZS50aW1lc3RhbXBGb3JtYXQpOwogICAgfSBlbHNlIGlmIChzZWxmLmlzVGltZXN0YW1wRm9ybWF0U2V0ICYmIHRoaXMudGltZXN0YW1wRm9ybWF0KSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCB0aGlzLnRpbWVzdGFtcEZvcm1hdCk7CiAgICB9IGVsc2UgaWYgKHRoaXMubG9jYXRpb24gPT09ICdoZWFkZXInKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCAncmZjODIyJyk7CiAgICB9IGVsc2UgaWYgKHRoaXMubG9jYXRpb24gPT09ICdxdWVyeXN0cmluZycpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsICdpc284NjAxJyk7CiAgICB9IGVsc2UgaWYgKHRoaXMuYXBpKSB7CiAgICAgIHN3aXRjaCAodGhpcy5hcGkucHJvdG9jb2wpIHsKICAgICAgICBjYXNlICdqc29uJzoKICAgICAgICBjYXNlICdyZXN0LWpzb24nOgogICAgICAgICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsICd1bml4VGltZXN0YW1wJyk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdyZXN0LXhtbCc6CiAgICAgICAgY2FzZSAncXVlcnknOgogICAgICAgIGNhc2UgJ2VjMic6CiAgICAgICAgICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0JywgJ2lzbzg2MDEnKTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgCiAgICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZS50b1VUQ1N0cmluZyA9PT0gJ2Z1bmN0aW9uJykgcmV0dXJuIHZhbHVlOwogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInID8KICAgICAgICAgICAgIHV0aWwuZGF0ZS5wYXJzZVRpbWVzdGFtcCh2YWx1ZSkgOiBudWxsOwogICAgfTsKICAKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHV0aWwuZGF0ZS5mb3JtYXQodmFsdWUsIHNlbGYudGltZXN0YW1wRm9ybWF0KTsKICAgIH07CiAgfQogIAogIGZ1bmN0aW9uIFN0cmluZ1NoYXBlKCkgewogICAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAKICAgIHZhciBudWxsTGVzc1Byb3RvY29scyA9IFsncmVzdC14bWwnLCAncXVlcnknLCAnZWMyJ107CiAgICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhbHVlID0gdGhpcy5hcGkgJiYgbnVsbExlc3NQcm90b2NvbHMuaW5kZXhPZih0aGlzLmFwaS5wcm90b2NvbCkgPiAtMSA/CiAgICAgICAgdmFsdWUgfHwgJycgOiB2YWx1ZTsKICAgICAgaWYgKHRoaXMuaXNKc29uVmFsdWUpIHsKICAgICAgICByZXR1cm4gSlNPTi5wYXJzZSh2YWx1ZSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHZhbHVlICYmIHR5cGVvZiB2YWx1ZS50b1N0cmluZyA9PT0gJ2Z1bmN0aW9uJyA/CiAgICAgICAgdmFsdWUudG9TdHJpbmcoKSA6IHZhbHVlOwogICAgfTsKICAKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHRoaXMuaXNKc29uVmFsdWUgPyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgOiB2YWx1ZTsKICAgIH07CiAgfQogIAogIGZ1bmN0aW9uIEZsb2F0U2hhcGUoKSB7CiAgICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiBwYXJzZUZsb2F0KHZhbHVlKTsKICAgIH07CiAgICB0aGlzLnRvV2lyZUZvcm1hdCA9IHRoaXMudG9UeXBlOwogIH0KICAKICBmdW5jdGlvbiBJbnRlZ2VyU2hhcGUoKSB7CiAgICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiBwYXJzZUludCh2YWx1ZSwgMTApOwogICAgfTsKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gdGhpcy50b1R5cGU7CiAgfQogIAogIGZ1bmN0aW9uIEJpbmFyeVNoYXBlKCkgewogICAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIGJ1ZiA9IHV0aWwuYmFzZTY0LmRlY29kZSh2YWx1ZSk7CiAgICAgIGlmICh0aGlzLmlzU2Vuc2l0aXZlICYmIHV0aWwuaXNOb2RlKCkgJiYgdHlwZW9mIHV0aWwuQnVmZmVyLmFsbG9jID09PSAnZnVuY3Rpb24nKSB7CiAgICAvKiBOb2RlLmpzIGNhbiBjcmVhdGUgYSBCdWZmZXIgdGhhdCBpcyBub3QgaXNvbGF0ZWQuCiAgICAgKiBpLmUuIGJ1Zi5ieXRlTGVuZ3RoICE9PSBidWYuYnVmZmVyLmJ5dGVMZW5ndGgKICAgICAqIFRoaXMgbWVhbnMgdGhhdCB0aGUgc2Vuc2l0aXZlIGRhdGEgaXMgYWNjZXNzaWJsZSB0byBhbnlvbmUgd2l0aCBhY2Nlc3MgdG8gYnVmLmJ1ZmZlci4KICAgICAqIElmIHRoaXMgaXMgdGhlIG5vZGUgc2hhcmVkIEJ1ZmZlciwgdGhlbiBvdGhlciBjb2RlIHdpdGhpbiB0aGlzIHByb2Nlc3MgX2NvdWxkXyBmaW5kIHRoaXMgc2VjcmV0LgogICAgICogQ29weSBzZW5zaXRpdmUgZGF0YSB0byBhbiBpc29sYXRlZCBCdWZmZXIgYW5kIHplcm8gdGhlIHNlbnNpdGl2ZSBkYXRhLgogICAgICogV2hpbGUgdGhpcyBpcyBzYWZlIHRvIGRvIGhlcmUsIGNvcHlpbmcgdGhpcyBjb2RlIHNvbWV3aGVyZSBlbHNlIG1heSBwcm9kdWNlIHVuZXhwZWN0ZWQgcmVzdWx0cy4KICAgICAqLwogICAgICAgIHZhciBzZWN1cmVCdWYgPSB1dGlsLkJ1ZmZlci5hbGxvYyhidWYubGVuZ3RoLCBidWYpOwogICAgICAgIGJ1Zi5maWxsKDApOwogICAgICAgIGJ1ZiA9IHNlY3VyZUJ1ZjsKICAgICAgfQogICAgICByZXR1cm4gYnVmOwogICAgfTsKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gdXRpbC5iYXNlNjQuZW5jb2RlOwogIH0KICAKICBmdW5jdGlvbiBCYXNlNjRTaGFwZSgpIHsKICAgIEJpbmFyeVNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfQogIAogIGZ1bmN0aW9uIEJvb2xlYW5TaGFwZSgpIHsKICAgIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJykgcmV0dXJuIHZhbHVlOwogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiB2YWx1ZSA9PT0gJ3RydWUnOwogICAgfTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgU2hhcGUuc2hhcGVzID0gewogICAgU3RydWN0dXJlU2hhcGU6IFN0cnVjdHVyZVNoYXBlLAogICAgTGlzdFNoYXBlOiBMaXN0U2hhcGUsCiAgICBNYXBTaGFwZTogTWFwU2hhcGUsCiAgICBTdHJpbmdTaGFwZTogU3RyaW5nU2hhcGUsCiAgICBCb29sZWFuU2hhcGU6IEJvb2xlYW5TaGFwZSwKICAgIEJhc2U2NFNoYXBlOiBCYXNlNjRTaGFwZQogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBTaGFwZTsKICAKICB9LHsiLi4vdXRpbCI6NzEsIi4vY29sbGVjdGlvbiI6Mzl9XSw0NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5QYXJhbVZhbGlkYXRvciA9IEFXUy51dGlsLmluaGVyaXQoewogICAgLyoqCiAgICAgKiBDcmVhdGUgYSBuZXcgdmFsaWRhdG9yIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsaWRhdGlvbiBbQm9vbGVhbnxtYXBdIHdoZXRoZXIgaW5wdXQgcGFyYW1ldGVycyBzaG91bGQgYmUKICAgICAqICAgICB2YWxpZGF0ZWQgYWdhaW5zdCB0aGUgb3BlcmF0aW9uIGRlc2NyaXB0aW9uIGJlZm9yZSBzZW5kaW5nIHRoZQogICAgICogICAgIHJlcXVlc3QuIFBhc3MgYSBtYXAgdG8gZW5hYmxlIGFueSBvZiB0aGUgZm9sbG93aW5nIHNwZWNpZmljCiAgICAgKiAgICAgdmFsaWRhdGlvbiBmZWF0dXJlczoKICAgICAqCiAgICAgKiAgICAgKiAqKm1pbioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1pbgogICAgICogICAgICAgY29uc3RyYWludC4gVGhpcyBpcyBlbmFibGVkIGJ5IGRlZmF1bHQgd2hlbiBwYXJhbVZhbGlkYXRpb24gaXMgc2V0CiAgICAgKiAgICAgICB0byBgdHJ1ZWAuCiAgICAgKiAgICAgKiAqKm1heCoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1heAogICAgICogICAgICAgY29uc3RyYWludC4KICAgICAqICAgICAqICoqcGF0dGVybioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgYQogICAgICogICAgICAgcmVndWxhciBleHByZXNzaW9uLgogICAgICogICAgICogKiplbnVtKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBvbmUKICAgICAqICAgICAgIG9mIHRoZSBhbGxvd2FibGUgZW51bSB2YWx1ZXMuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBQYXJhbVZhbGlkYXRvcih2YWxpZGF0aW9uKSB7CiAgICAgIGlmICh2YWxpZGF0aW9uID09PSB0cnVlIHx8IHZhbGlkYXRpb24gPT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhbGlkYXRpb24gPSB7J21pbic6IHRydWV9OwogICAgICB9CiAgICAgIHRoaXMudmFsaWRhdGlvbiA9IHZhbGlkYXRpb247CiAgICB9LAogIAogICAgdmFsaWRhdGU6IGZ1bmN0aW9uIHZhbGlkYXRlKHNoYXBlLCBwYXJhbXMsIGNvbnRleHQpIHsKICAgICAgdGhpcy5lcnJvcnMgPSBbXTsKICAgICAgdGhpcy52YWxpZGF0ZU1lbWJlcihzaGFwZSwgcGFyYW1zIHx8IHt9LCBjb250ZXh0IHx8ICdwYXJhbXMnKTsKICAKICAgICAgaWYgKHRoaXMuZXJyb3JzLmxlbmd0aCA+IDEpIHsKICAgICAgICB2YXIgbXNnID0gdGhpcy5lcnJvcnMuam9pbignXG4qICcpOwogICAgICAgIG1zZyA9ICdUaGVyZSB3ZXJlICcgKyB0aGlzLmVycm9ycy5sZW5ndGggKwogICAgICAgICAgJyB2YWxpZGF0aW9uIGVycm9yczpcbiogJyArIG1zZzsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IobXNnKSwKICAgICAgICAgIHtjb2RlOiAnTXVsdGlwbGVWYWxpZGF0aW9uRXJyb3JzJywgZXJyb3JzOiB0aGlzLmVycm9yc30pOwogICAgICB9IGVsc2UgaWYgKHRoaXMuZXJyb3JzLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHRocm93IHRoaXMuZXJyb3JzWzBdOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9LAogIAogICAgZmFpbDogZnVuY3Rpb24gZmFpbChjb2RlLCBtZXNzYWdlKSB7CiAgICAgIHRoaXMuZXJyb3JzLnB1c2goQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKG1lc3NhZ2UpLCB7Y29kZTogY29kZX0pKTsKICAgIH0sCiAgCiAgICB2YWxpZGF0ZVN0cnVjdHVyZTogZnVuY3Rpb24gdmFsaWRhdGVTdHJ1Y3R1cmUoc2hhcGUsIHBhcmFtcywgY29udGV4dCkgewogICAgICB0aGlzLnZhbGlkYXRlVHlwZShwYXJhbXMsIGNvbnRleHQsIFsnb2JqZWN0J10sICdzdHJ1Y3R1cmUnKTsKICAKICAgICAgdmFyIHBhcmFtTmFtZTsKICAgICAgZm9yICh2YXIgaSA9IDA7IHNoYXBlLnJlcXVpcmVkICYmIGkgPCBzaGFwZS5yZXF1aXJlZC5sZW5ndGg7IGkrKykgewogICAgICAgIHBhcmFtTmFtZSA9IHNoYXBlLnJlcXVpcmVkW2ldOwogICAgICAgIHZhciB2YWx1ZSA9IHBhcmFtc1twYXJhbU5hbWVdOwogICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ01pc3NpbmdSZXF1aXJlZFBhcmFtZXRlcicsCiAgICAgICAgICAgICdNaXNzaW5nIHJlcXVpcmVkIGtleSBcJycgKyBwYXJhbU5hbWUgKyAnXCcgaW4gJyArIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogIAogICAgICAvLyB2YWxpZGF0ZSBoYXNoIG1lbWJlcnMKICAgICAgZm9yIChwYXJhbU5hbWUgaW4gcGFyYW1zKSB7CiAgICAgICAgaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocGFyYW1zLCBwYXJhbU5hbWUpKSBjb250aW51ZTsKICAKICAgICAgICB2YXIgcGFyYW1WYWx1ZSA9IHBhcmFtc1twYXJhbU5hbWVdLAogICAgICAgICAgICBtZW1iZXJTaGFwZSA9IHNoYXBlLm1lbWJlcnNbcGFyYW1OYW1lXTsKICAKICAgICAgICBpZiAobWVtYmVyU2hhcGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdmFyIG1lbWJlckNvbnRleHQgPSBbY29udGV4dCwgcGFyYW1OYW1lXS5qb2luKCcuJyk7CiAgICAgICAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKG1lbWJlclNoYXBlLCBwYXJhbVZhbHVlLCBtZW1iZXJDb250ZXh0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5mYWlsKCdVbmV4cGVjdGVkUGFyYW1ldGVyJywKICAgICAgICAgICAgJ1VuZXhwZWN0ZWQga2V5IFwnJyArIHBhcmFtTmFtZSArICdcJyBmb3VuZCBpbiAnICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAKICAgIHZhbGlkYXRlTWVtYmVyOiBmdW5jdGlvbiB2YWxpZGF0ZU1lbWJlcihzaGFwZSwgcGFyYW0sIGNvbnRleHQpIHsKICAgICAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICAgICAgY2FzZSAnc3RydWN0dXJlJzoKICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlU3RydWN0dXJlKHNoYXBlLCBwYXJhbSwgY29udGV4dCk7CiAgICAgICAgY2FzZSAnbGlzdCc6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZUxpc3Qoc2hhcGUsIHBhcmFtLCBjb250ZXh0KTsKICAgICAgICBjYXNlICdtYXAnOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVNYXAoc2hhcGUsIHBhcmFtLCBjb250ZXh0KTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVTY2FsYXIoc2hhcGUsIHBhcmFtLCBjb250ZXh0KTsKICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlTGlzdDogZnVuY3Rpb24gdmFsaWRhdGVMaXN0KHNoYXBlLCBwYXJhbXMsIGNvbnRleHQpIHsKICAgICAgaWYgKHRoaXMudmFsaWRhdGVUeXBlKHBhcmFtcywgY29udGV4dCwgW0FycmF5XSkpIHsKICAgICAgICB0aGlzLnZhbGlkYXRlUmFuZ2Uoc2hhcGUsIHBhcmFtcy5sZW5ndGgsIGNvbnRleHQsICdsaXN0IG1lbWJlciBjb3VudCcpOwogICAgICAgIC8vIHZhbGlkYXRlIGFycmF5IG1lbWJlcnMKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcmFtcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdGhpcy52YWxpZGF0ZU1lbWJlcihzaGFwZS5tZW1iZXIsIHBhcmFtc1tpXSwgY29udGV4dCArICdbJyArIGkgKyAnXScpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlTWFwOiBmdW5jdGlvbiB2YWxpZGF0ZU1hcChzaGFwZSwgcGFyYW1zLCBjb250ZXh0KSB7CiAgICAgIGlmICh0aGlzLnZhbGlkYXRlVHlwZShwYXJhbXMsIGNvbnRleHQsIFsnb2JqZWN0J10sICdtYXAnKSkgewogICAgICAgIC8vIEJ1aWxkIHVwIGEgY291bnQgb2YgbWFwIG1lbWJlcnMgdG8gdmFsaWRhdGUgcmFuZ2UgdHJhaXRzLgogICAgICAgIHZhciBtYXBDb3VudCA9IDA7CiAgICAgICAgZm9yICh2YXIgcGFyYW0gaW4gcGFyYW1zKSB7CiAgICAgICAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwYXJhbXMsIHBhcmFtKSkgY29udGludWU7CiAgICAgICAgICAvLyBWYWxpZGF0ZSBhbnkgbWFwIGtleSB0cmFpdCBjb25zdHJhaW50cwogICAgICAgICAgdGhpcy52YWxpZGF0ZU1lbWJlcihzaGFwZS5rZXksIHBhcmFtLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0ICsgJ1trZXk9XCcnICsgcGFyYW0gKyAnXCddJyk7CiAgICAgICAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKHNoYXBlLnZhbHVlLCBwYXJhbXNbcGFyYW1dLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0ICsgJ1tcJycgKyBwYXJhbSArICdcJ10nKTsKICAgICAgICAgIG1hcENvdW50Kys7CiAgICAgICAgfQogICAgICAgIHRoaXMudmFsaWRhdGVSYW5nZShzaGFwZSwgbWFwQ291bnQsIGNvbnRleHQsICdtYXAgbWVtYmVyIGNvdW50Jyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVNjYWxhcjogZnVuY3Rpb24gdmFsaWRhdGVTY2FsYXIoc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICAgIGNhc2UgbnVsbDoKICAgICAgICBjYXNlIHVuZGVmaW5lZDoKICAgICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVTdHJpbmcoc2hhcGUsIHZhbHVlLCBjb250ZXh0KTsKICAgICAgICBjYXNlICdiYXNlNjQnOgogICAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVBheWxvYWQodmFsdWUsIGNvbnRleHQpOwogICAgICAgIGNhc2UgJ2ludGVnZXInOgogICAgICAgIGNhc2UgJ2Zsb2F0JzoKICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlTnVtYmVyKHNoYXBlLCB2YWx1ZSwgY29udGV4dCk7CiAgICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVR5cGUodmFsdWUsIGNvbnRleHQsIFsnYm9vbGVhbiddKTsKICAgICAgICBjYXNlICd0aW1lc3RhbXAnOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCBbRGF0ZSwKICAgICAgICAgICAgL15cZHs0fS1cZHsyfS1cZHsyfVRcZHsyfTpcZHsyfTpcZHsyfShcLlxkKyk/WiQvLCAnbnVtYmVyJ10sCiAgICAgICAgICAgICdEYXRlIG9iamVjdCwgSVNPLTg2MDEgc3RyaW5nLCBvciBhIFVOSVggdGltZXN0YW1wJyk7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiB0aGlzLmZhaWwoJ1Vua293blR5cGUnLCAnVW5oYW5kbGVkIHR5cGUgJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlLnR5cGUgKyAnIGZvciAnICsgY29udGV4dCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVN0cmluZzogZnVuY3Rpb24gdmFsaWRhdGVTdHJpbmcoc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciB2YWxpZFR5cGVzID0gWydzdHJpbmcnXTsKICAgICAgaWYgKHNoYXBlLmlzSnNvblZhbHVlKSB7CiAgICAgICAgdmFsaWRUeXBlcyA9IHZhbGlkVHlwZXMuY29uY2F0KFsnbnVtYmVyJywgJ29iamVjdCcsICdib29sZWFuJ10pOwogICAgICB9CiAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB0aGlzLnZhbGlkYXRlVHlwZSh2YWx1ZSwgY29udGV4dCwgdmFsaWRUeXBlcykpIHsKICAgICAgICB0aGlzLnZhbGlkYXRlRW51bShzaGFwZSwgdmFsdWUsIGNvbnRleHQpOwogICAgICAgIHRoaXMudmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUubGVuZ3RoLCBjb250ZXh0LCAnc3RyaW5nIGxlbmd0aCcpOwogICAgICAgIHRoaXMudmFsaWRhdGVQYXR0ZXJuKHNoYXBlLCB2YWx1ZSwgY29udGV4dCk7CiAgICAgICAgdGhpcy52YWxpZGF0ZVVyaShzaGFwZSwgdmFsdWUsIGNvbnRleHQpOwogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVVcmk6IGZ1bmN0aW9uIHZhbGlkYXRlVXJpKHNoYXBlLCB2YWx1ZSwgY29udGV4dCkgewogICAgICBpZiAoc2hhcGVbJ2xvY2F0aW9uJ10gPT09ICd1cmknKSB7CiAgICAgICAgaWYgKHZhbHVlLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgdGhpcy5mYWlsKCdVcmlQYXJhbWV0ZXJFcnJvcicsICdFeHBlY3RlZCB1cmkgcGFyYW1ldGVyIHRvIGhhdmUgbGVuZ3RoID49IDEsJwogICAgICAgICAgICArICcgYnV0IGZvdW5kICInICsgdmFsdWUgKyciIGZvciAnICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVQYXR0ZXJuOiBmdW5jdGlvbiB2YWxpZGF0ZVBhdHRlcm4oc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIGlmICh0aGlzLnZhbGlkYXRpb25bJ3BhdHRlcm4nXSAmJiBzaGFwZVsncGF0dGVybiddICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAoIShuZXcgUmVnRXhwKHNoYXBlWydwYXR0ZXJuJ10pKS50ZXN0KHZhbHVlKSkgewogICAgICAgICAgdGhpcy5mYWlsKCdQYXR0ZXJuTWF0Y2hFcnJvcicsICdQcm92aWRlZCB2YWx1ZSAiJyArIHZhbHVlICsgJyIgJwogICAgICAgICAgICArICdkb2VzIG5vdCBtYXRjaCByZWdleCBwYXR0ZXJuIC8nICsgc2hhcGVbJ3BhdHRlcm4nXSArICcvIGZvciAnCiAgICAgICAgICAgICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVSYW5nZTogZnVuY3Rpb24gdmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUsIGNvbnRleHQsIGRlc2NyaXB0b3IpIHsKICAgICAgaWYgKHRoaXMudmFsaWRhdGlvblsnbWluJ10pIHsKICAgICAgICBpZiAoc2hhcGVbJ21pbiddICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgPCBzaGFwZVsnbWluJ10pIHsKICAgICAgICAgIHRoaXMuZmFpbCgnTWluUmFuZ2VFcnJvcicsICdFeHBlY3RlZCAnICsgZGVzY3JpcHRvciArICcgPj0gJwogICAgICAgICAgICArIHNoYXBlWydtaW4nXSArICcsIGJ1dCBmb3VuZCAnICsgdmFsdWUgKyAnIGZvciAnICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICh0aGlzLnZhbGlkYXRpb25bJ21heCddKSB7CiAgICAgICAgaWYgKHNoYXBlWydtYXgnXSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlID4gc2hhcGVbJ21heCddKSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ01heFJhbmdlRXJyb3InLCAnRXhwZWN0ZWQgJyArIGRlc2NyaXB0b3IgKyAnIDw9ICcKICAgICAgICAgICAgKyBzaGFwZVsnbWF4J10gKyAnLCBidXQgZm91bmQgJyArIHZhbHVlICsgJyBmb3IgJyArIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlRW51bTogZnVuY3Rpb24gdmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgaWYgKHRoaXMudmFsaWRhdGlvblsnZW51bSddICYmIHNoYXBlWydlbnVtJ10gIT09IHVuZGVmaW5lZCkgewogICAgICAgIC8vIEZhaWwgaWYgdGhlIHN0cmluZyB2YWx1ZSBpcyBub3QgcHJlc2VudCBpbiB0aGUgZW51bSBsaXN0CiAgICAgICAgaWYgKHNoYXBlWydlbnVtJ10uaW5kZXhPZih2YWx1ZSkgPT09IC0xKSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ0VudW1FcnJvcicsICdGb3VuZCBzdHJpbmcgdmFsdWUgb2YgJyArIHZhbHVlICsgJywgYnV0ICcKICAgICAgICAgICAgKyAnZXhwZWN0ZWQgJyArIHNoYXBlWydlbnVtJ10uam9pbignfCcpICsgJyBmb3IgJyArIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlVHlwZTogZnVuY3Rpb24gdmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCBhY2NlcHRlZFR5cGVzLCB0eXBlKSB7CiAgICAgIC8vIFdlIHdpbGwgbm90IGxvZyBhbiBlcnJvciBmb3IgbnVsbCBvciB1bmRlZmluZWQsIGJ1dCB3ZSB3aWxsIHJldHVybgogICAgICAvLyBmYWxzZSBzbyB0aGF0IGNhbGxlcnMga25vdyB0aGF0IHRoZSBleHBlY3RlZCB0eXBlIHdhcyBub3Qgc3RyaWN0bHkgbWV0LgogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGZhbHNlOwogIAogICAgICB2YXIgZm91bmRJbnZhbGlkVHlwZSA9IGZhbHNlOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFjY2VwdGVkVHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAodHlwZW9mIGFjY2VwdGVkVHlwZXNbaV0gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSBhY2NlcHRlZFR5cGVzW2ldKSByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKGFjY2VwdGVkVHlwZXNbaV0gaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICAgIGlmICgodmFsdWUgfHwgJycpLnRvU3RyaW5nKCkubWF0Y2goYWNjZXB0ZWRUeXBlc1tpXSkpIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBhY2NlcHRlZFR5cGVzW2ldKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgIGlmIChBV1MudXRpbC5pc1R5cGUodmFsdWUsIGFjY2VwdGVkVHlwZXNbaV0pKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgIGlmICghdHlwZSAmJiAhZm91bmRJbnZhbGlkVHlwZSkgYWNjZXB0ZWRUeXBlcyA9IGFjY2VwdGVkVHlwZXMuc2xpY2UoKTsKICAgICAgICAgIGFjY2VwdGVkVHlwZXNbaV0gPSBBV1MudXRpbC50eXBlTmFtZShhY2NlcHRlZFR5cGVzW2ldKTsKICAgICAgICB9CiAgICAgICAgZm91bmRJbnZhbGlkVHlwZSA9IHRydWU7CiAgICAgIH0KICAKICAgICAgdmFyIGFjY2VwdGVkVHlwZSA9IHR5cGU7CiAgICAgIGlmICghYWNjZXB0ZWRUeXBlKSB7CiAgICAgICAgYWNjZXB0ZWRUeXBlID0gYWNjZXB0ZWRUeXBlcy5qb2luKCcsICcpLnJlcGxhY2UoLywoW14sXSspJC8sICcsIG9yJDEnKTsKICAgICAgfQogIAogICAgICB2YXIgdm93ZWwgPSBhY2NlcHRlZFR5cGUubWF0Y2goL15bYWVpb3VdL2kpID8gJ24nIDogJyc7CiAgICAgIHRoaXMuZmFpbCgnSW52YWxpZFBhcmFtZXRlclR5cGUnLCAnRXhwZWN0ZWQgJyArIGNvbnRleHQgKyAnIHRvIGJlIGEnICsKICAgICAgICAgICAgICAgIHZvd2VsICsgJyAnICsgYWNjZXB0ZWRUeXBlKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAKICAgIHZhbGlkYXRlTnVtYmVyOiBmdW5jdGlvbiB2YWxpZGF0ZU51bWJlcihzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICB2YXIgY2FzdGVkVmFsdWUgPSBwYXJzZUZsb2F0KHZhbHVlKTsKICAgICAgICBpZiAoY2FzdGVkVmFsdWUudG9TdHJpbmcoKSA9PT0gdmFsdWUpIHZhbHVlID0gY2FzdGVkVmFsdWU7CiAgICAgIH0KICAgICAgaWYgKHRoaXMudmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCBbJ251bWJlciddKSkgewogICAgICAgIHRoaXMudmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUsIGNvbnRleHQsICdudW1lcmljIHZhbHVlJyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVBheWxvYWQ6IGZ1bmN0aW9uIHZhbGlkYXRlUGF5bG9hZCh2YWx1ZSwgY29udGV4dCkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgcmV0dXJuOwogICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlLmJ5dGVMZW5ndGggPT09ICdudW1iZXInKSByZXR1cm47IC8vIHR5cGVkIGFycmF5cwogICAgICBpZiAoQVdTLnV0aWwuaXNOb2RlKCkpIHsgLy8gc3BlY2lhbCBjaGVjayBmb3IgYnVmZmVyL3N0cmVhbSBpbiBOb2RlLmpzCiAgICAgICAgdmFyIFN0cmVhbSA9IEFXUy51dGlsLnN0cmVhbS5TdHJlYW07CiAgICAgICAgaWYgKEFXUy51dGlsLkJ1ZmZlci5pc0J1ZmZlcih2YWx1ZSkgfHwgdmFsdWUgaW5zdGFuY2VvZiBTdHJlYW0pIHJldHVybjsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodHlwZW9mIEJsb2IgIT09IHZvaWQgMCAmJiB2YWx1ZSBpbnN0YW5jZW9mIEJsb2IpIHJldHVybjsKICAgICAgfQogIAogICAgICB2YXIgdHlwZXMgPSBbJ0J1ZmZlcicsICdTdHJlYW0nLCAnRmlsZScsICdCbG9iJywgJ0FycmF5QnVmZmVyJywgJ0RhdGFWaWV3J107CiAgICAgIGlmICh2YWx1ZSkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChBV1MudXRpbC5pc1R5cGUodmFsdWUsIHR5cGVzW2ldKSkgcmV0dXJuOwogICAgICAgICAgaWYgKEFXUy51dGlsLnR5cGVOYW1lKHZhbHVlLmNvbnN0cnVjdG9yKSA9PT0gdHlwZXNbaV0pIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgdGhpcy5mYWlsKCdJbnZhbGlkUGFyYW1ldGVyVHlwZScsICdFeHBlY3RlZCAnICsgY29udGV4dCArICcgdG8gYmUgYSAnICsKICAgICAgICAnc3RyaW5nLCBCdWZmZXIsIFN0cmVhbSwgQmxvYiwgb3IgdHlwZWQgYXJyYXkgb2JqZWN0Jyk7CiAgICB9CiAgfSk7CiAgCiAgfSx7Ii4vY29yZSI6MTh9XSw0NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSAgcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogUHJlcGVuZCBwcmVmaXggZGVmaW5lZCBieSBBUEkgbW9kZWwgdG8gZW5kcG9pbnQgdGhhdCdzIGFscmVhZHkKICAgKiBjb25zdHJ1Y3RlZC4gVGhpcyBmZWF0dXJlIGRvZXMgbm90IGFwcGx5IHRvIG9wZXJhdGlvbnMgdXNpbmcKICAgKiBlbmRwb2ludCBkaXNjb3ZlcnkgYW5kIGNhbiBiZSBkaXNhYmxlZC4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBwb3B1bGF0ZUhvc3RQcmVmaXgocmVxdWVzdCkgIHsKICAgIHZhciBlbmFibGVkID0gcmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5ob3N0UHJlZml4RW5hYmxlZDsKICAgIGlmICghZW5hYmxlZCkgcmV0dXJuIHJlcXVlc3Q7CiAgICB2YXIgb3BlcmF0aW9uTW9kZWwgPSByZXF1ZXN0LnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dOwogICAgLy9kb24ndCBtYXJzaGFsIGhvc3QgcHJlZml4IHdoZW4gb3BlcmF0aW9uIGhhcyBlbmRwb2ludCBkaXNjb3ZlcnkgdHJhaXRzCiAgICBpZiAoaGFzRW5kcG9pbnREaXNjb3ZlcihyZXF1ZXN0KSkgcmV0dXJuIHJlcXVlc3Q7CiAgICBpZiAob3BlcmF0aW9uTW9kZWwuZW5kcG9pbnQgJiYgb3BlcmF0aW9uTW9kZWwuZW5kcG9pbnQuaG9zdFByZWZpeCkgewogICAgICB2YXIgaG9zdFByZWZpeE5vdGF0aW9uID0gb3BlcmF0aW9uTW9kZWwuZW5kcG9pbnQuaG9zdFByZWZpeDsKICAgICAgdmFyIGhvc3RQcmVmaXggPSBleHBhbmRIb3N0UHJlZml4KGhvc3RQcmVmaXhOb3RhdGlvbiwgcmVxdWVzdC5wYXJhbXMsIG9wZXJhdGlvbk1vZGVsLmlucHV0KTsKICAgICAgcHJlcGVuZEVuZHBvaW50UHJlZml4KHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQsIGhvc3RQcmVmaXgpOwogICAgICB2YWxpZGF0ZUhvc3RuYW1lKHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQuaG9zdG5hbWUpOwogICAgfQogICAgcmV0dXJuIHJlcXVlc3Q7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGhhc0VuZHBvaW50RGlzY292ZXIocmVxdWVzdCkgewogICAgdmFyIGFwaSA9IHJlcXVlc3Quc2VydmljZS5hcGk7CiAgICB2YXIgb3BlcmF0aW9uTW9kZWwgPSBhcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICB2YXIgaXNFbmRwb2ludE9wZXJhdGlvbiA9IGFwaS5lbmRwb2ludE9wZXJhdGlvbiAmJiAoYXBpLmVuZHBvaW50T3BlcmF0aW9uID09PSB1dGlsLnN0cmluZy5sb3dlckZpcnN0KG9wZXJhdGlvbk1vZGVsLm5hbWUpKTsKICAgIHJldHVybiAob3BlcmF0aW9uTW9kZWwuZW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCAhPT0gJ05VTEwnIHx8IGlzRW5kcG9pbnRPcGVyYXRpb24gPT09IHRydWUpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBleHBhbmRIb3N0UHJlZml4KGhvc3RQcmVmaXhOb3RhdGlvbiwgcGFyYW1zLCBzaGFwZSkgewogICAgdXRpbC5lYWNoKHNoYXBlLm1lbWJlcnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlcikgewogICAgICBpZiAobWVtYmVyLmhvc3RMYWJlbCA9PT0gdHJ1ZSkgewogICAgICAgIGlmICh0eXBlb2YgcGFyYW1zW25hbWVdICE9PSAnc3RyaW5nJyB8fCBwYXJhbXNbbmFtZV0gPT09ICcnKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICAgIG1lc3NhZ2U6ICdQYXJhbWV0ZXIgJyArIG5hbWUgKyAnIHNob3VsZCBiZSBhIG5vbi1lbXB0eSBzdHJpbmcuJywKICAgICAgICAgICAgY29kZTogJ0ludmFsaWRQYXJhbWV0ZXInCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cCgnXFx7JyArIG5hbWUgKyAnXFx9JywgJ2cnKTsKICAgICAgICBob3N0UHJlZml4Tm90YXRpb24gPSBob3N0UHJlZml4Tm90YXRpb24ucmVwbGFjZShyZWdleCwgcGFyYW1zW25hbWVdKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gaG9zdFByZWZpeE5vdGF0aW9uOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBwcmVwZW5kRW5kcG9pbnRQcmVmaXgoZW5kcG9pbnQsIHByZWZpeCkgewogICAgaWYgKGVuZHBvaW50Lmhvc3QpIHsKICAgICAgZW5kcG9pbnQuaG9zdCA9IHByZWZpeCArIGVuZHBvaW50Lmhvc3Q7CiAgICB9CiAgICBpZiAoZW5kcG9pbnQuaG9zdG5hbWUpIHsKICAgICAgZW5kcG9pbnQuaG9zdG5hbWUgPSBwcmVmaXggKyBlbmRwb2ludC5ob3N0bmFtZTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gdmFsaWRhdGVIb3N0bmFtZShob3N0bmFtZSkgewogICAgdmFyIGxhYmVscyA9IGhvc3RuYW1lLnNwbGl0KCcuJyk7CiAgICAvL1JlZmVyZW5jZTogaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzExMjMjc2VjdGlvbi0yCiAgICB2YXIgaG9zdFBhdHRlcm4gPSAvXlthLXpBLVowLTldezF9JHxeW2EtekEtWjAtOV1bYS16QS1aMC05XC1dKlthLXpBLVowLTldJC87CiAgICB1dGlsLmFycmF5RWFjaChsYWJlbHMsIGZ1bmN0aW9uKGxhYmVsKSB7CiAgICAgIGlmICghbGFiZWwubGVuZ3RoIHx8IGxhYmVsLmxlbmd0aCA8IDEgfHwgbGFiZWwubGVuZ3RoID4gNjMpIHsKICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICBjb2RlOiAnVmFsaWRhdGlvbkVycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdIb3N0bmFtZSBsYWJlbCBsZW5ndGggc2hvdWxkIGJlIGJldHdlZW4gMSB0byA2MyBjaGFyYWN0ZXJzLCBpbmNsdXNpdmUuJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICghaG9zdFBhdHRlcm4udGVzdChsYWJlbCkpIHsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgIHtjb2RlOiAnVmFsaWRhdGlvbkVycm9yJywgbWVzc2FnZTogbGFiZWwgKyAnIGlzIG5vdCBob3N0bmFtZSBjb21wYXRpYmxlLid9KTsKICAgICAgfQogICAgfSk7CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gewogICAgcG9wdWxhdGVIb3N0UHJlZml4OiBwb3B1bGF0ZUhvc3RQcmVmaXgKICB9OwogIAogIH0seyIuLi9jb3JlIjoxOCwiLi4vdXRpbCI6NzF9XSw0NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIEpzb25CdWlsZGVyID0gcmVxdWlyZSgnLi4vanNvbi9idWlsZGVyJyk7CiAgdmFyIEpzb25QYXJzZXIgPSByZXF1aXJlKCcuLi9qc29uL3BhcnNlcicpOwogIHZhciBwb3B1bGF0ZUhvc3RQcmVmaXggPSByZXF1aXJlKCcuL2hlbHBlcnMnKS5wb3B1bGF0ZUhvc3RQcmVmaXg7CiAgCiAgZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogICAgdmFyIGh0dHBSZXF1ZXN0ID0gcmVxLmh0dHBSZXF1ZXN0OwogICAgdmFyIGFwaSA9IHJlcS5zZXJ2aWNlLmFwaTsKICAgIHZhciB0YXJnZXQgPSBhcGkudGFyZ2V0UHJlZml4ICsgJy4nICsgYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0ubmFtZTsKICAgIHZhciB2ZXJzaW9uID0gYXBpLmpzb25WZXJzaW9uIHx8ICcxLjAnOwogICAgdmFyIGlucHV0ID0gYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQ7CiAgICB2YXIgYnVpbGRlciA9IG5ldyBKc29uQnVpbGRlcigpOwogIAogICAgaWYgKHZlcnNpb24gPT09IDEpIHZlcnNpb24gPSAnMS4wJzsKICAgIGh0dHBSZXF1ZXN0LmJvZHkgPSBidWlsZGVyLmJ1aWxkKHJlcS5wYXJhbXMgfHwge30sIGlucHV0KTsKICAgIGh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID0gJ2FwcGxpY2F0aW9uL3gtYW16LWpzb24tJyArIHZlcnNpb247CiAgICBodHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1UYXJnZXQnXSA9IHRhcmdldDsKICAKICAgIHBvcHVsYXRlSG9zdFByZWZpeChyZXEpOwogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RXJyb3IocmVzcCkgewogICAgdmFyIGVycm9yID0ge307CiAgICB2YXIgaHR0cFJlc3BvbnNlID0gcmVzcC5odHRwUmVzcG9uc2U7CiAgCiAgICBlcnJvci5jb2RlID0gaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16bi1lcnJvcnR5cGUnXSB8fCAnVW5rbm93bkVycm9yJzsKICAgIGlmICh0eXBlb2YgZXJyb3IuY29kZSA9PT0gJ3N0cmluZycpIHsKICAgICAgZXJyb3IuY29kZSA9IGVycm9yLmNvZGUuc3BsaXQoJzonKVswXTsKICAgIH0KICAKICAgIGlmIChodHRwUmVzcG9uc2UuYm9keS5sZW5ndGggPiAwKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIGUgPSBKU09OLnBhcnNlKGh0dHBSZXNwb25zZS5ib2R5LnRvU3RyaW5nKCkpOwogICAgICAgIGlmIChlLl9fdHlwZSB8fCBlLmNvZGUpIHsKICAgICAgICAgIGVycm9yLmNvZGUgPSAoZS5fX3R5cGUgfHwgZS5jb2RlKS5zcGxpdCgnIycpLnBvcCgpOwogICAgICAgIH0KICAgICAgICBpZiAoZXJyb3IuY29kZSA9PT0gJ1JlcXVlc3RFbnRpdHlUb29MYXJnZScpIHsKICAgICAgICAgIGVycm9yLm1lc3NhZ2UgPSAnUmVxdWVzdCBib2R5IG11c3QgYmUgbGVzcyB0aGFuIDEgTUInOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlcnJvci5tZXNzYWdlID0gKGUubWVzc2FnZSB8fCBlLk1lc3NhZ2UgfHwgbnVsbCk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgZXJyb3Iuc3RhdHVzQ29kZSA9IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICAgIGVycm9yLm1lc3NhZ2UgPSBodHRwUmVzcG9uc2Uuc3RhdHVzTWVzc2FnZTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZXJyb3Iuc3RhdHVzQ29kZSA9IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICBlcnJvci5tZXNzYWdlID0gaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUudG9TdHJpbmcoKTsKICAgIH0KICAKICAgIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCBlcnJvcik7CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICAgIHZhciBib2R5ID0gcmVzcC5odHRwUmVzcG9uc2UuYm9keS50b1N0cmluZygpIHx8ICd7fSc7CiAgICBpZiAocmVzcC5yZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNvbnZlcnRSZXNwb25zZVR5cGVzID09PSBmYWxzZSkgewogICAgICByZXNwLmRhdGEgPSBKU09OLnBhcnNlKGJvZHkpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIG9wZXJhdGlvbiA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3Jlc3AucmVxdWVzdC5vcGVyYXRpb25dOwogICAgICB2YXIgc2hhcGUgPSBvcGVyYXRpb24ub3V0cHV0IHx8IHt9OwogICAgICB2YXIgcGFyc2VyID0gbmV3IEpzb25QYXJzZXIoKTsKICAgICAgcmVzcC5kYXRhID0gcGFyc2VyLnBhcnNlKGJvZHksIHNoYXBlKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICAgIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogICAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhCiAgfTsKICAKICB9LHsiLi4vanNvbi9idWlsZGVyIjozNiwiLi4vanNvbi9wYXJzZXIiOjM3LCIuLi91dGlsIjo3MSwiLi9oZWxwZXJzIjo0NX1dLDQ3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBRdWVyeVBhcmFtU2VyaWFsaXplciA9IHJlcXVpcmUoJy4uL3F1ZXJ5L3F1ZXJ5X3BhcmFtX3NlcmlhbGl6ZXInKTsKICB2YXIgU2hhcGUgPSByZXF1aXJlKCcuLi9tb2RlbC9zaGFwZScpOwogIHZhciBwb3B1bGF0ZUhvc3RQcmVmaXggPSByZXF1aXJlKCcuL2hlbHBlcnMnKS5wb3B1bGF0ZUhvc3RQcmVmaXg7CiAgCiAgZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIGh0dHBSZXF1ZXN0ID0gcmVxLmh0dHBSZXF1ZXN0OwogICAgaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ10gPQogICAgICAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PXV0Zi04JzsKICAgIGh0dHBSZXF1ZXN0LnBhcmFtcyA9IHsKICAgICAgVmVyc2lvbjogcmVxLnNlcnZpY2UuYXBpLmFwaVZlcnNpb24sCiAgICAgIEFjdGlvbjogb3BlcmF0aW9uLm5hbWUKICAgIH07CiAgCiAgICAvLyBjb252ZXJ0IHRoZSByZXF1ZXN0IHBhcmFtZXRlcnMgaW50byBhIGxpc3Qgb2YgcXVlcnkgcGFyYW1zLAogICAgLy8gZS5nLiBEZWVwbHkuTmVzdGVkUGFyYW0uMC5OYW1lPXZhbHVlCiAgICB2YXIgYnVpbGRlciA9IG5ldyBRdWVyeVBhcmFtU2VyaWFsaXplcigpOwogICAgYnVpbGRlci5zZXJpYWxpemUocmVxLnBhcmFtcywgb3BlcmF0aW9uLmlucHV0LCBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICBodHRwUmVxdWVzdC5wYXJhbXNbbmFtZV0gPSB2YWx1ZTsKICAgIH0pOwogICAgaHR0cFJlcXVlc3QuYm9keSA9IHV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhodHRwUmVxdWVzdC5wYXJhbXMpOwogIAogICAgcG9wdWxhdGVIb3N0UHJlZml4KHJlcSk7CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3RFcnJvcihyZXNwKSB7CiAgICB2YXIgZGF0YSwgYm9keSA9IHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkudG9TdHJpbmcoKTsKICAgIGlmIChib2R5Lm1hdGNoKCc8VW5rbm93bk9wZXJhdGlvbkV4Y2VwdGlvbicpKSB7CiAgICAgIGRhdGEgPSB7CiAgICAgICAgQ29kZTogJ1Vua25vd25PcGVyYXRpb24nLAogICAgICAgIE1lc3NhZ2U6ICdVbmtub3duIG9wZXJhdGlvbiAnICsgcmVzcC5yZXF1ZXN0Lm9wZXJhdGlvbgogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgdHJ5IHsKICAgICAgICBkYXRhID0gbmV3IEFXUy5YTUwuUGFyc2VyKCkucGFyc2UoYm9keSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBkYXRhID0gewogICAgICAgICAgQ29kZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSwKICAgICAgICAgIE1lc3NhZ2U6IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c01lc3NhZ2UKICAgICAgICB9OwogICAgICB9CiAgICB9CiAgCiAgICBpZiAoZGF0YS5yZXF1ZXN0SWQgJiYgIXJlc3AucmVxdWVzdElkKSByZXNwLnJlcXVlc3RJZCA9IGRhdGEucmVxdWVzdElkOwogICAgaWYgKGRhdGEuRXJyb3JzKSBkYXRhID0gZGF0YS5FcnJvcnM7CiAgICBpZiAoZGF0YS5FcnJvcikgZGF0YSA9IGRhdGEuRXJyb3I7CiAgICBpZiAoZGF0YS5Db2RlKSB7CiAgICAgIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogZGF0YS5Db2RlLAogICAgICAgIG1lc3NhZ2U6IGRhdGEuTWVzc2FnZQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSwKICAgICAgICBtZXNzYWdlOiBudWxsCiAgICAgIH0pOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RGF0YShyZXNwKSB7CiAgICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIHNoYXBlID0gb3BlcmF0aW9uLm91dHB1dCB8fCB7fTsKICAgIHZhciBvcmlnUnVsZXMgPSBzaGFwZTsKICAKICAgIGlmIChvcmlnUnVsZXMucmVzdWx0V3JhcHBlcikgewogICAgICB2YXIgdG1wID0gU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RydWN0dXJlJ30pOwogICAgICB0bXAubWVtYmVyc1tvcmlnUnVsZXMucmVzdWx0V3JhcHBlcl0gPSBzaGFwZTsKICAgICAgdG1wLm1lbWJlck5hbWVzID0gW29yaWdSdWxlcy5yZXN1bHRXcmFwcGVyXTsKICAgICAgdXRpbC5wcm9wZXJ0eShzaGFwZSwgJ25hbWUnLCBzaGFwZS5yZXN1bHRXcmFwcGVyKTsKICAgICAgc2hhcGUgPSB0bXA7CiAgICB9CiAgCiAgICB2YXIgcGFyc2VyID0gbmV3IEFXUy5YTUwuUGFyc2VyKCk7CiAgCiAgICAvLyBUT0RPOiBSZWZhY3RvciBYTUwgUGFyc2VyIHRvIHBhcnNlIFJlcXVlc3RJZCBmcm9tIHJlc3BvbnNlLgogICAgaWYgKHNoYXBlICYmIHNoYXBlLm1lbWJlcnMgJiYgIXNoYXBlLm1lbWJlcnMuX1hBTVpSZXF1ZXN0SWQpIHsKICAgICAgdmFyIHJlcXVlc3RJZFNoYXBlID0gU2hhcGUuY3JlYXRlKAogICAgICAgIHsgdHlwZTogJ3N0cmluZycgfSwKICAgICAgICB7IGFwaTogeyBwcm90b2NvbDogJ3F1ZXJ5JyB9IH0sCiAgICAgICAgJ3JlcXVlc3RJZCcKICAgICAgKTsKICAgICAgc2hhcGUubWVtYmVycy5fWEFNWlJlcXVlc3RJZCA9IHJlcXVlc3RJZFNoYXBlOwogICAgfQogIAogICAgdmFyIGRhdGEgPSBwYXJzZXIucGFyc2UocmVzcC5odHRwUmVzcG9uc2UuYm9keS50b1N0cmluZygpLCBzaGFwZSk7CiAgICByZXNwLnJlcXVlc3RJZCA9IGRhdGEuX1hBTVpSZXF1ZXN0SWQgfHwgZGF0YS5yZXF1ZXN0SWQ7CiAgCiAgICBpZiAoZGF0YS5fWEFNWlJlcXVlc3RJZCkgZGVsZXRlIGRhdGEuX1hBTVpSZXF1ZXN0SWQ7CiAgCiAgICBpZiAob3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXIpIHsKICAgICAgaWYgKGRhdGFbb3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXJdKSB7CiAgICAgICAgdXRpbC51cGRhdGUoZGF0YSwgZGF0YVtvcmlnUnVsZXMucmVzdWx0V3JhcHBlcl0pOwogICAgICAgIGRlbGV0ZSBkYXRhW29yaWdSdWxlcy5yZXN1bHRXcmFwcGVyXTsKICAgICAgfQogICAgfQogIAogICAgcmVzcC5kYXRhID0gZGF0YTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICAgIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogICAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhCiAgfTsKICAKICB9LHsiLi4vY29yZSI6MTgsIi4uL21vZGVsL3NoYXBlIjo0MywiLi4vcXVlcnkvcXVlcnlfcGFyYW1fc2VyaWFsaXplciI6NTEsIi4uL3V0aWwiOjcxLCIuL2hlbHBlcnMiOjQ1fV0sNDg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBwb3B1bGF0ZUhvc3RQcmVmaXggPSByZXF1aXJlKCcuL2hlbHBlcnMnKS5wb3B1bGF0ZUhvc3RQcmVmaXg7CiAgCiAgZnVuY3Rpb24gcG9wdWxhdGVNZXRob2QocmVxKSB7CiAgICByZXEuaHR0cFJlcXVlc3QubWV0aG9kID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaHR0cE1ldGhvZDsKICB9CiAgCiAgZnVuY3Rpb24gZ2VuZXJhdGVVUkkoZW5kcG9pbnRQYXRoLCBvcGVyYXRpb25QYXRoLCBpbnB1dCwgcGFyYW1zKSB7CiAgICB2YXIgdXJpID0gW2VuZHBvaW50UGF0aCwgb3BlcmF0aW9uUGF0aF0uam9pbignLycpOwogICAgdXJpID0gdXJpLnJlcGxhY2UoL1wvKy9nLCAnLycpOwogIAogICAgdmFyIHF1ZXJ5U3RyaW5nID0ge30sIHF1ZXJ5U3RyaW5nU2V0ID0gZmFsc2U7CiAgICB1dGlsLmVhY2goaW5wdXQubWVtYmVycywgZnVuY3Rpb24gKG5hbWUsIG1lbWJlcikgewogICAgICB2YXIgcGFyYW1WYWx1ZSA9IHBhcmFtc1tuYW1lXTsKICAgICAgaWYgKHBhcmFtVmFsdWUgPT09IG51bGwgfHwgcGFyYW1WYWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICd1cmknKSB7CiAgICAgICAgdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cCgnXFx7JyArIG1lbWJlci5uYW1lICsgJyhcXCspP1xcfScpOwogICAgICAgIHVyaSA9IHVyaS5yZXBsYWNlKHJlZ2V4LCBmdW5jdGlvbihfLCBwbHVzKSB7CiAgICAgICAgICB2YXIgZm4gPSBwbHVzID8gdXRpbC51cmlFc2NhcGVQYXRoIDogdXRpbC51cmlFc2NhcGU7CiAgICAgICAgICByZXR1cm4gZm4oU3RyaW5nKHBhcmFtVmFsdWUpKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdxdWVyeXN0cmluZycpIHsKICAgICAgICBxdWVyeVN0cmluZ1NldCA9IHRydWU7CiAgCiAgICAgICAgaWYgKG1lbWJlci50eXBlID09PSAnbGlzdCcpIHsKICAgICAgICAgIHF1ZXJ5U3RyaW5nW21lbWJlci5uYW1lXSA9IHBhcmFtVmFsdWUubWFwKGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICByZXR1cm4gdXRpbC51cmlFc2NhcGUobWVtYmVyLm1lbWJlci50b1dpcmVGb3JtYXQodmFsKS50b1N0cmluZygpKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSBpZiAobWVtYmVyLnR5cGUgPT09ICdtYXAnKSB7CiAgICAgICAgICB1dGlsLmVhY2gocGFyYW1WYWx1ZSwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICBxdWVyeVN0cmluZ1trZXldID0gdmFsdWUubWFwKGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwudXJpRXNjYXBlKFN0cmluZyh2YWwpKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBxdWVyeVN0cmluZ1trZXldID0gdXRpbC51cmlFc2NhcGUoU3RyaW5nKHZhbHVlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBxdWVyeVN0cmluZ1ttZW1iZXIubmFtZV0gPSB1dGlsLnVyaUVzY2FwZShtZW1iZXIudG9XaXJlRm9ybWF0KHBhcmFtVmFsdWUpLnRvU3RyaW5nKCkpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgCiAgICBpZiAocXVlcnlTdHJpbmdTZXQpIHsKICAgICAgdXJpICs9ICh1cmkuaW5kZXhPZignPycpID49IDAgPyAnJicgOiAnPycpOwogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgdXRpbC5hcnJheUVhY2goT2JqZWN0LmtleXMocXVlcnlTdHJpbmcpLnNvcnQoKSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHF1ZXJ5U3RyaW5nW2tleV0pKSB7CiAgICAgICAgICBxdWVyeVN0cmluZ1trZXldID0gW3F1ZXJ5U3RyaW5nW2tleV1dOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXJ5U3RyaW5nW2tleV0ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHBhcnRzLnB1c2godXRpbC51cmlFc2NhcGUoU3RyaW5nKGtleSkpICsgJz0nICsgcXVlcnlTdHJpbmdba2V5XVtpXSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdXJpICs9IHBhcnRzLmpvaW4oJyYnKTsKICAgIH0KICAKICAgIHJldHVybiB1cmk7CiAgfQogIAogIGZ1bmN0aW9uIHBvcHVsYXRlVVJJKHJlcSkgewogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIGlucHV0ID0gb3BlcmF0aW9uLmlucHV0OwogIAogICAgdmFyIHVyaSA9IGdlbmVyYXRlVVJJKHJlcS5odHRwUmVxdWVzdC5lbmRwb2ludC5wYXRoLCBvcGVyYXRpb24uaHR0cFBhdGgsIGlucHV0LCByZXEucGFyYW1zKTsKICAgIHJlcS5odHRwUmVxdWVzdC5wYXRoID0gdXJpOwogIH0KICAKICBmdW5jdGlvbiBwb3B1bGF0ZUhlYWRlcnMocmVxKSB7CiAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICB1dGlsLmVhY2gob3BlcmF0aW9uLmlucHV0Lm1lbWJlcnMsIGZ1bmN0aW9uIChuYW1lLCBtZW1iZXIpIHsKICAgICAgdmFyIHZhbHVlID0gcmVxLnBhcmFtc1tuYW1lXTsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAKICAgICAgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ2hlYWRlcnMnICYmIG1lbWJlci50eXBlID09PSAnbWFwJykgewogICAgICAgIHV0aWwuZWFjaCh2YWx1ZSwgZnVuY3Rpb24oa2V5LCBtZW1iZXJWYWx1ZSkgewogICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbbWVtYmVyLm5hbWUgKyBrZXldID0gbWVtYmVyVmFsdWU7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAnaGVhZGVyJykgewogICAgICAgIHZhbHVlID0gbWVtYmVyLnRvV2lyZUZvcm1hdCh2YWx1ZSkudG9TdHJpbmcoKTsKICAgICAgICBpZiAobWVtYmVyLmlzSnNvblZhbHVlKSB7CiAgICAgICAgICB2YWx1ZSA9IHV0aWwuYmFzZTY0LmVuY29kZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzW21lbWJlci5uYW1lXSA9IHZhbHVlOwogICAgICB9CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogICAgcG9wdWxhdGVNZXRob2QocmVxKTsKICAgIHBvcHVsYXRlVVJJKHJlcSk7CiAgICBwb3B1bGF0ZUhlYWRlcnMocmVxKTsKICAgIHBvcHVsYXRlSG9zdFByZWZpeChyZXEpOwogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RXJyb3IoKSB7CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICB2YXIgZGF0YSA9IHt9OwogICAgdmFyIHIgPSByZXNwLmh0dHBSZXNwb25zZTsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBvdXRwdXQgPSBvcGVyYXRpb24ub3V0cHV0OwogIAogICAgLy8gbm9ybWFsaXplIGhlYWRlcnMgbmFtZXMgdG8gbG93ZXItY2FzZWQga2V5cyBmb3IgbWF0Y2hpbmcKICAgIHZhciBoZWFkZXJzID0ge307CiAgICB1dGlsLmVhY2goci5oZWFkZXJzLCBmdW5jdGlvbiAoaywgdikgewogICAgICBoZWFkZXJzW2sudG9Mb3dlckNhc2UoKV0gPSB2OwogICAgfSk7CiAgCiAgICB1dGlsLmVhY2gob3V0cHV0Lm1lbWJlcnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlcikgewogICAgICB2YXIgaGVhZGVyID0gKG1lbWJlci5uYW1lIHx8IG5hbWUpLnRvTG93ZXJDYXNlKCk7CiAgICAgIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdoZWFkZXJzJyAmJiBtZW1iZXIudHlwZSA9PT0gJ21hcCcpIHsKICAgICAgICBkYXRhW25hbWVdID0ge307CiAgICAgICAgdmFyIGxvY2F0aW9uID0gbWVtYmVyLmlzTG9jYXRpb25OYW1lID8gbWVtYmVyLm5hbWUgOiAnJzsKICAgICAgICB2YXIgcGF0dGVybiA9IG5ldyBSZWdFeHAoJ14nICsgbG9jYXRpb24gKyAnKC4rKScsICdpJyk7CiAgICAgICAgdXRpbC5lYWNoKHIuaGVhZGVycywgZnVuY3Rpb24gKGssIHYpIHsKICAgICAgICAgIHZhciByZXN1bHQgPSBrLm1hdGNoKHBhdHRlcm4pOwogICAgICAgICAgaWYgKHJlc3VsdCAhPT0gbnVsbCkgewogICAgICAgICAgICBkYXRhW25hbWVdW3Jlc3VsdFsxXV0gPSB2OwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ2hlYWRlcicpIHsKICAgICAgICBpZiAoaGVhZGVyc1toZWFkZXJdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IG1lbWJlci5pc0pzb25WYWx1ZSA/CiAgICAgICAgICAgIHV0aWwuYmFzZTY0LmRlY29kZShoZWFkZXJzW2hlYWRlcl0pIDoKICAgICAgICAgICAgaGVhZGVyc1toZWFkZXJdOwogICAgICAgICAgZGF0YVtuYW1lXSA9IG1lbWJlci50b1R5cGUodmFsdWUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdzdGF0dXNDb2RlJykgewogICAgICAgIGRhdGFbbmFtZV0gPSBwYXJzZUludChyLnN0YXR1c0NvZGUsIDEwKTsKICAgICAgfQogICAgfSk7CiAgCiAgICByZXNwLmRhdGEgPSBkYXRhOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIGJ1aWxkUmVxdWVzdDogYnVpbGRSZXF1ZXN0LAogICAgZXh0cmFjdEVycm9yOiBleHRyYWN0RXJyb3IsCiAgICBleHRyYWN0RGF0YTogZXh0cmFjdERhdGEsCiAgICBnZW5lcmF0ZVVSSTogZ2VuZXJhdGVVUkkKICB9OwogIAogIH0seyIuLi91dGlsIjo3MSwiLi9oZWxwZXJzIjo0NX1dLDQ5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgUmVzdCA9IHJlcXVpcmUoJy4vcmVzdCcpOwogIHZhciBKc29uID0gcmVxdWlyZSgnLi9qc29uJyk7CiAgdmFyIEpzb25CdWlsZGVyID0gcmVxdWlyZSgnLi4vanNvbi9idWlsZGVyJyk7CiAgdmFyIEpzb25QYXJzZXIgPSByZXF1aXJlKCcuLi9qc29uL3BhcnNlcicpOwogIAogIGZ1bmN0aW9uIHBvcHVsYXRlQm9keShyZXEpIHsKICAgIHZhciBidWlsZGVyID0gbmV3IEpzb25CdWlsZGVyKCk7CiAgICB2YXIgaW5wdXQgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dDsKICAKICAgIGlmIChpbnB1dC5wYXlsb2FkKSB7CiAgICAgIHZhciBwYXJhbXMgPSB7fTsKICAgICAgdmFyIHBheWxvYWRTaGFwZSA9IGlucHV0Lm1lbWJlcnNbaW5wdXQucGF5bG9hZF07CiAgICAgIHBhcmFtcyA9IHJlcS5wYXJhbXNbaW5wdXQucGF5bG9hZF07CiAgICAgIGlmIChwYXJhbXMgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogIAogICAgICBpZiAocGF5bG9hZFNoYXBlLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmJvZHkgPSBidWlsZGVyLmJ1aWxkKHBhcmFtcywgcGF5bG9hZFNoYXBlKTsKICAgICAgICBhcHBseUNvbnRlbnRUeXBlSGVhZGVyKHJlcSk7CiAgICAgIH0gZWxzZSB7IC8vIG5vbi1KU09OIHBheWxvYWQKICAgICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IHBhcmFtczsKICAgICAgICBpZiAocGF5bG9hZFNoYXBlLnR5cGUgPT09ICdiaW5hcnknIHx8IHBheWxvYWRTaGFwZS5pc1N0cmVhbWluZykgewogICAgICAgICAgYXBwbHlDb250ZW50VHlwZUhlYWRlcihyZXEsIHRydWUpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGJvZHkgPSBidWlsZGVyLmJ1aWxkKHJlcS5wYXJhbXMsIGlucHV0KTsKICAgICAgaWYgKGJvZHkgIT09ICd7fScgfHwgcmVxLmh0dHBSZXF1ZXN0Lm1ldGhvZCAhPT0gJ0dFVCcpIHsgLy9kb24ndCBzZW5kIGVtcHR5IGJvZHkgZm9yIEdFVCBtZXRob2QKICAgICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IGJvZHk7CiAgICAgIH0KICAgICAgYXBwbHlDb250ZW50VHlwZUhlYWRlcihyZXEpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBhcHBseUNvbnRlbnRUeXBlSGVhZGVyKHJlcSwgaXNCaW5hcnkpIHsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBpbnB1dCA9IG9wZXJhdGlvbi5pbnB1dDsKICAKICAgIGlmICghcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddKSB7CiAgICAgIHZhciB0eXBlID0gaXNCaW5hcnkgPyAnYmluYXJ5L29jdGV0LXN0cmVhbScgOiAnYXBwbGljYXRpb24vanNvbic7CiAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXSA9IHR5cGU7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGJ1aWxkUmVxdWVzdChyZXEpIHsKICAgIFJlc3QuYnVpbGRSZXF1ZXN0KHJlcSk7CiAgCiAgICAvLyBuZXZlciBzZW5kIGJvZHkgcGF5bG9hZCBvbiBIRUFEL0RFTEVURQogICAgaWYgKFsnSEVBRCcsICdERUxFVEUnXS5pbmRleE9mKHJlcS5odHRwUmVxdWVzdC5tZXRob2QpIDwgMCkgewogICAgICBwb3B1bGF0ZUJvZHkocmVxKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gZXh0cmFjdEVycm9yKHJlc3ApIHsKICAgIEpzb24uZXh0cmFjdEVycm9yKHJlc3ApOwogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RGF0YShyZXNwKSB7CiAgICBSZXN0LmV4dHJhY3REYXRhKHJlc3ApOwogIAogICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBydWxlcyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLm91dHB1dCB8fCB7fTsKICAgIHZhciBwYXJzZXI7CiAgICB2YXIgaGFzRXZlbnRPdXRwdXQgPSBvcGVyYXRpb24uaGFzRXZlbnRPdXRwdXQ7CiAgCiAgICBpZiAocnVsZXMucGF5bG9hZCkgewogICAgICB2YXIgcGF5bG9hZE1lbWJlciA9IHJ1bGVzLm1lbWJlcnNbcnVsZXMucGF5bG9hZF07CiAgICAgIHZhciBib2R5ID0gcmVzcC5odHRwUmVzcG9uc2UuYm9keTsKICAgICAgaWYgKHBheWxvYWRNZW1iZXIuaXNFdmVudFN0cmVhbSkgewogICAgICAgIHBhcnNlciA9IG5ldyBKc29uUGFyc2VyKCk7CiAgICAgICAgcmVzcC5kYXRhW3BheWxvYWRdID0gdXRpbC5jcmVhdGVFdmVudFN0cmVhbSgKICAgICAgICAgIEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyID8gcmVzcC5odHRwUmVzcG9uc2Uuc3RyZWFtIDogYm9keSwKICAgICAgICAgIHBhcnNlciwKICAgICAgICAgIHBheWxvYWRNZW1iZXIKICAgICAgICApOwogICAgICB9IGVsc2UgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ3N0cnVjdHVyZScgfHwgcGF5bG9hZE1lbWJlci50eXBlID09PSAnbGlzdCcpIHsKICAgICAgICB2YXIgcGFyc2VyID0gbmV3IEpzb25QYXJzZXIoKTsKICAgICAgICByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0gPSBwYXJzZXIucGFyc2UoYm9keSwgcGF5bG9hZE1lbWJlcik7CiAgICAgIH0gZWxzZSBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnYmluYXJ5JyB8fCBwYXlsb2FkTWVtYmVyLmlzU3RyZWFtaW5nKSB7CiAgICAgICAgcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdID0gYm9keTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0gPSBwYXlsb2FkTWVtYmVyLnRvVHlwZShib2R5KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGRhdGEgPSByZXNwLmRhdGE7CiAgICAgIEpzb24uZXh0cmFjdERhdGEocmVzcCk7CiAgICAgIHJlc3AuZGF0YSA9IHV0aWwubWVyZ2UoZGF0YSwgcmVzcC5kYXRhKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICAgIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogICAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhCiAgfTsKICAKICB9LHsiLi4vanNvbi9idWlsZGVyIjozNiwiLi4vanNvbi9wYXJzZXIiOjM3LCIuLi91dGlsIjo3MSwiLi9qc29uIjo0NiwiLi9yZXN0Ijo0OH1dLDUwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBSZXN0ID0gcmVxdWlyZSgnLi9yZXN0Jyk7CiAgCiAgZnVuY3Rpb24gcG9wdWxhdGVCb2R5KHJlcSkgewogICAgdmFyIGlucHV0ID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQ7CiAgICB2YXIgYnVpbGRlciA9IG5ldyBBV1MuWE1MLkJ1aWxkZXIoKTsKICAgIHZhciBwYXJhbXMgPSByZXEucGFyYW1zOwogIAogICAgdmFyIHBheWxvYWQgPSBpbnB1dC5wYXlsb2FkOwogICAgaWYgKHBheWxvYWQpIHsKICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBpbnB1dC5tZW1iZXJzW3BheWxvYWRdOwogICAgICBwYXJhbXMgPSBwYXJhbXNbcGF5bG9hZF07CiAgICAgIGlmIChwYXJhbXMgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogIAogICAgICBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnc3RydWN0dXJlJykgewogICAgICAgIHZhciByb290RWxlbWVudCA9IHBheWxvYWRNZW1iZXIubmFtZTsKICAgICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IGJ1aWxkZXIudG9YTUwocGFyYW1zLCBwYXlsb2FkTWVtYmVyLCByb290RWxlbWVudCwgdHJ1ZSk7CiAgICAgIH0gZWxzZSB7IC8vIG5vbi14bWwgcGF5bG9hZAogICAgICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gcGFyYW1zOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IGJ1aWxkZXIudG9YTUwocGFyYW1zLCBpbnB1dCwgaW5wdXQubmFtZSB8fAogICAgICAgIGlucHV0LnNoYXBlIHx8IHV0aWwuc3RyaW5nLnVwcGVyRmlyc3QocmVxLm9wZXJhdGlvbikgKyAnUmVxdWVzdCcpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBidWlsZFJlcXVlc3QocmVxKSB7CiAgICBSZXN0LmJ1aWxkUmVxdWVzdChyZXEpOwogIAogICAgLy8gbmV2ZXIgc2VuZCBib2R5IHBheWxvYWQgb24gR0VUL0hFQUQKICAgIGlmIChbJ0dFVCcsICdIRUFEJ10uaW5kZXhPZihyZXEuaHR0cFJlcXVlc3QubWV0aG9kKSA8IDApIHsKICAgICAgcG9wdWxhdGVCb2R5KHJlcSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3RFcnJvcihyZXNwKSB7CiAgICBSZXN0LmV4dHJhY3RFcnJvcihyZXNwKTsKICAKICAgIHZhciBkYXRhOwogICAgdHJ5IHsKICAgICAgZGF0YSA9IG5ldyBBV1MuWE1MLlBhcnNlcigpLnBhcnNlKHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkudG9TdHJpbmcoKSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGRhdGEgPSB7CiAgICAgICAgQ29kZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSwKICAgICAgICBNZXNzYWdlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNNZXNzYWdlCiAgICAgIH07CiAgICB9CiAgCiAgICBpZiAoZGF0YS5FcnJvcnMpIGRhdGEgPSBkYXRhLkVycm9yczsKICAgIGlmIChkYXRhLkVycm9yKSBkYXRhID0gZGF0YS5FcnJvcjsKICAgIGlmIChkYXRhLkNvZGUpIHsKICAgICAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiBkYXRhLkNvZGUsCiAgICAgICAgbWVzc2FnZTogZGF0YS5NZXNzYWdlCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlLAogICAgICAgIG1lc3NhZ2U6IG51bGwKICAgICAgfSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICAgIFJlc3QuZXh0cmFjdERhdGEocmVzcCk7CiAgCiAgICB2YXIgcGFyc2VyOwogICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgIHZhciBib2R5ID0gcmVzcC5odHRwUmVzcG9uc2UuYm9keTsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBvdXRwdXQgPSBvcGVyYXRpb24ub3V0cHV0OwogIAogICAgdmFyIGhhc0V2ZW50T3V0cHV0ID0gb3BlcmF0aW9uLmhhc0V2ZW50T3V0cHV0OwogIAogICAgdmFyIHBheWxvYWQgPSBvdXRwdXQucGF5bG9hZDsKICAgIGlmIChwYXlsb2FkKSB7CiAgICAgIHZhciBwYXlsb2FkTWVtYmVyID0gb3V0cHV0Lm1lbWJlcnNbcGF5bG9hZF07CiAgICAgIGlmIChwYXlsb2FkTWVtYmVyLmlzRXZlbnRTdHJlYW0pIHsKICAgICAgICBwYXJzZXIgPSBuZXcgQVdTLlhNTC5QYXJzZXIoKTsKICAgICAgICByZXNwLmRhdGFbcGF5bG9hZF0gPSB1dGlsLmNyZWF0ZUV2ZW50U3RyZWFtKAogICAgICAgICAgQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIgPyByZXNwLmh0dHBSZXNwb25zZS5zdHJlYW0gOiByZXNwLmh0dHBSZXNwb25zZS5ib2R5LAogICAgICAgICAgcGFyc2VyLAogICAgICAgICAgcGF5bG9hZE1lbWJlcgogICAgICAgICk7CiAgICAgIH0gZWxzZSBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnc3RydWN0dXJlJykgewogICAgICAgIHBhcnNlciA9IG5ldyBBV1MuWE1MLlBhcnNlcigpOwogICAgICAgIHJlc3AuZGF0YVtwYXlsb2FkXSA9IHBhcnNlci5wYXJzZShib2R5LnRvU3RyaW5nKCksIHBheWxvYWRNZW1iZXIpOwogICAgICB9IGVsc2UgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ2JpbmFyeScgfHwgcGF5bG9hZE1lbWJlci5pc1N0cmVhbWluZykgewogICAgICAgIHJlc3AuZGF0YVtwYXlsb2FkXSA9IGJvZHk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzcC5kYXRhW3BheWxvYWRdID0gcGF5bG9hZE1lbWJlci50b1R5cGUoYm9keSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoYm9keS5sZW5ndGggPiAwKSB7CiAgICAgIHBhcnNlciA9IG5ldyBBV1MuWE1MLlBhcnNlcigpOwogICAgICB2YXIgZGF0YSA9IHBhcnNlci5wYXJzZShib2R5LnRvU3RyaW5nKCksIG91dHB1dCk7CiAgICAgIHV0aWwudXBkYXRlKHJlc3AuZGF0YSwgZGF0YSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgYnVpbGRSZXF1ZXN0OiBidWlsZFJlcXVlc3QsCiAgICBleHRyYWN0RXJyb3I6IGV4dHJhY3RFcnJvciwKICAgIGV4dHJhY3REYXRhOiBleHRyYWN0RGF0YQogIH07CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuLi91dGlsIjo3MSwiLi9yZXN0Ijo0OH1dLDUxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICAKICBmdW5jdGlvbiBRdWVyeVBhcmFtU2VyaWFsaXplcigpIHsKICB9CiAgCiAgUXVlcnlQYXJhbVNlcmlhbGl6ZXIucHJvdG90eXBlLnNlcmlhbGl6ZSA9IGZ1bmN0aW9uKHBhcmFtcywgc2hhcGUsIGZuKSB7CiAgICBzZXJpYWxpemVTdHJ1Y3R1cmUoJycsIHBhcmFtcywgc2hhcGUsIGZuKTsKICB9OwogIAogIGZ1bmN0aW9uIHVjZmlyc3Qoc2hhcGUpIHsKICAgIGlmIChzaGFwZS5pc1F1ZXJ5TmFtZSB8fCBzaGFwZS5hcGkucHJvdG9jb2wgIT09ICdlYzInKSB7CiAgICAgIHJldHVybiBzaGFwZS5uYW1lOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHNoYXBlLm5hbWVbMF0udG9VcHBlckNhc2UoKSArIHNoYXBlLm5hbWUuc3Vic3RyKDEpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVTdHJ1Y3R1cmUocHJlZml4LCBzdHJ1Y3QsIHJ1bGVzLCBmbikgewogICAgdXRpbC5lYWNoKHJ1bGVzLm1lbWJlcnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlcikgewogICAgICB2YXIgdmFsdWUgPSBzdHJ1Y3RbbmFtZV07CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgCiAgICAgIHZhciBtZW1iZXJOYW1lID0gdWNmaXJzdChtZW1iZXIpOwogICAgICBtZW1iZXJOYW1lID0gcHJlZml4ID8gcHJlZml4ICsgJy4nICsgbWVtYmVyTmFtZSA6IG1lbWJlck5hbWU7CiAgICAgIHNlcmlhbGl6ZU1lbWJlcihtZW1iZXJOYW1lLCB2YWx1ZSwgbWVtYmVyLCBmbik7CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplTWFwKG5hbWUsIG1hcCwgcnVsZXMsIGZuKSB7CiAgICB2YXIgaSA9IDE7CiAgICB1dGlsLmVhY2gobWFwLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICB2YXIgcHJlZml4ID0gcnVsZXMuZmxhdHRlbmVkID8gJy4nIDogJy5lbnRyeS4nOwogICAgICB2YXIgcG9zaXRpb24gPSBwcmVmaXggKyAoaSsrKSArICcuJzsKICAgICAgdmFyIGtleU5hbWUgPSBwb3NpdGlvbiArIChydWxlcy5rZXkubmFtZSB8fCAna2V5Jyk7CiAgICAgIHZhciB2YWx1ZU5hbWUgPSBwb3NpdGlvbiArIChydWxlcy52YWx1ZS5uYW1lIHx8ICd2YWx1ZScpOwogICAgICBzZXJpYWxpemVNZW1iZXIobmFtZSArIGtleU5hbWUsIGtleSwgcnVsZXMua2V5LCBmbik7CiAgICAgIHNlcmlhbGl6ZU1lbWJlcihuYW1lICsgdmFsdWVOYW1lLCB2YWx1ZSwgcnVsZXMudmFsdWUsIGZuKTsKICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVMaXN0KG5hbWUsIGxpc3QsIHJ1bGVzLCBmbikgewogICAgdmFyIG1lbWJlclJ1bGVzID0gcnVsZXMubWVtYmVyIHx8IHt9OwogIAogICAgaWYgKGxpc3QubGVuZ3RoID09PSAwKSB7CiAgICAgIGZuLmNhbGwodGhpcywgbmFtZSwgbnVsbCk7CiAgICAgIHJldHVybjsKICAgIH0KICAKICAgIHV0aWwuYXJyYXlFYWNoKGxpc3QsIGZ1bmN0aW9uICh2LCBuKSB7CiAgICAgIHZhciBzdWZmaXggPSAnLicgKyAobiArIDEpOwogICAgICBpZiAocnVsZXMuYXBpLnByb3RvY29sID09PSAnZWMyJykgewogICAgICAgIC8vIERvIG5vdGhpbmcgZm9yIEVDMgogICAgICAgIHN1ZmZpeCA9IHN1ZmZpeCArICcnOyAvLyBtYWtlIGxpbnRlciBoYXBweQogICAgICB9IGVsc2UgaWYgKHJ1bGVzLmZsYXR0ZW5lZCkgewogICAgICAgIGlmIChtZW1iZXJSdWxlcy5uYW1lKSB7CiAgICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCcuJyk7CiAgICAgICAgICBwYXJ0cy5wb3AoKTsKICAgICAgICAgIHBhcnRzLnB1c2godWNmaXJzdChtZW1iZXJSdWxlcykpOwogICAgICAgICAgbmFtZSA9IHBhcnRzLmpvaW4oJy4nKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3VmZml4ID0gJy4nICsgKG1lbWJlclJ1bGVzLm5hbWUgPyBtZW1iZXJSdWxlcy5uYW1lIDogJ21lbWJlcicpICsgc3VmZml4OwogICAgICB9CiAgICAgIHNlcmlhbGl6ZU1lbWJlcihuYW1lICsgc3VmZml4LCB2LCBtZW1iZXJSdWxlcywgZm4pOwogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZU1lbWJlcihuYW1lLCB2YWx1ZSwgcnVsZXMsIGZuKSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgaWYgKHJ1bGVzLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgIHNlcmlhbGl6ZVN0cnVjdHVyZShuYW1lLCB2YWx1ZSwgcnVsZXMsIGZuKTsKICAgIH0gZWxzZSBpZiAocnVsZXMudHlwZSA9PT0gJ2xpc3QnKSB7CiAgICAgIHNlcmlhbGl6ZUxpc3QobmFtZSwgdmFsdWUsIHJ1bGVzLCBmbik7CiAgICB9IGVsc2UgaWYgKHJ1bGVzLnR5cGUgPT09ICdtYXAnKSB7CiAgICAgIHNlcmlhbGl6ZU1hcChuYW1lLCB2YWx1ZSwgcnVsZXMsIGZuKTsKICAgIH0gZWxzZSB7CiAgICAgIGZuKG5hbWUsIHJ1bGVzLnRvV2lyZUZvcm1hdCh2YWx1ZSkudG9TdHJpbmcoKSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gUXVlcnlQYXJhbVNlcmlhbGl6ZXI7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxfV0sNTI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzID0gewogICAgLy9wcm92aWRlIHJlYWx0aW1lIGNsb2NrIGZvciBwZXJmb3JtYW5jZSBtZWFzdXJlbWVudAogICAgbm93OiBmdW5jdGlvbiBub3coKSB7CiAgICAgIGlmICh0eXBlb2YgcGVyZm9ybWFuY2UgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBwZXJmb3JtYW5jZS5ub3cgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm4gcGVyZm9ybWFuY2Uubm93KCk7CiAgICAgIH0KICAgICAgcmV0dXJuIERhdGUubm93KCk7CiAgICB9CiAgfTsKICAKICB9LHt9XSw1MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuL3V0aWwnKTsKICB2YXIgcmVnaW9uQ29uZmlnID0gcmVxdWlyZSgnLi9yZWdpb25fY29uZmlnX2RhdGEuanNvbicpOwogIAogIGZ1bmN0aW9uIGdlbmVyYXRlUmVnaW9uUHJlZml4KHJlZ2lvbikgewogICAgaWYgKCFyZWdpb24pIHJldHVybiBudWxsOwogIAogICAgdmFyIHBhcnRzID0gcmVnaW9uLnNwbGl0KCctJyk7CiAgICBpZiAocGFydHMubGVuZ3RoIDwgMykgcmV0dXJuIG51bGw7CiAgICByZXR1cm4gcGFydHMuc2xpY2UoMCwgcGFydHMubGVuZ3RoIC0gMikuam9pbignLScpICsgJy0qJzsKICB9CiAgCiAgZnVuY3Rpb24gZGVyaXZlZEtleXMoc2VydmljZSkgewogICAgdmFyIHJlZ2lvbiA9IHNlcnZpY2UuY29uZmlnLnJlZ2lvbjsKICAgIHZhciByZWdpb25QcmVmaXggPSBnZW5lcmF0ZVJlZ2lvblByZWZpeChyZWdpb24pOwogICAgdmFyIGVuZHBvaW50UHJlZml4ID0gc2VydmljZS5hcGkuZW5kcG9pbnRQcmVmaXg7CiAgCiAgICByZXR1cm4gWwogICAgICBbcmVnaW9uLCBlbmRwb2ludFByZWZpeF0sCiAgICAgIFtyZWdpb25QcmVmaXgsIGVuZHBvaW50UHJlZml4XSwKICAgICAgW3JlZ2lvbiwgJyonXSwKICAgICAgW3JlZ2lvblByZWZpeCwgJyonXSwKICAgICAgWycqJywgZW5kcG9pbnRQcmVmaXhdLAogICAgICBbJyonLCAnKiddCiAgICBdLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgIHJldHVybiBpdGVtWzBdICYmIGl0ZW1bMV0gPyBpdGVtLmpvaW4oJy8nKSA6IG51bGw7CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gYXBwbHlDb25maWcoc2VydmljZSwgY29uZmlnKSB7CiAgICB1dGlsLmVhY2goY29uZmlnLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIGlmIChrZXkgPT09ICdnbG9iYWxFbmRwb2ludCcpIHJldHVybjsKICAgICAgaWYgKHNlcnZpY2UuY29uZmlnW2tleV0gPT09IHVuZGVmaW5lZCB8fCBzZXJ2aWNlLmNvbmZpZ1trZXldID09PSBudWxsKSB7CiAgICAgICAgc2VydmljZS5jb25maWdba2V5XSA9IHZhbHVlOwogICAgICB9CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gY29uZmlndXJlRW5kcG9pbnQoc2VydmljZSkgewogICAgdmFyIGtleXMgPSBkZXJpdmVkS2V5cyhzZXJ2aWNlKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgaWYgKCFrZXkpIGNvbnRpbnVlOwogIAogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHJlZ2lvbkNvbmZpZy5ydWxlcywga2V5KSkgewogICAgICAgIHZhciBjb25maWcgPSByZWdpb25Db25maWcucnVsZXNba2V5XTsKICAgICAgICBpZiAodHlwZW9mIGNvbmZpZyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGNvbmZpZyA9IHJlZ2lvbkNvbmZpZy5wYXR0ZXJuc1tjb25maWddOwogICAgICAgIH0KICAKICAgICAgICAvLyBzZXQgZHVhbHN0YWNrIGVuZHBvaW50CiAgICAgICAgaWYgKHNlcnZpY2UuY29uZmlnLnVzZUR1YWxzdGFjayAmJiB1dGlsLmlzRHVhbHN0YWNrQXZhaWxhYmxlKHNlcnZpY2UpKSB7CiAgICAgICAgICBjb25maWcgPSB1dGlsLmNvcHkoY29uZmlnKTsKICAgICAgICAgIGNvbmZpZy5lbmRwb2ludCA9ICd7c2VydmljZX0uZHVhbHN0YWNrLntyZWdpb259LmFtYXpvbmF3cy5jb20nOwogICAgICAgIH0KICAKICAgICAgICAvLyBzZXQgZ2xvYmFsIGVuZHBvaW50CiAgICAgICAgc2VydmljZS5pc0dsb2JhbEVuZHBvaW50ID0gISFjb25maWcuZ2xvYmFsRW5kcG9pbnQ7CiAgCiAgICAgICAgLy8gc2lnbmF0dXJlIHZlcnNpb24KICAgICAgICBpZiAoIWNvbmZpZy5zaWduYXR1cmVWZXJzaW9uKSBjb25maWcuc2lnbmF0dXJlVmVyc2lvbiA9ICd2NCc7CiAgCiAgICAgICAgLy8gbWVyZ2UgY29uZmlnCiAgICAgICAgYXBwbHlDb25maWcoc2VydmljZSwgY29uZmlnKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBjb25maWd1cmVFbmRwb2ludDsKICAKICB9LHsiLi9yZWdpb25fY29uZmlnX2RhdGEuanNvbiI6NTQsIi4vdXRpbCI6NzF9XSw1NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHM9ewogICAgInJ1bGVzIjogewogICAgICAiKi8qIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgICAgfSwKICAgICAgImNuLSovKiI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LmFtYXpvbmF3cy5jb20uY24iCiAgICAgIH0sCiAgICAgICIqL2J1ZGdldHMiOiAiZ2xvYmFsU1NMIiwKICAgICAgIiovY2xvdWRmcm9udCI6ICJnbG9iYWxTU0wiLAogICAgICAiKi9pYW0iOiAiZ2xvYmFsU1NMIiwKICAgICAgIiovc3RzIjogImdsb2JhbFNTTCIsCiAgICAgICIqL2ltcG9ydGV4cG9ydCI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInYyIiwKICAgICAgICAiZ2xvYmFsRW5kcG9pbnQiOiB0cnVlCiAgICAgIH0sCiAgICAgICIqL3JvdXRlNTMiOiB7CiAgICAgICAgImVuZHBvaW50IjogImh0dHBzOi8ve3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInYzaHR0cHMiLAogICAgICAgICJnbG9iYWxFbmRwb2ludCI6IHRydWUKICAgICAgfSwKICAgICAgIiovd2FmIjogImdsb2JhbFNTTCIsCiAgICAgICJ1cy1nb3YtKi9pYW0iOiAiZ2xvYmFsR292Q2xvdWQiLAogICAgICAidXMtZ292LSovc3RzIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgICAgfSwKICAgICAgInVzLWdvdi13ZXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAidXMtd2VzdC0xL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICAgInVzLXdlc3QtMi9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAgICJldS13ZXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAiYXAtc291dGhlYXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAiYXAtc291dGhlYXN0LTIvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAiYXAtbm9ydGhlYXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAic2EtZWFzdC0xL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICAgInVzLWVhc3QtMS9zMyI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInMzIgogICAgICB9LAogICAgICAidXMtZWFzdC0xL3NkYiI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInYyIgogICAgICB9LAogICAgICAiKi9zZGIiOiB7CiAgICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hbWF6b25hd3MuY29tIiwKICAgICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJ2MiIKICAgICAgfQogICAgfSwKICAKICAgICJwYXR0ZXJucyI6IHsKICAgICAgImdsb2JhbFNTTCI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAiaHR0cHM6Ly97c2VydmljZX0uYW1hem9uYXdzLmNvbSIsCiAgICAgICAgImdsb2JhbEVuZHBvaW50IjogdHJ1ZQogICAgICB9LAogICAgICAiZ2xvYmFsR292Q2xvdWQiOiB7CiAgICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS51cy1nb3YuYW1hem9uYXdzLmNvbSIKICAgICAgfSwKICAgICAgInMzc2lnbmF0dXJlIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIsCiAgICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAiczMiCiAgICAgIH0KICAgIH0KICB9CiAgCiAgfSx7fV0sNTU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAocHJvY2Vzcyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHZhciBBY2NlcHRvclN0YXRlTWFjaGluZSA9IHJlcXVpcmUoJy4vc3RhdGVfbWFjaGluZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICB2YXIgZG9tYWluID0gQVdTLnV0aWwuZG9tYWluOwogIHZhciBqbWVzcGF0aCA9IHJlcXVpcmUoJ2ptZXNwYXRoJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIGhhcmRFcnJvclN0YXRlcyA9IHtzdWNjZXNzOiAxLCBlcnJvcjogMSwgY29tcGxldGU6IDF9OwogIAogIGZ1bmN0aW9uIGlzVGVybWluYWxTdGF0ZShtYWNoaW5lKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGhhcmRFcnJvclN0YXRlcywgbWFjaGluZS5fYXNtLmN1cnJlbnRTdGF0ZSk7CiAgfQogIAogIHZhciBmc20gPSBuZXcgQWNjZXB0b3JTdGF0ZU1hY2hpbmUoKTsKICBmc20uc2V0dXBTdGF0ZXMgPSBmdW5jdGlvbigpIHsKICAgIHZhciB0cmFuc2l0aW9uID0gZnVuY3Rpb24oXywgZG9uZSkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHNlbGYuX2hhbHRIYW5kbGVyc09uRXJyb3IgPSBmYWxzZTsKICAKICAgICAgc2VsZi5lbWl0KHNlbGYuX2FzbS5jdXJyZW50U3RhdGUsIGZ1bmN0aW9uKGVycikgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIGlmIChpc1Rlcm1pbmFsU3RhdGUoc2VsZikpIHsKICAgICAgICAgICAgaWYgKGRvbWFpbiAmJiBzZWxmLmRvbWFpbiBpbnN0YW5jZW9mIGRvbWFpbi5Eb21haW4pIHsKICAgICAgICAgICAgICBlcnIuZG9tYWluRW1pdHRlciA9IHNlbGY7CiAgICAgICAgICAgICAgZXJyLmRvbWFpbiA9IHNlbGYuZG9tYWluOwogICAgICAgICAgICAgIGVyci5kb21haW5UaHJvd24gPSBmYWxzZTsKICAgICAgICAgICAgICBzZWxmLmRvbWFpbi5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxmLnJlc3BvbnNlLmVycm9yID0gZXJyOwogICAgICAgICAgICBkb25lKGVycik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRvbmUoc2VsZi5yZXNwb25zZS5lcnJvcik7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgIH07CiAgCiAgICB0aGlzLmFkZFN0YXRlKCd2YWxpZGF0ZScsICdidWlsZCcsICdlcnJvcicsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnYnVpbGQnLCAnYWZ0ZXJCdWlsZCcsICdyZXN0YXJ0JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdhZnRlckJ1aWxkJywgJ3NpZ24nLCAncmVzdGFydCcsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnc2lnbicsICdzZW5kJywgJ3JldHJ5JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdyZXRyeScsICdhZnRlclJldHJ5JywgJ2FmdGVyUmV0cnknLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ2FmdGVyUmV0cnknLCAnc2lnbicsICdlcnJvcicsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnc2VuZCcsICd2YWxpZGF0ZVJlc3BvbnNlJywgJ3JldHJ5JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCd2YWxpZGF0ZVJlc3BvbnNlJywgJ2V4dHJhY3REYXRhJywgJ2V4dHJhY3RFcnJvcicsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnZXh0cmFjdEVycm9yJywgJ2V4dHJhY3REYXRhJywgJ3JldHJ5JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdleHRyYWN0RGF0YScsICdzdWNjZXNzJywgJ3JldHJ5JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdyZXN0YXJ0JywgJ2J1aWxkJywgJ2Vycm9yJywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdzdWNjZXNzJywgJ2NvbXBsZXRlJywgJ2NvbXBsZXRlJywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdlcnJvcicsICdjb21wbGV0ZScsICdjb21wbGV0ZScsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnY29tcGxldGUnLCBudWxsLCBudWxsLCB0cmFuc2l0aW9uKTsKICB9OwogIGZzbS5zZXR1cFN0YXRlcygpOwogIAogIC8qKgogICAqICMjIEFzeW5jaHJvbm91cyBSZXF1ZXN0cwogICAqCiAgICogQWxsIHJlcXVlc3RzIG1hZGUgdGhyb3VnaCB0aGUgU0RLIGFyZSBhc3luY2hyb25vdXMgYW5kIHVzZSBhCiAgICogY2FsbGJhY2sgaW50ZXJmYWNlLiBFYWNoIHNlcnZpY2UgbWV0aG9kIHRoYXQga2lja3Mgb2ZmIGEgcmVxdWVzdAogICAqIHJldHVybnMgYW4gYEFXUy5SZXF1ZXN0YCBvYmplY3QgdGhhdCB5b3UgY2FuIHVzZSB0byByZWdpc3RlcgogICAqIGNhbGxiYWNrcy4KICAgKgogICAqIEZvciBleGFtcGxlLCB0aGUgZm9sbG93aW5nIHNlcnZpY2UgbWV0aG9kIHJldHVybnMgdGhlIHJlcXVlc3QKICAgKiBvYmplY3QgYXMgInJlcXVlc3QiLCB3aGljaCBjYW4gYmUgdXNlZCB0byByZWdpc3RlciBjYWxsYmFja3M6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogLy8gcmVxdWVzdCBpcyBhbiBBV1MuUmVxdWVzdCBvYmplY3QKICAgKiB2YXIgcmVxdWVzdCA9IGVjMi5kZXNjcmliZUluc3RhbmNlcygpOwogICAqCiAgICogLy8gcmVnaXN0ZXIgY2FsbGJhY2tzIG9uIHJlcXVlc3QgdG8gcmV0cmlldmUgcmVzcG9uc2UgZGF0YQogICAqIHJlcXVlc3Qub24oJ3N1Y2Nlc3MnLCBmdW5jdGlvbihyZXNwb25zZSkgewogICAqICAgY29uc29sZS5sb2cocmVzcG9uc2UuZGF0YSk7CiAgICogfSk7CiAgICogYGBgCiAgICoKICAgKiBXaGVuIGEgcmVxdWVzdCBpcyByZWFkeSB0byBiZSBzZW50LCB0aGUge3NlbmR9IG1ldGhvZCBzaG91bGQKICAgKiBiZSBjYWxsZWQ6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogcmVxdWVzdC5zZW5kKCk7CiAgICogYGBgCiAgICoKICAgKiBTaW5jZSByZWdpc3RlcmVkIGNhbGxiYWNrcyBtYXkgb3IgbWF5IG5vdCBiZSBpZGVtcG90ZW50LCByZXF1ZXN0cyBzaG91bGQgb25seQogICAqIGJlIHNlbnQgb25jZS4gVG8gcGVyZm9ybSB0aGUgc2FtZSBvcGVyYXRpb24gbXVsdGlwbGUgdGltZXMsIHlvdSB3aWxsIG5lZWQgdG8KICAgKiBjcmVhdGUgbXVsdGlwbGUgcmVxdWVzdCBvYmplY3RzLCBlYWNoIHdpdGggaXRzIG93biByZWdpc3RlcmVkIGNhbGxiYWNrcy4KICAgKgogICAqICMjIFJlbW92aW5nIERlZmF1bHQgTGlzdGVuZXJzIGZvciBFdmVudHMKICAgKgogICAqIFJlcXVlc3Qgb2JqZWN0cyBhcmUgYnVpbHQgd2l0aCBkZWZhdWx0IGxpc3RlbmVycyBmb3IgdGhlIHZhcmlvdXMgZXZlbnRzLAogICAqIGRlcGVuZGluZyBvbiB0aGUgc2VydmljZSB0eXBlLiBJbiBzb21lIGNhc2VzLCB5b3UgbWF5IHdhbnQgdG8gcmVtb3ZlCiAgICogc29tZSBidWlsdC1pbiBsaXN0ZW5lcnMgdG8gY3VzdG9taXplIGJlaGF2aW91ci4gRG9pbmcgdGhpcyByZXF1aXJlcwogICAqIGFjY2VzcyB0byB0aGUgYnVpbHQtaW4gbGlzdGVuZXIgZnVuY3Rpb25zLCB3aGljaCBhcmUgZXhwb3NlZCB0aHJvdWdoCiAgICogdGhlIHtBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZX0gbmFtZXNwYWNlLiBGb3IgaW5zdGFuY2UsIHlvdSBtYXkKICAgKiB3YW50IHRvIGN1c3RvbWl6ZSB0aGUgSFRUUCBoYW5kbGVyIHVzZWQgd2hlbiBzZW5kaW5nIGEgcmVxdWVzdC4gSW4gdGhpcwogICAqIGNhc2UsIHlvdSBjYW4gcmVtb3ZlIHRoZSBidWlsdC1pbiBsaXN0ZW5lciBhc3NvY2lhdGVkIHdpdGggdGhlICdzZW5kJwogICAqIGV2ZW50LCB0aGUge0FXUy5FdmVudExpc3RlbmVycy5Db3JlLlNFTkR9IGxpc3RlbmVyIGFuZCBhZGQgeW91ciBvd24uCiAgICoKICAgKiAjIyBNdWx0aXBsZSBDYWxsYmFja3MgYW5kIENoYWluaW5nCiAgICoKICAgKiBZb3UgY2FuIHJlZ2lzdGVyIG11bHRpcGxlIGNhbGxiYWNrcyBvbiBhbnkgcmVxdWVzdCBvYmplY3QuIFRoZQogICAqIGNhbGxiYWNrcyBjYW4gYmUgcmVnaXN0ZXJlZCBmb3IgZGlmZmVyZW50IGV2ZW50cywgb3IgYWxsIGZvciB0aGUKICAgKiBzYW1lIGV2ZW50LiBJbiBhZGRpdGlvbiwgeW91IGNhbiBjaGFpbiBjYWxsYmFjayByZWdpc3RyYXRpb24sIGZvcgogICAqIGV4YW1wbGU6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogcmVxdWVzdC4KICAgKiAgIG9uKCdzdWNjZXNzJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgKiAgICAgY29uc29sZS5sb2coIlN1Y2Nlc3MhIik7CiAgICogICB9KS4KICAgKiAgIG9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycm9yLCByZXNwb25zZSkgewogICAqICAgICBjb25zb2xlLmxvZygiRXJyb3IhIik7CiAgICogICB9KS4KICAgKiAgIG9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICogICAgIGNvbnNvbGUubG9nKCJBbHdheXMhIik7CiAgICogICB9KS4KICAgKiAgIHNlbmQoKTsKICAgKiBgYGAKICAgKgogICAqIFRoZSBhYm92ZSBleGFtcGxlIHdpbGwgcHJpbnQgZWl0aGVyICJTdWNjZXNzISBBbHdheXMhIiwgb3IgIkVycm9yISBBbHdheXMhIiwKICAgKiBkZXBlbmRpbmcgb24gd2hldGhlciB0aGUgcmVxdWVzdCBzdWNjZWVkZWQgb3Igbm90LgogICAqCiAgICogQCFhdHRyaWJ1dGUgaHR0cFJlcXVlc3QKICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBIVFRQIFByb3BlcnRpZXMKICAgKiAgIEByZXR1cm4gW0FXUy5IdHRwUmVxdWVzdF0gdGhlIHJhdyBIVFRQIHJlcXVlc3Qgb2JqZWN0CiAgICogICAgIGNvbnRhaW5pbmcgcmVxdWVzdCBoZWFkZXJzIGFuZCBib2R5IGluZm9ybWF0aW9uCiAgICogICAgIHNlbnQgYnkgdGhlIHNlcnZpY2UuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzdGFydFRpbWUKICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBPcGVyYXRpb24gUHJvcGVydGllcwogICAqICAgQHJldHVybiBbRGF0ZV0gdGhlIHRpbWUgdGhhdCB0aGUgcmVxdWVzdCBzdGFydGVkCiAgICoKICAgKiBAIWdyb3VwIFJlcXVlc3QgQnVpbGRpbmcgRXZlbnRzCiAgICoKICAgKiBAIWV2ZW50IHZhbGlkYXRlKHJlcXVlc3QpCiAgICogICBUcmlnZ2VyZWQgd2hlbiBhIHJlcXVlc3QgaXMgYmVpbmcgdmFsaWRhdGVkLiBMaXN0ZW5lcnMKICAgKiAgIHNob3VsZCB0aHJvdyBhbiBlcnJvciBpZiB0aGUgcmVxdWVzdCBzaG91bGQgbm90IGJlIHNlbnQuCiAgICogICBAcGFyYW0gcmVxdWVzdCBbUmVxdWVzdF0gdGhlIHJlcXVlc3Qgb2JqZWN0IGJlaW5nIHNlbnQKICAgKiAgIEBzZWUgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfQ1JFREVOVElBTFMKICAgKiAgIEBzZWUgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUkVHSU9OCiAgICogICBAZXhhbXBsZSBFbnN1cmluZyB0aGF0IGEgY2VydGFpbiBwYXJhbWV0ZXIgaXMgc2V0IGJlZm9yZSBzZW5kaW5nIGEgcmVxdWVzdAogICAqICAgICB2YXIgcmVxID0gczMucHV0T2JqZWN0KHBhcmFtcyk7CiAgICogICAgIHJlcS5vbigndmFsaWRhdGUnLCBmdW5jdGlvbigpIHsKICAgKiAgICAgICBpZiAoIXJlcS5wYXJhbXMuQm9keS5tYXRjaCgvXkhlbGxvXHMvKSkgewogICAqICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCb2R5IG11c3Qgc3RhcnQgd2l0aCAiSGVsbG8gIicpOwogICAqICAgICAgIH0KICAgKiAgICAgfSk7CiAgICogICAgIHJlcS5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgeyAuLi4gfSk7CiAgICoKICAgKiBAIWV2ZW50IGJ1aWxkKHJlcXVlc3QpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgcmVxdWVzdCBwYXlsb2FkIGlzIGJlaW5nIGJ1aWx0LiBMaXN0ZW5lcnMKICAgKiAgIHNob3VsZCBmaWxsIHRoZSBuZWNlc3NhcnkgaW5mb3JtYXRpb24gdG8gc2VuZCB0aGUgcmVxdWVzdAogICAqICAgb3ZlciBIVFRQLgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+dmFsaWRhdGUpCiAgICogICBAZXhhbXBsZSBBZGQgYSBjdXN0b20gSFRUUCBoZWFkZXIgdG8gYSByZXF1ZXN0CiAgICogICAgIHZhciByZXEgPSBzMy5wdXRPYmplY3QocGFyYW1zKTsKICAgKiAgICAgcmVxLm9uKCdidWlsZCcsIGZ1bmN0aW9uKCkgewogICAqICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDdXN0b20tSGVhZGVyJ10gPSAndmFsdWUnOwogICAqICAgICB9KTsKICAgKiAgICAgcmVxLnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7IC4uLiB9KTsKICAgKgogICAqIEAhZXZlbnQgc2lnbihyZXF1ZXN0KQogICAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIHJlcXVlc3QgaXMgYmVpbmcgc2lnbmVkLiBMaXN0ZW5lcnMgc2hvdWxkCiAgICogICBhZGQgdGhlIGNvcnJlY3QgYXV0aGVudGljYXRpb24gaGVhZGVycyBhbmQvb3IgYWRqdXN0IHRoZSBib2R5LAogICAqICAgZGVwZW5kaW5nIG9uIHRoZSBhdXRoZW50aWNhdGlvbiBtZWNoYW5pc20gYmVpbmcgdXNlZC4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnZhbGlkYXRlKQogICAqCiAgICogQCFncm91cCBSZXF1ZXN0IFNlbmRpbmcgRXZlbnRzCiAgICoKICAgKiBAIWV2ZW50IHNlbmQocmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgcmVxdWVzdCBpcyByZWFkeSB0byBiZSBzZW50LiBMaXN0ZW5lcnMKICAgKiAgIHNob3VsZCBjYWxsIHRoZSB1bmRlcmx5aW5nIHRyYW5zcG9ydCBsYXllciB0byBpbml0aWF0ZQogICAqICAgdGhlIHNlbmRpbmcgb2YgdGhlIHJlcXVlc3QuCiAgICogICBAcGFyYW0gcmVzcG9uc2UgW1Jlc3BvbnNlXSB0aGUgcmVzcG9uc2Ugb2JqZWN0CiAgICogICBAY29udGV4dCBbUmVxdWVzdF0gdGhlIHJlcXVlc3Qgb2JqZWN0IHRoYXQgd2FzIHNlbnQKICAgKiAgIEBzZWUgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuU0VORAogICAqCiAgICogQCFldmVudCByZXRyeShyZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIGEgcmVxdWVzdCBmYWlsZWQgYW5kIG1pZ2h0IG5lZWQgdG8gYmUgcmV0cmllZCBvciByZWRpcmVjdGVkLgogICAqICAgSWYgdGhlIHJlc3BvbnNlIGlzIHJldHJ5YWJsZSwgdGhlIGxpc3RlbmVyIHNob3VsZCBzZXQgdGhlCiAgICogICBgcmVzcG9uc2UuZXJyb3IucmV0cnlhYmxlYCBwcm9wZXJ0eSB0byBgdHJ1ZWAsIGFuZCBvcHRpb25hbGx5IHNldAogICAqICAgYHJlc3BvbnNlLmVycm9yLnJldHJ5RGVsYXlgIHRvIHRoZSBtaWxsaXNlY29uZCBkZWxheSBmb3IgdGhlIG5leHQgYXR0ZW1wdC4KICAgKiAgIEluIHRoZSBjYXNlIG9mIGEgcmVkaXJlY3QsIGByZXNwb25zZS5lcnJvci5yZWRpcmVjdGAgc2hvdWxkIGJlIHNldCB0bwogICAqICAgYHRydWVgIHdpdGggYHJldHJ5RGVsYXlgIHNldCB0byBhbiBvcHRpb25hbCBkZWxheSBvbiB0aGUgbmV4dCByZXF1ZXN0LgogICAqCiAgICogICBJZiBhIGxpc3RlbmVyIGRlY2lkZXMgdGhhdCBhIHJlcXVlc3Qgc2hvdWxkIG5vdCBiZSByZXRyaWVkLAogICAqICAgaXQgc2hvdWxkIHNldCBib3RoIGByZXRyeWFibGVgIGFuZCBgcmVkaXJlY3RgIHRvIGZhbHNlLgogICAqCiAgICogICBOb3RlIHRoYXQgYSByZXRyeWFibGUgZXJyb3Igd2lsbCBiZSByZXRyaWVkIGF0IG1vc3QKICAgKiAgIHtBV1MuQ29uZmlnLm1heFJldHJpZXN9IHRpbWVzIChiYXNlZCBvbiB0aGUgc2VydmljZSBvYmplY3QncyBjb25maWcpLgogICAqICAgU2ltaWxhcmx5LCBhIHJlcXVlc3QgdGhhdCBpcyByZWRpcmVjdGVkIHdpbGwgb25seSByZWRpcmVjdCBhdCBtb3N0CiAgICogICB7QVdTLkNvbmZpZy5tYXhSZWRpcmVjdHN9IHRpbWVzLgogICAqCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGV4YW1wbGUgQWRkaW5nIGEgY3VzdG9tIHJldHJ5IGZvciBhIDQwNCByZXNwb25zZQogICAqICAgICByZXF1ZXN0Lm9uKCdyZXRyeScsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICogICAgICAgLy8gdGhpcyByZXNvdXJjZSBpcyBub3QgeWV0IGF2YWlsYWJsZSwgd2FpdCAxMCBzZWNvbmRzIHRvIGdldCBpdCBhZ2FpbgogICAqICAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gNDA0ICYmIHJlc3BvbnNlLmVycm9yKSB7CiAgICogICAgICAgICByZXNwb25zZS5lcnJvci5yZXRyeWFibGUgPSB0cnVlOyAgIC8vIHJldHJ5IHRoaXMgZXJyb3IKICAgKiAgICAgICAgIHJlc3BvbnNlLmVycm9yLnJldHJ5RGVsYXkgPSAxMDAwMDsgLy8gd2FpdCAxMCBzZWNvbmRzCiAgICogICAgICAgfQogICAqICAgICB9KTsKICAgKgogICAqIEAhZ3JvdXAgRGF0YSBQYXJzaW5nIEV2ZW50cwogICAqCiAgICogQCFldmVudCBleHRyYWN0RXJyb3IocmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgb24gYWxsIG5vbi0yeHggcmVxdWVzdHMgc28gdGhhdCBsaXN0ZW5lcnMgY2FuIGV4dHJhY3QKICAgKiAgIGVycm9yIGRldGFpbHMgZnJvbSB0aGUgcmVzcG9uc2UgYm9keS4gTGlzdGVuZXJzIHRvIHRoaXMgZXZlbnQKICAgKiAgIHNob3VsZCBzZXQgdGhlIGByZXNwb25zZS5lcnJvcmAgcHJvcGVydHkuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQCFldmVudCBleHRyYWN0RGF0YShyZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCBpbiBzdWNjZXNzZnVsIHJlcXVlc3RzIHRvIGFsbG93IGxpc3RlbmVycyB0bwogICAqICAgZGUtc2VyaWFsaXplIHRoZSByZXNwb25zZSBib2R5IGludG8gYHJlc3BvbnNlLmRhdGFgLgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEAhZ3JvdXAgQ29tcGxldGlvbiBFdmVudHMKICAgKgogICAqIEAhZXZlbnQgc3VjY2VzcyhyZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSByZXF1ZXN0IGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkuCiAgICogICBgcmVzcG9uc2UuZGF0YWAgd2lsbCBjb250YWluIHRoZSByZXNwb25zZSBkYXRhIGFuZAogICAqICAgYHJlc3BvbnNlLmVycm9yYCB3aWxsIGJlIG51bGwuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQCFldmVudCBlcnJvcihlcnJvciwgcmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiBhbiBlcnJvciBvY2N1cnMgYXQgYW55IHBvaW50IGR1cmluZyB0aGUKICAgKiAgIHJlcXVlc3QuIGByZXNwb25zZS5lcnJvcmAgd2lsbCBjb250YWluIGRldGFpbHMgYWJvdXQgdGhlIGVycm9yCiAgICogICB0aGF0IG9jY3VycmVkLiBgcmVzcG9uc2UuZGF0YWAgd2lsbCBiZSBudWxsLgogICAqICAgQHBhcmFtIGVycm9yIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCBjb250YWluaW5nIGRldGFpbHMgYWJvdXQKICAgKiAgICAgdGhlIGVycm9yIHRoYXQgb2NjdXJyZWQuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQCFldmVudCBjb21wbGV0ZShyZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuZXZlciBhIHJlcXVlc3QgY3ljbGUgY29tcGxldGVzLiBgcmVzcG9uc2UuZXJyb3JgCiAgICogICBzaG91bGQgYmUgY2hlY2tlZCwgc2luY2UgdGhlIHJlcXVlc3QgbWF5IGhhdmUgZmFpbGVkLgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEAhZ3JvdXAgSFRUUCBFdmVudHMKICAgKgogICAqIEAhZXZlbnQgaHR0cEhlYWRlcnMoc3RhdHVzQ29kZSwgaGVhZGVycywgcmVzcG9uc2UsIHN0YXR1c01lc3NhZ2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiBoZWFkZXJzIGFyZSBzZW50IGJ5IHRoZSByZW1vdGUgc2VydmVyCiAgICogICBAcGFyYW0gc3RhdHVzQ29kZSBbSW50ZWdlcl0gdGhlIEhUVFAgcmVzcG9uc2UgY29kZQogICAqICAgQHBhcmFtIGhlYWRlcnMgW21hcDxTdHJpbmcsU3RyaW5nPl0gdGhlIHJlc3BvbnNlIGhlYWRlcnMKICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAcGFyYW0gc3RhdHVzTWVzc2FnZSBbU3RyaW5nXSBBIHN0YXR1cyBtZXNzYWdlIGNvcnJlc3BvbmRpbmcgdG8gdGhlIEhUVFAKICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlIGNvZGUKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEAhZXZlbnQgaHR0cERhdGEoY2h1bmssIHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gZGF0YSBpcyBzZW50IGJ5IHRoZSByZW1vdGUgc2VydmVyCiAgICogICBAcGFyYW0gY2h1bmsgW0J1ZmZlcl0gdGhlIGJ1ZmZlciBkYXRhIGNvbnRhaW5pbmcgdGhlIG5leHQgZGF0YSBjaHVuawogICAqICAgICBmcm9tIHRoZSBzZXJ2ZXIKICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAc2VlIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLkhUVFBfREFUQQogICAqCiAgICogQCFldmVudCBodHRwVXBsb2FkUHJvZ3Jlc3MocHJvZ3Jlc3MsIHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIEhUVFAgcmVxdWVzdCBoYXMgdXBsb2FkZWQgbW9yZSBkYXRhCiAgICogICBAcGFyYW0gcHJvZ3Jlc3MgW21hcF0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGBsb2FkZWRgIGFuZCBgdG90YWxgIGJ5dGVzCiAgICogICAgIG9mIHRoZSByZXF1ZXN0LgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBub3RlIFRoaXMgZXZlbnQgd2lsbCBub3QgYmUgZW1pdHRlZCBpbiBOb2RlLmpzIDAuOC54LgogICAqCiAgICogQCFldmVudCBodHRwRG93bmxvYWRQcm9ncmVzcyhwcm9ncmVzcywgcmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgSFRUUCByZXF1ZXN0IGhhcyBkb3dubG9hZGVkIG1vcmUgZGF0YQogICAqICAgQHBhcmFtIHByb2dyZXNzIFttYXBdIEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBgbG9hZGVkYCBhbmQgYHRvdGFsYCBieXRlcwogICAqICAgICBvZiB0aGUgcmVxdWVzdC4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAbm90ZSBUaGlzIGV2ZW50IHdpbGwgbm90IGJlIGVtaXR0ZWQgaW4gTm9kZS5qcyAwLjgueC4KICAgKgogICAqIEAhZXZlbnQgaHR0cEVycm9yKGVycm9yLCByZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSBIVFRQIHJlcXVlc3QgZmFpbGVkCiAgICogICBAcGFyYW0gZXJyb3IgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHRoYXQgd2FzIHRocm93bgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEAhZXZlbnQgaHR0cERvbmUocmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgc2VydmVyIGlzIGZpbmlzaGVkIHNlbmRpbmcgZGF0YQogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEBzZWUgQVdTLlJlc3BvbnNlCiAgICovCiAgQVdTLlJlcXVlc3QgPSBpbmhlcml0KHsKICAKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHJlcXVlc3QgZm9yIGFuIG9wZXJhdGlvbiBvbiBhIGdpdmVuIHNlcnZpY2Ugd2l0aAogICAgICogYSBzZXQgb2YgaW5wdXQgcGFyYW1ldGVycy4KICAgICAqCiAgICAgKiBAcGFyYW0gc2VydmljZSBbQVdTLlNlcnZpY2VdIHRoZSBzZXJ2aWNlIHRvIHBlcmZvcm0gdGhlIG9wZXJhdGlvbiBvbgogICAgICogQHBhcmFtIG9wZXJhdGlvbiBbU3RyaW5nXSB0aGUgb3BlcmF0aW9uIHRvIHBlcmZvcm0gb24gdGhlIHNlcnZpY2UKICAgICAqIEBwYXJhbSBwYXJhbXMgW09iamVjdF0gcGFyYW1ldGVycyB0byBzZW5kIHRvIHRoZSBvcGVyYXRpb24uCiAgICAgKiAgIFNlZSB0aGUgb3BlcmF0aW9uJ3MgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIGZvcm1hdCBvZiB0aGUKICAgICAqICAgcGFyYW1ldGVycy4KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFJlcXVlc3Qoc2VydmljZSwgb3BlcmF0aW9uLCBwYXJhbXMpIHsKICAgICAgdmFyIGVuZHBvaW50ID0gc2VydmljZS5lbmRwb2ludDsKICAgICAgdmFyIHJlZ2lvbiA9IHNlcnZpY2UuY29uZmlnLnJlZ2lvbjsKICAgICAgdmFyIGN1c3RvbVVzZXJBZ2VudCA9IHNlcnZpY2UuY29uZmlnLmN1c3RvbVVzZXJBZ2VudDsKICAKICAgICAgLy8gZ2xvYmFsIGVuZHBvaW50cyBzaWduIGFzIHVzLWVhc3QtMQogICAgICBpZiAoc2VydmljZS5pc0dsb2JhbEVuZHBvaW50KSByZWdpb24gPSAndXMtZWFzdC0xJzsKICAKICAgICAgdGhpcy5kb21haW4gPSBkb21haW4gJiYgZG9tYWluLmFjdGl2ZTsKICAgICAgdGhpcy5zZXJ2aWNlID0gc2VydmljZTsKICAgICAgdGhpcy5vcGVyYXRpb24gPSBvcGVyYXRpb247CiAgICAgIHRoaXMucGFyYW1zID0gcGFyYW1zIHx8IHt9OwogICAgICB0aGlzLmh0dHBSZXF1ZXN0ID0gbmV3IEFXUy5IdHRwUmVxdWVzdChlbmRwb2ludCwgcmVnaW9uKTsKICAgICAgdGhpcy5odHRwUmVxdWVzdC5hcHBlbmRUb1VzZXJBZ2VudChjdXN0b21Vc2VyQWdlbnQpOwogICAgICB0aGlzLnN0YXJ0VGltZSA9IHNlcnZpY2UuZ2V0U2tld0NvcnJlY3RlZERhdGUoKTsKICAKICAgICAgdGhpcy5yZXNwb25zZSA9IG5ldyBBV1MuUmVzcG9uc2UodGhpcyk7CiAgICAgIHRoaXMuX2FzbSA9IG5ldyBBY2NlcHRvclN0YXRlTWFjaGluZShmc20uc3RhdGVzLCAndmFsaWRhdGUnKTsKICAgICAgdGhpcy5faGFsdEhhbmRsZXJzT25FcnJvciA9IGZhbHNlOwogIAogICAgICBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuZW1pdCA9IHRoaXMuZW1pdEV2ZW50OwogICAgfSwKICAKICAgIC8qKgogICAgICogQCFncm91cCBTZW5kaW5nIGEgUmVxdWVzdAogICAgICovCiAgCiAgICAvKioKICAgICAqIEBvdmVybG9hZCBzZW5kKGNhbGxiYWNrID0gbnVsbCkKICAgICAqICAgU2VuZHMgdGhlIHJlcXVlc3Qgb2JqZWN0LgogICAgICoKICAgICAqICAgQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgICAqICAgICBJZiBhIGNhbGxiYWNrIGlzIHN1cHBsaWVkLCBpdCBpcyBjYWxsZWQgd2hlbiBhIHJlc3BvbnNlIGlzIHJldHVybmVkCiAgICAgKiAgICAgZnJvbSB0aGUgc2VydmljZS4KICAgICAqICAgICBAY29udGV4dCBbQVdTLlJlcXVlc3RdIHRoZSByZXF1ZXN0IG9iamVjdCBiZWluZyBzZW50LgogICAgICogICAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICAgKiAgICAgICBTZXQgdG8gYG51bGxgIGlmIHRoZSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwuCiAgICAgKiAgICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgZGF0YSByZXR1cm5lZCBmcm9tCiAgICAgKiAgICAgICB0aGUgcmVxdWVzdC4gU2V0IHRvIGBudWxsYCBpZiBhIHJlcXVlc3QgZXJyb3Igb2NjdXJzLgogICAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRoIGEgY2FsbGJhY2sKICAgICAqICAgICByZXF1ZXN0ID0gczMucHV0T2JqZWN0KHtCdWNrZXQ6ICdidWNrZXQnLCBLZXk6ICdrZXknfSk7CiAgICAgKiAgICAgcmVxdWVzdC5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgeyBjb25zb2xlLmxvZyhlcnIsIGRhdGEpOyB9KTsKICAgICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3Qgd2l0aCBubyBjYWxsYmFjayAodXNpbmcgZXZlbnQgaGFuZGxlcnMpCiAgICAgKiAgICAgcmVxdWVzdCA9IHMzLnB1dE9iamVjdCh7QnVja2V0OiAnYnVja2V0JywgS2V5OiAna2V5J30pOwogICAgICogICAgIHJlcXVlc3Qub24oJ2NvbXBsZXRlJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsgLi4uIH0pOyAvLyByZWdpc3RlciBhIGNhbGxiYWNrCiAgICAgKiAgICAgcmVxdWVzdC5zZW5kKCk7CiAgICAgKi8KICAgIHNlbmQ6IGZ1bmN0aW9uIHNlbmQoY2FsbGJhY2spIHsKICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgLy8gYXBwZW5kIHRvIHVzZXIgYWdlbnQKICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0LmFwcGVuZFRvVXNlckFnZW50KCdjYWxsYmFjaycpOwogICAgICAgIHRoaXMub24oJ2NvbXBsZXRlJywgZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICAgIGNhbGxiYWNrLmNhbGwocmVzcCwgcmVzcC5lcnJvciwgcmVzcC5kYXRhKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICB0aGlzLnJ1blRvKCk7CiAgCiAgICAgIHJldHVybiB0aGlzLnJlc3BvbnNlOwogICAgfSwKICAKICAgIC8qKgogICAgICogQCFtZXRob2QgIHByb21pc2UoKQogICAgICogICBTZW5kcyB0aGUgcmVxdWVzdCBhbmQgcmV0dXJucyBhICd0aGVuYWJsZScgcHJvbWlzZS4KICAgICAqCiAgICAgKiAgIFR3byBjYWxsYmFja3MgY2FuIGJlIHByb3ZpZGVkIHRvIHRoZSBgdGhlbmAgbWV0aG9kIG9uIHRoZSByZXR1cm5lZCBwcm9taXNlLgogICAgICogICBUaGUgZmlyc3QgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLCBhbmQgdGhlIHNlY29uZAogICAgICogICBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAqICAgQGNhbGxiYWNrIGZ1bGZpbGxlZENhbGxiYWNrIGZ1bmN0aW9uKGRhdGEpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZC4KICAgICAqICAgICBAcGFyYW0gZGF0YSBbT2JqZWN0XSB0aGUgZGUtc2VyaWFsaXplZCBkYXRhIHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICAgKiAgIEBjYWxsYmFjayByZWplY3RlZENhbGxiYWNrIGZ1bmN0aW9uKGVycm9yKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAqICAgICBAcGFyYW0gZXJyb3IgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICAgKiAgIEByZXR1cm4gW1Byb21pc2VdIEEgcHJvbWlzZSB0aGF0IHJlcHJlc2VudHMgdGhlIHN0YXRlIG9mIHRoZSByZXF1ZXN0LgogICAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB1c2luZyBwcm9taXNlcy4KICAgICAqICAgICB2YXIgcmVxdWVzdCA9IHMzLnB1dE9iamVjdCh7QnVja2V0OiAnYnVja2V0JywgS2V5OiAna2V5J30pOwogICAgICogICAgIHZhciByZXN1bHQgPSByZXF1ZXN0LnByb21pc2UoKTsKICAgICAqICAgICByZXN1bHQudGhlbihmdW5jdGlvbihkYXRhKSB7IC4uLiB9LCBmdW5jdGlvbihlcnJvcikgeyAuLi4gfSk7CiAgICAgKi8KICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGJ1aWxkOiBmdW5jdGlvbiBidWlsZChjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5ydW5Ubygnc2VuZCcsIGNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBydW5UbzogZnVuY3Rpb24gcnVuVG8oc3RhdGUsIGRvbmUpIHsKICAgICAgdGhpcy5fYXNtLnJ1blRvKHN0YXRlLCBkb25lLCB0aGlzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBBYm9ydHMgYSByZXF1ZXN0LCBlbWl0dGluZyB0aGUgZXJyb3IgYW5kIGNvbXBsZXRlIGV2ZW50cy4KICAgICAqCiAgICAgKiBAIW1hY3JvIG5vYnJvd3NlcgogICAgICogQGV4YW1wbGUgQWJvcnRpbmcgYSByZXF1ZXN0IGFmdGVyIHNlbmRpbmcKICAgICAqICAgdmFyIHBhcmFtcyA9IHsKICAgICAqICAgICBCdWNrZXQ6ICdidWNrZXQnLCBLZXk6ICdrZXknLAogICAgICogICAgIEJvZHk6IEJ1ZmZlci5hbGxvYygxMDI0ICogMTAyNCAqIDUpIC8vIDVNQiBwYXlsb2FkCiAgICAgKiAgIH07CiAgICAgKiAgIHZhciByZXF1ZXN0ID0gczMucHV0T2JqZWN0KHBhcmFtcyk7CiAgICAgKiAgIHJlcXVlc3Quc2VuZChmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgKiAgICAgaWYgKGVycikgY29uc29sZS5sb2coIkVycm9yOiIsIGVyci5jb2RlLCBlcnIubWVzc2FnZSk7CiAgICAgKiAgICAgZWxzZSBjb25zb2xlLmxvZyhkYXRhKTsKICAgICAqICAgfSk7CiAgICAgKgogICAgICogICAvLyBhYm9ydCByZXF1ZXN0IGluIDEgc2Vjb25kCiAgICAgKiAgIHNldFRpbWVvdXQocmVxdWVzdC5hYm9ydC5iaW5kKHJlcXVlc3QpLCAxMDAwKTsKICAgICAqCiAgICAgKiAgIC8vIHByaW50cyAiRXJyb3I6IFJlcXVlc3RBYm9ydGVkRXJyb3IgUmVxdWVzdCBhYm9ydGVkIGJ5IHVzZXIiCiAgICAgKiBAcmV0dXJuIFtBV1MuUmVxdWVzdF0gdGhlIHNhbWUgcmVxdWVzdCBvYmplY3QsIGZvciBjaGFpbmluZy4KICAgICAqIEBzaW5jZSB2MS40LjAKICAgICAqLwogICAgYWJvcnQ6IGZ1bmN0aW9uIGFib3J0KCkgewogICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygndmFsaWRhdGVSZXNwb25zZScpOwogICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygnZXh0cmFjdEVycm9yJyk7CiAgICAgIHRoaXMub24oJ3ZhbGlkYXRlUmVzcG9uc2UnLCBmdW5jdGlvbiBhZGRBYm9ydGVkRXJyb3IocmVzcCkgewogICAgICAgIHJlc3AuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ1JlcXVlc3QgYWJvcnRlZCBieSB1c2VyJyksIHsKICAgICAgICAgICBjb2RlOiAnUmVxdWVzdEFib3J0ZWRFcnJvcicsIHJldHJ5YWJsZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgfSk7CiAgCiAgICAgIGlmICh0aGlzLmh0dHBSZXF1ZXN0LnN0cmVhbSAmJiAhdGhpcy5odHRwUmVxdWVzdC5zdHJlYW0uZGlkQ2FsbGJhY2spIHsgLy8gYWJvcnQgSFRUUCBzdHJlYW0KICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0LnN0cmVhbS5hYm9ydCgpOwogICAgICAgIGlmICh0aGlzLmh0dHBSZXF1ZXN0Ll9hYm9ydENhbGxiYWNrKSB7CiAgICAgICAgICAgdGhpcy5odHRwUmVxdWVzdC5fYWJvcnRDYWxsYmFjaygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygnc2VuZCcpOyAvLyBoYXZlbid0IHNlbnQgeWV0LCBzbyBsZXQncyBub3QKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBJdGVyYXRlcyBvdmVyIGVhY2ggcGFnZSBvZiByZXN1bHRzIGdpdmVuIGEgcGFnZWFibGUgcmVxdWVzdCwgY2FsbGluZwogICAgICogdGhlIHByb3ZpZGVkIGNhbGxiYWNrIHdpdGggZWFjaCBwYWdlIG9mIGRhdGEuIEFmdGVyIGFsbCBwYWdlcyBoYXZlIGJlZW4KICAgICAqIHJldHJpZXZlZCwgdGhlIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIGBudWxsYCBkYXRhLgogICAgICoKICAgICAqIEBub3RlIFRoaXMgb3BlcmF0aW9uIGNhbiBnZW5lcmF0ZSBtdWx0aXBsZSByZXF1ZXN0cyB0byBhIHNlcnZpY2UuCiAgICAgKiBAZXhhbXBsZSBJdGVyYXRpbmcgb3ZlciBtdWx0aXBsZSBwYWdlcyBvZiBvYmplY3RzIGluIGFuIFMzIGJ1Y2tldAogICAgICogICB2YXIgcGFnZXMgPSAxOwogICAgICogICBzMy5saXN0T2JqZWN0cygpLmVhY2hQYWdlKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICogICAgIGlmIChlcnIpIHJldHVybjsKICAgICAqICAgICBjb25zb2xlLmxvZygiUGFnZSIsIHBhZ2VzKyspOwogICAgICogICAgIGNvbnNvbGUubG9nKGRhdGEpOwogICAgICogICB9KTsKICAgICAqIEBleGFtcGxlIEl0ZXJhdGluZyBvdmVyIG11bHRpcGxlIHBhZ2VzIHdpdGggYW4gYXN5bmNocm9ub3VzIGNhbGxiYWNrCiAgICAgKiAgIHMzLmxpc3RPYmplY3RzKHBhcmFtcykuZWFjaFBhZ2UoZnVuY3Rpb24oZXJyLCBkYXRhLCBkb25lKSB7CiAgICAgKiAgICAgZG9Tb21ldGhpbmdBc3luY0FuZE9yRXhwZW5zaXZlKGZ1bmN0aW9uKCkgewogICAgICogICAgICAgLy8gVGhlIG5leHQgcGFnZSBvZiByZXN1bHRzIGlzbid0IGZldGNoZWQgdW50aWwgZG9uZSBpcyBjYWxsZWQKICAgICAqICAgICAgIGRvbmUoKTsKICAgICAqICAgICB9KTsKICAgICAqICAgfSk7CiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBkYXRhLCBbZG9uZUNhbGxiYWNrXSkKICAgICAqICAgQ2FsbGVkIHdpdGggZWFjaCBwYWdlIG9mIHJlc3VsdGluZyBkYXRhIGZyb20gdGhlIHJlcXVlc3QuIElmIHRoZQogICAgICogICBvcHRpb25hbCBgZG9uZUNhbGxiYWNrYCBpcyBwcm92aWRlZCBpbiB0aGUgZnVuY3Rpb24sIGl0IG11c3QgYmUgY2FsbGVkCiAgICAgKiAgIHdoZW4gdGhlIGNhbGxiYWNrIGlzIGNvbXBsZXRlLgogICAgICoKICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGFuIGVycm9yIG9iamVjdCwgaWYgYW4gZXJyb3Igb2NjdXJyZWQuCiAgICAgKiAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIGEgc2luZ2xlIHBhZ2Ugb2YgcmVzcG9uc2UgZGF0YS4gSWYgdGhlcmUgaXMgbm8KICAgICAqICAgICBtb3JlIGRhdGEsIHRoaXMgb2JqZWN0IHdpbGwgYmUgYG51bGxgLgogICAgICogICBAcGFyYW0gZG9uZUNhbGxiYWNrIFtGdW5jdGlvbl0gYW4gb3B0aW9uYWwgZG9uZSBjYWxsYmFjay4gSWYgdGhpcwogICAgICogICAgIGFyZ3VtZW50IGlzIGRlZmluZWQgaW4gdGhlIGZ1bmN0aW9uIGRlY2xhcmF0aW9uLCBpdCBzaG91bGQgYmUgY2FsbGVkCiAgICAgKiAgICAgd2hlbiB0aGUgbmV4dCBwYWdlIGlzIHJlYWR5IHRvIGJlIHJldHJpZXZlZC4gVGhpcyBpcyB1c2VmdWwgZm9yCiAgICAgKiAgICAgY29udHJvbGxpbmcgc2VyaWFsIHBhZ2luYXRpb24gYWNyb3NzIGFzeW5jaHJvbm91cyBvcGVyYXRpb25zLgogICAgICogICBAcmV0dXJuIFtCb29sZWFuXSBpZiB0aGUgY2FsbGJhY2sgcmV0dXJucyBgZmFsc2VgLCBwYWdpbmF0aW9uIHdpbGwKICAgICAqICAgICBzdG9wLgogICAgICoKICAgICAqIEBzZWUgQVdTLlJlcXVlc3QuZWFjaEl0ZW0KICAgICAqIEBzZWUgQVdTLlJlc3BvbnNlLm5leHRQYWdlCiAgICAgKiBAc2luY2UgdjEuNC4wCiAgICAgKi8KICAgIGVhY2hQYWdlOiBmdW5jdGlvbiBlYWNoUGFnZShjYWxsYmFjaykgewogICAgICAvLyBNYWtlIGFsbCBjYWxsYmFja3MgYXN5bmMtaXNoCiAgICAgIGNhbGxiYWNrID0gQVdTLnV0aWwuZm4ubWFrZUFzeW5jKGNhbGxiYWNrLCAzKTsKICAKICAgICAgZnVuY3Rpb24gd3JhcHBlZENhbGxiYWNrKHJlc3BvbnNlKSB7CiAgICAgICAgY2FsbGJhY2suY2FsbChyZXNwb25zZSwgcmVzcG9uc2UuZXJyb3IsIHJlc3BvbnNlLmRhdGEsIGZ1bmN0aW9uIChyZXN1bHQpIHsKICAgICAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKSByZXR1cm47CiAgCiAgICAgICAgICBpZiAocmVzcG9uc2UuaGFzTmV4dFBhZ2UoKSkgewogICAgICAgICAgICByZXNwb25zZS5uZXh0UGFnZSgpLm9uKCdjb21wbGV0ZScsIHdyYXBwZWRDYWxsYmFjaykuc2VuZCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2FsbGJhY2suY2FsbChyZXNwb25zZSwgbnVsbCwgbnVsbCwgQVdTLnV0aWwuZm4ubm9vcCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAKICAgICAgdGhpcy5vbignY29tcGxldGUnLCB3cmFwcGVkQ2FsbGJhY2spLnNlbmQoKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEVudW1lcmF0ZXMgb3ZlciBpbmRpdmlkdWFsIGl0ZW1zIG9mIGEgcmVxdWVzdCwgcGFnaW5nIHRoZSByZXNwb25zZXMgaWYKICAgICAqIG5lY2Vzc2FyeS4KICAgICAqCiAgICAgKiBAYXBpIGV4cGVyaW1lbnRhbAogICAgICogQHNpbmNlIHYxLjQuMAogICAgICovCiAgICBlYWNoSXRlbTogZnVuY3Rpb24gZWFjaEl0ZW0oY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBmdW5jdGlvbiB3cmFwcGVkQ2FsbGJhY2soZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKGVycikgcmV0dXJuIGNhbGxiYWNrKGVyciwgbnVsbCk7CiAgICAgICAgaWYgKGRhdGEgPT09IG51bGwpIHJldHVybiBjYWxsYmFjayhudWxsLCBudWxsKTsKICAKICAgICAgICB2YXIgY29uZmlnID0gc2VsZi5zZXJ2aWNlLnBhZ2luYXRpb25Db25maWcoc2VsZi5vcGVyYXRpb24pOwogICAgICAgIHZhciByZXN1bHRLZXkgPSBjb25maWcucmVzdWx0S2V5OwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdEtleSkpIHJlc3VsdEtleSA9IHJlc3VsdEtleVswXTsKICAgICAgICB2YXIgaXRlbXMgPSBqbWVzcGF0aC5zZWFyY2goZGF0YSwgcmVzdWx0S2V5KTsKICAgICAgICB2YXIgY29udGludWVJdGVyYXRpb24gPSB0cnVlOwogICAgICAgIEFXUy51dGlsLmFycmF5RWFjaChpdGVtcywgZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgY29udGludWVJdGVyYXRpb24gPSBjYWxsYmFjayhudWxsLCBpdGVtKTsKICAgICAgICAgIGlmIChjb250aW51ZUl0ZXJhdGlvbiA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgcmV0dXJuIEFXUy51dGlsLmFib3J0OwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBjb250aW51ZUl0ZXJhdGlvbjsKICAgICAgfQogIAogICAgICB0aGlzLmVhY2hQYWdlKHdyYXBwZWRDYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBvcGVyYXRpb24gY2FuIHJldHVybiBtdWx0aXBsZSBwYWdlcyBvZgogICAgICogICByZXNwb25zZSBkYXRhLgogICAgICogQHNlZSBBV1MuUmVzcG9uc2UuZWFjaFBhZ2UKICAgICAqIEBzaW5jZSB2MS40LjAKICAgICAqLwogICAgaXNQYWdlYWJsZTogZnVuY3Rpb24gaXNQYWdlYWJsZSgpIHsKICAgICAgcmV0dXJuIHRoaXMuc2VydmljZS5wYWdpbmF0aW9uQ29uZmlnKHRoaXMub3BlcmF0aW9uKSA/IHRydWUgOiBmYWxzZTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFNlbmRzIHRoZSByZXF1ZXN0IGFuZCBjb252ZXJ0cyB0aGUgcmVxdWVzdCBvYmplY3QgaW50byBhIHJlYWRhYmxlIHN0cmVhbQogICAgICogdGhhdCBjYW4gYmUgcmVhZCBmcm9tIG9yIHBpcGVkIGludG8gYSB3cml0YWJsZSBzdHJlYW0uCiAgICAgKgogICAgICogQG5vdGUgVGhlIGRhdGEgcmVhZCBmcm9tIGEgcmVhZGFibGUgc3RyZWFtIGNvbnRhaW5zIG9ubHkKICAgICAqICAgdGhlIHJhdyBIVFRQIGJvZHkgY29udGVudHMuCiAgICAgKiBAZXhhbXBsZSBNYW51YWxseSByZWFkaW5nIGZyb20gYSBzdHJlYW0KICAgICAqICAgcmVxdWVzdC5jcmVhdGVSZWFkU3RyZWFtKCkub24oJ2RhdGEnLCBmdW5jdGlvbihkYXRhKSB7CiAgICAgKiAgICAgY29uc29sZS5sb2coIkdvdCBkYXRhOiIsIGRhdGEudG9TdHJpbmcoKSk7CiAgICAgKiAgIH0pOwogICAgICogQGV4YW1wbGUgUGlwaW5nIGEgcmVxdWVzdCBib2R5IGludG8gYSBmaWxlCiAgICAgKiAgIHZhciBvdXQgPSBmcy5jcmVhdGVXcml0ZVN0cmVhbSgnL3BhdGgvdG8vb3V0ZmlsZS5qcGcnKTsKICAgICAqICAgczMuc2VydmljZS5nZXRPYmplY3QocGFyYW1zKS5jcmVhdGVSZWFkU3RyZWFtKCkucGlwZShvdXQpOwogICAgICogQHJldHVybiBbU3RyZWFtXSB0aGUgcmVhZGFibGUgc3RyZWFtIG9iamVjdCB0aGF0IGNhbiBiZSBwaXBlZAogICAgICogICBvciByZWFkIGZyb20gKGJ5IHJlZ2lzdGVyaW5nICdkYXRhJyBldmVudCBsaXN0ZW5lcnMpLgogICAgICogQCFtYWNybyBub2Jyb3dzZXIKICAgICAqLwogICAgY3JlYXRlUmVhZFN0cmVhbTogZnVuY3Rpb24gY3JlYXRlUmVhZFN0cmVhbSgpIHsKICAgICAgdmFyIHN0cmVhbXMgPSBBV1MudXRpbC5zdHJlYW07CiAgICAgIHZhciByZXEgPSB0aGlzOwogICAgICB2YXIgc3RyZWFtID0gbnVsbDsKICAKICAgICAgaWYgKEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyKSB7CiAgICAgICAgc3RyZWFtID0gbmV3IHN0cmVhbXMuUGFzc1Rocm91Z2goKTsKICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgeyByZXEuc2VuZCgpOyB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdHJlYW0gPSBuZXcgc3RyZWFtcy5TdHJlYW0oKTsKICAgICAgICBzdHJlYW0ucmVhZGFibGUgPSB0cnVlOwogIAogICAgICAgIHN0cmVhbS5zZW50ID0gZmFsc2U7CiAgICAgICAgc3RyZWFtLm9uKCduZXdMaXN0ZW5lcicsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICBpZiAoIXN0cmVhbS5zZW50ICYmIGV2ZW50ID09PSAnZGF0YScpIHsKICAgICAgICAgICAgc3RyZWFtLnNlbnQgPSB0cnVlOwogICAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgeyByZXEuc2VuZCgpOyB9KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogIAogICAgICB0aGlzLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycikgewogICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgIH0pOwogIAogICAgICB0aGlzLm9uKCdodHRwSGVhZGVycycsIGZ1bmN0aW9uIHN0cmVhbUhlYWRlcnMoc3RhdHVzQ29kZSwgaGVhZGVycywgcmVzcCkgewogICAgICAgIGlmIChzdGF0dXNDb2RlIDwgMzAwKSB7CiAgICAgICAgICByZXEucmVtb3ZlTGlzdGVuZXIoJ2h0dHBEYXRhJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuSFRUUF9EQVRBKTsKICAgICAgICAgIHJlcS5yZW1vdmVMaXN0ZW5lcignaHR0cEVycm9yJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuSFRUUF9FUlJPUik7CiAgICAgICAgICByZXEub24oJ2h0dHBFcnJvcicsIGZ1bmN0aW9uIHN0cmVhbUh0dHBFcnJvcihlcnJvcikgewogICAgICAgICAgICByZXNwLmVycm9yID0gZXJyb3I7CiAgICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gZmFsc2U7CiAgICAgICAgICB9KTsKICAKICAgICAgICAgIHZhciBzaG91bGRDaGVja0NvbnRlbnRMZW5ndGggPSBmYWxzZTsKICAgICAgICAgIHZhciBleHBlY3RlZExlbjsKICAgICAgICAgIGlmIChyZXEuaHR0cFJlcXVlc3QubWV0aG9kICE9PSAnSEVBRCcpIHsKICAgICAgICAgICAgZXhwZWN0ZWRMZW4gPSBwYXJzZUludChoZWFkZXJzWydjb250ZW50LWxlbmd0aCddLCAxMCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXhwZWN0ZWRMZW4gIT09IHVuZGVmaW5lZCAmJiAhaXNOYU4oZXhwZWN0ZWRMZW4pICYmIGV4cGVjdGVkTGVuID49IDApIHsKICAgICAgICAgICAgc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIHJlY2VpdmVkTGVuID0gMDsKICAgICAgICAgIH0KICAKICAgICAgICAgIHZhciBjaGVja0NvbnRlbnRMZW5ndGhBbmRFbWl0ID0gZnVuY3Rpb24gY2hlY2tDb250ZW50TGVuZ3RoQW5kRW1pdCgpIHsKICAgICAgICAgICAgaWYgKHNob3VsZENoZWNrQ29udGVudExlbmd0aCAmJiByZWNlaXZlZExlbiAhPT0gZXhwZWN0ZWRMZW4pIHsKICAgICAgICAgICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBBV1MudXRpbC5lcnJvcigKICAgICAgICAgICAgICAgIG5ldyBFcnJvcignU3RyZWFtIGNvbnRlbnQgbGVuZ3RoIG1pc21hdGNoLiBSZWNlaXZlZCAnICsKICAgICAgICAgICAgICAgICAgcmVjZWl2ZWRMZW4gKyAnIG9mICcgKyBleHBlY3RlZExlbiArICcgYnl0ZXMuJyksCiAgICAgICAgICAgICAgICB7IGNvZGU6ICdTdHJlYW1Db250ZW50TGVuZ3RoTWlzbWF0Y2gnIH0KICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMikgewogICAgICAgICAgICAgIHN0cmVhbS5lbmQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdHJlYW0uZW1pdCgnZW5kJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgCiAgICAgICAgICB2YXIgaHR0cFN0cmVhbSA9IHJlc3AuaHR0cFJlc3BvbnNlLmNyZWF0ZVVuYnVmZmVyZWRTdHJlYW0oKTsKICAKICAgICAgICAgIGlmIChBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMikgewogICAgICAgICAgICBpZiAoc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoKSB7CiAgICAgICAgICAgICAgdmFyIGxlbmd0aEFjY3VtdWxhdG9yID0gbmV3IHN0cmVhbXMuUGFzc1Rocm91Z2goKTsKICAgICAgICAgICAgICBsZW5ndGhBY2N1bXVsYXRvci5fd3JpdGUgPSBmdW5jdGlvbihjaHVuaykgewogICAgICAgICAgICAgICAgaWYgKGNodW5rICYmIGNodW5rLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICByZWNlaXZlZExlbiArPSBjaHVuay5sZW5ndGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gc3RyZWFtcy5QYXNzVGhyb3VnaC5wcm90b3R5cGUuX3dyaXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgfTsKICAKICAgICAgICAgICAgICBsZW5ndGhBY2N1bXVsYXRvci5vbignZW5kJywgY2hlY2tDb250ZW50TGVuZ3RoQW5kRW1pdCk7CiAgICAgICAgICAgICAgc3RyZWFtLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgICAgc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoID0gZmFsc2U7CiAgICAgICAgICAgICAgICBodHRwU3RyZWFtLnVucGlwZShsZW5ndGhBY2N1bXVsYXRvcik7CiAgICAgICAgICAgICAgICBsZW5ndGhBY2N1bXVsYXRvci5lbWl0KCdlbmQnKTsKICAgICAgICAgICAgICAgIGxlbmd0aEFjY3VtdWxhdG9yLmVuZCgpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGh0dHBTdHJlYW0ucGlwZShsZW5ndGhBY2N1bXVsYXRvcikucGlwZShzdHJlYW0sIHsgZW5kOiBmYWxzZSB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBodHRwU3RyZWFtLnBpcGUoc3RyZWFtKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAKICAgICAgICAgICAgaWYgKHNob3VsZENoZWNrQ29udGVudExlbmd0aCkgewogICAgICAgICAgICAgIGh0dHBTdHJlYW0ub24oJ2RhdGEnLCBmdW5jdGlvbihhcmcpIHsKICAgICAgICAgICAgICAgIGlmIChhcmcgJiYgYXJnLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICByZWNlaXZlZExlbiArPSBhcmcubGVuZ3RoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgCiAgICAgICAgICAgIGh0dHBTdHJlYW0ub24oJ2RhdGEnLCBmdW5jdGlvbihhcmcpIHsKICAgICAgICAgICAgICBzdHJlYW0uZW1pdCgnZGF0YScsIGFyZyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBodHRwU3RyZWFtLm9uKCdlbmQnLCBjaGVja0NvbnRlbnRMZW5ndGhBbmRFbWl0KTsKICAgICAgICAgIH0KICAKICAgICAgICAgIGh0dHBTdHJlYW0ub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgIHNob3VsZENoZWNrQ29udGVudExlbmd0aCA9IGZhbHNlOwogICAgICAgICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBlcnIpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgcmV0dXJuIHN0cmVhbTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBwYXJhbSBbQXJyYXksUmVzcG9uc2VdIGFyZ3MgVGhpcyBzaG91bGQgYmUgdGhlIHJlc3BvbnNlIG9iamVjdCwKICAgICAqICAgb3IgYW4gYXJyYXkgb2YgYXJncyB0byBzZW5kIHRvIHRoZSBldmVudC4KICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBlbWl0RXZlbnQ6IGZ1bmN0aW9uIGVtaXQoZXZlbnROYW1lLCBhcmdzLCBkb25lKSB7CiAgICAgIGlmICh0eXBlb2YgYXJncyA9PT0gJ2Z1bmN0aW9uJykgeyBkb25lID0gYXJnczsgYXJncyA9IG51bGw7IH0KICAgICAgaWYgKCFkb25lKSBkb25lID0gZnVuY3Rpb24oKSB7IH07CiAgICAgIGlmICghYXJncykgYXJncyA9IHRoaXMuZXZlbnRQYXJhbWV0ZXJzKGV2ZW50TmFtZSwgdGhpcy5yZXNwb25zZSk7CiAgCiAgICAgIHZhciBvcmlnRW1pdCA9IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IucHJvdG90eXBlLmVtaXQ7CiAgICAgIG9yaWdFbWl0LmNhbGwodGhpcywgZXZlbnROYW1lLCBhcmdzLCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgaWYgKGVycikgdGhpcy5yZXNwb25zZS5lcnJvciA9IGVycjsKICAgICAgICBkb25lLmNhbGwodGhpcywgZXJyKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZXZlbnRQYXJhbWV0ZXJzOiBmdW5jdGlvbiBldmVudFBhcmFtZXRlcnMoZXZlbnROYW1lKSB7CiAgICAgIHN3aXRjaCAoZXZlbnROYW1lKSB7CiAgICAgICAgY2FzZSAncmVzdGFydCc6CiAgICAgICAgY2FzZSAndmFsaWRhdGUnOgogICAgICAgIGNhc2UgJ3NpZ24nOgogICAgICAgIGNhc2UgJ2J1aWxkJzoKICAgICAgICBjYXNlICdhZnRlclZhbGlkYXRlJzoKICAgICAgICBjYXNlICdhZnRlckJ1aWxkJzoKICAgICAgICAgIHJldHVybiBbdGhpc107CiAgICAgICAgY2FzZSAnZXJyb3InOgogICAgICAgICAgcmV0dXJuIFt0aGlzLnJlc3BvbnNlLmVycm9yLCB0aGlzLnJlc3BvbnNlXTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIFt0aGlzLnJlc3BvbnNlXTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHByZXNpZ246IGZ1bmN0aW9uIHByZXNpZ24oZXhwaXJlcywgY2FsbGJhY2spIHsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgZXhwaXJlcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGNhbGxiYWNrID0gZXhwaXJlczsKICAgICAgICBleHBpcmVzID0gbnVsbDsKICAgICAgfQogICAgICByZXR1cm4gbmV3IEFXUy5TaWduZXJzLlByZXNpZ24oKS5zaWduKHRoaXMudG9HZXQoKSwgZXhwaXJlcywgY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGlzUHJlc2lnbmVkOiBmdW5jdGlvbiBpc1ByZXNpZ25lZCgpIHsKICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLmh0dHBSZXF1ZXN0LmhlYWRlcnMsICdwcmVzaWduZWQtZXhwaXJlcycpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHRvVW5hdXRoZW50aWNhdGVkOiBmdW5jdGlvbiB0b1VuYXV0aGVudGljYXRlZCgpIHsKICAgICAgdGhpcy5fdW5BdXRoZW50aWNhdGVkID0gdHJ1ZTsKICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9DUkVERU5USUFMUyk7CiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ3NpZ24nLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5TSUdOKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdG9HZXQ6IGZ1bmN0aW9uIHRvR2V0KCkgewogICAgICBpZiAodGhpcy5zZXJ2aWNlLmFwaS5wcm90b2NvbCA9PT0gJ3F1ZXJ5JyB8fAogICAgICAgICAgdGhpcy5zZXJ2aWNlLmFwaS5wcm90b2NvbCA9PT0gJ2VjMicpIHsKICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKCdidWlsZCcsIHRoaXMuYnVpbGRBc0dldCk7CiAgICAgICAgdGhpcy5hZGRMaXN0ZW5lcignYnVpbGQnLCB0aGlzLmJ1aWxkQXNHZXQpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGJ1aWxkQXNHZXQ6IGZ1bmN0aW9uIGJ1aWxkQXNHZXQocmVxdWVzdCkgewogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0Lm1ldGhvZCA9ICdHRVQnOwogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnBhdGggPSByZXF1ZXN0LnNlcnZpY2UuZW5kcG9pbnQucGF0aCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc/JyArIHJlcXVlc3QuaHR0cFJlcXVlc3QuYm9keTsKICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC5ib2R5ID0gJyc7CiAgCiAgICAgIC8vIGRvbid0IG5lZWQgdGhlc2UgaGVhZGVycyBvbiBhIEdFVCByZXF1ZXN0CiAgICAgIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtTGVuZ3RoJ107CiAgICAgIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGhhbHRIYW5kbGVyc09uRXJyb3I6IGZ1bmN0aW9uIGhhbHRIYW5kbGVyc09uRXJyb3IoKSB7CiAgICAgIHRoaXMuX2hhbHRIYW5kbGVyc09uRXJyb3IgPSB0cnVlOwogICAgfQogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5SZXF1ZXN0LmFkZFByb21pc2VzVG9DbGFzcyA9IGZ1bmN0aW9uIGFkZFByb21pc2VzVG9DbGFzcyhQcm9taXNlRGVwZW5kZW5jeSkgewogICAgdGhpcy5wcm90b3R5cGUucHJvbWlzZSA9IGZ1bmN0aW9uIHByb21pc2UoKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgLy8gYXBwZW5kIHRvIHVzZXIgYWdlbnQKICAgICAgdGhpcy5odHRwUmVxdWVzdC5hcHBlbmRUb1VzZXJBZ2VudCgncHJvbWlzZScpOwogICAgICByZXR1cm4gbmV3IFByb21pc2VEZXBlbmRlbmN5KGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIHNlbGYub24oJ2NvbXBsZXRlJywgZnVuY3Rpb24ocmVzcCkgewogICAgICAgICAgaWYgKHJlc3AuZXJyb3IpIHsKICAgICAgICAgICAgcmVqZWN0KHJlc3AuZXJyb3IpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gZGVmaW5lICRyZXNwb25zZSBwcm9wZXJ0eSBzbyB0aGF0IGl0IGlzIG5vdCBlbnVtYmVyYWJsZQogICAgICAgICAgICAvLyB0aGlzIHByZXZlbnRzIGNpcmN1bGFyIHJlZmVyZW5jZSBlcnJvcnMgd2hlbiBzdHJpbmdpZnlpbmcgdGhlIEpTT04gb2JqZWN0CiAgICAgICAgICAgIHJlc29sdmUoT2JqZWN0LmRlZmluZVByb3BlcnR5KAogICAgICAgICAgICAgIHJlc3AuZGF0YSB8fCB7fSwKICAgICAgICAgICAgICAnJHJlc3BvbnNlJywKICAgICAgICAgICAgICB7dmFsdWU6IHJlc3B9CiAgICAgICAgICAgICkpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHNlbGYucnVuVG8oKTsKICAgICAgfSk7CiAgICB9OwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlJlcXVlc3QuZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MgPSBmdW5jdGlvbiBkZWxldGVQcm9taXNlc0Zyb21DbGFzcygpIHsKICAgIGRlbGV0ZSB0aGlzLnByb3RvdHlwZS5wcm9taXNlOwogIH07CiAgCiAgQVdTLnV0aWwuYWRkUHJvbWlzZXMoQVdTLlJlcXVlc3QpOwogIAogIEFXUy51dGlsLm1peGluKEFXUy5SZXF1ZXN0LCBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKTsKICAKICB9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKICB9LHsiLi9jb3JlIjoxOCwiLi9zdGF0ZV9tYWNoaW5lIjo3MCwiX3Byb2Nlc3MiOjg1LCJqbWVzcGF0aCI6ODR9XSw1NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLyoqCiAgICogQ29weXJpZ2h0IDIwMTItMjAxMyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogICAqCiAgICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIikuIFlvdQogICAqIG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YKICAgKiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0CiAgICoKICAgKiAgICAgaHR0cDovL2F3cy5hbWF6b24uY29tL2FwYWNoZTIuMC8KICAgKgogICAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMKICAgKiBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRgogICAqIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYwogICAqIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAgICovCiAgCiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICB2YXIgam1lc3BhdGggPSByZXF1aXJlKCdqbWVzcGF0aCcpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIENIRUNLX0FDQ0VQVE9SUyhyZXNwKSB7CiAgICB2YXIgd2FpdGVyID0gcmVzcC5yZXF1ZXN0Ll93YWl0ZXI7CiAgICB2YXIgYWNjZXB0b3JzID0gd2FpdGVyLmNvbmZpZy5hY2NlcHRvcnM7CiAgICB2YXIgYWNjZXB0b3JNYXRjaGVkID0gZmFsc2U7CiAgICB2YXIgc3RhdGUgPSAncmV0cnknOwogIAogICAgYWNjZXB0b3JzLmZvckVhY2goZnVuY3Rpb24oYWNjZXB0b3IpIHsKICAgICAgaWYgKCFhY2NlcHRvck1hdGNoZWQpIHsKICAgICAgICB2YXIgbWF0Y2hlciA9IHdhaXRlci5tYXRjaGVyc1thY2NlcHRvci5tYXRjaGVyXTsKICAgICAgICBpZiAobWF0Y2hlciAmJiBtYXRjaGVyKHJlc3AsIGFjY2VwdG9yLmV4cGVjdGVkLCBhY2NlcHRvci5hcmd1bWVudCkpIHsKICAgICAgICAgIGFjY2VwdG9yTWF0Y2hlZCA9IHRydWU7CiAgICAgICAgICBzdGF0ZSA9IGFjY2VwdG9yLnN0YXRlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgCiAgICBpZiAoIWFjY2VwdG9yTWF0Y2hlZCAmJiByZXNwLmVycm9yKSBzdGF0ZSA9ICdmYWlsdXJlJzsKICAKICAgIGlmIChzdGF0ZSA9PT0gJ3N1Y2Nlc3MnKSB7CiAgICAgIHdhaXRlci5zZXRTdWNjZXNzKHJlc3ApOwogICAgfSBlbHNlIHsKICAgICAgd2FpdGVyLnNldEVycm9yKHJlc3AsIHN0YXRlID09PSAncmV0cnknKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlJlc291cmNlV2FpdGVyID0gaW5oZXJpdCh7CiAgICAvKioKICAgICAqIFdhaXRzIGZvciBhIGdpdmVuIHN0YXRlIG9uIGEgc2VydmljZSBvYmplY3QKICAgICAqIEBwYXJhbSBzZXJ2aWNlIFtTZXJ2aWNlXSB0aGUgc2VydmljZSBvYmplY3QgdG8gd2FpdCBvbgogICAgICogQHBhcmFtIHN0YXRlIFtTdHJpbmddIHRoZSBzdGF0ZSAoZGVmaW5lZCBpbiB3YWl0ZXIgY29uZmlndXJhdGlvbikgdG8gd2FpdAogICAgICogICBmb3IuCiAgICAgKiBAZXhhbXBsZSBDcmVhdGUgYSB3YWl0ZXIgZm9yIHJ1bm5pbmcgRUMyIGluc3RhbmNlcwogICAgICogICB2YXIgZWMyID0gbmV3IEFXUy5FQzI7CiAgICAgKiAgIHZhciB3YWl0ZXIgPSBuZXcgQVdTLlJlc291cmNlV2FpdGVyKGVjMiwgJ2luc3RhbmNlUnVubmluZycpOwogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gY29uc3RydWN0b3Ioc2VydmljZSwgc3RhdGUpIHsKICAgICAgdGhpcy5zZXJ2aWNlID0gc2VydmljZTsKICAgICAgdGhpcy5zdGF0ZSA9IHN0YXRlOwogICAgICB0aGlzLmxvYWRXYWl0ZXJDb25maWcodGhpcy5zdGF0ZSk7CiAgICB9LAogIAogICAgc2VydmljZTogbnVsbCwKICAKICAgIHN0YXRlOiBudWxsLAogIAogICAgY29uZmlnOiBudWxsLAogIAogICAgbWF0Y2hlcnM6IHsKICAgICAgcGF0aDogZnVuY3Rpb24ocmVzcCwgZXhwZWN0ZWQsIGFyZ3VtZW50KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciByZXN1bHQgPSBqbWVzcGF0aC5zZWFyY2gocmVzcC5kYXRhLCBhcmd1bWVudCk7CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogIAogICAgICAgIHJldHVybiBqbWVzcGF0aC5zdHJpY3REZWVwRXF1YWwocmVzdWx0LGV4cGVjdGVkKTsKICAgICAgfSwKICAKICAgICAgcGF0aEFsbDogZnVuY3Rpb24ocmVzcCwgZXhwZWN0ZWQsIGFyZ3VtZW50KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciByZXN1bHRzID0gam1lc3BhdGguc2VhcmNoKHJlc3AuZGF0YSwgYXJndW1lbnQpOwogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAKICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkocmVzdWx0cykpIHJlc3VsdHMgPSBbcmVzdWx0c107CiAgICAgICAgdmFyIG51bVJlc3VsdHMgPSByZXN1bHRzLmxlbmd0aDsKICAgICAgICBpZiAoIW51bVJlc3VsdHMpIHJldHVybiBmYWxzZTsKICAgICAgICBmb3IgKHZhciBpbmQgPSAwIDsgaW5kIDwgbnVtUmVzdWx0czsgaW5kKyspIHsKICAgICAgICAgIGlmICgham1lc3BhdGguc3RyaWN0RGVlcEVxdWFsKHJlc3VsdHNbaW5kXSwgZXhwZWN0ZWQpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0sCiAgCiAgICAgIHBhdGhBbnk6IGZ1bmN0aW9uKHJlc3AsIGV4cGVjdGVkLCBhcmd1bWVudCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgcmVzdWx0cyA9IGptZXNwYXRoLnNlYXJjaChyZXNwLmRhdGEsIGFyZ3VtZW50KTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgCiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdHMpKSByZXN1bHRzID0gW3Jlc3VsdHNdOwogICAgICAgIHZhciBudW1SZXN1bHRzID0gcmVzdWx0cy5sZW5ndGg7CiAgICAgICAgZm9yICh2YXIgaW5kID0gMCA7IGluZCA8IG51bVJlc3VsdHM7IGluZCsrKSB7CiAgICAgICAgICBpZiAoam1lc3BhdGguc3RyaWN0RGVlcEVxdWFsKHJlc3VsdHNbaW5kXSwgZXhwZWN0ZWQpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0sCiAgCiAgICAgIHN0YXR1czogZnVuY3Rpb24ocmVzcCwgZXhwZWN0ZWQpIHsKICAgICAgICB2YXIgc3RhdHVzQ29kZSA9IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgICAgcmV0dXJuICh0eXBlb2Ygc3RhdHVzQ29kZSA9PT0gJ251bWJlcicpICYmIChzdGF0dXNDb2RlID09PSBleHBlY3RlZCk7CiAgICAgIH0sCiAgCiAgICAgIGVycm9yOiBmdW5jdGlvbihyZXNwLCBleHBlY3RlZCkgewogICAgICAgIGlmICh0eXBlb2YgZXhwZWN0ZWQgPT09ICdzdHJpbmcnICYmIHJlc3AuZXJyb3IpIHsKICAgICAgICAgIHJldHVybiBleHBlY3RlZCA9PT0gcmVzcC5lcnJvci5jb2RlOwogICAgICAgIH0KICAgICAgICAvLyBpZiBleHBlY3RlZCBpcyBub3Qgc3RyaW5nLCBjYW4gYmUgYm9vbGVhbiBpbmRpY2F0aW5nIHByZXNlbmNlIG9mIGVycm9yCiAgICAgICAgcmV0dXJuIGV4cGVjdGVkID09PSAhIXJlc3AuZXJyb3I7CiAgICAgIH0KICAgIH0sCiAgCiAgICBsaXN0ZW5lcnM6IG5ldyBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICAgIGFkZCgnUkVUUllfQ0hFQ0snLCAncmV0cnknLCBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgdmFyIHdhaXRlciA9IHJlc3AucmVxdWVzdC5fd2FpdGVyOwogICAgICAgIGlmIChyZXNwLmVycm9yICYmIHJlc3AuZXJyb3IuY29kZSA9PT0gJ1Jlc291cmNlTm90UmVhZHknKSB7CiAgICAgICAgICByZXNwLmVycm9yLnJldHJ5RGVsYXkgPSAod2FpdGVyLmNvbmZpZy5kZWxheSB8fCAwKSAqIDEwMDA7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdDSEVDS19PVVRQVVQnLCAnZXh0cmFjdERhdGEnLCBDSEVDS19BQ0NFUFRPUlMpOwogIAogICAgICBhZGQoJ0NIRUNLX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIENIRUNLX0FDQ0VQVE9SUyk7CiAgICB9KSwKICAKICAgIC8qKgogICAgICogQHJldHVybiBbQVdTLlJlcXVlc3RdCiAgICAgKi8KICAgIHdhaXQ6IGZ1bmN0aW9uIHdhaXQocGFyYW1zLCBjYWxsYmFjaykgewogICAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGNhbGxiYWNrID0gcGFyYW1zOyBwYXJhbXMgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAKICAgICAgaWYgKHBhcmFtcyAmJiBwYXJhbXMuJHdhaXRlcikgewogICAgICAgIHBhcmFtcyA9IEFXUy51dGlsLmNvcHkocGFyYW1zKTsKICAgICAgICBpZiAodHlwZW9mIHBhcmFtcy4kd2FpdGVyLmRlbGF5ID09PSAnbnVtYmVyJykgewogICAgICAgICAgdGhpcy5jb25maWcuZGVsYXkgPSBwYXJhbXMuJHdhaXRlci5kZWxheTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBwYXJhbXMuJHdhaXRlci5tYXhBdHRlbXB0cyA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHRoaXMuY29uZmlnLm1heEF0dGVtcHRzID0gcGFyYW1zLiR3YWl0ZXIubWF4QXR0ZW1wdHM7CiAgICAgICAgfQogICAgICAgIGRlbGV0ZSBwYXJhbXMuJHdhaXRlcjsKICAgICAgfQogIAogICAgICB2YXIgcmVxdWVzdCA9IHRoaXMuc2VydmljZS5tYWtlUmVxdWVzdCh0aGlzLmNvbmZpZy5vcGVyYXRpb24sIHBhcmFtcyk7CiAgICAgIHJlcXVlc3QuX3dhaXRlciA9IHRoaXM7CiAgICAgIHJlcXVlc3QucmVzcG9uc2UubWF4UmV0cmllcyA9IHRoaXMuY29uZmlnLm1heEF0dGVtcHRzOwogICAgICByZXF1ZXN0LmFkZExpc3RlbmVycyh0aGlzLmxpc3RlbmVycyk7CiAgCiAgICAgIGlmIChjYWxsYmFjaykgcmVxdWVzdC5zZW5kKGNhbGxiYWNrKTsKICAgICAgcmV0dXJuIHJlcXVlc3Q7CiAgICB9LAogIAogICAgc2V0U3VjY2VzczogZnVuY3Rpb24gc2V0U3VjY2VzcyhyZXNwKSB7CiAgICAgIHJlc3AuZXJyb3IgPSBudWxsOwogICAgICByZXNwLmRhdGEgPSByZXNwLmRhdGEgfHwge307CiAgICAgIHJlc3AucmVxdWVzdC5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2V4dHJhY3REYXRhJyk7CiAgICB9LAogIAogICAgc2V0RXJyb3I6IGZ1bmN0aW9uIHNldEVycm9yKHJlc3AsIHJldHJ5YWJsZSkgewogICAgICByZXNwLmRhdGEgPSBudWxsOwogICAgICByZXNwLmVycm9yID0gQVdTLnV0aWwuZXJyb3IocmVzcC5lcnJvciB8fCBuZXcgRXJyb3IoKSwgewogICAgICAgIGNvZGU6ICdSZXNvdXJjZU5vdFJlYWR5JywKICAgICAgICBtZXNzYWdlOiAnUmVzb3VyY2UgaXMgbm90IGluIHRoZSBzdGF0ZSAnICsgdGhpcy5zdGF0ZSwKICAgICAgICByZXRyeWFibGU6IHJldHJ5YWJsZQogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIExvYWRzIHdhaXRlciBjb25maWd1cmF0aW9uIGZyb20gQVBJIGNvbmZpZ3VyYXRpb24KICAgICAqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZFdhaXRlckNvbmZpZzogZnVuY3Rpb24gbG9hZFdhaXRlckNvbmZpZyhzdGF0ZSkgewogICAgICBpZiAoIXRoaXMuc2VydmljZS5hcGkud2FpdGVyc1tzdGF0ZV0pIHsKICAgICAgICB0aHJvdyBuZXcgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICAgIGNvZGU6ICdTdGF0ZU5vdEZvdW5kRXJyb3InLAogICAgICAgICAgbWVzc2FnZTogJ1N0YXRlICcgKyBzdGF0ZSArICcgbm90IGZvdW5kLicKICAgICAgICB9KTsKICAgICAgfQogIAogICAgICB0aGlzLmNvbmZpZyA9IEFXUy51dGlsLmNvcHkodGhpcy5zZXJ2aWNlLmFwaS53YWl0ZXJzW3N0YXRlXSk7CiAgICB9CiAgfSk7CiAgCiAgfSx7Ii4vY29yZSI6MTgsImptZXNwYXRoIjo4NH1dLDU3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIHZhciBqbWVzcGF0aCA9IHJlcXVpcmUoJ2ptZXNwYXRoJyk7CiAgCiAgLyoqCiAgICogVGhpcyBjbGFzcyBlbmNhcHN1bGF0ZXMgdGhlIHJlc3BvbnNlIGluZm9ybWF0aW9uCiAgICogZnJvbSBhIHNlcnZpY2UgcmVxdWVzdCBvcGVyYXRpb24gc2VudCB0aHJvdWdoIHtBV1MuUmVxdWVzdH0uCiAgICogVGhlIHJlc3BvbnNlIG9iamVjdCBoYXMgdHdvIG1haW4gcHJvcGVydGllcyBmb3IgZ2V0dGluZyBpbmZvcm1hdGlvbgogICAqIGJhY2sgZnJvbSBhIHJlcXVlc3Q6CiAgICoKICAgKiAjIyBUaGUgYGRhdGFgIHByb3BlcnR5CiAgICoKICAgKiBUaGUgYHJlc3BvbnNlLmRhdGFgIHByb3BlcnR5IGNvbnRhaW5zIHRoZSBzZXJpYWxpemVkIG9iamVjdCBkYXRhCiAgICogcmV0cmlldmVkIGZyb20gdGhlIHNlcnZpY2UgcmVxdWVzdC4gRm9yIGluc3RhbmNlLCBmb3IgYW4KICAgKiBBbWF6b24gRHluYW1vREIgYGxpc3RUYWJsZXNgIG1ldGhvZCBjYWxsLCB0aGUgcmVzcG9uc2UgZGF0YSBtaWdodAogICAqIGxvb2sgbGlrZToKICAgKgogICAqIGBgYAogICAqID4gcmVzcC5kYXRhCiAgICogeyBUYWJsZU5hbWVzOgogICAqICAgIFsgJ3RhYmxlMScsICd0YWJsZTInLCAuLi4gXSB9CiAgICogYGBgCiAgICoKICAgKiBUaGUgYGRhdGFgIHByb3BlcnR5IGNhbiBiZSBudWxsIGlmIGFuIGVycm9yIG9jY3VycyAoc2VlIGJlbG93KS4KICAgKgogICAqICMjIFRoZSBgZXJyb3JgIHByb3BlcnR5CiAgICoKICAgKiBJbiB0aGUgZXZlbnQgb2YgYSBzZXJ2aWNlIGVycm9yIChvciB0cmFuc2ZlciBlcnJvciksIHRoZQogICAqIGByZXNwb25zZS5lcnJvcmAgcHJvcGVydHkgd2lsbCBiZSBmaWxsZWQgd2l0aCB0aGUgZ2l2ZW4KICAgKiBlcnJvciBkYXRhIGluIHRoZSBmb3JtOgogICAqCiAgICogYGBgCiAgICogeyBjb2RlOiAnU0hPUlRfVU5JUVVFX0VSUk9SX0NPREUnLAogICAqICAgbWVzc2FnZTogJ1NvbWUgaHVtYW4gcmVhZGFibGUgZXJyb3IgbWVzc2FnZScgfQogICAqIGBgYAogICAqCiAgICogSW4gdGhlIGNhc2Ugb2YgYW4gZXJyb3IsIHRoZSBgZGF0YWAgcHJvcGVydHkgd2lsbCBiZSBgbnVsbGAuCiAgICogTm90ZSB0aGF0IGlmIHlvdSBoYW5kbGUgZXZlbnRzIHRoYXQgY2FuIGJlIGluIGEgZmFpbHVyZSBzdGF0ZSwKICAgKiB5b3Ugc2hvdWxkIGFsd2F5cyBjaGVjayB3aGV0aGVyIGByZXNwb25zZS5lcnJvcmAgaXMgc2V0CiAgICogYmVmb3JlIGF0dGVtcHRpbmcgdG8gYWNjZXNzIHRoZSBgcmVzcG9uc2UuZGF0YWAgcHJvcGVydHkuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBkYXRhCiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgRGF0YSBQcm9wZXJ0aWVzCiAgICogICBAbm90ZSBJbnNpZGUgb2YgYSB7QVdTLlJlcXVlc3R+aHR0cERhdGF9IGV2ZW50LCB0aGlzCiAgICogICAgIHByb3BlcnR5IGNvbnRhaW5zIGEgc2luZ2xlIHJhdyBwYWNrZXQgaW5zdGVhZCBvZiB0aGUKICAgKiAgICAgZnVsbCBkZS1zZXJpYWxpemVkIHNlcnZpY2UgcmVzcG9uc2UuCiAgICogICBAcmV0dXJuIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIHJlc3BvbnNlIGRhdGEKICAgKiAgICAgZnJvbSB0aGUgc2VydmljZS4KICAgKgogICAqIEAhYXR0cmlidXRlIGVycm9yCiAgICogICBBbiBzdHJ1Y3R1cmUgY29udGFpbmluZyBpbmZvcm1hdGlvbiBhYm91dCBhIHNlcnZpY2UKICAgKiAgIG9yIG5ldHdvcmtpbmcgZXJyb3IuCiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgRGF0YSBQcm9wZXJ0aWVzCiAgICogICBAbm90ZSBUaGlzIGF0dHJpYnV0ZSBpcyBvbmx5IGZpbGxlZCBpZiBhIHNlcnZpY2Ugb3IKICAgKiAgICAgbmV0d29ya2luZyBlcnJvciBvY2N1cnMuCiAgICogICBAcmV0dXJuIFtFcnJvcl0KICAgKiAgICAgKiBjb2RlIFtTdHJpbmddIGEgdW5pcXVlIHNob3J0IGNvZGUgcmVwcmVzZW50aW5nIHRoZQogICAqICAgICAgIGVycm9yIHRoYXQgd2FzIGVtaXR0ZWQuCiAgICogICAgICogbWVzc2FnZSBbU3RyaW5nXSBhIGxvbmdlciBodW1hbiByZWFkYWJsZSBlcnJvciBtZXNzYWdlCiAgICogICAgICogcmV0cnlhYmxlIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBlcnJvciBtZXNzYWdlIGlzCiAgICogICAgICAgcmV0cnlhYmxlLgogICAqICAgICAqIHN0YXR1c0NvZGUgW051bWVyaWNdIGluIHRoZSBjYXNlIG9mIGEgcmVxdWVzdCB0aGF0IHJlYWNoZWQgdGhlIHNlcnZpY2UsCiAgICogICAgICAgdGhpcyB2YWx1ZSBjb250YWlucyB0aGUgcmVzcG9uc2Ugc3RhdHVzIGNvZGUuCiAgICogICAgICogdGltZSBbRGF0ZV0gdGhlIGRhdGUgdGltZSBvYmplY3Qgd2hlbiB0aGUgZXJyb3Igb2NjdXJyZWQuCiAgICogICAgICogaG9zdG5hbWUgW1N0cmluZ10gc2V0IHdoZW4gYSBuZXR3b3JraW5nIGVycm9yIG9jY3VycyB0byBlYXNpbHkKICAgKiAgICAgICBpZGVudGlmeSB0aGUgZW5kcG9pbnQgb2YgdGhlIHJlcXVlc3QuCiAgICogICAgICogcmVnaW9uIFtTdHJpbmddIHNldCB3aGVuIGEgbmV0d29ya2luZyBlcnJvciBvY2N1cnMgdG8gZWFzaWx5CiAgICogICAgICAgaWRlbnRpZnkgdGhlIHJlZ2lvbiBvZiB0aGUgcmVxdWVzdC4KICAgKgogICAqIEAhYXR0cmlidXRlIHJlcXVlc3RJZAogICAqICAgQHJlYWRvbmx5CiAgICogICBAIWdyb3VwIERhdGEgUHJvcGVydGllcwogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgdW5pcXVlIHJlcXVlc3QgSUQgYXNzb2NpYXRlZCB3aXRoIHRoZSByZXNwb25zZS4KICAgKiAgICAgTG9nIHRoaXMgdmFsdWUgd2hlbiBkZWJ1Z2dpbmcgcmVxdWVzdHMgZm9yIEFXUyBzdXBwb3J0LgogICAqCiAgICogQCFhdHRyaWJ1dGUgcmV0cnlDb3VudAogICAqICAgQHJlYWRvbmx5CiAgICogICBAIWdyb3VwIE9wZXJhdGlvbiBQcm9wZXJ0aWVzCiAgICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbnVtYmVyIG9mIHJldHJpZXMgdGhhdCB3ZXJlCiAgICogICAgIGF0dGVtcHRlZCBiZWZvcmUgdGhlIHJlcXVlc3Qgd2FzIGNvbXBsZXRlZC4KICAgKgogICAqIEAhYXR0cmlidXRlIHJlZGlyZWN0Q291bnQKICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBPcGVyYXRpb24gUHJvcGVydGllcwogICAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIG51bWJlciBvZiByZWRpcmVjdHMgdGhhdCB3ZXJlCiAgICogICAgIGZvbGxvd2VkIGJlZm9yZSB0aGUgcmVxdWVzdCB3YXMgY29tcGxldGVkLgogICAqCiAgICogQCFhdHRyaWJ1dGUgaHR0cFJlc3BvbnNlCiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgSFRUUCBQcm9wZXJ0aWVzCiAgICogICBAcmV0dXJuIFtBV1MuSHR0cFJlc3BvbnNlXSB0aGUgcmF3IEhUVFAgcmVzcG9uc2Ugb2JqZWN0CiAgICogICAgIGNvbnRhaW5pbmcgdGhlIHJlc3BvbnNlIGhlYWRlcnMgYW5kIGJvZHkgaW5mb3JtYXRpb24KICAgKiAgICAgZnJvbSB0aGUgc2VydmVyLgogICAqCiAgICogQHNlZSBBV1MuUmVxdWVzdAogICAqLwogIEFXUy5SZXNwb25zZSA9IGluaGVyaXQoewogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFJlc3BvbnNlKHJlcXVlc3QpIHsKICAgICAgdGhpcy5yZXF1ZXN0ID0gcmVxdWVzdDsKICAgICAgdGhpcy5kYXRhID0gbnVsbDsKICAgICAgdGhpcy5lcnJvciA9IG51bGw7CiAgICAgIHRoaXMucmV0cnlDb3VudCA9IDA7CiAgICAgIHRoaXMucmVkaXJlY3RDb3VudCA9IDA7CiAgICAgIHRoaXMuaHR0cFJlc3BvbnNlID0gbmV3IEFXUy5IdHRwUmVzcG9uc2UoKTsKICAgICAgaWYgKHJlcXVlc3QpIHsKICAgICAgICB0aGlzLm1heFJldHJpZXMgPSByZXF1ZXN0LnNlcnZpY2UubnVtUmV0cmllcygpOwogICAgICAgIHRoaXMubWF4UmVkaXJlY3RzID0gcmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5tYXhSZWRpcmVjdHM7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgcmVxdWVzdCBmb3IgdGhlIG5leHQgcGFnZSBvZiByZXNwb25zZSBkYXRhLCBjYWxsaW5nIHRoZQogICAgICogY2FsbGJhY2sgd2l0aCB0aGUgcGFnZSBkYXRhIGlmIGEgY2FsbGJhY2sgaXMgcHJvdmlkZWQuCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgICAqICAgQ2FsbGVkIHdoZW4gYSBwYWdlIG9mIGRhdGEgaXMgcmV0dXJuZWQgZnJvbSB0aGUgbmV4dCByZXF1ZXN0LgogICAgICoKICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGFuIGVycm9yIG9iamVjdCwgaWYgYW4gZXJyb3Igb2NjdXJyZWQgaW4gdGhlIHJlcXVlc3QKICAgICAqICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIG5leHQgcGFnZSBvZiBkYXRhLCBvciBudWxsLCBpZiB0aGVyZSBhcmUgbm8KICAgICAqICAgICBtb3JlIHBhZ2VzIGxlZnQuCiAgICAgKiBAcmV0dXJuIFtBV1MuUmVxdWVzdF0gdGhlIHJlcXVlc3Qgb2JqZWN0IGZvciB0aGUgbmV4dCBwYWdlIG9mIGRhdGEKICAgICAqIEByZXR1cm4gW251bGxdIGlmIG5vIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGFuZCB0aGVyZSBhcmUgbm8gcGFnZXMgbGVmdAogICAgICogICB0byByZXRyaWV2ZS4KICAgICAqIEBzaW5jZSB2MS40LjAKICAgICAqLwogICAgbmV4dFBhZ2U6IGZ1bmN0aW9uIG5leHRQYWdlKGNhbGxiYWNrKSB7CiAgICAgIHZhciBjb25maWc7CiAgICAgIHZhciBzZXJ2aWNlID0gdGhpcy5yZXF1ZXN0LnNlcnZpY2U7CiAgICAgIHZhciBvcGVyYXRpb24gPSB0aGlzLnJlcXVlc3Qub3BlcmF0aW9uOwogICAgICB0cnkgewogICAgICAgIGNvbmZpZyA9IHNlcnZpY2UucGFnaW5hdGlvbkNvbmZpZyhvcGVyYXRpb24sIHRydWUpOwogICAgICB9IGNhdGNoIChlKSB7IHRoaXMuZXJyb3IgPSBlOyB9CiAgCiAgICAgIGlmICghdGhpcy5oYXNOZXh0UGFnZSgpKSB7CiAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayh0aGlzLmVycm9yLCBudWxsKTsKICAgICAgICBlbHNlIGlmICh0aGlzLmVycm9yKSB0aHJvdyB0aGlzLmVycm9yOwogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgCiAgICAgIHZhciBwYXJhbXMgPSBBV1MudXRpbC5jb3B5KHRoaXMucmVxdWVzdC5wYXJhbXMpOwogICAgICBpZiAoIXRoaXMubmV4dFBhZ2VUb2tlbnMpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2sgPyBjYWxsYmFjayhudWxsLCBudWxsKSA6IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGlucHV0VG9rZW5zID0gY29uZmlnLmlucHV0VG9rZW47CiAgICAgICAgaWYgKHR5cGVvZiBpbnB1dFRva2VucyA9PT0gJ3N0cmluZycpIGlucHV0VG9rZW5zID0gW2lucHV0VG9rZW5zXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGlucHV0VG9rZW5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBwYXJhbXNbaW5wdXRUb2tlbnNbaV1dID0gdGhpcy5uZXh0UGFnZVRva2Vuc1tpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNlcnZpY2UubWFrZVJlcXVlc3QodGhpcy5yZXF1ZXN0Lm9wZXJhdGlvbiwgcGFyYW1zLCBjYWxsYmFjayk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgbW9yZSBwYWdlcyBvZiBkYXRhIGNhbiBiZSByZXR1cm5lZCBieSBmdXJ0aGVyCiAgICAgKiAgIHJlcXVlc3RzCiAgICAgKiBAc2luY2UgdjEuNC4wCiAgICAgKi8KICAgIGhhc05leHRQYWdlOiBmdW5jdGlvbiBoYXNOZXh0UGFnZSgpIHsKICAgICAgdGhpcy5jYWNoZU5leHRQYWdlVG9rZW5zKCk7CiAgICAgIGlmICh0aGlzLm5leHRQYWdlVG9rZW5zKSByZXR1cm4gdHJ1ZTsKICAgICAgaWYgKHRoaXMubmV4dFBhZ2VUb2tlbnMgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgZWxzZSByZXR1cm4gZmFsc2U7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY2FjaGVOZXh0UGFnZVRva2VuczogZnVuY3Rpb24gY2FjaGVOZXh0UGFnZVRva2VucygpIHsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLCAnbmV4dFBhZ2VUb2tlbnMnKSkgcmV0dXJuIHRoaXMubmV4dFBhZ2VUb2tlbnM7CiAgICAgIHRoaXMubmV4dFBhZ2VUb2tlbnMgPSB1bmRlZmluZWQ7CiAgCiAgICAgIHZhciBjb25maWcgPSB0aGlzLnJlcXVlc3Quc2VydmljZS5wYWdpbmF0aW9uQ29uZmlnKHRoaXMucmVxdWVzdC5vcGVyYXRpb24pOwogICAgICBpZiAoIWNvbmZpZykgcmV0dXJuIHRoaXMubmV4dFBhZ2VUb2tlbnM7CiAgCiAgICAgIHRoaXMubmV4dFBhZ2VUb2tlbnMgPSBudWxsOwogICAgICBpZiAoY29uZmlnLm1vcmVSZXN1bHRzKSB7CiAgICAgICAgaWYgKCFqbWVzcGF0aC5zZWFyY2godGhpcy5kYXRhLCBjb25maWcubW9yZVJlc3VsdHMpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5uZXh0UGFnZVRva2VuczsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgdmFyIGV4cHJzID0gY29uZmlnLm91dHB1dFRva2VuOwogICAgICBpZiAodHlwZW9mIGV4cHJzID09PSAnc3RyaW5nJykgZXhwcnMgPSBbZXhwcnNdOwogICAgICBBV1MudXRpbC5hcnJheUVhY2guY2FsbCh0aGlzLCBleHBycywgZnVuY3Rpb24gKGV4cHIpIHsKICAgICAgICB2YXIgb3V0cHV0ID0gam1lc3BhdGguc2VhcmNoKHRoaXMuZGF0YSwgZXhwcik7CiAgICAgICAgaWYgKG91dHB1dCkgewogICAgICAgICAgdGhpcy5uZXh0UGFnZVRva2VucyA9IHRoaXMubmV4dFBhZ2VUb2tlbnMgfHwgW107CiAgICAgICAgICB0aGlzLm5leHRQYWdlVG9rZW5zLnB1c2gob3V0cHV0KTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICByZXR1cm4gdGhpcy5uZXh0UGFnZVRva2VuczsKICAgIH0KICAKICB9KTsKICAKICB9LHsiLi9jb3JlIjoxOCwiam1lc3BhdGgiOjg0fV0sNTg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAIW1ldGhvZCBvbihldmVudE5hbWUsIGNhbGxiYWNrKQogICAqICAgUmVnaXN0ZXJzIGFuIGV2ZW50IGxpc3RlbmVyIGNhbGxiYWNrIGZvciB0aGUgZXZlbnQgZ2l2ZW4gYnkgYGV2ZW50TmFtZWAuCiAgICogICBQYXJhbWV0ZXJzIHBhc3NlZCB0byB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gZGVwZW5kIG9uIHRoZSBpbmRpdmlkdWFsIGV2ZW50CiAgICogICBiZWluZyB0cmlnZ2VyZWQuIFNlZSB0aGUgZXZlbnQgZG9jdW1lbnRhdGlvbiBmb3IgdGhvc2UgcGFyYW1ldGVycy4KICAgKgogICAqICAgQHBhcmFtIGV2ZW50TmFtZSBbU3RyaW5nXSB0aGUgZXZlbnQgbmFtZSB0byByZWdpc3RlciB0aGUgbGlzdGVuZXIgZm9yCiAgICogICBAcGFyYW0gY2FsbGJhY2sgW0Z1bmN0aW9uXSB0aGUgbGlzdGVuZXIgY2FsbGJhY2sgZnVuY3Rpb24KICAgKiAgIEBwYXJhbSB0b0hlYWQgW0Jvb2xlYW5dIGF0dGFjaCB0aGUgbGlzdGVuZXIgY2FsbGJhY2sgdG8gdGhlIGhlYWQgb2YgY2FsbGJhY2sgYXJyYXkgaWYgc2V0IHRvIHRydWUuCiAgICogICAgIERlZmF1bHQgdG8gYmUgZmFsc2UuCiAgICogICBAcmV0dXJuIFtBV1MuU2VxdWVudGlhbEV4ZWN1dG9yXSB0aGUgc2FtZSBvYmplY3QgZm9yIGNoYWluaW5nCiAgICovCiAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvciA9IEFXUy51dGlsLmluaGVyaXQoewogIAogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFNlcXVlbnRpYWxFeGVjdXRvcigpIHsKICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbGlzdGVuZXJzOiBmdW5jdGlvbiBsaXN0ZW5lcnMoZXZlbnROYW1lKSB7CiAgICAgIHJldHVybiB0aGlzLl9ldmVudHNbZXZlbnROYW1lXSA/IHRoaXMuX2V2ZW50c1tldmVudE5hbWVdLnNsaWNlKDApIDogW107CiAgICB9LAogIAogICAgb246IGZ1bmN0aW9uIG9uKGV2ZW50TmFtZSwgbGlzdGVuZXIsIHRvSGVhZCkgewogICAgICBpZiAodGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0pIHsKICAgICAgICB0b0hlYWQgPwogICAgICAgICAgdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0udW5zaGlmdChsaXN0ZW5lcikgOgogICAgICAgICAgdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0ucHVzaChsaXN0ZW5lcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0gPSBbbGlzdGVuZXJdOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIG9uQXN5bmM6IGZ1bmN0aW9uIG9uQXN5bmMoZXZlbnROYW1lLCBsaXN0ZW5lciwgdG9IZWFkKSB7CiAgICAgIGxpc3RlbmVyLl9pc0FzeW5jID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXMub24oZXZlbnROYW1lLCBsaXN0ZW5lciwgdG9IZWFkKTsKICAgIH0sCiAgCiAgICByZW1vdmVMaXN0ZW5lcjogZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXIoZXZlbnROYW1lLCBsaXN0ZW5lcikgewogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV07CiAgICAgIGlmIChsaXN0ZW5lcnMpIHsKICAgICAgICB2YXIgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aDsKICAgICAgICB2YXIgcG9zaXRpb24gPSAtMTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBpZiAobGlzdGVuZXJzW2ldID09PSBsaXN0ZW5lcikgewogICAgICAgICAgICBwb3NpdGlvbiA9IGk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChwb3NpdGlvbiA+IC0xKSB7CiAgICAgICAgICBsaXN0ZW5lcnMuc3BsaWNlKHBvc2l0aW9uLCAxKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgcmVtb3ZlQWxsTGlzdGVuZXJzOiBmdW5jdGlvbiByZW1vdmVBbGxMaXN0ZW5lcnMoZXZlbnROYW1lKSB7CiAgICAgIGlmIChldmVudE5hbWUpIHsKICAgICAgICBkZWxldGUgdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZW1pdDogZnVuY3Rpb24gZW1pdChldmVudE5hbWUsIGV2ZW50QXJncywgZG9uZUNhbGxiYWNrKSB7CiAgICAgIGlmICghZG9uZUNhbGxiYWNrKSBkb25lQ2FsbGJhY2sgPSBmdW5jdGlvbigpIHsgfTsKICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMubGlzdGVuZXJzKGV2ZW50TmFtZSk7CiAgICAgIHZhciBjb3VudCA9IGxpc3RlbmVycy5sZW5ndGg7CiAgICAgIHRoaXMuY2FsbExpc3RlbmVycyhsaXN0ZW5lcnMsIGV2ZW50QXJncywgZG9uZUNhbGxiYWNrKTsKICAgICAgcmV0dXJuIGNvdW50ID4gMDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjYWxsTGlzdGVuZXJzOiBmdW5jdGlvbiBjYWxsTGlzdGVuZXJzKGxpc3RlbmVycywgYXJncywgZG9uZUNhbGxiYWNrLCBwcmV2RXJyb3IpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgZXJyb3IgPSBwcmV2RXJyb3IgfHwgbnVsbDsKICAKICAgICAgZnVuY3Rpb24gY2FsbE5leHRMaXN0ZW5lcihlcnIpIHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICBlcnJvciA9IEFXUy51dGlsLmVycm9yKGVycm9yIHx8IG5ldyBFcnJvcigpLCBlcnIpOwogICAgICAgICAgaWYgKHNlbGYuX2hhbHRIYW5kbGVyc09uRXJyb3IpIHsKICAgICAgICAgICAgcmV0dXJuIGRvbmVDYWxsYmFjay5jYWxsKHNlbGYsIGVycm9yKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc2VsZi5jYWxsTGlzdGVuZXJzKGxpc3RlbmVycywgYXJncywgZG9uZUNhbGxiYWNrLCBlcnJvcik7CiAgICAgIH0KICAKICAgICAgd2hpbGUgKGxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgdmFyIGxpc3RlbmVyID0gbGlzdGVuZXJzLnNoaWZ0KCk7CiAgICAgICAgaWYgKGxpc3RlbmVyLl9pc0FzeW5jKSB7IC8vIGFzeW5jaHJvbm91cyBsaXN0ZW5lcgogICAgICAgICAgbGlzdGVuZXIuYXBwbHkoc2VsZiwgYXJncy5jb25jYXQoW2NhbGxOZXh0TGlzdGVuZXJdKSk7CiAgICAgICAgICByZXR1cm47IC8vIHN0b3AgaGVyZSwgY2FsbE5leHRMaXN0ZW5lciB3aWxsIGNvbnRpbnVlCiAgICAgICAgfSBlbHNlIHsgLy8gc3luY2hyb25vdXMgbGlzdGVuZXIKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGxpc3RlbmVyLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGVycm9yID0gQVdTLnV0aWwuZXJyb3IoZXJyb3IgfHwgbmV3IEVycm9yKCksIGVycik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXJyb3IgJiYgc2VsZi5faGFsdEhhbmRsZXJzT25FcnJvcikgewogICAgICAgICAgICBkb25lQ2FsbGJhY2suY2FsbChzZWxmLCBlcnJvcik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZG9uZUNhbGxiYWNrLmNhbGwoc2VsZiwgZXJyb3IpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQWRkcyBvciBjb3BpZXMgYSBzZXQgb2YgbGlzdGVuZXJzIGZyb20gYW5vdGhlciBsaXN0IG9mCiAgICAgKiBsaXN0ZW5lcnMgb3IgU2VxdWVudGlhbEV4ZWN1dG9yIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0gbGlzdGVuZXJzIFttYXA8U3RyaW5nLEFycmF5PEZ1bmN0aW9uPj4sIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3JdCiAgICAgKiAgIGEgbGlzdCBvZiBldmVudHMgYW5kIGNhbGxiYWNrcywgb3IgYW4gZXZlbnQgZW1pdHRlciBvYmplY3QKICAgICAqICAgY29udGFpbmluZyBsaXN0ZW5lcnMgdG8gYWRkIHRvIHRoaXMgZW1pdHRlciBvYmplY3QuCiAgICAgKiBAcmV0dXJuIFtBV1MuU2VxdWVudGlhbEV4ZWN1dG9yXSB0aGUgZW1pdHRlciBvYmplY3QsIGZvciBjaGFpbmluZy4KICAgICAqIEBleGFtcGxlIEFkZGluZyBsaXN0ZW5lcnMgZnJvbSBhIG1hcCBvZiBsaXN0ZW5lcnMKICAgICAqICAgZW1pdHRlci5hZGRMaXN0ZW5lcnMoewogICAgICogICAgIGV2ZW50MTogW2Z1bmN0aW9uKCkgeyAuLi4gfSwgZnVuY3Rpb24oKSB7IC4uLiB9XSwKICAgICAqICAgICBldmVudDI6IFtmdW5jdGlvbigpIHsgLi4uIH1dCiAgICAgKiAgIH0pOwogICAgICogICBlbWl0dGVyLmVtaXQoJ2V2ZW50MScpOyAvLyBlbWl0dGVyIGhhcyBldmVudDEKICAgICAqICAgZW1pdHRlci5lbWl0KCdldmVudDInKTsgLy8gZW1pdHRlciBoYXMgZXZlbnQyCiAgICAgKiBAZXhhbXBsZSBBZGRpbmcgbGlzdGVuZXJzIGZyb20gYW5vdGhlciBlbWl0dGVyIG9iamVjdAogICAgICogICB2YXIgZW1pdHRlcjEgPSBuZXcgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcigpOwogICAgICogICBlbWl0dGVyMS5vbignZXZlbnQxJywgZnVuY3Rpb24oKSB7IC4uLiB9KTsKICAgICAqICAgZW1pdHRlcjEub24oJ2V2ZW50MicsIGZ1bmN0aW9uKCkgeyAuLi4gfSk7CiAgICAgKiAgIHZhciBlbWl0dGVyMiA9IG5ldyBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKCk7CiAgICAgKiAgIGVtaXR0ZXIyLmFkZExpc3RlbmVycyhlbWl0dGVyMSk7CiAgICAgKiAgIGVtaXR0ZXIyLmVtaXQoJ2V2ZW50MScpOyAvLyBlbWl0dGVyMiBoYXMgZXZlbnQxCiAgICAgKiAgIGVtaXR0ZXIyLmVtaXQoJ2V2ZW50MicpOyAvLyBlbWl0dGVyMiBoYXMgZXZlbnQyCiAgICAgKi8KICAgIGFkZExpc3RlbmVyczogZnVuY3Rpb24gYWRkTGlzdGVuZXJzKGxpc3RlbmVycykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgCiAgICAgIC8vIGV4dHJhY3QgbGlzdGVuZXJzIGlmIHBhcmFtZXRlciBpcyBhbiBTZXF1ZW50aWFsRXhlY3V0b3Igb2JqZWN0CiAgICAgIGlmIChsaXN0ZW5lcnMuX2V2ZW50cykgbGlzdGVuZXJzID0gbGlzdGVuZXJzLl9ldmVudHM7CiAgCiAgICAgIEFXUy51dGlsLmVhY2gobGlzdGVuZXJzLCBmdW5jdGlvbihldmVudCwgY2FsbGJhY2tzKSB7CiAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFja3MgPT09ICdmdW5jdGlvbicpIGNhbGxiYWNrcyA9IFtjYWxsYmFja3NdOwogICAgICAgIEFXUy51dGlsLmFycmF5RWFjaChjYWxsYmFja3MsIGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICBzZWxmLm9uKGV2ZW50LCBjYWxsYmFjayk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogIAogICAgICByZXR1cm4gc2VsZjsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFJlZ2lzdGVycyBhbiBldmVudCB3aXRoIHtvbn0gYW5kIHNhdmVzIHRoZSBjYWxsYmFjayBoYW5kbGUgZnVuY3Rpb24KICAgICAqIGFzIGEgcHJvcGVydHkgb24gdGhlIGVtaXR0ZXIgb2JqZWN0IHVzaW5nIGEgZ2l2ZW4gYG5hbWVgLgogICAgICoKICAgICAqIEBwYXJhbSBuYW1lIFtTdHJpbmddIHRoZSBwcm9wZXJ0eSBuYW1lIHRvIHNldCBvbiB0aGlzIG9iamVjdCBjb250YWluaW5nCiAgICAgKiAgIHRoZSBjYWxsYmFjayBmdW5jdGlvbiBoYW5kbGUgc28gdGhhdCB0aGUgbGlzdGVuZXIgY2FuIGJlIHJlbW92ZWQgaW4KICAgICAqICAgdGhlIGZ1dHVyZS4KICAgICAqIEBwYXJhbSAoc2VlIG9uKQogICAgICogQHJldHVybiAoc2VlIG9uKQogICAgICogQGV4YW1wbGUgQWRkaW5nIGEgbmFtZWQgbGlzdGVuZXIgREFUQV9DQUxMQkFDSwogICAgICogICB2YXIgbGlzdGVuZXIgPSBmdW5jdGlvbigpIHsgZG9Tb21ldGhpbmcoKTsgfTsKICAgICAqICAgZW1pdHRlci5hZGROYW1lZExpc3RlbmVyKCdEQVRBX0NBTExCQUNLJywgJ2RhdGEnLCBsaXN0ZW5lcik7CiAgICAgKgogICAgICogICAvLyB0aGUgZm9sbG93aW5nIHByaW50czogdHJ1ZQogICAgICogICBjb25zb2xlLmxvZyhlbWl0dGVyLkRBVEFfQ0FMTEJBQ0sgPT0gbGlzdGVuZXIpOwogICAgICovCiAgICBhZGROYW1lZExpc3RlbmVyOiBmdW5jdGlvbiBhZGROYW1lZExpc3RlbmVyKG5hbWUsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIHRvSGVhZCkgewogICAgICB0aGlzW25hbWVdID0gY2FsbGJhY2s7CiAgICAgIHRoaXMuYWRkTGlzdGVuZXIoZXZlbnROYW1lLCBjYWxsYmFjaywgdG9IZWFkKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYWRkTmFtZWRBc3luY0xpc3RlbmVyOiBmdW5jdGlvbiBhZGROYW1lZEFzeW5jTGlzdGVuZXIobmFtZSwgZXZlbnROYW1lLCBjYWxsYmFjaywgdG9IZWFkKSB7CiAgICAgIGNhbGxiYWNrLl9pc0FzeW5jID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXMuYWRkTmFtZWRMaXN0ZW5lcihuYW1lLCBldmVudE5hbWUsIGNhbGxiYWNrLCB0b0hlYWQpOwogICAgfSwKICAKICAgIC8qKgogICAgICogSGVscGVyIG1ldGhvZCB0byBhZGQgYSBzZXQgb2YgbmFtZWQgbGlzdGVuZXJzIHVzaW5nCiAgICAgKiB7YWRkTmFtZWRMaXN0ZW5lcn0uIFRoZSBjYWxsYmFjayBjb250YWlucyBhIHBhcmFtZXRlcgogICAgICogd2l0aCBhIGhhbmRsZSB0byB0aGUgYGFkZE5hbWVkTGlzdGVuZXJgIG1ldGhvZC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oYWRkKQogICAgICogICBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gaXMgY2FsbGVkIGltbWVkaWF0ZWx5IGluIG9yZGVyIHRvIHByb3ZpZGUKICAgICAqICAgdGhlIGBhZGRgIGZ1bmN0aW9uIHRvIHRoZSBibG9jay4gVGhpcyBzaW1wbGlmaWVzIHRoZSBhZGRpdGlvbiBvZgogICAgICogICBhIGxhcmdlIGdyb3VwIG9mIG5hbWVkIGxpc3RlbmVycy4KICAgICAqICAgQHBhcmFtIGFkZCBbRnVuY3Rpb25dIHRoZSB7YWRkTmFtZWRMaXN0ZW5lcn0gZnVuY3Rpb24gdG8gY2FsbAogICAgICogICAgIHdoZW4gcmVnaXN0ZXJpbmcgbGlzdGVuZXJzLgogICAgICogQGV4YW1wbGUgQWRkaW5nIGEgc2V0IG9mIG5hbWVkIGxpc3RlbmVycwogICAgICogICBlbWl0dGVyLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICogICAgIGFkZCgnREFUQV9DQUxMQkFDSycsICdkYXRhJywgZnVuY3Rpb24oKSB7IC4uLiB9KTsKICAgICAqICAgICBhZGQoJ09USEVSJywgJ290aGVyRXZlbnQnLCBmdW5jdGlvbigpIHsgLi4uIH0pOwogICAgICogICAgIGFkZCgnTEFTVCcsICdsYXN0RXZlbnQnLCBmdW5jdGlvbigpIHsgLi4uIH0pOwogICAgICogICB9KTsKICAgICAqCiAgICAgKiAgIC8vIHRoZXNlIHByb3BlcnRpZXMgYXJlIG5vdyBzZXQ6CiAgICAgKiAgIGVtaXR0ZXIuREFUQV9DQUxMQkFDSzsKICAgICAqICAgZW1pdHRlci5PVEhFUjsKICAgICAqICAgZW1pdHRlci5MQVNUOwogICAgICovCiAgICBhZGROYW1lZExpc3RlbmVyczogZnVuY3Rpb24gYWRkTmFtZWRMaXN0ZW5lcnMoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBjYWxsYmFjaygKICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgIHNlbGYuYWRkTmFtZWRMaXN0ZW5lci5hcHBseShzZWxmLCBhcmd1bWVudHMpOwogICAgICAgIH0sCiAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICBzZWxmLmFkZE5hbWVkQXN5bmNMaXN0ZW5lci5hcHBseShzZWxmLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICoge29ufSBpcyB0aGUgcHJlZmVyZWQgbWV0aG9kLgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IucHJvdG90eXBlLmFkZExpc3RlbmVyID0gQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5wcm90b3R5cGUub247CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yOwogIAogIH0seyIuL2NvcmUiOjE4fV0sNTk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAocHJvY2Vzcyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHZhciBBcGkgPSByZXF1aXJlKCcuL21vZGVsL2FwaScpOwogIHZhciByZWdpb25Db25maWcgPSByZXF1aXJlKCcuL3JlZ2lvbl9jb25maWcnKTsKICAKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgdmFyIGNsaWVudENvdW50ID0gMDsKICAKICAvKioKICAgKiBUaGUgc2VydmljZSBjbGFzcyByZXByZXNlbnRpbmcgYW4gQVdTIHNlcnZpY2UuCiAgICoKICAgKiBAY2xhc3NfYWJzdHJhY3QgVGhpcyBjbGFzcyBpcyBhbiBhYnN0cmFjdCBjbGFzcy4KICAgKgogICAqIEAhYXR0cmlidXRlIGFwaVZlcnNpb25zCiAgICogICBAcmV0dXJuIFtBcnJheTxTdHJpbmc+XSB0aGUgbGlzdCBvZiBBUEkgdmVyc2lvbnMgc3VwcG9ydGVkIGJ5IHRoaXMgc2VydmljZS4KICAgKiAgIEByZWFkb25seQogICAqLwogIEFXUy5TZXJ2aWNlID0gaW5oZXJpdCh7CiAgICAvKioKICAgICAqIENyZWF0ZSBhIG5ldyBzZXJ2aWNlIG9iamVjdCB3aXRoIGEgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAqCiAgICAgKiBAcGFyYW0gY29uZmlnIFttYXBdIGEgbWFwIG9mIGNvbmZpZ3VyYXRpb24gb3B0aW9ucwogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gU2VydmljZShjb25maWcpIHsKICAgICAgaWYgKCF0aGlzLmxvYWRTZXJ2aWNlQ2xhc3MpIHsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgICdTZXJ2aWNlIG11c3QgYmUgY29uc3RydWN0ZWQgd2l0aCBgbmV3XCcgb3BlcmF0b3InKTsKICAgICAgfQogICAgICB2YXIgU2VydmljZUNsYXNzID0gdGhpcy5sb2FkU2VydmljZUNsYXNzKGNvbmZpZyB8fCB7fSk7CiAgICAgIGlmIChTZXJ2aWNlQ2xhc3MpIHsKICAgICAgICB2YXIgb3JpZ2luYWxDb25maWcgPSBBV1MudXRpbC5jb3B5KGNvbmZpZyk7CiAgICAgICAgdmFyIHN2YyA9IG5ldyBTZXJ2aWNlQ2xhc3MoY29uZmlnKTsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoc3ZjLCAnX29yaWdpbmFsQ29uZmlnJywgewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIG9yaWdpbmFsQ29uZmlnOyB9LAogICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICB9KTsKICAgICAgICBzdmMuX2NsaWVudElkID0gKytjbGllbnRDb3VudDsKICAgICAgICByZXR1cm4gc3ZjOwogICAgICB9CiAgICAgIHRoaXMuaW5pdGlhbGl6ZShjb25maWcpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIGluaXRpYWxpemUoY29uZmlnKSB7CiAgICAgIHZhciBzdmNDb25maWcgPSBBV1MuY29uZmlnW3RoaXMuc2VydmljZUlkZW50aWZpZXJdOwogICAgICB0aGlzLmNvbmZpZyA9IG5ldyBBV1MuQ29uZmlnKEFXUy5jb25maWcpOwogICAgICBpZiAoc3ZjQ29uZmlnKSB0aGlzLmNvbmZpZy51cGRhdGUoc3ZjQ29uZmlnLCB0cnVlKTsKICAgICAgaWYgKGNvbmZpZykgdGhpcy5jb25maWcudXBkYXRlKGNvbmZpZywgdHJ1ZSk7CiAgCiAgICAgIHRoaXMudmFsaWRhdGVTZXJ2aWNlKCk7CiAgICAgIGlmICghdGhpcy5jb25maWcuZW5kcG9pbnQpIHJlZ2lvbkNvbmZpZyh0aGlzKTsKICAKICAgICAgdGhpcy5jb25maWcuZW5kcG9pbnQgPSB0aGlzLmVuZHBvaW50RnJvbVRlbXBsYXRlKHRoaXMuY29uZmlnLmVuZHBvaW50KTsKICAgICAgdGhpcy5zZXRFbmRwb2ludCh0aGlzLmNvbmZpZy5lbmRwb2ludCk7CiAgICAgIC8vZW5hYmxlIGF0dGFjaGluZyBsaXN0ZW5lcnMgdG8gc2VydmljZSBjbGllbnQKICAgICAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5jYWxsKHRoaXMpOwogICAgICBBV1MuU2VydmljZS5hZGREZWZhdWx0TW9uaXRvcmluZ0xpc3RlbmVycyh0aGlzKTsKICAgICAgaWYgKCh0aGlzLmNvbmZpZy5jbGllbnRTaWRlTW9uaXRvcmluZyB8fCBBV1MuU2VydmljZS5fY2xpZW50U2lkZU1vbml0b3JpbmcpICYmIHRoaXMucHVibGlzaGVyKSB7CiAgICAgICAgdmFyIHB1Ymxpc2hlciA9IHRoaXMucHVibGlzaGVyOwogICAgICAgIHRoaXMuYWRkTmFtZWRMaXN0ZW5lcignUFVCTElTSF9BUElfQ0FMTCcsICdhcGlDYWxsJywgZnVuY3Rpb24gUFVCTElTSF9BUElfQ0FMTChldmVudCkgewogICAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHtwdWJsaXNoZXIuZXZlbnRIYW5kbGVyKGV2ZW50KTt9KTsKICAgICAgICB9KTsKICAgICAgICB0aGlzLmFkZE5hbWVkTGlzdGVuZXIoJ1BVQkxJU0hfQVBJX0FUVEVNUFQnLCAnYXBpQ2FsbEF0dGVtcHQnLCBmdW5jdGlvbiBQVUJMSVNIX0FQSV9BVFRFTVBUKGV2ZW50KSB7CiAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkge3B1Ymxpc2hlci5ldmVudEhhbmRsZXIoZXZlbnQpO30pOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdmFsaWRhdGVTZXJ2aWNlOiBmdW5jdGlvbiB2YWxpZGF0ZVNlcnZpY2UoKSB7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZFNlcnZpY2VDbGFzczogZnVuY3Rpb24gbG9hZFNlcnZpY2VDbGFzcyhzZXJ2aWNlQ29uZmlnKSB7CiAgICAgIHZhciBjb25maWcgPSBzZXJ2aWNlQ29uZmlnOwogICAgICBpZiAoIUFXUy51dGlsLmlzRW1wdHkodGhpcy5hcGkpKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0gZWxzZSBpZiAoY29uZmlnLmFwaUNvbmZpZykgewogICAgICAgIHJldHVybiBBV1MuU2VydmljZS5kZWZpbmVTZXJ2aWNlQXBpKHRoaXMuY29uc3RydWN0b3IsIGNvbmZpZy5hcGlDb25maWcpOwogICAgICB9IGVsc2UgaWYgKCF0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uZmlnID0gbmV3IEFXUy5Db25maWcoQVdTLmNvbmZpZyk7CiAgICAgICAgY29uZmlnLnVwZGF0ZShzZXJ2aWNlQ29uZmlnLCB0cnVlKTsKICAgICAgICB2YXIgdmVyc2lvbiA9IGNvbmZpZy5hcGlWZXJzaW9uc1t0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VJZGVudGlmaWVyXTsKICAgICAgICB2ZXJzaW9uID0gdmVyc2lvbiB8fCBjb25maWcuYXBpVmVyc2lvbjsKICAgICAgICByZXR1cm4gdGhpcy5nZXRMYXRlc3RTZXJ2aWNlQ2xhc3ModmVyc2lvbik7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRMYXRlc3RTZXJ2aWNlQ2xhc3M6IGZ1bmN0aW9uIGdldExhdGVzdFNlcnZpY2VDbGFzcyh2ZXJzaW9uKSB7CiAgICAgIHZlcnNpb24gPSB0aGlzLmdldExhdGVzdFNlcnZpY2VWZXJzaW9uKHZlcnNpb24pOwogICAgICBpZiAodGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlc1t2ZXJzaW9uXSA9PT0gbnVsbCkgewogICAgICAgIEFXUy5TZXJ2aWNlLmRlZmluZVNlcnZpY2VBcGkodGhpcy5jb25zdHJ1Y3RvciwgdmVyc2lvbik7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXNbdmVyc2lvbl07CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0TGF0ZXN0U2VydmljZVZlcnNpb246IGZ1bmN0aW9uIGdldExhdGVzdFNlcnZpY2VWZXJzaW9uKHZlcnNpb24pIHsKICAgICAgaWYgKCF0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzIHx8IHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBzZXJ2aWNlcyBkZWZpbmVkIG9uICcgKwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VJZGVudGlmaWVyKTsKICAgICAgfQogIAogICAgICBpZiAoIXZlcnNpb24pIHsKICAgICAgICB2ZXJzaW9uID0gJ2xhdGVzdCc7CiAgICAgIH0gZWxzZSBpZiAoQVdTLnV0aWwuaXNUeXBlKHZlcnNpb24sIERhdGUpKSB7CiAgICAgICAgdmVyc2lvbiA9IEFXUy51dGlsLmRhdGUuaXNvODYwMSh2ZXJzaW9uKS5zcGxpdCgnVCcpWzBdOwogICAgICB9CiAgCiAgICAgIGlmIChPYmplY3QuaGFzT3duUHJvcGVydHkodGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlcywgdmVyc2lvbikpIHsKICAgICAgICByZXR1cm4gdmVyc2lvbjsKICAgICAgfQogIAogICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXMpLnNvcnQoKTsKICAgICAgdmFyIHNlbGVjdGVkVmVyc2lvbiA9IG51bGw7CiAgICAgIGZvciAodmFyIGkgPSBrZXlzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgLy8gdmVyc2lvbnMgdGhhdCBlbmQgaW4gIioiIGFyZSBub3QgYXZhaWxhYmxlIG9uIGRpc2sgYW5kIGNhbiBiZQogICAgICAgIC8vIHNraXBwZWQsIHNvIGRvIG5vdCBjaG9vc2UgdGhlc2UgYXMgc2VsZWN0ZWRWZXJzaW9ucwogICAgICAgIGlmIChrZXlzW2ldW2tleXNbaV0ubGVuZ3RoIC0gMV0gIT09ICcqJykgewogICAgICAgICAgc2VsZWN0ZWRWZXJzaW9uID0ga2V5c1tpXTsKICAgICAgICB9CiAgICAgICAgaWYgKGtleXNbaV0uc3Vic3RyKDAsIDEwKSA8PSB2ZXJzaW9uKSB7CiAgICAgICAgICByZXR1cm4gc2VsZWN0ZWRWZXJzaW9uOwogICAgICAgIH0KICAgICAgfQogIAogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBmaW5kICcgKyB0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VJZGVudGlmaWVyICsKICAgICAgICAgICAgICAgICAgICAgICcgQVBJIHRvIHNhdGlzZnkgdmVyc2lvbiBjb25zdHJhaW50IGAnICsgdmVyc2lvbiArICdcJycpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwaToge30sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBkZWZhdWx0UmV0cnlDb3VudDogMywKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGN1c3RvbWl6ZVJlcXVlc3RzOiBmdW5jdGlvbiBjdXN0b21pemVSZXF1ZXN0cyhjYWxsYmFjaykgewogICAgICBpZiAoIWNhbGxiYWNrKSB7CiAgICAgICAgdGhpcy5jdXN0b21SZXF1ZXN0SGFuZGxlciA9IG51bGw7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhpcy5jdXN0b21SZXF1ZXN0SGFuZGxlciA9IGNhbGxiYWNrOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBjYWxsYmFjayB0eXBlIFwnJyArIHR5cGVvZiBjYWxsYmFjayArICdcJyBwcm92aWRlZCBpbiBjdXN0b21pemVSZXF1ZXN0cycpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBDYWxscyBhbiBvcGVyYXRpb24gb24gYSBzZXJ2aWNlIHdpdGggdGhlIGdpdmVuIGlucHV0IHBhcmFtZXRlcnMuCiAgICAgKgogICAgICogQHBhcmFtIG9wZXJhdGlvbiBbU3RyaW5nXSB0aGUgbmFtZSBvZiB0aGUgb3BlcmF0aW9uIHRvIGNhbGwgb24gdGhlIHNlcnZpY2UuCiAgICAgKiBAcGFyYW0gcGFyYW1zIFttYXBdIGEgbWFwIG9mIGlucHV0IG9wdGlvbnMgZm9yIHRoZSBvcGVyYXRpb24KICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEpCiAgICAgKiAgIElmIGEgY2FsbGJhY2sgaXMgc3VwcGxpZWQsIGl0IGlzIGNhbGxlZCB3aGVuIGEgcmVzcG9uc2UgaXMgcmV0dXJuZWQKICAgICAqICAgZnJvbSB0aGUgc2VydmljZS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgICAqICAgICBTZXQgdG8gYG51bGxgIGlmIHRoZSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwuCiAgICAgKiAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIGRhdGEgcmV0dXJuZWQgZnJvbQogICAgICogICAgIHRoZSByZXF1ZXN0LiBTZXQgdG8gYG51bGxgIGlmIGEgcmVxdWVzdCBlcnJvciBvY2N1cnMuCiAgICAgKi8KICAgIG1ha2VSZXF1ZXN0OiBmdW5jdGlvbiBtYWtlUmVxdWVzdChvcGVyYXRpb24sIHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBjYWxsYmFjayA9IHBhcmFtczsKICAgICAgICBwYXJhbXMgPSBudWxsOwogICAgICB9CiAgCiAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTsKICAgICAgaWYgKHRoaXMuY29uZmlnLnBhcmFtcykgeyAvLyBjb3B5IG9ubHkgdG9wbGV2ZWwgYm91bmQgcGFyYW1zCiAgICAgICAgdmFyIHJ1bGVzID0gdGhpcy5hcGkub3BlcmF0aW9uc1tvcGVyYXRpb25dOwogICAgICAgIGlmIChydWxlcykgewogICAgICAgICAgcGFyYW1zID0gQVdTLnV0aWwuY29weShwYXJhbXMpOwogICAgICAgICAgQVdTLnV0aWwuZWFjaCh0aGlzLmNvbmZpZy5wYXJhbXMsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKHJ1bGVzLmlucHV0Lm1lbWJlcnNba2V5XSkgewogICAgICAgICAgICAgIGlmIChwYXJhbXNba2V5XSA9PT0gdW5kZWZpbmVkIHx8IHBhcmFtc1trZXldID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBwYXJhbXNba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHZhciByZXF1ZXN0ID0gbmV3IEFXUy5SZXF1ZXN0KHRoaXMsIG9wZXJhdGlvbiwgcGFyYW1zKTsKICAgICAgdGhpcy5hZGRBbGxSZXF1ZXN0TGlzdGVuZXJzKHJlcXVlc3QpOwogICAgICB0aGlzLmF0dGFjaE1vbml0b3JpbmdFbWl0dGVyKHJlcXVlc3QpOwogICAgICBpZiAoY2FsbGJhY2spIHJlcXVlc3Quc2VuZChjYWxsYmFjayk7CiAgICAgIHJldHVybiByZXF1ZXN0OwogICAgfSwKICAKICAgIC8qKgogICAgICogQ2FsbHMgYW4gb3BlcmF0aW9uIG9uIGEgc2VydmljZSB3aXRoIHRoZSBnaXZlbiBpbnB1dCBwYXJhbWV0ZXJzLCB3aXRob3V0CiAgICAgKiBhbnkgYXV0aGVudGljYXRpb24gZGF0YS4gVGhpcyBtZXRob2QgaXMgdXNlZnVsIGZvciAicHVibGljIiBBUEkgb3BlcmF0aW9ucy4KICAgICAqCiAgICAgKiBAcGFyYW0gb3BlcmF0aW9uIFtTdHJpbmddIHRoZSBuYW1lIG9mIHRoZSBvcGVyYXRpb24gdG8gY2FsbCBvbiB0aGUgc2VydmljZS4KICAgICAqIEBwYXJhbSBwYXJhbXMgW21hcF0gYSBtYXAgb2YgaW5wdXQgb3B0aW9ucyBmb3IgdGhlIG9wZXJhdGlvbgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgICAqICAgSWYgYSBjYWxsYmFjayBpcyBzdXBwbGllZCwgaXQgaXMgY2FsbGVkIHdoZW4gYSByZXNwb25zZSBpcyByZXR1cm5lZAogICAgICogICBmcm9tIHRoZSBzZXJ2aWNlLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAgICogICAgIFNldCB0byBgbnVsbGAgaWYgdGhlIHJlcXVlc3QgaXMgc3VjY2Vzc2Z1bC4KICAgICAqICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgZGF0YSByZXR1cm5lZCBmcm9tCiAgICAgKiAgICAgdGhlIHJlcXVlc3QuIFNldCB0byBgbnVsbGAgaWYgYSByZXF1ZXN0IGVycm9yIG9jY3Vycy4KICAgICAqLwogICAgbWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3Q6IGZ1bmN0aW9uIG1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KG9wZXJhdGlvbiwgcGFyYW1zLCBjYWxsYmFjaykgewogICAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGNhbGxiYWNrID0gcGFyYW1zOwogICAgICAgIHBhcmFtcyA9IHt9OwogICAgICB9CiAgCiAgICAgIHZhciByZXF1ZXN0ID0gdGhpcy5tYWtlUmVxdWVzdChvcGVyYXRpb24sIHBhcmFtcykudG9VbmF1dGhlbnRpY2F0ZWQoKTsKICAgICAgcmV0dXJuIGNhbGxiYWNrID8gcmVxdWVzdC5zZW5kKGNhbGxiYWNrKSA6IHJlcXVlc3Q7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBXYWl0cyBmb3IgYSBnaXZlbiBzdGF0ZQogICAgICoKICAgICAqIEBwYXJhbSBzdGF0ZSBbU3RyaW5nXSB0aGUgc3RhdGUgb24gdGhlIHNlcnZpY2UgdG8gd2FpdCBmb3IKICAgICAqIEBwYXJhbSBwYXJhbXMgW21hcF0gYSBtYXAgb2YgcGFyYW1ldGVycyB0byBwYXNzIHdpdGggZWFjaCByZXF1ZXN0CiAgICAgKiBAb3B0aW9uIHBhcmFtcyAkd2FpdGVyIFttYXBdIGEgbWFwIG9mIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIHdhaXRlcgogICAgICogQG9wdGlvbiBwYXJhbXMgJHdhaXRlci5kZWxheSBbTnVtYmVyXSBUaGUgbnVtYmVyIG9mIHNlY29uZHMgdG8gd2FpdCBiZXR3ZWVuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3RzCiAgICAgKiBAb3B0aW9uIHBhcmFtcyAkd2FpdGVyLm1heEF0dGVtcHRzIFtOdW1iZXJdIFRoZSBtYXhpbXVtIG51bWJlciBvZiByZXF1ZXN0cwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0byBzZW5kIHdoaWxlIHdhaXRpbmcKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEpCiAgICAgKiAgIElmIGEgY2FsbGJhY2sgaXMgc3VwcGxpZWQsIGl0IGlzIGNhbGxlZCB3aGVuIGEgcmVzcG9uc2UgaXMgcmV0dXJuZWQKICAgICAqICAgZnJvbSB0aGUgc2VydmljZS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgICAqICAgICBTZXQgdG8gYG51bGxgIGlmIHRoZSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwuCiAgICAgKiAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIGRhdGEgcmV0dXJuZWQgZnJvbQogICAgICogICAgIHRoZSByZXF1ZXN0LiBTZXQgdG8gYG51bGxgIGlmIGEgcmVxdWVzdCBlcnJvciBvY2N1cnMuCiAgICAgKi8KICAgIHdhaXRGb3I6IGZ1bmN0aW9uIHdhaXRGb3Ioc3RhdGUsIHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgdmFyIHdhaXRlciA9IG5ldyBBV1MuUmVzb3VyY2VXYWl0ZXIodGhpcywgc3RhdGUpOwogICAgICByZXR1cm4gd2FpdGVyLndhaXQocGFyYW1zLCBjYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYWRkQWxsUmVxdWVzdExpc3RlbmVyczogZnVuY3Rpb24gYWRkQWxsUmVxdWVzdExpc3RlbmVycyhyZXF1ZXN0KSB7CiAgICAgIHZhciBsaXN0ID0gW0FXUy5ldmVudHMsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLCB0aGlzLnNlcnZpY2VJbnRlcmZhY2UoKSwKICAgICAgICAgICAgICAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmVQb3N0XTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGxpc3RbaV0pIHJlcXVlc3QuYWRkTGlzdGVuZXJzKGxpc3RbaV0pOwogICAgICB9CiAgCiAgICAgIC8vIGRpc2FibGUgcGFyYW1ldGVyIHZhbGlkYXRpb24KICAgICAgaWYgKCF0aGlzLmNvbmZpZy5wYXJhbVZhbGlkYXRpb24pIHsKICAgICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsCiAgICAgICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9QQVJBTUVURVJTKTsKICAgICAgfQogIAogICAgICBpZiAodGhpcy5jb25maWcubG9nZ2VyKSB7IC8vIGFkZCBsb2dnaW5nIGV2ZW50cwogICAgICAgIHJlcXVlc3QuYWRkTGlzdGVuZXJzKEFXUy5FdmVudExpc3RlbmVycy5Mb2dnZXIpOwogICAgICB9CiAgCiAgICAgIHRoaXMuc2V0dXBSZXF1ZXN0TGlzdGVuZXJzKHJlcXVlc3QpOwogICAgICAvLyBjYWxsIHByb3RvdHlwZSdzIGN1c3RvbVJlcXVlc3RIYW5kbGVyCiAgICAgIGlmICh0eXBlb2YgdGhpcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUuY3VzdG9tUmVxdWVzdEhhbmRsZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5jdXN0b21SZXF1ZXN0SGFuZGxlcihyZXF1ZXN0KTsKICAgICAgfQogICAgICAvLyBjYWxsIGluc3RhbmNlJ3MgY3VzdG9tUmVxdWVzdEhhbmRsZXIKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLCAnY3VzdG9tUmVxdWVzdEhhbmRsZXInKSAmJiB0eXBlb2YgdGhpcy5jdXN0b21SZXF1ZXN0SGFuZGxlciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRoaXMuY3VzdG9tUmVxdWVzdEhhbmRsZXIocmVxdWVzdCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEV2ZW50IHJlY29yZGluZyBtZXRyaWNzIGZvciBhIHdob2xlIEFQSSBjYWxsLgogICAgICogQHJldHVybnMge29iamVjdH0gYSBzdWJzZXQgb2YgYXBpIGNhbGwgbWV0cmljcwogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwaUNhbGxFdmVudDogZnVuY3Rpb24gYXBpQ2FsbEV2ZW50KHJlcXVlc3QpIHsKICAgICAgdmFyIGFwaSA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICAgIHZhciBtb25pdG9yaW5nRXZlbnQgPSB7CiAgICAgICAgVHlwZTogJ0FwaUNhbGwnLAogICAgICAgIEFwaTogYXBpID8gYXBpLm5hbWUgOiByZXF1ZXN0Lm9wZXJhdGlvbiwKICAgICAgICBWZXJzaW9uOiAxLAogICAgICAgIFNlcnZpY2U6IHJlcXVlc3Quc2VydmljZS5hcGkuc2VydmljZUlkIHx8IHJlcXVlc3Quc2VydmljZS5hcGkuZW5kcG9pbnRQcmVmaXgsCiAgICAgICAgUmVnaW9uOiByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnJlZ2lvbiwKICAgICAgICBNYXhSZXRyaWVzRXhjZWVkZWQ6IDAsCiAgICAgICAgVXNlckFnZW50OiByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmdldFVzZXJBZ2VudCgpLAogICAgICB9OwogICAgICB2YXIgcmVzcG9uc2UgPSByZXF1ZXN0LnJlc3BvbnNlOwogICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUpIHsKICAgICAgICBtb25pdG9yaW5nRXZlbnQuRmluYWxIdHRwU3RhdHVzQ29kZSA9IHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICB9CiAgICAgIGlmIChyZXNwb25zZS5lcnJvcikgewogICAgICAgIHZhciBlcnJvciA9IHJlc3BvbnNlLmVycm9yOwogICAgICAgIHZhciBzdGF0dXNDb2RlID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgICAgaWYgKHN0YXR1c0NvZGUgPiAyOTkpIHsKICAgICAgICAgIGlmIChlcnJvci5jb2RlKSBtb25pdG9yaW5nRXZlbnQuRmluYWxBd3NFeGNlcHRpb24gPSBlcnJvci5jb2RlOwogICAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIG1vbml0b3JpbmdFdmVudC5GaW5hbEF3c0V4Y2VwdGlvbk1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoZXJyb3IuY29kZSB8fCBlcnJvci5uYW1lKSBtb25pdG9yaW5nRXZlbnQuRmluYWxTZGtFeGNlcHRpb24gPSBlcnJvci5jb2RlIHx8IGVycm9yLm5hbWU7CiAgICAgICAgICBpZiAoZXJyb3IubWVzc2FnZSkgbW9uaXRvcmluZ0V2ZW50LkZpbmFsU2RrRXhjZXB0aW9uTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBtb25pdG9yaW5nRXZlbnQ7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBFdmVudCByZWNvcmRpbmcgbWV0cmljcyBmb3IgYW4gQVBJIGNhbGwgYXR0ZW1wdC4KICAgICAqIEByZXR1cm5zIHtvYmplY3R9IGEgc3Vic2V0IG9mIGFwaSBjYWxsIGF0dGVtcHQgbWV0cmljcwogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwaUF0dGVtcHRFdmVudDogZnVuY3Rpb24gYXBpQXR0ZW1wdEV2ZW50KHJlcXVlc3QpIHsKICAgICAgdmFyIGFwaSA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICAgIHZhciBtb25pdG9yaW5nRXZlbnQgPSB7CiAgICAgICAgVHlwZTogJ0FwaUNhbGxBdHRlbXB0JywKICAgICAgICBBcGk6IGFwaSA/IGFwaS5uYW1lIDogcmVxdWVzdC5vcGVyYXRpb24sCiAgICAgICAgVmVyc2lvbjogMSwKICAgICAgICBTZXJ2aWNlOiByZXF1ZXN0LnNlcnZpY2UuYXBpLnNlcnZpY2VJZCB8fCByZXF1ZXN0LnNlcnZpY2UuYXBpLmVuZHBvaW50UHJlZml4LAogICAgICAgIEZxZG46IHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQuaG9zdG5hbWUsCiAgICAgICAgVXNlckFnZW50OiByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmdldFVzZXJBZ2VudCgpLAogICAgICB9OwogICAgICB2YXIgcmVzcG9uc2UgPSByZXF1ZXN0LnJlc3BvbnNlOwogICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUpIHsKICAgICAgICBtb25pdG9yaW5nRXZlbnQuSHR0cFN0YXR1c0NvZGUgPSByZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgfQogICAgICBpZiAoCiAgICAgICAgIXJlcXVlc3QuX3VuQXV0aGVudGljYXRlZCAmJgogICAgICAgIHJlcXVlc3Quc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMgJiYKICAgICAgICByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkCiAgICAgICkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5BY2Nlc3NLZXkgPSByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkOwogICAgICB9CiAgICAgIGlmICghcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnMpIHJldHVybiBtb25pdG9yaW5nRXZlbnQ7CiAgICAgIGlmIChyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LXNlY3VyaXR5LXRva2VuJ10pIHsKICAgICAgICBtb25pdG9yaW5nRXZlbnQuU2Vzc2lvblRva2VuID0gcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWyd4LWFtei1zZWN1cml0eS10b2tlbiddOwogICAgICB9CiAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXpuLXJlcXVlc3RpZCddKSB7CiAgICAgICAgbW9uaXRvcmluZ0V2ZW50LlhBbXpuUmVxdWVzdElkID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16bi1yZXF1ZXN0aWQnXTsKICAgICAgfQogICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LXJlcXVlc3QtaWQnXSkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5YQW16UmVxdWVzdElkID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LXJlcXVlc3QtaWQnXTsKICAgICAgfQogICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LWlkLTInXSkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5YQW16SWQyID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LWlkLTInXTsKICAgICAgfQogICAgICByZXR1cm4gbW9uaXRvcmluZ0V2ZW50OwogICAgfSwKICAKICAgIC8qKgogICAgICogQWRkIG1ldHJpY3Mgb2YgZmFpbGVkIHJlcXVlc3QuCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXR0ZW1wdEZhaWxFdmVudDogZnVuY3Rpb24gYXR0ZW1wdEZhaWxFdmVudChyZXF1ZXN0KSB7CiAgICAgIHZhciBtb25pdG9yaW5nRXZlbnQgPSB0aGlzLmFwaUF0dGVtcHRFdmVudChyZXF1ZXN0KTsKICAgICAgdmFyIHJlc3BvbnNlID0gcmVxdWVzdC5yZXNwb25zZTsKICAgICAgdmFyIGVycm9yID0gcmVzcG9uc2UuZXJyb3I7CiAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSA+IDI5OSApIHsKICAgICAgICBpZiAoZXJyb3IuY29kZSkgbW9uaXRvcmluZ0V2ZW50LkF3c0V4Y2VwdGlvbiA9IGVycm9yLmNvZGU7CiAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIG1vbml0b3JpbmdFdmVudC5Bd3NFeGNlcHRpb25NZXNzYWdlID0gZXJyb3IubWVzc2FnZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoZXJyb3IuY29kZSB8fCBlcnJvci5uYW1lKSBtb25pdG9yaW5nRXZlbnQuU2RrRXhjZXB0aW9uID0gZXJyb3IuY29kZSB8fCBlcnJvci5uYW1lOwogICAgICAgIGlmIChlcnJvci5tZXNzYWdlKSBtb25pdG9yaW5nRXZlbnQuU2RrRXhjZXB0aW9uTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICAgIH0KICAgICAgcmV0dXJuIG1vbml0b3JpbmdFdmVudDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEF0dGFjaCBsaXN0ZW5lcnMgdG8gcmVxdWVzdCBvYmplY3QgdG8gZmV0Y2ggbWV0cmljcyBvZiBlYWNoIHJlcXVlc3QKICAgICAqIGFuZCBlbWl0IGRhdGEgb2JqZWN0IHRocm91Z2ggXCdBcGlDYWxsXCcgYW5kIFwnQXBpQ2FsbEF0dGVtcHRcJyBldmVudHMuCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXR0YWNoTW9uaXRvcmluZ0VtaXR0ZXI6IGZ1bmN0aW9uIGF0dGFjaE1vbml0b3JpbmdFbWl0dGVyKHJlcXVlc3QpIHsKICAgICAgdmFyIGF0dGVtcHRUaW1lc3RhbXA7IC8vdGltZXN0YW1wIG1hcmtpbmcgdGhlIGJlZ2lubmluZyBvZiBhIHJlcXVlc3QgYXR0ZW1wdAogICAgICB2YXIgYXR0ZW1wdFN0YXJ0UmVhbFRpbWU7IC8vU3RhcnQgdGltZSBvZiByZXF1ZXN0IGF0dGVtcHQuIFVzZWQgdG8gY2FsY3VsYXRpbmcgYXR0ZW1wdExhdGVuY3kKICAgICAgdmFyIGF0dGVtcHRMYXRlbmN5OyAvL2xhdGVuY3kgZnJvbSByZXF1ZXN0IHNlbnQgb3V0IHRvIGh0dHAgcmVzcG9uc2UgcmVhY2hpbmcgU0RLCiAgICAgIHZhciBjYWxsU3RhcnRSZWFsVGltZTsgLy9TdGFydCB0aW1lIG9mIEFQSSBjYWxsLiBVc2VkIHRvIGNhbGN1bGF0aW5nIEFQSSBjYWxsIGxhdGVuY3kKICAgICAgdmFyIGF0dGVtcHRDb3VudCA9IDA7IC8vcmVxdWVzdC5yZXRyeUNvdW50IGlzIG5vdCByZWxpYWJsZSBoZXJlCiAgICAgIHZhciByZWdpb247IC8vcmVnaW9uIGNhY2hlIHJlZ2lvbiBmb3IgZWFjaCBhdHRlbXB0IHNpbmNlIGl0IGNhbiBiZSB1cGRhdGVkIGluIHBsYXNlIChlLmcuIHMzKQogICAgICB2YXIgY2FsbFRpbWVzdGFtcDsgLy90aW1lc3RhbXAgd2hlbiB0aGUgcmVxdWVzdCBpcyBjcmVhdGVkCiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGFkZFRvSGVhZCA9IHRydWU7CiAgCiAgICAgIHJlcXVlc3Qub24oJ3ZhbGlkYXRlJywgZnVuY3Rpb24gKCkgewogICAgICAgIGNhbGxTdGFydFJlYWxUaW1lID0gQVdTLnV0aWwucmVhbENsb2NrLm5vdygpOwogICAgICAgIGNhbGxUaW1lc3RhbXAgPSBEYXRlLm5vdygpOwogICAgICB9LCBhZGRUb0hlYWQpOwogICAgICByZXF1ZXN0Lm9uKCdzaWduJywgZnVuY3Rpb24gKCkgewogICAgICAgIGF0dGVtcHRTdGFydFJlYWxUaW1lID0gQVdTLnV0aWwucmVhbENsb2NrLm5vdygpOwogICAgICAgIGF0dGVtcHRUaW1lc3RhbXAgPSBEYXRlLm5vdygpOwogICAgICAgIHJlZ2lvbiA9IHJlcXVlc3QuaHR0cFJlcXVlc3QucmVnaW9uOwogICAgICAgIGF0dGVtcHRDb3VudCsrOwogICAgICB9LCBhZGRUb0hlYWQpOwogICAgICByZXF1ZXN0Lm9uKCd2YWxpZGF0ZVJlc3BvbnNlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgYXR0ZW1wdExhdGVuY3kgPSBNYXRoLnJvdW5kKEFXUy51dGlsLnJlYWxDbG9jay5ub3coKSAtIGF0dGVtcHRTdGFydFJlYWxUaW1lKTsKICAgICAgfSk7CiAgICAgIHJlcXVlc3QuYWRkTmFtZWRMaXN0ZW5lcignQVBJX0NBTExfQVRURU1QVCcsICdzdWNjZXNzJywgZnVuY3Rpb24gQVBJX0NBTExfQVRURU1QVCgpIHsKICAgICAgICB2YXIgYXBpQXR0ZW1wdEV2ZW50ID0gc2VsZi5hcGlBdHRlbXB0RXZlbnQocmVxdWVzdCk7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LlRpbWVzdGFtcCA9IGF0dGVtcHRUaW1lc3RhbXA7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LkF0dGVtcHRMYXRlbmN5ID0gYXR0ZW1wdExhdGVuY3kgPj0gMCA/IGF0dGVtcHRMYXRlbmN5IDogMDsKICAgICAgICBhcGlBdHRlbXB0RXZlbnQuUmVnaW9uID0gcmVnaW9uOwogICAgICAgIHNlbGYuZW1pdCgnYXBpQ2FsbEF0dGVtcHQnLCBbYXBpQXR0ZW1wdEV2ZW50XSk7CiAgICAgIH0pOwogICAgICByZXF1ZXN0LmFkZE5hbWVkTGlzdGVuZXIoJ0FQSV9DQUxMX0FUVEVNUFRfUkVUUlknLCAncmV0cnknLCBmdW5jdGlvbiBBUElfQ0FMTF9BVFRFTVBUX1JFVFJZKCkgewogICAgICAgIHZhciBhcGlBdHRlbXB0RXZlbnQgPSBzZWxmLmF0dGVtcHRGYWlsRXZlbnQocmVxdWVzdCk7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LlRpbWVzdGFtcCA9IGF0dGVtcHRUaW1lc3RhbXA7CiAgICAgICAgLy9hdHRlbXB0TGF0ZW5jeSBtYXkgbm90IGJlIGF2YWlsYWJsZSBpZiBmYWlsIGJlZm9yZSByZXNwb25zZQogICAgICAgIGF0dGVtcHRMYXRlbmN5ID0gYXR0ZW1wdExhdGVuY3kgfHwKICAgICAgICAgIE1hdGgucm91bmQoQVdTLnV0aWwucmVhbENsb2NrLm5vdygpIC0gYXR0ZW1wdFN0YXJ0UmVhbFRpbWUpOwogICAgICAgIGFwaUF0dGVtcHRFdmVudC5BdHRlbXB0TGF0ZW5jeSA9IGF0dGVtcHRMYXRlbmN5ID49IDAgPyBhdHRlbXB0TGF0ZW5jeSA6IDA7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LlJlZ2lvbiA9IHJlZ2lvbjsKICAgICAgICBzZWxmLmVtaXQoJ2FwaUNhbGxBdHRlbXB0JywgW2FwaUF0dGVtcHRFdmVudF0pOwogICAgICB9KTsKICAgICAgcmVxdWVzdC5hZGROYW1lZExpc3RlbmVyKCdBUElfQ0FMTCcsICdjb21wbGV0ZScsIGZ1bmN0aW9uIEFQSV9DQUxMKCkgewogICAgICAgIHZhciBhcGlDYWxsRXZlbnQgPSBzZWxmLmFwaUNhbGxFdmVudChyZXF1ZXN0KTsKICAgICAgICBhcGlDYWxsRXZlbnQuQXR0ZW1wdENvdW50ID0gYXR0ZW1wdENvdW50OwogICAgICAgIGlmIChhcGlDYWxsRXZlbnQuQXR0ZW1wdENvdW50IDw9IDApIHJldHVybjsKICAgICAgICBhcGlDYWxsRXZlbnQuVGltZXN0YW1wID0gY2FsbFRpbWVzdGFtcDsKICAgICAgICB2YXIgbGF0ZW5jeSA9IE1hdGgucm91bmQoQVdTLnV0aWwucmVhbENsb2NrLm5vdygpIC0gY2FsbFN0YXJ0UmVhbFRpbWUpOwogICAgICAgIGFwaUNhbGxFdmVudC5MYXRlbmN5ID0gbGF0ZW5jeSA+PSAwID8gbGF0ZW5jeSA6IDA7CiAgICAgICAgdmFyIHJlc3BvbnNlID0gcmVxdWVzdC5yZXNwb25zZTsKICAgICAgICBpZiAoCiAgICAgICAgICB0eXBlb2YgcmVzcG9uc2UucmV0cnlDb3VudCA9PT0gJ251bWJlcicgJiYKICAgICAgICAgIHR5cGVvZiByZXNwb25zZS5tYXhSZXRyaWVzID09PSAnbnVtYmVyJyAmJgogICAgICAgICAgKHJlc3BvbnNlLnJldHJ5Q291bnQgPj0gcmVzcG9uc2UubWF4UmV0cmllcykKICAgICAgICApIHsKICAgICAgICAgIGFwaUNhbGxFdmVudC5NYXhSZXRyaWVzRXhjZWVkZWQgPSAxOwogICAgICAgIH0KICAgICAgICBzZWxmLmVtaXQoJ2FwaUNhbGwnLCBbYXBpQ2FsbEV2ZW50XSk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogT3ZlcnJpZGUgdGhpcyBtZXRob2QgdG8gc2V0dXAgYW55IGN1c3RvbSByZXF1ZXN0IGxpc3RlbmVycyBmb3IgZWFjaAogICAgICogbmV3IHJlcXVlc3QgdG8gdGhlIHNlcnZpY2UuCiAgICAgKgogICAgICogQG1ldGhvZF9hYnN0cmFjdCBUaGlzIGlzIGFuIGFic3RyYWN0IG1ldGhvZC4KICAgICAqLwogICAgc2V0dXBSZXF1ZXN0TGlzdGVuZXJzOiBmdW5jdGlvbiBzZXR1cFJlcXVlc3RMaXN0ZW5lcnMocmVxdWVzdCkgewogICAgfSwKICAKICAgIC8qKgogICAgICogR2V0cyB0aGUgc2lnbmVyIGNsYXNzIGZvciBhIGdpdmVuIHJlcXVlc3QKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRTaWduZXJDbGFzczogZnVuY3Rpb24gZ2V0U2lnbmVyQ2xhc3MocmVxdWVzdCkgewogICAgICB2YXIgdmVyc2lvbjsKICAgICAgLy8gZ2V0IG9wZXJhdGlvbiBhdXRodHlwZSBpZiBwcmVzZW50CiAgICAgIHZhciBvcGVyYXRpb24gPSBudWxsOwogICAgICB2YXIgYXV0aHR5cGUgPSAnJzsKICAgICAgaWYgKHJlcXVlc3QpIHsKICAgICAgICB2YXIgb3BlcmF0aW9ucyA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9ucyB8fCB7fTsKICAgICAgICBvcGVyYXRpb24gPSBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXSB8fCBudWxsOwogICAgICAgIGF1dGh0eXBlID0gb3BlcmF0aW9uID8gb3BlcmF0aW9uLmF1dGh0eXBlIDogJyc7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIHsKICAgICAgICB2ZXJzaW9uID0gdGhpcy5jb25maWcuc2lnbmF0dXJlVmVyc2lvbjsKICAgICAgfSBlbHNlIGlmIChhdXRodHlwZSA9PT0gJ3Y0JyB8fCBhdXRodHlwZSA9PT0gJ3Y0LXVuc2lnbmVkLWJvZHknKSB7CiAgICAgICAgdmVyc2lvbiA9ICd2NCc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmVyc2lvbiA9IHRoaXMuYXBpLnNpZ25hdHVyZVZlcnNpb247CiAgICAgIH0KICAgICAgcmV0dXJuIEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIuZ2V0VmVyc2lvbih2ZXJzaW9uKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzZXJ2aWNlSW50ZXJmYWNlOiBmdW5jdGlvbiBzZXJ2aWNlSW50ZXJmYWNlKCkgewogICAgICBzd2l0Y2ggKHRoaXMuYXBpLnByb3RvY29sKSB7CiAgICAgICAgY2FzZSAnZWMyJzogcmV0dXJuIEFXUy5FdmVudExpc3RlbmVycy5RdWVyeTsKICAgICAgICBjYXNlICdxdWVyeSc6IHJldHVybiBBV1MuRXZlbnRMaXN0ZW5lcnMuUXVlcnk7CiAgICAgICAgY2FzZSAnanNvbic6IHJldHVybiBBV1MuRXZlbnRMaXN0ZW5lcnMuSnNvbjsKICAgICAgICBjYXNlICdyZXN0LWpzb24nOiByZXR1cm4gQVdTLkV2ZW50TGlzdGVuZXJzLlJlc3RKc29uOwogICAgICAgIGNhc2UgJ3Jlc3QteG1sJzogcmV0dXJuIEFXUy5FdmVudExpc3RlbmVycy5SZXN0WG1sOwogICAgICB9CiAgICAgIGlmICh0aGlzLmFwaS5wcm90b2NvbCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBzZXJ2aWNlIGBwcm90b2NvbFwnICcgKwogICAgICAgICAgdGhpcy5hcGkucHJvdG9jb2wgKyAnIGluIEFQSSBjb25maWcnKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHN1Y2Nlc3NmdWxSZXNwb25zZTogZnVuY3Rpb24gc3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3ApIHsKICAgICAgcmV0dXJuIHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUgPCAzMDA7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBIb3cgbWFueSB0aW1lcyBhIGZhaWxlZCByZXF1ZXN0IHNob3VsZCBiZSByZXRyaWVkIGJlZm9yZSBnaXZpbmcgdXAuCiAgICAgKiB0aGUgZGVmYXVsdFJldHJ5Q291bnQgY2FuIGJlIG92ZXJyaWRlbiBieSBzZXJ2aWNlIGNsYXNzZXMuCiAgICAgKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIG51bVJldHJpZXM6IGZ1bmN0aW9uIG51bVJldHJpZXMoKSB7CiAgICAgIGlmICh0aGlzLmNvbmZpZy5tYXhSZXRyaWVzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25maWcubWF4UmV0cmllczsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5kZWZhdWx0UmV0cnlDb3VudDsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHJldHJ5RGVsYXlzOiBmdW5jdGlvbiByZXRyeURlbGF5cyhyZXRyeUNvdW50KSB7CiAgICAgIHJldHVybiBBV1MudXRpbC5jYWxjdWxhdGVSZXRyeURlbGF5KHJldHJ5Q291bnQsIHRoaXMuY29uZmlnLnJldHJ5RGVsYXlPcHRpb25zKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICByZXRyeWFibGVFcnJvcjogZnVuY3Rpb24gcmV0cnlhYmxlRXJyb3IoZXJyb3IpIHsKICAgICAgaWYgKHRoaXMudGltZW91dEVycm9yKGVycm9yKSkgcmV0dXJuIHRydWU7CiAgICAgIGlmICh0aGlzLm5ldHdvcmtpbmdFcnJvcihlcnJvcikpIHJldHVybiB0cnVlOwogICAgICBpZiAodGhpcy5leHBpcmVkQ3JlZGVudGlhbHNFcnJvcihlcnJvcikpIHJldHVybiB0cnVlOwogICAgICBpZiAodGhpcy50aHJvdHRsZWRFcnJvcihlcnJvcikpIHJldHVybiB0cnVlOwogICAgICBpZiAoZXJyb3Iuc3RhdHVzQ29kZSA+PSA1MDApIHJldHVybiB0cnVlOwogICAgICBpZiAoZXJyb3Iuc3RhdHVzQ29kZSA9PT0gNDAzKSByZXR1cm4gdHJ1ZTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIG5ldHdvcmtpbmdFcnJvcjogZnVuY3Rpb24gbmV0d29ya2luZ0Vycm9yKGVycm9yKSB7CiAgICAgIHJldHVybiBlcnJvci5jb2RlID09PSAnTmV0d29ya2luZ0Vycm9yJzsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICB0aW1lb3V0RXJyb3I6IGZ1bmN0aW9uIHRpbWVvdXRFcnJvcihlcnJvcikgewogICAgICByZXR1cm4gZXJyb3IuY29kZSA9PT0gJ1RpbWVvdXRFcnJvcic7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZXhwaXJlZENyZWRlbnRpYWxzRXJyb3I6IGZ1bmN0aW9uIGV4cGlyZWRDcmVkZW50aWFsc0Vycm9yKGVycm9yKSB7CiAgICAgIC8vIFRPRE8gOiB0aGlzIG9ubHkgaGFuZGxlcyAqb25lKiBvZiB0aGUgZXhwaXJlZCBjcmVkZW50aWFsIGNvZGVzCiAgICAgIHJldHVybiAoZXJyb3IuY29kZSA9PT0gJ0V4cGlyZWRUb2tlbkV4Y2VwdGlvbicpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNsb2NrU2tld0Vycm9yOiBmdW5jdGlvbiBjbG9ja1NrZXdFcnJvcihlcnJvcikgewogICAgICBzd2l0Y2ggKGVycm9yLmNvZGUpIHsKICAgICAgICBjYXNlICdSZXF1ZXN0VGltZVRvb1NrZXdlZCc6CiAgICAgICAgY2FzZSAnUmVxdWVzdEV4cGlyZWQnOgogICAgICAgIGNhc2UgJ0ludmFsaWRTaWduYXR1cmVFeGNlcHRpb24nOgogICAgICAgIGNhc2UgJ1NpZ25hdHVyZURvZXNOb3RNYXRjaCc6CiAgICAgICAgY2FzZSAnQXV0aEZhaWx1cmUnOgogICAgICAgIGNhc2UgJ1JlcXVlc3RJblRoZUZ1dHVyZSc6CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICBkZWZhdWx0OiByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRTa2V3Q29ycmVjdGVkRGF0ZTogZnVuY3Rpb24gZ2V0U2tld0NvcnJlY3RlZERhdGUoKSB7CiAgICAgIHJldHVybiBuZXcgRGF0ZShEYXRlLm5vdygpICsgdGhpcy5jb25maWcuc3lzdGVtQ2xvY2tPZmZzZXQpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwcGx5Q2xvY2tPZmZzZXQ6IGZ1bmN0aW9uIGFwcGx5Q2xvY2tPZmZzZXQobmV3U2VydmVyVGltZSkgewogICAgICBpZiAobmV3U2VydmVyVGltZSkgewogICAgICAgIHRoaXMuY29uZmlnLnN5c3RlbUNsb2NrT2Zmc2V0ID0gbmV3U2VydmVyVGltZSAtIERhdGUubm93KCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBpc0Nsb2NrU2tld2VkOiBmdW5jdGlvbiBpc0Nsb2NrU2tld2VkKG5ld1NlcnZlclRpbWUpIHsKICAgICAgaWYgKG5ld1NlcnZlclRpbWUpIHsKICAgICAgICByZXR1cm4gTWF0aC5hYnModGhpcy5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpLmdldFRpbWUoKSAtIG5ld1NlcnZlclRpbWUpID49IDMwMDAwOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdGhyb3R0bGVkRXJyb3I6IGZ1bmN0aW9uIHRocm90dGxlZEVycm9yKGVycm9yKSB7CiAgICAgIC8vIHRoaXMgbG9naWMgdmFyaWVzIGJldHdlZW4gc2VydmljZXMKICAgICAgaWYgKGVycm9yLnN0YXR1c0NvZGUgPT09IDQyOSkgcmV0dXJuIHRydWU7CiAgICAgIHN3aXRjaCAoZXJyb3IuY29kZSkgewogICAgICAgIGNhc2UgJ1Byb3Zpc2lvbmVkVGhyb3VnaHB1dEV4Y2VlZGVkRXhjZXB0aW9uJzoKICAgICAgICBjYXNlICdUaHJvdHRsaW5nJzoKICAgICAgICBjYXNlICdUaHJvdHRsaW5nRXhjZXB0aW9uJzoKICAgICAgICBjYXNlICdSZXF1ZXN0TGltaXRFeGNlZWRlZCc6CiAgICAgICAgY2FzZSAnUmVxdWVzdFRocm90dGxlZCc6CiAgICAgICAgY2FzZSAnUmVxdWVzdFRocm90dGxlZEV4Y2VwdGlvbic6CiAgICAgICAgY2FzZSAnVG9vTWFueVJlcXVlc3RzRXhjZXB0aW9uJzoKICAgICAgICBjYXNlICdUcmFuc2FjdGlvbkluUHJvZ3Jlc3NFeGNlcHRpb24nOiAvL2R5bmFtb2RiCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZW5kcG9pbnRGcm9tVGVtcGxhdGU6IGZ1bmN0aW9uIGVuZHBvaW50RnJvbVRlbXBsYXRlKGVuZHBvaW50KSB7CiAgICAgIGlmICh0eXBlb2YgZW5kcG9pbnQgIT09ICdzdHJpbmcnKSByZXR1cm4gZW5kcG9pbnQ7CiAgCiAgICAgIHZhciBlID0gZW5kcG9pbnQ7CiAgICAgIGUgPSBlLnJlcGxhY2UoL1x7c2VydmljZVx9L2csIHRoaXMuYXBpLmVuZHBvaW50UHJlZml4KTsKICAgICAgZSA9IGUucmVwbGFjZSgvXHtyZWdpb25cfS9nLCB0aGlzLmNvbmZpZy5yZWdpb24pOwogICAgICBlID0gZS5yZXBsYWNlKC9ce3NjaGVtZVx9L2csIHRoaXMuY29uZmlnLnNzbEVuYWJsZWQgPyAnaHR0cHMnIDogJ2h0dHAnKTsKICAgICAgcmV0dXJuIGU7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc2V0RW5kcG9pbnQ6IGZ1bmN0aW9uIHNldEVuZHBvaW50KGVuZHBvaW50KSB7CiAgICAgIHRoaXMuZW5kcG9pbnQgPSBuZXcgQVdTLkVuZHBvaW50KGVuZHBvaW50LCB0aGlzLmNvbmZpZyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgcGFnaW5hdGlvbkNvbmZpZzogZnVuY3Rpb24gcGFnaW5hdGlvbkNvbmZpZyhvcGVyYXRpb24sIHRocm93RXhjZXB0aW9uKSB7CiAgICAgIHZhciBwYWdpbmF0b3IgPSB0aGlzLmFwaS5vcGVyYXRpb25zW29wZXJhdGlvbl0ucGFnaW5hdG9yOwogICAgICBpZiAoIXBhZ2luYXRvcikgewogICAgICAgIGlmICh0aHJvd0V4Y2VwdGlvbikgewogICAgICAgICAgdmFyIGUgPSBuZXcgRXJyb3IoKTsKICAgICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKGUsICdObyBwYWdpbmF0aW9uIGNvbmZpZ3VyYXRpb24gZm9yICcgKyBvcGVyYXRpb24pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogIAogICAgICByZXR1cm4gcGFnaW5hdG9yOwogICAgfQogIH0pOwogIAogIEFXUy51dGlsLnVwZGF0ZShBV1MuU2VydmljZSwgewogIAogICAgLyoqCiAgICAgKiBBZGRzIG9uZSBtZXRob2QgZm9yIGVhY2ggb3BlcmF0aW9uIGRlc2NyaWJlZCBpbiB0aGUgYXBpIGNvbmZpZ3VyYXRpb24KICAgICAqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZGVmaW5lTWV0aG9kczogZnVuY3Rpb24gZGVmaW5lTWV0aG9kcyhzdmMpIHsKICAgICAgQVdTLnV0aWwuZWFjaChzdmMucHJvdG90eXBlLmFwaS5vcGVyYXRpb25zLCBmdW5jdGlvbiBpdGVyYXRvcihtZXRob2QpIHsKICAgICAgICBpZiAoc3ZjLnByb3RvdHlwZVttZXRob2RdKSByZXR1cm47CiAgICAgICAgdmFyIG9wZXJhdGlvbiA9IHN2Yy5wcm90b3R5cGUuYXBpLm9wZXJhdGlvbnNbbWV0aG9kXTsKICAgICAgICBpZiAob3BlcmF0aW9uLmF1dGh0eXBlID09PSAnbm9uZScpIHsKICAgICAgICAgIHN2Yy5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uIChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFjayk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdmMucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbiAocGFyYW1zLCBjYWxsYmFjaykgewogICAgICAgICAgICByZXR1cm4gdGhpcy5tYWtlUmVxdWVzdChtZXRob2QsIHBhcmFtcywgY2FsbGJhY2spOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogRGVmaW5lcyBhIG5ldyBTZXJ2aWNlIGNsYXNzIHVzaW5nIGEgc2VydmljZSBpZGVudGlmaWVyIGFuZCBsaXN0IG9mIHZlcnNpb25zCiAgICAgKiBpbmNsdWRpbmcgYW4gb3B0aW9uYWwgc2V0IG9mIGZlYXR1cmVzIChmdW5jdGlvbnMpIHRvIGFwcGx5IHRvIHRoZSBjbGFzcwogICAgICogcHJvdG90eXBlLgogICAgICoKICAgICAqIEBwYXJhbSBzZXJ2aWNlSWRlbnRpZmllciBbU3RyaW5nXSB0aGUgaWRlbnRpZmllciBmb3IgdGhlIHNlcnZpY2UKICAgICAqIEBwYXJhbSB2ZXJzaW9ucyBbQXJyYXk8U3RyaW5nPl0gYSBsaXN0IG9mIHZlcnNpb25zIHRoYXQgd29yayB3aXRoIHRoaXMKICAgICAqICAgc2VydmljZQogICAgICogQHBhcmFtIGZlYXR1cmVzIFtPYmplY3RdIGFuIG9iamVjdCB0byBhdHRhY2ggdG8gdGhlIHByb3RvdHlwZQogICAgICogQHJldHVybiBbQ2xhc3M8U2VydmljZT5dIHRoZSBzZXJ2aWNlIGNsYXNzIGRlZmluZWQgYnkgdGhpcyBmdW5jdGlvbi4KICAgICAqLwogICAgZGVmaW5lU2VydmljZTogZnVuY3Rpb24gZGVmaW5lU2VydmljZShzZXJ2aWNlSWRlbnRpZmllciwgdmVyc2lvbnMsIGZlYXR1cmVzKSB7CiAgICAgIEFXUy5TZXJ2aWNlLl9zZXJ2aWNlTWFwW3NlcnZpY2VJZGVudGlmaWVyXSA9IHRydWU7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheSh2ZXJzaW9ucykpIHsKICAgICAgICBmZWF0dXJlcyA9IHZlcnNpb25zOwogICAgICAgIHZlcnNpb25zID0gW107CiAgICAgIH0KICAKICAgICAgdmFyIHN2YyA9IGluaGVyaXQoQVdTLlNlcnZpY2UsIGZlYXR1cmVzIHx8IHt9KTsKICAKICAgICAgaWYgKHR5cGVvZiBzZXJ2aWNlSWRlbnRpZmllciA9PT0gJ3N0cmluZycpIHsKICAgICAgICBBV1MuU2VydmljZS5hZGRWZXJzaW9ucyhzdmMsIHZlcnNpb25zKTsKICAKICAgICAgICB2YXIgaWRlbnRpZmllciA9IHN2Yy5zZXJ2aWNlSWRlbnRpZmllciB8fCBzZXJ2aWNlSWRlbnRpZmllcjsKICAgICAgICBzdmMuc2VydmljZUlkZW50aWZpZXIgPSBpZGVudGlmaWVyOwogICAgICB9IGVsc2UgeyAvLyBkZWZpbmVTZXJ2aWNlIGNhbGxlZCB3aXRoIGFuIEFQSQogICAgICAgIHN2Yy5wcm90b3R5cGUuYXBpID0gc2VydmljZUlkZW50aWZpZXI7CiAgICAgICAgQVdTLlNlcnZpY2UuZGVmaW5lTWV0aG9kcyhzdmMpOwogICAgICB9CiAgICAgIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IuY2FsbCh0aGlzLnByb3RvdHlwZSk7CiAgICAgIC8vdXRpbC5jbGllbnRTaWRlTW9uaXRvcmluZyBpcyBvbmx5IGF2YWlsYWJsZSBpbiBub2RlCiAgICAgIGlmICghdGhpcy5wcm90b3R5cGUucHVibGlzaGVyICYmIEFXUy51dGlsLmNsaWVudFNpZGVNb25pdG9yaW5nKSB7CiAgICAgICAgdmFyIFB1Ymxpc2hlciA9IEFXUy51dGlsLmNsaWVudFNpZGVNb25pdG9yaW5nLlB1Ymxpc2hlcjsKICAgICAgICB2YXIgY29uZmlnUHJvdmlkZXIgPSBBV1MudXRpbC5jbGllbnRTaWRlTW9uaXRvcmluZy5jb25maWdQcm92aWRlcjsKICAgICAgICB2YXIgcHVibGlzaGVyQ29uZmlnID0gY29uZmlnUHJvdmlkZXIoKTsKICAgICAgICB0aGlzLnByb3RvdHlwZS5wdWJsaXNoZXIgPSBuZXcgUHVibGlzaGVyKHB1Ymxpc2hlckNvbmZpZyk7CiAgICAgICAgaWYgKHB1Ymxpc2hlckNvbmZpZy5lbmFibGVkKSB7CiAgICAgICAgICAvL2lmIGNzbSBpcyBlbmFibGVkIGluIGVudmlyb25tZW50LCBTREsgc2hvdWxkIHNlbmQgYWxsIG1ldHJpY3MKICAgICAgICAgIEFXUy5TZXJ2aWNlLl9jbGllbnRTaWRlTW9uaXRvcmluZyA9IHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IuY2FsbChzdmMucHJvdG90eXBlKTsKICAgICAgQVdTLlNlcnZpY2UuYWRkRGVmYXVsdE1vbml0b3JpbmdMaXN0ZW5lcnMoc3ZjLnByb3RvdHlwZSk7CiAgICAgIHJldHVybiBzdmM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYWRkVmVyc2lvbnM6IGZ1bmN0aW9uIGFkZFZlcnNpb25zKHN2YywgdmVyc2lvbnMpIHsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHZlcnNpb25zKSkgdmVyc2lvbnMgPSBbdmVyc2lvbnNdOwogIAogICAgICBzdmMuc2VydmljZXMgPSBzdmMuc2VydmljZXMgfHwge307CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmVyc2lvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoc3ZjLnNlcnZpY2VzW3ZlcnNpb25zW2ldXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBzdmMuc2VydmljZXNbdmVyc2lvbnNbaV1dID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgc3ZjLmFwaVZlcnNpb25zID0gT2JqZWN0LmtleXMoc3ZjLnNlcnZpY2VzKS5zb3J0KCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZGVmaW5lU2VydmljZUFwaTogZnVuY3Rpb24gZGVmaW5lU2VydmljZUFwaShzdXBlcmNsYXNzLCB2ZXJzaW9uLCBhcGlDb25maWcpIHsKICAgICAgdmFyIHN2YyA9IGluaGVyaXQoc3VwZXJjbGFzcywgewogICAgICAgIHNlcnZpY2VJZGVudGlmaWVyOiBzdXBlcmNsYXNzLnNlcnZpY2VJZGVudGlmaWVyCiAgICAgIH0pOwogIAogICAgICBmdW5jdGlvbiBzZXRBcGkoYXBpKSB7CiAgICAgICAgaWYgKGFwaS5pc0FwaSkgewogICAgICAgICAgc3ZjLnByb3RvdHlwZS5hcGkgPSBhcGk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN2Yy5wcm90b3R5cGUuYXBpID0gbmV3IEFwaShhcGkpOwogICAgICAgIH0KICAgICAgfQogIAogICAgICBpZiAodHlwZW9mIHZlcnNpb24gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgaWYgKGFwaUNvbmZpZykgewogICAgICAgICAgc2V0QXBpKGFwaUNvbmZpZyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNldEFwaShBV1MuYXBpTG9hZGVyKHN1cGVyY2xhc3Muc2VydmljZUlkZW50aWZpZXIsIHZlcnNpb24pKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihlcnIsIHsKICAgICAgICAgICAgICBtZXNzYWdlOiAnQ291bGQgbm90IGZpbmQgQVBJIGNvbmZpZ3VyYXRpb24gJyArCiAgICAgICAgICAgICAgICBzdXBlcmNsYXNzLnNlcnZpY2VJZGVudGlmaWVyICsgJy0nICsgdmVyc2lvbgogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc3VwZXJjbGFzcy5zZXJ2aWNlcywgdmVyc2lvbikpIHsKICAgICAgICAgIHN1cGVyY2xhc3MuYXBpVmVyc2lvbnMgPSBzdXBlcmNsYXNzLmFwaVZlcnNpb25zLmNvbmNhdCh2ZXJzaW9uKS5zb3J0KCk7CiAgICAgICAgfQogICAgICAgIHN1cGVyY2xhc3Muc2VydmljZXNbdmVyc2lvbl0gPSBzdmM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0QXBpKHZlcnNpb24pOwogICAgICB9CiAgCiAgICAgIEFXUy5TZXJ2aWNlLmRlZmluZU1ldGhvZHMoc3ZjKTsKICAgICAgcmV0dXJuIHN2YzsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBoYXNTZXJ2aWNlOiBmdW5jdGlvbihpZGVudGlmaWVyKSB7CiAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoQVdTLlNlcnZpY2UuX3NlcnZpY2VNYXAsIGlkZW50aWZpZXIpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQHBhcmFtIGF0dGFjaE9uIGF0dGFjaCBkZWZhdWx0IG1vbml0b3JpbmcgbGlzdGVuZXJzIHRvIG9iamVjdAogICAgICoKICAgICAqIEVhY2ggbW9uaXRvcmluZyBldmVudCBzaG91bGQgYmUgZW1pdHRlZCBmcm9tIHNlcnZpY2UgY2xpZW50IHRvIHNlcnZpY2UgY29uc3RydWN0b3IgcHJvdG90eXBlIGFuZCB0aGVuCiAgICAgKiB0byBnbG9iYWwgc2VydmljZSBwcm90b3R5cGUgbGlrZSBidWJibGluZyB1cC4gVGhlc2UgZGVmYXVsdCBtb25pdG9yaW5nIGV2ZW50cyBsaXN0ZW5lciB3aWxsIHRyYW5zZmVyCiAgICAgKiB0aGUgbW9uaXRvcmluZyBldmVudHMgdG8gdGhlIHVwcGVyIGxheWVyLgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFkZERlZmF1bHRNb25pdG9yaW5nTGlzdGVuZXJzOiBmdW5jdGlvbiBhZGREZWZhdWx0TW9uaXRvcmluZ0xpc3RlbmVycyhhdHRhY2hPbikgewogICAgICBhdHRhY2hPbi5hZGROYW1lZExpc3RlbmVyKCdNT05JVE9SX0VWRU5UU19CVUJCTEUnLCAnYXBpQ2FsbEF0dGVtcHQnLCBmdW5jdGlvbiBFVkVOVFNfQlVCQkxFKGV2ZW50KSB7CiAgICAgICAgdmFyIGJhc2VDbGFzcyA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihhdHRhY2hPbik7CiAgICAgICAgaWYgKGJhc2VDbGFzcy5fZXZlbnRzKSBiYXNlQ2xhc3MuZW1pdCgnYXBpQ2FsbEF0dGVtcHQnLCBbZXZlbnRdKTsKICAgICAgfSk7CiAgICAgIGF0dGFjaE9uLmFkZE5hbWVkTGlzdGVuZXIoJ0NBTExfRVZFTlRTX0JVQkJMRScsICdhcGlDYWxsJywgZnVuY3Rpb24gQ0FMTF9FVkVOVFNfQlVCQkxFKGV2ZW50KSB7CiAgICAgICAgdmFyIGJhc2VDbGFzcyA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihhdHRhY2hPbik7CiAgICAgICAgaWYgKGJhc2VDbGFzcy5fZXZlbnRzKSBiYXNlQ2xhc3MuZW1pdCgnYXBpQ2FsbCcsIFtldmVudF0pOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBfc2VydmljZU1hcDoge30KICB9KTsKICAKICBBV1MudXRpbC5taXhpbihBV1MuU2VydmljZSwgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcik7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2VydmljZTsKICAKICB9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKICB9LHsiLi9jb3JlIjoxOCwiLi9tb2RlbC9hcGkiOjM4LCIuL3JlZ2lvbl9jb25maWciOjUzLCJfcHJvY2VzcyI6ODV9XSw2MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICAKICBBV1MudXRpbC51cGRhdGUoQVdTLkNvZ25pdG9JZGVudGl0eS5wcm90b3R5cGUsIHsKICAgIGdldE9wZW5JZFRva2VuOiBmdW5jdGlvbiBnZXRPcGVuSWRUb2tlbihwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLm1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KCdnZXRPcGVuSWRUb2tlbicsIHBhcmFtcywgY2FsbGJhY2spOwogICAgfSwKICAKICAgIGdldElkOiBmdW5jdGlvbiBnZXRJZChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLm1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KCdnZXRJZCcsIHBhcmFtcywgY2FsbGJhY2spOwogICAgfSwKICAKICAgIGdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHk6IGZ1bmN0aW9uIGdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkocGFyYW1zLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5tYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdCgnZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eScsIHBhcmFtcywgY2FsbGJhY2spOwogICAgfQogIH0pOwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDYxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKHByb2Nlc3MpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIHJlZ2lvbkNvbmZpZyA9IHJlcXVpcmUoJy4uL3JlZ2lvbl9jb25maWcnKTsKICB2YXIgRU5WX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQgPSAnQVdTX1NUU19SRUdJT05BTF9FTkRQT0lOVFMnOwogIHZhciBDT05GSUdfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRCA9ICdzdHNfcmVnaW9uYWxfZW5kcG9pbnRzJzsKICAKICBBV1MudXRpbC51cGRhdGUoQVdTLlNUUy5wcm90b3R5cGUsIHsKICAgIC8qKgogICAgICogQG92ZXJsb2FkIGNyZWRlbnRpYWxzRnJvbShkYXRhLCBjcmVkZW50aWFscyA9IG51bGwpCiAgICAgKiAgIENyZWF0ZXMgYSBjcmVkZW50aWFscyBvYmplY3QgZnJvbSBTVFMgcmVzcG9uc2UgZGF0YSBjb250YWluaW5nCiAgICAgKiAgIGNyZWRlbnRpYWxzIGluZm9ybWF0aW9uLiBVc2VmdWwgZm9yIHF1aWNrbHkgc2V0dGluZyBBV1MgY3JlZGVudGlhbHMuCiAgICAgKgogICAgICogICBAbm90ZSBUaGlzIGlzIGEgbG93LWxldmVsIHV0aWxpdHkgZnVuY3Rpb24uIElmIHlvdSB3YW50IHRvIGxvYWQgdGVtcG9yYXJ5CiAgICAgKiAgICAgY3JlZGVudGlhbHMgaW50byB5b3VyIHByb2Nlc3MgZm9yIHN1YnNlcXVlbnQgcmVxdWVzdHMgdG8gQVdTIHJlc291cmNlcywKICAgICAqICAgICB5b3Ugc2hvdWxkIHVzZSB7QVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzfSBpbnN0ZWFkLgogICAgICogICBAcGFyYW0gZGF0YSBbbWFwXSBkYXRhIHJldHJpZXZlZCBmcm9tIGEgY2FsbCB0byB7Z2V0RmVkZXJhdGVkVG9rZW59LAogICAgICogICAgIHtnZXRTZXNzaW9uVG9rZW59LCB7YXNzdW1lUm9sZX0sIG9yIHthc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4KICAgICAqICAgQHBhcmFtIGNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIGFuIG9wdGlvbmFsIGNyZWRlbnRpYWxzIG9iamVjdCB0bwogICAgICogICAgIGZpbGwgaW5zdGVhZCBvZiBjcmVhdGluZyBhIG5ldyBvYmplY3QuIFVzZWZ1bCB3aGVuIG1vZGlmeWluZyBhbgogICAgICogICAgIGV4aXN0aW5nIGNyZWRlbnRpYWxzIG9iamVjdCBmcm9tIGEgcmVmcmVzaCBjYWxsLgogICAgICogICBAcmV0dXJuIFtBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHNdIHRoZSBzZXQgb2YgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzCiAgICAgKiAgICAgbG9hZGVkIGZyb20gYSByYXcgU1RTIG9wZXJhdGlvbiByZXNwb25zZS4KICAgICAqICAgQGV4YW1wbGUgVXNpbmcgY3JlZGVudGlhbHNGcm9tIHRvIGxvYWQgZ2xvYmFsIEFXUyBjcmVkZW50aWFscwogICAgICogICAgIHZhciBzdHMgPSBuZXcgQVdTLlNUUygpOwogICAgICogICAgIHN0cy5nZXRTZXNzaW9uVG9rZW4oZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICogICAgICAgaWYgKGVycikgY29uc29sZS5sb2coIkVycm9yIGdldHRpbmcgY3JlZGVudGlhbHMiKTsKICAgICAqICAgICAgIGVsc2UgewogICAgICogICAgICAgICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gc3RzLmNyZWRlbnRpYWxzRnJvbShkYXRhKTsKICAgICAqICAgICAgIH0KICAgICAqICAgICB9KTsKICAgICAqICAgQHNlZSBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMKICAgICAqLwogICAgY3JlZGVudGlhbHNGcm9tOiBmdW5jdGlvbiBjcmVkZW50aWFsc0Zyb20oZGF0YSwgY3JlZGVudGlhbHMpIHsKICAgICAgaWYgKCFkYXRhKSByZXR1cm4gbnVsbDsKICAgICAgaWYgKCFjcmVkZW50aWFscykgY3JlZGVudGlhbHMgPSBuZXcgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzKCk7CiAgICAgIGNyZWRlbnRpYWxzLmV4cGlyZWQgPSBmYWxzZTsKICAgICAgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgPSBkYXRhLkNyZWRlbnRpYWxzLkFjY2Vzc0tleUlkOwogICAgICBjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXkgPSBkYXRhLkNyZWRlbnRpYWxzLlNlY3JldEFjY2Vzc0tleTsKICAgICAgY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuID0gZGF0YS5DcmVkZW50aWFscy5TZXNzaW9uVG9rZW47CiAgICAgIGNyZWRlbnRpYWxzLmV4cGlyZVRpbWUgPSBkYXRhLkNyZWRlbnRpYWxzLkV4cGlyYXRpb247CiAgICAgIHJldHVybiBjcmVkZW50aWFsczsKICAgIH0sCiAgCiAgICBhc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5OiBmdW5jdGlvbiBhc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5KHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHRoaXMubWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3QoJ2Fzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHknLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICBhc3N1bWVSb2xlV2l0aFNBTUw6IGZ1bmN0aW9uIGFzc3VtZVJvbGVXaXRoU0FNTChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLm1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KCdhc3N1bWVSb2xlV2l0aFNBTUwnLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICB2YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZ1ZhbHVlOiBmdW5jdGlvbiB2YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZ1ZhbHVlKGNvbmZpZ1ZhbHVlLCBlcnJvck9wdGlvbnMpIHsKICAgICAgaWYgKHR5cGVvZiBjb25maWdWYWx1ZSA9PT0gJ3N0cmluZycgJiYgWydsZWdhY3knLCAncmVnaW9uYWwnXS5pbmRleE9mKGNvbmZpZ1ZhbHVlLnRvTG93ZXJDYXNlKCkpID49IDApIHsKICAgICAgICB0aGlzLmNvbmZpZy5zdHNSZWdpb25hbEVuZHBvaW50cyA9IGNvbmZpZ1ZhbHVlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLCBlcnJvck9wdGlvbnMpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWc6IGZ1bmN0aW9uIHZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnKCkgewogICAgICAvL3ZhbGlkYXRlIGNvbmZpZyB2YWx1ZQogICAgICB2YXIgY29uZmlnID0gdGhpcy5jb25maWc7CiAgICAgIGlmIChjb25maWcuc3RzUmVnaW9uYWxFbmRwb2ludHMpIHsKICAgICAgICB0aGlzLnZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnVmFsdWUoY29uZmlnLnN0c1JlZ2lvbmFsRW5kcG9pbnRzLCB7CiAgICAgICAgICBjb2RlOiAnSW52YWxpZENvbmZpZ3VyYXRpb24nLAogICAgICAgICAgbWVzc2FnZTogJ2ludmFsaWQgInN0c1JlZ2lvbmFsRW5kcG9pbnRzIiBjb25maWd1cmF0aW9uLiBFeHBlY3QgImxlZ2FjeSIgJyArCiAgICAgICAgICAnIG9yICJyZWdpb25hbCIuIEdvdCAiJyArIGNvbmZpZy5zdHNSZWdpb25hbEVuZHBvaW50cyArICciLicKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoIUFXUy51dGlsLmlzTm9kZSgpKSByZXR1cm47CiAgICAgIC8vdmFsaWRhdGUgZW52aXJvbm1lbnRhbCB2YXJpYWJsZQogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHByb2Nlc3MuZW52LCBFTlZfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRCkpIHsKICAgICAgICB2YXIgZW52RmxhZyA9IHByb2Nlc3MuZW52W0VOVl9SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEXTsKICAgICAgICB0aGlzLnZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnVmFsdWUoZW52RmxhZywgewogICAgICAgICAgY29kZTogJ0ludmFsaWRFbnZpcm9ubWVudGFsVmFyaWFibGUnLAogICAgICAgICAgbWVzc2FnZTogJ2ludmFsaWQgJyArIEVOVl9SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEICsgJyBlbnZpcm9ubWVudGFsIHZhcmlhYmxlLiBFeHBlY3QgImxlZ2FjeSIgJyArCiAgICAgICAgICAnIG9yICJyZWdpb25hbCIuIEdvdCAiJyArIHByb2Nlc3MuZW52W0VOVl9SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEXSArICciLicKICAgICAgICB9KTsKICAgICAgfQogICAgICAvL3ZhbGlkYXRlIHNoYXJlZCBjb25maWcgZmlsZQogICAgICB2YXIgcHJvZmlsZSA9IHt9OwogICAgICB0cnkgewogICAgICAgIHZhciBwcm9maWxlcyA9IEFXUy51dGlsLmdldFByb2ZpbGVzRnJvbVNoYXJlZENvbmZpZyhBV1MudXRpbC5pbmlMb2FkZXIpOwogICAgICAgIHByb2ZpbGUgPSBwcm9maWxlc1twcm9jZXNzLmVudi5BV1NfUFJPRklMRSB8fCBBV1MudXRpbC5kZWZhdWx0UHJvZmlsZV07CiAgICAgIH0gY2F0Y2ggKGUpIHt9OwogICAgICBpZiAocHJvZmlsZSAmJiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocHJvZmlsZSwgQ09ORklHX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQpKSB7CiAgICAgICAgdmFyIGZpbGVGbGFnID0gcHJvZmlsZVtDT05GSUdfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRF07CiAgICAgICAgdGhpcy52YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZ1ZhbHVlKGZpbGVGbGFnLCB7CiAgICAgICAgICBjb2RlOiAnSW52YWxpZENvbmZpZ3VyYXRpb24nLAogICAgICAgICAgbWVzc2FnZTogJ2ludmFsaWQgJytDT05GSUdfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRCsnIHByb2ZpbGUgY29uZmlnLiBFeHBlY3QgImxlZ2FjeSIgJyArCiAgICAgICAgICAnIG9yICJyZWdpb25hbCIuIEdvdCAiJyArIHByb2ZpbGVbQ09ORklHX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRURdICsgJyIuJwogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgb3B0SW5SZWdpb25hbEVuZHBvaW50OiBmdW5jdGlvbiBvcHRJblJlZ2lvbmFsRW5kcG9pbnQoKSB7CiAgICAgIHRoaXMudmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWcoKTsKICAgICAgdmFyIGNvbmZpZyA9IHRoaXMuY29uZmlnOwogICAgICBpZiAoY29uZmlnLnN0c1JlZ2lvbmFsRW5kcG9pbnRzID09PSAncmVnaW9uYWwnKSB7CiAgICAgICAgcmVnaW9uQ29uZmlnKHRoaXMpOwogICAgICAgIGlmICghdGhpcy5pc0dsb2JhbEVuZHBvaW50KSByZXR1cm47CiAgICAgICAgdGhpcy5pc0dsb2JhbEVuZHBvaW50ID0gZmFsc2U7CiAgICAgICAgLy9jbGllbnQgd2lsbCB0aHJvdyBpZiByZWdpb24gaXMgbm90IHN1cHBsaWVkOyByZXF1ZXN0IHdpbGwgYmUgc2lnbmVkIHdpdGggc3BlY2lmaWVkIHJlZ2lvbgogICAgICAgIGlmICghY29uZmlnLnJlZ2lvbikgewogICAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksCiAgICAgICAgICAgIHtjb2RlOiAnQ29uZmlnRXJyb3InLCBtZXNzYWdlOiAnTWlzc2luZyByZWdpb24gaW4gY29uZmlnJ30pOwogICAgICAgIH0KICAgICAgICB2YXIgaW5zZXJ0UG9pbnQgPSBjb25maWcuZW5kcG9pbnQuaW5kZXhPZignLmFtYXpvbmF3cy5jb20nKTsKICAgICAgICBjb25maWcuZW5kcG9pbnQgPSBjb25maWcuZW5kcG9pbnQuc3Vic3RyaW5nKDAsIGluc2VydFBvaW50KSArCiAgICAgICAgICAnLicgKyBjb25maWcucmVnaW9uICsgY29uZmlnLmVuZHBvaW50LnN1YnN0cmluZyhpbnNlcnRQb2ludCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVNlcnZpY2U6IGZ1bmN0aW9uIHZhbGlkYXRlU2VydmljZSgpIHsKICAgICAgdGhpcy5vcHRJblJlZ2lvbmFsRW5kcG9pbnQoKTsKICAgIH0KICAKICB9KTsKICAKICB9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKICB9LHsiLi4vY29yZSI6MTgsIi4uL3JlZ2lvbl9jb25maWciOjUzLCJfcHJvY2VzcyI6ODV9XSw2MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIGV4cGlyZXNIZWFkZXIgPSAncHJlc2lnbmVkLWV4cGlyZXMnOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHNpZ25lZFVybEJ1aWxkZXIocmVxdWVzdCkgewogICAgdmFyIGV4cGlyZXMgPSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl07CiAgICB2YXIgc2lnbmVyQ2xhc3MgPSByZXF1ZXN0LnNlcnZpY2UuZ2V0U2lnbmVyQ2xhc3MocmVxdWVzdCk7CiAgCiAgICBkZWxldGUgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydVc2VyLUFnZW50J107CiAgICBkZWxldGUgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1Vc2VyLUFnZW50J107CiAgCiAgICBpZiAoc2lnbmVyQ2xhc3MgPT09IEFXUy5TaWduZXJzLlY0KSB7CiAgICAgIGlmIChleHBpcmVzID4gNjA0ODAwKSB7IC8vIG9uZSB3ZWVrIGV4cGlyeSBpcyBpbnZhbGlkCiAgICAgICAgdmFyIG1lc3NhZ2UgPSAnUHJlc2lnbmluZyBkb2VzIG5vdCBzdXBwb3J0IGV4cGlyeSB0aW1lIGdyZWF0ZXIgJyArCiAgICAgICAgICAgICAgICAgICAgICAndGhhbiBhIHdlZWsgd2l0aCBTaWdWNCBzaWduaW5nLic7CiAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICAgIGNvZGU6ICdJbnZhbGlkRXhwaXJ5VGltZScsIG1lc3NhZ2U6IG1lc3NhZ2UsIHJldHJ5YWJsZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl0gPSBleHBpcmVzOwogICAgfSBlbHNlIGlmIChzaWduZXJDbGFzcyA9PT0gQVdTLlNpZ25lcnMuUzMpIHsKICAgICAgdmFyIG5vdyA9IHJlcXVlc3Quc2VydmljZSA/IHJlcXVlc3Quc2VydmljZS5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpIDogQVdTLnV0aWwuZGF0ZS5nZXREYXRlKCk7CiAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXSA9IHBhcnNlSW50KAogICAgICAgIEFXUy51dGlsLmRhdGUudW5peFRpbWVzdGFtcChub3cpICsgZXhwaXJlcywgMTApLnRvU3RyaW5nKCk7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgIG1lc3NhZ2U6ICdQcmVzaWduaW5nIG9ubHkgc3VwcG9ydHMgUzMgb3IgU2lnVjQgc2lnbmluZy4nLAogICAgICAgIGNvZGU6ICdVbnN1cHBvcnRlZFNpZ25lcicsIHJldHJ5YWJsZTogZmFsc2UKICAgICAgfSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHNpZ25lZFVybFNpZ25lcihyZXF1ZXN0KSB7CiAgICB2YXIgZW5kcG9pbnQgPSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50OwogICAgdmFyIHBhcnNlZFVybCA9IEFXUy51dGlsLnVybFBhcnNlKHJlcXVlc3QuaHR0cFJlcXVlc3QucGF0aCk7CiAgICB2YXIgcXVlcnlQYXJhbXMgPSB7fTsKICAKICAgIGlmIChwYXJzZWRVcmwuc2VhcmNoKSB7CiAgICAgIHF1ZXJ5UGFyYW1zID0gQVdTLnV0aWwucXVlcnlTdHJpbmdQYXJzZShwYXJzZWRVcmwuc2VhcmNoLnN1YnN0cigxKSk7CiAgICB9CiAgCiAgICB2YXIgYXV0aCA9IHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snQXV0aG9yaXphdGlvbiddLnNwbGl0KCcgJyk7CiAgICBpZiAoYXV0aFswXSA9PT0gJ0FXUycpIHsKICAgICAgYXV0aCA9IGF1dGhbMV0uc3BsaXQoJzonKTsKICAgICAgcXVlcnlQYXJhbXNbJ0FXU0FjY2Vzc0tleUlkJ10gPSBhdXRoWzBdOwogICAgICBxdWVyeVBhcmFtc1snU2lnbmF0dXJlJ10gPSBhdXRoWzFdOwogIAogICAgICBBV1MudXRpbC5lYWNoKHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICBpZiAoa2V5ID09PSBleHBpcmVzSGVhZGVyKSBrZXkgPSAnRXhwaXJlcyc7CiAgICAgICAgaWYgKGtleS5pbmRleE9mKCd4LWFtei1tZXRhLScpID09PSAwKSB7CiAgICAgICAgICAvLyBEZWxldGUgZXhpc3RpbmcsIHBvdGVudGlhbGx5IG5vdCBub3JtYWxpemVkIGtleQogICAgICAgICAgZGVsZXRlIHF1ZXJ5UGFyYW1zW2tleV07CiAgICAgICAgICBrZXkgPSBrZXkudG9Mb3dlckNhc2UoKTsKICAgICAgICB9CiAgICAgICAgcXVlcnlQYXJhbXNba2V5XSA9IHZhbHVlOwogICAgICB9KTsKICAgICAgZGVsZXRlIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXTsKICAgICAgZGVsZXRlIHF1ZXJ5UGFyYW1zWydBdXRob3JpemF0aW9uJ107CiAgICAgIGRlbGV0ZSBxdWVyeVBhcmFtc1snSG9zdCddOwogICAgfSBlbHNlIGlmIChhdXRoWzBdID09PSAnQVdTNC1ITUFDLVNIQTI1NicpIHsgLy8gU2lnVjQgc2lnbmluZwogICAgICBhdXRoLnNoaWZ0KCk7CiAgICAgIHZhciByZXN0ID0gYXV0aC5qb2luKCcgJyk7CiAgICAgIHZhciBzaWduYXR1cmUgPSByZXN0Lm1hdGNoKC9TaWduYXR1cmU9KC4qPykoPzosfFxzfFxyP1xufCQpLylbMV07CiAgICAgIHF1ZXJ5UGFyYW1zWydYLUFtei1TaWduYXR1cmUnXSA9IHNpZ25hdHVyZTsKICAgICAgZGVsZXRlIHF1ZXJ5UGFyYW1zWydFeHBpcmVzJ107CiAgICB9CiAgCiAgICAvLyBidWlsZCBVUkwKICAgIGVuZHBvaW50LnBhdGhuYW1lID0gcGFyc2VkVXJsLnBhdGhuYW1lOwogICAgZW5kcG9pbnQuc2VhcmNoID0gQVdTLnV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhxdWVyeVBhcmFtcyk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5TaWduZXJzLlByZXNpZ24gPSBpbmhlcml0KHsKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNpZ246IGZ1bmN0aW9uIHNpZ24ocmVxdWVzdCwgZXhwaXJlVGltZSwgY2FsbGJhY2spIHsKICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdID0gZXhwaXJlVGltZSB8fCAzNjAwOwogICAgICByZXF1ZXN0Lm9uKCdidWlsZCcsIHNpZ25lZFVybEJ1aWxkZXIpOwogICAgICByZXF1ZXN0Lm9uKCdzaWduJywgc2lnbmVkVXJsU2lnbmVyKTsKICAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcignYWZ0ZXJCdWlsZCcsCiAgICAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuU0VUX0NPTlRFTlRfTEVOR1RIKTsKICAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcignYWZ0ZXJCdWlsZCcsCiAgICAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuQ09NUFVURV9TSEEyNTYpOwogIAogICAgICByZXF1ZXN0LmVtaXQoJ2JlZm9yZVByZXNpZ24nLCBbcmVxdWVzdF0pOwogIAogICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICByZXF1ZXN0LmJ1aWxkKGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKHRoaXMucmVzcG9uc2UuZXJyb3IpIGNhbGxiYWNrKHRoaXMucmVzcG9uc2UuZXJyb3IpOwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIEFXUy51dGlsLnVybEZvcm1hdChyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50KSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVxdWVzdC5idWlsZCgpOwogICAgICAgIGlmIChyZXF1ZXN0LnJlc3BvbnNlLmVycm9yKSB0aHJvdyByZXF1ZXN0LnJlc3BvbnNlLmVycm9yOwogICAgICAgIHJldHVybiBBV1MudXRpbC51cmxGb3JtYXQocmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludCk7CiAgICAgIH0KICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlByZXNpZ247CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sNjM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgCiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIgPSBpbmhlcml0KHsKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBSZXF1ZXN0U2lnbmVyKHJlcXVlc3QpIHsKICAgICAgdGhpcy5yZXF1ZXN0ID0gcmVxdWVzdDsKICAgIH0sCiAgCiAgICBzZXRTZXJ2aWNlQ2xpZW50SWQ6IGZ1bmN0aW9uIHNldFNlcnZpY2VDbGllbnRJZChpZCkgewogICAgICB0aGlzLnNlcnZpY2VDbGllbnRJZCA9IGlkOwogICAgfSwKICAKICAgIGdldFNlcnZpY2VDbGllbnRJZDogZnVuY3Rpb24gZ2V0U2VydmljZUNsaWVudElkKCkgewogICAgICByZXR1cm4gdGhpcy5zZXJ2aWNlQ2xpZW50SWQ7CiAgICB9CiAgfSk7CiAgCiAgQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lci5nZXRWZXJzaW9uID0gZnVuY3Rpb24gZ2V0VmVyc2lvbih2ZXJzaW9uKSB7CiAgICBzd2l0Y2ggKHZlcnNpb24pIHsKICAgICAgY2FzZSAndjInOiByZXR1cm4gQVdTLlNpZ25lcnMuVjI7CiAgICAgIGNhc2UgJ3YzJzogcmV0dXJuIEFXUy5TaWduZXJzLlYzOwogICAgICBjYXNlICdzM3Y0JzogcmV0dXJuIEFXUy5TaWduZXJzLlY0OwogICAgICBjYXNlICd2NCc6IHJldHVybiBBV1MuU2lnbmVycy5WNDsKICAgICAgY2FzZSAnczMnOiByZXR1cm4gQVdTLlNpZ25lcnMuUzM7CiAgICAgIGNhc2UgJ3YzaHR0cHMnOiByZXR1cm4gQVdTLlNpZ25lcnMuVjNIdHRwczsKICAgIH0KICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBzaWduaW5nIHZlcnNpb24gJyArIHZlcnNpb24pOwogIH07CiAgCiAgcmVxdWlyZSgnLi92MicpOwogIHJlcXVpcmUoJy4vdjMnKTsKICByZXF1aXJlKCcuL3YzaHR0cHMnKTsKICByZXF1aXJlKCcuL3Y0Jyk7CiAgcmVxdWlyZSgnLi9zMycpOwogIHJlcXVpcmUoJy4vcHJlc2lnbicpOwogIAogIH0seyIuLi9jb3JlIjoxOCwiLi9wcmVzaWduIjo2MiwiLi9zMyI6NjQsIi4vdjIiOjY1LCIuL3YzIjo2NiwiLi92M2h0dHBzIjo2NywiLi92NCI6Njh9XSw2NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuUzMgPSBpbmhlcml0KEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIsIHsKICAgIC8qKgogICAgICogV2hlbiBidWlsZGluZyB0aGUgc3RyaW5nVG9TaWduLCB0aGVzZSBzdWIgcmVzb3VyY2UgcGFyYW1zIHNob3VsZCBiZQogICAgICogcGFydCBvZiB0aGUgY2Fub25pY2FsIHJlc291cmNlIHN0cmluZyB3aXRoIHRoZWlyIE5PTi1kZWNvZGVkIHZhbHVlcwogICAgICovCiAgICBzdWJSZXNvdXJjZXM6IHsKICAgICAgJ2FjbCc6IDEsCiAgICAgICdhY2NlbGVyYXRlJzogMSwKICAgICAgJ2FuYWx5dGljcyc6IDEsCiAgICAgICdjb3JzJzogMSwKICAgICAgJ2xpZmVjeWNsZSc6IDEsCiAgICAgICdkZWxldGUnOiAxLAogICAgICAnaW52ZW50b3J5JzogMSwKICAgICAgJ2xvY2F0aW9uJzogMSwKICAgICAgJ2xvZ2dpbmcnOiAxLAogICAgICAnbWV0cmljcyc6IDEsCiAgICAgICdub3RpZmljYXRpb24nOiAxLAogICAgICAncGFydE51bWJlcic6IDEsCiAgICAgICdwb2xpY3knOiAxLAogICAgICAncmVxdWVzdFBheW1lbnQnOiAxLAogICAgICAncmVwbGljYXRpb24nOiAxLAogICAgICAncmVzdG9yZSc6IDEsCiAgICAgICd0YWdnaW5nJzogMSwKICAgICAgJ3RvcnJlbnQnOiAxLAogICAgICAndXBsb2FkSWQnOiAxLAogICAgICAndXBsb2Fkcyc6IDEsCiAgICAgICd2ZXJzaW9uSWQnOiAxLAogICAgICAndmVyc2lvbmluZyc6IDEsCiAgICAgICd2ZXJzaW9ucyc6IDEsCiAgICAgICd3ZWJzaXRlJzogMQogICAgfSwKICAKICAgIC8vIHdoZW4gYnVpbGRpbmcgdGhlIHN0cmluZ1RvU2lnbiwgdGhlc2UgcXVlcnlzdHJpbmcgcGFyYW1zIHNob3VsZCBiZQogICAgLy8gcGFydCBvZiB0aGUgY2Fub25pY2FsIHJlc291cmNlIHN0cmluZyB3aXRoIHRoZWlyIE5PTi1lbmNvZGVkIHZhbHVlcwogICAgcmVzcG9uc2VIZWFkZXJzOiB7CiAgICAgICdyZXNwb25zZS1jb250ZW50LXR5cGUnOiAxLAogICAgICAncmVzcG9uc2UtY29udGVudC1sYW5ndWFnZSc6IDEsCiAgICAgICdyZXNwb25zZS1leHBpcmVzJzogMSwKICAgICAgJ3Jlc3BvbnNlLWNhY2hlLWNvbnRyb2wnOiAxLAogICAgICAncmVzcG9uc2UtY29udGVudC1kaXNwb3NpdGlvbic6IDEsCiAgICAgICdyZXNwb25zZS1jb250ZW50LWVuY29kaW5nJzogMQogICAgfSwKICAKICAgIGFkZEF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGFkZEF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGUpIHsKICAgICAgaWYgKCF0aGlzLnJlcXVlc3QuaGVhZGVyc1sncHJlc2lnbmVkLWV4cGlyZXMnXSkgewogICAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydYLUFtei1EYXRlJ10gPSBBV1MudXRpbC5kYXRlLnJmYzgyMihkYXRlKTsKICAgICAgfQogIAogICAgICBpZiAoY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuKSB7CiAgICAgICAgLy8gcHJlc2lnbmVkIFVSTHMgcmVxdWlyZSB0aGlzIGhlYWRlciB0byBiZSBsb3dlcmNhc2VkCiAgICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LXNlY3VyaXR5LXRva2VuJ10gPSBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW47CiAgICAgIH0KICAKICAgICAgdmFyIHNpZ25hdHVyZSA9IHRoaXMuc2lnbihjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXksIHRoaXMuc3RyaW5nVG9TaWduKCkpOwogICAgICB2YXIgYXV0aCA9ICdBV1MgJyArIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJzonICsgc2lnbmF0dXJlOwogIAogICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQXV0aG9yaXphdGlvbiddID0gYXV0aDsKICAgIH0sCiAgCiAgICBzdHJpbmdUb1NpZ246IGZ1bmN0aW9uIHN0cmluZ1RvU2lnbigpIHsKICAgICAgdmFyIHIgPSB0aGlzLnJlcXVlc3Q7CiAgCiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICBwYXJ0cy5wdXNoKHIubWV0aG9kKTsKICAgICAgcGFydHMucHVzaChyLmhlYWRlcnNbJ0NvbnRlbnQtTUQ1J10gfHwgJycpOwogICAgICBwYXJ0cy5wdXNoKHIuaGVhZGVyc1snQ29udGVudC1UeXBlJ10gfHwgJycpOwogIAogICAgICAvLyBUaGlzIGlzIHRoZSAiRGF0ZSIgaGVhZGVyLCBidXQgd2UgdXNlIFgtQW16LURhdGUuCiAgICAgIC8vIFRoZSBTMyBzaWduaW5nIG1lY2hhbmlzbSByZXF1aXJlcyB1cyB0byBwYXNzIGFuIGVtcHR5CiAgICAgIC8vIHN0cmluZyBmb3IgdGhpcyBEYXRlIGhlYWRlciByZWdhcmRsZXNzLgogICAgICBwYXJ0cy5wdXNoKHIuaGVhZGVyc1sncHJlc2lnbmVkLWV4cGlyZXMnXSB8fCAnJyk7CiAgCiAgICAgIHZhciBoZWFkZXJzID0gdGhpcy5jYW5vbmljYWxpemVkQW16SGVhZGVycygpOwogICAgICBpZiAoaGVhZGVycykgcGFydHMucHVzaChoZWFkZXJzKTsKICAgICAgcGFydHMucHVzaCh0aGlzLmNhbm9uaWNhbGl6ZWRSZXNvdXJjZSgpKTsKICAKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CiAgCiAgICB9LAogIAogICAgY2Fub25pY2FsaXplZEFtekhlYWRlcnM6IGZ1bmN0aW9uIGNhbm9uaWNhbGl6ZWRBbXpIZWFkZXJzKCkgewogIAogICAgICB2YXIgYW16SGVhZGVycyA9IFtdOwogIAogICAgICBBV1MudXRpbC5lYWNoKHRoaXMucmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIGlmIChuYW1lLm1hdGNoKC9eeC1hbXotL2kpKQogICAgICAgICAgYW16SGVhZGVycy5wdXNoKG5hbWUpOwogICAgICB9KTsKICAKICAgICAgYW16SGVhZGVycy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgcmV0dXJuIGEudG9Mb3dlckNhc2UoKSA8IGIudG9Mb3dlckNhc2UoKSA/IC0xIDogMTsKICAgICAgfSk7CiAgCiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICBBV1MudXRpbC5hcnJheUVhY2guY2FsbCh0aGlzLCBhbXpIZWFkZXJzLCBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHBhcnRzLnB1c2gobmFtZS50b0xvd2VyQ2FzZSgpICsgJzonICsgU3RyaW5nKHRoaXMucmVxdWVzdC5oZWFkZXJzW25hbWVdKSk7CiAgICAgIH0pOwogIAogICAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKICAKICAgIH0sCiAgCiAgICBjYW5vbmljYWxpemVkUmVzb3VyY2U6IGZ1bmN0aW9uIGNhbm9uaWNhbGl6ZWRSZXNvdXJjZSgpIHsKICAKICAgICAgdmFyIHIgPSB0aGlzLnJlcXVlc3Q7CiAgCiAgICAgIHZhciBwYXJ0cyA9IHIucGF0aC5zcGxpdCgnPycpOwogICAgICB2YXIgcGF0aCA9IHBhcnRzWzBdOwogICAgICB2YXIgcXVlcnlzdHJpbmcgPSBwYXJ0c1sxXTsKICAKICAgICAgdmFyIHJlc291cmNlID0gJyc7CiAgCiAgICAgIGlmIChyLnZpcnR1YWxIb3N0ZWRCdWNrZXQpCiAgICAgICAgcmVzb3VyY2UgKz0gJy8nICsgci52aXJ0dWFsSG9zdGVkQnVja2V0OwogIAogICAgICByZXNvdXJjZSArPSBwYXRoOwogIAogICAgICBpZiAocXVlcnlzdHJpbmcpIHsKICAKICAgICAgICAvLyBjb2xsZWN0IGEgbGlzdCBvZiBzdWIgcmVzb3VyY2VzIGFuZCBxdWVyeSBwYXJhbXMgdGhhdCBuZWVkIHRvIGJlIHNpZ25lZAogICAgICAgIHZhciByZXNvdXJjZXMgPSBbXTsKICAKICAgICAgICBBV1MudXRpbC5hcnJheUVhY2guY2FsbCh0aGlzLCBxdWVyeXN0cmluZy5zcGxpdCgnJicpLCBmdW5jdGlvbiAocGFyYW0pIHsKICAgICAgICAgIHZhciBuYW1lID0gcGFyYW0uc3BsaXQoJz0nKVswXTsKICAgICAgICAgIHZhciB2YWx1ZSA9IHBhcmFtLnNwbGl0KCc9JylbMV07CiAgICAgICAgICBpZiAodGhpcy5zdWJSZXNvdXJjZXNbbmFtZV0gfHwgdGhpcy5yZXNwb25zZUhlYWRlcnNbbmFtZV0pIHsKICAgICAgICAgICAgdmFyIHN1YnJlc291cmNlID0geyBuYW1lOiBuYW1lIH07CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMuc3ViUmVzb3VyY2VzW25hbWVdKSB7CiAgICAgICAgICAgICAgICBzdWJyZXNvdXJjZS52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdWJyZXNvdXJjZS52YWx1ZSA9IGRlY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc291cmNlcy5wdXNoKHN1YnJlc291cmNlKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAKICAgICAgICByZXNvdXJjZXMuc29ydChmdW5jdGlvbiAoYSwgYikgeyByZXR1cm4gYS5uYW1lIDwgYi5uYW1lID8gLTEgOiAxOyB9KTsKICAKICAgICAgICBpZiAocmVzb3VyY2VzLmxlbmd0aCkgewogIAogICAgICAgICAgcXVlcnlzdHJpbmcgPSBbXTsKICAgICAgICAgIEFXUy51dGlsLmFycmF5RWFjaChyZXNvdXJjZXMsIGZ1bmN0aW9uIChyZXMpIHsKICAgICAgICAgICAgaWYgKHJlcy52YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgcXVlcnlzdHJpbmcucHVzaChyZXMubmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcXVlcnlzdHJpbmcucHVzaChyZXMubmFtZSArICc9JyArIHJlcy52YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogIAogICAgICAgICAgcmVzb3VyY2UgKz0gJz8nICsgcXVlcnlzdHJpbmcuam9pbignJicpOwogICAgICAgIH0KICAKICAgICAgfQogIAogICAgICByZXR1cm4gcmVzb3VyY2U7CiAgCiAgICB9LAogIAogICAgc2lnbjogZnVuY3Rpb24gc2lnbihzZWNyZXQsIHN0cmluZykgewogICAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLmhtYWMoc2VjcmV0LCBzdHJpbmcsICdiYXNlNjQnLCAnc2hhMScpOwogICAgfQogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuUzM7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sNjU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5TaWduZXJzLlYyID0gaW5oZXJpdChBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLCB7CiAgICBhZGRBdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhZGRBdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRlKSB7CiAgCiAgICAgIGlmICghZGF0ZSkgZGF0ZSA9IEFXUy51dGlsLmRhdGUuZ2V0RGF0ZSgpOwogIAogICAgICB2YXIgciA9IHRoaXMucmVxdWVzdDsKICAKICAgICAgci5wYXJhbXMuVGltZXN0YW1wID0gQVdTLnV0aWwuZGF0ZS5pc284NjAxKGRhdGUpOwogICAgICByLnBhcmFtcy5TaWduYXR1cmVWZXJzaW9uID0gJzInOwogICAgICByLnBhcmFtcy5TaWduYXR1cmVNZXRob2QgPSAnSG1hY1NIQTI1Nic7CiAgICAgIHIucGFyYW1zLkFXU0FjY2Vzc0tleUlkID0gY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQ7CiAgCiAgICAgIGlmIChjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4pIHsKICAgICAgICByLnBhcmFtcy5TZWN1cml0eVRva2VuID0gY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuOwogICAgICB9CiAgCiAgICAgIGRlbGV0ZSByLnBhcmFtcy5TaWduYXR1cmU7IC8vIGRlbGV0ZSBvbGQgU2lnbmF0dXJlIGZvciByZS1zaWduaW5nCiAgICAgIHIucGFyYW1zLlNpZ25hdHVyZSA9IHRoaXMuc2lnbmF0dXJlKGNyZWRlbnRpYWxzKTsKICAKICAgICAgci5ib2R5ID0gQVdTLnV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhyLnBhcmFtcyk7CiAgICAgIHIuaGVhZGVyc1snQ29udGVudC1MZW5ndGgnXSA9IHIuYm9keS5sZW5ndGg7CiAgICB9LAogIAogICAgc2lnbmF0dXJlOiBmdW5jdGlvbiBzaWduYXR1cmUoY3JlZGVudGlhbHMpIHsKICAgICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5obWFjKGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSwgdGhpcy5zdHJpbmdUb1NpZ24oKSwgJ2Jhc2U2NCcpOwogICAgfSwKICAKICAgIHN0cmluZ1RvU2lnbjogZnVuY3Rpb24gc3RyaW5nVG9TaWduKCkgewogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3QubWV0aG9kKTsKICAgICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3QuZW5kcG9pbnQuaG9zdC50b0xvd2VyQ2FzZSgpKTsKICAgICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3QucGF0aG5hbWUoKSk7CiAgICAgIHBhcnRzLnB1c2goQVdTLnV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyh0aGlzLnJlcXVlc3QucGFyYW1zKSk7CiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogICAgfQogIAogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuVjI7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sNjY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5TaWduZXJzLlYzID0gaW5oZXJpdChBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLCB7CiAgICBhZGRBdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhZGRBdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRlKSB7CiAgCiAgICAgIHZhciBkYXRldGltZSA9IEFXUy51dGlsLmRhdGUucmZjODIyKGRhdGUpOwogIAogICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snWC1BbXotRGF0ZSddID0gZGF0ZXRpbWU7CiAgCiAgICAgIGlmIChjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4pIHsKICAgICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1sneC1hbXotc2VjdXJpdHktdG9rZW4nXSA9IGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbjsKICAgICAgfQogIAogICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snWC1BbXpuLUF1dGhvcml6YXRpb24nXSA9CiAgICAgICAgdGhpcy5hdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRldGltZSk7CiAgCiAgICB9LAogIAogICAgYXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYXV0aG9yaXphdGlvbihjcmVkZW50aWFscykgewogICAgICByZXR1cm4gJ0FXUzMgJyArCiAgICAgICAgJ0FXU0FjY2Vzc0tleUlkPScgKyBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCArICcsJyArCiAgICAgICAgJ0FsZ29yaXRobT1IbWFjU0hBMjU2LCcgKwogICAgICAgICdTaWduZWRIZWFkZXJzPScgKyB0aGlzLnNpZ25lZEhlYWRlcnMoKSArICcsJyArCiAgICAgICAgJ1NpZ25hdHVyZT0nICsgdGhpcy5zaWduYXR1cmUoY3JlZGVudGlhbHMpOwogICAgfSwKICAKICAgIHNpZ25lZEhlYWRlcnM6IGZ1bmN0aW9uIHNpZ25lZEhlYWRlcnMoKSB7CiAgICAgIHZhciBoZWFkZXJzID0gW107CiAgICAgIEFXUy51dGlsLmFycmF5RWFjaCh0aGlzLmhlYWRlcnNUb1NpZ24oKSwgZnVuY3Rpb24gaXRlcmF0b3IoaCkgewogICAgICAgIGhlYWRlcnMucHVzaChoLnRvTG93ZXJDYXNlKCkpOwogICAgICB9KTsKICAgICAgcmV0dXJuIGhlYWRlcnMuc29ydCgpLmpvaW4oJzsnKTsKICAgIH0sCiAgCiAgICBjYW5vbmljYWxIZWFkZXJzOiBmdW5jdGlvbiBjYW5vbmljYWxIZWFkZXJzKCkgewogICAgICB2YXIgaGVhZGVycyA9IHRoaXMucmVxdWVzdC5oZWFkZXJzOwogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHRoaXMuaGVhZGVyc1RvU2lnbigpLCBmdW5jdGlvbiBpdGVyYXRvcihoKSB7CiAgICAgICAgcGFydHMucHVzaChoLnRvTG93ZXJDYXNlKCkudHJpbSgpICsgJzonICsgU3RyaW5nKGhlYWRlcnNbaF0pLnRyaW0oKSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gcGFydHMuc29ydCgpLmpvaW4oJ1xuJykgKyAnXG4nOwogICAgfSwKICAKICAgIGhlYWRlcnNUb1NpZ246IGZ1bmN0aW9uIGhlYWRlcnNUb1NpZ24oKSB7CiAgICAgIHZhciBoZWFkZXJzID0gW107CiAgICAgIEFXUy51dGlsLmVhY2godGhpcy5yZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIGl0ZXJhdG9yKGspIHsKICAgICAgICBpZiAoayA9PT0gJ0hvc3QnIHx8IGsgPT09ICdDb250ZW50LUVuY29kaW5nJyB8fCBrLm1hdGNoKC9eWC1BbXovaSkpIHsKICAgICAgICAgIGhlYWRlcnMucHVzaChrKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gaGVhZGVyczsKICAgIH0sCiAgCiAgICBzaWduYXR1cmU6IGZ1bmN0aW9uIHNpZ25hdHVyZShjcmVkZW50aWFscykgewogICAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLmhtYWMoY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5LCB0aGlzLnN0cmluZ1RvU2lnbigpLCAnYmFzZTY0Jyk7CiAgICB9LAogIAogICAgc3RyaW5nVG9TaWduOiBmdW5jdGlvbiBzdHJpbmdUb1NpZ24oKSB7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5tZXRob2QpOwogICAgICBwYXJ0cy5wdXNoKCcvJyk7CiAgICAgIHBhcnRzLnB1c2goJycpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMuY2Fub25pY2FsSGVhZGVycygpKTsKICAgICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3QuYm9keSk7CiAgICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uc2hhMjU2KHBhcnRzLmpvaW4oJ1xuJykpOwogICAgfQogIAogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuVjM7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sNjc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIAogIHJlcXVpcmUoJy4vdjMnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuU2lnbmVycy5WM0h0dHBzID0gaW5oZXJpdChBV1MuU2lnbmVycy5WMywgewogICAgYXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYXV0aG9yaXphdGlvbihjcmVkZW50aWFscykgewogICAgICByZXR1cm4gJ0FXUzMtSFRUUFMgJyArCiAgICAgICAgJ0FXU0FjY2Vzc0tleUlkPScgKyBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCArICcsJyArCiAgICAgICAgJ0FsZ29yaXRobT1IbWFjU0hBMjU2LCcgKwogICAgICAgICdTaWduYXR1cmU9JyArIHRoaXMuc2lnbmF0dXJlKGNyZWRlbnRpYWxzKTsKICAgIH0sCiAgCiAgICBzdHJpbmdUb1NpZ246IGZ1bmN0aW9uIHN0cmluZ1RvU2lnbigpIHsKICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdC5oZWFkZXJzWydYLUFtei1EYXRlJ107CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5WM0h0dHBzOwogIAogIH0seyIuLi9jb3JlIjoxOCwiLi92MyI6NjZ9XSw2ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgdjRDcmVkZW50aWFscyA9IHJlcXVpcmUoJy4vdjRfY3JlZGVudGlhbHMnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIGV4cGlyZXNIZWFkZXIgPSAncHJlc2lnbmVkLWV4cGlyZXMnOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5TaWduZXJzLlY0ID0gaW5oZXJpdChBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLCB7CiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gVjQocmVxdWVzdCwgc2VydmljZU5hbWUsIG9wdGlvbnMpIHsKICAgICAgQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lci5jYWxsKHRoaXMsIHJlcXVlc3QpOwogICAgICB0aGlzLnNlcnZpY2VOYW1lID0gc2VydmljZU5hbWU7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB0aGlzLnNpZ25hdHVyZUNhY2hlID0gdHlwZW9mIG9wdGlvbnMuc2lnbmF0dXJlQ2FjaGUgPT09ICdib29sZWFuJyA/IG9wdGlvbnMuc2lnbmF0dXJlQ2FjaGUgOiB0cnVlOwogICAgICB0aGlzLm9wZXJhdGlvbiA9IG9wdGlvbnMub3BlcmF0aW9uOwogICAgICB0aGlzLnNpZ25hdHVyZVZlcnNpb24gPSBvcHRpb25zLnNpZ25hdHVyZVZlcnNpb247CiAgICB9LAogIAogICAgYWxnb3JpdGhtOiAnQVdTNC1ITUFDLVNIQTI1NicsCiAgCiAgICBhZGRBdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhZGRBdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRlKSB7CiAgICAgIHZhciBkYXRldGltZSA9IEFXUy51dGlsLmRhdGUuaXNvODYwMShkYXRlKS5yZXBsYWNlKC9bOlwtXXxcLlxkezN9L2csICcnKTsKICAKICAgICAgaWYgKHRoaXMuaXNQcmVzaWduZWQoKSkgewogICAgICAgIHRoaXMudXBkYXRlRm9yUHJlc2lnbmVkKGNyZWRlbnRpYWxzLCBkYXRldGltZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5hZGRIZWFkZXJzKGNyZWRlbnRpYWxzLCBkYXRldGltZSk7CiAgICAgIH0KICAKICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXSA9CiAgICAgICAgdGhpcy5hdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRldGltZSk7CiAgICB9LAogIAogICAgYWRkSGVhZGVyczogZnVuY3Rpb24gYWRkSGVhZGVycyhjcmVkZW50aWFscywgZGF0ZXRpbWUpIHsKICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXSA9IGRhdGV0aW1lOwogICAgICBpZiAoY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuKSB7CiAgICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LXNlY3VyaXR5LXRva2VuJ10gPSBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW47CiAgICAgIH0KICAgIH0sCiAgCiAgICB1cGRhdGVGb3JQcmVzaWduZWQ6IGZ1bmN0aW9uIHVwZGF0ZUZvclByZXNpZ25lZChjcmVkZW50aWFscywgZGF0ZXRpbWUpIHsKICAgICAgdmFyIGNyZWRTdHJpbmcgPSB0aGlzLmNyZWRlbnRpYWxTdHJpbmcoZGF0ZXRpbWUpOwogICAgICB2YXIgcXMgPSB7CiAgICAgICAgJ1gtQW16LURhdGUnOiBkYXRldGltZSwKICAgICAgICAnWC1BbXotQWxnb3JpdGhtJzogdGhpcy5hbGdvcml0aG0sCiAgICAgICAgJ1gtQW16LUNyZWRlbnRpYWwnOiBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCArICcvJyArIGNyZWRTdHJpbmcsCiAgICAgICAgJ1gtQW16LUV4cGlyZXMnOiB0aGlzLnJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXSwKICAgICAgICAnWC1BbXotU2lnbmVkSGVhZGVycyc6IHRoaXMuc2lnbmVkSGVhZGVycygpCiAgICAgIH07CiAgCiAgICAgIGlmIChjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4pIHsKICAgICAgICBxc1snWC1BbXotU2VjdXJpdHktVG9rZW4nXSA9IGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbjsKICAgICAgfQogIAogICAgICBpZiAodGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddKSB7CiAgICAgICAgcXNbJ0NvbnRlbnQtVHlwZSddID0gdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddOwogICAgICB9CiAgICAgIGlmICh0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1NRDUnXSkgewogICAgICAgIHFzWydDb250ZW50LU1ENSddID0gdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtTUQ1J107CiAgICAgIH0KICAgICAgaWYgKHRoaXMucmVxdWVzdC5oZWFkZXJzWydDYWNoZS1Db250cm9sJ10pIHsKICAgICAgICBxc1snQ2FjaGUtQ29udHJvbCddID0gdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NhY2hlLUNvbnRyb2wnXTsKICAgICAgfQogIAogICAgICAvLyBuZWVkIHRvIHB1bGwgaW4gYW55IG90aGVyIFgtQW16LSogaGVhZGVycwogICAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgdGhpcy5yZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICBpZiAoa2V5ID09PSBleHBpcmVzSGVhZGVyKSByZXR1cm47CiAgICAgICAgaWYgKHRoaXMuaXNTaWduYWJsZUhlYWRlcihrZXkpKSB7CiAgICAgICAgICB2YXIgbG93ZXJLZXkgPSBrZXkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIC8vIE1ldGFkYXRhIHNob3VsZCBiZSBub3JtYWxpemVkCiAgICAgICAgICBpZiAobG93ZXJLZXkuaW5kZXhPZigneC1hbXotbWV0YS0nKSA9PT0gMCkgewogICAgICAgICAgICBxc1tsb3dlcktleV0gPSB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAobG93ZXJLZXkuaW5kZXhPZigneC1hbXotJykgPT09IDApIHsKICAgICAgICAgICAgcXNba2V5XSA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIHZhciBzZXAgPSB0aGlzLnJlcXVlc3QucGF0aC5pbmRleE9mKCc/JykgPj0gMCA/ICcmJyA6ICc/JzsKICAgICAgdGhpcy5yZXF1ZXN0LnBhdGggKz0gc2VwICsgQVdTLnV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhxcyk7CiAgICB9LAogIAogICAgYXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZXRpbWUpIHsKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIHZhciBjcmVkU3RyaW5nID0gdGhpcy5jcmVkZW50aWFsU3RyaW5nKGRhdGV0aW1lKTsKICAgICAgcGFydHMucHVzaCh0aGlzLmFsZ29yaXRobSArICcgQ3JlZGVudGlhbD0nICsKICAgICAgICBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCArICcvJyArIGNyZWRTdHJpbmcpOwogICAgICBwYXJ0cy5wdXNoKCdTaWduZWRIZWFkZXJzPScgKyB0aGlzLnNpZ25lZEhlYWRlcnMoKSk7CiAgICAgIHBhcnRzLnB1c2goJ1NpZ25hdHVyZT0nICsgdGhpcy5zaWduYXR1cmUoY3JlZGVudGlhbHMsIGRhdGV0aW1lKSk7CiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCcsICcpOwogICAgfSwKICAKICAgIHNpZ25hdHVyZTogZnVuY3Rpb24gc2lnbmF0dXJlKGNyZWRlbnRpYWxzLCBkYXRldGltZSkgewogICAgICB2YXIgc2lnbmluZ0tleSA9IHY0Q3JlZGVudGlhbHMuZ2V0U2lnbmluZ0tleSgKICAgICAgICBjcmVkZW50aWFscywKICAgICAgICBkYXRldGltZS5zdWJzdHIoMCwgOCksCiAgICAgICAgdGhpcy5yZXF1ZXN0LnJlZ2lvbiwKICAgICAgICB0aGlzLnNlcnZpY2VOYW1lLAogICAgICAgIHRoaXMuc2lnbmF0dXJlQ2FjaGUKICAgICAgKTsKICAgICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5obWFjKHNpZ25pbmdLZXksIHRoaXMuc3RyaW5nVG9TaWduKGRhdGV0aW1lKSwgJ2hleCcpOwogICAgfSwKICAKICAgIHN0cmluZ1RvU2lnbjogZnVuY3Rpb24gc3RyaW5nVG9TaWduKGRhdGV0aW1lKSB7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICBwYXJ0cy5wdXNoKCdBV1M0LUhNQUMtU0hBMjU2Jyk7CiAgICAgIHBhcnRzLnB1c2goZGF0ZXRpbWUpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMuY3JlZGVudGlhbFN0cmluZyhkYXRldGltZSkpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMuaGV4RW5jb2RlZEhhc2godGhpcy5jYW5vbmljYWxTdHJpbmcoKSkpOwogICAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKICAgIH0sCiAgCiAgICBjYW5vbmljYWxTdHJpbmc6IGZ1bmN0aW9uIGNhbm9uaWNhbFN0cmluZygpIHsKICAgICAgdmFyIHBhcnRzID0gW10sIHBhdGhuYW1lID0gdGhpcy5yZXF1ZXN0LnBhdGhuYW1lKCk7CiAgICAgIGlmICh0aGlzLnNlcnZpY2VOYW1lICE9PSAnczMnICYmIHRoaXMuc2lnbmF0dXJlVmVyc2lvbiAhPT0gJ3MzdjQnKSBwYXRobmFtZSA9IEFXUy51dGlsLnVyaUVzY2FwZVBhdGgocGF0aG5hbWUpOwogIAogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5tZXRob2QpOwogICAgICBwYXJ0cy5wdXNoKHBhdGhuYW1lKTsKICAgICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3Quc2VhcmNoKCkpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMuY2Fub25pY2FsSGVhZGVycygpICsgJ1xuJyk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5zaWduZWRIZWFkZXJzKCkpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMuaGV4RW5jb2RlZEJvZHlIYXNoKCkpOwogICAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKICAgIH0sCiAgCiAgICBjYW5vbmljYWxIZWFkZXJzOiBmdW5jdGlvbiBjYW5vbmljYWxIZWFkZXJzKCkgewogICAgICB2YXIgaGVhZGVycyA9IFtdOwogICAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgdGhpcy5yZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIChrZXksIGl0ZW0pIHsKICAgICAgICBoZWFkZXJzLnB1c2goW2tleSwgaXRlbV0pOwogICAgICB9KTsKICAgICAgaGVhZGVycy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgcmV0dXJuIGFbMF0udG9Mb3dlckNhc2UoKSA8IGJbMF0udG9Mb3dlckNhc2UoKSA/IC0xIDogMTsKICAgICAgfSk7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICBBV1MudXRpbC5hcnJheUVhY2guY2FsbCh0aGlzLCBoZWFkZXJzLCBmdW5jdGlvbiAoaXRlbSkgewogICAgICAgIHZhciBrZXkgPSBpdGVtWzBdLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgaWYgKHRoaXMuaXNTaWduYWJsZUhlYWRlcihrZXkpKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSBpdGVtWzFdOwogICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgdmFsdWUgPT09IG51bGwgfHwgdHlwZW9mIHZhbHVlLnRvU3RyaW5nICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcignSGVhZGVyICcgKyBrZXkgKyAnIGNvbnRhaW5zIGludmFsaWQgdmFsdWUnKSwgewogICAgICAgICAgICAgIGNvZGU6ICdJbnZhbGlkSGVhZGVyJwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHBhcnRzLnB1c2goa2V5ICsgJzonICsKICAgICAgICAgICAgdGhpcy5jYW5vbmljYWxIZWFkZXJWYWx1ZXModmFsdWUudG9TdHJpbmcoKSkpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogICAgfSwKICAKICAgIGNhbm9uaWNhbEhlYWRlclZhbHVlczogZnVuY3Rpb24gY2Fub25pY2FsSGVhZGVyVmFsdWVzKHZhbHVlcykgewogICAgICByZXR1cm4gdmFsdWVzLnJlcGxhY2UoL1xzKy9nLCAnICcpLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJyk7CiAgICB9LAogIAogICAgc2lnbmVkSGVhZGVyczogZnVuY3Rpb24gc2lnbmVkSGVhZGVycygpIHsKICAgICAgdmFyIGtleXMgPSBbXTsKICAgICAgQVdTLnV0aWwuZWFjaC5jYWxsKHRoaXMsIHRoaXMucmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAga2V5ID0ga2V5LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgaWYgKHRoaXMuaXNTaWduYWJsZUhlYWRlcihrZXkpKSBrZXlzLnB1c2goa2V5KTsKICAgICAgfSk7CiAgICAgIHJldHVybiBrZXlzLnNvcnQoKS5qb2luKCc7Jyk7CiAgICB9LAogIAogICAgY3JlZGVudGlhbFN0cmluZzogZnVuY3Rpb24gY3JlZGVudGlhbFN0cmluZyhkYXRldGltZSkgewogICAgICByZXR1cm4gdjRDcmVkZW50aWFscy5jcmVhdGVTY29wZSgKICAgICAgICBkYXRldGltZS5zdWJzdHIoMCwgOCksCiAgICAgICAgdGhpcy5yZXF1ZXN0LnJlZ2lvbiwKICAgICAgICB0aGlzLnNlcnZpY2VOYW1lCiAgICAgICk7CiAgICB9LAogIAogICAgaGV4RW5jb2RlZEhhc2g6IGZ1bmN0aW9uIGhhc2goc3RyaW5nKSB7CiAgICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uc2hhMjU2KHN0cmluZywgJ2hleCcpOwogICAgfSwKICAKICAgIGhleEVuY29kZWRCb2R5SGFzaDogZnVuY3Rpb24gaGV4RW5jb2RlZEJvZHlIYXNoKCkgewogICAgICB2YXIgcmVxdWVzdCA9IHRoaXMucmVxdWVzdDsKICAgICAgaWYgKHRoaXMuaXNQcmVzaWduZWQoKSAmJiB0aGlzLnNlcnZpY2VOYW1lID09PSAnczMnICYmICFyZXF1ZXN0LmJvZHkpIHsKICAgICAgICByZXR1cm4gJ1VOU0lHTkVELVBBWUxPQUQnOwogICAgICB9IGVsc2UgaWYgKHJlcXVlc3QuaGVhZGVyc1snWC1BbXotQ29udGVudC1TaGEyNTYnXSkgewogICAgICAgIHJldHVybiByZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LUNvbnRlbnQtU2hhMjU2J107CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaGV4RW5jb2RlZEhhc2godGhpcy5yZXF1ZXN0LmJvZHkgfHwgJycpOwogICAgICB9CiAgICB9LAogIAogICAgdW5zaWduYWJsZUhlYWRlcnM6IFsKICAgICAgJ2F1dGhvcml6YXRpb24nLAogICAgICAnY29udGVudC10eXBlJywKICAgICAgJ2NvbnRlbnQtbGVuZ3RoJywKICAgICAgJ3VzZXItYWdlbnQnLAogICAgICBleHBpcmVzSGVhZGVyLAogICAgICAnZXhwZWN0JywKICAgICAgJ3gtYW16bi10cmFjZS1pZCcKICAgIF0sCiAgCiAgICBpc1NpZ25hYmxlSGVhZGVyOiBmdW5jdGlvbiBpc1NpZ25hYmxlSGVhZGVyKGtleSkgewogICAgICBpZiAoa2V5LnRvTG93ZXJDYXNlKCkuaW5kZXhPZigneC1hbXotJykgPT09IDApIHJldHVybiB0cnVlOwogICAgICByZXR1cm4gdGhpcy51bnNpZ25hYmxlSGVhZGVycy5pbmRleE9mKGtleSkgPCAwOwogICAgfSwKICAKICAgIGlzUHJlc2lnbmVkOiBmdW5jdGlvbiBpc1ByZXNpZ25lZCgpIHsKICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdID8gdHJ1ZSA6IGZhbHNlOwogICAgfQogIAogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuVjQ7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuL3Y0X2NyZWRlbnRpYWxzIjo2OX1dLDY5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciBjYWNoZWRTZWNyZXQgPSB7fTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgY2FjaGVRdWV1ZSA9IFtdOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciBtYXhDYWNoZUVudHJpZXMgPSA1MDsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgdjRJZGVudGlmaWVyID0gJ2F3czRfcmVxdWVzdCc7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICoKICAgICAqIEBwYXJhbSBkYXRlIFtTdHJpbmddCiAgICAgKiBAcGFyYW0gcmVnaW9uIFtTdHJpbmddCiAgICAgKiBAcGFyYW0gc2VydmljZU5hbWUgW1N0cmluZ10KICAgICAqIEByZXR1cm4gW1N0cmluZ10KICAgICAqLwogICAgY3JlYXRlU2NvcGU6IGZ1bmN0aW9uIGNyZWF0ZVNjb3BlKGRhdGUsIHJlZ2lvbiwgc2VydmljZU5hbWUpIHsKICAgICAgcmV0dXJuIFsKICAgICAgICBkYXRlLnN1YnN0cigwLCA4KSwKICAgICAgICByZWdpb24sCiAgICAgICAgc2VydmljZU5hbWUsCiAgICAgICAgdjRJZGVudGlmaWVyCiAgICAgIF0uam9pbignLycpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKgogICAgICogQHBhcmFtIGNyZWRlbnRpYWxzIFtDcmVkZW50aWFsc10KICAgICAqIEBwYXJhbSBkYXRlIFtTdHJpbmddCiAgICAgKiBAcGFyYW0gcmVnaW9uIFtTdHJpbmddCiAgICAgKiBAcGFyYW0gc2VydmljZSBbU3RyaW5nXQogICAgICogQHBhcmFtIHNob3VsZENhY2hlIFtCb29sZWFuXQogICAgICogQHJldHVybiBbU3RyaW5nXQogICAgICovCiAgICBnZXRTaWduaW5nS2V5OiBmdW5jdGlvbiBnZXRTaWduaW5nS2V5KAogICAgICBjcmVkZW50aWFscywKICAgICAgZGF0ZSwKICAgICAgcmVnaW9uLAogICAgICBzZXJ2aWNlLAogICAgICBzaG91bGRDYWNoZQogICAgKSB7CiAgICAgIHZhciBjcmVkc0lkZW50aWZpZXIgPSBBV1MudXRpbC5jcnlwdG8KICAgICAgICAuaG1hYyhjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXksIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkLCAnYmFzZTY0Jyk7CiAgICAgIHZhciBjYWNoZUtleSA9IFtjcmVkc0lkZW50aWZpZXIsIGRhdGUsIHJlZ2lvbiwgc2VydmljZV0uam9pbignXycpOwogICAgICBzaG91bGRDYWNoZSA9IHNob3VsZENhY2hlICE9PSBmYWxzZTsKICAgICAgaWYgKHNob3VsZENhY2hlICYmIChjYWNoZUtleSBpbiBjYWNoZWRTZWNyZXQpKSB7CiAgICAgICAgcmV0dXJuIGNhY2hlZFNlY3JldFtjYWNoZUtleV07CiAgICAgIH0KICAKICAgICAgdmFyIGtEYXRlID0gQVdTLnV0aWwuY3J5cHRvLmhtYWMoCiAgICAgICAgJ0FXUzQnICsgY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5LAogICAgICAgIGRhdGUsCiAgICAgICAgJ2J1ZmZlcicKICAgICAgKTsKICAgICAgdmFyIGtSZWdpb24gPSBBV1MudXRpbC5jcnlwdG8uaG1hYyhrRGF0ZSwgcmVnaW9uLCAnYnVmZmVyJyk7CiAgICAgIHZhciBrU2VydmljZSA9IEFXUy51dGlsLmNyeXB0by5obWFjKGtSZWdpb24sIHNlcnZpY2UsICdidWZmZXInKTsKICAKICAgICAgdmFyIHNpZ25pbmdLZXkgPSBBV1MudXRpbC5jcnlwdG8uaG1hYyhrU2VydmljZSwgdjRJZGVudGlmaWVyLCAnYnVmZmVyJyk7CiAgICAgIGlmIChzaG91bGRDYWNoZSkgewogICAgICAgIGNhY2hlZFNlY3JldFtjYWNoZUtleV0gPSBzaWduaW5nS2V5OwogICAgICAgIGNhY2hlUXVldWUucHVzaChjYWNoZUtleSk7CiAgICAgICAgaWYgKGNhY2hlUXVldWUubGVuZ3RoID4gbWF4Q2FjaGVFbnRyaWVzKSB7CiAgICAgICAgICAvLyByZW1vdmUgdGhlIG9sZGVzdCBlbnRyeSAobm90IHRoZSBsZWFzdCByZWNlbnRseSB1c2VkKQogICAgICAgICAgZGVsZXRlIGNhY2hlZFNlY3JldFtjYWNoZVF1ZXVlLnNoaWZ0KCldOwogICAgICAgIH0KICAgICAgfQogIAogICAgICByZXR1cm4gc2lnbmluZ0tleTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICoKICAgICAqIEVtcHRpZXMgdGhlIGRlcml2ZWQgc2lnbmluZyBrZXkgY2FjaGUuIE1hZGUgYXZhaWxhYmxlIGZvciB0ZXN0aW5nIHB1cnBvc2VzCiAgICAgKiBvbmx5LgogICAgICovCiAgICBlbXB0eUNhY2hlOiBmdW5jdGlvbiBlbXB0eUNhY2hlKCkgewogICAgICBjYWNoZWRTZWNyZXQgPSB7fTsKICAgICAgY2FjaGVRdWV1ZSA9IFtdOwogICAgfQogIH07CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sNzA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIGZ1bmN0aW9uIEFjY2VwdG9yU3RhdGVNYWNoaW5lKHN0YXRlcywgc3RhdGUpIHsKICAgIHRoaXMuY3VycmVudFN0YXRlID0gc3RhdGUgfHwgbnVsbDsKICAgIHRoaXMuc3RhdGVzID0gc3RhdGVzIHx8IHt9OwogIH0KICAKICBBY2NlcHRvclN0YXRlTWFjaGluZS5wcm90b3R5cGUucnVuVG8gPSBmdW5jdGlvbiBydW5UbyhmaW5hbFN0YXRlLCBkb25lLCBiaW5kT2JqZWN0LCBpbnB1dEVycm9yKSB7CiAgICBpZiAodHlwZW9mIGZpbmFsU3RhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgaW5wdXRFcnJvciA9IGJpbmRPYmplY3Q7IGJpbmRPYmplY3QgPSBkb25lOwogICAgICBkb25lID0gZmluYWxTdGF0ZTsgZmluYWxTdGF0ZSA9IG51bGw7CiAgICB9CiAgCiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgc3RhdGUgPSBzZWxmLnN0YXRlc1tzZWxmLmN1cnJlbnRTdGF0ZV07CiAgICBzdGF0ZS5mbi5jYWxsKGJpbmRPYmplY3QgfHwgc2VsZiwgaW5wdXRFcnJvciwgZnVuY3Rpb24oZXJyKSB7CiAgICAgIGlmIChlcnIpIHsKICAgICAgICBpZiAoc3RhdGUuZmFpbCkgc2VsZi5jdXJyZW50U3RhdGUgPSBzdGF0ZS5mYWlsOwogICAgICAgIGVsc2UgcmV0dXJuIGRvbmUgPyBkb25lLmNhbGwoYmluZE9iamVjdCwgZXJyKSA6IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHN0YXRlLmFjY2VwdCkgc2VsZi5jdXJyZW50U3RhdGUgPSBzdGF0ZS5hY2NlcHQ7CiAgICAgICAgZWxzZSByZXR1cm4gZG9uZSA/IGRvbmUuY2FsbChiaW5kT2JqZWN0KSA6IG51bGw7CiAgICAgIH0KICAgICAgaWYgKHNlbGYuY3VycmVudFN0YXRlID09PSBmaW5hbFN0YXRlKSB7CiAgICAgICAgcmV0dXJuIGRvbmUgPyBkb25lLmNhbGwoYmluZE9iamVjdCwgZXJyKSA6IG51bGw7CiAgICAgIH0KICAKICAgICAgc2VsZi5ydW5UbyhmaW5hbFN0YXRlLCBkb25lLCBiaW5kT2JqZWN0LCBlcnIpOwogICAgfSk7CiAgfTsKICAKICBBY2NlcHRvclN0YXRlTWFjaGluZS5wcm90b3R5cGUuYWRkU3RhdGUgPSBmdW5jdGlvbiBhZGRTdGF0ZShuYW1lLCBhY2NlcHRTdGF0ZSwgZmFpbFN0YXRlLCBmbikgewogICAgaWYgKHR5cGVvZiBhY2NlcHRTdGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBmbiA9IGFjY2VwdFN0YXRlOyBhY2NlcHRTdGF0ZSA9IG51bGw7IGZhaWxTdGF0ZSA9IG51bGw7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBmYWlsU3RhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgZm4gPSBmYWlsU3RhdGU7IGZhaWxTdGF0ZSA9IG51bGw7CiAgICB9CiAgCiAgICBpZiAoIXRoaXMuY3VycmVudFN0YXRlKSB0aGlzLmN1cnJlbnRTdGF0ZSA9IG5hbWU7CiAgICB0aGlzLnN0YXRlc1tuYW1lXSA9IHsgYWNjZXB0OiBhY2NlcHRTdGF0ZSwgZmFpbDogZmFpbFN0YXRlLCBmbjogZm4gfTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBY2NlcHRvclN0YXRlTWFjaGluZTsKICAKICB9LHt9XSw3MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChwcm9jZXNzLHNldEltbWVkaWF0ZSl7CiAgLyogZXNsaW50IGd1YXJkLWZvci1pbjowICovCiAgdmFyIEFXUzsKICAKICAvKioKICAgKiBBIHNldCBvZiB1dGlsaXR5IG1ldGhvZHMgZm9yIHVzZSB3aXRoIHRoZSBBV1MgU0RLLgogICAqCiAgICogQCFhdHRyaWJ1dGUgYWJvcnQKICAgKiAgIFJldHVybiB0aGlzIHZhbHVlIGZyb20gYW4gaXRlcmF0b3IgZnVuY3Rpb24ge2VhY2h9IG9yIHthcnJheUVhY2h9CiAgICogICB0byBicmVhayBvdXQgb2YgdGhlIGl0ZXJhdGlvbi4KICAgKiAgIEBleGFtcGxlIEJyZWFraW5nIG91dCBvZiBhbiBpdGVyYXRvciBmdW5jdGlvbgogICAqICAgICBBV1MudXRpbC5lYWNoKHthOiAxLCBiOiAyLCBjOiAzfSwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAqICAgICAgIGlmIChrZXkgPT0gJ2InKSByZXR1cm4gQVdTLnV0aWwuYWJvcnQ7CiAgICogICAgIH0pOwogICAqICAgQHNlZSBlYWNoCiAgICogICBAc2VlIGFycmF5RWFjaAogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciB1dGlsID0gewogICAgZW52aXJvbm1lbnQ6ICdub2RlanMnLAogICAgZW5naW5lOiBmdW5jdGlvbiBlbmdpbmUoKSB7CiAgICAgIGlmICh1dGlsLmlzQnJvd3NlcigpICYmIHR5cGVvZiBuYXZpZ2F0b3IgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgcmV0dXJuIG5hdmlnYXRvci51c2VyQWdlbnQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGVuZ2luZSA9IHByb2Nlc3MucGxhdGZvcm0gKyAnLycgKyBwcm9jZXNzLnZlcnNpb247CiAgICAgICAgaWYgKHByb2Nlc3MuZW52LkFXU19FWEVDVVRJT05fRU5WKSB7CiAgICAgICAgICBlbmdpbmUgKz0gJyBleGVjLWVudi8nICsgcHJvY2Vzcy5lbnYuQVdTX0VYRUNVVElPTl9FTlY7CiAgICAgICAgfQogICAgICAgIHJldHVybiBlbmdpbmU7CiAgICAgIH0KICAgIH0sCiAgCiAgICB1c2VyQWdlbnQ6IGZ1bmN0aW9uIHVzZXJBZ2VudCgpIHsKICAgICAgdmFyIG5hbWUgPSB1dGlsLmVudmlyb25tZW50OwogICAgICB2YXIgYWdlbnQgPSAnYXdzLXNkay0nICsgbmFtZSArICcvJyArIHJlcXVpcmUoJy4vY29yZScpLlZFUlNJT047CiAgICAgIGlmIChuYW1lID09PSAnbm9kZWpzJykgYWdlbnQgKz0gJyAnICsgdXRpbC5lbmdpbmUoKTsKICAgICAgcmV0dXJuIGFnZW50OwogICAgfSwKICAKICAgIHVyaUVzY2FwZTogZnVuY3Rpb24gdXJpRXNjYXBlKHN0cmluZykgewogICAgICB2YXIgb3V0cHV0ID0gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZyk7CiAgICAgIG91dHB1dCA9IG91dHB1dC5yZXBsYWNlKC9bXkEtWmEtejAtOV8uflwtJV0rL2csIGVzY2FwZSk7CiAgCiAgICAgIC8vIEFXUyBwZXJjZW50LWVuY29kZXMgc29tZSBleHRyYSBub24tc3RhbmRhcmQgY2hhcmFjdGVycyBpbiBhIFVSSQogICAgICBvdXRwdXQgPSBvdXRwdXQucmVwbGFjZSgvWypdL2csIGZ1bmN0aW9uKGNoKSB7CiAgICAgICAgcmV0dXJuICclJyArIGNoLmNoYXJDb2RlQXQoMCkudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCk7CiAgICAgIH0pOwogIAogICAgICByZXR1cm4gb3V0cHV0OwogICAgfSwKICAKICAgIHVyaUVzY2FwZVBhdGg6IGZ1bmN0aW9uIHVyaUVzY2FwZVBhdGgoc3RyaW5nKSB7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICB1dGlsLmFycmF5RWFjaChzdHJpbmcuc3BsaXQoJy8nKSwgZnVuY3Rpb24gKHBhcnQpIHsKICAgICAgICBwYXJ0cy5wdXNoKHV0aWwudXJpRXNjYXBlKHBhcnQpKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCcvJyk7CiAgICB9LAogIAogICAgdXJsUGFyc2U6IGZ1bmN0aW9uIHVybFBhcnNlKHVybCkgewogICAgICByZXR1cm4gdXRpbC51cmwucGFyc2UodXJsKTsKICAgIH0sCiAgCiAgICB1cmxGb3JtYXQ6IGZ1bmN0aW9uIHVybEZvcm1hdCh1cmwpIHsKICAgICAgcmV0dXJuIHV0aWwudXJsLmZvcm1hdCh1cmwpOwogICAgfSwKICAKICAgIHF1ZXJ5U3RyaW5nUGFyc2U6IGZ1bmN0aW9uIHF1ZXJ5U3RyaW5nUGFyc2UocXMpIHsKICAgICAgcmV0dXJuIHV0aWwucXVlcnlzdHJpbmcucGFyc2UocXMpOwogICAgfSwKICAKICAgIHF1ZXJ5UGFyYW1zVG9TdHJpbmc6IGZ1bmN0aW9uIHF1ZXJ5UGFyYW1zVG9TdHJpbmcocGFyYW1zKSB7CiAgICAgIHZhciBpdGVtcyA9IFtdOwogICAgICB2YXIgZXNjYXBlID0gdXRpbC51cmlFc2NhcGU7CiAgICAgIHZhciBzb3J0ZWRLZXlzID0gT2JqZWN0LmtleXMocGFyYW1zKS5zb3J0KCk7CiAgCiAgICAgIHV0aWwuYXJyYXlFYWNoKHNvcnRlZEtleXMsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICB2YXIgdmFsdWUgPSBwYXJhbXNbbmFtZV07CiAgICAgICAgdmFyIGVuYW1lID0gZXNjYXBlKG5hbWUpOwogICAgICAgIHZhciByZXN1bHQgPSBlbmFtZSArICc9JzsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgIHZhciB2YWxzID0gW107CiAgICAgICAgICB1dGlsLmFycmF5RWFjaCh2YWx1ZSwgZnVuY3Rpb24oaXRlbSkgeyB2YWxzLnB1c2goZXNjYXBlKGl0ZW0pKTsgfSk7CiAgICAgICAgICByZXN1bHQgPSBlbmFtZSArICc9JyArIHZhbHMuc29ydCgpLmpvaW4oJyYnICsgZW5hbWUgKyAnPScpOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbCkgewogICAgICAgICAgcmVzdWx0ID0gZW5hbWUgKyAnPScgKyBlc2NhcGUodmFsdWUpOwogICAgICAgIH0KICAgICAgICBpdGVtcy5wdXNoKHJlc3VsdCk7CiAgICAgIH0pOwogIAogICAgICByZXR1cm4gaXRlbXMuam9pbignJicpOwogICAgfSwKICAKICAgIHJlYWRGaWxlU3luYzogZnVuY3Rpb24gcmVhZEZpbGVTeW5jKHBhdGgpIHsKICAgICAgaWYgKHV0aWwuaXNCcm93c2VyKCkpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gcmVxdWlyZSgnZnMnKS5yZWFkRmlsZVN5bmMocGF0aCwgJ3V0Zi04Jyk7CiAgICB9LAogIAogICAgYmFzZTY0OiB7CiAgICAgIGVuY29kZTogZnVuY3Rpb24gZW5jb2RlNjQoc3RyaW5nKSB7CiAgICAgICAgaWYgKHR5cGVvZiBzdHJpbmcgPT09ICdudW1iZXInKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignQ2Fubm90IGJhc2U2NCBlbmNvZGUgbnVtYmVyICcgKyBzdHJpbmcpKTsKICAgICAgICB9CiAgICAgICAgaWYgKHN0cmluZyA9PT0gbnVsbCB8fCB0eXBlb2Ygc3RyaW5nID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICB9CiAgICAgICAgdmFyIGJ1ZiA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyKHN0cmluZyk7CiAgICAgICAgcmV0dXJuIGJ1Zi50b1N0cmluZygnYmFzZTY0Jyk7CiAgICAgIH0sCiAgCiAgICAgIGRlY29kZTogZnVuY3Rpb24gZGVjb2RlNjQoc3RyaW5nKSB7CiAgICAgICAgaWYgKHR5cGVvZiBzdHJpbmcgPT09ICdudW1iZXInKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignQ2Fubm90IGJhc2U2NCBkZWNvZGUgbnVtYmVyICcgKyBzdHJpbmcpKTsKICAgICAgICB9CiAgICAgICAgaWYgKHN0cmluZyA9PT0gbnVsbCB8fCB0eXBlb2Ygc3RyaW5nID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHV0aWwuYnVmZmVyLnRvQnVmZmVyKHN0cmluZywgJ2Jhc2U2NCcpOwogICAgICB9CiAgCiAgICB9LAogIAogICAgYnVmZmVyOiB7CiAgICAgIC8qKgogICAgICAgKiBCdWZmZXIgY29uc3RydWN0b3IgZm9yIE5vZGUgYnVmZmVyIGFuZCBidWZmZXIgcG9sbHlmaWxsCiAgICAgICAqLwogICAgICB0b0J1ZmZlcjogZnVuY3Rpb24oZGF0YSwgZW5jb2RpbmcpIHsKICAgICAgICByZXR1cm4gKHR5cGVvZiB1dGlsLkJ1ZmZlci5mcm9tID09PSAnZnVuY3Rpb24nICYmIHV0aWwuQnVmZmVyLmZyb20gIT09IFVpbnQ4QXJyYXkuZnJvbSkgPwogICAgICAgICAgdXRpbC5CdWZmZXIuZnJvbShkYXRhLCBlbmNvZGluZykgOiBuZXcgdXRpbC5CdWZmZXIoZGF0YSwgZW5jb2RpbmcpOwogICAgICB9LAogIAogICAgICBhbGxvYzogZnVuY3Rpb24oc2l6ZSwgZmlsbCwgZW5jb2RpbmcpIHsKICAgICAgICBpZiAodHlwZW9mIHNpemUgIT09ICdudW1iZXInKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NpemUgcGFzc2VkIHRvIGFsbG9jIG11c3QgYmUgYSBudW1iZXIuJyk7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgdXRpbC5CdWZmZXIuYWxsb2MgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHJldHVybiB1dGlsLkJ1ZmZlci5hbGxvYyhzaXplLCBmaWxsLCBlbmNvZGluZyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBidWYgPSBuZXcgdXRpbC5CdWZmZXIoc2l6ZSk7CiAgICAgICAgICBpZiAoZmlsbCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBidWYuZmlsbCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBidWYuZmlsbChmaWxsLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgZW5jb2RpbmcpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGJ1ZjsKICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIHRvU3RyZWFtOiBmdW5jdGlvbiB0b1N0cmVhbShidWZmZXIpIHsKICAgICAgICBpZiAoIXV0aWwuQnVmZmVyLmlzQnVmZmVyKGJ1ZmZlcikpIGJ1ZmZlciA9ICB1dGlsLmJ1ZmZlci50b0J1ZmZlcihidWZmZXIpOwogIAogICAgICAgIHZhciByZWFkYWJsZSA9IG5ldyAodXRpbC5zdHJlYW0uUmVhZGFibGUpKCk7CiAgICAgICAgdmFyIHBvcyA9IDA7CiAgICAgICAgcmVhZGFibGUuX3JlYWQgPSBmdW5jdGlvbihzaXplKSB7CiAgICAgICAgICBpZiAocG9zID49IGJ1ZmZlci5sZW5ndGgpIHJldHVybiByZWFkYWJsZS5wdXNoKG51bGwpOwogIAogICAgICAgICAgdmFyIGVuZCA9IHBvcyArIHNpemU7CiAgICAgICAgICBpZiAoZW5kID4gYnVmZmVyLmxlbmd0aCkgZW5kID0gYnVmZmVyLmxlbmd0aDsKICAgICAgICAgIHJlYWRhYmxlLnB1c2goYnVmZmVyLnNsaWNlKHBvcywgZW5kKSk7CiAgICAgICAgICBwb3MgPSBlbmQ7CiAgICAgICAgfTsKICAKICAgICAgICByZXR1cm4gcmVhZGFibGU7CiAgICAgIH0sCiAgCiAgICAgIC8qKgogICAgICAgKiBDb25jYXRlbmF0ZXMgYSBsaXN0IG9mIEJ1ZmZlciBvYmplY3RzLgogICAgICAgKi8KICAgICAgY29uY2F0OiBmdW5jdGlvbihidWZmZXJzKSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IDAsCiAgICAgICAgICAgIG9mZnNldCA9IDAsCiAgICAgICAgICAgIGJ1ZmZlciA9IG51bGwsIGk7CiAgCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGJ1ZmZlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGxlbmd0aCArPSBidWZmZXJzW2ldLmxlbmd0aDsKICAgICAgICB9CiAgCiAgICAgICAgYnVmZmVyID0gdXRpbC5idWZmZXIuYWxsb2MobGVuZ3RoKTsKICAKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYnVmZmVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgYnVmZmVyc1tpXS5jb3B5KGJ1ZmZlciwgb2Zmc2V0KTsKICAgICAgICAgIG9mZnNldCArPSBidWZmZXJzW2ldLmxlbmd0aDsKICAgICAgICB9CiAgCiAgICAgICAgcmV0dXJuIGJ1ZmZlcjsKICAgICAgfQogICAgfSwKICAKICAgIHN0cmluZzogewogICAgICBieXRlTGVuZ3RoOiBmdW5jdGlvbiBieXRlTGVuZ3RoKHN0cmluZykgewogICAgICAgIGlmIChzdHJpbmcgPT09IG51bGwgfHwgc3RyaW5nID09PSB1bmRlZmluZWQpIHJldHVybiAwOwogICAgICAgIGlmICh0eXBlb2Ygc3RyaW5nID09PSAnc3RyaW5nJykgc3RyaW5nID0gdXRpbC5idWZmZXIudG9CdWZmZXIoc3RyaW5nKTsKICAKICAgICAgICBpZiAodHlwZW9mIHN0cmluZy5ieXRlTGVuZ3RoID09PSAnbnVtYmVyJykgewogICAgICAgICAgcmV0dXJuIHN0cmluZy5ieXRlTGVuZ3RoOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0cmluZy5sZW5ndGggPT09ICdudW1iZXInKSB7CiAgICAgICAgICByZXR1cm4gc3RyaW5nLmxlbmd0aDsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdHJpbmcuc2l6ZSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHJldHVybiBzdHJpbmcuc2l6ZTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdHJpbmcucGF0aCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIHJldHVybiByZXF1aXJlKCdmcycpLmxzdGF0U3luYyhzdHJpbmcucGF0aCkuc2l6ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBkZXRlcm1pbmUgbGVuZ3RoIG9mICcgKyBzdHJpbmcpLAogICAgICAgICAgICB7IG9iamVjdDogc3RyaW5nIH0pOwogICAgICAgIH0KICAgICAgfSwKICAKICAgICAgdXBwZXJGaXJzdDogZnVuY3Rpb24gdXBwZXJGaXJzdChzdHJpbmcpIHsKICAgICAgICByZXR1cm4gc3RyaW5nWzBdLnRvVXBwZXJDYXNlKCkgKyBzdHJpbmcuc3Vic3RyKDEpOwogICAgICB9LAogIAogICAgICBsb3dlckZpcnN0OiBmdW5jdGlvbiBsb3dlckZpcnN0KHN0cmluZykgewogICAgICAgIHJldHVybiBzdHJpbmdbMF0udG9Mb3dlckNhc2UoKSArIHN0cmluZy5zdWJzdHIoMSk7CiAgICAgIH0KICAgIH0sCiAgCiAgICBpbmk6IHsKICAgICAgcGFyc2U6IGZ1bmN0aW9uIHN0cmluZyhpbmkpIHsKICAgICAgICB2YXIgY3VycmVudFNlY3Rpb24sIG1hcCA9IHt9OwogICAgICAgIHV0aWwuYXJyYXlFYWNoKGluaS5zcGxpdCgvXHI/XG4vKSwgZnVuY3Rpb24obGluZSkgewogICAgICAgICAgbGluZSA9IGxpbmUuc3BsaXQoLyhefFxzKVs7I10vKVswXTsgLy8gcmVtb3ZlIGNvbW1lbnRzCiAgICAgICAgICB2YXIgc2VjdGlvbiA9IGxpbmUubWF0Y2goL15ccypcWyhbXlxbXF1dKylcXVxzKiQvKTsKICAgICAgICAgIGlmIChzZWN0aW9uKSB7CiAgICAgICAgICAgIGN1cnJlbnRTZWN0aW9uID0gc2VjdGlvblsxXTsKICAgICAgICAgIH0gZWxzZSBpZiAoY3VycmVudFNlY3Rpb24pIHsKICAgICAgICAgICAgdmFyIGl0ZW0gPSBsaW5lLm1hdGNoKC9eXHMqKC4rPylccyo9XHMqKC4rPylccyokLyk7CiAgICAgICAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgICAgICAgbWFwW2N1cnJlbnRTZWN0aW9uXSA9IG1hcFtjdXJyZW50U2VjdGlvbl0gfHwge307CiAgICAgICAgICAgICAgbWFwW2N1cnJlbnRTZWN0aW9uXVtpdGVtWzFdXSA9IGl0ZW1bMl07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAKICAgICAgICByZXR1cm4gbWFwOwogICAgICB9CiAgICB9LAogIAogICAgZm46IHsKICAgICAgbm9vcDogZnVuY3Rpb24oKSB7fSwKICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uIChlcnIpIHsgaWYgKGVycikgdGhyb3cgZXJyOyB9LAogIAogICAgICAvKioKICAgICAgICogVHVybiBhIHN5bmNocm9ub3VzIGZ1bmN0aW9uIGludG8gYXMgImFzeW5jIiBmdW5jdGlvbiBieSBtYWtpbmcgaXQgY2FsbAogICAgICAgKiBhIGNhbGxiYWNrLiBUaGUgdW5kZXJseWluZyBmdW5jdGlvbiBpcyBjYWxsZWQgd2l0aCBhbGwgYnV0IHRoZSBsYXN0IGFyZ3VtZW50LAogICAgICAgKiB3aGljaCBpcyB0cmVhdGVkIGFzIHRoZSBjYWxsYmFjay4gVGhlIGNhbGxiYWNrIGlzIHBhc3NlZCBwYXNzZWQgYSBmaXJzdCBhcmd1bWVudAogICAgICAgKiBvZiBudWxsIG9uIHN1Y2Nlc3MgdG8gbWltaWNrIHN0YW5kYXJkIG5vZGUgY2FsbGJhY2tzLgogICAgICAgKi8KICAgICAgbWFrZUFzeW5jOiBmdW5jdGlvbiBtYWtlQXN5bmMoZm4sIGV4cGVjdGVkQXJncykgewogICAgICAgIGlmIChleHBlY3RlZEFyZ3MgJiYgZXhwZWN0ZWRBcmdzIDw9IGZuLmxlbmd0aCkgewogICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH0KICAKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBhcmdzLnBvcCgpOwogICAgICAgICAgdmFyIHJlc3VsdCA9IGZuLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgICAgICAgY2FsbGJhY2socmVzdWx0KTsKICAgICAgICB9OwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBEYXRlIGFuZCB0aW1lIHV0aWxpdHkgZnVuY3Rpb25zLgogICAgICovCiAgICBkYXRlOiB7CiAgCiAgICAgIC8qKgogICAgICAgKiBAcmV0dXJuIFtEYXRlXSB0aGUgY3VycmVudCBKYXZhU2NyaXB0IGRhdGUgb2JqZWN0LiBTaW5jZSBhbGwKICAgICAgICogICBBV1Mgc2VydmljZXMgcmVseSBvbiB0aGlzIGRhdGUgb2JqZWN0LCB5b3UgY2FuIG92ZXJyaWRlCiAgICAgICAqICAgdGhpcyBmdW5jdGlvbiB0byBwcm92aWRlIGEgc3BlY2lhbCB0aW1lIHZhbHVlIHRvIEFXUyBzZXJ2aWNlCiAgICAgICAqICAgcmVxdWVzdHMuCiAgICAgICAqLwogICAgICBnZXREYXRlOiBmdW5jdGlvbiBnZXREYXRlKCkgewogICAgICAgIGlmICghQVdTKSBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICAgICAgICBpZiAoQVdTLmNvbmZpZy5zeXN0ZW1DbG9ja09mZnNldCkgeyAvLyB1c2Ugb2Zmc2V0IHdoZW4gbm9uLXplcm8KICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShuZXcgRGF0ZSgpLmdldFRpbWUoKSArIEFXUy5jb25maWcuc3lzdGVtQ2xvY2tPZmZzZXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gbmV3IERhdGUoKTsKICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIC8qKgogICAgICAgKiBAcmV0dXJuIFtTdHJpbmddIHRoZSBkYXRlIGluIElTTy04NjAxIGZvcm1hdAogICAgICAgKi8KICAgICAgaXNvODYwMTogZnVuY3Rpb24gaXNvODYwMShkYXRlKSB7CiAgICAgICAgaWYgKGRhdGUgPT09IHVuZGVmaW5lZCkgeyBkYXRlID0gdXRpbC5kYXRlLmdldERhdGUoKTsgfQogICAgICAgIHJldHVybiBkYXRlLnRvSVNPU3RyaW5nKCkucmVwbGFjZSgvXC5cZHszfVokLywgJ1onKTsKICAgICAgfSwKICAKICAgICAgLyoqCiAgICAgICAqIEByZXR1cm4gW1N0cmluZ10gdGhlIGRhdGUgaW4gUkZDIDgyMiBmb3JtYXQKICAgICAgICovCiAgICAgIHJmYzgyMjogZnVuY3Rpb24gcmZjODIyKGRhdGUpIHsKICAgICAgICBpZiAoZGF0ZSA9PT0gdW5kZWZpbmVkKSB7IGRhdGUgPSB1dGlsLmRhdGUuZ2V0RGF0ZSgpOyB9CiAgICAgICAgcmV0dXJuIGRhdGUudG9VVENTdHJpbmcoKTsKICAgICAgfSwKICAKICAgICAgLyoqCiAgICAgICAqIEByZXR1cm4gW0ludGVnZXJdIHRoZSBVTklYIHRpbWVzdGFtcCB2YWx1ZSBmb3IgdGhlIGN1cnJlbnQgdGltZQogICAgICAgKi8KICAgICAgdW5peFRpbWVzdGFtcDogZnVuY3Rpb24gdW5peFRpbWVzdGFtcChkYXRlKSB7CiAgICAgICAgaWYgKGRhdGUgPT09IHVuZGVmaW5lZCkgeyBkYXRlID0gdXRpbC5kYXRlLmdldERhdGUoKTsgfQogICAgICAgIHJldHVybiBkYXRlLmdldFRpbWUoKSAvIDEwMDA7CiAgICAgIH0sCiAgCiAgICAgIC8qKgogICAgICAgKiBAcGFyYW0gW1N0cmluZyxudW1iZXIsRGF0ZV0gZGF0ZQogICAgICAgKiBAcmV0dXJuIFtEYXRlXQogICAgICAgKi8KICAgICAgZnJvbTogZnVuY3Rpb24gZm9ybWF0KGRhdGUpIHsKICAgICAgICBpZiAodHlwZW9mIGRhdGUgPT09ICdudW1iZXInKSB7CiAgICAgICAgICByZXR1cm4gbmV3IERhdGUoZGF0ZSAqIDEwMDApOyAvLyB1bml4IHRpbWVzdGFtcAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gbmV3IERhdGUoZGF0ZSk7CiAgICAgICAgfQogICAgICB9LAogIAogICAgICAvKioKICAgICAgICogR2l2ZW4gYSBEYXRlIG9yIGRhdGUtbGlrZSB2YWx1ZSwgdGhpcyBmdW5jdGlvbiBmb3JtYXRzIHRoZQogICAgICAgKiBkYXRlIGludG8gYSBzdHJpbmcgb2YgdGhlIHJlcXVlc3RlZCB2YWx1ZS4KICAgICAgICogQHBhcmFtIFtTdHJpbmcsbnVtYmVyLERhdGVdIGRhdGUKICAgICAgICogQHBhcmFtIFtTdHJpbmddIGZvcm1hdHRlciBWYWxpZCBmb3JtYXRzIGFyZToKICAgICAgICMgICAqICdpc284NjAxJwogICAgICAgIyAgICogJ3JmYzgyMicKICAgICAgICMgICAqICd1bml4VGltZXN0YW1wJwogICAgICAgKiBAcmV0dXJuIFtTdHJpbmddCiAgICAgICAqLwogICAgICBmb3JtYXQ6IGZ1bmN0aW9uIGZvcm1hdChkYXRlLCBmb3JtYXR0ZXIpIHsKICAgICAgICBpZiAoIWZvcm1hdHRlcikgZm9ybWF0dGVyID0gJ2lzbzg2MDEnOwogICAgICAgIHJldHVybiB1dGlsLmRhdGVbZm9ybWF0dGVyXSh1dGlsLmRhdGUuZnJvbShkYXRlKSk7CiAgICAgIH0sCiAgCiAgICAgIHBhcnNlVGltZXN0YW1wOiBmdW5jdGlvbiBwYXJzZVRpbWVzdGFtcCh2YWx1ZSkgewogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7IC8vIHVuaXggdGltZXN0YW1wIChudW1iZXIpCiAgICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWUgKiAxMDAwKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLm1hdGNoKC9eXGQrJC8pKSB7IC8vIHVuaXggdGltZXN0YW1wCiAgICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWUgKiAxMDAwKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLm1hdGNoKC9eXGR7NH0vKSkgeyAvLyBpc284NjAxCiAgICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWUubWF0Y2goL15cd3szfSwvKSkgeyAvLyByZmM4MjIKICAgICAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IoCiAgICAgICAgICAgIG5ldyBFcnJvcigndW5oYW5kbGVkIHRpbWVzdGFtcCBmb3JtYXQ6ICcgKyB2YWx1ZSksCiAgICAgICAgICAgIHtjb2RlOiAnVGltZXN0YW1wUGFyc2VyRXJyb3InfSk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICB9LAogIAogICAgY3J5cHRvOiB7CiAgICAgIGNyYzMyVGFibGU6IFsKICAgICAgIDB4MDAwMDAwMDAsIDB4NzcwNzMwOTYsIDB4RUUwRTYxMkMsIDB4OTkwOTUxQkEsIDB4MDc2REM0MTksCiAgICAgICAweDcwNkFGNDhGLCAweEU5NjNBNTM1LCAweDlFNjQ5NUEzLCAweDBFREI4ODMyLCAweDc5RENCOEE0LAogICAgICAgMHhFMEQ1RTkxRSwgMHg5N0QyRDk4OCwgMHgwOUI2NEMyQiwgMHg3RUIxN0NCRCwgMHhFN0I4MkQwNywKICAgICAgIDB4OTBCRjFEOTEsIDB4MURCNzEwNjQsIDB4NkFCMDIwRjIsIDB4RjNCOTcxNDgsIDB4ODRCRTQxREUsCiAgICAgICAweDFBREFENDdELCAweDZERERFNEVCLCAweEY0RDRCNTUxLCAweDgzRDM4NUM3LCAweDEzNkM5ODU2LAogICAgICAgMHg2NDZCQThDMCwgMHhGRDYyRjk3QSwgMHg4QTY1QzlFQywgMHgxNDAxNUM0RiwgMHg2MzA2NkNEOSwKICAgICAgIDB4RkEwRjNENjMsIDB4OEQwODBERjUsIDB4M0I2RTIwQzgsIDB4NEM2OTEwNUUsIDB4RDU2MDQxRTQsCiAgICAgICAweEEyNjc3MTcyLCAweDNDMDNFNEQxLCAweDRCMDRENDQ3LCAweEQyMEQ4NUZELCAweEE1MEFCNTZCLAogICAgICAgMHgzNUI1QThGQSwgMHg0MkIyOTg2QywgMHhEQkJCQzlENiwgMHhBQ0JDRjk0MCwgMHgzMkQ4NkNFMywKICAgICAgIDB4NDVERjVDNzUsIDB4RENENjBEQ0YsIDB4QUJEMTNENTksIDB4MjZEOTMwQUMsIDB4NTFERTAwM0EsCiAgICAgICAweEM4RDc1MTgwLCAweEJGRDA2MTE2LCAweDIxQjRGNEI1LCAweDU2QjNDNDIzLCAweENGQkE5NTk5LAogICAgICAgMHhCOEJEQTUwRiwgMHgyODAyQjg5RSwgMHg1RjA1ODgwOCwgMHhDNjBDRDlCMiwgMHhCMTBCRTkyNCwKICAgICAgIDB4MkY2RjdDODcsIDB4NTg2ODRDMTEsIDB4QzE2MTFEQUIsIDB4QjY2NjJEM0QsIDB4NzZEQzQxOTAsCiAgICAgICAweDAxREI3MTA2LCAweDk4RDIyMEJDLCAweEVGRDUxMDJBLCAweDcxQjE4NTg5LCAweDA2QjZCNTFGLAogICAgICAgMHg5RkJGRTRBNSwgMHhFOEI4RDQzMywgMHg3ODA3QzlBMiwgMHgwRjAwRjkzNCwgMHg5NjA5QTg4RSwKICAgICAgIDB4RTEwRTk4MTgsIDB4N0Y2QTBEQkIsIDB4MDg2RDNEMkQsIDB4OTE2NDZDOTcsIDB4RTY2MzVDMDEsCiAgICAgICAweDZCNkI1MUY0LCAweDFDNkM2MTYyLCAweDg1NjUzMEQ4LCAweEYyNjIwMDRFLCAweDZDMDY5NUVELAogICAgICAgMHgxQjAxQTU3QiwgMHg4MjA4RjRDMSwgMHhGNTBGQzQ1NywgMHg2NUIwRDlDNiwgMHgxMkI3RTk1MCwKICAgICAgIDB4OEJCRUI4RUEsIDB4RkNCOTg4N0MsIDB4NjJERDFEREYsIDB4MTVEQTJENDksIDB4OENEMzdDRjMsCiAgICAgICAweEZCRDQ0QzY1LCAweDREQjI2MTU4LCAweDNBQjU1MUNFLCAweEEzQkMwMDc0LCAweEQ0QkIzMEUyLAogICAgICAgMHg0QURGQTU0MSwgMHgzREQ4OTVENywgMHhBNEQxQzQ2RCwgMHhEM0Q2RjRGQiwgMHg0MzY5RTk2QSwKICAgICAgIDB4MzQ2RUQ5RkMsIDB4QUQ2Nzg4NDYsIDB4REE2MEI4RDAsIDB4NDQwNDJENzMsIDB4MzMwMzFERTUsCiAgICAgICAweEFBMEE0QzVGLCAweEREMEQ3Q0M5LCAweDUwMDU3MTNDLCAweDI3MDI0MUFBLCAweEJFMEIxMDEwLAogICAgICAgMHhDOTBDMjA4NiwgMHg1NzY4QjUyNSwgMHgyMDZGODVCMywgMHhCOTY2RDQwOSwgMHhDRTYxRTQ5RiwKICAgICAgIDB4NUVERUY5MEUsIDB4MjlEOUM5OTgsIDB4QjBEMDk4MjIsIDB4QzdEN0E4QjQsIDB4NTlCMzNEMTcsCiAgICAgICAweDJFQjQwRDgxLCAweEI3QkQ1QzNCLCAweEMwQkE2Q0FELCAweEVEQjg4MzIwLCAweDlBQkZCM0I2LAogICAgICAgMHgwM0I2RTIwQywgMHg3NEIxRDI5QSwgMHhFQUQ1NDczOSwgMHg5REQyNzdBRiwgMHgwNERCMjYxNSwKICAgICAgIDB4NzNEQzE2ODMsIDB4RTM2MzBCMTIsIDB4OTQ2NDNCODQsIDB4MEQ2RDZBM0UsIDB4N0E2QTVBQTgsCiAgICAgICAweEU0MEVDRjBCLCAweDkzMDlGRjlELCAweDBBMDBBRTI3LCAweDdEMDc5RUIxLCAweEYwMEY5MzQ0LAogICAgICAgMHg4NzA4QTNEMiwgMHgxRTAxRjI2OCwgMHg2OTA2QzJGRSwgMHhGNzYyNTc1RCwgMHg4MDY1NjdDQiwKICAgICAgIDB4MTk2QzM2NzEsIDB4NkU2QjA2RTcsIDB4RkVENDFCNzYsIDB4ODlEMzJCRTAsIDB4MTBEQTdBNUEsCiAgICAgICAweDY3REQ0QUNDLCAweEY5QjlERjZGLCAweDhFQkVFRkY5LCAweDE3QjdCRTQzLCAweDYwQjA4RUQ1LAogICAgICAgMHhENkQ2QTNFOCwgMHhBMUQxOTM3RSwgMHgzOEQ4QzJDNCwgMHg0RkRGRjI1MiwgMHhEMUJCNjdGMSwKICAgICAgIDB4QTZCQzU3NjcsIDB4M0ZCNTA2REQsIDB4NDhCMjM2NEIsIDB4RDgwRDJCREEsIDB4QUYwQTFCNEMsCiAgICAgICAweDM2MDM0QUY2LCAweDQxMDQ3QTYwLCAweERGNjBFRkMzLCAweEE4NjdERjU1LCAweDMxNkU4RUVGLAogICAgICAgMHg0NjY5QkU3OSwgMHhDQjYxQjM4QywgMHhCQzY2ODMxQSwgMHgyNTZGRDJBMCwgMHg1MjY4RTIzNiwKICAgICAgIDB4Q0MwQzc3OTUsIDB4QkIwQjQ3MDMsIDB4MjIwMjE2QjksIDB4NTUwNTI2MkYsIDB4QzVCQTNCQkUsCiAgICAgICAweEIyQkQwQjI4LCAweDJCQjQ1QTkyLCAweDVDQjM2QTA0LCAweEMyRDdGRkE3LCAweEI1RDBDRjMxLAogICAgICAgMHgyQ0Q5OUU4QiwgMHg1QkRFQUUxRCwgMHg5QjY0QzJCMCwgMHhFQzYzRjIyNiwgMHg3NTZBQTM5QywKICAgICAgIDB4MDI2RDkzMEEsIDB4OUMwOTA2QTksIDB4RUIwRTM2M0YsIDB4NzIwNzY3ODUsIDB4MDUwMDU3MTMsCiAgICAgICAweDk1QkY0QTgyLCAweEUyQjg3QTE0LCAweDdCQjEyQkFFLCAweDBDQjYxQjM4LCAweDkyRDI4RTlCLAogICAgICAgMHhFNUQ1QkUwRCwgMHg3Q0RDRUZCNywgMHgwQkRCREYyMSwgMHg4NkQzRDJENCwgMHhGMUQ0RTI0MiwKICAgICAgIDB4NjhEREIzRjgsIDB4MUZEQTgzNkUsIDB4ODFCRTE2Q0QsIDB4RjZCOTI2NUIsIDB4NkZCMDc3RTEsCiAgICAgICAweDE4Qjc0Nzc3LCAweDg4MDg1QUU2LCAweEZGMEY2QTcwLCAweDY2MDYzQkNBLCAweDExMDEwQjVDLAogICAgICAgMHg4RjY1OUVGRiwgMHhGODYyQUU2OSwgMHg2MTZCRkZEMywgMHgxNjZDQ0Y0NSwgMHhBMDBBRTI3OCwKICAgICAgIDB4RDcwREQyRUUsIDB4NEUwNDgzNTQsIDB4MzkwM0IzQzIsIDB4QTc2NzI2NjEsIDB4RDA2MDE2RjcsCiAgICAgICAweDQ5Njk0NzRELCAweDNFNkU3N0RCLCAweEFFRDE2QTRBLCAweEQ5RDY1QURDLCAweDQwREYwQjY2LAogICAgICAgMHgzN0Q4M0JGMCwgMHhBOUJDQUU1MywgMHhERUJCOUVDNSwgMHg0N0IyQ0Y3RiwgMHgzMEI1RkZFOSwKICAgICAgIDB4QkRCREYyMUMsIDB4Q0FCQUMyOEEsIDB4NTNCMzkzMzAsIDB4MjRCNEEzQTYsIDB4QkFEMDM2MDUsCiAgICAgICAweENERDcwNjkzLCAweDU0REU1NzI5LCAweDIzRDk2N0JGLCAweEIzNjY3QTJFLCAweEM0NjE0QUI4LAogICAgICAgMHg1RDY4MUIwMiwgMHgyQTZGMkI5NCwgMHhCNDBCQkUzNywgMHhDMzBDOEVBMSwgMHg1QTA1REYxQiwKICAgICAgIDB4MkQwMkVGOERdLAogIAogICAgICBjcmMzMjogZnVuY3Rpb24gY3JjMzIoZGF0YSkgewogICAgICAgIHZhciB0YmwgPSB1dGlsLmNyeXB0by5jcmMzMlRhYmxlOwogICAgICAgIHZhciBjcmMgPSAwIF4gLTE7CiAgCiAgICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgewogICAgICAgICAgZGF0YSA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyKGRhdGEpOwogICAgICAgIH0KICAKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBjb2RlID0gZGF0YS5yZWFkVUludDgoaSk7CiAgICAgICAgICBjcmMgPSAoY3JjID4+PiA4KSBeIHRibFsoY3JjIF4gY29kZSkgJiAweEZGXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIChjcmMgXiAtMSkgPj4+IDA7CiAgICAgIH0sCiAgCiAgICAgIGhtYWM6IGZ1bmN0aW9uIGhtYWMoa2V5LCBzdHJpbmcsIGRpZ2VzdCwgZm4pIHsKICAgICAgICBpZiAoIWRpZ2VzdCkgZGlnZXN0ID0gJ2JpbmFyeSc7CiAgICAgICAgaWYgKGRpZ2VzdCA9PT0gJ2J1ZmZlcicpIHsgZGlnZXN0ID0gdW5kZWZpbmVkOyB9CiAgICAgICAgaWYgKCFmbikgZm4gPSAnc2hhMjU2JzsKICAgICAgICBpZiAodHlwZW9mIHN0cmluZyA9PT0gJ3N0cmluZycpIHN0cmluZyA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyKHN0cmluZyk7CiAgICAgICAgcmV0dXJuIHV0aWwuY3J5cHRvLmxpYi5jcmVhdGVIbWFjKGZuLCBrZXkpLnVwZGF0ZShzdHJpbmcpLmRpZ2VzdChkaWdlc3QpOwogICAgICB9LAogIAogICAgICBtZDU6IGZ1bmN0aW9uIG1kNShkYXRhLCBkaWdlc3QsIGNhbGxiYWNrKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuY3J5cHRvLmhhc2goJ21kNScsIGRhdGEsIGRpZ2VzdCwgY2FsbGJhY2spOwogICAgICB9LAogIAogICAgICBzaGEyNTY6IGZ1bmN0aW9uIHNoYTI1NihkYXRhLCBkaWdlc3QsIGNhbGxiYWNrKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuY3J5cHRvLmhhc2goJ3NoYTI1NicsIGRhdGEsIGRpZ2VzdCwgY2FsbGJhY2spOwogICAgICB9LAogIAogICAgICBoYXNoOiBmdW5jdGlvbihhbGdvcml0aG0sIGRhdGEsIGRpZ2VzdCwgY2FsbGJhY2spIHsKICAgICAgICB2YXIgaGFzaCA9IHV0aWwuY3J5cHRvLmNyZWF0ZUhhc2goYWxnb3JpdGhtKTsKICAgICAgICBpZiAoIWRpZ2VzdCkgeyBkaWdlc3QgPSAnYmluYXJ5JzsgfQogICAgICAgIGlmIChkaWdlc3QgPT09ICdidWZmZXInKSB7IGRpZ2VzdCA9IHVuZGVmaW5lZDsgfQogICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIGRhdGEgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcihkYXRhKTsKICAgICAgICB2YXIgc2xpY2VGbiA9IHV0aWwuYXJyYXlTbGljZUZuKGRhdGEpOwogICAgICAgIHZhciBpc0J1ZmZlciA9IHV0aWwuQnVmZmVyLmlzQnVmZmVyKGRhdGEpOwogICAgICAgIC8vSWRlbnRpZnlpbmcgb2JqZWN0cyB3aXRoIGFuIEFycmF5QnVmZmVyIGFzIGJ1ZmZlcnMKICAgICAgICBpZiAodXRpbC5pc0Jyb3dzZXIoKSAmJiB0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmIGRhdGEgJiYgZGF0YS5idWZmZXIgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgaXNCdWZmZXIgPSB0cnVlOwogIAogICAgICAgIGlmIChjYWxsYmFjayAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcgJiYKICAgICAgICAgICAgdHlwZW9mIGRhdGEub24gPT09ICdmdW5jdGlvbicgJiYgIWlzQnVmZmVyKSB7CiAgICAgICAgICBkYXRhLm9uKCdkYXRhJywgZnVuY3Rpb24oY2h1bmspIHsgaGFzaC51cGRhdGUoY2h1bmspOyB9KTsKICAgICAgICAgIGRhdGEub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7IGNhbGxiYWNrKGVycik7IH0pOwogICAgICAgICAgZGF0YS5vbignZW5kJywgZnVuY3Rpb24oKSB7IGNhbGxiYWNrKG51bGwsIGhhc2guZGlnZXN0KGRpZ2VzdCkpOyB9KTsKICAgICAgICB9IGVsc2UgaWYgKGNhbGxiYWNrICYmIHNsaWNlRm4gJiYgIWlzQnVmZmVyICYmCiAgICAgICAgICAgICAgICAgICB0eXBlb2YgRmlsZVJlYWRlciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIC8vIHRoaXMgbWlnaHQgYmUgYSBGaWxlL0Jsb2IKICAgICAgICAgIHZhciBpbmRleCA9IDAsIHNpemUgPSAxMDI0ICogNTEyOwogICAgICAgICAgdmFyIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7CiAgICAgICAgICByZWFkZXIub25lcnJvciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjYWxsYmFjayhuZXcgRXJyb3IoJ0ZhaWxlZCB0byByZWFkIGRhdGEuJykpOwogICAgICAgICAgfTsKICAgICAgICAgIHJlYWRlci5vbmxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGJ1ZiA9IG5ldyB1dGlsLkJ1ZmZlcihuZXcgVWludDhBcnJheShyZWFkZXIucmVzdWx0KSk7CiAgICAgICAgICAgIGhhc2gudXBkYXRlKGJ1Zik7CiAgICAgICAgICAgIGluZGV4ICs9IGJ1Zi5sZW5ndGg7CiAgICAgICAgICAgIHJlYWRlci5fY29udGludWVSZWFkaW5nKCk7CiAgICAgICAgICB9OwogICAgICAgICAgcmVhZGVyLl9jb250aW51ZVJlYWRpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKGluZGV4ID49IGRhdGEuc2l6ZSkgewogICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGhhc2guZGlnZXN0KGRpZ2VzdCkpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogIAogICAgICAgICAgICB2YXIgYmFjayA9IGluZGV4ICsgc2l6ZTsKICAgICAgICAgICAgaWYgKGJhY2sgPiBkYXRhLnNpemUpIGJhY2sgPSBkYXRhLnNpemU7CiAgICAgICAgICAgIHJlYWRlci5yZWFkQXNBcnJheUJ1ZmZlcihzbGljZUZuLmNhbGwoZGF0YSwgaW5kZXgsIGJhY2spKTsKICAgICAgICAgIH07CiAgCiAgICAgICAgICByZWFkZXIuX2NvbnRpbnVlUmVhZGluZygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodXRpbC5pc0Jyb3dzZXIoKSAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcgJiYgIWlzQnVmZmVyKSB7CiAgICAgICAgICAgIGRhdGEgPSBuZXcgdXRpbC5CdWZmZXIobmV3IFVpbnQ4QXJyYXkoZGF0YSkpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG91dCA9IGhhc2gudXBkYXRlKGRhdGEpLmRpZ2VzdChkaWdlc3QpOwogICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayhudWxsLCBvdXQpOwogICAgICAgICAgcmV0dXJuIG91dDsKICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIHRvSGV4OiBmdW5jdGlvbiB0b0hleChkYXRhKSB7CiAgICAgICAgdmFyIG91dCA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgICAgb3V0LnB1c2goKCcwJyArIGRhdGEuY2hhckNvZGVBdChpKS50b1N0cmluZygxNikpLnN1YnN0cigtMiwgMikpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb3V0LmpvaW4oJycpOwogICAgICB9LAogIAogICAgICBjcmVhdGVIYXNoOiBmdW5jdGlvbiBjcmVhdGVIYXNoKGFsZ29yaXRobSkgewogICAgICAgIHJldHVybiB1dGlsLmNyeXB0by5saWIuY3JlYXRlSGFzaChhbGdvcml0aG0pOwogICAgICB9CiAgCiAgICB9LAogIAogICAgLyoqIEAhaWdub3JlICovCiAgCiAgICAvKiBBYm9ydCBjb25zdGFudCAqLwogICAgYWJvcnQ6IHt9LAogIAogICAgZWFjaDogZnVuY3Rpb24gZWFjaChvYmplY3QsIGl0ZXJGdW5jdGlvbikgewogICAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSB7CiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIHsKICAgICAgICAgIHZhciByZXQgPSBpdGVyRnVuY3Rpb24uY2FsbCh0aGlzLCBrZXksIG9iamVjdFtrZXldKTsKICAgICAgICAgIGlmIChyZXQgPT09IHV0aWwuYWJvcnQpIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIGFycmF5RWFjaDogZnVuY3Rpb24gYXJyYXlFYWNoKGFycmF5LCBpdGVyRnVuY3Rpb24pIHsKICAgICAgZm9yICh2YXIgaWR4IGluIGFycmF5KSB7CiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChhcnJheSwgaWR4KSkgewogICAgICAgICAgdmFyIHJldCA9IGl0ZXJGdW5jdGlvbi5jYWxsKHRoaXMsIGFycmF5W2lkeF0sIHBhcnNlSW50KGlkeCwgMTApKTsKICAgICAgICAgIGlmIChyZXQgPT09IHV0aWwuYWJvcnQpIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKG9iajEsIG9iajIpIHsKICAgICAgdXRpbC5lYWNoKG9iajIsIGZ1bmN0aW9uIGl0ZXJhdG9yKGtleSwgaXRlbSkgewogICAgICAgIG9iajFba2V5XSA9IGl0ZW07CiAgICAgIH0pOwogICAgICByZXR1cm4gb2JqMTsKICAgIH0sCiAgCiAgICBtZXJnZTogZnVuY3Rpb24gbWVyZ2Uob2JqMSwgb2JqMikgewogICAgICByZXR1cm4gdXRpbC51cGRhdGUodXRpbC5jb3B5KG9iajEpLCBvYmoyKTsKICAgIH0sCiAgCiAgICBjb3B5OiBmdW5jdGlvbiBjb3B5KG9iamVjdCkgewogICAgICBpZiAob2JqZWN0ID09PSBudWxsIHx8IG9iamVjdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gb2JqZWN0OwogICAgICB2YXIgZHVwZSA9IHt9OwogICAgICAvLyBqc2hpbnQgZm9yaW46ZmFsc2UKICAgICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgewogICAgICAgIGR1cGVba2V5XSA9IG9iamVjdFtrZXldOwogICAgICB9CiAgICAgIHJldHVybiBkdXBlOwogICAgfSwKICAKICAgIGlzRW1wdHk6IGZ1bmN0aW9uIGlzRW1wdHkob2JqKSB7CiAgICAgIGZvciAodmFyIHByb3AgaW4gb2JqKSB7CiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAKICAgIGFycmF5U2xpY2VGbjogZnVuY3Rpb24gYXJyYXlTbGljZUZuKG9iaikgewogICAgICB2YXIgZm4gPSBvYmouc2xpY2UgfHwgb2JqLndlYmtpdFNsaWNlIHx8IG9iai5tb3pTbGljZTsKICAgICAgcmV0dXJuIHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJyA/IGZuIDogbnVsbDsKICAgIH0sCiAgCiAgICBpc1R5cGU6IGZ1bmN0aW9uIGlzVHlwZShvYmosIHR5cGUpIHsKICAgICAgLy8gaGFuZGxlIGNyb3NzLSJmcmFtZSIgb2JqZWN0cwogICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICdmdW5jdGlvbicpIHR5cGUgPSB1dGlsLnR5cGVOYW1lKHR5cGUpOwogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0ICcgKyB0eXBlICsgJ10nOwogICAgfSwKICAKICAgIHR5cGVOYW1lOiBmdW5jdGlvbiB0eXBlTmFtZSh0eXBlKSB7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodHlwZSwgJ25hbWUnKSkgcmV0dXJuIHR5cGUubmFtZTsKICAgICAgdmFyIHN0ciA9IHR5cGUudG9TdHJpbmcoKTsKICAgICAgdmFyIG1hdGNoID0gc3RyLm1hdGNoKC9eXHMqZnVuY3Rpb24gKC4rKVwoLyk7CiAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogc3RyOwogICAgfSwKICAKICAgIGVycm9yOiBmdW5jdGlvbiBlcnJvcihlcnIsIG9wdGlvbnMpIHsKICAgICAgdmFyIG9yaWdpbmFsRXJyb3IgPSBudWxsOwogICAgICBpZiAodHlwZW9mIGVyci5tZXNzYWdlID09PSAnc3RyaW5nJyAmJiBlcnIubWVzc2FnZSAhPT0gJycpIHsKICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnIHx8IChvcHRpb25zICYmIG9wdGlvbnMubWVzc2FnZSkpIHsKICAgICAgICAgIG9yaWdpbmFsRXJyb3IgPSB1dGlsLmNvcHkoZXJyKTsKICAgICAgICAgIG9yaWdpbmFsRXJyb3IubWVzc2FnZSA9IGVyci5tZXNzYWdlOwogICAgICAgIH0KICAgICAgfQogICAgICBlcnIubWVzc2FnZSA9IGVyci5tZXNzYWdlIHx8IG51bGw7CiAgCiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHsKICAgICAgICBlcnIubWVzc2FnZSA9IG9wdGlvbnM7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdvYmplY3QnICYmIG9wdGlvbnMgIT09IG51bGwpIHsKICAgICAgICB1dGlsLnVwZGF0ZShlcnIsIG9wdGlvbnMpOwogICAgICAgIGlmIChvcHRpb25zLm1lc3NhZ2UpCiAgICAgICAgICBlcnIubWVzc2FnZSA9IG9wdGlvbnMubWVzc2FnZTsKICAgICAgICBpZiAob3B0aW9ucy5jb2RlIHx8IG9wdGlvbnMubmFtZSkKICAgICAgICAgIGVyci5jb2RlID0gb3B0aW9ucy5jb2RlIHx8IG9wdGlvbnMubmFtZTsKICAgICAgICBpZiAob3B0aW9ucy5zdGFjaykKICAgICAgICAgIGVyci5zdGFjayA9IG9wdGlvbnMuc3RhY2s7CiAgICAgIH0KICAKICAgICAgaWYgKHR5cGVvZiBPYmplY3QuZGVmaW5lUHJvcGVydHkgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXJyLCAnbmFtZScsIHt3cml0YWJsZTogdHJ1ZSwgZW51bWVyYWJsZTogZmFsc2V9KTsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXJyLCAnbWVzc2FnZScsIHtlbnVtZXJhYmxlOiB0cnVlfSk7CiAgICAgIH0KICAKICAgICAgZXJyLm5hbWUgPSBvcHRpb25zICYmIG9wdGlvbnMubmFtZSB8fCBlcnIubmFtZSB8fCBlcnIuY29kZSB8fCAnRXJyb3InOwogICAgICBlcnIudGltZSA9IG5ldyBEYXRlKCk7CiAgCiAgICAgIGlmIChvcmlnaW5hbEVycm9yKSBlcnIub3JpZ2luYWxFcnJvciA9IG9yaWdpbmFsRXJyb3I7CiAgCiAgICAgIHJldHVybiBlcnI7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaW5oZXJpdDogZnVuY3Rpb24gaW5oZXJpdChrbGFzcywgZmVhdHVyZXMpIHsKICAgICAgdmFyIG5ld09iamVjdCA9IG51bGw7CiAgICAgIGlmIChmZWF0dXJlcyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgZmVhdHVyZXMgPSBrbGFzczsKICAgICAgICBrbGFzcyA9IE9iamVjdDsKICAgICAgICBuZXdPYmplY3QgPSB7fTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgY3RvciA9IGZ1bmN0aW9uIENvbnN0cnVjdG9yV3JhcHBlcigpIHt9OwogICAgICAgIGN0b3IucHJvdG90eXBlID0ga2xhc3MucHJvdG90eXBlOwogICAgICAgIG5ld09iamVjdCA9IG5ldyBjdG9yKCk7CiAgICAgIH0KICAKICAgICAgLy8gY29uc3RydWN0b3Igbm90IHN1cHBsaWVkLCBjcmVhdGUgcGFzcy10aHJvdWdoIGN0b3IKICAgICAgaWYgKGZlYXR1cmVzLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIHsKICAgICAgICBmZWF0dXJlcy5jb25zdHJ1Y3RvciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKGtsYXNzICE9PSBPYmplY3QpIHsKICAgICAgICAgICAgcmV0dXJuIGtsYXNzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogIAogICAgICBmZWF0dXJlcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSBuZXdPYmplY3Q7CiAgICAgIHV0aWwudXBkYXRlKGZlYXR1cmVzLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgZmVhdHVyZXMpOwogICAgICBmZWF0dXJlcy5jb25zdHJ1Y3Rvci5fX3N1cGVyX18gPSBrbGFzczsKICAgICAgcmV0dXJuIGZlYXR1cmVzLmNvbnN0cnVjdG9yOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIG1peGluOiBmdW5jdGlvbiBtaXhpbigpIHsKICAgICAgdmFyIGtsYXNzID0gYXJndW1lbnRzWzBdOwogICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIC8vIGpzaGludCBmb3JpbjpmYWxzZQogICAgICAgIGZvciAodmFyIHByb3AgaW4gYXJndW1lbnRzW2ldLnByb3RvdHlwZSkgewogICAgICAgICAgdmFyIGZuID0gYXJndW1lbnRzW2ldLnByb3RvdHlwZVtwcm9wXTsKICAgICAgICAgIGlmIChwcm9wICE9PSAnY29uc3RydWN0b3InKSB7CiAgICAgICAgICAgIGtsYXNzLnByb3RvdHlwZVtwcm9wXSA9IGZuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4ga2xhc3M7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaGlkZVByb3BlcnRpZXM6IGZ1bmN0aW9uIGhpZGVQcm9wZXJ0aWVzKG9iaiwgcHJvcHMpIHsKICAgICAgaWYgKHR5cGVvZiBPYmplY3QuZGVmaW5lUHJvcGVydHkgIT09ICdmdW5jdGlvbicpIHJldHVybjsKICAKICAgICAgdXRpbC5hcnJheUVhY2gocHJvcHMsIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHsKICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0pOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBwcm9wZXJ0eTogZnVuY3Rpb24gcHJvcGVydHkob2JqLCBuYW1lLCB2YWx1ZSwgZW51bWVyYWJsZSwgaXNWYWx1ZSkgewogICAgICB2YXIgb3B0cyA9IHsKICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgZW51bWVyYWJsZTogZW51bWVyYWJsZSAhPT0gdW5kZWZpbmVkID8gZW51bWVyYWJsZSA6IHRydWUKICAgICAgfTsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJyAmJiAhaXNWYWx1ZSkgewogICAgICAgIG9wdHMuZ2V0ID0gdmFsdWU7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgb3B0cy52YWx1ZSA9IHZhbHVlOyBvcHRzLndyaXRhYmxlID0gdHJ1ZTsKICAgICAgfQogIAogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBuYW1lLCBvcHRzKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBtZW1vaXplZFByb3BlcnR5OiBmdW5jdGlvbiBtZW1vaXplZFByb3BlcnR5KG9iaiwgbmFtZSwgZ2V0LCBlbnVtZXJhYmxlKSB7CiAgICAgIHZhciBjYWNoZWRWYWx1ZSA9IG51bGw7CiAgCiAgICAgIC8vIGJ1aWxkIGVudW1lcmFibGUgYXR0cmlidXRlIGZvciBlYWNoIHZhbHVlIHdpdGggbGF6eSBhY2Nlc3Nvci4KICAgICAgdXRpbC5wcm9wZXJ0eShvYmosIG5hbWUsIGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChjYWNoZWRWYWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgY2FjaGVkVmFsdWUgPSBnZXQoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNhY2hlZFZhbHVlOwogICAgICB9LCBlbnVtZXJhYmxlKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFRPRE8gUmVtb3ZlIGluIG1ham9yIHZlcnNpb24gcmV2aXNpb24KICAgICAqIFRoaXMgYmFja2ZpbGwgcG9wdWxhdGVzIHJlc3BvbnNlIGRhdGEgd2l0aG91dCB0aGUKICAgICAqIHRvcC1sZXZlbCBwYXlsb2FkIG5hbWUuCiAgICAgKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGhvaXN0UGF5bG9hZE1lbWJlcjogZnVuY3Rpb24gaG9pc3RQYXlsb2FkTWVtYmVyKHJlc3ApIHsKICAgICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgICAgdmFyIG9wZXJhdGlvbk5hbWUgPSByZXEub3BlcmF0aW9uOwogICAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbb3BlcmF0aW9uTmFtZV07CiAgICAgIHZhciBvdXRwdXQgPSBvcGVyYXRpb24ub3V0cHV0OwogICAgICBpZiAob3V0cHV0LnBheWxvYWQgJiYgIW9wZXJhdGlvbi5oYXNFdmVudE91dHB1dCkgewogICAgICAgIHZhciBwYXlsb2FkTWVtYmVyID0gb3V0cHV0Lm1lbWJlcnNbb3V0cHV0LnBheWxvYWRdOwogICAgICAgIHZhciByZXNwb25zZVBheWxvYWQgPSByZXNwLmRhdGFbb3V0cHV0LnBheWxvYWRdOwogICAgICAgIGlmIChwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgICAgICB1dGlsLmVhY2gocmVzcG9uc2VQYXlsb2FkLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIHV0aWwucHJvcGVydHkocmVzcC5kYXRhLCBrZXksIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIENvbXB1dGUgU0hBLTI1NiBjaGVja3N1bXMgb2Ygc3RyZWFtcwogICAgICoKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjb21wdXRlU2hhMjU2OiBmdW5jdGlvbiBjb21wdXRlU2hhMjU2KGJvZHksIGRvbmUpIHsKICAgICAgaWYgKHV0aWwuaXNOb2RlKCkpIHsKICAgICAgICB2YXIgU3RyZWFtID0gdXRpbC5zdHJlYW0uU3RyZWFtOwogICAgICAgIHZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7CiAgICAgICAgaWYgKHR5cGVvZiBTdHJlYW0gPT09ICdmdW5jdGlvbicgJiYgYm9keSBpbnN0YW5jZW9mIFN0cmVhbSkgewogICAgICAgICAgaWYgKHR5cGVvZiBib2R5LnBhdGggPT09ICdzdHJpbmcnKSB7IC8vIGFzc3VtZSBmaWxlIG9iamVjdAogICAgICAgICAgICB2YXIgc2V0dGluZ3MgPSB7fTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBib2R5LnN0YXJ0ID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgIHNldHRpbmdzLnN0YXJ0ID0gYm9keS5zdGFydDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGJvZHkuZW5kID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgIHNldHRpbmdzLmVuZCA9IGJvZHkuZW5kOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJvZHkgPSBmcy5jcmVhdGVSZWFkU3RyZWFtKGJvZHkucGF0aCwgc2V0dGluZ3MpOwogICAgICAgICAgfSBlbHNlIHsgLy8gVE9ETyBzdXBwb3J0IG90aGVyIHN0cmVhbSB0eXBlcwogICAgICAgICAgICByZXR1cm4gZG9uZShuZXcgRXJyb3IoJ05vbi1maWxlIHN0cmVhbSBvYmplY3RzIGFyZSAnICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdub3Qgc3VwcG9ydGVkIHdpdGggU2lnVjQnKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHV0aWwuY3J5cHRvLnNoYTI1Nihib2R5LCAnaGV4JywgZnVuY3Rpb24oZXJyLCBzaGEpIHsKICAgICAgICBpZiAoZXJyKSBkb25lKGVycik7CiAgICAgICAgZWxzZSBkb25lKG51bGwsIHNoYSk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGlzQ2xvY2tTa2V3ZWQ6IGZ1bmN0aW9uIGlzQ2xvY2tTa2V3ZWQoc2VydmVyVGltZSkgewogICAgICBpZiAoc2VydmVyVGltZSkgewogICAgICAgIHV0aWwucHJvcGVydHkoQVdTLmNvbmZpZywgJ2lzQ2xvY2tTa2V3ZWQnLAogICAgICAgICAgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSBzZXJ2ZXJUaW1lKSA+PSAzMDAwMDAsIGZhbHNlKTsKICAgICAgICByZXR1cm4gQVdTLmNvbmZpZy5pc0Nsb2NrU2tld2VkOwogICAgICB9CiAgICB9LAogIAogICAgYXBwbHlDbG9ja09mZnNldDogZnVuY3Rpb24gYXBwbHlDbG9ja09mZnNldChzZXJ2ZXJUaW1lKSB7CiAgICAgIGlmIChzZXJ2ZXJUaW1lKQogICAgICAgIEFXUy5jb25maWcuc3lzdGVtQ2xvY2tPZmZzZXQgPSBzZXJ2ZXJUaW1lIC0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZXh0cmFjdFJlcXVlc3RJZDogZnVuY3Rpb24gZXh0cmFjdFJlcXVlc3RJZChyZXNwKSB7CiAgICAgIHZhciByZXF1ZXN0SWQgPSByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtei1yZXF1ZXN0LWlkJ10gfHwKICAgICAgICAgICAgICAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtem4tcmVxdWVzdGlkJ107CiAgCiAgICAgIGlmICghcmVxdWVzdElkICYmIHJlc3AuZGF0YSAmJiByZXNwLmRhdGEuUmVzcG9uc2VNZXRhZGF0YSkgewogICAgICAgIHJlcXVlc3RJZCA9IHJlc3AuZGF0YS5SZXNwb25zZU1ldGFkYXRhLlJlcXVlc3RJZDsKICAgICAgfQogIAogICAgICBpZiAocmVxdWVzdElkKSB7CiAgICAgICAgcmVzcC5yZXF1ZXN0SWQgPSByZXF1ZXN0SWQ7CiAgICAgIH0KICAKICAgICAgaWYgKHJlc3AuZXJyb3IpIHsKICAgICAgICByZXNwLmVycm9yLnJlcXVlc3RJZCA9IHJlcXVlc3RJZDsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFkZFByb21pc2VzOiBmdW5jdGlvbiBhZGRQcm9taXNlcyhjb25zdHJ1Y3RvcnMsIFByb21pc2VEZXBlbmRlbmN5KSB7CiAgICAgIHZhciBkZWxldGVQcm9taXNlcyA9IGZhbHNlOwogICAgICBpZiAoUHJvbWlzZURlcGVuZGVuY3kgPT09IHVuZGVmaW5lZCAmJiBBV1MgJiYgQVdTLmNvbmZpZykgewogICAgICAgIFByb21pc2VEZXBlbmRlbmN5ID0gQVdTLmNvbmZpZy5nZXRQcm9taXNlc0RlcGVuZGVuY3koKTsKICAgICAgfQogICAgICBpZiAoUHJvbWlzZURlcGVuZGVuY3kgPT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgUHJvbWlzZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICBQcm9taXNlRGVwZW5kZW5jeSA9IFByb21pc2U7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBQcm9taXNlRGVwZW5kZW5jeSAhPT0gJ2Z1bmN0aW9uJykgZGVsZXRlUHJvbWlzZXMgPSB0cnVlOwogICAgICBpZiAoIUFycmF5LmlzQXJyYXkoY29uc3RydWN0b3JzKSkgY29uc3RydWN0b3JzID0gW2NvbnN0cnVjdG9yc107CiAgCiAgICAgIGZvciAodmFyIGluZCA9IDA7IGluZCA8IGNvbnN0cnVjdG9ycy5sZW5ndGg7IGluZCsrKSB7CiAgICAgICAgdmFyIGNvbnN0cnVjdG9yID0gY29uc3RydWN0b3JzW2luZF07CiAgICAgICAgaWYgKGRlbGV0ZVByb21pc2VzKSB7CiAgICAgICAgICBpZiAoY29uc3RydWN0b3IuZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MpIHsKICAgICAgICAgICAgY29uc3RydWN0b3IuZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MoKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGNvbnN0cnVjdG9yLmFkZFByb21pc2VzVG9DbGFzcykgewogICAgICAgICAgY29uc3RydWN0b3IuYWRkUHJvbWlzZXNUb0NsYXNzKFByb21pc2VEZXBlbmRlbmN5KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICogUmV0dXJuIGEgZnVuY3Rpb24gdGhhdCB3aWxsIHJldHVybiBhIHByb21pc2Ugd2hvc2UgZmF0ZSBpcyBkZWNpZGVkIGJ5IHRoZQogICAgICogY2FsbGJhY2sgYmVoYXZpb3Igb2YgdGhlIGdpdmVuIG1ldGhvZCB3aXRoIGBtZXRob2ROYW1lYC4gVGhlIG1ldGhvZCB0byBiZQogICAgICogcHJvbWlzaWZpZWQgc2hvdWxkIGNvbmZvcm0gdG8gbm9kZS5qcyBjb252ZW50aW9uIG9mIGFjY2VwdGluZyBhIGNhbGxiYWNrIGFzCiAgICAgKiBsYXN0IGFyZ3VtZW50IGFuZCBjYWxsaW5nIHRoYXQgY2FsbGJhY2sgd2l0aCBlcnJvciBhcyB0aGUgZmlyc3QgYXJndW1lbnQKICAgICAqIGFuZCBzdWNjZXNzIHZhbHVlIG9uIHRoZSBzZWNvbmQgYXJndW1lbnQuCiAgICAgKi8KICAgIHByb21pc2lmeU1ldGhvZDogZnVuY3Rpb24gcHJvbWlzaWZ5TWV0aG9kKG1ldGhvZE5hbWUsIFByb21pc2VEZXBlbmRlbmN5KSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiBwcm9taXNlKCkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlRGVwZW5kZW5jeShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIGFyZ3MucHVzaChmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgc2VsZlttZXRob2ROYW1lXS5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBpc0R1YWxzdGFja0F2YWlsYWJsZTogZnVuY3Rpb24gaXNEdWFsc3RhY2tBdmFpbGFibGUoc2VydmljZSkgewogICAgICBpZiAoIXNlcnZpY2UpIHJldHVybiBmYWxzZTsKICAgICAgdmFyIG1ldGFkYXRhID0gcmVxdWlyZSgnLi4vYXBpcy9tZXRhZGF0YS5qc29uJyk7CiAgICAgIGlmICh0eXBlb2Ygc2VydmljZSAhPT0gJ3N0cmluZycpIHNlcnZpY2UgPSBzZXJ2aWNlLnNlcnZpY2VJZGVudGlmaWVyOwogICAgICBpZiAodHlwZW9mIHNlcnZpY2UgIT09ICdzdHJpbmcnIHx8ICFtZXRhZGF0YS5oYXNPd25Qcm9wZXJ0eShzZXJ2aWNlKSkgcmV0dXJuIGZhbHNlOwogICAgICByZXR1cm4gISFtZXRhZGF0YVtzZXJ2aWNlXS5kdWFsc3RhY2tBdmFpbGFibGU7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY2FsY3VsYXRlUmV0cnlEZWxheTogZnVuY3Rpb24gY2FsY3VsYXRlUmV0cnlEZWxheShyZXRyeUNvdW50LCByZXRyeURlbGF5T3B0aW9ucykgewogICAgICBpZiAoIXJldHJ5RGVsYXlPcHRpb25zKSByZXRyeURlbGF5T3B0aW9ucyA9IHt9OwogICAgICB2YXIgY3VzdG9tQmFja29mZiA9IHJldHJ5RGVsYXlPcHRpb25zLmN1c3RvbUJhY2tvZmYgfHwgbnVsbDsKICAgICAgaWYgKHR5cGVvZiBjdXN0b21CYWNrb2ZmID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIGN1c3RvbUJhY2tvZmYocmV0cnlDb3VudCk7CiAgICAgIH0KICAgICAgdmFyIGJhc2UgPSB0eXBlb2YgcmV0cnlEZWxheU9wdGlvbnMuYmFzZSA9PT0gJ251bWJlcicgPyByZXRyeURlbGF5T3B0aW9ucy5iYXNlIDogMTAwOwogICAgICB2YXIgZGVsYXkgPSBNYXRoLnJhbmRvbSgpICogKE1hdGgucG93KDIsIHJldHJ5Q291bnQpICogYmFzZSk7CiAgICAgIHJldHVybiBkZWxheTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBoYW5kbGVSZXF1ZXN0V2l0aFJldHJpZXM6IGZ1bmN0aW9uIGhhbmRsZVJlcXVlc3RXaXRoUmV0cmllcyhodHRwUmVxdWVzdCwgb3B0aW9ucywgY2IpIHsKICAgICAgaWYgKCFvcHRpb25zKSBvcHRpb25zID0ge307CiAgICAgIHZhciBodHRwID0gQVdTLkh0dHBDbGllbnQuZ2V0SW5zdGFuY2UoKTsKICAgICAgdmFyIGh0dHBPcHRpb25zID0gb3B0aW9ucy5odHRwT3B0aW9ucyB8fCB7fTsKICAgICAgdmFyIHJldHJ5Q291bnQgPSAwOwogIAogICAgICB2YXIgZXJyQ2FsbGJhY2sgPSBmdW5jdGlvbihlcnIpIHsKICAgICAgICB2YXIgbWF4UmV0cmllcyA9IG9wdGlvbnMubWF4UmV0cmllcyB8fCAwOwogICAgICAgIGlmIChlcnIgJiYgZXJyLmNvZGUgPT09ICdUaW1lb3V0RXJyb3InKSBlcnIucmV0cnlhYmxlID0gdHJ1ZTsKICAgICAgICBpZiAoZXJyICYmIGVyci5yZXRyeWFibGUgJiYgcmV0cnlDb3VudCA8IG1heFJldHJpZXMpIHsKICAgICAgICAgIHJldHJ5Q291bnQrKzsKICAgICAgICAgIHZhciBkZWxheSA9IHV0aWwuY2FsY3VsYXRlUmV0cnlEZWxheShyZXRyeUNvdW50LCBvcHRpb25zLnJldHJ5RGVsYXlPcHRpb25zKTsKICAgICAgICAgIHNldFRpbWVvdXQoc2VuZFJlcXVlc3QsIGRlbGF5ICsgKGVyci5yZXRyeUFmdGVyIHx8IDApKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2IoZXJyKTsKICAgICAgICB9CiAgICAgIH07CiAgCiAgICAgIHZhciBzZW5kUmVxdWVzdCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBkYXRhID0gJyc7CiAgICAgICAgaHR0cC5oYW5kbGVSZXF1ZXN0KGh0dHBSZXF1ZXN0LCBodHRwT3B0aW9ucywgZnVuY3Rpb24oaHR0cFJlc3BvbnNlKSB7CiAgICAgICAgICBodHRwUmVzcG9uc2Uub24oJ2RhdGEnLCBmdW5jdGlvbihjaHVuaykgeyBkYXRhICs9IGNodW5rLnRvU3RyaW5nKCk7IH0pOwogICAgICAgICAgaHR0cFJlc3BvbnNlLm9uKCdlbmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHN0YXR1c0NvZGUgPSBodHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICAgICAgaWYgKHN0YXR1c0NvZGUgPCAzMDApIHsKICAgICAgICAgICAgICBjYihudWxsLCBkYXRhKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgcmV0cnlBZnRlciA9IHBhcnNlSW50KGh0dHBSZXNwb25zZS5oZWFkZXJzWydyZXRyeS1hZnRlciddLCAxMCkgKiAxMDAwIHx8IDA7CiAgICAgICAgICAgICAgdmFyIGVyciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksCiAgICAgICAgICAgICAgICB7IHJldHJ5YWJsZTogc3RhdHVzQ29kZSA+PSA1MDAgfHwgc3RhdHVzQ29kZSA9PT0gNDI5IH0KICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChyZXRyeUFmdGVyICYmIGVyci5yZXRyeWFibGUpIGVyci5yZXRyeUFmdGVyID0gcmV0cnlBZnRlcjsKICAgICAgICAgICAgICBlcnJDYWxsYmFjayhlcnIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9LCBlcnJDYWxsYmFjayk7CiAgICAgIH07CiAgCiAgICAgIEFXUy51dGlsLmRlZmVyKHNlbmRSZXF1ZXN0KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICB1dWlkOiB7CiAgICAgIHY0OiBmdW5jdGlvbiB1dWlkVjQoKSB7CiAgICAgICAgcmV0dXJuIHJlcXVpcmUoJ3V1aWQnKS52NCgpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY29udmVydFBheWxvYWRUb1N0cmluZzogZnVuY3Rpb24gY29udmVydFBheWxvYWRUb1N0cmluZyhyZXNwKSB7CiAgICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICAgIHZhciBvcGVyYXRpb24gPSByZXEub3BlcmF0aW9uOwogICAgICB2YXIgcnVsZXMgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tvcGVyYXRpb25dLm91dHB1dCB8fCB7fTsKICAgICAgaWYgKHJ1bGVzLnBheWxvYWQgJiYgcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdKSB7CiAgICAgICAgcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdID0gcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdLnRvU3RyaW5nKCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBkZWZlcjogZnVuY3Rpb24gZGVmZXIoY2FsbGJhY2spIHsKICAgICAgaWYgKHR5cGVvZiBwcm9jZXNzID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgcHJvY2Vzcy5uZXh0VGljayA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHByb2Nlc3MubmV4dFRpY2soY2FsbGJhY2spOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzZXRJbW1lZGlhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBzZXRJbW1lZGlhdGUoY2FsbGJhY2spOwogICAgICB9IGVsc2UgewogICAgICAgIHNldFRpbWVvdXQoY2FsbGJhY2ssIDApOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0UmVxdWVzdFBheWxvYWRTaGFwZTogZnVuY3Rpb24gZ2V0UmVxdWVzdFBheWxvYWRTaGFwZShyZXEpIHsKICAgICAgdmFyIG9wZXJhdGlvbnMgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uczsKICAgICAgaWYgKCFvcGVyYXRpb25zKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICB2YXIgb3BlcmF0aW9uID0gKG9wZXJhdGlvbnMgfHwge30pW3JlcS5vcGVyYXRpb25dOwogICAgICBpZiAoIW9wZXJhdGlvbiB8fCAhb3BlcmF0aW9uLmlucHV0IHx8ICFvcGVyYXRpb24uaW5wdXQucGF5bG9hZCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgcmV0dXJuIG9wZXJhdGlvbi5pbnB1dC5tZW1iZXJzW29wZXJhdGlvbi5pbnB1dC5wYXlsb2FkXTsKICAgIH0sCiAgCiAgICBnZXRQcm9maWxlc0Zyb21TaGFyZWRDb25maWc6IGZ1bmN0aW9uIGdldFByb2ZpbGVzRnJvbVNoYXJlZENvbmZpZyhpbmlMb2FkZXIsIGZpbGVuYW1lKSB7CiAgICAgIHZhciBwcm9maWxlcyA9IHt9OwogICAgICB2YXIgcHJvZmlsZXNGcm9tQ29uZmlnID0ge307CiAgICAgIGlmIChwcm9jZXNzLmVudlt1dGlsLmNvbmZpZ09wdEluRW52XSkgewogICAgICAgIHZhciBwcm9maWxlc0Zyb21Db25maWcgPSBpbmlMb2FkZXIubG9hZEZyb20oewogICAgICAgICAgaXNDb25maWc6IHRydWUsCiAgICAgICAgICBmaWxlbmFtZTogcHJvY2Vzcy5lbnZbdXRpbC5zaGFyZWRDb25maWdGaWxlRW52XQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHZhciBwcm9maWxlc0Zyb21DcmVkcyA9IGluaUxvYWRlci5sb2FkRnJvbSh7CiAgICAgICAgZmlsZW5hbWU6IGZpbGVuYW1lIHx8CiAgICAgICAgICAocHJvY2Vzcy5lbnZbdXRpbC5jb25maWdPcHRJbkVudl0gJiYgcHJvY2Vzcy5lbnZbdXRpbC5zaGFyZWRDcmVkZW50aWFsc0ZpbGVFbnZdKQogICAgICB9KTsKICAgICAgZm9yICh2YXIgaSA9IDAsIHByb2ZpbGVOYW1lcyA9IE9iamVjdC5rZXlzKHByb2ZpbGVzRnJvbUNvbmZpZyk7IGkgPCBwcm9maWxlTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBwcm9maWxlc1twcm9maWxlTmFtZXNbaV1dID0gcHJvZmlsZXNGcm9tQ29uZmlnW3Byb2ZpbGVOYW1lc1tpXV07CiAgICAgIH0KICAgICAgZm9yICh2YXIgaSA9IDAsIHByb2ZpbGVOYW1lcyA9IE9iamVjdC5rZXlzKHByb2ZpbGVzRnJvbUNyZWRzKTsgaSA8IHByb2ZpbGVOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgIHByb2ZpbGVzW3Byb2ZpbGVOYW1lc1tpXV0gPSBwcm9maWxlc0Zyb21DcmVkc1twcm9maWxlTmFtZXNbaV1dOwogICAgICB9CiAgICAgIHJldHVybiBwcm9maWxlczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBkZWZhdWx0UHJvZmlsZTogJ2RlZmF1bHQnLAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY29uZmlnT3B0SW5FbnY6ICdBV1NfU0RLX0xPQURfQ09ORklHJywKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNoYXJlZENyZWRlbnRpYWxzRmlsZUVudjogJ0FXU19TSEFSRURfQ1JFREVOVElBTFNfRklMRScsCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzaGFyZWRDb25maWdGaWxlRW52OiAnQVdTX0NPTkZJR19GSUxFJywKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGltZHNEaXNhYmxlZEVudjogJ0FXU19FQzJfTUVUQURBVEFfRElTQUJMRUQnCiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHV0aWw7CiAgCiAgfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykscmVxdWlyZSgidGltZXJzIikuc2V0SW1tZWRpYXRlKQogIH0seyIuLi9hcGlzL21ldGFkYXRhLmpzb24iOjQsIi4vY29yZSI6MTgsIl9wcm9jZXNzIjo4NSwiZnMiOjc5LCJ0aW1lcnMiOjkzLCJ1dWlkIjo5OH1dLDcyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgU2hhcGUgPSByZXF1aXJlKCcuLi9tb2RlbC9zaGFwZScpOwogIAogIGZ1bmN0aW9uIERvbVhtbFBhcnNlcigpIHsgfQogIAogIERvbVhtbFBhcnNlci5wcm90b3R5cGUucGFyc2UgPSBmdW5jdGlvbih4bWwsIHNoYXBlKSB7CiAgICBpZiAoeG1sLnJlcGxhY2UoL15ccysvLCAnJykgPT09ICcnKSByZXR1cm4ge307CiAgCiAgICB2YXIgcmVzdWx0LCBlcnJvcjsKICAgIHRyeSB7CiAgICAgIGlmICh3aW5kb3cuRE9NUGFyc2VyKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBwYXJzZXIgPSBuZXcgRE9NUGFyc2VyKCk7CiAgICAgICAgICByZXN1bHQgPSBwYXJzZXIucGFyc2VGcm9tU3RyaW5nKHhtbCwgJ3RleHQveG1sJyk7CiAgICAgICAgfSBjYXRjaCAoc3ludGF4RXJyb3IpIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdQYXJzZSBlcnJvciBpbiBkb2N1bWVudCcpLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgb3JpZ2luYWxFcnJvcjogc3ludGF4RXJyb3IsCiAgICAgICAgICAgICAgY29kZTogJ1hNTFBhcnNlckVycm9yJywKICAgICAgICAgICAgICByZXRyeWFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogIAogICAgICAgIGlmIChyZXN1bHQuZG9jdW1lbnRFbGVtZW50ID09PSBudWxsKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignQ2Fubm90IHBhcnNlIGVtcHR5IGRvY3VtZW50LicpLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29kZTogJ1hNTFBhcnNlckVycm9yJywKICAgICAgICAgICAgICByZXRyeWFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogIAogICAgICAgIHZhciBpc0Vycm9yID0gcmVzdWx0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdwYXJzZXJlcnJvcicpWzBdOwogICAgICAgIGlmIChpc0Vycm9yICYmIChpc0Vycm9yLnBhcmVudE5vZGUgPT09IHJlc3VsdCB8fAogICAgICAgICAgICBpc0Vycm9yLnBhcmVudE5vZGUubm9kZU5hbWUgPT09ICdib2R5JyB8fAogICAgICAgICAgICBpc0Vycm9yLnBhcmVudE5vZGUucGFyZW50Tm9kZSA9PT0gcmVzdWx0IHx8CiAgICAgICAgICAgIGlzRXJyb3IucGFyZW50Tm9kZS5wYXJlbnROb2RlLm5vZGVOYW1lID09PSAnYm9keScpKSB7CiAgICAgICAgICB2YXIgZXJyb3JFbGVtZW50ID0gaXNFcnJvci5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZGl2JylbMF0gfHwgaXNFcnJvcjsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKGVycm9yRWxlbWVudC50ZXh0Q29udGVudCB8fCAnUGFyc2VyIGVycm9yIGluIGRvY3VtZW50JyksCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjb2RlOiAnWE1MUGFyc2VyRXJyb3InLAogICAgICAgICAgICAgIHJldHJ5YWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAod2luZG93LkFjdGl2ZVhPYmplY3QpIHsKICAgICAgICByZXN1bHQgPSBuZXcgd2luZG93LkFjdGl2ZVhPYmplY3QoJ01pY3Jvc29mdC5YTUxET00nKTsKICAgICAgICByZXN1bHQuYXN5bmMgPSBmYWxzZTsKICAKICAgICAgICBpZiAoIXJlc3VsdC5sb2FkWE1MKHhtbCkpIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdQYXJzZSBlcnJvciBpbiBkb2N1bWVudCcpLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29kZTogJ1hNTFBhcnNlckVycm9yJywKICAgICAgICAgICAgICByZXRyeWFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGxvYWQgWE1MIHBhcnNlcicpOwogICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGVycm9yID0gZTsKICAgIH0KICAKICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0LmRvY3VtZW50RWxlbWVudCAmJiAhZXJyb3IpIHsKICAgICAgdmFyIGRhdGEgPSBwYXJzZVhtbChyZXN1bHQuZG9jdW1lbnRFbGVtZW50LCBzaGFwZSk7CiAgICAgIHZhciBtZXRhZGF0YSA9IGdldEVsZW1lbnRCeVRhZ05hbWUocmVzdWx0LmRvY3VtZW50RWxlbWVudCwgJ1Jlc3BvbnNlTWV0YWRhdGEnKTsKICAgICAgaWYgKG1ldGFkYXRhKSB7CiAgICAgICAgZGF0YS5SZXNwb25zZU1ldGFkYXRhID0gcGFyc2VYbWwobWV0YWRhdGEsIHt9KTsKICAgICAgfQogICAgICByZXR1cm4gZGF0YTsKICAgIH0gZWxzZSBpZiAoZXJyb3IpIHsKICAgICAgdGhyb3cgdXRpbC5lcnJvcihlcnJvciB8fCBuZXcgRXJyb3IoKSwge2NvZGU6ICdYTUxQYXJzZXJFcnJvcicsIHJldHJ5YWJsZTogdHJ1ZX0pOwogICAgfSBlbHNlIHsgLy8gZW1wdHkgeG1sIGRvY3VtZW50CiAgICAgIHJldHVybiB7fTsKICAgIH0KICB9OwogIAogIGZ1bmN0aW9uIGdldEVsZW1lbnRCeVRhZ05hbWUoeG1sLCB0YWcpIHsKICAgIHZhciBlbGVtZW50cyA9IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpOwogICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBlbGVtZW50cy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgaWYgKGVsZW1lbnRzW2ldLnBhcmVudE5vZGUgPT09IHhtbCkgewogICAgICAgIHJldHVybiBlbGVtZW50c1tpXTsKICAgICAgfQogICAgfQogIH0KICAKICBmdW5jdGlvbiBwYXJzZVhtbCh4bWwsIHNoYXBlKSB7CiAgICBpZiAoIXNoYXBlKSBzaGFwZSA9IHt9OwogICAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICAgIGNhc2UgJ3N0cnVjdHVyZSc6IHJldHVybiBwYXJzZVN0cnVjdHVyZSh4bWwsIHNoYXBlKTsKICAgICAgY2FzZSAnbWFwJzogcmV0dXJuIHBhcnNlTWFwKHhtbCwgc2hhcGUpOwogICAgICBjYXNlICdsaXN0JzogcmV0dXJuIHBhcnNlTGlzdCh4bWwsIHNoYXBlKTsKICAgICAgY2FzZSB1bmRlZmluZWQ6IGNhc2UgbnVsbDogcmV0dXJuIHBhcnNlVW5rbm93bih4bWwpOwogICAgICBkZWZhdWx0OiByZXR1cm4gcGFyc2VTY2FsYXIoeG1sLCBzaGFwZSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIHBhcnNlU3RydWN0dXJlKHhtbCwgc2hhcGUpIHsKICAgIHZhciBkYXRhID0ge307CiAgICBpZiAoeG1sID09PSBudWxsKSByZXR1cm4gZGF0YTsKICAKICAgIHV0aWwuZWFjaChzaGFwZS5tZW1iZXJzLCBmdW5jdGlvbihtZW1iZXJOYW1lLCBtZW1iZXJTaGFwZSkgewogICAgICBpZiAobWVtYmVyU2hhcGUuaXNYbWxBdHRyaWJ1dGUpIHsKICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHhtbC5hdHRyaWJ1dGVzLCBtZW1iZXJTaGFwZS5uYW1lKSkgewogICAgICAgICAgdmFyIHZhbHVlID0geG1sLmF0dHJpYnV0ZXNbbWVtYmVyU2hhcGUubmFtZV0udmFsdWU7CiAgICAgICAgICBkYXRhW21lbWJlck5hbWVdID0gcGFyc2VYbWwoe3RleHRDb250ZW50OiB2YWx1ZX0sIG1lbWJlclNoYXBlKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHhtbENoaWxkID0gbWVtYmVyU2hhcGUuZmxhdHRlbmVkID8geG1sIDoKICAgICAgICAgIGdldEVsZW1lbnRCeVRhZ05hbWUoeG1sLCBtZW1iZXJTaGFwZS5uYW1lKTsKICAgICAgICBpZiAoeG1sQ2hpbGQpIHsKICAgICAgICAgIGRhdGFbbWVtYmVyTmFtZV0gPSBwYXJzZVhtbCh4bWxDaGlsZCwgbWVtYmVyU2hhcGUpOwogICAgICAgIH0gZWxzZSBpZiAoIW1lbWJlclNoYXBlLmZsYXR0ZW5lZCAmJiBtZW1iZXJTaGFwZS50eXBlID09PSAnbGlzdCcpIHsKICAgICAgICAgIGRhdGFbbWVtYmVyTmFtZV0gPSBtZW1iZXJTaGFwZS5kZWZhdWx0VmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAKICAgIHJldHVybiBkYXRhOwogIH0KICAKICBmdW5jdGlvbiBwYXJzZU1hcCh4bWwsIHNoYXBlKSB7CiAgICB2YXIgZGF0YSA9IHt9OwogICAgdmFyIHhtbEtleSA9IHNoYXBlLmtleS5uYW1lIHx8ICdrZXknOwogICAgdmFyIHhtbFZhbHVlID0gc2hhcGUudmFsdWUubmFtZSB8fCAndmFsdWUnOwogICAgdmFyIHRhZ05hbWUgPSBzaGFwZS5mbGF0dGVuZWQgPyBzaGFwZS5uYW1lIDogJ2VudHJ5JzsKICAKICAgIHZhciBjaGlsZCA9IHhtbC5maXJzdEVsZW1lbnRDaGlsZDsKICAgIHdoaWxlIChjaGlsZCkgewogICAgICBpZiAoY2hpbGQubm9kZU5hbWUgPT09IHRhZ05hbWUpIHsKICAgICAgICB2YXIga2V5ID0gZ2V0RWxlbWVudEJ5VGFnTmFtZShjaGlsZCwgeG1sS2V5KS50ZXh0Q29udGVudDsKICAgICAgICB2YXIgdmFsdWUgPSBnZXRFbGVtZW50QnlUYWdOYW1lKGNoaWxkLCB4bWxWYWx1ZSk7CiAgICAgICAgZGF0YVtrZXldID0gcGFyc2VYbWwodmFsdWUsIHNoYXBlLnZhbHVlKTsKICAgICAgfQogICAgICBjaGlsZCA9IGNoaWxkLm5leHRFbGVtZW50U2libGluZzsKICAgIH0KICAgIHJldHVybiBkYXRhOwogIH0KICAKICBmdW5jdGlvbiBwYXJzZUxpc3QoeG1sLCBzaGFwZSkgewogICAgdmFyIGRhdGEgPSBbXTsKICAgIHZhciB0YWdOYW1lID0gc2hhcGUuZmxhdHRlbmVkID8gc2hhcGUubmFtZSA6IChzaGFwZS5tZW1iZXIubmFtZSB8fCAnbWVtYmVyJyk7CiAgCiAgICB2YXIgY2hpbGQgPSB4bWwuZmlyc3RFbGVtZW50Q2hpbGQ7CiAgICB3aGlsZSAoY2hpbGQpIHsKICAgICAgaWYgKGNoaWxkLm5vZGVOYW1lID09PSB0YWdOYW1lKSB7CiAgICAgICAgZGF0YS5wdXNoKHBhcnNlWG1sKGNoaWxkLCBzaGFwZS5tZW1iZXIpKTsKICAgICAgfQogICAgICBjaGlsZCA9IGNoaWxkLm5leHRFbGVtZW50U2libGluZzsKICAgIH0KICAgIHJldHVybiBkYXRhOwogIH0KICAKICBmdW5jdGlvbiBwYXJzZVNjYWxhcih4bWwsIHNoYXBlKSB7CiAgICBpZiAoeG1sLmdldEF0dHJpYnV0ZSkgewogICAgICB2YXIgZW5jb2RpbmcgPSB4bWwuZ2V0QXR0cmlidXRlKCdlbmNvZGluZycpOwogICAgICBpZiAoZW5jb2RpbmcgPT09ICdiYXNlNjQnKSB7CiAgICAgICAgc2hhcGUgPSBuZXcgU2hhcGUuY3JlYXRlKHt0eXBlOiBlbmNvZGluZ30pOwogICAgICB9CiAgICB9CiAgCiAgICB2YXIgdGV4dCA9IHhtbC50ZXh0Q29udGVudDsKICAgIGlmICh0ZXh0ID09PSAnJykgdGV4dCA9IG51bGw7CiAgICBpZiAodHlwZW9mIHNoYXBlLnRvVHlwZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICByZXR1cm4gc2hhcGUudG9UeXBlKHRleHQpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIHBhcnNlVW5rbm93bih4bWwpIHsKICAgIGlmICh4bWwgPT09IHVuZGVmaW5lZCB8fCB4bWwgPT09IG51bGwpIHJldHVybiAnJzsKICAKICAgIC8vIGVtcHR5IG9iamVjdAogICAgaWYgKCF4bWwuZmlyc3RFbGVtZW50Q2hpbGQpIHsKICAgICAgaWYgKHhtbC5wYXJlbnROb2RlLnBhcmVudE5vZGUgPT09IG51bGwpIHJldHVybiB7fTsKICAgICAgaWYgKHhtbC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuICcnOwogICAgICBlbHNlIHJldHVybiB4bWwudGV4dENvbnRlbnQ7CiAgICB9CiAgCiAgICAvLyBvYmplY3QsIHBhcnNlIGFzIHN0cnVjdHVyZQogICAgdmFyIHNoYXBlID0ge3R5cGU6ICdzdHJ1Y3R1cmUnLCBtZW1iZXJzOiB7fX07CiAgICB2YXIgY2hpbGQgPSB4bWwuZmlyc3RFbGVtZW50Q2hpbGQ7CiAgICB3aGlsZSAoY2hpbGQpIHsKICAgICAgdmFyIHRhZyA9IGNoaWxkLm5vZGVOYW1lOwogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNoYXBlLm1lbWJlcnMsIHRhZykpIHsKICAgICAgICAvLyBtdWx0aXBsZSB0YWdzIG9mIHRoZSBzYW1lIG5hbWUgbWFrZXMgaXQgYSBsaXN0CiAgICAgICAgc2hhcGUubWVtYmVyc1t0YWddLnR5cGUgPSAnbGlzdCc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2hhcGUubWVtYmVyc1t0YWddID0ge25hbWU6IHRhZ307CiAgICAgIH0KICAgICAgY2hpbGQgPSBjaGlsZC5uZXh0RWxlbWVudFNpYmxpbmc7CiAgICB9CiAgICByZXR1cm4gcGFyc2VTdHJ1Y3R1cmUoeG1sLCBzaGFwZSk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gRG9tWG1sUGFyc2VyOwogIAogIH0seyIuLi9tb2RlbC9zaGFwZSI6NDMsIi4uL3V0aWwiOjcxfV0sNzM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBYbWxOb2RlID0gcmVxdWlyZSgnLi94bWwtbm9kZScpLlhtbE5vZGU7CiAgdmFyIFhtbFRleHQgPSByZXF1aXJlKCcuL3htbC10ZXh0JykuWG1sVGV4dDsKICAKICBmdW5jdGlvbiBYbWxCdWlsZGVyKCkgeyB9CiAgCiAgWG1sQnVpbGRlci5wcm90b3R5cGUudG9YTUwgPSBmdW5jdGlvbihwYXJhbXMsIHNoYXBlLCByb290RWxlbWVudCwgbm9FbXB0eSkgewogICAgdmFyIHhtbCA9IG5ldyBYbWxOb2RlKHJvb3RFbGVtZW50KTsKICAgIGFwcGx5TmFtZXNwYWNlcyh4bWwsIHNoYXBlLCB0cnVlKTsKICAgIHNlcmlhbGl6ZSh4bWwsIHBhcmFtcywgc2hhcGUpOwogICAgcmV0dXJuIHhtbC5jaGlsZHJlbi5sZW5ndGggPiAwIHx8IG5vRW1wdHkgPyB4bWwudG9TdHJpbmcoKSA6ICcnOwogIH07CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplKHhtbCwgdmFsdWUsIHNoYXBlKSB7CiAgICBzd2l0Y2ggKHNoYXBlLnR5cGUpIHsKICAgICAgY2FzZSAnc3RydWN0dXJlJzogcmV0dXJuIHNlcmlhbGl6ZVN0cnVjdHVyZSh4bWwsIHZhbHVlLCBzaGFwZSk7CiAgICAgIGNhc2UgJ21hcCc6IHJldHVybiBzZXJpYWxpemVNYXAoeG1sLCB2YWx1ZSwgc2hhcGUpOwogICAgICBjYXNlICdsaXN0JzogcmV0dXJuIHNlcmlhbGl6ZUxpc3QoeG1sLCB2YWx1ZSwgc2hhcGUpOwogICAgICBkZWZhdWx0OiByZXR1cm4gc2VyaWFsaXplU2NhbGFyKHhtbCwgdmFsdWUsIHNoYXBlKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplU3RydWN0dXJlKHhtbCwgcGFyYW1zLCBzaGFwZSkgewogICAgdXRpbC5hcnJheUVhY2goc2hhcGUubWVtYmVyTmFtZXMsIGZ1bmN0aW9uKG1lbWJlck5hbWUpIHsKICAgICAgdmFyIG1lbWJlclNoYXBlID0gc2hhcGUubWVtYmVyc1ttZW1iZXJOYW1lXTsKICAgICAgaWYgKG1lbWJlclNoYXBlLmxvY2F0aW9uICE9PSAnYm9keScpIHJldHVybjsKICAKICAgICAgdmFyIHZhbHVlID0gcGFyYW1zW21lbWJlck5hbWVdOwogICAgICB2YXIgbmFtZSA9IG1lbWJlclNoYXBlLm5hbWU7CiAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgaWYgKG1lbWJlclNoYXBlLmlzWG1sQXR0cmlidXRlKSB7CiAgICAgICAgICB4bWwuYWRkQXR0cmlidXRlKG5hbWUsIHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKG1lbWJlclNoYXBlLmZsYXR0ZW5lZCkgewogICAgICAgICAgc2VyaWFsaXplKHhtbCwgdmFsdWUsIG1lbWJlclNoYXBlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGVsZW1lbnQgPSBuZXcgWG1sTm9kZShuYW1lKTsKICAgICAgICAgIHhtbC5hZGRDaGlsZE5vZGUoZWxlbWVudCk7CiAgICAgICAgICBhcHBseU5hbWVzcGFjZXMoZWxlbWVudCwgbWVtYmVyU2hhcGUpOwogICAgICAgICAgc2VyaWFsaXplKGVsZW1lbnQsIHZhbHVlLCBtZW1iZXJTaGFwZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplTWFwKHhtbCwgbWFwLCBzaGFwZSkgewogICAgdmFyIHhtbEtleSA9IHNoYXBlLmtleS5uYW1lIHx8ICdrZXknOwogICAgdmFyIHhtbFZhbHVlID0gc2hhcGUudmFsdWUubmFtZSB8fCAndmFsdWUnOwogIAogICAgdXRpbC5lYWNoKG1hcCwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICB2YXIgZW50cnkgPSBuZXcgWG1sTm9kZShzaGFwZS5mbGF0dGVuZWQgPyBzaGFwZS5uYW1lIDogJ2VudHJ5Jyk7CiAgICAgIHhtbC5hZGRDaGlsZE5vZGUoZW50cnkpOwogIAogICAgICB2YXIgZW50cnlLZXkgPSBuZXcgWG1sTm9kZSh4bWxLZXkpOwogICAgICB2YXIgZW50cnlWYWx1ZSA9IG5ldyBYbWxOb2RlKHhtbFZhbHVlKTsKICAgICAgZW50cnkuYWRkQ2hpbGROb2RlKGVudHJ5S2V5KTsKICAgICAgZW50cnkuYWRkQ2hpbGROb2RlKGVudHJ5VmFsdWUpOwogIAogICAgICBzZXJpYWxpemUoZW50cnlLZXksIGtleSwgc2hhcGUua2V5KTsKICAgICAgc2VyaWFsaXplKGVudHJ5VmFsdWUsIHZhbHVlLCBzaGFwZS52YWx1ZSk7CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplTGlzdCh4bWwsIGxpc3QsIHNoYXBlKSB7CiAgICBpZiAoc2hhcGUuZmxhdHRlbmVkKSB7CiAgICAgIHV0aWwuYXJyYXlFYWNoKGxpc3QsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIG5hbWUgPSBzaGFwZS5tZW1iZXIubmFtZSB8fCBzaGFwZS5uYW1lOwogICAgICAgIHZhciBlbGVtZW50ID0gbmV3IFhtbE5vZGUobmFtZSk7CiAgICAgICAgeG1sLmFkZENoaWxkTm9kZShlbGVtZW50KTsKICAgICAgICBzZXJpYWxpemUoZWxlbWVudCwgdmFsdWUsIHNoYXBlLm1lbWJlcik7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgdXRpbC5hcnJheUVhY2gobGlzdCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgbmFtZSA9IHNoYXBlLm1lbWJlci5uYW1lIHx8ICdtZW1iZXInOwogICAgICAgIHZhciBlbGVtZW50ID0gbmV3IFhtbE5vZGUobmFtZSk7CiAgICAgICAgeG1sLmFkZENoaWxkTm9kZShlbGVtZW50KTsKICAgICAgICBzZXJpYWxpemUoZWxlbWVudCwgdmFsdWUsIHNoYXBlLm1lbWJlcik7CiAgICAgIH0pOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVTY2FsYXIoeG1sLCB2YWx1ZSwgc2hhcGUpIHsKICAgIHhtbC5hZGRDaGlsZE5vZGUoCiAgICAgIG5ldyBYbWxUZXh0KHNoYXBlLnRvV2lyZUZvcm1hdCh2YWx1ZSkpCiAgICApOwogIH0KICAKICBmdW5jdGlvbiBhcHBseU5hbWVzcGFjZXMoeG1sLCBzaGFwZSwgaXNSb290KSB7CiAgICB2YXIgdXJpLCBwcmVmaXggPSAneG1sbnMnOwogICAgaWYgKHNoYXBlLnhtbE5hbWVzcGFjZVVyaSkgewogICAgICB1cmkgPSBzaGFwZS54bWxOYW1lc3BhY2VVcmk7CiAgICAgIGlmIChzaGFwZS54bWxOYW1lc3BhY2VQcmVmaXgpIHByZWZpeCArPSAnOicgKyBzaGFwZS54bWxOYW1lc3BhY2VQcmVmaXg7CiAgICB9IGVsc2UgaWYgKGlzUm9vdCAmJiBzaGFwZS5hcGkueG1sTmFtZXNwYWNlVXJpKSB7CiAgICAgIHVyaSA9IHNoYXBlLmFwaS54bWxOYW1lc3BhY2VVcmk7CiAgICB9CiAgCiAgICBpZiAodXJpKSB4bWwuYWRkQXR0cmlidXRlKHByZWZpeCwgdXJpKTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBYbWxCdWlsZGVyOwogIAogIH0seyIuLi91dGlsIjo3MSwiLi94bWwtbm9kZSI6NzYsIi4veG1sLXRleHQiOjc3fV0sNzQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8qKgogICAqIEVzY2FwZXMgY2hhcmFjdGVycyB0aGF0IGNhbiBub3QgYmUgaW4gYW4gWE1MIGF0dHJpYnV0ZS4KICAgKi8KICBmdW5jdGlvbiBlc2NhcGVBdHRyaWJ1dGUodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoLyYvZywgJyZhbXA7JykucmVwbGFjZSgvJy9nLCAnJmFwb3M7JykucmVwbGFjZSgvPC9nLCAnJmx0OycpLnJlcGxhY2UoLz4vZywgJyZndDsnKS5yZXBsYWNlKC8iL2csICcmcXVvdDsnKTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGVzY2FwZUF0dHJpYnV0ZTogZXNjYXBlQXR0cmlidXRlCiAgfTsKICAKICB9LHt9XSw3NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLyoqCiAgICogRXNjYXBlcyBjaGFyYWN0ZXJzIHRoYXQgY2FuIG5vdCBiZSBpbiBhbiBYTUwgZWxlbWVudC4KICAgKi8KICBmdW5jdGlvbiBlc2NhcGVFbGVtZW50KHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZS5yZXBsYWNlKC8mL2csICcmYW1wOycpLnJlcGxhY2UoLzwvZywgJyZsdDsnKS5yZXBsYWNlKC8+L2csICcmZ3Q7Jyk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBlc2NhcGVFbGVtZW50OiBlc2NhcGVFbGVtZW50CiAgfTsKICAKICB9LHt9XSw3NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIGVzY2FwZUF0dHJpYnV0ZSA9IHJlcXVpcmUoJy4vZXNjYXBlLWF0dHJpYnV0ZScpLmVzY2FwZUF0dHJpYnV0ZTsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIGFuIFhNTCBub2RlLgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIFhtbE5vZGUobmFtZSwgY2hpbGRyZW4pIHsKICAgICAgaWYgKGNoaWxkcmVuID09PSB2b2lkIDApIHsgY2hpbGRyZW4gPSBbXTsgfQogICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICB0aGlzLmNoaWxkcmVuID0gY2hpbGRyZW47CiAgICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogIH0KICBYbWxOb2RlLnByb3RvdHlwZS5hZGRBdHRyaWJ1dGUgPSBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgdGhpcy5hdHRyaWJ1dGVzW25hbWVdID0gdmFsdWU7CiAgICAgIHJldHVybiB0aGlzOwogIH07CiAgWG1sTm9kZS5wcm90b3R5cGUuYWRkQ2hpbGROb2RlID0gZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgIHRoaXMuY2hpbGRyZW4ucHVzaChjaGlsZCk7CiAgICAgIHJldHVybiB0aGlzOwogIH07CiAgWG1sTm9kZS5wcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgZGVsZXRlIHRoaXMuYXR0cmlidXRlc1tuYW1lXTsKICAgICAgcmV0dXJuIHRoaXM7CiAgfTsKICBYbWxOb2RlLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGhhc0NoaWxkcmVuID0gQm9vbGVhbih0aGlzLmNoaWxkcmVuLmxlbmd0aCk7CiAgICAgIHZhciB4bWxUZXh0ID0gJzwnICsgdGhpcy5uYW1lOwogICAgICAvLyBhZGQgYXR0cmlidXRlcwogICAgICB2YXIgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlczsKICAgICAgZm9yICh2YXIgaSA9IDAsIGF0dHJpYnV0ZU5hbWVzID0gT2JqZWN0LmtleXMoYXR0cmlidXRlcyk7IGkgPCBhdHRyaWJ1dGVOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGF0dHJpYnV0ZU5hbWUgPSBhdHRyaWJ1dGVOYW1lc1tpXTsKICAgICAgICAgIHZhciBhdHRyaWJ1dGUgPSBhdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdOwogICAgICAgICAgaWYgKHR5cGVvZiBhdHRyaWJ1dGUgIT09ICd1bmRlZmluZWQnICYmIGF0dHJpYnV0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHhtbFRleHQgKz0gJyAnICsgYXR0cmlidXRlTmFtZSArICc9XCInICsgZXNjYXBlQXR0cmlidXRlKCcnICsgYXR0cmlidXRlKSArICdcIic7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHhtbFRleHQgKz0gIWhhc0NoaWxkcmVuID8gJy8+JyA6ICc+JyArIHRoaXMuY2hpbGRyZW4ubWFwKGZ1bmN0aW9uIChjKSB7IHJldHVybiBjLnRvU3RyaW5nKCk7IH0pLmpvaW4oJycpICsgJzwvJyArIHRoaXMubmFtZSArICc+JzsKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBYbWxOb2RlOiBYbWxOb2RlCiAgfTsKICAKICB9LHsiLi9lc2NhcGUtYXR0cmlidXRlIjo3NH1dLDc3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgZXNjYXBlRWxlbWVudCA9IHJlcXVpcmUoJy4vZXNjYXBlLWVsZW1lbnQnKS5lc2NhcGVFbGVtZW50OwogIAogIC8qKgogICAqIFJlcHJlc2VudHMgYW4gWE1MIHRleHQgdmFsdWUuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gWG1sVGV4dCh2YWx1ZSkgewogICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgfQogIAogIFhtbFRleHQucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gZXNjYXBlRWxlbWVudCgnJyArIHRoaXMudmFsdWUpOwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIFhtbFRleHQ6IFhtbFRleHQKICB9OwogIAogIH0seyIuL2VzY2FwZS1lbGVtZW50Ijo3NX1dLDc4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAndXNlIHN0cmljdCcKICAKICBleHBvcnRzLmJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoCiAgZXhwb3J0cy50b0J5dGVBcnJheSA9IHRvQnl0ZUFycmF5CiAgZXhwb3J0cy5mcm9tQnl0ZUFycmF5ID0gZnJvbUJ5dGVBcnJheQogIAogIHZhciBsb29rdXAgPSBbXQogIHZhciByZXZMb29rdXAgPSBbXQogIHZhciBBcnIgPSB0eXBlb2YgVWludDhBcnJheSAhPT0gJ3VuZGVmaW5lZCcgPyBVaW50OEFycmF5IDogQXJyYXkKICAKICB2YXIgY29kZSA9ICdBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OSsvJwogIGZvciAodmFyIGkgPSAwLCBsZW4gPSBjb2RlLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICBsb29rdXBbaV0gPSBjb2RlW2ldCiAgICByZXZMb29rdXBbY29kZS5jaGFyQ29kZUF0KGkpXSA9IGkKICB9CiAgCiAgLy8gU3VwcG9ydCBkZWNvZGluZyBVUkwtc2FmZSBiYXNlNjQgc3RyaW5ncywgYXMgTm9kZS5qcyBkb2VzLgogIC8vIFNlZTogaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQmFzZTY0I1VSTF9hcHBsaWNhdGlvbnMKICByZXZMb29rdXBbJy0nLmNoYXJDb2RlQXQoMCldID0gNjIKICByZXZMb29rdXBbJ18nLmNoYXJDb2RlQXQoMCldID0gNjMKICAKICBmdW5jdGlvbiBnZXRMZW5zIChiNjQpIHsKICAgIHZhciBsZW4gPSBiNjQubGVuZ3RoCiAgCiAgICBpZiAobGVuICUgNCA+IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHN0cmluZy4gTGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA0JykKICAgIH0KICAKICAgIC8vIFRyaW0gb2ZmIGV4dHJhIGJ5dGVzIGFmdGVyIHBsYWNlaG9sZGVyIGJ5dGVzIGFyZSBmb3VuZAogICAgLy8gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vYmVhdGdhbW1pdC9iYXNlNjQtanMvaXNzdWVzLzQyCiAgICB2YXIgdmFsaWRMZW4gPSBiNjQuaW5kZXhPZignPScpCiAgICBpZiAodmFsaWRMZW4gPT09IC0xKSB2YWxpZExlbiA9IGxlbgogIAogICAgdmFyIHBsYWNlSG9sZGVyc0xlbiA9IHZhbGlkTGVuID09PSBsZW4KICAgICAgPyAwCiAgICAgIDogNCAtICh2YWxpZExlbiAlIDQpCiAgCiAgICByZXR1cm4gW3ZhbGlkTGVuLCBwbGFjZUhvbGRlcnNMZW5dCiAgfQogIAogIC8vIGJhc2U2NCBpcyA0LzMgKyB1cCB0byB0d28gY2hhcmFjdGVycyBvZiB0aGUgb3JpZ2luYWwgZGF0YQogIGZ1bmN0aW9uIGJ5dGVMZW5ndGggKGI2NCkgewogICAgdmFyIGxlbnMgPSBnZXRMZW5zKGI2NCkKICAgIHZhciB2YWxpZExlbiA9IGxlbnNbMF0KICAgIHZhciBwbGFjZUhvbGRlcnNMZW4gPSBsZW5zWzFdCiAgICByZXR1cm4gKCh2YWxpZExlbiArIHBsYWNlSG9sZGVyc0xlbikgKiAzIC8gNCkgLSBwbGFjZUhvbGRlcnNMZW4KICB9CiAgCiAgZnVuY3Rpb24gX2J5dGVMZW5ndGggKGI2NCwgdmFsaWRMZW4sIHBsYWNlSG9sZGVyc0xlbikgewogICAgcmV0dXJuICgodmFsaWRMZW4gKyBwbGFjZUhvbGRlcnNMZW4pICogMyAvIDQpIC0gcGxhY2VIb2xkZXJzTGVuCiAgfQogIAogIGZ1bmN0aW9uIHRvQnl0ZUFycmF5IChiNjQpIHsKICAgIHZhciB0bXAKICAgIHZhciBsZW5zID0gZ2V0TGVucyhiNjQpCiAgICB2YXIgdmFsaWRMZW4gPSBsZW5zWzBdCiAgICB2YXIgcGxhY2VIb2xkZXJzTGVuID0gbGVuc1sxXQogIAogICAgdmFyIGFyciA9IG5ldyBBcnIoX2J5dGVMZW5ndGgoYjY0LCB2YWxpZExlbiwgcGxhY2VIb2xkZXJzTGVuKSkKICAKICAgIHZhciBjdXJCeXRlID0gMAogIAogICAgLy8gaWYgdGhlcmUgYXJlIHBsYWNlaG9sZGVycywgb25seSBnZXQgdXAgdG8gdGhlIGxhc3QgY29tcGxldGUgNCBjaGFycwogICAgdmFyIGxlbiA9IHBsYWNlSG9sZGVyc0xlbiA+IDAKICAgICAgPyB2YWxpZExlbiAtIDQKICAgICAgOiB2YWxpZExlbgogIAogICAgdmFyIGkKICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkgKz0gNCkgewogICAgICB0bXAgPQogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSldIDw8IDE4KSB8CiAgICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMSldIDw8IDEyKSB8CiAgICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMildIDw8IDYpIHwKICAgICAgICByZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDMpXQogICAgICBhcnJbY3VyQnl0ZSsrXSA9ICh0bXAgPj4gMTYpICYgMHhGRgogICAgICBhcnJbY3VyQnl0ZSsrXSA9ICh0bXAgPj4gOCkgJiAweEZGCiAgICAgIGFycltjdXJCeXRlKytdID0gdG1wICYgMHhGRgogICAgfQogIAogICAgaWYgKHBsYWNlSG9sZGVyc0xlbiA9PT0gMikgewogICAgICB0bXAgPQogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSldIDw8IDIpIHwKICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAxKV0gPj4gNCkKICAgICAgYXJyW2N1ckJ5dGUrK10gPSB0bXAgJiAweEZGCiAgICB9CiAgCiAgICBpZiAocGxhY2VIb2xkZXJzTGVuID09PSAxKSB7CiAgICAgIHRtcCA9CiAgICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpKV0gPDwgMTApIHwKICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAxKV0gPDwgNCkgfAogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDIpXSA+PiAyKQogICAgICBhcnJbY3VyQnl0ZSsrXSA9ICh0bXAgPj4gOCkgJiAweEZGCiAgICAgIGFycltjdXJCeXRlKytdID0gdG1wICYgMHhGRgogICAgfQogIAogICAgcmV0dXJuIGFycgogIH0KICAKICBmdW5jdGlvbiB0cmlwbGV0VG9CYXNlNjQgKG51bSkgewogICAgcmV0dXJuIGxvb2t1cFtudW0gPj4gMTggJiAweDNGXSArCiAgICAgIGxvb2t1cFtudW0gPj4gMTIgJiAweDNGXSArCiAgICAgIGxvb2t1cFtudW0gPj4gNiAmIDB4M0ZdICsKICAgICAgbG9va3VwW251bSAmIDB4M0ZdCiAgfQogIAogIGZ1bmN0aW9uIGVuY29kZUNodW5rICh1aW50OCwgc3RhcnQsIGVuZCkgewogICAgdmFyIHRtcAogICAgdmFyIG91dHB1dCA9IFtdCiAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7IGkgKz0gMykgewogICAgICB0bXAgPQogICAgICAgICgodWludDhbaV0gPDwgMTYpICYgMHhGRjAwMDApICsKICAgICAgICAoKHVpbnQ4W2kgKyAxXSA8PCA4KSAmIDB4RkYwMCkgKwogICAgICAgICh1aW50OFtpICsgMl0gJiAweEZGKQogICAgICBvdXRwdXQucHVzaCh0cmlwbGV0VG9CYXNlNjQodG1wKSkKICAgIH0KICAgIHJldHVybiBvdXRwdXQuam9pbignJykKICB9CiAgCiAgZnVuY3Rpb24gZnJvbUJ5dGVBcnJheSAodWludDgpIHsKICAgIHZhciB0bXAKICAgIHZhciBsZW4gPSB1aW50OC5sZW5ndGgKICAgIHZhciBleHRyYUJ5dGVzID0gbGVuICUgMyAvLyBpZiB3ZSBoYXZlIDEgYnl0ZSBsZWZ0LCBwYWQgMiBieXRlcwogICAgdmFyIHBhcnRzID0gW10KICAgIHZhciBtYXhDaHVua0xlbmd0aCA9IDE2MzgzIC8vIG11c3QgYmUgbXVsdGlwbGUgb2YgMwogIAogICAgLy8gZ28gdGhyb3VnaCB0aGUgYXJyYXkgZXZlcnkgdGhyZWUgYnl0ZXMsIHdlJ2xsIGRlYWwgd2l0aCB0cmFpbGluZyBzdHVmZiBsYXRlcgogICAgZm9yICh2YXIgaSA9IDAsIGxlbjIgPSBsZW4gLSBleHRyYUJ5dGVzOyBpIDwgbGVuMjsgaSArPSBtYXhDaHVua0xlbmd0aCkgewogICAgICBwYXJ0cy5wdXNoKGVuY29kZUNodW5rKAogICAgICAgIHVpbnQ4LCBpLCAoaSArIG1heENodW5rTGVuZ3RoKSA+IGxlbjIgPyBsZW4yIDogKGkgKyBtYXhDaHVua0xlbmd0aCkKICAgICAgKSkKICAgIH0KICAKICAgIC8vIHBhZCB0aGUgZW5kIHdpdGggemVyb3MsIGJ1dCBtYWtlIHN1cmUgdG8gbm90IGZvcmdldCB0aGUgZXh0cmEgYnl0ZXMKICAgIGlmIChleHRyYUJ5dGVzID09PSAxKSB7CiAgICAgIHRtcCA9IHVpbnQ4W2xlbiAtIDFdCiAgICAgIHBhcnRzLnB1c2goCiAgICAgICAgbG9va3VwW3RtcCA+PiAyXSArCiAgICAgICAgbG9va3VwWyh0bXAgPDwgNCkgJiAweDNGXSArCiAgICAgICAgJz09JwogICAgICApCiAgICB9IGVsc2UgaWYgKGV4dHJhQnl0ZXMgPT09IDIpIHsKICAgICAgdG1wID0gKHVpbnQ4W2xlbiAtIDJdIDw8IDgpICsgdWludDhbbGVuIC0gMV0KICAgICAgcGFydHMucHVzaCgKICAgICAgICBsb29rdXBbdG1wID4+IDEwXSArCiAgICAgICAgbG9va3VwWyh0bXAgPj4gNCkgJiAweDNGXSArCiAgICAgICAgbG9va3VwWyh0bXAgPDwgMikgJiAweDNGXSArCiAgICAgICAgJz0nCiAgICAgICkKICAgIH0KICAKICAgIHJldHVybiBwYXJ0cy5qb2luKCcnKQogIH0KICAKICB9LHt9XSw3OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgCiAgfSx7fV0sODA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAoZ2xvYmFsLEJ1ZmZlcil7CiAgLyohCiAgICogVGhlIGJ1ZmZlciBtb2R1bGUgZnJvbSBub2RlLmpzLCBmb3IgdGhlIGJyb3dzZXIuCiAgICoKICAgKiBAYXV0aG9yICAgRmVyb3NzIEFib3VraGFkaWplaCA8ZmVyb3NzQGZlcm9zcy5vcmc+IDxodHRwOi8vZmVyb3NzLm9yZz4KICAgKiBAbGljZW5zZSAgTUlUCiAgICovCiAgLyogZXNsaW50LWRpc2FibGUgbm8tcHJvdG8gKi8KICAKICAndXNlIHN0cmljdCcKICAKICB2YXIgYmFzZTY0ID0gcmVxdWlyZSgnYmFzZTY0LWpzJykKICB2YXIgaWVlZTc1NCA9IHJlcXVpcmUoJ2llZWU3NTQnKQogIHZhciBpc0FycmF5ID0gcmVxdWlyZSgnaXNhcnJheScpCiAgCiAgZXhwb3J0cy5CdWZmZXIgPSBCdWZmZXIKICBleHBvcnRzLlNsb3dCdWZmZXIgPSBTbG93QnVmZmVyCiAgZXhwb3J0cy5JTlNQRUNUX01BWF9CWVRFUyA9IDUwCiAgCiAgLyoqCiAgICogSWYgYEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUYDoKICAgKiAgID09PSB0cnVlICAgIFVzZSBVaW50OEFycmF5IGltcGxlbWVudGF0aW9uIChmYXN0ZXN0KQogICAqICAgPT09IGZhbHNlICAgVXNlIE9iamVjdCBpbXBsZW1lbnRhdGlvbiAobW9zdCBjb21wYXRpYmxlLCBldmVuIElFNikKICAgKgogICAqIEJyb3dzZXJzIHRoYXQgc3VwcG9ydCB0eXBlZCBhcnJheXMgYXJlIElFIDEwKywgRmlyZWZveCA0KywgQ2hyb21lIDcrLCBTYWZhcmkgNS4xKywKICAgKiBPcGVyYSAxMS42KywgaU9TIDQuMisuCiAgICoKICAgKiBEdWUgdG8gdmFyaW91cyBicm93c2VyIGJ1Z3MsIHNvbWV0aW1lcyB0aGUgT2JqZWN0IGltcGxlbWVudGF0aW9uIHdpbGwgYmUgdXNlZCBldmVuCiAgICogd2hlbiB0aGUgYnJvd3NlciBzdXBwb3J0cyB0eXBlZCBhcnJheXMuCiAgICoKICAgKiBOb3RlOgogICAqCiAgICogICAtIEZpcmVmb3ggNC0yOSBsYWNrcyBzdXBwb3J0IGZvciBhZGRpbmcgbmV3IHByb3BlcnRpZXMgdG8gYFVpbnQ4QXJyYXlgIGluc3RhbmNlcywKICAgKiAgICAgU2VlOiBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD02OTU0MzguCiAgICoKICAgKiAgIC0gQ2hyb21lIDktMTAgaXMgbWlzc2luZyB0aGUgYFR5cGVkQXJyYXkucHJvdG90eXBlLnN1YmFycmF5YCBmdW5jdGlvbi4KICAgKgogICAqICAgLSBJRTEwIGhhcyBhIGJyb2tlbiBgVHlwZWRBcnJheS5wcm90b3R5cGUuc3ViYXJyYXlgIGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYXJyYXlzIG9mCiAgICogICAgIGluY29ycmVjdCBsZW5ndGggaW4gc29tZSBzaXR1YXRpb25zLgogIAogICAqIFdlIGRldGVjdCB0aGVzZSBidWdneSBicm93c2VycyBhbmQgc2V0IGBCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVGAgdG8gYGZhbHNlYCBzbyB0aGV5CiAgICogZ2V0IHRoZSBPYmplY3QgaW1wbGVtZW50YXRpb24sIHdoaWNoIGlzIHNsb3dlciBidXQgYmVoYXZlcyBjb3JyZWN0bHkuCiAgICovCiAgQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQgPSBnbG9iYWwuVFlQRURfQVJSQVlfU1VQUE9SVCAhPT0gdW5kZWZpbmVkCiAgICA/IGdsb2JhbC5UWVBFRF9BUlJBWV9TVVBQT1JUCiAgICA6IHR5cGVkQXJyYXlTdXBwb3J0KCkKICAKICAvKgogICAqIEV4cG9ydCBrTWF4TGVuZ3RoIGFmdGVyIHR5cGVkIGFycmF5IHN1cHBvcnQgaXMgZGV0ZXJtaW5lZC4KICAgKi8KICBleHBvcnRzLmtNYXhMZW5ndGggPSBrTWF4TGVuZ3RoKCkKICAKICBmdW5jdGlvbiB0eXBlZEFycmF5U3VwcG9ydCAoKSB7CiAgICB0cnkgewogICAgICB2YXIgYXJyID0gbmV3IFVpbnQ4QXJyYXkoMSkKICAgICAgYXJyLl9fcHJvdG9fXyA9IHtfX3Byb3RvX186IFVpbnQ4QXJyYXkucHJvdG90eXBlLCBmb286IGZ1bmN0aW9uICgpIHsgcmV0dXJuIDQyIH19CiAgICAgIHJldHVybiBhcnIuZm9vKCkgPT09IDQyICYmIC8vIHR5cGVkIGFycmF5IGluc3RhbmNlcyBjYW4gYmUgYXVnbWVudGVkCiAgICAgICAgICB0eXBlb2YgYXJyLnN1YmFycmF5ID09PSAnZnVuY3Rpb24nICYmIC8vIGNocm9tZSA5LTEwIGxhY2sgYHN1YmFycmF5YAogICAgICAgICAgYXJyLnN1YmFycmF5KDEsIDEpLmJ5dGVMZW5ndGggPT09IDAgLy8gaWUxMCBoYXMgYnJva2VuIGBzdWJhcnJheWAKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGtNYXhMZW5ndGggKCkgewogICAgcmV0dXJuIEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUCiAgICAgID8gMHg3ZmZmZmZmZgogICAgICA6IDB4M2ZmZmZmZmYKICB9CiAgCiAgZnVuY3Rpb24gY3JlYXRlQnVmZmVyICh0aGF0LCBsZW5ndGgpIHsKICAgIGlmIChrTWF4TGVuZ3RoKCkgPCBsZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0ludmFsaWQgdHlwZWQgYXJyYXkgbGVuZ3RoJykKICAgIH0KICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICAvLyBSZXR1cm4gYW4gYXVnbWVudGVkIGBVaW50OEFycmF5YCBpbnN0YW5jZSwgZm9yIGJlc3QgcGVyZm9ybWFuY2UKICAgICAgdGhhdCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCkKICAgICAgdGhhdC5fX3Byb3RvX18gPSBCdWZmZXIucHJvdG90eXBlCiAgICB9IGVsc2UgewogICAgICAvLyBGYWxsYmFjazogUmV0dXJuIGFuIG9iamVjdCBpbnN0YW5jZSBvZiB0aGUgQnVmZmVyIGNsYXNzCiAgICAgIGlmICh0aGF0ID09PSBudWxsKSB7CiAgICAgICAgdGhhdCA9IG5ldyBCdWZmZXIobGVuZ3RoKQogICAgICB9CiAgICAgIHRoYXQubGVuZ3RoID0gbGVuZ3RoCiAgICB9CiAgCiAgICByZXR1cm4gdGhhdAogIH0KICAKICAvKioKICAgKiBUaGUgQnVmZmVyIGNvbnN0cnVjdG9yIHJldHVybnMgaW5zdGFuY2VzIG9mIGBVaW50OEFycmF5YCB0aGF0IGhhdmUgdGhlaXIKICAgKiBwcm90b3R5cGUgY2hhbmdlZCB0byBgQnVmZmVyLnByb3RvdHlwZWAuIEZ1cnRoZXJtb3JlLCBgQnVmZmVyYCBpcyBhIHN1YmNsYXNzIG9mCiAgICogYFVpbnQ4QXJyYXlgLCBzbyB0aGUgcmV0dXJuZWQgaW5zdGFuY2VzIHdpbGwgaGF2ZSBhbGwgdGhlIG5vZGUgYEJ1ZmZlcmAgbWV0aG9kcwogICAqIGFuZCB0aGUgYFVpbnQ4QXJyYXlgIG1ldGhvZHMuIFNxdWFyZSBicmFja2V0IG5vdGF0aW9uIHdvcmtzIGFzIGV4cGVjdGVkIC0tIGl0CiAgICogcmV0dXJucyBhIHNpbmdsZSBvY3RldC4KICAgKgogICAqIFRoZSBgVWludDhBcnJheWAgcHJvdG90eXBlIHJlbWFpbnMgdW5tb2RpZmllZC4KICAgKi8KICAKICBmdW5jdGlvbiBCdWZmZXIgKGFyZywgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKSB7CiAgICBpZiAoIUJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUICYmICEodGhpcyBpbnN0YW5jZW9mIEJ1ZmZlcikpIHsKICAgICAgcmV0dXJuIG5ldyBCdWZmZXIoYXJnLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpCiAgICB9CiAgCiAgICAvLyBDb21tb24gY2FzZS4KICAgIGlmICh0eXBlb2YgYXJnID09PSAnbnVtYmVyJykgewogICAgICBpZiAodHlwZW9mIGVuY29kaW5nT3JPZmZzZXQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgJ0lmIGVuY29kaW5nIGlzIHNwZWNpZmllZCB0aGVuIHRoZSBmaXJzdCBhcmd1bWVudCBtdXN0IGJlIGEgc3RyaW5nJwogICAgICAgICkKICAgICAgfQogICAgICByZXR1cm4gYWxsb2NVbnNhZmUodGhpcywgYXJnKQogICAgfQogICAgcmV0dXJuIGZyb20odGhpcywgYXJnLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpCiAgfQogIAogIEJ1ZmZlci5wb29sU2l6ZSA9IDgxOTIgLy8gbm90IHVzZWQgYnkgdGhpcyBpbXBsZW1lbnRhdGlvbgogIAogIC8vIFRPRE86IExlZ2FjeSwgbm90IG5lZWRlZCBhbnltb3JlLiBSZW1vdmUgaW4gbmV4dCBtYWpvciB2ZXJzaW9uLgogIEJ1ZmZlci5fYXVnbWVudCA9IGZ1bmN0aW9uIChhcnIpIHsKICAgIGFyci5fX3Byb3RvX18gPSBCdWZmZXIucHJvdG90eXBlCiAgICByZXR1cm4gYXJyCiAgfQogIAogIGZ1bmN0aW9uIGZyb20gKHRoYXQsIHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpIHsKICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJ2YWx1ZSIgYXJndW1lbnQgbXVzdCBub3QgYmUgYSBudW1iZXInKQogICAgfQogIAogICAgaWYgKHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gJ3VuZGVmaW5lZCcgJiYgdmFsdWUgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgewogICAgICByZXR1cm4gZnJvbUFycmF5QnVmZmVyKHRoYXQsIHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpCiAgICB9CiAgCiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gZnJvbVN0cmluZyh0aGF0LCB2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCkKICAgIH0KICAKICAgIHJldHVybiBmcm9tT2JqZWN0KHRoYXQsIHZhbHVlKQogIH0KICAKICAvKioKICAgKiBGdW5jdGlvbmFsbHkgZXF1aXZhbGVudCB0byBCdWZmZXIoYXJnLCBlbmNvZGluZykgYnV0IHRocm93cyBhIFR5cGVFcnJvcgogICAqIGlmIHZhbHVlIGlzIGEgbnVtYmVyLgogICAqIEJ1ZmZlci5mcm9tKHN0clssIGVuY29kaW5nXSkKICAgKiBCdWZmZXIuZnJvbShhcnJheSkKICAgKiBCdWZmZXIuZnJvbShidWZmZXIpCiAgICogQnVmZmVyLmZyb20oYXJyYXlCdWZmZXJbLCBieXRlT2Zmc2V0WywgbGVuZ3RoXV0pCiAgICoqLwogIEJ1ZmZlci5mcm9tID0gZnVuY3Rpb24gKHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpIHsKICAgIHJldHVybiBmcm9tKG51bGwsIHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpCiAgfQogIAogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgQnVmZmVyLnByb3RvdHlwZS5fX3Byb3RvX18gPSBVaW50OEFycmF5LnByb3RvdHlwZQogICAgQnVmZmVyLl9fcHJvdG9fXyA9IFVpbnQ4QXJyYXkKICAgIGlmICh0eXBlb2YgU3ltYm9sICE9PSAndW5kZWZpbmVkJyAmJiBTeW1ib2wuc3BlY2llcyAmJgogICAgICAgIEJ1ZmZlcltTeW1ib2wuc3BlY2llc10gPT09IEJ1ZmZlcikgewogICAgICAvLyBGaXggc3ViYXJyYXkoKSBpbiBFUzIwMTYuIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2Zlcm9zcy9idWZmZXIvcHVsbC85NwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQnVmZmVyLCBTeW1ib2wuc3BlY2llcywgewogICAgICAgIHZhbHVlOiBudWxsLAogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICB9KQogICAgfQogIH0KICAKICBmdW5jdGlvbiBhc3NlcnRTaXplIChzaXplKSB7CiAgICBpZiAodHlwZW9mIHNpemUgIT09ICdudW1iZXInKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJzaXplIiBhcmd1bWVudCBtdXN0IGJlIGEgbnVtYmVyJykKICAgIH0gZWxzZSBpZiAoc2l6ZSA8IDApIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJyJzaXplIiBhcmd1bWVudCBtdXN0IG5vdCBiZSBuZWdhdGl2ZScpCiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGFsbG9jICh0aGF0LCBzaXplLCBmaWxsLCBlbmNvZGluZykgewogICAgYXNzZXJ0U2l6ZShzaXplKQogICAgaWYgKHNpemUgPD0gMCkgewogICAgICByZXR1cm4gY3JlYXRlQnVmZmVyKHRoYXQsIHNpemUpCiAgICB9CiAgICBpZiAoZmlsbCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIC8vIE9ubHkgcGF5IGF0dGVudGlvbiB0byBlbmNvZGluZyBpZiBpdCdzIGEgc3RyaW5nLiBUaGlzCiAgICAgIC8vIHByZXZlbnRzIGFjY2lkZW50YWxseSBzZW5kaW5nIGluIGEgbnVtYmVyIHRoYXQgd291bGQKICAgICAgLy8gYmUgaW50ZXJwcmV0dGVkIGFzIGEgc3RhcnQgb2Zmc2V0LgogICAgICByZXR1cm4gdHlwZW9mIGVuY29kaW5nID09PSAnc3RyaW5nJwogICAgICAgID8gY3JlYXRlQnVmZmVyKHRoYXQsIHNpemUpLmZpbGwoZmlsbCwgZW5jb2RpbmcpCiAgICAgICAgOiBjcmVhdGVCdWZmZXIodGhhdCwgc2l6ZSkuZmlsbChmaWxsKQogICAgfQogICAgcmV0dXJuIGNyZWF0ZUJ1ZmZlcih0aGF0LCBzaXplKQogIH0KICAKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IGZpbGxlZCBCdWZmZXIgaW5zdGFuY2UuCiAgICogYWxsb2Moc2l6ZVssIGZpbGxbLCBlbmNvZGluZ11dKQogICAqKi8KICBCdWZmZXIuYWxsb2MgPSBmdW5jdGlvbiAoc2l6ZSwgZmlsbCwgZW5jb2RpbmcpIHsKICAgIHJldHVybiBhbGxvYyhudWxsLCBzaXplLCBmaWxsLCBlbmNvZGluZykKICB9CiAgCiAgZnVuY3Rpb24gYWxsb2NVbnNhZmUgKHRoYXQsIHNpemUpIHsKICAgIGFzc2VydFNpemUoc2l6ZSkKICAgIHRoYXQgPSBjcmVhdGVCdWZmZXIodGhhdCwgc2l6ZSA8IDAgPyAwIDogY2hlY2tlZChzaXplKSB8IDApCiAgICBpZiAoIUJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2l6ZTsgKytpKSB7CiAgICAgICAgdGhhdFtpXSA9IDAKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoYXQKICB9CiAgCiAgLyoqCiAgICogRXF1aXZhbGVudCB0byBCdWZmZXIobnVtKSwgYnkgZGVmYXVsdCBjcmVhdGVzIGEgbm9uLXplcm8tZmlsbGVkIEJ1ZmZlciBpbnN0YW5jZS4KICAgKiAqLwogIEJ1ZmZlci5hbGxvY1Vuc2FmZSA9IGZ1bmN0aW9uIChzaXplKSB7CiAgICByZXR1cm4gYWxsb2NVbnNhZmUobnVsbCwgc2l6ZSkKICB9CiAgLyoqCiAgICogRXF1aXZhbGVudCB0byBTbG93QnVmZmVyKG51bSksIGJ5IGRlZmF1bHQgY3JlYXRlcyBhIG5vbi16ZXJvLWZpbGxlZCBCdWZmZXIgaW5zdGFuY2UuCiAgICovCiAgQnVmZmVyLmFsbG9jVW5zYWZlU2xvdyA9IGZ1bmN0aW9uIChzaXplKSB7CiAgICByZXR1cm4gYWxsb2NVbnNhZmUobnVsbCwgc2l6ZSkKICB9CiAgCiAgZnVuY3Rpb24gZnJvbVN0cmluZyAodGhhdCwgc3RyaW5nLCBlbmNvZGluZykgewogICAgaWYgKHR5cGVvZiBlbmNvZGluZyAhPT0gJ3N0cmluZycgfHwgZW5jb2RpbmcgPT09ICcnKSB7CiAgICAgIGVuY29kaW5nID0gJ3V0ZjgnCiAgICB9CiAgCiAgICBpZiAoIUJ1ZmZlci5pc0VuY29kaW5nKGVuY29kaW5nKSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCciZW5jb2RpbmciIG11c3QgYmUgYSB2YWxpZCBzdHJpbmcgZW5jb2RpbmcnKQogICAgfQogIAogICAgdmFyIGxlbmd0aCA9IGJ5dGVMZW5ndGgoc3RyaW5nLCBlbmNvZGluZykgfCAwCiAgICB0aGF0ID0gY3JlYXRlQnVmZmVyKHRoYXQsIGxlbmd0aCkKICAKICAgIHZhciBhY3R1YWwgPSB0aGF0LndyaXRlKHN0cmluZywgZW5jb2RpbmcpCiAgCiAgICBpZiAoYWN0dWFsICE9PSBsZW5ndGgpIHsKICAgICAgLy8gV3JpdGluZyBhIGhleCBzdHJpbmcsIGZvciBleGFtcGxlLCB0aGF0IGNvbnRhaW5zIGludmFsaWQgY2hhcmFjdGVycyB3aWxsCiAgICAgIC8vIGNhdXNlIGV2ZXJ5dGhpbmcgYWZ0ZXIgdGhlIGZpcnN0IGludmFsaWQgY2hhcmFjdGVyIHRvIGJlIGlnbm9yZWQuIChlLmcuCiAgICAgIC8vICdhYnh4Y2QnIHdpbGwgYmUgdHJlYXRlZCBhcyAnYWInKQogICAgICB0aGF0ID0gdGhhdC5zbGljZSgwLCBhY3R1YWwpCiAgICB9CiAgCiAgICByZXR1cm4gdGhhdAogIH0KICAKICBmdW5jdGlvbiBmcm9tQXJyYXlMaWtlICh0aGF0LCBhcnJheSkgewogICAgdmFyIGxlbmd0aCA9IGFycmF5Lmxlbmd0aCA8IDAgPyAwIDogY2hlY2tlZChhcnJheS5sZW5ndGgpIHwgMAogICAgdGhhdCA9IGNyZWF0ZUJ1ZmZlcih0aGF0LCBsZW5ndGgpCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAxKSB7CiAgICAgIHRoYXRbaV0gPSBhcnJheVtpXSAmIDI1NQogICAgfQogICAgcmV0dXJuIHRoYXQKICB9CiAgCiAgZnVuY3Rpb24gZnJvbUFycmF5QnVmZmVyICh0aGF0LCBhcnJheSwgYnl0ZU9mZnNldCwgbGVuZ3RoKSB7CiAgICBhcnJheS5ieXRlTGVuZ3RoIC8vIHRoaXMgdGhyb3dzIGlmIGBhcnJheWAgaXMgbm90IGEgdmFsaWQgQXJyYXlCdWZmZXIKICAKICAgIGlmIChieXRlT2Zmc2V0IDwgMCB8fCBhcnJheS5ieXRlTGVuZ3RoIDwgYnl0ZU9mZnNldCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignXCdvZmZzZXRcJyBpcyBvdXQgb2YgYm91bmRzJykKICAgIH0KICAKICAgIGlmIChhcnJheS5ieXRlTGVuZ3RoIDwgYnl0ZU9mZnNldCArIChsZW5ndGggfHwgMCkpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ1wnbGVuZ3RoXCcgaXMgb3V0IG9mIGJvdW5kcycpCiAgICB9CiAgCiAgICBpZiAoYnl0ZU9mZnNldCA9PT0gdW5kZWZpbmVkICYmIGxlbmd0aCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXkpCiAgICB9IGVsc2UgaWYgKGxlbmd0aCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXksIGJ5dGVPZmZzZXQpCiAgICB9IGVsc2UgewogICAgICBhcnJheSA9IG5ldyBVaW50OEFycmF5KGFycmF5LCBieXRlT2Zmc2V0LCBsZW5ndGgpCiAgICB9CiAgCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgLy8gUmV0dXJuIGFuIGF1Z21lbnRlZCBgVWludDhBcnJheWAgaW5zdGFuY2UsIGZvciBiZXN0IHBlcmZvcm1hbmNlCiAgICAgIHRoYXQgPSBhcnJheQogICAgICB0aGF0Ll9fcHJvdG9fXyA9IEJ1ZmZlci5wcm90b3R5cGUKICAgIH0gZWxzZSB7CiAgICAgIC8vIEZhbGxiYWNrOiBSZXR1cm4gYW4gb2JqZWN0IGluc3RhbmNlIG9mIHRoZSBCdWZmZXIgY2xhc3MKICAgICAgdGhhdCA9IGZyb21BcnJheUxpa2UodGhhdCwgYXJyYXkpCiAgICB9CiAgICByZXR1cm4gdGhhdAogIH0KICAKICBmdW5jdGlvbiBmcm9tT2JqZWN0ICh0aGF0LCBvYmopIHsKICAgIGlmIChCdWZmZXIuaXNCdWZmZXIob2JqKSkgewogICAgICB2YXIgbGVuID0gY2hlY2tlZChvYmoubGVuZ3RoKSB8IDAKICAgICAgdGhhdCA9IGNyZWF0ZUJ1ZmZlcih0aGF0LCBsZW4pCiAgCiAgICAgIGlmICh0aGF0Lmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiB0aGF0CiAgICAgIH0KICAKICAgICAgb2JqLmNvcHkodGhhdCwgMCwgMCwgbGVuKQogICAgICByZXR1cm4gdGhhdAogICAgfQogIAogICAgaWYgKG9iaikgewogICAgICBpZiAoKHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gJ3VuZGVmaW5lZCcgJiYKICAgICAgICAgIG9iai5idWZmZXIgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgfHwgJ2xlbmd0aCcgaW4gb2JqKSB7CiAgICAgICAgaWYgKHR5cGVvZiBvYmoubGVuZ3RoICE9PSAnbnVtYmVyJyB8fCBpc25hbihvYmoubGVuZ3RoKSkgewogICAgICAgICAgcmV0dXJuIGNyZWF0ZUJ1ZmZlcih0aGF0LCAwKQogICAgICAgIH0KICAgICAgICByZXR1cm4gZnJvbUFycmF5TGlrZSh0aGF0LCBvYmopCiAgICAgIH0KICAKICAgICAgaWYgKG9iai50eXBlID09PSAnQnVmZmVyJyAmJiBpc0FycmF5KG9iai5kYXRhKSkgewogICAgICAgIHJldHVybiBmcm9tQXJyYXlMaWtlKHRoYXQsIG9iai5kYXRhKQogICAgICB9CiAgICB9CiAgCiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdGaXJzdCBhcmd1bWVudCBtdXN0IGJlIGEgc3RyaW5nLCBCdWZmZXIsIEFycmF5QnVmZmVyLCBBcnJheSwgb3IgYXJyYXktbGlrZSBvYmplY3QuJykKICB9CiAgCiAgZnVuY3Rpb24gY2hlY2tlZCAobGVuZ3RoKSB7CiAgICAvLyBOb3RlOiBjYW5ub3QgdXNlIGBsZW5ndGggPCBrTWF4TGVuZ3RoKClgIGhlcmUgYmVjYXVzZSB0aGF0IGZhaWxzIHdoZW4KICAgIC8vIGxlbmd0aCBpcyBOYU4gKHdoaWNoIGlzIG90aGVyd2lzZSBjb2VyY2VkIHRvIHplcm8uKQogICAgaWYgKGxlbmd0aCA+PSBrTWF4TGVuZ3RoKCkpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0F0dGVtcHQgdG8gYWxsb2NhdGUgQnVmZmVyIGxhcmdlciB0aGFuIG1heGltdW0gJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICdzaXplOiAweCcgKyBrTWF4TGVuZ3RoKCkudG9TdHJpbmcoMTYpICsgJyBieXRlcycpCiAgICB9CiAgICByZXR1cm4gbGVuZ3RoIHwgMAogIH0KICAKICBmdW5jdGlvbiBTbG93QnVmZmVyIChsZW5ndGgpIHsKICAgIGlmICgrbGVuZ3RoICE9IGxlbmd0aCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGVxZXFlcQogICAgICBsZW5ndGggPSAwCiAgICB9CiAgICByZXR1cm4gQnVmZmVyLmFsbG9jKCtsZW5ndGgpCiAgfQogIAogIEJ1ZmZlci5pc0J1ZmZlciA9IGZ1bmN0aW9uIGlzQnVmZmVyIChiKSB7CiAgICByZXR1cm4gISEoYiAhPSBudWxsICYmIGIuX2lzQnVmZmVyKQogIH0KICAKICBCdWZmZXIuY29tcGFyZSA9IGZ1bmN0aW9uIGNvbXBhcmUgKGEsIGIpIHsKICAgIGlmICghQnVmZmVyLmlzQnVmZmVyKGEpIHx8ICFCdWZmZXIuaXNCdWZmZXIoYikpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJndW1lbnRzIG11c3QgYmUgQnVmZmVycycpCiAgICB9CiAgCiAgICBpZiAoYSA9PT0gYikgcmV0dXJuIDAKICAKICAgIHZhciB4ID0gYS5sZW5ndGgKICAgIHZhciB5ID0gYi5sZW5ndGgKICAKICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBNYXRoLm1pbih4LCB5KTsgaSA8IGxlbjsgKytpKSB7CiAgICAgIGlmIChhW2ldICE9PSBiW2ldKSB7CiAgICAgICAgeCA9IGFbaV0KICAgICAgICB5ID0gYltpXQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KICAKICAgIGlmICh4IDwgeSkgcmV0dXJuIC0xCiAgICBpZiAoeSA8IHgpIHJldHVybiAxCiAgICByZXR1cm4gMAogIH0KICAKICBCdWZmZXIuaXNFbmNvZGluZyA9IGZ1bmN0aW9uIGlzRW5jb2RpbmcgKGVuY29kaW5nKSB7CiAgICBzd2l0Y2ggKFN0cmluZyhlbmNvZGluZykudG9Mb3dlckNhc2UoKSkgewogICAgICBjYXNlICdoZXgnOgogICAgICBjYXNlICd1dGY4JzoKICAgICAgY2FzZSAndXRmLTgnOgogICAgICBjYXNlICdhc2NpaSc6CiAgICAgIGNhc2UgJ2xhdGluMSc6CiAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgIGNhc2UgJ3VjczInOgogICAgICBjYXNlICd1Y3MtMic6CiAgICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gZmFsc2UKICAgIH0KICB9CiAgCiAgQnVmZmVyLmNvbmNhdCA9IGZ1bmN0aW9uIGNvbmNhdCAobGlzdCwgbGVuZ3RoKSB7CiAgICBpZiAoIWlzQXJyYXkobGlzdCkpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignImxpc3QiIGFyZ3VtZW50IG11c3QgYmUgYW4gQXJyYXkgb2YgQnVmZmVycycpCiAgICB9CiAgCiAgICBpZiAobGlzdC5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIEJ1ZmZlci5hbGxvYygwKQogICAgfQogIAogICAgdmFyIGkKICAgIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCkgewogICAgICBsZW5ndGggPSAwCiAgICAgIGZvciAoaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgbGVuZ3RoICs9IGxpc3RbaV0ubGVuZ3RoCiAgICAgIH0KICAgIH0KICAKICAgIHZhciBidWZmZXIgPSBCdWZmZXIuYWxsb2NVbnNhZmUobGVuZ3RoKQogICAgdmFyIHBvcyA9IDAKICAgIGZvciAoaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBidWYgPSBsaXN0W2ldCiAgICAgIGlmICghQnVmZmVyLmlzQnVmZmVyKGJ1ZikpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCcibGlzdCIgYXJndW1lbnQgbXVzdCBiZSBhbiBBcnJheSBvZiBCdWZmZXJzJykKICAgICAgfQogICAgICBidWYuY29weShidWZmZXIsIHBvcykKICAgICAgcG9zICs9IGJ1Zi5sZW5ndGgKICAgIH0KICAgIHJldHVybiBidWZmZXIKICB9CiAgCiAgZnVuY3Rpb24gYnl0ZUxlbmd0aCAoc3RyaW5nLCBlbmNvZGluZykgewogICAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihzdHJpbmcpKSB7CiAgICAgIHJldHVybiBzdHJpbmcubGVuZ3RoCiAgICB9CiAgICBpZiAodHlwZW9mIEFycmF5QnVmZmVyICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgQXJyYXlCdWZmZXIuaXNWaWV3ID09PSAnZnVuY3Rpb24nICYmCiAgICAgICAgKEFycmF5QnVmZmVyLmlzVmlldyhzdHJpbmcpIHx8IHN0cmluZyBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSkgewogICAgICByZXR1cm4gc3RyaW5nLmJ5dGVMZW5ndGgKICAgIH0KICAgIGlmICh0eXBlb2Ygc3RyaW5nICE9PSAnc3RyaW5nJykgewogICAgICBzdHJpbmcgPSAnJyArIHN0cmluZwogICAgfQogIAogICAgdmFyIGxlbiA9IHN0cmluZy5sZW5ndGgKICAgIGlmIChsZW4gPT09IDApIHJldHVybiAwCiAgCiAgICAvLyBVc2UgYSBmb3IgbG9vcCB0byBhdm9pZCByZWN1cnNpb24KICAgIHZhciBsb3dlcmVkQ2FzZSA9IGZhbHNlCiAgICBmb3IgKDs7KSB7CiAgICAgIHN3aXRjaCAoZW5jb2RpbmcpIHsKICAgICAgICBjYXNlICdhc2NpaSc6CiAgICAgICAgY2FzZSAnbGF0aW4xJzoKICAgICAgICBjYXNlICdiaW5hcnknOgogICAgICAgICAgcmV0dXJuIGxlbgogICAgICAgIGNhc2UgJ3V0ZjgnOgogICAgICAgIGNhc2UgJ3V0Zi04JzoKICAgICAgICBjYXNlIHVuZGVmaW5lZDoKICAgICAgICAgIHJldHVybiB1dGY4VG9CeXRlcyhzdHJpbmcpLmxlbmd0aAogICAgICAgIGNhc2UgJ3VjczInOgogICAgICAgIGNhc2UgJ3Vjcy0yJzoKICAgICAgICBjYXNlICd1dGYxNmxlJzoKICAgICAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgICAgICByZXR1cm4gbGVuICogMgogICAgICAgIGNhc2UgJ2hleCc6CiAgICAgICAgICByZXR1cm4gbGVuID4+PiAxCiAgICAgICAgY2FzZSAnYmFzZTY0JzoKICAgICAgICAgIHJldHVybiBiYXNlNjRUb0J5dGVzKHN0cmluZykubGVuZ3RoCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGlmIChsb3dlcmVkQ2FzZSkgcmV0dXJuIHV0ZjhUb0J5dGVzKHN0cmluZykubGVuZ3RoIC8vIGFzc3VtZSB1dGY4CiAgICAgICAgICBlbmNvZGluZyA9ICgnJyArIGVuY29kaW5nKS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICBsb3dlcmVkQ2FzZSA9IHRydWUKICAgICAgfQogICAgfQogIH0KICBCdWZmZXIuYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGgKICAKICBmdW5jdGlvbiBzbG93VG9TdHJpbmcgKGVuY29kaW5nLCBzdGFydCwgZW5kKSB7CiAgICB2YXIgbG93ZXJlZENhc2UgPSBmYWxzZQogIAogICAgLy8gTm8gbmVlZCB0byB2ZXJpZnkgdGhhdCAidGhpcy5sZW5ndGggPD0gTUFYX1VJTlQzMiIgc2luY2UgaXQncyBhIHJlYWQtb25seQogICAgLy8gcHJvcGVydHkgb2YgYSB0eXBlZCBhcnJheS4KICAKICAgIC8vIFRoaXMgYmVoYXZlcyBuZWl0aGVyIGxpa2UgU3RyaW5nIG5vciBVaW50OEFycmF5IGluIHRoYXQgd2Ugc2V0IHN0YXJ0L2VuZAogICAgLy8gdG8gdGhlaXIgdXBwZXIvbG93ZXIgYm91bmRzIGlmIHRoZSB2YWx1ZSBwYXNzZWQgaXMgb3V0IG9mIHJhbmdlLgogICAgLy8gdW5kZWZpbmVkIGlzIGhhbmRsZWQgc3BlY2lhbGx5IGFzIHBlciBFQ01BLTI2MiA2dGggRWRpdGlvbiwKICAgIC8vIFNlY3Rpb24gMTMuMy4zLjcgUnVudGltZSBTZW1hbnRpY3M6IEtleWVkQmluZGluZ0luaXRpYWxpemF0aW9uLgogICAgaWYgKHN0YXJ0ID09PSB1bmRlZmluZWQgfHwgc3RhcnQgPCAwKSB7CiAgICAgIHN0YXJ0ID0gMAogICAgfQogICAgLy8gUmV0dXJuIGVhcmx5IGlmIHN0YXJ0ID4gdGhpcy5sZW5ndGguIERvbmUgaGVyZSB0byBwcmV2ZW50IHBvdGVudGlhbCB1aW50MzIKICAgIC8vIGNvZXJjaW9uIGZhaWwgYmVsb3cuCiAgICBpZiAoc3RhcnQgPiB0aGlzLmxlbmd0aCkgewogICAgICByZXR1cm4gJycKICAgIH0KICAKICAgIGlmIChlbmQgPT09IHVuZGVmaW5lZCB8fCBlbmQgPiB0aGlzLmxlbmd0aCkgewogICAgICBlbmQgPSB0aGlzLmxlbmd0aAogICAgfQogIAogICAgaWYgKGVuZCA8PSAwKSB7CiAgICAgIHJldHVybiAnJwogICAgfQogIAogICAgLy8gRm9yY2UgY29lcnNpb24gdG8gdWludDMyLiBUaGlzIHdpbGwgYWxzbyBjb2VyY2UgZmFsc2V5L05hTiB2YWx1ZXMgdG8gMC4KICAgIGVuZCA+Pj49IDAKICAgIHN0YXJ0ID4+Pj0gMAogIAogICAgaWYgKGVuZCA8PSBzdGFydCkgewogICAgICByZXR1cm4gJycKICAgIH0KICAKICAgIGlmICghZW5jb2RpbmcpIGVuY29kaW5nID0gJ3V0ZjgnCiAgCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBzd2l0Y2ggKGVuY29kaW5nKSB7CiAgICAgICAgY2FzZSAnaGV4JzoKICAgICAgICAgIHJldHVybiBoZXhTbGljZSh0aGlzLCBzdGFydCwgZW5kKQogIAogICAgICAgIGNhc2UgJ3V0ZjgnOgogICAgICAgIGNhc2UgJ3V0Zi04JzoKICAgICAgICAgIHJldHVybiB1dGY4U2xpY2UodGhpcywgc3RhcnQsIGVuZCkKICAKICAgICAgICBjYXNlICdhc2NpaSc6CiAgICAgICAgICByZXR1cm4gYXNjaWlTbGljZSh0aGlzLCBzdGFydCwgZW5kKQogIAogICAgICAgIGNhc2UgJ2xhdGluMSc6CiAgICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgICAgIHJldHVybiBsYXRpbjFTbGljZSh0aGlzLCBzdGFydCwgZW5kKQogIAogICAgICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgICAgICByZXR1cm4gYmFzZTY0U2xpY2UodGhpcywgc3RhcnQsIGVuZCkKICAKICAgICAgICBjYXNlICd1Y3MyJzoKICAgICAgICBjYXNlICd1Y3MtMic6CiAgICAgICAgY2FzZSAndXRmMTZsZSc6CiAgICAgICAgY2FzZSAndXRmLTE2bGUnOgogICAgICAgICAgcmV0dXJuIHV0ZjE2bGVTbGljZSh0aGlzLCBzdGFydCwgZW5kKQogIAogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBpZiAobG93ZXJlZENhc2UpIHRocm93IG5ldyBUeXBlRXJyb3IoJ1Vua25vd24gZW5jb2Rpbmc6ICcgKyBlbmNvZGluZykKICAgICAgICAgIGVuY29kaW5nID0gKGVuY29kaW5nICsgJycpLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIGxvd2VyZWRDYXNlID0gdHJ1ZQogICAgICB9CiAgICB9CiAgfQogIAogIC8vIFRoZSBwcm9wZXJ0eSBpcyB1c2VkIGJ5IGBCdWZmZXIuaXNCdWZmZXJgIGFuZCBgaXMtYnVmZmVyYCAoaW4gU2FmYXJpIDUtNykgdG8gZGV0ZWN0CiAgLy8gQnVmZmVyIGluc3RhbmNlcy4KICBCdWZmZXIucHJvdG90eXBlLl9pc0J1ZmZlciA9IHRydWUKICAKICBmdW5jdGlvbiBzd2FwIChiLCBuLCBtKSB7CiAgICB2YXIgaSA9IGJbbl0KICAgIGJbbl0gPSBiW21dCiAgICBiW21dID0gaQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnN3YXAxNiA9IGZ1bmN0aW9uIHN3YXAxNiAoKSB7CiAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGgKICAgIGlmIChsZW4gJSAyICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdCdWZmZXIgc2l6ZSBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMTYtYml0cycpCiAgICB9CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSArPSAyKSB7CiAgICAgIHN3YXAodGhpcywgaSwgaSArIDEpCiAgICB9CiAgICByZXR1cm4gdGhpcwogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnN3YXAzMiA9IGZ1bmN0aW9uIHN3YXAzMiAoKSB7CiAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGgKICAgIGlmIChsZW4gJSA0ICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdCdWZmZXIgc2l6ZSBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMzItYml0cycpCiAgICB9CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSArPSA0KSB7CiAgICAgIHN3YXAodGhpcywgaSwgaSArIDMpCiAgICAgIHN3YXAodGhpcywgaSArIDEsIGkgKyAyKQogICAgfQogICAgcmV0dXJuIHRoaXMKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5zd2FwNjQgPSBmdW5jdGlvbiBzd2FwNjQgKCkgewogICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoCiAgICBpZiAobGVuICUgOCAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDY0LWJpdHMnKQogICAgfQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkgKz0gOCkgewogICAgICBzd2FwKHRoaXMsIGksIGkgKyA3KQogICAgICBzd2FwKHRoaXMsIGkgKyAxLCBpICsgNikKICAgICAgc3dhcCh0aGlzLCBpICsgMiwgaSArIDUpCiAgICAgIHN3YXAodGhpcywgaSArIDMsIGkgKyA0KQogICAgfQogICAgcmV0dXJuIHRoaXMKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uIHRvU3RyaW5nICgpIHsKICAgIHZhciBsZW5ndGggPSB0aGlzLmxlbmd0aCB8IDAKICAgIGlmIChsZW5ndGggPT09IDApIHJldHVybiAnJwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHJldHVybiB1dGY4U2xpY2UodGhpcywgMCwgbGVuZ3RoKQogICAgcmV0dXJuIHNsb3dUb1N0cmluZy5hcHBseSh0aGlzLCBhcmd1bWVudHMpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24gZXF1YWxzIChiKSB7CiAgICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihiKSkgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJndW1lbnQgbXVzdCBiZSBhIEJ1ZmZlcicpCiAgICBpZiAodGhpcyA9PT0gYikgcmV0dXJuIHRydWUKICAgIHJldHVybiBCdWZmZXIuY29tcGFyZSh0aGlzLCBiKSA9PT0gMAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLmluc3BlY3QgPSBmdW5jdGlvbiBpbnNwZWN0ICgpIHsKICAgIHZhciBzdHIgPSAnJwogICAgdmFyIG1heCA9IGV4cG9ydHMuSU5TUEVDVF9NQVhfQllURVMKICAgIGlmICh0aGlzLmxlbmd0aCA+IDApIHsKICAgICAgc3RyID0gdGhpcy50b1N0cmluZygnaGV4JywgMCwgbWF4KS5tYXRjaCgvLnsyfS9nKS5qb2luKCcgJykKICAgICAgaWYgKHRoaXMubGVuZ3RoID4gbWF4KSBzdHIgKz0gJyAuLi4gJwogICAgfQogICAgcmV0dXJuICc8QnVmZmVyICcgKyBzdHIgKyAnPicKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5jb21wYXJlID0gZnVuY3Rpb24gY29tcGFyZSAodGFyZ2V0LCBzdGFydCwgZW5kLCB0aGlzU3RhcnQsIHRoaXNFbmQpIHsKICAgIGlmICghQnVmZmVyLmlzQnVmZmVyKHRhcmdldCkpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJndW1lbnQgbXVzdCBiZSBhIEJ1ZmZlcicpCiAgICB9CiAgCiAgICBpZiAoc3RhcnQgPT09IHVuZGVmaW5lZCkgewogICAgICBzdGFydCA9IDAKICAgIH0KICAgIGlmIChlbmQgPT09IHVuZGVmaW5lZCkgewogICAgICBlbmQgPSB0YXJnZXQgPyB0YXJnZXQubGVuZ3RoIDogMAogICAgfQogICAgaWYgKHRoaXNTdGFydCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHRoaXNTdGFydCA9IDAKICAgIH0KICAgIGlmICh0aGlzRW5kID09PSB1bmRlZmluZWQpIHsKICAgICAgdGhpc0VuZCA9IHRoaXMubGVuZ3RoCiAgICB9CiAgCiAgICBpZiAoc3RhcnQgPCAwIHx8IGVuZCA+IHRhcmdldC5sZW5ndGggfHwgdGhpc1N0YXJ0IDwgMCB8fCB0aGlzRW5kID4gdGhpcy5sZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ291dCBvZiByYW5nZSBpbmRleCcpCiAgICB9CiAgCiAgICBpZiAodGhpc1N0YXJ0ID49IHRoaXNFbmQgJiYgc3RhcnQgPj0gZW5kKSB7CiAgICAgIHJldHVybiAwCiAgICB9CiAgICBpZiAodGhpc1N0YXJ0ID49IHRoaXNFbmQpIHsKICAgICAgcmV0dXJuIC0xCiAgICB9CiAgICBpZiAoc3RhcnQgPj0gZW5kKSB7CiAgICAgIHJldHVybiAxCiAgICB9CiAgCiAgICBzdGFydCA+Pj49IDAKICAgIGVuZCA+Pj49IDAKICAgIHRoaXNTdGFydCA+Pj49IDAKICAgIHRoaXNFbmQgPj4+PSAwCiAgCiAgICBpZiAodGhpcyA9PT0gdGFyZ2V0KSByZXR1cm4gMAogIAogICAgdmFyIHggPSB0aGlzRW5kIC0gdGhpc1N0YXJ0CiAgICB2YXIgeSA9IGVuZCAtIHN0YXJ0CiAgICB2YXIgbGVuID0gTWF0aC5taW4oeCwgeSkKICAKICAgIHZhciB0aGlzQ29weSA9IHRoaXMuc2xpY2UodGhpc1N0YXJ0LCB0aGlzRW5kKQogICAgdmFyIHRhcmdldENvcHkgPSB0YXJnZXQuc2xpY2Uoc3RhcnQsIGVuZCkKICAKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgICAgaWYgKHRoaXNDb3B5W2ldICE9PSB0YXJnZXRDb3B5W2ldKSB7CiAgICAgICAgeCA9IHRoaXNDb3B5W2ldCiAgICAgICAgeSA9IHRhcmdldENvcHlbaV0KICAgICAgICBicmVhawogICAgICB9CiAgICB9CiAgCiAgICBpZiAoeCA8IHkpIHJldHVybiAtMQogICAgaWYgKHkgPCB4KSByZXR1cm4gMQogICAgcmV0dXJuIDAKICB9CiAgCiAgLy8gRmluZHMgZWl0aGVyIHRoZSBmaXJzdCBpbmRleCBvZiBgdmFsYCBpbiBgYnVmZmVyYCBhdCBvZmZzZXQgPj0gYGJ5dGVPZmZzZXRgLAogIC8vIE9SIHRoZSBsYXN0IGluZGV4IG9mIGB2YWxgIGluIGBidWZmZXJgIGF0IG9mZnNldCA8PSBgYnl0ZU9mZnNldGAuCiAgLy8KICAvLyBBcmd1bWVudHM6CiAgLy8gLSBidWZmZXIgLSBhIEJ1ZmZlciB0byBzZWFyY2gKICAvLyAtIHZhbCAtIGEgc3RyaW5nLCBCdWZmZXIsIG9yIG51bWJlcgogIC8vIC0gYnl0ZU9mZnNldCAtIGFuIGluZGV4IGludG8gYGJ1ZmZlcmA7IHdpbGwgYmUgY2xhbXBlZCB0byBhbiBpbnQzMgogIC8vIC0gZW5jb2RpbmcgLSBhbiBvcHRpb25hbCBlbmNvZGluZywgcmVsZXZhbnQgaXMgdmFsIGlzIGEgc3RyaW5nCiAgLy8gLSBkaXIgLSB0cnVlIGZvciBpbmRleE9mLCBmYWxzZSBmb3IgbGFzdEluZGV4T2YKICBmdW5jdGlvbiBiaWRpcmVjdGlvbmFsSW5kZXhPZiAoYnVmZmVyLCB2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCBkaXIpIHsKICAgIC8vIEVtcHR5IGJ1ZmZlciBtZWFucyBubyBtYXRjaAogICAgaWYgKGJ1ZmZlci5sZW5ndGggPT09IDApIHJldHVybiAtMQogIAogICAgLy8gTm9ybWFsaXplIGJ5dGVPZmZzZXQKICAgIGlmICh0eXBlb2YgYnl0ZU9mZnNldCA9PT0gJ3N0cmluZycpIHsKICAgICAgZW5jb2RpbmcgPSBieXRlT2Zmc2V0CiAgICAgIGJ5dGVPZmZzZXQgPSAwCiAgICB9IGVsc2UgaWYgKGJ5dGVPZmZzZXQgPiAweDdmZmZmZmZmKSB7CiAgICAgIGJ5dGVPZmZzZXQgPSAweDdmZmZmZmZmCiAgICB9IGVsc2UgaWYgKGJ5dGVPZmZzZXQgPCAtMHg4MDAwMDAwMCkgewogICAgICBieXRlT2Zmc2V0ID0gLTB4ODAwMDAwMDAKICAgIH0KICAgIGJ5dGVPZmZzZXQgPSArYnl0ZU9mZnNldCAgLy8gQ29lcmNlIHRvIE51bWJlci4KICAgIGlmIChpc05hTihieXRlT2Zmc2V0KSkgewogICAgICAvLyBieXRlT2Zmc2V0OiBpdCBpdCdzIHVuZGVmaW5lZCwgbnVsbCwgTmFOLCAiZm9vIiwgZXRjLCBzZWFyY2ggd2hvbGUgYnVmZmVyCiAgICAgIGJ5dGVPZmZzZXQgPSBkaXIgPyAwIDogKGJ1ZmZlci5sZW5ndGggLSAxKQogICAgfQogIAogICAgLy8gTm9ybWFsaXplIGJ5dGVPZmZzZXQ6IG5lZ2F0aXZlIG9mZnNldHMgc3RhcnQgZnJvbSB0aGUgZW5kIG9mIHRoZSBidWZmZXIKICAgIGlmIChieXRlT2Zmc2V0IDwgMCkgYnl0ZU9mZnNldCA9IGJ1ZmZlci5sZW5ndGggKyBieXRlT2Zmc2V0CiAgICBpZiAoYnl0ZU9mZnNldCA+PSBidWZmZXIubGVuZ3RoKSB7CiAgICAgIGlmIChkaXIpIHJldHVybiAtMQogICAgICBlbHNlIGJ5dGVPZmZzZXQgPSBidWZmZXIubGVuZ3RoIC0gMQogICAgfSBlbHNlIGlmIChieXRlT2Zmc2V0IDwgMCkgewogICAgICBpZiAoZGlyKSBieXRlT2Zmc2V0ID0gMAogICAgICBlbHNlIHJldHVybiAtMQogICAgfQogIAogICAgLy8gTm9ybWFsaXplIHZhbAogICAgaWYgKHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnKSB7CiAgICAgIHZhbCA9IEJ1ZmZlci5mcm9tKHZhbCwgZW5jb2RpbmcpCiAgICB9CiAgCiAgICAvLyBGaW5hbGx5LCBzZWFyY2ggZWl0aGVyIGluZGV4T2YgKGlmIGRpciBpcyB0cnVlKSBvciBsYXN0SW5kZXhPZgogICAgaWYgKEJ1ZmZlci5pc0J1ZmZlcih2YWwpKSB7CiAgICAgIC8vIFNwZWNpYWwgY2FzZTogbG9va2luZyBmb3IgZW1wdHkgc3RyaW5nL2J1ZmZlciBhbHdheXMgZmFpbHMKICAgICAgaWYgKHZhbC5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gLTEKICAgICAgfQogICAgICByZXR1cm4gYXJyYXlJbmRleE9mKGJ1ZmZlciwgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZGlyKQogICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgICB2YWwgPSB2YWwgJiAweEZGIC8vIFNlYXJjaCBmb3IgYSBieXRlIHZhbHVlIFswLTI1NV0KICAgICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUICYmCiAgICAgICAgICB0eXBlb2YgVWludDhBcnJheS5wcm90b3R5cGUuaW5kZXhPZiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGlmIChkaXIpIHsKICAgICAgICAgIHJldHVybiBVaW50OEFycmF5LnByb3RvdHlwZS5pbmRleE9mLmNhbGwoYnVmZmVyLCB2YWwsIGJ5dGVPZmZzZXQpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBVaW50OEFycmF5LnByb3RvdHlwZS5sYXN0SW5kZXhPZi5jYWxsKGJ1ZmZlciwgdmFsLCBieXRlT2Zmc2V0KQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gYXJyYXlJbmRleE9mKGJ1ZmZlciwgWyB2YWwgXSwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGRpcikKICAgIH0KICAKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ3ZhbCBtdXN0IGJlIHN0cmluZywgbnVtYmVyIG9yIEJ1ZmZlcicpCiAgfQogIAogIGZ1bmN0aW9uIGFycmF5SW5kZXhPZiAoYXJyLCB2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCBkaXIpIHsKICAgIHZhciBpbmRleFNpemUgPSAxCiAgICB2YXIgYXJyTGVuZ3RoID0gYXJyLmxlbmd0aAogICAgdmFyIHZhbExlbmd0aCA9IHZhbC5sZW5ndGgKICAKICAgIGlmIChlbmNvZGluZyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGVuY29kaW5nID0gU3RyaW5nKGVuY29kaW5nKS50b0xvd2VyQ2FzZSgpCiAgICAgIGlmIChlbmNvZGluZyA9PT0gJ3VjczInIHx8IGVuY29kaW5nID09PSAndWNzLTInIHx8CiAgICAgICAgICBlbmNvZGluZyA9PT0gJ3V0ZjE2bGUnIHx8IGVuY29kaW5nID09PSAndXRmLTE2bGUnKSB7CiAgICAgICAgaWYgKGFyci5sZW5ndGggPCAyIHx8IHZhbC5sZW5ndGggPCAyKSB7CiAgICAgICAgICByZXR1cm4gLTEKICAgICAgICB9CiAgICAgICAgaW5kZXhTaXplID0gMgogICAgICAgIGFyckxlbmd0aCAvPSAyCiAgICAgICAgdmFsTGVuZ3RoIC89IDIKICAgICAgICBieXRlT2Zmc2V0IC89IDIKICAgICAgfQogICAgfQogIAogICAgZnVuY3Rpb24gcmVhZCAoYnVmLCBpKSB7CiAgICAgIGlmIChpbmRleFNpemUgPT09IDEpIHsKICAgICAgICByZXR1cm4gYnVmW2ldCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGJ1Zi5yZWFkVUludDE2QkUoaSAqIGluZGV4U2l6ZSkKICAgICAgfQogICAgfQogIAogICAgdmFyIGkKICAgIGlmIChkaXIpIHsKICAgICAgdmFyIGZvdW5kSW5kZXggPSAtMQogICAgICBmb3IgKGkgPSBieXRlT2Zmc2V0OyBpIDwgYXJyTGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAocmVhZChhcnIsIGkpID09PSByZWFkKHZhbCwgZm91bmRJbmRleCA9PT0gLTEgPyAwIDogaSAtIGZvdW5kSW5kZXgpKSB7CiAgICAgICAgICBpZiAoZm91bmRJbmRleCA9PT0gLTEpIGZvdW5kSW5kZXggPSBpCiAgICAgICAgICBpZiAoaSAtIGZvdW5kSW5kZXggKyAxID09PSB2YWxMZW5ndGgpIHJldHVybiBmb3VuZEluZGV4ICogaW5kZXhTaXplCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChmb3VuZEluZGV4ICE9PSAtMSkgaSAtPSBpIC0gZm91bmRJbmRleAogICAgICAgICAgZm91bmRJbmRleCA9IC0xCiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoYnl0ZU9mZnNldCArIHZhbExlbmd0aCA+IGFyckxlbmd0aCkgYnl0ZU9mZnNldCA9IGFyckxlbmd0aCAtIHZhbExlbmd0aAogICAgICBmb3IgKGkgPSBieXRlT2Zmc2V0OyBpID49IDA7IGktLSkgewogICAgICAgIHZhciBmb3VuZCA9IHRydWUKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHZhbExlbmd0aDsgaisrKSB7CiAgICAgICAgICBpZiAocmVhZChhcnIsIGkgKyBqKSAhPT0gcmVhZCh2YWwsIGopKSB7CiAgICAgICAgICAgIGZvdW5kID0gZmFsc2UKICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGZvdW5kKSByZXR1cm4gaQogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gLTEKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5pbmNsdWRlcyA9IGZ1bmN0aW9uIGluY2x1ZGVzICh2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKSB7CiAgICByZXR1cm4gdGhpcy5pbmRleE9mKHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpICE9PSAtMQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLmluZGV4T2YgPSBmdW5jdGlvbiBpbmRleE9mICh2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKSB7CiAgICByZXR1cm4gYmlkaXJlY3Rpb25hbEluZGV4T2YodGhpcywgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgdHJ1ZSkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5sYXN0SW5kZXhPZiA9IGZ1bmN0aW9uIGxhc3RJbmRleE9mICh2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKSB7CiAgICByZXR1cm4gYmlkaXJlY3Rpb25hbEluZGV4T2YodGhpcywgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZmFsc2UpCiAgfQogIAogIGZ1bmN0aW9uIGhleFdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIG9mZnNldCA9IE51bWJlcihvZmZzZXQpIHx8IDAKICAgIHZhciByZW1haW5pbmcgPSBidWYubGVuZ3RoIC0gb2Zmc2V0CiAgICBpZiAoIWxlbmd0aCkgewogICAgICBsZW5ndGggPSByZW1haW5pbmcKICAgIH0gZWxzZSB7CiAgICAgIGxlbmd0aCA9IE51bWJlcihsZW5ndGgpCiAgICAgIGlmIChsZW5ndGggPiByZW1haW5pbmcpIHsKICAgICAgICBsZW5ndGggPSByZW1haW5pbmcKICAgICAgfQogICAgfQogIAogICAgLy8gbXVzdCBiZSBhbiBldmVuIG51bWJlciBvZiBkaWdpdHMKICAgIHZhciBzdHJMZW4gPSBzdHJpbmcubGVuZ3RoCiAgICBpZiAoc3RyTGVuICUgMiAhPT0gMCkgdGhyb3cgbmV3IFR5cGVFcnJvcignSW52YWxpZCBoZXggc3RyaW5nJykKICAKICAgIGlmIChsZW5ndGggPiBzdHJMZW4gLyAyKSB7CiAgICAgIGxlbmd0aCA9IHN0ckxlbiAvIDIKICAgIH0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgdmFyIHBhcnNlZCA9IHBhcnNlSW50KHN0cmluZy5zdWJzdHIoaSAqIDIsIDIpLCAxNikKICAgICAgaWYgKGlzTmFOKHBhcnNlZCkpIHJldHVybiBpCiAgICAgIGJ1ZltvZmZzZXQgKyBpXSA9IHBhcnNlZAogICAgfQogICAgcmV0dXJuIGkKICB9CiAgCiAgZnVuY3Rpb24gdXRmOFdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIHJldHVybiBibGl0QnVmZmVyKHV0ZjhUb0J5dGVzKHN0cmluZywgYnVmLmxlbmd0aCAtIG9mZnNldCksIGJ1Ziwgb2Zmc2V0LCBsZW5ndGgpCiAgfQogIAogIGZ1bmN0aW9uIGFzY2lpV3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogICAgcmV0dXJuIGJsaXRCdWZmZXIoYXNjaWlUb0J5dGVzKHN0cmluZyksIGJ1Ziwgb2Zmc2V0LCBsZW5ndGgpCiAgfQogIAogIGZ1bmN0aW9uIGxhdGluMVdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIHJldHVybiBhc2NpaVdyaXRlKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKICB9CiAgCiAgZnVuY3Rpb24gYmFzZTY0V3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogICAgcmV0dXJuIGJsaXRCdWZmZXIoYmFzZTY0VG9CeXRlcyhzdHJpbmcpLCBidWYsIG9mZnNldCwgbGVuZ3RoKQogIH0KICAKICBmdW5jdGlvbiB1Y3MyV3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogICAgcmV0dXJuIGJsaXRCdWZmZXIodXRmMTZsZVRvQnl0ZXMoc3RyaW5nLCBidWYubGVuZ3RoIC0gb2Zmc2V0KSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZSA9IGZ1bmN0aW9uIHdyaXRlIChzdHJpbmcsIG9mZnNldCwgbGVuZ3RoLCBlbmNvZGluZykgewogICAgLy8gQnVmZmVyI3dyaXRlKHN0cmluZykKICAgIGlmIChvZmZzZXQgPT09IHVuZGVmaW5lZCkgewogICAgICBlbmNvZGluZyA9ICd1dGY4JwogICAgICBsZW5ndGggPSB0aGlzLmxlbmd0aAogICAgICBvZmZzZXQgPSAwCiAgICAvLyBCdWZmZXIjd3JpdGUoc3RyaW5nLCBlbmNvZGluZykKICAgIH0gZWxzZSBpZiAobGVuZ3RoID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIG9mZnNldCA9PT0gJ3N0cmluZycpIHsKICAgICAgZW5jb2RpbmcgPSBvZmZzZXQKICAgICAgbGVuZ3RoID0gdGhpcy5sZW5ndGgKICAgICAgb2Zmc2V0ID0gMAogICAgLy8gQnVmZmVyI3dyaXRlKHN0cmluZywgb2Zmc2V0WywgbGVuZ3RoXVssIGVuY29kaW5nXSkKICAgIH0gZWxzZSBpZiAoaXNGaW5pdGUob2Zmc2V0KSkgewogICAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICAgIGlmIChpc0Zpbml0ZShsZW5ndGgpKSB7CiAgICAgICAgbGVuZ3RoID0gbGVuZ3RoIHwgMAogICAgICAgIGlmIChlbmNvZGluZyA9PT0gdW5kZWZpbmVkKSBlbmNvZGluZyA9ICd1dGY4JwogICAgICB9IGVsc2UgewogICAgICAgIGVuY29kaW5nID0gbGVuZ3RoCiAgICAgICAgbGVuZ3RoID0gdW5kZWZpbmVkCiAgICAgIH0KICAgIC8vIGxlZ2FjeSB3cml0ZShzdHJpbmcsIGVuY29kaW5nLCBvZmZzZXQsIGxlbmd0aCkgLSByZW1vdmUgaW4gdjAuMTMKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAnQnVmZmVyLndyaXRlKHN0cmluZywgZW5jb2RpbmcsIG9mZnNldFssIGxlbmd0aF0pIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQnCiAgICAgICkKICAgIH0KICAKICAgIHZhciByZW1haW5pbmcgPSB0aGlzLmxlbmd0aCAtIG9mZnNldAogICAgaWYgKGxlbmd0aCA9PT0gdW5kZWZpbmVkIHx8IGxlbmd0aCA+IHJlbWFpbmluZykgbGVuZ3RoID0gcmVtYWluaW5nCiAgCiAgICBpZiAoKHN0cmluZy5sZW5ndGggPiAwICYmIChsZW5ndGggPCAwIHx8IG9mZnNldCA8IDApKSB8fCBvZmZzZXQgPiB0aGlzLmxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQXR0ZW1wdCB0byB3cml0ZSBvdXRzaWRlIGJ1ZmZlciBib3VuZHMnKQogICAgfQogIAogICAgaWYgKCFlbmNvZGluZykgZW5jb2RpbmcgPSAndXRmOCcKICAKICAgIHZhciBsb3dlcmVkQ2FzZSA9IGZhbHNlCiAgICBmb3IgKDs7KSB7CiAgICAgIHN3aXRjaCAoZW5jb2RpbmcpIHsKICAgICAgICBjYXNlICdoZXgnOgogICAgICAgICAgcmV0dXJuIGhleFdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgCiAgICAgICAgY2FzZSAndXRmOCc6CiAgICAgICAgY2FzZSAndXRmLTgnOgogICAgICAgICAgcmV0dXJuIHV0ZjhXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogIAogICAgICAgIGNhc2UgJ2FzY2lpJzoKICAgICAgICAgIHJldHVybiBhc2NpaVdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgCiAgICAgICAgY2FzZSAnbGF0aW4xJzoKICAgICAgICBjYXNlICdiaW5hcnknOgogICAgICAgICAgcmV0dXJuIGxhdGluMVdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgCiAgICAgICAgY2FzZSAnYmFzZTY0JzoKICAgICAgICAgIC8vIFdhcm5pbmc6IG1heExlbmd0aCBub3QgdGFrZW4gaW50byBhY2NvdW50IGluIGJhc2U2NFdyaXRlCiAgICAgICAgICByZXR1cm4gYmFzZTY0V3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKICAKICAgICAgICBjYXNlICd1Y3MyJzoKICAgICAgICBjYXNlICd1Y3MtMic6CiAgICAgICAgY2FzZSAndXRmMTZsZSc6CiAgICAgICAgY2FzZSAndXRmLTE2bGUnOgogICAgICAgICAgcmV0dXJuIHVjczJXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogIAogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBpZiAobG93ZXJlZENhc2UpIHRocm93IG5ldyBUeXBlRXJyb3IoJ1Vua25vd24gZW5jb2Rpbmc6ICcgKyBlbmNvZGluZykKICAgICAgICAgIGVuY29kaW5nID0gKCcnICsgZW5jb2RpbmcpLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIGxvd2VyZWRDYXNlID0gdHJ1ZQogICAgICB9CiAgICB9CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gdG9KU09OICgpIHsKICAgIHJldHVybiB7CiAgICAgIHR5cGU6ICdCdWZmZXInLAogICAgICBkYXRhOiBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0aGlzLl9hcnIgfHwgdGhpcywgMCkKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gYmFzZTY0U2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogICAgaWYgKHN0YXJ0ID09PSAwICYmIGVuZCA9PT0gYnVmLmxlbmd0aCkgewogICAgICByZXR1cm4gYmFzZTY0LmZyb21CeXRlQXJyYXkoYnVmKQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGJhc2U2NC5mcm9tQnl0ZUFycmF5KGJ1Zi5zbGljZShzdGFydCwgZW5kKSkKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gdXRmOFNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICAgIGVuZCA9IE1hdGgubWluKGJ1Zi5sZW5ndGgsIGVuZCkKICAgIHZhciByZXMgPSBbXQogIAogICAgdmFyIGkgPSBzdGFydAogICAgd2hpbGUgKGkgPCBlbmQpIHsKICAgICAgdmFyIGZpcnN0Qnl0ZSA9IGJ1ZltpXQogICAgICB2YXIgY29kZVBvaW50ID0gbnVsbAogICAgICB2YXIgYnl0ZXNQZXJTZXF1ZW5jZSA9IChmaXJzdEJ5dGUgPiAweEVGKSA/IDQKICAgICAgICA6IChmaXJzdEJ5dGUgPiAweERGKSA/IDMKICAgICAgICA6IChmaXJzdEJ5dGUgPiAweEJGKSA/IDIKICAgICAgICA6IDEKICAKICAgICAgaWYgKGkgKyBieXRlc1BlclNlcXVlbmNlIDw9IGVuZCkgewogICAgICAgIHZhciBzZWNvbmRCeXRlLCB0aGlyZEJ5dGUsIGZvdXJ0aEJ5dGUsIHRlbXBDb2RlUG9pbnQKICAKICAgICAgICBzd2l0Y2ggKGJ5dGVzUGVyU2VxdWVuY2UpIHsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgaWYgKGZpcnN0Qnl0ZSA8IDB4ODApIHsKICAgICAgICAgICAgICBjb2RlUG9pbnQgPSBmaXJzdEJ5dGUKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICBzZWNvbmRCeXRlID0gYnVmW2kgKyAxXQogICAgICAgICAgICBpZiAoKHNlY29uZEJ5dGUgJiAweEMwKSA9PT0gMHg4MCkgewogICAgICAgICAgICAgIHRlbXBDb2RlUG9pbnQgPSAoZmlyc3RCeXRlICYgMHgxRikgPDwgMHg2IHwgKHNlY29uZEJ5dGUgJiAweDNGKQogICAgICAgICAgICAgIGlmICh0ZW1wQ29kZVBvaW50ID4gMHg3RikgewogICAgICAgICAgICAgICAgY29kZVBvaW50ID0gdGVtcENvZGVQb2ludAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICBzZWNvbmRCeXRlID0gYnVmW2kgKyAxXQogICAgICAgICAgICB0aGlyZEJ5dGUgPSBidWZbaSArIDJdCiAgICAgICAgICAgIGlmICgoc2Vjb25kQnl0ZSAmIDB4QzApID09PSAweDgwICYmICh0aGlyZEJ5dGUgJiAweEMwKSA9PT0gMHg4MCkgewogICAgICAgICAgICAgIHRlbXBDb2RlUG9pbnQgPSAoZmlyc3RCeXRlICYgMHhGKSA8PCAweEMgfCAoc2Vjb25kQnl0ZSAmIDB4M0YpIDw8IDB4NiB8ICh0aGlyZEJ5dGUgJiAweDNGKQogICAgICAgICAgICAgIGlmICh0ZW1wQ29kZVBvaW50ID4gMHg3RkYgJiYgKHRlbXBDb2RlUG9pbnQgPCAweEQ4MDAgfHwgdGVtcENvZGVQb2ludCA+IDB4REZGRikpIHsKICAgICAgICAgICAgICAgIGNvZGVQb2ludCA9IHRlbXBDb2RlUG9pbnQKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgc2Vjb25kQnl0ZSA9IGJ1ZltpICsgMV0KICAgICAgICAgICAgdGhpcmRCeXRlID0gYnVmW2kgKyAyXQogICAgICAgICAgICBmb3VydGhCeXRlID0gYnVmW2kgKyAzXQogICAgICAgICAgICBpZiAoKHNlY29uZEJ5dGUgJiAweEMwKSA9PT0gMHg4MCAmJiAodGhpcmRCeXRlICYgMHhDMCkgPT09IDB4ODAgJiYgKGZvdXJ0aEJ5dGUgJiAweEMwKSA9PT0gMHg4MCkgewogICAgICAgICAgICAgIHRlbXBDb2RlUG9pbnQgPSAoZmlyc3RCeXRlICYgMHhGKSA8PCAweDEyIHwgKHNlY29uZEJ5dGUgJiAweDNGKSA8PCAweEMgfCAodGhpcmRCeXRlICYgMHgzRikgPDwgMHg2IHwgKGZvdXJ0aEJ5dGUgJiAweDNGKQogICAgICAgICAgICAgIGlmICh0ZW1wQ29kZVBvaW50ID4gMHhGRkZGICYmIHRlbXBDb2RlUG9pbnQgPCAweDExMDAwMCkgewogICAgICAgICAgICAgICAgY29kZVBvaW50ID0gdGVtcENvZGVQb2ludAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogIAogICAgICBpZiAoY29kZVBvaW50ID09PSBudWxsKSB7CiAgICAgICAgLy8gd2UgZGlkIG5vdCBnZW5lcmF0ZSBhIHZhbGlkIGNvZGVQb2ludCBzbyBpbnNlcnQgYQogICAgICAgIC8vIHJlcGxhY2VtZW50IGNoYXIgKFUrRkZGRCkgYW5kIGFkdmFuY2Ugb25seSAxIGJ5dGUKICAgICAgICBjb2RlUG9pbnQgPSAweEZGRkQKICAgICAgICBieXRlc1BlclNlcXVlbmNlID0gMQogICAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA+IDB4RkZGRikgewogICAgICAgIC8vIGVuY29kZSB0byB1dGYxNiAoc3Vycm9nYXRlIHBhaXIgZGFuY2UpCiAgICAgICAgY29kZVBvaW50IC09IDB4MTAwMDAKICAgICAgICByZXMucHVzaChjb2RlUG9pbnQgPj4+IDEwICYgMHgzRkYgfCAweEQ4MDApCiAgICAgICAgY29kZVBvaW50ID0gMHhEQzAwIHwgY29kZVBvaW50ICYgMHgzRkYKICAgICAgfQogIAogICAgICByZXMucHVzaChjb2RlUG9pbnQpCiAgICAgIGkgKz0gYnl0ZXNQZXJTZXF1ZW5jZQogICAgfQogIAogICAgcmV0dXJuIGRlY29kZUNvZGVQb2ludHNBcnJheShyZXMpCiAgfQogIAogIC8vIEJhc2VkIG9uIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzIyNzQ3MjcyLzY4MDc0MiwgdGhlIGJyb3dzZXIgd2l0aAogIC8vIHRoZSBsb3dlc3QgbGltaXQgaXMgQ2hyb21lLCB3aXRoIDB4MTAwMDAgYXJncy4KICAvLyBXZSBnbyAxIG1hZ25pdHVkZSBsZXNzLCBmb3Igc2FmZXR5CiAgdmFyIE1BWF9BUkdVTUVOVFNfTEVOR1RIID0gMHgxMDAwCiAgCiAgZnVuY3Rpb24gZGVjb2RlQ29kZVBvaW50c0FycmF5IChjb2RlUG9pbnRzKSB7CiAgICB2YXIgbGVuID0gY29kZVBvaW50cy5sZW5ndGgKICAgIGlmIChsZW4gPD0gTUFYX0FSR1VNRU5UU19MRU5HVEgpIHsKICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoU3RyaW5nLCBjb2RlUG9pbnRzKSAvLyBhdm9pZCBleHRyYSBzbGljZSgpCiAgICB9CiAgCiAgICAvLyBEZWNvZGUgaW4gY2h1bmtzIHRvIGF2b2lkICJjYWxsIHN0YWNrIHNpemUgZXhjZWVkZWQiLgogICAgdmFyIHJlcyA9ICcnCiAgICB2YXIgaSA9IDAKICAgIHdoaWxlIChpIDwgbGVuKSB7CiAgICAgIHJlcyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KAogICAgICAgIFN0cmluZywKICAgICAgICBjb2RlUG9pbnRzLnNsaWNlKGksIGkgKz0gTUFYX0FSR1VNRU5UU19MRU5HVEgpCiAgICAgICkKICAgIH0KICAgIHJldHVybiByZXMKICB9CiAgCiAgZnVuY3Rpb24gYXNjaWlTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgICB2YXIgcmV0ID0gJycKICAgIGVuZCA9IE1hdGgubWluKGJ1Zi5sZW5ndGgsIGVuZCkKICAKICAgIGZvciAodmFyIGkgPSBzdGFydDsgaSA8IGVuZDsgKytpKSB7CiAgICAgIHJldCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ1ZltpXSAmIDB4N0YpCiAgICB9CiAgICByZXR1cm4gcmV0CiAgfQogIAogIGZ1bmN0aW9uIGxhdGluMVNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICAgIHZhciByZXQgPSAnJwogICAgZW5kID0gTWF0aC5taW4oYnVmLmxlbmd0aCwgZW5kKQogIAogICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgZW5kOyArK2kpIHsKICAgICAgcmV0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnVmW2ldKQogICAgfQogICAgcmV0dXJuIHJldAogIH0KICAKICBmdW5jdGlvbiBoZXhTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgICB2YXIgbGVuID0gYnVmLmxlbmd0aAogIAogICAgaWYgKCFzdGFydCB8fCBzdGFydCA8IDApIHN0YXJ0ID0gMAogICAgaWYgKCFlbmQgfHwgZW5kIDwgMCB8fCBlbmQgPiBsZW4pIGVuZCA9IGxlbgogIAogICAgdmFyIG91dCA9ICcnCiAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7ICsraSkgewogICAgICBvdXQgKz0gdG9IZXgoYnVmW2ldKQogICAgfQogICAgcmV0dXJuIG91dAogIH0KICAKICBmdW5jdGlvbiB1dGYxNmxlU2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogICAgdmFyIGJ5dGVzID0gYnVmLnNsaWNlKHN0YXJ0LCBlbmQpCiAgICB2YXIgcmVzID0gJycKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYnl0ZXMubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgcmVzICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnl0ZXNbaV0gKyBieXRlc1tpICsgMV0gKiAyNTYpCiAgICB9CiAgICByZXR1cm4gcmVzCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuc2xpY2UgPSBmdW5jdGlvbiBzbGljZSAoc3RhcnQsIGVuZCkgewogICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoCiAgICBzdGFydCA9IH5+c3RhcnQKICAgIGVuZCA9IGVuZCA9PT0gdW5kZWZpbmVkID8gbGVuIDogfn5lbmQKICAKICAgIGlmIChzdGFydCA8IDApIHsKICAgICAgc3RhcnQgKz0gbGVuCiAgICAgIGlmIChzdGFydCA8IDApIHN0YXJ0ID0gMAogICAgfSBlbHNlIGlmIChzdGFydCA+IGxlbikgewogICAgICBzdGFydCA9IGxlbgogICAgfQogIAogICAgaWYgKGVuZCA8IDApIHsKICAgICAgZW5kICs9IGxlbgogICAgICBpZiAoZW5kIDwgMCkgZW5kID0gMAogICAgfSBlbHNlIGlmIChlbmQgPiBsZW4pIHsKICAgICAgZW5kID0gbGVuCiAgICB9CiAgCiAgICBpZiAoZW5kIDwgc3RhcnQpIGVuZCA9IHN0YXJ0CiAgCiAgICB2YXIgbmV3QnVmCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgbmV3QnVmID0gdGhpcy5zdWJhcnJheShzdGFydCwgZW5kKQogICAgICBuZXdCdWYuX19wcm90b19fID0gQnVmZmVyLnByb3RvdHlwZQogICAgfSBlbHNlIHsKICAgICAgdmFyIHNsaWNlTGVuID0gZW5kIC0gc3RhcnQKICAgICAgbmV3QnVmID0gbmV3IEJ1ZmZlcihzbGljZUxlbiwgdW5kZWZpbmVkKQogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNsaWNlTGVuOyArK2kpIHsKICAgICAgICBuZXdCdWZbaV0gPSB0aGlzW2kgKyBzdGFydF0KICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIG5ld0J1ZgogIH0KICAKICAvKgogICAqIE5lZWQgdG8gbWFrZSBzdXJlIHRoYXQgYnVmZmVyIGlzbid0IHRyeWluZyB0byB3cml0ZSBvdXQgb2YgYm91bmRzLgogICAqLwogIGZ1bmN0aW9uIGNoZWNrT2Zmc2V0IChvZmZzZXQsIGV4dCwgbGVuZ3RoKSB7CiAgICBpZiAoKG9mZnNldCAlIDEpICE9PSAwIHx8IG9mZnNldCA8IDApIHRocm93IG5ldyBSYW5nZUVycm9yKCdvZmZzZXQgaXMgbm90IHVpbnQnKQogICAgaWYgKG9mZnNldCArIGV4dCA+IGxlbmd0aCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ1RyeWluZyB0byBhY2Nlc3MgYmV5b25kIGJ1ZmZlciBsZW5ndGgnKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50TEUgPSBmdW5jdGlvbiByZWFkVUludExFIChvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgYnl0ZUxlbmd0aCwgdGhpcy5sZW5ndGgpCiAgCiAgICB2YXIgdmFsID0gdGhpc1tvZmZzZXRdCiAgICB2YXIgbXVsID0gMQogICAgdmFyIGkgPSAwCiAgICB3aGlsZSAoKytpIDwgYnl0ZUxlbmd0aCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICB2YWwgKz0gdGhpc1tvZmZzZXQgKyBpXSAqIG11bAogICAgfQogIAogICAgcmV0dXJuIHZhbAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50QkUgPSBmdW5jdGlvbiByZWFkVUludEJFIChvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIHsKICAgICAgY2hlY2tPZmZzZXQob2Zmc2V0LCBieXRlTGVuZ3RoLCB0aGlzLmxlbmd0aCkKICAgIH0KICAKICAgIHZhciB2YWwgPSB0aGlzW29mZnNldCArIC0tYnl0ZUxlbmd0aF0KICAgIHZhciBtdWwgPSAxCiAgICB3aGlsZSAoYnl0ZUxlbmd0aCA+IDAgJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgdmFsICs9IHRoaXNbb2Zmc2V0ICsgLS1ieXRlTGVuZ3RoXSAqIG11bAogICAgfQogIAogICAgcmV0dXJuIHZhbAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50OCA9IGZ1bmN0aW9uIHJlYWRVSW50OCAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAxLCB0aGlzLmxlbmd0aCkKICAgIHJldHVybiB0aGlzW29mZnNldF0KICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDE2TEUgPSBmdW5jdGlvbiByZWFkVUludDE2TEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpCiAgICByZXR1cm4gdGhpc1tvZmZzZXRdIHwgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDE2QkUgPSBmdW5jdGlvbiByZWFkVUludDE2QkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpCiAgICByZXR1cm4gKHRoaXNbb2Zmc2V0XSA8PCA4KSB8IHRoaXNbb2Zmc2V0ICsgMV0KICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDMyTEUgPSBmdW5jdGlvbiByZWFkVUludDMyTEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCiAgCiAgICByZXR1cm4gKCh0aGlzW29mZnNldF0pIHwKICAgICAgICAodGhpc1tvZmZzZXQgKyAxXSA8PCA4KSB8CiAgICAgICAgKHRoaXNbb2Zmc2V0ICsgMl0gPDwgMTYpKSArCiAgICAgICAgKHRoaXNbb2Zmc2V0ICsgM10gKiAweDEwMDAwMDApCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQzMkJFID0gZnVuY3Rpb24gcmVhZFVJbnQzMkJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQogIAogICAgcmV0dXJuICh0aGlzW29mZnNldF0gKiAweDEwMDAwMDApICsKICAgICAgKCh0aGlzW29mZnNldCArIDFdIDw8IDE2KSB8CiAgICAgICh0aGlzW29mZnNldCArIDJdIDw8IDgpIHwKICAgICAgdGhpc1tvZmZzZXQgKyAzXSkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50TEUgPSBmdW5jdGlvbiByZWFkSW50TEUgKG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCBieXRlTGVuZ3RoLCB0aGlzLmxlbmd0aCkKICAKICAgIHZhciB2YWwgPSB0aGlzW29mZnNldF0KICAgIHZhciBtdWwgPSAxCiAgICB2YXIgaSA9IDAKICAgIHdoaWxlICgrK2kgPCBieXRlTGVuZ3RoICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICAgIHZhbCArPSB0aGlzW29mZnNldCArIGldICogbXVsCiAgICB9CiAgICBtdWwgKj0gMHg4MAogIAogICAgaWYgKHZhbCA+PSBtdWwpIHZhbCAtPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCkKICAKICAgIHJldHVybiB2YWwKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50QkUgPSBmdW5jdGlvbiByZWFkSW50QkUgKG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCBieXRlTGVuZ3RoLCB0aGlzLmxlbmd0aCkKICAKICAgIHZhciBpID0gYnl0ZUxlbmd0aAogICAgdmFyIG11bCA9IDEKICAgIHZhciB2YWwgPSB0aGlzW29mZnNldCArIC0taV0KICAgIHdoaWxlIChpID4gMCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICB2YWwgKz0gdGhpc1tvZmZzZXQgKyAtLWldICogbXVsCiAgICB9CiAgICBtdWwgKj0gMHg4MAogIAogICAgaWYgKHZhbCA+PSBtdWwpIHZhbCAtPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCkKICAKICAgIHJldHVybiB2YWwKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50OCA9IGZ1bmN0aW9uIHJlYWRJbnQ4IChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDEsIHRoaXMubGVuZ3RoKQogICAgaWYgKCEodGhpc1tvZmZzZXRdICYgMHg4MCkpIHJldHVybiAodGhpc1tvZmZzZXRdKQogICAgcmV0dXJuICgoMHhmZiAtIHRoaXNbb2Zmc2V0XSArIDEpICogLTEpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludDE2TEUgPSBmdW5jdGlvbiByZWFkSW50MTZMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCkKICAgIHZhciB2YWwgPSB0aGlzW29mZnNldF0gfCAodGhpc1tvZmZzZXQgKyAxXSA8PCA4KQogICAgcmV0dXJuICh2YWwgJiAweDgwMDApID8gdmFsIHwgMHhGRkZGMDAwMCA6IHZhbAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQxNkJFID0gZnVuY3Rpb24gcmVhZEludDE2QkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpCiAgICB2YXIgdmFsID0gdGhpc1tvZmZzZXQgKyAxXSB8ICh0aGlzW29mZnNldF0gPDwgOCkKICAgIHJldHVybiAodmFsICYgMHg4MDAwKSA/IHZhbCB8IDB4RkZGRjAwMDAgOiB2YWwKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50MzJMRSA9IGZ1bmN0aW9uIHJlYWRJbnQzMkxFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQogIAogICAgcmV0dXJuICh0aGlzW29mZnNldF0pIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCkgfAogICAgICAodGhpc1tvZmZzZXQgKyAyXSA8PCAxNikgfAogICAgICAodGhpc1tvZmZzZXQgKyAzXSA8PCAyNCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50MzJCRSA9IGZ1bmN0aW9uIHJlYWRJbnQzMkJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQogIAogICAgcmV0dXJuICh0aGlzW29mZnNldF0gPDwgMjQpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgMTYpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMl0gPDwgOCkgfAogICAgICAodGhpc1tvZmZzZXQgKyAzXSkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkRmxvYXRMRSA9IGZ1bmN0aW9uIHJlYWRGbG9hdExFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQogICAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIHRydWUsIDIzLCA0KQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRGbG9hdEJFID0gZnVuY3Rpb24gcmVhZEZsb2F0QkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCiAgICByZXR1cm4gaWVlZTc1NC5yZWFkKHRoaXMsIG9mZnNldCwgZmFsc2UsIDIzLCA0KQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWREb3VibGVMRSA9IGZ1bmN0aW9uIHJlYWREb3VibGVMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA4LCB0aGlzLmxlbmd0aCkKICAgIHJldHVybiBpZWVlNzU0LnJlYWQodGhpcywgb2Zmc2V0LCB0cnVlLCA1MiwgOCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkRG91YmxlQkUgPSBmdW5jdGlvbiByZWFkRG91YmxlQkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgOCwgdGhpcy5sZW5ndGgpCiAgICByZXR1cm4gaWVlZTc1NC5yZWFkKHRoaXMsIG9mZnNldCwgZmFsc2UsIDUyLCA4KQogIH0KICAKICBmdW5jdGlvbiBjaGVja0ludCAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBleHQsIG1heCwgbWluKSB7CiAgICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihidWYpKSB0aHJvdyBuZXcgVHlwZUVycm9yKCciYnVmZmVyIiBhcmd1bWVudCBtdXN0IGJlIGEgQnVmZmVyIGluc3RhbmNlJykKICAgIGlmICh2YWx1ZSA+IG1heCB8fCB2YWx1ZSA8IG1pbikgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJyJ2YWx1ZSIgYXJndW1lbnQgaXMgb3V0IG9mIGJvdW5kcycpCiAgICBpZiAob2Zmc2V0ICsgZXh0ID4gYnVmLmxlbmd0aCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0luZGV4IG91dCBvZiByYW5nZScpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50TEUgPSBmdW5jdGlvbiB3cml0ZVVJbnRMRSAodmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIHsKICAgICAgdmFyIG1heEJ5dGVzID0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgpIC0gMQogICAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBtYXhCeXRlcywgMCkKICAgIH0KICAKICAgIHZhciBtdWwgPSAxCiAgICB2YXIgaSA9IDAKICAgIHRoaXNbb2Zmc2V0XSA9IHZhbHVlICYgMHhGRgogICAgd2hpbGUgKCsraSA8IGJ5dGVMZW5ndGggJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgdGhpc1tvZmZzZXQgKyBpXSA9ICh2YWx1ZSAvIG11bCkgJiAweEZGCiAgICB9CiAgCiAgICByZXR1cm4gb2Zmc2V0ICsgYnl0ZUxlbmd0aAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlVUludEJFID0gZnVuY3Rpb24gd3JpdGVVSW50QkUgKHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIHZhciBtYXhCeXRlcyA9IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoKSAtIDEKICAgICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbWF4Qnl0ZXMsIDApCiAgICB9CiAgCiAgICB2YXIgaSA9IGJ5dGVMZW5ndGggLSAxCiAgICB2YXIgbXVsID0gMQogICAgdGhpc1tvZmZzZXQgKyBpXSA9IHZhbHVlICYgMHhGRgogICAgd2hpbGUgKC0taSA+PSAwICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSAodmFsdWUgLyBtdWwpICYgMHhGRgogICAgfQogIAogICAgcmV0dXJuIG9mZnNldCArIGJ5dGVMZW5ndGgKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnQ4ID0gZnVuY3Rpb24gd3JpdGVVSW50OCAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAxLCAweGZmLCAwKQogICAgaWYgKCFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgdmFsdWUgPSBNYXRoLmZsb29yKHZhbHVlKQogICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICAgIHJldHVybiBvZmZzZXQgKyAxCiAgfQogIAogIGZ1bmN0aW9uIG9iamVjdFdyaXRlVUludDE2IChidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbikgewogICAgaWYgKHZhbHVlIDwgMCkgdmFsdWUgPSAweGZmZmYgKyB2YWx1ZSArIDEKICAgIGZvciAodmFyIGkgPSAwLCBqID0gTWF0aC5taW4oYnVmLmxlbmd0aCAtIG9mZnNldCwgMik7IGkgPCBqOyArK2kpIHsKICAgICAgYnVmW29mZnNldCArIGldID0gKHZhbHVlICYgKDB4ZmYgPDwgKDggKiAobGl0dGxlRW5kaWFuID8gaSA6IDEgLSBpKSkpKSA+Pj4KICAgICAgICAobGl0dGxlRW5kaWFuID8gaSA6IDEgLSBpKSAqIDgKICAgIH0KICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnQxNkxFID0gZnVuY3Rpb24gd3JpdGVVSW50MTZMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweGZmZmYsIDApCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICAgICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gOCkKICAgIH0gZWxzZSB7CiAgICAgIG9iamVjdFdyaXRlVUludDE2KHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUpCiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgMgogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDE2QkUgPSBmdW5jdGlvbiB3cml0ZVVJbnQxNkJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDIsIDB4ZmZmZiwgMCkKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDgpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgJiAweGZmKQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UpCiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgMgogIH0KICAKICBmdW5jdGlvbiBvYmplY3RXcml0ZVVJbnQzMiAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4pIHsKICAgIGlmICh2YWx1ZSA8IDApIHZhbHVlID0gMHhmZmZmZmZmZiArIHZhbHVlICsgMQogICAgZm9yICh2YXIgaSA9IDAsIGogPSBNYXRoLm1pbihidWYubGVuZ3RoIC0gb2Zmc2V0LCA0KTsgaSA8IGo7ICsraSkgewogICAgICBidWZbb2Zmc2V0ICsgaV0gPSAodmFsdWUgPj4+IChsaXR0bGVFbmRpYW4gPyBpIDogMyAtIGkpICogOCkgJiAweGZmCiAgICB9CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50MzJMRSA9IGZ1bmN0aW9uIHdyaXRlVUludDMyTEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgNCwgMHhmZmZmZmZmZiwgMCkKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldCArIDNdID0gKHZhbHVlID4+PiAyNCkKICAgICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gMTYpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDgpCiAgICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDQKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnQzMkJFID0gZnVuY3Rpb24gd3JpdGVVSW50MzJCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweGZmZmZmZmZmLCAwKQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSA+Pj4gMjQpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDE2KQogICAgICB0aGlzW29mZnNldCArIDJdID0gKHZhbHVlID4+PiA4KQogICAgICB0aGlzW29mZnNldCArIDNdID0gKHZhbHVlICYgMHhmZikKICAgIH0gZWxzZSB7CiAgICAgIG9iamVjdFdyaXRlVUludDMyKHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDQKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUludExFID0gZnVuY3Rpb24gd3JpdGVJbnRMRSAodmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIHZhciBsaW1pdCA9IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoIC0gMSkKICAKICAgICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbGltaXQgLSAxLCAtbGltaXQpCiAgICB9CiAgCiAgICB2YXIgaSA9IDAKICAgIHZhciBtdWwgPSAxCiAgICB2YXIgc3ViID0gMAogICAgdGhpc1tvZmZzZXRdID0gdmFsdWUgJiAweEZGCiAgICB3aGlsZSAoKytpIDwgYnl0ZUxlbmd0aCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICBpZiAodmFsdWUgPCAwICYmIHN1YiA9PT0gMCAmJiB0aGlzW29mZnNldCArIGkgLSAxXSAhPT0gMCkgewogICAgICAgIHN1YiA9IDEKICAgICAgfQogICAgICB0aGlzW29mZnNldCArIGldID0gKCh2YWx1ZSAvIG11bCkgPj4gMCkgLSBzdWIgJiAweEZGCiAgICB9CiAgCiAgICByZXR1cm4gb2Zmc2V0ICsgYnl0ZUxlbmd0aAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlSW50QkUgPSBmdW5jdGlvbiB3cml0ZUludEJFICh2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIHsKICAgICAgdmFyIGxpbWl0ID0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGggLSAxKQogIAogICAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBsaW1pdCAtIDEsIC1saW1pdCkKICAgIH0KICAKICAgIHZhciBpID0gYnl0ZUxlbmd0aCAtIDEKICAgIHZhciBtdWwgPSAxCiAgICB2YXIgc3ViID0gMAogICAgdGhpc1tvZmZzZXQgKyBpXSA9IHZhbHVlICYgMHhGRgogICAgd2hpbGUgKC0taSA+PSAwICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICAgIGlmICh2YWx1ZSA8IDAgJiYgc3ViID09PSAwICYmIHRoaXNbb2Zmc2V0ICsgaSArIDFdICE9PSAwKSB7CiAgICAgICAgc3ViID0gMQogICAgICB9CiAgICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSAoKHZhbHVlIC8gbXVsKSA+PiAwKSAtIHN1YiAmIDB4RkYKICAgIH0KICAKICAgIHJldHVybiBvZmZzZXQgKyBieXRlTGVuZ3RoCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQ4ID0gZnVuY3Rpb24gd3JpdGVJbnQ4ICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDEsIDB4N2YsIC0weDgwKQogICAgaWYgKCFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgdmFsdWUgPSBNYXRoLmZsb29yKHZhbHVlKQogICAgaWYgKHZhbHVlIDwgMCkgdmFsdWUgPSAweGZmICsgdmFsdWUgKyAxCiAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogICAgcmV0dXJuIG9mZnNldCArIDEKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDE2TEUgPSBmdW5jdGlvbiB3cml0ZUludDE2TEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMiwgMHg3ZmZmLCAtMHg4MDAwKQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDgpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQxNih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDIKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDE2QkUgPSBmdW5jdGlvbiB3cml0ZUludDE2QkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMiwgMHg3ZmZmLCAtMHg4MDAwKQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSA+Pj4gOCkKICAgICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQxNih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyAyCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQzMkxFID0gZnVuY3Rpb24gd3JpdGVJbnQzMkxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDQsIDB4N2ZmZmZmZmYsIC0weDgwMDAwMDAwKQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDgpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMl0gPSAodmFsdWUgPj4+IDE2KQogICAgICB0aGlzW29mZnNldCArIDNdID0gKHZhbHVlID4+PiAyNCkKICAgIH0gZWxzZSB7CiAgICAgIG9iamVjdFdyaXRlVUludDMyKHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUpCiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgNAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlSW50MzJCRSA9IGZ1bmN0aW9uIHdyaXRlSW50MzJCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweDdmZmZmZmZmLCAtMHg4MDAwMDAwMCkKICAgIGlmICh2YWx1ZSA8IDApIHZhbHVlID0gMHhmZmZmZmZmZiArIHZhbHVlICsgMQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSA+Pj4gMjQpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDE2KQogICAgICB0aGlzW29mZnNldCArIDJdID0gKHZhbHVlID4+PiA4KQogICAgICB0aGlzW29mZnNldCArIDNdID0gKHZhbHVlICYgMHhmZikKICAgIH0gZWxzZSB7CiAgICAgIG9iamVjdFdyaXRlVUludDMyKHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDQKICB9CiAgCiAgZnVuY3Rpb24gY2hlY2tJRUVFNzU0IChidWYsIHZhbHVlLCBvZmZzZXQsIGV4dCwgbWF4LCBtaW4pIHsKICAgIGlmIChvZmZzZXQgKyBleHQgPiBidWYubGVuZ3RoKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW5kZXggb3V0IG9mIHJhbmdlJykKICAgIGlmIChvZmZzZXQgPCAwKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW5kZXggb3V0IG9mIHJhbmdlJykKICB9CiAgCiAgZnVuY3Rpb24gd3JpdGVGbG9hdCAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIGNoZWNrSUVFRTc1NChidWYsIHZhbHVlLCBvZmZzZXQsIDQsIDMuNDAyODIzNDY2Mzg1Mjg4NmUrMzgsIC0zLjQwMjgyMzQ2NjM4NTI4ODZlKzM4KQogICAgfQogICAgaWVlZTc1NC53cml0ZShidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbiwgMjMsIDQpCiAgICByZXR1cm4gb2Zmc2V0ICsgNAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlRmxvYXRMRSA9IGZ1bmN0aW9uIHdyaXRlRmxvYXRMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHJldHVybiB3cml0ZUZsb2F0KHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUsIG5vQXNzZXJ0KQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlRmxvYXRCRSA9IGZ1bmN0aW9uIHdyaXRlRmxvYXRCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHJldHVybiB3cml0ZUZsb2F0KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlLCBub0Fzc2VydCkKICB9CiAgCiAgZnVuY3Rpb24gd3JpdGVEb3VibGUgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgewogICAgICBjaGVja0lFRUU3NTQoYnVmLCB2YWx1ZSwgb2Zmc2V0LCA4LCAxLjc5NzY5MzEzNDg2MjMxNTdFKzMwOCwgLTEuNzk3NjkzMTM0ODYyMzE1N0UrMzA4KQogICAgfQogICAgaWVlZTc1NC53cml0ZShidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbiwgNTIsIDgpCiAgICByZXR1cm4gb2Zmc2V0ICsgOAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlRG91YmxlTEUgPSBmdW5jdGlvbiB3cml0ZURvdWJsZUxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgcmV0dXJuIHdyaXRlRG91YmxlKHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUsIG5vQXNzZXJ0KQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlRG91YmxlQkUgPSBmdW5jdGlvbiB3cml0ZURvdWJsZUJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgcmV0dXJuIHdyaXRlRG91YmxlKHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlLCBub0Fzc2VydCkKICB9CiAgCiAgLy8gY29weSh0YXJnZXRCdWZmZXIsIHRhcmdldFN0YXJ0PTAsIHNvdXJjZVN0YXJ0PTAsIHNvdXJjZUVuZD1idWZmZXIubGVuZ3RoKQogIEJ1ZmZlci5wcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uIGNvcHkgKHRhcmdldCwgdGFyZ2V0U3RhcnQsIHN0YXJ0LCBlbmQpIHsKICAgIGlmICghc3RhcnQpIHN0YXJ0ID0gMAogICAgaWYgKCFlbmQgJiYgZW5kICE9PSAwKSBlbmQgPSB0aGlzLmxlbmd0aAogICAgaWYgKHRhcmdldFN0YXJ0ID49IHRhcmdldC5sZW5ndGgpIHRhcmdldFN0YXJ0ID0gdGFyZ2V0Lmxlbmd0aAogICAgaWYgKCF0YXJnZXRTdGFydCkgdGFyZ2V0U3RhcnQgPSAwCiAgICBpZiAoZW5kID4gMCAmJiBlbmQgPCBzdGFydCkgZW5kID0gc3RhcnQKICAKICAgIC8vIENvcHkgMCBieXRlczsgd2UncmUgZG9uZQogICAgaWYgKGVuZCA9PT0gc3RhcnQpIHJldHVybiAwCiAgICBpZiAodGFyZ2V0Lmxlbmd0aCA9PT0gMCB8fCB0aGlzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIDAKICAKICAgIC8vIEZhdGFsIGVycm9yIGNvbmRpdGlvbnMKICAgIGlmICh0YXJnZXRTdGFydCA8IDApIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ3RhcmdldFN0YXJ0IG91dCBvZiBib3VuZHMnKQogICAgfQogICAgaWYgKHN0YXJ0IDwgMCB8fCBzdGFydCA+PSB0aGlzLmxlbmd0aCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ3NvdXJjZVN0YXJ0IG91dCBvZiBib3VuZHMnKQogICAgaWYgKGVuZCA8IDApIHRocm93IG5ldyBSYW5nZUVycm9yKCdzb3VyY2VFbmQgb3V0IG9mIGJvdW5kcycpCiAgCiAgICAvLyBBcmUgd2Ugb29iPwogICAgaWYgKGVuZCA+IHRoaXMubGVuZ3RoKSBlbmQgPSB0aGlzLmxlbmd0aAogICAgaWYgKHRhcmdldC5sZW5ndGggLSB0YXJnZXRTdGFydCA8IGVuZCAtIHN0YXJ0KSB7CiAgICAgIGVuZCA9IHRhcmdldC5sZW5ndGggLSB0YXJnZXRTdGFydCArIHN0YXJ0CiAgICB9CiAgCiAgICB2YXIgbGVuID0gZW5kIC0gc3RhcnQKICAgIHZhciBpCiAgCiAgICBpZiAodGhpcyA9PT0gdGFyZ2V0ICYmIHN0YXJ0IDwgdGFyZ2V0U3RhcnQgJiYgdGFyZ2V0U3RhcnQgPCBlbmQpIHsKICAgICAgLy8gZGVzY2VuZGluZyBjb3B5IGZyb20gZW5kCiAgICAgIGZvciAoaSA9IGxlbiAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgdGFyZ2V0W2kgKyB0YXJnZXRTdGFydF0gPSB0aGlzW2kgKyBzdGFydF0KICAgICAgfQogICAgfSBlbHNlIGlmIChsZW4gPCAxMDAwIHx8ICFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICAvLyBhc2NlbmRpbmcgY29weSBmcm9tIHN0YXJ0CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICAgIHRhcmdldFtpICsgdGFyZ2V0U3RhcnRdID0gdGhpc1tpICsgc3RhcnRdCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIFVpbnQ4QXJyYXkucHJvdG90eXBlLnNldC5jYWxsKAogICAgICAgIHRhcmdldCwKICAgICAgICB0aGlzLnN1YmFycmF5KHN0YXJ0LCBzdGFydCArIGxlbiksCiAgICAgICAgdGFyZ2V0U3RhcnQKICAgICAgKQogICAgfQogIAogICAgcmV0dXJuIGxlbgogIH0KICAKICAvLyBVc2FnZToKICAvLyAgICBidWZmZXIuZmlsbChudW1iZXJbLCBvZmZzZXRbLCBlbmRdXSkKICAvLyAgICBidWZmZXIuZmlsbChidWZmZXJbLCBvZmZzZXRbLCBlbmRdXSkKICAvLyAgICBidWZmZXIuZmlsbChzdHJpbmdbLCBvZmZzZXRbLCBlbmRdXVssIGVuY29kaW5nXSkKICBCdWZmZXIucHJvdG90eXBlLmZpbGwgPSBmdW5jdGlvbiBmaWxsICh2YWwsIHN0YXJ0LCBlbmQsIGVuY29kaW5nKSB7CiAgICAvLyBIYW5kbGUgc3RyaW5nIGNhc2VzOgogICAgaWYgKHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnKSB7CiAgICAgIGlmICh0eXBlb2Ygc3RhcnQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgZW5jb2RpbmcgPSBzdGFydAogICAgICAgIHN0YXJ0ID0gMAogICAgICAgIGVuZCA9IHRoaXMubGVuZ3RoCiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGVuZCA9PT0gJ3N0cmluZycpIHsKICAgICAgICBlbmNvZGluZyA9IGVuZAogICAgICAgIGVuZCA9IHRoaXMubGVuZ3RoCiAgICAgIH0KICAgICAgaWYgKHZhbC5sZW5ndGggPT09IDEpIHsKICAgICAgICB2YXIgY29kZSA9IHZhbC5jaGFyQ29kZUF0KDApCiAgICAgICAgaWYgKGNvZGUgPCAyNTYpIHsKICAgICAgICAgIHZhbCA9IGNvZGUKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGVuY29kaW5nICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIGVuY29kaW5nICE9PSAnc3RyaW5nJykgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2VuY29kaW5nIG11c3QgYmUgYSBzdHJpbmcnKQogICAgICB9CiAgICAgIGlmICh0eXBlb2YgZW5jb2RpbmcgPT09ICdzdHJpbmcnICYmICFCdWZmZXIuaXNFbmNvZGluZyhlbmNvZGluZykpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jb2RpbmcpCiAgICAgIH0KICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpIHsKICAgICAgdmFsID0gdmFsICYgMjU1CiAgICB9CiAgCiAgICAvLyBJbnZhbGlkIHJhbmdlcyBhcmUgbm90IHNldCB0byBhIGRlZmF1bHQsIHNvIGNhbiByYW5nZSBjaGVjayBlYXJseS4KICAgIGlmIChzdGFydCA8IDAgfHwgdGhpcy5sZW5ndGggPCBzdGFydCB8fCB0aGlzLmxlbmd0aCA8IGVuZCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignT3V0IG9mIHJhbmdlIGluZGV4JykKICAgIH0KICAKICAgIGlmIChlbmQgPD0gc3RhcnQpIHsKICAgICAgcmV0dXJuIHRoaXMKICAgIH0KICAKICAgIHN0YXJ0ID0gc3RhcnQgPj4+IDAKICAgIGVuZCA9IGVuZCA9PT0gdW5kZWZpbmVkID8gdGhpcy5sZW5ndGggOiBlbmQgPj4+IDAKICAKICAgIGlmICghdmFsKSB2YWwgPSAwCiAgCiAgICB2YXIgaQogICAgaWYgKHR5cGVvZiB2YWwgPT09ICdudW1iZXInKSB7CiAgICAgIGZvciAoaSA9IHN0YXJ0OyBpIDwgZW5kOyArK2kpIHsKICAgICAgICB0aGlzW2ldID0gdmFsCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhciBieXRlcyA9IEJ1ZmZlci5pc0J1ZmZlcih2YWwpCiAgICAgICAgPyB2YWwKICAgICAgICA6IHV0ZjhUb0J5dGVzKG5ldyBCdWZmZXIodmFsLCBlbmNvZGluZykudG9TdHJpbmcoKSkKICAgICAgdmFyIGxlbiA9IGJ5dGVzLmxlbmd0aAogICAgICBmb3IgKGkgPSAwOyBpIDwgZW5kIC0gc3RhcnQ7ICsraSkgewogICAgICAgIHRoaXNbaSArIHN0YXJ0XSA9IGJ5dGVzW2kgJSBsZW5dCiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiB0aGlzCiAgfQogIAogIC8vIEhFTFBFUiBGVU5DVElPTlMKICAvLyA9PT09PT09PT09PT09PT09CiAgCiAgdmFyIElOVkFMSURfQkFTRTY0X1JFID0gL1teK1wvMC05QS1aYS16LV9dL2cKICAKICBmdW5jdGlvbiBiYXNlNjRjbGVhbiAoc3RyKSB7CiAgICAvLyBOb2RlIHN0cmlwcyBvdXQgaW52YWxpZCBjaGFyYWN0ZXJzIGxpa2UgXG4gYW5kIFx0IGZyb20gdGhlIHN0cmluZywgYmFzZTY0LWpzIGRvZXMgbm90CiAgICBzdHIgPSBzdHJpbmd0cmltKHN0cikucmVwbGFjZShJTlZBTElEX0JBU0U2NF9SRSwgJycpCiAgICAvLyBOb2RlIGNvbnZlcnRzIHN0cmluZ3Mgd2l0aCBsZW5ndGggPCAyIHRvICcnCiAgICBpZiAoc3RyLmxlbmd0aCA8IDIpIHJldHVybiAnJwogICAgLy8gTm9kZSBhbGxvd3MgZm9yIG5vbi1wYWRkZWQgYmFzZTY0IHN0cmluZ3MgKG1pc3NpbmcgdHJhaWxpbmcgPT09KSwgYmFzZTY0LWpzIGRvZXMgbm90CiAgICB3aGlsZSAoc3RyLmxlbmd0aCAlIDQgIT09IDApIHsKICAgICAgc3RyID0gc3RyICsgJz0nCiAgICB9CiAgICByZXR1cm4gc3RyCiAgfQogIAogIGZ1bmN0aW9uIHN0cmluZ3RyaW0gKHN0cikgewogICAgaWYgKHN0ci50cmltKSByZXR1cm4gc3RyLnRyaW0oKQogICAgcmV0dXJuIHN0ci5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpCiAgfQogIAogIGZ1bmN0aW9uIHRvSGV4IChuKSB7CiAgICBpZiAobiA8IDE2KSByZXR1cm4gJzAnICsgbi50b1N0cmluZygxNikKICAgIHJldHVybiBuLnRvU3RyaW5nKDE2KQogIH0KICAKICBmdW5jdGlvbiB1dGY4VG9CeXRlcyAoc3RyaW5nLCB1bml0cykgewogICAgdW5pdHMgPSB1bml0cyB8fCBJbmZpbml0eQogICAgdmFyIGNvZGVQb2ludAogICAgdmFyIGxlbmd0aCA9IHN0cmluZy5sZW5ndGgKICAgIHZhciBsZWFkU3Vycm9nYXRlID0gbnVsbAogICAgdmFyIGJ5dGVzID0gW10KICAKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgY29kZVBvaW50ID0gc3RyaW5nLmNoYXJDb2RlQXQoaSkKICAKICAgICAgLy8gaXMgc3Vycm9nYXRlIGNvbXBvbmVudAogICAgICBpZiAoY29kZVBvaW50ID4gMHhEN0ZGICYmIGNvZGVQb2ludCA8IDB4RTAwMCkgewogICAgICAgIC8vIGxhc3QgY2hhciB3YXMgYSBsZWFkCiAgICAgICAgaWYgKCFsZWFkU3Vycm9nYXRlKSB7CiAgICAgICAgICAvLyBubyBsZWFkIHlldAogICAgICAgICAgaWYgKGNvZGVQb2ludCA+IDB4REJGRikgewogICAgICAgICAgICAvLyB1bmV4cGVjdGVkIHRyYWlsCiAgICAgICAgICAgIGlmICgodW5pdHMgLT0gMykgPiAtMSkgYnl0ZXMucHVzaCgweEVGLCAweEJGLCAweEJEKQogICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgfSBlbHNlIGlmIChpICsgMSA9PT0gbGVuZ3RoKSB7CiAgICAgICAgICAgIC8vIHVucGFpcmVkIGxlYWQKICAgICAgICAgICAgaWYgKCh1bml0cyAtPSAzKSA+IC0xKSBieXRlcy5wdXNoKDB4RUYsIDB4QkYsIDB4QkQpCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICB9CiAgCiAgICAgICAgICAvLyB2YWxpZCBsZWFkCiAgICAgICAgICBsZWFkU3Vycm9nYXRlID0gY29kZVBvaW50CiAgCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KICAKICAgICAgICAvLyAyIGxlYWRzIGluIGEgcm93CiAgICAgICAgaWYgKGNvZGVQb2ludCA8IDB4REMwMCkgewogICAgICAgICAgaWYgKCh1bml0cyAtPSAzKSA+IC0xKSBieXRlcy5wdXNoKDB4RUYsIDB4QkYsIDB4QkQpCiAgICAgICAgICBsZWFkU3Vycm9nYXRlID0gY29kZVBvaW50CiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KICAKICAgICAgICAvLyB2YWxpZCBzdXJyb2dhdGUgcGFpcgogICAgICAgIGNvZGVQb2ludCA9IChsZWFkU3Vycm9nYXRlIC0gMHhEODAwIDw8IDEwIHwgY29kZVBvaW50IC0gMHhEQzAwKSArIDB4MTAwMDAKICAgICAgfSBlbHNlIGlmIChsZWFkU3Vycm9nYXRlKSB7CiAgICAgICAgLy8gdmFsaWQgYm1wIGNoYXIsIGJ1dCBsYXN0IGNoYXIgd2FzIGEgbGVhZAogICAgICAgIGlmICgodW5pdHMgLT0gMykgPiAtMSkgYnl0ZXMucHVzaCgweEVGLCAweEJGLCAweEJEKQogICAgICB9CiAgCiAgICAgIGxlYWRTdXJyb2dhdGUgPSBudWxsCiAgCiAgICAgIC8vIGVuY29kZSB1dGY4CiAgICAgIGlmIChjb2RlUG9pbnQgPCAweDgwKSB7CiAgICAgICAgaWYgKCh1bml0cyAtPSAxKSA8IDApIGJyZWFrCiAgICAgICAgYnl0ZXMucHVzaChjb2RlUG9pbnQpCiAgICAgIH0gZWxzZSBpZiAoY29kZVBvaW50IDwgMHg4MDApIHsKICAgICAgICBpZiAoKHVuaXRzIC09IDIpIDwgMCkgYnJlYWsKICAgICAgICBieXRlcy5wdXNoKAogICAgICAgICAgY29kZVBvaW50ID4+IDB4NiB8IDB4QzAsCiAgICAgICAgICBjb2RlUG9pbnQgJiAweDNGIHwgMHg4MAogICAgICAgICkKICAgICAgfSBlbHNlIGlmIChjb2RlUG9pbnQgPCAweDEwMDAwKSB7CiAgICAgICAgaWYgKCh1bml0cyAtPSAzKSA8IDApIGJyZWFrCiAgICAgICAgYnl0ZXMucHVzaCgKICAgICAgICAgIGNvZGVQb2ludCA+PiAweEMgfCAweEUwLAogICAgICAgICAgY29kZVBvaW50ID4+IDB4NiAmIDB4M0YgfCAweDgwLAogICAgICAgICAgY29kZVBvaW50ICYgMHgzRiB8IDB4ODAKICAgICAgICApCiAgICAgIH0gZWxzZSBpZiAoY29kZVBvaW50IDwgMHgxMTAwMDApIHsKICAgICAgICBpZiAoKHVuaXRzIC09IDQpIDwgMCkgYnJlYWsKICAgICAgICBieXRlcy5wdXNoKAogICAgICAgICAgY29kZVBvaW50ID4+IDB4MTIgfCAweEYwLAogICAgICAgICAgY29kZVBvaW50ID4+IDB4QyAmIDB4M0YgfCAweDgwLAogICAgICAgICAgY29kZVBvaW50ID4+IDB4NiAmIDB4M0YgfCAweDgwLAogICAgICAgICAgY29kZVBvaW50ICYgMHgzRiB8IDB4ODAKICAgICAgICApCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGNvZGUgcG9pbnQnKQogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gYnl0ZXMKICB9CiAgCiAgZnVuY3Rpb24gYXNjaWlUb0J5dGVzIChzdHIpIHsKICAgIHZhciBieXRlQXJyYXkgPSBbXQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHsKICAgICAgLy8gTm9kZSdzIGNvZGUgc2VlbXMgdG8gYmUgZG9pbmcgdGhpcyBhbmQgbm90ICYgMHg3Ri4uCiAgICAgIGJ5dGVBcnJheS5wdXNoKHN0ci5jaGFyQ29kZUF0KGkpICYgMHhGRikKICAgIH0KICAgIHJldHVybiBieXRlQXJyYXkKICB9CiAgCiAgZnVuY3Rpb24gdXRmMTZsZVRvQnl0ZXMgKHN0ciwgdW5pdHMpIHsKICAgIHZhciBjLCBoaSwgbG8KICAgIHZhciBieXRlQXJyYXkgPSBbXQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKCh1bml0cyAtPSAyKSA8IDApIGJyZWFrCiAgCiAgICAgIGMgPSBzdHIuY2hhckNvZGVBdChpKQogICAgICBoaSA9IGMgPj4gOAogICAgICBsbyA9IGMgJSAyNTYKICAgICAgYnl0ZUFycmF5LnB1c2gobG8pCiAgICAgIGJ5dGVBcnJheS5wdXNoKGhpKQogICAgfQogIAogICAgcmV0dXJuIGJ5dGVBcnJheQogIH0KICAKICBmdW5jdGlvbiBiYXNlNjRUb0J5dGVzIChzdHIpIHsKICAgIHJldHVybiBiYXNlNjQudG9CeXRlQXJyYXkoYmFzZTY0Y2xlYW4oc3RyKSkKICB9CiAgCiAgZnVuY3Rpb24gYmxpdEJ1ZmZlciAoc3JjLCBkc3QsIG9mZnNldCwgbGVuZ3RoKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGlmICgoaSArIG9mZnNldCA+PSBkc3QubGVuZ3RoKSB8fCAoaSA+PSBzcmMubGVuZ3RoKSkgYnJlYWsKICAgICAgZHN0W2kgKyBvZmZzZXRdID0gc3JjW2ldCiAgICB9CiAgICByZXR1cm4gaQogIH0KICAKICBmdW5jdGlvbiBpc25hbiAodmFsKSB7CiAgICByZXR1cm4gdmFsICE9PSB2YWwgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1zZWxmLWNvbXBhcmUKICB9CiAgCiAgfSkuY2FsbCh0aGlzLHR5cGVvZiBnbG9iYWwgIT09ICJ1bmRlZmluZWQiID8gZ2xvYmFsIDogdHlwZW9mIHNlbGYgIT09ICJ1bmRlZmluZWQiID8gc2VsZiA6IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDoge30scmVxdWlyZSgiYnVmZmVyIikuQnVmZmVyKQogIH0seyJiYXNlNjQtanMiOjc4LCJidWZmZXIiOjgwLCJpZWVlNzU0Ijo4MiwiaXNhcnJheSI6ODN9XSw4MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCiAgLy8KICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQogIC8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKICAvLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCiAgLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAogIC8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKICAvLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKICAvLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAvLwogIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCiAgLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgLy8KICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwogIC8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICAvLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCiAgLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCiAgLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCiAgLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQogIC8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiAgCiAgZnVuY3Rpb24gRXZlbnRFbWl0dGVyKCkgewogICAgdGhpcy5fZXZlbnRzID0gdGhpcy5fZXZlbnRzIHx8IHt9OwogICAgdGhpcy5fbWF4TGlzdGVuZXJzID0gdGhpcy5fbWF4TGlzdGVuZXJzIHx8IHVuZGVmaW5lZDsKICB9CiAgbW9kdWxlLmV4cG9ydHMgPSBFdmVudEVtaXR0ZXI7CiAgCiAgLy8gQmFja3dhcmRzLWNvbXBhdCB3aXRoIG5vZGUgMC4xMC54CiAgRXZlbnRFbWl0dGVyLkV2ZW50RW1pdHRlciA9IEV2ZW50RW1pdHRlcjsKICAKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLl9ldmVudHMgPSB1bmRlZmluZWQ7CiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fbWF4TGlzdGVuZXJzID0gdW5kZWZpbmVkOwogIAogIC8vIEJ5IGRlZmF1bHQgRXZlbnRFbWl0dGVycyB3aWxsIHByaW50IGEgd2FybmluZyBpZiBtb3JlIHRoYW4gMTAgbGlzdGVuZXJzIGFyZQogIC8vIGFkZGVkIHRvIGl0LiBUaGlzIGlzIGEgdXNlZnVsIGRlZmF1bHQgd2hpY2ggaGVscHMgZmluZGluZyBtZW1vcnkgbGVha3MuCiAgRXZlbnRFbWl0dGVyLmRlZmF1bHRNYXhMaXN0ZW5lcnMgPSAxMDsKICAKICAvLyBPYnZpb3VzbHkgbm90IGFsbCBFbWl0dGVycyBzaG91bGQgYmUgbGltaXRlZCB0byAxMC4gVGhpcyBmdW5jdGlvbiBhbGxvd3MKICAvLyB0aGF0IHRvIGJlIGluY3JlYXNlZC4gU2V0IHRvIHplcm8gZm9yIHVubGltaXRlZC4KICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLnNldE1heExpc3RlbmVycyA9IGZ1bmN0aW9uKG4pIHsKICAgIGlmICghaXNOdW1iZXIobikgfHwgbiA8IDAgfHwgaXNOYU4obikpCiAgICAgIHRocm93IFR5cGVFcnJvcignbiBtdXN0IGJlIGEgcG9zaXRpdmUgbnVtYmVyJyk7CiAgICB0aGlzLl9tYXhMaXN0ZW5lcnMgPSBuOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLmVtaXQgPSBmdW5jdGlvbih0eXBlKSB7CiAgICB2YXIgZXIsIGhhbmRsZXIsIGxlbiwgYXJncywgaSwgbGlzdGVuZXJzOwogIAogICAgaWYgKCF0aGlzLl9ldmVudHMpCiAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogIAogICAgLy8gSWYgdGhlcmUgaXMgbm8gJ2Vycm9yJyBldmVudCBsaXN0ZW5lciB0aGVuIHRocm93LgogICAgaWYgKHR5cGUgPT09ICdlcnJvcicpIHsKICAgICAgaWYgKCF0aGlzLl9ldmVudHMuZXJyb3IgfHwKICAgICAgICAgIChpc09iamVjdCh0aGlzLl9ldmVudHMuZXJyb3IpICYmICF0aGlzLl9ldmVudHMuZXJyb3IubGVuZ3RoKSkgewogICAgICAgIGVyID0gYXJndW1lbnRzWzFdOwogICAgICAgIGlmIChlciBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgICB0aHJvdyBlcjsgLy8gVW5oYW5kbGVkICdlcnJvcicgZXZlbnQKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gQXQgbGVhc3QgZ2l2ZSBzb21lIGtpbmQgb2YgY29udGV4dCB0byB0aGUgdXNlcgogICAgICAgICAgdmFyIGVyciA9IG5ldyBFcnJvcignVW5jYXVnaHQsIHVuc3BlY2lmaWVkICJlcnJvciIgZXZlbnQuICgnICsgZXIgKyAnKScpOwogICAgICAgICAgZXJyLmNvbnRleHQgPSBlcjsKICAgICAgICAgIHRocm93IGVycjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAKICAgIGhhbmRsZXIgPSB0aGlzLl9ldmVudHNbdHlwZV07CiAgCiAgICBpZiAoaXNVbmRlZmluZWQoaGFuZGxlcikpCiAgICAgIHJldHVybiBmYWxzZTsKICAKICAgIGlmIChpc0Z1bmN0aW9uKGhhbmRsZXIpKSB7CiAgICAgIHN3aXRjaCAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIC8vIGZhc3QgY2FzZXMKICAgICAgICBjYXNlIDE6CiAgICAgICAgICBoYW5kbGVyLmNhbGwodGhpcyk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDI6CiAgICAgICAgICBoYW5kbGVyLmNhbGwodGhpcywgYXJndW1lbnRzWzFdKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMzoKICAgICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzLCBhcmd1bWVudHNbMV0sIGFyZ3VtZW50c1syXSk7CiAgICAgICAgICBicmVhazsKICAgICAgICAvLyBzbG93ZXIKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICBoYW5kbGVyLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KGhhbmRsZXIpKSB7CiAgICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICBsaXN0ZW5lcnMgPSBoYW5kbGVyLnNsaWNlKCk7CiAgICAgIGxlbiA9IGxpc3RlbmVycy5sZW5ndGg7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykKICAgICAgICBsaXN0ZW5lcnNbaV0uYXBwbHkodGhpcywgYXJncyk7CiAgICB9CiAgCiAgICByZXR1cm4gdHJ1ZTsKICB9OwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuYWRkTGlzdGVuZXIgPSBmdW5jdGlvbih0eXBlLCBsaXN0ZW5lcikgewogICAgdmFyIG07CiAgCiAgICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKQogICAgICB0aHJvdyBUeXBlRXJyb3IoJ2xpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbicpOwogIAogICAgaWYgKCF0aGlzLl9ldmVudHMpCiAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogIAogICAgLy8gVG8gYXZvaWQgcmVjdXJzaW9uIGluIHRoZSBjYXNlIHRoYXQgdHlwZSA9PT0gIm5ld0xpc3RlbmVyIiEgQmVmb3JlCiAgICAvLyBhZGRpbmcgaXQgdG8gdGhlIGxpc3RlbmVycywgZmlyc3QgZW1pdCAibmV3TGlzdGVuZXIiLgogICAgaWYgKHRoaXMuX2V2ZW50cy5uZXdMaXN0ZW5lcikKICAgICAgdGhpcy5lbWl0KCduZXdMaXN0ZW5lcicsIHR5cGUsCiAgICAgICAgICAgICAgICBpc0Z1bmN0aW9uKGxpc3RlbmVyLmxpc3RlbmVyKSA/CiAgICAgICAgICAgICAgICBsaXN0ZW5lci5saXN0ZW5lciA6IGxpc3RlbmVyKTsKICAKICAgIGlmICghdGhpcy5fZXZlbnRzW3R5cGVdKQogICAgICAvLyBPcHRpbWl6ZSB0aGUgY2FzZSBvZiBvbmUgbGlzdGVuZXIuIERvbid0IG5lZWQgdGhlIGV4dHJhIGFycmF5IG9iamVjdC4KICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdID0gbGlzdGVuZXI7CiAgICBlbHNlIGlmIChpc09iamVjdCh0aGlzLl9ldmVudHNbdHlwZV0pKQogICAgICAvLyBJZiB3ZSd2ZSBhbHJlYWR5IGdvdCBhbiBhcnJheSwganVzdCBhcHBlbmQuCiAgICAgIHRoaXMuX2V2ZW50c1t0eXBlXS5wdXNoKGxpc3RlbmVyKTsKICAgIGVsc2UKICAgICAgLy8gQWRkaW5nIHRoZSBzZWNvbmQgZWxlbWVudCwgbmVlZCB0byBjaGFuZ2UgdG8gYXJyYXkuCiAgICAgIHRoaXMuX2V2ZW50c1t0eXBlXSA9IFt0aGlzLl9ldmVudHNbdHlwZV0sIGxpc3RlbmVyXTsKICAKICAgIC8vIENoZWNrIGZvciBsaXN0ZW5lciBsZWFrCiAgICBpZiAoaXNPYmplY3QodGhpcy5fZXZlbnRzW3R5cGVdKSAmJiAhdGhpcy5fZXZlbnRzW3R5cGVdLndhcm5lZCkgewogICAgICBpZiAoIWlzVW5kZWZpbmVkKHRoaXMuX21heExpc3RlbmVycykpIHsKICAgICAgICBtID0gdGhpcy5fbWF4TGlzdGVuZXJzOwogICAgICB9IGVsc2UgewogICAgICAgIG0gPSBFdmVudEVtaXR0ZXIuZGVmYXVsdE1heExpc3RlbmVyczsKICAgICAgfQogIAogICAgICBpZiAobSAmJiBtID4gMCAmJiB0aGlzLl9ldmVudHNbdHlwZV0ubGVuZ3RoID4gbSkgewogICAgICAgIHRoaXMuX2V2ZW50c1t0eXBlXS53YXJuZWQgPSB0cnVlOwogICAgICAgIGNvbnNvbGUuZXJyb3IoJyhub2RlKSB3YXJuaW5nOiBwb3NzaWJsZSBFdmVudEVtaXR0ZXIgbWVtb3J5ICcgKwogICAgICAgICAgICAgICAgICAgICAgJ2xlYWsgZGV0ZWN0ZWQuICVkIGxpc3RlbmVycyBhZGRlZC4gJyArCiAgICAgICAgICAgICAgICAgICAgICAnVXNlIGVtaXR0ZXIuc2V0TWF4TGlzdGVuZXJzKCkgdG8gaW5jcmVhc2UgbGltaXQuJywKICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2V2ZW50c1t0eXBlXS5sZW5ndGgpOwogICAgICAgIGlmICh0eXBlb2YgY29uc29sZS50cmFjZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgLy8gbm90IHN1cHBvcnRlZCBpbiBJRSAxMAogICAgICAgICAgY29uc29sZS50cmFjZSgpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lcjsKICAKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbih0eXBlLCBsaXN0ZW5lcikgewogICAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkKICAgICAgdGhyb3cgVHlwZUVycm9yKCdsaXN0ZW5lciBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAKICAgIHZhciBmaXJlZCA9IGZhbHNlOwogIAogICAgZnVuY3Rpb24gZygpIHsKICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBnKTsKICAKICAgICAgaWYgKCFmaXJlZCkgewogICAgICAgIGZpcmVkID0gdHJ1ZTsKICAgICAgICBsaXN0ZW5lci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9CiAgCiAgICBnLmxpc3RlbmVyID0gbGlzdGVuZXI7CiAgICB0aGlzLm9uKHR5cGUsIGcpOwogIAogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICAvLyBlbWl0cyBhICdyZW1vdmVMaXN0ZW5lcicgZXZlbnQgaWZmIHRoZSBsaXN0ZW5lciB3YXMgcmVtb3ZlZAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbih0eXBlLCBsaXN0ZW5lcikgewogICAgdmFyIGxpc3QsIHBvc2l0aW9uLCBsZW5ndGgsIGk7CiAgCiAgICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKQogICAgICB0aHJvdyBUeXBlRXJyb3IoJ2xpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbicpOwogIAogICAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIXRoaXMuX2V2ZW50c1t0eXBlXSkKICAgICAgcmV0dXJuIHRoaXM7CiAgCiAgICBsaXN0ID0gdGhpcy5fZXZlbnRzW3R5cGVdOwogICAgbGVuZ3RoID0gbGlzdC5sZW5ndGg7CiAgICBwb3NpdGlvbiA9IC0xOwogIAogICAgaWYgKGxpc3QgPT09IGxpc3RlbmVyIHx8CiAgICAgICAgKGlzRnVuY3Rpb24obGlzdC5saXN0ZW5lcikgJiYgbGlzdC5saXN0ZW5lciA9PT0gbGlzdGVuZXIpKSB7CiAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07CiAgICAgIGlmICh0aGlzLl9ldmVudHMucmVtb3ZlTGlzdGVuZXIpCiAgICAgICAgdGhpcy5lbWl0KCdyZW1vdmVMaXN0ZW5lcicsIHR5cGUsIGxpc3RlbmVyKTsKICAKICAgIH0gZWxzZSBpZiAoaXNPYmplY3QobGlzdCkpIHsKICAgICAgZm9yIChpID0gbGVuZ3RoOyBpLS0gPiAwOykgewogICAgICAgIGlmIChsaXN0W2ldID09PSBsaXN0ZW5lciB8fAogICAgICAgICAgICAobGlzdFtpXS5saXN0ZW5lciAmJiBsaXN0W2ldLmxpc3RlbmVyID09PSBsaXN0ZW5lcikpIHsKICAgICAgICAgIHBvc2l0aW9uID0gaTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogIAogICAgICBpZiAocG9zaXRpb24gPCAwKQogICAgICAgIHJldHVybiB0aGlzOwogIAogICAgICBpZiAobGlzdC5sZW5ndGggPT09IDEpIHsKICAgICAgICBsaXN0Lmxlbmd0aCA9IDA7CiAgICAgICAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsaXN0LnNwbGljZShwb3NpdGlvbiwgMSk7CiAgICAgIH0KICAKICAgICAgaWYgKHRoaXMuX2V2ZW50cy5yZW1vdmVMaXN0ZW5lcikKICAgICAgICB0aGlzLmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgdHlwZSwgbGlzdGVuZXIpOwogICAgfQogIAogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLnJlbW92ZUFsbExpc3RlbmVycyA9IGZ1bmN0aW9uKHR5cGUpIHsKICAgIHZhciBrZXksIGxpc3RlbmVyczsKICAKICAgIGlmICghdGhpcy5fZXZlbnRzKQogICAgICByZXR1cm4gdGhpczsKICAKICAgIC8vIG5vdCBsaXN0ZW5pbmcgZm9yIHJlbW92ZUxpc3RlbmVyLCBubyBuZWVkIHRvIGVtaXQKICAgIGlmICghdGhpcy5fZXZlbnRzLnJlbW92ZUxpc3RlbmVyKSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKQogICAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgICBlbHNlIGlmICh0aGlzLl9ldmVudHNbdHlwZV0pCiAgICAgICAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgCiAgICAvLyBlbWl0IHJlbW92ZUxpc3RlbmVyIGZvciBhbGwgbGlzdGVuZXJzIG9uIGFsbCBldmVudHMKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSB7CiAgICAgIGZvciAoa2V5IGluIHRoaXMuX2V2ZW50cykgewogICAgICAgIGlmIChrZXkgPT09ICdyZW1vdmVMaXN0ZW5lcicpIGNvbnRpbnVlOwogICAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKGtleSk7CiAgICAgIH0KICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ3JlbW92ZUxpc3RlbmVyJyk7CiAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAKICAgIGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKICAKICAgIGlmIChpc0Z1bmN0aW9uKGxpc3RlbmVycykpIHsKICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcnMpOwogICAgfSBlbHNlIGlmIChsaXN0ZW5lcnMpIHsKICAgICAgLy8gTElGTyBvcmRlcgogICAgICB3aGlsZSAobGlzdGVuZXJzLmxlbmd0aCkKICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGxpc3RlbmVyc1tsaXN0ZW5lcnMubGVuZ3RoIC0gMV0pOwogICAgfQogICAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKICAKICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5saXN0ZW5lcnMgPSBmdW5jdGlvbih0eXBlKSB7CiAgICB2YXIgcmV0OwogICAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIXRoaXMuX2V2ZW50c1t0eXBlXSkKICAgICAgcmV0ID0gW107CiAgICBlbHNlIGlmIChpc0Z1bmN0aW9uKHRoaXMuX2V2ZW50c1t0eXBlXSkpCiAgICAgIHJldCA9IFt0aGlzLl9ldmVudHNbdHlwZV1dOwogICAgZWxzZQogICAgICByZXQgPSB0aGlzLl9ldmVudHNbdHlwZV0uc2xpY2UoKTsKICAgIHJldHVybiByZXQ7CiAgfTsKICAKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbih0eXBlKSB7CiAgICBpZiAodGhpcy5fZXZlbnRzKSB7CiAgICAgIHZhciBldmxpc3RlbmVyID0gdGhpcy5fZXZlbnRzW3R5cGVdOwogIAogICAgICBpZiAoaXNGdW5jdGlvbihldmxpc3RlbmVyKSkKICAgICAgICByZXR1cm4gMTsKICAgICAgZWxzZSBpZiAoZXZsaXN0ZW5lcikKICAgICAgICByZXR1cm4gZXZsaXN0ZW5lci5sZW5ndGg7CiAgICB9CiAgICByZXR1cm4gMDsKICB9OwogIAogIEV2ZW50RW1pdHRlci5saXN0ZW5lckNvdW50ID0gZnVuY3Rpb24oZW1pdHRlciwgdHlwZSkgewogICAgcmV0dXJuIGVtaXR0ZXIubGlzdGVuZXJDb3VudCh0eXBlKTsKICB9OwogIAogIGZ1bmN0aW9uIGlzRnVuY3Rpb24oYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ2Z1bmN0aW9uJzsKICB9CiAgCiAgZnVuY3Rpb24gaXNOdW1iZXIoYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ251bWJlcic7CiAgfQogIAogIGZ1bmN0aW9uIGlzT2JqZWN0KGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdvYmplY3QnICYmIGFyZyAhPT0gbnVsbDsKICB9CiAgCiAgZnVuY3Rpb24gaXNVbmRlZmluZWQoYXJnKSB7CiAgICByZXR1cm4gYXJnID09PSB2b2lkIDA7CiAgfQogIAogIH0se31dLDgyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBleHBvcnRzLnJlYWQgPSBmdW5jdGlvbiAoYnVmZmVyLCBvZmZzZXQsIGlzTEUsIG1MZW4sIG5CeXRlcykgewogICAgdmFyIGUsIG0KICAgIHZhciBlTGVuID0gKG5CeXRlcyAqIDgpIC0gbUxlbiAtIDEKICAgIHZhciBlTWF4ID0gKDEgPDwgZUxlbikgLSAxCiAgICB2YXIgZUJpYXMgPSBlTWF4ID4+IDEKICAgIHZhciBuQml0cyA9IC03CiAgICB2YXIgaSA9IGlzTEUgPyAobkJ5dGVzIC0gMSkgOiAwCiAgICB2YXIgZCA9IGlzTEUgPyAtMSA6IDEKICAgIHZhciBzID0gYnVmZmVyW29mZnNldCArIGldCiAgCiAgICBpICs9IGQKICAKICAgIGUgPSBzICYgKCgxIDw8ICgtbkJpdHMpKSAtIDEpCiAgICBzID4+PSAoLW5CaXRzKQogICAgbkJpdHMgKz0gZUxlbgogICAgZm9yICg7IG5CaXRzID4gMDsgZSA9IChlICogMjU2KSArIGJ1ZmZlcltvZmZzZXQgKyBpXSwgaSArPSBkLCBuQml0cyAtPSA4KSB7fQogIAogICAgbSA9IGUgJiAoKDEgPDwgKC1uQml0cykpIC0gMSkKICAgIGUgPj49ICgtbkJpdHMpCiAgICBuQml0cyArPSBtTGVuCiAgICBmb3IgKDsgbkJpdHMgPiAwOyBtID0gKG0gKiAyNTYpICsgYnVmZmVyW29mZnNldCArIGldLCBpICs9IGQsIG5CaXRzIC09IDgpIHt9CiAgCiAgICBpZiAoZSA9PT0gMCkgewogICAgICBlID0gMSAtIGVCaWFzCiAgICB9IGVsc2UgaWYgKGUgPT09IGVNYXgpIHsKICAgICAgcmV0dXJuIG0gPyBOYU4gOiAoKHMgPyAtMSA6IDEpICogSW5maW5pdHkpCiAgICB9IGVsc2UgewogICAgICBtID0gbSArIE1hdGgucG93KDIsIG1MZW4pCiAgICAgIGUgPSBlIC0gZUJpYXMKICAgIH0KICAgIHJldHVybiAocyA/IC0xIDogMSkgKiBtICogTWF0aC5wb3coMiwgZSAtIG1MZW4pCiAgfQogIAogIGV4cG9ydHMud3JpdGUgPSBmdW5jdGlvbiAoYnVmZmVyLCB2YWx1ZSwgb2Zmc2V0LCBpc0xFLCBtTGVuLCBuQnl0ZXMpIHsKICAgIHZhciBlLCBtLCBjCiAgICB2YXIgZUxlbiA9IChuQnl0ZXMgKiA4KSAtIG1MZW4gLSAxCiAgICB2YXIgZU1heCA9ICgxIDw8IGVMZW4pIC0gMQogICAgdmFyIGVCaWFzID0gZU1heCA+PiAxCiAgICB2YXIgcnQgPSAobUxlbiA9PT0gMjMgPyBNYXRoLnBvdygyLCAtMjQpIC0gTWF0aC5wb3coMiwgLTc3KSA6IDApCiAgICB2YXIgaSA9IGlzTEUgPyAwIDogKG5CeXRlcyAtIDEpCiAgICB2YXIgZCA9IGlzTEUgPyAxIDogLTEKICAgIHZhciBzID0gdmFsdWUgPCAwIHx8ICh2YWx1ZSA9PT0gMCAmJiAxIC8gdmFsdWUgPCAwKSA/IDEgOiAwCiAgCiAgICB2YWx1ZSA9IE1hdGguYWJzKHZhbHVlKQogIAogICAgaWYgKGlzTmFOKHZhbHVlKSB8fCB2YWx1ZSA9PT0gSW5maW5pdHkpIHsKICAgICAgbSA9IGlzTmFOKHZhbHVlKSA/IDEgOiAwCiAgICAgIGUgPSBlTWF4CiAgICB9IGVsc2UgewogICAgICBlID0gTWF0aC5mbG9vcihNYXRoLmxvZyh2YWx1ZSkgLyBNYXRoLkxOMikKICAgICAgaWYgKHZhbHVlICogKGMgPSBNYXRoLnBvdygyLCAtZSkpIDwgMSkgewogICAgICAgIGUtLQogICAgICAgIGMgKj0gMgogICAgICB9CiAgICAgIGlmIChlICsgZUJpYXMgPj0gMSkgewogICAgICAgIHZhbHVlICs9IHJ0IC8gYwogICAgICB9IGVsc2UgewogICAgICAgIHZhbHVlICs9IHJ0ICogTWF0aC5wb3coMiwgMSAtIGVCaWFzKQogICAgICB9CiAgICAgIGlmICh2YWx1ZSAqIGMgPj0gMikgewogICAgICAgIGUrKwogICAgICAgIGMgLz0gMgogICAgICB9CiAgCiAgICAgIGlmIChlICsgZUJpYXMgPj0gZU1heCkgewogICAgICAgIG0gPSAwCiAgICAgICAgZSA9IGVNYXgKICAgICAgfSBlbHNlIGlmIChlICsgZUJpYXMgPj0gMSkgewogICAgICAgIG0gPSAoKHZhbHVlICogYykgLSAxKSAqIE1hdGgucG93KDIsIG1MZW4pCiAgICAgICAgZSA9IGUgKyBlQmlhcwogICAgICB9IGVsc2UgewogICAgICAgIG0gPSB2YWx1ZSAqIE1hdGgucG93KDIsIGVCaWFzIC0gMSkgKiBNYXRoLnBvdygyLCBtTGVuKQogICAgICAgIGUgPSAwCiAgICAgIH0KICAgIH0KICAKICAgIGZvciAoOyBtTGVuID49IDg7IGJ1ZmZlcltvZmZzZXQgKyBpXSA9IG0gJiAweGZmLCBpICs9IGQsIG0gLz0gMjU2LCBtTGVuIC09IDgpIHt9CiAgCiAgICBlID0gKGUgPDwgbUxlbikgfCBtCiAgICBlTGVuICs9IG1MZW4KICAgIGZvciAoOyBlTGVuID4gMDsgYnVmZmVyW29mZnNldCArIGldID0gZSAmIDB4ZmYsIGkgKz0gZCwgZSAvPSAyNTYsIGVMZW4gLT0gOCkge30KICAKICAgIGJ1ZmZlcltvZmZzZXQgKyBpIC0gZF0gfD0gcyAqIDEyOAogIH0KICAKICB9LHt9XSw4MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHRvU3RyaW5nID0ge30udG9TdHJpbmc7CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSBBcnJheS5pc0FycmF5IHx8IGZ1bmN0aW9uIChhcnIpIHsKICAgIHJldHVybiB0b1N0cmluZy5jYWxsKGFycikgPT0gJ1tvYmplY3QgQXJyYXldJzsKICB9OwogIAogIH0se31dLDg0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24oZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogIAogICAgZnVuY3Rpb24gaXNBcnJheShvYmopIHsKICAgICAgaWYgKG9iaiAhPT0gbnVsbCkgewogICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gIltvYmplY3QgQXJyYXldIjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAKICAgIGZ1bmN0aW9uIGlzT2JqZWN0KG9iaikgewogICAgICBpZiAob2JqICE9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopID09PSAiW29iamVjdCBPYmplY3RdIjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAKICAgIGZ1bmN0aW9uIHN0cmljdERlZXBFcXVhbChmaXJzdCwgc2Vjb25kKSB7CiAgICAgIC8vIENoZWNrIHRoZSBzY2FsYXIgY2FzZSBmaXJzdC4KICAgICAgaWYgKGZpcnN0ID09PSBzZWNvbmQpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogIAogICAgICAvLyBDaGVjayBpZiB0aGV5IGFyZSB0aGUgc2FtZSB0eXBlLgogICAgICB2YXIgZmlyc3RUeXBlID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGZpcnN0KTsKICAgICAgaWYgKGZpcnN0VHlwZSAhPT0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHNlY29uZCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gV2Uga25vdyB0aGF0IGZpcnN0IGFuZCBzZWNvbmQgaGF2ZSB0aGUgc2FtZSB0eXBlIHNvIHdlIGNhbiBqdXN0IGNoZWNrIHRoZQogICAgICAvLyBmaXJzdCB0eXBlIGZyb20gbm93IG9uLgogICAgICBpZiAoaXNBcnJheShmaXJzdCkgPT09IHRydWUpIHsKICAgICAgICAvLyBTaG9ydCBjaXJjdWl0IGlmIHRoZXkncmUgbm90IHRoZSBzYW1lIGxlbmd0aDsKICAgICAgICBpZiAoZmlyc3QubGVuZ3RoICE9PSBzZWNvbmQubGVuZ3RoKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZmlyc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChzdHJpY3REZWVwRXF1YWwoZmlyc3RbaV0sIHNlY29uZFtpXSkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKGlzT2JqZWN0KGZpcnN0KSA9PT0gdHJ1ZSkgewogICAgICAgIC8vIEFuIG9iamVjdCBpcyBlcXVhbCBpZiBpdCBoYXMgdGhlIHNhbWUga2V5L3ZhbHVlIHBhaXJzLgogICAgICAgIHZhciBrZXlzU2VlbiA9IHt9OwogICAgICAgIGZvciAodmFyIGtleSBpbiBmaXJzdCkgewogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoZmlyc3QsIGtleSkpIHsKICAgICAgICAgICAgaWYgKHN0cmljdERlZXBFcXVhbChmaXJzdFtrZXldLCBzZWNvbmRba2V5XSkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGtleXNTZWVuW2tleV0gPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBOb3cgY2hlY2sgdGhhdCB0aGVyZSBhcmVuJ3QgYW55IGtleXMgaW4gc2Vjb25kIHRoYXQgd2VyZW4ndAogICAgICAgIC8vIGluIGZpcnN0LgogICAgICAgIGZvciAodmFyIGtleTIgaW4gc2Vjb25kKSB7CiAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChzZWNvbmQsIGtleTIpKSB7CiAgICAgICAgICAgIGlmIChrZXlzU2VlbltrZXkyXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgCiAgICBmdW5jdGlvbiBpc0ZhbHNlKG9iaikgewogICAgICAvLyBGcm9tIHRoZSBzcGVjOgogICAgICAvLyBBIGZhbHNlIHZhbHVlIGNvcnJlc3BvbmRzIHRvIHRoZSBmb2xsb3dpbmcgdmFsdWVzOgogICAgICAvLyBFbXB0eSBsaXN0CiAgICAgIC8vIEVtcHR5IG9iamVjdAogICAgICAvLyBFbXB0eSBzdHJpbmcKICAgICAgLy8gRmFsc2UgYm9vbGVhbgogICAgICAvLyBudWxsIHZhbHVlCiAgCiAgICAgIC8vIEZpcnN0IGNoZWNrIHRoZSBzY2FsYXIgdmFsdWVzLgogICAgICBpZiAob2JqID09PSAiIiB8fCBvYmogPT09IGZhbHNlIHx8IG9iaiA9PT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShvYmopICYmIG9iai5sZW5ndGggPT09IDApIHsKICAgICAgICAgIC8vIENoZWNrIGZvciBhbiBlbXB0eSBhcnJheS4KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KG9iaikpIHsKICAgICAgICAgIC8vIENoZWNrIGZvciBhbiBlbXB0eSBvYmplY3QuCiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgICAgICAgICAgLy8gSWYgdGhlcmUgYXJlIGFueSBrZXlzLCB0aGVuCiAgICAgICAgICAgICAgLy8gdGhlIG9iamVjdCBpcyBub3QgZW1wdHkgc28gdGhlIG9iamVjdAogICAgICAgICAgICAgIC8vIGlzIG5vdCBmYWxzZS4KICAgICAgICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogIAogICAgZnVuY3Rpb24gb2JqVmFsdWVzKG9iaikgewogICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKG9iaik7CiAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFsdWVzLnB1c2gob2JqW2tleXNbaV1dKTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWVzOwogICAgfQogIAogICAgZnVuY3Rpb24gbWVyZ2UoYSwgYikgewogICAgICAgIHZhciBtZXJnZWQgPSB7fTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gYSkgewogICAgICAgICAgICBtZXJnZWRba2V5XSA9IGFba2V5XTsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIga2V5MiBpbiBiKSB7CiAgICAgICAgICAgIG1lcmdlZFtrZXkyXSA9IGJba2V5Ml07CiAgICAgICAgfQogICAgICAgIHJldHVybiBtZXJnZWQ7CiAgICB9CiAgCiAgICB2YXIgdHJpbUxlZnQ7CiAgICBpZiAodHlwZW9mIFN0cmluZy5wcm90b3R5cGUudHJpbUxlZnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgdHJpbUxlZnQgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICByZXR1cm4gc3RyLnRyaW1MZWZ0KCk7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICB0cmltTGVmdCA9IGZ1bmN0aW9uKHN0cikgewogICAgICAgIHJldHVybiBzdHIubWF0Y2goL15ccyooLiopLylbMV07CiAgICAgIH07CiAgICB9CiAgCiAgICAvLyBUeXBlIGNvbnN0YW50cyB1c2VkIHRvIGRlZmluZSBmdW5jdGlvbnMuCiAgICB2YXIgVFlQRV9OVU1CRVIgPSAwOwogICAgdmFyIFRZUEVfQU5ZID0gMTsKICAgIHZhciBUWVBFX1NUUklORyA9IDI7CiAgICB2YXIgVFlQRV9BUlJBWSA9IDM7CiAgICB2YXIgVFlQRV9PQkpFQ1QgPSA0OwogICAgdmFyIFRZUEVfQk9PTEVBTiA9IDU7CiAgICB2YXIgVFlQRV9FWFBSRUYgPSA2OwogICAgdmFyIFRZUEVfTlVMTCA9IDc7CiAgICB2YXIgVFlQRV9BUlJBWV9OVU1CRVIgPSA4OwogICAgdmFyIFRZUEVfQVJSQVlfU1RSSU5HID0gOTsKICAKICAgIHZhciBUT0tfRU9GID0gIkVPRiI7CiAgICB2YXIgVE9LX1VOUVVPVEVESURFTlRJRklFUiA9ICJVbnF1b3RlZElkZW50aWZpZXIiOwogICAgdmFyIFRPS19RVU9URURJREVOVElGSUVSID0gIlF1b3RlZElkZW50aWZpZXIiOwogICAgdmFyIFRPS19SQlJBQ0tFVCA9ICJSYnJhY2tldCI7CiAgICB2YXIgVE9LX1JQQVJFTiA9ICJScGFyZW4iOwogICAgdmFyIFRPS19DT01NQSA9ICJDb21tYSI7CiAgICB2YXIgVE9LX0NPTE9OID0gIkNvbG9uIjsKICAgIHZhciBUT0tfUkJSQUNFID0gIlJicmFjZSI7CiAgICB2YXIgVE9LX05VTUJFUiA9ICJOdW1iZXIiOwogICAgdmFyIFRPS19DVVJSRU5UID0gIkN1cnJlbnQiOwogICAgdmFyIFRPS19FWFBSRUYgPSAiRXhwcmVmIjsKICAgIHZhciBUT0tfUElQRSA9ICJQaXBlIjsKICAgIHZhciBUT0tfT1IgPSAiT3IiOwogICAgdmFyIFRPS19BTkQgPSAiQW5kIjsKICAgIHZhciBUT0tfRVEgPSAiRVEiOwogICAgdmFyIFRPS19HVCA9ICJHVCI7CiAgICB2YXIgVE9LX0xUID0gIkxUIjsKICAgIHZhciBUT0tfR1RFID0gIkdURSI7CiAgICB2YXIgVE9LX0xURSA9ICJMVEUiOwogICAgdmFyIFRPS19ORSA9ICJORSI7CiAgICB2YXIgVE9LX0ZMQVRURU4gPSAiRmxhdHRlbiI7CiAgICB2YXIgVE9LX1NUQVIgPSAiU3RhciI7CiAgICB2YXIgVE9LX0ZJTFRFUiA9ICJGaWx0ZXIiOwogICAgdmFyIFRPS19ET1QgPSAiRG90IjsKICAgIHZhciBUT0tfTk9UID0gIk5vdCI7CiAgICB2YXIgVE9LX0xCUkFDRSA9ICJMYnJhY2UiOwogICAgdmFyIFRPS19MQlJBQ0tFVCA9ICJMYnJhY2tldCI7CiAgICB2YXIgVE9LX0xQQVJFTj0gIkxwYXJlbiI7CiAgICB2YXIgVE9LX0xJVEVSQUw9ICJMaXRlcmFsIjsKICAKICAgIC8vIFRoZSAiJiIsICJbIiwgIjwiLCAiPiIgdG9rZW5zCiAgICAvLyBhcmUgbm90IGluIGJhc2ljVG9rZW4gYmVjYXVzZQogICAgLy8gdGhlcmUgYXJlIHR3byB0b2tlbiB2YXJpYW50cwogICAgLy8gKCImJiIsICJbPyIsICI8PSIsICI+PSIpLiAgVGhpcyBpcyBzcGVjaWFsbHkgaGFuZGxlZAogICAgLy8gYmVsb3cuCiAgCiAgICB2YXIgYmFzaWNUb2tlbnMgPSB7CiAgICAgICIuIjogVE9LX0RPVCwKICAgICAgIioiOiBUT0tfU1RBUiwKICAgICAgIiwiOiBUT0tfQ09NTUEsCiAgICAgICI6IjogVE9LX0NPTE9OLAogICAgICAieyI6IFRPS19MQlJBQ0UsCiAgICAgICJ9IjogVE9LX1JCUkFDRSwKICAgICAgIl0iOiBUT0tfUkJSQUNLRVQsCiAgICAgICIoIjogVE9LX0xQQVJFTiwKICAgICAgIikiOiBUT0tfUlBBUkVOLAogICAgICAiQCI6IFRPS19DVVJSRU5UCiAgICB9OwogIAogICAgdmFyIG9wZXJhdG9yU3RhcnRUb2tlbiA9IHsKICAgICAgICAiPCI6IHRydWUsCiAgICAgICAgIj4iOiB0cnVlLAogICAgICAgICI9IjogdHJ1ZSwKICAgICAgICAiISI6IHRydWUKICAgIH07CiAgCiAgICB2YXIgc2tpcENoYXJzID0gewogICAgICAgICIgIjogdHJ1ZSwKICAgICAgICAiXHQiOiB0cnVlLAogICAgICAgICJcbiI6IHRydWUKICAgIH07CiAgCiAgCiAgICBmdW5jdGlvbiBpc0FscGhhKGNoKSB7CiAgICAgICAgcmV0dXJuIChjaCA+PSAiYSIgJiYgY2ggPD0gInoiKSB8fAogICAgICAgICAgICAgICAoY2ggPj0gIkEiICYmIGNoIDw9ICJaIikgfHwKICAgICAgICAgICAgICAgY2ggPT09ICJfIjsKICAgIH0KICAKICAgIGZ1bmN0aW9uIGlzTnVtKGNoKSB7CiAgICAgICAgcmV0dXJuIChjaCA+PSAiMCIgJiYgY2ggPD0gIjkiKSB8fAogICAgICAgICAgICAgICBjaCA9PT0gIi0iOwogICAgfQogICAgZnVuY3Rpb24gaXNBbHBoYU51bShjaCkgewogICAgICAgIHJldHVybiAoY2ggPj0gImEiICYmIGNoIDw9ICJ6IikgfHwKICAgICAgICAgICAgICAgKGNoID49ICJBIiAmJiBjaCA8PSAiWiIpIHx8CiAgICAgICAgICAgICAgIChjaCA+PSAiMCIgJiYgY2ggPD0gIjkiKSB8fAogICAgICAgICAgICAgICBjaCA9PT0gIl8iOwogICAgfQogIAogICAgZnVuY3Rpb24gTGV4ZXIoKSB7CiAgICB9CiAgICBMZXhlci5wcm90b3R5cGUgPSB7CiAgICAgICAgdG9rZW5pemU6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICB2YXIgdG9rZW5zID0gW107CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQgPSAwOwogICAgICAgICAgICB2YXIgc3RhcnQ7CiAgICAgICAgICAgIHZhciBpZGVudGlmaWVyOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIHdoaWxlICh0aGlzLl9jdXJyZW50IDwgc3RyZWFtLmxlbmd0aCkgewogICAgICAgICAgICAgICAgaWYgKGlzQWxwaGEoc3RyZWFtW3RoaXMuX2N1cnJlbnRdKSkgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgICBpZGVudGlmaWVyID0gdGhpcy5fY29uc3VtZVVucXVvdGVkSWRlbnRpZmllcihzdHJlYW0pOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfVU5RVU9URURJREVOVElGSUVSLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaWRlbnRpZmllciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGJhc2ljVG9rZW5zW3N0cmVhbVt0aGlzLl9jdXJyZW50XV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBiYXNpY1Rva2Vuc1tzdHJlYW1bdGhpcy5fY3VycmVudF1dLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBzdHJlYW1bdGhpcy5fY3VycmVudF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHRoaXMuX2N1cnJlbnR9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzTnVtKHN0cmVhbVt0aGlzLl9jdXJyZW50XSkpIHsKICAgICAgICAgICAgICAgICAgICB0b2tlbiA9IHRoaXMuX2NvbnN1bWVOdW1iZXIoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh0b2tlbik7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIlsiKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTm8gbmVlZCB0byBpbmNyZW1lbnQgdGhpcy5fY3VycmVudC4gIFRoaXMgaGFwcGVucwogICAgICAgICAgICAgICAgICAgIC8vIGluIF9jb25zdW1lTEJyYWNrZXQKICAgICAgICAgICAgICAgICAgICB0b2tlbiA9IHRoaXMuX2NvbnN1bWVMQnJhY2tldChzdHJlYW0pOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiXCIiKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICAgIGlkZW50aWZpZXIgPSB0aGlzLl9jb25zdW1lUXVvdGVkSWRlbnRpZmllcihzdHJlYW0pOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfUVVPVEVESURFTlRJRklFUiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGlkZW50aWZpZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICInIikgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgICBpZGVudGlmaWVyID0gdGhpcy5fY29uc3VtZVJhd1N0cmluZ0xpdGVyYWwoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX0xJVEVSQUwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpZGVudGlmaWVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiYCIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxpdGVyYWwgPSB0aGlzLl9jb25zdW1lTGl0ZXJhbChzdHJlYW0pOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfTElURVJBTCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGxpdGVyYWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvclN0YXJ0VG9rZW5bc3RyZWFtW3RoaXMuX2N1cnJlbnRdXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2godGhpcy5fY29uc3VtZU9wZXJhdG9yKHN0cmVhbSkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChza2lwQ2hhcnNbc3RyZWFtW3RoaXMuX2N1cnJlbnRdXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSWdub3JlIHdoaXRlc3BhY2UuCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICImIikgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIiYiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19BTkQsIHZhbHVlOiAiJiYiLCBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX0VYUFJFRiwgdmFsdWU6ICImIiwgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJ8IikgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gInwiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19PUiwgdmFsdWU6ICJ8fCIsIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfUElQRSwgdmFsdWU6ICJ8Iiwgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIlVua25vd24gY2hhcmFjdGVyOiIgKyBzdHJlYW1bdGhpcy5fY3VycmVudF0pOwogICAgICAgICAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiTGV4ZXJFcnJvciI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRva2VuczsKICAgICAgICB9LAogIAogICAgICAgIF9jb25zdW1lVW5xdW90ZWRJZGVudGlmaWVyOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICB3aGlsZSAodGhpcy5fY3VycmVudCA8IHN0cmVhbS5sZW5ndGggJiYgaXNBbHBoYU51bShzdHJlYW1bdGhpcy5fY3VycmVudF0pKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0cmVhbS5zbGljZShzdGFydCwgdGhpcy5fY3VycmVudCk7CiAgICAgICAgfSwKICAKICAgICAgICBfY29uc3VtZVF1b3RlZElkZW50aWZpZXI6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHZhciBtYXhMZW5ndGggPSBzdHJlYW0ubGVuZ3RoOwogICAgICAgICAgICB3aGlsZSAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdICE9PSAiXCIiICYmIHRoaXMuX2N1cnJlbnQgPCBtYXhMZW5ndGgpIHsKICAgICAgICAgICAgICAgIC8vIFlvdSBjYW4gZXNjYXBlIGEgZG91YmxlIHF1b3RlIGFuZCB5b3UgY2FuIGVzY2FwZSBhbiBlc2NhcGUuCiAgICAgICAgICAgICAgICB2YXIgY3VycmVudCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW2N1cnJlbnRdID09PSAiXFwiICYmIChzdHJlYW1bY3VycmVudCArIDFdID09PSAiXFwiIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW1bY3VycmVudCArIDFdID09PSAiXCIiKSkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgKz0gMjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCA9IGN1cnJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShzdHJlYW0uc2xpY2Uoc3RhcnQsIHRoaXMuX2N1cnJlbnQpKTsKICAgICAgICB9LAogIAogICAgICAgIF9jb25zdW1lUmF3U3RyaW5nTGl0ZXJhbDogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgdmFyIG1heExlbmd0aCA9IHN0cmVhbS5sZW5ndGg7CiAgICAgICAgICAgIHdoaWxlIChzdHJlYW1bdGhpcy5fY3VycmVudF0gIT09ICInIiAmJiB0aGlzLl9jdXJyZW50IDwgbWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAvLyBZb3UgY2FuIGVzY2FwZSBhIHNpbmdsZSBxdW90ZSBhbmQgeW91IGNhbiBlc2NhcGUgYW4gZXNjYXBlLgogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgaWYgKHN0cmVhbVtjdXJyZW50XSA9PT0gIlxcIiAmJiAoc3RyZWFtW2N1cnJlbnQgKyAxXSA9PT0gIlxcIiB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtW2N1cnJlbnQgKyAxXSA9PT0gIiciKSkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgKz0gMjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCA9IGN1cnJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICB2YXIgbGl0ZXJhbCA9IHN0cmVhbS5zbGljZShzdGFydCArIDEsIHRoaXMuX2N1cnJlbnQgLSAxKTsKICAgICAgICAgICAgcmV0dXJuIGxpdGVyYWwucmVwbGFjZSgiXFwnIiwgIiciKTsKICAgICAgICB9LAogIAogICAgICAgIF9jb25zdW1lTnVtYmVyOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICB2YXIgbWF4TGVuZ3RoID0gc3RyZWFtLmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKGlzTnVtKHN0cmVhbVt0aGlzLl9jdXJyZW50XSkgJiYgdGhpcy5fY3VycmVudCA8IG1heExlbmd0aCkgewogICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHBhcnNlSW50KHN0cmVhbS5zbGljZShzdGFydCwgdGhpcy5fY3VycmVudCkpOwogICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19OVU1CRVIsIHZhbHVlOiB2YWx1ZSwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICB9LAogIAogICAgICAgIF9jb25zdW1lTEJyYWNrZXQ6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICI/IikgewogICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfRklMVEVSLCB2YWx1ZTogIls/Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJdIikgewogICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfRkxBVFRFTiwgdmFsdWU6ICJbXSIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19MQlJBQ0tFVCwgdmFsdWU6ICJbIiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVPcGVyYXRvcjogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgIHZhciBzdGFydGluZ0NoYXIgPSBzdHJlYW1bc3RhcnRdOwogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIGlmIChzdGFydGluZ0NoYXIgPT09ICIhIikgewogICAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIj0iKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX05FLCB2YWx1ZTogIiE9Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX05PVCwgdmFsdWU6ICIhIiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFydGluZ0NoYXIgPT09ICI8IikgewogICAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIj0iKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0xURSwgdmFsdWU6ICI8PSIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0xULCB2YWx1ZTogIjwiLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0aW5nQ2hhciA9PT0gIj4iKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiPSIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfR1RFLCB2YWx1ZTogIj49Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfR1QsIHZhbHVlOiAiPiIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnRpbmdDaGFyID09PSAiPSIpIHsKICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICI9IikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19FUSwgdmFsdWU6ICI9PSIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIF9jb25zdW1lTGl0ZXJhbDogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgdmFyIG1heExlbmd0aCA9IHN0cmVhbS5sZW5ndGg7CiAgICAgICAgICAgIHZhciBsaXRlcmFsOwogICAgICAgICAgICB3aGlsZShzdHJlYW1bdGhpcy5fY3VycmVudF0gIT09ICJgIiAmJiB0aGlzLl9jdXJyZW50IDwgbWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAvLyBZb3UgY2FuIGVzY2FwZSBhIGxpdGVyYWwgY2hhciBvciB5b3UgY2FuIGVzY2FwZSB0aGUgZXNjYXBlLgogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgaWYgKHN0cmVhbVtjdXJyZW50XSA9PT0gIlxcIiAmJiAoc3RyZWFtW2N1cnJlbnQgKyAxXSA9PT0gIlxcIiB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtW2N1cnJlbnQgKyAxXSA9PT0gImAiKSkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgKz0gMjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCA9IGN1cnJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGxpdGVyYWxTdHJpbmcgPSB0cmltTGVmdChzdHJlYW0uc2xpY2Uoc3RhcnQsIHRoaXMuX2N1cnJlbnQpKTsKICAgICAgICAgICAgbGl0ZXJhbFN0cmluZyA9IGxpdGVyYWxTdHJpbmcucmVwbGFjZSgiXFxgIiwgImAiKTsKICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2tzTGlrZUpTT04obGl0ZXJhbFN0cmluZykpIHsKICAgICAgICAgICAgICAgIGxpdGVyYWwgPSBKU09OLnBhcnNlKGxpdGVyYWxTdHJpbmcpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gVHJ5IHRvIEpTT04gcGFyc2UgaXQgYXMgIjxsaXRlcmFsPiIKICAgICAgICAgICAgICAgIGxpdGVyYWwgPSBKU09OLnBhcnNlKCJcIiIgKyBsaXRlcmFsU3RyaW5nICsgIlwiIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gKzEgZ2V0cyB1cyB0byB0aGUgZW5kaW5nICJgIiwgKzEgdG8gbW92ZSBvbiB0byB0aGUgbmV4dCBjaGFyLgogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHJldHVybiBsaXRlcmFsOwogICAgICAgIH0sCiAgCiAgICAgICAgX2xvb2tzTGlrZUpTT046IGZ1bmN0aW9uKGxpdGVyYWxTdHJpbmcpIHsKICAgICAgICAgICAgdmFyIHN0YXJ0aW5nQ2hhcnMgPSAiW3tcIiI7CiAgICAgICAgICAgIHZhciBqc29uTGl0ZXJhbHMgPSBbInRydWUiLCAiZmFsc2UiLCAibnVsbCJdOwogICAgICAgICAgICB2YXIgbnVtYmVyTG9va2luZyA9ICItMDEyMzQ1Njc4OSI7CiAgCiAgICAgICAgICAgIGlmIChsaXRlcmFsU3RyaW5nID09PSAiIikgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0aW5nQ2hhcnMuaW5kZXhPZihsaXRlcmFsU3RyaW5nWzBdKSA+PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChqc29uTGl0ZXJhbHMuaW5kZXhPZihsaXRlcmFsU3RyaW5nKSA+PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChudW1iZXJMb29raW5nLmluZGV4T2YobGl0ZXJhbFN0cmluZ1swXSkgPj0gMCkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBKU09OLnBhcnNlKGxpdGVyYWxTdHJpbmcpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogIAogICAgICAgIHZhciBiaW5kaW5nUG93ZXIgPSB7fTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0VPRl0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfVU5RVU9URURJREVOVElGSUVSXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19RVU9URURJREVOVElGSUVSXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19SQlJBQ0tFVF0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfUlBBUkVOXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19DT01NQV0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfUkJSQUNFXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19OVU1CRVJdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0NVUlJFTlRdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0VYUFJFRl0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfUElQRV0gPSAxOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfT1JdID0gMjsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0FORF0gPSAzOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfRVFdID0gNTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0dUXSA9IDU7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19MVF0gPSA1OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfR1RFXSA9IDU7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19MVEVdID0gNTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX05FXSA9IDU7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19GTEFUVEVOXSA9IDk7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19TVEFSXSA9IDIwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfRklMVEVSXSA9IDIxOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfRE9UXSA9IDQwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfTk9UXSA9IDQ1OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfTEJSQUNFXSA9IDUwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfTEJSQUNLRVRdID0gNTU7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19MUEFSRU5dID0gNjA7CiAgCiAgICBmdW5jdGlvbiBQYXJzZXIoKSB7CiAgICB9CiAgCiAgICBQYXJzZXIucHJvdG90eXBlID0gewogICAgICAgIHBhcnNlOiBmdW5jdGlvbihleHByZXNzaW9uKSB7CiAgICAgICAgICAgIHRoaXMuX2xvYWRUb2tlbnMoZXhwcmVzc2lvbik7CiAgICAgICAgICAgIHRoaXMuaW5kZXggPSAwOwogICAgICAgICAgICB2YXIgYXN0ID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApICE9PSBUT0tfRU9GKSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKAogICAgICAgICAgICAgICAgICAgICJVbmV4cGVjdGVkIHRva2VuIHR5cGU6ICIgKyB0LnR5cGUgKyAiLCB2YWx1ZTogIiArIHQudmFsdWUpOwogICAgICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJQYXJzZXJFcnJvciI7CiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYXN0OwogICAgICAgIH0sCiAgCiAgICAgICAgX2xvYWRUb2tlbnM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pIHsKICAgICAgICAgICAgdmFyIGxleGVyID0gbmV3IExleGVyKCk7CiAgICAgICAgICAgIHZhciB0b2tlbnMgPSBsZXhlci50b2tlbml6ZShleHByZXNzaW9uKTsKICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19FT0YsIHZhbHVlOiAiIiwgc3RhcnQ6IGV4cHJlc3Npb24ubGVuZ3RofSk7CiAgICAgICAgICAgIHRoaXMudG9rZW5zID0gdG9rZW5zOwogICAgICAgIH0sCiAgCiAgICAgICAgZXhwcmVzc2lvbjogZnVuY3Rpb24ocmJwKSB7CiAgICAgICAgICAgIHZhciBsZWZ0VG9rZW4gPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICB2YXIgbGVmdCA9IHRoaXMubnVkKGxlZnRUb2tlbik7CiAgICAgICAgICAgIHZhciBjdXJyZW50VG9rZW4gPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICAgIHdoaWxlIChyYnAgPCBiaW5kaW5nUG93ZXJbY3VycmVudFRva2VuXSkgewogICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgbGVmdCA9IHRoaXMubGVkKGN1cnJlbnRUb2tlbiwgbGVmdCk7CiAgICAgICAgICAgICAgICBjdXJyZW50VG9rZW4gPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfSwKICAKICAgICAgICBfbG9va2FoZWFkOiBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudG9rZW5zW3RoaXMuaW5kZXggKyBudW1iZXJdLnR5cGU7CiAgICAgICAgfSwKICAKICAgICAgICBfbG9va2FoZWFkVG9rZW46IGZ1bmN0aW9uKG51bWJlcikgewogICAgICAgICAgICByZXR1cm4gdGhpcy50b2tlbnNbdGhpcy5pbmRleCArIG51bWJlcl07CiAgICAgICAgfSwKICAKICAgICAgICBfYWR2YW5jZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuaW5kZXgrKzsKICAgICAgICB9LAogIAogICAgICAgIG51ZDogZnVuY3Rpb24odG9rZW4pIHsKICAgICAgICAgIHZhciBsZWZ0OwogICAgICAgICAgdmFyIHJpZ2h0OwogICAgICAgICAgdmFyIGV4cHJlc3Npb247CiAgICAgICAgICBzd2l0Y2ggKHRva2VuLnR5cGUpIHsKICAgICAgICAgICAgY2FzZSBUT0tfTElURVJBTDoKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJMaXRlcmFsIiwgdmFsdWU6IHRva2VuLnZhbHVlfTsKICAgICAgICAgICAgY2FzZSBUT0tfVU5RVU9URURJREVOVElGSUVSOgogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIkZpZWxkIiwgbmFtZTogdG9rZW4udmFsdWV9OwogICAgICAgICAgICBjYXNlIFRPS19RVU9URURJREVOVElGSUVSOgogICAgICAgICAgICAgIHZhciBub2RlID0ge3R5cGU6ICJGaWVsZCIsIG5hbWU6IHRva2VuLnZhbHVlfTsKICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfTFBBUkVOKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUXVvdGVkIGlkZW50aWZpZXIgbm90IGFsbG93ZWQgZm9yIGZ1bmN0aW9uIG5hbWVzLiIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUT0tfTk9UOgogICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlci5Ob3QpOwogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIk5vdEV4cHJlc3Npb24iLCBjaGlsZHJlbjogW3JpZ2h0XX07CiAgICAgICAgICAgIGNhc2UgVE9LX1NUQVI6CiAgICAgICAgICAgICAgbGVmdCA9IHt0eXBlOiAiSWRlbnRpdHkifTsKICAgICAgICAgICAgICByaWdodCA9IG51bGw7CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX1JCUkFDS0VUKSB7CiAgICAgICAgICAgICAgICAgIC8vIFRoaXMgY2FuIGhhcHBlbiBpbiBhIG11bHRpc2VsZWN0LAogICAgICAgICAgICAgICAgICAvLyBbYSwgYiwgKl0KICAgICAgICAgICAgICAgICAgcmlnaHQgPSB7dHlwZTogIklkZW50aXR5In07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLlN0YXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJWYWx1ZVByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgIGNhc2UgVE9LX0ZJTFRFUjoKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sZWQodG9rZW4udHlwZSwge3R5cGU6ICJJZGVudGl0eSJ9KTsKICAgICAgICAgICAgY2FzZSBUT0tfTEJSQUNFOgogICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZU11bHRpc2VsZWN0SGFzaCgpOwogICAgICAgICAgICBjYXNlIFRPS19GTEFUVEVOOgogICAgICAgICAgICAgIGxlZnQgPSB7dHlwZTogVE9LX0ZMQVRURU4sIGNoaWxkcmVuOiBbe3R5cGU6ICJJZGVudGl0eSJ9XX07CiAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLkZsYXR0ZW4pOwogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgIGNhc2UgVE9LX0xCUkFDS0VUOgogICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19OVU1CRVIgfHwgdGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ09MT04pIHsKICAgICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZUluZGV4RXhwcmVzc2lvbigpOwogICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcHJvamVjdElmU2xpY2Uoe3R5cGU6ICJJZGVudGl0eSJ9LCByaWdodCk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19TVEFSICYmCiAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb29rYWhlYWQoMSkgPT09IFRPS19SQlJBQ0tFVCkgewogICAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLlN0YXIpOwogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJQcm9qZWN0aW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogW3t0eXBlOiAiSWRlbnRpdHkifSwgcmlnaHRdfTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VNdWx0aXNlbGVjdExpc3QoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVE9LX0NVUlJFTlQ6CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfQ1VSUkVOVH07CiAgICAgICAgICAgIGNhc2UgVE9LX0VYUFJFRjoKICAgICAgICAgICAgICBleHByZXNzaW9uID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlci5FeHByZWYpOwogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIkV4cHJlc3Npb25SZWZlcmVuY2UiLCBjaGlsZHJlbjogW2V4cHJlc3Npb25dfTsKICAgICAgICAgICAgY2FzZSBUT0tfTFBBUkVOOgogICAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2xvb2thaGVhZCgwKSAhPT0gVE9LX1JQQVJFTikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NVUlJFTlQpIHsKICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHt0eXBlOiBUT0tfQ1VSUkVOVH07CiAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhcmdzLnB1c2goZXhwcmVzc2lvbik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SUEFSRU4pOwogICAgICAgICAgICAgIHJldHVybiBhcmdzWzBdOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRoaXMuX2Vycm9yVG9rZW4odG9rZW4pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgbGVkOiBmdW5jdGlvbih0b2tlbk5hbWUsIGxlZnQpIHsKICAgICAgICAgIHZhciByaWdodDsKICAgICAgICAgIHN3aXRjaCh0b2tlbk5hbWUpIHsKICAgICAgICAgICAgY2FzZSBUT0tfRE9UOgogICAgICAgICAgICAgIHZhciByYnAgPSBiaW5kaW5nUG93ZXIuRG90OwogICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgIT09IFRPS19TVEFSKSB7CiAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VEb3RSSFMocmJwKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiU3ViZXhwcmVzc2lvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAvLyBDcmVhdGluZyBhIHByb2plY3Rpb24uCiAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMocmJwKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiVmFsdWVQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUT0tfUElQRToKICAgICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihiaW5kaW5nUG93ZXIuUGlwZSk7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfUElQRSwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICBjYXNlIFRPS19PUjoKICAgICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihiaW5kaW5nUG93ZXIuT3IpOwogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIk9yRXhwcmVzc2lvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgY2FzZSBUT0tfQU5EOgogICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlci5BbmQpOwogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIkFuZEV4cHJlc3Npb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgIGNhc2UgVE9LX0xQQVJFTjoKICAgICAgICAgICAgICB2YXIgbmFtZSA9IGxlZnQubmFtZTsKICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICAgIHZhciBleHByZXNzaW9uLCBub2RlOwogICAgICAgICAgICAgIHdoaWxlICh0aGlzLl9sb29rYWhlYWQoMCkgIT09IFRPS19SUEFSRU4pIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DVVJSRU5UKSB7CiAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB7dHlwZTogVE9LX0NVUlJFTlR9OwogICAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBleHByZXNzaW9uID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NPTU1BKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19DT01NQSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhcmdzLnB1c2goZXhwcmVzc2lvbik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SUEFSRU4pOwogICAgICAgICAgICAgIG5vZGUgPSB7dHlwZTogIkZ1bmN0aW9uIiwgbmFtZTogbmFtZSwgY2hpbGRyZW46IGFyZ3N9OwogICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICBjYXNlIFRPS19GSUxURVI6CiAgICAgICAgICAgICAgdmFyIGNvbmRpdGlvbiA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNLRVQpOwogICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19GTEFUVEVOKSB7CiAgICAgICAgICAgICAgICByaWdodCA9IHt0eXBlOiAiSWRlbnRpdHkifTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLkZpbHRlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIkZpbHRlclByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0LCBjb25kaXRpb25dfTsKICAgICAgICAgICAgY2FzZSBUT0tfRkxBVFRFTjoKICAgICAgICAgICAgICB2YXIgbGVmdE5vZGUgPSB7dHlwZTogVE9LX0ZMQVRURU4sIGNoaWxkcmVuOiBbbGVmdF19OwogICAgICAgICAgICAgIHZhciByaWdodE5vZGUgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLkZsYXR0ZW4pOwogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnROb2RlLCByaWdodE5vZGVdfTsKICAgICAgICAgICAgY2FzZSBUT0tfRVE6CiAgICAgICAgICAgIGNhc2UgVE9LX05FOgogICAgICAgICAgICBjYXNlIFRPS19HVDoKICAgICAgICAgICAgY2FzZSBUT0tfR1RFOgogICAgICAgICAgICBjYXNlIFRPS19MVDoKICAgICAgICAgICAgY2FzZSBUT0tfTFRFOgogICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZUNvbXBhcmF0b3IobGVmdCwgdG9rZW5OYW1lKTsKICAgICAgICAgICAgY2FzZSBUT0tfTEJSQUNLRVQ6CiAgICAgICAgICAgICAgdmFyIHRva2VuID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRPS19OVU1CRVIgfHwgdG9rZW4udHlwZSA9PT0gVE9LX0NPTE9OKSB7CiAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VJbmRleEV4cHJlc3Npb24oKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Byb2plY3RJZlNsaWNlKGxlZnQsIHJpZ2h0KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfU1RBUik7CiAgICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0tFVCk7CiAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5TdGFyKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGhpcy5fZXJyb3JUb2tlbih0aGlzLl9sb29rYWhlYWRUb2tlbigwKSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBfbWF0Y2g6IGZ1bmN0aW9uKHRva2VuVHlwZSkgewogICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSB0b2tlblR5cGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIkV4cGVjdGVkICIgKyB0b2tlblR5cGUgKyAiLCBnb3Q6ICIgKyB0LnR5cGUpOwogICAgICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJQYXJzZXJFcnJvciI7CiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgX2Vycm9yVG9rZW46IGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiSW52YWxpZCB0b2tlbiAoIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbi50eXBlICsgIik6IFwiIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbi52YWx1ZSArICJcIiIpOwogICAgICAgICAgICBlcnJvci5uYW1lID0gIlBhcnNlckVycm9yIjsKICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgfSwKICAKICAKICAgICAgICBfcGFyc2VJbmRleEV4cHJlc3Npb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ09MT04gfHwgdGhpcy5fbG9va2FoZWFkKDEpID09PSBUT0tfQ09MT04pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZVNsaWNlRXhwcmVzc2lvbigpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIG5vZGUgPSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogIkluZGV4IiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdGhpcy5fbG9va2FoZWFkVG9rZW4oMCkudmFsdWV9OwogICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDS0VUKTsKICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBfcHJvamVjdElmU2xpY2U6IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgICAgIHZhciBpbmRleEV4cHIgPSB7dHlwZTogIkluZGV4RXhwcmVzc2lvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgaWYgKHJpZ2h0LnR5cGUgPT09ICJTbGljZSIpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogIlByb2plY3Rpb24iLAogICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbaW5kZXhFeHByLCB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLlN0YXIpXQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBpbmRleEV4cHI7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIF9wYXJzZVNsaWNlRXhwcmVzc2lvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vIFtzdGFydDplbmQ6c3RlcF0gd2hlcmUgZWFjaCBwYXJ0IGlzIG9wdGlvbmFsLCBhcyB3ZWxsIGFzIHRoZSBsYXN0CiAgICAgICAgICAgIC8vIGNvbG9uLgogICAgICAgICAgICB2YXIgcGFydHMgPSBbbnVsbCwgbnVsbCwgbnVsbF07CiAgICAgICAgICAgIHZhciBpbmRleCA9IDA7CiAgICAgICAgICAgIHZhciBjdXJyZW50VG9rZW4gPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50VG9rZW4gIT09IFRPS19SQlJBQ0tFVCAmJiBpbmRleCA8IDMpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50VG9rZW4gPT09IFRPS19DT0xPTikgewogICAgICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50VG9rZW4gPT09IFRPS19OVU1CRVIpIHsKICAgICAgICAgICAgICAgICAgICBwYXJ0c1tpbmRleF0gPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKS52YWx1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcy5fbG9va2FoZWFkKDApOwogICAgICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiU3ludGF4IGVycm9yLCB1bmV4cGVjdGVkIHRva2VuOiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC52YWx1ZSArICIoIiArIHQudHlwZSArICIpIik7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJQYXJzZXJlcnJvciI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50VG9rZW4gPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDS0VUKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHR5cGU6ICJTbGljZSIsCiAgICAgICAgICAgICAgICBjaGlsZHJlbjogcGFydHMKICAgICAgICAgICAgfTsKICAgICAgICB9LAogIAogICAgICAgIF9wYXJzZUNvbXBhcmF0b3I6IGZ1bmN0aW9uKGxlZnQsIGNvbXBhcmF0b3IpIHsKICAgICAgICAgIHZhciByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihiaW5kaW5nUG93ZXJbY29tcGFyYXRvcl0pOwogICAgICAgICAgcmV0dXJuIHt0eXBlOiAiQ29tcGFyYXRvciIsIG5hbWU6IGNvbXBhcmF0b3IsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICB9LAogIAogICAgICAgIF9wYXJzZURvdFJIUzogZnVuY3Rpb24ocmJwKSB7CiAgICAgICAgICAgIHZhciBsb29rYWhlYWQgPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICAgIHZhciBleHByVG9rZW5zID0gW1RPS19VTlFVT1RFRElERU5USUZJRVIsIFRPS19RVU9URURJREVOVElGSUVSLCBUT0tfU1RBUl07CiAgICAgICAgICAgIGlmIChleHByVG9rZW5zLmluZGV4T2YobG9va2FoZWFkKSA+PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5leHByZXNzaW9uKHJicCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobG9va2FoZWFkID09PSBUT0tfTEJSQUNLRVQpIHsKICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19MQlJBQ0tFVCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VNdWx0aXNlbGVjdExpc3QoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChsb29rYWhlYWQgPT09IFRPS19MQlJBQ0UpIHsKICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19MQlJBQ0UpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlTXVsdGlzZWxlY3RIYXNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIF9wYXJzZVByb2plY3Rpb25SSFM6IGZ1bmN0aW9uKHJicCkgewogICAgICAgICAgICB2YXIgcmlnaHQ7CiAgICAgICAgICAgIGlmIChiaW5kaW5nUG93ZXJbdGhpcy5fbG9va2FoZWFkKDApXSA8IDEwKSB7CiAgICAgICAgICAgICAgICByaWdodCA9IHt0eXBlOiAiSWRlbnRpdHkifTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19MQlJBQ0tFVCkgewogICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24ocmJwKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19GSUxURVIpIHsKICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKHJicCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfRE9UKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfRE9UKTsKICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VEb3RSSFMocmJwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIlN5dGFueCBlcnJvciwgdW5leHBlY3RlZCB0b2tlbjogIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC52YWx1ZSArICIoIiArIHQudHlwZSArICIpIik7CiAgICAgICAgICAgICAgICBlcnJvci5uYW1lID0gIlBhcnNlckVycm9yIjsKICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByaWdodDsKICAgICAgICB9LAogIAogICAgICAgIF9wYXJzZU11bHRpc2VsZWN0TGlzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBleHByZXNzaW9ucyA9IFtdOwogICAgICAgICAgICB3aGlsZSAodGhpcy5fbG9va2FoZWFkKDApICE9PSBUT0tfUkJSQUNLRVQpIHsKICAgICAgICAgICAgICAgIHZhciBleHByZXNzaW9uID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgICAgICAgZXhwcmVzc2lvbnMucHVzaChleHByZXNzaW9uKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DT01NQSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19DT01NQSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX1JCUkFDS0VUKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgdG9rZW4gUmJyYWNrZXQiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDS0VUKTsKICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiTXVsdGlTZWxlY3RMaXN0IiwgY2hpbGRyZW46IGV4cHJlc3Npb25zfTsKICAgICAgICB9LAogIAogICAgICAgIF9wYXJzZU11bHRpc2VsZWN0SGFzaDogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgcGFpcnMgPSBbXTsKICAgICAgICAgIHZhciBpZGVudGlmaWVyVHlwZXMgPSBbVE9LX1VOUVVPVEVESURFTlRJRklFUiwgVE9LX1FVT1RFRElERU5USUZJRVJdOwogICAgICAgICAgdmFyIGtleVRva2VuLCBrZXlOYW1lLCB2YWx1ZSwgbm9kZTsKICAgICAgICAgIGZvciAoOzspIHsKICAgICAgICAgICAga2V5VG9rZW4gPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgaWYgKGlkZW50aWZpZXJUeXBlcy5pbmRleE9mKGtleVRva2VuLnR5cGUpIDwgMCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0aW5nIGFuIGlkZW50aWZpZXIgdG9rZW4sIGdvdDogIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleVRva2VuLnR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGtleU5hbWUgPSBrZXlUb2tlbi52YWx1ZTsKICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfQ09MT04pOwogICAgICAgICAgICB2YWx1ZSA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgICAgbm9kZSA9IHt0eXBlOiAiS2V5VmFsdWVQYWlyIiwgbmFtZToga2V5TmFtZSwgdmFsdWU6IHZhbHVlfTsKICAgICAgICAgICAgcGFpcnMucHVzaChub2RlKTsKICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NPTU1BKSB7CiAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0NPTU1BKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19SQlJBQ0UpIHsKICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNFKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHt0eXBlOiAiTXVsdGlTZWxlY3RIYXNoIiwgY2hpbGRyZW46IHBhaXJzfTsKICAgICAgICB9CiAgICB9OwogIAogIAogICAgZnVuY3Rpb24gVHJlZUludGVycHJldGVyKHJ1bnRpbWUpIHsKICAgICAgdGhpcy5ydW50aW1lID0gcnVudGltZTsKICAgIH0KICAKICAgIFRyZWVJbnRlcnByZXRlci5wcm90b3R5cGUgPSB7CiAgICAgICAgc2VhcmNoOiBmdW5jdGlvbihub2RlLCB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy52aXNpdChub2RlLCB2YWx1ZSk7CiAgICAgICAgfSwKICAKICAgICAgICB2aXNpdDogZnVuY3Rpb24obm9kZSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIG1hdGNoZWQsIGN1cnJlbnQsIHJlc3VsdCwgZmlyc3QsIHNlY29uZCwgZmllbGQsIGxlZnQsIHJpZ2h0LCBjb2xsZWN0ZWQsIGk7CiAgICAgICAgICAgIHN3aXRjaCAobm9kZS50eXBlKSB7CiAgICAgICAgICAgICAgY2FzZSAiRmllbGQiOgogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsICkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc09iamVjdCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICBmaWVsZCA9IHZhbHVlW25vZGUubmFtZV07CiAgICAgICAgICAgICAgICAgICAgaWYgKGZpZWxkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpZWxkOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAiU3ViZXhwcmVzc2lvbiI6CiAgICAgICAgICAgICAgICByZXN1bHQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDE7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCByZXN1bHQpOwogICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICBjYXNlICJJbmRleEV4cHJlc3Npb24iOgogICAgICAgICAgICAgICAgbGVmdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIGxlZnQpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJpZ2h0OwogICAgICAgICAgICAgIGNhc2UgIkluZGV4IjoKICAgICAgICAgICAgICAgIGlmICghaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSBub2RlLnZhbHVlOwogICAgICAgICAgICAgICAgaWYgKGluZGV4IDwgMCkgewogICAgICAgICAgICAgICAgICBpbmRleCA9IHZhbHVlLmxlbmd0aCArIGluZGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVzdWx0ID0gdmFsdWVbaW5kZXhdOwogICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgIGNhc2UgIlNsaWNlIjoKICAgICAgICAgICAgICAgIGlmICghaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgc2xpY2VQYXJhbXMgPSBub2RlLmNoaWxkcmVuLnNsaWNlKDApOwogICAgICAgICAgICAgICAgdmFyIGNvbXB1dGVkID0gdGhpcy5jb21wdXRlU2xpY2VQYXJhbXModmFsdWUubGVuZ3RoLCBzbGljZVBhcmFtcyk7CiAgICAgICAgICAgICAgICB2YXIgc3RhcnQgPSBjb21wdXRlZFswXTsKICAgICAgICAgICAgICAgIHZhciBzdG9wID0gY29tcHV0ZWRbMV07CiAgICAgICAgICAgICAgICB2YXIgc3RlcCA9IGNvbXB1dGVkWzJdOwogICAgICAgICAgICAgICAgcmVzdWx0ID0gW107CiAgICAgICAgICAgICAgICBpZiAoc3RlcCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSBzdGFydDsgaSA8IHN0b3A7IGkgKz0gc3RlcCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZVtpXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSBzdGFydDsgaSA+IHN0b3A7IGkgKz0gc3RlcCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZVtpXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICBjYXNlICJQcm9qZWN0aW9uIjoKICAgICAgICAgICAgICAgIC8vIEV2YWx1YXRlIGxlZnQgY2hpbGQuCiAgICAgICAgICAgICAgICB2YXIgYmFzZSA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KGJhc2UpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29sbGVjdGVkID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYmFzZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBjdXJyZW50ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCBiYXNlW2ldKTsKICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb2xsZWN0ZWQucHVzaChjdXJyZW50KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3RlZDsKICAgICAgICAgICAgICBjYXNlICJWYWx1ZVByb2plY3Rpb24iOgogICAgICAgICAgICAgICAgLy8gRXZhbHVhdGUgbGVmdCBjaGlsZC4KICAgICAgICAgICAgICAgIGJhc2UgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIGlmICghaXNPYmplY3QoYmFzZSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb2xsZWN0ZWQgPSBbXTsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBvYmpWYWx1ZXMoYmFzZSk7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIHZhbHVlc1tpXSk7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29sbGVjdGVkLnB1c2goY3VycmVudCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBjb2xsZWN0ZWQ7CiAgICAgICAgICAgICAgY2FzZSAiRmlsdGVyUHJvamVjdGlvbiI6CiAgICAgICAgICAgICAgICBiYXNlID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkoYmFzZSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgZmlsdGVyZWQgPSBbXTsKICAgICAgICAgICAgICAgIHZhciBmaW5hbFJlc3VsdHMgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBiYXNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIG1hdGNoZWQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMl0sIGJhc2VbaV0pOwogICAgICAgICAgICAgICAgICBpZiAoIWlzRmFsc2UobWF0Y2hlZCkpIHsKICAgICAgICAgICAgICAgICAgICBmaWx0ZXJlZC5wdXNoKGJhc2VbaV0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGZpbHRlcmVkLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIGZpbHRlcmVkW2pdKTsKICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBmaW5hbFJlc3VsdHMucHVzaChjdXJyZW50KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGZpbmFsUmVzdWx0czsKICAgICAgICAgICAgICBjYXNlICJDb21wYXJhdG9yIjoKICAgICAgICAgICAgICAgIGZpcnN0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBzZWNvbmQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIHN3aXRjaChub2RlLm5hbWUpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBUT0tfRVE6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gc3RyaWN0RGVlcEVxdWFsKGZpcnN0LCBzZWNvbmQpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIFRPS19ORToKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSAhc3RyaWN0RGVlcEVxdWFsKGZpcnN0LCBzZWNvbmQpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIFRPS19HVDoKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBmaXJzdCA+IHNlY29uZDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBUT0tfR1RFOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZpcnN0ID49IHNlY29uZDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBUT0tfTFQ6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZmlyc3QgPCBzZWNvbmQ7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgVE9LX0xURToKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBmaXJzdCA8PSBzZWNvbmQ7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIGNvbXBhcmF0b3I6ICIgKyBub2RlLm5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICBjYXNlIFRPS19GTEFUVEVOOgogICAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkob3JpZ2luYWwpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG1lcmdlZCA9IFtdOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG9yaWdpbmFsLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBvcmlnaW5hbFtpXTsKICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoY3VycmVudCkpIHsKICAgICAgICAgICAgICAgICAgICBtZXJnZWQucHVzaC5hcHBseShtZXJnZWQsIGN1cnJlbnQpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1lcmdlZC5wdXNoKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbWVyZ2VkOwogICAgICAgICAgICAgIGNhc2UgIklkZW50aXR5IjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICBjYXNlICJNdWx0aVNlbGVjdExpc3QiOgogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29sbGVjdGVkID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbGxlY3RlZC5wdXNoKHRoaXMudmlzaXQobm9kZS5jaGlsZHJlbltpXSwgdmFsdWUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBjb2xsZWN0ZWQ7CiAgICAgICAgICAgICAgY2FzZSAiTXVsdGlTZWxlY3RIYXNoIjoKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbGxlY3RlZCA9IHt9OwogICAgICAgICAgICAgICAgdmFyIGNoaWxkOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgY2hpbGQgPSBub2RlLmNoaWxkcmVuW2ldOwogICAgICAgICAgICAgICAgICBjb2xsZWN0ZWRbY2hpbGQubmFtZV0gPSB0aGlzLnZpc2l0KGNoaWxkLnZhbHVlLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gY29sbGVjdGVkOwogICAgICAgICAgICAgIGNhc2UgIk9yRXhwcmVzc2lvbiI6CiAgICAgICAgICAgICAgICBtYXRjaGVkID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBpZiAoaXNGYWxzZShtYXRjaGVkKSkgewogICAgICAgICAgICAgICAgICAgIG1hdGNoZWQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaGVkOwogICAgICAgICAgICAgIGNhc2UgIkFuZEV4cHJlc3Npb24iOgogICAgICAgICAgICAgICAgZmlyc3QgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAKICAgICAgICAgICAgICAgIGlmIChpc0ZhbHNlKGZpcnN0KSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZmlyc3Q7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgY2FzZSAiTm90RXhwcmVzc2lvbiI6CiAgICAgICAgICAgICAgICBmaXJzdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIGlzRmFsc2UoZmlyc3QpOwogICAgICAgICAgICAgIGNhc2UgIkxpdGVyYWwiOgogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUudmFsdWU7CiAgICAgICAgICAgICAgY2FzZSBUT0tfUElQRToKICAgICAgICAgICAgICAgIGxlZnQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIGxlZnQpOwogICAgICAgICAgICAgIGNhc2UgVE9LX0NVUlJFTlQ6CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgY2FzZSAiRnVuY3Rpb24iOgogICAgICAgICAgICAgICAgdmFyIHJlc29sdmVkQXJncyA9IFtdOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlZEFyZ3MucHVzaCh0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5baV0sIHZhbHVlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5ydW50aW1lLmNhbGxGdW5jdGlvbihub2RlLm5hbWUsIHJlc29sdmVkQXJncyk7CiAgICAgICAgICAgICAgY2FzZSAiRXhwcmVzc2lvblJlZmVyZW5jZSI6CiAgICAgICAgICAgICAgICB2YXIgcmVmTm9kZSA9IG5vZGUuY2hpbGRyZW5bMF07CiAgICAgICAgICAgICAgICAvLyBUYWcgdGhlIG5vZGUgd2l0aCBhIHNwZWNpZmljIGF0dHJpYnV0ZSBzbyB0aGUgdHlwZQogICAgICAgICAgICAgICAgLy8gY2hlY2tlciB2ZXJpZnkgdGhlIHR5cGUuCiAgICAgICAgICAgICAgICByZWZOb2RlLmptZXNwYXRoVHlwZSA9IFRPS19FWFBSRUY7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVmTm9kZTsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIG5vZGUgdHlwZTogIiArIG5vZGUudHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIGNvbXB1dGVTbGljZVBhcmFtczogZnVuY3Rpb24oYXJyYXlMZW5ndGgsIHNsaWNlUGFyYW1zKSB7CiAgICAgICAgICB2YXIgc3RhcnQgPSBzbGljZVBhcmFtc1swXTsKICAgICAgICAgIHZhciBzdG9wID0gc2xpY2VQYXJhbXNbMV07CiAgICAgICAgICB2YXIgc3RlcCA9IHNsaWNlUGFyYW1zWzJdOwogICAgICAgICAgdmFyIGNvbXB1dGVkID0gW251bGwsIG51bGwsIG51bGxdOwogICAgICAgICAgaWYgKHN0ZXAgPT09IG51bGwpIHsKICAgICAgICAgICAgc3RlcCA9IDE7CiAgICAgICAgICB9IGVsc2UgaWYgKHN0ZXAgPT09IDApIHsKICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJJbnZhbGlkIHNsaWNlLCBzdGVwIGNhbm5vdCBiZSAwIik7CiAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiUnVudGltZUVycm9yIjsKICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RlcFZhbHVlTmVnYXRpdmUgPSBzdGVwIDwgMCA/IHRydWUgOiBmYWxzZTsKICAKICAgICAgICAgIGlmIChzdGFydCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHN0YXJ0ID0gc3RlcFZhbHVlTmVnYXRpdmUgPyBhcnJheUxlbmd0aCAtIDEgOiAwOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuY2FwU2xpY2VSYW5nZShhcnJheUxlbmd0aCwgc3RhcnQsIHN0ZXApOwogICAgICAgICAgfQogIAogICAgICAgICAgaWYgKHN0b3AgPT09IG51bGwpIHsKICAgICAgICAgICAgICBzdG9wID0gc3RlcFZhbHVlTmVnYXRpdmUgPyAtMSA6IGFycmF5TGVuZ3RoOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdG9wID0gdGhpcy5jYXBTbGljZVJhbmdlKGFycmF5TGVuZ3RoLCBzdG9wLCBzdGVwKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbXB1dGVkWzBdID0gc3RhcnQ7CiAgICAgICAgICBjb21wdXRlZFsxXSA9IHN0b3A7CiAgICAgICAgICBjb21wdXRlZFsyXSA9IHN0ZXA7CiAgICAgICAgICByZXR1cm4gY29tcHV0ZWQ7CiAgICAgICAgfSwKICAKICAgICAgICBjYXBTbGljZVJhbmdlOiBmdW5jdGlvbihhcnJheUxlbmd0aCwgYWN0dWFsVmFsdWUsIHN0ZXApIHsKICAgICAgICAgICAgaWYgKGFjdHVhbFZhbHVlIDwgMCkgewogICAgICAgICAgICAgICAgYWN0dWFsVmFsdWUgKz0gYXJyYXlMZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAoYWN0dWFsVmFsdWUgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgYWN0dWFsVmFsdWUgPSBzdGVwIDwgMCA/IC0xIDogMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChhY3R1YWxWYWx1ZSA+PSBhcnJheUxlbmd0aCkgewogICAgICAgICAgICAgICAgYWN0dWFsVmFsdWUgPSBzdGVwIDwgMCA/IGFycmF5TGVuZ3RoIC0gMSA6IGFycmF5TGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhY3R1YWxWYWx1ZTsKICAgICAgICB9CiAgCiAgICB9OwogIAogICAgZnVuY3Rpb24gUnVudGltZShpbnRlcnByZXRlcikgewogICAgICB0aGlzLl9pbnRlcnByZXRlciA9IGludGVycHJldGVyOwogICAgICB0aGlzLmZ1bmN0aW9uVGFibGUgPSB7CiAgICAgICAgICAvLyBuYW1lOiBbZnVuY3Rpb24sIDxzaWduYXR1cmU+XQogICAgICAgICAgLy8gVGhlIDxzaWduYXR1cmU+IGNhbiBiZToKICAgICAgICAgIC8vCiAgICAgICAgICAvLyB7CiAgICAgICAgICAvLyAgIGFyZ3M6IFtbdHlwZTEsIHR5cGUyXSwgW3R5cGUxLCB0eXBlMl1dLAogICAgICAgICAgLy8gICB2YXJpYWRpYzogdHJ1ZXxmYWxzZQogICAgICAgICAgLy8gfQogICAgICAgICAgLy8KICAgICAgICAgIC8vIEVhY2ggYXJnIGluIHRoZSBhcmcgbGlzdCBpcyBhIGxpc3Qgb2YgdmFsaWQgdHlwZXMKICAgICAgICAgIC8vIChpZiB0aGUgZnVuY3Rpb24gaXMgb3ZlcmxvYWRlZCBhbmQgc3VwcG9ydHMgbXVsdGlwbGUKICAgICAgICAgIC8vIHR5cGVzLiAgSWYgdGhlIHR5cGUgaXMgImFueSIgdGhlbiBubyB0eXBlIGNoZWNraW5nCiAgICAgICAgICAvLyBvY2N1cnMgb24gdGhlIGFyZ3VtZW50LiAgVmFyaWFkaWMgaXMgb3B0aW9uYWwKICAgICAgICAgIC8vIGFuZCBpZiBub3QgcHJvdmlkZWQgaXMgYXNzdW1lZCB0byBiZSBmYWxzZS4KICAgICAgICAgIGFiczoge19mdW5jOiB0aGlzLl9mdW5jdGlvbkFicywgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfTlVNQkVSXX1dfSwKICAgICAgICAgIGF2Zzoge19mdW5jOiB0aGlzLl9mdW5jdGlvbkF2ZywgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVlfTlVNQkVSXX1dfSwKICAgICAgICAgIGNlaWw6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25DZWlsLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9OVU1CRVJdfV19LAogICAgICAgICAgY29udGFpbnM6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25Db250YWlucywKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9TVFJJTkcsIFRZUEVfQVJSQVldfSwKICAgICAgICAgICAgICAgICAgICAgICAgICB7dHlwZXM6IFtUWVBFX0FOWV19XX0sCiAgICAgICAgICAiZW5kc193aXRoIjogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbkVuZHNXaXRoLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX1NUUklOR119LCB7dHlwZXM6IFtUWVBFX1NUUklOR119XX0sCiAgICAgICAgICBmbG9vcjoge19mdW5jOiB0aGlzLl9mdW5jdGlvbkZsb29yLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9OVU1CRVJdfV19LAogICAgICAgICAgbGVuZ3RoOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTGVuZ3RoLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX1NUUklORywgVFlQRV9BUlJBWSwgVFlQRV9PQkpFQ1RdfV19LAogICAgICAgICAgbWFwOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWFwLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0VYUFJFRl19LCB7dHlwZXM6IFtUWVBFX0FSUkFZXX1dfSwKICAgICAgICAgIG1heDogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1heCwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV9OVU1CRVIsIFRZUEVfQVJSQVlfU1RSSU5HXX1dfSwKICAgICAgICAgICJtZXJnZSI6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NZXJnZSwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9PQkpFQ1RdLCB2YXJpYWRpYzogdHJ1ZX1dCiAgICAgICAgICB9LAogICAgICAgICAgIm1heF9ieSI6IHsKICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWF4QnksCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZXX0sIHt0eXBlczogW1RZUEVfRVhQUkVGXX1dCiAgICAgICAgICB9LAogICAgICAgICAgc3VtOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uU3VtLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV9OVU1CRVJdfV19LAogICAgICAgICAgInN0YXJ0c193aXRoIjogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvblN0YXJ0c1dpdGgsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfU1RSSU5HXX0sIHt0eXBlczogW1RZUEVfU1RSSU5HXX1dfSwKICAgICAgICAgIG1pbjogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1pbiwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV9OVU1CRVIsIFRZUEVfQVJSQVlfU1RSSU5HXX1dfSwKICAgICAgICAgICJtaW5fYnkiOiB7CiAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1pbkJ5LAogICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV19LCB7dHlwZXM6IFtUWVBFX0VYUFJFRl19XQogICAgICAgICAgfSwKICAgICAgICAgIHR5cGU6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25UeXBlLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BTlldfV19LAogICAgICAgICAga2V5czoge19mdW5jOiB0aGlzLl9mdW5jdGlvbktleXMsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX09CSkVDVF19XX0sCiAgICAgICAgICB2YWx1ZXM6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25WYWx1ZXMsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX09CSkVDVF19XX0sCiAgICAgICAgICBzb3J0OiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uU29ydCwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVlfU1RSSU5HLCBUWVBFX0FSUkFZX05VTUJFUl19XX0sCiAgICAgICAgICAic29ydF9ieSI6IHsKICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uU29ydEJ5LAogICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV19LCB7dHlwZXM6IFtUWVBFX0VYUFJFRl19XQogICAgICAgICAgfSwKICAgICAgICAgIGpvaW46IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25Kb2luLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFsKICAgICAgICAgICAgICAgICAge3R5cGVzOiBbVFlQRV9TVFJJTkddfSwKICAgICAgICAgICAgICAgICAge3R5cGVzOiBbVFlQRV9BUlJBWV9TVFJJTkddfQogICAgICAgICAgICAgIF0KICAgICAgICAgIH0sCiAgICAgICAgICByZXZlcnNlOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uUmV2ZXJzZSwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9TVFJJTkcsIFRZUEVfQVJSQVldfV19LAogICAgICAgICAgInRvX2FycmF5Ijoge19mdW5jOiB0aGlzLl9mdW5jdGlvblRvQXJyYXksIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FOWV19XX0sCiAgICAgICAgICAidG9fc3RyaW5nIjoge19mdW5jOiB0aGlzLl9mdW5jdGlvblRvU3RyaW5nLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BTlldfV19LAogICAgICAgICAgInRvX251bWJlciI6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25Ub051bWJlciwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQU5ZXX1dfSwKICAgICAgICAgICJub3RfbnVsbCI6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25Ob3ROdWxsLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FOWV0sIHZhcmlhZGljOiB0cnVlfV0KICAgICAgICAgIH0KICAgICAgfTsKICAgIH0KICAKICAgIFJ1bnRpbWUucHJvdG90eXBlID0gewogICAgICBjYWxsRnVuY3Rpb246IGZ1bmN0aW9uKG5hbWUsIHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBmdW5jdGlvbkVudHJ5ID0gdGhpcy5mdW5jdGlvblRhYmxlW25hbWVdOwogICAgICAgIGlmIChmdW5jdGlvbkVudHJ5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIGZ1bmN0aW9uOiAiICsgbmFtZSArICIoKSIpOwogICAgICAgIH0KICAgICAgICB0aGlzLl92YWxpZGF0ZUFyZ3MobmFtZSwgcmVzb2x2ZWRBcmdzLCBmdW5jdGlvbkVudHJ5Ll9zaWduYXR1cmUpOwogICAgICAgIHJldHVybiBmdW5jdGlvbkVudHJ5Ll9mdW5jLmNhbGwodGhpcywgcmVzb2x2ZWRBcmdzKTsKICAgICAgfSwKICAKICAgICAgX3ZhbGlkYXRlQXJnczogZnVuY3Rpb24obmFtZSwgYXJncywgc2lnbmF0dXJlKSB7CiAgICAgICAgICAvLyBWYWxpZGF0aW5nIHRoZSBhcmdzIHJlcXVpcmVzIHZhbGlkYXRpbmcKICAgICAgICAgIC8vIHRoZSBjb3JyZWN0IGFyaXR5IGFuZCB0aGUgY29ycmVjdCB0eXBlIG9mIGVhY2ggYXJnLgogICAgICAgICAgLy8gSWYgdGhlIGxhc3QgYXJndW1lbnQgaXMgZGVjbGFyZWQgYXMgdmFyaWFkaWMsIHRoZW4gd2UgbmVlZAogICAgICAgICAgLy8gYSBtaW5pbXVtIG51bWJlciBvZiBhcmdzIHRvIGJlIHJlcXVpcmVkLiAgT3RoZXJ3aXNlIGl0IGhhcyB0bwogICAgICAgICAgLy8gYmUgYW4gZXhhY3QgYW1vdW50LgogICAgICAgICAgdmFyIHBsdXJhbGl6ZWQ7CiAgICAgICAgICBpZiAoc2lnbmF0dXJlW3NpZ25hdHVyZS5sZW5ndGggLSAxXS52YXJpYWRpYykgewogICAgICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCA8IHNpZ25hdHVyZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgcGx1cmFsaXplZCA9IHNpZ25hdHVyZS5sZW5ndGggPT09IDEgPyAiIGFyZ3VtZW50IiA6ICIgYXJndW1lbnRzIjsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBcmd1bWVudEVycm9yOiAiICsgbmFtZSArICIoKSAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0YWtlcyBhdCBsZWFzdCIgKyBzaWduYXR1cmUubGVuZ3RoICsgcGx1cmFsaXplZCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIGJ1dCByZWNlaXZlZCAiICsgYXJncy5sZW5ndGgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoYXJncy5sZW5ndGggIT09IHNpZ25hdHVyZS5sZW5ndGgpIHsKICAgICAgICAgICAgICBwbHVyYWxpemVkID0gc2lnbmF0dXJlLmxlbmd0aCA9PT0gMSA/ICIgYXJndW1lbnQiIDogIiBhcmd1bWVudHMiOwogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQXJndW1lbnRFcnJvcjogIiArIG5hbWUgKyAiKCkgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0YWtlcyAiICsgc2lnbmF0dXJlLmxlbmd0aCArIHBsdXJhbGl6ZWQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIGJ1dCByZWNlaXZlZCAiICsgYXJncy5sZW5ndGgpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRTcGVjOwogICAgICAgICAgdmFyIGFjdHVhbFR5cGU7CiAgICAgICAgICB2YXIgdHlwZU1hdGNoZWQ7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNpZ25hdHVyZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHR5cGVNYXRjaGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgY3VycmVudFNwZWMgPSBzaWduYXR1cmVbaV0udHlwZXM7CiAgICAgICAgICAgICAgYWN0dWFsVHlwZSA9IHRoaXMuX2dldFR5cGVOYW1lKGFyZ3NbaV0pOwogICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgY3VycmVudFNwZWMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX3R5cGVNYXRjaGVzKGFjdHVhbFR5cGUsIGN1cnJlbnRTcGVjW2pdLCBhcmdzW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgdHlwZU1hdGNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCF0eXBlTWF0Y2hlZCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlR5cGVFcnJvcjogIiArIG5hbWUgKyAiKCkgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZXhwZWN0ZWQgYXJndW1lbnQgIiArIChpICsgMSkgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiB0byBiZSB0eXBlICIgKyBjdXJyZW50U3BlYyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIGJ1dCByZWNlaXZlZCB0eXBlICIgKyBhY3R1YWxUeXBlICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF90eXBlTWF0Y2hlczogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgYXJnVmFsdWUpIHsKICAgICAgICAgIGlmIChleHBlY3RlZCA9PT0gVFlQRV9BTlkpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChleHBlY3RlZCA9PT0gVFlQRV9BUlJBWV9TVFJJTkcgfHwKICAgICAgICAgICAgICBleHBlY3RlZCA9PT0gVFlQRV9BUlJBWV9OVU1CRVIgfHwKICAgICAgICAgICAgICBleHBlY3RlZCA9PT0gVFlQRV9BUlJBWSkgewogICAgICAgICAgICAgIC8vIFRoZSBleHBlY3RlZCB0eXBlIGNhbiBlaXRoZXIganVzdCBiZSBhcnJheSwKICAgICAgICAgICAgICAvLyBvciBpdCBjYW4gcmVxdWlyZSBhIHNwZWNpZmljIHN1YnR5cGUgKGFycmF5IG9mIG51bWJlcnMpLgogICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgLy8gVGhlIHNpbXBsZXN0IGNhc2UgaXMgaWYgImFycmF5IiB3aXRoIG5vIHN1YnR5cGUgaXMgc3BlY2lmaWVkLgogICAgICAgICAgICAgIGlmIChleHBlY3RlZCA9PT0gVFlQRV9BUlJBWSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gYWN0dWFsID09PSBUWVBFX0FSUkFZOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0dWFsID09PSBUWVBFX0FSUkFZKSB7CiAgICAgICAgICAgICAgICAgIC8vIE90aGVyd2lzZSB3ZSBuZWVkIHRvIGNoZWNrIHN1YnR5cGVzLgogICAgICAgICAgICAgICAgICAvLyBJIHRoaW5rIHRoaXMgaGFzIHBvdGVudGlhbCB0byBiZSBpbXByb3ZlZC4KICAgICAgICAgICAgICAgICAgdmFyIHN1YnR5cGU7CiAgICAgICAgICAgICAgICAgIGlmIChleHBlY3RlZCA9PT0gVFlQRV9BUlJBWV9OVU1CRVIpIHsKICAgICAgICAgICAgICAgICAgICBzdWJ0eXBlID0gVFlQRV9OVU1CRVI7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZXhwZWN0ZWQgPT09IFRZUEVfQVJSQVlfU1RSSU5HKSB7CiAgICAgICAgICAgICAgICAgICAgc3VidHlwZSA9IFRZUEVfU1RSSU5HOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJnVmFsdWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5fdHlwZU1hdGNoZXMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2dldFR5cGVOYW1lKGFyZ1ZhbHVlW2ldKSwgc3VidHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdWYWx1ZVtpXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gYWN0dWFsID09PSBleHBlY3RlZDsKICAgICAgICAgIH0KICAgICAgfSwKICAgICAgX2dldFR5cGVOYW1lOiBmdW5jdGlvbihvYmopIHsKICAgICAgICAgIHN3aXRjaCAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikpIHsKICAgICAgICAgICAgICBjYXNlICJbb2JqZWN0IFN0cmluZ10iOgogICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfU1RSSU5HOwogICAgICAgICAgICAgIGNhc2UgIltvYmplY3QgTnVtYmVyXSI6CiAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9OVU1CRVI7CiAgICAgICAgICAgICAgY2FzZSAiW29iamVjdCBBcnJheV0iOgogICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfQVJSQVk7CiAgICAgICAgICAgICAgY2FzZSAiW29iamVjdCBCb29sZWFuXSI6CiAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9CT09MRUFOOwogICAgICAgICAgICAgIGNhc2UgIltvYmplY3QgTnVsbF0iOgogICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfTlVMTDsKICAgICAgICAgICAgICBjYXNlICJbb2JqZWN0IE9iamVjdF0iOgogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgaXQncyBhbiBleHByZWYuICBJZiBpdCBoYXMsIGl0J3MgYmVlbgogICAgICAgICAgICAgICAgLy8gdGFnZ2VkIHdpdGggYSBqbWVzcGF0aFR5cGUgYXR0ciBvZiAnRXhwcmVmJzsKICAgICAgICAgICAgICAgIGlmIChvYmouam1lc3BhdGhUeXBlID09PSBUT0tfRVhQUkVGKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX0VYUFJFRjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX09CSkVDVDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uU3RhcnRzV2l0aDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdLmxhc3RJbmRleE9mKHJlc29sdmVkQXJnc1sxXSkgPT09IDA7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkVuZHNXaXRoOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciBzZWFyY2hTdHIgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICB2YXIgc3VmZml4ID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgICAgcmV0dXJuIHNlYXJjaFN0ci5pbmRleE9mKHN1ZmZpeCwgc2VhcmNoU3RyLmxlbmd0aCAtIHN1ZmZpeC5sZW5ndGgpICE9PSAtMTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uUmV2ZXJzZTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICB2YXIgdHlwZU5hbWUgPSB0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF0pOwogICAgICAgICAgaWYgKHR5cGVOYW1lID09PSBUWVBFX1NUUklORykgewogICAgICAgICAgICB2YXIgb3JpZ2luYWxTdHIgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICAgIHZhciByZXZlcnNlZFN0ciA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBpID0gb3JpZ2luYWxTdHIubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIHJldmVyc2VkU3RyICs9IG9yaWdpbmFsU3RyW2ldOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXZlcnNlZFN0cjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciByZXZlcnNlZEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdLnNsaWNlKDApOwogICAgICAgICAgICByZXZlcnNlZEFycmF5LnJldmVyc2UoKTsKICAgICAgICAgICAgcmV0dXJuIHJldmVyc2VkQXJyYXk7CiAgICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkFiczogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgcmV0dXJuIE1hdGguYWJzKHJlc29sdmVkQXJnc1swXSk7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkNlaWw6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgcmV0dXJuIE1hdGguY2VpbChyZXNvbHZlZEFyZ3NbMF0pOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Bdmc6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIHN1bSA9IDA7CiAgICAgICAgICB2YXIgaW5wdXRBcnJheSA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5wdXRBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHN1bSArPSBpbnB1dEFycmF5W2ldOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN1bSAvIGlucHV0QXJyYXkubGVuZ3RoOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Db250YWluczogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdLmluZGV4T2YocmVzb2x2ZWRBcmdzWzFdKSA+PSAwOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25GbG9vcjogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICByZXR1cm4gTWF0aC5mbG9vcihyZXNvbHZlZEFyZ3NbMF0pOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25MZW5ndGg6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICBpZiAoIWlzT2JqZWN0KHJlc29sdmVkQXJnc1swXSkpIHsKICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdLmxlbmd0aDsKICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAvLyBBcyBmYXIgYXMgSSBjYW4gdGVsbCwgdGhlcmUncyBubyB3YXkgdG8gZ2V0IHRoZSBsZW5ndGgKICAgICAgICAgICAvLyBvZiBhbiBvYmplY3Qgd2l0aG91dCBPKG4pIGl0ZXJhdGlvbiB0aHJvdWdoIHRoZSBvYmplY3QuCiAgICAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHJlc29sdmVkQXJnc1swXSkubGVuZ3RoOwogICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbk1hcDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIG1hcHBlZCA9IFtdOwogICAgICAgIHZhciBpbnRlcnByZXRlciA9IHRoaXMuX2ludGVycHJldGVyOwogICAgICAgIHZhciBleHByZWZOb2RlID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgIHZhciBlbGVtZW50cyA9IHJlc29sdmVkQXJnc1sxXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIG1hcHBlZC5wdXNoKGludGVycHJldGVyLnZpc2l0KGV4cHJlZk5vZGUsIGVsZW1lbnRzW2ldKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBtYXBwZWQ7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbk1lcmdlOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgbWVyZ2VkID0ge307CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvbHZlZEFyZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBjdXJyZW50ID0gcmVzb2x2ZWRBcmdzW2ldOwogICAgICAgICAgZm9yICh2YXIga2V5IGluIGN1cnJlbnQpIHsKICAgICAgICAgICAgbWVyZ2VkW2tleV0gPSBjdXJyZW50W2tleV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBtZXJnZWQ7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbk1heDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgaWYgKHJlc29sdmVkQXJnc1swXS5sZW5ndGggPiAwKSB7CiAgICAgICAgICB2YXIgdHlwZU5hbWUgPSB0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF1bMF0pOwogICAgICAgICAgaWYgKHR5cGVOYW1lID09PSBUWVBFX05VTUJFUikgewogICAgICAgICAgICByZXR1cm4gTWF0aC5tYXguYXBwbHkoTWF0aCwgcmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50cyA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgICAgdmFyIG1heEVsZW1lbnQgPSBlbGVtZW50c1swXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKG1heEVsZW1lbnQubG9jYWxlQ29tcGFyZShlbGVtZW50c1tpXSkgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgbWF4RWxlbWVudCA9IGVsZW1lbnRzW2ldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXhFbGVtZW50OwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTWluOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICBpZiAocmVzb2x2ZWRBcmdzWzBdLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHZhciB0eXBlTmFtZSA9IHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXVswXSk7CiAgICAgICAgICBpZiAodHlwZU5hbWUgPT09IFRZUEVfTlVNQkVSKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLm1pbi5hcHBseShNYXRoLCByZXNvbHZlZEFyZ3NbMF0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnRzID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgICB2YXIgbWluRWxlbWVudCA9IGVsZW1lbnRzWzBdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudHNbaV0ubG9jYWxlQ29tcGFyZShtaW5FbGVtZW50KSA8IDApIHsKICAgICAgICAgICAgICAgICAgICBtaW5FbGVtZW50ID0gZWxlbWVudHNbaV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1pbkVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uU3VtOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgc3VtID0gMDsKICAgICAgICB2YXIgbGlzdFRvU3VtID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdFRvU3VtLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBzdW0gKz0gbGlzdFRvU3VtW2ldOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3VtOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25UeXBlOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHN3aXRjaCAodGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdKSkgewogICAgICAgICAgICBjYXNlIFRZUEVfTlVNQkVSOgogICAgICAgICAgICAgIHJldHVybiAibnVtYmVyIjsKICAgICAgICAgICAgY2FzZSBUWVBFX1NUUklORzoKICAgICAgICAgICAgICByZXR1cm4gInN0cmluZyI7CiAgICAgICAgICAgIGNhc2UgVFlQRV9BUlJBWToKICAgICAgICAgICAgICByZXR1cm4gImFycmF5IjsKICAgICAgICAgICAgY2FzZSBUWVBFX09CSkVDVDoKICAgICAgICAgICAgICByZXR1cm4gIm9iamVjdCI7CiAgICAgICAgICAgIGNhc2UgVFlQRV9CT09MRUFOOgogICAgICAgICAgICAgIHJldHVybiAiYm9vbGVhbiI7CiAgICAgICAgICAgIGNhc2UgVFlQRV9FWFBSRUY6CiAgICAgICAgICAgICAgcmV0dXJuICJleHByZWYiOwogICAgICAgICAgICBjYXNlIFRZUEVfTlVMTDoKICAgICAgICAgICAgICByZXR1cm4gIm51bGwiOwogICAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25LZXlzOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhyZXNvbHZlZEFyZ3NbMF0pOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25WYWx1ZXM6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIG9iaiA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqKTsKICAgICAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhbHVlcy5wdXNoKG9ialtrZXlzW2ldXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsdWVzOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Kb2luOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciBqb2luQ2hhciA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIHZhciBsaXN0Sm9pbiA9IHJlc29sdmVkQXJnc1sxXTsKICAgICAgICAgIHJldHVybiBsaXN0Sm9pbi5qb2luKGpvaW5DaGFyKTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uVG9BcnJheTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICBpZiAodGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdKSA9PT0gVFlQRV9BUlJBWSkgewogICAgICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBbcmVzb2x2ZWRBcmdzWzBdXTsKICAgICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uVG9TdHJpbmc6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgaWYgKHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXSkgPT09IFRZUEVfU1RSSU5HKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHJlc29sdmVkQXJnc1swXSk7CiAgICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblRvTnVtYmVyOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciB0eXBlTmFtZSA9IHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXSk7CiAgICAgICAgICB2YXIgY29udmVydGVkVmFsdWU7CiAgICAgICAgICBpZiAodHlwZU5hbWUgPT09IFRZUEVfTlVNQkVSKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZU5hbWUgPT09IFRZUEVfU1RSSU5HKSB7CiAgICAgICAgICAgICAgY29udmVydGVkVmFsdWUgPSArcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgICAgIGlmICghaXNOYU4oY29udmVydGVkVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjb252ZXJ0ZWRWYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTm90TnVsbDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc29sdmVkQXJncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGlmICh0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbaV0pICE9PSBUWVBFX05VTEwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1tpXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uU29ydDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICB2YXIgc29ydGVkQXJyYXkgPSByZXNvbHZlZEFyZ3NbMF0uc2xpY2UoMCk7CiAgICAgICAgICBzb3J0ZWRBcnJheS5zb3J0KCk7CiAgICAgICAgICByZXR1cm4gc29ydGVkQXJyYXk7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblNvcnRCeTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICB2YXIgc29ydGVkQXJyYXkgPSByZXNvbHZlZEFyZ3NbMF0uc2xpY2UoMCk7CiAgICAgICAgICBpZiAoc29ydGVkQXJyYXkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHNvcnRlZEFycmF5OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGludGVycHJldGVyID0gdGhpcy5faW50ZXJwcmV0ZXI7CiAgICAgICAgICB2YXIgZXhwcmVmTm9kZSA9IHJlc29sdmVkQXJnc1sxXTsKICAgICAgICAgIHZhciByZXF1aXJlZFR5cGUgPSB0aGlzLl9nZXRUeXBlTmFtZSgKICAgICAgICAgICAgICBpbnRlcnByZXRlci52aXNpdChleHByZWZOb2RlLCBzb3J0ZWRBcnJheVswXSkpOwogICAgICAgICAgaWYgKFtUWVBFX05VTUJFUiwgVFlQRV9TVFJJTkddLmluZGV4T2YocmVxdWlyZWRUeXBlKSA8IDApIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlR5cGVFcnJvciIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgLy8gSW4gb3JkZXIgdG8gZ2V0IGEgc3RhYmxlIHNvcnQgb3V0IG9mIGFuIHVuc3RhYmxlCiAgICAgICAgICAvLyBzb3J0IGFsZ29yaXRobSwgd2UgZGVjb3JhdGUvc29ydC91bmRlY29yYXRlIChEU1UpCiAgICAgICAgICAvLyBieSBjcmVhdGluZyBhIG5ldyBsaXN0IG9mIFtpbmRleCwgZWxlbWVudF0gcGFpcnMuCiAgICAgICAgICAvLyBJbiB0aGUgY21wIGZ1bmN0aW9uLCBpZiB0aGUgZXZhbHVhdGVkIGVsZW1lbnRzIGFyZQogICAgICAgICAgLy8gZXF1YWwsIHRoZW4gdGhlIGluZGV4IHdpbGwgYmUgdXNlZCBhcyB0aGUgdGllYnJlYWtlci4KICAgICAgICAgIC8vIEFmdGVyIHRoZSBkZWNvcmF0ZWQgbGlzdCBoYXMgYmVlbiBzb3J0ZWQsIGl0IHdpbGwgYmUKICAgICAgICAgIC8vIHVuZGVjb3JhdGVkIHRvIGV4dHJhY3QgdGhlIG9yaWdpbmFsIGVsZW1lbnRzLgogICAgICAgICAgdmFyIGRlY29yYXRlZCA9IFtdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3J0ZWRBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBkZWNvcmF0ZWQucHVzaChbaSwgc29ydGVkQXJyYXlbaV1dKTsKICAgICAgICAgIH0KICAgICAgICAgIGRlY29yYXRlZC5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgICAgdmFyIGV4cHJBID0gaW50ZXJwcmV0ZXIudmlzaXQoZXhwcmVmTm9kZSwgYVsxXSk7CiAgICAgICAgICAgIHZhciBleHByQiA9IGludGVycHJldGVyLnZpc2l0KGV4cHJlZk5vZGUsIGJbMV0pOwogICAgICAgICAgICBpZiAodGhhdC5fZ2V0VHlwZU5hbWUoZXhwckEpICE9PSByZXF1aXJlZFR5cGUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAgICAgICAiVHlwZUVycm9yOiBleHBlY3RlZCAiICsgcmVxdWlyZWRUeXBlICsgIiwgcmVjZWl2ZWQgIiArCiAgICAgICAgICAgICAgICAgICAgdGhhdC5fZ2V0VHlwZU5hbWUoZXhwckEpKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGF0Ll9nZXRUeXBlTmFtZShleHByQikgIT09IHJlcXVpcmVkVHlwZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAgICAgICAgICJUeXBlRXJyb3I6IGV4cGVjdGVkICIgKyByZXF1aXJlZFR5cGUgKyAiLCByZWNlaXZlZCAiICsKICAgICAgICAgICAgICAgICAgICB0aGF0Ll9nZXRUeXBlTmFtZShleHByQikpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChleHByQSA+IGV4cHJCKSB7CiAgICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXhwckEgPCBleHByQikgewogICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyBJZiB0aGV5J3JlIGVxdWFsIGNvbXBhcmUgdGhlIGl0ZW1zIGJ5IHRoZWlyCiAgICAgICAgICAgICAgLy8gb3JkZXIgdG8gbWFpbnRhaW4gcmVsYXRpdmUgb3JkZXIgb2YgZXF1YWwga2V5cwogICAgICAgICAgICAgIC8vIChpLmUuIHRvIGdldCBhIHN0YWJsZSBzb3J0KS4KICAgICAgICAgICAgICByZXR1cm4gYVswXSAtIGJbMF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgLy8gVW5kZWNvcmF0ZTogZXh0cmFjdCBvdXQgdGhlIG9yaWdpbmFsIGxpc3QgZWxlbWVudHMuCiAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGRlY29yYXRlZC5sZW5ndGg7IGorKykgewogICAgICAgICAgICBzb3J0ZWRBcnJheVtqXSA9IGRlY29yYXRlZFtqXVsxXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzb3J0ZWRBcnJheTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTWF4Qnk6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBleHByZWZOb2RlID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgIHZhciByZXNvbHZlZEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgIHZhciBrZXlGdW5jdGlvbiA9IHRoaXMuY3JlYXRlS2V5RnVuY3Rpb24oZXhwcmVmTm9kZSwgW1RZUEVfTlVNQkVSLCBUWVBFX1NUUklOR10pOwogICAgICAgIHZhciBtYXhOdW1iZXIgPSAtSW5maW5pdHk7CiAgICAgICAgdmFyIG1heFJlY29yZDsKICAgICAgICB2YXIgY3VycmVudDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc29sdmVkQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGN1cnJlbnQgPSBrZXlGdW5jdGlvbihyZXNvbHZlZEFycmF5W2ldKTsKICAgICAgICAgIGlmIChjdXJyZW50ID4gbWF4TnVtYmVyKSB7CiAgICAgICAgICAgIG1heE51bWJlciA9IGN1cnJlbnQ7CiAgICAgICAgICAgIG1heFJlY29yZCA9IHJlc29sdmVkQXJyYXlbaV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBtYXhSZWNvcmQ7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbk1pbkJ5OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgZXhwcmVmTm9kZSA9IHJlc29sdmVkQXJnc1sxXTsKICAgICAgICB2YXIgcmVzb2x2ZWRBcnJheSA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICB2YXIga2V5RnVuY3Rpb24gPSB0aGlzLmNyZWF0ZUtleUZ1bmN0aW9uKGV4cHJlZk5vZGUsIFtUWVBFX05VTUJFUiwgVFlQRV9TVFJJTkddKTsKICAgICAgICB2YXIgbWluTnVtYmVyID0gSW5maW5pdHk7CiAgICAgICAgdmFyIG1pblJlY29yZDsKICAgICAgICB2YXIgY3VycmVudDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc29sdmVkQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGN1cnJlbnQgPSBrZXlGdW5jdGlvbihyZXNvbHZlZEFycmF5W2ldKTsKICAgICAgICAgIGlmIChjdXJyZW50IDwgbWluTnVtYmVyKSB7CiAgICAgICAgICAgIG1pbk51bWJlciA9IGN1cnJlbnQ7CiAgICAgICAgICAgIG1pblJlY29yZCA9IHJlc29sdmVkQXJyYXlbaV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBtaW5SZWNvcmQ7CiAgICAgIH0sCiAgCiAgICAgIGNyZWF0ZUtleUZ1bmN0aW9uOiBmdW5jdGlvbihleHByZWZOb2RlLCBhbGxvd2VkVHlwZXMpIHsKICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgdmFyIGludGVycHJldGVyID0gdGhpcy5faW50ZXJwcmV0ZXI7CiAgICAgICAgdmFyIGtleUZ1bmMgPSBmdW5jdGlvbih4KSB7CiAgICAgICAgICB2YXIgY3VycmVudCA9IGludGVycHJldGVyLnZpc2l0KGV4cHJlZk5vZGUsIHgpOwogICAgICAgICAgaWYgKGFsbG93ZWRUeXBlcy5pbmRleE9mKHRoYXQuX2dldFR5cGVOYW1lKGN1cnJlbnQpKSA8IDApIHsKICAgICAgICAgICAgdmFyIG1zZyA9ICJUeXBlRXJyb3I6IGV4cGVjdGVkIG9uZSBvZiAiICsgYWxsb3dlZFR5cGVzICsKICAgICAgICAgICAgICAgICAgICAgICIsIHJlY2VpdmVkICIgKyB0aGF0Ll9nZXRUeXBlTmFtZShjdXJyZW50KTsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY3VycmVudDsKICAgICAgICB9OwogICAgICAgIHJldHVybiBrZXlGdW5jOwogICAgICB9CiAgCiAgICB9OwogIAogICAgZnVuY3Rpb24gY29tcGlsZShzdHJlYW0pIHsKICAgICAgdmFyIHBhcnNlciA9IG5ldyBQYXJzZXIoKTsKICAgICAgdmFyIGFzdCA9IHBhcnNlci5wYXJzZShzdHJlYW0pOwogICAgICByZXR1cm4gYXN0OwogICAgfQogIAogICAgZnVuY3Rpb24gdG9rZW5pemUoc3RyZWFtKSB7CiAgICAgICAgdmFyIGxleGVyID0gbmV3IExleGVyKCk7CiAgICAgICAgcmV0dXJuIGxleGVyLnRva2VuaXplKHN0cmVhbSk7CiAgICB9CiAgCiAgICBmdW5jdGlvbiBzZWFyY2goZGF0YSwgZXhwcmVzc2lvbikgewogICAgICAgIHZhciBwYXJzZXIgPSBuZXcgUGFyc2VyKCk7CiAgICAgICAgLy8gVGhpcyBuZWVkcyB0byBiZSBpbXByb3ZlZC4gIEJvdGggdGhlIGludGVycHJldGVyIGFuZCBydW50aW1lIGRlcGVuZCBvbgogICAgICAgIC8vIGVhY2ggb3RoZXIuICBUaGUgcnVudGltZSBuZWVkcyB0aGUgaW50ZXJwcmV0ZXIgdG8gc3VwcG9ydCBleHByZWZzLgogICAgICAgIC8vIFRoZXJlJ3MgbGlrZWx5IGEgY2xlYW4gd2F5IHRvIGF2b2lkIHRoZSBjeWNsaWMgZGVwZW5kZW5jeS4KICAgICAgICB2YXIgcnVudGltZSA9IG5ldyBSdW50aW1lKCk7CiAgICAgICAgdmFyIGludGVycHJldGVyID0gbmV3IFRyZWVJbnRlcnByZXRlcihydW50aW1lKTsKICAgICAgICBydW50aW1lLl9pbnRlcnByZXRlciA9IGludGVycHJldGVyOwogICAgICAgIHZhciBub2RlID0gcGFyc2VyLnBhcnNlKGV4cHJlc3Npb24pOwogICAgICAgIHJldHVybiBpbnRlcnByZXRlci5zZWFyY2gobm9kZSwgZGF0YSk7CiAgICB9CiAgCiAgICBleHBvcnRzLnRva2VuaXplID0gdG9rZW5pemU7CiAgICBleHBvcnRzLmNvbXBpbGUgPSBjb21waWxlOwogICAgZXhwb3J0cy5zZWFyY2ggPSBzZWFyY2g7CiAgICBleHBvcnRzLnN0cmljdERlZXBFcXVhbCA9IHN0cmljdERlZXBFcXVhbDsKICB9KSh0eXBlb2YgZXhwb3J0cyA9PT0gInVuZGVmaW5lZCIgPyB0aGlzLmptZXNwYXRoID0ge30gOiBleHBvcnRzKTsKICAKICB9LHt9XSw4NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gc2hpbSBmb3IgdXNpbmcgcHJvY2VzcyBpbiBicm93c2VyCiAgdmFyIHByb2Nlc3MgPSBtb2R1bGUuZXhwb3J0cyA9IHt9OwogIAogIC8vIGNhY2hlZCBmcm9tIHdoYXRldmVyIGdsb2JhbCBpcyBwcmVzZW50IHNvIHRoYXQgdGVzdCBydW5uZXJzIHRoYXQgc3R1YiBpdAogIC8vIGRvbid0IGJyZWFrIHRoaW5ncy4gIEJ1dCB3ZSBuZWVkIHRvIHdyYXAgaXQgaW4gYSB0cnkgY2F0Y2ggaW4gY2FzZSBpdCBpcwogIC8vIHdyYXBwZWQgaW4gc3RyaWN0IG1vZGUgY29kZSB3aGljaCBkb2Vzbid0IGRlZmluZSBhbnkgZ2xvYmFscy4gIEl0J3MgaW5zaWRlIGEKICAvLyBmdW5jdGlvbiBiZWNhdXNlIHRyeS9jYXRjaGVzIGRlb3B0aW1pemUgaW4gY2VydGFpbiBlbmdpbmVzLgogIAogIHZhciBjYWNoZWRTZXRUaW1lb3V0OwogIHZhciBjYWNoZWRDbGVhclRpbWVvdXQ7CiAgCiAgZnVuY3Rpb24gZGVmYXVsdFNldFRpbW91dCgpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdzZXRUaW1lb3V0IGhhcyBub3QgYmVlbiBkZWZpbmVkJyk7CiAgfQogIGZ1bmN0aW9uIGRlZmF1bHRDbGVhclRpbWVvdXQgKCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NsZWFyVGltZW91dCBoYXMgbm90IGJlZW4gZGVmaW5lZCcpOwogIH0KICAoZnVuY3Rpb24gKCkgewogICAgICB0cnkgewogICAgICAgICAgaWYgKHR5cGVvZiBzZXRUaW1lb3V0ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgY2FjaGVkU2V0VGltZW91dCA9IHNldFRpbWVvdXQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNhY2hlZFNldFRpbWVvdXQgPSBkZWZhdWx0U2V0VGltb3V0OwogICAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjYWNoZWRTZXRUaW1lb3V0ID0gZGVmYXVsdFNldFRpbW91dDsKICAgICAgfQogICAgICB0cnkgewogICAgICAgICAgaWYgKHR5cGVvZiBjbGVhclRpbWVvdXQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICBjYWNoZWRDbGVhclRpbWVvdXQgPSBjbGVhclRpbWVvdXQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNhY2hlZENsZWFyVGltZW91dCA9IGRlZmF1bHRDbGVhclRpbWVvdXQ7CiAgICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNhY2hlZENsZWFyVGltZW91dCA9IGRlZmF1bHRDbGVhclRpbWVvdXQ7CiAgICAgIH0KICB9ICgpKQogIGZ1bmN0aW9uIHJ1blRpbWVvdXQoZnVuKSB7CiAgICAgIGlmIChjYWNoZWRTZXRUaW1lb3V0ID09PSBzZXRUaW1lb3V0KSB7CiAgICAgICAgICAvL25vcm1hbCBlbnZpcm9tZW50cyBpbiBzYW5lIHNpdHVhdGlvbnMKICAgICAgICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1biwgMCk7CiAgICAgIH0KICAgICAgLy8gaWYgc2V0VGltZW91dCB3YXNuJ3QgYXZhaWxhYmxlIGJ1dCB3YXMgbGF0dGVyIGRlZmluZWQKICAgICAgaWYgKChjYWNoZWRTZXRUaW1lb3V0ID09PSBkZWZhdWx0U2V0VGltb3V0IHx8ICFjYWNoZWRTZXRUaW1lb3V0KSAmJiBzZXRUaW1lb3V0KSB7CiAgICAgICAgICBjYWNoZWRTZXRUaW1lb3V0ID0gc2V0VGltZW91dDsKICAgICAgICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1biwgMCk7CiAgICAgIH0KICAgICAgdHJ5IHsKICAgICAgICAgIC8vIHdoZW4gd2hlbiBzb21lYm9keSBoYXMgc2NyZXdlZCB3aXRoIHNldFRpbWVvdXQgYnV0IG5vIEkuRS4gbWFkZG5lc3MKICAgICAgICAgIHJldHVybiBjYWNoZWRTZXRUaW1lb3V0KGZ1biwgMCk7CiAgICAgIH0gY2F0Y2goZSl7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIC8vIFdoZW4gd2UgYXJlIGluIEkuRS4gYnV0IHRoZSBzY3JpcHQgaGFzIGJlZW4gZXZhbGVkIHNvIEkuRS4gZG9lc24ndCB0cnVzdCB0aGUgZ2xvYmFsIG9iamVjdCB3aGVuIGNhbGxlZCBub3JtYWxseQogICAgICAgICAgICAgIHJldHVybiBjYWNoZWRTZXRUaW1lb3V0LmNhbGwobnVsbCwgZnVuLCAwKTsKICAgICAgICAgIH0gY2F0Y2goZSl7CiAgICAgICAgICAgICAgLy8gc2FtZSBhcyBhYm92ZSBidXQgd2hlbiBpdCdzIGEgdmVyc2lvbiBvZiBJLkUuIHRoYXQgbXVzdCBoYXZlIHRoZSBnbG9iYWwgb2JqZWN0IGZvciAndGhpcycsIGhvcGZ1bGx5IG91ciBjb250ZXh0IGNvcnJlY3Qgb3RoZXJ3aXNlIGl0IHdpbGwgdGhyb3cgYSBnbG9iYWwgZXJyb3IKICAgICAgICAgICAgICByZXR1cm4gY2FjaGVkU2V0VGltZW91dC5jYWxsKHRoaXMsIGZ1biwgMCk7CiAgICAgICAgICB9CiAgICAgIH0KICAKICAKICB9CiAgZnVuY3Rpb24gcnVuQ2xlYXJUaW1lb3V0KG1hcmtlcikgewogICAgICBpZiAoY2FjaGVkQ2xlYXJUaW1lb3V0ID09PSBjbGVhclRpbWVvdXQpIHsKICAgICAgICAgIC8vbm9ybWFsIGVudmlyb21lbnRzIGluIHNhbmUgc2l0dWF0aW9ucwogICAgICAgICAgcmV0dXJuIGNsZWFyVGltZW91dChtYXJrZXIpOwogICAgICB9CiAgICAgIC8vIGlmIGNsZWFyVGltZW91dCB3YXNuJ3QgYXZhaWxhYmxlIGJ1dCB3YXMgbGF0dGVyIGRlZmluZWQKICAgICAgaWYgKChjYWNoZWRDbGVhclRpbWVvdXQgPT09IGRlZmF1bHRDbGVhclRpbWVvdXQgfHwgIWNhY2hlZENsZWFyVGltZW91dCkgJiYgY2xlYXJUaW1lb3V0KSB7CiAgICAgICAgICBjYWNoZWRDbGVhclRpbWVvdXQgPSBjbGVhclRpbWVvdXQ7CiAgICAgICAgICByZXR1cm4gY2xlYXJUaW1lb3V0KG1hcmtlcik7CiAgICAgIH0KICAgICAgdHJ5IHsKICAgICAgICAgIC8vIHdoZW4gd2hlbiBzb21lYm9keSBoYXMgc2NyZXdlZCB3aXRoIHNldFRpbWVvdXQgYnV0IG5vIEkuRS4gbWFkZG5lc3MKICAgICAgICAgIHJldHVybiBjYWNoZWRDbGVhclRpbWVvdXQobWFya2VyKTsKICAgICAgfSBjYXRjaCAoZSl7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIC8vIFdoZW4gd2UgYXJlIGluIEkuRS4gYnV0IHRoZSBzY3JpcHQgaGFzIGJlZW4gZXZhbGVkIHNvIEkuRS4gZG9lc24ndCAgdHJ1c3QgdGhlIGdsb2JhbCBvYmplY3Qgd2hlbiBjYWxsZWQgbm9ybWFsbHkKICAgICAgICAgICAgICByZXR1cm4gY2FjaGVkQ2xlYXJUaW1lb3V0LmNhbGwobnVsbCwgbWFya2VyKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpewogICAgICAgICAgICAgIC8vIHNhbWUgYXMgYWJvdmUgYnV0IHdoZW4gaXQncyBhIHZlcnNpb24gb2YgSS5FLiB0aGF0IG11c3QgaGF2ZSB0aGUgZ2xvYmFsIG9iamVjdCBmb3IgJ3RoaXMnLCBob3BmdWxseSBvdXIgY29udGV4dCBjb3JyZWN0IG90aGVyd2lzZSBpdCB3aWxsIHRocm93IGEgZ2xvYmFsIGVycm9yLgogICAgICAgICAgICAgIC8vIFNvbWUgdmVyc2lvbnMgb2YgSS5FLiBoYXZlIGRpZmZlcmVudCBydWxlcyBmb3IgY2xlYXJUaW1lb3V0IHZzIHNldFRpbWVvdXQKICAgICAgICAgICAgICByZXR1cm4gY2FjaGVkQ2xlYXJUaW1lb3V0LmNhbGwodGhpcywgbWFya2VyKTsKICAgICAgICAgIH0KICAgICAgfQogIAogIAogIAogIH0KICB2YXIgcXVldWUgPSBbXTsKICB2YXIgZHJhaW5pbmcgPSBmYWxzZTsKICB2YXIgY3VycmVudFF1ZXVlOwogIHZhciBxdWV1ZUluZGV4ID0gLTE7CiAgCiAgZnVuY3Rpb24gY2xlYW5VcE5leHRUaWNrKCkgewogICAgICBpZiAoIWRyYWluaW5nIHx8ICFjdXJyZW50UXVldWUpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBkcmFpbmluZyA9IGZhbHNlOwogICAgICBpZiAoY3VycmVudFF1ZXVlLmxlbmd0aCkgewogICAgICAgICAgcXVldWUgPSBjdXJyZW50UXVldWUuY29uY2F0KHF1ZXVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAgIHF1ZXVlSW5kZXggPSAtMTsKICAgICAgfQogICAgICBpZiAocXVldWUubGVuZ3RoKSB7CiAgICAgICAgICBkcmFpblF1ZXVlKCk7CiAgICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gZHJhaW5RdWV1ZSgpIHsKICAgICAgaWYgKGRyYWluaW5nKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHRpbWVvdXQgPSBydW5UaW1lb3V0KGNsZWFuVXBOZXh0VGljayk7CiAgICAgIGRyYWluaW5nID0gdHJ1ZTsKICAKICAgICAgdmFyIGxlbiA9IHF1ZXVlLmxlbmd0aDsKICAgICAgd2hpbGUobGVuKSB7CiAgICAgICAgICBjdXJyZW50UXVldWUgPSBxdWV1ZTsKICAgICAgICAgIHF1ZXVlID0gW107CiAgICAgICAgICB3aGlsZSAoKytxdWV1ZUluZGV4IDwgbGVuKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRRdWV1ZSkgewogICAgICAgICAgICAgICAgICBjdXJyZW50UXVldWVbcXVldWVJbmRleF0ucnVuKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcXVldWVJbmRleCA9IC0xOwogICAgICAgICAgbGVuID0gcXVldWUubGVuZ3RoOwogICAgICB9CiAgICAgIGN1cnJlbnRRdWV1ZSA9IG51bGw7CiAgICAgIGRyYWluaW5nID0gZmFsc2U7CiAgICAgIHJ1bkNsZWFyVGltZW91dCh0aW1lb3V0KTsKICB9CiAgCiAgcHJvY2Vzcy5uZXh0VGljayA9IGZ1bmN0aW9uIChmdW4pIHsKICAgICAgdmFyIGFyZ3MgPSBuZXcgQXJyYXkoYXJndW1lbnRzLmxlbmd0aCAtIDEpOwogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgYXJnc1tpIC0gMV0gPSBhcmd1bWVudHNbaV07CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgcXVldWUucHVzaChuZXcgSXRlbShmdW4sIGFyZ3MpKTsKICAgICAgaWYgKHF1ZXVlLmxlbmd0aCA9PT0gMSAmJiAhZHJhaW5pbmcpIHsKICAgICAgICAgIHJ1blRpbWVvdXQoZHJhaW5RdWV1ZSk7CiAgICAgIH0KICB9OwogIAogIC8vIHY4IGxpa2VzIHByZWRpY3RpYmxlIG9iamVjdHMKICBmdW5jdGlvbiBJdGVtKGZ1biwgYXJyYXkpIHsKICAgICAgdGhpcy5mdW4gPSBmdW47CiAgICAgIHRoaXMuYXJyYXkgPSBhcnJheTsKICB9CiAgSXRlbS5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24gKCkgewogICAgICB0aGlzLmZ1bi5hcHBseShudWxsLCB0aGlzLmFycmF5KTsKICB9OwogIHByb2Nlc3MudGl0bGUgPSAnYnJvd3Nlcic7CiAgcHJvY2Vzcy5icm93c2VyID0gdHJ1ZTsKICBwcm9jZXNzLmVudiA9IHt9OwogIHByb2Nlc3MuYXJndiA9IFtdOwogIHByb2Nlc3MudmVyc2lvbiA9ICcnOyAvLyBlbXB0eSBzdHJpbmcgdG8gYXZvaWQgcmVnZXhwIGlzc3VlcwogIHByb2Nlc3MudmVyc2lvbnMgPSB7fTsKICAKICBmdW5jdGlvbiBub29wKCkge30KICAKICBwcm9jZXNzLm9uID0gbm9vcDsKICBwcm9jZXNzLmFkZExpc3RlbmVyID0gbm9vcDsKICBwcm9jZXNzLm9uY2UgPSBub29wOwogIHByb2Nlc3Mub2ZmID0gbm9vcDsKICBwcm9jZXNzLnJlbW92ZUxpc3RlbmVyID0gbm9vcDsKICBwcm9jZXNzLnJlbW92ZUFsbExpc3RlbmVycyA9IG5vb3A7CiAgcHJvY2Vzcy5lbWl0ID0gbm9vcDsKICBwcm9jZXNzLnByZXBlbmRMaXN0ZW5lciA9IG5vb3A7CiAgcHJvY2Vzcy5wcmVwZW5kT25jZUxpc3RlbmVyID0gbm9vcDsKICAKICBwcm9jZXNzLmxpc3RlbmVycyA9IGZ1bmN0aW9uIChuYW1lKSB7IHJldHVybiBbXSB9CiAgCiAgcHJvY2Vzcy5iaW5kaW5nID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdwcm9jZXNzLmJpbmRpbmcgaXMgbm90IHN1cHBvcnRlZCcpOwogIH07CiAgCiAgcHJvY2Vzcy5jd2QgPSBmdW5jdGlvbiAoKSB7IHJldHVybiAnLycgfTsKICBwcm9jZXNzLmNoZGlyID0gZnVuY3Rpb24gKGRpcikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Byb2Nlc3MuY2hkaXIgaXMgbm90IHN1cHBvcnRlZCcpOwogIH07CiAgcHJvY2Vzcy51bWFzayA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gMDsgfTsKICAKICB9LHt9XSw4NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChnbG9iYWwpewogIC8qISBodHRwczovL210aHMuYmUvcHVueWNvZGUgdjEuMy4yIGJ5IEBtYXRoaWFzICovCiAgOyhmdW5jdGlvbihyb290KSB7CiAgCiAgICAvKiogRGV0ZWN0IGZyZWUgdmFyaWFibGVzICovCiAgICB2YXIgZnJlZUV4cG9ydHMgPSB0eXBlb2YgZXhwb3J0cyA9PSAnb2JqZWN0JyAmJiBleHBvcnRzICYmCiAgICAgICFleHBvcnRzLm5vZGVUeXBlICYmIGV4cG9ydHM7CiAgICB2YXIgZnJlZU1vZHVsZSA9IHR5cGVvZiBtb2R1bGUgPT0gJ29iamVjdCcgJiYgbW9kdWxlICYmCiAgICAgICFtb2R1bGUubm9kZVR5cGUgJiYgbW9kdWxlOwogICAgdmFyIGZyZWVHbG9iYWwgPSB0eXBlb2YgZ2xvYmFsID09ICdvYmplY3QnICYmIGdsb2JhbDsKICAgIGlmICgKICAgICAgZnJlZUdsb2JhbC5nbG9iYWwgPT09IGZyZWVHbG9iYWwgfHwKICAgICAgZnJlZUdsb2JhbC53aW5kb3cgPT09IGZyZWVHbG9iYWwgfHwKICAgICAgZnJlZUdsb2JhbC5zZWxmID09PSBmcmVlR2xvYmFsCiAgICApIHsKICAgICAgcm9vdCA9IGZyZWVHbG9iYWw7CiAgICB9CiAgCiAgICAvKioKICAgICAqIFRoZSBgcHVueWNvZGVgIG9iamVjdC4KICAgICAqIEBuYW1lIHB1bnljb2RlCiAgICAgKiBAdHlwZSBPYmplY3QKICAgICAqLwogICAgdmFyIHB1bnljb2RlLAogIAogICAgLyoqIEhpZ2hlc3QgcG9zaXRpdmUgc2lnbmVkIDMyLWJpdCBmbG9hdCB2YWx1ZSAqLwogICAgbWF4SW50ID0gMjE0NzQ4MzY0NywgLy8gYWthLiAweDdGRkZGRkZGIG9yIDJeMzEtMQogIAogICAgLyoqIEJvb3RzdHJpbmcgcGFyYW1ldGVycyAqLwogICAgYmFzZSA9IDM2LAogICAgdE1pbiA9IDEsCiAgICB0TWF4ID0gMjYsCiAgICBza2V3ID0gMzgsCiAgICBkYW1wID0gNzAwLAogICAgaW5pdGlhbEJpYXMgPSA3MiwKICAgIGluaXRpYWxOID0gMTI4LCAvLyAweDgwCiAgICBkZWxpbWl0ZXIgPSAnLScsIC8vICdceDJEJwogIAogICAgLyoqIFJlZ3VsYXIgZXhwcmVzc2lvbnMgKi8KICAgIHJlZ2V4UHVueWNvZGUgPSAvXnhuLS0vLAogICAgcmVnZXhOb25BU0NJSSA9IC9bXlx4MjAtXHg3RV0vLCAvLyB1bnByaW50YWJsZSBBU0NJSSBjaGFycyArIG5vbi1BU0NJSSBjaGFycwogICAgcmVnZXhTZXBhcmF0b3JzID0gL1tceDJFXHUzMDAyXHVGRjBFXHVGRjYxXS9nLCAvLyBSRkMgMzQ5MCBzZXBhcmF0b3JzCiAgCiAgICAvKiogRXJyb3IgbWVzc2FnZXMgKi8KICAgIGVycm9ycyA9IHsKICAgICAgJ292ZXJmbG93JzogJ092ZXJmbG93OiBpbnB1dCBuZWVkcyB3aWRlciBpbnRlZ2VycyB0byBwcm9jZXNzJywKICAgICAgJ25vdC1iYXNpYyc6ICdJbGxlZ2FsIGlucHV0ID49IDB4ODAgKG5vdCBhIGJhc2ljIGNvZGUgcG9pbnQpJywKICAgICAgJ2ludmFsaWQtaW5wdXQnOiAnSW52YWxpZCBpbnB1dCcKICAgIH0sCiAgCiAgICAvKiogQ29udmVuaWVuY2Ugc2hvcnRjdXRzICovCiAgICBiYXNlTWludXNUTWluID0gYmFzZSAtIHRNaW4sCiAgICBmbG9vciA9IE1hdGguZmxvb3IsCiAgICBzdHJpbmdGcm9tQ2hhckNvZGUgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLAogIAogICAgLyoqIFRlbXBvcmFyeSB2YXJpYWJsZSAqLwogICAga2V5OwogIAogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgCiAgICAvKioKICAgICAqIEEgZ2VuZXJpYyBlcnJvciB1dGlsaXR5IGZ1bmN0aW9uLgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBlcnJvciB0eXBlLgogICAgICogQHJldHVybnMge0Vycm9yfSBUaHJvd3MgYSBgUmFuZ2VFcnJvcmAgd2l0aCB0aGUgYXBwbGljYWJsZSBlcnJvciBtZXNzYWdlLgogICAgICovCiAgICBmdW5jdGlvbiBlcnJvcih0eXBlKSB7CiAgICAgIHRocm93IFJhbmdlRXJyb3IoZXJyb3JzW3R5cGVdKTsKICAgIH0KICAKICAgIC8qKgogICAgICogQSBnZW5lcmljIGBBcnJheSNtYXBgIHV0aWxpdHkgZnVuY3Rpb24uCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0aGF0IGdldHMgY2FsbGVkIGZvciBldmVyeSBhcnJheQogICAgICogaXRlbS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gQSBuZXcgYXJyYXkgb2YgdmFsdWVzIHJldHVybmVkIGJ5IHRoZSBjYWxsYmFjayBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gbWFwKGFycmF5LCBmbikgewogICAgICB2YXIgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgIHJlc3VsdFtsZW5ndGhdID0gZm4oYXJyYXlbbGVuZ3RoXSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAKICAgIC8qKgogICAgICogQSBzaW1wbGUgYEFycmF5I21hcGAtbGlrZSB3cmFwcGVyIHRvIHdvcmsgd2l0aCBkb21haW4gbmFtZSBzdHJpbmdzIG9yIGVtYWlsCiAgICAgKiBhZGRyZXNzZXMuCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGRvbWFpbiBUaGUgZG9tYWluIG5hbWUgb3IgZW1haWwgYWRkcmVzcy4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0aGF0IGdldHMgY2FsbGVkIGZvciBldmVyeQogICAgICogY2hhcmFjdGVyLgogICAgICogQHJldHVybnMge0FycmF5fSBBIG5ldyBzdHJpbmcgb2YgY2hhcmFjdGVycyByZXR1cm5lZCBieSB0aGUgY2FsbGJhY2sKICAgICAqIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBtYXBEb21haW4oc3RyaW5nLCBmbikgewogICAgICB2YXIgcGFydHMgPSBzdHJpbmcuc3BsaXQoJ0AnKTsKICAgICAgdmFyIHJlc3VsdCA9ICcnOwogICAgICBpZiAocGFydHMubGVuZ3RoID4gMSkgewogICAgICAgIC8vIEluIGVtYWlsIGFkZHJlc3Nlcywgb25seSB0aGUgZG9tYWluIG5hbWUgc2hvdWxkIGJlIHB1bnljb2RlZC4gTGVhdmUKICAgICAgICAvLyB0aGUgbG9jYWwgcGFydCAoaS5lLiBldmVyeXRoaW5nIHVwIHRvIGBAYCkgaW50YWN0LgogICAgICAgIHJlc3VsdCA9IHBhcnRzWzBdICsgJ0AnOwogICAgICAgIHN0cmluZyA9IHBhcnRzWzFdOwogICAgICB9CiAgICAgIC8vIEF2b2lkIGBzcGxpdChyZWdleClgIGZvciBJRTggY29tcGF0aWJpbGl0eS4gU2VlICMxNy4KICAgICAgc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UocmVnZXhTZXBhcmF0b3JzLCAnXHgyRScpOwogICAgICB2YXIgbGFiZWxzID0gc3RyaW5nLnNwbGl0KCcuJyk7CiAgICAgIHZhciBlbmNvZGVkID0gbWFwKGxhYmVscywgZm4pLmpvaW4oJy4nKTsKICAgICAgcmV0dXJuIHJlc3VsdCArIGVuY29kZWQ7CiAgICB9CiAgCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgY29udGFpbmluZyB0aGUgbnVtZXJpYyBjb2RlIHBvaW50cyBvZiBlYWNoIFVuaWNvZGUKICAgICAqIGNoYXJhY3RlciBpbiB0aGUgc3RyaW5nLiBXaGlsZSBKYXZhU2NyaXB0IHVzZXMgVUNTLTIgaW50ZXJuYWxseSwKICAgICAqIHRoaXMgZnVuY3Rpb24gd2lsbCBjb252ZXJ0IGEgcGFpciBvZiBzdXJyb2dhdGUgaGFsdmVzIChlYWNoIG9mIHdoaWNoCiAgICAgKiBVQ1MtMiBleHBvc2VzIGFzIHNlcGFyYXRlIGNoYXJhY3RlcnMpIGludG8gYSBzaW5nbGUgY29kZSBwb2ludCwKICAgICAqIG1hdGNoaW5nIFVURi0xNi4KICAgICAqIEBzZWUgYHB1bnljb2RlLnVjczIuZW5jb2RlYAogICAgICogQHNlZSA8aHR0cHM6Ly9tYXRoaWFzYnluZW5zLmJlL25vdGVzL2phdmFzY3JpcHQtZW5jb2Rpbmc+CiAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUudWNzMgogICAgICogQG5hbWUgZGVjb2RlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyaW5nIFRoZSBVbmljb2RlIGlucHV0IHN0cmluZyAoVUNTLTIpLgogICAgICogQHJldHVybnMge0FycmF5fSBUaGUgbmV3IGFycmF5IG9mIGNvZGUgcG9pbnRzLgogICAgICovCiAgICBmdW5jdGlvbiB1Y3MyZGVjb2RlKHN0cmluZykgewogICAgICB2YXIgb3V0cHV0ID0gW10sCiAgICAgICAgICBjb3VudGVyID0gMCwKICAgICAgICAgIGxlbmd0aCA9IHN0cmluZy5sZW5ndGgsCiAgICAgICAgICB2YWx1ZSwKICAgICAgICAgIGV4dHJhOwogICAgICB3aGlsZSAoY291bnRlciA8IGxlbmd0aCkgewogICAgICAgIHZhbHVlID0gc3RyaW5nLmNoYXJDb2RlQXQoY291bnRlcisrKTsKICAgICAgICBpZiAodmFsdWUgPj0gMHhEODAwICYmIHZhbHVlIDw9IDB4REJGRiAmJiBjb3VudGVyIDwgbGVuZ3RoKSB7CiAgICAgICAgICAvLyBoaWdoIHN1cnJvZ2F0ZSwgYW5kIHRoZXJlIGlzIGEgbmV4dCBjaGFyYWN0ZXIKICAgICAgICAgIGV4dHJhID0gc3RyaW5nLmNoYXJDb2RlQXQoY291bnRlcisrKTsKICAgICAgICAgIGlmICgoZXh0cmEgJiAweEZDMDApID09IDB4REMwMCkgeyAvLyBsb3cgc3Vycm9nYXRlCiAgICAgICAgICAgIG91dHB1dC5wdXNoKCgodmFsdWUgJiAweDNGRikgPDwgMTApICsgKGV4dHJhICYgMHgzRkYpICsgMHgxMDAwMCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyB1bm1hdGNoZWQgc3Vycm9nYXRlOyBvbmx5IGFwcGVuZCB0aGlzIGNvZGUgdW5pdCwgaW4gY2FzZSB0aGUgbmV4dAogICAgICAgICAgICAvLyBjb2RlIHVuaXQgaXMgdGhlIGhpZ2ggc3Vycm9nYXRlIG9mIGEgc3Vycm9nYXRlIHBhaXIKICAgICAgICAgICAgb3V0cHV0LnB1c2godmFsdWUpOwogICAgICAgICAgICBjb3VudGVyLS07CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG91dHB1dC5wdXNoKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH0KICAKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHN0cmluZyBiYXNlZCBvbiBhbiBhcnJheSBvZiBudW1lcmljIGNvZGUgcG9pbnRzLgogICAgICogQHNlZSBgcHVueWNvZGUudWNzMi5kZWNvZGVgCiAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUudWNzMgogICAgICogQG5hbWUgZW5jb2RlCiAgICAgKiBAcGFyYW0ge0FycmF5fSBjb2RlUG9pbnRzIFRoZSBhcnJheSBvZiBudW1lcmljIGNvZGUgcG9pbnRzLgogICAgICogQHJldHVybnMge1N0cmluZ30gVGhlIG5ldyBVbmljb2RlIHN0cmluZyAoVUNTLTIpLgogICAgICovCiAgICBmdW5jdGlvbiB1Y3MyZW5jb2RlKGFycmF5KSB7CiAgICAgIHJldHVybiBtYXAoYXJyYXksIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIG91dHB1dCA9ICcnOwogICAgICAgIGlmICh2YWx1ZSA+IDB4RkZGRikgewogICAgICAgICAgdmFsdWUgLT0gMHgxMDAwMDsKICAgICAgICAgIG91dHB1dCArPSBzdHJpbmdGcm9tQ2hhckNvZGUodmFsdWUgPj4+IDEwICYgMHgzRkYgfCAweEQ4MDApOwogICAgICAgICAgdmFsdWUgPSAweERDMDAgfCB2YWx1ZSAmIDB4M0ZGOwogICAgICAgIH0KICAgICAgICBvdXRwdXQgKz0gc3RyaW5nRnJvbUNoYXJDb2RlKHZhbHVlKTsKICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICB9KS5qb2luKCcnKTsKICAgIH0KICAKICAgIC8qKgogICAgICogQ29udmVydHMgYSBiYXNpYyBjb2RlIHBvaW50IGludG8gYSBkaWdpdC9pbnRlZ2VyLgogICAgICogQHNlZSBgZGlnaXRUb0Jhc2ljKClgCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtOdW1iZXJ9IGNvZGVQb2ludCBUaGUgYmFzaWMgbnVtZXJpYyBjb2RlIHBvaW50IHZhbHVlLgogICAgICogQHJldHVybnMge051bWJlcn0gVGhlIG51bWVyaWMgdmFsdWUgb2YgYSBiYXNpYyBjb2RlIHBvaW50IChmb3IgdXNlIGluCiAgICAgKiByZXByZXNlbnRpbmcgaW50ZWdlcnMpIGluIHRoZSByYW5nZSBgMGAgdG8gYGJhc2UgLSAxYCwgb3IgYGJhc2VgIGlmCiAgICAgKiB0aGUgY29kZSBwb2ludCBkb2VzIG5vdCByZXByZXNlbnQgYSB2YWx1ZS4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzaWNUb0RpZ2l0KGNvZGVQb2ludCkgewogICAgICBpZiAoY29kZVBvaW50IC0gNDggPCAxMCkgewogICAgICAgIHJldHVybiBjb2RlUG9pbnQgLSAyMjsKICAgICAgfQogICAgICBpZiAoY29kZVBvaW50IC0gNjUgPCAyNikgewogICAgICAgIHJldHVybiBjb2RlUG9pbnQgLSA2NTsKICAgICAgfQogICAgICBpZiAoY29kZVBvaW50IC0gOTcgPCAyNikgewogICAgICAgIHJldHVybiBjb2RlUG9pbnQgLSA5NzsKICAgICAgfQogICAgICByZXR1cm4gYmFzZTsKICAgIH0KICAKICAgIC8qKgogICAgICogQ29udmVydHMgYSBkaWdpdC9pbnRlZ2VyIGludG8gYSBiYXNpYyBjb2RlIHBvaW50LgogICAgICogQHNlZSBgYmFzaWNUb0RpZ2l0KClgCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtOdW1iZXJ9IGRpZ2l0IFRoZSBudW1lcmljIHZhbHVlIG9mIGEgYmFzaWMgY29kZSBwb2ludC4KICAgICAqIEByZXR1cm5zIHtOdW1iZXJ9IFRoZSBiYXNpYyBjb2RlIHBvaW50IHdob3NlIHZhbHVlICh3aGVuIHVzZWQgZm9yCiAgICAgKiByZXByZXNlbnRpbmcgaW50ZWdlcnMpIGlzIGBkaWdpdGAsIHdoaWNoIG5lZWRzIHRvIGJlIGluIHRoZSByYW5nZQogICAgICogYDBgIHRvIGBiYXNlIC0gMWAuIElmIGBmbGFnYCBpcyBub24temVybywgdGhlIHVwcGVyY2FzZSBmb3JtIGlzCiAgICAgKiB1c2VkOyBlbHNlLCB0aGUgbG93ZXJjYXNlIGZvcm0gaXMgdXNlZC4gVGhlIGJlaGF2aW9yIGlzIHVuZGVmaW5lZAogICAgICogaWYgYGZsYWdgIGlzIG5vbi16ZXJvIGFuZCBgZGlnaXRgIGhhcyBubyB1cHBlcmNhc2UgZm9ybS4KICAgICAqLwogICAgZnVuY3Rpb24gZGlnaXRUb0Jhc2ljKGRpZ2l0LCBmbGFnKSB7CiAgICAgIC8vICAwLi4yNSBtYXAgdG8gQVNDSUkgYS4ueiBvciBBLi5aCiAgICAgIC8vIDI2Li4zNSBtYXAgdG8gQVNDSUkgMC4uOQogICAgICByZXR1cm4gZGlnaXQgKyAyMiArIDc1ICogKGRpZ2l0IDwgMjYpIC0gKChmbGFnICE9IDApIDw8IDUpOwogICAgfQogIAogICAgLyoqCiAgICAgKiBCaWFzIGFkYXB0YXRpb24gZnVuY3Rpb24gYXMgcGVyIHNlY3Rpb24gMy40IG9mIFJGQyAzNDkyLgogICAgICogaHR0cDovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMzQ5MiNzZWN0aW9uLTMuNAogICAgICogQHByaXZhdGUKICAgICAqLwogICAgZnVuY3Rpb24gYWRhcHQoZGVsdGEsIG51bVBvaW50cywgZmlyc3RUaW1lKSB7CiAgICAgIHZhciBrID0gMDsKICAgICAgZGVsdGEgPSBmaXJzdFRpbWUgPyBmbG9vcihkZWx0YSAvIGRhbXApIDogZGVsdGEgPj4gMTsKICAgICAgZGVsdGEgKz0gZmxvb3IoZGVsdGEgLyBudW1Qb2ludHMpOwogICAgICBmb3IgKC8qIG5vIGluaXRpYWxpemF0aW9uICovOyBkZWx0YSA+IGJhc2VNaW51c1RNaW4gKiB0TWF4ID4+IDE7IGsgKz0gYmFzZSkgewogICAgICAgIGRlbHRhID0gZmxvb3IoZGVsdGEgLyBiYXNlTWludXNUTWluKTsKICAgICAgfQogICAgICByZXR1cm4gZmxvb3IoayArIChiYXNlTWludXNUTWluICsgMSkgKiBkZWx0YSAvIChkZWx0YSArIHNrZXcpKTsKICAgIH0KICAKICAgIC8qKgogICAgICogQ29udmVydHMgYSBQdW55Y29kZSBzdHJpbmcgb2YgQVNDSUktb25seSBzeW1ib2xzIHRvIGEgc3RyaW5nIG9mIFVuaWNvZGUKICAgICAqIHN5bWJvbHMuCiAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpbnB1dCBUaGUgUHVueWNvZGUgc3RyaW5nIG9mIEFTQ0lJLW9ubHkgc3ltYm9scy4KICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IFRoZSByZXN1bHRpbmcgc3RyaW5nIG9mIFVuaWNvZGUgc3ltYm9scy4KICAgICAqLwogICAgZnVuY3Rpb24gZGVjb2RlKGlucHV0KSB7CiAgICAgIC8vIERvbid0IHVzZSBVQ1MtMgogICAgICB2YXIgb3V0cHV0ID0gW10sCiAgICAgICAgICBpbnB1dExlbmd0aCA9IGlucHV0Lmxlbmd0aCwKICAgICAgICAgIG91dCwKICAgICAgICAgIGkgPSAwLAogICAgICAgICAgbiA9IGluaXRpYWxOLAogICAgICAgICAgYmlhcyA9IGluaXRpYWxCaWFzLAogICAgICAgICAgYmFzaWMsCiAgICAgICAgICBqLAogICAgICAgICAgaW5kZXgsCiAgICAgICAgICBvbGRpLAogICAgICAgICAgdywKICAgICAgICAgIGssCiAgICAgICAgICBkaWdpdCwKICAgICAgICAgIHQsCiAgICAgICAgICAvKiogQ2FjaGVkIGNhbGN1bGF0aW9uIHJlc3VsdHMgKi8KICAgICAgICAgIGJhc2VNaW51c1Q7CiAgCiAgICAgIC8vIEhhbmRsZSB0aGUgYmFzaWMgY29kZSBwb2ludHM6IGxldCBgYmFzaWNgIGJlIHRoZSBudW1iZXIgb2YgaW5wdXQgY29kZQogICAgICAvLyBwb2ludHMgYmVmb3JlIHRoZSBsYXN0IGRlbGltaXRlciwgb3IgYDBgIGlmIHRoZXJlIGlzIG5vbmUsIHRoZW4gY29weQogICAgICAvLyB0aGUgZmlyc3QgYmFzaWMgY29kZSBwb2ludHMgdG8gdGhlIG91dHB1dC4KICAKICAgICAgYmFzaWMgPSBpbnB1dC5sYXN0SW5kZXhPZihkZWxpbWl0ZXIpOwogICAgICBpZiAoYmFzaWMgPCAwKSB7CiAgICAgICAgYmFzaWMgPSAwOwogICAgICB9CiAgCiAgICAgIGZvciAoaiA9IDA7IGogPCBiYXNpYzsgKytqKSB7CiAgICAgICAgLy8gaWYgaXQncyBub3QgYSBiYXNpYyBjb2RlIHBvaW50CiAgICAgICAgaWYgKGlucHV0LmNoYXJDb2RlQXQoaikgPj0gMHg4MCkgewogICAgICAgICAgZXJyb3IoJ25vdC1iYXNpYycpOwogICAgICAgIH0KICAgICAgICBvdXRwdXQucHVzaChpbnB1dC5jaGFyQ29kZUF0KGopKTsKICAgICAgfQogIAogICAgICAvLyBNYWluIGRlY29kaW5nIGxvb3A6IHN0YXJ0IGp1c3QgYWZ0ZXIgdGhlIGxhc3QgZGVsaW1pdGVyIGlmIGFueSBiYXNpYyBjb2RlCiAgICAgIC8vIHBvaW50cyB3ZXJlIGNvcGllZDsgc3RhcnQgYXQgdGhlIGJlZ2lubmluZyBvdGhlcndpc2UuCiAgCiAgICAgIGZvciAoaW5kZXggPSBiYXNpYyA+IDAgPyBiYXNpYyArIDEgOiAwOyBpbmRleCA8IGlucHV0TGVuZ3RoOyAvKiBubyBmaW5hbCBleHByZXNzaW9uICovKSB7CiAgCiAgICAgICAgLy8gYGluZGV4YCBpcyB0aGUgaW5kZXggb2YgdGhlIG5leHQgY2hhcmFjdGVyIHRvIGJlIGNvbnN1bWVkLgogICAgICAgIC8vIERlY29kZSBhIGdlbmVyYWxpemVkIHZhcmlhYmxlLWxlbmd0aCBpbnRlZ2VyIGludG8gYGRlbHRhYCwKICAgICAgICAvLyB3aGljaCBnZXRzIGFkZGVkIHRvIGBpYC4gVGhlIG92ZXJmbG93IGNoZWNraW5nIGlzIGVhc2llcgogICAgICAgIC8vIGlmIHdlIGluY3JlYXNlIGBpYCBhcyB3ZSBnbywgdGhlbiBzdWJ0cmFjdCBvZmYgaXRzIHN0YXJ0aW5nCiAgICAgICAgLy8gdmFsdWUgYXQgdGhlIGVuZCB0byBvYnRhaW4gYGRlbHRhYC4KICAgICAgICBmb3IgKG9sZGkgPSBpLCB3ID0gMSwgayA9IGJhc2U7IC8qIG5vIGNvbmRpdGlvbiAqLzsgayArPSBiYXNlKSB7CiAgCiAgICAgICAgICBpZiAoaW5kZXggPj0gaW5wdXRMZW5ndGgpIHsKICAgICAgICAgICAgZXJyb3IoJ2ludmFsaWQtaW5wdXQnKTsKICAgICAgICAgIH0KICAKICAgICAgICAgIGRpZ2l0ID0gYmFzaWNUb0RpZ2l0KGlucHV0LmNoYXJDb2RlQXQoaW5kZXgrKykpOwogIAogICAgICAgICAgaWYgKGRpZ2l0ID49IGJhc2UgfHwgZGlnaXQgPiBmbG9vcigobWF4SW50IC0gaSkgLyB3KSkgewogICAgICAgICAgICBlcnJvcignb3ZlcmZsb3cnKTsKICAgICAgICAgIH0KICAKICAgICAgICAgIGkgKz0gZGlnaXQgKiB3OwogICAgICAgICAgdCA9IGsgPD0gYmlhcyA/IHRNaW4gOiAoayA+PSBiaWFzICsgdE1heCA/IHRNYXggOiBrIC0gYmlhcyk7CiAgCiAgICAgICAgICBpZiAoZGlnaXQgPCB0KSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogIAogICAgICAgICAgYmFzZU1pbnVzVCA9IGJhc2UgLSB0OwogICAgICAgICAgaWYgKHcgPiBmbG9vcihtYXhJbnQgLyBiYXNlTWludXNUKSkgewogICAgICAgICAgICBlcnJvcignb3ZlcmZsb3cnKTsKICAgICAgICAgIH0KICAKICAgICAgICAgIHcgKj0gYmFzZU1pbnVzVDsKICAKICAgICAgICB9CiAgCiAgICAgICAgb3V0ID0gb3V0cHV0Lmxlbmd0aCArIDE7CiAgICAgICAgYmlhcyA9IGFkYXB0KGkgLSBvbGRpLCBvdXQsIG9sZGkgPT0gMCk7CiAgCiAgICAgICAgLy8gYGlgIHdhcyBzdXBwb3NlZCB0byB3cmFwIGFyb3VuZCBmcm9tIGBvdXRgIHRvIGAwYCwKICAgICAgICAvLyBpbmNyZW1lbnRpbmcgYG5gIGVhY2ggdGltZSwgc28gd2UnbGwgZml4IHRoYXQgbm93OgogICAgICAgIGlmIChmbG9vcihpIC8gb3V0KSA+IG1heEludCAtIG4pIHsKICAgICAgICAgIGVycm9yKCdvdmVyZmxvdycpOwogICAgICAgIH0KICAKICAgICAgICBuICs9IGZsb29yKGkgLyBvdXQpOwogICAgICAgIGkgJT0gb3V0OwogIAogICAgICAgIC8vIEluc2VydCBgbmAgYXQgcG9zaXRpb24gYGlgIG9mIHRoZSBvdXRwdXQKICAgICAgICBvdXRwdXQuc3BsaWNlKGkrKywgMCwgbik7CiAgCiAgICAgIH0KICAKICAgICAgcmV0dXJuIHVjczJlbmNvZGUob3V0cHV0KTsKICAgIH0KICAKICAgIC8qKgogICAgICogQ29udmVydHMgYSBzdHJpbmcgb2YgVW5pY29kZSBzeW1ib2xzIChlLmcuIGEgZG9tYWluIG5hbWUgbGFiZWwpIHRvIGEKICAgICAqIFB1bnljb2RlIHN0cmluZyBvZiBBU0NJSS1vbmx5IHN5bWJvbHMuCiAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpbnB1dCBUaGUgc3RyaW5nIG9mIFVuaWNvZGUgc3ltYm9scy4KICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IFRoZSByZXN1bHRpbmcgUHVueWNvZGUgc3RyaW5nIG9mIEFTQ0lJLW9ubHkgc3ltYm9scy4KICAgICAqLwogICAgZnVuY3Rpb24gZW5jb2RlKGlucHV0KSB7CiAgICAgIHZhciBuLAogICAgICAgICAgZGVsdGEsCiAgICAgICAgICBoYW5kbGVkQ1BDb3VudCwKICAgICAgICAgIGJhc2ljTGVuZ3RoLAogICAgICAgICAgYmlhcywKICAgICAgICAgIGosCiAgICAgICAgICBtLAogICAgICAgICAgcSwKICAgICAgICAgIGssCiAgICAgICAgICB0LAogICAgICAgICAgY3VycmVudFZhbHVlLAogICAgICAgICAgb3V0cHV0ID0gW10sCiAgICAgICAgICAvKiogYGlucHV0TGVuZ3RoYCB3aWxsIGhvbGQgdGhlIG51bWJlciBvZiBjb2RlIHBvaW50cyBpbiBgaW5wdXRgLiAqLwogICAgICAgICAgaW5wdXRMZW5ndGgsCiAgICAgICAgICAvKiogQ2FjaGVkIGNhbGN1bGF0aW9uIHJlc3VsdHMgKi8KICAgICAgICAgIGhhbmRsZWRDUENvdW50UGx1c09uZSwKICAgICAgICAgIGJhc2VNaW51c1QsCiAgICAgICAgICBxTWludXNUOwogIAogICAgICAvLyBDb252ZXJ0IHRoZSBpbnB1dCBpbiBVQ1MtMiB0byBVbmljb2RlCiAgICAgIGlucHV0ID0gdWNzMmRlY29kZShpbnB1dCk7CiAgCiAgICAgIC8vIENhY2hlIHRoZSBsZW5ndGgKICAgICAgaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGg7CiAgCiAgICAgIC8vIEluaXRpYWxpemUgdGhlIHN0YXRlCiAgICAgIG4gPSBpbml0aWFsTjsKICAgICAgZGVsdGEgPSAwOwogICAgICBiaWFzID0gaW5pdGlhbEJpYXM7CiAgCiAgICAgIC8vIEhhbmRsZSB0aGUgYmFzaWMgY29kZSBwb2ludHMKICAgICAgZm9yIChqID0gMDsgaiA8IGlucHV0TGVuZ3RoOyArK2opIHsKICAgICAgICBjdXJyZW50VmFsdWUgPSBpbnB1dFtqXTsKICAgICAgICBpZiAoY3VycmVudFZhbHVlIDwgMHg4MCkgewogICAgICAgICAgb3V0cHV0LnB1c2goc3RyaW5nRnJvbUNoYXJDb2RlKGN1cnJlbnRWYWx1ZSkpOwogICAgICAgIH0KICAgICAgfQogIAogICAgICBoYW5kbGVkQ1BDb3VudCA9IGJhc2ljTGVuZ3RoID0gb3V0cHV0Lmxlbmd0aDsKICAKICAgICAgLy8gYGhhbmRsZWRDUENvdW50YCBpcyB0aGUgbnVtYmVyIG9mIGNvZGUgcG9pbnRzIHRoYXQgaGF2ZSBiZWVuIGhhbmRsZWQ7CiAgICAgIC8vIGBiYXNpY0xlbmd0aGAgaXMgdGhlIG51bWJlciBvZiBiYXNpYyBjb2RlIHBvaW50cy4KICAKICAgICAgLy8gRmluaXNoIHRoZSBiYXNpYyBzdHJpbmcgLSBpZiBpdCBpcyBub3QgZW1wdHkgLSB3aXRoIGEgZGVsaW1pdGVyCiAgICAgIGlmIChiYXNpY0xlbmd0aCkgewogICAgICAgIG91dHB1dC5wdXNoKGRlbGltaXRlcik7CiAgICAgIH0KICAKICAgICAgLy8gTWFpbiBlbmNvZGluZyBsb29wOgogICAgICB3aGlsZSAoaGFuZGxlZENQQ291bnQgPCBpbnB1dExlbmd0aCkgewogIAogICAgICAgIC8vIEFsbCBub24tYmFzaWMgY29kZSBwb2ludHMgPCBuIGhhdmUgYmVlbiBoYW5kbGVkIGFscmVhZHkuIEZpbmQgdGhlIG5leHQKICAgICAgICAvLyBsYXJnZXIgb25lOgogICAgICAgIGZvciAobSA9IG1heEludCwgaiA9IDA7IGogPCBpbnB1dExlbmd0aDsgKytqKSB7CiAgICAgICAgICBjdXJyZW50VmFsdWUgPSBpbnB1dFtqXTsKICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgPj0gbiAmJiBjdXJyZW50VmFsdWUgPCBtKSB7CiAgICAgICAgICAgIG0gPSBjdXJyZW50VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogIAogICAgICAgIC8vIEluY3JlYXNlIGBkZWx0YWAgZW5vdWdoIHRvIGFkdmFuY2UgdGhlIGRlY29kZXIncyA8bixpPiBzdGF0ZSB0byA8bSwwPiwKICAgICAgICAvLyBidXQgZ3VhcmQgYWdhaW5zdCBvdmVyZmxvdwogICAgICAgIGhhbmRsZWRDUENvdW50UGx1c09uZSA9IGhhbmRsZWRDUENvdW50ICsgMTsKICAgICAgICBpZiAobSAtIG4gPiBmbG9vcigobWF4SW50IC0gZGVsdGEpIC8gaGFuZGxlZENQQ291bnRQbHVzT25lKSkgewogICAgICAgICAgZXJyb3IoJ292ZXJmbG93Jyk7CiAgICAgICAgfQogIAogICAgICAgIGRlbHRhICs9IChtIC0gbikgKiBoYW5kbGVkQ1BDb3VudFBsdXNPbmU7CiAgICAgICAgbiA9IG07CiAgCiAgICAgICAgZm9yIChqID0gMDsgaiA8IGlucHV0TGVuZ3RoOyArK2opIHsKICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IGlucHV0W2pdOwogIAogICAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSA8IG4gJiYgKytkZWx0YSA+IG1heEludCkgewogICAgICAgICAgICBlcnJvcignb3ZlcmZsb3cnKTsKICAgICAgICAgIH0KICAKICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgPT0gbikgewogICAgICAgICAgICAvLyBSZXByZXNlbnQgZGVsdGEgYXMgYSBnZW5lcmFsaXplZCB2YXJpYWJsZS1sZW5ndGggaW50ZWdlcgogICAgICAgICAgICBmb3IgKHEgPSBkZWx0YSwgayA9IGJhc2U7IC8qIG5vIGNvbmRpdGlvbiAqLzsgayArPSBiYXNlKSB7CiAgICAgICAgICAgICAgdCA9IGsgPD0gYmlhcyA/IHRNaW4gOiAoayA+PSBiaWFzICsgdE1heCA/IHRNYXggOiBrIC0gYmlhcyk7CiAgICAgICAgICAgICAgaWYgKHEgPCB0KSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcU1pbnVzVCA9IHEgLSB0OwogICAgICAgICAgICAgIGJhc2VNaW51c1QgPSBiYXNlIC0gdDsKICAgICAgICAgICAgICBvdXRwdXQucHVzaCgKICAgICAgICAgICAgICAgIHN0cmluZ0Zyb21DaGFyQ29kZShkaWdpdFRvQmFzaWModCArIHFNaW51c1QgJSBiYXNlTWludXNULCAwKSkKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHEgPSBmbG9vcihxTWludXNUIC8gYmFzZU1pbnVzVCk7CiAgICAgICAgICAgIH0KICAKICAgICAgICAgICAgb3V0cHV0LnB1c2goc3RyaW5nRnJvbUNoYXJDb2RlKGRpZ2l0VG9CYXNpYyhxLCAwKSkpOwogICAgICAgICAgICBiaWFzID0gYWRhcHQoZGVsdGEsIGhhbmRsZWRDUENvdW50UGx1c09uZSwgaGFuZGxlZENQQ291bnQgPT0gYmFzaWNMZW5ndGgpOwogICAgICAgICAgICBkZWx0YSA9IDA7CiAgICAgICAgICAgICsraGFuZGxlZENQQ291bnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogIAogICAgICAgICsrZGVsdGE7CiAgICAgICAgKytuOwogIAogICAgICB9CiAgICAgIHJldHVybiBvdXRwdXQuam9pbignJyk7CiAgICB9CiAgCiAgICAvKioKICAgICAqIENvbnZlcnRzIGEgUHVueWNvZGUgc3RyaW5nIHJlcHJlc2VudGluZyBhIGRvbWFpbiBuYW1lIG9yIGFuIGVtYWlsIGFkZHJlc3MKICAgICAqIHRvIFVuaWNvZGUuIE9ubHkgdGhlIFB1bnljb2RlZCBwYXJ0cyBvZiB0aGUgaW5wdXQgd2lsbCBiZSBjb252ZXJ0ZWQsIGkuZS4KICAgICAqIGl0IGRvZXNuJ3QgbWF0dGVyIGlmIHlvdSBjYWxsIGl0IG9uIGEgc3RyaW5nIHRoYXQgaGFzIGFscmVhZHkgYmVlbgogICAgICogY29udmVydGVkIHRvIFVuaWNvZGUuCiAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpbnB1dCBUaGUgUHVueWNvZGVkIGRvbWFpbiBuYW1lIG9yIGVtYWlsIGFkZHJlc3MgdG8KICAgICAqIGNvbnZlcnQgdG8gVW5pY29kZS4KICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IFRoZSBVbmljb2RlIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBnaXZlbiBQdW55Y29kZQogICAgICogc3RyaW5nLgogICAgICovCiAgICBmdW5jdGlvbiB0b1VuaWNvZGUoaW5wdXQpIHsKICAgICAgcmV0dXJuIG1hcERvbWFpbihpbnB1dCwgZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgICAgcmV0dXJuIHJlZ2V4UHVueWNvZGUudGVzdChzdHJpbmcpCiAgICAgICAgICA/IGRlY29kZShzdHJpbmcuc2xpY2UoNCkudG9Mb3dlckNhc2UoKSkKICAgICAgICAgIDogc3RyaW5nOwogICAgICB9KTsKICAgIH0KICAKICAgIC8qKgogICAgICogQ29udmVydHMgYSBVbmljb2RlIHN0cmluZyByZXByZXNlbnRpbmcgYSBkb21haW4gbmFtZSBvciBhbiBlbWFpbCBhZGRyZXNzIHRvCiAgICAgKiBQdW55Y29kZS4gT25seSB0aGUgbm9uLUFTQ0lJIHBhcnRzIG9mIHRoZSBkb21haW4gbmFtZSB3aWxsIGJlIGNvbnZlcnRlZCwKICAgICAqIGkuZS4gaXQgZG9lc24ndCBtYXR0ZXIgaWYgeW91IGNhbGwgaXQgd2l0aCBhIGRvbWFpbiB0aGF0J3MgYWxyZWFkeSBpbgogICAgICogQVNDSUkuCiAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpbnB1dCBUaGUgZG9tYWluIG5hbWUgb3IgZW1haWwgYWRkcmVzcyB0byBjb252ZXJ0LCBhcyBhCiAgICAgKiBVbmljb2RlIHN0cmluZy4KICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IFRoZSBQdW55Y29kZSByZXByZXNlbnRhdGlvbiBvZiB0aGUgZ2l2ZW4gZG9tYWluIG5hbWUgb3IKICAgICAqIGVtYWlsIGFkZHJlc3MuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvQVNDSUkoaW5wdXQpIHsKICAgICAgcmV0dXJuIG1hcERvbWFpbihpbnB1dCwgZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgICAgcmV0dXJuIHJlZ2V4Tm9uQVNDSUkudGVzdChzdHJpbmcpCiAgICAgICAgICA/ICd4bi0tJyArIGVuY29kZShzdHJpbmcpCiAgICAgICAgICA6IHN0cmluZzsKICAgICAgfSk7CiAgICB9CiAgCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICAKICAgIC8qKiBEZWZpbmUgdGhlIHB1YmxpYyBBUEkgKi8KICAgIHB1bnljb2RlID0gewogICAgICAvKioKICAgICAgICogQSBzdHJpbmcgcmVwcmVzZW50aW5nIHRoZSBjdXJyZW50IFB1bnljb2RlLmpzIHZlcnNpb24gbnVtYmVyLgogICAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUKICAgICAgICogQHR5cGUgU3RyaW5nCiAgICAgICAqLwogICAgICAndmVyc2lvbic6ICcxLjMuMicsCiAgICAgIC8qKgogICAgICAgKiBBbiBvYmplY3Qgb2YgbWV0aG9kcyB0byBjb252ZXJ0IGZyb20gSmF2YVNjcmlwdCdzIGludGVybmFsIGNoYXJhY3RlcgogICAgICAgKiByZXByZXNlbnRhdGlvbiAoVUNTLTIpIHRvIFVuaWNvZGUgY29kZSBwb2ludHMsIGFuZCBiYWNrLgogICAgICAgKiBAc2VlIDxodHRwczovL21hdGhpYXNieW5lbnMuYmUvbm90ZXMvamF2YXNjcmlwdC1lbmNvZGluZz4KICAgICAgICogQG1lbWJlck9mIHB1bnljb2RlCiAgICAgICAqIEB0eXBlIE9iamVjdAogICAgICAgKi8KICAgICAgJ3VjczInOiB7CiAgICAgICAgJ2RlY29kZSc6IHVjczJkZWNvZGUsCiAgICAgICAgJ2VuY29kZSc6IHVjczJlbmNvZGUKICAgICAgfSwKICAgICAgJ2RlY29kZSc6IGRlY29kZSwKICAgICAgJ2VuY29kZSc6IGVuY29kZSwKICAgICAgJ3RvQVNDSUknOiB0b0FTQ0lJLAogICAgICAndG9Vbmljb2RlJzogdG9Vbmljb2RlCiAgICB9OwogIAogICAgLyoqIEV4cG9zZSBgcHVueWNvZGVgICovCiAgICAvLyBTb21lIEFNRCBidWlsZCBvcHRpbWl6ZXJzLCBsaWtlIHIuanMsIGNoZWNrIGZvciBzcGVjaWZpYyBjb25kaXRpb24gcGF0dGVybnMKICAgIC8vIGxpa2UgdGhlIGZvbGxvd2luZzoKICAgIGlmICgKICAgICAgdHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nICYmCiAgICAgIHR5cGVvZiBkZWZpbmUuYW1kID09ICdvYmplY3QnICYmCiAgICAgIGRlZmluZS5hbWQKICAgICkgewogICAgICBkZWZpbmUoJ3B1bnljb2RlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHB1bnljb2RlOwogICAgICB9KTsKICAgIH0gZWxzZSBpZiAoZnJlZUV4cG9ydHMgJiYgZnJlZU1vZHVsZSkgewogICAgICBpZiAobW9kdWxlLmV4cG9ydHMgPT0gZnJlZUV4cG9ydHMpIHsgLy8gaW4gTm9kZS5qcyBvciBSaW5nb0pTIHYwLjguMCsKICAgICAgICBmcmVlTW9kdWxlLmV4cG9ydHMgPSBwdW55Y29kZTsKICAgICAgfSBlbHNlIHsgLy8gaW4gTmFyd2hhbCBvciBSaW5nb0pTIHYwLjcuMC0KICAgICAgICBmb3IgKGtleSBpbiBwdW55Y29kZSkgewogICAgICAgICAgcHVueWNvZGUuaGFzT3duUHJvcGVydHkoa2V5KSAmJiAoZnJlZUV4cG9ydHNba2V5XSA9IHB1bnljb2RlW2tleV0pOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsgLy8gaW4gUmhpbm8gb3IgYSB3ZWIgYnJvd3NlcgogICAgICByb290LnB1bnljb2RlID0gcHVueWNvZGU7CiAgICB9CiAgCiAgfSh0aGlzKSk7CiAgCiAgfSkuY2FsbCh0aGlzLHR5cGVvZiBnbG9iYWwgIT09ICJ1bmRlZmluZWQiID8gZ2xvYmFsIDogdHlwZW9mIHNlbGYgIT09ICJ1bmRlZmluZWQiID8gc2VsZiA6IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDoge30pCiAgfSx7fV0sODc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgogIC8vCiAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKICAvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiAgLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwogIC8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKICAvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CiAgLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCiAgLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgLy8KICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAogIC8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogIC8vCiAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICAvLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiAgLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgogIC8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAogIC8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgogIC8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKICAvLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogIAogICd1c2Ugc3RyaWN0JzsKICAKICAvLyBJZiBvYmouaGFzT3duUHJvcGVydHkgaGFzIGJlZW4gb3ZlcnJpZGRlbiwgdGhlbiBjYWxsaW5nCiAgLy8gb2JqLmhhc093blByb3BlcnR5KHByb3ApIHdpbGwgYnJlYWsuCiAgLy8gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vam95ZW50L25vZGUvaXNzdWVzLzE3MDcKICBmdW5jdGlvbiBoYXNPd25Qcm9wZXJ0eShvYmosIHByb3ApIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBwcm9wKTsKICB9CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihxcywgc2VwLCBlcSwgb3B0aW9ucykgewogICAgc2VwID0gc2VwIHx8ICcmJzsKICAgIGVxID0gZXEgfHwgJz0nOwogICAgdmFyIG9iaiA9IHt9OwogIAogICAgaWYgKHR5cGVvZiBxcyAhPT0gJ3N0cmluZycgfHwgcXMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBvYmo7CiAgICB9CiAgCiAgICB2YXIgcmVnZXhwID0gL1wrL2c7CiAgICBxcyA9IHFzLnNwbGl0KHNlcCk7CiAgCiAgICB2YXIgbWF4S2V5cyA9IDEwMDA7CiAgICBpZiAob3B0aW9ucyAmJiB0eXBlb2Ygb3B0aW9ucy5tYXhLZXlzID09PSAnbnVtYmVyJykgewogICAgICBtYXhLZXlzID0gb3B0aW9ucy5tYXhLZXlzOwogICAgfQogIAogICAgdmFyIGxlbiA9IHFzLmxlbmd0aDsKICAgIC8vIG1heEtleXMgPD0gMCBtZWFucyB0aGF0IHdlIHNob3VsZCBub3QgbGltaXQga2V5cyBjb3VudAogICAgaWYgKG1heEtleXMgPiAwICYmIGxlbiA+IG1heEtleXMpIHsKICAgICAgbGVuID0gbWF4S2V5czsKICAgIH0KICAKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgICAgdmFyIHggPSBxc1tpXS5yZXBsYWNlKHJlZ2V4cCwgJyUyMCcpLAogICAgICAgICAgaWR4ID0geC5pbmRleE9mKGVxKSwKICAgICAgICAgIGtzdHIsIHZzdHIsIGssIHY7CiAgCiAgICAgIGlmIChpZHggPj0gMCkgewogICAgICAgIGtzdHIgPSB4LnN1YnN0cigwLCBpZHgpOwogICAgICAgIHZzdHIgPSB4LnN1YnN0cihpZHggKyAxKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBrc3RyID0geDsKICAgICAgICB2c3RyID0gJyc7CiAgICAgIH0KICAKICAgICAgayA9IGRlY29kZVVSSUNvbXBvbmVudChrc3RyKTsKICAgICAgdiA9IGRlY29kZVVSSUNvbXBvbmVudCh2c3RyKTsKICAKICAgICAgaWYgKCFoYXNPd25Qcm9wZXJ0eShvYmosIGspKSB7CiAgICAgICAgb2JqW2tdID0gdjsKICAgICAgfSBlbHNlIGlmIChpc0FycmF5KG9ialtrXSkpIHsKICAgICAgICBvYmpba10ucHVzaCh2KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvYmpba10gPSBbb2JqW2tdLCB2XTsKICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIG9iajsKICB9OwogIAogIHZhciBpc0FycmF5ID0gQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiAoeHMpIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoeHMpID09PSAnW29iamVjdCBBcnJheV0nOwogIH07CiAgCiAgfSx7fV0sODg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgogIC8vCiAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKICAvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiAgLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwogIC8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKICAvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CiAgLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCiAgLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgLy8KICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAogIC8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogIC8vCiAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICAvLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiAgLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgogIC8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAogIC8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgogIC8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKICAvLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogIAogICd1c2Ugc3RyaWN0JzsKICAKICB2YXIgc3RyaW5naWZ5UHJpbWl0aXZlID0gZnVuY3Rpb24odikgewogICAgc3dpdGNoICh0eXBlb2YgdikgewogICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgIHJldHVybiB2OwogIAogICAgICBjYXNlICdib29sZWFuJzoKICAgICAgICByZXR1cm4gdiA/ICd0cnVlJyA6ICdmYWxzZSc7CiAgCiAgICAgIGNhc2UgJ251bWJlcic6CiAgICAgICAgcmV0dXJuIGlzRmluaXRlKHYpID8gdiA6ICcnOwogIAogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiAnJzsKICAgIH0KICB9OwogIAogIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ob2JqLCBzZXAsIGVxLCBuYW1lKSB7CiAgICBzZXAgPSBzZXAgfHwgJyYnOwogICAgZXEgPSBlcSB8fCAnPSc7CiAgICBpZiAob2JqID09PSBudWxsKSB7CiAgICAgIG9iaiA9IHVuZGVmaW5lZDsKICAgIH0KICAKICAgIGlmICh0eXBlb2Ygb2JqID09PSAnb2JqZWN0JykgewogICAgICByZXR1cm4gbWFwKG9iamVjdEtleXMob2JqKSwgZnVuY3Rpb24oaykgewogICAgICAgIHZhciBrcyA9IGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUoaykpICsgZXE7CiAgICAgICAgaWYgKGlzQXJyYXkob2JqW2tdKSkgewogICAgICAgICAgcmV0dXJuIG1hcChvYmpba10sIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgcmV0dXJuIGtzICsgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZSh2KSk7CiAgICAgICAgICB9KS5qb2luKHNlcCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBrcyArIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUob2JqW2tdKSk7CiAgICAgICAgfQogICAgICB9KS5qb2luKHNlcCk7CiAgCiAgICB9CiAgCiAgICBpZiAoIW5hbWUpIHJldHVybiAnJzsKICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG5hbWUpKSArIGVxICsKICAgICAgICAgICBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG9iaikpOwogIH07CiAgCiAgdmFyIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5IHx8IGZ1bmN0aW9uICh4cykgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh4cykgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKICAKICBmdW5jdGlvbiBtYXAgKHhzLCBmKSB7CiAgICBpZiAoeHMubWFwKSByZXR1cm4geHMubWFwKGYpOwogICAgdmFyIHJlcyA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB4cy5sZW5ndGg7IGkrKykgewogICAgICByZXMucHVzaChmKHhzW2ldLCBpKSk7CiAgICB9CiAgICByZXR1cm4gcmVzOwogIH0KICAKICB2YXIgb2JqZWN0S2V5cyA9IE9iamVjdC5rZXlzIHx8IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciByZXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHJlcy5wdXNoKGtleSk7CiAgICB9CiAgICByZXR1cm4gcmVzOwogIH07CiAgCiAgfSx7fV0sODk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogICd1c2Ugc3RyaWN0JzsKICAKICBleHBvcnRzLmRlY29kZSA9IGV4cG9ydHMucGFyc2UgPSByZXF1aXJlKCcuL2RlY29kZScpOwogIGV4cG9ydHMuZW5jb2RlID0gZXhwb3J0cy5zdHJpbmdpZnkgPSByZXF1aXJlKCcuL2VuY29kZScpOwogIAogIH0seyIuL2RlY29kZSI6ODcsIi4vZW5jb2RlIjo4OH1dLDkwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KICAvLwogIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCiAgLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQogIC8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKICAvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCiAgLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAogIC8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQogIC8vIGZvbGxvd2luZyBjb25kaXRpb25zOgogIC8vCiAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKICAvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAvLwogIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAgLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogIC8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KICAvLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKICAvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKICAvLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCiAgLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICAKICAndXNlIHN0cmljdCc7CiAgCiAgLy8gSWYgb2JqLmhhc093blByb3BlcnR5IGhhcyBiZWVuIG92ZXJyaWRkZW4sIHRoZW4gY2FsbGluZwogIC8vIG9iai5oYXNPd25Qcm9wZXJ0eShwcm9wKSB3aWxsIGJyZWFrLgogIC8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2pveWVudC9ub2RlL2lzc3Vlcy8xNzA3CiAgZnVuY3Rpb24gaGFzT3duUHJvcGVydHkob2JqLCBwcm9wKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCk7CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ocXMsIHNlcCwgZXEsIG9wdGlvbnMpIHsKICAgIHNlcCA9IHNlcCB8fCAnJic7CiAgICBlcSA9IGVxIHx8ICc9JzsKICAgIHZhciBvYmogPSB7fTsKICAKICAgIGlmICh0eXBlb2YgcXMgIT09ICdzdHJpbmcnIHx8IHFzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gb2JqOwogICAgfQogIAogICAgdmFyIHJlZ2V4cCA9IC9cKy9nOwogICAgcXMgPSBxcy5zcGxpdChzZXApOwogIAogICAgdmFyIG1heEtleXMgPSAxMDAwOwogICAgaWYgKG9wdGlvbnMgJiYgdHlwZW9mIG9wdGlvbnMubWF4S2V5cyA9PT0gJ251bWJlcicpIHsKICAgICAgbWF4S2V5cyA9IG9wdGlvbnMubWF4S2V5czsKICAgIH0KICAKICAgIHZhciBsZW4gPSBxcy5sZW5ndGg7CiAgICAvLyBtYXhLZXlzIDw9IDAgbWVhbnMgdGhhdCB3ZSBzaG91bGQgbm90IGxpbWl0IGtleXMgY291bnQKICAgIGlmIChtYXhLZXlzID4gMCAmJiBsZW4gPiBtYXhLZXlzKSB7CiAgICAgIGxlbiA9IG1heEtleXM7CiAgICB9CiAgCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIHZhciB4ID0gcXNbaV0ucmVwbGFjZShyZWdleHAsICclMjAnKSwKICAgICAgICAgIGlkeCA9IHguaW5kZXhPZihlcSksCiAgICAgICAgICBrc3RyLCB2c3RyLCBrLCB2OwogIAogICAgICBpZiAoaWR4ID49IDApIHsKICAgICAgICBrc3RyID0geC5zdWJzdHIoMCwgaWR4KTsKICAgICAgICB2c3RyID0geC5zdWJzdHIoaWR4ICsgMSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAga3N0ciA9IHg7CiAgICAgICAgdnN0ciA9ICcnOwogICAgICB9CiAgCiAgICAgIGsgPSBkZWNvZGVVUklDb21wb25lbnQoa3N0cik7CiAgICAgIHYgPSBkZWNvZGVVUklDb21wb25lbnQodnN0cik7CiAgCiAgICAgIGlmICghaGFzT3duUHJvcGVydHkob2JqLCBrKSkgewogICAgICAgIG9ialtrXSA9IHY7CiAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShvYmpba10pKSB7CiAgICAgICAgb2JqW2tdLnB1c2godik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb2JqW2tdID0gW29ialtrXSwgdl07CiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiBvYmo7CiAgfTsKICAKICB9LHt9XSw5MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCiAgLy8KICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQogIC8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKICAvLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCiAgLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAogIC8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKICAvLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKICAvLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAvLwogIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCiAgLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgLy8KICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwogIC8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICAvLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCiAgLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCiAgLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCiAgLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQogIC8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiAgCiAgJ3VzZSBzdHJpY3QnOwogIAogIHZhciBzdHJpbmdpZnlQcmltaXRpdmUgPSBmdW5jdGlvbih2KSB7CiAgICBzd2l0Y2ggKHR5cGVvZiB2KSB7CiAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgcmV0dXJuIHY7CiAgCiAgICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICAgIHJldHVybiB2ID8gJ3RydWUnIDogJ2ZhbHNlJzsKICAKICAgICAgY2FzZSAnbnVtYmVyJzoKICAgICAgICByZXR1cm4gaXNGaW5pdGUodikgPyB2IDogJyc7CiAgCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuICcnOwogICAgfQogIH07CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihvYmosIHNlcCwgZXEsIG5hbWUpIHsKICAgIHNlcCA9IHNlcCB8fCAnJic7CiAgICBlcSA9IGVxIHx8ICc9JzsKICAgIGlmIChvYmogPT09IG51bGwpIHsKICAgICAgb2JqID0gdW5kZWZpbmVkOwogICAgfQogIAogICAgaWYgKHR5cGVvZiBvYmogPT09ICdvYmplY3QnKSB7CiAgICAgIHJldHVybiBPYmplY3Qua2V5cyhvYmopLm1hcChmdW5jdGlvbihrKSB7CiAgICAgICAgdmFyIGtzID0gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShrKSkgKyBlcTsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShvYmpba10pKSB7CiAgICAgICAgICByZXR1cm4gb2JqW2tdLm1hcChmdW5jdGlvbih2KSB7CiAgICAgICAgICAgIHJldHVybiBrcyArIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUodikpOwogICAgICAgICAgfSkuam9pbihzZXApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4ga3MgKyBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG9ialtrXSkpOwogICAgICAgIH0KICAgICAgfSkuam9pbihzZXApOwogIAogICAgfQogIAogICAgaWYgKCFuYW1lKSByZXR1cm4gJyc7CiAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShuYW1lKSkgKyBlcSArCiAgICAgICAgICAgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShvYmopKTsKICB9OwogIAogIH0se31dLDkyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBhcmd1bWVudHNbNF1bODldWzBdLmFwcGx5KGV4cG9ydHMsYXJndW1lbnRzKQogIH0seyIuL2RlY29kZSI6OTAsIi4vZW5jb2RlIjo5MSwiZHVwIjo4OX1dLDkzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKHNldEltbWVkaWF0ZSxjbGVhckltbWVkaWF0ZSl7CiAgdmFyIG5leHRUaWNrID0gcmVxdWlyZSgncHJvY2Vzcy9icm93c2VyLmpzJykubmV4dFRpY2s7CiAgdmFyIGFwcGx5ID0gRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5OwogIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICB2YXIgaW1tZWRpYXRlSWRzID0ge307CiAgdmFyIG5leHRJbW1lZGlhdGVJZCA9IDA7CiAgCiAgLy8gRE9NIEFQSXMsIGZvciBjb21wbGV0ZW5lc3MKICAKICBleHBvcnRzLnNldFRpbWVvdXQgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBuZXcgVGltZW91dChhcHBseS5jYWxsKHNldFRpbWVvdXQsIHdpbmRvdywgYXJndW1lbnRzKSwgY2xlYXJUaW1lb3V0KTsKICB9OwogIGV4cG9ydHMuc2V0SW50ZXJ2YWwgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBuZXcgVGltZW91dChhcHBseS5jYWxsKHNldEludGVydmFsLCB3aW5kb3csIGFyZ3VtZW50cyksIGNsZWFySW50ZXJ2YWwpOwogIH07CiAgZXhwb3J0cy5jbGVhclRpbWVvdXQgPQogIGV4cG9ydHMuY2xlYXJJbnRlcnZhbCA9IGZ1bmN0aW9uKHRpbWVvdXQpIHsgdGltZW91dC5jbG9zZSgpOyB9OwogIAogIGZ1bmN0aW9uIFRpbWVvdXQoaWQsIGNsZWFyRm4pIHsKICAgIHRoaXMuX2lkID0gaWQ7CiAgICB0aGlzLl9jbGVhckZuID0gY2xlYXJGbjsKICB9CiAgVGltZW91dC5wcm90b3R5cGUudW5yZWYgPSBUaW1lb3V0LnByb3RvdHlwZS5yZWYgPSBmdW5jdGlvbigpIHt9OwogIFRpbWVvdXQucHJvdG90eXBlLmNsb3NlID0gZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9jbGVhckZuLmNhbGwod2luZG93LCB0aGlzLl9pZCk7CiAgfTsKICAKICAvLyBEb2VzIG5vdCBzdGFydCB0aGUgdGltZSwganVzdCBzZXRzIHVwIHRoZSBtZW1iZXJzIG5lZWRlZC4KICBleHBvcnRzLmVucm9sbCA9IGZ1bmN0aW9uKGl0ZW0sIG1zZWNzKSB7CiAgICBjbGVhclRpbWVvdXQoaXRlbS5faWRsZVRpbWVvdXRJZCk7CiAgICBpdGVtLl9pZGxlVGltZW91dCA9IG1zZWNzOwogIH07CiAgCiAgZXhwb3J0cy51bmVucm9sbCA9IGZ1bmN0aW9uKGl0ZW0pIHsKICAgIGNsZWFyVGltZW91dChpdGVtLl9pZGxlVGltZW91dElkKTsKICAgIGl0ZW0uX2lkbGVUaW1lb3V0ID0gLTE7CiAgfTsKICAKICBleHBvcnRzLl91bnJlZkFjdGl2ZSA9IGV4cG9ydHMuYWN0aXZlID0gZnVuY3Rpb24oaXRlbSkgewogICAgY2xlYXJUaW1lb3V0KGl0ZW0uX2lkbGVUaW1lb3V0SWQpOwogIAogICAgdmFyIG1zZWNzID0gaXRlbS5faWRsZVRpbWVvdXQ7CiAgICBpZiAobXNlY3MgPj0gMCkgewogICAgICBpdGVtLl9pZGxlVGltZW91dElkID0gc2V0VGltZW91dChmdW5jdGlvbiBvblRpbWVvdXQoKSB7CiAgICAgICAgaWYgKGl0ZW0uX29uVGltZW91dCkKICAgICAgICAgIGl0ZW0uX29uVGltZW91dCgpOwogICAgICB9LCBtc2Vjcyk7CiAgICB9CiAgfTsKICAKICAvLyBUaGF0J3Mgbm90IGhvdyBub2RlLmpzIGltcGxlbWVudHMgaXQgYnV0IHRoZSBleHBvc2VkIGFwaSBpcyB0aGUgc2FtZS4KICBleHBvcnRzLnNldEltbWVkaWF0ZSA9IHR5cGVvZiBzZXRJbW1lZGlhdGUgPT09ICJmdW5jdGlvbiIgPyBzZXRJbW1lZGlhdGUgOiBmdW5jdGlvbihmbikgewogICAgdmFyIGlkID0gbmV4dEltbWVkaWF0ZUlkKys7CiAgICB2YXIgYXJncyA9IGFyZ3VtZW50cy5sZW5ndGggPCAyID8gZmFsc2UgOiBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgCiAgICBpbW1lZGlhdGVJZHNbaWRdID0gdHJ1ZTsKICAKICAgIG5leHRUaWNrKGZ1bmN0aW9uIG9uTmV4dFRpY2soKSB7CiAgICAgIGlmIChpbW1lZGlhdGVJZHNbaWRdKSB7CiAgICAgICAgLy8gZm4uY2FsbCgpIGlzIGZhc3RlciBzbyB3ZSBvcHRpbWl6ZSBmb3IgdGhlIGNvbW1vbiB1c2UtY2FzZQogICAgICAgIC8vIEBzZWUgaHR0cDovL2pzcGVyZi5jb20vY2FsbC1hcHBseS1zZWd1CiAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgIGZuLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmbi5jYWxsKG51bGwpOwogICAgICAgIH0KICAgICAgICAvLyBQcmV2ZW50IGlkcyBmcm9tIGxlYWtpbmcKICAgICAgICBleHBvcnRzLmNsZWFySW1tZWRpYXRlKGlkKTsKICAgICAgfQogICAgfSk7CiAgCiAgICByZXR1cm4gaWQ7CiAgfTsKICAKICBleHBvcnRzLmNsZWFySW1tZWRpYXRlID0gdHlwZW9mIGNsZWFySW1tZWRpYXRlID09PSAiZnVuY3Rpb24iID8gY2xlYXJJbW1lZGlhdGUgOiBmdW5jdGlvbihpZCkgewogICAgZGVsZXRlIGltbWVkaWF0ZUlkc1tpZF07CiAgfTsKICB9KS5jYWxsKHRoaXMscmVxdWlyZSgidGltZXJzIikuc2V0SW1tZWRpYXRlLHJlcXVpcmUoInRpbWVycyIpLmNsZWFySW1tZWRpYXRlKQogIH0seyJwcm9jZXNzL2Jyb3dzZXIuanMiOjg1LCJ0aW1lcnMiOjkzfV0sOTQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgogIC8vCiAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKICAvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiAgLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwogIC8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKICAvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CiAgLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCiAgLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgLy8KICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAogIC8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogIC8vCiAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICAvLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiAgLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgogIC8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAogIC8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgogIC8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKICAvLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogIAogIHZhciBwdW55Y29kZSA9IHJlcXVpcmUoJ3B1bnljb2RlJyk7CiAgCiAgZXhwb3J0cy5wYXJzZSA9IHVybFBhcnNlOwogIGV4cG9ydHMucmVzb2x2ZSA9IHVybFJlc29sdmU7CiAgZXhwb3J0cy5yZXNvbHZlT2JqZWN0ID0gdXJsUmVzb2x2ZU9iamVjdDsKICBleHBvcnRzLmZvcm1hdCA9IHVybEZvcm1hdDsKICAKICBleHBvcnRzLlVybCA9IFVybDsKICAKICBmdW5jdGlvbiBVcmwoKSB7CiAgICB0aGlzLnByb3RvY29sID0gbnVsbDsKICAgIHRoaXMuc2xhc2hlcyA9IG51bGw7CiAgICB0aGlzLmF1dGggPSBudWxsOwogICAgdGhpcy5ob3N0ID0gbnVsbDsKICAgIHRoaXMucG9ydCA9IG51bGw7CiAgICB0aGlzLmhvc3RuYW1lID0gbnVsbDsKICAgIHRoaXMuaGFzaCA9IG51bGw7CiAgICB0aGlzLnNlYXJjaCA9IG51bGw7CiAgICB0aGlzLnF1ZXJ5ID0gbnVsbDsKICAgIHRoaXMucGF0aG5hbWUgPSBudWxsOwogICAgdGhpcy5wYXRoID0gbnVsbDsKICAgIHRoaXMuaHJlZiA9IG51bGw7CiAgfQogIAogIC8vIFJlZmVyZW5jZTogUkZDIDM5ODYsIFJGQyAxODA4LCBSRkMgMjM5NgogIAogIC8vIGRlZmluZSB0aGVzZSBoZXJlIHNvIGF0IGxlYXN0IHRoZXkgb25seSBoYXZlIHRvIGJlCiAgLy8gY29tcGlsZWQgb25jZSBvbiB0aGUgZmlyc3QgbW9kdWxlIGxvYWQuCiAgdmFyIHByb3RvY29sUGF0dGVybiA9IC9eKFthLXowLTkuKy1dKzopL2ksCiAgICAgIHBvcnRQYXR0ZXJuID0gLzpbMC05XSokLywKICAKICAgICAgLy8gUkZDIDIzOTY6IGNoYXJhY3RlcnMgcmVzZXJ2ZWQgZm9yIGRlbGltaXRpbmcgVVJMcy4KICAgICAgLy8gV2UgYWN0dWFsbHkganVzdCBhdXRvLWVzY2FwZSB0aGVzZS4KICAgICAgZGVsaW1zID0gWyc8JywgJz4nLCAnIicsICdgJywgJyAnLCAnXHInLCAnXG4nLCAnXHQnXSwKICAKICAgICAgLy8gUkZDIDIzOTY6IGNoYXJhY3RlcnMgbm90IGFsbG93ZWQgZm9yIHZhcmlvdXMgcmVhc29ucy4KICAgICAgdW53aXNlID0gWyd7JywgJ30nLCAnfCcsICdcXCcsICdeJywgJ2AnXS5jb25jYXQoZGVsaW1zKSwKICAKICAgICAgLy8gQWxsb3dlZCBieSBSRkNzLCBidXQgY2F1c2Ugb2YgWFNTIGF0dGFja3MuICBBbHdheXMgZXNjYXBlIHRoZXNlLgogICAgICBhdXRvRXNjYXBlID0gWydcJyddLmNvbmNhdCh1bndpc2UpLAogICAgICAvLyBDaGFyYWN0ZXJzIHRoYXQgYXJlIG5ldmVyIGV2ZXIgYWxsb3dlZCBpbiBhIGhvc3RuYW1lLgogICAgICAvLyBOb3RlIHRoYXQgYW55IGludmFsaWQgY2hhcnMgYXJlIGFsc28gaGFuZGxlZCwgYnV0IHRoZXNlCiAgICAgIC8vIGFyZSB0aGUgb25lcyB0aGF0IGFyZSAqZXhwZWN0ZWQqIHRvIGJlIHNlZW4sIHNvIHdlIGZhc3QtcGF0aAogICAgICAvLyB0aGVtLgogICAgICBub25Ib3N0Q2hhcnMgPSBbJyUnLCAnLycsICc/JywgJzsnLCAnIyddLmNvbmNhdChhdXRvRXNjYXBlKSwKICAgICAgaG9zdEVuZGluZ0NoYXJzID0gWycvJywgJz8nLCAnIyddLAogICAgICBob3N0bmFtZU1heExlbiA9IDI1NSwKICAgICAgaG9zdG5hbWVQYXJ0UGF0dGVybiA9IC9eW2EtejAtOUEtWl8tXXswLDYzfSQvLAogICAgICBob3N0bmFtZVBhcnRTdGFydCA9IC9eKFthLXowLTlBLVpfLV17MCw2M30pKC4qKSQvLAogICAgICAvLyBwcm90b2NvbHMgdGhhdCBjYW4gYWxsb3cgInVuc2FmZSIgYW5kICJ1bndpc2UiIGNoYXJzLgogICAgICB1bnNhZmVQcm90b2NvbCA9IHsKICAgICAgICAnamF2YXNjcmlwdCc6IHRydWUsCiAgICAgICAgJ2phdmFzY3JpcHQ6JzogdHJ1ZQogICAgICB9LAogICAgICAvLyBwcm90b2NvbHMgdGhhdCBuZXZlciBoYXZlIGEgaG9zdG5hbWUuCiAgICAgIGhvc3RsZXNzUHJvdG9jb2wgPSB7CiAgICAgICAgJ2phdmFzY3JpcHQnOiB0cnVlLAogICAgICAgICdqYXZhc2NyaXB0Oic6IHRydWUKICAgICAgfSwKICAgICAgLy8gcHJvdG9jb2xzIHRoYXQgYWx3YXlzIGNvbnRhaW4gYSAvLyBiaXQuCiAgICAgIHNsYXNoZWRQcm90b2NvbCA9IHsKICAgICAgICAnaHR0cCc6IHRydWUsCiAgICAgICAgJ2h0dHBzJzogdHJ1ZSwKICAgICAgICAnZnRwJzogdHJ1ZSwKICAgICAgICAnZ29waGVyJzogdHJ1ZSwKICAgICAgICAnZmlsZSc6IHRydWUsCiAgICAgICAgJ2h0dHA6JzogdHJ1ZSwKICAgICAgICAnaHR0cHM6JzogdHJ1ZSwKICAgICAgICAnZnRwOic6IHRydWUsCiAgICAgICAgJ2dvcGhlcjonOiB0cnVlLAogICAgICAgICdmaWxlOic6IHRydWUKICAgICAgfSwKICAgICAgcXVlcnlzdHJpbmcgPSByZXF1aXJlKCdxdWVyeXN0cmluZycpOwogIAogIGZ1bmN0aW9uIHVybFBhcnNlKHVybCwgcGFyc2VRdWVyeVN0cmluZywgc2xhc2hlc0Rlbm90ZUhvc3QpIHsKICAgIGlmICh1cmwgJiYgaXNPYmplY3QodXJsKSAmJiB1cmwgaW5zdGFuY2VvZiBVcmwpIHJldHVybiB1cmw7CiAgCiAgICB2YXIgdSA9IG5ldyBVcmw7CiAgICB1LnBhcnNlKHVybCwgcGFyc2VRdWVyeVN0cmluZywgc2xhc2hlc0Rlbm90ZUhvc3QpOwogICAgcmV0dXJuIHU7CiAgfQogIAogIFVybC5wcm90b3R5cGUucGFyc2UgPSBmdW5jdGlvbih1cmwsIHBhcnNlUXVlcnlTdHJpbmcsIHNsYXNoZXNEZW5vdGVIb3N0KSB7CiAgICBpZiAoIWlzU3RyaW5nKHVybCkpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiUGFyYW1ldGVyICd1cmwnIG11c3QgYmUgYSBzdHJpbmcsIG5vdCAiICsgdHlwZW9mIHVybCk7CiAgICB9CiAgCiAgICB2YXIgcmVzdCA9IHVybDsKICAKICAgIC8vIHRyaW0gYmVmb3JlIHByb2NlZWRpbmcuCiAgICAvLyBUaGlzIGlzIHRvIHN1cHBvcnQgcGFyc2Ugc3R1ZmYgbGlrZSAiICBodHRwOi8vZm9vLmNvbSAgXG4iCiAgICByZXN0ID0gcmVzdC50cmltKCk7CiAgCiAgICB2YXIgcHJvdG8gPSBwcm90b2NvbFBhdHRlcm4uZXhlYyhyZXN0KTsKICAgIGlmIChwcm90bykgewogICAgICBwcm90byA9IHByb3RvWzBdOwogICAgICB2YXIgbG93ZXJQcm90byA9IHByb3RvLnRvTG93ZXJDYXNlKCk7CiAgICAgIHRoaXMucHJvdG9jb2wgPSBsb3dlclByb3RvOwogICAgICByZXN0ID0gcmVzdC5zdWJzdHIocHJvdG8ubGVuZ3RoKTsKICAgIH0KICAKICAgIC8vIGZpZ3VyZSBvdXQgaWYgaXQncyBnb3QgYSBob3N0CiAgICAvLyB1c2VyQHNlcnZlciBpcyAqYWx3YXlzKiBpbnRlcnByZXRlZCBhcyBhIGhvc3RuYW1lLCBhbmQgdXJsCiAgICAvLyByZXNvbHV0aW9uIHdpbGwgdHJlYXQgLy9mb28vYmFyIGFzIGhvc3Q9Zm9vLHBhdGg9YmFyIGJlY2F1c2UgdGhhdCdzCiAgICAvLyBob3cgdGhlIGJyb3dzZXIgcmVzb2x2ZXMgcmVsYXRpdmUgVVJMcy4KICAgIGlmIChzbGFzaGVzRGVub3RlSG9zdCB8fCBwcm90byB8fCByZXN0Lm1hdGNoKC9eXC9cL1teQFwvXStAW15AXC9dKy8pKSB7CiAgICAgIHZhciBzbGFzaGVzID0gcmVzdC5zdWJzdHIoMCwgMikgPT09ICcvLyc7CiAgICAgIGlmIChzbGFzaGVzICYmICEocHJvdG8gJiYgaG9zdGxlc3NQcm90b2NvbFtwcm90b10pKSB7CiAgICAgICAgcmVzdCA9IHJlc3Quc3Vic3RyKDIpOwogICAgICAgIHRoaXMuc2xhc2hlcyA9IHRydWU7CiAgICAgIH0KICAgIH0KICAKICAgIGlmICghaG9zdGxlc3NQcm90b2NvbFtwcm90b10gJiYKICAgICAgICAoc2xhc2hlcyB8fCAocHJvdG8gJiYgIXNsYXNoZWRQcm90b2NvbFtwcm90b10pKSkgewogIAogICAgICAvLyB0aGVyZSdzIGEgaG9zdG5hbWUuCiAgICAgIC8vIHRoZSBmaXJzdCBpbnN0YW5jZSBvZiAvLCA/LCA7LCBvciAjIGVuZHMgdGhlIGhvc3QuCiAgICAgIC8vCiAgICAgIC8vIElmIHRoZXJlIGlzIGFuIEAgaW4gdGhlIGhvc3RuYW1lLCB0aGVuIG5vbi1ob3N0IGNoYXJzICphcmUqIGFsbG93ZWQKICAgICAgLy8gdG8gdGhlIGxlZnQgb2YgdGhlIGxhc3QgQCBzaWduLCB1bmxlc3Mgc29tZSBob3N0LWVuZGluZyBjaGFyYWN0ZXIKICAgICAgLy8gY29tZXMgKmJlZm9yZSogdGhlIEAtc2lnbi4KICAgICAgLy8gVVJMcyBhcmUgb2Jub3hpb3VzLgogICAgICAvLwogICAgICAvLyBleDoKICAgICAgLy8gaHR0cDovL2FAYkBjLyA9PiB1c2VyOmFAYiBob3N0OmMKICAgICAgLy8gaHR0cDovL2FAYj9AYyA9PiB1c2VyOmEgaG9zdDpjIHBhdGg6Lz9AYwogIAogICAgICAvLyB2MC4xMiBUT0RPKGlzYWFjcyk6IFRoaXMgaXMgbm90IHF1aXRlIGhvdyBDaHJvbWUgZG9lcyB0aGluZ3MuCiAgICAgIC8vIFJldmlldyBvdXIgdGVzdCBjYXNlIGFnYWluc3QgYnJvd3NlcnMgbW9yZSBjb21wcmVoZW5zaXZlbHkuCiAgCiAgICAgIC8vIGZpbmQgdGhlIGZpcnN0IGluc3RhbmNlIG9mIGFueSBob3N0RW5kaW5nQ2hhcnMKICAgICAgdmFyIGhvc3RFbmQgPSAtMTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBob3N0RW5kaW5nQ2hhcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgaGVjID0gcmVzdC5pbmRleE9mKGhvc3RFbmRpbmdDaGFyc1tpXSk7CiAgICAgICAgaWYgKGhlYyAhPT0gLTEgJiYgKGhvc3RFbmQgPT09IC0xIHx8IGhlYyA8IGhvc3RFbmQpKQogICAgICAgICAgaG9zdEVuZCA9IGhlYzsKICAgICAgfQogIAogICAgICAvLyBhdCB0aGlzIHBvaW50LCBlaXRoZXIgd2UgaGF2ZSBhbiBleHBsaWNpdCBwb2ludCB3aGVyZSB0aGUKICAgICAgLy8gYXV0aCBwb3J0aW9uIGNhbm5vdCBnbyBwYXN0LCBvciB0aGUgbGFzdCBAIGNoYXIgaXMgdGhlIGRlY2lkZXIuCiAgICAgIHZhciBhdXRoLCBhdFNpZ247CiAgICAgIGlmIChob3N0RW5kID09PSAtMSkgewogICAgICAgIC8vIGF0U2lnbiBjYW4gYmUgYW55d2hlcmUuCiAgICAgICAgYXRTaWduID0gcmVzdC5sYXN0SW5kZXhPZignQCcpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGF0U2lnbiBtdXN0IGJlIGluIGF1dGggcG9ydGlvbi4KICAgICAgICAvLyBodHRwOi8vYUBiL2NAZCA9PiBob3N0OmIgYXV0aDphIHBhdGg6L2NAZAogICAgICAgIGF0U2lnbiA9IHJlc3QubGFzdEluZGV4T2YoJ0AnLCBob3N0RW5kKTsKICAgICAgfQogIAogICAgICAvLyBOb3cgd2UgaGF2ZSBhIHBvcnRpb24gd2hpY2ggaXMgZGVmaW5pdGVseSB0aGUgYXV0aC4KICAgICAgLy8gUHVsbCB0aGF0IG9mZi4KICAgICAgaWYgKGF0U2lnbiAhPT0gLTEpIHsKICAgICAgICBhdXRoID0gcmVzdC5zbGljZSgwLCBhdFNpZ24pOwogICAgICAgIHJlc3QgPSByZXN0LnNsaWNlKGF0U2lnbiArIDEpOwogICAgICAgIHRoaXMuYXV0aCA9IGRlY29kZVVSSUNvbXBvbmVudChhdXRoKTsKICAgICAgfQogIAogICAgICAvLyB0aGUgaG9zdCBpcyB0aGUgcmVtYWluaW5nIHRvIHRoZSBsZWZ0IG9mIHRoZSBmaXJzdCBub24taG9zdCBjaGFyCiAgICAgIGhvc3RFbmQgPSAtMTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub25Ib3N0Q2hhcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgaGVjID0gcmVzdC5pbmRleE9mKG5vbkhvc3RDaGFyc1tpXSk7CiAgICAgICAgaWYgKGhlYyAhPT0gLTEgJiYgKGhvc3RFbmQgPT09IC0xIHx8IGhlYyA8IGhvc3RFbmQpKQogICAgICAgICAgaG9zdEVuZCA9IGhlYzsKICAgICAgfQogICAgICAvLyBpZiB3ZSBzdGlsbCBoYXZlIG5vdCBoaXQgaXQsIHRoZW4gdGhlIGVudGlyZSB0aGluZyBpcyBhIGhvc3QuCiAgICAgIGlmIChob3N0RW5kID09PSAtMSkKICAgICAgICBob3N0RW5kID0gcmVzdC5sZW5ndGg7CiAgCiAgICAgIHRoaXMuaG9zdCA9IHJlc3Quc2xpY2UoMCwgaG9zdEVuZCk7CiAgICAgIHJlc3QgPSByZXN0LnNsaWNlKGhvc3RFbmQpOwogIAogICAgICAvLyBwdWxsIG91dCBwb3J0LgogICAgICB0aGlzLnBhcnNlSG9zdCgpOwogIAogICAgICAvLyB3ZSd2ZSBpbmRpY2F0ZWQgdGhhdCB0aGVyZSBpcyBhIGhvc3RuYW1lLAogICAgICAvLyBzbyBldmVuIGlmIGl0J3MgZW1wdHksIGl0IGhhcyB0byBiZSBwcmVzZW50LgogICAgICB0aGlzLmhvc3RuYW1lID0gdGhpcy5ob3N0bmFtZSB8fCAnJzsKICAKICAgICAgLy8gaWYgaG9zdG5hbWUgYmVnaW5zIHdpdGggWyBhbmQgZW5kcyB3aXRoIF0KICAgICAgLy8gYXNzdW1lIHRoYXQgaXQncyBhbiBJUHY2IGFkZHJlc3MuCiAgICAgIHZhciBpcHY2SG9zdG5hbWUgPSB0aGlzLmhvc3RuYW1lWzBdID09PSAnWycgJiYKICAgICAgICAgIHRoaXMuaG9zdG5hbWVbdGhpcy5ob3N0bmFtZS5sZW5ndGggLSAxXSA9PT0gJ10nOwogIAogICAgICAvLyB2YWxpZGF0ZSBhIGxpdHRsZS4KICAgICAgaWYgKCFpcHY2SG9zdG5hbWUpIHsKICAgICAgICB2YXIgaG9zdHBhcnRzID0gdGhpcy5ob3N0bmFtZS5zcGxpdCgvXC4vKTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGhvc3RwYXJ0cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHZhciBwYXJ0ID0gaG9zdHBhcnRzW2ldOwogICAgICAgICAgaWYgKCFwYXJ0KSBjb250aW51ZTsKICAgICAgICAgIGlmICghcGFydC5tYXRjaChob3N0bmFtZVBhcnRQYXR0ZXJuKSkgewogICAgICAgICAgICB2YXIgbmV3cGFydCA9ICcnOwogICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgayA9IHBhcnQubGVuZ3RoOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgICAgaWYgKHBhcnQuY2hhckNvZGVBdChqKSA+IDEyNykgewogICAgICAgICAgICAgICAgLy8gd2UgcmVwbGFjZSBub24tQVNDSUkgY2hhciB3aXRoIGEgdGVtcG9yYXJ5IHBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRoaXMgdG8gbWFrZSBzdXJlIHNpemUgb2YgaG9zdG5hbWUgaXMgbm90CiAgICAgICAgICAgICAgICAvLyBicm9rZW4gYnkgcmVwbGFjaW5nIG5vbi1BU0NJSSBieSBub3RoaW5nCiAgICAgICAgICAgICAgICBuZXdwYXJ0ICs9ICd4JzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV3cGFydCArPSBwYXJ0W2pdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyB3ZSB0ZXN0IGFnYWluIHdpdGggQVNDSUkgY2hhciBvbmx5CiAgICAgICAgICAgIGlmICghbmV3cGFydC5tYXRjaChob3N0bmFtZVBhcnRQYXR0ZXJuKSkgewogICAgICAgICAgICAgIHZhciB2YWxpZFBhcnRzID0gaG9zdHBhcnRzLnNsaWNlKDAsIGkpOwogICAgICAgICAgICAgIHZhciBub3RIb3N0ID0gaG9zdHBhcnRzLnNsaWNlKGkgKyAxKTsKICAgICAgICAgICAgICB2YXIgYml0ID0gcGFydC5tYXRjaChob3N0bmFtZVBhcnRTdGFydCk7CiAgICAgICAgICAgICAgaWYgKGJpdCkgewogICAgICAgICAgICAgICAgdmFsaWRQYXJ0cy5wdXNoKGJpdFsxXSk7CiAgICAgICAgICAgICAgICBub3RIb3N0LnVuc2hpZnQoYml0WzJdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vdEhvc3QubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICByZXN0ID0gJy8nICsgbm90SG9zdC5qb2luKCcuJykgKyByZXN0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmhvc3RuYW1lID0gdmFsaWRQYXJ0cy5qb2luKCcuJyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAKICAgICAgaWYgKHRoaXMuaG9zdG5hbWUubGVuZ3RoID4gaG9zdG5hbWVNYXhMZW4pIHsKICAgICAgICB0aGlzLmhvc3RuYW1lID0gJyc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gaG9zdG5hbWVzIGFyZSBhbHdheXMgbG93ZXIgY2FzZS4KICAgICAgICB0aGlzLmhvc3RuYW1lID0gdGhpcy5ob3N0bmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICB9CiAgCiAgICAgIGlmICghaXB2Nkhvc3RuYW1lKSB7CiAgICAgICAgLy8gSUROQSBTdXBwb3J0OiBSZXR1cm5zIGEgcHVueSBjb2RlZCByZXByZXNlbnRhdGlvbiBvZiAiZG9tYWluIi4KICAgICAgICAvLyBJdCBvbmx5IGNvbnZlcnRzIHRoZSBwYXJ0IG9mIHRoZSBkb21haW4gbmFtZSB0aGF0CiAgICAgICAgLy8gaGFzIG5vbiBBU0NJSSBjaGFyYWN0ZXJzLiBJLmUuIGl0IGRvc2VudCBtYXR0ZXIgaWYKICAgICAgICAvLyB5b3UgY2FsbCBpdCB3aXRoIGEgZG9tYWluIHRoYXQgYWxyZWFkeSBpcyBpbiBBU0NJSS4KICAgICAgICB2YXIgZG9tYWluQXJyYXkgPSB0aGlzLmhvc3RuYW1lLnNwbGl0KCcuJyk7CiAgICAgICAgdmFyIG5ld091dCA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZG9tYWluQXJyYXkubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIHZhciBzID0gZG9tYWluQXJyYXlbaV07CiAgICAgICAgICBuZXdPdXQucHVzaChzLm1hdGNoKC9bXkEtWmEtejAtOV8tXS8pID8KICAgICAgICAgICAgICAneG4tLScgKyBwdW55Y29kZS5lbmNvZGUocykgOiBzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5ob3N0bmFtZSA9IG5ld091dC5qb2luKCcuJyk7CiAgICAgIH0KICAKICAgICAgdmFyIHAgPSB0aGlzLnBvcnQgPyAnOicgKyB0aGlzLnBvcnQgOiAnJzsKICAgICAgdmFyIGggPSB0aGlzLmhvc3RuYW1lIHx8ICcnOwogICAgICB0aGlzLmhvc3QgPSBoICsgcDsKICAgICAgdGhpcy5ocmVmICs9IHRoaXMuaG9zdDsKICAKICAgICAgLy8gc3RyaXAgWyBhbmQgXSBmcm9tIHRoZSBob3N0bmFtZQogICAgICAvLyB0aGUgaG9zdCBmaWVsZCBzdGlsbCByZXRhaW5zIHRoZW0sIHRob3VnaAogICAgICBpZiAoaXB2Nkhvc3RuYW1lKSB7CiAgICAgICAgdGhpcy5ob3N0bmFtZSA9IHRoaXMuaG9zdG5hbWUuc3Vic3RyKDEsIHRoaXMuaG9zdG5hbWUubGVuZ3RoIC0gMik7CiAgICAgICAgaWYgKHJlc3RbMF0gIT09ICcvJykgewogICAgICAgICAgcmVzdCA9ICcvJyArIHJlc3Q7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgCiAgICAvLyBub3cgcmVzdCBpcyBzZXQgdG8gdGhlIHBvc3QtaG9zdCBzdHVmZi4KICAgIC8vIGNob3Agb2ZmIGFueSBkZWxpbSBjaGFycy4KICAgIGlmICghdW5zYWZlUHJvdG9jb2xbbG93ZXJQcm90b10pIHsKICAKICAgICAgLy8gRmlyc3QsIG1ha2UgMTAwJSBzdXJlIHRoYXQgYW55ICJhdXRvRXNjYXBlIiBjaGFycyBnZXQKICAgICAgLy8gZXNjYXBlZCwgZXZlbiBpZiBlbmNvZGVVUklDb21wb25lbnQgZG9lc24ndCB0aGluayB0aGV5CiAgICAgIC8vIG5lZWQgdG8gYmUuCiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gYXV0b0VzY2FwZS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB2YXIgYWUgPSBhdXRvRXNjYXBlW2ldOwogICAgICAgIHZhciBlc2MgPSBlbmNvZGVVUklDb21wb25lbnQoYWUpOwogICAgICAgIGlmIChlc2MgPT09IGFlKSB7CiAgICAgICAgICBlc2MgPSBlc2NhcGUoYWUpOwogICAgICAgIH0KICAgICAgICByZXN0ID0gcmVzdC5zcGxpdChhZSkuam9pbihlc2MpOwogICAgICB9CiAgICB9CiAgCiAgCiAgICAvLyBjaG9wIG9mZiBmcm9tIHRoZSB0YWlsIGZpcnN0LgogICAgdmFyIGhhc2ggPSByZXN0LmluZGV4T2YoJyMnKTsKICAgIGlmIChoYXNoICE9PSAtMSkgewogICAgICAvLyBnb3QgYSBmcmFnbWVudCBzdHJpbmcuCiAgICAgIHRoaXMuaGFzaCA9IHJlc3Quc3Vic3RyKGhhc2gpOwogICAgICByZXN0ID0gcmVzdC5zbGljZSgwLCBoYXNoKTsKICAgIH0KICAgIHZhciBxbSA9IHJlc3QuaW5kZXhPZignPycpOwogICAgaWYgKHFtICE9PSAtMSkgewogICAgICB0aGlzLnNlYXJjaCA9IHJlc3Quc3Vic3RyKHFtKTsKICAgICAgdGhpcy5xdWVyeSA9IHJlc3Quc3Vic3RyKHFtICsgMSk7CiAgICAgIGlmIChwYXJzZVF1ZXJ5U3RyaW5nKSB7CiAgICAgICAgdGhpcy5xdWVyeSA9IHF1ZXJ5c3RyaW5nLnBhcnNlKHRoaXMucXVlcnkpOwogICAgICB9CiAgICAgIHJlc3QgPSByZXN0LnNsaWNlKDAsIHFtKTsKICAgIH0gZWxzZSBpZiAocGFyc2VRdWVyeVN0cmluZykgewogICAgICAvLyBubyBxdWVyeSBzdHJpbmcsIGJ1dCBwYXJzZVF1ZXJ5U3RyaW5nIHN0aWxsIHJlcXVlc3RlZAogICAgICB0aGlzLnNlYXJjaCA9ICcnOwogICAgICB0aGlzLnF1ZXJ5ID0ge307CiAgICB9CiAgICBpZiAocmVzdCkgdGhpcy5wYXRobmFtZSA9IHJlc3Q7CiAgICBpZiAoc2xhc2hlZFByb3RvY29sW2xvd2VyUHJvdG9dICYmCiAgICAgICAgdGhpcy5ob3N0bmFtZSAmJiAhdGhpcy5wYXRobmFtZSkgewogICAgICB0aGlzLnBhdGhuYW1lID0gJy8nOwogICAgfQogIAogICAgLy90byBzdXBwb3J0IGh0dHAucmVxdWVzdAogICAgaWYgKHRoaXMucGF0aG5hbWUgfHwgdGhpcy5zZWFyY2gpIHsKICAgICAgdmFyIHAgPSB0aGlzLnBhdGhuYW1lIHx8ICcnOwogICAgICB2YXIgcyA9IHRoaXMuc2VhcmNoIHx8ICcnOwogICAgICB0aGlzLnBhdGggPSBwICsgczsKICAgIH0KICAKICAgIC8vIGZpbmFsbHksIHJlY29uc3RydWN0IHRoZSBocmVmIGJhc2VkIG9uIHdoYXQgaGFzIGJlZW4gdmFsaWRhdGVkLgogICAgdGhpcy5ocmVmID0gdGhpcy5mb3JtYXQoKTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgLy8gZm9ybWF0IGEgcGFyc2VkIG9iamVjdCBpbnRvIGEgdXJsIHN0cmluZwogIGZ1bmN0aW9uIHVybEZvcm1hdChvYmopIHsKICAgIC8vIGVuc3VyZSBpdCdzIGFuIG9iamVjdCwgYW5kIG5vdCBhIHN0cmluZyB1cmwuCiAgICAvLyBJZiBpdCdzIGFuIG9iaiwgdGhpcyBpcyBhIG5vLW9wLgogICAgLy8gdGhpcyB3YXksIHlvdSBjYW4gY2FsbCB1cmxfZm9ybWF0KCkgb24gc3RyaW5ncwogICAgLy8gdG8gY2xlYW4gdXAgcG90ZW50aWFsbHkgd29ua3kgdXJscy4KICAgIGlmIChpc1N0cmluZyhvYmopKSBvYmogPSB1cmxQYXJzZShvYmopOwogICAgaWYgKCEob2JqIGluc3RhbmNlb2YgVXJsKSkgcmV0dXJuIFVybC5wcm90b3R5cGUuZm9ybWF0LmNhbGwob2JqKTsKICAgIHJldHVybiBvYmouZm9ybWF0KCk7CiAgfQogIAogIFVybC5wcm90b3R5cGUuZm9ybWF0ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXV0aCA9IHRoaXMuYXV0aCB8fCAnJzsKICAgIGlmIChhdXRoKSB7CiAgICAgIGF1dGggPSBlbmNvZGVVUklDb21wb25lbnQoYXV0aCk7CiAgICAgIGF1dGggPSBhdXRoLnJlcGxhY2UoLyUzQS9pLCAnOicpOwogICAgICBhdXRoICs9ICdAJzsKICAgIH0KICAKICAgIHZhciBwcm90b2NvbCA9IHRoaXMucHJvdG9jb2wgfHwgJycsCiAgICAgICAgcGF0aG5hbWUgPSB0aGlzLnBhdGhuYW1lIHx8ICcnLAogICAgICAgIGhhc2ggPSB0aGlzLmhhc2ggfHwgJycsCiAgICAgICAgaG9zdCA9IGZhbHNlLAogICAgICAgIHF1ZXJ5ID0gJyc7CiAgCiAgICBpZiAodGhpcy5ob3N0KSB7CiAgICAgIGhvc3QgPSBhdXRoICsgdGhpcy5ob3N0OwogICAgfSBlbHNlIGlmICh0aGlzLmhvc3RuYW1lKSB7CiAgICAgIGhvc3QgPSBhdXRoICsgKHRoaXMuaG9zdG5hbWUuaW5kZXhPZignOicpID09PSAtMSA/CiAgICAgICAgICB0aGlzLmhvc3RuYW1lIDoKICAgICAgICAgICdbJyArIHRoaXMuaG9zdG5hbWUgKyAnXScpOwogICAgICBpZiAodGhpcy5wb3J0KSB7CiAgICAgICAgaG9zdCArPSAnOicgKyB0aGlzLnBvcnQ7CiAgICAgIH0KICAgIH0KICAKICAgIGlmICh0aGlzLnF1ZXJ5ICYmCiAgICAgICAgaXNPYmplY3QodGhpcy5xdWVyeSkgJiYKICAgICAgICBPYmplY3Qua2V5cyh0aGlzLnF1ZXJ5KS5sZW5ndGgpIHsKICAgICAgcXVlcnkgPSBxdWVyeXN0cmluZy5zdHJpbmdpZnkodGhpcy5xdWVyeSk7CiAgICB9CiAgCiAgICB2YXIgc2VhcmNoID0gdGhpcy5zZWFyY2ggfHwgKHF1ZXJ5ICYmICgnPycgKyBxdWVyeSkpIHx8ICcnOwogIAogICAgaWYgKHByb3RvY29sICYmIHByb3RvY29sLnN1YnN0cigtMSkgIT09ICc6JykgcHJvdG9jb2wgKz0gJzonOwogIAogICAgLy8gb25seSB0aGUgc2xhc2hlZFByb3RvY29scyBnZXQgdGhlIC8vLiAgTm90IG1haWx0bzosIHhtcHA6LCBldGMuCiAgICAvLyB1bmxlc3MgdGhleSBoYWQgdGhlbSB0byBiZWdpbiB3aXRoLgogICAgaWYgKHRoaXMuc2xhc2hlcyB8fAogICAgICAgICghcHJvdG9jb2wgfHwgc2xhc2hlZFByb3RvY29sW3Byb3RvY29sXSkgJiYgaG9zdCAhPT0gZmFsc2UpIHsKICAgICAgaG9zdCA9ICcvLycgKyAoaG9zdCB8fCAnJyk7CiAgICAgIGlmIChwYXRobmFtZSAmJiBwYXRobmFtZS5jaGFyQXQoMCkgIT09ICcvJykgcGF0aG5hbWUgPSAnLycgKyBwYXRobmFtZTsKICAgIH0gZWxzZSBpZiAoIWhvc3QpIHsKICAgICAgaG9zdCA9ICcnOwogICAgfQogIAogICAgaWYgKGhhc2ggJiYgaGFzaC5jaGFyQXQoMCkgIT09ICcjJykgaGFzaCA9ICcjJyArIGhhc2g7CiAgICBpZiAoc2VhcmNoICYmIHNlYXJjaC5jaGFyQXQoMCkgIT09ICc/Jykgc2VhcmNoID0gJz8nICsgc2VhcmNoOwogIAogICAgcGF0aG5hbWUgPSBwYXRobmFtZS5yZXBsYWNlKC9bPyNdL2csIGZ1bmN0aW9uKG1hdGNoKSB7CiAgICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQobWF0Y2gpOwogICAgfSk7CiAgICBzZWFyY2ggPSBzZWFyY2gucmVwbGFjZSgnIycsICclMjMnKTsKICAKICAgIHJldHVybiBwcm90b2NvbCArIGhvc3QgKyBwYXRobmFtZSArIHNlYXJjaCArIGhhc2g7CiAgfTsKICAKICBmdW5jdGlvbiB1cmxSZXNvbHZlKHNvdXJjZSwgcmVsYXRpdmUpIHsKICAgIHJldHVybiB1cmxQYXJzZShzb3VyY2UsIGZhbHNlLCB0cnVlKS5yZXNvbHZlKHJlbGF0aXZlKTsKICB9CiAgCiAgVXJsLnByb3RvdHlwZS5yZXNvbHZlID0gZnVuY3Rpb24ocmVsYXRpdmUpIHsKICAgIHJldHVybiB0aGlzLnJlc29sdmVPYmplY3QodXJsUGFyc2UocmVsYXRpdmUsIGZhbHNlLCB0cnVlKSkuZm9ybWF0KCk7CiAgfTsKICAKICBmdW5jdGlvbiB1cmxSZXNvbHZlT2JqZWN0KHNvdXJjZSwgcmVsYXRpdmUpIHsKICAgIGlmICghc291cmNlKSByZXR1cm4gcmVsYXRpdmU7CiAgICByZXR1cm4gdXJsUGFyc2Uoc291cmNlLCBmYWxzZSwgdHJ1ZSkucmVzb2x2ZU9iamVjdChyZWxhdGl2ZSk7CiAgfQogIAogIFVybC5wcm90b3R5cGUucmVzb2x2ZU9iamVjdCA9IGZ1bmN0aW9uKHJlbGF0aXZlKSB7CiAgICBpZiAoaXNTdHJpbmcocmVsYXRpdmUpKSB7CiAgICAgIHZhciByZWwgPSBuZXcgVXJsKCk7CiAgICAgIHJlbC5wYXJzZShyZWxhdGl2ZSwgZmFsc2UsIHRydWUpOwogICAgICByZWxhdGl2ZSA9IHJlbDsKICAgIH0KICAKICAgIHZhciByZXN1bHQgPSBuZXcgVXJsKCk7CiAgICBPYmplY3Qua2V5cyh0aGlzKS5mb3JFYWNoKGZ1bmN0aW9uKGspIHsKICAgICAgcmVzdWx0W2tdID0gdGhpc1trXTsKICAgIH0sIHRoaXMpOwogIAogICAgLy8gaGFzaCBpcyBhbHdheXMgb3ZlcnJpZGRlbiwgbm8gbWF0dGVyIHdoYXQuCiAgICAvLyBldmVuIGhyZWY9IiIgd2lsbCByZW1vdmUgaXQuCiAgICByZXN1bHQuaGFzaCA9IHJlbGF0aXZlLmhhc2g7CiAgCiAgICAvLyBpZiB0aGUgcmVsYXRpdmUgdXJsIGlzIGVtcHR5LCB0aGVuIHRoZXJlJ3Mgbm90aGluZyBsZWZ0IHRvIGRvIGhlcmUuCiAgICBpZiAocmVsYXRpdmUuaHJlZiA9PT0gJycpIHsKICAgICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgCiAgICAvLyBocmVmcyBsaWtlIC8vZm9vL2JhciBhbHdheXMgY3V0IHRvIHRoZSBwcm90b2NvbC4KICAgIGlmIChyZWxhdGl2ZS5zbGFzaGVzICYmICFyZWxhdGl2ZS5wcm90b2NvbCkgewogICAgICAvLyB0YWtlIGV2ZXJ5dGhpbmcgZXhjZXB0IHRoZSBwcm90b2NvbCBmcm9tIHJlbGF0aXZlCiAgICAgIE9iamVjdC5rZXlzKHJlbGF0aXZlKS5mb3JFYWNoKGZ1bmN0aW9uKGspIHsKICAgICAgICBpZiAoayAhPT0gJ3Byb3RvY29sJykKICAgICAgICAgIHJlc3VsdFtrXSA9IHJlbGF0aXZlW2tdOwogICAgICB9KTsKICAKICAgICAgLy91cmxQYXJzZSBhcHBlbmRzIHRyYWlsaW5nIC8gdG8gdXJscyBsaWtlIGh0dHA6Ly93d3cuZXhhbXBsZS5jb20KICAgICAgaWYgKHNsYXNoZWRQcm90b2NvbFtyZXN1bHQucHJvdG9jb2xdICYmCiAgICAgICAgICByZXN1bHQuaG9zdG5hbWUgJiYgIXJlc3VsdC5wYXRobmFtZSkgewogICAgICAgIHJlc3VsdC5wYXRoID0gcmVzdWx0LnBhdGhuYW1lID0gJy8nOwogICAgICB9CiAgCiAgICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIAogICAgaWYgKHJlbGF0aXZlLnByb3RvY29sICYmIHJlbGF0aXZlLnByb3RvY29sICE9PSByZXN1bHQucHJvdG9jb2wpIHsKICAgICAgLy8gaWYgaXQncyBhIGtub3duIHVybCBwcm90b2NvbCwgdGhlbiBjaGFuZ2luZwogICAgICAvLyB0aGUgcHJvdG9jb2wgZG9lcyB3ZWlyZCB0aGluZ3MKICAgICAgLy8gZmlyc3QsIGlmIGl0J3Mgbm90IGZpbGU6LCB0aGVuIHdlIE1VU1QgaGF2ZSBhIGhvc3QsCiAgICAgIC8vIGFuZCBpZiB0aGVyZSB3YXMgYSBwYXRoCiAgICAgIC8vIHRvIGJlZ2luIHdpdGgsIHRoZW4gd2UgTVVTVCBoYXZlIGEgcGF0aC4KICAgICAgLy8gaWYgaXQgaXMgZmlsZTosIHRoZW4gdGhlIGhvc3QgaXMgZHJvcHBlZCwKICAgICAgLy8gYmVjYXVzZSB0aGF0J3Mga25vd24gdG8gYmUgaG9zdGxlc3MuCiAgICAgIC8vIGFueXRoaW5nIGVsc2UgaXMgYXNzdW1lZCB0byBiZSBhYnNvbHV0ZS4KICAgICAgaWYgKCFzbGFzaGVkUHJvdG9jb2xbcmVsYXRpdmUucHJvdG9jb2xdKSB7CiAgICAgICAgT2JqZWN0LmtleXMocmVsYXRpdmUpLmZvckVhY2goZnVuY3Rpb24oaykgewogICAgICAgICAgcmVzdWx0W2tdID0gcmVsYXRpdmVba107CiAgICAgICAgfSk7CiAgICAgICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogIAogICAgICByZXN1bHQucHJvdG9jb2wgPSByZWxhdGl2ZS5wcm90b2NvbDsKICAgICAgaWYgKCFyZWxhdGl2ZS5ob3N0ICYmICFob3N0bGVzc1Byb3RvY29sW3JlbGF0aXZlLnByb3RvY29sXSkgewogICAgICAgIHZhciByZWxQYXRoID0gKHJlbGF0aXZlLnBhdGhuYW1lIHx8ICcnKS5zcGxpdCgnLycpOwogICAgICAgIHdoaWxlIChyZWxQYXRoLmxlbmd0aCAmJiAhKHJlbGF0aXZlLmhvc3QgPSByZWxQYXRoLnNoaWZ0KCkpKTsKICAgICAgICBpZiAoIXJlbGF0aXZlLmhvc3QpIHJlbGF0aXZlLmhvc3QgPSAnJzsKICAgICAgICBpZiAoIXJlbGF0aXZlLmhvc3RuYW1lKSByZWxhdGl2ZS5ob3N0bmFtZSA9ICcnOwogICAgICAgIGlmIChyZWxQYXRoWzBdICE9PSAnJykgcmVsUGF0aC51bnNoaWZ0KCcnKTsKICAgICAgICBpZiAocmVsUGF0aC5sZW5ndGggPCAyKSByZWxQYXRoLnVuc2hpZnQoJycpOwogICAgICAgIHJlc3VsdC5wYXRobmFtZSA9IHJlbFBhdGguam9pbignLycpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdC5wYXRobmFtZSA9IHJlbGF0aXZlLnBhdGhuYW1lOwogICAgICB9CiAgICAgIHJlc3VsdC5zZWFyY2ggPSByZWxhdGl2ZS5zZWFyY2g7CiAgICAgIHJlc3VsdC5xdWVyeSA9IHJlbGF0aXZlLnF1ZXJ5OwogICAgICByZXN1bHQuaG9zdCA9IHJlbGF0aXZlLmhvc3QgfHwgJyc7CiAgICAgIHJlc3VsdC5hdXRoID0gcmVsYXRpdmUuYXV0aDsKICAgICAgcmVzdWx0Lmhvc3RuYW1lID0gcmVsYXRpdmUuaG9zdG5hbWUgfHwgcmVsYXRpdmUuaG9zdDsKICAgICAgcmVzdWx0LnBvcnQgPSByZWxhdGl2ZS5wb3J0OwogICAgICAvLyB0byBzdXBwb3J0IGh0dHAucmVxdWVzdAogICAgICBpZiAocmVzdWx0LnBhdGhuYW1lIHx8IHJlc3VsdC5zZWFyY2gpIHsKICAgICAgICB2YXIgcCA9IHJlc3VsdC5wYXRobmFtZSB8fCAnJzsKICAgICAgICB2YXIgcyA9IHJlc3VsdC5zZWFyY2ggfHwgJyc7CiAgICAgICAgcmVzdWx0LnBhdGggPSBwICsgczsKICAgICAgfQogICAgICByZXN1bHQuc2xhc2hlcyA9IHJlc3VsdC5zbGFzaGVzIHx8IHJlbGF0aXZlLnNsYXNoZXM7CiAgICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIAogICAgdmFyIGlzU291cmNlQWJzID0gKHJlc3VsdC5wYXRobmFtZSAmJiByZXN1bHQucGF0aG5hbWUuY2hhckF0KDApID09PSAnLycpLAogICAgICAgIGlzUmVsQWJzID0gKAogICAgICAgICAgICByZWxhdGl2ZS5ob3N0IHx8CiAgICAgICAgICAgIHJlbGF0aXZlLnBhdGhuYW1lICYmIHJlbGF0aXZlLnBhdGhuYW1lLmNoYXJBdCgwKSA9PT0gJy8nCiAgICAgICAgKSwKICAgICAgICBtdXN0RW5kQWJzID0gKGlzUmVsQWJzIHx8IGlzU291cmNlQWJzIHx8CiAgICAgICAgICAgICAgICAgICAgICAocmVzdWx0Lmhvc3QgJiYgcmVsYXRpdmUucGF0aG5hbWUpKSwKICAgICAgICByZW1vdmVBbGxEb3RzID0gbXVzdEVuZEFicywKICAgICAgICBzcmNQYXRoID0gcmVzdWx0LnBhdGhuYW1lICYmIHJlc3VsdC5wYXRobmFtZS5zcGxpdCgnLycpIHx8IFtdLAogICAgICAgIHJlbFBhdGggPSByZWxhdGl2ZS5wYXRobmFtZSAmJiByZWxhdGl2ZS5wYXRobmFtZS5zcGxpdCgnLycpIHx8IFtdLAogICAgICAgIHBzeWNob3RpYyA9IHJlc3VsdC5wcm90b2NvbCAmJiAhc2xhc2hlZFByb3RvY29sW3Jlc3VsdC5wcm90b2NvbF07CiAgCiAgICAvLyBpZiB0aGUgdXJsIGlzIGEgbm9uLXNsYXNoZWQgdXJsLCB0aGVuIHJlbGF0aXZlCiAgICAvLyBsaW5rcyBsaWtlIC4uLy4uIHNob3VsZCBiZSBhYmxlCiAgICAvLyB0byBjcmF3bCB1cCB0byB0aGUgaG9zdG5hbWUsIGFzIHdlbGwuICBUaGlzIGlzIHN0cmFuZ2UuCiAgICAvLyByZXN1bHQucHJvdG9jb2wgaGFzIGFscmVhZHkgYmVlbiBzZXQgYnkgbm93LgogICAgLy8gTGF0ZXIgb24sIHB1dCB0aGUgZmlyc3QgcGF0aCBwYXJ0IGludG8gdGhlIGhvc3QgZmllbGQuCiAgICBpZiAocHN5Y2hvdGljKSB7CiAgICAgIHJlc3VsdC5ob3N0bmFtZSA9ICcnOwogICAgICByZXN1bHQucG9ydCA9IG51bGw7CiAgICAgIGlmIChyZXN1bHQuaG9zdCkgewogICAgICAgIGlmIChzcmNQYXRoWzBdID09PSAnJykgc3JjUGF0aFswXSA9IHJlc3VsdC5ob3N0OwogICAgICAgIGVsc2Ugc3JjUGF0aC51bnNoaWZ0KHJlc3VsdC5ob3N0KTsKICAgICAgfQogICAgICByZXN1bHQuaG9zdCA9ICcnOwogICAgICBpZiAocmVsYXRpdmUucHJvdG9jb2wpIHsKICAgICAgICByZWxhdGl2ZS5ob3N0bmFtZSA9IG51bGw7CiAgICAgICAgcmVsYXRpdmUucG9ydCA9IG51bGw7CiAgICAgICAgaWYgKHJlbGF0aXZlLmhvc3QpIHsKICAgICAgICAgIGlmIChyZWxQYXRoWzBdID09PSAnJykgcmVsUGF0aFswXSA9IHJlbGF0aXZlLmhvc3Q7CiAgICAgICAgICBlbHNlIHJlbFBhdGgudW5zaGlmdChyZWxhdGl2ZS5ob3N0KTsKICAgICAgICB9CiAgICAgICAgcmVsYXRpdmUuaG9zdCA9IG51bGw7CiAgICAgIH0KICAgICAgbXVzdEVuZEFicyA9IG11c3RFbmRBYnMgJiYgKHJlbFBhdGhbMF0gPT09ICcnIHx8IHNyY1BhdGhbMF0gPT09ICcnKTsKICAgIH0KICAKICAgIGlmIChpc1JlbEFicykgewogICAgICAvLyBpdCdzIGFic29sdXRlLgogICAgICByZXN1bHQuaG9zdCA9IChyZWxhdGl2ZS5ob3N0IHx8IHJlbGF0aXZlLmhvc3QgPT09ICcnKSA/CiAgICAgICAgICAgICAgICAgICAgcmVsYXRpdmUuaG9zdCA6IHJlc3VsdC5ob3N0OwogICAgICByZXN1bHQuaG9zdG5hbWUgPSAocmVsYXRpdmUuaG9zdG5hbWUgfHwgcmVsYXRpdmUuaG9zdG5hbWUgPT09ICcnKSA/CiAgICAgICAgICAgICAgICAgICAgICAgIHJlbGF0aXZlLmhvc3RuYW1lIDogcmVzdWx0Lmhvc3RuYW1lOwogICAgICByZXN1bHQuc2VhcmNoID0gcmVsYXRpdmUuc2VhcmNoOwogICAgICByZXN1bHQucXVlcnkgPSByZWxhdGl2ZS5xdWVyeTsKICAgICAgc3JjUGF0aCA9IHJlbFBhdGg7CiAgICAgIC8vIGZhbGwgdGhyb3VnaCB0byB0aGUgZG90LWhhbmRsaW5nIGJlbG93LgogICAgfSBlbHNlIGlmIChyZWxQYXRoLmxlbmd0aCkgewogICAgICAvLyBpdCdzIHJlbGF0aXZlCiAgICAgIC8vIHRocm93IGF3YXkgdGhlIGV4aXN0aW5nIGZpbGUsIGFuZCB0YWtlIHRoZSBuZXcgcGF0aCBpbnN0ZWFkLgogICAgICBpZiAoIXNyY1BhdGgpIHNyY1BhdGggPSBbXTsKICAgICAgc3JjUGF0aC5wb3AoKTsKICAgICAgc3JjUGF0aCA9IHNyY1BhdGguY29uY2F0KHJlbFBhdGgpOwogICAgICByZXN1bHQuc2VhcmNoID0gcmVsYXRpdmUuc2VhcmNoOwogICAgICByZXN1bHQucXVlcnkgPSByZWxhdGl2ZS5xdWVyeTsKICAgIH0gZWxzZSBpZiAoIWlzTnVsbE9yVW5kZWZpbmVkKHJlbGF0aXZlLnNlYXJjaCkpIHsKICAgICAgLy8ganVzdCBwdWxsIG91dCB0aGUgc2VhcmNoLgogICAgICAvLyBsaWtlIGhyZWY9Jz9mb28nLgogICAgICAvLyBQdXQgdGhpcyBhZnRlciB0aGUgb3RoZXIgdHdvIGNhc2VzIGJlY2F1c2UgaXQgc2ltcGxpZmllcyB0aGUgYm9vbGVhbnMKICAgICAgaWYgKHBzeWNob3RpYykgewogICAgICAgIHJlc3VsdC5ob3N0bmFtZSA9IHJlc3VsdC5ob3N0ID0gc3JjUGF0aC5zaGlmdCgpOwogICAgICAgIC8vb2NjYXRpb25hbHkgdGhlIGF1dGggY2FuIGdldCBzdHVjayBvbmx5IGluIGhvc3QKICAgICAgICAvL3RoaXMgZXNwZWNpYWx5IGhhcHBlbnMgaW4gY2FzZXMgbGlrZQogICAgICAgIC8vdXJsLnJlc29sdmVPYmplY3QoJ21haWx0bzpsb2NhbDFAZG9tYWluMScsICdsb2NhbDJAZG9tYWluMicpCiAgICAgICAgdmFyIGF1dGhJbkhvc3QgPSByZXN1bHQuaG9zdCAmJiByZXN1bHQuaG9zdC5pbmRleE9mKCdAJykgPiAwID8KICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5ob3N0LnNwbGl0KCdAJykgOiBmYWxzZTsKICAgICAgICBpZiAoYXV0aEluSG9zdCkgewogICAgICAgICAgcmVzdWx0LmF1dGggPSBhdXRoSW5Ib3N0LnNoaWZ0KCk7CiAgICAgICAgICByZXN1bHQuaG9zdCA9IHJlc3VsdC5ob3N0bmFtZSA9IGF1dGhJbkhvc3Quc2hpZnQoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmVzdWx0LnNlYXJjaCA9IHJlbGF0aXZlLnNlYXJjaDsKICAgICAgcmVzdWx0LnF1ZXJ5ID0gcmVsYXRpdmUucXVlcnk7CiAgICAgIC8vdG8gc3VwcG9ydCBodHRwLnJlcXVlc3QKICAgICAgaWYgKCFpc051bGwocmVzdWx0LnBhdGhuYW1lKSB8fCAhaXNOdWxsKHJlc3VsdC5zZWFyY2gpKSB7CiAgICAgICAgcmVzdWx0LnBhdGggPSAocmVzdWx0LnBhdGhuYW1lID8gcmVzdWx0LnBhdGhuYW1lIDogJycpICsKICAgICAgICAgICAgICAgICAgICAgIChyZXN1bHQuc2VhcmNoID8gcmVzdWx0LnNlYXJjaCA6ICcnKTsKICAgICAgfQogICAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAKICAgIGlmICghc3JjUGF0aC5sZW5ndGgpIHsKICAgICAgLy8gbm8gcGF0aCBhdCBhbGwuICBlYXN5LgogICAgICAvLyB3ZSd2ZSBhbHJlYWR5IGhhbmRsZWQgdGhlIG90aGVyIHN0dWZmIGFib3ZlLgogICAgICByZXN1bHQucGF0aG5hbWUgPSBudWxsOwogICAgICAvL3RvIHN1cHBvcnQgaHR0cC5yZXF1ZXN0CiAgICAgIGlmIChyZXN1bHQuc2VhcmNoKSB7CiAgICAgICAgcmVzdWx0LnBhdGggPSAnLycgKyByZXN1bHQuc2VhcmNoOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdC5wYXRoID0gbnVsbDsKICAgICAgfQogICAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAKICAgIC8vIGlmIGEgdXJsIEVORHMgaW4gLiBvciAuLiwgdGhlbiBpdCBtdXN0IGdldCBhIHRyYWlsaW5nIHNsYXNoLgogICAgLy8gaG93ZXZlciwgaWYgaXQgZW5kcyBpbiBhbnl0aGluZyBlbHNlIG5vbi1zbGFzaHksCiAgICAvLyB0aGVuIGl0IG11c3QgTk9UIGdldCBhIHRyYWlsaW5nIHNsYXNoLgogICAgdmFyIGxhc3QgPSBzcmNQYXRoLnNsaWNlKC0xKVswXTsKICAgIHZhciBoYXNUcmFpbGluZ1NsYXNoID0gKAogICAgICAgIChyZXN1bHQuaG9zdCB8fCByZWxhdGl2ZS5ob3N0KSAmJiAobGFzdCA9PT0gJy4nIHx8IGxhc3QgPT09ICcuLicpIHx8CiAgICAgICAgbGFzdCA9PT0gJycpOwogIAogICAgLy8gc3RyaXAgc2luZ2xlIGRvdHMsIHJlc29sdmUgZG91YmxlIGRvdHMgdG8gcGFyZW50IGRpcgogICAgLy8gaWYgdGhlIHBhdGggdHJpZXMgdG8gZ28gYWJvdmUgdGhlIHJvb3QsIGB1cGAgZW5kcyB1cCA+IDAKICAgIHZhciB1cCA9IDA7CiAgICBmb3IgKHZhciBpID0gc3JjUGF0aC5sZW5ndGg7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGxhc3QgPSBzcmNQYXRoW2ldOwogICAgICBpZiAobGFzdCA9PSAnLicpIHsKICAgICAgICBzcmNQYXRoLnNwbGljZShpLCAxKTsKICAgICAgfSBlbHNlIGlmIChsYXN0ID09PSAnLi4nKSB7CiAgICAgICAgc3JjUGF0aC5zcGxpY2UoaSwgMSk7CiAgICAgICAgdXArKzsKICAgICAgfSBlbHNlIGlmICh1cCkgewogICAgICAgIHNyY1BhdGguc3BsaWNlKGksIDEpOwogICAgICAgIHVwLS07CiAgICAgIH0KICAgIH0KICAKICAgIC8vIGlmIHRoZSBwYXRoIGlzIGFsbG93ZWQgdG8gZ28gYWJvdmUgdGhlIHJvb3QsIHJlc3RvcmUgbGVhZGluZyAuLnMKICAgIGlmICghbXVzdEVuZEFicyAmJiAhcmVtb3ZlQWxsRG90cykgewogICAgICBmb3IgKDsgdXAtLTsgdXApIHsKICAgICAgICBzcmNQYXRoLnVuc2hpZnQoJy4uJyk7CiAgICAgIH0KICAgIH0KICAKICAgIGlmIChtdXN0RW5kQWJzICYmIHNyY1BhdGhbMF0gIT09ICcnICYmCiAgICAgICAgKCFzcmNQYXRoWzBdIHx8IHNyY1BhdGhbMF0uY2hhckF0KDApICE9PSAnLycpKSB7CiAgICAgIHNyY1BhdGgudW5zaGlmdCgnJyk7CiAgICB9CiAgCiAgICBpZiAoaGFzVHJhaWxpbmdTbGFzaCAmJiAoc3JjUGF0aC5qb2luKCcvJykuc3Vic3RyKC0xKSAhPT0gJy8nKSkgewogICAgICBzcmNQYXRoLnB1c2goJycpOwogICAgfQogIAogICAgdmFyIGlzQWJzb2x1dGUgPSBzcmNQYXRoWzBdID09PSAnJyB8fAogICAgICAgIChzcmNQYXRoWzBdICYmIHNyY1BhdGhbMF0uY2hhckF0KDApID09PSAnLycpOwogIAogICAgLy8gcHV0IHRoZSBob3N0IGJhY2sKICAgIGlmIChwc3ljaG90aWMpIHsKICAgICAgcmVzdWx0Lmhvc3RuYW1lID0gcmVzdWx0Lmhvc3QgPSBpc0Fic29sdXRlID8gJycgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNyY1BhdGgubGVuZ3RoID8gc3JjUGF0aC5zaGlmdCgpIDogJyc7CiAgICAgIC8vb2NjYXRpb25hbHkgdGhlIGF1dGggY2FuIGdldCBzdHVjayBvbmx5IGluIGhvc3QKICAgICAgLy90aGlzIGVzcGVjaWFseSBoYXBwZW5zIGluIGNhc2VzIGxpa2UKICAgICAgLy91cmwucmVzb2x2ZU9iamVjdCgnbWFpbHRvOmxvY2FsMUBkb21haW4xJywgJ2xvY2FsMkBkb21haW4yJykKICAgICAgdmFyIGF1dGhJbkhvc3QgPSByZXN1bHQuaG9zdCAmJiByZXN1bHQuaG9zdC5pbmRleE9mKCdAJykgPiAwID8KICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQuaG9zdC5zcGxpdCgnQCcpIDogZmFsc2U7CiAgICAgIGlmIChhdXRoSW5Ib3N0KSB7CiAgICAgICAgcmVzdWx0LmF1dGggPSBhdXRoSW5Ib3N0LnNoaWZ0KCk7CiAgICAgICAgcmVzdWx0Lmhvc3QgPSByZXN1bHQuaG9zdG5hbWUgPSBhdXRoSW5Ib3N0LnNoaWZ0KCk7CiAgICAgIH0KICAgIH0KICAKICAgIG11c3RFbmRBYnMgPSBtdXN0RW5kQWJzIHx8IChyZXN1bHQuaG9zdCAmJiBzcmNQYXRoLmxlbmd0aCk7CiAgCiAgICBpZiAobXVzdEVuZEFicyAmJiAhaXNBYnNvbHV0ZSkgewogICAgICBzcmNQYXRoLnVuc2hpZnQoJycpOwogICAgfQogIAogICAgaWYgKCFzcmNQYXRoLmxlbmd0aCkgewogICAgICByZXN1bHQucGF0aG5hbWUgPSBudWxsOwogICAgICByZXN1bHQucGF0aCA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICByZXN1bHQucGF0aG5hbWUgPSBzcmNQYXRoLmpvaW4oJy8nKTsKICAgIH0KICAKICAgIC8vdG8gc3VwcG9ydCByZXF1ZXN0Lmh0dHAKICAgIGlmICghaXNOdWxsKHJlc3VsdC5wYXRobmFtZSkgfHwgIWlzTnVsbChyZXN1bHQuc2VhcmNoKSkgewogICAgICByZXN1bHQucGF0aCA9IChyZXN1bHQucGF0aG5hbWUgPyByZXN1bHQucGF0aG5hbWUgOiAnJykgKwogICAgICAgICAgICAgICAgICAgIChyZXN1bHQuc2VhcmNoID8gcmVzdWx0LnNlYXJjaCA6ICcnKTsKICAgIH0KICAgIHJlc3VsdC5hdXRoID0gcmVsYXRpdmUuYXV0aCB8fCByZXN1bHQuYXV0aDsKICAgIHJlc3VsdC5zbGFzaGVzID0gcmVzdWx0LnNsYXNoZXMgfHwgcmVsYXRpdmUuc2xhc2hlczsKICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIAogIFVybC5wcm90b3R5cGUucGFyc2VIb3N0ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgaG9zdCA9IHRoaXMuaG9zdDsKICAgIHZhciBwb3J0ID0gcG9ydFBhdHRlcm4uZXhlYyhob3N0KTsKICAgIGlmIChwb3J0KSB7CiAgICAgIHBvcnQgPSBwb3J0WzBdOwogICAgICBpZiAocG9ydCAhPT0gJzonKSB7CiAgICAgICAgdGhpcy5wb3J0ID0gcG9ydC5zdWJzdHIoMSk7CiAgICAgIH0KICAgICAgaG9zdCA9IGhvc3Quc3Vic3RyKDAsIGhvc3QubGVuZ3RoIC0gcG9ydC5sZW5ndGgpOwogICAgfQogICAgaWYgKGhvc3QpIHRoaXMuaG9zdG5hbWUgPSBob3N0OwogIH07CiAgCiAgZnVuY3Rpb24gaXNTdHJpbmcoYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gInN0cmluZyI7CiAgfQogIAogIGZ1bmN0aW9uIGlzT2JqZWN0KGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdvYmplY3QnICYmIGFyZyAhPT0gbnVsbDsKICB9CiAgCiAgZnVuY3Rpb24gaXNOdWxsKGFyZykgewogICAgcmV0dXJuIGFyZyA9PT0gbnVsbDsKICB9CiAgZnVuY3Rpb24gaXNOdWxsT3JVbmRlZmluZWQoYXJnKSB7CiAgICByZXR1cm4gIGFyZyA9PSBudWxsOwogIH0KICAKICB9LHsicHVueWNvZGUiOjg2LCJxdWVyeXN0cmluZyI6ODl9XSw5NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgaWYgKHR5cGVvZiBPYmplY3QuY3JlYXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAvLyBpbXBsZW1lbnRhdGlvbiBmcm9tIHN0YW5kYXJkIG5vZGUuanMgJ3V0aWwnIG1vZHVsZQogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpbmhlcml0cyhjdG9yLCBzdXBlckN0b3IpIHsKICAgICAgY3Rvci5zdXBlcl8gPSBzdXBlckN0b3IKICAgICAgY3Rvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ3Rvci5wcm90b3R5cGUsIHsKICAgICAgICBjb25zdHJ1Y3RvcjogewogICAgICAgICAgdmFsdWU6IGN0b3IsCiAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgfQogICAgICB9KTsKICAgIH07CiAgfSBlbHNlIHsKICAgIC8vIG9sZCBzY2hvb2wgc2hpbSBmb3Igb2xkIGJyb3dzZXJzCiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGluaGVyaXRzKGN0b3IsIHN1cGVyQ3RvcikgewogICAgICBjdG9yLnN1cGVyXyA9IHN1cGVyQ3RvcgogICAgICB2YXIgVGVtcEN0b3IgPSBmdW5jdGlvbiAoKSB7fQogICAgICBUZW1wQ3Rvci5wcm90b3R5cGUgPSBzdXBlckN0b3IucHJvdG90eXBlCiAgICAgIGN0b3IucHJvdG90eXBlID0gbmV3IFRlbXBDdG9yKCkKICAgICAgY3Rvci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjdG9yCiAgICB9CiAgfQogIAogIH0se31dLDk2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGlzQnVmZmVyKGFyZykgewogICAgcmV0dXJuIGFyZyAmJiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JwogICAgICAmJiB0eXBlb2YgYXJnLmNvcHkgPT09ICdmdW5jdGlvbicKICAgICAgJiYgdHlwZW9mIGFyZy5maWxsID09PSAnZnVuY3Rpb24nCiAgICAgICYmIHR5cGVvZiBhcmcucmVhZFVJbnQ4ID09PSAnZnVuY3Rpb24nOwogIH0KICB9LHt9XSw5NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChwcm9jZXNzLGdsb2JhbCl7CiAgLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCiAgLy8KICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQogIC8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKICAvLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCiAgLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAogIC8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKICAvLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKICAvLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAvLwogIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCiAgLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgLy8KICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwogIC8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICAvLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCiAgLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCiAgLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCiAgLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQogIC8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiAgCiAgdmFyIGZvcm1hdFJlZ0V4cCA9IC8lW3NkaiVdL2c7CiAgZXhwb3J0cy5mb3JtYXQgPSBmdW5jdGlvbihmKSB7CiAgICBpZiAoIWlzU3RyaW5nKGYpKSB7CiAgICAgIHZhciBvYmplY3RzID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgb2JqZWN0cy5wdXNoKGluc3BlY3QoYXJndW1lbnRzW2ldKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIG9iamVjdHMuam9pbignICcpOwogICAgfQogIAogICAgdmFyIGkgPSAxOwogICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICB2YXIgbGVuID0gYXJncy5sZW5ndGg7CiAgICB2YXIgc3RyID0gU3RyaW5nKGYpLnJlcGxhY2UoZm9ybWF0UmVnRXhwLCBmdW5jdGlvbih4KSB7CiAgICAgIGlmICh4ID09PSAnJSUnKSByZXR1cm4gJyUnOwogICAgICBpZiAoaSA+PSBsZW4pIHJldHVybiB4OwogICAgICBzd2l0Y2ggKHgpIHsKICAgICAgICBjYXNlICclcyc6IHJldHVybiBTdHJpbmcoYXJnc1tpKytdKTsKICAgICAgICBjYXNlICclZCc6IHJldHVybiBOdW1iZXIoYXJnc1tpKytdKTsKICAgICAgICBjYXNlICclaic6CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoYXJnc1tpKytdKTsKICAgICAgICAgIH0gY2F0Y2ggKF8pIHsKICAgICAgICAgICAgcmV0dXJuICdbQ2lyY3VsYXJdJzsKICAgICAgICAgIH0KICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIHg7CiAgICAgIH0KICAgIH0pOwogICAgZm9yICh2YXIgeCA9IGFyZ3NbaV07IGkgPCBsZW47IHggPSBhcmdzWysraV0pIHsKICAgICAgaWYgKGlzTnVsbCh4KSB8fCAhaXNPYmplY3QoeCkpIHsKICAgICAgICBzdHIgKz0gJyAnICsgeDsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdHIgKz0gJyAnICsgaW5zcGVjdCh4KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHN0cjsKICB9OwogIAogIAogIC8vIE1hcmsgdGhhdCBhIG1ldGhvZCBzaG91bGQgbm90IGJlIHVzZWQuCiAgLy8gUmV0dXJucyBhIG1vZGlmaWVkIGZ1bmN0aW9uIHdoaWNoIHdhcm5zIG9uY2UgYnkgZGVmYXVsdC4KICAvLyBJZiAtLW5vLWRlcHJlY2F0aW9uIGlzIHNldCwgdGhlbiBpdCBpcyBhIG5vLW9wLgogIGV4cG9ydHMuZGVwcmVjYXRlID0gZnVuY3Rpb24oZm4sIG1zZykgewogICAgLy8gQWxsb3cgZm9yIGRlcHJlY2F0aW5nIHRoaW5ncyBpbiB0aGUgcHJvY2VzcyBvZiBzdGFydGluZyB1cC4KICAgIGlmIChpc1VuZGVmaW5lZChnbG9iYWwucHJvY2VzcykpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBleHBvcnRzLmRlcHJlY2F0ZShmbiwgbXNnKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQogIAogICAgaWYgKHByb2Nlc3Mubm9EZXByZWNhdGlvbiA9PT0gdHJ1ZSkgewogICAgICByZXR1cm4gZm47CiAgICB9CiAgCiAgICB2YXIgd2FybmVkID0gZmFsc2U7CiAgICBmdW5jdGlvbiBkZXByZWNhdGVkKCkgewogICAgICBpZiAoIXdhcm5lZCkgewogICAgICAgIGlmIChwcm9jZXNzLnRocm93RGVwcmVjYXRpb24pIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihtc2cpOwogICAgICAgIH0gZWxzZSBpZiAocHJvY2Vzcy50cmFjZURlcHJlY2F0aW9uKSB7CiAgICAgICAgICBjb25zb2xlLnRyYWNlKG1zZyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IobXNnKTsKICAgICAgICB9CiAgICAgICAgd2FybmVkID0gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICAKICAgIHJldHVybiBkZXByZWNhdGVkOwogIH07CiAgCiAgCiAgdmFyIGRlYnVncyA9IHt9OwogIHZhciBkZWJ1Z0Vudmlyb247CiAgZXhwb3J0cy5kZWJ1Z2xvZyA9IGZ1bmN0aW9uKHNldCkgewogICAgaWYgKGlzVW5kZWZpbmVkKGRlYnVnRW52aXJvbikpCiAgICAgIGRlYnVnRW52aXJvbiA9IHByb2Nlc3MuZW52Lk5PREVfREVCVUcgfHwgJyc7CiAgICBzZXQgPSBzZXQudG9VcHBlckNhc2UoKTsKICAgIGlmICghZGVidWdzW3NldF0pIHsKICAgICAgaWYgKG5ldyBSZWdFeHAoJ1xcYicgKyBzZXQgKyAnXFxiJywgJ2knKS50ZXN0KGRlYnVnRW52aXJvbikpIHsKICAgICAgICB2YXIgcGlkID0gcHJvY2Vzcy5waWQ7CiAgICAgICAgZGVidWdzW3NldF0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBtc2cgPSBleHBvcnRzLmZvcm1hdC5hcHBseShleHBvcnRzLCBhcmd1bWVudHMpOwogICAgICAgICAgY29uc29sZS5lcnJvcignJXMgJWQ6ICVzJywgc2V0LCBwaWQsIG1zZyk7CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkZWJ1Z3Nbc2V0XSA9IGZ1bmN0aW9uKCkge307CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBkZWJ1Z3Nbc2V0XTsKICB9OwogIAogIAogIC8qKgogICAqIEVjaG9zIHRoZSB2YWx1ZSBvZiBhIHZhbHVlLiBUcnlzIHRvIHByaW50IHRoZSB2YWx1ZSBvdXQKICAgKiBpbiB0aGUgYmVzdCB3YXkgcG9zc2libGUgZ2l2ZW4gdGhlIGRpZmZlcmVudCB0eXBlcy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmogVGhlIG9iamVjdCB0byBwcmludCBvdXQuCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdHMgT3B0aW9uYWwgb3B0aW9ucyBvYmplY3QgdGhhdCBhbHRlcnMgdGhlIG91dHB1dC4KICAgKi8KICAvKiBsZWdhY3k6IG9iaiwgc2hvd0hpZGRlbiwgZGVwdGgsIGNvbG9ycyovCiAgZnVuY3Rpb24gaW5zcGVjdChvYmosIG9wdHMpIHsKICAgIC8vIGRlZmF1bHQgb3B0aW9ucwogICAgdmFyIGN0eCA9IHsKICAgICAgc2VlbjogW10sCiAgICAgIHN0eWxpemU6IHN0eWxpemVOb0NvbG9yCiAgICB9OwogICAgLy8gbGVnYWN5Li4uCiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+PSAzKSBjdHguZGVwdGggPSBhcmd1bWVudHNbMl07CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+PSA0KSBjdHguY29sb3JzID0gYXJndW1lbnRzWzNdOwogICAgaWYgKGlzQm9vbGVhbihvcHRzKSkgewogICAgICAvLyBsZWdhY3kuLi4KICAgICAgY3R4LnNob3dIaWRkZW4gPSBvcHRzOwogICAgfSBlbHNlIGlmIChvcHRzKSB7CiAgICAgIC8vIGdvdCBhbiAib3B0aW9ucyIgb2JqZWN0CiAgICAgIGV4cG9ydHMuX2V4dGVuZChjdHgsIG9wdHMpOwogICAgfQogICAgLy8gc2V0IGRlZmF1bHQgb3B0aW9ucwogICAgaWYgKGlzVW5kZWZpbmVkKGN0eC5zaG93SGlkZGVuKSkgY3R4LnNob3dIaWRkZW4gPSBmYWxzZTsKICAgIGlmIChpc1VuZGVmaW5lZChjdHguZGVwdGgpKSBjdHguZGVwdGggPSAyOwogICAgaWYgKGlzVW5kZWZpbmVkKGN0eC5jb2xvcnMpKSBjdHguY29sb3JzID0gZmFsc2U7CiAgICBpZiAoaXNVbmRlZmluZWQoY3R4LmN1c3RvbUluc3BlY3QpKSBjdHguY3VzdG9tSW5zcGVjdCA9IHRydWU7CiAgICBpZiAoY3R4LmNvbG9ycykgY3R4LnN0eWxpemUgPSBzdHlsaXplV2l0aENvbG9yOwogICAgcmV0dXJuIGZvcm1hdFZhbHVlKGN0eCwgb2JqLCBjdHguZGVwdGgpOwogIH0KICBleHBvcnRzLmluc3BlY3QgPSBpbnNwZWN0OwogIAogIAogIC8vIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQU5TSV9lc2NhcGVfY29kZSNncmFwaGljcwogIGluc3BlY3QuY29sb3JzID0gewogICAgJ2JvbGQnIDogWzEsIDIyXSwKICAgICdpdGFsaWMnIDogWzMsIDIzXSwKICAgICd1bmRlcmxpbmUnIDogWzQsIDI0XSwKICAgICdpbnZlcnNlJyA6IFs3LCAyN10sCiAgICAnd2hpdGUnIDogWzM3LCAzOV0sCiAgICAnZ3JleScgOiBbOTAsIDM5XSwKICAgICdibGFjaycgOiBbMzAsIDM5XSwKICAgICdibHVlJyA6IFszNCwgMzldLAogICAgJ2N5YW4nIDogWzM2LCAzOV0sCiAgICAnZ3JlZW4nIDogWzMyLCAzOV0sCiAgICAnbWFnZW50YScgOiBbMzUsIDM5XSwKICAgICdyZWQnIDogWzMxLCAzOV0sCiAgICAneWVsbG93JyA6IFszMywgMzldCiAgfTsKICAKICAvLyBEb24ndCB1c2UgJ2JsdWUnIG5vdCB2aXNpYmxlIG9uIGNtZC5leGUKICBpbnNwZWN0LnN0eWxlcyA9IHsKICAgICdzcGVjaWFsJzogJ2N5YW4nLAogICAgJ251bWJlcic6ICd5ZWxsb3cnLAogICAgJ2Jvb2xlYW4nOiAneWVsbG93JywKICAgICd1bmRlZmluZWQnOiAnZ3JleScsCiAgICAnbnVsbCc6ICdib2xkJywKICAgICdzdHJpbmcnOiAnZ3JlZW4nLAogICAgJ2RhdGUnOiAnbWFnZW50YScsCiAgICAvLyAibmFtZSI6IGludGVudGlvbmFsbHkgbm90IHN0eWxpbmcKICAgICdyZWdleHAnOiAncmVkJwogIH07CiAgCiAgCiAgZnVuY3Rpb24gc3R5bGl6ZVdpdGhDb2xvcihzdHIsIHN0eWxlVHlwZSkgewogICAgdmFyIHN0eWxlID0gaW5zcGVjdC5zdHlsZXNbc3R5bGVUeXBlXTsKICAKICAgIGlmIChzdHlsZSkgewogICAgICByZXR1cm4gJ1x1MDAxYlsnICsgaW5zcGVjdC5jb2xvcnNbc3R5bGVdWzBdICsgJ20nICsgc3RyICsKICAgICAgICAgICAgICdcdTAwMWJbJyArIGluc3BlY3QuY29sb3JzW3N0eWxlXVsxXSArICdtJzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBzdHI7CiAgICB9CiAgfQogIAogIAogIGZ1bmN0aW9uIHN0eWxpemVOb0NvbG9yKHN0ciwgc3R5bGVUeXBlKSB7CiAgICByZXR1cm4gc3RyOwogIH0KICAKICAKICBmdW5jdGlvbiBhcnJheVRvSGFzaChhcnJheSkgewogICAgdmFyIGhhc2ggPSB7fTsKICAKICAgIGFycmF5LmZvckVhY2goZnVuY3Rpb24odmFsLCBpZHgpIHsKICAgICAgaGFzaFt2YWxdID0gdHJ1ZTsKICAgIH0pOwogIAogICAgcmV0dXJuIGhhc2g7CiAgfQogIAogIAogIGZ1bmN0aW9uIGZvcm1hdFZhbHVlKGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcykgewogICAgLy8gUHJvdmlkZSBhIGhvb2sgZm9yIHVzZXItc3BlY2lmaWVkIGluc3BlY3QgZnVuY3Rpb25zLgogICAgLy8gQ2hlY2sgdGhhdCB2YWx1ZSBpcyBhbiBvYmplY3Qgd2l0aCBhbiBpbnNwZWN0IGZ1bmN0aW9uIG9uIGl0CiAgICBpZiAoY3R4LmN1c3RvbUluc3BlY3QgJiYKICAgICAgICB2YWx1ZSAmJgogICAgICAgIGlzRnVuY3Rpb24odmFsdWUuaW5zcGVjdCkgJiYKICAgICAgICAvLyBGaWx0ZXIgb3V0IHRoZSB1dGlsIG1vZHVsZSwgaXQncyBpbnNwZWN0IGZ1bmN0aW9uIGlzIHNwZWNpYWwKICAgICAgICB2YWx1ZS5pbnNwZWN0ICE9PSBleHBvcnRzLmluc3BlY3QgJiYKICAgICAgICAvLyBBbHNvIGZpbHRlciBvdXQgYW55IHByb3RvdHlwZSBvYmplY3RzIHVzaW5nIHRoZSBjaXJjdWxhciBjaGVjay4KICAgICAgICAhKHZhbHVlLmNvbnN0cnVjdG9yICYmIHZhbHVlLmNvbnN0cnVjdG9yLnByb3RvdHlwZSA9PT0gdmFsdWUpKSB7CiAgICAgIHZhciByZXQgPSB2YWx1ZS5pbnNwZWN0KHJlY3Vyc2VUaW1lcywgY3R4KTsKICAgICAgaWYgKCFpc1N0cmluZyhyZXQpKSB7CiAgICAgICAgcmV0ID0gZm9ybWF0VmFsdWUoY3R4LCByZXQsIHJlY3Vyc2VUaW1lcyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJldDsKICAgIH0KICAKICAgIC8vIFByaW1pdGl2ZSB0eXBlcyBjYW5ub3QgaGF2ZSBwcm9wZXJ0aWVzCiAgICB2YXIgcHJpbWl0aXZlID0gZm9ybWF0UHJpbWl0aXZlKGN0eCwgdmFsdWUpOwogICAgaWYgKHByaW1pdGl2ZSkgewogICAgICByZXR1cm4gcHJpbWl0aXZlOwogICAgfQogIAogICAgLy8gTG9vayB1cCB0aGUga2V5cyBvZiB0aGUgb2JqZWN0LgogICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7CiAgICB2YXIgdmlzaWJsZUtleXMgPSBhcnJheVRvSGFzaChrZXlzKTsKICAKICAgIGlmIChjdHguc2hvd0hpZGRlbikgewogICAgICBrZXlzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXModmFsdWUpOwogICAgfQogIAogICAgLy8gSUUgZG9lc24ndCBtYWtlIGVycm9yIGZpZWxkcyBub24tZW51bWVyYWJsZQogICAgLy8gaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L2llL2R3dzUyc2J0KHY9dnMuOTQpLmFzcHgKICAgIGlmIChpc0Vycm9yKHZhbHVlKQogICAgICAgICYmIChrZXlzLmluZGV4T2YoJ21lc3NhZ2UnKSA+PSAwIHx8IGtleXMuaW5kZXhPZignZGVzY3JpcHRpb24nKSA+PSAwKSkgewogICAgICByZXR1cm4gZm9ybWF0RXJyb3IodmFsdWUpOwogICAgfQogIAogICAgLy8gU29tZSB0eXBlIG9mIG9iamVjdCB3aXRob3V0IHByb3BlcnRpZXMgY2FuIGJlIHNob3J0Y3V0dGVkLgogICAgaWYgKGtleXMubGVuZ3RoID09PSAwKSB7CiAgICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgIHZhciBuYW1lID0gdmFsdWUubmFtZSA/ICc6ICcgKyB2YWx1ZS5uYW1lIDogJyc7CiAgICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKCdbRnVuY3Rpb24nICsgbmFtZSArICddJywgJ3NwZWNpYWwnKTsKICAgICAgfQogICAgICBpZiAoaXNSZWdFeHAodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKFJlZ0V4cC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSksICdyZWdleHAnKTsKICAgICAgfQogICAgICBpZiAoaXNEYXRlKHZhbHVlKSkgewogICAgICAgIHJldHVybiBjdHguc3R5bGl6ZShEYXRlLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSwgJ2RhdGUnKTsKICAgICAgfQogICAgICBpZiAoaXNFcnJvcih2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gZm9ybWF0RXJyb3IodmFsdWUpOwogICAgICB9CiAgICB9CiAgCiAgICB2YXIgYmFzZSA9ICcnLCBhcnJheSA9IGZhbHNlLCBicmFjZXMgPSBbJ3snLCAnfSddOwogIAogICAgLy8gTWFrZSBBcnJheSBzYXkgdGhhdCB0aGV5IGFyZSBBcnJheQogICAgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgIGFycmF5ID0gdHJ1ZTsKICAgICAgYnJhY2VzID0gWydbJywgJ10nXTsKICAgIH0KICAKICAgIC8vIE1ha2UgZnVuY3Rpb25zIHNheSB0aGF0IHRoZXkgYXJlIGZ1bmN0aW9ucwogICAgaWYgKGlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgIHZhciBuID0gdmFsdWUubmFtZSA/ICc6ICcgKyB2YWx1ZS5uYW1lIDogJyc7CiAgICAgIGJhc2UgPSAnIFtGdW5jdGlvbicgKyBuICsgJ10nOwogICAgfQogIAogICAgLy8gTWFrZSBSZWdFeHBzIHNheSB0aGF0IHRoZXkgYXJlIFJlZ0V4cHMKICAgIGlmIChpc1JlZ0V4cCh2YWx1ZSkpIHsKICAgICAgYmFzZSA9ICcgJyArIFJlZ0V4cC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSk7CiAgICB9CiAgCiAgICAvLyBNYWtlIGRhdGVzIHdpdGggcHJvcGVydGllcyBmaXJzdCBzYXkgdGhlIGRhdGUKICAgIGlmIChpc0RhdGUodmFsdWUpKSB7CiAgICAgIGJhc2UgPSAnICcgKyBEYXRlLnByb3RvdHlwZS50b1VUQ1N0cmluZy5jYWxsKHZhbHVlKTsKICAgIH0KICAKICAgIC8vIE1ha2UgZXJyb3Igd2l0aCBtZXNzYWdlIGZpcnN0IHNheSB0aGUgZXJyb3IKICAgIGlmIChpc0Vycm9yKHZhbHVlKSkgewogICAgICBiYXNlID0gJyAnICsgZm9ybWF0RXJyb3IodmFsdWUpOwogICAgfQogIAogICAgaWYgKGtleXMubGVuZ3RoID09PSAwICYmICghYXJyYXkgfHwgdmFsdWUubGVuZ3RoID09IDApKSB7CiAgICAgIHJldHVybiBicmFjZXNbMF0gKyBiYXNlICsgYnJhY2VzWzFdOwogICAgfQogIAogICAgaWYgKHJlY3Vyc2VUaW1lcyA8IDApIHsKICAgICAgaWYgKGlzUmVnRXhwKHZhbHVlKSkgewogICAgICAgIHJldHVybiBjdHguc3R5bGl6ZShSZWdFeHAucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpLCAncmVnZXhwJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKCdbT2JqZWN0XScsICdzcGVjaWFsJyk7CiAgICAgIH0KICAgIH0KICAKICAgIGN0eC5zZWVuLnB1c2godmFsdWUpOwogIAogICAgdmFyIG91dHB1dDsKICAgIGlmIChhcnJheSkgewogICAgICBvdXRwdXQgPSBmb3JtYXRBcnJheShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLCBrZXlzKTsKICAgIH0gZWxzZSB7CiAgICAgIG91dHB1dCA9IGtleXMubWFwKGZ1bmN0aW9uKGtleSkgewogICAgICAgIHJldHVybiBmb3JtYXRQcm9wZXJ0eShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLCBrZXksIGFycmF5KTsKICAgICAgfSk7CiAgICB9CiAgCiAgICBjdHguc2Vlbi5wb3AoKTsKICAKICAgIHJldHVybiByZWR1Y2VUb1NpbmdsZVN0cmluZyhvdXRwdXQsIGJhc2UsIGJyYWNlcyk7CiAgfQogIAogIAogIGZ1bmN0aW9uIGZvcm1hdFByaW1pdGl2ZShjdHgsIHZhbHVlKSB7CiAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKQogICAgICByZXR1cm4gY3R4LnN0eWxpemUoJ3VuZGVmaW5lZCcsICd1bmRlZmluZWQnKTsKICAgIGlmIChpc1N0cmluZyh2YWx1ZSkpIHsKICAgICAgdmFyIHNpbXBsZSA9ICdcJycgKyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkucmVwbGFjZSgvXiJ8IiQvZywgJycpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoLycvZywgIlxcJyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcIi9nLCAnIicpICsgJ1wnJzsKICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKHNpbXBsZSwgJ3N0cmluZycpOwogICAgfQogICAgaWYgKGlzTnVtYmVyKHZhbHVlKSkKICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKCcnICsgdmFsdWUsICdudW1iZXInKTsKICAgIGlmIChpc0Jvb2xlYW4odmFsdWUpKQogICAgICByZXR1cm4gY3R4LnN0eWxpemUoJycgKyB2YWx1ZSwgJ2Jvb2xlYW4nKTsKICAgIC8vIEZvciBzb21lIHJlYXNvbiB0eXBlb2YgbnVsbCBpcyAib2JqZWN0Iiwgc28gc3BlY2lhbCBjYXNlIGhlcmUuCiAgICBpZiAoaXNOdWxsKHZhbHVlKSkKICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKCdudWxsJywgJ251bGwnKTsKICB9CiAgCiAgCiAgZnVuY3Rpb24gZm9ybWF0RXJyb3IodmFsdWUpIHsKICAgIHJldHVybiAnWycgKyBFcnJvci5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSkgKyAnXSc7CiAgfQogIAogIAogIGZ1bmN0aW9uIGZvcm1hdEFycmF5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsIGtleXMpIHsKICAgIHZhciBvdXRwdXQgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gdmFsdWUubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eSh2YWx1ZSwgU3RyaW5nKGkpKSkgewogICAgICAgIG91dHB1dC5wdXNoKGZvcm1hdFByb3BlcnR5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsCiAgICAgICAgICAgIFN0cmluZyhpKSwgdHJ1ZSkpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dHB1dC5wdXNoKCcnKTsKICAgICAgfQogICAgfQogICAga2V5cy5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgICBpZiAoIWtleS5tYXRjaCgvXlxkKyQvKSkgewogICAgICAgIG91dHB1dC5wdXNoKGZvcm1hdFByb3BlcnR5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsCiAgICAgICAgICAgIGtleSwgdHJ1ZSkpOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBvdXRwdXQ7CiAgfQogIAogIAogIGZ1bmN0aW9uIGZvcm1hdFByb3BlcnR5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsIGtleSwgYXJyYXkpIHsKICAgIHZhciBuYW1lLCBzdHIsIGRlc2M7CiAgICBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih2YWx1ZSwga2V5KSB8fCB7IHZhbHVlOiB2YWx1ZVtrZXldIH07CiAgICBpZiAoZGVzYy5nZXQpIHsKICAgICAgaWYgKGRlc2Muc2V0KSB7CiAgICAgICAgc3RyID0gY3R4LnN0eWxpemUoJ1tHZXR0ZXIvU2V0dGVyXScsICdzcGVjaWFsJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RyID0gY3R4LnN0eWxpemUoJ1tHZXR0ZXJdJywgJ3NwZWNpYWwnKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGRlc2Muc2V0KSB7CiAgICAgICAgc3RyID0gY3R4LnN0eWxpemUoJ1tTZXR0ZXJdJywgJ3NwZWNpYWwnKTsKICAgICAgfQogICAgfQogICAgaWYgKCFoYXNPd25Qcm9wZXJ0eSh2aXNpYmxlS2V5cywga2V5KSkgewogICAgICBuYW1lID0gJ1snICsga2V5ICsgJ10nOwogICAgfQogICAgaWYgKCFzdHIpIHsKICAgICAgaWYgKGN0eC5zZWVuLmluZGV4T2YoZGVzYy52YWx1ZSkgPCAwKSB7CiAgICAgICAgaWYgKGlzTnVsbChyZWN1cnNlVGltZXMpKSB7CiAgICAgICAgICBzdHIgPSBmb3JtYXRWYWx1ZShjdHgsIGRlc2MudmFsdWUsIG51bGwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdHIgPSBmb3JtYXRWYWx1ZShjdHgsIGRlc2MudmFsdWUsIHJlY3Vyc2VUaW1lcyAtIDEpOwogICAgICAgIH0KICAgICAgICBpZiAoc3RyLmluZGV4T2YoJ1xuJykgPiAtMSkgewogICAgICAgICAgaWYgKGFycmF5KSB7CiAgICAgICAgICAgIHN0ciA9IHN0ci5zcGxpdCgnXG4nKS5tYXAoZnVuY3Rpb24obGluZSkgewogICAgICAgICAgICAgIHJldHVybiAnICAnICsgbGluZTsKICAgICAgICAgICAgfSkuam9pbignXG4nKS5zdWJzdHIoMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdHIgPSAnXG4nICsgc3RyLnNwbGl0KCdcbicpLm1hcChmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICcgICAnICsgbGluZTsKICAgICAgICAgICAgfSkuam9pbignXG4nKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RyID0gY3R4LnN0eWxpemUoJ1tDaXJjdWxhcl0nLCAnc3BlY2lhbCcpOwogICAgICB9CiAgICB9CiAgICBpZiAoaXNVbmRlZmluZWQobmFtZSkpIHsKICAgICAgaWYgKGFycmF5ICYmIGtleS5tYXRjaCgvXlxkKyQvKSkgewogICAgICAgIHJldHVybiBzdHI7CiAgICAgIH0KICAgICAgbmFtZSA9IEpTT04uc3RyaW5naWZ5KCcnICsga2V5KTsKICAgICAgaWYgKG5hbWUubWF0Y2goL14iKFthLXpBLVpfXVthLXpBLVpfMC05XSopIiQvKSkgewogICAgICAgIG5hbWUgPSBuYW1lLnN1YnN0cigxLCBuYW1lLmxlbmd0aCAtIDIpOwogICAgICAgIG5hbWUgPSBjdHguc3R5bGl6ZShuYW1lLCAnbmFtZScpOwogICAgICB9IGVsc2UgewogICAgICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UoLycvZywgIlxcJyIpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFwiL2csICciJykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8oXiJ8IiQpL2csICInIik7CiAgICAgICAgbmFtZSA9IGN0eC5zdHlsaXplKG5hbWUsICdzdHJpbmcnKTsKICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIG5hbWUgKyAnOiAnICsgc3RyOwogIH0KICAKICAKICBmdW5jdGlvbiByZWR1Y2VUb1NpbmdsZVN0cmluZyhvdXRwdXQsIGJhc2UsIGJyYWNlcykgewogICAgdmFyIG51bUxpbmVzRXN0ID0gMDsKICAgIHZhciBsZW5ndGggPSBvdXRwdXQucmVkdWNlKGZ1bmN0aW9uKHByZXYsIGN1cikgewogICAgICBudW1MaW5lc0VzdCsrOwogICAgICBpZiAoY3VyLmluZGV4T2YoJ1xuJykgPj0gMCkgbnVtTGluZXNFc3QrKzsKICAgICAgcmV0dXJuIHByZXYgKyBjdXIucmVwbGFjZSgvXHUwMDFiXFtcZFxkP20vZywgJycpLmxlbmd0aCArIDE7CiAgICB9LCAwKTsKICAKICAgIGlmIChsZW5ndGggPiA2MCkgewogICAgICByZXR1cm4gYnJhY2VzWzBdICsKICAgICAgICAgICAgIChiYXNlID09PSAnJyA/ICcnIDogYmFzZSArICdcbiAnKSArCiAgICAgICAgICAgICAnICcgKwogICAgICAgICAgICAgb3V0cHV0LmpvaW4oJyxcbiAgJykgKwogICAgICAgICAgICAgJyAnICsKICAgICAgICAgICAgIGJyYWNlc1sxXTsKICAgIH0KICAKICAgIHJldHVybiBicmFjZXNbMF0gKyBiYXNlICsgJyAnICsgb3V0cHV0LmpvaW4oJywgJykgKyAnICcgKyBicmFjZXNbMV07CiAgfQogIAogIAogIC8vIE5PVEU6IFRoZXNlIHR5cGUgY2hlY2tpbmcgZnVuY3Rpb25zIGludGVudGlvbmFsbHkgZG9uJ3QgdXNlIGBpbnN0YW5jZW9mYAogIC8vIGJlY2F1c2UgaXQgaXMgZnJhZ2lsZSBhbmQgY2FuIGJlIGVhc2lseSBmYWtlZCB3aXRoIGBPYmplY3QuY3JlYXRlKClgLgogIGZ1bmN0aW9uIGlzQXJyYXkoYXIpIHsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KGFyKTsKICB9CiAgZXhwb3J0cy5pc0FycmF5ID0gaXNBcnJheTsKICAKICBmdW5jdGlvbiBpc0Jvb2xlYW4oYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ2Jvb2xlYW4nOwogIH0KICBleHBvcnRzLmlzQm9vbGVhbiA9IGlzQm9vbGVhbjsKICAKICBmdW5jdGlvbiBpc051bGwoYXJnKSB7CiAgICByZXR1cm4gYXJnID09PSBudWxsOwogIH0KICBleHBvcnRzLmlzTnVsbCA9IGlzTnVsbDsKICAKICBmdW5jdGlvbiBpc051bGxPclVuZGVmaW5lZChhcmcpIHsKICAgIHJldHVybiBhcmcgPT0gbnVsbDsKICB9CiAgZXhwb3J0cy5pc051bGxPclVuZGVmaW5lZCA9IGlzTnVsbE9yVW5kZWZpbmVkOwogIAogIGZ1bmN0aW9uIGlzTnVtYmVyKGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdudW1iZXInOwogIH0KICBleHBvcnRzLmlzTnVtYmVyID0gaXNOdW1iZXI7CiAgCiAgZnVuY3Rpb24gaXNTdHJpbmcoYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ3N0cmluZyc7CiAgfQogIGV4cG9ydHMuaXNTdHJpbmcgPSBpc1N0cmluZzsKICAKICBmdW5jdGlvbiBpc1N5bWJvbChhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnc3ltYm9sJzsKICB9CiAgZXhwb3J0cy5pc1N5bWJvbCA9IGlzU3ltYm9sOwogIAogIGZ1bmN0aW9uIGlzVW5kZWZpbmVkKGFyZykgewogICAgcmV0dXJuIGFyZyA9PT0gdm9pZCAwOwogIH0KICBleHBvcnRzLmlzVW5kZWZpbmVkID0gaXNVbmRlZmluZWQ7CiAgCiAgZnVuY3Rpb24gaXNSZWdFeHAocmUpIHsKICAgIHJldHVybiBpc09iamVjdChyZSkgJiYgb2JqZWN0VG9TdHJpbmcocmUpID09PSAnW29iamVjdCBSZWdFeHBdJzsKICB9CiAgZXhwb3J0cy5pc1JlZ0V4cCA9IGlzUmVnRXhwOwogIAogIGZ1bmN0aW9uIGlzT2JqZWN0KGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdvYmplY3QnICYmIGFyZyAhPT0gbnVsbDsKICB9CiAgZXhwb3J0cy5pc09iamVjdCA9IGlzT2JqZWN0OwogIAogIGZ1bmN0aW9uIGlzRGF0ZShkKSB7CiAgICByZXR1cm4gaXNPYmplY3QoZCkgJiYgb2JqZWN0VG9TdHJpbmcoZCkgPT09ICdbb2JqZWN0IERhdGVdJzsKICB9CiAgZXhwb3J0cy5pc0RhdGUgPSBpc0RhdGU7CiAgCiAgZnVuY3Rpb24gaXNFcnJvcihlKSB7CiAgICByZXR1cm4gaXNPYmplY3QoZSkgJiYKICAgICAgICAob2JqZWN0VG9TdHJpbmcoZSkgPT09ICdbb2JqZWN0IEVycm9yXScgfHwgZSBpbnN0YW5jZW9mIEVycm9yKTsKICB9CiAgZXhwb3J0cy5pc0Vycm9yID0gaXNFcnJvcjsKICAKICBmdW5jdGlvbiBpc0Z1bmN0aW9uKGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdmdW5jdGlvbic7CiAgfQogIGV4cG9ydHMuaXNGdW5jdGlvbiA9IGlzRnVuY3Rpb247CiAgCiAgZnVuY3Rpb24gaXNQcmltaXRpdmUoYXJnKSB7CiAgICByZXR1cm4gYXJnID09PSBudWxsIHx8CiAgICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ2Jvb2xlYW4nIHx8CiAgICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ251bWJlcicgfHwKICAgICAgICAgICB0eXBlb2YgYXJnID09PSAnc3RyaW5nJyB8fAogICAgICAgICAgIHR5cGVvZiBhcmcgPT09ICdzeW1ib2wnIHx8ICAvLyBFUzYgc3ltYm9sCiAgICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ3VuZGVmaW5lZCc7CiAgfQogIGV4cG9ydHMuaXNQcmltaXRpdmUgPSBpc1ByaW1pdGl2ZTsKICAKICBleHBvcnRzLmlzQnVmZmVyID0gcmVxdWlyZSgnLi9zdXBwb3J0L2lzQnVmZmVyJyk7CiAgCiAgZnVuY3Rpb24gb2JqZWN0VG9TdHJpbmcobykgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvKTsKICB9CiAgCiAgCiAgZnVuY3Rpb24gcGFkKG4pIHsKICAgIHJldHVybiBuIDwgMTAgPyAnMCcgKyBuLnRvU3RyaW5nKDEwKSA6IG4udG9TdHJpbmcoMTApOwogIH0KICAKICAKICB2YXIgbW9udGhzID0gWydKYW4nLCAnRmViJywgJ01hcicsICdBcHInLCAnTWF5JywgJ0p1bicsICdKdWwnLCAnQXVnJywgJ1NlcCcsCiAgICAgICAgICAgICAgICAnT2N0JywgJ05vdicsICdEZWMnXTsKICAKICAvLyAyNiBGZWIgMTY6MTk6MzQKICBmdW5jdGlvbiB0aW1lc3RhbXAoKSB7CiAgICB2YXIgZCA9IG5ldyBEYXRlKCk7CiAgICB2YXIgdGltZSA9IFtwYWQoZC5nZXRIb3VycygpKSwKICAgICAgICAgICAgICAgIHBhZChkLmdldE1pbnV0ZXMoKSksCiAgICAgICAgICAgICAgICBwYWQoZC5nZXRTZWNvbmRzKCkpXS5qb2luKCc6Jyk7CiAgICByZXR1cm4gW2QuZ2V0RGF0ZSgpLCBtb250aHNbZC5nZXRNb250aCgpXSwgdGltZV0uam9pbignICcpOwogIH0KICAKICAKICAvLyBsb2cgaXMganVzdCBhIHRoaW4gd3JhcHBlciB0byBjb25zb2xlLmxvZyB0aGF0IHByZXBlbmRzIGEgdGltZXN0YW1wCiAgZXhwb3J0cy5sb2cgPSBmdW5jdGlvbigpIHsKICAgIGNvbnNvbGUubG9nKCclcyAtICVzJywgdGltZXN0YW1wKCksIGV4cG9ydHMuZm9ybWF0LmFwcGx5KGV4cG9ydHMsIGFyZ3VtZW50cykpOwogIH07CiAgCiAgCiAgLyoqCiAgICogSW5oZXJpdCB0aGUgcHJvdG90eXBlIG1ldGhvZHMgZnJvbSBvbmUgY29uc3RydWN0b3IgaW50byBhbm90aGVyLgogICAqCiAgICogVGhlIEZ1bmN0aW9uLnByb3RvdHlwZS5pbmhlcml0cyBmcm9tIGxhbmcuanMgcmV3cml0dGVuIGFzIGEgc3RhbmRhbG9uZQogICAqIGZ1bmN0aW9uIChub3Qgb24gRnVuY3Rpb24ucHJvdG90eXBlKS4gTk9URTogSWYgdGhpcyBmaWxlIGlzIHRvIGJlIGxvYWRlZAogICAqIGR1cmluZyBib290c3RyYXBwaW5nIHRoaXMgZnVuY3Rpb24gbmVlZHMgdG8gYmUgcmV3cml0dGVuIHVzaW5nIHNvbWUgbmF0aXZlCiAgICogZnVuY3Rpb25zIGFzIHByb3RvdHlwZSBzZXR1cCB1c2luZyBub3JtYWwgSmF2YVNjcmlwdCBkb2VzIG5vdCB3b3JrIGFzCiAgICogZXhwZWN0ZWQgZHVyaW5nIGJvb3RzdHJhcHBpbmcgKHNlZSBtaXJyb3IuanMgaW4gcjExNDkwMykuCiAgICoKICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjdG9yIENvbnN0cnVjdG9yIGZ1bmN0aW9uIHdoaWNoIG5lZWRzIHRvIGluaGVyaXQgdGhlCiAgICogICAgIHByb3RvdHlwZS4KICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBzdXBlckN0b3IgQ29uc3RydWN0b3IgZnVuY3Rpb24gdG8gaW5oZXJpdCBwcm90b3R5cGUgZnJvbS4KICAgKi8KICBleHBvcnRzLmluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKICAKICBleHBvcnRzLl9leHRlbmQgPSBmdW5jdGlvbihvcmlnaW4sIGFkZCkgewogICAgLy8gRG9uJ3QgZG8gYW55dGhpbmcgaWYgYWRkIGlzbid0IGFuIG9iamVjdAogICAgaWYgKCFhZGQgfHwgIWlzT2JqZWN0KGFkZCkpIHJldHVybiBvcmlnaW47CiAgCiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGFkZCk7CiAgICB2YXIgaSA9IGtleXMubGVuZ3RoOwogICAgd2hpbGUgKGktLSkgewogICAgICBvcmlnaW5ba2V5c1tpXV0gPSBhZGRba2V5c1tpXV07CiAgICB9CiAgICByZXR1cm4gb3JpZ2luOwogIH07CiAgCiAgZnVuY3Rpb24gaGFzT3duUHJvcGVydHkob2JqLCBwcm9wKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCk7CiAgfQogIAogIH0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpLHR5cGVvZiBnbG9iYWwgIT09ICJ1bmRlZmluZWQiID8gZ2xvYmFsIDogdHlwZW9mIHNlbGYgIT09ICJ1bmRlZmluZWQiID8gc2VsZiA6IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDoge30pCiAgfSx7Ii4vc3VwcG9ydC9pc0J1ZmZlciI6OTYsIl9wcm9jZXNzIjo4NSwiaW5oZXJpdHMiOjk1fV0sOTg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB2MSA9IHJlcXVpcmUoJy4vdjEnKTsKICB2YXIgdjQgPSByZXF1aXJlKCcuL3Y0Jyk7CiAgCiAgdmFyIHV1aWQgPSB2NDsKICB1dWlkLnYxID0gdjE7CiAgdXVpZC52NCA9IHY0OwogIAogIG1vZHVsZS5leHBvcnRzID0gdXVpZDsKICAKICB9LHsiLi92MSI6MTAxLCIuL3Y0IjoxMDJ9XSw5OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLyoqCiAgICogQ29udmVydCBhcnJheSBvZiAxNiBieXRlIHZhbHVlcyB0byBVVUlEIHN0cmluZyBmb3JtYXQgb2YgdGhlIGZvcm06CiAgICogWFhYWFhYWFgtWFhYWC1YWFhYLVhYWFgtWFhYWFhYWFhYWFhYCiAgICovCiAgdmFyIGJ5dGVUb0hleCA9IFtdOwogIGZvciAodmFyIGkgPSAwOyBpIDwgMjU2OyArK2kpIHsKICAgIGJ5dGVUb0hleFtpXSA9IChpICsgMHgxMDApLnRvU3RyaW5nKDE2KS5zdWJzdHIoMSk7CiAgfQogIAogIGZ1bmN0aW9uIGJ5dGVzVG9VdWlkKGJ1Ziwgb2Zmc2V0KSB7CiAgICB2YXIgaSA9IG9mZnNldCB8fCAwOwogICAgdmFyIGJ0aCA9IGJ5dGVUb0hleDsKICAgIC8vIGpvaW4gdXNlZCB0byBmaXggbWVtb3J5IGlzc3VlIGNhdXNlZCBieSBjb25jYXRlbmF0aW9uOiBodHRwczovL2J1Z3MuY2hyb21pdW0ub3JnL3AvdjgvaXNzdWVzL2RldGFpbD9pZD0zMTc1I2M0CiAgICByZXR1cm4gKFtidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLCAKICAgIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sICctJywKICAgIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sICctJywKICAgIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sICctJywKICAgIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sICctJywKICAgIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sCiAgICBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXV0pLmpvaW4oJycpOwogIH0KICAKICBtb2R1bGUuZXhwb3J0cyA9IGJ5dGVzVG9VdWlkOwogIAogIH0se31dLDEwMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gVW5pcXVlIElEIGNyZWF0aW9uIHJlcXVpcmVzIGEgaGlnaCBxdWFsaXR5IHJhbmRvbSAjIGdlbmVyYXRvci4gIEluIHRoZQogIC8vIGJyb3dzZXIgdGhpcyBpcyBhIGxpdHRsZSBjb21wbGljYXRlZCBkdWUgdG8gdW5rbm93biBxdWFsaXR5IG9mIE1hdGgucmFuZG9tKCkKICAvLyBhbmQgaW5jb25zaXN0ZW50IHN1cHBvcnQgZm9yIHRoZSBgY3J5cHRvYCBBUEkuICBXZSBkbyB0aGUgYmVzdCB3ZSBjYW4gdmlhCiAgLy8gZmVhdHVyZS1kZXRlY3Rpb24KICAKICAvLyBnZXRSYW5kb21WYWx1ZXMgbmVlZHMgdG8gYmUgaW52b2tlZCBpbiBhIGNvbnRleHQgd2hlcmUgInRoaXMiIGlzIGEgQ3J5cHRvCiAgLy8gaW1wbGVtZW50YXRpb24uIEFsc28sIGZpbmQgdGhlIGNvbXBsZXRlIGltcGxlbWVudGF0aW9uIG9mIGNyeXB0byBvbiBJRTExLgogIHZhciBnZXRSYW5kb21WYWx1ZXMgPSAodHlwZW9mKGNyeXB0bykgIT0gJ3VuZGVmaW5lZCcgJiYgY3J5cHRvLmdldFJhbmRvbVZhbHVlcyAmJiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzLmJpbmQoY3J5cHRvKSkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgKHR5cGVvZihtc0NyeXB0bykgIT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIHdpbmRvdy5tc0NyeXB0by5nZXRSYW5kb21WYWx1ZXMgPT0gJ2Z1bmN0aW9uJyAmJiBtc0NyeXB0by5nZXRSYW5kb21WYWx1ZXMuYmluZChtc0NyeXB0bykpOwogIAogIGlmIChnZXRSYW5kb21WYWx1ZXMpIHsKICAgIC8vIFdIQVRXRyBjcnlwdG8gUk5HIC0gaHR0cDovL3dpa2kud2hhdHdnLm9yZy93aWtpL0NyeXB0bwogICAgdmFyIHJuZHM4ID0gbmV3IFVpbnQ4QXJyYXkoMTYpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVuZGVmCiAgCiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIHdoYXR3Z1JORygpIHsKICAgICAgZ2V0UmFuZG9tVmFsdWVzKHJuZHM4KTsKICAgICAgcmV0dXJuIHJuZHM4OwogICAgfTsKICB9IGVsc2UgewogICAgLy8gTWF0aC5yYW5kb20oKS1iYXNlZCAoUk5HKQogICAgLy8KICAgIC8vIElmIGFsbCBlbHNlIGZhaWxzLCB1c2UgTWF0aC5yYW5kb20oKS4gIEl0J3MgZmFzdCwgYnV0IGlzIG9mIHVuc3BlY2lmaWVkCiAgICAvLyBxdWFsaXR5LgogICAgdmFyIHJuZHMgPSBuZXcgQXJyYXkoMTYpOwogIAogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBtYXRoUk5HKCkgewogICAgICBmb3IgKHZhciBpID0gMCwgcjsgaSA8IDE2OyBpKyspIHsKICAgICAgICBpZiAoKGkgJiAweDAzKSA9PT0gMCkgciA9IE1hdGgucmFuZG9tKCkgKiAweDEwMDAwMDAwMDsKICAgICAgICBybmRzW2ldID0gciA+Pj4gKChpICYgMHgwMykgPDwgMykgJiAweGZmOwogICAgICB9CiAgCiAgICAgIHJldHVybiBybmRzOwogICAgfTsKICB9CiAgCiAgfSx7fV0sMTAxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgcm5nID0gcmVxdWlyZSgnLi9saWIvcm5nJyk7CiAgdmFyIGJ5dGVzVG9VdWlkID0gcmVxdWlyZSgnLi9saWIvYnl0ZXNUb1V1aWQnKTsKICAKICAvLyAqKmB2MSgpYCAtIEdlbmVyYXRlIHRpbWUtYmFzZWQgVVVJRCoqCiAgLy8KICAvLyBJbnNwaXJlZCBieSBodHRwczovL2dpdGh1Yi5jb20vTGlvc0svVVVJRC5qcwogIC8vIGFuZCBodHRwOi8vZG9jcy5weXRob24ub3JnL2xpYnJhcnkvdXVpZC5odG1sCiAgCiAgdmFyIF9ub2RlSWQ7CiAgdmFyIF9jbG9ja3NlcTsKICAKICAvLyBQcmV2aW91cyB1dWlkIGNyZWF0aW9uIHRpbWUKICB2YXIgX2xhc3RNU2VjcyA9IDA7CiAgdmFyIF9sYXN0TlNlY3MgPSAwOwogIAogIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vYnJvb2ZhL25vZGUtdXVpZCBmb3IgQVBJIGRldGFpbHMKICBmdW5jdGlvbiB2MShvcHRpb25zLCBidWYsIG9mZnNldCkgewogICAgdmFyIGkgPSBidWYgJiYgb2Zmc2V0IHx8IDA7CiAgICB2YXIgYiA9IGJ1ZiB8fCBbXTsKICAKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdmFyIG5vZGUgPSBvcHRpb25zLm5vZGUgfHwgX25vZGVJZDsKICAgIHZhciBjbG9ja3NlcSA9IG9wdGlvbnMuY2xvY2tzZXEgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuY2xvY2tzZXEgOiBfY2xvY2tzZXE7CiAgCiAgICAvLyBub2RlIGFuZCBjbG9ja3NlcSBuZWVkIHRvIGJlIGluaXRpYWxpemVkIHRvIHJhbmRvbSB2YWx1ZXMgaWYgdGhleSdyZSBub3QKICAgIC8vIHNwZWNpZmllZC4gIFdlIGRvIHRoaXMgbGF6aWx5IHRvIG1pbmltaXplIGlzc3VlcyByZWxhdGVkIHRvIGluc3VmZmljaWVudAogICAgLy8gc3lzdGVtIGVudHJvcHkuICBTZWUgIzE4OQogICAgaWYgKG5vZGUgPT0gbnVsbCB8fCBjbG9ja3NlcSA9PSBudWxsKSB7CiAgICAgIHZhciBzZWVkQnl0ZXMgPSBybmcoKTsKICAgICAgaWYgKG5vZGUgPT0gbnVsbCkgewogICAgICAgIC8vIFBlciA0LjUsIGNyZWF0ZSBhbmQgNDgtYml0IG5vZGUgaWQsICg0NyByYW5kb20gYml0cyArIG11bHRpY2FzdCBiaXQgPSAxKQogICAgICAgIG5vZGUgPSBfbm9kZUlkID0gWwogICAgICAgICAgc2VlZEJ5dGVzWzBdIHwgMHgwMSwKICAgICAgICAgIHNlZWRCeXRlc1sxXSwgc2VlZEJ5dGVzWzJdLCBzZWVkQnl0ZXNbM10sIHNlZWRCeXRlc1s0XSwgc2VlZEJ5dGVzWzVdCiAgICAgICAgXTsKICAgICAgfQogICAgICBpZiAoY2xvY2tzZXEgPT0gbnVsbCkgewogICAgICAgIC8vIFBlciA0LjIuMiwgcmFuZG9taXplICgxNCBiaXQpIGNsb2Nrc2VxCiAgICAgICAgY2xvY2tzZXEgPSBfY2xvY2tzZXEgPSAoc2VlZEJ5dGVzWzZdIDw8IDggfCBzZWVkQnl0ZXNbN10pICYgMHgzZmZmOwogICAgICB9CiAgICB9CiAgCiAgICAvLyBVVUlEIHRpbWVzdGFtcHMgYXJlIDEwMCBuYW5vLXNlY29uZCB1bml0cyBzaW5jZSB0aGUgR3JlZ29yaWFuIGVwb2NoLAogICAgLy8gKDE1ODItMTAtMTUgMDA6MDApLiAgSlNOdW1iZXJzIGFyZW4ndCBwcmVjaXNlIGVub3VnaCBmb3IgdGhpcywgc28KICAgIC8vIHRpbWUgaXMgaGFuZGxlZCBpbnRlcm5hbGx5IGFzICdtc2VjcycgKGludGVnZXIgbWlsbGlzZWNvbmRzKSBhbmQgJ25zZWNzJwogICAgLy8gKDEwMC1uYW5vc2Vjb25kcyBvZmZzZXQgZnJvbSBtc2Vjcykgc2luY2UgdW5peCBlcG9jaCwgMTk3MC0wMS0wMSAwMDowMC4KICAgIHZhciBtc2VjcyA9IG9wdGlvbnMubXNlY3MgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubXNlY3MgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAKICAgIC8vIFBlciA0LjIuMS4yLCB1c2UgY291bnQgb2YgdXVpZCdzIGdlbmVyYXRlZCBkdXJpbmcgdGhlIGN1cnJlbnQgY2xvY2sKICAgIC8vIGN5Y2xlIHRvIHNpbXVsYXRlIGhpZ2hlciByZXNvbHV0aW9uIGNsb2NrCiAgICB2YXIgbnNlY3MgPSBvcHRpb25zLm5zZWNzICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLm5zZWNzIDogX2xhc3ROU2VjcyArIDE7CiAgCiAgICAvLyBUaW1lIHNpbmNlIGxhc3QgdXVpZCBjcmVhdGlvbiAoaW4gbXNlY3MpCiAgICB2YXIgZHQgPSAobXNlY3MgLSBfbGFzdE1TZWNzKSArIChuc2VjcyAtIF9sYXN0TlNlY3MpLzEwMDAwOwogIAogICAgLy8gUGVyIDQuMi4xLjIsIEJ1bXAgY2xvY2tzZXEgb24gY2xvY2sgcmVncmVzc2lvbgogICAgaWYgKGR0IDwgMCAmJiBvcHRpb25zLmNsb2Nrc2VxID09PSB1bmRlZmluZWQpIHsKICAgICAgY2xvY2tzZXEgPSBjbG9ja3NlcSArIDEgJiAweDNmZmY7CiAgICB9CiAgCiAgICAvLyBSZXNldCBuc2VjcyBpZiBjbG9jayByZWdyZXNzZXMgKG5ldyBjbG9ja3NlcSkgb3Igd2UndmUgbW92ZWQgb250byBhIG5ldwogICAgLy8gdGltZSBpbnRlcnZhbAogICAgaWYgKChkdCA8IDAgfHwgbXNlY3MgPiBfbGFzdE1TZWNzKSAmJiBvcHRpb25zLm5zZWNzID09PSB1bmRlZmluZWQpIHsKICAgICAgbnNlY3MgPSAwOwogICAgfQogIAogICAgLy8gUGVyIDQuMi4xLjIgVGhyb3cgZXJyb3IgaWYgdG9vIG1hbnkgdXVpZHMgYXJlIHJlcXVlc3RlZAogICAgaWYgKG5zZWNzID49IDEwMDAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigndXVpZC52MSgpOiBDYW5cJ3QgY3JlYXRlIG1vcmUgdGhhbiAxME0gdXVpZHMvc2VjJyk7CiAgICB9CiAgCiAgICBfbGFzdE1TZWNzID0gbXNlY3M7CiAgICBfbGFzdE5TZWNzID0gbnNlY3M7CiAgICBfY2xvY2tzZXEgPSBjbG9ja3NlcTsKICAKICAgIC8vIFBlciA0LjEuNCAtIENvbnZlcnQgZnJvbSB1bml4IGVwb2NoIHRvIEdyZWdvcmlhbiBlcG9jaAogICAgbXNlY3MgKz0gMTIyMTkyOTI4MDAwMDA7CiAgCiAgICAvLyBgdGltZV9sb3dgCiAgICB2YXIgdGwgPSAoKG1zZWNzICYgMHhmZmZmZmZmKSAqIDEwMDAwICsgbnNlY3MpICUgMHgxMDAwMDAwMDA7CiAgICBiW2krK10gPSB0bCA+Pj4gMjQgJiAweGZmOwogICAgYltpKytdID0gdGwgPj4+IDE2ICYgMHhmZjsKICAgIGJbaSsrXSA9IHRsID4+PiA4ICYgMHhmZjsKICAgIGJbaSsrXSA9IHRsICYgMHhmZjsKICAKICAgIC8vIGB0aW1lX21pZGAKICAgIHZhciB0bWggPSAobXNlY3MgLyAweDEwMDAwMDAwMCAqIDEwMDAwKSAmIDB4ZmZmZmZmZjsKICAgIGJbaSsrXSA9IHRtaCA+Pj4gOCAmIDB4ZmY7CiAgICBiW2krK10gPSB0bWggJiAweGZmOwogIAogICAgLy8gYHRpbWVfaGlnaF9hbmRfdmVyc2lvbmAKICAgIGJbaSsrXSA9IHRtaCA+Pj4gMjQgJiAweGYgfCAweDEwOyAvLyBpbmNsdWRlIHZlcnNpb24KICAgIGJbaSsrXSA9IHRtaCA+Pj4gMTYgJiAweGZmOwogIAogICAgLy8gYGNsb2NrX3NlcV9oaV9hbmRfcmVzZXJ2ZWRgIChQZXIgNC4yLjIgLSBpbmNsdWRlIHZhcmlhbnQpCiAgICBiW2krK10gPSBjbG9ja3NlcSA+Pj4gOCB8IDB4ODA7CiAgCiAgICAvLyBgY2xvY2tfc2VxX2xvd2AKICAgIGJbaSsrXSA9IGNsb2Nrc2VxICYgMHhmZjsKICAKICAgIC8vIGBub2RlYAogICAgZm9yICh2YXIgbiA9IDA7IG4gPCA2OyArK24pIHsKICAgICAgYltpICsgbl0gPSBub2RlW25dOwogICAgfQogIAogICAgcmV0dXJuIGJ1ZiA/IGJ1ZiA6IGJ5dGVzVG9VdWlkKGIpOwogIH0KICAKICBtb2R1bGUuZXhwb3J0cyA9IHYxOwogIAogIH0seyIuL2xpYi9ieXRlc1RvVXVpZCI6OTksIi4vbGliL3JuZyI6MTAwfV0sMTAyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgcm5nID0gcmVxdWlyZSgnLi9saWIvcm5nJyk7CiAgdmFyIGJ5dGVzVG9VdWlkID0gcmVxdWlyZSgnLi9saWIvYnl0ZXNUb1V1aWQnKTsKICAKICBmdW5jdGlvbiB2NChvcHRpb25zLCBidWYsIG9mZnNldCkgewogICAgdmFyIGkgPSBidWYgJiYgb2Zmc2V0IHx8IDA7CiAgCiAgICBpZiAodHlwZW9mKG9wdGlvbnMpID09ICdzdHJpbmcnKSB7CiAgICAgIGJ1ZiA9IG9wdGlvbnMgPT09ICdiaW5hcnknID8gbmV3IEFycmF5KDE2KSA6IG51bGw7CiAgICAgIG9wdGlvbnMgPSBudWxsOwogICAgfQogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgCiAgICB2YXIgcm5kcyA9IG9wdGlvbnMucmFuZG9tIHx8IChvcHRpb25zLnJuZyB8fCBybmcpKCk7CiAgCiAgICAvLyBQZXIgNC40LCBzZXQgYml0cyBmb3IgdmVyc2lvbiBhbmQgYGNsb2NrX3NlcV9oaV9hbmRfcmVzZXJ2ZWRgCiAgICBybmRzWzZdID0gKHJuZHNbNl0gJiAweDBmKSB8IDB4NDA7CiAgICBybmRzWzhdID0gKHJuZHNbOF0gJiAweDNmKSB8IDB4ODA7CiAgCiAgICAvLyBDb3B5IGJ5dGVzIHRvIGJ1ZmZlciwgaWYgcHJvdmlkZWQKICAgIGlmIChidWYpIHsKICAgICAgZm9yICh2YXIgaWkgPSAwOyBpaSA8IDE2OyArK2lpKSB7CiAgICAgICAgYnVmW2kgKyBpaV0gPSBybmRzW2lpXTsKICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIGJ1ZiB8fCBieXRlc1RvVXVpZChybmRzKTsKICB9CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSB2NDsKICAKICB9LHsiLi9saWIvYnl0ZXNUb1V1aWQiOjk5LCIuL2xpYi9ybmciOjEwMH1dLDEwMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgInVzZSBzdHJpY3QiOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7CiAgdmFyIExSVV8xID0gcmVxdWlyZSgiLi91dGlscy9MUlUiKTsKICB2YXIgQ0FDSEVfU0laRSA9IDEwMDA7CiAgLyoqCiAgICogSW5zcGlyZWQgbm9kZS1scnUtY2FjaGVbaHR0cHM6Ly9naXRodWIuY29tL2lzYWFjcy9ub2RlLWxydS1jYWNoZV0KICAgKi8KICB2YXIgRW5kcG9pbnRDYWNoZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsKICAgICAgZnVuY3Rpb24gRW5kcG9pbnRDYWNoZShtYXhTaXplKSB7CiAgICAgICAgICBpZiAobWF4U2l6ZSA9PT0gdm9pZCAwKSB7IG1heFNpemUgPSBDQUNIRV9TSVpFOyB9CiAgICAgICAgICB0aGlzLm1heFNpemUgPSBtYXhTaXplOwogICAgICAgICAgdGhpcy5jYWNoZSA9IG5ldyBMUlVfMS5MUlVDYWNoZShtYXhTaXplKTsKICAgICAgfQogICAgICA7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFbmRwb2ludENhY2hlLnByb3RvdHlwZSwgInNpemUiLCB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jYWNoZS5sZW5ndGg7CiAgICAgICAgICB9LAogICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICB9KTsKICAgICAgRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUucHV0ID0gZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICB2YXIga2V5U3RyaW5nID0gdHlwZW9mIGtleSAhPT0gJ3N0cmluZycgPyBFbmRwb2ludENhY2hlLmdldEtleVN0cmluZyhrZXkpIDoga2V5OwogICAgICAgICAgdmFyIGVuZHBvaW50UmVjb3JkID0gdGhpcy5wb3B1bGF0ZVZhbHVlKHZhbHVlKTsKICAgICAgICAgIHRoaXMuY2FjaGUucHV0KGtleVN0cmluZywgZW5kcG9pbnRSZWNvcmQpOwogICAgICB9OwogICAgICBFbmRwb2ludENhY2hlLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgdmFyIGtleVN0cmluZyA9IHR5cGVvZiBrZXkgIT09ICdzdHJpbmcnID8gRW5kcG9pbnRDYWNoZS5nZXRLZXlTdHJpbmcoa2V5KSA6IGtleTsKICAgICAgICAgIHZhciBub3cgPSBEYXRlLm5vdygpOwogICAgICAgICAgdmFyIHJlY29yZHMgPSB0aGlzLmNhY2hlLmdldChrZXlTdHJpbmcpOwogICAgICAgICAgaWYgKHJlY29yZHMpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlY29yZHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIHJlY29yZCA9IHJlY29yZHNbaV07CiAgICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuRXhwaXJlIDwgbm93KSB7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhY2hlLnJlbW92ZShrZXlTdHJpbmcpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZWNvcmRzOwogICAgICB9OwogICAgICBFbmRwb2ludENhY2hlLmdldEtleVN0cmluZyA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIHZhciBpZGVudGlmaWVycyA9IFtdOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJOYW1lcyA9IE9iamVjdC5rZXlzKGtleSkuc29ydCgpOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpZGVudGlmaWVyTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgaWRlbnRpZmllck5hbWUgPSBpZGVudGlmaWVyTmFtZXNbaV07CiAgICAgICAgICAgICAgaWYgKGtleVtpZGVudGlmaWVyTmFtZV0gPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgaWRlbnRpZmllcnMucHVzaChrZXlbaWRlbnRpZmllck5hbWVdKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpZGVudGlmaWVycy5qb2luKCcgJyk7CiAgICAgIH07CiAgICAgIEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLnBvcHVsYXRlVmFsdWUgPSBmdW5jdGlvbiAoZW5kcG9pbnRzKSB7CiAgICAgICAgICB2YXIgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgICAgIHJldHVybiBlbmRwb2ludHMubWFwKGZ1bmN0aW9uIChlbmRwb2ludCkgeyByZXR1cm4gKHsKICAgICAgICAgICAgICBBZGRyZXNzOiBlbmRwb2ludC5BZGRyZXNzIHx8ICcnLAogICAgICAgICAgICAgIEV4cGlyZTogbm93ICsgKGVuZHBvaW50LkNhY2hlUGVyaW9kSW5NaW51dGVzIHx8IDEpICogNjAgKiAxMDAwCiAgICAgICAgICB9KTsgfSk7CiAgICAgIH07CiAgICAgIEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLmVtcHR5ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgdGhpcy5jYWNoZS5lbXB0eSgpOwogICAgICB9OwogICAgICBFbmRwb2ludENhY2hlLnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgdmFyIGtleVN0cmluZyA9IHR5cGVvZiBrZXkgIT09ICdzdHJpbmcnID8gRW5kcG9pbnRDYWNoZS5nZXRLZXlTdHJpbmcoa2V5KSA6IGtleTsKICAgICAgICAgIHRoaXMuY2FjaGUucmVtb3ZlKGtleVN0cmluZyk7CiAgICAgIH07CiAgICAgIHJldHVybiBFbmRwb2ludENhY2hlOwogIH0oKSk7CiAgZXhwb3J0cy5FbmRwb2ludENhY2hlID0gRW5kcG9pbnRDYWNoZTsKICB9LHsiLi91dGlscy9MUlUiOjEwNH1dLDEwNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgInVzZSBzdHJpY3QiOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7CiAgdmFyIExpbmtlZExpc3ROb2RlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgewogICAgICBmdW5jdGlvbiBMaW5rZWRMaXN0Tm9kZShrZXksIHZhbHVlKSB7CiAgICAgICAgICB0aGlzLmtleSA9IGtleTsKICAgICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgfQogICAgICByZXR1cm4gTGlua2VkTGlzdE5vZGU7CiAgfSgpKTsKICB2YXIgTFJVQ2FjaGUgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7CiAgICAgIGZ1bmN0aW9uIExSVUNhY2hlKHNpemUpIHsKICAgICAgICAgIHRoaXMubm9kZU1hcCA9IHt9OwogICAgICAgICAgdGhpcy5zaXplID0gMDsKICAgICAgICAgIGlmICh0eXBlb2Ygc2l6ZSAhPT0gJ251bWJlcicgfHwgc2l6ZSA8IDEpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NhY2hlIHNpemUgY2FuIG9ubHkgYmUgcG9zaXRpdmUgbnVtYmVyJyk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnNpemVMaW1pdCA9IHNpemU7CiAgICAgIH0KICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KExSVUNhY2hlLnByb3RvdHlwZSwgImxlbmd0aCIsIHsKICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLnNpemU7CiAgICAgICAgICB9LAogICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICB9KTsKICAgICAgTFJVQ2FjaGUucHJvdG90eXBlLnByZXBlbmRUb0xpc3QgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgaWYgKCF0aGlzLmhlYWRlck5vZGUpIHsKICAgICAgICAgICAgICB0aGlzLnRhaWxOb2RlID0gbm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHRoaXMuaGVhZGVyTm9kZS5wcmV2ID0gbm9kZTsKICAgICAgICAgICAgICBub2RlLm5leHQgPSB0aGlzLmhlYWRlck5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmhlYWRlck5vZGUgPSBub2RlOwogICAgICAgICAgdGhpcy5zaXplKys7CiAgICAgIH07CiAgICAgIExSVUNhY2hlLnByb3RvdHlwZS5yZW1vdmVGcm9tVGFpbCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICghdGhpcy50YWlsTm9kZSkgewogICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbm9kZSA9IHRoaXMudGFpbE5vZGU7CiAgICAgICAgICB2YXIgcHJldk5vZGUgPSBub2RlLnByZXY7CiAgICAgICAgICBpZiAocHJldk5vZGUpIHsKICAgICAgICAgICAgICBwcmV2Tm9kZS5uZXh0ID0gdW5kZWZpbmVkOwogICAgICAgICAgfQogICAgICAgICAgbm9kZS5wcmV2ID0gdW5kZWZpbmVkOwogICAgICAgICAgdGhpcy50YWlsTm9kZSA9IHByZXZOb2RlOwogICAgICAgICAgdGhpcy5zaXplLS07CiAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgfTsKICAgICAgTFJVQ2FjaGUucHJvdG90eXBlLmRldGFjaEZyb21MaXN0ID0gZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICAgIGlmICh0aGlzLmhlYWRlck5vZGUgPT09IG5vZGUpIHsKICAgICAgICAgICAgICB0aGlzLmhlYWRlck5vZGUgPSBub2RlLm5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy50YWlsTm9kZSA9PT0gbm9kZSkgewogICAgICAgICAgICAgIHRoaXMudGFpbE5vZGUgPSBub2RlLnByZXY7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZS5wcmV2KSB7CiAgICAgICAgICAgICAgbm9kZS5wcmV2Lm5leHQgPSBub2RlLm5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZS5uZXh0KSB7CiAgICAgICAgICAgICAgbm9kZS5uZXh0LnByZXYgPSBub2RlLnByZXY7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLm5leHQgPSB1bmRlZmluZWQ7CiAgICAgICAgICBub2RlLnByZXYgPSB1bmRlZmluZWQ7CiAgICAgICAgICB0aGlzLnNpemUtLTsKICAgICAgfTsKICAgICAgTFJVQ2FjaGUucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIGlmICh0aGlzLm5vZGVNYXBba2V5XSkgewogICAgICAgICAgICAgIHZhciBub2RlID0gdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgICAgICAgdGhpcy5kZXRhY2hGcm9tTGlzdChub2RlKTsKICAgICAgICAgICAgICB0aGlzLnByZXBlbmRUb0xpc3Qobm9kZSk7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGUudmFsdWU7CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIExSVUNhY2hlLnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICBpZiAodGhpcy5ub2RlTWFwW2tleV0pIHsKICAgICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXMubm9kZU1hcFtrZXldOwogICAgICAgICAgICAgIHRoaXMuZGV0YWNoRnJvbUxpc3Qobm9kZSk7CiAgICAgICAgICAgICAgZGVsZXRlIHRoaXMubm9kZU1hcFtrZXldOwogICAgICAgICAgfQogICAgICB9OwogICAgICBMUlVDYWNoZS5wcm90b3R5cGUucHV0ID0gZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgIGlmICh0aGlzLm5vZGVNYXBba2V5XSkgewogICAgICAgICAgICAgIHRoaXMucmVtb3ZlKGtleSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmICh0aGlzLnNpemUgPT09IHRoaXMuc2l6ZUxpbWl0KSB7CiAgICAgICAgICAgICAgdmFyIHRhaWxOb2RlID0gdGhpcy5yZW1vdmVGcm9tVGFpbCgpOwogICAgICAgICAgICAgIHZhciBrZXlfMSA9IHRhaWxOb2RlLmtleTsKICAgICAgICAgICAgICBkZWxldGUgdGhpcy5ub2RlTWFwW2tleV8xXTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdOb2RlID0gbmV3IExpbmtlZExpc3ROb2RlKGtleSwgdmFsdWUpOwogICAgICAgICAgdGhpcy5ub2RlTWFwW2tleV0gPSBuZXdOb2RlOwogICAgICAgICAgdGhpcy5wcmVwZW5kVG9MaXN0KG5ld05vZGUpOwogICAgICB9OwogICAgICBMUlVDYWNoZS5wcm90b3R5cGUuZW1wdHkgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHRoaXMubm9kZU1hcCk7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXMubm9kZU1hcFtrZXldOwogICAgICAgICAgICAgIHRoaXMuZGV0YWNoRnJvbUxpc3Qobm9kZSk7CiAgICAgICAgICAgICAgZGVsZXRlIHRoaXMubm9kZU1hcFtrZXldOwogICAgICAgICAgfQogICAgICB9OwogICAgICByZXR1cm4gTFJVQ2FjaGU7CiAgfSgpKTsKICBleHBvcnRzLkxSVUNhY2hlID0gTFJVQ2FjaGU7CiAgfSx7fV0sMTA1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBBV1MgU0RLIGZvciBKYXZhU2NyaXB0IHYyLjU1My4wCiAgLy8gQ29weXJpZ2h0IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAgLy8gTGljZW5zZSBhdCBodHRwczovL3Nkay5hbWF6b25hd3MuY29tL2pzL0JVTkRMRV9MSUNFTlNFLnR4dAogIHJlcXVpcmUoJy4vYnJvd3Nlcl9sb2FkZXInKTsKICAKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgCiAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB3aW5kb3cuQVdTID0gQVdTOwogIGlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJykgewogICAgICAvKioKICAgICAgICogQGFwaSBwcml2YXRlCiAgICAgICAqLwogICAgICBtb2R1bGUuZXhwb3J0cyA9IEFXUzsKICB9CiAgaWYgKHR5cGVvZiBzZWxmICE9PSAndW5kZWZpbmVkJykgc2VsZi5BV1MgPSBBV1M7CiAgCiAgLyoqCiAgICogQHByaXZhdGUKICAgKiBETyBOT1QgUkVNT1ZFCiAgICogYnJvd3NlciBidWlsZGVyIHdpbGwgc3RyaXAgb3V0IHRoaXMgbGluZSBpZiBzZXJ2aWNlcyBhcmUgc3VwcGxpZWQgb24gdGhlIGNvbW1hbmQgbGluZS4KICAgKi9pZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChBV1MsICdDb25uZWN0JykpIHsKICAgIEFXUy5hcGlMb2FkZXIuc2VydmljZXNbJ2Nvbm5lY3QnXSA9IHt9OwogICAgQVdTLkNvbm5lY3QgPSBBV1MuU2VydmljZS5kZWZpbmVTZXJ2aWNlKCdjb25uZWN0JywgWyAnMjAxNy0wMi0xNScgXSk7CiAgfQogIEFXUy5hcGlMb2FkZXIuc2VydmljZXNbJ2Nvbm5lY3QnXVsnMjAxNy0wMi0xNSddID0gcmVxdWlyZSgnLi4vYXBpcy9jb25uZWN0LTIwMTctMDItMTUubWluJyk7CiAgCiAgaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoQVdTLCAnU1RTJykpIHsKICAgIEFXUy5hcGlMb2FkZXIuc2VydmljZXNbJ3N0cyddID0ge307CiAgICBBV1MuU1RTID0gQVdTLlNlcnZpY2UuZGVmaW5lU2VydmljZSgnc3RzJywgWyAnMjAxMS0wNi0xNScgXSk7CiAgICByZXF1aXJlKCcuL3NlcnZpY2VzL3N0cycpOwogIH0KICBBV1MuYXBpTG9hZGVyLnNlcnZpY2VzWydzdHMnXVsnMjAxMS0wNi0xNSddID0gcmVxdWlyZSgnLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5taW4nKTsKICAKICAKICB9LHsiLi4vYXBpcy9jb25uZWN0LTIwMTctMDItMTUubWluIjozLCIuLi9hcGlzL3N0cy0yMDExLTA2LTE1Lm1pbiI6NSwiLi9icm93c2VyX2xvYWRlciI6MTYsIi4vY29yZSI6MTgsIi4vc2VydmljZXMvc3RzIjo2MX1dfSx7fSxbMTA1XSk7CiAgCiAgCi8qISBAbGljZW5zZSBzcHJpbnRmLmpzIHwgQ29weXJpZ2h0IChjKSAyMDA3LTIwMTMgQWxleGFuZHJ1IE1hcmFzdGVhbnUgPGhlbGxvIGF0IGFsZXhlaSBkb3Qgcm8+IHwgMyBjbGF1c2UgQlNEIGxpY2Vuc2UgKi8KCihmdW5jdGlvbigpIHsKICAgdmFyIGN0eCA9IHRoaXM7CgoJdmFyIHNwcmludGYgPSBmdW5jdGlvbigpIHsKCQlpZiAoIXNwcmludGYuY2FjaGUuaGFzT3duUHJvcGVydHkoYXJndW1lbnRzWzBdKSkgewoJCQlzcHJpbnRmLmNhY2hlW2FyZ3VtZW50c1swXV0gPSBzcHJpbnRmLnBhcnNlKGFyZ3VtZW50c1swXSk7CgkJfQoJCXJldHVybiBzcHJpbnRmLmZvcm1hdC5jYWxsKG51bGwsIHNwcmludGYuY2FjaGVbYXJndW1lbnRzWzBdXSwgYXJndW1lbnRzKTsKCX07CgoJc3ByaW50Zi5mb3JtYXQgPSBmdW5jdGlvbihwYXJzZV90cmVlLCBhcmd2KSB7CgkJdmFyIGN1cnNvciA9IDEsIHRyZWVfbGVuZ3RoID0gcGFyc2VfdHJlZS5sZW5ndGgsIG5vZGVfdHlwZSA9ICcnLCBhcmcsIG91dHB1dCA9IFtdLCBpLCBrLCBtYXRjaCwgcGFkLCBwYWRfY2hhcmFjdGVyLCBwYWRfbGVuZ3RoOwoJCWZvciAoaSA9IDA7IGkgPCB0cmVlX2xlbmd0aDsgaSsrKSB7CgkJCW5vZGVfdHlwZSA9IGdldF90eXBlKHBhcnNlX3RyZWVbaV0pOwoJCQlpZiAobm9kZV90eXBlID09PSAnc3RyaW5nJykgewoJCQkJb3V0cHV0LnB1c2gocGFyc2VfdHJlZVtpXSk7CgkJCX0KCQkJZWxzZSBpZiAobm9kZV90eXBlID09PSAnYXJyYXknKSB7CgkJCQltYXRjaCA9IHBhcnNlX3RyZWVbaV07IC8vIGNvbnZlbmllbmNlIHB1cnBvc2VzIG9ubHkKCQkJCWlmIChtYXRjaFsyXSkgeyAvLyBrZXl3b3JkIGFyZ3VtZW50CgkJCQkJYXJnID0gYXJndltjdXJzb3JdOwoJCQkJCWZvciAoayA9IDA7IGsgPCBtYXRjaFsyXS5sZW5ndGg7IGsrKykgewoJCQkJCQlpZiAoIWFyZy5oYXNPd25Qcm9wZXJ0eShtYXRjaFsyXVtrXSkpIHsKCQkJCQkJCXRocm93KHNwcmludGYoJ1tzcHJpbnRmXSBwcm9wZXJ0eSAiJXMiIGRvZXMgbm90IGV4aXN0JywgbWF0Y2hbMl1ba10pKTsKCQkJCQkJfQoJCQkJCQlhcmcgPSBhcmdbbWF0Y2hbMl1ba11dOwoJCQkJCX0KCQkJCX0KCQkJCWVsc2UgaWYgKG1hdGNoWzFdKSB7IC8vIHBvc2l0aW9uYWwgYXJndW1lbnQgKGV4cGxpY2l0KQoJCQkJCWFyZyA9IGFyZ3ZbbWF0Y2hbMV1dOwoJCQkJfQoJCQkJZWxzZSB7IC8vIHBvc2l0aW9uYWwgYXJndW1lbnQgKGltcGxpY2l0KQoJCQkJCWFyZyA9IGFyZ3ZbY3Vyc29yKytdOwoJCQkJfQoKCQkJCWlmICgvW15zXS8udGVzdChtYXRjaFs4XSkgJiYgKGdldF90eXBlKGFyZykgIT0gJ251bWJlcicpKSB7CgkJCQkJdGhyb3coc3ByaW50ZignW3NwcmludGZdIGV4cGVjdGluZyBudW1iZXIgYnV0IGZvdW5kICVzJywgZ2V0X3R5cGUoYXJnKSkpOwoJCQkJfQoJCQkJc3dpdGNoIChtYXRjaFs4XSkgewoJCQkJCWNhc2UgJ2InOiBhcmcgPSBhcmcudG9TdHJpbmcoMik7IGJyZWFrOwoJCQkJCWNhc2UgJ2MnOiBhcmcgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGFyZyk7IGJyZWFrOwoJCQkJCWNhc2UgJ2QnOiBhcmcgPSBwYXJzZUludChhcmcsIDEwKTsgYnJlYWs7CgkJCQkJY2FzZSAnZSc6IGFyZyA9IG1hdGNoWzddID8gYXJnLnRvRXhwb25lbnRpYWwobWF0Y2hbN10pIDogYXJnLnRvRXhwb25lbnRpYWwoKTsgYnJlYWs7CgkJCQkJY2FzZSAnZic6IGFyZyA9IG1hdGNoWzddID8gcGFyc2VGbG9hdChhcmcpLnRvRml4ZWQobWF0Y2hbN10pIDogcGFyc2VGbG9hdChhcmcpOyBicmVhazsKCQkJCQljYXNlICdvJzogYXJnID0gYXJnLnRvU3RyaW5nKDgpOyBicmVhazsKCQkJCQljYXNlICdzJzogYXJnID0gKChhcmcgPSBTdHJpbmcoYXJnKSkgJiYgbWF0Y2hbN10gPyBhcmcuc3Vic3RyaW5nKDAsIG1hdGNoWzddKSA6IGFyZyk7IGJyZWFrOwoJCQkJCWNhc2UgJ3UnOiBhcmcgPSBhcmcgPj4+IDA7IGJyZWFrOwoJCQkJCWNhc2UgJ3gnOiBhcmcgPSBhcmcudG9TdHJpbmcoMTYpOyBicmVhazsKCQkJCQljYXNlICdYJzogYXJnID0gYXJnLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpOyBicmVhazsKCQkJCX0KCQkJCWFyZyA9ICgvW2RlZl0vLnRlc3QobWF0Y2hbOF0pICYmIG1hdGNoWzNdICYmIGFyZyA+PSAwID8gJysnKyBhcmcgOiBhcmcpOwoJCQkJcGFkX2NoYXJhY3RlciA9IG1hdGNoWzRdID8gbWF0Y2hbNF0gPT0gJzAnID8gJzAnIDogbWF0Y2hbNF0uY2hhckF0KDEpIDogJyAnOwoJCQkJcGFkX2xlbmd0aCA9IG1hdGNoWzZdIC0gU3RyaW5nKGFyZykubGVuZ3RoOwoJCQkJcGFkID0gbWF0Y2hbNl0gPyBzdHJfcmVwZWF0KHBhZF9jaGFyYWN0ZXIsIHBhZF9sZW5ndGgpIDogJyc7CgkJCQlvdXRwdXQucHVzaChtYXRjaFs1XSA/IGFyZyArIHBhZCA6IHBhZCArIGFyZyk7CgkJCX0KCQl9CgkJcmV0dXJuIG91dHB1dC5qb2luKCcnKTsKCX07CgoJc3ByaW50Zi5jYWNoZSA9IHt9OwoKCXNwcmludGYucGFyc2UgPSBmdW5jdGlvbihmbXQpIHsKCQl2YXIgX2ZtdCA9IGZtdCwgbWF0Y2ggPSBbXSwgcGFyc2VfdHJlZSA9IFtdLCBhcmdfbmFtZXMgPSAwOwoJCXdoaWxlIChfZm10KSB7CgkJCWlmICgobWF0Y2ggPSAvXlteXHgyNV0rLy5leGVjKF9mbXQpKSAhPT0gbnVsbCkgewoJCQkJcGFyc2VfdHJlZS5wdXNoKG1hdGNoWzBdKTsKCQkJfQoJCQllbHNlIGlmICgobWF0Y2ggPSAvXlx4MjV7Mn0vLmV4ZWMoX2ZtdCkpICE9PSBudWxsKSB7CgkJCQlwYXJzZV90cmVlLnB1c2goJyUnKTsKCQkJfQoJCQllbHNlIGlmICgobWF0Y2ggPSAvXlx4MjUoPzooWzEtOV1cZCopXCR8XCgoW15cKV0rKVwpKT8oXCspPygwfCdbXiRdKT8oLSk/KFxkKyk/KD86XC4oXGQrKSk/KFtiLWZvc3V4WF0pLy5leGVjKF9mbXQpKSAhPT0gbnVsbCkgewoJCQkJaWYgKG1hdGNoWzJdKSB7CgkJCQkJYXJnX25hbWVzIHw9IDE7CgkJCQkJdmFyIGZpZWxkX2xpc3QgPSBbXSwgcmVwbGFjZW1lbnRfZmllbGQgPSBtYXRjaFsyXSwgZmllbGRfbWF0Y2ggPSBbXTsKCQkJCQlpZiAoKGZpZWxkX21hdGNoID0gL14oW2Etel9dW2Etel9cZF0qKS9pLmV4ZWMocmVwbGFjZW1lbnRfZmllbGQpKSAhPT0gbnVsbCkgewoJCQkJCQlmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwoJCQkJCQl3aGlsZSAoKHJlcGxhY2VtZW50X2ZpZWxkID0gcmVwbGFjZW1lbnRfZmllbGQuc3Vic3RyaW5nKGZpZWxkX21hdGNoWzBdLmxlbmd0aCkpICE9PSAnJykgewoJCQkJCQkJaWYgKChmaWVsZF9tYXRjaCA9IC9eXC4oW2Etel9dW2Etel9cZF0qKS9pLmV4ZWMocmVwbGFjZW1lbnRfZmllbGQpKSAhPT0gbnVsbCkgewoJCQkJCQkJCWZpZWxkX2xpc3QucHVzaChmaWVsZF9tYXRjaFsxXSk7CgkJCQkJCQl9CgkJCQkJCQllbHNlIGlmICgoZmllbGRfbWF0Y2ggPSAvXlxbKFxkKylcXS8uZXhlYyhyZXBsYWNlbWVudF9maWVsZCkpICE9PSBudWxsKSB7CgkJCQkJCQkJZmllbGRfbGlzdC5wdXNoKGZpZWxkX21hdGNoWzFdKTsKCQkJCQkJCX0KCQkJCQkJCWVsc2UgewoJCQkJCQkJCXRocm93KCdbc3ByaW50Zl0gaHVoPycpOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJCWVsc2UgewoJCQkJCQl0aHJvdygnW3NwcmludGZdIGh1aD8nKTsKCQkJCQl9CgkJCQkJbWF0Y2hbMl0gPSBmaWVsZF9saXN0OwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJYXJnX25hbWVzIHw9IDI7CgkJCQl9CgkJCQlpZiAoYXJnX25hbWVzID09PSAzKSB7CgkJCQkJdGhyb3coJ1tzcHJpbnRmXSBtaXhpbmcgcG9zaXRpb25hbCBhbmQgbmFtZWQgcGxhY2Vob2xkZXJzIGlzIG5vdCAoeWV0KSBzdXBwb3J0ZWQnKTsKCQkJCX0KCQkJCXBhcnNlX3RyZWUucHVzaChtYXRjaCk7CgkJCX0KCQkJZWxzZSB7CgkJCQl0aHJvdygnW3NwcmludGZdIGh1aD8nKTsKCQkJfQoJCQlfZm10ID0gX2ZtdC5zdWJzdHJpbmcobWF0Y2hbMF0ubGVuZ3RoKTsKCQl9CgkJcmV0dXJuIHBhcnNlX3RyZWU7Cgl9OwoKCXZhciB2c3ByaW50ZiA9IGZ1bmN0aW9uKGZtdCwgYXJndiwgX2FyZ3YpIHsKCQlfYXJndiA9IGFyZ3Yuc2xpY2UoMCk7CgkJX2FyZ3Yuc3BsaWNlKDAsIDAsIGZtdCk7CgkJcmV0dXJuIHNwcmludGYuYXBwbHkobnVsbCwgX2FyZ3YpOwoJfTsKCgkvKioKCSAqIGhlbHBlcnMKCSAqLwoJZnVuY3Rpb24gZ2V0X3R5cGUodmFyaWFibGUpIHsKCQlyZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhcmlhYmxlKS5zbGljZSg4LCAtMSkudG9Mb3dlckNhc2UoKTsKCX0KCglmdW5jdGlvbiBzdHJfcmVwZWF0KGlucHV0LCBtdWx0aXBsaWVyKSB7CgkJZm9yICh2YXIgb3V0cHV0ID0gW107IG11bHRpcGxpZXIgPiAwOyBvdXRwdXRbLS1tdWx0aXBsaWVyXSA9IGlucHV0KSB7LyogZG8gbm90aGluZyAqL30KCQlyZXR1cm4gb3V0cHV0LmpvaW4oJycpOwoJfQoKCS8qKgoJICogZXhwb3J0IHRvIGVpdGhlciBicm93c2VyIG9yIG5vZGUuanMKCSAqLwoJY3R4LnNwcmludGYgPSBzcHJpbnRmOwoJY3R4LnZzcHJpbnRmID0gdnNwcmludGY7Cn0pKCk7CgoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgLy8gSG93IGZyZXF1ZW50bHkgc29mdHBob25lIGxvZ3Mgc2hvdWxkIGJlIGNvbGxlY3RlZCBhbmQgcmVwb3J0ZWQgdG8gc2hhcmVkIHdvcmtlci4KICB2YXIgU09GVFBIT05FX0xPR19SRVBPUlRfSU5URVJWQUxfTUlMTElTID0gNTAwMDsKCiAgLy8gSG93IGZyZXF1ZW50bHkgbG9ncyBzaG91bGQgYmUgY29sbGVjdGVkIGFuZCBzZW50IGRvd25zdHJlYW0KICB2YXIgTE9HU19SRVBPUlRfSU5URVJWQUxfTUlMTElTID0gNTAwMDsKCiAgLy8gVGhlIGRlZmF1bHQgbG9nIHJvbGwgaW50ZXJ2YWwgKDMwbWluKQogIHZhciBERUZBVUxUX0xPR19ST0xMX0lOVEVSVkFMID0gMTgwMDAwMDsKCiAgLyoqCiAgICogQW4gZW51bWVyYXRpb24gb2YgY29tbW9uIGxvZ2dpbmcgbGV2ZWxzLgogICAqLwogIHZhciBMb2dMZXZlbCA9IHsKICAgIFRFU1Q6ICJURVNUIiwKICAgIFRSQUNFOiAiVFJBQ0UiLAogICAgREVCVUc6ICJERUJVRyIsCiAgICBJTkZPOiAiSU5GTyIsCiAgICBMT0c6ICJMT0ciLAogICAgV0FSTjogIldBUk4iLAogICAgRVJST1I6ICJFUlJPUiIsCiAgICBDUklUSUNBTDogIkNSSVRJQ0FMIgogIH07CgogIC8qKgogICAqIEFuIGVudW1lcmF0aW9uIG9mIGNvbW1vbiBsb2dnaW5nIGNvbXBvbmVudHMuCiAgICovCiAgdmFyIExvZ0NvbXBvbmVudCA9IHsKICAgIENDUDogImNjcCIsCiAgICBTT0ZUUEhPTkU6ICJzb2Z0cGhvbmUiLAogICAgQ0hBVDogImNoYXQiLAogICAgVEFTSzogInRhc2siCiAgfTsKCiAgLyoqCiAgICogVGhlIG51bWVyaWMgb3JkZXIgb2YgdGhlIGxvZ2dpbmcgbGV2ZWxzIGFib3ZlLgogICAqIFRoZXkgYXJlIHNwYWNlZCB0byBhbGxvdyB0aGUgYWRkaXRpb24gb2Ygb3RoZXIgbG9nCiAgICogbGV2ZWxzIGF0IGEgbGF0ZXIgdGltZS4KICAgKi8KICB2YXIgTG9nTGV2ZWxPcmRlciA9IHsKICAgIFRFU1Q6IDAsCiAgICBUUkFDRTogMTAsCiAgICBERUJVRzogMjAsCiAgICBJTkZPOiAzMCwKICAgIExPRzogNDAsCiAgICBXQVJOOiA1MCwKICAgIEVSUk9SOiAxMDAsCiAgICBDUklUSUNBTDogMjAwCgogIH07CgogIC8qKgogICAqIEEgbWFwIGZyb20gbG9nIGxldmVsIHRvIGNvbnNvbGUgbG9nZ2VyIGZ1bmN0aW9uLgogICAqLwogIHZhciBDT05TT0xFX0xPR0dFUl9NQVAgPSB7CiAgICBUUkFDRTogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5pbmZvKHRleHQpOyB9LAogICAgREVCVUc6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuaW5mbyh0ZXh0KTsgfSwKICAgIElORk86IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuaW5mbyh0ZXh0KTsgfSwKICAgIExPRzogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5sb2codGV4dCk7IH0sCiAgICBURVNUOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmxvZyh0ZXh0KTsgfSwKICAgIFdBUk46IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUud2Fybih0ZXh0KTsgfSwKICAgIEVSUk9SOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmVycm9yKHRleHQpOyB9LAogICAgQ1JJVElDQUw6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuZXJyb3IodGV4dCk7IH0KICB9OwoKICAvKioKICAqIENoZWNrcyBpZiBpdCBpcyBhIHZhbGlkIGxvZyBjb21wb25lbnQgZW51bQogICovCgogIHZhciBpc1ZhbGlkTG9nQ29tcG9uZW50ID0gZnVuY3Rpb24gKGNvbXBvbmVudCkgewogICAgcmV0dXJuIE9iamVjdC52YWx1ZXMoTG9nQ29tcG9uZW50KS5pbmRleE9mKGNvbXBvbmVudCkgIT09IC0xOwogIH07CgogIC8qKgogICogRXh0cmFjdCB0aGUgY3VzdG9tIGFyZ3VtZW50cyBhcyByZXF1aXJlZCBieSB0aGUgbG9nZ2VyCiAgKi8KICB2YXIgZXh0cmFjdExvZ2dlckFyZ3MgPSBmdW5jdGlvbiAobG9nZ2VyQXJncykgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChsb2dnZXJBcmdzLCAwKTsKICAgIHZhciBmaXJzdEFyZyA9IGFyZ3Muc2hpZnQoKTsKICAgIHZhciBmb3JtYXQ7CiAgICB2YXIgY29tcG9uZW50OwoKICAgIGlmIChpc1ZhbGlkTG9nQ29tcG9uZW50KGZpcnN0QXJnKSkgewogICAgICBjb21wb25lbnQgPSBmaXJzdEFyZzsKICAgICAgZm9ybWF0ID0gYXJncy5zaGlmdCgpOwogICAgfSBlbHNlIHsKICAgICAgLy9kZWZhdWx0IHRvIENDUCBjb21wb25lbnQKICAgICAgZm9ybWF0ID0gZmlyc3RBcmc7CiAgICAgIGNvbXBvbmVudCA9IExvZ0NvbXBvbmVudC5DQ1A7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgZm9ybWF0OiBmb3JtYXQsCiAgICAgIGNvbXBvbmVudDogY29tcG9uZW50LAogICAgICBhcmdzOiBhcmdzCiAgICB9OwogIH07CgogIC8qKgogICAqIEEgbG9nIGVudHJ5LgogICAqCiAgICogQHBhcmFtIGNvbXBvbmVudCBUaGUgbG9nZ2luZyBjb21wb25lbnQuCiAgICogQHBhcmFtIGxldmVsIFRoZSBsb2cgbGV2ZWwgb2YgdGhpcyBsb2cgZW50cnkuCiAgICogQHBhcmFtIHRleHQgVGhlIHRleHQgY29udGFpbmVkIGluIHRoZSBsb2cgZW50cnkuCiAgICogQHBhcmFtIGxvZ2dlcklkIFRoZSByb290IGxvZ2dlciBpZC4KICAgKgogICAqIExvZyBlbnRyaWVzIGFyZSBhd2FyZSBvZiB0aGVpciB0aW1lc3RhbXAsIG9yZGVyLAogICAqIGFuZCBjYW4gY29udGFpbiBvYmplY3RzIGFuZCBleGNlcHRpb24gc3RhY2sgdHJhY2VzLgogICAqLwogIHZhciBMb2dFbnRyeSA9IGZ1bmN0aW9uIChjb21wb25lbnQsIGxldmVsLCB0ZXh0LCBsb2dnZXJJZCkgewogICAgdGhpcy5jb21wb25lbnQgPSBjb21wb25lbnQ7CiAgICB0aGlzLmxldmVsID0gbGV2ZWw7CiAgICB0aGlzLnRleHQgPSB0ZXh0OwogICAgdGhpcy50aW1lID0gbmV3IERhdGUoKTsKICAgIHRoaXMuZXhjZXB0aW9uID0gbnVsbDsKICAgIHRoaXMub2JqZWN0cyA9IFtdOwogICAgdGhpcy5saW5lID0gMDsKICAgIHRoaXMuYWdlbnRSZXNvdXJjZUlkID0gbnVsbDsKICAgIHRyeSB7CiAgICAgIGlmIChjb25uZWN0LmFnZW50LmluaXRpYWxpemVkKXsKICAgICAgICB0aGlzLmFnZW50UmVzb3VyY2VJZCA9IG5ldyBjb25uZWN0LkFnZW50KCkuX2dldFJlc291cmNlSWQoKTsKICAgICAgfQogICAgfSBjYXRjaChlKSB7CiAgICAgIGNvbnNvbGUubG9nKCJJc3N1ZSBmaW5kaW5nIGFnZW50UmVzb3VyY2VJZDogIiwgZSk7IC8vY2FuJ3QgdXNlIG91ciBsb2dnZXIgaGVyZSBhcyB3ZSBtaWdodCBpbmZpbml0ZWx5IGF0dGVtcHQgdG8gbG9nIHRoaXMgZXJyb3IuCiAgICB9CiAgICB0aGlzLmxvZ2dlcklkID0gbG9nZ2VySWQ7CiAgfTsKCiAgTG9nRW50cnkuZnJvbU9iamVjdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBlbnRyeSA9IG5ldyBMb2dFbnRyeShMb2dDb21wb25lbnQuQ0NQLCBvYmoubGV2ZWwsIG9iai50ZXh0LCBvYmoubG9nZ2VySWQpOwoKICAgIC8vIFJlcXVpcmVkIHRvIGNoZWNrIGZvciBEYXRlIG9iamVjdHMgc2VudCBhY3Jvc3MgZnJhbWUgYm91bmRhcmllcwogICAgaWYgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmoudGltZSkgPT09ICdbb2JqZWN0IERhdGVdJykgewogICAgICBlbnRyeS50aW1lID0gbmV3IERhdGUob2JqLnRpbWUuZ2V0VGltZSgpKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iai50aW1lID09PSAnbnVtYmVyJykgewogICAgICBlbnRyeS50aW1lID0gbmV3IERhdGUob2JqLnRpbWUpOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygb2JqLnRpbWUgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVudHJ5LnRpbWUgPSBEYXRlLnBhcnNlKG9iai50aW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIGVudHJ5LnRpbWUgPSBuZXcgRGF0ZSgpOwogICAgfQogICAgZW50cnkuZXhjZXB0aW9uID0gb2JqLmV4Y2VwdGlvbjsKICAgIGVudHJ5Lm9iamVjdHMgPSBvYmoub2JqZWN0czsKICAgIHJldHVybiBlbnRyeTsKICB9OwoKICAvKioKICAgKiBQcml2YXRlIG1ldGhvZCB0byByZW1vdmUgc2Vuc2l0aXZlIGluZm8gZnJvbSBjbGllbnQgbG9nCiAgICovCiAgdmFyIHJlZGFjdFNlbnNpdGl2ZUluZm8gPSBmdW5jdGlvbihkYXRhKSB7CiAgICB2YXIgcmVnZXggPSAvQXV0aFRva2VuLipcPS9nOwogICAgaWYoZGF0YSAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcpIHsKICAgICAgT2JqZWN0LmtleXMoZGF0YSkuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAgICBpZiAodHlwZW9mIGRhdGFba2V5XSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgIHJlZGFjdFNlbnNpdGl2ZUluZm8oZGF0YVtrZXldKQogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZih0eXBlb2YgZGF0YVtrZXldID09PSAnc3RyaW5nJyAmJiAoa2V5ID09PSAidXJsIiB8fCBrZXkgPT09ICJ0ZXh0IikpIHsKICAgICAgICAgIGRhdGFba2V5XSA9IGRhdGFba2V5XS5yZXBsYWNlKHJlZ2V4LCAiW3JlZGFjdGVkXSIpOwogICAgICAgIH0KICAgICAgfSk7IAogICAgfQogICAgCiAgfQoKICAvKioKICAgKiBQdWxscyB0aGUgdHlwZSwgbWVzc2FnZSwgYW5kIHN0YWNrIHRyYWNlCiAgICogb3V0IG9mIHRoZSBnaXZlbiBleGNlcHRpb24gZm9yIEpTT04gc2VyaWFsaXphdGlvbi4KICAgKi8KICB2YXIgTG9nZ2VkRXhjZXB0aW9uID0gZnVuY3Rpb24gKGUpIHsKICAgIHRoaXMudHlwZSA9IChlIGluc3RhbmNlb2YgRXJyb3IpID8gZS5uYW1lIDogZS5jb2RlIHx8IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChlKTsKICAgIHRoaXMubWVzc2FnZSA9IGUubWVzc2FnZTsKICAgIHRoaXMuc3RhY2sgPSBlLnN0YWNrID8gZS5zdGFjay5zcGxpdCgnXG4nKSA6IFtdOwogIH07CgogIC8qKgogICAqIE1pbmltYWxseSBzdHJpbmdpZnkgdGhpcyBsb2cgZW50cnkgZm9yIHByaW50aW5nCiAgICogdG8gdGhlIGNvbnNvbGUuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Quc3ByaW50ZigiWyVzXSBbJXNdIFslc106ICVzIiwKICAgICAgdGhpcy5nZXRUaW1lKCkgJiYgdGhpcy5nZXRUaW1lKCkudG9JU09TdHJpbmcgPyB0aGlzLmdldFRpbWUoKS50b0lTT1N0cmluZygpIDogIj8/PyIsCiAgICAgIHRoaXMuZ2V0TGV2ZWwoKSwKICAgICAgdGhpcy5nZXRBZ2VudFJlc291cmNlSWQoKSwKICAgICAgdGhpcy5nZXRUZXh0KCkpOwogIH07CgogIC8qKgogICAqIEdldCB0aGUgbG9nIGVudHJ5IHRpbWVzdGFtcC4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUuZ2V0VGltZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLnRpbWU7CiAgfTsKCiAgTG9nRW50cnkucHJvdG90eXBlLmdldEFnZW50UmVzb3VyY2VJZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmFnZW50UmVzb3VyY2VJZDsKICB9CgogIC8qKgogICAqIEdldCB0aGUgbGV2ZWwgb2YgdGhlIGxvZyBlbnRyeS4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUuZ2V0TGV2ZWwgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5sZXZlbDsKICB9OwoKICAvKioKICAgKiBHZXQgdGhlIGxvZyBlbnRyeSB0ZXh0LgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS5nZXRUZXh0ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMudGV4dDsKICB9OwoKICAvKioKICAgKiBHZXQgdGhlIGxvZyBlbnRyeSBjb21wb25lbnQuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLmdldENvbXBvbmVudCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbXBvbmVudDsKICB9OwoKICAvKioKICAgKiBBZGQgYW4gZXhjZXB0aW9uIHN0YWNrIHRyYWNlIHRvIHRoaXMgbG9nIGVudHJ5LgogICAqIEEgbG9nIGVudHJ5IG1heSBjb250YWluIG9ubHkgb25lIGV4Y2VwdGlvbiBzdGFjayB0cmFjZS4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUud2l0aEV4Y2VwdGlvbiA9IGZ1bmN0aW9uIChlKSB7CiAgICB0aGlzLmV4Y2VwdGlvbiA9IG5ldyBMb2dnZWRFeGNlcHRpb24oZSk7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvKioKICAgKiBBZGQgYW4gYXJiaXRyYXJ5IG9iamVjdCB0byB0aGUgbG9nIGVudHJ5LiAgQSBsb2cgZW50cnkKICAgKiBtYXkgY29udGFpbiBhbnkgbnVtYmVyIG9mIG9iamVjdHMuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLndpdGhPYmplY3QgPSBmdW5jdGlvbiAob2JqKSB7CiAgICB2YXIgY29waWVkT2JqID0gY29ubmVjdC5kZWVwY29weShvYmopCiAgICByZWRhY3RTZW5zaXRpdmVJbmZvKGNvcGllZE9iaik7CiAgICB0aGlzLm9iamVjdHMucHVzaChjb3BpZWRPYmopOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLyoqCiAgICogSW5kaWNhdGUgdGhhdCB0aGlzIGxvZyBlbnRyeSBzaG91bGQgYmUgc2VudCB0byB0aGUgc2VydmVyCiAgICogTk9URTogVGhpcyBzaG91bGQgYmUgdXNlZCBmb3IgaW50ZXJuYWwgbG9ncyBvbmx5CiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5nZXRMb2coKS5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MucHVzaCh0aGlzKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8qKgogICAqIFRoZSBsb2dnZXIgaW5zdGFuY2UuCiAgICovCiAgdmFyIExvZ2dlciA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuX2xvZ3MgPSBbXTsKICAgIHRoaXMuX3JvbGxlZExvZ3MgPSBbXTsKICAgIHRoaXMuX2xvZ3NUb1B1c2ggPSBbXTsKICAgIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzID0gW107CiAgICB0aGlzLl9lY2hvTGV2ZWwgPSBMb2dMZXZlbE9yZGVyLklORk87CiAgICB0aGlzLl9sb2dMZXZlbCA9IExvZ0xldmVsT3JkZXIuSU5GTzsKICAgIHRoaXMuX2xpbmVDb3VudCA9IDA7CiAgICB0aGlzLl9sb2dSb2xsSW50ZXJ2YWwgPSAwOwogICAgdGhpcy5fbG9nUm9sbFRpbWVyID0gbnVsbDsKICAgIHRoaXMuX2xvZ2dlcklkID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgKyAiLSIgKyBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyKTsKICAgIHRoaXMuc2V0TG9nUm9sbEludGVydmFsKERFRkFVTFRfTE9HX1JPTExfSU5URVJWQUwpOwogICAgdGhpcy5fc3RhcnRMb2dJbmRleFRvUHVzaCA9IDA7CiAgfTsKCiAgLyoqCiAgICogU2V0cyB0aGUgaW50ZXJ2YWwgaW4gbWlsbGlzZWNvbmRzIHRoYXQgdGhlIGxvZ3Mgd2lsbCBiZSByb3RhdGVkLgogICAqIExvZ3MgYXJlIHJvdGF0ZWQgb3V0IGNvbXBsZXRlbHkgYXQgdGhlIGVuZCBvZiB0aGUgc2Vjb25kIHJvbGwKICAgKiBhbmQgd2lsbCBldmVudHVhbGx5IGJlIGdhcmJhZ2UgY29sbGVjdGVkLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUuc2V0TG9nUm9sbEludGVydmFsID0gZnVuY3Rpb24gKGludGVydmFsKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgaWYgKCEodGhpcy5fbG9nUm9sbFRpbWVyKSB8fCBpbnRlcnZhbCAhPT0gdGhpcy5fbG9nUm9sbEludGVydmFsKSB7CiAgICAgIGlmICh0aGlzLl9sb2dSb2xsVGltZXIpIHsKICAgICAgICBnbG9iYWwuY2xlYXJJbnRlcnZhbCh0aGlzLl9sb2dSb2xsVGltZXIpOwogICAgICB9CiAgICAgIHRoaXMuX2xvZ1JvbGxJbnRlcnZhbCA9IGludGVydmFsOwogICAgICB0aGlzLl9sb2dSb2xsVGltZXIgPSBnbG9iYWwuc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuX3JvbGxlZExvZ3MgPSB0aGlzLl9sb2dzOwogICAgICAgIHRoaXMuX2xvZ3MgPSBbXTsKICAgICAgICB0aGlzLl9zdGFydExvZ0luZGV4VG9QdXNoID0gMDsKICAgICAgICBzZWxmLmluZm8oIkxvZyByb2xsIGludGVydmFsIG9jY3VycmVkLiIpOwogICAgICB9LCB0aGlzLl9sb2dSb2xsSW50ZXJ2YWwpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy53YXJuKCJMb2dnZXIgaXMgYWxyZWFkeSBzZXQgdG8gdGhlIGdpdmVuIGludGVydmFsOiAlZCIsIHRoaXMuX2xvZ1JvbGxJbnRlcnZhbCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogU2V0IHRoZSBsb2cgbGV2ZWwuICBUaGlzIGlzIHRoZSBtaW5pbXVtIGxldmVsIGF0IHdoaWNoIGxvZ3Mgd2lsbAogICAqIGJlIGtlcHQgZm9yIGxhdGVyIGFyY2hpdmluZy4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLnNldExvZ0xldmVsID0gZnVuY3Rpb24gKGxldmVsKSB7CiAgICBpZiAobGV2ZWwgaW4gTG9nTGV2ZWxPcmRlcikgewogICAgICB0aGlzLl9sb2dMZXZlbCA9IExvZ0xldmVsT3JkZXJbbGV2ZWxdOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIGxvZ2dpbmcgbGV2ZWw6ICIgKyBsZXZlbCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogU2V0IHRoZSBlY2hvIGxldmVsLiAgVGhpcyBpcyB0aGUgbWluaW11bSBsZXZlbCBhdCB3aGljaCBsb2dzIHdpbGwKICAgKiBiZSBwcmludGVkIHRvIHRoZSBqYXZhc2NyaXB0IGNvbnNvbGUuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5zZXRFY2hvTGV2ZWwgPSBmdW5jdGlvbiAobGV2ZWwpIHsKICAgIGlmIChsZXZlbCBpbiBMb2dMZXZlbE9yZGVyKSB7CiAgICAgIHRoaXMuX2VjaG9MZXZlbCA9IExvZ0xldmVsT3JkZXJbbGV2ZWxdOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIGxvZ2dpbmcgbGV2ZWw6ICIgKyBsZXZlbCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogV3JpdGUgYSBwYXJ0aWN1bGFyIGxvZyBlbnRyeS4KICAgKgogICAqIEBwYXJhbSBsZXZlbCBUaGUgbG9nZ2luZyBsZXZlbCBvZiB0aGUgZW50cnkuCiAgICogQHBhcmFtIHRleHQgVGhlIHRleHQgY29udGVudHMgb2YgdGhlIGVudHJ5LgogICAqCiAgICogQHJldHVybnMgVGhlIG5ldyBsb2cgZW50cnkuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS53cml0ZSA9IGZ1bmN0aW9uIChjb21wb25lbnQsIGxldmVsLCB0ZXh0KSB7CiAgICB2YXIgbG9nRW50cnkgPSBuZXcgTG9nRW50cnkoY29tcG9uZW50LCBsZXZlbCwgdGV4dCwgdGhpcy5nZXRMb2dnZXJJZCgpKTsKICAgIHJlZGFjdFNlbnNpdGl2ZUluZm8obG9nRW50cnkpOwogICAgdGhpcy5hZGRMb2dFbnRyeShsb2dFbnRyeSk7CiAgICByZXR1cm4gbG9nRW50cnk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5hZGRMb2dFbnRyeSA9IGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgLy8gQ2FsbCB0aGlzIHNlY29uZCB0aW1lIGFzIGluIHNvbWUgcGxhY2VzIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIGRpcmVjdGx5CiAgICByZWRhY3RTZW5zaXRpdmVJbmZvKGxvZ0VudHJ5KTsKICAgIHRoaXMuX2xvZ3MucHVzaChsb2dFbnRyeSk7CgogICAgLy9Gb3Igbm93IG9ubHkgc2VuZCBzb2Z0cGhvbmUgbG9ncyBvbmx5LgogICAgLy9UT0RPIGFkZCBDQ1AgbG9ncyBvbmNlIHdlIGFyZSBzdXJlIHRoYXQgbm8gc2Vuc2l0aXZlIGRhdGEgaXMgYmVpbmcgbG9nZ2VkLgogICAgaWYgKExvZ0NvbXBvbmVudC5TT0ZUUEhPTkUgPT09IGxvZ0VudHJ5LmNvbXBvbmVudCkgewogICAgICB0aGlzLl9sb2dzVG9QdXNoLnB1c2gobG9nRW50cnkpOwogICAgfQoKICAgIGlmIChsb2dFbnRyeS5sZXZlbCBpbiBMb2dMZXZlbE9yZGVyICYmCiAgICAgIExvZ0xldmVsT3JkZXJbbG9nRW50cnkubGV2ZWxdID49IHRoaXMuX2xvZ0xldmVsKSB7CgogICAgICBpZiAoTG9nTGV2ZWxPcmRlcltsb2dFbnRyeS5sZXZlbF0gPj0gdGhpcy5fZWNob0xldmVsKSB7CiAgICAgICAgQ09OU09MRV9MT0dHRVJfTUFQW2xvZ0VudHJ5LmdldExldmVsKCldKGxvZ0VudHJ5LnRvU3RyaW5nKCkpOwogICAgICB9CgogICAgICBsb2dFbnRyeS5saW5lID0gdGhpcy5fbGluZUNvdW50Kys7CiAgICB9CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5zZW5kSW50ZXJuYWxMb2dFbnRyeVRvU2VydmVyID0gZnVuY3Rpb24gKGxvZ0VudHJ5KSB7CiAgICB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5wdXNoKGxvZ0VudHJ5KTsKCiAgICBpZiAobG9nRW50cnkubGV2ZWwgaW4gTG9nTGV2ZWxPcmRlciAmJgogICAgICBMb2dMZXZlbE9yZGVyW2xvZ0VudHJ5LmxldmVsXSA+PSB0aGlzLl9sb2dMZXZlbCkgewoKICAgICAgaWYgKExvZ0xldmVsT3JkZXJbbG9nRW50cnkubGV2ZWxdID49IHRoaXMuX2VjaG9MZXZlbCkgewogICAgICAgIENPTlNPTEVfTE9HR0VSX01BUFtsb2dFbnRyeS5nZXRMZXZlbCgpXShsb2dFbnRyeS50b1N0cmluZygpKTsKICAgICAgfQoKICAgICAgbG9nRW50cnkubGluZSA9IHRoaXMuX2xpbmVDb3VudCsrOwogICAgfQogIH07CgogIC8qKgogICAqIFJlbW92ZSBhbGwgb2JqZWN0cyBmcm9tIGFsbCBsb2cgZW50cmllcy4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLmNsZWFyT2JqZWN0cyA9IGZ1bmN0aW9uICgpIHsKICAgIGZvciAodmFyIHggPSAwOyB4IDwgdGhpcy5fbG9ncy5sZW5ndGg7IHgrKykgewogICAgICBpZiAodGhpcy5fbG9nc1t4XS5vYmplY3RzKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2xvZ3NbeF0ub2JqZWN0czsKICAgICAgfQogICAgfQogIH07CgogIC8qKgogICAqIFJlbW92ZSBhbGwgZXhjZXB0aW9uIHN0YWNrIHRyYWNlcyBmcm9tIHRoZSBsb2cgZW50cmllcy4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLmNsZWFyRXhjZXB0aW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgIGZvciAodmFyIHggPSAwOyB4IDwgdGhpcy5fbG9ncy5sZW5ndGg7IHgrKykgewogICAgICBpZiAodGhpcy5fbG9nc1t4XS5leGNlcHRpb24pIHsKICAgICAgICBkZWxldGUgdGhpcy5fbG9nc1t4XS5leGNlcHRpb247CiAgICAgIH0KICAgIH0KICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnRyYWNlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLlRSQUNFLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmRlYnVnID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLkRFQlVHLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuSU5GTywgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5sb2cgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuTE9HLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnRlc3QgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuVEVTVCwgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS53YXJuID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLldBUk4sIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuZXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuRVJST1IsIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuY3JpdGljYWwgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuRVJST1IsIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIC8qKgogICAqIENyZWF0ZSBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgbG9nZ2VyIGNvbnRlbnRzLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbGluZXMgPSBbXTsKICAgIGZvciAodmFyIHggPSAwOyB4IDwgdGhpcy5fbG9ncy5sZW5ndGg7IHgrKykgewogICAgICBsaW5lcy5wdXNoKHRoaXMuX2xvZ3NbeF0udG9TdHJpbmcoKSk7CiAgICB9CgogICAgcmV0dXJuIGxpbmVzLmpvaW4oIlxuIik7CiAgfTsKICAKICAvKioKICAgKiBEb3dubG9hZC9BcmNoaXZlIGxvZ3MgdG8gYSBmaWxlLCAKICAgKiBCeSBkZWZhdWx0LCBpdCByZXR1cm5zIGFsbCBsb2dzLgogICAqIFRvIGZpbHRlciBsb2dzIGJ5IHRoZSBtaW5pbXVtIGxvZyBsZXZlbCBzZXQgYnkgc2V0TG9nTGV2ZWwgb3IgdGhlIGRlZmF1bHQgc2V0IGluIF9sb2dMZXZlbCwgCiAgICogcGFzcyBpbiBmaWx0ZXJCeUxvZ0xldmVsIHRvIHRydWUgaW4gb3B0aW9ucwogICAqIAogICAqIEBwYXJhbSBvcHRpb25zIGRvd25sb2FkIG9wdGlvbnMgW09iamVjdHxTdHJpbmddLiAKICAgKiAtIG9mIHR5cGUgT2JqZWN0OiAKICAgKiAgIHsgbG9nTmFtZTogJ215LWxvZy1uYW1lJywKICAgKiAgICAgZmlsdGVyQnlMb2dMZXZlbDogZmFsc2UsIC8vZG93bmxvYWQgYWxsIGxvZ3MKICAgKiAgIH0KICAgKiAtIG9mIHR5cGUgU3RyaW5nIChmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSksIHRoZSBmaWxlJ3MgbmFtZQogICAqLwogIExvZ2dlci5wcm90b3R5cGUuZG93bmxvYWQgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgbG9nTmFtZSA9ICdhZ2VudC1sb2cnOwogICAgdmFyIGZpbHRlckJ5TG9nTGV2ZWwgPSBmYWxzZTsKCiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdvYmplY3QnKSB7CiAgICAgIGxvZ05hbWUgPSBvcHRpb25zLmxvZ05hbWUgfHwgbG9nTmFtZTsKICAgICAgZmlsdGVyQnlMb2dMZXZlbCA9IG9wdGlvbnMuZmlsdGVyQnlMb2dMZXZlbCB8fCBmaWx0ZXJCeUxvZ0xldmVsOwogICAgfQogICAgZWxzZSBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7CiAgICAgIGxvZ05hbWUgPSBvcHRpb25zIHx8IGxvZ05hbWU7CiAgICB9CgogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGxvZ3MgPSB0aGlzLl9yb2xsZWRMb2dzLmNvbmNhdCh0aGlzLl9sb2dzKTsKICAgIGlmIChmaWx0ZXJCeUxvZ0xldmVsKSB7CiAgICAgIGxvZ3MgPSBsb2dzLmZpbHRlcihmdW5jdGlvbihlbnRyeSkgewogICAgICAgIHJldHVybiBMb2dMZXZlbE9yZGVyW2VudHJ5LmxldmVsXSA+PSBzZWxmLl9sb2dMZXZlbDsKICAgICAgfSk7CiAgICB9CgogICAgdmFyIGxvZ0Jsb2IgPSBuZXcgZ2xvYmFsLkJsb2IoW0pTT04uc3RyaW5naWZ5KGxvZ3MsIHVuZGVmaW5lZCwgNCldLCBbJ3RleHQvcGxhaW4nXSk7CiAgICB2YXIgZG93bmxvYWRMaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgdmFyIGxvZ05hbWUgPSBsb2dOYW1lIHx8ICdhZ2VudC1sb2cnOwogICAgZG93bmxvYWRMaW5rLmhyZWYgPSBnbG9iYWwuVVJMLmNyZWF0ZU9iamVjdFVSTChsb2dCbG9iKTsKICAgIGRvd25sb2FkTGluay5kb3dubG9hZCA9IGxvZ05hbWUgKyAnLnR4dCc7CiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGRvd25sb2FkTGluayk7CiAgICBkb3dubG9hZExpbmsuY2xpY2soKTsKICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoZG93bmxvYWRMaW5rKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnNjaGVkdWxlVXBzdHJlYW1Mb2dQdXNoID0gZnVuY3Rpb24gKGNvbmR1aXQpIHsKICAgIGlmICghY29ubmVjdC51cHN0cmVhbUxvZ1B1c2hTY2hlZHVsZWQpIHsKICAgICAgY29ubmVjdC51cHN0cmVhbUxvZ1B1c2hTY2hlZHVsZWQgPSB0cnVlOwogICAgICAvKiogU2NoZWR1bGUgcHVzaGluZyBsb2dzIGZyZXF1ZW50bHkgdG8gc2hhcmVkd29ya2VyIHVwc3RyZWFtLCBzaGFyZWR3b3JrZXIgd2lsbCByZXBvcnQgdG8gTEFSUyovCiAgICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMucmVwb3J0TWFzdGVyTG9nc1VwU3RyZWFtLCBjb25kdWl0KSwgU09GVFBIT05FX0xPR19SRVBPUlRfSU5URVJWQUxfTUlMTElTKTsKICAgIH0KICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnJlcG9ydE1hc3RlckxvZ3NVcFN0cmVhbSA9IGZ1bmN0aW9uIChjb25kdWl0KSB7CiAgICB2YXIgbG9nc1RvUHVzaCA9IHRoaXMuX2xvZ3NUb1B1c2guc2xpY2UoKTsKICAgIHRoaXMuX2xvZ3NUb1B1c2ggPSBbXTsKICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU0VORF9MT0dTLCBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChsb2dzVG9QdXNoLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TRU5EX0xPR1MsIGxvZ3NUb1B1c2gpOwogICAgICB9CiAgICB9KTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnNjaGVkdWxlVXBzdHJlYW1PdXRlckNvbnRleHRDQ1BzZXJ2ZXJCb3VuZExvZ3NQdXNoID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgZ2xvYmFsLnNldEludGVydmFsKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5wdXNoT3V0ZXJDb250ZXh0Q0NQc2VydmVyQm91bmRMb2dzVXBzdHJlYW0sIGNvbmR1aXQpLCAxMDAwKTsKICB9CgogIExvZ2dlci5wcm90b3R5cGUuc2NoZWR1bGVVcHN0cmVhbU91dGVyQ29udGV4dENDUExvZ3NQdXNoID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgZ2xvYmFsLnNldEludGVydmFsKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5wdXNoT3V0ZXJDb250ZXh0Q0NQTG9nc1Vwc3RyZWFtLCBjb25kdWl0KSwgMTAwMCk7CiAgfQoKICBMb2dnZXIucHJvdG90eXBlLnB1c2hPdXRlckNvbnRleHRDQ1BzZXJ2ZXJCb3VuZExvZ3NVcHN0cmVhbSA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgIGlmICh0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5sZW5ndGggPiAwKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9nc1tpXS50ZXh0ID0gdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3NbaV0udGV4dDsKICAgICAgfQoKICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU0VSVkVSX0JPVU5EX0lOVEVSTkFMX0xPRywgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MpOwogICAgICB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncyA9IFtdOwogICAgfQogIH0KCiAgTG9nZ2VyLnByb3RvdHlwZS5wdXNoT3V0ZXJDb250ZXh0Q0NQTG9nc1Vwc3RyZWFtID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgZm9yICh2YXIgaSA9IHRoaXMuX3N0YXJ0TG9nSW5kZXhUb1B1c2g7IGkgPCB0aGlzLl9sb2dzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh0aGlzLl9sb2dzW2ldLmxvZ2dlcklkICE9PSB0aGlzLl9sb2dnZXJJZCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgdGhpcy5fbG9nc1tpXSk7CiAgICB9CiAgICB0aGlzLl9zdGFydExvZ0luZGV4VG9QdXNoID0gdGhpcy5fbG9ncy5sZW5ndGg7CiAgfQoKICBMb2dnZXIucHJvdG90eXBlLmdldExvZ2dlcklkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2xvZ2dlcklkOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuc2NoZWR1bGVEb3duc3RyZWFtQ2xpZW50U2lkZUxvZ3NQdXNoID0gZnVuY3Rpb24gKCkgewogICAgZ2xvYmFsLnNldEludGVydmFsKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5wdXNoQ2xpZW50U2lkZUxvZ3NEb3duc3RyZWFtKSwgTE9HU19SRVBPUlRfSU5URVJWQUxfTUlMTElTKTsKICB9CgogIExvZ2dlci5wcm90b3R5cGUucHVzaENsaWVudFNpZGVMb2dzRG93bnN0cmVhbSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dzID0gW107CgogICAgLy8gV2UgZG8gbm90IHNlbmQgYSByZXF1ZXN0IGlmIHdlIGhhdmUgbGVzcyB0aGFuIDUwIHJlY29yZHMgc28gdGhhdCB3ZSBtaW5pbWl6ZSB0aGUgbnVtYmVyIG9mCiAgICAvLyByZXF1ZXN0cyBwZXIgc2Vjb25kLiAKICAgIC8vIDUwMCBpcyB0aGUgbWF4IHdlIGFjY2VwdCBvbiB0aGUgc2VydmVyLiAKICAgIC8vIFdlIGNob3NlIDUwMCBiZWNhdXNlIHRoaXMgaXMgdGhlIGxpbWl0IGltcG9zZWQgYnkgRmlyZWhvc2UgZm9yIGEgcHV0IGJhdGNoIHJlcXVlc3QKICAgIGlmICh0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5sZW5ndGggPCA1MCkgewogICAgICByZXR1cm47CiAgICB9IGVsc2UgaWYgKHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLmxlbmd0aCA+IDUwMCkgewogICAgICBsb2dzID0gdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3Muc3BsaWNlKDAsIDUwMCk7CiAgICB9IGVsc2UgewogICAgICBsb2dzID0gdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3M7CiAgICAgIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzID0gW107CiAgICB9CgogICAgY29ubmVjdC5wdWJsaXNoQ2xpZW50U2lkZUxvZ3MobG9ncyk7CiAgfQoKICB2YXIgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIgPSBmdW5jdGlvbiAoY29uZHVpdCkgewogICAgTG9nZ2VyLmNhbGwodGhpcyk7CiAgICB0aGlzLmNvbmR1aXQgPSBjb25kdWl0OwogICAgCiAgICBnbG9iYWwuc2V0SW50ZXJ2YWwoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLl9wdXNoTG9nc0Rvd25zdHJlYW0pLAogICAgICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5MT0dfUFVTSF9JTlRFUlZBTCk7CgogICAgLy8gRGlzYWJsZSBsb2cgcm9sbGluZywgd2Ugd2lsbCBwdXJnZSBvdXIgb3duIGxvZ3Mgb25jZSB0aGV5IGhhdmUKICAgIC8vIGJlZW4gcHVzaGVkIGRvd25zdHJlYW0uCiAgICBnbG9iYWwuY2xlYXJJbnRlcnZhbCh0aGlzLl9sb2dSb2xsVGltZXIpOwogICAgdGhpcy5fbG9nUm9sbFRpbWVyID0gbnVsbDsKICB9OwogIC8vIEhvdyBmcmVxdWVudGx5IGxvZ3Mgc2hvdWxkIGJlIGNvbGxlY3RlZCBhbmQgZGVsaXZlcmVkIGRvd25zdHJlYW0uCiAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIuTE9HX1BVU0hfSU5URVJWQUwgPSAxMDAwOwogIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoTG9nZ2VyLnByb3RvdHlwZSk7CiAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRG93bnN0cmVhbUNvbmR1aXRMb2dnZXI7CgogIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLnByb3RvdHlwZS5wdXNoTG9nc0Rvd25zdHJlYW0gPSBmdW5jdGlvbiAobG9ncykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgbG9ncy5mb3JFYWNoKGZ1bmN0aW9uIChsb2cpIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgbG9nKTsKICAgIH0pOwogIH07CgogIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLnByb3RvdHlwZS5fcHVzaExvZ3NEb3duc3RyZWFtID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgCiAgICB0aGlzLl9sb2dzLmZvckVhY2goZnVuY3Rpb24gKGxvZykgewogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTE9HLCBsb2cpOwogICAgfSk7CiAgICB0aGlzLl9sb2dzID0gW107CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5sZW5ndGg7IGkrKykgewogICAgICB0aGlzLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU0VSVkVSX0JPVU5EX0lOVEVSTkFMX0xPRywgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3NbaV0pOwogICAgfQoKICAgIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzID0gW107CiAgfTsKCiAgLyoqCiAgICogV3JhcCBhIGZ1bmN0aW9uIHdpdGggdHJ5IGNhdGNoIGJsb2NrCiAgICovCiAgdmFyIHRyeUNhdGNoV3JhcHBlck1ldGhvZCA9IGZ1bmN0aW9uIChmbikgewogICAgdmFyIHdyYXBwZWRmdW5jdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICB0cnkgewogICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgLy8gU2luY2UgdGhpcyB3cmFwcyBMb2dnZXIgY2xhc3MsIHdlIGNhbiBvbmx5IHByaW50IGl0IGluIHRoZSBjb25zb2xlIGFuZCBlYXQgaXQuCiAgICAgICAgQ09OU09MRV9MT0dHRVJfTUFQLkVSUk9SKGUpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gd3JhcHBlZGZ1bmN0aW9uOwogIH0KICAvKioKICAgKiBUaGlzIGlzIGEgd3JhcHBlciBtZXRob2QgdG8gd3JhcCBlYWNoIGZ1bmN0aW9uCiAgICogaW4gYW4gb2JqZWN0IHdpdGggdHJ5IGNhdGNoIGJsb2NrLgogICAqLwogIHZhciB0cnlDYXRjaFdyYXBwZXJPYmplY3QgPSBmdW5jdGlvbiAob2JqKSB7CiAgICBmb3IgKHZhciBtZXRob2QgaW4gb2JqKSB7CiAgICAgIGlmICh0eXBlb2Yob2JqW21ldGhvZF0pID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgb2JqW21ldGhvZF0gPSB0cnlDYXRjaFdyYXBwZXJNZXRob2Qob2JqW21ldGhvZF0pOwogICAgICB9CiAgICB9CiAgfQoKICAvKiogQ3JlYXRlIHRoZSBzaW5nbGV0b24gbG9nZ2VyIGluc3RhbmNlLiAqLwogIGNvbm5lY3Qucm9vdExvZ2dlciA9IG5ldyBMb2dnZXIoKTsKICB0cnlDYXRjaFdyYXBwZXJPYmplY3QoY29ubmVjdC5yb290TG9nZ2VyKTsKCgogIC8qKiBGZXRjaCB0aGUgc2luZ2xldG9uIGxvZ2dlciBpbnN0YW5jZS4gKi8KICB2YXIgZ2V0TG9nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Qucm9vdExvZ2dlcjsKICB9OwoKICBjb25uZWN0ID0gY29ubmVjdCB8fCB7fTsKICBjb25uZWN0LmdldExvZyA9IGdldExvZzsKICBjb25uZWN0LkxvZ0VudHJ5ID0gTG9nRW50cnk7CiAgY29ubmVjdC5Mb2dnZXIgPSBMb2dnZXI7CiAgY29ubmVjdC5Mb2dMZXZlbCA9IExvZ0xldmVsOwogIGNvbm5lY3QuTG9nQ29tcG9uZW50ID0gTG9nQ29tcG9uZW50OwogIGNvbm5lY3QuRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIgPSBEb3duc3RyZWFtQ29uZHVpdExvZ2dlcjsKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogIHZhciB1c2VyQWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50OwogIHZhciBPTkVfREFZX01JTExJUyA9IDI0ICogNjAgKiA2MCAqIDEwMDA7CiAgdmFyIERFRkFVTFRfUE9QVVBfSEVJR0hUID0gNTc4OwogIHZhciBERUZBVUxUX1BPUFVQX1dJRFRIID0gNDMzOwoKICAvKioKICAgKiBVbnBvbGx1dGUgc3ByaW50ZiBmdW5jdGlvbnMgZnJvbSB0aGUgZ2xvYmFsIG5hbWVzcGFjZS4KICAgKi8KICBjb25uZWN0LnNwcmludGYgPSBnbG9iYWwuc3ByaW50ZjsKICBjb25uZWN0LnZzcHJpbnRmID0gZ2xvYmFsLnZzcHJpbnRmOwogIGRlbGV0ZSBnbG9iYWwuc3ByaW50ZjsKICBkZWxldGUgZ2xvYmFsLnZzcHJpbnRmOwoKICBjb25uZWN0LkhUVFBfU1RBVFVTX0NPREVTID0gewogICAgU1VDQ0VTUzogMjAwLAogICAgVE9PX01BTllfUkVRVUVTVFM6IDQyOSwKICAgIElOVEVSTkFMX1NFUlZFUl9FUlJPUjogNTAwCiAgfTsKCiAgY29ubmVjdC5UUkFOU1BPUlRfVFlQRVMgPSB7CiAgICBDSEFUX1RPS0VOOiAiY2hhdF90b2tlbiIsCiAgICBXRUJfU09DS0VUOiAid2ViX3NvY2tldCIKICB9OwoKICAvKioKICAgKiBCaW5kcyB0aGUgZ2l2ZW4gaW5zdGFuY2Ugb2JqZWN0IGFzIHRoZSBjb250ZXh0IGZvcgogICAqIHRoZSBtZXRob2QgcHJvdmlkZWQuCiAgICoKICAgKiBAcGFyYW0gc2NvcGUgVGhlIGluc3RhbmNlIG9iamVjdCB0byBiZSBzZXQgYXMgdGhlIHNjb3BlCiAgICogICAgb2YgdGhlIGZ1bmN0aW9uLgogICAqIEBwYXJhbSBtZXRob2QgVGhlIG1ldGhvZCB0byBiZSBlbmNhcHN1bGF0ZWQuCiAgICoKICAgKiBBbGwgb3RoZXIgYXJndW1lbnRzLCBpZiBhbnksIGFyZSBib3VuZCB0byB0aGUgbWV0aG9kCiAgICogaW52b2NhdGlvbiBpbnNpZGUgdGhlIGNsb3N1cmUuCiAgICoKICAgKiBAcmV0dXJuIEEgY2xvc3VyZSBlbmNhcHN1bGF0aW5nIHRoZSBpbnZvY2F0aW9uIG9mIHRoZQogICAqICAgIG1ldGhvZCBwcm92aWRlZCBpbiBjb250ZXh0IG9mIHRoZSBnaXZlbiBpbnN0YW5jZS4KICAgKi8KICBjb25uZWN0LmhpdGNoID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgdmFyIHNjb3BlID0gYXJncy5zaGlmdCgpOwogICAgdmFyIG1ldGhvZCA9IGFyZ3Muc2hpZnQoKTsKCiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoc2NvcGUsICdzY29wZScpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKG1ldGhvZCwgJ21ldGhvZCcpOwogICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihtZXRob2QpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwoKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBjbG9zdXJlQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBtZXRob2QuYXBwbHkoc2NvcGUsIGFyZ3MuY29uY2F0KGNsb3N1cmVBcmdzKSk7CiAgICB9OwogIH07CgogIC8qKgogICAqIERldGVybWluZSBpZiB0aGUgZ2l2ZW4gdmFsdWUgaXMgYSBjYWxsYWJsZSBmdW5jdGlvbiB0eXBlLgogICAqIEJvcnJvd2VkIGZyb20gVW5kZXJzY29yZS5qcy4KICAgKi8KICBjb25uZWN0LmlzRnVuY3Rpb24gPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gISEob2JqICYmIG9iai5jb25zdHJ1Y3RvciAmJiBvYmouY2FsbCAmJiBvYmouYXBwbHkpOwogIH07CgogIC8qKgogICAqIERldGVybWluZSBpZiB0aGUgZ2l2ZW4gdmFsdWUgaXMgYW4gYXJyYXkuCiAgICovCiAgY29ubmVjdC5pc0FycmF5ID0gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCBBcnJheV0nOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2Yga2V5cyBmcm9tIGEgSmF2YXNjcmlwdCBvYmplY3QgdXNlZAogICAqIGFzIGEgaGFzaCBtYXAuCiAgICovCiAgY29ubmVjdC5rZXlzID0gZnVuY3Rpb24gKG1hcCkgewogICAgdmFyIGtleXMgPSBbXTsKCiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwobWFwLCAnbWFwJyk7CgogICAgZm9yICh2YXIgayBpbiBtYXApIHsKICAgICAga2V5cy5wdXNoKGspOwogICAgfQoKICAgIHJldHVybiBrZXlzOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2YgdmFsdWVzIGZyb20gYSBKYXZhc2NyaXB0IG9iamVjdCB1c2VkCiAgICogYXMgYSBoYXNoIG1hcC4KICAgKi8KICBjb25uZWN0LnZhbHVlcyA9IGZ1bmN0aW9uIChtYXApIHsKICAgIHZhciB2YWx1ZXMgPSBbXTsKCiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwobWFwLCAnbWFwJyk7CgogICAgZm9yICh2YXIgayBpbiBtYXApIHsKICAgICAgdmFsdWVzLnB1c2gobWFwW2tdKTsKICAgIH0KCiAgICByZXR1cm4gdmFsdWVzOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2Yga2V5L3ZhbHVlIHBhaXJzIGZyb20gdGhlIGdpdmVuIG1hcC4KICAgKi8KICBjb25uZWN0LmVudHJpZXMgPSBmdW5jdGlvbiAobWFwKSB7CiAgICB2YXIgZW50cmllcyA9IFtdOwoKICAgIGZvciAodmFyIGsgaW4gbWFwKSB7CiAgICAgIGVudHJpZXMucHVzaCh7IGtleTogaywgdmFsdWU6IG1hcFtrXSB9KTsKICAgIH0KCiAgICByZXR1cm4gZW50cmllczsKICB9OwoKICAvKioKICAgKiBNZXJnZSB0d28gb3IgbW9yZSBtYXBzIHRvZ2V0aGVyIGludG8gYSBuZXcgbWFwLAogICAqIG9yIHNpbXBseSBjb3B5IGEgc2luZ2xlIG1hcC4KICAgKi8KICBjb25uZWN0Lm1lcmdlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ01hcHMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgdmFyIHJlc3VsdE1hcCA9IHt9OwoKICAgIGFyZ01hcHMuZm9yRWFjaChmdW5jdGlvbiAobWFwKSB7CiAgICAgIGNvbm5lY3QuZW50cmllcyhtYXApLmZvckVhY2goZnVuY3Rpb24gKGt2KSB7CiAgICAgICAgcmVzdWx0TWFwW2t2LmtleV0gPSBrdi52YWx1ZTsKICAgICAgfSk7CiAgICB9KTsKCiAgICByZXR1cm4gcmVzdWx0TWFwOwogIH07CgogIGNvbm5lY3Qubm93ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogIH07CgogIGNvbm5lY3QuZmluZCA9IGZ1bmN0aW9uIChhcnJheSwgcHJlZGljYXRlKSB7CiAgICBmb3IgKHZhciB4ID0gMDsgeCA8IGFycmF5Lmxlbmd0aDsgeCsrKSB7CiAgICAgIGlmIChwcmVkaWNhdGUoYXJyYXlbeF0pKSB7CiAgICAgICAgcmV0dXJuIGFycmF5W3hdOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG51bGw7CiAgfTsKCiAgY29ubmVjdC5jb250YWlucyA9IGZ1bmN0aW9uIChvYmosIHZhbHVlKSB7CiAgICBpZiAob2JqIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgcmV0dXJuIGNvbm5lY3QuZmluZChvYmosIGZ1bmN0aW9uICh2KSB7IHJldHVybiB2ID09PSB2YWx1ZTsgfSkgIT0gbnVsbDsKCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gKHZhbHVlIGluIG9iaik7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5jb250YWluc1ZhbHVlID0gZnVuY3Rpb24gKG9iaiwgdmFsdWUpIHsKICAgIGlmIChvYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICByZXR1cm4gY29ubmVjdC5maW5kKG9iaiwgZnVuY3Rpb24gKHYpIHsgcmV0dXJuIHYgPT09IHZhbHVlOyB9KSAhPSBudWxsOwoKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBjb25uZWN0LmZpbmQoY29ubmVjdC52YWx1ZXMob2JqKSwgZnVuY3Rpb24gKHYpIHsgcmV0dXJuIHYgPT09IHZhbHVlOyB9KSAhPSBudWxsOwogICAgfQogIH07CgogIC8qKgogICAqIEdlbmVyYXRlIGEgcmFuZG9tIElEIGNvbnNpc3Rpbmcgb2YgdGhlIGN1cnJlbnQgdGltZXN0YW1wCiAgICogYW5kIGEgcmFuZG9tIGJhc2UtMzYgbnVtYmVyIGJhc2VkIG9uIE1hdGgucmFuZG9tKCkuCiAgICovCiAgY29ubmVjdC5yYW5kb21JZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LnNwcmludGYoIiVzLSVzIiwgY29ubmVjdC5ub3coKSwgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMikpOwogIH07CgogIC8qKgogICAqIEdlbmVyYXRlIGFuIGVudW0gZnJvbSB0aGUgZ2l2ZW4gbGlzdCBvZiBsb3dlci1jYXNlIGVudW0gdmFsdWVzLAogICAqIHdoZXJlIHRoZSBlbnVtIGtleXMgd2lsbCBiZSB1cHBlciBjYXNlLgogICAqCiAgICogQ29udmVyc2lvbiBmcm9tIHBhc2NhbCBjYXNlIGJhc2VkIG9uIGNvZGUgZnJvbSBoZXJlOgogICAqIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzA1MjEyMjQKICAgKi8KICBjb25uZWN0Lm1ha2VFbnVtID0gZnVuY3Rpb24gKHZhbHVlcykgewogICAgdmFyIGVudW1PYmogPSB7fTsKCiAgICB2YWx1ZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgdmFyIGtleSA9IHZhbHVlLnJlcGxhY2UoL1wuPyhbYS16XSspXz8vZywgZnVuY3Rpb24gKHgsIHkpIHsgcmV0dXJuIHkudG9VcHBlckNhc2UoKSArICJfIjsgfSkKICAgICAgICAucmVwbGFjZSgvXyQvLCAiIik7CgogICAgICBlbnVtT2JqW2tleV0gPSB2YWx1ZTsKICAgIH0pOwoKICAgIHJldHVybiBlbnVtT2JqOwogIH07CgogIGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtID0gZnVuY3Rpb24gKHByZWZpeCwgdmFsdWVzKSB7CiAgICB2YXIgZW51bU9iaiA9IGNvbm5lY3QubWFrZUVudW0odmFsdWVzKTsKICAgIGNvbm5lY3Qua2V5cyhlbnVtT2JqKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgZW51bU9ialtrZXldID0gY29ubmVjdC5zcHJpbnRmKCIlczo6JXMiLCBwcmVmaXgsIGVudW1PYmpba2V5XSk7CiAgICB9KTsKICAgIHJldHVybiBlbnVtT2JqOwogIH07CgogIGNvbm5lY3QubWFrZUdlbmVyaWNOYW1lc3BhY2VkRW51bSA9IGZ1bmN0aW9uIChwcmVmaXgsIHZhbHVlcywgZGVsaW1pdGVyKSB7CiAgICB2YXIgZW51bU9iaiA9IGNvbm5lY3QubWFrZUVudW0odmFsdWVzKTsKICAgIGNvbm5lY3Qua2V5cyhlbnVtT2JqKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgZW51bU9ialtrZXldID0gY29ubmVjdC5zcHJpbnRmKCIlcyIrZGVsaW1pdGVyKyIlcyIsIHByZWZpeCwgZW51bU9ialtrZXldKTsKICAgIH0pOwogICAgcmV0dXJuIGVudW1PYmo7CiAgfTsKCiAgLyoqCiAgKiBNZXRob2RzIHRvIGRldGVybWluZSBicm93c2VyIHR5cGUgYW5kIHZlcnNpb25zLCB1c2VkIGZvciBzb2Z0cGhvbmUgaW5pdGlhbGl6YXRpb24uCiAgKi8KICBjb25uZWN0LmlzQ2hyb21lQnJvd3NlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB1c2VyQWdlbnQuaW5kZXhPZigiQ2hyb21lIikgIT09IC0xOwogIH07CgogIGNvbm5lY3QuaXNGaXJlZm94QnJvd3NlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB1c2VyQWdlbnQuaW5kZXhPZigiRmlyZWZveCIpICE9PSAtMTsKICB9OwoKICBjb25uZWN0LmlzT3BlcmFCcm93c2VyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHVzZXJBZ2VudC5pbmRleE9mKCJPcGVyYSIpICE9PSAtMTsKICB9OwoKICBjb25uZWN0LmdldENocm9tZUJyb3dzZXJWZXJzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNocm9tZVZlcnNpb24gPSB1c2VyQWdlbnQuc3Vic3RyaW5nKHVzZXJBZ2VudC5pbmRleE9mKCJDaHJvbWUiKSArIDcpOwogICAgaWYgKGNocm9tZVZlcnNpb24pIHsKICAgICAgcmV0dXJuIHBhcnNlRmxvYXQoY2hyb21lVmVyc2lvbik7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gLTE7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5nZXRGaXJlZm94QnJvd3NlclZlcnNpb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZmlyZWZveFZlcnNpb24gPSB1c2VyQWdlbnQuc3Vic3RyaW5nKHVzZXJBZ2VudC5pbmRleE9mKCJGaXJlZm94IikgKyA4KTsKICAgIGlmIChmaXJlZm94VmVyc2lvbikgewogICAgICByZXR1cm4gcGFyc2VGbG9hdChmaXJlZm94VmVyc2lvbik7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gLTE7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5pc1ZhbGlkTG9jYWxlID0gZnVuY3Rpb24gKGxvY2FsZSkgewogICAgdmFyIGxhbmd1YWdlcyA9IFsKICAgICAgewogICAgICAgIGlkOiAnZW5fVVMnLAogICAgICAgIGxhYmVsOiAnRW5nbGlzaCcKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnZGVfREUnLAogICAgICAgIGxhYmVsOiAnRGV1dHNjaCcKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnZXNfRVMnLAogICAgICAgIGxhYmVsOiAnRXNwYcOxb2wnCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ2ZyX0ZSJywKICAgICAgICBsYWJlbDogJ0ZyYW7Dp2FpcycKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnamFfSlAnLAogICAgICAgIGxhYmVsOiAn5pel5pys6KqeJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICdpdF9JVCcsCiAgICAgICAgbGFiZWw6ICdJdGFsaWFubycKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAna29fS1InLAogICAgICAgIGxhYmVsOiAn7ZWc6rWt7Ja0JwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICdwdF9CUicsCiAgICAgICAgbGFiZWw6ICdQb3J0dWd1w6pzJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICd6aF9DTicsCiAgICAgICAgbGFiZWw6ICfkuK3mloco566A5L2TKScKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnemhfVFcnLAogICAgICAgIGxhYmVsOiAn5Lit5paHKOe5gemrlCknCiAgICAgIH0KICAgIF07CiAgICByZXR1cm4gbGFuZ3VhZ2VzLm1hcChmdW5jdGlvbihsYW5ndWFnZSl7IHJldHVybiBsYW5ndWFnZS5pZH0pLmluY2x1ZGVzKGxvY2FsZSk7CiAgfQoKICBjb25uZWN0LmdldE9wZXJhQnJvd3NlclZlcnNpb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgdmVyc2lvbk9mZnNldCA9IHVzZXJBZ2VudC5pbmRleE9mKCJPcGVyYSIpOwogICAgdmFyIG9wZXJhVmVyc2lvbiA9ICh1c2VyQWdlbnQuaW5kZXhPZigiVmVyc2lvbiIpICE9PSAtMSkgPyB1c2VyQWdlbnQuc3Vic3RyaW5nKHZlcnNpb25PZmZzZXQgKyA4KSA6IHVzZXJBZ2VudC5zdWJzdHJpbmcodmVyc2lvbk9mZnNldCArIDYpOwogICAgaWYgKG9wZXJhVmVyc2lvbikgewogICAgICByZXR1cm4gcGFyc2VGbG9hdChvcGVyYVZlcnNpb24pOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIC0xOwogICAgfQogIH07CgogIC8qKgogICAqIFJldHVybiBhIG1hcCBvZiBpdGVtcyBpbiB0aGUgZ2l2ZW4gbGlzdCBpbmRleGVkIGJ5CiAgICoga2V5cyBkZXRlcm1pbmVkIGJ5IHRoZSBjbG9zdXJlIHByb3ZpZGVkLgogICAqCiAgICogQHBhcmFtIGl0ZXJhYmxlIEEgbGlzdC1saWtlIG9iamVjdC4KICAgKiBAcGFyYW0gY2xvc3VyZSBBIGNsb3N1cmUgdG8gZGV0ZXJtaW5lIHRoZSBpbmRleCBmb3IgdGhlCiAgICogICAgaXRlbXMgaW4gdGhlIGl0ZXJhYmxlLgogICAqIEByZXR1cm4gQSBtYXAgZnJvbSBpbmRleCB0byBpdGVtIGZvciBlYWNoIGl0ZW0gaW4gdGhlIGl0ZXJhYmxlLgogICAqLwogIGNvbm5lY3QuaW5kZXggPSBmdW5jdGlvbiAoaXRlcmFibGUsIGNsb3N1cmUpIHsKICAgIHZhciBtYXAgPSB7fTsKCiAgICBpdGVyYWJsZS5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIG1hcFtjbG9zdXJlKGl0ZW0pXSA9IGl0ZW07CiAgICB9KTsKCiAgICByZXR1cm4gbWFwOwogIH07CgogIC8qKgogICAqIENvbnZlcnRzIHRoZSBnaXZlbiBhcnJheSBpbnRvIGEgbWFwIGFzIGEgc2V0LAogICAqIHdoZXJlIGVsZW1lbnRzIGluIHRoZSBhcnJheSBhcmUgbWFwcGVkIHRvIDEuCiAgICovCiAgY29ubmVjdC5zZXQgPSBmdW5jdGlvbiAoYXJyYXlJbikgewogICAgdmFyIHNldE1hcCA9IHt9OwoKICAgIGFycmF5SW4uZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHNldE1hcFtrZXldID0gMTsKICAgIH0pOwoKICAgIHJldHVybiBzZXRNYXA7CiAgfTsKCiAgLyoqCiAgICogUmV0dXJucyBhIG1hcCBmb3IgZWFjaCBrZXkgaW4gbWFwQiB3aGljaAogICAqIGlzIE5PVCBpbiBtYXBBLgogICAqLwogIGNvbm5lY3QucmVsYXRpdmVDb21wbGVtZW50ID0gZnVuY3Rpb24gKG1hcEEsIG1hcEIpIHsKICAgIHZhciBjb21wTWFwID0ge307CgogICAgY29ubmVjdC5rZXlzKG1hcEIpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICBpZiAoIShrZXkgaW4gbWFwQSkpIHsKICAgICAgICBjb21wTWFwW2tleV0gPSBtYXBCW2tleV07CiAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiBjb21wTWFwOwogIH07CgogIC8qKgogICAqIEFzc2VydHMgdGhhdCBhIHByZW1pc2UgaXMgdHJ1ZS4KICAgKi8KICBjb25uZWN0LmFzc2VydFRydWUgPSBmdW5jdGlvbiAocHJlbWlzZSwgbWVzc2FnZSkgewogICAgaWYgKCFwcmVtaXNlKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlZhbHVlRXJyb3IobWVzc2FnZSk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQXNzZXJ0cyB0aGF0IGEgdmFsdWUgaXMgbm90IG51bGwgb3IgdW5kZWZpbmVkLgogICAqLwogIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCA9IGZ1bmN0aW9uICh2YWx1ZSwgbmFtZSkgewogICAgY29ubmVjdC5hc3NlcnRUcnVlKHZhbHVlICE9IG51bGwgJiYgdHlwZW9mIHZhbHVlICE9PSB1bmRlZmluZWQsCiAgICAgIGNvbm5lY3Quc3ByaW50ZigiJXMgbXVzdCBiZSBwcm92aWRlZCIsIG5hbWUgfHwgJ0EgdmFsdWUnKSk7CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKCiAgY29ubmVjdC5kZWVwY29weSA9IGZ1bmN0aW9uIChzcmMpIHsKICAgIHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHNyYykpOwogIH07CgogIC8qKgogICAqIEdldCB0aGUgY3VycmVudCBiYXNlIHVybCBvZiB0aGUgb3BlbiBwYWdlLCBlLmcuIGlmIHRoZSBwYWdlIGlzCiAgICogaHR0cHM6Ly9leGFtcGxlLmNvbTo5NDk0L29yYW5nZXMsIHRoaXMgd2lsbCBiZSAiaHR0cHM6Ly9leGFtcGxlLmNvbTo5NDk0Ii4KICAgKi8KICBjb25uZWN0LmdldEJhc2VVcmwgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9jYXRpb24gPSBnbG9iYWwubG9jYXRpb247CiAgICByZXR1cm4gY29ubmVjdC5zcHJpbnRmKCIlcy8vJXM6JXMiLCBsb2NhdGlvbi5wcm90b2NvbCwgbG9jYXRpb24uaG9zdG5hbWUsIGxvY2F0aW9uLnBvcnQpOwogIH07CgogIGNvbm5lY3QuZ2V0VXJsV2l0aFByb3RvY29sID0gZnVuY3Rpb24odXJsKSB7CiAgICB2YXIgcHJvdG9jb2wgPSBnbG9iYWwubG9jYXRpb24ucHJvdG9jb2w7CiAgICBpZiAodXJsLnN1YnN0cigwLCBwcm90b2NvbC5sZW5ndGgpICE9PSBwcm90b2NvbCkgewogICAgICByZXR1cm4gY29ubmVjdC5zcHJpbnRmKCIlcy8vJXMiLCBwcm90b2NvbCwgdXJsKTsKICAgIH0KICAgIHJldHVybiB1cmw7CiAgfQoKICAvKioKICAgKiBEZXRlcm1pbmUgaWYgdGhlIGN1cnJlbnQgd2luZG93IGlzIGluIGFuIGlmcmFtZS4KICAgKiBDb3VydGVzeTogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8zMjYwNjkvCiAgICovCiAgY29ubmVjdC5pc0ZyYW1lZCA9IGZ1bmN0aW9uICgpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiB3aW5kb3cuc2VsZiAhPT0gd2luZG93LnRvcDsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5oYXNPdGhlckNvbm5lY3RlZENDUHMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHMgPiAxOwogIH0KCiAgY29ubmVjdC5mZXRjaCA9IGZ1bmN0aW9uIChlbmRwb2ludCwgb3B0aW9ucywgbWlsbGlJbnRlcnZhbCwgbWF4UmV0cnkpIHsKICAgIG1heFJldHJ5ID0gbWF4UmV0cnkgfHwgNTsKICAgIG1pbGxpSW50ZXJ2YWwgPSBtaWxsaUludGVydmFsIHx8IDEwMDA7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGZ1bmN0aW9uIGZldGNoRGF0YShtYXhSZXRyeSkgewogICAgICAgIGZldGNoKGVuZHBvaW50LCBvcHRpb25zKS50aGVuKGZ1bmN0aW9uIChyZXMpIHsKICAgICAgICAgIGlmIChyZXMuc3RhdHVzID09PSBjb25uZWN0LkhUVFBfU1RBVFVTX0NPREVTLlNVQ0NFU1MpIHsKICAgICAgICAgICAgcmVzLmpzb24oKS50aGVuKGpzb24gPT4gcmVzb2x2ZShqc29uKSkuY2F0Y2goKCkgPT4gcmVzb2x2ZSh7fSkpOwogICAgICAgICAgfSBlbHNlIGlmIChtYXhSZXRyeSAhPT0gMSAmJiAocmVzLnN0YXR1cyA+PSBjb25uZWN0LkhUVFBfU1RBVFVTX0NPREVTLklOVEVSTkFMX1NFUlZFUl9FUlJPUiB8fCByZXMuc3RhdHVzID09PSBjb25uZWN0LkhUVFBfU1RBVFVTX0NPREVTLlRPT19NQU5ZX1JFUVVFU1RTKSkgewogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBmZXRjaERhdGEoLS1tYXhSZXRyeSk7CiAgICAgICAgICAgIH0sIG1pbGxpSW50ZXJ2YWwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVqZWN0KHJlcyk7CiAgICAgICAgICB9CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGUpIHsKICAgICAgICAgIHJlamVjdChlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBmZXRjaERhdGEobWF4UmV0cnkpOwogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogQ2FsbGluZyBhIGZ1bmN0aW9uIHdpdGggZXhwb25lbnRpYWwgYmFja29mZiB3aXRoIGZ1bGwgaml0dGVyIHJldHJ5IHN0cmF0ZWd5CiAgICogSXQgd2lsbCByZXRyeSBjYWxsaW5nIHRoZSBmdW5jdGlvbiBmb3IgbWF4aW11bSBtYXhSZXRyeSB0aW1lcyBpZiBpdCBmYWlscy4KICAgKiBTdWNjZXNzIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBmdW5jdGlvbiBzdWNjZWVkZWQuCiAgICogRmFpbHVyZSBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBvbmx5IGlmIHRoZSBsYXN0IHRyeSBmYWlsZWQuCiAgICovCiAgY29ubmVjdC5iYWNrb2ZmID0gZnVuY3Rpb24gKGZ1bmMsIG1pbGxpSW50ZXJ2YWwsIG1heFJldHJ5LCBjYWxsYmFja3MpIHsKICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZnVuYyksICJmdW5jIG11c3QgYmUgYSBGdW5jdGlvbiIpOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHJhdGlvID0gMjsKCiAgICBmdW5jKHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5zdWNjZXNzKSB7CiAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICBpZiAobWF4UmV0cnkgPiAwKSB7CiAgICAgICAgICB2YXIgaW50ZXJ2YWwgPSBtaWxsaUludGVydmFsICogMiAqIE1hdGgucmFuZG9tKCk7CiAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHNlbGYuYmFja29mZihmdW5jLCBpbnRlcnZhbCAqIHJhdGlvLCAtLW1heFJldHJ5LCBjYWxsYmFja3MpOwogICAgICAgICAgfSwgaW50ZXJ2YWwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVyciwgZGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9OwoKICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMgPSBmdW5jdGlvbiAobWV0cmljRGF0YSkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuQ0xJRU5UX01FVFJJQywKICAgICAgZGF0YTogbWV0cmljRGF0YQogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5wdWJsaXNoU29mdHBob25lU3RhdHMgPSBmdW5jdGlvbihzdGF0cykgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuU09GVFBIT05FX1NUQVRTLAogICAgICBkYXRhOiBzdGF0cwogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5wdWJsaXNoU29mdHBob25lUmVwb3J0ID0gZnVuY3Rpb24ocmVwb3J0KSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5TT0ZUUEhPTkVfUkVQT1JULAogICAgICBkYXRhOiByZXBvcnQKICAgIH0pOwogIH07CgogIGNvbm5lY3QucHVibGlzaENsaWVudFNpZGVMb2dzID0gZnVuY3Rpb24obG9ncykgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuQ0xJRU5UX1NJREVfTE9HUywgbG9ncyk7CiAgfTsKCiAgLyoqCiAgICogQSB3cmFwcGVyIGFyb3VuZCBXaW5kb3cub3BlbigpIGZvciBtYW5hZ2luZyBzaW5nbGUgaW5zdGFuY2UgcG9wdXBzLgogICAqLwogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyID0gZnVuY3Rpb24gKCkgeyB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUub3BlbiA9IGZ1bmN0aW9uICh1cmwsIG5hbWUsIG9wdGlvbnMpIHsKICAgIHZhciB0aGVuID0gdGhpcy5fZ2V0TGFzdE9wZW5lZFRpbWVzdGFtcChuYW1lKTsKICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIHZhciB3aW4gPSBudWxsOwogICAgaWYgKG5vdyAtIHRoZW4gPiBPTkVfREFZX01JTExJUykgewogICAgICBpZiAob3B0aW9ucykgewogICAgICAgIC8vIGRlZmF1bHQgdmFsdWVzIGFyZSBjaG9zZW4gdG8gcHJvdmlkZSBhIG1pbmltdW0gaGVpZ2h0IHdpdGhvdXQgc2Nyb2xsaW5nCiAgICAgICAgLy8gYW5kIGEgdW5pZm9ybSBtYXJnaW4gYmFzZWQgb24gdGhlIGNzcyBvZiB0aGUgY2NwIGxvZ2luIHBhZ2UKICAgICAgICB2YXIgaGVpZ2h0ID0gb3B0aW9ucy5oZWlnaHQgfHwgREVGQVVMVF9QT1BVUF9IRUlHSFQ7CiAgICAgICAgdmFyIHdpZHRoID0gb3B0aW9ucy53aWR0aCB8fCBERUZBVUxUX1BPUFVQX1dJRFRIOwogICAgICAgIHZhciB0b3AgPSBvcHRpb25zLnRvcCB8fCAwOwogICAgICAgIHZhciBsZWZ0ID0gb3B0aW9ucy5sZWZ0IHx8IDA7CiAgICAgICAgd2luID0gd2luZG93Lm9wZW4oJycsIG5hbWUsICJ3aWR0aD0iK3dpZHRoKyIsIGhlaWdodD0iK2hlaWdodCsiLCB0b3A9Iit0b3ArIiwgbGVmdD0iK2xlZnQpOwogICAgICAgIGlmICh3aW4ubG9jYXRpb24gIT09IHVybCkgewogICAgICAgICAgd2luID0gd2luZG93Lm9wZW4odXJsLCBuYW1lLCAid2lkdGg9Iit3aWR0aCsiLCBoZWlnaHQ9IitoZWlnaHQrIiwgdG9wPSIrdG9wKyIsIGxlZnQ9IitsZWZ0KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2luID0gd2luZG93Lm9wZW4oJycsIG5hbWUpOwogICAgICAgIGlmICh3aW4ubG9jYXRpb24gIT09IHVybCkgewogICAgICAgICAgd2luID0gd2luZG93Lm9wZW4odXJsLCBuYW1lKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5fc2V0TGFzdE9wZW5lZFRpbWVzdGFtcChuYW1lLCBub3cpOwogICAgfQogICAgcmV0dXJuIHdpbjsKICB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAobmFtZSkgewogICAgdmFyIGtleSA9IHRoaXMuX2dldExvY2FsU3RvcmFnZUtleShuYW1lKTsKICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShrZXkpOwogIH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5fZ2V0TGFzdE9wZW5lZFRpbWVzdGFtcCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICB2YXIga2V5ID0gdGhpcy5fZ2V0TG9jYWxTdG9yYWdlS2V5KG5hbWUpOwogICAgdmFyIHZhbHVlID0gZ2xvYmFsLmxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSk7CgogICAgaWYgKHZhbHVlKSB7CiAgICAgIHJldHVybiBwYXJzZUludCh2YWx1ZSwgMTApOwoKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAwOwogICAgfQogIH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5fc2V0TGFzdE9wZW5lZFRpbWVzdGFtcCA9IGZ1bmN0aW9uIChuYW1lLCB0cykgewogICAgdmFyIGtleSA9IHRoaXMuX2dldExvY2FsU3RvcmFnZUtleShuYW1lKTsKICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXksICcnICsgdHMpOwogIH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5fZ2V0TG9jYWxTdG9yYWdlS2V5ID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgIHJldHVybiAiY29ubmVjdFBvcHVwTWFuYWdlcjo6IiArIG5hbWU7CiAgfTsKCiAgLyoqCiAgICogQW4gZW51bWVyYXRpb24gb2YgdGhlIEhUTUw1IG5vdGlmaWNhdGlvbiBwZXJtaXNzaW9uIHZhbHVlcy4KICAgKi8KICB2YXIgTm90aWZpY2F0aW9uUGVybWlzc2lvbiA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2dyYW50ZWQnLAogICAgJ2RlbmllZCcsCiAgICAnZGVmYXVsdCcKICBdKTsKCiAgLyoqCiAgICogQSBzaW1wbGUgZW5naW5lIGZvciBzaG93aW5nIG5vdGlmaWNhdGlvbiBwb3B1cHMuCiAgICovCiAgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5xdWV1ZSA9IFtdOwogICAgdGhpcy5wZXJtaXNzaW9uID0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5ERUZBVUxUOwogIH07CgogIGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlci5wcm90b3R5cGUucmVxdWVzdFBlcm1pc3Npb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZiAoISgiTm90aWZpY2F0aW9uIiBpbiBnbG9iYWwpKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiVGhpcyBicm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBub3RpZmljYXRpb25zLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHRoaXMucGVybWlzc2lvbiA9IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uREVOSUVEOwoKICAgIH0gZWxzZSBpZiAoZ2xvYmFsLk5vdGlmaWNhdGlvbi5wZXJtaXNzaW9uID09PSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkRFTklFRCkgewogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIlRoZSB1c2VyIGhhcyByZXF1ZXN0ZWQgdG8gbm90IHJlY2VpdmUgbm90aWZpY2F0aW9ucy4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB0aGlzLnBlcm1pc3Npb24gPSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkRFTklFRDsKCiAgICB9IGVsc2UgaWYgKHRoaXMucGVybWlzc2lvbiAhPT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5HUkFOVEVEKSB7CiAgICAgIGdsb2JhbC5Ob3RpZmljYXRpb24ucmVxdWVzdFBlcm1pc3Npb24oKS50aGVuKGZ1bmN0aW9uIChwZXJtaXNzaW9uKSB7CiAgICAgICAgc2VsZi5wZXJtaXNzaW9uID0gcGVybWlzc2lvbjsKICAgICAgICBpZiAocGVybWlzc2lvbiA9PT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5HUkFOVEVEKSB7CiAgICAgICAgICBzZWxmLl9zaG93UXVldWVkKCk7CgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxmLnF1ZXVlID0gW107CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwoKICBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIucHJvdG90eXBlLnNob3cgPSBmdW5jdGlvbiAodGl0bGUsIG9wdGlvbnMpIHsKICAgIGlmICh0aGlzLnBlcm1pc3Npb24gPT09IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uR1JBTlRFRCkgewogICAgICByZXR1cm4gdGhpcy5fc2hvd0ltcGwoeyB0aXRsZTogdGl0bGUsIG9wdGlvbnM6IG9wdGlvbnMgfSk7CgogICAgfSBlbHNlIGlmICh0aGlzLnBlcm1pc3Npb24gPT09IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uREVOSUVEKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiVW5hYmxlIHRvIHNob3cgbm90aWZpY2F0aW9uLiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICB0aXRsZTogdGl0bGUsCiAgICAgICAgICBvcHRpb25zOiBvcHRpb25zCiAgICAgICAgfSk7CgogICAgfSBlbHNlIHsKICAgICAgdmFyIHBhcmFtcyA9IHsgdGl0bGU6IHRpdGxlLCBvcHRpb25zOiBvcHRpb25zIH07CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiRGVmZXJyaW5nIG5vdGlmaWNhdGlvbiB1bnRpbCB1c2VyIGRlY2lkZXMgdG8gYWxsb3cgb3IgZGVueS4iKQogICAgICAgIC53aXRoT2JqZWN0KHBhcmFtcykKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgdGhpcy5xdWV1ZS5wdXNoKHBhcmFtcyk7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyLnByb3RvdHlwZS5fc2hvd1F1ZXVlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBub3RpZmljYXRpb25zID0gdGhpcy5xdWV1ZS5tYXAoZnVuY3Rpb24gKHBhcmFtcykgewogICAgICByZXR1cm4gc2VsZi5fc2hvd0ltcGwocGFyYW1zKTsKICAgIH0pOwogICAgdGhpcy5xdWV1ZSA9IFtdOwogICAgcmV0dXJuIG5vdGlmaWNhdGlvbnM7CiAgfTsKCiAgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyLnByb3RvdHlwZS5fc2hvd0ltcGwgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICB2YXIgbm90aWZpY2F0aW9uID0gbmV3IGdsb2JhbC5Ob3RpZmljYXRpb24ocGFyYW1zLnRpdGxlLCBwYXJhbXMub3B0aW9ucyk7CiAgICBpZiAocGFyYW1zLm9wdGlvbnMuY2xpY2tlZCkgewogICAgICBub3RpZmljYXRpb24ub25jbGljayA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBwYXJhbXMub3B0aW9ucy5jbGlja2VkLmNhbGwobm90aWZpY2F0aW9uKTsKICAgICAgfTsKICAgIH0KICAgIHJldHVybiBub3RpZmljYXRpb247CiAgfTsKCiAgY29ubmVjdC5CYXNlRXJyb3IgPSBmdW5jdGlvbiAoZm9ybWF0LCBhcmdzKSB7CiAgICBnbG9iYWwuRXJyb3IuY2FsbCh0aGlzLCBjb25uZWN0LnZzcHJpbnRmKGZvcm1hdCwgYXJncykpOwogIH07CiAgY29ubmVjdC5CYXNlRXJyb3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShFcnJvci5wcm90b3R5cGUpOwogIGNvbm5lY3QuQmFzZUVycm9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGNvbm5lY3QuQmFzZUVycm9yOwoKICBjb25uZWN0LlZhbHVlRXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICB2YXIgZm9ybWF0ID0gYXJncy5zaGlmdCgpOwogICAgY29ubmVjdC5CYXNlRXJyb3IuY2FsbCh0aGlzLCBmb3JtYXQsIGFyZ3MpOwogIH07CiAgY29ubmVjdC5WYWx1ZUVycm9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoY29ubmVjdC5CYXNlRXJyb3IucHJvdG90eXBlKTsKICBjb25uZWN0LlZhbHVlRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gY29ubmVjdC5WYWx1ZUVycm9yOwoKICBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICB2YXIgZm9ybWF0ID0gYXJncy5zaGlmdCgpOwogICAgY29ubmVjdC5CYXNlRXJyb3IuY2FsbCh0aGlzLCBmb3JtYXQsIGFyZ3MpOwogIH07CiAgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoY29ubmVjdC5CYXNlRXJyb3IucHJvdG90eXBlKTsKICBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yOwoKICBjb25uZWN0LlN0YXRlRXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICB2YXIgZm9ybWF0ID0gYXJncy5zaGlmdCgpOwogICAgY29ubmVjdC5CYXNlRXJyb3IuY2FsbCh0aGlzLCBmb3JtYXQsIGFyZ3MpOwogIH07CiAgY29ubmVjdC5TdGF0ZUVycm9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoY29ubmVjdC5CYXNlRXJyb3IucHJvdG90eXBlKTsKICBjb25uZWN0LlN0YXRlRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gY29ubmVjdC5TdGF0ZUVycm9yOwoKICBjb25uZWN0LlZvaWNlSWRFcnJvciA9IGZ1bmN0aW9uKHR5cGUsIG1lc3NhZ2UsIGVycil7CiAgICB2YXIgZXJyb3IgPSB7fTsKICAgIGVycm9yLnR5cGUgPSB0eXBlOwogICAgZXJyb3IubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICBlcnJvci5zdGFjayA9IEVycm9yKG1lc3NhZ2UpLnN0YWNrOwogICAgZXJyb3IuZXJyID0gZXJyOwogICAgcmV0dXJuIGVycm9yOwogIH0KCiAgLy8gaW50ZXJuYWwgdXNlIG9ubHkKICBjb25uZWN0LmlzQ0NQID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgIHJldHVybiBjb25kdWl0Lm5hbWUgPT09ICdDb25uZWN0U2hhcmVkV29ya2VyQ29uZHVpdCc7CiAgfQp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwoKICB2YXIgQUxMX0VWRU5UUyA9ICc8PGFsbD4+JzsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBFdmVudFR5cGUKICAgKi8KICB2YXIgRXZlbnRUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnYWNrbm93bGVkZ2UnLAogICAgJ2Fja190aW1lb3V0JywKICAgICdpbml0JywKICAgICdhcGlfcmVxdWVzdCcsCiAgICAnYXBpX3Jlc3BvbnNlJywKICAgICdhdXRoX2ZhaWwnLAogICAgJ2FjY2Vzc19kZW5pZWQnLAogICAgJ2Nsb3NlJywKICAgICdjb25maWd1cmUnLAogICAgJ2xvZycsCiAgICAnbWFzdGVyX3JlcXVlc3QnLAogICAgJ21hc3Rlcl9yZXNwb25zZScsCiAgICAnc3luY2hyb25pemUnLAogICAgJ3Rlcm1pbmF0ZScsCiAgICAndGVybWluYXRlZCcsCiAgICAnc2VuZF9sb2dzJywKICAgICdyZWxvYWRfYWdlbnRfY29uZmlndXJhdGlvbicsCiAgICAnYnJvYWRjYXN0JywKICAgICdhcGlfbWV0cmljJywKICAgICdjbGllbnRfbWV0cmljJywKICAgICdzb2Z0cGhvbmVfc3RhdHMnLAogICAgJ3NvZnRwaG9uZV9yZXBvcnQnLAogICAgJ2NsaWVudF9zaWRlX2xvZ3MnLAogICAgJ3NlcnZlcl9ib3VuZF9pbnRlcm5hbF9sb2cnLAogICAgJ211dGUnLAogICAgImlmcmFtZV9zdHlsZSIsCiAgICAidXBkYXRlX2Nvbm5lY3RlZF9jY3BzIiwKICAgICJvdXRlcl9jb250ZXh0X2luZm8iLAogICAgIm1lZGlhX2RldmljZV9yZXF1ZXN0IiwKICAgICJtZWRpYV9kZXZpY2VfcmVzcG9uc2UiCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gTWFzdGVyVG9waWNzCiAgICovCiAgdmFyIE1hc3RlclRvcGljcyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdjb25uZWN0JywgWwogICAgJ2xvZ2luUG9wdXAnLAogICAgJ3NlbmRMb2dzJywKICAgICdzb2Z0cGhvbmUnLAogICAgJ3Jpbmd0b25lJywKICAgICdtZXRyaWNzJwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIEFnZW50RXZlbnRzCiAgICovCiAgdmFyIEFnZW50RXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2FnZW50JywgWwogICAgJ2luaXQnLAogICAgJ3VwZGF0ZScsCiAgICAncmVmcmVzaCcsCiAgICAncm91dGFibGUnLAogICAgJ25vdF9yb3V0YWJsZScsCiAgICAncGVuZGluZycsCiAgICAnY29udGFjdF9wZW5kaW5nJywKICAgICdvZmZsaW5lJywKICAgICdlcnJvcicsCiAgICAnc29mdHBob25lX2Vycm9yJywKICAgICd3ZWJzb2NrZXRfY29ubmVjdGlvbl9sb3N0JywKICAgICd3ZWJzb2NrZXRfY29ubmVjdGlvbl9nYWluZWQnLAogICAgJ3N0YXRlX2NoYW5nZScsCiAgICAnYWN3JywKICAgICdtdXRlX3RvZ2dsZScsCiAgICAnbG9jYWxfbWVkaWFfc3RyZWFtX2NyZWF0ZWQnLAogICAgJ2VucXVldWVkX25leHRfc3RhdGUnCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogZW51bSBXZWJTb2NrZXRFdmVudHMKICAqLwogIHZhciBXZWJTb2NrZXRFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnd2ViU29ja2V0JywgWwogICAgJ2luaXRfZmFpbHVyZScsCiAgICAnY29ubmVjdGlvbl9vcGVuJywKICAgICdjb25uZWN0aW9uX2Nsb3NlJywKICAgICdjb25uZWN0aW9uX2Vycm9yJywKICAgICdjb25uZWN0aW9uX2dhaW4nLAogICAgJ2Nvbm5lY3Rpb25fbG9zdCcsCiAgICAnc3Vic2NyaXB0aW9uX3VwZGF0ZScsCiAgICAnc3Vic2NyaXB0aW9uX2ZhaWx1cmUnLAogICAgJ2FsbF9tZXNzYWdlJywKICAgICdzZW5kJywKICAgICdzdWJzY3JpYmUnCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBlbnVtIENvbnRhY3RFdmVudHMKICAgICovCiAgdmFyIENvbnRhY3RFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnY29udGFjdCcsIFsKICAgICdpbml0JywKICAgICdyZWZyZXNoJywKICAgICdkZXN0cm95ZWQnLAogICAgJ2luY29taW5nJywKICAgICdwZW5kaW5nJywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ21pc3NlZCcsCiAgICAnYWN3JywKICAgICd2aWV3JywKICAgICdlbmRlZCcsCiAgICAnZXJyb3InLAogICAgJ2FjY2VwdGVkJwogIF0pOwoKICB2YXIgVGFza0xpc3RFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgndGFza0xpc3QnLCBbCiAgICAnYWN0aXZhdGVfY2hhbm5lbF93aXRoX3ZpZXdfdHlwZScKICBdKTsKCgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogZW51bSBDb25uZWN0aW9uRXZlbnRzCiAgKi8KICB2YXIgQ29ubmVjdGlvbkV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdjb25uZWN0aW9uJywgWwogICAgJ3Nlc3Npb25faW5pdCcsCiAgICAncmVhZHlfdG9fc3RhcnRfc2Vzc2lvbicKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBDb25maWd1cmF0aW9uIEV2ZW50cwogICAqLwogIHZhciBDb25maWd1cmF0aW9uRXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2NvbmZpZ3VyYXRpb24nLCBbCiAgICAnY29uZmlndXJlJywKICAgICdzZXRfc3BlYWtlcl9kZXZpY2UnLAogICAgJ3NldF9taWNyb3Bob25lX2RldmljZScsCiAgICAnc2V0X3Jpbmdlcl9kZXZpY2UnLAogICAgJ3NwZWFrZXJfZGV2aWNlX2NoYW5nZWQnLAogICAgJ21pY3JvcGhvbmVfZGV2aWNlX2NoYW5nZWQnLAogICAgJ3Jpbmdlcl9kZXZpY2VfY2hhbmdlZCcKICBdKTsKCiAgdmFyIERpc2FzdGVyUmVjb3ZlcnlFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnZGlzYXN0ZXJSZWNvdmVyeScsIFsKICAgICdzdXBwcmVzcycsCiAgICAnZm9yY2Vfb2ZmbGluZScsIC8vIGxldHRpbmcgdGhlIHNoYXJlZHdvcmtlciBrbm93IHRvIGZvcmNlIG9mZmxpbmUgCiAgICAnc2V0X29mZmxpbmUnLCAvLyBpZnJhbWUgbGV0dGluZyB0aGUgbmF0aXZlIGNjcCB0byBzZXQgb2ZmbGluZQogICAgJ2luaXRfZGlzYXN0ZXJfcmVjb3ZlcnknLAogICAgJ2ZhaWxvdmVyJyAvLyB1c2VkIHRvIHByb3BhZ2F0ZSBmYWlsb3ZlciBzdGF0ZSB0byBvdGhlciB3aW5kb3dzCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29uZmlndXJhdGlvbiBFdmVudHMKICAgKi8KICB2YXIgQ29uZmlndXJhdGlvbkV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdjb25maWd1cmF0aW9uJywgWwogICAgJ2NvbmZpZ3VyZScsCiAgICAnc2V0X3NwZWFrZXJfZGV2aWNlJywKICAgICdzZXRfbWljcm9waG9uZV9kZXZpY2UnLAogICAgJ3NldF9yaW5nZXJfZGV2aWNlJywKICAgICdzcGVha2VyX2RldmljZV9jaGFuZ2VkJywKICAgICdtaWNyb3Bob25lX2RldmljZV9jaGFuZ2VkJywKICAgICdyaW5nZXJfZGV2aWNlX2NoYW5nZWQnCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIEV2ZW50RmFjdG9yeQogICAqLwogIHZhciBFdmVudEZhY3RvcnkgPSBmdW5jdGlvbiAoKSB7IH07CiAgRXZlbnRGYWN0b3J5LmNyZWF0ZVJlcXVlc3QgPSBmdW5jdGlvbiAodHlwZSwgbWV0aG9kLCBwYXJhbXMpIHsKICAgIHJldHVybiB7CiAgICAgIGV2ZW50OiB0eXBlLAogICAgICByZXF1ZXN0SWQ6IGNvbm5lY3QucmFuZG9tSWQoKSwKICAgICAgbWV0aG9kOiBtZXRob2QsCiAgICAgIHBhcmFtczogcGFyYW1zCiAgICB9OwogIH07CgogIEV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZSA9IGZ1bmN0aW9uICh0eXBlLCByZXF1ZXN0LCBkYXRhLCBlcnIpIHsKICAgIHJldHVybiB7CiAgICAgIGV2ZW50OiB0eXBlLAogICAgICByZXF1ZXN0SWQ6IHJlcXVlc3QucmVxdWVzdElkLAogICAgICBkYXRhOiBkYXRhLAogICAgICBlcnI6IGVyciB8fCBudWxsCiAgICB9OwogIH07CgogIC8qKgogICAqIEFuIG9iamVjdCByZXByZXNlbnRpbmcgYW4gZXZlbnQgc3Vic2NyaXB0aW9uIGluIGFuIEV2ZW50QnVzLgogICAqLwogIHZhciBTdWJzY3JpcHRpb24gPSBmdW5jdGlvbiAoc3ViTWFwLCBldmVudE5hbWUsIGYpIHsKICAgIHRoaXMuc3ViTWFwID0gc3ViTWFwOwogICAgdGhpcy5pZCA9IGNvbm5lY3QucmFuZG9tSWQoKTsKICAgIHRoaXMuZXZlbnROYW1lID0gZXZlbnROYW1lOwogICAgdGhpcy5mID0gZjsKICB9OwoKICAvKioKICAgKiBVbnN1YnNjcmliZSB0aGUgaGFuZGxlciBvZiB0aGlzIHN1YnNjcmlwdGlvbiBmcm9tIHRoZSBFdmVudEJ1cwogICAqIGZyb20gd2hpY2ggaXQgd2FzIGNyZWF0ZWQuCiAgICovCiAgU3Vic2NyaXB0aW9uLnByb3RvdHlwZS51bnN1YnNjcmliZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuc3ViTWFwLnVuc3Vic2NyaWJlKHRoaXMuZXZlbnROYW1lLCB0aGlzLmlkKTsKICB9OwoKICAvKioKICAgKiBBIG1hcCBvZiBldmVudCBzdWJzY3JpcHRpb25zLCB1c2VkIGJ5IHRoZSBFdmVudEJ1cy4KICAgKi8KICB2YXIgU3Vic2NyaXB0aW9uTWFwID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5zdWJJZE1hcCA9IHt9OwogICAgdGhpcy5zdWJFdmVudE5hbWVNYXAgPSB7fTsKICB9OwoKICAvKioKICAgKiBBZGQgYSBzdWJzY3JpcHRpb24gZm9yIHRoZSBuYW1lZCBldmVudC4gIENyZWF0ZXMgYSBuZXcgU3Vic2NyaXB0aW9uCiAgICogb2JqZWN0IGFuZCByZXR1cm5zIGl0LiAgVGhpcyBvYmplY3QgY2FuIGJlIHVzZWQgdG8gdW5zdWJzY3JpYmUuCiAgICovCiAgU3Vic2NyaXB0aW9uTWFwLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBmKSB7CiAgICB2YXIgc3ViID0gbmV3IFN1YnNjcmlwdGlvbih0aGlzLCBldmVudE5hbWUsIGYpOwoKICAgIHRoaXMuc3ViSWRNYXBbc3ViLmlkXSA9IHN1YjsKICAgIHZhciBzdWJMaXN0ID0gdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXSB8fCBbXTsKICAgIHN1Ykxpc3QucHVzaChzdWIpOwogICAgdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXSA9IHN1Ykxpc3Q7CiAgICByZXR1cm4gc3ViOwogIH07CgogIC8qKgogICAqIFVuc3Vic2NyaWJlIGEgc3Vic2NyaXB0aW9uIG1hdGNoaW5nIHRoZSBnaXZlbiBldmVudCBuYW1lIGFuZCBpZC4KICAgKi8KICBTdWJzY3JpcHRpb25NYXAucHJvdG90eXBlLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgc3ViSWQpIHsKICAgIGlmIChjb25uZWN0LmNvbnRhaW5zKHRoaXMuc3ViRXZlbnROYW1lTWFwLCBldmVudE5hbWUpKSB7CiAgICAgIHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0gPSB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdLmZpbHRlcihmdW5jdGlvbiAocykgeyByZXR1cm4gcy5pZCAhPT0gc3ViSWQ7IH0pOwoKICAgICAgaWYgKHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0ubGVuZ3RoIDwgMSkgewogICAgICAgIGRlbGV0ZSB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdOwogICAgICB9CiAgICB9CgogICAgaWYgKGNvbm5lY3QuY29udGFpbnModGhpcy5zdWJJZE1hcCwgc3ViSWQpKSB7CiAgICAgIGRlbGV0ZSB0aGlzLnN1YklkTWFwW3N1YklkXTsKICAgIH0KICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIGFsbCBzdWJzY3JpcHRpb25zIGluIHRoZSBzdWJzY3JpcHRpb24gbWFwLgogICAqLwogIFN1YnNjcmlwdGlvbk1hcC5wcm90b3R5cGUuZ2V0QWxsU3Vic2NyaXB0aW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LnZhbHVlcyh0aGlzLnN1YkV2ZW50TmFtZU1hcCkucmVkdWNlKGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgIHJldHVybiBhLmNvbmNhdChiKTsKICAgIH0sIFtdKTsKICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIHN1YnNjcmlwdGlvbnMgZm9yIHRoZSBnaXZlbiBldmVudCBuYW1lLCBvciBhbiBlbXB0eQogICAqIGxpc3QgaWYgdGhlcmUgYXJlIG5vIHN1YnNjcmlwdGlvbnMuCiAgICovCiAgU3Vic2NyaXB0aW9uTWFwLnByb3RvdHlwZS5nZXRTdWJzY3JpcHRpb25zID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgcmV0dXJuIHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0gfHwgW107CiAgfTsKCiAgLyoqCiAgICogQW4gb2JqZWN0IHdoaWNoIG1haW50YWlucyBhIG1hcCBvZiBzdWJzY3JpcHRpb25zIGFuZCBzZXJ2ZXMgYXMgdGhlCiAgICogbWVjaGFuaXNtIGZvciB0cmlnZ2VyaW5nIGV2ZW50cyB0byBiZSBoYW5kbGVkIGJ5IHN1YnNjcmliZXJzLgogICAqLwogIHZhciBFdmVudEJ1cyA9IGZ1bmN0aW9uIChwYXJhbXNJbikgewogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwoKICAgIHRoaXMuc3ViTWFwID0gbmV3IFN1YnNjcmlwdGlvbk1hcCgpOwogICAgdGhpcy5sb2dFdmVudHMgPSBwYXJhbXMubG9nRXZlbnRzIHx8IGZhbHNlOwogIH07CgogIC8qKgogICAqIFN1YnNjcmliZSB0byB0aGUgbmFtZWQgZXZlbnQuICBSZXR1cm5zIGEgbmV3IFN1YnNjcmlwdGlvbiBvYmplY3QKICAgKiB3aGljaCBjYW4gYmUgdXNlZCB0byB1bnN1YnNjcmliZS4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgZikgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgIHJldHVybiB0aGlzLnN1Yk1hcC5zdWJzY3JpYmUoZXZlbnROYW1lLCBmKTsKICB9OwoKICAvKioKICAgKiBTdWJzY3JpYmUgYSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgb24gYWxsIGV2ZW50cy4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuc3Vic2NyaWJlQWxsID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICByZXR1cm4gdGhpcy5zdWJNYXAuc3Vic2NyaWJlKEFMTF9FVkVOVFMsIGYpOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2Ygc3Vic2NyaXB0aW9ucyBmb3IgdGhlIGdpdmVuIGV2ZW50IG5hbWUsIG9yIGFuIGVtcHR5CiAgICogbGlzdCBpZiB0aGVyZSBhcmUgbm8gc3Vic2NyaXB0aW9ucy4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuZ2V0U3Vic2NyaXB0aW9ucyA9IGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgIHJldHVybiB0aGlzLnN1Yk1hcC5nZXRTdWJzY3JpcHRpb25zKGV2ZW50TmFtZSk7CiAgfTsKCiAgLyoqCiAgICogVHJpZ2dlciB0aGUgZ2l2ZW4gZXZlbnQgd2l0aCB0aGUgZ2l2ZW4gZGF0YS4gIEFsbCBtZXRob2RzIHN1YnNjcmliZWQKICAgKiB0byB0aGlzIGV2ZW50IHdpbGwgYmUgY2FsbGVkIGFuZCBhcmUgcHJvdmlkZWQgd2l0aCB0aGUgZ2l2ZW4gYXJiaXRyYXJ5CiAgICogZGF0YSBvYmplY3QgYW5kIHRoZSBuYW1lIG9mIHRoZSBldmVudCwgaW4gdGhhdCBvcmRlci4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUudHJpZ2dlciA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGRhdGEpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBhbGxFdmVudFN1YnMgPSB0aGlzLnN1Yk1hcC5nZXRTdWJzY3JpcHRpb25zKEFMTF9FVkVOVFMpOwogICAgdmFyIGV2ZW50U3VicyA9IHRoaXMuc3ViTWFwLmdldFN1YnNjcmlwdGlvbnMoZXZlbnROYW1lKTsKCiAgICBpZiAodGhpcy5sb2dFdmVudHMgJiYKICAgICAgICBldmVudE5hbWUgIT09IGNvbm5lY3QuRXZlbnRUeXBlLkxPRyAmJgogICAgICAgIGV2ZW50TmFtZSAhPT0gY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFU1BPTlNFICYmCiAgICAgICAgZXZlbnROYW1lICE9PSBjb25uZWN0LkV2ZW50VHlwZS5BUElfTUVUUklDICYmCiAgICAgICAgZXZlbnROYW1lICE9PSBjb25uZWN0LkV2ZW50VHlwZS5TRVJWRVJfQk9VTkRfSU5URVJOQUxfTE9HCiAgICApIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiUHVibGlzaGluZyBldmVudDogJXMiLCBldmVudE5hbWUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CgogICAgaWYgKAogICAgICBldmVudE5hbWUuc3RhcnRzV2l0aChjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQpICYmCiAgICAgIGRhdGEgJiYKICAgICAgZGF0YS5jb250YWN0SWQgJiYKICAgICAgIShkYXRhIGluc3RhbmNlb2YgY29ubmVjdC5Db250YWN0KQogICAgKSB7CiAgICAgIGRhdGEgPSBuZXcgY29ubmVjdC5Db250YWN0KGRhdGEuY29udGFjdElkKTsKICAgIH0KCiAgICBpZiAoZXZlbnROYW1lLnN0YXJ0c1dpdGgoY29ubmVjdC5Db250YWN0RXZlbnRzLkFDQ0VQVEVEKSAmJiBkYXRhICYmIGRhdGEuY29udGFjdElkICYmICEoZGF0YSBpbnN0YW5jZW9mIGNvbm5lY3QuQ29udGFjdCkpIHsKICAgICAgZGF0YSA9IG5ldyBjb25uZWN0LkNvbnRhY3QoZGF0YS5jb250YWN0SWQpOwogICAgfQogICAgYWxsRXZlbnRTdWJzLmNvbmNhdChldmVudFN1YnMpLmZvckVhY2goZnVuY3Rpb24gKHN1YikgewogICAgICB0cnkgewogICAgICAgIHN1Yi5mKGRhdGEgfHwgbnVsbCwgZXZlbnROYW1lLCBzZWxmKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIiclcycgZXZlbnQgaGFuZGxlciBmYWlsZWQuIiwgZXZlbnROYW1lKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIC8qKgogICAqIFJldHVybnMgYSBjbG9zdXJlIHdoaWNoIGJyaWRnZXMgYW4gZXZlbnQgZnJvbSBhbm90aGVyIEV2ZW50QnVzIHRvIHRoaXMgYnVzLgogICAqCiAgICogVXNhZ2U6CiAgICogY29uZHVpdC5vblVwc3RyZWFtKCJNeUV2ZW50IiwgYnVzLmJyaWRnZSgpKTsKICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuYnJpZGdlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgcmV0dXJuIGZ1bmN0aW9uIChkYXRhLCBldmVudCkgewogICAgICBzZWxmLnRyaWdnZXIoZXZlbnQsIGRhdGEpOwogICAgfTsKICB9OwoKICAvKioKICAgKiBVbnN1YnNjcmliZSBhbGwgZXZlbnRzIGluIHRoZSBldmVudCBidXMuCiAgICovCiAgRXZlbnRCdXMucHJvdG90eXBlLnVuc3Vic2NyaWJlQWxsID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5zdWJNYXAuZ2V0QWxsU3Vic2NyaXB0aW9ucygpLmZvckVhY2goZnVuY3Rpb24gKHN1YikgewogICAgICBzdWIudW5zdWJzY3JpYmUoKTsKICAgIH0pOwogIH07CgogIGNvbm5lY3QuRXZlbnRCdXMgPSBFdmVudEJ1czsKICBjb25uZWN0LkV2ZW50RmFjdG9yeSA9IEV2ZW50RmFjdG9yeTsKICBjb25uZWN0LkV2ZW50VHlwZSA9IEV2ZW50VHlwZTsKICBjb25uZWN0LkFnZW50RXZlbnRzID0gQWdlbnRFdmVudHM7CiAgY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzID0gQ29uZmlndXJhdGlvbkV2ZW50czsKICBjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMgPSBDb25uZWN0aW9uRXZlbnRzOwogIGNvbm5lY3QuQ29ubm5lY3Rpb25FdmVudHMgPSBDb25uZWN0aW9uRXZlbnRzOyAvL2RlcHJlY2F0ZSBvbiBuZXh0IG1ham9yIHZlcnNpb24gcmVsZWFzZS4KICBjb25uZWN0LkNvbnRhY3RFdmVudHMgPSBDb250YWN0RXZlbnRzOwogIGNvbm5lY3QuVGFza0xpc3RFdmVudHMgPSBUYXNrTGlzdEV2ZW50czsKICBjb25uZWN0LldlYlNvY2tldEV2ZW50cyA9IFdlYlNvY2tldEV2ZW50czsKICBjb25uZWN0Lk1hc3RlclRvcGljcyA9IE1hc3RlclRvcGljczsKICBjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMgPSBEaXNhc3RlclJlY292ZXJ5RXZlbnRzOwp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uKCkgewogICB2YXIgZ2xvYmFsID0gdGhpczsKICAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBTdHJlYW0KICAgICoKICAgICogUmVwcmVzZW50cyBhbiBvYmplY3QgZnJvbSB3aGljaCBtZXNzYWdlcyBjYW4gYmUgcmVhZCBhbmQgdG8gd2hpY2gKICAgICogbWVzc2FnZXMgY2FuIGJlIHNlbnQuCiAgICAqLwogICB2YXIgU3RyZWFtID0gZnVuY3Rpb24oKSB7fTsKCiAgIC8qKgogICAgKiBTZW5kIGEgbWVzc2FnZSB0byB0aGUgc3RyZWFtLiAgVGhpcyBtZXRob2QgbXVzdCBiZSBpbXBsZW1lbnRlZCBieSBzdWJjbGFzc2VzLgogICAgKi8KICAgU3RyZWFtLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7CiAgIH07CgogICAvKioKICAgICogUHJvdmlkZSBhIG1ldGhvZCB0byBiZSBjYWxsZWQgd2hlbiBtZXNzYWdlcyBhcmUgcmVjZWl2ZWQgZnJvbSB0aGlzIHN0cmVhbS4KICAgICogVGhpcyBtZXRob2QgbXVzdCBiZSBpbXBsZW1lbnRlZCBieSBzdWJjbGFzc2VzLgogICAgKi8KICAgU3RyZWFtLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IoKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBOdWxsU3RyZWFtIGV4dGVuZHMgU3RyZWFtCiAgICAqCiAgICAqIEEgbnVsbCBzdHJlYW0gd2hpY2ggcHJvdmlkZXMgbm8gbWVzc2FnZSBzZW5kaW5nIG9yIHJlY2VpdmluZyBmYWNpbGl0aWVzLgogICAgKi8KICAgdmFyIE51bGxTdHJlYW0gPSBmdW5jdGlvbigpIHsKICAgICAgU3RyZWFtLmNhbGwodGhpcyk7CiAgIH07CiAgIE51bGxTdHJlYW0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdHJlYW0ucHJvdG90eXBlKTsKICAgTnVsbFN0cmVhbS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBOdWxsU3RyZWFtOwoKICAgTnVsbFN0cmVhbS5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikge307CiAgIE51bGxTdHJlYW0ucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7fTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBXaW5kb3dTdHJlYW0gZXh0ZW5kcyBTdHJlYW0KICAgICoKICAgICogQSBzdHJlYW0gZm9yIGNvbW11bmljYXRpbmcgd2l0aCBhIHdpbmRvdyBvYmplY3QuICBUaGUgZG9tYWluIHByb3ZpZGVkCiAgICAqIG11c3QgbWF0Y2ggdGhlIGFsbG93ZWQgbWVzc2FnZSBkb21haW5zIG9mIHRoZSBkb3duc3RyZWFtIHJlY2VpdmVyCiAgICAqIG9yIG1lc3NhZ2VzIHdpbGwgYmUgcmVqZWN0ZWQsIHNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvV2luZG93L3Bvc3RNZXNzYWdlCiAgICAqIGZvciBtb3JlIGluZm8uCiAgICAqLwogICB2YXIgV2luZG93U3RyZWFtID0gZnVuY3Rpb24od2luLCBkb21haW4pIHsKICAgICAgU3RyZWFtLmNhbGwodGhpcyk7CiAgICAgIHRoaXMud2luZG93ID0gd2luOwogICAgICB0aGlzLmRvbWFpbiA9IGRvbWFpbiB8fCAnKic7CiAgIH07CiAgIFdpbmRvd1N0cmVhbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUpOwogICBXaW5kb3dTdHJlYW0ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gV2luZG93U3RyZWFtOwoKICAgV2luZG93U3RyZWFtLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aGlzLndpbmRvdy5wb3N0TWVzc2FnZShtZXNzYWdlLCB0aGlzLmRvbWFpbik7CiAgIH07CgogICBXaW5kb3dTdHJlYW0ucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgdGhpcy53aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIGYpOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFdpbmRvd0lPU3RyZWFtIGV4dGVuZHMgU3RyZWFtCiAgICAqCiAgICAqIEEgc3RyZWFtIHVzZWQgYnkgSUZyYW1lL3BvcHVwIHdpbmRvd3MgdG8gY29tbXVuaWNhdGUgd2l0aCB0aGVpciBwYXJlbnRzCiAgICAqIGFuZCB2aXNlIHZlcnNhLgogICAgKgogICAgKiBUaGlzIG9iamVjdCBlbmNhcHN1bGF0ZXMgdGhlIGZhY3QgdGhhdCBpbmNvbWluZyBhbmQgb3V0Z29pbmcgbWVzc2FnZXMKICAgICogYXJyaXZlIG9uIGRpZmZlcmVudCB3aW5kb3dzIGFuZCBhbGxvd3MgdGhpcyB0byBiZSBtYW5hZ2VkIGFzIGEgc2luZ2xlCiAgICAqIFN0cmVhbSBvYmplY3QuCiAgICAqLwogICB2YXIgV2luZG93SU9TdHJlYW0gPSBmdW5jdGlvbihpbnB1dHdpbiwgb3V0cHV0d2luLCBkb21haW4pIHsKICAgICAgU3RyZWFtLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuaW5wdXQgPSBpbnB1dHdpbjsKICAgICAgdGhpcy5vdXRwdXQgPSBvdXRwdXR3aW47CiAgICAgIHRoaXMuZG9tYWluID0gZG9tYWluIHx8ICcqJzsKICAgfTsKICAgV2luZG93SU9TdHJlYW0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdHJlYW0ucHJvdG90eXBlKTsKICAgV2luZG93SU9TdHJlYW0ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gV2luZG93SU9TdHJlYW07CgogICBXaW5kb3dJT1N0cmVhbS5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgdGhpcy5vdXRwdXQucG9zdE1lc3NhZ2UobWVzc2FnZSwgdGhpcy5kb21haW4pOwogICB9OwoKICAgV2luZG93SU9TdHJlYW0ucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgdGhpcy5pbnB1dC5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgZik7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgUG9ydFN0cmVhbSBleHRlbmRzIFN0cmVhbQogICAgKgogICAgKiBBIHN0cmVhbSB3cmFwcGluZyBhbiBIVE1MNSBXb3JrZXIgcG9ydC4gIFRoaXMgY291bGQgYmUgdGhlIHBvcnQKICAgICogdXNlZCB0byBjb25uZWN0IHRvIGEgV29ya2VyIG9yIG9uZSBvZiB0aGUgbXVsdGl0dWRlIG9mIHBvcnRzCiAgICAqIG1hZGUgYXZhaWxhYmxlIHRvIGEgU2hhcmVkV29ya2VyIGZvciBjb21tdW5pY2F0aW9uIGJhY2sgdG8KICAgICogaXRzIGNvbm5lY3RlZCBjbGllbnRzLgogICAgKi8KICAgdmFyIFBvcnRTdHJlYW0gPSBmdW5jdGlvbihwb3J0KSB7CiAgICAgIFN0cmVhbS5jYWxsKHRoaXMpOwogICAgICB0aGlzLnBvcnQgPSBwb3J0OwogICAgICB0aGlzLmlkID0gY29ubmVjdC5yYW5kb21JZCgpOwogICB9OwogICBQb3J0U3RyZWFtLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoU3RyZWFtLnByb3RvdHlwZSk7CiAgIFBvcnRTdHJlYW0ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUG9ydFN0cmVhbTsKCiAgIFBvcnRTdHJlYW0ucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgIHRoaXMucG9ydC5wb3N0TWVzc2FnZShtZXNzYWdlKTsKICAgfTsKCiAgIFBvcnRTdHJlYW0ucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgdGhpcy5wb3J0LmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBmKTsKICAgfTsKCiAgIFBvcnRTdHJlYW0ucHJvdG90eXBlLmdldElkID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmlkOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFN0cmVhbU11bHRpcGxleGVyIGV4dGVuZHMgU3RyZWFtCiAgICAqCiAgICAqIEEgd3JhcHBlciBmb3IgbXVsdGlwbGV4ZWQgZG93bnN0cmVhbSBjb21tdW5pY2F0aW9uIHdpdGgKICAgICogbXVsdGlwbGUgc3RyZWFtcyBhdCBvbmNlLiAgTWFpbmx5IHVzZWZ1bCBmb3IgdGhlIFNoYXJlZFdvcmtlciB0bwogICAgKiBicm9hZGNhc3QgZXZlbnRzIHRvIG1hbnkgUG9ydFN0cmVhbSBvYmplY3RzIGF0IG9uY2UuCiAgICAqLwogICB2YXIgU3RyZWFtTXVsdGlwbGV4ZXIgPSBmdW5jdGlvbihzdHJlYW1zKSB7CiAgICAgIFN0cmVhbS5jYWxsKHRoaXMpOwogICAgICB0aGlzLnN0cmVhbU1hcCA9IHN0cmVhbXMgPwogICAgICAgICBjb25uZWN0LmluZGV4KHN0cmVhbXMsIGZ1bmN0aW9uKHMpIHsgcmV0dXJuIHMuZ2V0SWQoKTsgfSkgOiB7fTsKICAgICAgdGhpcy5tZXNzYWdlTGlzdGVuZXJzID0gW107CiAgIH07CiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoU3RyZWFtLnByb3RvdHlwZSk7CiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFN0cmVhbU11bHRpcGxleGVyOwoKICAgLyoqCiAgICAqIFNlbmQgYSBtZXNzYWdlIHRvIGFsbCBwb3J0cyBpbiB0aGUgbXVsdGlwbGV4ZXIuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgdGhpcy5nZXRTdHJlYW1zKCkuZm9yRWFjaChmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc3RyZWFtLnNlbmQobWVzc2FnZSk7CgogICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIC8vIENvdWxkbid0IHNlbmQgbWVzc2FnZSB0byBvbmUgb2YgdGhlIGRvd25zdHJlYW1zIGZvciBzb21lIHJlYXNvbi4uLgogICAgICAgICAgICAvLyBObyByZWxpYWJsZSBsb2dnaW5nIHBvc3NpYmxlIHdpdGhvdXQgZnVydGhlciBmYWlsdXJlcywKICAgICAgICAgICAgLy8gbm8gcmVjb3ZlcnksIGp1c3QgZWF0IGl0LgogICAgICAgICB9CiAgICAgIH0pOwogICB9OwoKICAgLyoqCiAgICAqIFJlZ2lzdGVyIGEgbWV0aG9kIHdoaWNoIHdpbGwgYmUgY2FsbGVkIHdoZW4gYSBtZXNzYWdlIGlzIHJlY2VpdmVkIGZyb20KICAgICogYW55IG9mIHRoZSBkb3duc3RyZWFtcy4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7CiAgICAgIHRoaXMubWVzc2FnZUxpc3RlbmVycy5wdXNoKGYpOwoKICAgICAgLy8gVXBkYXRlIGV4aXN0aW5nIHN0cmVhbXMgd2l0aCB0aGUgbmV3IGxpc3RlbmVyLgogICAgICB0aGlzLmdldFN0cmVhbXMoKS5mb3JFYWNoKGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICBzdHJlYW0ub25NZXNzYWdlKGYpOwogICAgICB9KTsKICAgfTsKCiAgIC8qKgogICAgKiBBZGQgYSBzdHJlYW0gdG8gdGhlIG11bHRpcGxleGVyLgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLmFkZFN0cmVhbSA9IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHRoaXMuc3RyZWFtTWFwW3N0cmVhbS5nZXRJZCgpXSA9IHN0cmVhbTsKCiAgICAgIC8vIFVwZGF0ZSBzdHJlYW0gd2l0aCBleGlzdGluZyBsaXN0ZW5lcnMuCiAgICAgIHRoaXMubWVzc2FnZUxpc3RlbmVycy5mb3JFYWNoKGZ1bmN0aW9uKG1lc3NhZ2VMaXN0ZW5lcikgewogICAgICAgICBzdHJlYW0ub25NZXNzYWdlKG1lc3NhZ2VMaXN0ZW5lcik7CiAgICAgIH0pOwogICB9OwoKICAgLyoqCiAgICAqIFJlbW92ZSB0aGUgZ2l2ZW4gZG93bnN0cmVhbS4gIFRoaXMgaXMgdHlwaWNhbGx5IHVzZWQgaW4gcmVzcG9uc2UKICAgICogdG8gdGhlIFNoYXJlZFdvcmtlcidzIG9uY2xvc2UgZXZlbnQsIGluZGljYXRpbmcgdGhhdCBhIGNvbnN1bWVyCiAgICAqIHRhYiBoYXMgYmVlbiBjbG9zZWQuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUucmVtb3ZlU3RyZWFtID0gZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgIGRlbGV0ZSB0aGlzLnN0cmVhbU1hcFtzdHJlYW0uZ2V0SWQoKV07CiAgIH07CgogICAvKioKICAgICogR2V0IGEgbGlzdCBvZiBzdHJlYW1zIGluIHRoZSBtdWx0aXBsZXhlci4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5nZXRTdHJlYW1zID0gZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgIHJldHVybiBjb25uZWN0LnZhbHVlcyh0aGlzLnN0cmVhbU1hcCk7CiAgIH07CgogICAvKioKICAgICogR2V0IHRoZSBzdHJlYW0gbWF0Y2hpbmcgdGhlIGdpdmVuIHBvcnQuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUuZ2V0U3RyZWFtRm9yUG9ydCA9IGZ1bmN0aW9uKHBvcnQpIHsKICAgICAgcmV0dXJuIGNvbm5lY3QuZmluZCh0aGlzLmdldFN0cmVhbXMoKSwgZnVuY3Rpb24ocykgewogICAgICAgICByZXR1cm4gcy5wb3J0ID09PSBwb3J0OwogICAgICB9KTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBDb25kdWl0CiAgICAqCiAgICAqIEFuIG9iamVjdCB3aGljaCBicmlkZ2VzIGFuIHVwc3RyZWFtIGFuZCBhIGRvd25zdHJlYW0sIGFsbG93aW5nIG1lc3NhZ2VzCiAgICAqIHRvIGJlIHBhc3NlZCB0byBhbmQgZnJvbSBlYWNoIGFuZCBwcm92aWRpbmcgYW4gZXZlbnQgYnVzIGZvciBldmVudAogICAgKiBzdWJzY3JpcHRpb25zIHRvIGJlIG1hZGUgdXBzdHJlYW0gYW5kIGRvd25zdHJlYW0uCiAgICAqLwogICB2YXIgQ29uZHVpdCA9IGZ1bmN0aW9uKG5hbWUsIHVwc3RyZWFtLCBkb3duc3RyZWFtKSB7CiAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgIHRoaXMudXBzdHJlYW0gPSB1cHN0cmVhbSB8fCBuZXcgTnVsbFN0cmVhbSgpOwogICAgICB0aGlzLmRvd25zdHJlYW0gPSBkb3duc3RyZWFtIHx8IG5ldyBOdWxsU3RyZWFtKCk7CiAgICAgIHRoaXMuZG93bnN0cmVhbUJ1cyA9IG5ldyBjb25uZWN0LkV2ZW50QnVzKCk7CiAgICAgIHRoaXMudXBzdHJlYW1CdXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cygpOwoKICAgICAgdGhpcy51cHN0cmVhbS5vbk1lc3NhZ2UoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLl9kaXNwYXRjaEV2ZW50LCB0aGlzLnVwc3RyZWFtQnVzKSk7CiAgICAgIHRoaXMuZG93bnN0cmVhbS5vbk1lc3NhZ2UoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLl9kaXNwYXRjaEV2ZW50LCB0aGlzLmRvd25zdHJlYW1CdXMpKTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLm9uVXBzdHJlYW0gPSBmdW5jdGlvbihldmVudE5hbWUsIGYpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZiwgJ2YnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIHJldHVybiB0aGlzLnVwc3RyZWFtQnVzLnN1YnNjcmliZShldmVudE5hbWUsIGYpOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUub25BbGxVcHN0cmVhbSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICByZXR1cm4gdGhpcy51cHN0cmVhbUJ1cy5zdWJzY3JpYmVBbGwoZik7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5vbkRvd25zdHJlYW0gPSBmdW5jdGlvbihldmVudE5hbWUsIGYpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZiwgJ2YnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIHJldHVybiB0aGlzLmRvd25zdHJlYW1CdXMuc3Vic2NyaWJlKGV2ZW50TmFtZSwgZik7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5vbkFsbERvd25zdHJlYW0gPSBmdW5jdGlvbihmKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgcmV0dXJuIHRoaXMuZG93bnN0cmVhbUJ1cy5zdWJzY3JpYmVBbGwoZik7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5zZW5kVXBzdHJlYW0gPSBmdW5jdGlvbihldmVudE5hbWUsIGRhdGEpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgICB0aGlzLnVwc3RyZWFtLnNlbmQoe2V2ZW50OiBldmVudE5hbWUsIGRhdGE6IGRhdGF9KTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLnNlbmREb3duc3RyZWFtID0gZnVuY3Rpb24oZXZlbnROYW1lLCBkYXRhKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgICAgdGhpcy5kb3duc3RyZWFtLnNlbmQoe2V2ZW50OiBldmVudE5hbWUsIGRhdGE6IGRhdGF9KTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLl9kaXNwYXRjaEV2ZW50ID0gZnVuY3Rpb24oYnVzLCBtZXNzYWdlRXZlbnQpIHsKICAgICAgdmFyIG1lc3NhZ2UgPSBtZXNzYWdlRXZlbnQuZGF0YTsKICAgICAgaWYgKG1lc3NhZ2UuZXZlbnQpIHsKICAgICAgICAgYnVzLnRyaWdnZXIobWVzc2FnZS5ldmVudCwgbWVzc2FnZS5kYXRhKTsKICAgICAgfQogICB9OwoKICAgLyoqCiAgICAqIFJldHVybnMgYSBjbG9zdXJlIHdoaWNoIHBhc3NlcyBldmVudHMgdXBzdHJlYW0uCiAgICAqCiAgICAqIFVzYWdlOgogICAgKiBjb25kdWl0Lm9uRG93bnN0cmVhbSgiTXlFdmVudCIsIGNvbmR1aXQucGFzc1Vwc3RyZWFtKCkpOwogICAgKi8KICAgQ29uZHVpdC5wcm90b3R5cGUucGFzc1Vwc3RyZWFtID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGRhdGEsIGV2ZW50TmFtZSkgewogICAgICAgICBzZWxmLnVwc3RyZWFtLnNlbmQoe2V2ZW50OiBldmVudE5hbWUsIGRhdGE6IGRhdGF9KTsKICAgICAgfTsKICAgfTsKCiAgIC8qKgogICAgKiBSZXR1cm5zIGEgY2xvc3VyZSB3aGljaCBwYXNzZXMgZXZlbnRzIGRvd25zdHJlYW0uCiAgICAqCiAgICAqIFVzYWdlOgogICAgKiBjb25kdWl0Lm9uVXBzdHJlYW0oIk15RXZlbnQiLCBjb25kdWl0LnBhc3NEb3duc3RyZWFtKCkpOwogICAgKi8KICAgQ29uZHVpdC5wcm90b3R5cGUucGFzc0Rvd25zdHJlYW0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICByZXR1cm4gZnVuY3Rpb24oZGF0YSwgZXZlbnROYW1lKSB7CiAgICAgICAgIHNlbGYuZG93bnN0cmVhbS5zZW5kKHtldmVudDogZXZlbnROYW1lLCBkYXRhOiBkYXRhfSk7CiAgICAgIH07CiAgIH07CgogICAvKioKICAgICogU2h1dGRvd24gdGhlIGNvbmR1aXQncyBldmVudCBidXNzZXMgYW5kIHJlbW92ZSBhbGwgc3Vic2NyaXB0aW9ucy4KICAgICovCiAgIENvbmR1aXQucHJvdG90eXBlLnNodXRkb3duID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMudXBzdHJlYW1CdXMudW5zdWJzY3JpYmVBbGwoKTsKICAgICAgdGhpcy5kb3duc3RyZWFtQnVzLnVuc3Vic2NyaWJlQWxsKCk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgSUZyYW1lQ29uZHVpdCBleHRlbmRzIENvbmR1aXQKICAgICoKICAgICogQ3JlYXRlcyBhIGNvbmR1aXQgZm9yIHRoZSBnaXZlbiBJRnJhbWUgZWxlbWVudC4KICAgICovCiAgIHZhciBJRnJhbWVDb25kdWl0ID0gZnVuY3Rpb24obmFtZSwgd2luZG93LCBpZnJhbWUsIGRvbWFpbikgewogICAgICBDb25kdWl0LmNhbGwodGhpcywgbmFtZSwgbmV3IFdpbmRvd0lPU3RyZWFtKHdpbmRvdywgaWZyYW1lLmNvbnRlbnRXaW5kb3csIGRvbWFpbiB8fCAnKicpLCBudWxsKTsKICAgfTsKICAgSUZyYW1lQ29uZHVpdC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbmR1aXQucHJvdG90eXBlKTsKICAgSUZyYW1lQ29uZHVpdC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBJRnJhbWVDb25kdWl0OwoKICAgY29ubmVjdC5TdHJlYW0gPSBTdHJlYW07CiAgIGNvbm5lY3QuTnVsbFN0cmVhbSA9IE51bGxTdHJlYW07CiAgIGNvbm5lY3QuV2luZG93U3RyZWFtID0gV2luZG93U3RyZWFtOwogICBjb25uZWN0LldpbmRvd0lPU3RyZWFtID0gV2luZG93SU9TdHJlYW07CiAgIGNvbm5lY3QuUG9ydFN0cmVhbSA9IFBvcnRTdHJlYW07CiAgIGNvbm5lY3QuU3RyZWFtTXVsdGlwbGV4ZXIgPSBTdHJlYW1NdWx0aXBsZXhlcjsKICAgY29ubmVjdC5Db25kdWl0ID0gQ29uZHVpdDsKICAgY29ubmVjdC5JRnJhbWVDb25kdWl0ID0gSUZyYW1lQ29uZHVpdDsKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbigpIHsKICAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogZW51bSBDbGllbnRNZXRob2RzCiAgICAqLwogICBjb25uZWN0LkNsaWVudE1ldGhvZHMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICAgICAgJ2dldEFnZW50U25hcHNob3QnLAogICAgICAgICAncHV0QWdlbnRTdGF0ZScsCiAgICAgICAgICdnZXRBZ2VudFN0YXRlcycsCiAgICAgICAgICdnZXREaWFsYWJsZUNvdW50cnlDb2RlcycsCiAgICAgICAgICdnZXRSb3V0aW5nUHJvZmlsZVF1ZXVlcycsCiAgICAgICAgICdnZXRBZ2VudFBlcm1pc3Npb25zJywKICAgICAgICAgJ2dldEFnZW50Q29uZmlndXJhdGlvbicsCiAgICAgICAgICd1cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24nLAogICAgICAgICAnYWNjZXB0Q29udGFjdCcsCiAgICAgICAgICdjcmVhdGVPdXRib3VuZENvbnRhY3QnLAogICAgICAgICAnY3JlYXRlVGFza0NvbnRhY3QnLAogICAgICAgICAnY2xlYXJDb250YWN0JywKICAgICAgICAgJ2NvbXBsZXRlQ29udGFjdCcsCiAgICAgICAgICdkZXN0cm95Q29udGFjdCcsCiAgICAgICAgICdyZWplY3RDb250YWN0JywKICAgICAgICAgJ25vdGlmeUNvbnRhY3RJc3N1ZScsCiAgICAgICAgICd1cGRhdGVDb250YWN0QXR0cmlidXRlcycsCiAgICAgICAgICdjcmVhdGVBZGRpdGlvbmFsQ29ubmVjdGlvbicsCiAgICAgICAgICdkZXN0cm95Q29ubmVjdGlvbicsCiAgICAgICAgICdob2xkQ29ubmVjdGlvbicsCiAgICAgICAgICdyZXN1bWVDb25uZWN0aW9uJywKICAgICAgICAgJ3RvZ2dsZUFjdGl2ZUNvbm5lY3Rpb25zJywKICAgICAgICAgJ2NvbmZlcmVuY2VDb25uZWN0aW9ucycsCiAgICAgICAgICdzZW5kQ2xpZW50TG9ncycsCiAgICAgICAgICdzZW5kRGlnaXRzJywKICAgICAgICAgJ3NlbmRTb2Z0cGhvbmVDYWxsUmVwb3J0JywKICAgICAgICAgJ3NlbmRTb2Z0cGhvbmVDYWxsTWV0cmljcycsCiAgICAgICAgICdnZXRFbmRwb2ludHMnLAogICAgICAgICAnZ2V0TmV3QXV0aFRva2VuJywKICAgICAgICAgJ2NyZWF0ZVRyYW5zcG9ydCcKICAgXSk7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogZW51bSBBZ2VudEFwcENsaWVudE1ldGhvZHMKICAgICovCiAgIGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzID0gewogICAgICBHRVRfU1BFQUtFUl9JRDogIkFnZW50QXBwU2VydmljZS5MY21zLmdldENvbnRhY3QiLAogICAgICBERUxFVEVfVk9JQ0VJRF9TUEVBS0VSOiAiQWdlbnRBcHBTZXJ2aWNlLlZvaWNlSWQuZGVsZXRlU3BlYWtlciIsCiAgICAgIEVOUk9MTF9TUEVBS0VSX0lOX1ZPSUNFSUQ6ICJBZ2VudEFwcFNlcnZpY2UuVm9pY2VJZC5lbnJvbGxCeVNlc3Npb24iLAogICAgICBFVkFMVUFURV9TUEVBS0VSX1dJVEhfVk9JQ0VJRDogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLmV2YWx1YXRlU2Vzc2lvbiIsCiAgICAgIEdFVF9TUEVBS0VSX1NUQVRVUzogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLmRlc2NyaWJlU3BlYWtlciIsCiAgICAgIE9QVF9PVVRfVk9JQ0VJRF9TUEVBS0VSOiAiQWdlbnRBcHBTZXJ2aWNlLlZvaWNlSWQub3B0T3V0U3BlYWtlciIsCiAgICAgIERFU0NSSUJFX1ZPSUNFSURfU0VTU0lPTjogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLmRlc2NyaWJlU2Vzc2lvbiIsCiAgICAgIFVQREFURV9WT0lDRUlEX1NFU1NJT046ICJBZ2VudEFwcFNlcnZpY2UuVm9pY2VJZC51cGRhdGVTZXNzaW9uIiwKICAgICAgU1RBUlRfVk9JQ0VJRF9TRVNTSU9OOiAiQWdlbnRBcHBTZXJ2aWNlLk5hc2Euc3RhcnRWb2ljZUlkU2Vzc2lvbiIsCiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogZW51bSBNYXN0ZXJNZXRob2RzCiAgICAqLwogICBjb25uZWN0Lk1hc3Rlck1ldGhvZHMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICAgICAgJ2JlY29tZU1hc3RlcicsCiAgICAgICAgICdjaGVja01hc3RlcicKICAgXSk7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogYWJzdHJhY3QgY2xhc3MgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIENsaWVudEJhc2UgPSBmdW5jdGlvbigpIHt9OwogICBDbGllbnRCYXNlLkVNUFRZX0NBTExCQUNLUyA9IHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24oKSB7IH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uKCkgeyB9CiAgIH07CgogICBDbGllbnRCYXNlLnByb3RvdHlwZS5jYWxsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXNJbiwgY2FsbGJhY2tzSW4pIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKG1ldGhvZCwgJ21ldGhvZCcpOwogICAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICAgIHZhciBjYWxsYmFja3MgPSBjYWxsYmFja3NJbiB8fCBDbGllbnRCYXNlLkVNUFRZX0NBTExCQUNLUzsKICAgICAgdGhpcy5fY2FsbEltcGwobWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcyk7CiAgIH07CgogICBDbGllbnRCYXNlLnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IoKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBOdWxsQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIE51bGxDbGllbnQgPSBmdW5jdGlvbigpIHsKICAgICAgQ2xpZW50QmFzZS5jYWxsKHRoaXMpOwogICB9OwogICBOdWxsQ2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ2xpZW50QmFzZS5wcm90b3R5cGUpOwogICBOdWxsQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IE51bGxDbGllbnQ7CgogICBOdWxsQ2xpZW50LnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CiAgICAgIGlmIChjYWxsYmFja3MgJiYgY2FsbGJhY2tzLmZhaWx1cmUpIHsKICAgICAgICAgdmFyIG1lc3NhZ2UgPSBjb25uZWN0LnNwcmludGYoJ05vIHN1Y2ggbWV0aG9kIGV4aXN0cyBvbiBOVUxMIGNsaWVudDogJXMnLCBtZXRob2QpOwogICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShuZXcgY29ubmVjdC5WYWx1ZUVycm9yKG1lc3NhZ2UpLCB7bWVzc2FnZTogbWVzc2FnZX0pOwogICAgICB9CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogYWJzdHJhY3QgY2xhc3MgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZSBleHRlbmRzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlID0gZnVuY3Rpb24oY29uZHVpdCwgcmVxdWVzdEV2ZW50LCByZXNwb25zZUV2ZW50KSB7CiAgICAgIENsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5jb25kdWl0ID0gY29uZHVpdDsKICAgICAgdGhpcy5yZXF1ZXN0RXZlbnQgPSByZXF1ZXN0RXZlbnQ7CiAgICAgIHRoaXMucmVzcG9uc2VFdmVudCA9IHJlc3BvbnNlRXZlbnQ7CiAgICAgIHRoaXMuX3JlcXVlc3RJZENhbGxiYWNrc01hcCA9IHt9OwoKICAgICAgdGhpcy5jb25kdWl0Lm9uVXBzdHJlYW0ocmVzcG9uc2VFdmVudCwgY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLl9oYW5kbGVSZXNwb25zZSkpOwogICB9OwoKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlOwoKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgICB2YXIgcmVxdWVzdCA9IGNvbm5lY3QuRXZlbnRGYWN0b3J5LmNyZWF0ZVJlcXVlc3QodGhpcy5yZXF1ZXN0RXZlbnQsIG1ldGhvZCwgcGFyYW1zKTsKICAgICAgdGhpcy5fcmVxdWVzdElkQ2FsbGJhY2tzTWFwW3JlcXVlc3QucmVxdWVzdElkXSA9IGNhbGxiYWNrczsKICAgICAgdGhpcy5jb25kdWl0LnNlbmRVcHN0cmVhbShyZXF1ZXN0LmV2ZW50LCByZXF1ZXN0KTsKICAgfTsKCiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlLl9nZXRDYWxsYmFja3NGb3JSZXF1ZXN0ID0gZnVuY3Rpb24ocmVxdWVzdElkKSB7CiAgICAgIHZhciBjYWxsYmFja3MgPSB0aGlzLl9yZXF1ZXN0SWRDYWxsYmFja3NNYXBbcmVxdWVzdElkXSB8fCBudWxsOwoKICAgICAgaWYgKGNhbGxiYWNrcyAhPSBudWxsKSB7CiAgICAgICAgIGRlbGV0ZSB0aGlzLl9yZXF1ZXN0SWRDYWxsYmFja3NNYXBbcmVxdWVzdElkXTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNhbGxiYWNrczsKICAgfTsKCiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlLl9oYW5kbGVSZXNwb25zZSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgdmFyIGNhbGxiYWNrcyA9IHRoaXMuX2dldENhbGxiYWNrc0ZvclJlcXVlc3QoZGF0YS5yZXF1ZXN0SWQpOwogICAgICBpZiAoY2FsbGJhY2tzID09IG51bGwpIHsKICAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoZGF0YS5lcnIgJiYgY2FsbGJhY2tzLmZhaWx1cmUpIHsKICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZGF0YS5lcnIsIGRhdGEuZGF0YSk7CgogICAgICB9IGVsc2UgaWYgKGNhbGxiYWNrcy5zdWNjZXNzKSB7CiAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEuZGF0YSk7CiAgICAgIH0KICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBVcHN0cmVhbUNvbmR1aXRDbGllbnQgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICAqLwogICB2YXIgVXBzdHJlYW1Db25kdWl0Q2xpZW50ID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLmNhbGwodGhpcywgY29uZHVpdCwgY29ubmVjdC5FdmVudFR5cGUuQVBJX1JFUVVFU1QsIGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9SRVNQT05TRSk7CiAgIH07CiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFVwc3RyZWFtQ29uZHVpdENsaWVudDsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBVcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICAqLwogICB2YXIgVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50ID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLmNhbGwodGhpcywgY29uZHVpdCwgY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFUVVFU1QsIGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVNQT05TRSk7CiAgIH07CiAgIFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudDsKICAgCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIEFnZW50QXBwQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAqLwogICB2YXIgQWdlbnRBcHBDbGllbnQgPSBmdW5jdGlvbihhdXRoQ29va2llTmFtZSwgYXV0aFRva2VuLCBlbmRwb2ludCkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoYXV0aENvb2tpZU5hbWUsICdhdXRoQ29va2llTmFtZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoYXV0aFRva2VuLCAnYXV0aFRva2VuJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChlbmRwb2ludCwgJ2VuZHBvaW50Jyk7CiAgICAgIENsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5lbmRwb2ludFVybCA9IGNvbm5lY3QuZ2V0VXJsV2l0aFByb3RvY29sKGVuZHBvaW50KTsKICAgICAgdGhpcy5hdXRoVG9rZW4gPSBhdXRoVG9rZW47CiAgICAgIHRoaXMuYXV0aENvb2tpZU5hbWUgPSBhdXRoQ29va2llTmFtZQogICB9OwoKICAgQWdlbnRBcHBDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIEFnZW50QXBwQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEFnZW50QXBwQ2xpZW50OwoKICAgQWdlbnRBcHBDbGllbnQucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgYmVhciA9IHt9OwogICAgICBiZWFyW3NlbGYuYXV0aENvb2tpZU5hbWVdID0gc2VsZi5hdXRoVG9rZW47CiAgICAgIHZhciBvcHRpb25zID0gewogICAgICAgICBtZXRob2Q6ICdwb3N0JywKICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocGFyYW1zIHx8IHt9KSwKICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nLAogICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLAogICAgICAgICAgICAgICAnWC1BbXotdGFyZ2V0JzogbWV0aG9kLAogICAgICAgICAgICAgICAnWC1BbXotQmVhcmVyJzogSlNPTi5zdHJpbmdpZnkoYmVhcikKICAgICAgICAgfQogICAgICB9OwogICAgICBjb25uZWN0LmZldGNoKHNlbGYuZW5kcG9pbnRVcmwsIG9wdGlvbnMpLnRoZW4oZnVuY3Rpb24ocmVzKXsKICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MocmVzKTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgY29uc3QgcmVhZGVyID0gZXJyLmJvZHkuZ2V0UmVhZGVyKCk7CiAgICAgICAgIGxldCBib2R5ID0gJyc7CiAgICAgICAgIGNvbnN0IGRlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTsKICAgICAgICAgcmVhZGVyLnJlYWQoKS50aGVuKGZ1bmN0aW9uIHByb2Nlc3NUZXh0KHsgZG9uZSwgdmFsdWUgfSkgewogICAgICAgICAgICBpZiAoZG9uZSkgewogICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBKU09OLnBhcnNlKGJvZHkpOwogICAgICAgICAgICAgICBlcnJvci5zdGF0dXMgPSBlcnIuc3RhdHVzOwogICAgICAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvcik7CiAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBib2R5ICs9IGRlY29kZXIuZGVjb2RlKHZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIHJlYWRlci5yZWFkKCkudGhlbihwcm9jZXNzVGV4dCk7CiAgICAgICAgIH0pOwogICAgICB9KQogICB9OwogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgQVdTQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIEFXU0NsaWVudCA9IGZ1bmN0aW9uKGF1dGhUb2tlbiwgcmVnaW9uLCBlbmRwb2ludEluKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChhdXRoVG9rZW4sICdhdXRoVG9rZW4nKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJlZ2lvbiwgJ3JlZ2lvbicpOwogICAgICBDbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgICAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKHt9KTsKICAgICAgQVdTLmNvbmZpZy5yZWdpb24gPSByZWdpb247CiAgICAgIHRoaXMuYXV0aFRva2VuID0gYXV0aFRva2VuOwogICAgICB2YXIgYmFzZVVybCA9IGNvbm5lY3QuZ2V0QmFzZVVybCgpOwogICAgICB2YXIgZW5kcG9pbnRVcmwgPSBlbmRwb2ludEluIHx8ICggCiAgICAgICAgIGJhc2VVcmwuaW5jbHVkZXMoIi5hd3NhcHBzLmNvbSIpCiAgICAgICAgICAgID8gYmFzZVVybCArICcvY29ubmVjdC9hcGknCiAgICAgICAgICAgIDogYmFzZVVybCArICcvYXBpJwogICAgICApOwogICAgICB2YXIgZW5kcG9pbnQgPSBuZXcgQVdTLkVuZHBvaW50KGVuZHBvaW50VXJsKTsKICAgICAgdGhpcy5jbGllbnQgPSBuZXcgQVdTLkNvbm5lY3Qoe2VuZHBvaW50OiBlbmRwb2ludH0pOwogICB9OwogICBBV1NDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIEFXU0NsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBBV1NDbGllbnQ7CgogICBBV1NDbGllbnQucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgbG9nID0gY29ubmVjdC5nZXRMb2coKTsKCiAgICAgIGlmICghIGNvbm5lY3QuY29udGFpbnModGhpcy5jbGllbnQsIG1ldGhvZCkpIHsKICAgICAgICAgdmFyIG1lc3NhZ2UgPSBjb25uZWN0LnNwcmludGYoJ05vIHN1Y2ggbWV0aG9kIGV4aXN0cyBvbiBBV1MgY2xpZW50OiAlcycsIG1ldGhvZCk7CiAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKG5ldyBjb25uZWN0LlZhbHVlRXJyb3IobWVzc2FnZSksIHttZXNzYWdlOiBtZXNzYWdlfSk7CgogICAgICB9IGVsc2UgewogICAgICAgICBwYXJhbXMgPSB0aGlzLl90cmFuc2xhdGVQYXJhbXMobWV0aG9kLCBwYXJhbXMpOwoKICAgICAgICAgbG9nLnRyYWNlKCJBV1NDbGllbnQ6IC0tPiBDYWxsaW5nIG9wZXJhdGlvbiAnJXMnIiwgbWV0aG9kKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgICAgdGhpcy5jbGllbnRbbWV0aG9kXShwYXJhbXMpCiAgICAgICAgICAgIC5vbignYnVpbGQnLCBmdW5jdGlvbihyZXF1ZXN0KSB7CiAgICAgICAgICAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snWC1BbXotQmVhcmVyJ10gPSBzZWxmLmF1dGhUb2tlbjsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgaWYgKGVyci5jb2RlID09PSBjb25uZWN0LkNUSUV4Y2VwdGlvbnMuVU5BVVRIT1JJWkVEX0VYQ0VQVElPTikgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3MuYXV0aEZhaWx1cmUoKTsKICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjYWxsYmFja3MuYWNjZXNzRGVuaWVkICYmIChlcnIuY29kZSA9PT0gY29ubmVjdC5DVElFeGNlcHRpb25zLkFDQ0VTU19ERU5JRURfRVhDRVBUSU9OIHx8IGVyci5zdGF0dXNDb2RlID09PSA0MDMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5hY2Nlc3NEZW5pZWQoKTsKICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FuJ3QgcGFzcyBlcnIgZGlyZWN0bHkgdG8gcG9zdE1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcG9zdE1lc3NhZ2UoKSB0cmllcyB0byBjbG9uZSB0aGUgZXJyIG9iamVjdCBhbmQgZmFpbGVkLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZWZlciB0byBodHRwczovL2dpdGh1Yi5jb20vZ29hdHNsYWNrZXIvYWx0LWRldnRvb2wvaXNzdWVzLzUKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLnR5cGUgPSBlcnIuY29kZTsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IubWVzc2FnZSA9IGVyci5tZXNzYWdlOwogICAgICAgICAgICAgICAgICAgICAgICBlcnJvci5zdGFjayA9IGVyci5zdGFjayA/IGVyci5zdGFjay5zcGxpdCgnXG4nKSA6IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvciwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgIGxvZy50cmFjZSgiQVdTQ2xpZW50OiA8LS0gT3BlcmF0aW9uICclcycgZmFpbGVkOiAlcyIsIG1ldGhvZCwgSlNPTi5zdHJpbmdpZnkoZXJyKSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgIGxvZy50cmFjZSgiQVdTQ2xpZW50OiA8LS0gT3BlcmF0aW9uICclcycgc3VjY2VlZGVkLiIsIG1ldGhvZCkud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBoYW5kbGUgQVdTIEFQSSByZXF1ZXN0IGZvciBtZXRob2QgJXMiLCBtZXRob2QpCiAgICAgICAgICAgICAgICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgIH0KICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3JlcXVpcmVzQXV0aGVudGljYXRpb25QYXJhbSA9IGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgcmV0dXJuIG1ldGhvZCAhPT0gY29ubmVjdC5DbGllbnRNZXRob2RzLkNPTVBMRVRFX0NPTlRBQ1QgJiYKICAgICAgICAgbWV0aG9kICE9PSBjb25uZWN0LkNsaWVudE1ldGhvZHMuQ0xFQVJfQ09OVEFDVCAmJgogICAgICAgICBtZXRob2QgIT09IGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5SRUpFQ1RfQ09OVEFDVCAmJgogICAgICAgICBtZXRob2QgIT09IGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfVEFTS19DT05UQUNUOwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlUGFyYW1zID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMpIHsKICAgICAgc3dpdGNoIChtZXRob2QpIHsKICAgICAgICAgY2FzZSBjb25uZWN0LkNsaWVudE1ldGhvZHMuVVBEQVRFX0FHRU5UX0NPTkZJR1VSQVRJT046CiAgICAgICAgICAgIHBhcmFtcy5jb25maWd1cmF0aW9uID0gdGhpcy5fdHJhbnNsYXRlQWdlbnRDb25maWd1cmF0aW9uKHBhcmFtcy5jb25maWd1cmF0aW9uKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICBjYXNlIGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX1NPRlRQSE9ORV9DQUxMX01FVFJJQ1M6CiAgICAgICAgICAgIHBhcmFtcy5zb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzID0gdGhpcy5fdHJhbnNsYXRlU29mdHBob25lU3RyZWFtU3RhdGlzdGljcygKICAgICAgICAgICAgICAgICAgcGFyYW1zLnNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgIGNhc2UgY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfU09GVFBIT05FX0NBTExfUkVQT1JUOgogICAgICAgICAgICBwYXJhbXMucmVwb3J0ID0gdGhpcy5fdHJhbnNsYXRlU29mdHBob25lQ2FsbFJlcG9ydChwYXJhbXMucmVwb3J0KTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBicmVhazsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuX3JlcXVpcmVzQXV0aGVudGljYXRpb25QYXJhbShtZXRob2QpKSB7CiAgICAgICAgIHBhcmFtcy5hdXRoZW50aWNhdGlvbiA9IHsKICAgICAgICAgICAgYXV0aFRva2VuOiB0aGlzLmF1dGhUb2tlbgogICAgICAgICB9OwogICAgICB9CgogICAgICByZXR1cm4gcGFyYW1zOwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlQWdlbnRDb25maWd1cmF0aW9uID0gZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgIG5hbWU6IGNvbmZpZy5uYW1lLAogICAgICAgICBzb2Z0cGhvbmVFbmFibGVkOiBjb25maWcuc29mdHBob25lRW5hYmxlZCwKICAgICAgICAgc29mdHBob25lQXV0b0FjY2VwdDogY29uZmlnLnNvZnRwaG9uZUF1dG9BY2NlcHQsCiAgICAgICAgIGV4dGVuc2lvbjogY29uZmlnLmV4dGVuc2lvbiwKICAgICAgICAgcm91dGluZ1Byb2ZpbGU6IHRoaXMuX3RyYW5zbGF0ZVJvdXRpbmdQcm9maWxlKGNvbmZpZy5yb3V0aW5nUHJvZmlsZSksCiAgICAgICAgIGFnZW50UHJlZmVyZW5jZXM6IGNvbmZpZy5hZ2VudFByZWZlcmVuY2VzCiAgICAgIH07CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVSb3V0aW5nUHJvZmlsZSA9IGZ1bmN0aW9uKHByb2ZpbGUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAgbmFtZTogcHJvZmlsZS5uYW1lLAogICAgICAgICByb3V0aW5nUHJvZmlsZUFSTjogcHJvZmlsZS5yb3V0aW5nUHJvZmlsZUFSTiwKICAgICAgICAgZGVmYXVsdE91dGJvdW5kUXVldWU6IHRoaXMuX3RyYW5zbGF0ZVF1ZXVlKHByb2ZpbGUuZGVmYXVsdE91dGJvdW5kUXVldWUpCiAgICAgIH07CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVRdWV1ZSA9IGZ1bmN0aW9uKHF1ZXVlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgIHF1ZXVlQVJOOiAgIHF1ZXVlLnF1ZXVlQVJOLAogICAgICAgICBuYW1lOiAgICAgICBxdWV1ZS5uYW1lCiAgICAgIH07CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVTb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzID0gZnVuY3Rpb24oc3RhdHMpIHsKICAgICAgc3RhdHMuZm9yRWFjaChmdW5jdGlvbihzdGF0KSB7CiAgICAgICAgIGlmICgncGFja2V0c0NvdW50JyBpbiBzdGF0KSB7CiAgICAgICAgICAgIHN0YXQucGFja2V0Q291bnQgPSBzdGF0LnBhY2tldHNDb3VudDsKICAgICAgICAgICAgZGVsZXRlIHN0YXQucGFja2V0c0NvdW50OwogICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIHN0YXRzOwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlU29mdHBob25lQ2FsbFJlcG9ydCA9IGZ1bmN0aW9uKHJlcG9ydCkgewogICAgICBpZiAoJ2hhbmRzaGFraW5nVGltZU1pbGxpcycgaW4gcmVwb3J0KSB7CiAgICAgICAgIHJlcG9ydC5oYW5kc2hha2VUaW1lTWlsbGlzID0gcmVwb3J0LmhhbmRzaGFraW5nVGltZU1pbGxpczsKICAgICAgICAgZGVsZXRlIHJlcG9ydC5oYW5kc2hha2luZ1RpbWVNaWxsaXM7CiAgICAgIH0KCiAgICAgIGlmICgncHJlVGFsa2luZ1RpbWVNaWxsaXMnIGluIHJlcG9ydCkgewogICAgICAgICByZXBvcnQucHJlVGFsa1RpbWVNaWxsaXMgPSByZXBvcnQucHJlVGFsa2luZ1RpbWVNaWxsaXM7CiAgICAgICAgIGRlbGV0ZSByZXBvcnQucHJlVGFsa2luZ1RpbWVNaWxsaXM7CiAgICAgIH0KCiAgICAgIGlmICgnaGFuZHNoYWtpbmdGYWlsdXJlJyBpbiByZXBvcnQpIHsKICAgICAgICAgcmVwb3J0LmhhbmRzaGFrZUZhaWx1cmUgPSByZXBvcnQuaGFuZHNoYWtpbmdGYWlsdXJlOwogICAgICAgICBkZWxldGUgcmVwb3J0LmhhbmRzaGFraW5nRmFpbHVyZTsKICAgICAgfQoKICAgICAgaWYgKCd0YWxraW5nVGltZU1pbGxpcycgaW4gcmVwb3J0KSB7CiAgICAgICAgIHJlcG9ydC50YWxrVGltZU1pbGxpcyA9IHJlcG9ydC50YWxraW5nVGltZU1pbGxpczsKICAgICAgICAgZGVsZXRlIHJlcG9ydC50YWxraW5nVGltZU1pbGxpczsKICAgICAgfQoKICAgICAgcmVwb3J0LnNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MgPSB0aGlzLl90cmFuc2xhdGVTb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzKAogICAgICAgICAgICByZXBvcnQuc29mdHBob25lU3RyZWFtU3RhdGlzdGljcyk7CgogICAgICByZXR1cm4gcmVwb3J0OwogICB9OwoKICAgY29ubmVjdC5DbGllbnRCYXNlID0gQ2xpZW50QmFzZTsKICAgY29ubmVjdC5OdWxsQ2xpZW50ID0gTnVsbENsaWVudDsKICAgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRDbGllbnQgPSBVcHN0cmVhbUNvbmR1aXRDbGllbnQ7CiAgIGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50ID0gVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50OwogICBjb25uZWN0LkFXU0NsaWVudCA9IEFXU0NsaWVudDsKICAgY29ubmVjdC5BZ2VudEFwcENsaWVudCA9IEFnZW50QXBwQ2xpZW50OwoKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbigpIHsKICAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIEdyYXBoTGluayA8PGFic3RyYWN0IGNsYXNzPj4KICAgICoKICAgICogUmVwcmVzZW50cyB0aGUgYXNzb2NpYXRpb24gb2Ygb25lIG9yIG1vcmUgYXR0cmlidXRlcyB0byBhIHN0YXRlIHRyYW5zaXRpb24uCiAgICAqLwogICB2YXIgR3JhcGhMaW5rID0gZnVuY3Rpb24oZnJvbVN0YXRlLCB0b1N0YXRlKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmcm9tU3RhdGUsICdmcm9tU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvU3RhdGUsICd0b1N0YXRlJyk7CiAgICAgIHRoaXMuZnJvbVN0YXRlID0gZnJvbVN0YXRlOwogICAgICB0aGlzLnRvU3RhdGUgPSB0b1N0YXRlOwogICB9OwoKICAgR3JhcGhMaW5rLnByb3RvdHlwZS5nZXRBc3NvY2lhdGlvbnMgPSBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgIHRocm93IGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvcigpOwogICB9OwoKICAgR3JhcGhMaW5rLnByb3RvdHlwZS5nZXRGcm9tU3RhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuZnJvbVN0YXRlOwogICB9OwoKICAgR3JhcGhMaW5rLnByb3RvdHlwZS5nZXRUb1N0YXRlID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnRvU3RhdGU7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIERpcmVjdEdyYXBoTGluayA8PGNvbmNyZXRlIGNsYXNzPj4gZXh0ZW5kcyBHcmFwaExpbmsKICAgICoKICAgICogUmVwcmVzZW50cyB0aGUgYnktdmFsdWUgcmVwcmVzZW50YXRpb24gb2Ygb25lIG9yIG1vcmUgYXR0cmlidXRlcyB0byBhCiAgICAqIHN0YXRlIHRyYW5zaXRpb24uCiAgICAqLwogICB2YXIgRGlyZWN0R3JhcGhMaW5rID0gZnVuY3Rpb24oZnJvbVN0YXRlLCB0b1N0YXRlLCBhc3NvY2lhdGlvbnMpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGZyb21TdGF0ZSwgJ2Zyb21TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9TdGF0ZSwgJ3RvU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGFzc29jaWF0aW9ucywgJ2Fzc29jaWF0aW9ucycpOwogICAgICBHcmFwaExpbmsuY2FsbCh0aGlzLCBmcm9tU3RhdGUsIHRvU3RhdGUpOwogICAgICB0aGlzLmFzc29jaWF0aW9ucyA9IGFzc29jaWF0aW9uczsKICAgfTsKICAgRGlyZWN0R3JhcGhMaW5rLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoR3JhcGhMaW5rLnByb3RvdHlwZSk7CiAgIERpcmVjdEdyYXBoTGluay5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBEaXJlY3RHcmFwaExpbms7CgogICBEaXJlY3RHcmFwaExpbmsucHJvdG90eXBlLmdldEFzc29jaWF0aW9ucyA9IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgcmV0dXJuIHRoaXMuYXNzb2NpYXRpb25zOwogICB9OwoKICAgLyoqCiAgICAqIEZ1bmN0aW9uYWxHcmFwaExpbmsgPDxjb25jcmV0ZSBjbGFzcz4+IGV4dGVuZHMgR3JhcGhMaW5rCiAgICAqCiAgICAqIFJlcHJlc2VudHMgYSBmdW5jdGlvbmFsIGFzc29jaWF0aW9uIG9mIG9uZSBvciBtb3JlIGF0dHJpYnV0ZXMgdG8gYQogICAgKiBzdGF0ZSB0cmFuc2l0aW9uLgogICAgKi8KICAgdmFyIEZ1bmN0aW9uYWxHcmFwaExpbmsgPSBmdW5jdGlvbihmcm9tU3RhdGUsIHRvU3RhdGUsIGNsb3N1cmUpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGZyb21TdGF0ZSwgJ2Zyb21TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9TdGF0ZSwgJ3RvU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNsb3N1cmUsICdjbG9zdXJlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2xvc3VyZSksICdjbG9zdXJlIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBHcmFwaExpbmsuY2FsbCh0aGlzLCBmcm9tU3RhdGUsIHRvU3RhdGUpOwogICAgICB0aGlzLmNsb3N1cmUgPSBjbG9zdXJlOwogICB9OwogICBGdW5jdGlvbmFsR3JhcGhMaW5rLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoR3JhcGhMaW5rLnByb3RvdHlwZSk7CiAgIEZ1bmN0aW9uYWxHcmFwaExpbmsucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRnVuY3Rpb25hbEdyYXBoTGluazsKCiAgIEZ1bmN0aW9uYWxHcmFwaExpbmsucHJvdG90eXBlLmdldEFzc29jaWF0aW9ucyA9IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xvc3VyZShjb250ZXh0LCB0aGlzLmdldEZyb21TdGF0ZSgpLCB0aGlzLmdldFRvU3RhdGUoKSk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIEV2ZW50R3JhcGggPDxjbGFzcz4+CiAgICAqCiAgICAqIEJ1aWxkcyBhIG1hcCBvZiBhc3NvY2lhdGlvbnMgZnJvbSBvbmUgc3RhdGUgdG8gYW5vdGhlciBpbiBjb250ZXh0IG9mIGEKICAgICogcGFydGljdWxhciBvYmplY3QuICBUaGUgYXNzb2NpYXRpb25zIGNhbiBiZSBkaXJlY3QgKG9uZSBvciBtb3JlIHZhbHVlcykKICAgICogb3IgZnVuY3Rpb25hbCAoYSBtZXRob2QgcmV0dXJuaW5nIG9uZSBvciBtb3JlIHZhbHVlcyksIGFuZCBhcmUgdXNlZCB0bwogICAgKiBwcm92aWRlIGFkZGl0aW9uYWwgY29udGV4dHVhbCBldmVudCBob29rcyBmb3IgdGhlIFVJIHRvIGNvbnN1bWUuCiAgICAqLwogICB2YXIgRXZlbnRHcmFwaCA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmZyb21NYXAgPSB7fTsKICAgfTsKICAgRXZlbnRHcmFwaC5BTlkgPSAiPDxhbnk+PiI7CgogICBFdmVudEdyYXBoLnByb3RvdHlwZS5hc3NvYyA9IGZ1bmN0aW9uKGZyb21TdGF0ZU9iaiwgdG9TdGF0ZU9iaiwgYXNzb2NPYmopIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgaWYgKCEgZnJvbVN0YXRlT2JqKSB7CiAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZnJvbVN0YXRlT2JqIGlzIG5vdCBkZWZpbmVkLiIpOwogICAgICB9CgogICAgICBpZiAoISB0b1N0YXRlT2JqKSB7CiAgICAgICAgIHRocm93IG5ldyBFcnJvcigidG9TdGF0ZU9iaiBpcyBub3QgZGVmaW5lZC4iKTsKICAgICAgfQoKICAgICAgaWYgKCEgYXNzb2NPYmopIHsKICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJhc3NvY09iaiBpcyBub3QgZGVmaW5lZC4iKTsKICAgICAgfQoKICAgICAgaWYgKGZyb21TdGF0ZU9iaiBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgIGZyb21TdGF0ZU9iai5mb3JFYWNoKGZ1bmN0aW9uKGZyb21TdGF0ZSkgewogICAgICAgICAgICBzZWxmLmFzc29jKGZyb21TdGF0ZSwgdG9TdGF0ZU9iaiwgYXNzb2NPYmopOwogICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmICh0b1N0YXRlT2JqIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgdG9TdGF0ZU9iai5mb3JFYWNoKGZ1bmN0aW9uKHRvU3RhdGUpIHsKICAgICAgICAgICAgc2VsZi5hc3NvYyhmcm9tU3RhdGVPYmosIHRvU3RhdGUsIGFzc29jT2JqKTsKICAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgIGlmICh0eXBlb2YgYXNzb2NPYmogPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhpcy5fYWRkQXNzb2NpYXRpb24obmV3IEZ1bmN0aW9uYWxHcmFwaExpbmsoZnJvbVN0YXRlT2JqLCB0b1N0YXRlT2JqLCBhc3NvY09iaikpOwogICAgICAgICB9IGVsc2UgaWYgKGFzc29jT2JqIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgICAgdGhpcy5fYWRkQXNzb2NpYXRpb24obmV3IERpcmVjdEdyYXBoTGluayhmcm9tU3RhdGVPYmosIHRvU3RhdGVPYmosIGFzc29jT2JqKSk7CiAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX2FkZEFzc29jaWF0aW9uKG5ldyBEaXJlY3RHcmFwaExpbmsoZnJvbVN0YXRlT2JqLCB0b1N0YXRlT2JqLCBbYXNzb2NPYmpdKSk7CiAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgfTsKCiAgIEV2ZW50R3JhcGgucHJvdG90eXBlLmdldEFzc29jaWF0aW9ucyA9IGZ1bmN0aW9uKGNvbnRleHQsIGZyb21TdGF0ZSwgdG9TdGF0ZSkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZnJvbVN0YXRlLCAnZnJvbVN0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b1N0YXRlLCAndG9TdGF0ZScpOwogICAgICB2YXIgYXNzb2NpYXRpb25zID0gW107CgogICAgICB2YXIgdG9NYXBGcm9tQW55ID0gdGhpcy5mcm9tTWFwW0V2ZW50R3JhcGguQU5ZXSB8fCB7fTsKICAgICAgdmFyIHRvTWFwID0gdGhpcy5mcm9tTWFwW2Zyb21TdGF0ZV0gfHwge307CgogICAgICBhc3NvY2lhdGlvbnMgPSBhc3NvY2lhdGlvbnMuY29uY2F0KHRoaXMuX2dldEFzc29jaWF0aW9uc0Zyb21NYXAoCiAgICAgICAgICAgICAgIHRvTWFwRnJvbUFueSwgY29udGV4dCwgZnJvbVN0YXRlLCB0b1N0YXRlKSk7CiAgICAgIGFzc29jaWF0aW9ucyA9IGFzc29jaWF0aW9ucy5jb25jYXQodGhpcy5fZ2V0QXNzb2NpYXRpb25zRnJvbU1hcCgKICAgICAgICAgICAgICAgdG9NYXAsIGNvbnRleHQsIGZyb21TdGF0ZSwgdG9TdGF0ZSkpOwoKICAgICAgcmV0dXJuIGFzc29jaWF0aW9uczsKICAgfTsKCiAgIEV2ZW50R3JhcGgucHJvdG90eXBlLl9hZGRBc3NvY2lhdGlvbiA9IGZ1bmN0aW9uKGFzc29jKSB7CiAgICAgIHZhciB0b01hcCA9IHRoaXMuZnJvbU1hcFthc3NvYy5nZXRGcm9tU3RhdGUoKV07CgogICAgICBpZiAoISB0b01hcCkgewogICAgICAgICB0b01hcCA9IHRoaXMuZnJvbU1hcFthc3NvYy5nZXRGcm9tU3RhdGUoKV0gPSB7fTsKICAgICAgfQoKICAgICAgdmFyIGFzc29jTGlzdCA9IHRvTWFwW2Fzc29jLmdldFRvU3RhdGUoKV07CgogICAgICBpZiAoISBhc3NvY0xpc3QpIHsKICAgICAgICAgYXNzb2NMaXN0ID0gdG9NYXBbYXNzb2MuZ2V0VG9TdGF0ZSgpXSA9IFtdOwogICAgICB9CgogICAgICBhc3NvY0xpc3QucHVzaChhc3NvYyk7CiAgIH07CgogICBFdmVudEdyYXBoLnByb3RvdHlwZS5fZ2V0QXNzb2NpYXRpb25zRnJvbU1hcCA9IGZ1bmN0aW9uKG1hcCwgY29udGV4dCwgZnJvbVN0YXRlLCB0b1N0YXRlKSB7CiAgICAgIHZhciBhc3NvY0xpc3QgPSAobWFwW0V2ZW50R3JhcGguQU5ZXSB8fCBbXSkuY29uY2F0KG1hcFt0b1N0YXRlXSB8fCBbXSk7CiAgICAgIHJldHVybiBhc3NvY0xpc3QucmVkdWNlKGZ1bmN0aW9uKHByZXYsIGFzc29jKSB7CiAgICAgICAgIHJldHVybiBwcmV2LmNvbmNhdChhc3NvYy5nZXRBc3NvY2lhdGlvbnMoY29udGV4dCkpOwogICAgICB9LCBbXSk7CiAgIH07CgogICBjb25uZWN0LkV2ZW50R3JhcGggPSBFdmVudEdyYXBoOwoKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQWdlbnRTdGF0ZVR5cGUKICAgKi8KICBjb25uZWN0LkFnZW50U3RhdGVUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5pdCcsCiAgICAncm91dGFibGUnLAogICAgJ25vdF9yb3V0YWJsZScsCiAgICAnb2ZmbGluZScKICBdKTsKICBjb25uZWN0LkFnZW50U3RhdHVzVHlwZSA9IGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGU7CgogIC8qKgogICAqIGVudW0gQWdlbnRBdmFpbFN0YXRlcwogICAqLwogIGNvbm5lY3QuQWdlbnRBdmFpbFN0YXRlcyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ0luaXQnLAogICAgJ0J1c3knLAogICAgJ0FmdGVyQ2FsbFdvcmsnLAogICAgJ0NhbGxpbmdDdXN0b21lcicsCiAgICAnRGlhbGluZycsCiAgICAnSm9pbmluZycsCiAgICAnUGVuZGluZ0F2YWlsYWJsZScsCiAgICAnUGVuZGluZ0J1c3knCiAgXSk7CgogIC8qKgogICAqIGVudW0gQWdlbnRFcnJvclN0YXRlcwogICAqLwogIGNvbm5lY3QuQWdlbnRFcnJvclN0YXRlcyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ0Vycm9yJywKICAgICdBZ2VudEh1bmdVcCcsCiAgICAnQmFkQWRkcmVzc0FnZW50JywKICAgICdCYWRBZGRyZXNzQ3VzdG9tZXInLAogICAgJ0RlZmF1bHQnLAogICAgJ0ZhaWxlZENvbm5lY3RBZ2VudCcsCiAgICAnRmFpbGVkQ29ubmVjdEN1c3RvbWVyJywKICAgICdJbnZhbGlkTG9jYWxlJywKICAgICdMaW5lRW5nYWdlZEFnZW50JywKICAgICdMaW5lRW5nYWdlZEN1c3RvbWVyJywKICAgICdNaXNzZWRDYWxsQWdlbnQnLAogICAgJ01pc3NlZENhbGxDdXN0b21lcicsCiAgICAnTXVsdGlwbGVDY3BXaW5kb3dzJywKICAgICdSZWFsdGltZUNvbW11bmljYXRpb25FcnJvcicKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBBZGRyZXNzVHlwZQogICAqLwogIGNvbm5lY3QuRW5kcG9pbnRUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAncGhvbmVfbnVtYmVyJywKICAgICdhZ2VudCcsCiAgICAncXVldWUnCiAgXSk7CiAgY29ubmVjdC5BZGRyZXNzVHlwZSA9IGNvbm5lY3QuRW5kcG9pbnRUeXBlOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIENvbm5lY3Rpb25UeXBlCiAgICovCiAgY29ubmVjdC5Db25uZWN0aW9uVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2FnZW50JywKICAgICdpbmJvdW5kJywKICAgICdvdXRib3VuZCcsCiAgICAnbW9uaXRvcmluZycKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBDb25uZWN0aW9uU3RhdGVUeXBlCiAgICovCiAgY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5pdCcsCiAgICAnY29ubmVjdGluZycsCiAgICAnY29ubmVjdGVkJywKICAgICdob2xkJywKICAgICdkaXNjb25uZWN0ZWQnCiAgXSk7CiAgY29ubmVjdC5Db25uZWN0aW9uU3RhdHVzVHlwZSA9IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZTsKCiAgY29ubmVjdC5DT05ORUNUSU9OX0FDVElWRV9TVEFURVMgPSBjb25uZWN0LnNldChbCiAgICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuQ09OTkVDVElORywKICAgIGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNURUQsCiAgICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuSE9MRAogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIENvbnRhY3RTdGF0ZVR5cGUKICAgKi8KICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdpbmNvbWluZycsCiAgICAncGVuZGluZycsCiAgICAnY29ubmVjdGluZycsCiAgICAnY29ubmVjdGVkJywKICAgICdtaXNzZWQnLAogICAgJ2Vycm9yJywKICAgICdlbmRlZCcKICBdKTsKICBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlID0gY29ubmVjdC5Db250YWN0U3RhdGVUeXBlOwoKICBjb25uZWN0LkNPTlRBQ1RfQUNUSVZFX1NUQVRFUyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2luY29taW5nJywKICAgICdwZW5kaW5nJywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdFR5cGUKICAgKi8KICBjb25uZWN0LkNvbnRhY3RUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAndm9pY2UnLAogICAgJ3F1ZXVlX2NhbGxiYWNrJywKICAgICdjaGF0JywKICAgICd0YXNrJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIENvbnRhY3RJbml0aWF0aW9uTWV0aG9kCiAgICovCiAgY29ubmVjdC5Db250YWN0SW5pdGlhdGlvbk1ldGhvZCA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2luYm91bmQnLAogICAgJ291dGJvdW5kJywKICAgICd0cmFuc2ZlcicsCiAgICAncXVldWVfdHJhbnNmZXInLAogICAgJ2NhbGxiYWNrJywKICAgICdhcGknLAogICAgJ2Rpc2Nvbm5lY3QnCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogZW51bSBDaGFubmVsVHlwZQogICovCiAgY29ubmVjdC5DaGFubmVsVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ1ZPSUNFJywKICAgICdDSEFUJywKICAgICdUQVNLJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIGVudW0gTWVkaWFUeXBlCiAgKi8KICBjb25uZWN0Lk1lZGlhVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ3NvZnRwaG9uZScsCiAgICAnY2hhdCcsCiAgICAndGFzaycKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBTb2Z0cGhvbmVDYWxsVHlwZQogICAqLwogIGNvbm5lY3QuU29mdHBob25lQ2FsbFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdhdWRpb192aWRlbycsCiAgICAndmlkZW9fb25seScsCiAgICAnYXVkaW9fb25seScsCiAgICAnbm9uZScKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgU29mdHBob25lRXJyb3JUeXBlcwogICAqLwogIGNvbm5lY3QuU29mdHBob25lRXJyb3JUeXBlcyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ3Vuc3VwcG9ydGVkX2Jyb3dzZXInLAogICAgJ21pY3JvcGhvbmVfbm90X3NoYXJlZCcsCiAgICAnc2lnbmFsbGluZ19oYW5kc2hha2VfZmFpbHVyZScsCiAgICAnc2lnbmFsbGluZ19jb25uZWN0aW9uX2ZhaWx1cmUnLAogICAgJ2ljZV9jb2xsZWN0aW9uX3RpbWVvdXQnLAogICAgJ3VzZXJfYnVzeV9lcnJvcicsCiAgICAnd2VicnRjX2Vycm9yJywKICAgICdyZWFsdGltZV9jb21tdW5pY2F0aW9uX2Vycm9yJywKICAgICdvdGhlcicKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZEVycm9yVHlwZXMKICAgKi8KICBjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnbm9fc3BlYWtlcl9pZF9mb3VuZCcsCiAgICAnc3BlYWtlcl9pZF9ub3RfZW5yb2xsZWQnLAogICAgJ2dldF9zcGVha2VyX2lkX2ZhaWxlZCcsCiAgICAnZ2V0X3NwZWFrZXJfc3RhdHVzX2ZhaWxlZCcsCiAgICAnb3B0X291dF9zcGVha2VyX2ZhaWxlZCcsCiAgICAnZGVsZXRlX3NwZWFrZXJfZmFpbGVkJywKICAgICdzdGFydF9zZXNzaW9uX2ZhaWxlZCcsCiAgICAnZXZhbHVhdGVfc3BlYWtlcl9mYWlsZWQnLAogICAgJ2Rlc2NyaWJlX3Nlc3Npb25fZmFpbGVkJywKICAgICdlbnJvbGxfc3BlYWtlcl9mYWlsZWQnLAogICAgJ3VwZGF0ZV9zcGVha2VyX2lkX2ZhaWxlZCcsCiAgICAnbm90X3N1cHBvcnRlZF9vbl9jb25mZXJlbmNlX2NhbGxzJywKICAgICd0aW1lb3V0JwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBDVEkgZXhjZXB0aW9ucwogICAqLwogIGNvbm5lY3QuQ1RJRXhjZXB0aW9ucyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgIkFjY2Vzc0RlbmllZEV4Y2VwdGlvbiIsCiAgICAiSW52YWxpZFN0YXRlRXhjZXB0aW9uIiwKICAgICJCYWRFbmRwb2ludEV4Y2VwdGlvbiIsCiAgICAiSW52YWxpZEFnZW50QVJORXhjZXB0aW9uIiwKICAgICJJbnZhbGlkQ29uZmlndXJhdGlvbkV4Y2VwdGlvbiIsCiAgICAiSW52YWxpZENvbnRhY3RUeXBlRXhjZXB0aW9uIiwKICAgICJQYWdpbmF0aW9uRXhjZXB0aW9uIiwKICAgICJSZWZyZXNoVG9rZW5FeHBpcmVkRXhjZXB0aW9uIiwKICAgICJTZW5kRGF0YUZhaWxlZEV4Y2VwdGlvbiIsCiAgICAiVW5hdXRob3JpemVkRXhjZXB0aW9uIiwKICAgICJRdW90YUV4Y2VlZGVkRXhjZXB0aW9uIgogIF0pOwogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIFZvaWNlSWQgc3RyZWFtaW5nIHN0YXR1cwogICAqLwogIGNvbm5lY3QuVm9pY2VJZFN0cmVhbWluZ1N0YXR1cyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgIk9OR09JTkciLAogICAgIkVOREVEIiwKICAgICJQRU5ESU5HX0NPTkZJR1VSQVRJT04iCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIFZvaWNlSWQgYXV0aGVudGljYXRpb24gZGVjaXNpb24KICAgKi8KICBjb25uZWN0LlZvaWNlSWRBdXRoZW50aWNhdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiQUNDRVBUIiwKICAgICJSRUpFQ1QiLAogICAgIk5PVF9FTk9VR0hfU1BFRUNIIiwKICAgICJTUEVBS0VSX05PVF9FTlJPTExFRCIsCiAgICAiU1BFQUtFUl9PUFRFRF9PVVQiLAogICAgIlNQRUFLRVJfSURfTk9UX1BST1ZJREVEIiwKICAgICJTUEVBS0VSX0VYUElSRUQiCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIFZvaWNlSWQgZnJhdWQgZGV0ZWN0aW9uIGRlY2lzaW9uCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkRnJhdWREZXRlY3Rpb25EZWNpc2lvbiA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgIk5PVF9FTk9VR0hfU1BFRUNIIiwKICAgICJISUdIX1JJU0siLAogICAgIkxPV19SSVNLIgogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBjb250YWN0IGZsb3cgYXV0aGVudGljYXRpb24gZGVjaXNpb24gCiAgICovCiAgY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24gPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJBdXRoZW50aWNhdGVkIiwKICAgICJOb3RBdXRoZW50aWNhdGVkIiwKICAgICJJbmNvbmNsdXNpdmUiLAogICAgIk5vdEVucm9sbGVkIiwKICAgICJPcHRlZE91dCIsCiAgICAiTm90RW5hYmxlZCIsCiAgICAiRXJyb3IiCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIGNvbnRhY3QgZmxvdyAgZnJhdWQgZGV0ZWN0aW9uIGRlY2lzaW9uCiAgICovCiAgY29ubmVjdC5Db250YWN0Rmxvd0ZyYXVkRGV0ZWN0aW9uRGVjaXNpb24gPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJIaWdoUmlzayIsCiAgICAiTG93UmlzayIsCiAgICAiSW5jb25jbHVzaXZlIiwKICAgICJOb3RFbmFibGVkIiwKICAgICJFcnJvciIKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZCBFbnJvbGxtZW50UmVxdWVzdCBTdGF0dXMgCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkRW5yb2xsbWVudFJlcXVlc3RTdGF0dXMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJOT1RfRU5PVUdIX1NQRUVDSCIsCiAgICAiSU5fUFJPR1JFU1MiLAogICAgIkNPTVBMRVRFRCIsCiAgICAiRkFJTEVEIgogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBWb2ljZUlkIFNwZWFrZXIgc3RhdHVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkU3BlYWtlclN0YXR1cyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgIk9QVEVEX09VVCIsCiAgICAiRU5ST0xMRUQiCiAgXSkKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQWdlbnQKICAgKi8KICB2YXIgQWdlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuYWdlbnQuaW5pdGlhbGl6ZWQpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcigiVGhlIGFnZW50IGlzIG5vdCB5ZXQgaW5pdGlhbGl6ZWQhIik7CiAgICB9CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFnZW50RGF0YSgpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5fY3JlYXRlQ29udGFjdEFQSSA9IGZ1bmN0aW9uIChjb250YWN0RGF0YSkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdERhdGEuY29udGFjdElkKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25Db250YWN0UGVuZGluZyA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuQ09OVEFDVF9QRU5ESU5HLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25SZWZyZXNoID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5SRUZSRVNILCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25Sb3V0YWJsZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuUk9VVEFCTEUsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbk5vdFJvdXRhYmxlID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5OT1RfUk9VVEFCTEUsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbk9mZmxpbmUgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLk9GRkxJTkUsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbkVycm9yID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5FUlJPUiwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uU29mdHBob25lRXJyb3IgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLlNPRlRQSE9ORV9FUlJPUiwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uV2ViU29ja2V0Q29ubmVjdGlvbkxvc3QgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLldFQlNPQ0tFVF9DT05ORUNUSU9OX0xPU1QsIGYpOwogIH0KCiAgQWdlbnQucHJvdG90eXBlLm9uV2ViU29ja2V0Q29ubmVjdGlvbkdhaW5lZCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuV0VCU09DS0VUX0NPTk5FQ1RJT05fR0FJTkVELCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vbkFmdGVyQ2FsbFdvcmsgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLkFDVywgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uU3RhdGVDaGFuZ2UgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLlNUQVRFX0NIQU5HRSwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uTXV0ZVRvZ2dsZSA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQWdlbnRFdmVudHMuTVVURV9UT0dHTEUsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbkxvY2FsTWVkaWFTdHJlYW1DcmVhdGVkID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5BZ2VudEV2ZW50cy5MT0NBTF9NRURJQV9TVFJFQU1fQ1JFQVRFRCwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uU3BlYWtlckRldmljZUNoYW5nZWQgPSBmdW5jdGlvbihmKXsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNQRUFLRVJfREVWSUNFX0NIQU5HRUQsIGYpOwogIH0KCiAgQWdlbnQucHJvdG90eXBlLm9uTWljcm9waG9uZURldmljZUNoYW5nZWQgPSBmdW5jdGlvbihmKXsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLk1JQ1JPUEhPTkVfREVWSUNFX0NIQU5HRUQsIGYpOwogIH0KCiAgQWdlbnQucHJvdG90eXBlLm9uUmluZ2VyRGV2aWNlQ2hhbmdlZCA9IGZ1bmN0aW9uKGYpewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuUklOR0VSX0RFVklDRV9DSEFOR0VELCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5tdXRlID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwKICAgICAgewogICAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5NVVRFLAogICAgICAgIGRhdGE6IHsgbXV0ZTogdHJ1ZSB9CiAgICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS51bm11dGUgPSBmdW5jdGlvbiAoKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULAogICAgICB7CiAgICAgICAgZXZlbnQ6IGNvbm5lY3QuRXZlbnRUeXBlLk1VVEUsCiAgICAgICAgZGF0YTogeyBtdXRlOiBmYWxzZSB9CiAgICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRTcGVha2VyRGV2aWNlID0gZnVuY3Rpb24gKGRldmljZUlkKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuU0VUX1NQRUFLRVJfREVWSUNFLAogICAgICBkYXRhOiB7IGRldmljZUlkOiBkZXZpY2VJZCB9CiAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuc2V0TWljcm9waG9uZURldmljZSA9IGZ1bmN0aW9uIChkZXZpY2VJZCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9NSUNST1BIT05FX0RFVklDRSwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldFJpbmdlckRldmljZSA9IGZ1bmN0aW9uIChkZXZpY2VJZCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9SSU5HRVJfREVWSUNFLAogICAgICBkYXRhOiB7IGRldmljZUlkOiBkZXZpY2VJZCB9CiAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNuYXBzaG90LnN0YXRlOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXROZXh0U3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNuYXBzaG90Lm5leHRTdGF0ZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0QXZhaWxhYmlsaXR5U3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNuYXBzaG90LmFnZW50QXZhaWxhYmlsaXR5U3RhdGU7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldFN0YXR1cyA9IEFnZW50LnByb3RvdHlwZS5nZXRTdGF0ZTsKCiAgQWdlbnQucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5ub3coKSAtIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5zdGF0ZS5zdGFydFRpbWVzdGFtcC5nZXRUaW1lKCkgKyBjb25uZWN0LmNvcmUuZ2V0U2tldygpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRTdGF0dXNEdXJhdGlvbiA9IEFnZW50LnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uOwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0UGVybWlzc2lvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25maWd1cmF0aW9uKCkucGVybWlzc2lvbnM7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldENvbnRhY3RzID0gZnVuY3Rpb24gKGNvbnRhY3RUeXBlRmlsdGVyKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNuYXBzaG90LmNvbnRhY3RzLm1hcChmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgICAgcmV0dXJuIHNlbGYuX2NyZWF0ZUNvbnRhY3RBUEkoY29udGFjdERhdGEpOwogICAgfSkuZmlsdGVyKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIHJldHVybiAoIWNvbnRhY3RUeXBlRmlsdGVyKSB8fCBjb250YWN0LmdldFR5cGUoKSA9PT0gY29udGFjdFR5cGVGaWx0ZXI7CiAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0Q29uZmlndXJhdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuY29uZmlndXJhdGlvbjsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0QWdlbnRTdGF0ZXMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25maWd1cmF0aW9uKCkuYWdlbnRTdGF0ZXM7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldFJvdXRpbmdQcm9maWxlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnJvdXRpbmdQcm9maWxlOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRDaGFubmVsQ29uY3VycmVuY3kgPSBmdW5jdGlvbiAoY2hhbm5lbCkgewogICAgdmFyIGNoYW5uZWxDb25jdXJyZW5jeU1hcCA9IHRoaXMuZ2V0Um91dGluZ1Byb2ZpbGUoKS5jaGFubmVsQ29uY3VycmVuY3lNYXA7CiAgICBpZiAoIWNoYW5uZWxDb25jdXJyZW5jeU1hcCkgewogICAgICBjaGFubmVsQ29uY3VycmVuY3lNYXAgPSBPYmplY3Qua2V5cyhjb25uZWN0LkNoYW5uZWxUeXBlKS5yZWR1Y2UoZnVuY3Rpb24gKGFjYywga2V5KSB7CiAgICAgICAgLy8gRXhjbHVkZSBUQVNLIGZyb20gZGVmYXVsdCBjb25jdXJyZW5jeS4KICAgICAgICBpZiAoa2V5ICE9PSAnVEFTSycpIHsKICAgICAgICAgIGFjY1tjb25uZWN0LkNoYW5uZWxUeXBlW2tleV1dID0gMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFjYzsKICAgICAgfSwge30pOwogICAgfQogICAgcmV0dXJuIGNoYW5uZWwKICAgICAgPyAoY2hhbm5lbENvbmN1cnJlbmN5TWFwW2NoYW5uZWxdIHx8IDApCiAgICAgIDogY2hhbm5lbENvbmN1cnJlbmN5TWFwOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXROYW1lID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLm5hbWU7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldEV4dGVuc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5leHRlbnNpb247CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldERpYWxhYmxlQ291bnRyaWVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLmRpYWxhYmxlQ291bnRyaWVzOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5pc1NvZnRwaG9uZUVuYWJsZWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25maWd1cmF0aW9uKCkuc29mdHBob25lRW5hYmxlZDsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuc2V0Q29uZmlndXJhdGlvbiA9IGZ1bmN0aW9uIChjb25maWd1cmF0aW9uLCBjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBpZiAoY29uZmlndXJhdGlvbiAmJiBjb25maWd1cmF0aW9uLmFnZW50UHJlZmVyZW5jZXMgJiYgIWNvbm5lY3QuaXNWYWxpZExvY2FsZShjb25maWd1cmF0aW9uLmFnZW50UHJlZmVyZW5jZXMubG9jYWxlKSkgewogICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzLklOVkFMSURfTE9DQUxFKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlVQREFURV9BR0VOVF9DT05GSUdVUkFUSU9OLCB7CiAgICAgICAgY29uZmlndXJhdGlvbjogY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbmZpZ3VyYXRpb24sICdjb25maWd1cmF0aW9uJykKICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgLy8gV2UgbmVlZCB0byBhc2sgdGhlIHNoYXJlZCB3b3JrZXIgdG8gcmVsb2FkIGFnZW50IGNvbmZpZwogICAgICAgICAgICAvLyBvbmNlIHdlIGNoYW5nZSBpdCBzbyBldmVyeSB0YWIgaGFzIGFjY3VyYXRlIGNvbmZpZy4KICAgICAgICAgICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuUkVMT0FEX0FHRU5UX0NPTkZJR1VSQVRJT04pOwoKICAgICAgICAgICAgaWYgKGNhbGxiYWNrcy5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBjYWxsYmFja3MgJiYgY2FsbGJhY2tzLmZhaWx1cmUKICAgICAgfSk7CiAgICB9CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24gKHN0YXRlLCBjYWxsYmFja3MsIG9wdGlvbnMpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuUFVUX0FHRU5UX1NUQVRFLCB7CiAgICAgIHN0YXRlOiBjb25uZWN0LmFzc2VydE5vdE51bGwoc3RhdGUsICdzdGF0ZScpLAogICAgICBlbnF1ZXVlTmV4dFN0YXRlOiBvcHRpb25zICYmICEhb3B0aW9ucy5lbnF1ZXVlTmV4dFN0YXRlCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbkVucXVldWVkTmV4dFN0YXRlID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5FTlFVRVVFRF9ORVhUX1NUQVRFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuc2V0U3RhdHVzID0gQWdlbnQucHJvdG90eXBlLnNldFN0YXRlOwoKICBBZ2VudC5wcm90b3R5cGUuY29ubmVjdCA9IGZ1bmN0aW9uIChlbmRwb2ludEluLCBwYXJhbXMpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgZW5kcG9pbnQgPSBuZXcgY29ubmVjdC5FbmRwb2ludChlbmRwb2ludEluKTsKICAgIC8vIEhhdmUgdG8gcmVtb3ZlIHRoZSBlbmRwb2ludElkIGZpZWxkIG9yIEFXUyBKUyBTREsgZ2V0cyBtYWQuCiAgICBkZWxldGUgZW5kcG9pbnQuZW5kcG9pbnRJZDsKCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX09VVEJPVU5EX0NPTlRBQ1QsIHsKICAgICAgZW5kcG9pbnQ6IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChlbmRwb2ludCwgJ2VuZHBvaW50JyksCiAgICAgIHF1ZXVlQVJOOiAocGFyYW1zICYmIChwYXJhbXMucXVldWVBUk4gfHwgcGFyYW1zLnF1ZXVlSWQpKSB8fCB0aGlzLmdldFJvdXRpbmdQcm9maWxlKCkuZGVmYXVsdE91dGJvdW5kUXVldWUucXVldWVBUk4KICAgIH0sIHBhcmFtcyAmJiB7CiAgICAgICAgc3VjY2VzczogcGFyYW1zLnN1Y2Nlc3MsCiAgICAgICAgZmFpbHVyZTogcGFyYW1zLmZhaWx1cmUKICAgICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldEFsbFF1ZXVlQVJOcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5yb3V0aW5nUHJvZmlsZS5xdWV1ZXMubWFwKGZ1bmN0aW9uIChxdWV1ZSkgewogICAgICByZXR1cm4gcXVldWUucXVldWVBUk47CiAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0RW5kcG9pbnRzID0gZnVuY3Rpb24gKHF1ZXVlQVJOcywgY2FsbGJhY2tzLCBwYWdlSW5mb0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNhbGxiYWNrcywgImNhbGxiYWNrcyIpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNhbGxiYWNrcy5zdWNjZXNzLCAiY2FsbGJhY2tzLnN1Y2Nlc3MiKTsKICAgIHZhciBwYWdlSW5mbyA9IHBhZ2VJbmZvSW4gfHwgeyB9OwoKICAgIHBhZ2VJbmZvLmVuZHBvaW50cyA9IHBhZ2VJbmZvLmVuZHBvaW50cyB8fCBbXTsKICAgIHBhZ2VJbmZvLm1heFJlc3VsdHMgPSBwYWdlSW5mby5tYXhSZXN1bHRzIHx8IGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFOwoKICAgIC8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IGFsbG93aW5nIGEgc2luZ2xlIHF1ZXVlQVJOIHRvIGJlIHNwZWNpZmllZAogICAgLy8gaW5zdGVhZCBvZiBhbiBhcnJheS4KICAgIGlmICghY29ubmVjdC5pc0FycmF5KHF1ZXVlQVJOcykpIHsKICAgICAgcXVldWVBUk5zID0gW3F1ZXVlQVJOc107CiAgICB9CgogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9FTkRQT0lOVFMsIHsKICAgICAgcXVldWVBUk5zOiBxdWV1ZUFSTnMsCiAgICAgIG5leHRUb2tlbjogcGFnZUluZm8ubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhZ2VJbmZvLm1heFJlc3VsdHMKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEubmV4dFRva2VuKSB7CiAgICAgICAgICAgIHNlbGYuZ2V0RW5kcG9pbnRzKHF1ZXVlQVJOcywgY2FsbGJhY2tzLCB7CiAgICAgICAgICAgICAgbmV4dFRva2VuOiBkYXRhLm5leHRUb2tlbiwKICAgICAgICAgICAgICBtYXhSZXN1bHRzOiBwYWdlSW5mby5tYXhSZXN1bHRzLAogICAgICAgICAgICAgIGVuZHBvaW50czogcGFnZUluZm8uZW5kcG9pbnRzLmNvbmNhdChkYXRhLmVuZHBvaW50cykKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwYWdlSW5mby5lbmRwb2ludHMgPSBwYWdlSW5mby5lbmRwb2ludHMuY29uY2F0KGRhdGEuZW5kcG9pbnRzKTsKICAgICAgICAgICAgdmFyIGVuZHBvaW50cyA9IHBhZ2VJbmZvLmVuZHBvaW50cy5tYXAoZnVuY3Rpb24gKGVuZHBvaW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LkVuZHBvaW50KGVuZHBvaW50KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjYWxsYmFja3Muc3VjY2Vzcyh7CiAgICAgICAgICAgICAgZW5kcG9pbnRzOiBlbmRwb2ludHMsCiAgICAgICAgICAgICAgYWRkcmVzc2VzOiBlbmRwb2ludHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBjYWxsYmFja3MuZmFpbHVyZQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0QWRkcmVzc2VzID0gQWdlbnQucHJvdG90eXBlLmdldEVuZHBvaW50czsKCiAgLy9JbnRlcm5hbCBpZGVudGlmaWVyLgogIEFnZW50LnByb3RvdHlwZS5fZ2V0UmVzb3VyY2VJZCA9IGZ1bmN0aW9uKCkgewogICAgcXVldWVBcm5zID0gdGhpcy5nZXRBbGxRdWV1ZUFSTnMoKTsKICAgIGZvciAobGV0IHF1ZXVlQXJuIG9mIHF1ZXVlQXJucykgewogICAgICBjb25zdCBhZ2VudElkTWF0Y2ggPSBxdWV1ZUFybi5tYXRjaCgvXC9hZ2VudFwvKFteL10rKS8pOwogICAgICAKICAgICAgaWYgKGFnZW50SWRNYXRjaCkgewogICAgICAgIHJldHVybiBhZ2VudElkTWF0Y2hbMV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBuZXcgRXJyb3IoIkFnZW50LnByb3RvdHlwZS5fZ2V0UmVzb3VyY2VJZDogcXVldWVBcm5zIGRpZCBub3QgY29udGFpbiBhZ2VudFJlc291cmNlSWQ6ICIsIHF1ZXVlQXJucyk7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUudG9TbmFwc2hvdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5BZ2VudFNuYXBzaG90KHRoaXMuX2dldERhdGEoKSk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQWdlbnRTbmFwc2hvdAogICAqLwogIHZhciBBZ2VudFNuYXBzaG90ID0gZnVuY3Rpb24gKGFnZW50RGF0YSkgewogICAgY29ubmVjdC5BZ2VudC5jYWxsKHRoaXMpOwogICAgdGhpcy5hZ2VudERhdGEgPSBhZ2VudERhdGE7CiAgfTsKICBBZ2VudFNuYXBzaG90LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQWdlbnQucHJvdG90eXBlKTsKICBBZ2VudFNuYXBzaG90LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEFnZW50U25hcHNob3Q7CgogIEFnZW50U25hcHNob3QucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuYWdlbnREYXRhOwogIH07CgogIEFnZW50U25hcHNob3QucHJvdG90eXBlLl9jcmVhdGVDb250YWN0QVBJID0gZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ29udGFjdFNuYXBzaG90KGNvbnRhY3REYXRhKTsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBDb250YWN0CiAgICovCiAgdmFyIENvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICB0aGlzLmNvbnRhY3RJZCA9IGNvbnRhY3RJZDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmdldENvbnRhY3RJZCgpKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5fY3JlYXRlQ29ubmVjdGlvbkFQSSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uRGF0YSkgewogICAgaWYgKHRoaXMuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLkNIQVQpIHsKICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LkNoYXRDb25uZWN0aW9uKHRoaXMuY29udGFjdElkLCBjb25uZWN0aW9uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgfSBlbHNlIGlmICh0aGlzLmdldFR5cGUoKSA9PT0gY29ubmVjdC5Db250YWN0VHlwZS5UQVNLKSB7CiAgICAgIHJldHVybiBuZXcgY29ubmVjdC5UYXNrQ29ubmVjdGlvbih0aGlzLmNvbnRhY3RJZCwgY29ubmVjdGlvbkRhdGEuY29ubmVjdGlvbklkKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBuZXcgY29ubmVjdC5Wb2ljZUNvbm5lY3Rpb24odGhpcy5jb250YWN0SWQsIGNvbm5lY3Rpb25EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICB9CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0RXZlbnROYW1lID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGV2ZW50TmFtZSwgdGhpcy5nZXRDb250YWN0SWQoKSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25SZWZyZXNoID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLlJFRlJFU0gpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkluY29taW5nID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLklOQ09NSU5HKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25Db25uZWN0aW5nID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkNPTk5FQ1RJTkcpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vblBlbmRpbmcgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuUEVORElORyksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uQWNjZXB0ZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbk1pc3NlZCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkVuZGVkID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkVOREVEKSwgZik7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5ERVNUUk9ZRUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkRlc3Ryb3kgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuREVTVFJPWUVEKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25BQ1cgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNXKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25Db25uZWN0ZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQ09OTkVDVEVEKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25FcnJvciA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5FUlJPUiksIGYpOwogIH0KCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29udGFjdElkOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldE9yaWdpbmFsQ29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5pbml0aWFsQ29udGFjdElkOwogIH07CiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0SW5pdGlhbENvbnRhY3RJZCA9IENvbnRhY3QucHJvdG90eXBlLmdldE9yaWdpbmFsQ29udGFjdElkOwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS50eXBlOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENvbnRhY3REdXJhdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb250YWN0RHVyYXRpb247CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc3RhdGU7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdHVzID0gQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdGU7CgogIENvbnRhY3QucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5ub3coKSAtIHRoaXMuX2dldERhdGEoKS5zdGF0ZS50aW1lc3RhbXAuZ2V0VGltZSgpICsgY29ubmVjdC5jb3JlLmdldFNrZXcoKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0dXNEdXJhdGlvbiA9IENvbnRhY3QucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb247CgogIENvbnRhY3QucHJvdG90eXBlLmdldFF1ZXVlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5xdWV1ZTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRRdWV1ZVRpbWVzdGFtcCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkucXVldWVUaW1lc3RhbXA7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNvbm5lY3Rpb25zLm1hcChmdW5jdGlvbiAoY29ubkRhdGEpIHsKICAgICAgaWYgKHNlbGYuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLkNIQVQpIHsKICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ2hhdENvbm5lY3Rpb24oc2VsZi5jb250YWN0SWQsIGNvbm5EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICAgIH0gZWxzZSBpZiAoc2VsZi5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29udGFjdFR5cGUuVEFTSykgewogICAgICAgIHJldHVybiBuZXcgY29ubmVjdC5UYXNrQ29ubmVjdGlvbihzZWxmLmNvbnRhY3RJZCwgY29ubkRhdGEuY29ubmVjdGlvbklkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuVm9pY2VDb25uZWN0aW9uKHNlbGYuY29udGFjdElkLCBjb25uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgICB9CiAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRJbml0aWFsQ29ubmVjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmZpbmQodGhpcy5nZXRDb25uZWN0aW9ucygpLCBmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubi5pc0luaXRpYWxDb25uZWN0aW9uKCk7CiAgICB9KSB8fCBudWxsOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldEFjdGl2ZUluaXRpYWxDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGluaXRpYWxDb25uID0gdGhpcy5nZXRJbml0aWFsQ29ubmVjdGlvbigpOwogICAgaWYgKGluaXRpYWxDb25uICE9IG51bGwgJiYgaW5pdGlhbENvbm4uaXNBY3RpdmUoKSkgewogICAgICByZXR1cm4gaW5pdGlhbENvbm47CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRUaGlyZFBhcnR5Q29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25uZWN0aW9ucygpLmZpbHRlcihmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gIWNvbm4uaXNJbml0aWFsQ29ubmVjdGlvbigpICYmIGNvbm4uZ2V0VHlwZSgpICE9PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLkFHRU5UOwogICAgfSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0U2luZ2xlQWN0aXZlVGhpcmRQYXJ0eUNvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRUaGlyZFBhcnR5Q29ubmVjdGlvbnMoKS5maWx0ZXIoZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm4uaXNBY3RpdmUoKTsKICAgIH0pWzBdIHx8IG51bGw7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0QWdlbnRDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuZmluZCh0aGlzLmdldENvbm5lY3Rpb25zKCksIGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHZhciBjb25uVHlwZSA9IGNvbm4uZ2V0VHlwZSgpOwogICAgICByZXR1cm4gY29ublR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuQUdFTlQgfHwgY29ublR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuTU9OSVRPUklORzsKICAgIH0pOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldE5hbWUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLm5hbWU7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29udGFjdE1ldGFkYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb250YWN0TWV0YWRhdGE7CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5nZXREZXNjcmlwdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuZGVzY3JpcHRpb247CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0UmVmZXJlbmNlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkucmVmZXJlbmNlczsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRBdHRyaWJ1dGVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5hdHRyaWJ1dGVzOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENvbnRhY3RGZWF0dXJlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuY29udGFjdEZlYXR1cmVzOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmlzU29mdHBob25lQ2FsbCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmZpbmQodGhpcy5nZXRDb25uZWN0aW9ucygpLCBmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubi5nZXRTb2Z0cGhvbmVNZWRpYUluZm8oKSAhPSBudWxsOwogICAgfSkgIT0gbnVsbDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5faXNJbmJvdW5kID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGluaXRpYXRpb25NZXRob2QgPSB0aGlzLl9nZXREYXRhKCkuaW5pdGlhdGlvbk1ldGhvZDsKICAgIHJldHVybiAoaW5pdGlhdGlvbk1ldGhvZCA9PT0gY29ubmVjdC5Db250YWN0SW5pdGlhdGlvbk1ldGhvZC5PVVRCT1VORCkgPyBmYWxzZSA6IHRydWU7CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5pc0luYm91bmQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29ubiA9IHRoaXMuZ2V0SW5pdGlhbENvbm5lY3Rpb24oKTsKCiAgICAvLyBXZSB3aWxsIGdyYWR1YWxseSBjaGFuZ2UgY2hlY2tpbmcgaW5ib3VuZCBieSByZWx5aW5nIG9uIGNvbnRhY3QgaW5pdGlhdGlvbk1ldGhvZAogICAgaWYgKGNvbm4uZ2V0TWVkaWFUeXBlKCkgPT09IGNvbm5lY3QuTWVkaWFUeXBlLlRBU0spIHsKICAgICAgcmV0dXJuIHRoaXMuX2lzSW5ib3VuZCgpOwogICAgfQoKICAgIHJldHVybiBjb25uID8gY29ubi5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuSU5CT1VORCA6IGZhbHNlOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmlzQ29ubmVjdGVkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkNPTk5FQ1RFRDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5hY2NlcHQgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNvbnRhY3RJZCA9IHRoaXMuZ2V0Q29udGFjdElkKCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQUNDRVBUX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiBjb250YWN0SWQKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgICAgICBldmVudDogY29ubmVjdC5Db250YWN0RXZlbnRzLkFDQ0VQVEVELAogICAgICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkKICAgICAgICAgIH0pOwogICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgICAgIGV2ZW50OiBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQsIHNlbGYuZ2V0Q29udGFjdElkKCkpLAogICAgICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkKICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIEluIEZpcmVmb3gsIHRoZXJlJ3MgYSBicm93c2VyIHJlc3RyaWN0aW9uIHRoYXQgYW4gdW5mb2N1c2VkIGJyb3dzZXIgdGFiIGlzIG5vdCBhbGxvd2VkIHRvIGFjY2VzcyB0aGUgdXNlcidzIG1pY3JvcGhvbmUuCiAgICAgICAgICAvLyBUaGUgcHJvYmxlbSBpcyB0aGF0IHRoZSByZXN0cmljdGlvbiBjb3VsZCBjYXVzZSBhIHdlYnJ0YyBzZXNzaW9uIGNyZWF0aW9uIHRpbWVvdXQgZXJyb3Igd2hlbiB5b3UgZ2V0IGFuIGluY29taW5nIGNhbGwgd2hpbGUgeW91IGFyZSBub3Qgb24gdGhlIHByaW1hcnkgdGFiLgogICAgICAgICAgLy8gSXQgd2FzIGhhcmQgdG8gd29ya2Fyb3VuZCB0aGUgaXNzdWUgZXNwZWNpYWxseSB3aGVuIHlvdSBoYXZlIG11bHRpcGxlIHRhYnMgb3BlbiBiZWNhdXNlIHlvdSBuZWVkZWQgdG8gZmluZCB0aGUgcmlnaHQgdGFiIGFuZCBhY2NlcHQgdGhlIGNvbnRhY3QgYmVmb3JlIHRoZSB0aW1lb3V0LgogICAgICAgICAgLy8gVG8gYXZvaWQgdGhlIGVycm9yLCB3aGVuIG11bHRpcGxlIHRhYnMgYXJlIG9wZW4gaW4gRmlyZWZveCwgYSB3ZWJydGMgc2Vzc2lvbiBpcyBub3QgaW1tZWRpYXRlbHkgY3JlYXRlZCBhcyBhbiBpbmNvbWluZyBzb2Z0cGhvbmUgY29udGFjdCBpcyBkZXRlY3RlZC4KICAgICAgICAgIC8vIEluc3RlYWQsIGl0IHdhaXRzIHVudGlsIGNvbnRhY3QuYWNjZXB0KCkgaXMgY2FsbGVkIG9uIGEgdGFiIGFuZCBsZXRzIHRoZSB0YWIgYmVjb21lIHRoZSBuZXcgcHJpbWFyeSB0YWIgYW5kIHN0YXJ0IHRoZSB3ZWIgcnRjIHNlc3Npb24gdGhlcmUKICAgICAgICAgIC8vIGJlY2F1c2UgdGhlIHRhYiBzaG91bGQgYmUgZm9jdXNlZCBhdCB0aGUgbW9tZW50IGFuZCBoYXZlIGFjY2VzcyB0byB0aGUgdXNlcidzIG1pY3JvcGhvbmUuCiAgICAgICAgICB2YXIgY29udGFjdCA9IG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKTsKICAgICAgICAgIGlmIChjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIoKSAmJiBjb250YWN0LmlzU29mdHBob25lQ2FsbCgpKSB7CiAgICAgICAgICAgIGNvbm5lY3QuY29yZS50cmlnZ2VyUmVhZHlUb1N0YXJ0U2Vzc2lvbkV2ZW50KCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3Muc3VjY2VzcykgewogICAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGNhbGxiYWNrcyA/IGNhbGxiYWNrcy5mYWlsdXJlIDogbnVsbAogICAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJjb250YWN0LmRlc3Ryb3koKSBoYXMgYmVlbiBkZXByZWNhdGVkLiIpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnJlamVjdCA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuUkVKRUNUX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnJlamVjdCA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuUkVKRUNUX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmNvbXBsZXRlID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DT01QTEVURV9DT05UQUNULCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ0xFQVJfQ09OVEFDVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUubm90aWZ5SXNzdWUgPSBmdW5jdGlvbiAoaXNzdWVDb2RlLCBkZXNjcmlwdGlvbiwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLk5PVElGWV9DT05UQUNUX0lTU1VFLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgaXNzdWVDb2RlOiBpc3N1ZUNvZGUsCiAgICAgIGRlc2NyaXB0aW9uOiBkZXNjcmlwdGlvbgogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5hZGRDb25uZWN0aW9uID0gZnVuY3Rpb24gKGVuZHBvaW50SW4sIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBlbmRwb2ludCA9IG5ldyBjb25uZWN0LkVuZHBvaW50KGVuZHBvaW50SW4pOwogICAgLy8gSGF2ZSB0byByZW1vdmUgdGhlIGVuZHBvaW50SWQgZmllbGQgb3IgQVdTIEpTIFNESyBnZXRzIG1hZC4KICAgIGRlbGV0ZSBlbmRwb2ludC5lbmRwb2ludElkOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfQURESVRJT05BTF9DT05ORUNUSU9OLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgZW5kcG9pbnQ6IGVuZHBvaW50CiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnRvZ2dsZUFjdGl2ZUNvbm5lY3Rpb25zID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBjb25uZWN0aW9uSWQgPSBudWxsOwogICAgdmFyIGhvbGRpbmdDb25uID0gY29ubmVjdC5maW5kKHRoaXMuZ2V0Q29ubmVjdGlvbnMoKSwgZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm4uZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkhPTEQ7CiAgICB9KTsKCiAgICBpZiAoaG9sZGluZ0Nvbm4gIT0gbnVsbCkgewogICAgICBjb25uZWN0aW9uSWQgPSBob2xkaW5nQ29ubi5nZXRDb25uZWN0aW9uSWQoKTsKCiAgICB9IGVsc2UgewogICAgICB2YXIgYWN0aXZlQ29ubnMgPSB0aGlzLmdldENvbm5lY3Rpb25zKCkuZmlsdGVyKGZ1bmN0aW9uIChjb25uKSB7CiAgICAgICAgcmV0dXJuIGNvbm4uaXNBY3RpdmUoKTsKICAgICAgfSk7CiAgICAgIGlmIChhY3RpdmVDb25ucy5sZW5ndGggPiAwKSB7CiAgICAgICAgY29ubmVjdGlvbklkID0gYWN0aXZlQ29ubnNbMF0uZ2V0Q29ubmVjdGlvbklkKCk7CiAgICAgIH0KICAgIH0KCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuVE9HR0xFX0FDVElWRV9DT05ORUNUSU9OUywgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogY29ubmVjdGlvbklkCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnNlbmRTb2Z0cGhvbmVNZXRyaWNzID0gZnVuY3Rpb24gKHNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MsIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuU0VORF9TT0ZUUEhPTkVfQ0FMTF9NRVRSSUNTLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2NwVmVyc2lvbjogZ2xvYmFsLmNjcFZlcnNpb24sCiAgICAgIHNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3M6IHNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MKICAgIH0sIGNhbGxiYWNrcyk7CgogICAgY29ubmVjdC5wdWJsaXNoU29mdHBob25lU3RhdHMoewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNjcFZlcnNpb246IGdsb2JhbC5jY3BWZXJzaW9uLAogICAgICBzdGF0czogc29mdHBob25lU3RyZWFtU3RhdGlzdGljcwogICAgfSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuc2VuZFNvZnRwaG9uZVJlcG9ydCA9IGZ1bmN0aW9uIChyZXBvcnQsIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX1NPRlRQSE9ORV9DQUxMX1JFUE9SVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNjcFZlcnNpb246IGdsb2JhbC5jY3BWZXJzaW9uLAogICAgICByZXBvcnQ6IHJlcG9ydAogICAgfSwgY2FsbGJhY2tzKTsKCiAgICBjb25uZWN0LnB1Ymxpc2hTb2Z0cGhvbmVSZXBvcnQoewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNjcFZlcnNpb246IGdsb2JhbC5jY3BWZXJzaW9uLAogICAgICByZXBvcnQ6IHJlcG9ydAogICAgfSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuY29uZmVyZW5jZUNvbm5lY3Rpb25zID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DT05GRVJFTkNFX0NPTk5FQ1RJT05TLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS50b1NuYXBzaG90ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkNvbnRhY3RTbmFwc2hvdCh0aGlzLl9nZXREYXRhKCkpOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbnRhY3RTbmFwc2hvdAogICAqLwogIHZhciBDb250YWN0U25hcHNob3QgPSBmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgIGNvbm5lY3QuQ29udGFjdC5jYWxsKHRoaXMsIGNvbnRhY3REYXRhLmNvbnRhY3RJZCk7CiAgICB0aGlzLmNvbnRhY3REYXRhID0gY29udGFjdERhdGE7CiAgfTsKICBDb250YWN0U25hcHNob3QucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb250YWN0LnByb3RvdHlwZSk7CiAgQ29udGFjdFNuYXBzaG90LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENvbnRhY3RTbmFwc2hvdDsKCiAgQ29udGFjdFNuYXBzaG90LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbnRhY3REYXRhOwogIH07CgogIENvbnRhY3RTbmFwc2hvdC5wcm90b3R5cGUuX2NyZWF0ZUNvbm5lY3Rpb25BUEkgPSBmdW5jdGlvbiAoY29ubmVjdGlvbkRhdGEpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db25uZWN0aW9uU25hcHNob3QoY29ubmVjdGlvbkRhdGEpOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbm5lY3Rpb24KICAgKi8KICB2YXIgQ29ubmVjdGlvbiA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgdGhpcy5jb250YWN0SWQgPSBjb250YWN0SWQ7CiAgICB0aGlzLmNvbm5lY3Rpb25JZCA9IGNvbm5lY3Rpb25JZDsKICAgIHRoaXMuX2luaXRNZWRpYUNvbnRyb2xsZXIoKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb25uZWN0aW9uRGF0YSgKICAgICAgdGhpcy5nZXRDb250YWN0SWQoKSwgdGhpcy5nZXRDb25uZWN0aW9uSWQoKSk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Q29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29udGFjdElkOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldENvbm5lY3Rpb25JZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbm5lY3Rpb25JZDsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRFbmRwb2ludCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5FbmRwb2ludCh0aGlzLl9nZXREYXRhKCkuZW5kcG9pbnQpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldEFkZHJlc3MgPSBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRFbmRwb2ludDsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnN0YXRlOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXR1cyA9IENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXRlOwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Qubm93KCkgLSB0aGlzLl9nZXREYXRhKCkuc3RhdGUudGltZXN0YW1wLmdldFRpbWUoKSArIGNvbm5lY3QuY29yZS5nZXRTa2V3KCk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdHVzRHVyYXRpb24gPSBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uOwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS50eXBlOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmlzSW5pdGlhbENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmluaXRpYWw7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNBY3RpdmUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb250YWlucyhjb25uZWN0LkNPTk5FQ1RJT05fQUNUSVZFX1NUQVRFUywgdGhpcy5nZXRTdGF0dXMoKS50eXBlKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5pc0Nvbm5lY3RlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNURUQ7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNDb25uZWN0aW5nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RJTkc7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNPbkhvbGQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuSE9MRDsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTb2Z0cGhvbmVNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNvZnRwaG9uZU1lZGlhSW5mbzsKICB9OwoKICAvKioKICAgKiBHZXRzIHRoZSBjdXJyZW50bHkgbW9uaXRvcmVkIGNvbnRhY3QgaW5mbywgUmV0dXJucyBudWxsIGlmIGRvZXMgbm90IGV4aXN0cy4KICAgKiBAcmV0dXJuIHt7YWdlbnROYW1lOnN0cmluZywgY3VzdG9tZXJOYW1lOnN0cmluZywgam9pblRpbWU6RGF0ZX19CiAgICovCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TW9uaXRvckluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLm1vbml0b3JpbmdJbmZvOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkRFU1RST1lfQ09OTkVDVElPTiwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5zZW5kRGlnaXRzID0gZnVuY3Rpb24gKGRpZ2l0cywgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfRElHSVRTLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY29ubmVjdGlvbklkOiB0aGlzLmdldENvbm5lY3Rpb25JZCgpLAogICAgICBkaWdpdHM6IGRpZ2l0cwogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5ob2xkID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5IT0xEX0NPTk5FQ1RJT04sIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUucmVzdW1lID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5SRVNVTUVfQ09OTkVDVElPTiwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS50b1NuYXBzaG90ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkNvbm5lY3Rpb25TbmFwc2hvdCh0aGlzLl9nZXREYXRhKCkpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLl9pbml0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMuZ2V0TWVkaWFJbmZvKCkpIHsKICAgICAgY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcykuY2F0Y2goZnVuY3Rpb24gKCkgeyB9KTsKICAgIH0KICB9CgogIC8vIE1ldGhvZCBmb3IgY2hlY2tpbmcgd2hldGhlciB0aGlzIGNvbm5lY3Rpb24gaXMgYW4gYWdlbnQtc2lkZSBjb25uZWN0aW9uIAogIC8vICh0eXBlIEFHRU5UIG9yIE1PTklUT1JJTkcpCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuX2lzQWdlbnRDb25uZWN0aW9uVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBjb25uZWN0aW9uVHlwZSA9IHRoaXMuZ2V0VHlwZSgpOwogICAgcmV0dXJuIGNvbm5lY3Rpb25UeXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLkFHRU5UIAogICAgICB8fCBjb25uZWN0aW9uVHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5NT05JVE9SSU5HOwogIH0KCiAgLyoqCiAgICogVXRpbGl0eSBtZXRob2QgZm9yIGNoZWNraW5nIHdoZXRoZXIgdGhpcyBjb25uZWN0aW9uIGlzIGFuIGFnZW50LXNpZGUgY29ubmVjdGlvbiAKICAgKiAodHlwZSBBR0VOVCBvciBNT05JVE9SSU5HKQogICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhpcyBjb25uZWN0aW9uIGlzIGFuIGFnZW50LXNpZGUgY29ubmVjdGlvbi4gRmFsc2Ugb3RoZXJ3aXNlLgogICAqLwogIENvbm5lY3Rpb24ucHJvdG90eXBlLl9pc0FnZW50Q29ubmVjdGlvblR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29ubmVjdGlvblR5cGUgPSB0aGlzLmdldFR5cGUoKTsKICAgIHJldHVybiBjb25uZWN0aW9uVHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5BR0VOVCAKICAgICAgfHwgY29ubmVjdGlvblR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuTU9OSVRPUklORzsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogVm9pY2UgYXV0aGVudGljYXRvciBWb2ljZUlkCiAgKi8KIAogIHZhciBWb2ljZUlkID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgdGhpcy5jb250YWN0SWQgPSBjb250YWN0SWQ7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuZ2V0U3BlYWtlcklkID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuR0VUX1NQRUFLRVJfSUQsIHsKICAgICAgICAiY29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgImF3c0FjY291bnRJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFXU0FjY291bnRJZCgpCiAgICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgaWYoZGF0YS5jb250YWN0RGF0YS5jdXN0b21lcklkKSB7CiAgICAgICAgICAgICAgdmFyIG9iaiA9IHsKICAgICAgICAgICAgICAgIHNwZWFrZXJJZDogZGF0YS5jb250YWN0RGF0YS5jdXN0b21lcklkCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc29sdmUob2JqKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLk5PX1NQRUFLRVJfSURfRk9VTkQsICJObyBzcGVha2VySWQgYXNzb3RpYXRlZCB3aXRoIHRoaXMgY2FsbCIpOwogICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICB9LAogICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJHZXQgU3BlYWtlcklkIGZhaWxlZCIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgZXJyOiBlcnIKICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkdFVF9TUEVBS0VSX0lEX0ZBSUxFRCwgIkdldCBTcGVha2VySWQgZmFpbGVkIiwgZXJyKTsKICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLmdldFNwZWFrZXJTdGF0dXMgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldFNwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuR0VUX1NQRUFLRVJfU1RBVFVTLCB7CiAgICAgICAgICAiU3BlYWtlcklkIjogY29ubmVjdC5hc3NlcnROb3ROdWxsKGRhdGEuc3BlYWtlcklkLCAnc3BlYWtlcklkJyksCiAgICAgICAgICAiRG9tYWluSWQiIDogIkNvbm5lY3REZWZhdWx0RG9tYWluSWQiCiAgICAgICAgICB9LCB7CiAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIGNvbnN0IHBhcnNlZEVyciA9IEpTT04ucGFyc2UoZXJyKTsKICAgICAgICAgICAgICBpZiAocGFyc2VkRXJyLnN0YXR1cyA9PT0gNDAwKSB7CiAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IHBhcnNlZEVycjsKICAgICAgICAgICAgICAgIGRhdGEudHlwZSA9IGRhdGEudHlwZSA/IGRhdGEudHlwZSA6IGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU1BFQUtFUl9JRF9OT1RfRU5ST0xMRUQ7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlNwZWFrZXIgaXMgbm90IGVucm9sbGVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJnZXRTcGVha2VyU3RhdHVzIGZhaWxlZCIpCiAgICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgICBlcnI6IGVycgogICAgICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5HRVRfU1BFQUtFUl9TVEFUVVNfRkFJTEVELCAiR2V0IFNwZWFrZXJTdGF0dXMgZmFpbGVkIiwgZXJyKTsKICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICByZWplY3QoZXJyKTsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5vcHRPdXRTcGVha2VyID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgc2VsZi5nZXRTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLk9QVF9PVVRfVk9JQ0VJRF9TUEVBS0VSLCB7CiAgICAgICAgICAiU3BlYWtlcklkIjogY29ubmVjdC5hc3NlcnROb3ROdWxsKGRhdGEuc3BlYWtlcklkLCAnc3BlYWtlcklkJyksCiAgICAgICAgICAiRG9tYWluSWQiIDogIkNvbm5lY3REZWZhdWx0RG9tYWluSWQiCiAgICAgICAgICB9LCB7CiAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJvcHRPdXRTcGVha2VyIHN1Y2NlZWRlZCIpOwogICAgICAgICAgICAgIC8vVE9ETyBhZGQgbW9yZSBsb2dpYyBoZXJlIGZvciBmaWx0ZXJpbmcgb3V0IGRhdGEgb25jZSBWb2ljZUlkIEFQSSBmaW5hbGl6ZWQKICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigib3B0T3V0U3BlYWtlciBmYWlsZWQiKQogICAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5PUFRfT1VUX1NQRUFLRVJfRkFJTEVELCAib3B0T3V0U3BlYWtlciBmYWlsZWQuIiwgZXJyKTsKICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICByZWplY3QoZXJyKTsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5kZWxldGVTcGVha2VyID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgc2VsZi5nZXRTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkRFTEVURV9WT0lDRUlEX1NQRUFLRVIsIHsKICAgICAgICAgICJTcGVha2VySWQiOiBjb25uZWN0LmFzc2VydE5vdE51bGwoZGF0YS5zcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAgICJEb21haW5JZCIgOiAiQ29ubmVjdERlZmF1bHREb21haW5JZCIKICAgICAgICAgIH0sIHsKICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImRlbGV0ZVNwZWFrZXIgc3VjY2VlZGVkIik7CiAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImRlbGV0ZVNwZWFrZXIgZmFpbGVkIikKICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuREVMRVRFX1NQRUFLRVJfRkFJTEVELCAiZGVsZXRlU3BlYWtlciBmYWlsZWQuIiwgZXJyKTsKICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICByZWplY3QoZXJyKTsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5zdGFydFNlc3Npb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5TVEFSVF9WT0lDRUlEX1NFU1NJT04sIHsKICAgICAgICAiY29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgImN1c3RvbWVyQWNjb3VudElkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0QVdTQWNjb3VudElkKCksCiAgICAgICAgImNsaWVudFRva2VuIjogQVdTLnV0aWwudXVpZC52NCgpCiAgICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgaWYoZGF0YS5zZXNzaW9uSWQpIHsKICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlamVjdChFcnJvcigiTm8gY29udGFjdCBpZCBpcyByZXR1cm5lZCBmcm9tIHN0YXJ0IHNlc3Npb24gYXBpLiIpKQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJzdGFydFZvaWNlSWRTZXNzaW9uIGZhaWxlZCIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgZXJyOiBlcnIKICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlNUQVJUX1NFU1NJT05fRkFJTEVELCAic3RhcnRWb2ljZUlkU2Vzc2lvbiBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuZXZhbHVhdGVTcGVha2VyID0gZnVuY3Rpb24gKHN0YXJ0TmV3KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICB2YXIgbWF4UG9sbFRpbWVzID0gMTIwOyAvLyBQb2xsaW5nIGZvciBtYXhpbXVtIDIgbWlucy4KICAgIHZhciBtaWxsaUludGVydmFsID0gMTAwMDsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGZ1bmN0aW9uIGV2YWx1YXRlKCkgewogICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkVWQUxVQVRFX1NQRUFLRVJfV0lUSF9WT0lDRUlELCB7CiAgICAgICAgICAiU2Vzc2lvbk5hbWVPcklkIjogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCB0aGlzLmNvbnRhY3RJZCwKICAgICAgICAgICJEb21haW5JZCIgOiAiQ29ubmVjdERlZmF1bHREb21haW5JZCIKICAgICAgICB9LCB7CiAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICBpZihtYXhQb2xsVGltZXMtLSAhPT0gMSkgewogICAgICAgICAgICAgIGlmKGRhdGEuU3RyZWFtaW5nU3RhdHVzID09PSBjb25uZWN0LlZvaWNlSWRTdHJlYW1pbmdTdGF0dXMuUEVORElOR19DT05GSUdVUkFUSU9OKSB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGV2YWx1YXRlLCBtaWxsaUludGVydmFsKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYoIWRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdCA9IHt9OwogICAgICAgICAgICAgICAgICBkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uTk9UX0VOQUJMRUQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYoIWRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdCA9IHt9OwogICAgICAgICAgICAgICAgICBkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0ZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uTk9UX0VOQUJMRUQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy9SZXNvbHZlIGlmIGJvdGggYXV0aGVudGljYXRpb24gYW5kIGZyYXVkIGRldGVjdGlvbiBhcmUgbm90IGVuYWJsZWQuCiAgICAgICAgICAgICAgICBpZighc2VsZi5pc0F1dGhFbmFibGVkKGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24pICYmIAogICAgICAgICAgICAgICAgICAhc2VsZi5pc0ZyYXVkRW5hYmxlZChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSkgewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmKGRhdGEuU3RyZWFtaW5nU3RhdHVzID09PSBjb25uZWN0LlZvaWNlSWRTdHJlYW1pbmdTdGF0dXMuRU5ERUQpIHsKICAgICAgICAgICAgICAgICAgaWYoc2VsZi5pc0F1dGhSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICBkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uSU5DT05DTFVTSVZFOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmKHNlbGYuaXNGcmF1ZFJlc3VsdE5vdEVub3VnaFNwZWVjaChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSkgewogICAgICAgICAgICAgICAgICAgIGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5JTkNPTkNMVVNJVkU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIFZvaWNlIHByaW50IGlzIG5vdCBsb25nIGVub3VnaCBmb3IgYm90aCBhdXRoZW50aWNhdGlvbiBhbmQgZnJhdWQgZGV0ZWN0aW9uCiAgICAgICAgICAgICAgICBpZihzZWxmLmlzQXV0aFJlc3VsdEluY29uY2x1c2l2ZShkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uKSAmJgogICAgICAgICAgICAgICAgICBzZWxmLmlzRnJhdWRSZXN1bHRJbmNvbmNsdXNpdmUoZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZighc2VsZi5pc0F1dGhSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikgJiYgCiAgICAgICAgICAgICAgICAgIHNlbGYuaXNBdXRoRW5hYmxlZChkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uKSkgewogICAgICAgICAgICAgICAgICBzd2l0Y2ggKGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24pIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEF1dGhlbnRpY2F0aW9uRGVjaXNpb24uQUNDRVBUOgogICAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLkFVVEhFTlRJQ0FURUQ7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEF1dGhlbnRpY2F0aW9uRGVjaXNpb24uUkVKRUNUOgogICAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLk5PVF9BVVRIRU5USUNBVEVEOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBjb25uZWN0LlZvaWNlSWRBdXRoZW50aWNhdGlvbkRlY2lzaW9uLlNQRUFLRVJfT1BURURfT1VUOgogICAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLk9QVEVEX09VVDsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkQXV0aGVudGljYXRpb25EZWNpc2lvbi5TUEVBS0VSX05PVF9FTlJPTExFRDoKICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5OT1RfRU5ST0xMRUQ7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLkVSUk9SOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYoIXNlbGYuaXNGcmF1ZFJlc3VsdE5vdEVub3VnaFNwZWVjaChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSAmJiAKICAgICAgICAgICAgICAgICAgc2VsZi5pc0ZyYXVkRW5hYmxlZChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSkgewogICAgICAgICAgICAgICAgICBzd2l0Y2ggKGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24pIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uSElHSF9SSVNLOgogICAgICAgICAgICAgICAgICAgICAgZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLkhJR0hfUklTSzsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkRnJhdWREZXRlY3Rpb25EZWNpc2lvbi5MT1dfUklTSzoKICAgICAgICAgICAgICAgICAgICAgIGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5MT1dfUklTSzsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0ZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uRVJST1I7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZighc2VsZi5pc0F1dGhSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikgJiYKICAgICAgICAgICAgICAgICAgIXNlbGYuaXNGcmF1ZFJlc3VsdE5vdEVub3VnaFNwZWVjaChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSkgewogICAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmUgb25seSB3aGVuIGJvdGggYXV0aGVudGljYXRpb24gYW5kIGZyYXVkIGRldGVjdGlvbiBoYXZlIHJlc3VsdHMuIE90aGVyd2lzZSwga2VlcCBwb2xsaW5nLgogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChldmFsdWF0ZSwgbWlsbGlJbnRlcnZhbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImV2YWx1YXRlU3BlYWtlciB0aW1lb3V0Iikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlRJTUVPVVQsICJldmFsdWF0ZVNwZWFrZXIgdGltZW91dCIpOwogICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImV2YWx1YXRlU3BlYWtlciBmYWlsZWQiKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgIGVycjogZXJyCiAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5FVkFMVUFURV9TUEVBS0VSX0ZBSUxFRCwgImV2YWx1YXRlU3BlYWtlciBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgIH0KICAgICAgaWYoIXN0YXJ0TmV3KXsKICAgICAgICBldmFsdWF0ZSgpOwogICAgICB9IGVsc2UgewogICAgICAgIHNlbGYuc3RhcnRTZXNzaW9uKCkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICBldmFsdWF0ZSgpOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycil7CiAgICAgICAgICByZWplY3QoZXJyKQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5kZXNjcmliZVNlc3Npb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIGNvbnRhY3REYXRhID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEodGhpcy5jb250YWN0SWQpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuREVTQ1JJQkVfVk9JQ0VJRF9TRVNTSU9OLCB7CiAgICAgICAgIlNlc3Npb25OYW1lT3JJZCI6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgdGhpcy5jb250YWN0SWQsCiAgICAgICAgIkRvbWFpbklkIiA6ICJDb25uZWN0RGVmYXVsdERvbWFpbklkIgogICAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIHJlc29sdmUoZGF0YSkKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImRlc2NyaWJlU2Vzc2lvbiBmYWlsZWQiKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIKICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuREVTQ1JJQkVfU0VTU0lPTl9GQUlMRUQsICJkZXNjcmliZVNlc3Npb24gZmFpbGVkIiwgZXJyKTsKICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgfQogICAgICB9KQogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuY2hlY2tFbnJvbGxtZW50U3RhdHVzID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIG1heFBvbGxpbmdUaW1lcyA9IDEyMDsgLy8gSXQgaXMgcG9sbGluZyBmb3IgbWF4aW11bSAxMCBtaW5zLgogICAgdmFyIG1pbGxpSW50ZXJ2YWwgPSA1MDAwOwoKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlICgpIHsKICAgICAgICBpZihtYXhQb2xsaW5nVGltZXMtLSAhPT0gMSkgewogICAgICAgICAgc2VsZi5kZXNjcmliZVNlc3Npb24oKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICBzd2l0Y2goZGF0YS5TZXNzaW9uLkVucm9sbG1lbnRSZXF1ZXN0RGV0YWlscy5TdGF0dXMpIHsKICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLkNPTVBMRVRFRDoKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLklOX1BST0dSRVNTOgogICAgICAgICAgICAgICAgc2V0VGltZW91dChkZXNjcmliZSwgbWlsbGlJbnRlcnZhbCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLk5PVF9FTk9VR0hfU1BFRUNIOgogICAgICAgICAgICAgICAgaWYoZGF0YS5TZXNzaW9uLlN0cmVhbWluZ1N0YXR1cyAhPT0gY29ubmVjdC5Wb2ljZUlkU3RyZWFtaW5nU3RhdHVzLkVOREVEKSB7CiAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZGVzY3JpYmUsbWlsbGlJbnRlcnZhbCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzZWxmLnN0YXJ0U2Vzc2lvbigpLnRoZW4oZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgICAgICAgIGRlc2NyaWJlKCk7CiAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVyciwgZGF0YSl7CiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJlamVjdChFcnJvcihkYXRhLlNlc3Npb24uRW5yb2xsbWVudFJlcXVlc3REZXRhaWxzLlN0YXR1cykpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZGVzY3JpYmVTZXNzaW9uIHRpbWVvdXQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5USU1FT1VULCAiZGVzY3JpYmVTZXNzaW9uIHRpbWVvdXQiKTsKICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGRlc2NyaWJlKCk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5lbnJvbGxTcGVha2VyID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuZ2V0U3BlYWtlclN0YXR1cygpLnRoZW4oZnVuY3Rpb24oZGF0YSkgewogICAgICAgIHJldHVybiBkYXRhOwogICAgICB9KS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICBpZihkYXRhLlNwZWFrZXIgJiYgZGF0YS5TcGVha2VyLlN0YXR1cyA9PSBjb25uZWN0LlZvaWNlSWRTcGVha2VyU3RhdHVzLk9QVEVEX09VVCkgewogICAgICAgICAgc2VsZi5kZWxldGVTcGVha2VyKCkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgIHNlbGYuZW5yb2xsU3BlYWtlckhlbHBlcihyZXNvbHZlLCByZWplY3QpOwogICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYuZW5yb2xsU3BlYWtlckhlbHBlcihyZXNvbHZlLCByZWplY3QpOwogICAgICAgIH0KICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pCiAgICB9KQogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuZW5yb2xsU3BlYWtlckhlbHBlciA9IGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5FTlJPTExfU1BFQUtFUl9JTl9WT0lDRUlELCB7CiAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAiRG9tYWluSWQiIDogIkNvbm5lY3REZWZhdWx0RG9tYWluSWQiCiAgICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYoZGF0YS5TdGF0dXMgPT09IGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLkNPTVBMRVRFRCkgewogICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZi5jaGVja0Vucm9sbG1lbnRTdGF0dXMoKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycil7CiAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgIH0pCiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJlbnJvbGxTcGVha2VyIGZhaWxlZCIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVycgogICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5FTlJPTExfU1BFQUtFUl9GQUlMRUQsICJlbnJvbGxTcGVha2VyIGZhaWxlZCIsIGVycik7CiAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgIH0KICAgICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUudXBkYXRlU3BlYWtlcklkID0gZnVuY3Rpb24gKHNwZWFrZXJJZCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIGNvbnRhY3REYXRhID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEodGhpcy5jb250YWN0SWQpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuVVBEQVRFX1ZPSUNFSURfU0VTU0lPTiwgewogICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICJTcGVha2VySWQiOiBjb25uZWN0LmFzc2VydE5vdE51bGwoc3BlYWtlcklkLCAnc3BlYWtlcklkJyksCiAgICAgICAgIkRvbWFpbklkIiA6ICJDb25uZWN0RGVmYXVsdERvbWFpbklkIgogICAgICAgIH0sIHsKICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICB9LAogICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJ1cGRhdGVTcGVha2VySWQgZmFpbGVkIikKICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICBlcnI6IGVycgogICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuVVBEQVRFX1NQRUFLRVJfSURfRkFJTEVELCAidXBkYXRlU3BlYWtlcklkIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5jaGVja0NvbmZlcmVuY2VDYWxsID0gZnVuY3Rpb24oKXsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBpc0NvbmZlcmVuY2VDYWxsID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEoc2VsZi5jb250YWN0SWQpLmNvbm5lY3Rpb25zLmZpbHRlcihmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubmVjdC5jb250YWlucyhjb25uZWN0LkNPTk5FQ1RJT05fQUNUSVZFX1NUQVRFUywgY29ubi5zdGF0ZS50eXBlKTsKICAgIH0pLmxlbmd0aCA+IDI7CiAgICBpZihpc0NvbmZlcmVuY2VDYWxsKXsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvcigiVm9pY2VJZCBpcyBub3Qgc3VwcG9ydGVkIGZvciBjb25mZXJlbmNlIGNhbGxzIik7CiAgICB9CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5pc0F1dGhFbmFibGVkID0gZnVuY3Rpb24oYXV0aFJlc3VsdCkgewogICAgcmV0dXJuIGF1dGhSZXN1bHQgIT09IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLk5PVF9FTkFCTEVEOwogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuaXNBdXRoUmVzdWx0Tm90RW5vdWdoU3BlZWNoID0gZnVuY3Rpb24oYXV0aFJlc3VsdCkgewogICAgcmV0dXJuIGF1dGhSZXN1bHQgPT09IGNvbm5lY3QuVm9pY2VJZEF1dGhlbnRpY2F0aW9uRGVjaXNpb24uTk9UX0VOT1VHSF9TUEVFQ0g7CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5pc0F1dGhSZXN1bHRJbmNvbmNsdXNpdmUgPSBmdW5jdGlvbihhdXRoUmVzdWx0KSB7CiAgICByZXR1cm4gYXV0aFJlc3VsdCA9PT0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uSU5DT05DTFVTSVZFOwogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuaXNGcmF1ZEVuYWJsZWQgPSBmdW5jdGlvbihmcmF1ZFJlc3VsdCkgewogICAgcmV0dXJuIGZyYXVkUmVzdWx0ICE9PSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5OT1RfRU5BQkxFRDsKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmlzRnJhdWRSZXN1bHROb3RFbm91Z2hTcGVlY2ggPSBmdW5jdGlvbihmcmF1ZFJlc3VsdCkgewogICAgcmV0dXJuIGZyYXVkUmVzdWx0ID09PSBjb25uZWN0LlZvaWNlSWRGcmF1ZERldGVjdGlvbkRlY2lzaW9uLk5PVF9FTk9VR0hfU1BFRUNIOwogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuaXNGcmF1ZFJlc3VsdEluY29uY2x1c2l2ZSA9IGZ1bmN0aW9uKGZyYXVkUmVzdWx0KSB7CiAgICByZXR1cm4gZnJhdWRSZXN1bHQgPT09IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLklOQ09OQ0xVU0lWRTsKICB9CgogIC8qKgogICAqIEBjbGFzcyBWb2ljZUNvbm5lY3Rpb24KICAgKiBAcGFyYW0ge251bWJlcn0gY29udGFjdElkIAogICAqIEBwYXJhbSB7bnVtYmVyfSBjb25uZWN0aW9uSWQgCiAgICogQGRlc2NyaXB0aW9uIC0gUHJvdmlkZXMgdm9pY2UgbWVkaWEgc3BlY2lmaWMgb3BlcmF0aW9ucwogICAqLwogIHZhciBWb2ljZUNvbm5lY3Rpb24gPSBmdW5jdGlvbiAoY29udGFjdElkLCBjb25uZWN0aW9uSWQpIHsKICAgIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yID0gbmV3IFZvaWNlSWQoY29udGFjdElkKTsKICAgIENvbm5lY3Rpb24uY2FsbCh0aGlzLCBjb250YWN0SWQsIGNvbm5lY3Rpb25JZCk7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29ubmVjdGlvbi5wcm90b3R5cGUpOwogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBWb2ljZUNvbm5lY3Rpb247CgogIC8qKgogICogQGRlcHJlY2F0ZWQKICAqIFBsZWFzZSB1c2UgZ2V0TWVkaWFJbmZvIAogICovCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTb2Z0cGhvbmVNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNvZnRwaG9uZU1lZGlhSW5mbzsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhSW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc29mdHBob25lTWVkaWFJbmZvOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuTWVkaWFUeXBlLlNPRlRQSE9ORTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5LmdldCh0aGlzKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Vm9pY2VJZFNwZWFrZXJJZCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLmdldFNwZWFrZXJJZCgpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRWb2ljZUlkU3BlYWtlclN0YXR1cyA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLmdldFNwZWFrZXJTdGF0dXMoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUub3B0T3V0Vm9pY2VJZFNwZWFrZXIgPSBmdW5jdGlvbigpIHsKICAgIAogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLm9wdE91dFNwZWFrZXIoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZGVsZXRlVm9pY2VJZFNwZWFrZXIgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvci5kZWxldGVTcGVha2VyKCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmV2YWx1YXRlU3BlYWtlcldpdGhWb2ljZUlkID0gZnVuY3Rpb24oc3RhcnROZXcpIHsKICAgIHJldHVybiB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvci5ldmFsdWF0ZVNwZWFrZXIoc3RhcnROZXcpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5lbnJvbGxTcGVha2VySW5Wb2ljZUlkID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fc3BlYWtlckF1dGhlbnRpY2F0b3IuZW5yb2xsU3BlYWtlcigpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS51cGRhdGVWb2ljZUlkU3BlYWtlcklkID0gZnVuY3Rpb24oc3BlYWtlcklkKSB7CiAgICByZXR1cm4gdGhpcy5fc3BlYWtlckF1dGhlbnRpY2F0b3IudXBkYXRlU3BlYWtlcklkKHNwZWFrZXJJZCk7CiAgfQoKICAvKioKICAgKiBAY2xhc3MgQ2hhdENvbm5lY3Rpb24KICAgKiBAcGFyYW0geyp9IGNvbnRhY3RJZCAKICAgKiBAcGFyYW0geyp9IGNvbm5lY3Rpb25JZCAKICAgKiBAZGVzY3JpcHRpb24gYWRkcyB0aGUgY2hhdCBtZWRpYSBzcGVjaWZpYyBmdW5jdGlvbmFsaXR5CiAgICovCiAgdmFyIENoYXRDb25uZWN0aW9uID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKSB7CiAgICBDb25uZWN0aW9uLmNhbGwodGhpcywgY29udGFjdElkLCBjb25uZWN0aW9uSWQpOwogIH07CgogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29ubmVjdGlvbi5wcm90b3R5cGUpOwogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENoYXRDb25uZWN0aW9uOwoKICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFJbmZvID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGRhdGEgPSB0aGlzLl9nZXREYXRhKCkuY2hhdE1lZGlhSW5mbzsKICAgIGlmICghZGF0YSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuY29udGFjdElkKTsKICAgICAgdmFyIG1lZGlhT2JqZWN0ID0gewogICAgICAgIGNvbnRhY3RJZDogdGhpcy5jb250YWN0SWQsCiAgICAgICAgaW5pdGlhbENvbnRhY3RJZDogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCB0aGlzLmNvbnRhY3RJZCwKICAgICAgICBwYXJ0aWNpcGFudElkOiB0aGlzLmNvbm5lY3Rpb25JZCwKICAgICAgICBnZXRDb25uZWN0aW9uVG9rZW46IGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5nZXRDb25uZWN0aW9uVG9rZW4pCiAgICAgIH07CiAgICAgIGlmIChkYXRhLmNvbm5lY3Rpb25EYXRhKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIG1lZGlhT2JqZWN0LnBhcnRpY2lwYW50VG9rZW4gPSBKU09OLnBhcnNlKGRhdGEuY29ubmVjdGlvbkRhdGEpLkNvbm5lY3Rpb25BdXRoZW50aWNhdGlvblRva2VuOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoY29ubmVjdC5Mb2dDb21wb25lbnQuQ0hBVCwgIkNvbm5lY3Rpb24gZGF0YSBpcyBpbnZhbGlkIikKICAgICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkKICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZSkKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICBtZWRpYU9iamVjdC5wYXJ0aWNpcGFudFRva2VuID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgICAgbWVkaWFPYmplY3QucGFydGljaXBhbnRUb2tlbiA9IG1lZGlhT2JqZWN0LnBhcnRpY2lwYW50VG9rZW4gfHwgbnVsbDsKICAgICAgLyoqIEp1c3QgdG8ga2VlcCB0aGUgZGF0YSBhY2Nlc3NpYmxlICovCiAgICAgIG1lZGlhT2JqZWN0Lm9yaWdpbmFsSW5mbyA9IHRoaXMuX2dldERhdGEoKS5jaGF0TWVkaWFJbmZvOwogICAgICByZXR1cm4gbWVkaWFPYmplY3Q7CiAgICB9CiAgfTsKCiAgLyoqCiAgKiBQcm92aWRlcyB0aGUgY2hhdCBjb25uZWN0aW9uVG9rZW4gdGhyb3VnaCB0aGUgY3JlYXRlX3RyYW5zcG9ydCBBUEkgZm9yIGEgc3BlY2lmaWMgY29udGFjdCBhbmQgcGFydGljaXBhbnQgSWQuIAogICogQHJldHVybnMgYSBwcm9taXNlIHdoaWNoLCB1cG9uIHN1Y2Nlc3MsIHJldHVybnMgdGhlIHJlc3BvbnNlIGZyb20gdGhlIGNyZWF0ZVRyYW5zcG9ydCBBUEkuCiAgKiBVc2FnZToKICAqIGNvbm5lY3Rpb24uZ2V0Q29ubmVjdGlvblRva2VuKCkKICAqICAudGhlbihyZXNwb25zZSA9PiB7fSkKICAqICAuY2F0Y2goZXJyb3IgPT4ge30pCiAgKi8KICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvblRva2VuID0gZnVuY3Rpb24gKCkgewogICAgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIGNvbnRhY3REYXRhID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEodGhpcy5jb250YWN0SWQpOwogICAgdmFyIHRyYW5zcG9ydERldGFpbHMgPSB7CiAgICAgIHRyYW5zcG9ydFR5cGU6IGNvbm5lY3QuVFJBTlNQT1JUX1RZUEVTLkNIQVRfVE9LRU4sCiAgICAgIHBhcnRpY2lwYW50SWQ6IHRoaXMuY29ubmVjdGlvbklkLAogICAgICBjb250YWN0SWQ6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgdGhpcy5jb250YWN0SWQKICAgIH07CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX1RSQU5TUE9SVCwgdHJhbnNwb3J0RGV0YWlscywgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImdldENvbm5lY3Rpb25Ub2tlbiBzdWNjZWVkZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldENvbm5lY3Rpb25Ub2tlbiBmYWlsZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJnZXRDb25uZWN0aW9uVG9rZW4gZmFpbGVkIikpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuTWVkaWFUeXBlLkNIQVQ7CiAgfTsKCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5LmdldCh0aGlzKTsKICB9OwoKICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuX2luaXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAvLyBOb3RlIHRoYXQgYSBjaGF0IG1lZGlhIGNvbnRyb2xsZXIgb25seSBuZWVkcyB0byBiZSBwcm9kdWNlZCBmb3IgYWdlbnQgdHlwZSBjb25uZWN0aW9ucy4KICAgIGlmICh0aGlzLl9pc0FnZW50Q29ubmVjdGlvblR5cGUoKSkgewogICAgICBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5LmdldCh0aGlzKS5jYXRjaChmdW5jdGlvbiAoKSB7IH0pOwogICAgfQogIH0KCiAgLyoqCiAgICogQGNsYXNzIFRhc2tDb25uZWN0aW9uCiAgICogQHBhcmFtIHsqfSBjb250YWN0SWQgCiAgICogQHBhcmFtIHsqfSBjb25uZWN0aW9uSWQgCiAgICogQGRlc2NyaXB0aW9uIGFkZHMgdGhlIHRhc2sgbWVkaWEgc3BlY2lmaWMgZnVuY3Rpb25hbGl0eQogICAqLwogIHZhciBUYXNrQ29ubmVjdGlvbiA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgQ29ubmVjdGlvbi5jYWxsKHRoaXMsIGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKTsKICB9OwogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29ubmVjdGlvbi5wcm90b3R5cGUpOwogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFRhc2tDb25uZWN0aW9uOwoKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuTWVkaWFUeXBlLlRBU0s7CiAgfQoKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFJbmZvID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICAgIHZhciBtZWRpYU9iamVjdCA9IHsKICAgICAgICBjb250YWN0SWQ6IHRoaXMuY29udGFjdElkLAogICAgICAgIGluaXRpYWxDb250YWN0SWQ6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgdGhpcy5jb250YWN0SWQsCiAgICAgIH07CiAgICAgIHJldHVybiBtZWRpYU9iamVjdDsKICB9OwoKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkuZ2V0KHRoaXMpOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbm5lY3Rpb25TbmFwc2hvdAogICAqLwogIHZhciBDb25uZWN0aW9uU25hcHNob3QgPSBmdW5jdGlvbiAoY29ubmVjdGlvbkRhdGEpIHsKICAgIGNvbm5lY3QuQ29ubmVjdGlvbi5jYWxsKHRoaXMsIGNvbm5lY3Rpb25EYXRhLmNvbnRhY3RJZCwgY29ubmVjdGlvbkRhdGEuY29ubmVjdGlvbklkKTsKICAgIHRoaXMuY29ubmVjdGlvbkRhdGEgPSBjb25uZWN0aW9uRGF0YTsKICB9OwogIENvbm5lY3Rpb25TbmFwc2hvdC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbm5lY3Rpb24ucHJvdG90eXBlKTsKICBDb25uZWN0aW9uU25hcHNob3QucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQ29ubmVjdGlvblNuYXBzaG90OwoKICBDb25uZWN0aW9uU25hcHNob3QucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvbkRhdGE7CiAgfTsKCiAgQ29ubmVjdGlvblNuYXBzaG90LnByb3RvdHlwZS5faW5pdE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsgfTsKCiAgdmFyIEVuZHBvaW50ID0gZnVuY3Rpb24gKHBhcmFtc0luKSB7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICB0aGlzLmVuZHBvaW50QVJOID0gcGFyYW1zLmVuZHBvaW50SWQgfHwgcGFyYW1zLmVuZHBvaW50QVJOIHx8IG51bGw7CiAgICB0aGlzLmVuZHBvaW50SWQgPSB0aGlzLmVuZHBvaW50QVJOOwogICAgdGhpcy50eXBlID0gcGFyYW1zLnR5cGUgfHwgbnVsbDsKICAgIHRoaXMubmFtZSA9IHBhcmFtcy5uYW1lIHx8IG51bGw7CiAgICB0aGlzLnBob25lTnVtYmVyID0gcGFyYW1zLnBob25lTnVtYmVyIHx8IG51bGw7CiAgICB0aGlzLmFnZW50TG9naW4gPSBwYXJhbXMuYWdlbnRMb2dpbiB8fCBudWxsOwogICAgdGhpcy5xdWV1ZSA9IHBhcmFtcy5xdWV1ZSB8fCBudWxsOwogIH07CgogIC8qKgogICAqIFN0cmlwIHRoZSBTSVAgZW5kcG9pbnQgY29tcG9uZW50cyBmcm9tIHRoZSBwaG9uZU51bWJlciBmaWVsZC4KICAgKi8KICBFbmRwb2ludC5wcm90b3R5cGUuc3RyaXBQaG9uZU51bWJlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLnBob25lTnVtYmVyID8gdGhpcy5waG9uZU51bWJlci5yZXBsYWNlKC9zaXA6KFteQF0qKUAuKi8sICIkMSIpIDogIiI7CiAgfTsKCiAgLyoqCiAgICogQ3JlYXRlIGFuIEVuZHBvaW50IG9iamVjdCBmcm9tIHRoZSBnaXZlbiBwaG9uZSBudW1iZXIgYW5kIG5hbWUuCiAgICovCiAgRW5kcG9pbnQuYnlQaG9uZU51bWJlciA9IGZ1bmN0aW9uIChudW1iZXIsIG5hbWUpIHsKICAgIHJldHVybiBuZXcgRW5kcG9pbnQoewogICAgICB0eXBlOiBjb25uZWN0LkVuZHBvaW50VHlwZS5QSE9ORV9OVU1CRVIsCiAgICAgIHBob25lTnVtYmVyOiBudW1iZXIsCiAgICAgIG5hbWU6IG5hbWUgfHwgbnVsbAogICAgfSk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgU29mdHBob25lRXJyb3IKICAgKi8KICB2YXIgU29mdHBob25lRXJyb3IgPSBmdW5jdGlvbiAoZXJyb3JUeXBlLCBlcnJvck1lc3NhZ2UsIGVuZFBvaW50VXJsKSB7CiAgICB0aGlzLmVycm9yVHlwZSA9IGVycm9yVHlwZTsKICAgIHRoaXMuZXJyb3JNZXNzYWdlID0gZXJyb3JNZXNzYWdlOwogICAgdGhpcy5lbmRQb2ludFVybCA9IGVuZFBvaW50VXJsOwogIH07CiAgU29mdHBob25lRXJyb3IucHJvdG90eXBlLmdldEVycm9yVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmVycm9yVHlwZTsKICB9OwogIFNvZnRwaG9uZUVycm9yLnByb3RvdHlwZS5nZXRFcnJvck1lc3NhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5lcnJvck1lc3NhZ2U7CiAgfTsKICBTb2Z0cGhvbmVFcnJvci5wcm90b3R5cGUuZ2V0RW5kUG9pbnRVcmwgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5lbmRQb2ludFVybDsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBSb290IFN1YnNjcmlwdGlvbiBBUElzLgogICAqLwogIGNvbm5lY3QuYWdlbnQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgdmFyIHN1YiA9IGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5JTklULCBmKTsKICAgIGlmIChjb25uZWN0LmFnZW50LmluaXRpYWxpemVkKSB7CiAgICAgIGYobmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICB9CiAgICByZXR1cm4gc3ViOwogIH07CiAgY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCA9IGZhbHNlOwoKICBjb25uZWN0LmNvbnRhY3QgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgcmV0dXJuIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5Db250YWN0RXZlbnRzLklOSVQsIGYpOwogIH07CgogIGNvbm5lY3Qub25XZWJzb2NrZXRJbml0RmFpbHVyZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICB2YXIgc3ViID0gYnVzLnN1YnNjcmliZShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5JTklUX0ZBSUxVUkUsIGYpOwogICAgaWYgKGNvbm5lY3Qud2ViU29ja2V0SW5pdEZhaWxlZCkgewogICAgICBmKCk7CiAgICB9CiAgICByZXR1cm4gc3ViOwogIH07CgogIC8qKgogICAqIFN0YXJ0cyB0aGUgZ2l2ZW4gZnVuY3Rpb24gYXN5bmNocm9ub3VzbHkgb25seSBpZiB0aGUgc2hhcmVkIHdvcmtlcgogICAqIHNheXMgd2UgYXJlIHRoZSBtYXN0ZXIgZm9yIHRoZSBnaXZlbiB0b3BpYy4gIElmIHRoZXJlIGlzIG5vIG1hc3RlciBmb3IKICAgKiB0aGUgZ2l2ZW4gdG9waWMsIHdlIGJlY29tZSB0aGUgbWFzdGVyIGFuZCBzdGFydCB0aGUgZnVuY3Rpb24gdW5sZXNzCiAgICogc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lIGlzIHRydWUuCiAgICoKICAgKiBAcGFyYW0gdG9waWMgVGhlIG1hc3RlciB0b3BpYyB3ZSBhcmUgY29uY2VybmVkIGFib3V0LgogICAqIEBwYXJhbSBmX3RydWUgVGhlIGNhbGxiYWNrIHRvIGJlIGludm9rZWQgaWYgd2UgYXJlIHRoZSBtYXN0ZXIuCiAgICogQHBhcmFtIGZfZWxzZSBbb3B0aW9uYWxdIEEgY2FsbGJhY2sgdG8gYmUgaW52b2tlZCBpZiB3ZSBhcmUgbm90IHRoZSBtYXN0ZXIuCiAgICogQHBhcmFtIHNob3VsZE5vdEJlY29tZU1hc3RlcklmTm9uZSBbb3B0aW9uYWxdIGlmIHRydWUsIHRoaXMgdGFiIHdvbid0IGJlY29tZSBtYXN0ZXIuCiAgICovCiAgY29ubmVjdC5pZk1hc3RlciA9IGZ1bmN0aW9uICh0b3BpYywgZl90cnVlLCBmX2Vsc2UsIHNob3VsZE5vdEJlY29tZU1hc3RlcklmTm9uZSkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljLCAiQSB0b3BpYyBtdXN0IGJlIHByb3ZpZGVkLiIpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGZfdHJ1ZSwgIkEgdHJ1ZSBjYWxsYmFjayBtdXN0IGJlIHByb3ZpZGVkLiIpOwoKICAgIGlmICghY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCkgewogICAgICAvLyBXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGZvciB0b3BpYyAnJXMnIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEiLCB0b3BpYykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgaWYgKGZfZWxzZSkgewogICAgICAgIGZfZWxzZSgpOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgbWFzdGVyQ2xpZW50ID0gY29ubmVjdC5jb3JlLmdldE1hc3RlckNsaWVudCgpOwogICAgbWFzdGVyQ2xpZW50LmNhbGwoY29ubmVjdC5NYXN0ZXJNZXRob2RzLkNIRUNLX01BU1RFUiwgewogICAgICB0b3BpYzogdG9waWMsCiAgICAgIHNob3VsZE5vdEJlY29tZU1hc3RlcklmTm9uZTogc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLmlzTWFzdGVyKSB7CiAgICAgICAgICAgIGZfdHJ1ZSgpOwoKICAgICAgICAgIH0gZWxzZSBpZiAoZl9lbHNlKSB7CiAgICAgICAgICAgIGZfZWxzZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgfTsKCiAgLyoqCiAgICogTm90aWZ5IHRoZSBzaGFyZWQgd29ya2VyIGFuZCBvdGhlciBDQ1AgdGFicyB0aGF0IHdlIGFyZSBub3cgdGhlIG1hc3RlciBmb3IgdGhlIGdpdmVuIHRvcGljLgogICAqLwogIGNvbm5lY3QuYmVjb21lTWFzdGVyID0gZnVuY3Rpb24gKHRvcGljLCBzdWNjZXNzQ2FsbGJhY2ssIGZhaWx1cmVDYWxsYmFjaykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljLCAiQSB0b3BpYyBtdXN0IGJlIHByb3ZpZGVkLiIpOwoKICAgIGlmICghY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCkgewogICAgICAvLyBXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGZvciB0b3BpYyAnJXMnIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEiLCB0b3BpYyk7CiAgICAgIGlmIChmYWlsdXJlQ2FsbGJhY2spIHsKICAgICAgICBmYWlsdXJlQ2FsbGJhY2soKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIG1hc3RlckNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRNYXN0ZXJDbGllbnQoKTsKICAgICAgbWFzdGVyQ2xpZW50LmNhbGwoY29ubmVjdC5NYXN0ZXJNZXRob2RzLkJFQ09NRV9NQVNURVIsIHsKICAgICAgICB0b3BpYzogdG9waWMKICAgICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChzdWNjZXNzQ2FsbGJhY2spIHsKICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwoKICBjb25uZWN0LkFnZW50ID0gQWdlbnQ7CiAgY29ubmVjdC5BZ2VudFNuYXBzaG90ID0gQWdlbnRTbmFwc2hvdDsKICBjb25uZWN0LkNvbnRhY3QgPSBDb250YWN0OwogIGNvbm5lY3QuQ29udGFjdFNuYXBzaG90ID0gQ29udGFjdFNuYXBzaG90OwogIC8qKiBEZWZhdWx0IHdpbGwgZ2V0IHRoZSBWb2ljZSBjb25uZWN0aW9uICovCiAgY29ubmVjdC5Db25uZWN0aW9uID0gVm9pY2VDb25uZWN0aW9uOwogIGNvbm5lY3QuQmFzZUNvbm5lY3Rpb24gPSBDb25uZWN0aW9uOwogIGNvbm5lY3QuVm9pY2VDb25uZWN0aW9uID0gVm9pY2VDb25uZWN0aW9uOwogIGNvbm5lY3QuQ2hhdENvbm5lY3Rpb24gPSBDaGF0Q29ubmVjdGlvbjsKICBjb25uZWN0LlRhc2tDb25uZWN0aW9uID0gVGFza0Nvbm5lY3Rpb247CiAgY29ubmVjdC5Db25uZWN0aW9uU25hcHNob3QgPSBDb25uZWN0aW9uU25hcHNob3Q7CiAgY29ubmVjdC5FbmRwb2ludCA9IEVuZHBvaW50OwogIGNvbm5lY3QuQWRkcmVzcyA9IEVuZHBvaW50OwogIGNvbm5lY3QuU29mdHBob25lRXJyb3IgPSBTb2Z0cGhvbmVFcnJvcjsKCn0pKCk7CgoKIWZ1bmN0aW9uKGUpe3ZhciBuPXt9O2Z1bmN0aW9uIHQobyl7aWYobltvXSlyZXR1cm4gbltvXS5leHBvcnRzO3ZhciByPW5bb109e2k6byxsOiExLGV4cG9ydHM6e319O3JldHVybiBlW29dLmNhbGwoci5leHBvcnRzLHIsci5leHBvcnRzLHQpLHIubD0hMCxyLmV4cG9ydHN9dC5tPWUsdC5jPW4sdC5kPWZ1bmN0aW9uKGUsbixvKXt0Lm8oZSxuKXx8T2JqZWN0LmRlZmluZVByb3BlcnR5KGUsbix7ZW51bWVyYWJsZTohMCxnZXQ6b30pfSx0LnI9ZnVuY3Rpb24oZSl7InVuZGVmaW5lZCIhPXR5cGVvZiBTeW1ib2wmJlN5bWJvbC50b1N0cmluZ1RhZyYmT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsU3ltYm9sLnRvU3RyaW5nVGFnLHt2YWx1ZToiTW9kdWxlIn0pLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KX0sdC50PWZ1bmN0aW9uKGUsbil7aWYoMSZuJiYoZT10KGUpKSw4Jm4pcmV0dXJuIGU7aWYoNCZuJiYib2JqZWN0Ij09dHlwZW9mIGUmJmUmJmUuX19lc01vZHVsZSlyZXR1cm4gZTt2YXIgbz1PYmplY3QuY3JlYXRlKG51bGwpO2lmKHQucihvKSxPYmplY3QuZGVmaW5lUHJvcGVydHkobywiZGVmYXVsdCIse2VudW1lcmFibGU6ITAsdmFsdWU6ZX0pLDImbiYmInN0cmluZyIhPXR5cGVvZiBlKWZvcih2YXIgciBpbiBlKXQuZChvLHIsZnVuY3Rpb24obil7cmV0dXJuIGVbbl19LmJpbmQobnVsbCxyKSk7cmV0dXJuIG99LHQubj1mdW5jdGlvbihlKXt2YXIgbj1lJiZlLl9fZXNNb2R1bGU/ZnVuY3Rpb24oKXtyZXR1cm4gZS5kZWZhdWx0fTpmdW5jdGlvbigpe3JldHVybiBlfTtyZXR1cm4gdC5kKG4sImEiLG4pLG59LHQubz1mdW5jdGlvbihlLG4pe3JldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoZSxuKX0sdC5wPSIiLHQodC5zPTIpfShbZnVuY3Rpb24oZSxuLHQpeyJ1c2Ugc3RyaWN0Ijt2YXIgbz10KDEpLHI9Ik5VTEwiLGk9IkNMSUVOVF9MT0dHRVIiLGM9IkRFQlVHIixzPTJlMyxhPSJhd3Mvc3Vic2NyaWJlIix1PSJhd3MvdW5zdWJzY3JpYmUiLGw9ImF3cy9oZWFydGJlYXQiLGY9ImNvbm5lY3RlZCIscD0iZGlzY29ubmVjdGVkIjtmdW5jdGlvbiBkKGUpe3JldHVybihkPSJmdW5jdGlvbiI9PXR5cGVvZiBTeW1ib2wmJiJzeW1ib2wiPT10eXBlb2YgU3ltYm9sLml0ZXJhdG9yP2Z1bmN0aW9uKGUpe3JldHVybiB0eXBlb2YgZX06ZnVuY3Rpb24oZSl7cmV0dXJuIGUmJiJmdW5jdGlvbiI9PXR5cGVvZiBTeW1ib2wmJmUuY29uc3RydWN0b3I9PT1TeW1ib2wmJmUhPT1TeW1ib2wucHJvdG90eXBlPyJzeW1ib2wiOnR5cGVvZiBlfSkoZSl9dmFyIGI9e2Fzc2VydFRydWU6ZnVuY3Rpb24oZSxuKXtpZighZSl0aHJvdyBuZXcgRXJyb3Iobil9LGFzc2VydE5vdE51bGw6ZnVuY3Rpb24oZSxuKXtyZXR1cm4gYi5hc3NlcnRUcnVlKG51bGwhPT1lJiZ2b2lkIDAhPT1kKGUpLE9iamVjdChvLnNwcmludGYpKCIlcyBtdXN0IGJlIHByb3ZpZGVkIixufHwiQSB2YWx1ZSIpKSxlfSxpc05vbkVtcHR5U3RyaW5nOmZ1bmN0aW9uKGUpe3JldHVybiJzdHJpbmciPT10eXBlb2YgZSYmZS5sZW5ndGg+MH0sYXNzZXJ0SXNMaXN0OmZ1bmN0aW9uKGUsbil7aWYoIUFycmF5LmlzQXJyYXkoZSkpdGhyb3cgbmV3IEVycm9yKG4rIiBpcyBub3QgYW4gYXJyYXkiKX0saXNGdW5jdGlvbjpmdW5jdGlvbihlKXtyZXR1cm4hIShlJiZlLmNvbnN0cnVjdG9yJiZlLmNhbGwmJmUuYXBwbHkpfSxpc09iamVjdDpmdW5jdGlvbihlKXtyZXR1cm4hKCJvYmplY3QiIT09ZChlKXx8bnVsbD09PWUpfSxpc1N0cmluZzpmdW5jdGlvbihlKXtyZXR1cm4ic3RyaW5nIj09dHlwZW9mIGV9LGlzTnVtYmVyOmZ1bmN0aW9uKGUpe3JldHVybiJudW1iZXIiPT10eXBlb2YgZX19LGc9bmV3IFJlZ0V4cCgiXih3c3M6Ly8pXFx3KiIpO2IudmFsaWRXU1VybD1mdW5jdGlvbihlKXtyZXR1cm4gZy50ZXN0KGUpfSxiLmdldFN1YnNjcmlwdGlvblJlc3BvbnNlPWZ1bmN0aW9uKGUsbix0KXtyZXR1cm57dG9waWM6ZSxjb250ZW50OntzdGF0dXM6bj8ic3VjY2VzcyI6ImZhaWx1cmUiLHRvcGljczp0fX19LGIuYXNzZXJ0SXNPYmplY3Q9ZnVuY3Rpb24oZSxuKXtpZighYi5pc09iamVjdChlKSl0aHJvdyBuZXcgRXJyb3IobisiIGlzIG5vdCBhbiBvYmplY3QhIil9LGIuYWRkSml0dGVyPWZ1bmN0aW9uKGUpe3ZhciBuPWFyZ3VtZW50cy5sZW5ndGg+MSYmdm9pZCAwIT09YXJndW1lbnRzWzFdP2FyZ3VtZW50c1sxXToxO249TWF0aC5taW4obiwxKTt2YXIgdD1NYXRoLnJhbmRvbSgpPi41PzE6LTE7cmV0dXJuIE1hdGguZmxvb3IoZSt0KmUqTWF0aC5yYW5kb20oKSpuKX0sYi5pc05ldHdvcmtPbmxpbmU9ZnVuY3Rpb24oKXtyZXR1cm4gbmF2aWdhdG9yLm9uTGluZX0sYi5pc05ldHdvcmtGYWlsdXJlPWZ1bmN0aW9uKGUpe3JldHVybiEoIWUuX2RlYnVnfHwhZS5fZGVidWcudHlwZSkmJiJOZXR3b3JraW5nRXJyb3IiPT09ZS5fZGVidWcudHlwZX07dmFyIHk9YjtmdW5jdGlvbiBtKGUpe3JldHVybihtPSJmdW5jdGlvbiI9PXR5cGVvZiBTeW1ib2wmJiJzeW1ib2wiPT10eXBlb2YgU3ltYm9sLml0ZXJhdG9yP2Z1bmN0aW9uKGUpe3JldHVybiB0eXBlb2YgZX06ZnVuY3Rpb24oZSl7cmV0dXJuIGUmJiJmdW5jdGlvbiI9PXR5cGVvZiBTeW1ib2wmJmUuY29uc3RydWN0b3I9PT1TeW1ib2wmJmUhPT1TeW1ib2wucHJvdG90eXBlPyJzeW1ib2wiOnR5cGVvZiBlfSkoZSl9ZnVuY3Rpb24gUyhlLG4pe3JldHVybiFufHwib2JqZWN0IiE9PW0obikmJiJmdW5jdGlvbiIhPXR5cGVvZiBuP2Z1bmN0aW9uKGUpe2lmKHZvaWQgMD09PWUpdGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCJ0aGlzIGhhc24ndCBiZWVuIGluaXRpYWxpc2VkIC0gc3VwZXIoKSBoYXNuJ3QgYmVlbiBjYWxsZWQiKTtyZXR1cm4gZX0oZSk6bn1mdW5jdGlvbiBrKGUpe3JldHVybihrPU9iamVjdC5zZXRQcm90b3R5cGVPZj9PYmplY3QuZ2V0UHJvdG90eXBlT2Y6ZnVuY3Rpb24oZSl7cmV0dXJuIGUuX19wcm90b19ffHxPYmplY3QuZ2V0UHJvdG90eXBlT2YoZSl9KShlKX1mdW5jdGlvbiBoKGUsbil7cmV0dXJuKGg9T2JqZWN0LnNldFByb3RvdHlwZU9mfHxmdW5jdGlvbihlLG4pe3JldHVybiBlLl9fcHJvdG9fXz1uLGV9KShlLG4pfWZ1bmN0aW9uIHYoZSxuKXtpZighKGUgaW5zdGFuY2VvZiBuKSl0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKX1mdW5jdGlvbiB3KGUsbil7Zm9yKHZhciB0PTA7dDxuLmxlbmd0aDt0Kyspe3ZhciBvPW5bdF07by5lbnVtZXJhYmxlPW8uZW51bWVyYWJsZXx8ITEsby5jb25maWd1cmFibGU9ITAsInZhbHVlImluIG8mJihvLndyaXRhYmxlPSEwKSxPYmplY3QuZGVmaW5lUHJvcGVydHkoZSxvLmtleSxvKX19ZnVuY3Rpb24gQyhlLG4sdCl7cmV0dXJuIG4mJncoZS5wcm90b3R5cGUsbiksdCYmdyhlLHQpLGV9dmFyIFQ9ZnVuY3Rpb24oKXtmdW5jdGlvbiBlKCl7dih0aGlzLGUpfXJldHVybiBDKGUsW3trZXk6ImRlYnVnIix2YWx1ZTpmdW5jdGlvbihlKXt9fSx7a2V5OiJpbmZvIix2YWx1ZTpmdW5jdGlvbihlKXt9fSx7a2V5OiJ3YXJuIix2YWx1ZTpmdW5jdGlvbihlKXt9fSx7a2V5OiJlcnJvciIsdmFsdWU6ZnVuY3Rpb24oZSl7fX1dKSxlfSgpLE89e0RFQlVHOjEwLElORk86MjAsV0FSTjozMCxFUlJPUjo0MH0sST1mdW5jdGlvbigpe2Z1bmN0aW9uIGUoKXt2KHRoaXMsZSksdGhpcy51cGRhdGVMb2dnZXJDb25maWcoKSx0aGlzLmNvbnNvbGVMb2dnZXJXcmFwcGVyPV8oKX1yZXR1cm4gQyhlLFt7a2V5OiJ3cml0ZVRvQ2xpZW50TG9nZ2VyIix2YWx1ZTpmdW5jdGlvbihlLG4pe2lmKHRoaXMuaGFzQ2xpZW50TG9nZ2VyKCkpc3dpdGNoKGUpe2Nhc2UgTy5ERUJVRzpyZXR1cm4gdGhpcy5fY2xpZW50TG9nZ2VyLmRlYnVnKG4pO2Nhc2UgTy5JTkZPOnJldHVybiB0aGlzLl9jbGllbnRMb2dnZXIuaW5mbyhuKTtjYXNlIE8uV0FSTjpyZXR1cm4gdGhpcy5fY2xpZW50TG9nZ2VyLndhcm4obik7Y2FzZSBPLkVSUk9SOnJldHVybiB0aGlzLl9jbGllbnRMb2dnZXIuZXJyb3Iobil9fX0se2tleToiaXNMZXZlbEVuYWJsZWQiLHZhbHVlOmZ1bmN0aW9uKGUpe3JldHVybiBlPj10aGlzLl9sZXZlbH19LHtrZXk6Imhhc0NsaWVudExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oKXtyZXR1cm4gbnVsbCE9PXRoaXMuX2NsaWVudExvZ2dlcn19LHtrZXk6ImdldExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oZSl7dmFyIG49ZS5wcmVmaXh8fCIiO3JldHVybiB0aGlzLl9sb2dzRGVzdGluYXRpb249PT1jP3RoaXMuY29uc29sZUxvZ2dlcldyYXBwZXI6bmV3IE4obil9fSx7a2V5OiJ1cGRhdGVMb2dnZXJDb25maWciLHZhbHVlOmZ1bmN0aW9uKGUpe3ZhciBuPWV8fHt9O3RoaXMuX2xldmVsPW4ubGV2ZWx8fE8uREVCVUcsdGhpcy5fY2xpZW50TG9nZ2VyPW4ubG9nZ2VyfHxudWxsLHRoaXMuX2xvZ3NEZXN0aW5hdGlvbj1yLG4uZGVidWcmJih0aGlzLl9sb2dzRGVzdGluYXRpb249Yyksbi5sb2dnZXImJih0aGlzLl9sb2dzRGVzdGluYXRpb249aSl9fV0pLGV9KCksVz1mdW5jdGlvbigpe2Z1bmN0aW9uIGUoKXt2KHRoaXMsZSl9cmV0dXJuIEMoZSxbe2tleToiZGVidWciLHZhbHVlOmZ1bmN0aW9uKCl7fX0se2tleToiaW5mbyIsdmFsdWU6ZnVuY3Rpb24oKXt9fSx7a2V5OiJ3YXJuIix2YWx1ZTpmdW5jdGlvbigpe319LHtrZXk6ImVycm9yIix2YWx1ZTpmdW5jdGlvbigpe319XSksZX0oKSxOPWZ1bmN0aW9uKGUpe2Z1bmN0aW9uIG4oZSl7dmFyIHQ7cmV0dXJuIHYodGhpcyxuKSwodD1TKHRoaXMsayhuKS5jYWxsKHRoaXMpKSkucHJlZml4PWV8fCIiLHR9cmV0dXJuIGZ1bmN0aW9uKGUsbil7aWYoImZ1bmN0aW9uIiE9dHlwZW9mIG4mJm51bGwhPT1uKXRocm93IG5ldyBUeXBlRXJyb3IoIlN1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uIik7ZS5wcm90b3R5cGU9T2JqZWN0LmNyZWF0ZShuJiZuLnByb3RvdHlwZSx7Y29uc3RydWN0b3I6e3ZhbHVlOmUsd3JpdGFibGU6ITAsY29uZmlndXJhYmxlOiEwfX0pLG4mJmgoZSxuKX0obixXKSxDKG4sW3trZXk6ImRlYnVnIix2YWx1ZTpmdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiB0aGlzLl9sb2coTy5ERUJVRyxuKX19LHtrZXk6ImluZm8iLHZhbHVlOmZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07cmV0dXJuIHRoaXMuX2xvZyhPLklORk8sbil9fSx7a2V5OiJ3YXJuIix2YWx1ZTpmdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiB0aGlzLl9sb2coTy5XQVJOLG4pfX0se2tleToiZXJyb3IiLHZhbHVlOmZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07cmV0dXJuIHRoaXMuX2xvZyhPLkVSUk9SLG4pfX0se2tleToiX3Nob3VsZExvZyIsdmFsdWU6ZnVuY3Rpb24oZSl7cmV0dXJuIEUuaGFzQ2xpZW50TG9nZ2VyKCkmJkUuaXNMZXZlbEVuYWJsZWQoZSl9fSx7a2V5OiJfd3JpdGVUb0NsaWVudExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oZSxuKXtyZXR1cm4gRS53cml0ZVRvQ2xpZW50TG9nZ2VyKGUsbil9fSx7a2V5OiJfbG9nIix2YWx1ZTpmdW5jdGlvbihlLG4pe2lmKHRoaXMuX3Nob3VsZExvZyhlKSl7dmFyIHQ9dGhpcy5fY29udmVydFRvU2luZ2xlU3RhdGVtZW50KG4pO3JldHVybiB0aGlzLl93cml0ZVRvQ2xpZW50TG9nZ2VyKGUsdCl9fX0se2tleToiX2NvbnZlcnRUb1NpbmdsZVN0YXRlbWVudCIsdmFsdWU6ZnVuY3Rpb24oZSl7dmFyIG49IiI7dGhpcy5wcmVmaXgmJihuKz10aGlzLnByZWZpeCsiICIpO2Zvcih2YXIgdD0wO3Q8ZS5sZW5ndGg7dCsrKXt2YXIgbz1lW3RdO24rPXRoaXMuX2NvbnZlcnRUb1N0cmluZyhvKSsiICJ9cmV0dXJuIG59fSx7a2V5OiJfY29udmVydFRvU3RyaW5nIix2YWx1ZTpmdW5jdGlvbihlKXt0cnl7aWYoIWUpcmV0dXJuIiI7aWYoeS5pc1N0cmluZyhlKSlyZXR1cm4gZTtpZih5LmlzT2JqZWN0KGUpJiZ5LmlzRnVuY3Rpb24oZS50b1N0cmluZykpe3ZhciBuPWUudG9TdHJpbmcoKTtpZigiW29iamVjdCBPYmplY3RdIiE9PW4pcmV0dXJuIG59cmV0dXJuIEpTT04uc3RyaW5naWZ5KGUpfWNhdGNoKG4pe3JldHVybiBjb25zb2xlLmVycm9yKCJFcnJvciB3aGlsZSBjb252ZXJ0aW5nIGFyZ3VtZW50IHRvIHN0cmluZyIsZSxuKSwiIn19fV0pLG59KCksXz1mdW5jdGlvbigpe3ZhciBlPW5ldyBXO3JldHVybiBlLmRlYnVnPWNvbnNvbGUuZGVidWcsZS5pbmZvPWNvbnNvbGUuaW5mbyxlLndhcm49Y29uc29sZS53YXJuLGUuZXJyb3I9Y29uc29sZS5lcnJvcixlfSxFPW5ldyBJO2Z1bmN0aW9uIEYoZSxuKXtmb3IodmFyIHQ9MDt0PG4ubGVuZ3RoO3QrKyl7dmFyIG89blt0XTtvLmVudW1lcmFibGU9by5lbnVtZXJhYmxlfHwhMSxvLmNvbmZpZ3VyYWJsZT0hMCwidmFsdWUiaW4gbyYmKG8ud3JpdGFibGU9ITApLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLG8ua2V5LG8pfX12YXIgTD1mdW5jdGlvbigpe2Z1bmN0aW9uIGUobil7dmFyIHQ9YXJndW1lbnRzLmxlbmd0aD4xJiZ2b2lkIDAhPT1hcmd1bWVudHNbMV0/YXJndW1lbnRzWzFdOnM7IWZ1bmN0aW9uKGUsbil7aWYoIShlIGluc3RhbmNlb2YgbikpdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIil9KHRoaXMsZSksdGhpcy5udW1BdHRlbXB0cz0wLHRoaXMuZXhlY3V0b3I9bix0aGlzLmhhc0FjdGl2ZVJlY29ubmVjdGlvbj0hMSx0aGlzLmRlZmF1bHRSZXRyeT10fXZhciBuLHQsbztyZXR1cm4gbj1lLCh0PVt7a2V5OiJyZXRyeSIsdmFsdWU6ZnVuY3Rpb24oKXt2YXIgZT10aGlzO3RoaXMuaGFzQWN0aXZlUmVjb25uZWN0aW9ufHwodGhpcy5oYXNBY3RpdmVSZWNvbm5lY3Rpb249ITAsc2V0VGltZW91dChmdW5jdGlvbigpe2UuX2V4ZWN1dGUoKX0sdGhpcy5fZ2V0RGVsYXkoKSkpfX0se2tleToiX2V4ZWN1dGUiLHZhbHVlOmZ1bmN0aW9uKCl7dGhpcy5oYXNBY3RpdmVSZWNvbm5lY3Rpb249ITEsdGhpcy5leGVjdXRvcigpLHRoaXMubnVtQXR0ZW1wdHMrK319LHtrZXk6ImNvbm5lY3RlZCIsdmFsdWU6ZnVuY3Rpb24oKXt0aGlzLm51bUF0dGVtcHRzPTB9fSx7a2V5OiJfZ2V0RGVsYXkiLHZhbHVlOmZ1bmN0aW9uKCl7dmFyIGU9TWF0aC5wb3coMix0aGlzLm51bUF0dGVtcHRzKSp0aGlzLmRlZmF1bHRSZXRyeTtyZXR1cm4gZTw9M2U0P2U6M2U0fX1dKSYmRihuLnByb3RvdHlwZSx0KSxvJiZGKG4sbyksZX0oKTt0LmQobiwiYSIsZnVuY3Rpb24oKXtyZXR1cm4gUn0pO3ZhciB4PWZ1bmN0aW9uKCl7dmFyIGU9RS5nZXRMb2dnZXIoe30pLG49eS5pc05ldHdvcmtPbmxpbmUoKSx0PXtwcmltYXJ5Om51bGwsc2Vjb25kYXJ5Om51bGx9LG89e3JlY29ubmVjdFdlYlNvY2tldDohMCx3ZWJzb2NrZXRJbml0RmFpbGVkOiExLGV4cG9uZW50aWFsQmFja09mZlRpbWU6MWUzLGV4cG9uZW50aWFsVGltZW91dEhhbmRsZTpudWxsLGxpZmVUaW1lVGltZW91dEhhbmRsZTpudWxsLHdlYlNvY2tldEluaXRDaGVja2VyVGltZW91dElkOm51bGwsY29ublN0YXRlOm51bGx9LHI9e2Nvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50OjAsY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU6bnVsbCxub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcDpudWxsfSxpPXtwZW5kaW5nUmVzcG9uc2U6ITEsaW50ZXJ2YWxIYW5kbGU6bnVsbH0sYz17aW5pdEZhaWx1cmU6bmV3IFNldCxnZXRXZWJTb2NrZXRUcmFuc3BvcnQ6bnVsbCxzdWJzY3JpcHRpb25VcGRhdGU6bmV3IFNldCxzdWJzY3JpcHRpb25GYWlsdXJlOm5ldyBTZXQsdG9waWM6bmV3IE1hcCxhbGxNZXNzYWdlOm5ldyBTZXQsY29ubmVjdGlvbkdhaW46bmV3IFNldCxjb25uZWN0aW9uTG9zdDpuZXcgU2V0LGNvbm5lY3Rpb25PcGVuOm5ldyBTZXQsY29ubmVjdGlvbkNsb3NlOm5ldyBTZXR9LHM9e2Nvbm5Db25maWc6bnVsbCxwcm9taXNlSGFuZGxlOm51bGwscHJvbWlzZUNvbXBsZXRlZDohMH0sZD17c3Vic2NyaWJlZDpuZXcgU2V0LHBlbmRpbmc6bmV3IFNldCxzdWJzY3JpcHRpb25IaXN0b3J5Om5ldyBTZXR9LGI9e3Jlc3BvbnNlQ2hlY2tJbnRlcnZhbElkOm51bGwscmVxdWVzdENvbXBsZXRlZDohMCxyZVN1YnNjcmliZUludGVydmFsSWQ6bnVsbCxjb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzOjAsY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdDowfSxnPW5ldyBMKGZ1bmN0aW9uKCl7VSgpfSksbT1uZXcgU2V0KFthLHUsbF0pLFM9c2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXtpZihuIT09eS5pc05ldHdvcmtPbmxpbmUoKSl7aWYoIShuPXkuaXNOZXR3b3JrT25saW5lKCkpKXJldHVybiB2b2lkIEooZS5pbmZvKCJOZXR3b3JrIG9mZmxpbmUiKSk7dmFyIHQ9TygpO24mJighdHx8dyh0LFdlYlNvY2tldC5DTE9TSU5HKXx8dyh0LFdlYlNvY2tldC5DTE9TRUQpKSYmKEooZS5pbmZvKCJOZXR3b3JrIG9ubGluZSwgY29ubmVjdGluZyB0byBXZWJTb2NrZXQgc2VydmVyIikpLFUoKSl9fSwyNTApLGs9ZnVuY3Rpb24obix0KXtuLmZvckVhY2goZnVuY3Rpb24obil7dHJ5e24odCl9Y2F0Y2gobil7SihlLmVycm9yKCJFcnJvciBleGVjdXRpbmcgY2FsbGJhY2siLG4pKX19KX0saD1mdW5jdGlvbihlKXtpZihudWxsPT09ZSlyZXR1cm4iTlVMTCI7c3dpdGNoKGUucmVhZHlTdGF0ZSl7Y2FzZSBXZWJTb2NrZXQuQ09OTkVDVElORzpyZXR1cm4iQ09OTkVDVElORyI7Y2FzZSBXZWJTb2NrZXQuT1BFTjpyZXR1cm4iT1BFTiI7Y2FzZSBXZWJTb2NrZXQuQ0xPU0lORzpyZXR1cm4iQ0xPU0lORyI7Y2FzZSBXZWJTb2NrZXQuQ0xPU0VEOnJldHVybiJDTE9TRUQiO2RlZmF1bHQ6cmV0dXJuIlVOREVGSU5FRCJ9fSx2PWZ1bmN0aW9uKCl7dmFyIG49YXJndW1lbnRzLmxlbmd0aD4wJiZ2b2lkIDAhPT1hcmd1bWVudHNbMF0/YXJndW1lbnRzWzBdOiIiO0ooZS5kZWJ1ZygiWyIrbisiXSBQcmltYXJ5IFdlYlNvY2tldDogIitoKHQucHJpbWFyeSkrIiB8IFNlY29uZGFyeSBXZWJTb2NrZXQ6ICIraCh0LnNlY29uZGFyeSkpKX0sdz1mdW5jdGlvbihlLG4pe3JldHVybiBlJiZlLnJlYWR5U3RhdGU9PT1ufSxDPWZ1bmN0aW9uKGUpe3JldHVybiB3KGUsV2ViU29ja2V0Lk9QRU4pfSxUPWZ1bmN0aW9uKGUpe3JldHVybiBudWxsPT09ZXx8dm9pZCAwPT09ZS5yZWFkeVN0YXRlfHx3KGUsV2ViU29ja2V0LkNMT1NFRCl9LE89ZnVuY3Rpb24oKXtyZXR1cm4gbnVsbCE9PXQuc2Vjb25kYXJ5P3Quc2Vjb25kYXJ5OnQucHJpbWFyeX0sST1mdW5jdGlvbigpe3JldHVybiBDKE8oKSl9LFc9ZnVuY3Rpb24oKXtpZihpLnBlbmRpbmdSZXNwb25zZSlyZXR1cm4gSihlLndhcm4oIkhlYXJ0YmVhdCByZXNwb25zZSBub3QgcmVjZWl2ZWQiKSksY2xlYXJJbnRlcnZhbChpLmludGVydmFsSGFuZGxlKSxpLnBlbmRpbmdSZXNwb25zZT0hMSx2b2lkIFUoKTtJKCk/KEooZS5kZWJ1ZygiU2VuZGluZyBoZWFydGJlYXQiKSksTygpLnNlbmQoRyhsKSksaS5wZW5kaW5nUmVzcG9uc2U9ITApOihKKGUud2FybigiRmFpbGVkIHRvIHNlbmQgaGVhcnRiZWF0IHNpbmNlIFdlYlNvY2tldCBpcyBub3Qgb3BlbiIpKSx2KCJzZW5kSGVhcnRCZWF0IiksVSgpKX0sTj1mdW5jdGlvbigpe28uZXhwb25lbnRpYWxCYWNrT2ZmVGltZT0xZTMsaS5wZW5kaW5nUmVzcG9uc2U9ITEsby5yZWNvbm5lY3RXZWJTb2NrZXQ9ITAsY2xlYXJUaW1lb3V0KG8ubGlmZVRpbWVUaW1lb3V0SGFuZGxlKSxjbGVhckludGVydmFsKGkuaW50ZXJ2YWxIYW5kbGUpLGNsZWFyVGltZW91dChvLmV4cG9uZW50aWFsVGltZW91dEhhbmRsZSksY2xlYXJUaW1lb3V0KG8ud2ViU29ja2V0SW5pdENoZWNrZXJUaW1lb3V0SWQpfSxfPWZ1bmN0aW9uKCl7Yi5jb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzPTAsYi5jb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0PTAsY2xlYXJJbnRlcnZhbChiLnJlc3BvbnNlQ2hlY2tJbnRlcnZhbElkKSxjbGVhckludGVydmFsKGIucmVTdWJzY3JpYmVJbnRlcnZhbElkKX0sRj1mdW5jdGlvbigpe3IuY29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQ9MCxyLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lPW51bGwsci5ub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcD1udWxsfSx4PWZ1bmN0aW9uKCl7dHJ5e0ooZS5pbmZvKCJXZWJTb2NrZXQgY29ubmVjdGlvbiBlc3RhYmxpc2hlZCEiKSksdigid2ViU29ja2V0T25PcGVuIiksbnVsbCE9PW8uY29ublN0YXRlJiZvLmNvbm5TdGF0ZSE9PXB8fGsoYy5jb25uZWN0aW9uR2Fpbiksby5jb25uU3RhdGU9Zjt2YXIgbj1EYXRlLm5vdygpO2soYy5jb25uZWN0aW9uT3Blbix7Y29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQ6ci5jb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudCxjb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZTpyLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lLG5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wOnIubm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXAsY29ubmVjdGlvbkVzdGFibGlzaGVkVGltZTpuLHRpbWVUb0Nvbm5lY3Q6bi1yLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lLHRpbWVXaXRob3V0Q29ubmVjdGlvbjpyLm5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wP24tci5ub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcDpudWxsfSksRigpLE4oKSxPKCkub3BlblRpbWVzdGFtcD1EYXRlLm5vdygpLDA9PT1kLnN1YnNjcmliZWQuc2l6ZSYmQyh0LnNlY29uZGFyeSkmJkQodC5wcmltYXJ5LCJbUHJpbWFyeSBXZWJTb2NrZXRdIENsb3NpbmcgV2ViU29ja2V0IiksKGQuc3Vic2NyaWJlZC5zaXplPjB8fGQucGVuZGluZy5zaXplPjApJiYoQyh0LnNlY29uZGFyeSkmJkooZS5pbmZvKCJTdWJzY3JpYmluZyBzZWNvbmRhcnkgd2Vic29ja2V0IHRvIHRvcGljcyBvZiBwcmltYXJ5IHdlYnNvY2tldCIpKSxkLnN1YnNjcmliZWQuZm9yRWFjaChmdW5jdGlvbihlKXtkLnN1YnNjcmlwdGlvbkhpc3RvcnkuYWRkKGUpLGQucGVuZGluZy5hZGQoZSl9KSxkLnN1YnNjcmliZWQuY2xlYXIoKSxBKCkpLFcoKSxpLmludGVydmFsSGFuZGxlPXNldEludGVydmFsKFcsMWU0KTt2YXIgYT0xZTMqcy5jb25uQ29uZmlnLndlYlNvY2tldFRyYW5zcG9ydC50cmFuc3BvcnRMaWZlVGltZUluU2Vjb25kcztKKGUuZGVidWcoIlNjaGVkdWxpbmcgV2ViU29ja2V0IG1hbmFnZXIgcmVjb25uZWN0aW9uLCBhZnRlciBkZWxheSAiK2ErIiBtcyIpKSxvLmxpZmVUaW1lVGltZW91dEhhbmRsZT1zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7SihlLmRlYnVnKCJTdGFydGluZyBzY2hlZHVsZWQgV2ViU29ja2V0IG1hbmFnZXIgcmVjb25uZWN0aW9uIikpLFUoKX0sYSl9Y2F0Y2gobil7SihlLmVycm9yKCJFcnJvciBhZnRlciBlc3RhYmxpc2hpbmcgV2ViU29ja2V0IGNvbm5lY3Rpb24iLG4pKX19LFI9ZnVuY3Rpb24obil7digid2ViU29ja2V0T25FcnJvciIpLEooZS5lcnJvcigiV2ViU29ja2V0TWFuYWdlciBFcnJvciwgZXJyb3JfZXZlbnQ6ICIsSlNPTi5zdHJpbmdpZnkobikpKSxVKCl9LGo9ZnVuY3Rpb24obil7dmFyIG89SlNPTi5wYXJzZShuLmRhdGEpO3N3aXRjaChvLnRvcGljKXtjYXNlIGE6aWYoSihlLmRlYnVnKCJTdWJzY3JpcHRpb24gTWVzc2FnZSByZWNlaXZlZCBmcm9tIHdlYlNvY2tldCBzZXJ2ZXIiLG4uZGF0YSkpLGIucmVxdWVzdENvbXBsZXRlZD0hMCxiLmNvbnNlY3V0aXZlTm9SZXNwb25zZVJlcXVlc3Q9MCwic3VjY2VzcyI9PT1vLmNvbnRlbnQuc3RhdHVzKWIuY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0cz0wLG8uY29udGVudC50b3BpY3MuZm9yRWFjaChmdW5jdGlvbihlKXtkLnN1YnNjcmlwdGlvbkhpc3RvcnkuZGVsZXRlKGUpLGQucGVuZGluZy5kZWxldGUoZSksZC5zdWJzY3JpYmVkLmFkZChlKX0pLDA9PT1kLnN1YnNjcmlwdGlvbkhpc3Rvcnkuc2l6ZT9DKHQuc2Vjb25kYXJ5KSYmKEooZS5pbmZvKCJTdWNjZXNzZnVsbHkgc3Vic2NyaWJlZCBzZWNvbmRhcnkgd2Vic29ja2V0IHRvIGFsbCB0b3BpY3Mgb2YgcHJpbWFyeSB3ZWJzb2NrZXQiKSksRCh0LnByaW1hcnksIltQcmltYXJ5IFdlYlNvY2tldF0gQ2xvc2luZyBXZWJTb2NrZXQiKSk6QSgpLGsoYy5zdWJzY3JpcHRpb25VcGRhdGUsbyk7ZWxzZXtpZihjbGVhckludGVydmFsKGIucmVTdWJzY3JpYmVJbnRlcnZhbElkKSwrK2IuY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0cyw1PT09Yi5jb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzKXJldHVybiBrKGMuc3Vic2NyaXB0aW9uRmFpbHVyZSxvKSx2b2lkKGIuY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0cz0wKTtiLnJlU3Vic2NyaWJlSW50ZXJ2YWxJZD1zZXRJbnRlcnZhbChmdW5jdGlvbigpe0EoKX0sNTAwKX1icmVhaztjYXNlIGw6SihlLmRlYnVnKCJIZWFydGJlYXQgcmVzcG9uc2UgcmVjZWl2ZWQiKSksaS5wZW5kaW5nUmVzcG9uc2U9ITE7YnJlYWs7ZGVmYXVsdDppZihvLnRvcGljKXtpZihKKGUuZGVidWcoIk1lc3NhZ2UgcmVjZWl2ZWQgZm9yIHRvcGljICIrby50b3BpYykpLEModC5wcmltYXJ5KSYmQyh0LnNlY29uZGFyeSkmJjA9PT1kLnN1YnNjcmlwdGlvbkhpc3Rvcnkuc2l6ZSYmdGhpcz09PXQucHJpbWFyeSlyZXR1cm4gdm9pZCBKKGUud2FybigiSWdub3JpbmcgTWVzc2FnZSBmb3IgVG9waWMgIitvLnRvcGljKyIsIHRvIGF2b2lkIGR1cGxpY2F0ZXMiKSk7aWYoMD09PWMuYWxsTWVzc2FnZS5zaXplJiYwPT09Yy50b3BpYy5zaXplKXJldHVybiB2b2lkIEooZS53YXJuKCJObyByZWdpc3RlcmVkIGNhbGxiYWNrIGxpc3RlbmVyIGZvciBUb3BpYyIsby50b3BpYykpO2soYy5hbGxNZXNzYWdlLG8pLGMudG9waWMuaGFzKG8udG9waWMpJiZrKGMudG9waWMuZ2V0KG8udG9waWMpLG8pfWVsc2Ugby5tZXNzYWdlP0ooZS53YXJuKCJXZWJTb2NrZXRNYW5hZ2VyIE1lc3NhZ2UgRXJyb3IiLG8pKTpKKGUud2FybigiSW52YWxpZCBpbmNvbWluZyBtZXNzYWdlIixvKSl9fSxBPWZ1bmN0aW9uIG4oKXtpZihiLmNvbnNlY3V0aXZlTm9SZXNwb25zZVJlcXVlc3Q+MylyZXR1cm4gSihlLndhcm4oIklnbm9yaW5nIHN1YnNjcmliZVBlbmRpbmdUb3BpY3Mgc2luY2Ugd2UgaGF2ZSBleGhhdXN0ZWQgbWF4IHN1YnNjcmlwdGlvbiByZXRyaWVzIHdpdGggbm8gcmVzcG9uc2UiKSksdm9pZCBrKGMuc3Vic2NyaXB0aW9uRmFpbHVyZSx5LmdldFN1YnNjcmlwdGlvblJlc3BvbnNlKGEsITEsQXJyYXkuZnJvbShkLnBlbmRpbmcpKSk7SSgpPyhjbGVhckludGVydmFsKGIucmVzcG9uc2VDaGVja0ludGVydmFsSWQpLE8oKS5zZW5kKEcoYSx7dG9waWNzOkFycmF5LmZyb20oZC5wZW5kaW5nKX0pKSxiLnJlcXVlc3RDb21wbGV0ZWQ9ITEsYi5yZXNwb25zZUNoZWNrSW50ZXJ2YWxJZD1zZXRJbnRlcnZhbChmdW5jdGlvbigpe2IucmVxdWVzdENvbXBsZXRlZHx8KCsrYi5jb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0LG4oKSl9LDFlMykpOkooZS53YXJuKCJJZ25vcmluZyBzdWJzY3JpYmVQZW5kaW5nVG9waWNzIGNhbGwgc2luY2UgRGVmYXVsdCBXZWJTb2NrZXQgaXMgbm90IG9wZW4iKSl9LEQ9ZnVuY3Rpb24obix0KXt3KG4sV2ViU29ja2V0LkNPTk5FQ1RJTkcpfHx3KG4sV2ViU29ja2V0Lk9QRU4pP24uY2xvc2UoMWUzLHQpOkooZS53YXJuKCJJZ25vcmluZyBXZWJTb2NrZXQgQ2xvc2UgcmVxdWVzdCwgV2ViU29ja2V0IFN0YXRlOiAiK2gobikpKX0sTT1mdW5jdGlvbihlKXtEKHQucHJpbWFyeSwiW1ByaW1hcnldIFdlYlNvY2tldCAiK2UpLEQodC5zZWNvbmRhcnksIltTZWNvbmRhcnldIFdlYlNvY2tldCAiK2UpfSxQPWZ1bmN0aW9uKCl7ci5jb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudCsrO3ZhciBuPXkuYWRkSml0dGVyKG8uZXhwb25lbnRpYWxCYWNrT2ZmVGltZSwuMyk7RGF0ZS5ub3coKStuPD1zLmNvbm5Db25maWcudXJsQ29ublZhbGlkVGltZT8oSihlLmRlYnVnKCJTY2hlZHVsaW5nIFdlYlNvY2tldCByZWluaXRpYWxpemF0aW9uLCBhZnRlciBkZWxheSAiK24rIiBtcyIpKSxvLmV4cG9uZW50aWFsVGltZW91dEhhbmRsZT1zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7cmV0dXJuIHEoKX0sbiksby5leHBvbmVudGlhbEJhY2tPZmZUaW1lKj0yKTooSihlLndhcm4oIldlYlNvY2tldCBVUkwgY2Fubm90IGJlIHVzZWQgdG8gZXN0YWJsaXNoIGNvbm5lY3Rpb24iKSksVSgpKX0sSD1mdW5jdGlvbihuKXtOKCksXygpLEooZS5lcnJvcigiV2ViU29ja2V0IEluaXRpYWxpemF0aW9uIGZhaWxlZCIpKSxvLndlYnNvY2tldEluaXRGYWlsZWQ9ITAsTSgiVGVybWluYXRpbmcgV2ViU29ja2V0IE1hbmFnZXIiKSxjbGVhckludGVydmFsKFMpLGsoYy5pbml0RmFpbHVyZSx7Y29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQ6ci5jb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudCxjb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZTpyLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lLHJlYXNvbjpufSksRigpfSxHPWZ1bmN0aW9uKGUsbil7cmV0dXJuIEpTT04uc3RyaW5naWZ5KHt0b3BpYzplLGNvbnRlbnQ6bn0pfSx6PWZ1bmN0aW9uKG4pe3JldHVybiEhKHkuaXNPYmplY3QobikmJnkuaXNPYmplY3Qobi53ZWJTb2NrZXRUcmFuc3BvcnQpJiZ5LmlzTm9uRW1wdHlTdHJpbmcobi53ZWJTb2NrZXRUcmFuc3BvcnQudXJsKSYmeS52YWxpZFdTVXJsKG4ud2ViU29ja2V0VHJhbnNwb3J0LnVybCkmJjFlMypuLndlYlNvY2tldFRyYW5zcG9ydC50cmFuc3BvcnRMaWZlVGltZUluU2Vjb25kcz49M2U1KXx8KEooZS5lcnJvcigiSW52YWxpZCBXZWJTb2NrZXQgQ29ubmVjdGlvbiBDb25maWd1cmF0aW9uIixuKSksITEpfSxVPWZ1bmN0aW9uKCl7aWYoeS5pc05ldHdvcmtPbmxpbmUoKSlpZihvLndlYnNvY2tldEluaXRGYWlsZWQpSihlLmRlYnVnKCJXZWJTb2NrZXQgSW5pdCBoYWQgZmFpbGVkLCBpZ25vcmluZyB0aGlzIGdldFdlYlNvY2tldENvbm5Db25maWcgcmVxdWVzdCIpKTtlbHNle2lmKHMucHJvbWlzZUNvbXBsZXRlZClyZXR1cm4gTigpLEooZS5pbmZvKCJGZXRjaGluZyBuZXcgV2ViU29ja2V0IGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbiIpKSxyLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lPXIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWV8fERhdGUubm93KCkscy5wcm9taXNlQ29tcGxldGVkPSExLHMucHJvbWlzZUhhbmRsZT1jLmdldFdlYlNvY2tldFRyYW5zcG9ydCgpLHMucHJvbWlzZUhhbmRsZS50aGVuKGZ1bmN0aW9uKG4pe3JldHVybiBzLnByb21pc2VDb21wbGV0ZWQ9ITAsSihlLmRlYnVnKCJTdWNjZXNzZnVsbHkgZmV0Y2hlZCB3ZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uIixuKSkseihuKT8ocy5jb25uQ29uZmlnPW4scy5jb25uQ29uZmlnLnVybENvbm5WYWxpZFRpbWU9RGF0ZS5ub3coKSs4NWUzLGcuY29ubmVjdGVkKCkscSgpKTooSCgiSW52YWxpZCBXZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uOiAiK24pLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfSl9LGZ1bmN0aW9uKG4pe3JldHVybiBzLnByb21pc2VDb21wbGV0ZWQ9ITAsSihlLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggd2ViU29ja2V0IGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbiIsbikpLHkuaXNOZXR3b3JrRmFpbHVyZShuKT8oSihlLmluZm8oIlJldHJ5aW5nIGZldGNoaW5nIG5ldyBXZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uIikpLGcucmV0cnkoKSk6SCgiRmFpbGVkIHRvIGZldGNoIHdlYlNvY2tldCBjb25uZWN0aW9uIGNvbmZpZ3VyYXRpb246ICIrSlNPTi5zdHJpbmdpZnkobikpLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfX0pO0ooZS5kZWJ1ZygiVGhlcmUgaXMgYW4gb25nb2luZyBnZXRXZWJTb2NrZXRDb25uQ29uZmlnIHJlcXVlc3QsIHRoaXMgcmVxdWVzdCB3aWxsIGJlIGlnbm9yZWQiKSl9ZWxzZSBKKGUuaW5mbygiTmV0d29yayBvZmZsaW5lLCBpZ25vcmluZyB0aGlzIGdldFdlYlNvY2tldENvbm5Db25maWcgcmVxdWVzdCIpKX0scT1mdW5jdGlvbigpe2lmKG8ud2Vic29ja2V0SW5pdEZhaWxlZClyZXR1cm4gSihlLmluZm8oIndlYi1zb2NrZXQgaW5pdGlhbGl6aW5nIGhhZCBmYWlsZWQsIGFib3J0aW5nIHJlLWluaXQiKSkse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITB9O2lmKCF5LmlzTmV0d29ya09ubGluZSgpKXJldHVybiBKKGUud2FybigiU3lzdGVtIGlzIG9mZmxpbmUgYWJvcnRpbmcgd2ViLXNvY2tldCBpbml0IikpLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfTtKKGUuaW5mbygiSW5pdGlhbGl6aW5nIFdlYnNvY2tldCBNYW5hZ2VyIikpLHYoImluaXRXZWJTb2NrZXQiKTt0cnl7aWYoeihzLmNvbm5Db25maWcpKXt2YXIgbj1udWxsO3JldHVybiBDKHQucHJpbWFyeSk/KEooZS5kZWJ1ZygiUHJpbWFyeSBTb2NrZXQgY29ubmVjdGlvbiBpcyBhbHJlYWR5IG9wZW4iKSksdyh0LnNlY29uZGFyeSxXZWJTb2NrZXQuQ09OTkVDVElORyl8fChKKGUuZGVidWcoIkVzdGFibGlzaGluZyBhIHNlY29uZGFyeSB3ZWItc29ja2V0IGNvbm5lY3Rpb24iKSksdC5zZWNvbmRhcnk9QigpKSxuPXQuc2Vjb25kYXJ5KToodyh0LnByaW1hcnksV2ViU29ja2V0LkNPTk5FQ1RJTkcpfHwoSihlLmRlYnVnKCJFc3RhYmxpc2hpbmcgYSBwcmltYXJ5IHdlYi1zb2NrZXQgY29ubmVjdGlvbiIpKSx0LnByaW1hcnk9QigpKSxuPXQucHJpbWFyeSksby53ZWJTb2NrZXRJbml0Q2hlY2tlclRpbWVvdXRJZD1zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7QyhuKXx8UCgpfSwxZTMpLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiExfX19Y2F0Y2gobil7cmV0dXJuIEooZS5lcnJvcigiRXJyb3IgSW5pdGlhbGl6aW5nIHdlYi1zb2NrZXQtbWFuYWdlciIsbikpLEgoIkZhaWxlZCB0byBpbml0aWFsaXplIG5ldyBXZWJTb2NrZXQ6ICIrbi5tZXNzYWdlKSx7d2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZDohMH19fSxCPWZ1bmN0aW9uKCl7dmFyIG49bmV3IFdlYlNvY2tldChzLmNvbm5Db25maWcud2ViU29ja2V0VHJhbnNwb3J0LnVybCk7cmV0dXJuIG4uYWRkRXZlbnRMaXN0ZW5lcigib3BlbiIseCksbi5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIixqKSxuLmFkZEV2ZW50TGlzdGVuZXIoImVycm9yIixSKSxuLmFkZEV2ZW50TGlzdGVuZXIoImNsb3NlIixmdW5jdGlvbihpKXtyZXR1cm4gZnVuY3Rpb24obixpKXtKKGUuaW5mbygiU29ja2V0IGNvbm5lY3Rpb24gaXMgY2xvc2VkIixuKSksdigid2ViU29ja2V0T25DbG9zZSBiZWZvcmUtY2xlYW51cCIpLGsoYy5jb25uZWN0aW9uQ2xvc2Use29wZW5UaW1lc3RhbXA6aS5vcGVuVGltZXN0YW1wLGNsb3NlVGltZXN0YW1wOkRhdGUubm93KCksY29ubmVjdGlvbkR1cmF0aW9uOkRhdGUubm93KCktaS5vcGVuVGltZXN0YW1wLGNvZGU6bi5jb2RlLHJlYXNvbjpuLnJlYXNvbn0pLFQodC5wcmltYXJ5KSYmKHQucHJpbWFyeT1udWxsKSxUKHQuc2Vjb25kYXJ5KSYmKHQuc2Vjb25kYXJ5PW51bGwpLG8ucmVjb25uZWN0V2ViU29ja2V0JiYoQyh0LnByaW1hcnkpfHxDKHQuc2Vjb25kYXJ5KT9UKHQucHJpbWFyeSkmJkModC5zZWNvbmRhcnkpJiYoSihlLmluZm8oIltQcmltYXJ5XSBXZWJTb2NrZXQgQ2xlYW5seSBDbG9zZWQiKSksdC5wcmltYXJ5PXQuc2Vjb25kYXJ5LHQuc2Vjb25kYXJ5PW51bGwpOihKKGUud2FybigiTmVpdGhlciBwcmltYXJ5IHdlYnNvY2tldCBhbmQgbm9yIHNlY29uZGFyeSB3ZWJzb2NrZXQgaGF2ZSBvcGVuIGNvbm5lY3Rpb25zLCBhdHRlbXB0aW5nIHRvIHJlLWVzdGFibGlzaCBjb25uZWN0aW9uIikpLG8uY29ublN0YXRlPT09cD9KKGUuaW5mbygiSWdub3JpbmcgY29ubmVjdGlvbkxvc3QgY2FsbGJhY2sgaW52b2NhdGlvbiIpKTooayhjLmNvbm5lY3Rpb25Mb3N0LHtvcGVuVGltZXN0YW1wOmkub3BlblRpbWVzdGFtcCxjbG9zZVRpbWVzdGFtcDpEYXRlLm5vdygpLGNvbm5lY3Rpb25EdXJhdGlvbjpEYXRlLm5vdygpLWkub3BlblRpbWVzdGFtcCxjb2RlOm4uY29kZSxyZWFzb246bi5yZWFzb259KSxyLm5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wPURhdGUubm93KCkpLG8uY29ublN0YXRlPXAsVSgpKSx2KCJ3ZWJTb2NrZXRPbkNsb3NlIGFmdGVyLWNsZWFudXAiKSl9KGksbil9KSxufSxKPWZ1bmN0aW9uKGUpe3JldHVybiBlJiYiZnVuY3Rpb24iPT10eXBlb2YgZS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlciYmZS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpLGV9O3RoaXMuaW5pdD1mdW5jdGlvbihuKXtpZih5LmFzc2VydFRydWUoeS5pc0Z1bmN0aW9uKG4pLCJ0cmFuc3BvcnRIYW5kbGUgbXVzdCBiZSBhIGZ1bmN0aW9uIiksbnVsbD09PWMuZ2V0V2ViU29ja2V0VHJhbnNwb3J0KXJldHVybiBjLmdldFdlYlNvY2tldFRyYW5zcG9ydD1uLFUoKTtKKGUud2FybigiV2ViIFNvY2tldCBNYW5hZ2VyIHdhcyBhbHJlYWR5IGluaXRpYWxpemVkIikpfSx0aGlzLm9uSW5pdEZhaWx1cmU9ZnVuY3Rpb24oZSl7cmV0dXJuIHkuYXNzZXJ0VHJ1ZSh5LmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuaW5pdEZhaWx1cmUuYWRkKGUpLG8ud2Vic29ja2V0SW5pdEZhaWxlZCYmZSgpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuaW5pdEZhaWx1cmUuZGVsZXRlKGUpfX0sdGhpcy5vbkNvbm5lY3Rpb25PcGVuPWZ1bmN0aW9uKGUpe3JldHVybiB5LmFzc2VydFRydWUoeS5pc0Z1bmN0aW9uKGUpLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmNvbm5lY3Rpb25PcGVuLmFkZChlKSxmdW5jdGlvbigpe3JldHVybiBjLmNvbm5lY3Rpb25PcGVuLmRlbGV0ZShlKX19LHRoaXMub25Db25uZWN0aW9uQ2xvc2U9ZnVuY3Rpb24oZSl7cmV0dXJuIHkuYXNzZXJ0VHJ1ZSh5LmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuY29ubmVjdGlvbkNsb3NlLmFkZChlKSxmdW5jdGlvbigpe3JldHVybiBjLmNvbm5lY3Rpb25DbG9zZS5kZWxldGUoZSl9fSx0aGlzLm9uQ29ubmVjdGlvbkdhaW49ZnVuY3Rpb24oZSl7cmV0dXJuIHkuYXNzZXJ0VHJ1ZSh5LmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuY29ubmVjdGlvbkdhaW4uYWRkKGUpLEkoKSYmZSgpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuY29ubmVjdGlvbkdhaW4uZGVsZXRlKGUpfX0sdGhpcy5vbkNvbm5lY3Rpb25Mb3N0PWZ1bmN0aW9uKGUpe3JldHVybiB5LmFzc2VydFRydWUoeS5pc0Z1bmN0aW9uKGUpLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmNvbm5lY3Rpb25Mb3N0LmFkZChlKSxvLmNvbm5TdGF0ZT09PXAmJmUoKSxmdW5jdGlvbigpe3JldHVybiBjLmNvbm5lY3Rpb25Mb3N0LmRlbGV0ZShlKX19LHRoaXMub25TdWJzY3JpcHRpb25VcGRhdGU9ZnVuY3Rpb24oZSl7cmV0dXJuIHkuYXNzZXJ0VHJ1ZSh5LmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuc3Vic2NyaXB0aW9uVXBkYXRlLmFkZChlKSxmdW5jdGlvbigpe3JldHVybiBjLnN1YnNjcmlwdGlvblVwZGF0ZS5kZWxldGUoZSl9fSx0aGlzLm9uU3Vic2NyaXB0aW9uRmFpbHVyZT1mdW5jdGlvbihlKXtyZXR1cm4geS5hc3NlcnRUcnVlKHkuaXNGdW5jdGlvbihlKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5zdWJzY3JpcHRpb25GYWlsdXJlLmFkZChlKSxmdW5jdGlvbigpe3JldHVybiBjLnN1YnNjcmlwdGlvbkZhaWx1cmUuZGVsZXRlKGUpfX0sdGhpcy5vbk1lc3NhZ2U9ZnVuY3Rpb24oZSxuKXtyZXR1cm4geS5hc3NlcnROb3ROdWxsKGUsInRvcGljTmFtZSIpLHkuYXNzZXJ0VHJ1ZSh5LmlzRnVuY3Rpb24obiksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMudG9waWMuaGFzKGUpP2MudG9waWMuZ2V0KGUpLmFkZChuKTpjLnRvcGljLnNldChlLG5ldyBTZXQoW25dKSksZnVuY3Rpb24oKXtyZXR1cm4gYy50b3BpYy5nZXQoZSkuZGVsZXRlKG4pfX0sdGhpcy5vbkFsbE1lc3NhZ2U9ZnVuY3Rpb24oZSl7cmV0dXJuIHkuYXNzZXJ0VHJ1ZSh5LmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuYWxsTWVzc2FnZS5hZGQoZSksZnVuY3Rpb24oKXtyZXR1cm4gYy5hbGxNZXNzYWdlLmRlbGV0ZShlKX19LHRoaXMuc3Vic2NyaWJlVG9waWNzPWZ1bmN0aW9uKGUpe3kuYXNzZXJ0Tm90TnVsbChlLCJ0b3BpY3MiKSx5LmFzc2VydElzTGlzdChlKSxlLmZvckVhY2goZnVuY3Rpb24oZSl7ZC5zdWJzY3JpYmVkLmhhcyhlKXx8ZC5wZW5kaW5nLmFkZChlKX0pLGIuY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdD0wLEEoKX0sdGhpcy5zZW5kTWVzc2FnZT1mdW5jdGlvbihuKXtpZih5LmFzc2VydElzT2JqZWN0KG4sInBheWxvYWQiKSx2b2lkIDA9PT1uLnRvcGljfHxtLmhhcyhuLnRvcGljKSlKKGUud2FybigiQ2Fubm90IHNlbmQgbWVzc2FnZSwgSW52YWxpZCB0b3BpYyIsbikpO2Vsc2V7dHJ5e249SlNPTi5zdHJpbmdpZnkobil9Y2F0Y2godCl7cmV0dXJuIHZvaWQgSihlLndhcm4oIkVycm9yIHN0cmluZ2lmeSBtZXNzYWdlIixuKSl9SSgpP08oKS5zZW5kKG4pOkooZS53YXJuKCJDYW5ub3Qgc2VuZCBtZXNzYWdlLCB3ZWIgc29ja2V0IGNvbm5lY3Rpb24gaXMgbm90IG9wZW4iKSl9fSx0aGlzLmNsb3NlV2ViU29ja2V0PWZ1bmN0aW9uKCl7TigpLF8oKSxvLnJlY29ubmVjdFdlYlNvY2tldD0hMSxjbGVhckludGVydmFsKFMpLE0oIlVzZXIgcmVxdWVzdCB0byBjbG9zZSBXZWJTb2NrZXQiKX0sdGhpcy50ZXJtaW5hdGVXZWJTb2NrZXRNYW5hZ2VyPUh9LFI9e2NyZWF0ZTpmdW5jdGlvbigpe3JldHVybiBuZXcgeH0sc2V0R2xvYmFsQ29uZmlnOmZ1bmN0aW9uKGUpe3ZhciBuPWUubG9nZ2VyQ29uZmlnO0UudXBkYXRlTG9nZ2VyQ29uZmlnKG4pfSxMb2dMZXZlbDpPLExvZ2dlcjpUfX0sZnVuY3Rpb24oZSxuLHQpe3ZhciBvOyFmdW5jdGlvbigpeyJ1c2Ugc3RyaWN0Ijt2YXIgcj17bm90X3N0cmluZzovW15zXS8sbm90X2Jvb2w6L1tedF0vLG5vdF90eXBlOi9bXlRdLyxub3RfcHJpbWl0aXZlOi9bXnZdLyxudW1iZXI6L1tkaWVmZ10vLG51bWVyaWNfYXJnOi9bYmNkaWVmZ3V4WF0vLGpzb246L1tqXS8sbm90X2pzb246L1teal0vLHRleHQ6L15bXlx4MjVdKy8sbW9kdWxvOi9eXHgyNXsyfS8scGxhY2Vob2xkZXI6L15ceDI1KD86KFsxLTldXGQqKVwkfFwoKFteKV0rKVwpKT8oXCspPygwfCdbXiRdKT8oLSk/KFxkKyk/KD86XC4oXGQrKSk/KFtiLWdpam9zdFR1dnhYXSkvLGtleTovXihbYS16X11bYS16X1xkXSopL2ksa2V5X2FjY2VzczovXlwuKFthLXpfXVthLXpfXGRdKikvaSxpbmRleF9hY2Nlc3M6L15cWyhcZCspXF0vLHNpZ246L15bKy1dL307ZnVuY3Rpb24gaShlKXtyZXR1cm4gZnVuY3Rpb24oZSxuKXt2YXIgdCxvLGMscyxhLHUsbCxmLHAsZD0xLGI9ZS5sZW5ndGgsZz0iIjtmb3Iobz0wO288YjtvKyspaWYoInN0cmluZyI9PXR5cGVvZiBlW29dKWcrPWVbb107ZWxzZSBpZigib2JqZWN0Ij09dHlwZW9mIGVbb10pe2lmKChzPWVbb10pLmtleXMpZm9yKHQ9bltkXSxjPTA7YzxzLmtleXMubGVuZ3RoO2MrKyl7aWYobnVsbD09dCl0aHJvdyBuZXcgRXJyb3IoaSgnW3NwcmludGZdIENhbm5vdCBhY2Nlc3MgcHJvcGVydHkgIiVzIiBvZiB1bmRlZmluZWQgdmFsdWUgIiVzIicscy5rZXlzW2NdLHMua2V5c1tjLTFdKSk7dD10W3Mua2V5c1tjXV19ZWxzZSB0PXMucGFyYW1fbm8/bltzLnBhcmFtX25vXTpuW2QrK107aWYoci5ub3RfdHlwZS50ZXN0KHMudHlwZSkmJnIubm90X3ByaW1pdGl2ZS50ZXN0KHMudHlwZSkmJnQgaW5zdGFuY2VvZiBGdW5jdGlvbiYmKHQ9dCgpKSxyLm51bWVyaWNfYXJnLnRlc3Qocy50eXBlKSYmIm51bWJlciIhPXR5cGVvZiB0JiZpc05hTih0KSl0aHJvdyBuZXcgVHlwZUVycm9yKGkoIltzcHJpbnRmXSBleHBlY3RpbmcgbnVtYmVyIGJ1dCBmb3VuZCAlVCIsdCkpO3N3aXRjaChyLm51bWJlci50ZXN0KHMudHlwZSkmJihmPXQ+PTApLHMudHlwZSl7Y2FzZSJiIjp0PXBhcnNlSW50KHQsMTApLnRvU3RyaW5nKDIpO2JyZWFrO2Nhc2UiYyI6dD1TdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KHQsMTApKTticmVhaztjYXNlImQiOmNhc2UiaSI6dD1wYXJzZUludCh0LDEwKTticmVhaztjYXNlImoiOnQ9SlNPTi5zdHJpbmdpZnkodCxudWxsLHMud2lkdGg/cGFyc2VJbnQocy53aWR0aCk6MCk7YnJlYWs7Y2FzZSJlIjp0PXMucHJlY2lzaW9uP3BhcnNlRmxvYXQodCkudG9FeHBvbmVudGlhbChzLnByZWNpc2lvbik6cGFyc2VGbG9hdCh0KS50b0V4cG9uZW50aWFsKCk7YnJlYWs7Y2FzZSJmIjp0PXMucHJlY2lzaW9uP3BhcnNlRmxvYXQodCkudG9GaXhlZChzLnByZWNpc2lvbik6cGFyc2VGbG9hdCh0KTticmVhaztjYXNlImciOnQ9cy5wcmVjaXNpb24/U3RyaW5nKE51bWJlcih0LnRvUHJlY2lzaW9uKHMucHJlY2lzaW9uKSkpOnBhcnNlRmxvYXQodCk7YnJlYWs7Y2FzZSJvIjp0PShwYXJzZUludCh0LDEwKT4+PjApLnRvU3RyaW5nKDgpO2JyZWFrO2Nhc2UicyI6dD1TdHJpbmcodCksdD1zLnByZWNpc2lvbj90LnN1YnN0cmluZygwLHMucHJlY2lzaW9uKTp0O2JyZWFrO2Nhc2UidCI6dD1TdHJpbmcoISF0KSx0PXMucHJlY2lzaW9uP3Quc3Vic3RyaW5nKDAscy5wcmVjaXNpb24pOnQ7YnJlYWs7Y2FzZSJUIjp0PU9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh0KS5zbGljZSg4LC0xKS50b0xvd2VyQ2FzZSgpLHQ9cy5wcmVjaXNpb24/dC5zdWJzdHJpbmcoMCxzLnByZWNpc2lvbik6dDticmVhaztjYXNlInUiOnQ9cGFyc2VJbnQodCwxMCk+Pj4wO2JyZWFrO2Nhc2UidiI6dD10LnZhbHVlT2YoKSx0PXMucHJlY2lzaW9uP3Quc3Vic3RyaW5nKDAscy5wcmVjaXNpb24pOnQ7YnJlYWs7Y2FzZSJ4Ijp0PShwYXJzZUludCh0LDEwKT4+PjApLnRvU3RyaW5nKDE2KTticmVhaztjYXNlIlgiOnQ9KHBhcnNlSW50KHQsMTApPj4+MCkudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCl9ci5qc29uLnRlc3Qocy50eXBlKT9nKz10Oighci5udW1iZXIudGVzdChzLnR5cGUpfHxmJiYhcy5zaWduP3A9IiI6KHA9Zj8iKyI6Ii0iLHQ9dC50b1N0cmluZygpLnJlcGxhY2Uoci5zaWduLCIiKSksdT1zLnBhZF9jaGFyPyIwIj09PXMucGFkX2NoYXI/IjAiOnMucGFkX2NoYXIuY2hhckF0KDEpOiIgIixsPXMud2lkdGgtKHArdCkubGVuZ3RoLGE9cy53aWR0aCYmbD4wP3UucmVwZWF0KGwpOiIiLGcrPXMuYWxpZ24/cCt0K2E6IjAiPT09dT9wK2ErdDphK3ArdCl9cmV0dXJuIGd9KGZ1bmN0aW9uKGUpe2lmKHNbZV0pcmV0dXJuIHNbZV07dmFyIG4sdD1lLG89W10saT0wO2Zvcig7dDspe2lmKG51bGwhPT0obj1yLnRleHQuZXhlYyh0KSkpby5wdXNoKG5bMF0pO2Vsc2UgaWYobnVsbCE9PShuPXIubW9kdWxvLmV4ZWModCkpKW8ucHVzaCgiJSIpO2Vsc2V7aWYobnVsbD09PShuPXIucGxhY2Vob2xkZXIuZXhlYyh0KSkpdGhyb3cgbmV3IFN5bnRheEVycm9yKCJbc3ByaW50Zl0gdW5leHBlY3RlZCBwbGFjZWhvbGRlciIpO2lmKG5bMl0pe2l8PTE7dmFyIGM9W10sYT1uWzJdLHU9W107aWYobnVsbD09PSh1PXIua2V5LmV4ZWMoYSkpKXRocm93IG5ldyBTeW50YXhFcnJvcigiW3NwcmludGZdIGZhaWxlZCB0byBwYXJzZSBuYW1lZCBhcmd1bWVudCBrZXkiKTtmb3IoYy5wdXNoKHVbMV0pOyIiIT09KGE9YS5zdWJzdHJpbmcodVswXS5sZW5ndGgpKTspaWYobnVsbCE9PSh1PXIua2V5X2FjY2Vzcy5leGVjKGEpKSljLnB1c2godVsxXSk7ZWxzZXtpZihudWxsPT09KHU9ci5pbmRleF9hY2Nlc3MuZXhlYyhhKSkpdGhyb3cgbmV3IFN5bnRheEVycm9yKCJbc3ByaW50Zl0gZmFpbGVkIHRvIHBhcnNlIG5hbWVkIGFyZ3VtZW50IGtleSIpO2MucHVzaCh1WzFdKX1uWzJdPWN9ZWxzZSBpfD0yO2lmKDM9PT1pKXRocm93IG5ldyBFcnJvcigiW3NwcmludGZdIG1peGluZyBwb3NpdGlvbmFsIGFuZCBuYW1lZCBwbGFjZWhvbGRlcnMgaXMgbm90ICh5ZXQpIHN1cHBvcnRlZCIpO28ucHVzaCh7cGxhY2Vob2xkZXI6blswXSxwYXJhbV9ubzpuWzFdLGtleXM6blsyXSxzaWduOm5bM10scGFkX2NoYXI6bls0XSxhbGlnbjpuWzVdLHdpZHRoOm5bNl0scHJlY2lzaW9uOm5bN10sdHlwZTpuWzhdfSl9dD10LnN1YnN0cmluZyhuWzBdLmxlbmd0aCl9cmV0dXJuIHNbZV09b30oZSksYXJndW1lbnRzKX1mdW5jdGlvbiBjKGUsbil7cmV0dXJuIGkuYXBwbHkobnVsbCxbZV0uY29uY2F0KG58fFtdKSl9dmFyIHM9T2JqZWN0LmNyZWF0ZShudWxsKTtuLnNwcmludGY9aSxuLnZzcHJpbnRmPWMsInVuZGVmaW5lZCIhPXR5cGVvZiB3aW5kb3cmJih3aW5kb3cuc3ByaW50Zj1pLHdpbmRvdy52c3ByaW50Zj1jLHZvaWQgMD09PShvPWZ1bmN0aW9uKCl7cmV0dXJue3NwcmludGY6aSx2c3ByaW50ZjpjfX0uY2FsbChuLHQsbixlKSl8fChlLmV4cG9ydHM9bykpfSgpfSxmdW5jdGlvbihlLG4sdCl7InVzZSBzdHJpY3QiO3QucihuKSxmdW5jdGlvbihlKXt0LmQobiwiV2ViU29ja2V0TWFuYWdlciIsZnVuY3Rpb24oKXtyZXR1cm4gcn0pO3ZhciBvPXQoMCk7ZS5jb25uZWN0PWUuY29ubmVjdHx8e30sY29ubmVjdC5XZWJTb2NrZXRNYW5hZ2VyPW8uYTt2YXIgcj1vLmF9LmNhbGwodGhpcyx0KDMpKX0sZnVuY3Rpb24oZSxuKXt2YXIgdDt0PWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXN9KCk7dHJ5e3Q9dHx8bmV3IEZ1bmN0aW9uKCJyZXR1cm4gdGhpcyIpKCl9Y2F0Y2goZSl7Im9iamVjdCI9PXR5cGVvZiB3aW5kb3cmJih0PXdpbmRvdyl9ZS5leHBvcnRzPXR9XSk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPWFtYXpvbi1jb25uZWN0LXdlYnNvY2tldC1tYW5hZ2VyLmpzLm1hcAoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgY29ubmVjdC5jb3JlID0ge307CiAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gZmFsc2U7CiAgY29ubmVjdC52ZXJzaW9uID0gIjEuNi40IjsKICBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRSA9IDUwMDsKIAogIHZhciBDQ1BfU1lOX1RJTUVPVVQgPSAxMDAwOyAvLyAxIHNlYwogIHZhciBDQ1BfQUNLX1RJTUVPVVQgPSAzMDAwOyAvLyAzIHNlYwogIHZhciBDQ1BfTE9BRF9USU1FT1VUID0gMzAwMDsgLy8gMyBzZWMKICB2YXIgQ0NQX0lGUkFNRV9SRUZSRVNIX0lOVEVSVkFMID0gNTAwMDsgLy8gNSBzZWMKICB2YXIgQ0NQX0RSX0lGUkFNRV9SRUZSRVNIX0lOVEVSVkFMID0gMTAwMDA7IC8vMTAgcwogCiAgdmFyIExFR0FDWV9MT0dJTl9VUkxfUEFUVEVSTiA9ICJodHRwczovL3thbGlhc30uYXdzYXBwcy5jb20vYXV0aC8/Y2xpZW50X2lkPXtjbGllbnRfaWR9JnJlZGlyZWN0X3VyaT17cmVkaXJlY3R9IjsKICB2YXIgQ0xJRU5UX0lEX01BUCA9IHsKICAgICJ1cy1lYXN0LTEiOiAiMDY5MTlmNGZkOGVkMzI0ZSIKICB9OwogCiAgdmFyIEFVVEhPUklaRV9FTkRQT0lOVCA9ICIvYXV0aC9hdXRob3JpemUiOwogIHZhciBMRUdBQ1lfQVVUSE9SSVpFX0VORFBPSU5UID0gIi9jb25uZWN0L2F1dGgvYXV0aG9yaXplIjsKICB2YXIgQVVUSE9SSVpFX1JFVFJZX0lOVEVSVkFMID0gMjAwMDsKICB2YXIgQVVUSE9SSVpFX01BWF9SRVRSWSA9IDU7CiAKICB2YXIgTEVHQUNZX1dISVRFTElTVEVEX09SSUdJTlNfRU5EUE9JTlQgPSAiL2Nvbm5lY3Qvd2hpdGVsaXN0ZWQtb3JpZ2lucyI7CiAgdmFyIFdISVRFTElTVEVEX09SSUdJTlNfRU5EUE9JTlQgPSAiL3doaXRlbGlzdGVkLW9yaWdpbnMiOwogIHZhciBXSElURUxJU1RFRF9PUklHSU5TX1JFVFJZX0lOVEVSVkFMID0gMjAwMDsKICB2YXIgV0hJVEVMSVNURURfT1JJR0lOU19NQVhfUkVUUlkgPSA1OwoKICBjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQcyA9IDA7CgogIC8qKgogICAqIEBkZXByZWNhdGVkCiAgICogVGhpcyBmdW5jdGlvbiB3YXMgb25seSBtZWFudCBmb3IgaW50ZXJuYWwgdXNlLiAKICAgKiBUaGUgbmFtZSBpcyBtaXNsZWFkaW5nIGZvciB3aGF0IGl0IHNob3VsZCBkby4KICAgKiBJbnRlcm5hbGx5IHdlIGhhdmUgcmVwbGFjZWQgaXRzIHVzYWdlIHdpdGggYGdldExvZ2luVXJsYC4KICAgKi8KICB2YXIgY3JlYXRlTG9naW5VcmwgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICB2YXIgcmVkaXJlY3QgPSAiaHR0cHM6Ly9saWx5LnVzLWVhc3QtMS5hbWF6b25hd3MuY29tL3Rhdy9hdXRoL2NvZGUiOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJlZGlyZWN0KTsKIAogICAgaWYgKHBhcmFtcy5sb2dpblVybCkgewogICAgICByZXR1cm4gcGFyYW1zLmxvZ2luVXJsCiAgICB9IGVsc2UgaWYgKHBhcmFtcy5hbGlhcykgewogICAgICBsb2cud2FybigiVGhlIGBhbGlhc2AgcGFyYW0gaXMgZGVwcmVjYXRlZCBhbmQgc2hvdWxkIG5vdCBiZSBleHBlY3RlZCB0byBmdW5jdGlvbiBwcm9wZXJseS4gUGxlYXNlIHVzZSBgY2NwVXJsYCBvciBgbG9naW5VcmxgLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2FtYXpvbi1jb25uZWN0L2FtYXpvbi1jb25uZWN0LXN0cmVhbXMvYmxvYi9tYXN0ZXIvUkVBRE1FLm1kI2Nvbm5lY3Rjb3JlaW5pdGNjcCBmb3IgdmFsaWQgcGFyYW1ldGVycy4iKTsKICAgICAgcmV0dXJuIExFR0FDWV9MT0dJTl9VUkxfUEFUVEVSTgogICAgICAgIC5yZXBsYWNlKCJ7YWxpYXN9IiwgcGFyYW1zLmFsaWFzKQogICAgICAgIC5yZXBsYWNlKCJ7Y2xpZW50X2lkfSIsIENMSUVOVF9JRF9NQVBbInVzLWVhc3QtMSJdKQogICAgICAgIC5yZXBsYWNlKCJ7cmVkaXJlY3R9IiwgZ2xvYmFsLmVuY29kZVVSSUNvbXBvbmVudCgKICAgICAgICAgIHJlZGlyZWN0KSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gcGFyYW1zLmNjcFVybDsKICAgIH0KICB9OwoKICAvKioKICAgKiBSZXBsYWNlcyBgY3JlYXRlTG9naW5VcmxgLCBhcyB0aGF0IGZ1bmN0aW9uJ3MgbmFtZSB3YXMgbWlzbGVhZGluZy4KICAgKiBUaGUgYHBhcmFtcy5hbGlhc2AgcGFyYW1ldGVyIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSByZWZyYWluIGZyb20gdXNpbmcgaXQuCiAgICovCiAgdmFyIGdldExvZ2luVXJsID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgdmFyIHJlZGlyZWN0ID0gImh0dHBzOi8vbGlseS51cy1lYXN0LTEuYW1hem9uYXdzLmNvbS90YXcvYXV0aC9jb2RlIjsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChyZWRpcmVjdCk7CiAgICBpZiAocGFyYW1zLmxvZ2luVXJsKSB7CiAgICAgIHJldHVybiBwYXJhbXMubG9naW5VcmwKICAgIH0gZWxzZSBpZiAocGFyYW1zLmFsaWFzKSB7CiAgICAgIGxvZy53YXJuKCJUaGUgYGFsaWFzYCBwYXJhbSBpcyBkZXByZWNhdGVkIGFuZCBzaG91bGQgbm90IGJlIGV4cGVjdGVkIHRvIGZ1bmN0aW9uIHByb3Blcmx5LiBQbGVhc2UgdXNlIGBjY3BVcmxgIG9yIGBsb2dpblVybGAuIFNlZSBodHRwczovL2dpdGh1Yi5jb20vYW1hem9uLWNvbm5lY3QvYW1hem9uLWNvbm5lY3Qtc3RyZWFtcy9ibG9iL21hc3Rlci9SRUFETUUubWQjY29ubmVjdGNvcmVpbml0Y2NwIGZvciB2YWxpZCBwYXJhbWV0ZXJzLiIpOwogICAgICByZXR1cm4gTEVHQUNZX0xPR0lOX1VSTF9QQVRURVJOCiAgICAgICAgLnJlcGxhY2UoInthbGlhc30iLCBwYXJhbXMuYWxpYXMpCiAgICAgICAgLnJlcGxhY2UoIntjbGllbnRfaWR9IiwgQ0xJRU5UX0lEX01BUFsidXMtZWFzdC0xIl0pCiAgICAgICAgLnJlcGxhY2UoIntyZWRpcmVjdH0iLCBnbG9iYWwuZW5jb2RlVVJJQ29tcG9uZW50KAogICAgICAgICAgcmVkaXJlY3QpKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBwYXJhbXMuY2NwVXJsOwogICAgfQogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBSZXR1cm5zIHNjaGVtZTovL2hvc3Q6cG9ydCBmb3IgYSBnaXZlbiB1cmwKICAqLwogIGZ1bmN0aW9uIHNhbml0aXplRG9tYWluKHVybCkgewogICAgdmFyIGRvbWFpbiA9IHVybC5tYXRjaCgvXig/Omh0dHBzPzpcL1wvKT8oPzpbXkBcbl0rQCk/KD86d3d3XC4pPyhbXjpcL1xuP10rKS9pZyk7CiAgICByZXR1cm4gZG9tYWluLmxlbmd0aCA/IGRvbWFpblswXSA6ICIiOwogIH0KIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogUHJpbnQgYSB3YXJuaW5nIG1lc3NhZ2UgaWYgdGhlIENvbm5lY3QgY29yZSBpcyBub3QgaW5pdGlhbGl6ZWQuCiAgICAqLwogIGNvbm5lY3QuY29yZS5jaGVja05vdEluaXRpYWxpemVkID0gZnVuY3Rpb24gKCkgewogICAgaWYgKGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCkgewogICAgICB2YXIgbG9nID0gY29ubmVjdC5nZXRMb2coKTsKICAgICAgbG9nLndhcm4oIkNvbm5lY3QgY29yZSBhbHJlYWR5IGluaXRpYWxpemVkLCBvbmx5IG5lZWRzIHRvIGJlIGluaXRpYWxpemVkIG9uY2UuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICB9OwogCiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBESVNBU1RFUiBSRUNPVkVSWSAKICAqLwogIAogIHZhciBtYWtlQWdlbnRPZmZsaW5lID0gZnVuY3Rpb24oYWdlbnQsIGNhbGxiYWNrcykgewogICAgdmFyIG9mZmxpbmVTdGF0ZSA9IGFnZW50LmdldEFnZW50U3RhdGVzKCkuZmluZChmdW5jdGlvbiAoc3RhdGUpIHsKICAgICAgcmV0dXJuIHN0YXRlLnR5cGUgPT09IGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUuT0ZGTElORTsKICAgIH0pOwogICAgYWdlbnQuc2V0U3RhdGUob2ZmbGluZVN0YXRlLCBjYWxsYmFja3MpOyAgIAogIH0KIAogIC8vIFN1cHByZXNzIENvbnRhY3RzIGZ1bmN0aW9uIAogIC8vIFRoaXMgaXMgdXNlZCBieSBEaXNhc3RlciBSZWNvdmVyeSBhcyBhIHNhZmVndWFyZCB0byBub3Qgc3VyZmFjZSBpbmNvbWluZyBjYWxscy9jaGF0cyB0byBVSQogIC8vIAogIHZhciBzdXBwcmVzc0NvbnRhY3RzID0gZnVuY3Rpb24gKGlzU3VwcHJlc3NlZCkgewogICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIFNpZ25hbCBzaGFyZWR3b3JrZXIgdG8gc2V0IGNvbnRhY3RzIHN1cHByZXNzb3IgdG8gJXMgZm9yIGluc3RhbmNlICVzLiIsIAogICAgICBpc1N1cHByZXNzZWQsIGNvbm5lY3QuY29yZS5yZWdpb24KICAgICkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuU1VQUFJFU1MsIHsKICAgICAgc3VwcHJlc3M6IGlzU3VwcHJlc3NlZAogICAgfSk7CiAgfQogCiAgdmFyIHNldEZvcmNlT2ZmbGluZVVwc3RyZWFtID0gZnVuY3Rpb24ob2ZmbGluZSkgewogICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbRElTQVNURVIgUkVDT1ZFUlldIFNpZ25hbCBzaGFyZWR3b3JrZXIgdG8gc2V0IGZvcmNlT2ZmbGluZSB0byAlcyBmb3IgaW5zdGFuY2UgJXMuIiwgCiAgICAgIG9mZmxpbmUsIGNvbm5lY3QuY29yZS5yZWdpb24KICAgICkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuRk9SQ0VfT0ZGTElORSwgewogICAgICBvZmZsaW5lOiBvZmZsaW5lCiAgICB9KTsKICB9CiAKICAvLyBGb3JjZSB0aGUgaW5zdGFuY2UgdG8gYmUgb2ZmbGluZS4gCiAgLy8gVGhpcyB0cmllcyB0byBkaXNjb25uZWN0IGFsbCBjb250YWN0cyAoSGFyZCBzdG9wKQogIC8vIGlmIGR1ZSB0byBhIGZhaWx1cmUgKHRoZSBiYWNrZW5kIGlzIG5vdCByZWFjaGFibGUpLCBzaWduYWwgdGhlIHNoYXJlZCB3b3JrZXIgdG8gZm9yY2Vfb2ZmbGluZSB3aGVuIGl0IHdha2VzIHVwIGFnYWluCiAgLy8gVGhpcyBmdW5jdGlvbiBzaG91bGQgb25seSBiZSByYW4gZnJvbSBuYXRpdmUgQ0NQIGZvciBkaXNjb25uZWN0aW5nIGNoYXRzLgogIHZhciBmb3JjZU9mZmxpbmUgPSBmdW5jdGlvbigpIHsKICAgIHZhciBsb2cgPSBjb25uZWN0LmdldExvZygpOwogICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gQXR0ZW1wdGluZyB0byBmb3JjZSBpbnN0YW5jZSAlcyBvZmZsaW5lIiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24oYWdlbnQpIHsKICAgICAgdmFyIGNvbnRhY3RDbG9zZWQgPSAwOwogICAgICB2YXIgY29udGFjdHMgPSBhZ2VudC5nZXRDb250YWN0cygpOwogICAgICBpZiAoY29udGFjdHMubGVuZ3RoKSB7CiAgICAgICAgY29udGFjdHMuZm9yRWFjaChmdW5jdGlvbihjb250YWN0KSAKICAgICAgICAgIHsKICAgICAgICAgICAgY29udGFjdC5nZXRBZ2VudENvbm5lY3Rpb24oKS5kZXN0cm95KHsKICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIC8vIGNoZWNrIGlmIGFsbCBhY3RpdmUgY29udGFjdHMgYXJlIGNsb3NlZAogICAgICAgICAgICAgICAgaWYgKCsrY29udGFjdENsb3NlZCA9PT0gY29udGFjdHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHNldEZvcmNlT2ZmbGluZVVwc3RyZWFtKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgLy8gSXQncyBvayBpZiB3ZSdyZSBub3QgYWJsZSB0byBwdXQgdGhlIGFnZW50IG9mZmxpbmUuIAogICAgICAgICAgICAgICAgICAvLyBzaW5jZSB3ZSdyZSBzdXBwcmVzc2luZyB0aGUgYWdlbnRzIGNvbnRhY3RzIGFscmVhZHkuIAogICAgICAgICAgICAgICAgICBtYWtlQWdlbnRPZmZsaW5lKGFnZW50KTsKICAgICAgICAgICAgICAgICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gSW5zdGFuY2UgJXMgaXMgbm93IG9mZmxpbmUiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgICBsb2cud2FybigiW0Rpc2FzdGVyIFJlY292ZXJ5XSBBbiBlcnJvciBvY2N1cmVkIHdoaWxlIGF0dGVtcHRpbmcgdG8gZm9yY2UgdGhpcyBpbnN0YW5jZSB0byBvZmZsaW5lIGluIHJlZ2lvbiAlcyIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICBsb2cud2FybihlcnIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAvLyBzaWduYWwgdGhlIHNoYXJlZHdvcmtlciB0byBjYWxsIGZvcmNlT2ZmbGluZSBhZ2FpbiB3aGVuIG5ldHdvcmsgY29ubmVjdGlvbiAKICAgICAgICAgICAgICAgIC8vIGhhcyBiZWVuIHJlLWVzdGFibGlzaGVkICh0aGlzIGhhcHBlbnMgaW4gY2FzZSBvZiBuZXR3b3JrIG9yIGJhY2tlbmQgZmFpbHVyZXMpCiAgICAgICAgICAgICAgICBzZXRGb3JjZU9mZmxpbmVVcHN0cmVhbSh0cnVlKTsKICAgICAgICAgICAgfX0pOwogICAgICAgICAgfQogICAgICAgICkgICAgICAgIAogICAgICB9IGVsc2UgewogICAgICAgIHNldEZvcmNlT2ZmbGluZVVwc3RyZWFtKGZhbHNlKTsKICAgICAgICBtYWtlQWdlbnRPZmZsaW5lKGFnZW50KTsKICAgICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBJbnN0YW5jZSAlcyBpcyBub3cgb2ZmbGluZSIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH0pOwogIH0KIAogIC8vSW5pdGlhdGUgRGlzYXN0ZXIgUmVjb3ZlcnkgKFRoaXMgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIGZyb20gY3VzdG9tQ0NQIHRoYXQgYXJlIERSIGVuYWJsZWQpCiAgY29ubmVjdC5jb3JlLmluaXREaXNhc3RlclJlY292ZXJ5ID0gZnVuY3Rpb24ocGFyYW1zKSB7CiAgICB2YXIgbG9nID0gY29ubmVjdC5nZXRMb2coKTsKICAgIGNvbm5lY3QuY29yZS5yZWdpb24gPSBwYXJhbXMucmVnaW9uOwogICAgY29ubmVjdC5jb3JlLnN1cHByZXNzQ29udGFjdHMgPSBzdXBwcmVzc0NvbnRhY3RzOyAgCiAgICBjb25uZWN0LmNvcmUuZm9yY2VPZmZsaW5lID0gZm9yY2VPZmZsaW5lOwoKICAgIC8vUmVnaXN0ZXIgaWZyYW1lIGxpc3RuZXIgdG8gc2V0IG5hdGl2ZSBDQ1Agb2ZmbGluZQogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25Eb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5TRVRfT0ZGTElORSwgZnVuY3Rpb24oKSB7CiAgICAgIGNvbm5lY3QuY29yZS5mb3JjZU9mZmxpbmUoKTsKICAgIH0pOwogCiAgICAvLyBSZWdpc3RlciBFdmVudCBsaXN0bmVyIHRvIEZvcmNlIHRoZSBBZ2VudCB0byBiZSBvZmZsaW5lIHdoZW4gc2hhcmVkIHdvcmtlciByZWNvdmVycyBmcm9tIG5ldHdvcmsgZmFpbHVyZQogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuRk9SQ0VfT0ZGTElORSwgZnVuY3Rpb24oKSB7CiAgICAgIGNvbm5lY3QuY29yZS5mb3JjZU9mZmxpbmUoKTsKICAgIH0pOwoKICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU09GVFBIT05FLCAKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gSW5pdGlhbGl6aW5nIHJlZ2lvbiAlcyBhcyBwYXJ0IG9mIGEgRGlzYXN0ZXIgUmVjb3ZlcnkgZmxlZXQiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9LCAKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gJXMgYWxyZWFkeSBwYXJ0IG9mIGEgRGlzYXN0ZXIgUmVjb3ZlcnkgZmxlZXQiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9KTsKCiAgICBpZiAoIXBhcmFtcy5pc1ByaW1hcnkpIHsKICAgICAgY29ubmVjdC5jb3JlLnN1cHByZXNzQ29udGFjdHModHJ1ZSk7CiAgICAgIGNvbm5lY3QuY29yZS5mb3JjZU9mZmxpbmUoKTsKICAgICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gJXMgaW5zdGFuY2UgaXMgc2V0IHRvIHN0YW5kLWJ5IiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbm5lY3QuY29yZS5zdXBwcmVzc0NvbnRhY3RzKGZhbHNlKTsKICAgICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gJXMgaW5zdGFuY2UgaXMgc2V0IHRvIHByaW1hcnkiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH0KIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBCYXNpYyBDb25uZWN0IGNsaWVudCBpbml0aWFsaXphdGlvbi4KICAgKiBTaG91bGQgYmUgdXNlZCBvbmx5IGJ5IHRoZSBBUEkgU2hhcmVkIFdvcmtlci4KICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIGNvbm5lY3QuY29yZS5ldmVudEJ1cyA9IG5ldyBjb25uZWN0LkV2ZW50QnVzKCk7CiAgICBjb25uZWN0LmNvcmUuYWdlbnREYXRhUHJvdmlkZXIgPSBuZXcgQWdlbnREYXRhUHJvdmlkZXIoY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkpOwogICAgY29ubmVjdC5jb3JlLmluaXRDbGllbnQocGFyYW1zKTsKICAgIGNvbm5lY3QuY29yZS5pbml0QWdlbnRBcHBDbGllbnQocGFyYW1zKTsKICAgIGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCA9IHRydWU7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJbml0aWFsaXplZCBBV1MgY2xpZW50CiAgICogU2hvdWxkIGJlIHVzZWQgYnkgU2hhcmVkIFdvcmtlciB0byB1cGRhdGUgQVdTIGNsaWVudCB3aXRoIG5ldyBjcmVkZW50aWFscwogICAqIGFmdGVyIHJlZnJlc2hlZCBhdXRoZW50aWNhdGlvbi4KICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdENsaWVudCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMsICdwYXJhbXMnKTsKICAgIAogICAgdmFyIGF1dGhUb2tlbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuYXV0aFRva2VuLCAncGFyYW1zLmF1dGhUb2tlbicpOwogICAgdmFyIHJlZ2lvbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMucmVnaW9uLCAncGFyYW1zLnJlZ2lvbicpOwogICAgdmFyIGVuZHBvaW50ID0gcGFyYW1zLmVuZHBvaW50IHx8IG51bGw7CiAKICAgIGNvbm5lY3QuY29yZS5jbGllbnQgPSBuZXcgY29ubmVjdC5BV1NDbGllbnQoYXV0aFRva2VuLCByZWdpb24sIGVuZHBvaW50KTsKICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogSW5pdGlhbGl6ZWQgQWdlbnRBcHAgY2xpZW50CiAgICogU2hvdWxkIGJlIHVzZWQgYnkgU2hhcmVkIFdvcmtlciB0byB1cGRhdGUgQWdlbnRBcHAgY2xpZW50IHdpdGggbmV3IGNyZWRlbnRpYWxzCiAgICogYWZ0ZXIgcmVmcmVzaGVkIGF1dGhlbnRpY2F0aW9uLgogICAqLwogIGNvbm5lY3QuY29yZS5pbml0QWdlbnRBcHBDbGllbnQgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAncGFyYW1zJyk7ICAgIAogICAgdmFyIGF1dGhUb2tlbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuYXV0aFRva2VuLCAncGFyYW1zLmF1dGhUb2tlbicpOwogICAgdmFyIGF1dGhDb29raWVOYW1lID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5hdXRoQ29va2llTmFtZSwgJ3BhcmFtcy5hdXRoQ29va2llTmFtZScpOwogICAgdmFyIGVuZHBvaW50ID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5hZ2VudEFwcEVuZHBvaW50LCAncGFyYW1zLmFnZW50QXBwRW5kcG9pbnQnKTsKICAgIAogICAgY29ubmVjdC5jb3JlLmFnZW50QXBwQ2xpZW50ID0gbmV3IGNvbm5lY3QuQWdlbnRBcHBDbGllbnQoYXV0aENvb2tpZU5hbWUsIGF1dGhUb2tlbiwgZW5kcG9pbnQpOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogVW5pbml0aWFsaXplIENvbm5lY3QuCiAgICovCiAgY29ubmVjdC5jb3JlLnRlcm1pbmF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3QuY29yZS5jbGllbnQgPSBuZXcgY29ubmVjdC5OdWxsQ2xpZW50KCk7CiAgICBjb25uZWN0LmNvcmUuYWdlbnRBcHBDbGllbnQgPSBuZXcgY29ubmVjdC5OdWxsQ2xpZW50KCk7CiAgICBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50ID0gbmV3IGNvbm5lY3QuTnVsbENsaWVudCgpOwogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgaWYgKGJ1cykgYnVzLnVuc3Vic2NyaWJlQWxsKCk7CiAgICBjb25uZWN0LmNvcmUuYnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoKTsKICAgIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlciA9IG51bGw7CiAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciA9IG51bGw7CiAgICBjb25uZWN0LmNvcmUudXBzdHJlYW0gPSBudWxsOwogICAgY29ubmVjdC5jb3JlLmtlZXBhbGl2ZU1hbmFnZXIgPSBudWxsOwogICAgY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCA9IGZhbHNlOwogICAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gZmFsc2U7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBTZXR1cCB0aGUgU29mdHBob25lTWFuYWdlciB0byBiZSBpbml0aWFsaXplZCB3aGVuIHRoZSBhZ2VudAogICAqIGlzIGRldGVybWluZWQgdG8gaGF2ZSBzb2Z0cGhvbmUgZW5hYmxlZC4KICAgKi8KICBjb25uZWN0LmNvcmUuc29mdHBob25lVXNlck1lZGlhU3RyZWFtID0gbnVsbDsKIAogIGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLnNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbTsKICB9OwogCiAgY29ubmVjdC5jb3JlLnNldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uIChzdHJlYW0pIHsKICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0gPSBzdHJlYW07CiAgfTsKIAogIGNvbm5lY3QuY29yZS5pbml0UmluZ3RvbmVFbmdpbmVzID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcywgInBhcmFtcyIpOwogCiAgICB2YXIgc2V0dXBSaW5ndG9uZUVuZ2luZXMgPSBmdW5jdGlvbiAocmluZ3RvbmVTZXR0aW5ncykgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmluZ3RvbmVTZXR0aW5ncywgInJpbmd0b25lU2V0dGluZ3MiKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJpbmd0b25lU2V0dGluZ3Mudm9pY2UsICJyaW5ndG9uZVNldHRpbmdzLnZvaWNlIik7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShyaW5ndG9uZVNldHRpbmdzLnZvaWNlLnJpbmd0b25lVXJsIHx8IHJpbmd0b25lU2V0dGluZ3Mudm9pY2UuZGlzYWJsZWQsICJyaW5ndG9uZVNldHRpbmdzLnZvaWNlLnJpbmd0b25lVXJsIG11c3QgYmUgcHJvdmlkZWQgb3IgcmluZ3RvbmVTZXR0aW5ncy52b2ljZS5kaXNhYmxlZCBtdXN0IGJlIHRydWUiKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2ssICJyaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrIik7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShyaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrLnJpbmd0b25lVXJsIHx8IHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2suZGlzYWJsZWQsICJyaW5ndG9uZVNldHRpbmdzLnZvaWNlLnJpbmd0b25lVXJsIG11c3QgYmUgcHJvdmlkZWQgb3IgcmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjay5kaXNhYmxlZCBtdXN0IGJlIHRydWUiKTsKIAogICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzID0ge307CiAKICAgICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbiAoYWdlbnQpIHsKICAgICAgICBhZ2VudC5vblJlZnJlc2goZnVuY3Rpb24gKCkgewogICAgICAgICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5SSU5HVE9ORSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoIXJpbmd0b25lU2V0dGluZ3Mudm9pY2UuZGlzYWJsZWQgJiYgIWNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMudm9pY2UpIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnZvaWNlID0KICAgICAgICAgICAgICAgIG5ldyBjb25uZWN0LlZvaWNlUmluZ3RvbmVFbmdpbmUocmluZ3RvbmVTZXR0aW5ncy52b2ljZSk7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJWb2ljZVJpbmd0b25lRW5naW5lIGluaXRpYWxpemVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KIAogICAgICAgICAgICBpZiAoIXJpbmd0b25lU2V0dGluZ3MuY2hhdC5kaXNhYmxlZCAmJiAhY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5jaGF0KSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5jaGF0ID0KICAgICAgICAgICAgICAgIG5ldyBjb25uZWN0LkNoYXRSaW5ndG9uZUVuZ2luZShyaW5ndG9uZVNldHRpbmdzLmNoYXQpOwogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQ2hhdFJpbmd0b25lRW5naW5lIGluaXRpYWxpemVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KIAogICAgICAgICAgICBpZiAoIXJpbmd0b25lU2V0dGluZ3MudGFzay5kaXNhYmxlZCAmJiAhY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy50YXNrKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy50YXNrID0KICAgICAgICAgICAgICAgIG5ldyBjb25uZWN0LlRhc2tSaW5ndG9uZUVuZ2luZShyaW5ndG9uZVNldHRpbmdzLnRhc2spOwogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJUYXNrUmluZ3RvbmVFbmdpbmUgaW5pdGlhbGl6ZWQuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQogCiAgICAgICAgICAgIGlmICghcmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjay5kaXNhYmxlZCAmJiAhY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5xdWV1ZV9jYWxsYmFjaykgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMucXVldWVfY2FsbGJhY2sgPQogICAgICAgICAgICAgICAgbmV3IGNvbm5lY3QuUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lKHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2spOwogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lIGluaXRpYWxpemVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKCiAgICAgIGhhbmRsZVJpbmdlckRldmljZUNoYW5nZSgpOwogICAgfTsKIAogICAgdmFyIG1lcmdlUGFyYW1zID0gZnVuY3Rpb24gKHBhcmFtcywgb3RoZXJQYXJhbXMpIHsKICAgICAgLy8gRm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5OiBzdXBwb3J0IHB1bGxpbmcgZGlzYWJsZWQgZmxhZyBhbmQgcmluZ3RvbmVVcmwKICAgICAgLy8gZnJvbSBzb2Z0cGhvbmUgY29uZmlnIGlmIGl0IGV4aXN0cyBmcm9tIGRvd25zdHJlYW0gaW50byB0aGUgcmluZ3RvbmUgY29uZmlnLgogICAgICBwYXJhbXMucmluZ3RvbmUgPSBwYXJhbXMucmluZ3RvbmUgfHwge307CiAgICAgIHBhcmFtcy5yaW5ndG9uZS52b2ljZSA9IHBhcmFtcy5yaW5ndG9uZS52b2ljZSB8fCB7fTsKICAgICAgcGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrID0gcGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrIHx8IHt9OwogICAgICBwYXJhbXMucmluZ3RvbmUuY2hhdCA9IHBhcmFtcy5yaW5ndG9uZS5jaGF0IHx8IHsgZGlzYWJsZWQ6IHRydWUgfTsKICAgICAgcGFyYW1zLnJpbmd0b25lLnRhc2sgPSBwYXJhbXMucmluZ3RvbmUudGFzayB8fCB7IGRpc2FibGVkOiB0cnVlIH07CiAKICAgICAgaWYgKG90aGVyUGFyYW1zLnNvZnRwaG9uZSkgewogICAgICAgIGlmIChvdGhlclBhcmFtcy5zb2Z0cGhvbmUuZGlzYWJsZVJpbmd0b25lKSB7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUudm9pY2UuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgcGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICB9CiAKICAgICAgICBpZiAob3RoZXJQYXJhbXMuc29mdHBob25lLnJpbmd0b25lVXJsKSB7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUudm9pY2UucmluZ3RvbmVVcmwgPSBvdGhlclBhcmFtcy5zb2Z0cGhvbmUucmluZ3RvbmVVcmw7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2sucmluZ3RvbmVVcmwgPSBvdGhlclBhcmFtcy5zb2Z0cGhvbmUucmluZ3RvbmVVcmw7CiAgICAgICAgfQogICAgICB9CiAKICAgICAgaWYgKG90aGVyUGFyYW1zLmNoYXQpIHsKICAgICAgICBpZiAob3RoZXJQYXJhbXMuY2hhdC5kaXNhYmxlUmluZ3RvbmUpIHsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS5jaGF0LmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICB9CiAKICAgICAgICBpZiAob3RoZXJQYXJhbXMuY2hhdC5yaW5ndG9uZVVybCkgewogICAgICAgICAgcGFyYW1zLnJpbmd0b25lLmNoYXQucmluZ3RvbmVVcmwgPSBvdGhlclBhcmFtcy5jaGF0LnJpbmd0b25lVXJsOwogICAgICAgIH0KICAgICAgfQogCiAgICAgIC8vIE1lcmdlIGluIHJpbmd0b25lIHNldHRpbmdzIGZyb20gZG93bnN0cmVhbS4KICAgICAgaWYgKG90aGVyUGFyYW1zLnJpbmd0b25lKSB7CiAgICAgICAgcGFyYW1zLnJpbmd0b25lLnZvaWNlID0gY29ubmVjdC5tZXJnZShwYXJhbXMucmluZ3RvbmUudm9pY2UsCiAgICAgICAgICBvdGhlclBhcmFtcy5yaW5ndG9uZS52b2ljZSB8fCB7fSk7CiAgICAgICAgcGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrID0gY29ubmVjdC5tZXJnZShwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2ssCiAgICAgICAgICBvdGhlclBhcmFtcy5yaW5ndG9uZS52b2ljZSB8fCB7fSk7CiAgICAgICAgcGFyYW1zLnJpbmd0b25lLmNoYXQgPSBjb25uZWN0Lm1lcmdlKHBhcmFtcy5yaW5ndG9uZS5jaGF0LAogICAgICAgICAgb3RoZXJQYXJhbXMucmluZ3RvbmUuY2hhdCB8fCB7fSk7CiAgICAgIH0KICAgIH07CiAKICAgIC8vIE1lcmdlIHBhcmFtcyBmcm9tIHBhcmFtcy5zb2Z0cGhvbmUgYW5kIHBhcmFtcy5jaGF0IGludG8gcGFyYW1zLnJpbmd0b25lCiAgICAvLyBmb3IgZW1iZWRkZWQgYW5kIG5vbi1lbWJlZGRlZCB1c2UgY2FzZXMgc28gdGhhdCBkZWZhdWx0cyBhcmUgcGlja2VkIHVwLgogICAgbWVyZ2VQYXJhbXMocGFyYW1zLCBwYXJhbXMpOwogCiAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpKSB7CiAgICAgIC8vIElmIHRoZSBDQ1AgaXMgaW4gYSBmcmFtZSwgd2FpdCBmb3IgY29uZmlndXJhdGlvbiBmcm9tIGRvd25zdHJlYW0uCiAgICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwogICAgICAgIC8vIE1lcmdlIGFsbCBwYXJhbXMgZnJvbSBkYXRhIGludG8gcGFyYW1zIGZvciBhbnkgb3ZlcnJpZGRlbgogICAgICAgIC8vIHZhbHVlcyBpbiBlaXRoZXIgbGVnYWN5ICJzb2Z0cGhvbmUiIG9yICJyaW5ndG9uZSIgc2V0dGluZ3MuCiAgICAgICAgbWVyZ2VQYXJhbXMocGFyYW1zLCBkYXRhKTsKICAgICAgICBzZXR1cFJpbmd0b25lRW5naW5lcyhwYXJhbXMucmluZ3RvbmUpOwogICAgICB9KTsKIAogICAgfSBlbHNlIHsKICAgICAgc2V0dXBSaW5ndG9uZUVuZ2luZXMocGFyYW1zLnJpbmd0b25lKTsKICAgIH0KICB9OwoKICB2YXIgaGFuZGxlUmluZ2VyRGV2aWNlQ2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfUklOR0VSX0RFVklDRSwgc2V0UmluZ2VyRGV2aWNlKTsKICB9CgogIHZhciBzZXRSaW5nZXJEZXZpY2UgPSBmdW5jdGlvbiAoZGF0YSl7CiAgICBpZihjb25uZWN0LmtleXMoY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcykubGVuZ3RoID09PSAwIHx8ICFkYXRhIHx8ICFkYXRhLmRldmljZUlkKXsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGRldmljZUlkID0gZGF0YS5kZXZpY2VJZDsKICAgIGZvciAodmFyIHJpbmd0b25lVHlwZSBpbiBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzKSB7CiAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXNbcmluZ3RvbmVUeXBlXS5zZXRPdXRwdXREZXZpY2UoZGV2aWNlSWQpOwogICAgfQoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5SSU5HRVJfREVWSUNFX0NIQU5HRUQsCiAgICAgIGRhdGE6IHsgZGV2aWNlSWQ6IGRldmljZUlkIH0KICAgIH0pOwogIH0KCiAgY29ubmVjdC5jb3JlLmluaXRTb2Z0cGhvbmVNYW5hZ2VyID0gZnVuY3Rpb24gKHBhcmFtc0luKSB7CiAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gaW5pdFNvZnRwaG9uZU1hbmFnZXIgc3RhcnRlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAKICAgIHZhciBjb21wZXRlRm9yTWFzdGVyT25BZ2VudFVwZGF0ZSA9IGZ1bmN0aW9uIChzb2Z0cGhvbmVQYXJhbXNJbikgewogICAgICB2YXIgc29mdHBob25lUGFyYW1zID0gY29ubmVjdC5tZXJnZShwYXJhbXMuc29mdHBob25lIHx8IHt9LCBzb2Z0cGhvbmVQYXJhbXNJbik7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW1NvZnRwaG9uZSBNYW5hZ2VyXSBjb21wZXRlRm9yTWFzdGVyT25BZ2VudFVwZGF0ZSBleGVjdXRlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24gKGFnZW50KSB7CiAgICAgICAgaWYgKCFhZ2VudC5nZXRDaGFubmVsQ29uY3VycmVuY3koY29ubmVjdC5DaGFubmVsVHlwZS5WT0lDRSkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgYWdlbnQub25SZWZyZXNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBzdWIgPSB0aGlzOwogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbU29mdHBob25lIE1hbmFnZXJdIGFnZW50IHJlZnJlc2ggaGFuZGxlciBleGVjdXRlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAKICAgICAgICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU09GVFBIT05FLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW1NvZnRwaG9uZSBNYW5hZ2VyXSBjb25maXJtZWQgYXMgc29mdHBob25lIG1hc3RlciB0b3BpYyIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIGlmICghY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIgJiYgYWdlbnQuaXNTb2Z0cGhvbmVFbmFibGVkKCkpIHsKICAgICAgICAgICAgICAvLyBCZWNvbWUgbWFzdGVyIHRvIHNlbmQgbG9ncywgc2luY2Ugd2UgbmVlZCBsb2dzIGZyb20gc29mdHBob25lIHRhYi4KICAgICAgICAgICAgICBjb25uZWN0LmJlY29tZU1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TRU5EX0xPR1MpOwogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyID0gbmV3IGNvbm5lY3QuU29mdHBob25lTWFuYWdlcihzb2Z0cGhvbmVQYXJhbXMpOwogICAgICAgICAgICAgIHN1Yi51bnN1YnNjcmliZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9OwogCiAgICAvKioKICAgICAqIElmIHRoZSB3aW5kb3cgaXMgZnJhbWVkLCB3ZSBuZWVkIHRvIHdhaXQgZm9yIGEgQ09ORklHVVJFIG1lc3NhZ2UgZnJvbQogICAgICogZG93bnN0cmVhbSBiZWZvcmUgd2UgdHJ5IHRvIGluaXRpYWxpemUsIHVubGVzcyBwYXJhbXMuYWxsb3dGcmFtZWRTb2Z0cGhvbmUgaXMgdHJ1ZS4KICAgICAqLwogICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSAmJiAhcGFyYW1zLmFsbG93RnJhbWVkU29mdHBob25lKSB7CiAgICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbU29mdHBob25lIE1hbmFnZXJdIENvbmZpZ3VyZSBldmVudCBoYW5kbGVyIGV4ZWN1dGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBpZiAoZGF0YS5zb2Z0cGhvbmUgJiYgZGF0YS5zb2Z0cGhvbmUuYWxsb3dGcmFtZWRTb2Z0cGhvbmUpIHsKICAgICAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKICAgICAgICAgIGNvbXBldGVGb3JNYXN0ZXJPbkFnZW50VXBkYXRlKGRhdGEuc29mdHBob25lKTsKICAgICAgICAgIAogICAgICAgIH0KICAgICAgICBzZXR1cEV2ZW50TGlzdGVuZXJzRm9yTXVsdGlUYWJVc2VJbkZpcmVmb3goZGF0YS5zb2Z0cGhvbmUpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbXBldGVGb3JNYXN0ZXJPbkFnZW50VXBkYXRlKHBhcmFtcyk7CiAgICAgIHNldHVwRXZlbnRMaXN0ZW5lcnNGb3JNdWx0aVRhYlVzZUluRmlyZWZveChwYXJhbXMpOwogICAgfQogCiAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uIChhZ2VudCkgewogICAgICAvLyBTeW5jIG11dGUgYWNyb3NzIGFsbCB0YWJzIAogICAgICBpZiAoYWdlbnQuaXNTb2Z0cGhvbmVFbmFibGVkKCkgJiYgYWdlbnQuZ2V0Q2hhbm5lbENvbmN1cnJlbmN5KGNvbm5lY3QuQ2hhbm5lbFR5cGUuVk9JQ0UpKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwKICAgICAgICAgIHsKICAgICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuRXZlbnRUeXBlLk1VVEUKICAgICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKCiAgICBmdW5jdGlvbiBzZXR1cEV2ZW50TGlzdGVuZXJzRm9yTXVsdGlUYWJVc2VJbkZpcmVmb3goc29mdHBob25lUGFyYW1zSW4pIHsKICAgICAgdmFyIHNvZnRwaG9uZVBhcmFtcyA9IGNvbm5lY3QubWVyZ2UocGFyYW1zLnNvZnRwaG9uZSB8fCB7fSwgc29mdHBob25lUGFyYW1zSW4pOwoKICAgICAgLy8ga2VlcCB0aGUgc29mdHBob25lIHBhcmFtcyBmb3IgZXh0ZXJuYWwgdXNlCiAgICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVQYXJhbXMgPSBzb2Z0cGhvbmVQYXJhbXM7CgogICAgICBpZiAoY29ubmVjdC5pc0ZpcmVmb3hCcm93c2VyKCkpIHsKICAgICAgICAvLyBJbiBGaXJlZm94LCB3aGVuIGEgdGFiIHRha2VzIG92ZXIgYW5vdGhlciB0YWIncyBzb2Z0cGhvbmUgcHJpbWFyeSwKICAgICAgICAvLyB0aGUgcHJldmlvdXMgcHJpbWFyeSB0YWIgc2hvdWxkIGRlbGV0ZSBzb2ZwaG9uZSBtYW5hZ2VyIGFuZCBzdG9wIG1pY3JvcGhvbmUKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVNQT05TRSwgZnVuY3Rpb24gKHJlcykgewogICAgICAgICAgaWYgKHJlcy5kYXRhICYmIHJlcy5kYXRhLnRvcGljID09PSBjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUgJiYgcmVzLmRhdGEudGFrZU92ZXIgJiYgKHJlcy5kYXRhLm1hc3RlcklkICE9PSBjb25uZWN0LmNvcmUucG9ydFN0cmVhbUlkKSkgewogICAgICAgICAgICBpZiAoY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIpIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlci5vbkluaXRDb250YWN0U3ViLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgICAgICAgZGVsZXRlIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB1c2VyTWVkaWFTdHJlYW0gPSBjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtKCk7CiAgICAgICAgICAgIGlmICh1c2VyTWVkaWFTdHJlYW0pIHsKICAgICAgICAgICAgICB1c2VyTWVkaWFTdHJlYW0uZ2V0VHJhY2tzKCkuZm9yRWFjaChmdW5jdGlvbih0cmFjaykgeyB0cmFjay5zdG9wKCk7IH0pOwogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5zZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0obnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgLy8gSW4gRmlyZWZveCwgd2hlbiBtdWx0aXBsZSB0YWJzIGFyZSBvcGVuLAogICAgICAgIC8vIHdlYnJ0YyBzZXNzaW9uIGlzIG5vdCBzdGFydGVkIHVudGlsIFJFQURZX1RPX1NUQVJUX1NFU1NJT04gZXZlbnQgaXMgdHJpZ2dlcmVkCiAgICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5SRUFEWV9UT19TVEFSVF9TRVNTSU9OLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNPRlRQSE9ORSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIpIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlci5zdGFydFNlc3Npb24oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBjb25uZWN0LmJlY29tZU1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uIChhZ2VudCkgewogICAgICAgICAgICAgICAgaWYgKCFjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciAmJiBhZ2VudC5pc1NvZnRwaG9uZUVuYWJsZWQoKSkgewogICAgICAgICAgICAgICAgICBjb25uZWN0LmJlY29tZU1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TRU5EX0xPR1MpOwogICAgICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciA9IG5ldyBjb25uZWN0LlNvZnRwaG9uZU1hbmFnZXIoc29mdHBob25lUGFyYW1zKTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIuc3RhcnRTZXNzaW9uKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIGhhbmRsaW5nIG91dGJvdW5kLWNhbGwgYW5kIGF1dG8tYWNjZXB0IGNhc2VzIGZvciBwZW5kaW5nIHNlc3Npb24KICAgICAgICBjb25uZWN0LmNvbnRhY3QoZnVuY3Rpb24gKGMpIHsKICAgICAgICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24gKGFnZW50KSB7CiAgICAgICAgICAgIGMub25SZWZyZXNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgY29ubmVjdC5oYXNPdGhlckNvbm5lY3RlZENDUHMoKSAmJgogICAgICAgICAgICAgICAgZG9jdW1lbnQudmlzaWJpbGl0eVN0YXRlID09PSAndmlzaWJsZScgJiYKICAgICAgICAgICAgICAgIChjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuQ09OTkVDVElORyB8fCBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuSU5DT01JTkcpCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICB2YXIgaXNPdXRCb3VuZENhbGwgPSBjb250YWN0LmlzU29mdHBob25lQ2FsbCgpICYmICFjb250YWN0LmlzSW5ib3VuZCgpOwogICAgICAgICAgICAgICAgdmFyIGlzQXV0b0FjY2VwdEVuYWJsZWQgPSBjb250YWN0LmlzU29mdHBob25lQ2FsbCgpICYmIGFnZW50LmdldENvbmZpZ3VyYXRpb24oKS5zb2Z0cGhvbmVBdXRvQWNjZXB0OwogICAgICAgICAgICAgICAgdmFyIGlzUXVldWVkQ2FsbGJhY2sgPSBjb250YWN0LmdldFR5cGUoKSA9PT0gY29ubmVjdC5Db250YWN0VHlwZS5RVUVVRV9DQUxMQkFDSzsKICAgICAgICAgICAgICAgIGlmIChpc091dEJvdW5kQ2FsbCB8fCBpc0F1dG9BY2NlcHRFbmFibGVkIHx8IGlzUXVldWVkQ2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnRyaWdnZXJSZWFkeVRvU3RhcnRTZXNzaW9uRXZlbnQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9OwoKICAvLyB0cmlnZ2VyIFJFQURZX1RPX1NUQVJUX1NFU1NJT04gZXZlbnQgaW4gYSBjb250ZXh0IHdpdGggU29mdHBob25lIE1hbmFnZXIKICAvLyBpbnRlcm5hbCB1c2Ugb25seQogIGNvbm5lY3QuY29yZS50cmlnZ2VyUmVhZHlUb1N0YXJ0U2Vzc2lvbkV2ZW50ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFsbG93RnJhbWVkU29mdHBob25lID0gY29ubmVjdC5jb3JlLnNvZnRwaG9uZVBhcmFtcyAmJiBjb25uZWN0LmNvcmUuc29mdHBob25lUGFyYW1zLmFsbG93RnJhbWVkU29mdHBob25lOwogICAgaWYgKGNvbm5lY3QuaXNDQ1AoKSkgewogICAgICBpZiAoYWxsb3dGcmFtZWRTb2Z0cGhvbmUpIHsKICAgICAgICAvLyB0aGUgZXZlbnQgaXMgdHJpZ2dlcmVkIGluIHRoaXMgaWZyYW1lZCBDQ1AgY29udGV4dAogICAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlJFQURZX1RPX1NUQVJUX1NFU1NJT04pOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkpIHsKICAgICAgICAgIC8vIGlmIHRoaXMgaXMgYW4gaWZyYW1lZCBDQ1AsIHRoZSBldmVudCBpcyBzZW5kIHRvIGRvd25zdHJlYW0gKENSTSkKICAgICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmREb3duc3RyZWFtKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5SRUFEWV9UT19TVEFSVF9TRVNTSU9OKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gaWYgdGhpcyBpcyBhIHN0YW5kYWxvbmUgQ0NQLCB0cmlnZ2VyIHRoaXMgZXZlbnQgaW4gdGhpcyBDQ1AgY29udGV4dAogICAgICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuUkVBRFlfVE9fU1RBUlRfU0VTU0lPTik7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoYWxsb3dGcmFtZWRTb2Z0cGhvbmUpIHsKICAgICAgICAvLyB0aGUgZXZlbnQgaXMgc2VuZCB0byB0aGUgdXBzdHJlYW0gKGlmcmFtZWQgQ0NQKQogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuUkVBRFlfVE9fU1RBUlRfU0VTU0lPTik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gdGhlIGV2ZW50IGlzIHRyaWdnZXJlZCBpbiB0aGlzIENSTSBjb250ZXh0CiAgICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuUkVBRFlfVE9fU1RBUlRfU0VTU0lPTik7CiAgICAgIH0KICAgIH0KICB9OwoKICBjb25uZWN0LmNvcmUuaW5pdFBhZ2VPcHRpb25zID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcywgInBhcmFtcyIpOwogICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSkgewogICAgICAvLyBJZiB0aGUgQ0NQIGlzIGluIGEgZnJhbWUsIHdhaXQgZm9yIGNvbmZpZ3VyYXRpb24gZnJvbSBkb3duc3RyZWFtLgogICAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuQ09ORklHVVJFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsCiAgICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50OiBjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuQ09ORklHVVJFLAogICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIC8vIExpc3RlbiBmb3IgaWZyYW1lIG1lZGlhIGRldmljZXMgcmVxdWVzdCBmcm9tIENSTQogICAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLk1FRElBX0RFVklDRV9SRVFVRVNULCBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gc2VuZERldmljZXMoZGV2aWNlcykgewogICAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTUVESUFfREVWSUNFX1JFU1BPTlNFLCBkZXZpY2VzKTsKICAgICAgICB9CiAgICAgICAgaWYgKG5hdmlnYXRvciAmJiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzKSB7CiAgICAgICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmVudW1lcmF0ZURldmljZXMoKQogICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGRldmljZXNJbikgewogICAgICAgICAgICBkZXZpY2VzID0gZGV2aWNlc0luIHx8IFtdOwogICAgICAgICAgICBkZXZpY2VzID0gZGV2aWNlcy5tYXAoZnVuY3Rpb24oZCkgeyByZXR1cm4gZC50b0pTT04oKSB9KTsKICAgICAgICAgICAgc2VuZERldmljZXMoZGV2aWNlcyk7CiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgc2VuZERldmljZXMoe2Vycm9yOiBlcnIubWVzc2FnZX0pOwogICAgICAgICAgfSk7IAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZW5kRGV2aWNlcyh7ZXJyb3I6ICJObyBuYXZpZ2F0b3Igb3IgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcyBvYmplY3QgZm91bmQifSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogR2V0IHRoZSBsaXN0IG9mIG1lZGlhIGRldmljZXMgZnJvbSBpZnJhbWVkIENDUAogICAqIFRpbWVvdXQgZm9yIHRoZSByZXF1ZXN0IGlzIHBhc3NlZCBhbiBhbiBvcHRpb25hbCBhcmd1bWVudAogICAqIFRoZSBkZWZhdWx0IHRpbWVvdXQgaXMgMTAwMG1zCiAgICovCiAgY29ubmVjdC5jb3JlLmdldEZyYW1lTWVkaWFEZXZpY2VzID0gZnVuY3Rpb24gKHRpbWVvdXRJbikgewogICAgdmFyIHN1YiA9IG51bGw7CiAgICB2YXIgdGltZW91dCA9IHRpbWVvdXRJbiB8fCAxMDAwOwogICAgdmFyIHRpbWVvdXRQcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgCiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcigiVGltZW91dCBleGNlZWRlZCIpKTsgCiAgICAgIH0sIHRpbWVvdXQpOwogICAgfSk7CiAgICB2YXIgbWVkaWFEZXZpY2VzUHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsgCiAgICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkgfHwgY29ubmVjdC5pc0NDUCgpKSB7CiAgICAgICAgaWYgKG5hdmlnYXRvciAmJiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzKSB7CiAgICAgICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmVudW1lcmF0ZURldmljZXMoKQogICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGRldmljZXNJbikgewogICAgICAgICAgICBkZXZpY2VzID0gZGV2aWNlc0luIHx8IFtdOwogICAgICAgICAgICBkZXZpY2VzID0gZGV2aWNlcy5tYXAoZnVuY3Rpb24gKGQpIHsgcmV0dXJuIGQudG9KU09OKCkgfSk7CiAgICAgICAgICAgIHJlc29sdmUoZGV2aWNlcyk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcigiTm8gbmF2aWdhdG9yIG9yIG5hdmlnYXRvci5tZWRpYURldmljZXMgb2JqZWN0IGZvdW5kIikpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICAgICAgc3ViID0gYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5NRURJQV9ERVZJQ0VfUkVTUE9OU0UsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5lcnJvcikgewogICAgICAgICAgICByZWplY3QobmV3IEVycm9yKGRhdGEuZXJyb3IpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLk1FRElBX0RFVklDRV9SRVFVRVNUKTsKICAgICAgfQogICAgfSkKICAgIHJldHVybiBQcm9taXNlLnJhY2UoW21lZGlhRGV2aWNlc1Byb21pc2UsIHRpbWVvdXRQcm9taXNlXSkKICAgIC5maW5hbGx5KGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHN1YikgewogICAgICAgIHN1Yi51bnN1YnNjcmliZSgpOwogICAgICB9CiAgICB9KTsKICB9CgogIC8vSW50ZXJuYWwgdXNlIG9ubHkuCiAgY29ubmVjdC5jb3JlLmF1dGhvcml6ZSA9IGZ1bmN0aW9uIChlbmRwb2ludCkgewogICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgIGNyZWRlbnRpYWxzOiAnaW5jbHVkZScKICAgIH07CgogICAgdmFyIGF1dGhvcml6ZUVuZHBvaW50ID0gZW5kcG9pbnQ7CiAgICBpZiAoIWF1dGhvcml6ZUVuZHBvaW50KSB7CiAgICAgIGF1dGhvcml6ZUVuZHBvaW50ID0gY29ubmVjdC5jb3JlLmlzTGVnYWN5RG9tYWluKCkKICAgICAgICA/IExFR0FDWV9BVVRIT1JJWkVfRU5EUE9JTlQKICAgICAgICA6IEFVVEhPUklaRV9FTkRQT0lOVDsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmZldGNoKGF1dGhvcml6ZUVuZHBvaW50LCBvcHRpb25zLCBBVVRIT1JJWkVfUkVUUllfSU5URVJWQUwsIEFVVEhPUklaRV9NQVhfUkVUUlkpOwogIH07CiAKICAvKioKICAgKiBAZGVwcmVjYXRlZAogICAqIFRoaXMgdXNlZCB0byBiZSB1c2VkIGludGVybmFsbHksIGJ1dCBpcyBubyBsb25nZXIgbmVlZGVkLgogICAqLwogIGNvbm5lY3QuY29yZS52ZXJpZnlEb21haW5BY2Nlc3MgPSBmdW5jdGlvbiAoYXV0aFRva2VuLCBlbmRwb2ludCkgewogICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJUaGlzIEFQSSB3aWxsIGJlIGRlcHJlY2F0ZWQgaW4gdGhlIG5leHQgbWFqb3IgdmVyc2lvbiByZWxlYXNlIik7CiAgICBpZiAoIWNvbm5lY3QuaXNGcmFtZWQoKSkgewogICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7CiAgICB9CiAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgaGVhZGVyczogewogICAgICAgICdYLUFtei1CZWFyZXInOiBhdXRoVG9rZW4KICAgICAgfQogICAgfTsKICAgIHZhciB3aGl0ZWxpc3RlZE9yaWdpbnNFbmRwb2ludCA9IG51bGw7CiAgICBpZiAoZW5kcG9pbnQpewogICAgICB3aGl0ZWxpc3RlZE9yaWdpbnNFbmRwb2ludCA9IGVuZHBvaW50OwogICAgfQogICAgZWxzZSB7CiAgICAgIHdoaXRlbGlzdGVkT3JpZ2luc0VuZHBvaW50ID0gY29ubmVjdC5jb3JlLmlzTGVnYWN5RG9tYWluKCkgCiAgICAgICAgPyBMRUdBQ1lfV0hJVEVMSVNURURfT1JJR0lOU19FTkRQT0lOVAogICAgICAgIDogV0hJVEVMSVNURURfT1JJR0lOU19FTkRQT0lOVDsKICAgIH0KICAgIAogICAgcmV0dXJuIGNvbm5lY3QuZmV0Y2god2hpdGVsaXN0ZWRPcmlnaW5zRW5kcG9pbnQsIG9wdGlvbnMsIFdISVRFTElTVEVEX09SSUdJTlNfUkVUUllfSU5URVJWQUwsIFdISVRFTElTVEVEX09SSUdJTlNfTUFYX1JFVFJZKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICB2YXIgdG9wRG9tYWluID0gc2FuaXRpemVEb21haW4od2luZG93LmRvY3VtZW50LnJlZmVycmVyKTsKICAgICAgdmFyIGlzQWxsb3dlZCA9IHJlc3BvbnNlLndoaXRlbGlzdGVkT3JpZ2lucy5zb21lKGZ1bmN0aW9uIChvcmlnaW4pIHsKICAgICAgICByZXR1cm4gdG9wRG9tYWluID09PSBzYW5pdGl6ZURvbWFpbihvcmlnaW4pOwogICAgICB9KTsKICAgICAgcmV0dXJuIGlzQWxsb3dlZCA/IFByb21pc2UucmVzb2x2ZSgpIDogUHJvbWlzZS5yZWplY3QoKTsKICAgIH0pOwogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBSZXR1cm5zIHRydWUgaWYgdGhpcyB3aW5kb3cncyBocmVmIGlzIG9uIHRoZSBsZWdhY3kgY29ubmVjdCBkb21haW4uIAogICAqIE9ubHkgdXNlZnVsIGZvciBpbnRlcm5hbCB1c2UuIAogICAqLwogIGNvbm5lY3QuY29yZS5pc0xlZ2FjeURvbWFpbiA9IGZ1bmN0aW9uKHVybCkgewogICAgdXJsID0gdXJsIHx8IHdpbmRvdy5sb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuIHVybC5pbmNsdWRlcygnLmF3c2FwcHMuY29tJyk7CiAgfQoKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJbml0aWFsaXplcyBDb25uZWN0IGJ5IGNyZWF0aW5nIG9yIGNvbm5lY3RpbmcgdG8gdGhlIEFQSSBTaGFyZWQgV29ya2VyLgogICAqIFVzZWQgb25seSBieSB0aGUgQ0NQCiAgICovCiAgY29ubmVjdC5jb3JlLmluaXRTaGFyZWRXb3JrZXIgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmNvcmUuY2hlY2tOb3RJbml0aWFsaXplZCgpOwogICAgaWYgKGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAncGFyYW1zJyk7CiAKICAgIHZhciBzaGFyZWRXb3JrZXJVcmwgPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnNoYXJlZFdvcmtlclVybCwgJ3BhcmFtcy5zaGFyZWRXb3JrZXJVcmwnKTsKICAgIHZhciBhdXRoVG9rZW4gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmF1dGhUb2tlbiwgJ3BhcmFtcy5hdXRoVG9rZW4nKTsKICAgIHZhciByZWZyZXNoVG9rZW4gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnJlZnJlc2hUb2tlbiwgJ3BhcmFtcy5yZWZyZXNoVG9rZW4nKTsKICAgIHZhciBhdXRoVG9rZW5FeHBpcmF0aW9uID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5hdXRoVG9rZW5FeHBpcmF0aW9uLCAncGFyYW1zLmF1dGhUb2tlbkV4cGlyYXRpb24nKTsKICAgIHZhciByZWdpb24gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnJlZ2lvbiwgJ3BhcmFtcy5yZWdpb24nKTsKICAgIHZhciBlbmRwb2ludCA9IHBhcmFtcy5lbmRwb2ludCB8fCBudWxsOwogICAgdmFyIGF1dGhvcml6ZUVuZHBvaW50ID0gcGFyYW1zLmF1dGhvcml6ZUVuZHBvaW50OwogICAgaWYgKCFhdXRob3JpemVFbmRwb2ludCkgewogICAgICBhdXRob3JpemVFbmRwb2ludCA9IGNvbm5lY3QuY29yZS5pc0xlZ2FjeURvbWFpbigpCiAgICAgICAgPyBMRUdBQ1lfQVVUSE9SSVpFX0VORFBPSU5UCiAgICAgICAgOiBBVVRIT1JJWkVfRU5EUE9JTlQ7CiAgICB9CiAgICB2YXIgYWdlbnRBcHBFbmRwb2ludCA9IHBhcmFtcy5hZ2VudEFwcEVuZHBvaW50IHx8IG51bGw7CiAgICB2YXIgYXV0aENvb2tpZU5hbWUgPSBwYXJhbXMuYXV0aENvb2tpZU5hbWUgfHwgbnVsbDsKIAogICAgdHJ5IHsKICAgICAgLy8gSW5pdGlhbGl6ZSB0aGUgZXZlbnQgYnVzIGFuZCBhZ2VudCBkYXRhIHByb3ZpZGVycy4KICAgICAgY29ubmVjdC5jb3JlLmV2ZW50QnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoeyBsb2dFdmVudHM6IHRydWUgfSk7CiAgICAgIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlciA9IG5ldyBBZ2VudERhdGFQcm92aWRlcihjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKSk7CiAgICAgIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkgPSBuZXcgY29ubmVjdC5NZWRpYUZhY3RvcnkocGFyYW1zKTsKICAgICAgCiAgICAgIC8vIENyZWF0ZSB0aGUgc2hhcmVkIHdvcmtlciBhbmQgdXBzdHJlYW0gY29uZHVpdC4KICAgICAgdmFyIHdvcmtlciA9IG5ldyBTaGFyZWRXb3JrZXIoc2hhcmVkV29ya2VyVXJsLCAiQ29ubmVjdFNoYXJlZFdvcmtlciIpOwogICAgICB2YXIgY29uZHVpdCA9IG5ldyBjb25uZWN0LkNvbmR1aXQoIkNvbm5lY3RTaGFyZWRXb3JrZXJDb25kdWl0IiwKICAgICAgICBuZXcgY29ubmVjdC5Qb3J0U3RyZWFtKHdvcmtlci5wb3J0KSwKICAgICAgICBuZXcgY29ubmVjdC5XaW5kb3dJT1N0cmVhbSh3aW5kb3csIHBhcmVudCkpOwogCiAgICAgIC8vIFNldCB0aGUgZ2xvYmFsIHVwc3RyZWFtIGNvbmR1aXQgZm9yIGV4dGVybmFsIHVzZS4KICAgICAgY29ubmVjdC5jb3JlLnVwc3RyZWFtID0gY29uZHVpdDsKICAgICAgY29ubmVjdC5jb3JlLndlYlNvY2tldFByb3ZpZGVyID0gbmV3IFdlYlNvY2tldFByb3ZpZGVyKCk7CiAKICAgICAgLy8gQ2xvc2Ugb3VyIHBvcnQgdG8gdGhlIHNoYXJlZCB3b3JrZXIgYmVmb3JlIHRoZSB3aW5kb3cgY2xvc2VzLgogICAgICBnbG9iYWwub251bmxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQ0xPU0UpOwogICAgICAgIHdvcmtlci5wb3J0LmNsb3NlKCk7CiAgICAgIH07CiAKICAgICAgY29ubmVjdC5nZXRMb2coKS5zY2hlZHVsZVVwc3RyZWFtTG9nUHVzaChjb25kdWl0KTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5zY2hlZHVsZURvd25zdHJlYW1DbGllbnRTaWRlTG9nc1B1c2goKTsKICAgICAgLy8gQnJpZGdlIGFsbCB1cHN0cmVhbSBtZXNzYWdlcyBpbnRvIHRoZSBldmVudCBidXMuCiAgICAgIGNvbmR1aXQub25BbGxVcHN0cmVhbShjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5icmlkZ2UoKSk7CiAgICAgIC8vIFBhc3MgYWxsIHVwc3RyZWFtIG1lc3NhZ2VzIChmcm9tIHNoYXJlZCB3b3JrZXIpIGRvd25zdHJlYW0gKHRvIENDUCBjb25zdW1lcikuCiAgICAgIGNvbmR1aXQub25BbGxVcHN0cmVhbShjb25kdWl0LnBhc3NEb3duc3RyZWFtKCkpOwoKICAgICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSkgewogICAgICAgIC8vIEJyaWRnZSBhbGwgZG93bnN0cmVhbSBtZXNzYWdlcyBpbnRvIHRoZSBldmVudCBidXMuCiAgICAgICAgY29uZHVpdC5vbkFsbERvd25zdHJlYW0oY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuYnJpZGdlKCkpOwogICAgICAgIC8vIFBhc3MgYWxsIGRvd25zdHJlYW0gbWVzc2FnZXMgKGZyb20gQ0NQIGNvbnN1bWVyKSB1cHN0cmVhbSAodG8gc2hhcmVkIHdvcmtlcikuCiAgICAgICAgY29uZHVpdC5vbkFsbERvd25zdHJlYW0oY29uZHVpdC5wYXNzVXBzdHJlYW0oKSk7CiAgICAgIH0KICAgICAgLy8gU2VuZCBjb25maWd1cmF0aW9uIHVwIHRvIHRoZSBzaGFyZWQgd29ya2VyLgogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIHsKICAgICAgICBhdXRoVG9rZW46IGF1dGhUb2tlbiwKICAgICAgICBhdXRoVG9rZW5FeHBpcmF0aW9uOiBhdXRoVG9rZW5FeHBpcmF0aW9uLAogICAgICAgIGVuZHBvaW50OiBlbmRwb2ludCwKICAgICAgICByZWZyZXNoVG9rZW46IHJlZnJlc2hUb2tlbiwKICAgICAgICByZWdpb246IHJlZ2lvbiwKICAgICAgICBhdXRob3JpemVFbmRwb2ludDogYXV0aG9yaXplRW5kcG9pbnQsCiAgICAgICAgYWdlbnRBcHBFbmRwb2ludDogYWdlbnRBcHBFbmRwb2ludCwKICAgICAgICBhdXRoQ29va2llTmFtZTogYXV0aENvb2tpZU5hbWUKICAgICAgfSk7CiAKICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQWNrbm93bGVkZ2VkIGJ5IHRoZSBDb25uZWN0U2hhcmVkV29ya2VyISIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICBjb25uZWN0LmNvcmUucG9ydFN0cmVhbUlkID0gZGF0YS5pZDsKICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgIH0pOwogICAgICAvLyBBZGQgYWxsIHVwc3RyZWFtIGxvZyBlbnRyaWVzIHRvIG91ciBvd24gbG9nZ2VyLgogICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTE9HLCBmdW5jdGlvbiAobG9nRW50cnkpIHsKICAgICAgICBpZiAobG9nRW50cnkubG9nZ2VySWQgIT09IGNvbm5lY3QuZ2V0TG9nKCkuZ2V0TG9nZ2VySWQoKSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5hZGRMb2dFbnRyeShjb25uZWN0LkxvZ0VudHJ5LmZyb21PYmplY3QobG9nRW50cnkpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAvLyBHZXQgd29ya2VyIGxvZ3MKICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNFUlZFUl9CT1VORF9JTlRFUk5BTF9MT0csIGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuc2VuZEludGVybmFsTG9nRW50cnlUb1NlcnZlcihjb25uZWN0LkxvZ0VudHJ5LmZyb21PYmplY3QobG9nRW50cnkpKTsKICAgICAgfSk7CiAgICAgIC8vIEdldCBvdXRlciBjb250ZXh0IGxvZ3MKICAgICAgY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU0VSVkVSX0JPVU5EX0lOVEVSTkFMX0xPRywgZnVuY3Rpb24gKGxvZ3MpIHsKICAgICAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpICYmIEFycmF5LmlzQXJyYXkobG9ncykpIHsKICAgICAgICAgIGxvZ3MuZm9yRWFjaChmdW5jdGlvbiAobG9nKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuc2VuZEludGVybmFsTG9nRW50cnlUb1NlcnZlcihjb25uZWN0LkxvZ0VudHJ5LmZyb21PYmplY3QobG9nKSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAvLyBHZXQgbG9nIGZyb20gb3V0ZXIgY29udGV4dAogICAgICBjb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIGZ1bmN0aW9uIChsb2cpIHsKICAgICAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpICYmIGxvZy5sb2dnZXJJZCAhPT0gY29ubmVjdC5nZXRMb2coKS5nZXRMb2dnZXJJZCgpKSB7IAogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5hZGRMb2dFbnRyeShjb25uZWN0LkxvZ0VudHJ5LmZyb21PYmplY3QobG9nKSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgLy8gUmVsb2FkIHRoZSBwYWdlIGlmIHRoZSBzaGFyZWQgd29ya2VyIGRldGVjdHMgYW4gQVBJIGF1dGggZmFpbHVyZS4KICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhfRkFJTCwgZnVuY3Rpb24gKGxvZ0VudHJ5KSB7CiAgICAgICAgbG9jYXRpb24ucmVsb2FkKCk7CiAgICAgIH0pOwoKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJVc2VyIEFnZW50OiAiICsgbmF2aWdhdG9yLnVzZXJBZ2VudCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJpc0NDUHYyOiAiICsgdHJ1ZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJpc0ZyYW1lZDogIiArIGNvbm5lY3QuaXNGcmFtZWQoKSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29ubmVjdC5jb3JlLnVwc3RyZWFtLm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5PVVRFUl9DT05URVhUX0lORk8sIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgdmFyIHN0cmVhbXNWZXJzaW9uID0gZGF0YS5zdHJlYW1zVmVyc2lvbjsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlN0cmVhbXNKUyBWZXJzaW9uOiAiICsgc3RyZWFtc1ZlcnNpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0pOwoKICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlVQREFURV9DT05ORUNURURfQ0NQUywgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIk51bWJlciBvZiBjb25uZWN0ZWQgQ0NQcyB1cGRhdGVkOiAiICsgZGF0YS5sZW5ndGgpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHMgPSBkYXRhLmxlbmd0aDsKICAgICAgfSk7CgogICAgICBjb25uZWN0LmNvcmUuY2xpZW50ID0gbmV3IGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0Q2xpZW50KGNvbmR1aXQpOwogICAgICBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50ID0gbmV3IGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50KGNvbmR1aXQpOwogCiAgICAgIC8vIFBhc3MgdGhlIFRFUk1JTkFURSByZXF1ZXN0IHVwc3RyZWFtIHRvIHRoZSBzaGFyZWQgd29ya2VyLgogICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFLAogICAgICAgIGNvbmR1aXQucGFzc1Vwc3RyZWFtKCkpOwogCiAgICAgIC8vIFJlZnJlc2ggdGhlIHBhZ2Ugd2hlbiB3ZSByZWNlaXZlIHRoZSBURVJNSU5BVEVEIHJlc3BvbnNlIGZyb20gdGhlCiAgICAgIC8vIHNoYXJlZCB3b3JrZXIuCiAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5URVJNSU5BVEVELCBmdW5jdGlvbiAoKSB7CiAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCh0cnVlKTsKICAgICAgfSk7CiAKICAgICAgd29ya2VyLnBvcnQuc3RhcnQoKTsKIAogICAgICAvLyBBdHRlbXB0IHRvIGdldCBwZXJtaXNzaW9uIHRvIHNob3cgbm90aWZpY2F0aW9ucy4KICAgICAgdmFyIG5tID0gY29ubmVjdC5jb3JlLmdldE5vdGlmaWNhdGlvbk1hbmFnZXIoKTsKICAgICAgbm0ucmVxdWVzdFBlcm1pc3Npb24oKTsKIAogICAgICBjb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuSU5JVF9ESVNBU1RFUl9SRUNPVkVSWSwgZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmluaXREaXNhc3RlclJlY292ZXJ5KHBhcmFtcyk7CiAgICAgIH0pCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBpbml0aWFsaXplIHRoZSBBUEkgc2hhcmVkIHdvcmtlciwgd2UncmUgZGVhZCEiKQogICAgICAgIC53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJbml0aWFsaXplcyBDb25uZWN0IGJ5IGNyZWF0aW5nIG9yIGNvbm5lY3RpbmcgdG8gdGhlIEFQSSBTaGFyZWQgV29ya2VyLgogICAqIEluaXRpYWxpemVzIENvbm5lY3QgYnkgbG9hZGluZyB0aGUgQ0NQIGluIGFuIGlmcmFtZSBhbmQgY29ubmVjdGluZyB0byBpdC4KICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdENDUCA9IGZ1bmN0aW9uIChjb250YWluZXJEaXYsIHBhcmFtc0luKSB7CiAgICBjb25uZWN0LmNvcmUuY2hlY2tOb3RJbml0aWFsaXplZCgpOwogICAgaWYgKGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCkgewogICAgICByZXR1cm47CiAgICB9CiAKICAgIC8vIEZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSwgd2hlbiBpbnN0ZWFkIG9mIHRha2luZyBhIHBhcmFtcyBvYmplY3QKICAgIC8vIGFzIGlucHV0IHdlIG9ubHkgYWNjZXB0ZWQgY2NwVXJsLgogICAgdmFyIHBhcmFtcyA9IHt9OwogICAgaWYgKHR5cGVvZiAocGFyYW1zSW4pID09PSAnc3RyaW5nJykgewogICAgICBwYXJhbXMuY2NwVXJsID0gcGFyYW1zSW47CiAgICB9IGVsc2UgewogICAgICBwYXJhbXMgPSBwYXJhbXNJbjsKICAgIH0KIAogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbnRhaW5lckRpdiwgJ2NvbnRhaW5lckRpdicpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5jY3BVcmwsICdwYXJhbXMuY2NwVXJsJyk7CiAKICAgIC8vIENyZWF0ZSB0aGUgQ0NQIGlmcmFtZSBhbmQgYXBwZW5kIGl0IHRvIHRoZSBjb250YWluZXIgZGl2LgogICAgdmFyIGlmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lmcmFtZScpOwogICAgaWZyYW1lLnNyYyA9IHBhcmFtcy5jY3BVcmw7CiAgICBpZnJhbWUuYWxsb3cgPSAibWljcm9waG9uZTsgYXV0b3BsYXkiOwogICAgaWZyYW1lLnN0eWxlID0gIndpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCUiOwogICAgaWZyYW1lLnRpdGxlID0gJ0FtYXpvbiBDb25uZWN0IENDUCc7CiAgICBjb250YWluZXJEaXYuYXBwZW5kQ2hpbGQoaWZyYW1lKTsKCiAgICAvLyBJbml0aWFsaXplIHRoZSBldmVudCBidXMgYW5kIGFnZW50IGRhdGEgcHJvdmlkZXJzLgogICAgLy8gTk9URTogU2V0dGluZyBsb2dFdmVudHMgaGVyZSB0byBGQUxTRSBpbiBvcmRlciB0byBhdm9pZCBkdXBsaWNhdGluZwogICAgLy8gZXZlbnRzIHdoaWNoIGFyZSBsb2dnZWQgaW4gQ0NQLgogICAgY29ubmVjdC5jb3JlLmV2ZW50QnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoeyBsb2dFdmVudHM6IGZhbHNlIH0pOwogICAgY29ubmVjdC5jb3JlLmFnZW50RGF0YVByb3ZpZGVyID0gbmV3IEFnZW50RGF0YVByb3ZpZGVyKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpKTsKICAgIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkgPSBuZXcgY29ubmVjdC5NZWRpYUZhY3RvcnkocGFyYW1zKTsKIAogICAgLy8gQnVpbGQgdGhlIHVwc3RyZWFtIGNvbmR1aXQgY29tbXVuaWNhdGluZyB3aXRoIHRoZSBDQ1AgaWZyYW1lLgogICAgdmFyIGNvbmR1aXQgPSBuZXcgY29ubmVjdC5JRnJhbWVDb25kdWl0KHBhcmFtcy5jY3BVcmwsIHdpbmRvdywgaWZyYW1lKTsKIAogICAgLy8gTGV0IENDUCBrbm93IGlmIGlmcmFtZSBpcyB2aXNpYmxlCiAgICBpZnJhbWUub25sb2FkID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgdmFyIHN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoaWZyYW1lLCBudWxsKTsKICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgZGlzcGxheTogc3R5bGUuZGlzcGxheSwKICAgICAgICBvZmZzZXRXaWR0aDogaWZyYW1lLm9mZnNldFdpZHRoLAogICAgICAgIG9mZnNldEhlaWdodDogaWZyYW1lLm9mZnNldEhlaWdodCwKICAgICAgICBjbGllbnRSZWN0c0xlbmd0aDogaWZyYW1lLmdldENsaWVudFJlY3RzKCkubGVuZ3RoCiAgICAgIH07CiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLklGUkFNRV9TVFlMRSwgZGF0YSk7CiAgICB9LCAxMDAwMCk7CiAKICAgIC8vIFNldCB0aGUgZ2xvYmFsIHVwc3RyZWFtIGNvbmR1aXQgZm9yIGV4dGVybmFsIHVzZS4KICAgIGNvbm5lY3QuY29yZS51cHN0cmVhbSA9IGNvbmR1aXQ7CiAKICAgIC8vIEluaXQgd2ViU29ja2V0UHJvdmlkZXIKICAgIGNvbm5lY3QuY29yZS53ZWJTb2NrZXRQcm92aWRlciA9IG5ldyBXZWJTb2NrZXRQcm92aWRlcigpOwogCiAgICBjb25kdWl0Lm9uQWxsVXBzdHJlYW0oY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuYnJpZGdlKCkpOwogCiAgICAvLyBJbml0aWFsaXplIHRoZSBrZWVwYWxpdmUgbWFuYWdlci4KICAgIGNvbm5lY3QuY29yZS5rZWVwYWxpdmVNYW5hZ2VyID0gbmV3IEtlZXBhbGl2ZU1hbmFnZXIoY29uZHVpdCwKICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCksCiAgICAgIHBhcmFtcy5jY3BTeW5UaW1lb3V0IHx8IENDUF9TWU5fVElNRU9VVCwKICAgICAgcGFyYW1zLmNjcEFja1RpbWVvdXQgfHwgQ0NQX0FDS19USU1FT1VUKQogICAgICA7CiAgICBjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEludGVydmFsID0gbnVsbDsKIAogICAgLy8gQWxsb3cgMTAgc2VjIChkZWZhdWx0KSBiZWZvcmUgcmVjZWl2aW5nIHRoZSBmaXJzdCBBQ0sgZnJvbSB0aGUgQ0NQLgogICAgY29ubmVjdC5jb3JlLmNjcExvYWRUaW1lb3V0SW5zdGFuY2UgPSBnbG9iYWwuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIGNvbm5lY3QuY29yZS5jY3BMb2FkVGltZW91dEluc3RhbmNlID0gbnVsbDsKICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5BQ0tfVElNRU9VVCk7CiAgICB9LCBwYXJhbXMuY2NwTG9hZFRpbWVvdXQgfHwgQ0NQX0xPQURfVElNRU9VVCk7CgogICAgY29ubmVjdC5nZXRMb2coKS5zY2hlZHVsZVVwc3RyZWFtT3V0ZXJDb250ZXh0Q0NQTG9nc1B1c2goY29uZHVpdCk7CiAgICBjb25uZWN0LmdldExvZygpLnNjaGVkdWxlVXBzdHJlYW1PdXRlckNvbnRleHRDQ1BzZXJ2ZXJCb3VuZExvZ3NQdXNoKGNvbmR1aXQpOwogCiAgICAvLyBPbmNlIHdlIHJlY2VpdmUgdGhlIGZpcnN0IEFDSywgc2V0dXAgb3VyIHVwc3RyZWFtIEFQSSBjbGllbnQgYW5kIGVzdGFibGlzaAogICAgLy8gdGhlIFNZTi9BQ0sgcmVmcmVzaCBmbG93LgogICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkFja25vd2xlZGdlZCBieSB0aGUgQ0NQISIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbm5lY3QuY29yZS5jbGllbnQgPSBuZXcgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRDbGllbnQoY29uZHVpdCk7CiAgICAgIGNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQgPSBuZXcgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQoY29uZHVpdCk7CiAgICAgIGNvbm5lY3QuY29yZS5wb3J0U3RyZWFtSWQgPSBkYXRhLmlkOwoKICAgICAgaWYgKHBhcmFtcy5zb2Z0cGhvbmUgfHwgcGFyYW1zLmNoYXQgfHwgcGFyYW1zLnBhZ2VPcHRpb25zKSB7CiAgICAgICAgLy8gU2VuZCBjb25maWd1cmF0aW9uIHVwIHRvIHRoZSBDQ1AuCiAgICAgICAgLy9zZXQgaXQgdG8gZmFsc2UgaWYgc2Vjb25kYXJ5CiAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQ09ORklHVVJFLCB7CiAgICAgICAgICBzb2Z0cGhvbmU6IHBhcmFtcy5zb2Z0cGhvbmUsCiAgICAgICAgICBjaGF0OiBwYXJhbXMuY2hhdCwKICAgICAgICAgIHBhZ2VPcHRpb25zOiBwYXJhbXMucGFnZU9wdGlvbnMKICAgICAgICB9KTsKICAgICAgfQogCiAgICAgIC8vIElmIERSIGVuYWJsZWQsIHNldCB0aGlzIENDUCBpbnN0YW5jZSBhcyBwYXJ0IG9mIGEgRGlzYXN0ZXIgUmVjb3ZlcnkgZmxlZXQKICAgICAgaWYgKHBhcmFtcy5kaXNhc3RlclJlY292ZXJ5T24pIHsKICAgICAgICBjb25uZWN0LmNvcmUucmVnaW9uID0gcGFyYW1zLnJlZ2lvbjsKICAgICAgICBjb25uZWN0LmNvcmUuc3VwcHJlc3NDb250YWN0cyA9IHN1cHByZXNzQ29udGFjdHM7CiAgICAgICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLlNFVF9PRkZMSU5FKTsKICAgICAgICB9ICAgICAgIAogICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5JTklUX0RJU0FTVEVSX1JFQ09WRVJZLCBwYXJhbXMpOwogICAgICB9CiAKICAgICAgaWYgKGNvbm5lY3QuY29yZS5jY3BMb2FkVGltZW91dEluc3RhbmNlKSB7CiAgICAgICAgZ2xvYmFsLmNsZWFyVGltZW91dChjb25uZWN0LmNvcmUuY2NwTG9hZFRpbWVvdXRJbnN0YW5jZSk7CiAgICAgICAgY29ubmVjdC5jb3JlLmNjcExvYWRUaW1lb3V0SW5zdGFuY2UgPSBudWxsOwogICAgICB9CgogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5PVVRFUl9DT05URVhUX0lORk8sIHsgc3RyZWFtc1ZlcnNpb246IGNvbm5lY3QudmVyc2lvbiB9KTsKIAogICAgICBjb25uZWN0LmNvcmUua2VlcGFsaXZlTWFuYWdlci5zdGFydCgpOwogICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CgogICAgICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLklOSVQpOwogICAgfSk7CiAKICAgIC8vIEFkZCBhbnkgbG9ncyBmcm9tIHRoZSB1cHN0cmVhbSB0byBvdXIgb3duIGxvZ2dlci4KICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgICBpZiAobG9nRW50cnkubG9nZ2VySWQgIT09IGNvbm5lY3QuZ2V0TG9nKCkuZ2V0TG9nZ2VySWQoKSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuYWRkTG9nRW50cnkoY29ubmVjdC5Mb2dFbnRyeS5mcm9tT2JqZWN0KGxvZ0VudHJ5KSk7CiAgICAgIH0KICAgIH0pOwogCiAgICAvLyBQb3AgYSBsb2dpbiBwYWdlIHdoZW4gd2UgZW5jb3VudGVyIGFuIEFDSyB0aW1lb3V0LgogICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkFDS19USU1FT1VULCBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIGxvZ2luUG9wdXAgaXMgdHJ1ZSBieSBkZWZhdWx0LCBvbmx5IGZhbHNlIGlmIGV4cGxpY2l0bHkgc2V0IHRvIGZhbHNlLgogICAgICBpZiAocGFyYW1zLmxvZ2luUG9wdXAgIT09IGZhbHNlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBsb2dpblVybCA9IGdldExvZ2luVXJsKHBhcmFtcyk7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIkFDS19USU1FT1VUIG9jY3VycmVkLCBhdHRlbXB0aW5nIHRvIHBvcCB0aGUgbG9naW4gcGFnZSBpZiBub3QgYWxyZWFkeSBvcGVuLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAvLyBjbGVhciBvdXQgbGFzdCBvcGVuZWQgdGltZXN0YW1wIGZvciBTQU1MIGF1dGhlbnRpY2F0aW9uIHdoZW4gdGhlcmUgaXMgQUNLX1RJTUVPVVQKICAgICAgICAgIGlmIChwYXJhbXMubG9naW5VcmwpIHsKICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5nZXRQb3B1cE1hbmFnZXIoKS5jbGVhcihjb25uZWN0Lk1hc3RlclRvcGljcy5MT0dJTl9QT1BVUCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25uZWN0LmNvcmUubG9naW5XaW5kb3cgPSBjb25uZWN0LmNvcmUuZ2V0UG9wdXBNYW5hZ2VyKCkub3Blbihsb2dpblVybCwgY29ubmVjdC5NYXN0ZXJUb3BpY3MuTE9HSU5fUE9QVVApOwogCiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiQUNLX1RJTUVPVVQgb2NjdXJyZWQgYnV0IHdlIGFyZSB1bmFibGUgdG8gb3BlbiB0aGUgbG9naW4gcG9wdXAuIikud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0KICAgICAgfQogCiAgICAgIGlmIChjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEludGVydmFsID09IG51bGwpIHsKICAgICAgICB2YXIgY2NwX2lmcmFtZV9yZWZyZXNoX2ludGVydmFsID0gKHBhcmFtcy5kaXNhc3RlclJlY292ZXJ5T24pID8gQ0NQX0RSX0lGUkFNRV9SRUZSRVNIX0lOVEVSVkFMIDogQ0NQX0lGUkFNRV9SRUZSRVNIX0lOVEVSVkFMOwogICAgICAgIGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoSW50ZXJ2YWwgPSB3aW5kb3cuc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgaWZyYW1lLnNyYyA9IChwYXJhbXMuZGlzYXN0ZXJSZWNvdmVyeU9uKSA/IHBhcmFtcy5sb2dpblVybCA6IHBhcmFtcy5jY3BVcmw7CiAgICAgICAgfSwgY2NwX2lmcmFtZV9yZWZyZXNoX2ludGVydmFsKTsKIAogICAgICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwogICAgICAgICAgZ2xvYmFsLmNsZWFySW50ZXJ2YWwoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hJbnRlcnZhbCk7CiAgICAgICAgICBjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEludGVydmFsID0gbnVsbDsKICAgICAgICAgIGNvbm5lY3QuY29yZS5nZXRQb3B1cE1hbmFnZXIoKS5jbGVhcihjb25uZWN0Lk1hc3RlclRvcGljcy5MT0dJTl9QT1BVUCk7CiAgICAgICAgICBpZiAocGFyYW1zLmxvZ2luUG9wdXBBdXRvQ2xvc2UgJiYgY29ubmVjdC5jb3JlLmxvZ2luV2luZG93KSB7CiAgICAgICAgICAgIGNvbm5lY3QuY29yZS5sb2dpbldpbmRvdy5jbG9zZSgpOwogICAgICAgICAgICBjb25uZWN0LmNvcmUubG9naW5XaW5kb3cgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKIAogICAgaWYgKHBhcmFtcy5vblZpZXdDb250YWN0KSB7CiAgICAgIGNvbm5lY3QuY29yZS5vblZpZXdDb250YWN0KHBhcmFtcy5vblZpZXdDb250YWN0KTsKICAgIH0KCiAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVVBEQVRFX0NPTk5FQ1RFRF9DQ1BTLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQcyA9IGRhdGEubGVuZ3RoOwogICAgfSk7CgogICAgLy8ga2VlcCB0aGUgc29mdHBob25lIHBhcmFtcyBmb3IgZXh0ZXJuYWwgdXNlCiAgICBjb25uZWN0LmNvcmUuc29mdHBob25lUGFyYW1zID0gcGFyYW1zLnNvZnRwaG9uZTsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIHZhciBLZWVwYWxpdmVNYW5hZ2VyID0gZnVuY3Rpb24gKGNvbmR1aXQsIGV2ZW50QnVzLCBzeW5UaW1lb3V0LCBhY2tUaW1lb3V0KSB7CiAgICB0aGlzLmNvbmR1aXQgPSBjb25kdWl0OwogICAgdGhpcy5ldmVudEJ1cyA9IGV2ZW50QnVzOwogICAgdGhpcy5zeW5UaW1lb3V0ID0gc3luVGltZW91dDsKICAgIHRoaXMuYWNrVGltZW91dCA9IGFja1RpbWVvdXQ7CiAgICB0aGlzLmFja1RpbWVyID0gbnVsbDsKICAgIHRoaXMuc3luVGltZXIgPSBudWxsOwogICAgdGhpcy5hY2tTdWIgPSBudWxsOwogIH07CiAKICBLZWVwYWxpdmVNYW5hZ2VyLnByb3RvdHlwZS5zdGFydCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKIAogICAgdGhpcy5jb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TWU5DSFJPTklaRSk7CiAgICB0aGlzLmFja1N1YiA9IHRoaXMuY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFLCBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKICAgICAgZ2xvYmFsLmNsZWFyVGltZW91dChzZWxmLmFja1RpbWVyKTsKICAgICAgc2VsZi5kZWZlclN0YXJ0KCk7CiAgICB9KTsKICAgIHRoaXMuYWNrVGltZXIgPSBnbG9iYWwuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIHNlbGYuYWNrU3ViLnVuc3Vic2NyaWJlKCk7CiAgICAgIHNlbGYuZXZlbnRCdXMudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5BQ0tfVElNRU9VVCk7CiAgICAgIHNlbGYuZGVmZXJTdGFydCgpOwogICAgfSwgdGhpcy5hY2tUaW1lb3V0KTsKICB9OwogCiAgS2VlcGFsaXZlTWFuYWdlci5wcm90b3R5cGUuZGVmZXJTdGFydCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLnN5blRpbWVyID09IG51bGwpIHsKICAgICAgdGhpcy5zeW5UaW1lciA9IGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5zdGFydCksIHRoaXMuc3luVGltZW91dCk7CiAgICB9CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KIAogIHZhciBXZWJTb2NrZXRQcm92aWRlciA9IGZ1bmN0aW9uICgpIHsKIAogICAgdmFyIGNhbGxiYWNrcyA9IHsKICAgICAgaW5pdEZhaWx1cmU6IG5ldyBTZXQoKSwKICAgICAgc3Vic2NyaXB0aW9uVXBkYXRlOiBuZXcgU2V0KCksCiAgICAgIHN1YnNjcmlwdGlvbkZhaWx1cmU6IG5ldyBTZXQoKSwKICAgICAgdG9waWM6IG5ldyBNYXAoKSwKICAgICAgYWxsTWVzc2FnZTogbmV3IFNldCgpLAogICAgICBjb25uZWN0aW9uR2FpbjogbmV3IFNldCgpLAogICAgICBjb25uZWN0aW9uTG9zdDogbmV3IFNldCgpLAogICAgICBjb25uZWN0aW9uT3BlbjogbmV3IFNldCgpLAogICAgICBjb25uZWN0aW9uQ2xvc2U6IG5ldyBTZXQoKQogICAgfTsKIAogICAgdmFyIGludm9rZUNhbGxiYWNrcyA9IGZ1bmN0aW9uIChjYWxsYmFja3MsIHJlc3BvbnNlKSB7CiAgICAgIGNhbGxiYWNrcy5mb3JFYWNoKGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgIGNhbGxiYWNrKHJlc3BvbnNlKTsKICAgICAgfSk7CiAgICB9OwogCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLklOSVRfRkFJTFVSRSwgZnVuY3Rpb24gKCkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmluaXRGYWlsdXJlKTsKICAgIH0pOwoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9PUEVOLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5jb25uZWN0aW9uT3BlbiwgcmVzcG9uc2UpOwogICAgfSk7CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0NMT1NFLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5jb25uZWN0aW9uQ2xvc2UsIHJlc3BvbnNlKTsKICAgIH0pOwoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9HQUlOLCBmdW5jdGlvbiAoKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuY29ubmVjdGlvbkdhaW4pOwogICAgfSk7CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0xPU1QsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmNvbm5lY3Rpb25Mb3N0LCByZXNwb25zZSk7CiAgICB9KTsKIAogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJUFRJT05fVVBEQVRFLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5zdWJzY3JpcHRpb25VcGRhdGUsIHJlc3BvbnNlKTsKICAgIH0pOwogCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNVQlNDUklQVElPTl9GQUlMVVJFLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5zdWJzY3JpcHRpb25GYWlsdXJlLCByZXNwb25zZSk7CiAgICB9KTsKIAogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5BTExfTUVTU0FHRSwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuYWxsTWVzc2FnZSwgcmVzcG9uc2UpOwogICAgICBpZiAoY2FsbGJhY2tzLnRvcGljLmhhcyhyZXNwb25zZS50b3BpYykpIHsKICAgICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLnRvcGljLmdldChyZXNwb25zZS50b3BpYyksIHJlc3BvbnNlKTsKICAgICAgfQogICAgfSk7CiAKICAgIHRoaXMuc2VuZE1lc3NhZ2UgPSBmdW5jdGlvbiAod2ViU29ja2V0UGF5bG9hZCkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU0VORCwgd2ViU29ja2V0UGF5bG9hZCk7CiAgICB9OwogCiAgICB0aGlzLm9uSW5pdEZhaWx1cmUgPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5pbml0RmFpbHVyZS5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuaW5pdEZhaWx1cmUuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CgogICAgdGhpcy5vbkNvbm5lY3Rpb25PcGVuID0gZnVuY3Rpb24oY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5jb25uZWN0aW9uT3Blbi5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuY29ubmVjdGlvbk9wZW4uZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CgogICAgdGhpcy5vbkNvbm5lY3Rpb25DbG9zZSA9IGZ1bmN0aW9uKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuY29ubmVjdGlvbkNsb3NlLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5jb25uZWN0aW9uQ2xvc2UuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CgogICAgdGhpcy5vbkNvbm5lY3Rpb25HYWluID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuY29ubmVjdGlvbkdhaW4uYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmNvbm5lY3Rpb25HYWluLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgICB0aGlzLm9uQ29ubmVjdGlvbkxvc3QgPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5jb25uZWN0aW9uTG9zdC5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuY29ubmVjdGlvbkxvc3QuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICAgIHRoaXMub25TdWJzY3JpcHRpb25VcGRhdGUgPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5zdWJzY3JpcHRpb25VcGRhdGUuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLnN1YnNjcmlwdGlvblVwZGF0ZS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogICAgdGhpcy5vblN1YnNjcmlwdGlvbkZhaWx1cmUgPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5zdWJzY3JpcHRpb25GYWlsdXJlLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5zdWJzY3JpcHRpb25GYWlsdXJlLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgICB0aGlzLnN1YnNjcmliZVRvcGljcyA9IGZ1bmN0aW9uICh0b3BpY3MpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljcywgJ3RvcGljcycpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0FycmF5KHRvcGljcyksICd0b3BpY3MgbXVzdCBiZSBhIGFycmF5Jyk7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJQkUsIHRvcGljcyk7CiAgICB9OwogCiAgICB0aGlzLm9uTWVzc2FnZSA9IGZ1bmN0aW9uICh0b3BpY05hbWUsIGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b3BpY05hbWUsICd0b3BpY05hbWUnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGlmIChjYWxsYmFja3MudG9waWMuaGFzKHRvcGljTmFtZSkpIHsKICAgICAgICBjYWxsYmFja3MudG9waWMuZ2V0KHRvcGljTmFtZSkuYWRkKGNiKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFja3MudG9waWMuc2V0KHRvcGljTmFtZSwgbmV3IFNldChbY2JdKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLnRvcGljLmdldCh0b3BpY05hbWUpLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgICB0aGlzLm9uQWxsTWVzc2FnZSA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmFsbE1lc3NhZ2UuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmFsbE1lc3NhZ2UuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIHZhciBBZ2VudERhdGFQcm92aWRlciA9IGZ1bmN0aW9uIChidXMpIHsKICAgIHZhciBhZ2VudERhdGEgPSBudWxsOwogICAgdGhpcy5idXMgPSBidXM7CiAgICB0aGlzLmJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5VUERBVEUsIGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy51cGRhdGVBZ2VudERhdGEpKTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLnVwZGF0ZUFnZW50RGF0YSA9IGZ1bmN0aW9uIChhZ2VudERhdGEpIHsKICAgIHZhciBvbGRBZ2VudERhdGEgPSB0aGlzLmFnZW50RGF0YTsKICAgIHRoaXMuYWdlbnREYXRhID0gYWdlbnREYXRhOwogCiAgICBpZiAob2xkQWdlbnREYXRhID09IG51bGwpIHsKICAgICAgY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCA9IHRydWU7CiAgICAgIHRoaXMuYnVzLnRyaWdnZXIoY29ubmVjdC5BZ2VudEV2ZW50cy5JTklULCBuZXcgY29ubmVjdC5BZ2VudCgpKTsKICAgIH0KIAogICAgdGhpcy5idXMudHJpZ2dlcihjb25uZWN0LkFnZW50RXZlbnRzLlJFRlJFU0gsIG5ldyBjb25uZWN0LkFnZW50KCkpOwogCiAgICB0aGlzLl9maXJlQWdlbnRVcGRhdGVFdmVudHMob2xkQWdlbnREYXRhKTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLmdldEFnZW50RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLmFnZW50RGF0YSA9PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ05vIGFnZW50IGRhdGEgaXMgYXZhaWxhYmxlIHlldCEnKTsKICAgIH0KIAogICAgcmV0dXJuIHRoaXMuYWdlbnREYXRhOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuZ2V0Q29udGFjdERhdGEgPSBmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICB2YXIgYWdlbnREYXRhID0gdGhpcy5nZXRBZ2VudERhdGEoKTsKICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuZmluZChhZ2VudERhdGEuc25hcHNob3QuY29udGFjdHMsIGZ1bmN0aW9uIChjdGRhdGEpIHsKICAgICAgcmV0dXJuIGN0ZGF0YS5jb250YWN0SWQgPT09IGNvbnRhY3RJZDsKICAgIH0pOwogCiAgICBpZiAoY29udGFjdERhdGEgPT0gbnVsbCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdDb250YWN0ICVzIG5vIGxvbmdlciBleGlzdHMuJywgY29udGFjdElkKTsKICAgIH0KIAogICAgcmV0dXJuIGNvbnRhY3REYXRhOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvbkRhdGEgPSBmdW5jdGlvbiAoY29udGFjdElkLCBjb25uZWN0aW9uSWQpIHsKICAgIHZhciBjb250YWN0RGF0YSA9IHRoaXMuZ2V0Q29udGFjdERhdGEoY29udGFjdElkKTsKICAgIHZhciBjb25uZWN0aW9uRGF0YSA9IGNvbm5lY3QuZmluZChjb250YWN0RGF0YS5jb25uZWN0aW9ucywgZnVuY3Rpb24gKGNkYXRhKSB7CiAgICAgIHJldHVybiBjZGF0YS5jb25uZWN0aW9uSWQgPT09IGNvbm5lY3Rpb25JZDsKICAgIH0pOwogCiAgICBpZiAoY29ubmVjdGlvbkRhdGEgPT0gbnVsbCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdDb25uZWN0aW9uICVzIGZvciBjb250YWN0ICVzIG5vIGxvbmdlciBleGlzdHMuJywgY29ubmVjdGlvbklkLCBjb250YWN0SWQpOwogICAgfQogCiAgICByZXR1cm4gY29ubmVjdGlvbkRhdGE7CiAgfTsKCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLmdldEluc3RhbmNlSWQgPSBmdW5jdGlvbigpewogICAgcmV0dXJuIHRoaXMuZ2V0QWdlbnREYXRhKCkuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5yb3V0aW5nUHJvZmlsZUlkLm1hdGNoKC9pbnN0YW5jZVwvKFswLTlhLWZBLUZ8LV0rKVwvLylbMV07CiAgfQoKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuZ2V0QVdTQWNjb3VudElkID0gZnVuY3Rpb24oKXsKICAgIHJldHVybiB0aGlzLmdldEFnZW50RGF0YSgpLmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucm91dGluZ1Byb2ZpbGVJZC5tYXRjaCgvOihbMC05XSspOmluc3RhbmNlLylbMV07CiAgfQogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLl9kaWZmQ29udGFjdHMgPSBmdW5jdGlvbiAob2xkQWdlbnREYXRhKSB7CiAgICB2YXIgZGlmZiA9IHsKICAgICAgYWRkZWQ6IHt9LAogICAgICByZW1vdmVkOiB7fSwKICAgICAgY29tbW9uOiB7fSwKICAgICAgb2xkTWFwOiBjb25uZWN0LmluZGV4KG9sZEFnZW50RGF0YSA9PSBudWxsID8gW10gOiBvbGRBZ2VudERhdGEuc25hcHNob3QuY29udGFjdHMsIGZ1bmN0aW9uIChjb250YWN0KSB7IHJldHVybiBjb250YWN0LmNvbnRhY3RJZDsgfSksCiAgICAgIG5ld01hcDogY29ubmVjdC5pbmRleCh0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGNvbnRhY3QpIHsgcmV0dXJuIGNvbnRhY3QuY29udGFjdElkOyB9KQogICAgfTsKIAogICAgY29ubmVjdC5rZXlzKGRpZmYub2xkTWFwKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgICAgaWYgKGNvbm5lY3QuY29udGFpbnMoZGlmZi5uZXdNYXAsIGNvbnRhY3RJZCkpIHsKICAgICAgICBkaWZmLmNvbW1vbltjb250YWN0SWRdID0gZGlmZi5uZXdNYXBbY29udGFjdElkXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkaWZmLnJlbW92ZWRbY29udGFjdElkXSA9IGRpZmYub2xkTWFwW2NvbnRhY3RJZF07CiAgICAgIH0KICAgIH0pOwogCiAgICBjb25uZWN0LmtleXMoZGlmZi5uZXdNYXApLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgICBpZiAoIWNvbm5lY3QuY29udGFpbnMoZGlmZi5vbGRNYXAsIGNvbnRhY3RJZCkpIHsKICAgICAgICBkaWZmLmFkZGVkW2NvbnRhY3RJZF0gPSBkaWZmLm5ld01hcFtjb250YWN0SWRdOwogICAgICB9CiAgICB9KTsKIAogICAgcmV0dXJuIGRpZmY7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5fZmlyZUFnZW50VXBkYXRlRXZlbnRzID0gZnVuY3Rpb24gKG9sZEFnZW50RGF0YSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGRpZmYgPSBudWxsOwogICAgdmFyIG9sZEFnZW50U3RhdGUgPSBvbGRBZ2VudERhdGEgPT0gbnVsbCA/IGNvbm5lY3QuQWdlbnRBdmFpbFN0YXRlcy5JTklUIDogb2xkQWdlbnREYXRhLnNuYXBzaG90LnN0YXRlLm5hbWU7CiAgICB2YXIgbmV3QWdlbnRTdGF0ZSA9IHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LnN0YXRlLm5hbWU7CiAgICB2YXIgb2xkUm91dGluZ1N0YXRlID0gb2xkQWdlbnREYXRhID09IG51bGwgPyBjb25uZWN0LkFnZW50U3RhdGVUeXBlLklOSVQgOiBvbGRBZ2VudERhdGEuc25hcHNob3Quc3RhdGUudHlwZTsKICAgIHZhciBuZXdSb3V0aW5nU3RhdGUgPSB0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5zdGF0ZS50eXBlOwogCiAgICBpZiAob2xkUm91dGluZ1N0YXRlICE9PSBuZXdSb3V0aW5nU3RhdGUpIHsKICAgICAgY29ubmVjdC5jb3JlLmdldEFnZW50Um91dGluZ0V2ZW50R3JhcGgoKS5nZXRBc3NvY2lhdGlvbnModGhpcywgb2xkUm91dGluZ1N0YXRlLCBuZXdSb3V0aW5nU3RhdGUpLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgc2VsZi5idXMudHJpZ2dlcihldmVudCwgbmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICAgIH0pOwogICAgfQogCiAgICBpZiAob2xkQWdlbnRTdGF0ZSAhPT0gbmV3QWdlbnRTdGF0ZSkgewogICAgICB0aGlzLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQWdlbnRFdmVudHMuU1RBVEVfQ0hBTkdFLCB7CiAgICAgICAgYWdlbnQ6IG5ldyBjb25uZWN0LkFnZW50KCksCiAgICAgICAgb2xkU3RhdGU6IG9sZEFnZW50U3RhdGUsCiAgICAgICAgbmV3U3RhdGU6IG5ld0FnZW50U3RhdGUKIAogICAgICB9KTsKICAgICAgY29ubmVjdC5jb3JlLmdldEFnZW50U3RhdGVFdmVudEdyYXBoKCkuZ2V0QXNzb2NpYXRpb25zKHRoaXMsIG9sZEFnZW50U3RhdGUsIG5ld0FnZW50U3RhdGUpLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgc2VsZi5idXMudHJpZ2dlcihldmVudCwgbmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICAgIH0pOwogICAgfQoKICAgIHZhciBvbGROZXh0U3RhdGUgPSBvbGRBZ2VudERhdGEgJiYgb2xkQWdlbnREYXRhLnNuYXBzaG90Lm5leHRTdGF0ZSA/IG9sZEFnZW50RGF0YS5zbmFwc2hvdC5uZXh0U3RhdGUubmFtZSA6IG51bGw7CiAgICB2YXIgbmV3TmV4dFN0YXRlID0gdGhpcy5hZ2VudERhdGEuc25hcHNob3QubmV4dFN0YXRlID8gdGhpcy5hZ2VudERhdGEuc25hcHNob3QubmV4dFN0YXRlLm5hbWUgOiBudWxsOwogICAgaWYgKG9sZE5leHRTdGF0ZSAhPT0gbmV3TmV4dFN0YXRlICYmIG5ld05leHRTdGF0ZSkgewogICAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQWdlbnRFdmVudHMuRU5RVUVVRURfTkVYVF9TVEFURSwgbmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICB9CgogICAgaWYgKG9sZEFnZW50RGF0YSAhPT0gbnVsbCkgewogICAgICBkaWZmID0gdGhpcy5fZGlmZkNvbnRhY3RzKG9sZEFnZW50RGF0YSk7CiAKICAgIH0gZWxzZSB7CiAgICAgIGRpZmYgPSB7CiAgICAgICAgYWRkZWQ6IGNvbm5lY3QuaW5kZXgodGhpcy5hZ2VudERhdGEuc25hcHNob3QuY29udGFjdHMsIGZ1bmN0aW9uIChjb250YWN0KSB7IHJldHVybiBjb250YWN0LmNvbnRhY3RJZDsgfSksCiAgICAgICAgcmVtb3ZlZDoge30sCiAgICAgICAgY29tbW9uOiB7fSwKICAgICAgICBvbGRNYXA6IHt9LAogICAgICAgIG5ld01hcDogY29ubmVjdC5pbmRleCh0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGNvbnRhY3QpIHsgcmV0dXJuIGNvbnRhY3QuY29udGFjdElkOyB9KQogICAgICB9OwogICAgfQogCiAgICBjb25uZWN0LnZhbHVlcyhkaWZmLmFkZGVkKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0RGF0YSkgewogICAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5JTklULCBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3REYXRhLmNvbnRhY3RJZCkpOwogICAgICBzZWxmLl9maXJlQ29udGFjdFVwZGF0ZUV2ZW50cyhjb250YWN0RGF0YS5jb250YWN0SWQsIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5JTklULCBjb250YWN0RGF0YS5zdGF0ZS50eXBlKTsKICAgIH0pOwogCiAgICBjb25uZWN0LnZhbHVlcyhkaWZmLnJlbW92ZWQpLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5Db250YWN0RXZlbnRzLkRFU1RST1lFRCwgbmV3IGNvbm5lY3QuQ29udGFjdFNuYXBzaG90KGNvbnRhY3REYXRhKSk7CiAgICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkRFU1RST1lFRCwgY29udGFjdERhdGEuY29udGFjdElkKSwgbmV3IGNvbm5lY3QuQ29udGFjdFNuYXBzaG90KGNvbnRhY3REYXRhKSk7CiAgICAgIHNlbGYuX3Vuc3ViQWxsQ29udGFjdEV2ZW50c0ZvckNvbnRhY3QoY29udGFjdERhdGEuY29udGFjdElkKTsKICAgIH0pOwogCiAgICBjb25uZWN0LmtleXMoZGlmZi5jb21tb24pLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgICBzZWxmLl9maXJlQ29udGFjdFVwZGF0ZUV2ZW50cyhjb250YWN0SWQsIGRpZmYub2xkTWFwW2NvbnRhY3RJZF0uc3RhdGUudHlwZSwgZGlmZi5uZXdNYXBbY29udGFjdElkXS5zdGF0ZS50eXBlKTsKICAgIH0pOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuX2ZpcmVDb250YWN0VXBkYXRlRXZlbnRzID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgb2xkQ29udGFjdFN0YXRlLCBuZXdDb250YWN0U3RhdGUpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGlmIChvbGRDb250YWN0U3RhdGUgIT09IG5ld0NvbnRhY3RTdGF0ZSkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50R3JhcGgoKS5nZXRBc3NvY2lhdGlvbnModGhpcywgb2xkQ29udGFjdFN0YXRlLCBuZXdDb250YWN0U3RhdGUpLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgc2VsZi5idXMudHJpZ2dlcihldmVudCwgbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0SWQpKTsKICAgICAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGV2ZW50LCBjb250YWN0SWQpLCBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkpOwogICAgICB9KTsKICAgIH0KCiAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5SRUZSRVNILCBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkpOwogICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuUkVGUkVTSCwgY29udGFjdElkKSwgbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0SWQpKTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLl91bnN1YkFsbENvbnRhY3RFdmVudHNGb3JDb250YWN0ID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgY29ubmVjdC52YWx1ZXMoY29ubmVjdC5Db250YWN0RXZlbnRzKS5mb3JFYWNoKGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgICAgc2VsZi5idXMuZ2V0U3Vic2NyaXB0aW9ucyhjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShldmVudE5hbWUsIGNvbnRhY3RJZCkpCiAgICAgICAgLm1hcChmdW5jdGlvbiAoc3ViKSB7IHN1Yi51bnN1YnNjcmliZSgpOyB9KTsKICAgIH0pOwogIH07CiAKICAvKiogLS0tLS0gbWluaW1hbCB2aWV3IGxheWVyIGV2ZW50IGhhbmRsaW5nICoqLwogCiAgY29ubmVjdC5jb3JlLm9uVmlld0NvbnRhY3QgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkNvbnRhY3RFdmVudHMuVklFVywgZik7CiAgfTsKIAogIC8qKgogICAqIFVzZWQgb2YgYWdlbnQgaW50ZXJmYWNlIGNvbnRyb2wuIAogICAqIGNvbm5lY3QuY29yZS52aWV3Q29udGFjdCgiY29udGFjdElkIikgLT4gIHRoaXMgaXMgY3VyZW50bHkgcHJvZ3JhbW1lZCB0byBnZXQgdGhlIGNvbnRhY3QgaW50byB2aWV3LgogICAqLwogIGNvbm5lY3QuY29yZS52aWV3Q29udGFjdCA9IGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29udGFjdEV2ZW50cy5WSUVXLAogICAgICBkYXRhOiB7CiAgICAgICAgY29udGFjdElkOiBjb250YWN0SWQKICAgICAgfQogICAgfSk7CiAgfTsKCiAgLyoqIC0tLS0tIG1pbmltYWwgdmlldyBsYXllciBldmVudCBoYW5kbGluZyAqKi8KIAogIGNvbm5lY3QuY29yZS5vbkFjdGl2YXRlQ2hhbm5lbFdpdGhWaWV3VHlwZSA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuVGFza0xpc3RFdmVudHMuQUNUSVZBVEVfQ0hBTk5FTF9XSVRIX1ZJRVdfVFlQRSwgZik7CiAgfTsKIAogIC8qKgogICAqIFVzZWQgb2YgYWdlbnQgaW50ZXJmYWNlIGNvbnRyb2wuIAogICAqIGNvbm5lY3QuY29yZS5hY3RpdmF0ZUNoYW5uZWxXaXRoVmlld1R5cGUoKSAtPiAgdGhpcyBpcyBjdXJlbnRseSBwcm9ncmFtbWVkIHRvIGdldCBlaXRoZXIgdGhlIG51bWJlciBwYWQgb3IgcXVpY2sgY29ubmVjdHMgaW50byB2aWV3LgogICAqLwogIGNvbm5lY3QuY29yZS5hY3RpdmF0ZUNoYW5uZWxXaXRoVmlld1R5cGUgPSBmdW5jdGlvbiAodmlld1R5cGUsIG1lZGlhVHlwZSkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5UYXNrTGlzdEV2ZW50cy5BQ1RJVkFURV9DSEFOTkVMX1dJVEhfVklFV19UWVBFLAogICAgICBkYXRhOiB7CiAgICAgICAgdmlld1R5cGU6IHZpZXdUeXBlLAogICAgICAgIG1lZGlhVHlwZTogbWVkaWFUeXBlIAogICAgICB9CiAgICB9KTsKICB9OwoKIAogIC8qKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCiAKICAvKioKICAqIFRoaXMgd2lsbCBiZSBoZWxwZnVsIGZvciB0aGUgY3VzdG9tIGFuZCBlbWJlZGRlZCBDQ1BzIAogICogdG8gaGFuZGxlIHRoZSBhY2Nlc3MgZGVuaWVkIHVzZSBjYXNlLiAKICAqLwogIGNvbm5lY3QuY29yZS5vbkFjY2Vzc0RlbmllZCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDQ0VTU19ERU5JRUQsIGYpOwogIH07CiAKICAvKioKICAqIFRoaXMgd2lsbCBiZSBoZWxwZnVsIGZvciBTQU1MIHVzZSBjYXNlcyB0byBoYW5kbGUgdGhlIGN1c3RvbSBsb2dpbnMuIAogICovCiAgY29ubmVjdC5jb3JlLm9uQXV0aEZhaWwgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BVVRIX0ZBSUwsIGYpOwogIH07CiAKICAvKiogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwogCiAgLyoqCiAgICogVXNlZCBmb3IgaGFuZGxpbmcgdGhlIHJ0YyBzZXNzaW9uIHN0YXRzLgogICAqIFVzYWdlCiAgICogY29ubmVjdC5jb3JlLm9uU29mdHBob25lU2Vzc2lvbkluaXQoZnVuY3Rpb24oeyBjb25uZWN0aW9uSWQgfSkgewogICAqICAgICB2YXIgc29mdHBob25lTWFuYWdlciA9IGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVNYW5hZ2VyKCk7CiAgICogICAgIGlmKHNvZnRwaG9uZU1hbmFnZXIpewogICAqICAgICAgICAvLyBhY2Nlc3Mgc2Vzc2lvbgogICAqICAgICAgICB2YXIgc2Vzc2lvbiA9IHNvZnRwaG9uZU1hbmFnZXIuZ2V0U2Vzc2lvbihjb25uZWN0aW9uSWQpOyAKICAgKiAgICAgIH0KICAgKiB9KTsKICAgKi8KIAogIGNvbm5lY3QuY29yZS5vblNvZnRwaG9uZVNlc3Npb25Jbml0ID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlNFU1NJT05fSU5JVCwgZik7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUub25Db25maWd1cmUgPSBmdW5jdGlvbihmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5DT05GSUdVUkUsIGYpOwogIH0KCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICAgY29ubmVjdC5jb3JlLm9uSW5pdGlhbGl6ZWQgPSBmdW5jdGlvbihmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLklOSVQsIGYpOwogIH0KCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgY29udGFjdElkKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY29udGFjdElkLCAnY29udGFjdElkJyk7CiAgICBpZiAoIWNvbm5lY3QuY29udGFpbnMoY29ubmVjdC52YWx1ZXMoY29ubmVjdC5Db250YWN0RXZlbnRzKSwgZXZlbnROYW1lKSkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5WYWx1ZUVycm9yKCclcyBpcyBub3QgYSB2YWxpZCBjb250YWN0IGV2ZW50LicsIGV2ZW50TmFtZSk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5zcHJpbnRmKCclczo6JXMnLCBldmVudE5hbWUsIGNvbnRhY3RJZCk7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmV2ZW50QnVzOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldFdlYlNvY2tldE1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLndlYlNvY2tldFByb3ZpZGVyOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlcjsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRMb2NhbFRpbWVzdGFtcCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBZ2VudERhdGEoKS5zbmFwc2hvdC5sb2NhbFRpbWVzdGFtcDsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRTa2V3ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFnZW50RGF0YSgpLnNuYXBzaG90LnNrZXc7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRSb3V0aW5nRXZlbnRHcmFwaCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuYWdlbnRSb3V0aW5nRXZlbnRHcmFwaDsKICB9OwogIGNvbm5lY3QuY29yZS5hZ2VudFJvdXRpbmdFdmVudEdyYXBoID0gbmV3IGNvbm5lY3QuRXZlbnRHcmFwaCgpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwgY29ubmVjdC5BZ2VudFN0YXRlVHlwZS5ST1VUQUJMRSwKICAgICAgY29ubmVjdC5BZ2VudEV2ZW50cy5ST1VUQUJMRSkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLCBjb25uZWN0LkFnZW50U3RhdGVUeXBlLk5PVF9ST1VUQUJMRSwKICAgICAgY29ubmVjdC5BZ2VudEV2ZW50cy5OT1RfUk9VVEFCTEUpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwgY29ubmVjdC5BZ2VudFN0YXRlVHlwZS5PRkZMSU5FLAogICAgICBjb25uZWN0LkFnZW50RXZlbnRzLk9GRkxJTkUpOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRBZ2VudFN0YXRlRXZlbnRHcmFwaCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuYWdlbnRTdGF0ZUV2ZW50R3JhcGg7CiAgfTsKICBjb25uZWN0LmNvcmUuYWdlbnRTdGF0ZUV2ZW50R3JhcGggPSBuZXcgY29ubmVjdC5FdmVudEdyYXBoKCkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LnZhbHVlcyhjb25uZWN0LkFnZW50RXJyb3JTdGF0ZXMpLAogICAgICBjb25uZWN0LkFnZW50RXZlbnRzLkVSUk9SKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksIGNvbm5lY3QuQWdlbnRBdmFpbFN0YXRlcy5BRlRFUl9DQUxMX1dPUkssCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuQUNXKTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50R3JhcGggPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmNvbnRhY3RFdmVudEdyYXBoOwogIH07CiAKICBjb25uZWN0LmNvcmUuY29udGFjdEV2ZW50R3JhcGggPSBuZXcgY29ubmVjdC5FdmVudEdyYXBoKCkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuSU5DT01JTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5JTkNPTUlORykKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuUEVORElORywKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLlBFTkRJTkcpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkNPTk5FQ1RJTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5DT05ORUNUSU5HKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5DT05ORUNURUQsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5DT05ORUNURUQpCiAgICAuYXNzb2MoY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkNPTk5FQ1RJTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5FUlJPUiwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLk1JU1NFRCkKICAgIC5hc3NvYyhjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuSU5DT01JTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5FUlJPUiwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLk1JU1NFRCkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuRU5ERUQsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5BQ1cpCiAgICAuYXNzb2MoY29ubmVjdC52YWx1ZXMoY29ubmVjdC5DT05UQUNUX0FDVElWRV9TVEFURVMpLAogICAgICBjb25uZWN0LnZhbHVlcyhjb25uZWN0LnJlbGF0aXZlQ29tcGxlbWVudChjb25uZWN0LkNPTlRBQ1RfQUNUSVZFX1NUQVRFUywgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlKSksCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5FTkRFRCkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LnZhbHVlcyhjb25uZWN0LkFnZW50RXJyb3JTdGF0ZXMpLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuRVJST1IpCiAgICAuYXNzb2MoY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkNPTk5FQ1RJTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5NSVNTRUQsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldENsaWVudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLmNsaWVudCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdUaGUgY29ubmVjdCBjb3JlIGhhcyBub3QgYmVlbiBpbml0aWFsaXplZCEnKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmNvcmUuY2xpZW50OwogIH07CiAgY29ubmVjdC5jb3JlLmNsaWVudCA9IG51bGw7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRBcHBDbGllbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS5hZ2VudEFwcENsaWVudCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdUaGUgY29ubmVjdCBBZ2VudEFwcCBDbGllbnQgaGFzIG5vdCBiZWVuIGluaXRpYWxpemVkIScpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5hZ2VudEFwcENsaWVudDsKICB9OwogIGNvbm5lY3QuY29yZS5hZ2VudEFwcENsaWVudCA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldE1hc3RlckNsaWVudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdUaGUgY29ubmVjdCBtYXN0ZXIgY2xpZW50IGhhcyBub3QgYmVlbiBpbml0aWFsaXplZCEnKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50OwogIH07CiAgY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZU1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXI7CiAgfTsKICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldE5vdGlmaWNhdGlvbk1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS5ub3RpZmljYXRpb25NYW5hZ2VyKSB7CiAgICAgIGNvbm5lY3QuY29yZS5ub3RpZmljYXRpb25NYW5hZ2VyID0gbmV3IGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlcigpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5ub3RpZmljYXRpb25NYW5hZ2VyOwogIH07CiAgY29ubmVjdC5jb3JlLm5vdGlmaWNhdGlvbk1hbmFnZXIgPSBudWxsOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRQb3B1cE1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLnBvcHVwTWFuYWdlcjsKICB9OwogIGNvbm5lY3QuY29yZS5wb3B1cE1hbmFnZXIgPSBuZXcgY29ubmVjdC5Qb3B1cE1hbmFnZXIoKTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0gPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS51cHN0cmVhbSkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdUaGVyZSBpcyBubyB1cHN0cmVhbSBjb25kdWl0IScpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS51cHN0cmVhbTsKICB9OwogIGNvbm5lY3QuY29yZS51cHN0cmVhbSA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLkFnZW50RGF0YVByb3ZpZGVyID0gQWdlbnREYXRhUHJvdmlkZXI7CiAKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICB2YXIgUmluZ3RvbmVFbmdpbmVCYXNlID0gZnVuY3Rpb24gKHJpbmd0b25lQ29uZmlnKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0aGlzLl9wcmV2Q29udGFjdElkID0gbnVsbDsKCiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmluZ3RvbmVDb25maWcsICJyaW5ndG9uZUNvbmZpZyIpOwogICAgaWYgKCFyaW5ndG9uZUNvbmZpZy5yaW5ndG9uZVVybCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoInJpbmd0b25lVXJsIGlzIHJlcXVpcmVkISIpOwogICAgfQoKICAgIGlmIChnbG9iYWwuQXVkaW8gJiYgdHlwZW9mIGdsb2JhbC5Qcm9taXNlICE9PSAidW5kZWZpbmVkIikgewogICAgICB0aGlzLl9wbGF5YWJsZUF1ZGlvUHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBzZWxmLl9hdWRpbyA9IG5ldyBBdWRpbyhyaW5ndG9uZUNvbmZpZy5yaW5ndG9uZVVybCk7CiAgICAgICAgc2VsZi5fYXVkaW8ubG9vcCA9IHRydWU7CiAgICAgICAgc2VsZi5fYXVkaW8uYWRkRXZlbnRMaXN0ZW5lcigiY2FucGxheSIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHNlbGYuX2F1ZGlvUGxheWFibGUgPSB0cnVlOwogICAgICAgICAgcmVzb2x2ZShzZWxmLl9hdWRpbyk7CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2F1ZGlvID0gbnVsbDsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiVW5hYmxlIHRvIHByb3ZpZGUgYSByaW5ndG9uZS4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQoKICAgIHNlbGYuX2RyaXZlUmluZ3RvbmUoKTsKICB9OwoKICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLl9kcml2ZVJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJOb3QgaW1wbGVtZW50ZWQuIik7CiAgfTsKCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5fc3RhcnRSaW5ndG9uZSA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICBpZiAodGhpcy5fYXVkaW8pIHsKICAgICAgdGhpcy5fYXVkaW8ucGxheSgpCiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIHRoaXMuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiUmluZ3RvbmUgUGxheWJhY2sgRmFpbHVyZSIsIGNvbnRhY3QpOwogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiUmluZ3RvbmUgUGxheWJhY2sgRmFpbHVyZSIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfSk7CiAgICAgIHRoaXMuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiUmluZ3RvbmUgU3RhcnQiLCBjb250YWN0KTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJSaW5ndG9uZSBTdGFydCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5fc3RvcFJpbmd0b25lID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIGlmICh0aGlzLl9hdWRpbykgewogICAgICB0aGlzLl9hdWRpby5wYXVzZSgpOwogICAgICB0aGlzLl9hdWRpby5jdXJyZW50VGltZSA9IDA7CiAgICAgIHRoaXMuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiUmluZ3RvbmUgU3RvcCIsIGNvbnRhY3QpOwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlJpbmd0b25lIFN0b3AiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH07CgogIC8qKgogICAqIFN0b3AgcmluZ3RvbmUuCiAgICovCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5zdG9wUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLl9zdG9wUmluZ3RvbmUoKTsKICB9OwoKICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLl9yaW5ndG9uZVNldHVwID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuUklOR1RPTkUsIGZ1bmN0aW9uICgpIHsKICAgICAgc2VsZi5fc3RhcnRSaW5ndG9uZShjb250YWN0KTsKICAgICAgc2VsZi5fcHJldkNvbnRhY3RJZCA9IGNvbnRhY3QuZ2V0Q29udGFjdElkKCk7CgogICAgICBjb250YWN0Lm9uQ29ubmVjdGVkKGxpbHkuaGl0Y2goc2VsZiwgc2VsZi5fc3RvcFJpbmd0b25lKSk7CiAgICAgIGNvbnRhY3Qub25BY2NlcHRlZChsaWx5LmhpdGNoKHNlbGYsIHNlbGYuX3N0b3BSaW5ndG9uZSkpOwogICAgICBjb250YWN0Lm9uRW5kZWQobGlseS5oaXRjaChzZWxmLCBzZWxmLl9zdG9wUmluZ3RvbmUpKTsKICAgICAgLy8gSnVzdCB0byBtYWtlIHN1cmUgdG8gc3RvcCB0aGUgcmluZ3RvbmUgaW4gY2FzZSBvZiB0aGUgZmFpbHVyZXMgb2Ygc3BlY2lmaWMgY2FsbGJhY2tzKG9uQWNjZXB0ZWQsb25Db25uZWN0ZWQpOwogICAgICBjb250YWN0Lm9uUmVmcmVzaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgIGlmIChjb250YWN0LmdldFN0YXR1cygpLnR5cGUgIT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuQ09OTkVDVElORyAmJgogICAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlICE9PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLklOQ09NSU5HKSB7CiAgICAgICAgICBzZWxmLl9zdG9wUmluZ3RvbmUoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5fcHVibGlzaFRlbGVtZXRyeUV2ZW50ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgY29udGFjdCkgewogICAgaWYgKGNvbnRhY3QgJiYgY29udGFjdC5nZXRDb250YWN0SWQoKSkgewogICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgIG5hbWU6IGV2ZW50TmFtZSwKICAgICAgICBjb250YWN0SWQ6IGNvbnRhY3QuZ2V0Q29udGFjdElkKCkKICAgICAgfSk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQ2hhbmdlIHRoZSBhdWRpbyBkZXZpY2UgdXNlZCB0byBwbGF5IHJpbmd0b25lLgogICAqIElmIGF1ZGlvIGVsZW1lbnQgaXMgbm90IGZ1bGx5IGluaXRpYWxpemVkLCB0aGUgQVBJIHdpbGwgd2FpdCBfYXVkaW9QbGF5YWJsZVByb21pc2UgZm9yIDMgc2Vjb25kcyBhbmQgZmFpbCBvbiB0aW1lb3V0LgogICAqIFRoaXMgQVBJIGlzIHN1cHBvcnRlZCBvbmx5IGJ5IGJyb3dzZXJzIHRoYXQgaW1wbGVtZW50ZWQgRVM2IFByb21pc2UgYW5kIGh0dHA6Ly93d3cudzMub3JnL1RSL2F1ZGlvLW91dHB1dC8KICAgKiBSZXR1cm4gYSBQcm9taXNlIHRoYXQgaW5kaWNhdGVzIHRoZSByZXN1bHQgb2YgY2hhbmdpbmcgb3V0cHV0IGRldmljZS4KICAgKi8KICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLnNldE91dHB1dERldmljZSA9IGZ1bmN0aW9uIChkZXZpY2VJZCkgewogICAgaWYgKHRoaXMuX3BsYXlhYmxlQXVkaW9Qcm9taXNlKSB7CiAgICAgIHZhciBwbGF5YWJsZUF1ZGlvV2l0aFRpbWVvdXQgPSBQcm9taXNlLnJhY2UoWwogICAgICAgIHRoaXMuX3BsYXlhYmxlQXVkaW9Qcm9taXNlLAogICAgICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgcmVqZWN0KCJUaW1lZCBvdXQgd2FpdGluZyBmb3IgcGxheWFibGUgYXVkaW8iKTsgfSwgMzAwMC8qbXMqLyk7CiAgICAgICAgfSkKICAgICAgXSk7CiAgICAgIHJldHVybiBwbGF5YWJsZUF1ZGlvV2l0aFRpbWVvdXQudGhlbihmdW5jdGlvbiAoYXVkaW8pIHsKICAgICAgICBpZiAoYXVkaW8pIHsKICAgICAgICAgIGlmIChhdWRpby5zZXRTaW5rSWQpIHsKICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShhdWRpby5zZXRTaW5rSWQoZGV2aWNlSWQpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgiTm90IHN1cHBvcnRlZCIpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoIk5vIGF1ZGlvIGZvdW5kIik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBpZiAoZ2xvYmFsLlByb21pc2UpIHsKICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJOb3QgZWxpZ2libGUgcmluZ3RvbmUgb3duZXIiKTsKICAgIH0KICB9OwoKICB2YXIgVm9pY2VSaW5ndG9uZUVuZ2luZSA9IGZ1bmN0aW9uIChyaW5ndG9uZUNvbmZpZykgewogICAgUmluZ3RvbmVFbmdpbmVCYXNlLmNhbGwodGhpcywgcmluZ3RvbmVDb25maWcpOwogIH07CiAgVm9pY2VSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUpOwogIFZvaWNlUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVm9pY2VSaW5ndG9uZUVuZ2luZTsKCiAgVm9pY2VSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdmFyIG9uQ29udGFjdENvbm5lY3QgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBpZiAoY29udGFjdC5nZXRUeXBlKCkgPT09IGxpbHkuQ29udGFjdFR5cGUuVk9JQ0UgJiYKICAgICAgICBjb250YWN0LmlzU29mdHBob25lQ2FsbCgpICYmIGNvbnRhY3QuaXNJbmJvdW5kKCkpIHsKICAgICAgICBzZWxmLl9yaW5ndG9uZVNldHVwKGNvbnRhY3QpOwogICAgICAgIHNlbGYuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiUmluZ3RvbmUgQ29ubmVjdGluZyIsIGNvbnRhY3QpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiUmluZ3RvbmUgQ29ubmVjdGluZyIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH07CgogICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGNvbnRhY3Qub25Db25uZWN0aW5nKG9uQ29udGFjdENvbm5lY3QpOwogICAgfSk7CgogICAgbmV3IGNvbm5lY3QuQWdlbnQoKS5nZXRDb250YWN0cygpLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgaWYgKGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5DT05ORUNUSU5HKSB7CiAgICAgICAgb25Db250YWN0Q29ubmVjdChjb250YWN0KTsKICAgICAgfQogICAgfSk7CiAgfTsKCgogIHZhciBDaGF0UmluZ3RvbmVFbmdpbmUgPSBmdW5jdGlvbiAocmluZ3RvbmVDb25maWcpIHsKICAgIFJpbmd0b25lRW5naW5lQmFzZS5jYWxsKHRoaXMsIHJpbmd0b25lQ29uZmlnKTsKICB9OwogIENoYXRSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUpOwogIENoYXRSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBDaGF0UmluZ3RvbmVFbmdpbmU7CgogIENoYXRSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdmFyIG9uQ29udGFjdENvbm5lY3QgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBpZiAoY29udGFjdC5nZXRUeXBlKCkgPT09IGxpbHkuQ29udGFjdFR5cGUuQ0hBVCAmJiBjb250YWN0LmlzSW5ib3VuZCgpKSB7CiAgICAgICAgc2VsZi5fcmluZ3RvbmVTZXR1cChjb250YWN0KTsKICAgICAgICBzZWxmLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgUmluZ3RvbmUgQ29ubmVjdGluZyIsIGNvbnRhY3QpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQ2hhdCBSaW5ndG9uZSBDb25uZWN0aW5nIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfTsKCiAgICBjb25uZWN0LmNvbnRhY3QoZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgY29udGFjdC5vbkNvbm5lY3Rpbmcob25Db250YWN0Q29ubmVjdCk7CiAgICB9KTsKICB9OwoKICB2YXIgVGFza1Jpbmd0b25lRW5naW5lID0gZnVuY3Rpb24gKHJpbmd0b25lQ29uZmlnKSB7CiAgICBSaW5ndG9uZUVuZ2luZUJhc2UuY2FsbCh0aGlzLCByaW5ndG9uZUNvbmZpZyk7CiAgfTsKICBUYXNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlKTsKICBUYXNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVGFza1Jpbmd0b25lRW5naW5lOwoKICBUYXNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLl9kcml2ZVJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHZhciBvbkNvbnRhY3RDb25uZWN0ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgaWYgKGNvbnRhY3QuZ2V0VHlwZSgpID09PSBsaWx5LkNvbnRhY3RUeXBlLlRBU0sgJiYgY29udGFjdC5pc0luYm91bmQoKSkgewogICAgICAgIHNlbGYuX3Jpbmd0b25lU2V0dXAoY29udGFjdCk7CiAgICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJUYXNrIFJpbmd0b25lIENvbm5lY3RpbmciLCBjb250YWN0KTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlRhc2sgUmluZ3RvbmUgQ29ubmVjdGluZyIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH07CgogICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGNvbnRhY3Qub25Db25uZWN0aW5nKG9uQ29udGFjdENvbm5lY3QpOwogICAgfSk7CiAgfTsKCgogIHZhciBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUgPSBmdW5jdGlvbiAocmluZ3RvbmVDb25maWcpIHsKICAgIFJpbmd0b25lRW5naW5lQmFzZS5jYWxsKHRoaXMsIHJpbmd0b25lQ29uZmlnKTsKICB9OwogIFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUpOwogIFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmU7CgogIFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGNvbnRhY3Qub25JbmNvbWluZyhmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKGNvbnRhY3QuZ2V0VHlwZSgpID09PSBsaWx5LkNvbnRhY3RUeXBlLlFVRVVFX0NBTExCQUNLKSB7CiAgICAgICAgICBzZWxmLl9yaW5ndG9uZVNldHVwKGNvbnRhY3QpOwogICAgICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDYWxsYmFjayBSaW5ndG9uZSBDb25uZWN0aW5nIiwgY29udGFjdCk7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkNhbGxiYWNrIFJpbmd0b25lIENvbm5lY3RpbmciKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICAvKiBleHBvcnQgY29ubmVjdC5SaW5ndG9uZUVuZ2luZSAqLwogIGNvbm5lY3QuVm9pY2VSaW5ndG9uZUVuZ2luZSA9IFZvaWNlUmluZ3RvbmVFbmdpbmU7CiAgY29ubmVjdC5DaGF0UmluZ3RvbmVFbmdpbmUgPSBDaGF0UmluZ3RvbmVFbmdpbmU7CiAgY29ubmVjdC5UYXNrUmluZ3RvbmVFbmdpbmUgPSBUYXNrUmluZ3RvbmVFbmdpbmU7CiAgY29ubmVjdC5RdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUgPSBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmU7Cn0pKCk7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwogIGdsb2JhbC5jY3BWZXJzaW9uID0gIlYyIjsKCiAgdmFyIFJUUEpvYkludGVydmFsTXMgPSAxMDAwOwogIHZhciBzdGF0c1JlcG9ydGluZ0pvYkludGVydmFsTXMgPSAzMDAwMDsKICB2YXIgc3RyZWFtQnVmZmVyU2l6ZSA9IDUwMDsKICB2YXIgQ2FsbFR5cGVNYXAgPSB7fTsKICBDYWxsVHlwZU1hcFtjb25uZWN0LlNvZnRwaG9uZUNhbGxUeXBlLkFVRElPX09OTFldID0gJ0F1ZGlvJzsKICBDYWxsVHlwZU1hcFtjb25uZWN0LlNvZnRwaG9uZUNhbGxUeXBlLlZJREVPX09OTFldID0gJ1ZpZGVvJzsKICBDYWxsVHlwZU1hcFtjb25uZWN0LlNvZnRwaG9uZUNhbGxUeXBlLkFVRElPX1ZJREVPXSA9ICdBdWRpb1ZpZGVvJzsKICBDYWxsVHlwZU1hcFtjb25uZWN0LlNvZnRwaG9uZUNhbGxUeXBlLk5PTkVdID0gJ05vbmUnOwogIHZhciBBVURJT19JTlBVVCA9ICdhdWRpb19pbnB1dCc7CiAgdmFyIEFVRElPX09VVFBVVCA9ICdhdWRpb19vdXRwdXQnOwoKICB2YXIgTWVkaWFUeXBlTWFwID0ge307CiAgTWVkaWFUeXBlTWFwW2Nvbm5lY3QuQ29udGFjdFR5cGUuVk9JQ0VdID0gIlZvaWNlIjsKICB2YXIgVU5LTk9XTl9NRURJQV9UWVBFID0gIlVua25vd24iOwoKICB2YXIgdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyID0gW107CiAgdmFyIGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cyA9IHt9OwogIHZhciBhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cyA9IHt9OwogIHZhciBydHBTdGF0c0pvYiA9IG51bGw7CiAgdmFyIHJlcG9ydFN0YXRzSm9iID0gbnVsbDsKICAvL0xvZ2dlciBzcGVjaWZpYyB0byBzb2Z0cGhvbmUuCiAgdmFyIGxvZ2dlciA9IG51bGw7CiAgdmFyIFNvZnRwaG9uZUVycm9yVHlwZXMgPSBjb25uZWN0LlNvZnRwaG9uZUVycm9yVHlwZXM7CiAgdmFyIEhBTkdfVVBfTVVMVElQTEVfU0VTU0lPTlNfRVZFTlQgPSAiTXVsdGlTZXNzaW9uSGFuZ1VwIjsKICB2YXIgTVVMVElQTEVfU0VTU0lPTlNfRVZFTlQgPSAiTXVsdGlTZXNzaW9ucyI7CgogIHZhciBsb2NhbE1lZGlhU3RyZWFtID0ge307CgogIHZhciBzb2Z0cGhvbmVDbGllbnRJZCA9IGNvbm5lY3QucmFuZG9tSWQoKTsKCiAgdmFyIHJlcXVlc3RJY2VBY2Nlc3MgPSBmdW5jdGlvbiAodHJhbnNwb3J0KSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCkuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX1RSQU5TUE9SVCwgdHJhbnNwb3J0LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIHJlc29sdmUoZGF0YS5zb2Z0cGhvbmVUcmFuc3BvcnQuc29mdHBob25lTWVkaWFDb25uZWN0aW9ucyk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICBpZiAocmVhc29uLm1lc3NhZ2UgJiYgcmVhc29uLm1lc3NhZ2UuaW5jbHVkZXMoIlNvZnRwaG9uZUNvbm5lY3Rpb25MaW1pdEJyZWFjaGVkRXhjZXB0aW9uIikpIHsKICAgICAgICAgICAgcHVibGlzaEVycm9yKCJtdWx0aXBsZV9zb2Z0cGhvbmVfYWN0aXZlX3Nlc3Npb25zIiwgIk51bWJlciBvZiBhY3RpdmUgc2Vzc2lvbnMgYXJlIG1vcmUgdGhlbiBhbGxvd2VkIGxpbWl0LiIsICIiKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlamVjdChFcnJvcigicmVxdWVzdEljZUFjY2VzcyBmYWlsZWQiKSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmVqZWN0KEVycm9yKCJBdXRoZW50aWNhdGlvbiBmYWlsZWQgd2hpbGUgcmVxdWVzdEljZUFjY2VzcyIpKTsKICAgICAgICB9LAogICAgICAgIGFjY2Vzc0RlbmllZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmVqZWN0KEVycm9yKCJBY2Nlc3MgRGVuaWVkIHdoaWxlIHJlcXVlc3RJY2VBY2Nlc3MiKSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH07CgogIHZhciBTb2Z0cGhvbmVNYW5hZ2VyID0gZnVuY3Rpb24gKHNvZnRwaG9uZVBhcmFtcykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgbG9nZ2VyID0gbmV3IFNvZnRwaG9uZUxvZ2dlcihjb25uZWN0LmdldExvZygpKTsKICAgIGxvZ2dlci5pbmZvKCJbU29mdHBob25lIE1hbmFnZXJdIHNvZnRwaG9uZSBtYW5hZ2VyIGluaXRpYWxpemF0aW9uIGhhcyBiZWd1biIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB2YXIgcnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5OwogICAgaWYgKGNvbm5lY3QuUnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5KSB7CiAgICAgIHJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeSA9IG5ldyBjb25uZWN0LlJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeShsb2dnZXIsCiAgICAgICAgY29ubmVjdC5jb3JlLmdldFdlYlNvY2tldE1hbmFnZXIoKSwKICAgICAgICBzb2Z0cGhvbmVDbGllbnRJZCwKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHJlcXVlc3RJY2VBY2Nlc3MsIHsKICAgICAgICAgIHRyYW5zcG9ydFR5cGU6ICJzb2Z0cGhvbmUiLAogICAgICAgICAgc29mdHBob25lQ2xpZW50SWQ6IHNvZnRwaG9uZUNsaWVudElkCiAgICAgICAgfSksCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBwdWJsaXNoRXJyb3IpKTsKICAgIH0KICAgIGlmICghaXNCcm93c2VyU29mdFBob25lU3VwcG9ydGVkKCkpIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuVU5TVVBQT1JURURfQlJPV1NFUiwKICAgICAgICAiQ29ubmVjdCBkb2VzIG5vdCBzdXBwb3J0IHRoaXMgYnJvd3Nlci4gU29tZSBmdW5jdGlvbmFsaXR5IG1heSBub3Qgd29yay4gIiwKICAgICAgICAiIik7CiAgICB9CiAgICB2YXIgZ3VtUHJvbWlzZSA9IGZldGNoVXNlck1lZGlhKHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKHN0cmVhbSkgewogICAgICAgIGNvbm5lY3QuY29yZS5zZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0oc3RyZWFtKTsKICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgIHB1Ymxpc2hFcnJvcihlcnIsICJZb3VyIG1pY3JvcGhvbmUgaXMgbm90IGVuYWJsZWQgaW4geW91ciBicm93c2VyLiAiLCAiIik7CiAgICAgIH0KICAgIH0pOwogICAgaGFuZGxlU29mdFBob25lTXV0ZVRvZ2dsZSgpOwogICAgaGFuZGxlU3BlYWtlckRldmljZUNoYW5nZSgpOwogICAgaGFuZGxlTWljcm9waG9uZURldmljZUNoYW5nZSgpOwoKICAgIHRoaXMucmluZ3RvbmVFbmdpbmUgPSBudWxsOwogICAgdmFyIHJ0Y1Nlc3Npb25zID0ge307CiAgICAvLyBUcmFja3MgdGhlIGFnZW50IGNvbm5lY3Rpb24gSUQsIHNvIHRoYXQgaWYgdGhlIHNhbWUgY29udGFjdCBnZXRzIHJlLXJvdXRlZCB0byB0aGUgc2FtZSBhZ2VudCwgaXQnbGwgc3RpbGwgc2V0IHVwIHNvZnRwaG9uZQogICAgdmFyIGNhbGxzRGV0ZWN0ZWQgPSB7fTsKICAgIHRoaXMub25Jbml0Q29udGFjdFN1YiA9IHt9OwogICAgdGhpcy5vbkluaXRDb250YWN0U3ViLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24oKSB7fTsKCiAgICAvLyB2YXJpYWJsZXMgZm9yIGZpcmVmb3ggbXVsdGl0YWIKICAgIHZhciBpc1Nlc3Npb25QZW5kaW5nID0gZmFsc2U7CiAgICB2YXIgcGVuZGluZ0NvbnRhY3QgPSBudWxsOwogICAgdmFyIHBlbmRpbmdBZ2VudENvbm5lY3Rpb25JZCA9IG51bGw7CiAgICB2YXIgcG9zdHBvbmVTdGFydGluZ1Nlc3Npb24gPSBmdW5jdGlvbiAoY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpIHsKICAgICAgaXNTZXNzaW9uUGVuZGluZyA9IHRydWU7CiAgICAgIHBlbmRpbmdDb250YWN0ID0gY29udGFjdDsKICAgICAgcGVuZGluZ0FnZW50Q29ubmVjdGlvbklkID0gYWdlbnRDb25uZWN0aW9uSWQ7CiAgICB9CiAgICB2YXIgY2FuY2VsUGVuZGluZ1Nlc3Npb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlzU2Vzc2lvblBlbmRpbmcgPSBmYWxzZTsKICAgICAgcGVuZGluZ0NvbnRhY3QgPSBudWxsOwogICAgICBwZW5kaW5nQWdlbnRDb25uZWN0aW9uSWQgPSBudWxsOwogICAgfQoKICAgIC8vIGhlbHBlciBtZXRob2QgdG8gcHJvdmlkZSBhY2Nlc3MgdG8gcnRjIHNlc3Npb25zCiAgICB0aGlzLmdldFNlc3Npb24gPSBmdW5jdGlvbiAoY29ubmVjdGlvbklkKSB7CiAgICAgIHJldHVybiBydGNTZXNzaW9uc1tjb25uZWN0aW9uSWRdOwogICAgfQoKICAgIHRoaXMucmVwbGFjZUxvY2FsTWVkaWFUcmFjayA9IGZ1bmN0aW9uKGNvbm5lY3Rpb25JZCwgdHJhY2spIHsKICAgICAgdmFyIHN0cmVhbSA9IGxvY2FsTWVkaWFTdHJlYW1bY29ubmVjdGlvbklkXS5zdHJlYW07CiAgICAgIGlmKHN0cmVhbSl7CiAgICAgICAgdmFyIG9sZFRyYWNrID0gc3RyZWFtLmdldEF1ZGlvVHJhY2tzKClbMF07CiAgICAgICAgdHJhY2suZW5hYmxlZCA9IG9sZFRyYWNrLmVuYWJsZWQ7CiAgICAgICAgb2xkVHJhY2suZW5hYmxlZCA9IGZhbHNlOwogICAgICAgIHN0cmVhbS5yZW1vdmVUcmFjayhvbGRUcmFjayk7CiAgICAgICAgc3RyZWFtLmFkZFRyYWNrKHRyYWNrKTsKICAgICAgfQogICAgfTsKCiAgICB2YXIgaXNDb250YWN0VGVybWluYXRlZCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIHJldHVybiBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuRU5ERUQgfHwKICAgICAgICBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuRVJST1IgfHwKICAgICAgICBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuTUlTU0VEOwogICAgfTsKCiAgICB2YXIgZGVzdHJveVNlc3Npb24gPSBmdW5jdGlvbiAoYWdlbnRDb25uZWN0aW9uSWQpIHsKICAgICAgaWYgKHJ0Y1Nlc3Npb25zLmhhc093blByb3BlcnR5KGFnZW50Q29ubmVjdGlvbklkKSkgewogICAgICAgIHZhciBzZXNzaW9uID0gcnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgIC8vIEN1cnJlbnRseSB0aGUgYXNzdW1wdGlvbiBpcyBpdCB3aWxsIHRocm93IGFuIGV4Y2VwdGlvbiBvbmx5IGFuZCBpZiBvbmx5IGl0IGFscmVhZHkgaGFzIGJlZW4gaHVuZyB1cC4KICAgICAgICAvLyBUT0RPOiBVcGRhdGUgb25jZSB0aGUgaGFuZ3VwIEFQSSBkb2VzIG5vdCB0aHJvdyBleGNlcHRpb25zCiAgICAgICAgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgZGVsZXRlIHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICAgIGRlbGV0ZSBjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICAgIHNlc3Npb24uaGFuZ3VwKCk7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgICAgbGlseS5nZXRMb2coKS53YXJuKCJDbGVhbiB1cCB0aGUgc2Vzc2lvbiBsb2NhbGx5ICIgKyBhZ2VudENvbm5lY3Rpb25JZCwgZXJyLm1lc3NhZ2UpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CgogICAgLy8gV2hlbiBtdWx0aXBsZSBSVEMgc2Vzc2lvbnMgZGV0ZWN0ZWQsIGlnbm9yZSB0aGUgbmV3IGNhbGwgYW5kIGhhbmcgdXAgdGhlIHByZXZpb3VzIHNlc3Npb25zLgogICAgLy8gVE9ETzogVXBkYXRlIHdoZW4gY29ubmVjdC1ydGMgZXhwb3NlcyBhbiBBUEkgdG8gZGV0ZWN0IHNlc3Npb24gc3RhdHVzLgogICAgdmFyIHNhbml0eUNoZWNrQWN0aXZlU2Vzc2lvbnMgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbnMpIHsKICAgICAgaWYgKE9iamVjdC5rZXlzKHJ0Y1Nlc3Npb25zKS5sZW5ndGggPiAwKSB7CiAgICAgICAgLy8gRXJyb3IhIG91ciBzdGF0ZSBkb2Vzbid0IG1hdGNoLCB0ZWFyIGl0IGFsbCBkb3duLgogICAgICAgIGZvciAodmFyIGNvbm5lY3Rpb25JZCBpbiBydGNTZXNzaW9ucykgewogICAgICAgICAgaWYgKHJ0Y1Nlc3Npb25zLmhhc093blByb3BlcnR5KGNvbm5lY3Rpb25JZCkpIHsKICAgICAgICAgICAgLy8gTG9nIGFuIGVycm9yIGZvciB0aGUgc2Vzc2lvbiB3ZSBhcmUgYWJvdXQgdG8gZW5kLgogICAgICAgICAgICBwdWJsaXNoTXVsdGlwbGVTZXNzaW9uc0V2ZW50KEhBTkdfVVBfTVVMVElQTEVfU0VTU0lPTlNfRVZFTlQsIHJ0Y1Nlc3Npb25zW2Nvbm5lY3Rpb25JZF0uY2FsbElkLCBjb25uZWN0aW9uSWQpOwogICAgICAgICAgICBkZXN0cm95U2Vzc2lvbihjb25uZWN0aW9uSWQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImR1cGxpY2F0ZSBzZXNzaW9uIGRldGVjdGVkLCByZWZ1c2luZyB0byBzZXR1cCBuZXcgY29ubmVjdGlvbiIpOwogICAgICB9CiAgICB9OwoKICAgIHRoaXMuc3RhcnRTZXNzaW9uID0gZnVuY3Rpb24gKF9jb250YWN0LCBfYWdlbnRDb25uZWN0aW9uSWQpIHsKICAgICAgdmFyIGNvbnRhY3QgPSBpc1Nlc3Npb25QZW5kaW5nID8gcGVuZGluZ0NvbnRhY3QgOiBfY29udGFjdDsKICAgICAgdmFyIGFnZW50Q29ubmVjdGlvbklkID0gaXNTZXNzaW9uUGVuZGluZyA/IHBlbmRpbmdBZ2VudENvbm5lY3Rpb25JZCA6IF9hZ2VudENvbm5lY3Rpb25JZDsKICAgICAgaWYgKCFjb250YWN0IHx8ICFhZ2VudENvbm5lY3Rpb25JZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjYW5jZWxQZW5kaW5nU2Vzc2lvbigpOwogICAgICAKICAgICAgLy8gU2V0IHRvIHRydWUsIHRoaXMgd2lsbCBibG9jayBzdWJzZXF1ZW50IGludm9rZXMgZnJvbSBlbnRlcmluZy4KICAgICAgY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF0gPSB0cnVlOwogICAgICBsb2dnZXIuaW5mbygiU29mdHBob25lIGNhbGwgZGV0ZWN0ZWQ6IiwgImNvbnRhY3RJZCAiICsgY29udGFjdC5nZXRDb250YWN0SWQoKSwgImFnZW50IGNvbm5lY3Rpb25JZCAiICsgYWdlbnRDb25uZWN0aW9uSWQpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgICAvLyBFbnN1cmUgb3VyIHNlc3Npb24gc3RhdGUgbWF0Y2hlcyBvdXIgY29udGFjdCBzdGF0ZSB0byBwcmV2ZW50IGlzc3VlcyBzaG91bGQgd2UgbG9zZSB0cmFjayBvZiBhIGNvbnRhY3QuCiAgICAgIHNhbml0eUNoZWNrQWN0aXZlU2Vzc2lvbnMocnRjU2Vzc2lvbnMpOwoKICAgICAgaWYgKGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5DT05ORUNUSU5HKSB7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJTb2Z0cGhvbmUgQ29ubmVjdGluZyIsIGNvbnRhY3QuZ2V0Q29udGFjdElkKCkpOwogICAgICB9CgogICAgICBpbml0aWFsaXplUGFyYW1zKCk7CiAgICAgIHZhciBzb2Z0cGhvbmVJbmZvID0gY29udGFjdC5nZXRBZ2VudENvbm5lY3Rpb24oKS5nZXRTb2Z0cGhvbmVNZWRpYUluZm8oKTsKICAgICAgdmFyIGNhbGxDb25maWcgPSBwYXJzZUNhbGxDb25maWcoc29mdHBob25lSW5mby5jYWxsQ29uZmlnSnNvbik7CiAgICAgIHZhciB3ZWJTb2NrZXRQcm92aWRlcjsKICAgICAgaWYgKGNhbGxDb25maWcudXNlV2ViU29ja2V0UHJvdmlkZXIpIHsKICAgICAgICB3ZWJTb2NrZXRQcm92aWRlciA9IGNvbm5lY3QuY29yZS5nZXRXZWJTb2NrZXRNYW5hZ2VyKCk7CiAgICAgIH0KICAgICAgdmFyIHNlc3Npb24gPSBuZXcgY29ubmVjdC5SVENTZXNzaW9uKAogICAgICAgIGNhbGxDb25maWcuc2lnbmFsaW5nRW5kcG9pbnQsCiAgICAgICAgY2FsbENvbmZpZy5pY2VTZXJ2ZXJzLAogICAgICAgIHNvZnRwaG9uZUluZm8uY2FsbENvbnRleHRUb2tlbiwKICAgICAgICBsb2dnZXIsCiAgICAgICAgY29udGFjdC5nZXRDb250YWN0SWQoKSwKICAgICAgICBhZ2VudENvbm5lY3Rpb25JZCwKICAgICAgICB3ZWJTb2NrZXRQcm92aWRlcik7CgogICAgICBydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF0gPSBzZXNzaW9uOwoKICAgICAgaWYgKGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0oKSkgewogICAgICAgIHNlc3Npb24ubWVkaWFTdHJlYW0gPSBjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtKCk7CiAgICAgIH0KCiAgICAgIC8vIEN1c3RvbSBFdmVudCB0byBpbmRpY2F0ZSB0aGUgc2Vzc2lvbiBpbml0IG9wZXJhdGlvbnMKICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgIGV2ZW50OiBjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuU0VTU0lPTl9JTklULAogICAgICAgIGRhdGE6IHsKICAgICAgICAgIGNvbm5lY3Rpb25JZDogYWdlbnRDb25uZWN0aW9uSWQKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgc2Vzc2lvbi5vblNlc3Npb25GYWlsZWQgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbiwgcmVhc29uKSB7CiAgICAgICAgZGVsZXRlIHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICBkZWxldGUgY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgcHVibGlzaFNvZnRwaG9uZUZhaWx1cmVMb2dzKHJ0Y1Nlc3Npb24sIHJlYXNvbik7CiAgICAgICAgcHVibGlzaFNlc3Npb25GYWlsdXJlVGVsZW1ldHJ5RXZlbnQoY29udGFjdC5nZXRDb250YWN0SWQoKSwgcmVhc29uKTsKICAgICAgICBzdG9wSm9ic0FuZFJlcG9ydChjb250YWN0LCBydGNTZXNzaW9uLnNlc3Npb25SZXBvcnQpOwogICAgICB9OwogICAgICBzZXNzaW9uLm9uU2Vzc2lvbkNvbm5lY3RlZCA9IGZ1bmN0aW9uIChydGNTZXNzaW9uKSB7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJTb2Z0cGhvbmUgU2Vzc2lvbiBDb25uZWN0ZWQiLCBjb250YWN0LmdldENvbnRhY3RJZCgpKTsKICAgICAgICAvLyBCZWNvbWUgbWFzdGVyIHRvIHNlbmQgbG9ncywgc2luY2Ugd2UgbmVlZCBsb2dzIGZyb20gc29mdHBob25lIHRhYi4KICAgICAgICBjb25uZWN0LmJlY29tZU1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TRU5EX0xPR1MpOwogICAgICAgIC8vc3RhcnQgc3RhdHMgY29sbGVjdGlvbiBhbmQgcmVwb3J0aW5nIGpvYnMKICAgICAgICBzdGFydFN0YXRzQ29sbGVjdGlvbkpvYihydGNTZXNzaW9uKTsKICAgICAgICBzdGFydFN0YXRzUmVwb3J0aW5nSm9iKGNvbnRhY3QpOwogICAgICAgIGZpcmVDb250YWN0QWNjZXB0ZWRFdmVudChjb250YWN0KTsKICAgICAgfTsKCiAgICAgIHNlc3Npb24ub25TZXNzaW9uQ29tcGxldGVkID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24pIHsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlNvZnRwaG9uZSBTZXNzaW9uIENvbXBsZXRlZCIsIGNvbnRhY3QuZ2V0Q29udGFjdElkKCkpOwoKICAgICAgICBkZWxldGUgcnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgIGRlbGV0ZSBjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICAvLyBTdG9wIGFsbCBqb2JzIGFuZCBwZXJmb3JtIG9uZSBsYXN0IGpvYi4KICAgICAgICBzdG9wSm9ic0FuZFJlcG9ydChjb250YWN0LCBydGNTZXNzaW9uLnNlc3Npb25SZXBvcnQpOwoKICAgICAgICAvLyBDbGVhbnVwIHRoZSBjYWNoZWQgc3RyZWFtcwogICAgICAgIGRlbGV0ZUxvY2FsTWVkaWFTdHJlYW0oYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICB9OwoKICAgICAgc2Vzc2lvbi5vbkxvY2FsU3RyZWFtQWRkZWQgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbiwgc3RyZWFtKSB7CiAgICAgICAgLy8gQ2FjaGUgdGhlIHN0cmVhbXMgZm9yIG11dGUvdW5tdXRlCiAgICAgICAgbG9jYWxNZWRpYVN0cmVhbVthZ2VudENvbm5lY3Rpb25JZF0gPSB7CiAgICAgICAgICBzdHJlYW06IHN0cmVhbQogICAgICAgIH07CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuQWdlbnRFdmVudHMuTE9DQUxfTUVESUFfU1RSRUFNX0NSRUFURUQsCiAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgIGNvbm5lY3Rpb25JZDogYWdlbnRDb25uZWN0aW9uSWQKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfTsKCiAgICAgIHNlc3Npb24ucmVtb3RlQXVkaW9FbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlbW90ZS1hdWRpbycpOwogICAgICBpZiAocnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5KSB7CiAgICAgICAgc2Vzc2lvbi5jb25uZWN0KHJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeS5nZXQoY2FsbENvbmZpZy5pY2VTZXJ2ZXJzKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2Vzc2lvbi5jb25uZWN0KCk7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgb25SZWZyZXNoQ29udGFjdCA9IGZ1bmN0aW9uIChjb250YWN0LCBhZ2VudENvbm5lY3Rpb25JZCkgewogICAgICBpZiAocnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdICYmIGlzQ29udGFjdFRlcm1pbmF0ZWQoY29udGFjdCkpIHsKICAgICAgICBkZXN0cm95U2Vzc2lvbihhZ2VudENvbm5lY3Rpb25JZCk7CiAgICAgICAgY2FuY2VsUGVuZGluZ1Nlc3Npb24oKTsKICAgICAgfQogICAgICBpZiAoY29udGFjdC5pc1NvZnRwaG9uZUNhbGwoKSAmJiAhY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF0gJiYgKAogICAgICAgIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5DT05ORUNUSU5HIHx8CiAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLklOQ09NSU5HKSkgewogICAgICAgICAgaWYgKGNvbm5lY3QuaXNGaXJlZm94QnJvd3NlcigpICYmIGNvbm5lY3QuaGFzT3RoZXJDb25uZWN0ZWRDQ1BzKCkpIHsKICAgICAgICAgICAgcG9zdHBvbmVTdGFydGluZ1Nlc3Npb24oY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZi5zdGFydFNlc3Npb24oY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIHZhciBvbkluaXRDb250YWN0ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgdmFyIGFnZW50Q29ubmVjdGlvbklkID0gY29udGFjdC5nZXRBZ2VudENvbm5lY3Rpb24oKS5jb25uZWN0aW9uSWQ7CiAgICAgIGxvZ2dlci5pbmZvKCJDb250YWN0IGRldGVjdGVkOiIsICJjb250YWN0SWQgIiArIGNvbnRhY3QuZ2V0Q29udGFjdElkKCksICJhZ2VudCBjb25uZWN0aW9uSWQgIiArIGFnZW50Q29ubmVjdGlvbklkKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgaWYgKCFjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXSkgewogICAgICAgIGNvbnRhY3Qub25SZWZyZXNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIG9uUmVmcmVzaENvbnRhY3QoY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwoKICAgIHNlbGYub25Jbml0Q29udGFjdFN1YiA9IGNvbm5lY3QuY29udGFjdChvbkluaXRDb250YWN0KTsKCiAgICAvLyBDb250YWN0IGFscmVhZHkgaW4gY29ubmVjdGluZyBzdGF0ZSBzY2VuYXJpbyAtIEluIHRoaXMgY2FzZSBjb250YWN0IElOSVQgaXMgbWlzc2VkIGhlbmNlIHRoZSBPblJlZnJlc2ggY2FsbGJhY2sgaXMgbWlzc2VkLiAKICAgIG5ldyBjb25uZWN0LkFnZW50KCkuZ2V0Q29udGFjdHMoKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIHZhciBhZ2VudENvbm5lY3Rpb25JZCA9IGNvbnRhY3QuZ2V0QWdlbnRDb25uZWN0aW9uKCkuY29ubmVjdGlvbklkOwogICAgICBsb2dnZXIuaW5mbygiQ29udGFjdCBleGlzdCBpbiB0aGUgc25hcHNob3QuIFJlaW5pdGlhdGUgdGhlIENvbnRhY3QgYW5kIFJUQyBzZXNzaW9uIGNyZWF0aW9uIGZvciBjb250YWN0SWQiICsgY29udGFjdC5nZXRDb250YWN0SWQoKSwgImFnZW50IGNvbm5lY3Rpb25JZCAiICsgYWdlbnRDb25uZWN0aW9uSWQpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIG9uSW5pdENvbnRhY3QoY29udGFjdCk7CiAgICAgIG9uUmVmcmVzaENvbnRhY3QoY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpOwogICAgfSk7CiAgfTsKCiAgdmFyIGZpcmVDb250YWN0QWNjZXB0ZWRFdmVudCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICB2YXIgY29uZHVpdCA9IGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpOwogICAgdmFyIGFnZW50Q29ubmVjdGlvbiA9IGNvbnRhY3QuZ2V0QWdlbnRDb25uZWN0aW9uKCk7CiAgICBpZiAoIWFnZW50Q29ubmVjdGlvbikgewogICAgICBsb2dnZXIuaW5mbygiTm90IGFibGUgdG8gcmV0cmlldmUgdGhlIGF1dG8tYWNjZXB0IHNldHRpbmcgZnJvbSBudWxsIEFnZW50Q29ubmVjdGlvbiwgaWdub3JpbmcgZXZlbnQgcHVibGlzaC4uIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHNvZnRwaG9uZU1lZGlhSW5mbyA9IGFnZW50Q29ubmVjdGlvbi5nZXRTb2Z0cGhvbmVNZWRpYUluZm8oKTsKICAgIGlmICghc29mdHBob25lTWVkaWFJbmZvKSB7CiAgICAgIGxvZ2dlci5pbmZvKCJOb3QgYWJsZSB0byByZXRyaWV2ZSB0aGUgYXV0by1hY2NlcHQgc2V0dGluZyBmcm9tIG51bGwgU29mdHBob25lTWVkaWFJbmZvLCBpZ25vcmluZyBldmVudCBwdWJsaXNoLi4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoc29mdHBob25lTWVkaWFJbmZvLmF1dG9BY2NlcHQgPT09IHRydWUpIHsKICAgICAgbG9nZ2VyLmluZm8oIkF1dG8tYWNjZXB0IGlzIGVuYWJsZWQsIHNlbmRpbmcgb3V0IEFjY2VwdGVkIGV2ZW50IHRvIHN0b3AgcmluZ3RvbmUuLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgIGV2ZW50OiBjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQsCiAgICAgICAgZGF0YTogbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0LmNvbnRhY3RJZCkKICAgICAgfSk7CiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgIGV2ZW50OiBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQsIGNvbnRhY3QuY29udGFjdElkKSwKICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3QuY29udGFjdElkKQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGxvZ2dlci5pbmZvKCJBdXRvLWFjY2VwdCBpcyBkaXNhYmxlZCwgcmluZ3RvbmUgd2lsbCBiZSBzdG9wcGVkIGJ5IHVzZXIgYWN0aW9uLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgLy8gQmluZCBldmVudHMgZm9yIG11dGUKICB2YXIgaGFuZGxlU29mdFBob25lTXV0ZVRvZ2dsZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuTVVURSwgbXV0ZVRvZ2dsZSk7CiAgfTsKCiAgdmFyIGhhbmRsZVNwZWFrZXJEZXZpY2VDaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9TUEVBS0VSX0RFVklDRSwgc2V0U3BlYWtlckRldmljZSk7CiAgfQoKICB2YXIgaGFuZGxlTWljcm9waG9uZURldmljZUNoYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9NSUNST1BIT05FX0RFVklDRSwgc2V0TWljcm9waG9uZURldmljZSk7CiAgfQoKICAvLyBNYWtlIHN1cmUgb25jZSB3ZSBkaXNjb25uZWN0ZWQgd2UgZ2V0IHRoZSBtdXRlIHN0YXRlIGJhY2sgdG8gbm9ybWFsCiAgdmFyIGRlbGV0ZUxvY2FsTWVkaWFTdHJlYW0gPSBmdW5jdGlvbiAoY29ubmVjdGlvbklkKSB7CiAgICBkZWxldGUgbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdOwogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5BZ2VudEV2ZW50cy5NVVRFX1RPR0dMRSwKICAgICAgZGF0YTogeyBtdXRlZDogZmFsc2UgfQogICAgfSk7CiAgfTsKCiAgLy8gQ2hlY2sgZm9yIHRoZSBsb2NhbCBzdHJlYW1zIGlmIGV4aXN0cyAgLSAgcmV2ZXJ0IGl0CiAgLy8gQW5kIGluZm9ybSBvdGhlciBjbGllbnRzIGFib3V0IHRoZSBjaGFuZ2UgCiAgdmFyIG11dGVUb2dnbGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgdmFyIHN0YXR1czsKICAgIGlmIChjb25uZWN0LmtleXMobG9jYWxNZWRpYVN0cmVhbSkubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoZGF0YSAmJiBkYXRhLm11dGUgIT09IHVuZGVmaW5lZCkgewogICAgICBzdGF0dXMgPSBkYXRhLm11dGU7CiAgICB9CgogICAgZm9yICh2YXIgY29ubmVjdGlvbklkIGluIGxvY2FsTWVkaWFTdHJlYW0pIHsKICAgICAgaWYgKGxvY2FsTWVkaWFTdHJlYW0uaGFzT3duUHJvcGVydHkoY29ubmVjdGlvbklkKSkgewogICAgICAgIHZhciBsb2NhbE1lZGlhID0gbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLnN0cmVhbTsKICAgICAgICBpZiAobG9jYWxNZWRpYSkgewogICAgICAgICAgdmFyIGF1ZGlvVHJhY2tzID0gbG9jYWxNZWRpYS5nZXRBdWRpb1RyYWNrcygpWzBdOwogICAgICAgICAgaWYgKHN0YXR1cyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGF1ZGlvVHJhY2tzLmVuYWJsZWQgPSAhc3RhdHVzOwogICAgICAgICAgICBsb2NhbE1lZGlhU3RyZWFtW2Nvbm5lY3Rpb25JZF0ubXV0ZWQgPSBzdGF0dXM7CgogICAgICAgICAgICBpZiAoc3RhdHVzKSB7CiAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkFnZW50IGhhcyBtdXRlZCB0aGUgY29udGFjdCwgY29ubmVjdGlvbklkIC0gICIgKyBjb25uZWN0aW9uSWQpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkFnZW50IGhhcyB1bm11dGVkIHRoZSBjb250YWN0LCBjb25uZWN0aW9uSWQgLSAiICsgY29ubmVjdGlvbklkKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB9CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdHVzID0gbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLm11dGVkIHx8IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQWdlbnRFdmVudHMuTVVURV9UT0dHTEUsCiAgICAgIGRhdGE6IHsgbXV0ZWQ6IHN0YXR1cyB9CiAgICB9KTsKICB9OwoKICB2YXIgc2V0U3BlYWtlckRldmljZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICBpZiAoY29ubmVjdC5rZXlzKGxvY2FsTWVkaWFTdHJlYW0pLmxlbmd0aCA9PT0gMCB8fCAhZGF0YSB8fCAhZGF0YS5kZXZpY2VJZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgZGV2aWNlSWQgPSBkYXRhLmRldmljZUlkOwogICAgdmFyIHJlbW90ZUF1ZGlvRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZW1vdGUtYXVkaW8nKTsKICAgIHRyeSB7CiAgICAgIGxvZ2dlci5pbmZvKCJUcnlpbmcgdG8gc2V0IHNwZWFrZXIgdG8gZGV2aWNlICIgKyBkZXZpY2VJZCk7CiAgICAgIGlmIChyZW1vdGVBdWRpb0VsZW1lbnQgJiYgdHlwZW9mIHJlbW90ZUF1ZGlvRWxlbWVudC5zZXRTaW5rSWQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZW1vdGVBdWRpb0VsZW1lbnQuc2V0U2lua0lkKGRldmljZUlkKTsKICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBsb2dnZXIuZXJyb3IoIkZhaWxlZCB0byBzZXQgc3BlYWtlciB0byBkZXZpY2UgIiArIGRldmljZUlkKTsKICAgIH0KCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuU1BFQUtFUl9ERVZJQ0VfQ0hBTkdFRCwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfQoKICB2YXIgc2V0TWljcm9waG9uZURldmljZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICBpZiAoY29ubmVjdC5rZXlzKGxvY2FsTWVkaWFTdHJlYW0pLmxlbmd0aCA9PT0gMCAgfHwgIWRhdGEgfHwgIWRhdGEuZGV2aWNlSWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGRldmljZUlkID0gZGF0YS5kZXZpY2VJZDsKICAgIHZhciBzb2Z0cGhvbmVNYW5hZ2VyID0gY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZU1hbmFnZXIoKTsKICAgIHRyeSB7CiAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKHsgYXVkaW86IHsgZGV2aWNlSWQ6IHsgZXhhY3Q6IGRldmljZUlkIH0gfSB9KQogICAgICAgIC50aGVuKGZ1bmN0aW9uIChuZXdNaWNyb3Bob25lU3RyZWFtKSB7CiAgICAgICAgICB2YXIgbmV3TWljcm9waG9uZVRyYWNrID0gbmV3TWljcm9waG9uZVN0cmVhbS5nZXRBdWRpb1RyYWNrcygpWzBdOwogICAgICAgICAgZm9yICh2YXIgY29ubmVjdGlvbklkIGluIGxvY2FsTWVkaWFTdHJlYW0pIHsKICAgICAgICAgICAgaWYgKGxvY2FsTWVkaWFTdHJlYW0uaGFzT3duUHJvcGVydHkoY29ubmVjdGlvbklkKSkgewogICAgICAgICAgICAgIHZhciBsb2NhbE1lZGlhID0gbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLnN0cmVhbTsKICAgICAgICAgICAgICB2YXIgc2Vzc2lvbiA9IHNvZnRwaG9uZU1hbmFnZXIuZ2V0U2Vzc2lvbihjb25uZWN0aW9uSWQpOwogICAgICAgICAgICAgIC8vUmVwbGFjZSB0aGUgYXVkaW8gdHJhY2sgaW4gdGhlIFJ0Y1BlZXJDb25uZWN0aW9uCiAgICAgICAgICAgICAgc2Vzc2lvbi5fcGMuZ2V0U2VuZGVycygpWzBdLnJlcGxhY2VUcmFjayhuZXdNaWNyb3Bob25lVHJhY2spLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgLy9SZXBsYWNlIHRoZSBhdWRpbyB0cmFjayBpbiB0aGUgbG9jYWwgbWVkaWEgc3RyZWFtIChmb3IgbXV0ZSAvIHVubXV0ZSkKICAgICAgICAgICAgICAgIHNvZnRwaG9uZU1hbmFnZXIucmVwbGFjZUxvY2FsTWVkaWFUcmFjayhjb25uZWN0aW9uSWQsIG5ld01pY3JvcGhvbmVUcmFjayk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0gY2F0Y2goZSkgewogICAgICBsb2dnZXIuZXJyb3IoIkZhaWxlZCB0byBzZXQgbWljcm9waG9uZSBkZXZpY2UgIiArIGRldmljZUlkKTsKICAgIH0KCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuTUlDUk9QSE9ORV9ERVZJQ0VfQ0hBTkdFRCwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfQoKICB2YXIgcHVibGlzaFNvZnRwaG9uZUZhaWx1cmVMb2dzID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24sIHJlYXNvbikgewogICAgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuSUNFX0NPTExFQ1RJT05fVElNRU9VVCkgewogICAgICB2YXIgZW5kUG9pbnRVcmwgPSAiXG4iOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJ0Y1Nlc3Npb24uX2ljZVNlcnZlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJ0Y1Nlc3Npb24uX2ljZVNlcnZlcnNbaV0udXJscy5sZW5ndGg7IGorKykgewogICAgICAgICAgZW5kUG9pbnRVcmwgPSBlbmRQb2ludFVybCArIHJ0Y1Nlc3Npb24uX2ljZVNlcnZlcnNbaV0udXJsc1tqXSArICJcbiI7CiAgICAgICAgfQogICAgICB9CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLklDRV9DT0xMRUNUSU9OX1RJTUVPVVQsICJJY2UgY29sbGVjdGlvbiB0aW1lZG91dC4gIiwgZW5kUG9pbnRVcmwpOwogICAgfSBlbHNlIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLlVTRVJfQlVTWSkgewogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5VU0VSX0JVU1lfRVJST1IsCiAgICAgICAgIlNvZnRwaG9uZSBjYWxsIFVzZXJCdXN5IGVycm9yLiAiLAogICAgICAgICIiKTsKICAgIH0gZWxzZSBpZiAocmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5TSUdOQUxMSU5HX0hBTkRTSEFLRV9GQUlMVVJFKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLlNJR05BTExJTkdfSEFORFNIQUtFX0ZBSUxVUkUsCiAgICAgICAgIkhhbmRzaGFraW5nIHdpdGggU2lnbmFsbGluZyBTZXJ2ZXIgIiArIHJ0Y1Nlc3Npb24uX3NpZ25hbGluZ1VyaSArICIgZmFpbGVkLiAiLAogICAgICAgIHJ0Y1Nlc3Npb24uX3NpZ25hbGluZ1VyaSk7CiAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuR1VNX1RJTUVPVVRfRkFJTFVSRSB8fCByZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLkdVTV9PVEhFUl9GQUlMVVJFKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLk1JQ1JPUEhPTkVfTk9UX1NIQVJFRCwKICAgICAgICAiWW91ciBtaWNyb3Bob25lIGlzIG5vdCBlbmFibGVkIGluIHlvdXIgYnJvd3Nlci4gIiwKICAgICAgICAiIik7CiAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuU0lHTkFMTElOR19DT05ORUNUSU9OX0ZBSUxVUkUpIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuU0lHTkFMTElOR19DT05ORUNUSU9OX0ZBSUxVUkUsCiAgICAgICAgIlVSTCAiICsgcnRjU2Vzc2lvbi5fc2lnbmFsaW5nVXJpICsgIiBjYW5ub3QgYmUgcmVhY2hlZC4gIiwKICAgICAgICBydGNTZXNzaW9uLl9zaWduYWxpbmdVcmkpOwogICAgfSBlbHNlIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLkNBTExfTk9UX0ZPVU5EKSB7CiAgICAgIC8vIE5vIG5lZWQgdG8gcHVibGlzaCBhbnkgc29mdHBob25lIGVycm9yIGZvciB0aGlzIGNhc2UuIENDUCBVWCB3aWxsIGhhbmRsZSB0aGlzIGNhc2UuCiAgICAgIGxvZ2dlci5lcnJvcigiU29mdHBob25lIGNhbGwgZmFpbGVkIGR1ZSB0byBDYWxsTm90Rm91bmRFeGNlcHRpb24uIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0gZWxzZSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLldFQlJUQ19FUlJPUiwKICAgICAgICAid2VicnRjIHN5c3RlbSBlcnJvci4gIiwKICAgICAgICAiIik7CiAgICB9CiAgfTsKCiAgLyoqIFBhcnNlIHRoZSBKU09OIGVuY29kZWQgd2ViIGNhbGwgY29uZmlnIGludG8gdGhlIGRhdGEgaXQgcmVwcmVzZW50cy4gKi8KICB2YXIgcGFyc2VDYWxsQ29uZmlnID0gZnVuY3Rpb24gKHNlcmlhbGl6ZWRDb25maWcpIHsKICAgIC8vIE91ciB1bmRlcnNjb3JlIGlzIHRvbyBvbGQgZm9yIHVuZXNjYXBlCiAgICAvLyBodHRwczovL2lzc3Vlcy5hbWF6b24uY29tL2lzc3Vlcy9DU1dGLTE0NjcKICAgIHZhciBkZWNvZGVkSlNPTiA9IHNlcmlhbGl6ZWRDb25maWcucmVwbGFjZSgvJnF1b3Q7L2csICciJyk7CiAgICByZXR1cm4gSlNPTi5wYXJzZShkZWNvZGVkSlNPTik7CiAgfTsKCiAgdmFyIGZldGNoVXNlck1lZGlhID0gZnVuY3Rpb24gKGNhbGxiYWNrc0luKSB7CiAgICB2YXIgY2FsbGJhY2tzID0gY2FsbGJhY2tzSW4gfHwge307CiAgICBjYWxsYmFja3Muc3VjY2VzcyA9IGNhbGxiYWNrcy5zdWNjZXNzIHx8IGZ1bmN0aW9uICgpIHsgfTsKICAgIGNhbGxiYWNrcy5mYWlsdXJlID0gY2FsbGJhY2tzLmZhaWx1cmUgfHwgZnVuY3Rpb24gKCkgeyB9OwoKICAgIHZhciBDT05TVFJBSU5UID0gewogICAgICBhdWRpbzogdHJ1ZQogICAgfTsKCiAgICB2YXIgcHJvbWlzZSA9IG51bGw7CgogICAgaWYgKHR5cGVvZiBQcm9taXNlICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKFNvZnRwaG9uZUVycm9yVHlwZXMuVU5TVVBQT1JURURfQlJPV1NFUik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAodHlwZW9mIG5hdmlnYXRvci5tZWRpYURldmljZXMgPT09ICJvYmplY3QiICYmIHR5cGVvZiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSA9PT0gImZ1bmN0aW9uIikgewogICAgICBwcm9taXNlID0gbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEoQ09OU1RSQUlOVCk7CgogICAgfSBlbHNlIGlmICh0eXBlb2YgbmF2aWdhdG9yLndlYmtpdEdldFVzZXJNZWRpYSA9PT0gImZ1bmN0aW9uIikgewogICAgICBwcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIG5hdmlnYXRvci53ZWJraXRHZXRVc2VyTWVkaWEoQ09OU1RSQUlOVCwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgfSk7CgogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoU29mdHBob25lRXJyb3JUeXBlcy5VTlNVUFBPUlRFRF9CUk9XU0VSKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAoc3RyZWFtKSB7CiAgICAgIHZhciBhdWRpb1RyYWNrcyA9IHN0cmVhbS5nZXRBdWRpb1RyYWNrcygpOwogICAgICBpZiAoYXVkaW9UcmFja3MgJiYgYXVkaW9UcmFja3MubGVuZ3RoID4gMCkgewogICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKHN0cmVhbSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoU29mdHBob25lRXJyb3JUeXBlcy5NSUNST1BIT05FX05PVF9TSEFSRUQpOwogICAgICB9CiAgICB9LCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKFNvZnRwaG9uZUVycm9yVHlwZXMuTUlDUk9QSE9ORV9OT1RfU0hBUkVEKTsKICAgIH0pOwogICAgcmV0dXJuIHByb21pc2U7CiAgfTsKCiAgdmFyIHB1Ymxpc2hFcnJvciA9IGZ1bmN0aW9uIChlcnJvclR5cGUsIG1lc3NhZ2UsIGVuZFBvaW50VXJsKSB7CiAgICBsb2dnZXIuZXJyb3IoIlNvZnRwaG9uZSBlcnJvciBvY2N1cnJlZCA6ICIsIGVycm9yVHlwZSwKICAgICAgbWVzc2FnZSB8fCAiIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkFnZW50RXZlbnRzLlNPRlRQSE9ORV9FUlJPUiwKICAgICAgZGF0YTogbmV3IGNvbm5lY3QuU29mdHBob25lRXJyb3IoZXJyb3JUeXBlLCBtZXNzYWdlLCBlbmRQb2ludFVybCkKICAgIH0pOwogIH07CgogIHZhciBwdWJsaXNoU2Vzc2lvbkZhaWx1cmVUZWxlbWV0cnlFdmVudCA9IGZ1bmN0aW9uIChjb250YWN0SWQsIHJlYXNvbikgewogICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJTb2Z0cGhvbmUgU2Vzc2lvbiBGYWlsZWQiLCBjb250YWN0SWQsIHsKICAgICAgZmFpbGVkUmVhc29uOiByZWFzb24KICAgIH0pOwogIH07CgogIHZhciBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBjb250YWN0SWQsIGRhdGEpIHsKICAgIGlmIChjb250YWN0SWQpIHsKICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICBuYW1lOiBldmVudE5hbWUsCiAgICAgICAgY29udGFjdElkOiBjb250YWN0SWQsCiAgICAgICAgZGF0YTogZGF0YQogICAgICB9KTsKICAgIH0KICB9OwoKICAvLyBQdWJsaXNoIHRoZSBjb250YWN0IGFuZCBhZ2VudCBpbmZvcm1hdGlvbiBpbiBhIG11bHRpcGxlIHNlc3Npb25zIHNjZW5hcmlvcwogIHZhciBwdWJsaXNoTXVsdGlwbGVTZXNzaW9uc0V2ZW50ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgY29udGFjdElkLCBhZ2VudENvbm5lY3Rpb25JZCkgewogICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KGV2ZW50TmFtZSwgY29udGFjdElkLCBbewogICAgICBuYW1lOiAiQWdlbnRDb25uZWN0aW9uSWQiLAogICAgICB2YWx1ZTogYWdlbnRDb25uZWN0aW9uSWQKICAgIH1dKTsKICAgIGxvZ2dlci5pbmZvKCJQdWJsaXNoIG11bHRpcGxlIHNlc3Npb24gZXJyb3IgbWV0cmljcyIsIGV2ZW50TmFtZSwgImNvbnRhY3RJZCAiICsgY29udGFjdElkLCAiYWdlbnQgY29ubmVjdGlvbklkICIgKyBhZ2VudENvbm5lY3Rpb25JZCkKICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgfTsKCiAgdmFyIGlzQnJvd3NlclNvZnRQaG9uZVN1cHBvcnRlZCA9IGZ1bmN0aW9uICgpIHsKICAgIC8vIEluIE9wZXJhLCB0aGUgdHJ1ZSB2ZXJzaW9uIGlzIGFmdGVyICJPcGVyYSIgb3IgYWZ0ZXIgIlZlcnNpb24iCiAgICBpZiAoY29ubmVjdC5pc09wZXJhQnJvd3NlcigpICYmIGNvbm5lY3QuZ2V0T3BlcmFCcm93c2VyVmVyc2lvbigpID4gMTcpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvLyBJbiBDaHJvbWUsIHRoZSB0cnVlIHZlcnNpb24gaXMgYWZ0ZXIgIkNocm9tZSIKICAgIGVsc2UgaWYgKGNvbm5lY3QuaXNDaHJvbWVCcm93c2VyKCkgJiYgY29ubmVjdC5nZXRDaHJvbWVCcm93c2VyVmVyc2lvbigpID4gMjIpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvLyBJbiBGaXJlZm94LCB0aGUgdHJ1ZSB2ZXJzaW9uIGlzIGFmdGVyICJGaXJlZm94IgogICAgZWxzZSBpZiAoY29ubmVjdC5pc0ZpcmVmb3hCcm93c2VyKCkgJiYgY29ubmVjdC5nZXRGaXJlZm94QnJvd3NlclZlcnNpb24oKSA+IDIxKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH07CgogIHZhciBzZW5kU29mdHBob25lTWV0cmljcyA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICB2YXIgc3RyZWFtU3RhdHMgPSB0aW1lU2VyaWVzU3RyZWFtU3RhdHNCdWZmZXIuc2xpY2UoKTsKICAgIHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlciA9IFtdOwogICAgaWYgKHN0cmVhbVN0YXRzLmxlbmd0aCA+IDApIHsKICAgICAgY29udGFjdC5zZW5kU29mdHBob25lTWV0cmljcyhzdHJlYW1TdGF0cywgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGxvZ2dlci5pbmZvKCJzZW5kU29mdHBob25lTWV0cmljcyBzdWNjZXNzIiArIEpTT04uc3RyaW5naWZ5KHN0cmVhbVN0YXRzKSkKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgbG9nZ2VyLmVycm9yKCJzZW5kU29mdHBob25lTWV0cmljcyBmYWlsZWQuIikKICAgICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwoKICB2YXIgc2VuZFNvZnRwaG9uZVJlcG9ydCA9IGZ1bmN0aW9uIChjb250YWN0LCByZXBvcnQsIHVzZXJBdWRpb1N0YXRzLCByZW1vdGVBdWRpb1N0YXRzKSB7CiAgICByZXBvcnQuc3RyZWFtU3RhdHMgPSBbYWRkU3RyZWFtVHlwZVRvU3RhdHModXNlckF1ZGlvU3RhdHMsIEFVRElPX0lOUFVUKSwKICAgIGFkZFN0cmVhbVR5cGVUb1N0YXRzKHJlbW90ZUF1ZGlvU3RhdHMsIEFVRElPX09VVFBVVCldOwogICAgdmFyIGNhbGxSZXBvcnQgPSB7CiAgICAgIGNhbGxTdGFydFRpbWU6IHJlcG9ydC5zZXNzaW9uU3RhcnRUaW1lLAogICAgICBjYWxsRW5kVGltZTogcmVwb3J0LnNlc3Npb25FbmRUaW1lLAogICAgICBndW1UaW1lTWlsbGlzOiByZXBvcnQuZ3VtVGltZU1pbGxpcywKICAgICAgaW5pdGlhbGl6YXRpb25UaW1lTWlsbGlzOiByZXBvcnQuaW5pdGlhbGl6YXRpb25UaW1lTWlsbGlzLAogICAgICBpY2VDb2xsZWN0aW9uVGltZU1pbGxpczogcmVwb3J0LmljZUNvbGxlY3Rpb25UaW1lTWlsbGlzLAogICAgICBzaWduYWxsaW5nQ29ubmVjdFRpbWVNaWxsaXM6IHJlcG9ydC5zaWduYWxsaW5nQ29ubmVjdFRpbWVNaWxsaXMsCiAgICAgIGhhbmRzaGFraW5nVGltZU1pbGxpczogcmVwb3J0LmhhbmRzaGFraW5nVGltZU1pbGxpcywKICAgICAgcHJlVGFsa2luZ1RpbWVNaWxsaXM6IHJlcG9ydC5wcmVUYWxraW5nVGltZU1pbGxpcywKICAgICAgdGFsa2luZ1RpbWVNaWxsaXM6IHJlcG9ydC50YWxraW5nVGltZU1pbGxpcywKICAgICAgY2xlYW51cFRpbWVNaWxsaXM6IHJlcG9ydC5jbGVhbnVwVGltZU1pbGxpcywKICAgICAgaWNlQ29sbGVjdGlvbkZhaWx1cmU6IHJlcG9ydC5pY2VDb2xsZWN0aW9uRmFpbHVyZSwKICAgICAgc2lnbmFsbGluZ0Nvbm5lY3Rpb25GYWlsdXJlOiByZXBvcnQuc2lnbmFsbGluZ0Nvbm5lY3Rpb25GYWlsdXJlLAogICAgICBoYW5kc2hha2luZ0ZhaWx1cmU6IHJlcG9ydC5oYW5kc2hha2luZ0ZhaWx1cmUsCiAgICAgIGd1bU90aGVyRmFpbHVyZTogcmVwb3J0Lmd1bU90aGVyRmFpbHVyZSwKICAgICAgZ3VtVGltZW91dEZhaWx1cmU6IHJlcG9ydC5ndW1UaW1lb3V0RmFpbHVyZSwKICAgICAgY3JlYXRlT2ZmZXJGYWlsdXJlOiByZXBvcnQuY3JlYXRlT2ZmZXJGYWlsdXJlLAogICAgICBzZXRMb2NhbERlc2NyaXB0aW9uRmFpbHVyZTogcmVwb3J0LnNldExvY2FsRGVzY3JpcHRpb25GYWlsdXJlLAogICAgICB1c2VyQnVzeUZhaWx1cmU6IHJlcG9ydC51c2VyQnVzeUZhaWx1cmUsCiAgICAgIGludmFsaWRSZW1vdGVTRFBGYWlsdXJlOiByZXBvcnQuaW52YWxpZFJlbW90ZVNEUEZhaWx1cmUsCiAgICAgIG5vUmVtb3RlSWNlQ2FuZGlkYXRlRmFpbHVyZTogcmVwb3J0Lm5vUmVtb3RlSWNlQ2FuZGlkYXRlRmFpbHVyZSwKICAgICAgc2V0UmVtb3RlRGVzY3JpcHRpb25GYWlsdXJlOiByZXBvcnQuc2V0UmVtb3RlRGVzY3JpcHRpb25GYWlsdXJlLAogICAgICBzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzOiByZXBvcnQuc3RyZWFtU3RhdHMKICAgIH07CiAgICBjb250YWN0LnNlbmRTb2Z0cGhvbmVSZXBvcnQoY2FsbFJlcG9ydCwgewogICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgbG9nZ2VyLmluZm8oInNlbmRTb2Z0cGhvbmVSZXBvcnQgc3VjY2VzcyIgKyBKU09OLnN0cmluZ2lmeShjYWxsUmVwb3J0KSkKICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGxvZ2dlci5lcnJvcigic2VuZFNvZnRwaG9uZVJlcG9ydCBmYWlsZWQuIikKICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpCiAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgdmFyIHN0YXJ0U3RhdHNDb2xsZWN0aW9uSm9iID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24pIHsKICAgIHJ0cFN0YXRzSm9iID0gd2luZG93LnNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgcnRjU2Vzc2lvbi5nZXRVc2VyQXVkaW9TdGF0cygpLnRoZW4oZnVuY3Rpb24gKHN0YXRzKSB7CiAgICAgICAgdmFyIHByZXZpb3VzVXNlclN0YXRzID0gYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzOwogICAgICAgIGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cyA9IHN0YXRzOwogICAgICAgIHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlci5wdXNoKGdldFRpbWVTZXJpZXNTdGF0cyhhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHMsIHByZXZpb3VzVXNlclN0YXRzLCBBVURJT19JTlBVVCkpOwogICAgICB9LCBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICBsb2dnZXIuZGVidWcoIkZhaWxlZCB0byBnZXQgdXNlciBhdWRpbyBzdGF0cy4iLCBlcnJvcikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSk7CiAgICAgIHJ0Y1Nlc3Npb24uZ2V0UmVtb3RlQXVkaW9TdGF0cygpLnRoZW4oZnVuY3Rpb24gKHN0YXRzKSB7CiAgICAgICAgdmFyIHByZXZpb3VzUmVtb3RlU3RhdHMgPSBhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0czsKICAgICAgICBhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cyA9IHN0YXRzOwogICAgICAgIHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlci5wdXNoKGdldFRpbWVTZXJpZXNTdGF0cyhhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cywgcHJldmlvdXNSZW1vdGVTdGF0cywgQVVESU9fT1VUUFVUKSk7CiAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgIGxvZ2dlci5kZWJ1ZygiRmFpbGVkIHRvIGdldCByZW1vdGUgYXVkaW8gc3RhdHMuIiwgZXJyb3IpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0pOwogICAgfSwgMTAwMCk7CiAgfTsKCiAgdmFyIHN0YXJ0U3RhdHNSZXBvcnRpbmdKb2IgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgcmVwb3J0U3RhdHNKb2IgPSB3aW5kb3cuc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICBzZW5kU29mdHBob25lTWV0cmljcyhjb250YWN0KTsKICAgIH0sIHN0YXRzUmVwb3J0aW5nSm9iSW50ZXJ2YWxNcyk7CiAgfTsKCiAgdmFyIGluaXRpYWxpemVQYXJhbXMgPSBmdW5jdGlvbiAoKSB7CiAgICBhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHMgPSBudWxsOwogICAgYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHMgPSBudWxsOwogICAgdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyID0gW107CiAgICBydHBTdGF0c0pvYiA9IG51bGw7CiAgICByZXBvcnRTdGF0c0pvYiA9IG51bGw7CiAgfTsKCiAgdmFyIGdldFRpbWVTZXJpZXNTdGF0cyA9IGZ1bmN0aW9uIChjdXJyZW50U3RhdHMsIHByZXZpb3VzU3RhdHMsIHN0cmVhbVR5cGUpIHsKICAgIGlmIChwcmV2aW91c1N0YXRzICYmIGN1cnJlbnRTdGF0cykgewogICAgICB2YXIgcGFja2V0c0xvc3QgPSBjdXJyZW50U3RhdHMucGFja2V0c0xvc3QgPiBwcmV2aW91c1N0YXRzLnBhY2tldHNMb3N0ID8gY3VycmVudFN0YXRzLnBhY2tldHNMb3N0IC0gcHJldmlvdXNTdGF0cy5wYWNrZXRzTG9zdCA6IDA7CiAgICAgIHZhciBwYWNrZXRzQ291bnQgPSBjdXJyZW50U3RhdHMucGFja2V0c0NvdW50ID4gcHJldmlvdXNTdGF0cy5wYWNrZXRzQ291bnQgPyBjdXJyZW50U3RhdHMucGFja2V0c0NvdW50IC0gcHJldmlvdXNTdGF0cy5wYWNrZXRzQ291bnQgOiAwOwogICAgICByZXR1cm4gbmV3IFJUUFN0cmVhbVN0YXRzKGN1cnJlbnRTdGF0cy50aW1lc3RhbXAsCiAgICAgICAgcGFja2V0c0xvc3QsCiAgICAgICAgcGFja2V0c0NvdW50LAogICAgICAgIHN0cmVhbVR5cGUsCiAgICAgICAgY3VycmVudFN0YXRzLmF1ZGlvTGV2ZWwsCiAgICAgICAgY3VycmVudFN0YXRzLmpiTWlsbGlzZWNvbmRzLAogICAgICAgIGN1cnJlbnRTdGF0cy5ydHRNaWxsaXNlY29uZHMpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG5ldyBSVFBTdHJlYW1TdGF0cyhjdXJyZW50U3RhdHMudGltZXN0YW1wLAogICAgICAgIGN1cnJlbnRTdGF0cy5wYWNrZXRzTG9zdCwKICAgICAgICBjdXJyZW50U3RhdHMucGFja2V0c0NvdW50LAogICAgICAgIHN0cmVhbVR5cGUsCiAgICAgICAgY3VycmVudFN0YXRzLmF1ZGlvTGV2ZWwsCiAgICAgICAgY3VycmVudFN0YXRzLmpiTWlsbGlzZWNvbmRzLAogICAgICAgIGN1cnJlbnRTdGF0cy5ydHRNaWxsaXNlY29uZHMpOwogICAgfQogIH07CgogIHZhciBzdG9wSm9iID0gZnVuY3Rpb24gKHRhc2spIHsKICAgIGlmICh0YXNrICE9PSBudWxsKSB7CiAgICAgIHdpbmRvdy5jbGVhckludGVydmFsKHRhc2spOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfTsKCiAgdmFyIHN0b3BKb2JzQW5kUmVwb3J0ID0gZnVuY3Rpb24gKGNvbnRhY3QsIHNlc3Npb25SZXBvcnQpIHsKICAgIHJ0cFN0YXRzSm9iID0gc3RvcEpvYihydHBTdGF0c0pvYik7CiAgICByZXBvcnRTdGF0c0pvYiA9IHN0b3BKb2IocmVwb3J0U3RhdHNKb2IpOwogICAgc2VuZFNvZnRwaG9uZVJlcG9ydChjb250YWN0LCBzZXNzaW9uUmVwb3J0LCBhZGRTdHJlYW1UeXBlVG9TdGF0cyhhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHMsIEFVRElPX0lOUFVUKSwgYWRkU3RyZWFtVHlwZVRvU3RhdHMoYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHMsIEFVRElPX09VVFBVVCkpOwogICAgc2VuZFNvZnRwaG9uZU1ldHJpY3MoY29udGFjdCk7CiAgfTsKCiAgLyoqCiAgKiAgIEFkZGluZyBzdHJlYW10eXBlIHBhcmFtZXRlciBvbiB0b3Agb2YgUlRDSlMgUlRTdGF0cyBvYmplY3QuCiAgKi8KICB2YXIgUlRQU3RyZWFtU3RhdHMgPSBmdW5jdGlvbiAodGltZXN0YW1wLCBwYWNrZXRzTG9zdCwgcGFja2V0c0NvdW50LCBzdHJlYW1UeXBlLCBhdWRpb0xldmVsLCBqaXR0ZXJCdWZmZXJNaWxsaXMsIHJvdW5kVHJpcFRpbWVNaWxsaXMpIHsKICAgIHRoaXMuc29mdHBob25lU3RyZWFtVHlwZSA9IHN0cmVhbVR5cGU7CiAgICB0aGlzLnRpbWVzdGFtcCA9IHRpbWVzdGFtcDsKICAgIHRoaXMucGFja2V0c0xvc3QgPSBwYWNrZXRzTG9zdDsKICAgIHRoaXMucGFja2V0c0NvdW50ID0gcGFja2V0c0NvdW50OwogICAgdGhpcy5hdWRpb0xldmVsID0gYXVkaW9MZXZlbDsKICAgIHRoaXMuaml0dGVyQnVmZmVyTWlsbGlzID0gaml0dGVyQnVmZmVyTWlsbGlzOwogICAgdGhpcy5yb3VuZFRyaXBUaW1lTWlsbGlzID0gcm91bmRUcmlwVGltZU1pbGxpczsKICB9OwoKICB2YXIgYWRkU3RyZWFtVHlwZVRvU3RhdHMgPSBmdW5jdGlvbiAoc3RhdHMsIHN0cmVhbVR5cGUpIHsKICAgIHN0YXRzID0gc3RhdHMgfHwge307CiAgICByZXR1cm4gbmV3IFJUUFN0cmVhbVN0YXRzKHN0YXRzLnRpbWVzdGFtcCwgc3RhdHMucGFja2V0c0xvc3QsIHN0YXRzLnBhY2tldHNDb3VudCwgc3RyZWFtVHlwZSwgc3RhdHMuYXVkaW9MZXZlbCk7CiAgfTsKCiAgdmFyIFNvZnRwaG9uZUxvZ2dlciA9IGZ1bmN0aW9uIChsb2dnZXIpIHsKICAgIHRoaXMuX29yaWdpbmFsTG9nZ2VyID0gbG9nZ2VyOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdGhpcy5fdGVlID0gZnVuY3Rpb24gKGxldmVsLCBtZXRob2QpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBjYWxsIHRoZSBvcmlnaW5hbCBsb2dnZXIgb2JqZWN0IHRvIG91dHB1dCB0byBicm93c2VyCiAgICAgICAgLy9Db25uZWN0IGxvZ2dlciBmb2xsb3dzICVzIGZvcm1hdCB0byBwcmludCBvYmplY3RzIHRvIGNvbnNvbGUuCiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHNbMF0pOwogICAgICAgIHZhciBmb3JtYXQgPSAiIjsKICAgICAgICBhcmdzLmZvckVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgZm9ybWF0ID0gZm9ybWF0ICsgIiAlcyI7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIG1ldGhvZC5hcHBseShzZWxmLl9vcmlnaW5hbExvZ2dlciwgW2Nvbm5lY3QuTG9nQ29tcG9uZW50LlNPRlRQSE9ORSwgZm9ybWF0XS5jb25jYXQoYXJncykpOwogICAgICB9OwogICAgfTsKICB9OwoKICBTb2Z0cGhvbmVMb2dnZXIucHJvdG90eXBlLmRlYnVnID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX3RlZSgxLCB0aGlzLl9vcmlnaW5hbExvZ2dlci5kZWJ1ZykoYXJndW1lbnRzKTsKICB9OwogIFNvZnRwaG9uZUxvZ2dlci5wcm90b3R5cGUuaW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl90ZWUoMiwgdGhpcy5fb3JpZ2luYWxMb2dnZXIuaW5mbykoYXJndW1lbnRzKTsKICB9OwogIFNvZnRwaG9uZUxvZ2dlci5wcm90b3R5cGUubG9nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX3RlZSgzLCB0aGlzLl9vcmlnaW5hbExvZ2dlci5sb2cpKGFyZ3VtZW50cyk7CiAgfTsKICBTb2Z0cGhvbmVMb2dnZXIucHJvdG90eXBlLndhcm4gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fdGVlKDQsIHRoaXMuX29yaWdpbmFsTG9nZ2VyLndhcm4pKGFyZ3VtZW50cyk7CiAgfTsKICBTb2Z0cGhvbmVMb2dnZXIucHJvdG90eXBlLmVycm9yID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX3RlZSg1LCB0aGlzLl9vcmlnaW5hbExvZ2dlci5lcnJvcikoYXJndW1lbnRzKTsKICB9OwoKICBjb25uZWN0LlNvZnRwaG9uZU1hbmFnZXIgPSBTb2Z0cGhvbmVNYW5hZ2VyOwp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgY29ubmVjdC53b3JrZXIgPSB7fTsKCiAgdmFyIEdFVF9BR0VOVF9USU1FT1VUX01TID0gMzAwMDA7CiAgdmFyIEdFVF9BR0VOVF9SRUNPVkVSWV9USU1FT1VUX01TID0gNTAwMDsKICB2YXIgR0VUX0FHRU5UX1NVQ0NFU1NfVElNRU9VVF9NUyA9IDEwMDsKICB2YXIgTE9HX0JVRkZFUl9DQVBfU0laRSA9IDQwMDsKCiAgdmFyIENIRUNLX0FVVEhfVE9LRU5fSU5URVJWQUxfTVMgPSAzMDAwMDA7IC8vIDUgbWludXRzCiAgdmFyIFJFRlJFU0hfQVVUSF9UT0tFTl9JTlRFUlZBTF9NUyA9IDEwMDAwOyAvLyAxMCBzZWNvbmRzCiAgdmFyIFJFRlJFU0hfQVVUSF9UT0tFTl9NQVhfVFJZID0gNDsKCiAgdmFyIEdFVF9BR0VOVF9DT05GSUdVUkFUSU9OX0lOVEVSVkFMX01TID0gMzAwMDA7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICB2YXIgTWFzdGVyVG9waWNDb29yZGluYXRvciA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMudG9waWNNYXN0ZXJNYXAgPSB7fTsKICB9OwoKICBNYXN0ZXJUb3BpY0Nvb3JkaW5hdG9yLnByb3RvdHlwZS5nZXRNYXN0ZXIgPSBmdW5jdGlvbiAodG9waWMpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b3BpYywgJ3RvcGljJyk7CiAgICByZXR1cm4gdGhpcy50b3BpY01hc3Rlck1hcFt0b3BpY10gfHwgbnVsbDsKICB9OwoKICBNYXN0ZXJUb3BpY0Nvb3JkaW5hdG9yLnByb3RvdHlwZS5zZXRNYXN0ZXIgPSBmdW5jdGlvbiAodG9waWMsIGlkKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWMsICd0b3BpYycpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGlkLCAnaWQnKTsKICAgIHRoaXMudG9waWNNYXN0ZXJNYXBbdG9waWNdID0gaWQ7CiAgfTsKCiAgTWFzdGVyVG9waWNDb29yZGluYXRvci5wcm90b3R5cGUucmVtb3ZlTWFzdGVyID0gZnVuY3Rpb24gKGlkKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoaWQsICdpZCcpOwogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIGNvbm5lY3QuZW50cmllcyh0aGlzLnRvcGljTWFzdGVyTWFwKS5maWx0ZXIoZnVuY3Rpb24gKGVudHJ5KSB7CiAgICAgIHJldHVybiBlbnRyeS52YWx1ZSA9PT0gaWQ7CiAgICB9KS5mb3JFYWNoKGZ1bmN0aW9uIChlbnRyeSkgewogICAgICBkZWxldGUgc2VsZi50b3BpY01hc3Rlck1hcFtlbnRyeS5rZXldOwogICAgfSk7CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgV29ya2VyQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAqLwogIHZhciBXb3JrZXJDbGllbnQgPSBmdW5jdGlvbiAoY29uZHVpdCkgewogICAgY29ubmVjdC5DbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgICB0aGlzLmNvbmR1aXQgPSBjb25kdWl0OwogIH07CiAgV29ya2VyQ2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoY29ubmVjdC5DbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgV29ya2VyQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFdvcmtlckNsaWVudDsKCiAgV29ya2VyQ2xpZW50LnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbiAobWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHJlcXVlc3Rfc3RhcnQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIGlmKGNvbm5lY3QuY29udGFpbnNWYWx1ZShjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcywgbWV0aG9kKSkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRBcHBDbGllbnQoKS5fY2FsbEltcGwobWV0aG9kLCBwYXJhbXMsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQpOwogICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgIHNlbGYuX3JlY29yZEFQSUxhdGVuY3kobWV0aG9kLCByZXF1ZXN0X3N0YXJ0LCBlcnJvcik7CiAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvcik7CiAgICAgICAgfQogICAgICB9KQogICAgfSBlbHNlIHsKICAgICAgY29ubmVjdC5jb3JlLmdldENsaWVudCgpLl9jYWxsSW1wbChtZXRob2QsIHBhcmFtcywgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCk7CiAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnJvciwgZGF0YSkgewogICAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQsIGVycm9yKTsKICAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVycm9yLCBkYXRhKTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCk7CiAgICAgICAgICBjYWxsYmFja3MuYXV0aEZhaWx1cmUoKTsKICAgICAgICB9LAogICAgICAgIGFjY2Vzc0RlbmllZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgY2FsbGJhY2tzLmFjY2Vzc0RlbmllZCAmJiBjYWxsYmFja3MuYWNjZXNzRGVuaWVkKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIAogIH07CgogIFdvcmtlckNsaWVudC5wcm90b3R5cGUuX3JlY29yZEFQSUxhdGVuY3kgPSBmdW5jdGlvbiAobWV0aG9kLCByZXF1ZXN0X3N0YXJ0LCBlcnIpIHsKICAgIHZhciByZXF1ZXN0X2VuZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgdmFyIHJlcXVlc3RfdGltZSA9IHJlcXVlc3RfZW5kIC0gcmVxdWVzdF9zdGFydDsKICAgIHRoaXMuX3NlbmRBUElNZXRyaWNzKG1ldGhvZCwgcmVxdWVzdF90aW1lLCBlcnIpOwogIH07CgogIFdvcmtlckNsaWVudC5wcm90b3R5cGUuX3NlbmRBUElNZXRyaWNzID0gZnVuY3Rpb24gKG1ldGhvZCwgdGltZSwgZXJyKSB7CiAgICB0aGlzLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVBJX01FVFJJQywgewogICAgICBuYW1lOiBtZXRob2QsCiAgICAgIHRpbWU6IHRpbWUsCiAgICAgIGRpbWVuc2lvbnM6IFsKICAgICAgICB7CiAgICAgICAgICBuYW1lOiAiQ2F0ZWdvcnkiLAogICAgICAgICAgdmFsdWU6ICJBUEkiCiAgICAgICAgfQogICAgICBdLAogICAgICBlcnJvcjogZXJyCiAgICB9KTsKICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogVGhlIG9iamVjdCByZXNwb25zaWJsZSBmb3IgcG9sbGluZyBhbmQgcGFzc2luZyBkYXRhIGRvd25zdHJlYW0gdG8gYWxsCiAgICogY29uc3VtZXIgcG9ydHMuCiAgICovCiAgdmFyIENsaWVudEVuZ2luZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB0aGlzLm11bHRpcGxleGVyID0gbmV3IGNvbm5lY3QuU3RyZWFtTXVsdGlwbGV4ZXIoKTsKICAgIHRoaXMuY29uZHVpdCA9IG5ldyBjb25uZWN0LkNvbmR1aXQoIkFtYXpvbkNvbm5lY3RTaGFyZWRXb3JrZXIiLCBudWxsLCB0aGlzLm11bHRpcGxleGVyKTsKICAgIHRoaXMuY2xpZW50ID0gbmV3IFdvcmtlckNsaWVudCh0aGlzLmNvbmR1aXQpOwogICAgdGhpcy50aW1lb3V0ID0gbnVsbDsKICAgIHRoaXMuYWdlbnQgPSBudWxsOwogICAgdGhpcy5uZXh0VG9rZW4gPSBudWxsOwogICAgdGhpcy5pbml0RGF0YSA9IHt9OwogICAgdGhpcy5wb3J0Q29uZHVpdE1hcCA9IHt9OwogICAgdGhpcy5tYXN0ZXJDb29yZCA9IG5ldyBNYXN0ZXJUb3BpY0Nvb3JkaW5hdG9yKCk7CiAgICB0aGlzLmxvZ3NCdWZmZXIgPSBbXTsKICAgIHRoaXMuc3VwcHJlc3MgPSBmYWxzZTsKICAgIHRoaXMuZm9yY2VPZmZsaW5lID0gZmFsc2U7CgogICAgdmFyIHdlYlNvY2tldE1hbmFnZXIgPSBudWxsOwoKICAgIGNvbm5lY3Qucm9vdExvZ2dlciA9IG5ldyBjb25uZWN0LkRvd25zdHJlYW1Db25kdWl0TG9nZ2VyKHRoaXMuY29uZHVpdCk7CgogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TRU5EX0xPR1MsIGZ1bmN0aW9uIChsb2dzVG9VcGxvYWQpIHsKICAgICAgLy8gQWRkIHNvZnRwaG9uZSBsb2dzIGRvd25zdHJlYW0KICAgICAgY29ubmVjdC5nZXRMb2coKS5wdXNoTG9nc0Rvd25zdHJlYW0obG9nc1RvVXBsb2FkKTsKCiAgICAgIHNlbGYubG9nc0J1ZmZlciA9IHNlbGYubG9nc0J1ZmZlci5jb25jYXQobG9nc1RvVXBsb2FkKTsKICAgICAgLy9vbmx5IGNhbGwgQVBJIHRvIHNlbmQgbG9ncyBpZiBidWZmZXIgcmVhY2hlZCBjYXAKICAgICAgaWYgKHNlbGYubG9nc0J1ZmZlci5sZW5ndGggPiBMT0dfQlVGRkVSX0NBUF9TSVpFKSB7CiAgICAgICAgc2VsZi5oYW5kbGVTZW5kTG9nc1JlcXVlc3Qoc2VsZi5sb2dzQnVmZmVyKTsKICAgICAgfQogICAgfSk7CgogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuU1VQUFJFU1MsIGZ1bmN0aW9uIChkYXRhKXsKICAgICAgY29ubmVjdC5nZXRMb2coKS5kZWJ1ZygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBTZXR0aW5nIFN1cHByZXNzIHRvICVzIiwgZGF0YS5zdXBwcmVzcykKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgc2VsZi5zdXBwcmVzcyA9IGRhdGEuc3VwcHJlc3MgfHwgZmFsc2U7CiAgICAgIC8vc2lnbmFsIG90aGVyIHdpbmRvd3MgdGhhdCBhIGZhaWxvdmVyIGhhcHBlbmVkCiAgICAgIGlmIChzZWxmLm1hc3RlckNvb3JkLmdldE1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUpKSB7CiAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GQUlMT1ZFUiwgewogICAgICAgICAgaXNQcmltYXJ5OiAhc2VsZi5zdXBwcmVzcwogICAgICAgIH0pOyAgICAgIAogICAgICB9CiAgICB9KTsKCiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GT1JDRV9PRkZMSU5FLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBjb25uZWN0LmdldExvZygpLmRlYnVnKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIFNldHRpbmcgRk9SQ0VfT0ZGTElORSB0byAlcyIsIGRhdGEub2ZmbGluZSkKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgc2VsZi5mb3JjZU9mZmxpbmUgPSBkYXRhLm9mZmxpbmUgfHwgZmFsc2U7CiAgICB9KTsKCiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgaWYgKGRhdGEuYXV0aFRva2VuICYmIGRhdGEuYXV0aFRva2VuICE9PSBzZWxmLmluaXREYXRhLmF1dGhUb2tlbikgewogICAgICAgIHNlbGYuaW5pdERhdGEgPSBkYXRhOwogICAgICAgIGNvbm5lY3QuY29yZS5pbml0KGRhdGEpOwogICAgICAgIC8vIGluaXQgb25seSBvbmNlLgogICAgICAgIGlmICghd2ViU29ja2V0TWFuYWdlcikgewoKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQ3JlYXRpbmcgYSBuZXcgV2Vic29ja2V0IGNvbm5lY3Rpb24gZm9yIENDUCIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgICAgIGNvbm5lY3QuV2ViU29ja2V0TWFuYWdlci5zZXRHbG9iYWxDb25maWcoewogICAgICAgICAgICBsb2dnZXJDb25maWc6IHsgbG9nZ2VyOiBjb25uZWN0LmdldExvZygpIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIgPSBjb25uZWN0LldlYlNvY2tldE1hbmFnZXIuY3JlYXRlKCk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkluaXRGYWlsdXJlKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLklOSVRfRkFJTFVSRSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uQ29ubmVjdGlvbk9wZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX09QRU4sIHJlc3BvbnNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25Db25uZWN0aW9uQ2xvc2UoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0NMT1NFLCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uQ29ubmVjdGlvbkdhaW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5BZ2VudEV2ZW50cy5XRUJTT0NLRVRfQ09OTkVDVElPTl9HQUlORUQpOwogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9HQUlOKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25Db25uZWN0aW9uTG9zdChmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuQWdlbnRFdmVudHMuV0VCU09DS0VUX0NPTk5FQ1RJT05fTE9TVCwgcmVzcG9uc2UpOwogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9MT1NULCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uU3Vic2NyaXB0aW9uVXBkYXRlKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSVBUSU9OX1VQREFURSwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vblN1YnNjcmlwdGlvbkZhaWx1cmUoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJUFRJT05fRkFJTFVSRSwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkFsbE1lc3NhZ2UoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5BTExfTUVTU0FHRSwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgc2VsZi5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TRU5ELCBmdW5jdGlvbiAobWVzc2FnZSkgewogICAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLnNlbmRNZXNzYWdlKG1lc3NhZ2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgc2VsZi5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJQkUsIGZ1bmN0aW9uICh0b3BpY3MpIHsKICAgICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5zdWJzY3JpYmVUb3BpY3ModG9waWNzKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIuaW5pdChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuZ2V0V2ViU29ja2V0VXJsKSkudGhlbihmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICBpZiAocmVzcG9uc2UgJiYgIXJlc3BvbnNlLndlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQpIHsKICAgICAgICAgICAgICAvLyBTdGFydCBwb2xsaW5nIGZvciBhZ2VudCBkYXRhLgogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiS2lja2luZyBvZmYgYWdlbnQgcG9sbGluZyIpCiAgICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudCgpOwoKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIktpY2tpbmcgb2ZmIGNvbmZpZyBwb2xsaW5nIikKICAgICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIHNlbGYucG9sbEZvckFnZW50Q29uZmlndXJhdGlvbih7IHJlcGVhdEZvcmV2ZXI6IHRydWUgfSk7CgogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiS2lja2luZyBvZmYgYXV0aCB0b2tlbiBwb2xsaW5nIikKICAgICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuY2hlY2tBdXRoVG9rZW4pLCBDSEVDS19BVVRIX1RPS0VOX0lOVEVSVkFMX01TKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoIWNvbm5lY3Qud2ViU29ja2V0SW5pdEZhaWxlZCkgewogICAgICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLklOSVRfRkFJTFVSRSk7CiAgICAgICAgICAgICAgICBjb25uZWN0LndlYlNvY2tldEluaXRGYWlsZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiTm90IEluaXRpYWxpemluZyBhIG5ldyBXZWJzb2NrZXRNYW5hZ2VyIGluc3RhbmNlLCBzaW5jZSBvbmUgYWxyZWFkeSBleGlzdHMiKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5URVJNSU5BVEUsIGZ1bmN0aW9uICgpIHsKICAgICAgLy91cGxvYWQgcGVuZGluZyBsb2dzIGJlZm9yZSB0ZXJtaW5hdGluZy4KICAgICAgc2VsZi5oYW5kbGVTZW5kTG9nc1JlcXVlc3Qoc2VsZi5sb2dzQnVmZmVyKTsKICAgICAgY29ubmVjdC5jb3JlLnRlcm1pbmF0ZSgpOwogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFRCk7CiAgICB9KTsKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU1lOQ0hST05JWkUsIGZ1bmN0aW9uICgpIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFKTsKICAgIH0pOwogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShkYXRhLmV2ZW50LCBkYXRhLmRhdGEpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDYWxsZWQgd2hlbiBhIGNvbnN1bWVyIHBvcnQgY29ubmVjdHMgdG8gdGhpcyBTaGFyZWRXb3JrZXIuCiAgICAgKiBMZXQncyBhZGQgdGhlbSB0byBvdXIgbXVsdGlwbGV4ZXIuCiAgICAgKi8KICAgIGdsb2JhbC5vbmNvbm5lY3QgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgdmFyIHBvcnQgPSBldmVudC5wb3J0c1swXTsKICAgICAgdmFyIHN0cmVhbSA9IG5ldyBjb25uZWN0LlBvcnRTdHJlYW0ocG9ydCk7CiAgICAgIHNlbGYubXVsdGlwbGV4ZXIuYWRkU3RyZWFtKHN0cmVhbSk7CiAgICAgIHBvcnQuc3RhcnQoKTsKCiAgICAgIHZhciBwb3J0Q29uZHVpdCA9IG5ldyBjb25uZWN0LkNvbmR1aXQoc3RyZWFtLmdldElkKCksIG51bGwsIHN0cmVhbSk7CiAgICAgIHBvcnRDb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFLCB7IGlkOiBzdHJlYW0uZ2V0SWQoKSB9KTsKCiAgICAgIHNlbGYucG9ydENvbmR1aXRNYXBbc3RyZWFtLmdldElkKCldID0gcG9ydENvbmR1aXQ7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5VUERBVEVfQ09OTkVDVEVEX0NDUFMsIHsgbGVuZ3RoOiBPYmplY3Qua2V5cyhzZWxmLnBvcnRDb25kdWl0TWFwKS5sZW5ndGggfSk7CgogICAgICBpZiAoc2VsZi5hZ2VudCAhPT0gbnVsbCkgewogICAgICAgIHNlbGYudXBkYXRlQWdlbnQoKTsKICAgICAgfQoKICAgICAgcG9ydENvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9SRVFVRVNULAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBUElSZXF1ZXN0LCBwb3J0Q29uZHVpdCkpOwogICAgICBwb3J0Q29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFUVVFU1QsCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZU1hc3RlclJlcXVlc3QsIHBvcnRDb25kdWl0LCBzdHJlYW0uZ2V0SWQoKSkpOwogICAgICBwb3J0Q29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuUkVMT0FEX0FHRU5UX0NPTkZJR1VSQVRJT04sCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLnBvbGxGb3JBZ2VudENvbmZpZ3VyYXRpb24pKTsKICAgICAgcG9ydENvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNMT1NFLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgc2VsZi5tdWx0aXBsZXhlci5yZW1vdmVTdHJlYW0oc3RyZWFtKTsKICAgICAgICBkZWxldGUgc2VsZi5wb3J0Q29uZHVpdE1hcFtzdHJlYW0uZ2V0SWQoKV07CiAgICAgICAgc2VsZi5tYXN0ZXJDb29yZC5yZW1vdmVNYXN0ZXIoc3RyZWFtLmdldElkKCkpOwogICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5VUERBVEVfQ09OTkVDVEVEX0NDUFMsIHsgbGVuZ3RoOiBPYmplY3Qua2V5cyhzZWxmLnBvcnRDb25kdWl0TWFwKS5sZW5ndGggfSk7CiAgICAgIH0pOwogICAgfTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JBZ2VudCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBvbkF1dGhGYWlsID0gY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfQUdFTlRfU05BUFNIT1QsIHsKICAgICAgbmV4dFRva2VuOiBzZWxmLm5leHRUb2tlbiwKICAgICAgdGltZW91dDogR0VUX0FHRU5UX1RJTUVPVVRfTVMKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2VsZi5hZ2VudCA9IHNlbGYuYWdlbnQgfHwge307CiAgICAgICAgICAgIHNlbGYuYWdlbnQuc25hcHNob3QgPSBkYXRhLnNuYXBzaG90OwogICAgICAgICAgICBzZWxmLmFnZW50LnNuYXBzaG90LmxvY2FsVGltZXN0YW1wID0gY29ubmVjdC5ub3coKTsKICAgICAgICAgICAgc2VsZi5hZ2VudC5zbmFwc2hvdC5za2V3ID0gc2VsZi5hZ2VudC5zbmFwc2hvdC5zbmFwc2hvdFRpbWVzdGFtcCAtIHNlbGYuYWdlbnQuc25hcHNob3QubG9jYWxUaW1lc3RhbXA7CiAgICAgICAgICAgIHNlbGYubmV4dFRva2VuID0gZGF0YS5uZXh0VG9rZW47CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIkdFVF9BR0VOVF9TTkFQU0hPVCBzdWNjZWVkZWQuIikKICAgICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKQogICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICBzZWxmLnVwZGF0ZUFnZW50KCk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkxvbmcgcG9sbCBmYWlsZWQgdG8gdXBkYXRlIGFnZW50LiIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkKICAgICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlKQogICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLnBvbGxGb3JBZ2VudCksIEdFVF9BR0VOVF9TVUNDRVNTX1RJTUVPVVRfTVMpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGdldCBhZ2VudCBkYXRhLiIpCiAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYucG9sbEZvckFnZW50KSwgR0VUX0FHRU5UX1JFQ09WRVJZX1RJTUVPVVRfTVMpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIG9uQXV0aEZhaWwoKTsKICAgICAgICB9LAogICAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKCiAgICAgIH0pOwoKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JBZ2VudENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAocGFyYW1zSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHZhciBvbkF1dGhGYWlsID0gY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfQUdFTlRfQ09ORklHVVJBVElPTiwge30sIHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICB2YXIgY29uZmlndXJhdGlvbiA9IGRhdGEuY29uZmlndXJhdGlvbjsKICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudFBlcm1pc3Npb25zKGNvbmZpZ3VyYXRpb24pOwogICAgICAgIHNlbGYucG9sbEZvckFnZW50U3RhdGVzKGNvbmZpZ3VyYXRpb24pOwogICAgICAgIHNlbGYucG9sbEZvckRpYWxhYmxlQ291bnRyeUNvZGVzKGNvbmZpZ3VyYXRpb24pOwogICAgICAgIHNlbGYucG9sbEZvclJvdXRpbmdQcm9maWxlUXVldWVzKGNvbmZpZ3VyYXRpb24pOwogICAgICAgIGlmIChwYXJhbXMucmVwZWF0Rm9yZXZlcikgewogICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLnBvbGxGb3JBZ2VudENvbmZpZ3VyYXRpb24sIHBhcmFtcyksCiAgICAgICAgICAgIEdFVF9BR0VOVF9DT05GSUdVUkFUSU9OX0lOVEVSVkFMX01TKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICB0cnkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIGFnZW50IGNvbmZpZ3VyYXRpb24gZGF0YS4iKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaWYgKHBhcmFtcy5yZXBlYXRGb3JldmVyKSB7CiAgICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5wb2xsRm9yQWdlbnRDb25maWd1cmF0aW9uKSwKICAgICAgICAgICAgICBHRVRfQUdFTlRfQ09ORklHVVJBVElPTl9JTlRFUlZBTF9NUywgcGFyYW1zKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGF1dGhGYWlsdXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgb25BdXRoRmFpbCgpOwogICAgICB9LAogICAgICBhY2Nlc3NEZW5pZWQ6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpCiAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JBZ2VudFN0YXRlcyA9IGZ1bmN0aW9uIChjb25maWd1cmF0aW9uLCBwYXJhbXNJbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgcGFyYW1zLm1heFJlc3VsdHMgPSBwYXJhbXMubWF4UmVzdWx0cyB8fCBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfQUdFTlRfU1RBVEVTLCB7CiAgICAgIG5leHRUb2tlbjogcGFyYW1zLm5leHRUb2tlbiB8fCBudWxsLAogICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwoKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEubmV4dFRva2VuKSB7CiAgICAgICAgICAgIHNlbGYucG9sbEZvckFnZW50U3RhdGVzKGNvbmZpZ3VyYXRpb24sIHsKICAgICAgICAgICAgICBzdGF0ZXM6IChwYXJhbXMuc3RhdGVzIHx8IFtdKS5jb25jYXQoZGF0YS5zdGF0ZXMpLAogICAgICAgICAgICAgIG5leHRUb2tlbjogZGF0YS5uZXh0VG9rZW4sCiAgICAgICAgICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgICAgICAgICAgfSk7CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uZmlndXJhdGlvbi5hZ2VudFN0YXRlcyA9IChwYXJhbXMuc3RhdGVzIHx8IFtdKS5jb25jYXQoZGF0YS5zdGF0ZXMpOwogICAgICAgICAgICBzZWxmLnVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbihjb25maWd1cmF0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBmZXRjaCBhZ2VudCBzdGF0ZXMgbGlzdC4iKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpLAogICAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKICAgICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yQWdlbnRQZXJtaXNzaW9ucyA9IGZ1bmN0aW9uIChjb25maWd1cmF0aW9uLCBwYXJhbXNJbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgcGFyYW1zLm1heFJlc3VsdHMgPSBwYXJhbXMubWF4UmVzdWx0cyB8fCBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfQUdFTlRfUEVSTUlTU0lPTlMsIHsKICAgICAgbmV4dFRva2VuOiBwYXJhbXMubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCgogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnRQZXJtaXNzaW9ucyhjb25maWd1cmF0aW9uLCB7CiAgICAgICAgICAgICAgcGVybWlzc2lvbnM6IChwYXJhbXMucGVybWlzc2lvbnMgfHwgW10pLmNvbmNhdChkYXRhLnBlcm1pc3Npb25zKSwKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24ucGVybWlzc2lvbnMgPSAocGFyYW1zLnBlcm1pc3Npb25zIHx8IFtdKS5jb25jYXQoZGF0YS5wZXJtaXNzaW9ucyk7CiAgICAgICAgICAgIHNlbGYudXBkYXRlQWdlbnRDb25maWd1cmF0aW9uKGNvbmZpZ3VyYXRpb24pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIGFnZW50IHBlcm1pc3Npb25zIGxpc3QuIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpCiAgICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvckRpYWxhYmxlQ291bnRyeUNvZGVzID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24sIHBhcmFtc0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICBwYXJhbXMubWF4UmVzdWx0cyA9IHBhcmFtcy5tYXhSZXN1bHRzIHx8IGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9ESUFMQUJMRV9DT1VOVFJZX0NPREVTLCB7CiAgICAgIG5leHRUb2tlbjogcGFyYW1zLm5leHRUb2tlbiB8fCBudWxsLAogICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5wb2xsRm9yRGlhbGFibGVDb3VudHJ5Q29kZXMoY29uZmlndXJhdGlvbiwgewogICAgICAgICAgICAgIGNvdW50cnlDb2RlczogKHBhcmFtcy5jb3VudHJ5Q29kZXMgfHwgW10pLmNvbmNhdChkYXRhLmNvdW50cnlDb2RlcyksCiAgICAgICAgICAgICAgbmV4dFRva2VuOiBkYXRhLm5leHRUb2tlbiwKICAgICAgICAgICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgICAgICAgICB9KTsKCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25maWd1cmF0aW9uLmRpYWxhYmxlQ291bnRyaWVzID0gKHBhcmFtcy5jb3VudHJ5Q29kZXMgfHwgW10pLmNvbmNhdChkYXRhLmNvdW50cnlDb2Rlcyk7CiAgICAgICAgICAgIHNlbGYudXBkYXRlQWdlbnRDb25maWd1cmF0aW9uKGNvbmZpZ3VyYXRpb24pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIGRpYWxhYmxlIGNvdW50cnkgY29kZXMgbGlzdC4iKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpLAogICAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKICAgICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yUm91dGluZ1Byb2ZpbGVRdWV1ZXMgPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgcGFyYW1zSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHBhcmFtcy5tYXhSZXN1bHRzID0gcGFyYW1zLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX1JPVVRJTkdfUFJPRklMRV9RVUVVRVMsIHsKICAgICAgcm91dGluZ1Byb2ZpbGVBUk46IGNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucm91dGluZ1Byb2ZpbGVBUk4sCiAgICAgIG5leHRUb2tlbjogcGFyYW1zLm5leHRUb2tlbiB8fCBudWxsLAogICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5wb2xsRm9yUm91dGluZ1Byb2ZpbGVRdWV1ZXMoY29uZmlndXJhdGlvbiwgewogICAgICAgICAgICAgIGNvdW50cnlDb2RlczogKHBhcmFtcy5xdWV1ZXMgfHwgW10pLmNvbmNhdChkYXRhLnF1ZXVlcyksCiAgICAgICAgICAgICAgbmV4dFRva2VuOiBkYXRhLm5leHRUb2tlbiwKICAgICAgICAgICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgICAgICAgICB9KTsKCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnF1ZXVlcyA9IChwYXJhbXMucXVldWVzIHx8IFtdKS5jb25jYXQoZGF0YS5xdWV1ZXMpOwogICAgICAgICAgICBzZWxmLnVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbihjb25maWd1cmF0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBmZXRjaCByb3V0aW5nIHByb2ZpbGUgcXVldWVzIGxpc3QuIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpCiAgICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlQVBJUmVxdWVzdCA9IGZ1bmN0aW9uIChwb3J0Q29uZHVpdCwgcmVxdWVzdCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHRoaXMuY2xpZW50LmNhbGwocmVxdWVzdC5tZXRob2QsIHJlcXVlc3QucGFyYW1zLCB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgdmFyIHJlc3BvbnNlID0gY29ubmVjdC5FdmVudEZhY3RvcnkuY3JlYXRlUmVzcG9uc2UoY29ubmVjdC5FdmVudFR5cGUuQVBJX1JFU1BPTlNFLCByZXF1ZXN0LCBkYXRhKTsKICAgICAgICBwb3J0Q29uZHVpdC5zZW5kRG93bnN0cmVhbShyZXNwb25zZS5ldmVudCwgcmVzcG9uc2UpOwogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgdmFyIHJlc3BvbnNlID0gY29ubmVjdC5FdmVudEZhY3RvcnkuY3JlYXRlUmVzcG9uc2UoY29ubmVjdC5FdmVudFR5cGUuQVBJX1JFU1BPTlNFLCByZXF1ZXN0LCBkYXRhLCBKU09OLnN0cmluZ2lmeShlcnIpKTsKICAgICAgICBwb3J0Q29uZHVpdC5zZW5kRG93bnN0cmVhbShyZXNwb25zZS5ldmVudCwgcmVzcG9uc2UpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIiclcycgQVBJIHJlcXVlc3QgZmFpbGVkIiwgcmVxdWVzdC5tZXRob2QpCiAgICAgICAgICAud2l0aE9iamVjdCh7IHJlcXVlc3Q6IHNlbGYuZmlsdGVyQXV0aFRva2VuKHJlcXVlc3QpLCByZXNwb25zZTogcmVzcG9uc2UgfSkKICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGVycikKICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9LAogICAgICBhdXRoRmFpbHVyZTogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKQogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogSGFuZGxlIGluY29taW5nIG1hc3RlciBxdWVyeSBvciBtb2RpZmljYXRpb24gcmVxdWVzdHMgZnJvbSBjb25uZWN0ZWQgdGFiIHBvcnRzLgogICAqLwogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlTWFzdGVyUmVxdWVzdCA9IGZ1bmN0aW9uIChwb3J0Q29uZHVpdCwgcG9ydElkLCByZXF1ZXN0KSB7CiAgICB2YXIgbXVsdGlwbGV4ZXJDb25kdWl0ID0gdGhpcy5jb25kdWl0OwogICAgdmFyIHJlc3BvbnNlID0gbnVsbDsKCiAgICBzd2l0Y2ggKHJlcXVlc3QubWV0aG9kKSB7CiAgICAgIGNhc2UgY29ubmVjdC5NYXN0ZXJNZXRob2RzLkJFQ09NRV9NQVNURVI6CiAgICAgICAgdmFyIG1hc3RlcklkID0gdGhpcy5tYXN0ZXJDb29yZC5nZXRNYXN0ZXIocmVxdWVzdC5wYXJhbXMudG9waWMpOwogICAgICAgIHZhciB0YWtlT3ZlciA9IEJvb2xlYW4obWFzdGVySWQpICYmIG1hc3RlcklkICE9PSBwb3J0SWQ7CiAgICAgICAgdGhpcy5tYXN0ZXJDb29yZC5zZXRNYXN0ZXIocmVxdWVzdC5wYXJhbXMudG9waWMsIHBvcnRJZCk7CiAgICAgICAgcmVzcG9uc2UgPSBjb25uZWN0LkV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZShjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVTUE9OU0UsIHJlcXVlc3QsIHsKICAgICAgICAgIG1hc3RlcklkOiBwb3J0SWQsCiAgICAgICAgICB0YWtlT3ZlcjogdGFrZU92ZXIsCiAgICAgICAgICB0b3BpYzogcmVxdWVzdC5wYXJhbXMudG9waWMKICAgICAgICB9KTsKICAgICAgICBpZiAodGFrZU92ZXIpIHsKICAgICAgICAgIG11bHRpcGxleGVyQ29uZHVpdC5zZW5kRG93bnN0cmVhbShyZXNwb25zZS5ldmVudCwgcmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgY29ubmVjdC5NYXN0ZXJNZXRob2RzLkNIRUNLX01BU1RFUjoKICAgICAgICB2YXIgbWFzdGVySWQgPSB0aGlzLm1hc3RlckNvb3JkLmdldE1hc3RlcihyZXF1ZXN0LnBhcmFtcy50b3BpYyk7CiAgICAgICAgaWYgKCFtYXN0ZXJJZCAmJiAhcmVxdWVzdC5wYXJhbXMuc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lKSB7CiAgICAgICAgICB0aGlzLm1hc3RlckNvb3JkLnNldE1hc3RlcihyZXF1ZXN0LnBhcmFtcy50b3BpYywgcG9ydElkKTsKICAgICAgICAgIG1hc3RlcklkID0gcG9ydElkOwogICAgICAgIH0KICAgICAgICByZXNwb25zZSA9IGNvbm5lY3QuRXZlbnRGYWN0b3J5LmNyZWF0ZVJlc3BvbnNlKGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVNQT05TRSwgcmVxdWVzdCwgewogICAgICAgICAgbWFzdGVySWQ6IG1hc3RlcklkLAogICAgICAgICAgaXNNYXN0ZXI6IHBvcnRJZCA9PT0gbWFzdGVySWQsCiAgICAgICAgICB0b3BpYzogcmVxdWVzdC5wYXJhbXMudG9waWMKICAgICAgICB9KTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIG1hc3RlciBtZXRob2Q6ICIgKyByZXF1ZXN0Lm1ldGhvZCk7CiAgICB9CgogICAgcG9ydENvbmR1aXQuc2VuZERvd25zdHJlYW0ocmVzcG9uc2UuZXZlbnQsIHJlc3BvbnNlKTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbiA9IGZ1bmN0aW9uIChjb25maWd1cmF0aW9uKSB7CiAgICBpZiAoY29uZmlndXJhdGlvbi5wZXJtaXNzaW9ucyAmJgogICAgICBjb25maWd1cmF0aW9uLmRpYWxhYmxlQ291bnRyaWVzICYmCiAgICAgIGNvbmZpZ3VyYXRpb24uYWdlbnRTdGF0ZXMgJiYKICAgICAgY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5xdWV1ZXMpIHsKCiAgICAgIHRoaXMuYWdlbnQgPSB0aGlzLmFnZW50IHx8IHt9OwogICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24gPSBjb25maWd1cmF0aW9uOwogICAgICB0aGlzLnVwZGF0ZUFnZW50KCk7CgogICAgfSBlbHNlIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiV2FpdGluZyB0byB1cGRhdGUgYWdlbnQgY29uZmlndXJhdGlvbiB1bnRpbCBhbGwgY29uZmlnIGRhdGEgaGFzIGJlZW4gZmV0Y2hlZC4iKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUudXBkYXRlQWdlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIXRoaXMuYWdlbnQpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiV2FpdGluZyB0byB1cGRhdGUgYWdlbnQgdW50aWwgdGhlIGFnZW50IGhhcyBiZWVuIGZ1bGx5IGNvbnN0cnVjdGVkLiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgfSBlbHNlIGlmICghdGhpcy5hZ2VudC5zbmFwc2hvdCkgewogICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJXYWl0aW5nIHRvIHVwZGF0ZSBhZ2VudCB1bnRpbCB0aGUgYWdlbnQgc25hcHNob3QgaXMgYXZhaWxhYmxlLiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgfSBlbHNlIGlmICghdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIldhaXRpbmcgdG8gdXBkYXRlIGFnZW50IHVudGlsIHRoZSBhZ2VudCBjb25maWd1cmF0aW9uIGlzIGF2YWlsYWJsZS4iKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgIH0gZWxzZSB7CiAgICAgIC8vIEFsaWFzIHNvbWUgb2YgdGhlIHByb3BlcnRpZXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogICAgICB0aGlzLmFnZW50LnNuYXBzaG90LnN0YXR1cyA9IHRoaXMuYWdlbnQuc3RhdGU7CgogICAgICAvLyBTb3J0IHRoZSBjb250YWN0cyBvbiB0aGUgdGltZXN0YW1wCiAgICAgIGlmICh0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzICYmIHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMubGVuZ3RoID4gMSkgewogICAgICAgIHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMuc29ydChmdW5jdGlvbiAoY29udGFjdEEsIGNvbnRhY3RCKSB7CiAgICAgICAgICByZXR1cm4gY29udGFjdEEuc3RhdGUudGltZXN0YW1wLmdldFRpbWUoKSAtIGNvbnRhY3RCLnN0YXRlLnRpbWVzdGFtcC5nZXRUaW1lKCk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgIGNvbnRhY3Quc3RhdHVzID0gY29udGFjdC5zdGF0ZTsKCiAgICAgICAgY29udGFjdC5jb25uZWN0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uIChjb25uZWN0aW9uKSB7CiAgICAgICAgICBjb25uZWN0aW9uLmFkZHJlc3MgPSBjb25uZWN0aW9uLmVuZHBvaW50OwogICAgICAgIH0pOwogICAgICB9KTsKCiAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5kZWZhdWx0T3V0Ym91bmRRdWV1ZS5xdWV1ZUlkID0KICAgICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUuZGVmYXVsdE91dGJvdW5kUXVldWUucXVldWVBUk47CiAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5xdWV1ZXMuZm9yRWFjaChmdW5jdGlvbiAocXVldWUpIHsKICAgICAgICBxdWV1ZS5xdWV1ZUlkID0gcXVldWUucXVldWVBUk47CiAgICAgIH0pOwogICAgICB0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICAvL2NvbnRhY3QucXVldWUgaXMgbnVsbCB3aGVuIG1vbml0b3JpbmcKICAgICAgICBpZiAoY29udGFjdC5xdWV1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBjb250YWN0LnF1ZXVlLnF1ZXVlSWQgPSBjb250YWN0LnF1ZXVlLnF1ZXVlQVJOOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5yb3V0aW5nUHJvZmlsZUlkID0KICAgICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucm91dGluZ1Byb2ZpbGVBUk47CiAgICAgIAogICAgICBpZiAodGhpcy5zdXBwcmVzcykgewogICAgICAgIHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMgPSB0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzLmZpbHRlcihmdW5jdGlvbihjb250YWN0KXsKICAgICAgICAgIHJldHVybiAoY29udGFjdC5zdGF0ZS50eXBlID09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5IT0xEIHx8IGNvbnRhY3Quc3RhdGUudHlwZSA9PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuQ09OTkVDVEVEKTsKICAgICAgICB9KTsKICAgICAgICBpZiAodGhpcy5mb3JjZU9mZmxpbmUpIHsKICAgICAgICAgIHRoaXMuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuRk9SQ0VfT0ZGTElORSk7CiAgICAgICAgfQogICAgICB9IAogICAgICB0aGlzLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5BZ2VudEV2ZW50cy5VUERBVEUsIHRoaXMuYWdlbnQpOwogICAgfQogIH07CgovKioKICogUHJvdmlkZXMgYSB3ZWJzb2NrZXQgdXJsIHRocm91Z2ggdGhlIGNyZWF0ZV90cmFuc3BvcnQgQVBJLgogKiBAcmV0dXJucyBhIHByb21pc2Ugd2hpY2gsIHVwb24gc3VjY2VzcywgcmV0dXJucyB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgY3JlYXRlVHJhbnNwb3J0IEFQSS4KICovCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5nZXRXZWJTb2NrZXRVcmwgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIG9uQXV0aEZhaWwgPSBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpOwogICAgdmFyIG9uQWNjZXNzRGVuaWVkID0gY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX1RSQU5TUE9SVCwgeyB0cmFuc3BvcnRUeXBlOiBjb25uZWN0LlRSQU5TUE9SVF9UWVBFUy5XRUJfU09DS0VUIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXRXZWJTb2NrZXRVcmwgc3VjY2VlZGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJnZXRXZWJTb2NrZXRVcmwgZmFpbGVkIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICByZWplY3QoewogICAgICAgICAgICByZWFzb246ICdnZXRXZWJTb2NrZXRVcmwgZmFpbGVkJywgCiAgICAgICAgICAgIF9kZWJ1ZzogZXJyCiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJnZXRXZWJTb2NrZXRVcmwgQXV0aCBGYWlsdXJlIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlamVjdChFcnJvcigiQXV0aGVudGljYXRpb24gZmFpbGVkIHdoaWxlIGdldHRpbmcgZ2V0V2ViU29ja2V0VXJsIikpOwogICAgICAgICAgb25BdXRoRmFpbCgpOwogICAgICAgIH0sCiAgICAgICAgYWNjZXNzRGVuaWVkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJnZXRXZWJTb2NrZXRVcmwgQWNjZXNzIERlbmllZCBGYWlsdXJlIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlamVjdChFcnJvcigiQWNjZXNzIERlbmllZCBGYWlsdXJlIHdoaWxlIGdldHRpbmcgZ2V0V2ViU29ja2V0VXJsIikpOwogICAgICAgICAgb25BY2Nlc3NEZW5pZWQoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCgogIC8qKgogICAgKiBTZW5kIGEgbWVzc2FnZSBkb3duc3RyZWFtIHRvIGFsbCBjb25zdW1lcnMgd2hlbiB3ZSBkZXRlY3QgdGhhdCBhdXRoZW50aWNhdGlvbgogICAgKiBhZ2FpbnN0IG9uZSBvZiBvdXIgQVBJcyBoYXMgZmFpbGVkLgogICAgKi8KICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZVNlbmRMb2dzUmVxdWVzdCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBsb2dFdmVudHMgPSBbXTsKICAgIHZhciBsb2dzVG9TZW5kID0gc2VsZi5sb2dzQnVmZmVyLnNsaWNlKCk7CiAgICBzZWxmLmxvZ3NCdWZmZXIgPSBbXTsKICAgIGxvZ3NUb1NlbmQuZm9yRWFjaChmdW5jdGlvbiAobG9nKSB7CiAgICAgIGxvZ0V2ZW50cy5wdXNoKHsKICAgICAgICB0aW1lc3RhbXA6IGxvZy50aW1lLAogICAgICAgIGNvbXBvbmVudDogbG9nLmNvbXBvbmVudCwKICAgICAgICBtZXNzYWdlOiBsb2cudGV4dAogICAgICB9KTsKICAgIH0pOwogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuU0VORF9DTElFTlRfTE9HUywgeyBsb2dFdmVudHM6IGxvZ0V2ZW50cyB9LCB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJTZW5kTG9ncyByZXF1ZXN0IHN1Y2NlZWRlZC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiU2VuZExvZ3MgcmVxdWVzdCBmYWlsZWQuIikKICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpLndpdGhFeGNlcHRpb24oZXJyKQogICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0sCiAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpCiAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZUF1dGhGYWlsID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhfRkFJTCk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVBY2Nlc3NEZW5pZWQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNDRVNTX0RFTklFRCk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5jaGVja0F1dGhUb2tlbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBleHBpcmF0aW9uRGF0ZSA9IG5ldyBEYXRlKHNlbGYuaW5pdERhdGEuYXV0aFRva2VuRXhwaXJhdGlvbik7CiAgICB2YXIgY3VycmVudFRpbWVTdGFtcCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgdmFyIHRoaXJ0eU1pbnMgPSAzMCAqIDYwICogMTAwMDsKCiAgICAvLyByZWZyZXNoIHRva2VuIDMwIG1pbnV0ZXMgYmVmb3JlIGV4cGlyYXRpb24KICAgIGlmIChleHBpcmF0aW9uRGF0ZS5nZXRUaW1lKCkgPCAoY3VycmVudFRpbWVTdGFtcCArIHRoaXJ0eU1pbnMpKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQXV0aCB0b2tlbiBleHBpcmVzIGF0ICIgKyBleHBpcmF0aW9uRGF0ZSArICIgU3RhcnQgcmVmcmVzaGluZyB0b2tlbiB3aXRoIHJldHJ5LiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbm5lY3QuYmFja29mZihjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuYXV0aG9yaXplKSwgUkVGUkVTSF9BVVRIX1RPS0VOX0lOVEVSVkFMX01TLCBSRUZSRVNIX0FVVEhfVE9LRU5fTUFYX1RSWSk7CiAgICB9CiAgfTsKCgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuYXV0aG9yaXplID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgY29ubmVjdC5jb3JlLmF1dGhvcml6ZSh0aGlzLmluaXREYXRhLmF1dGhvcml6ZUVuZHBvaW50KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICB2YXIgZXhwaXJhdGlvbiA9IG5ldyBEYXRlKHJlc3BvbnNlLmV4cGlyYXRpb24pOwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkF1dGhvcml6YXRpb24gc3VjY2VlZGVkIGFuZCB0aGUgdG9rZW4gZXhwaXJlcyBhdCAlcyIsIGV4cGlyYXRpb24pCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHNlbGYuaW5pdERhdGEuYXV0aFRva2VuID0gcmVzcG9uc2UuYWNjZXNzVG9rZW47CiAgICAgIHNlbGYuaW5pdERhdGEuYXV0aFRva2VuRXhwaXJhdGlvbiA9IGV4cGlyYXRpb247CiAgICAgIGNvbm5lY3QuY29yZS5pbml0Q2xpZW50KHNlbGYuaW5pdERhdGEpOwogICAgICBjb25uZWN0LmNvcmUuaW5pdEFnZW50QXBwQ2xpZW50KHNlbGYuaW5pdERhdGEpOwogICAgICBjYWxsYmFja3Muc3VjY2VzcygpOwogICAgfSkuY2F0Y2goZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkF1dGhvcml6YXRpb24gZmFpbGVkIHdpdGggY29kZSAlcyIsIHJlc3BvbnNlLnN0YXR1cykKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gNDAxKSB7CiAgICAgICAgc2VsZi5oYW5kbGVBdXRoRmFpbCgpOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKCk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIC8qKgogICAqIEZpbHRlciB0aGUgJ2F1dGhlbnRpY2F0aW9uJyBmaWVsZCBvZiB0aGUgcmVxdWVzdCBwYXJhbXMgZnJvbSB0aGUgZ2l2ZW4gQVBJX1JFUVVFU1QgZXZlbnQuCiAgICovCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5maWx0ZXJBdXRoVG9rZW4gPSBmdW5jdGlvbiAocmVxdWVzdCkgewogICAgdmFyIG5ld19yZXF1ZXN0ID0ge307CgogICAgZm9yICh2YXIga2V5QSBpbiByZXF1ZXN0KSB7CiAgICAgIGlmIChrZXlBID09PSAncGFyYW1zJykgewogICAgICAgIHZhciBuZXdfcGFyYW1zID0ge307CiAgICAgICAgZm9yICh2YXIga2V5QiBpbiByZXF1ZXN0LnBhcmFtcykgewogICAgICAgICAgaWYgKGtleUIgIT09ICdhdXRoZW50aWNhdGlvbicpIHsKICAgICAgICAgICAgbmV3X3BhcmFtc1trZXlCXSA9IHJlcXVlc3QucGFyYW1zW2tleUJdOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbmV3X3JlcXVlc3QucGFyYW1zID0gbmV3X3BhcmFtczsKICAgICAgfSBlbHNlIHsKICAgICAgICBuZXdfcmVxdWVzdFtrZXlBXSA9IHJlcXVlc3Rba2V5QV07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbmV3X3JlcXVlc3Q7CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3Qud29ya2VyLm1haW4gPSBmdW5jdGlvbiAoKSB7CiAgICBjb25uZWN0Lndvcmtlci5jbGllbnRFbmdpbmUgPSBuZXcgQ2xpZW50RW5naW5lKCk7CiAgfTsKCn0pKCk7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBbWF6b24gU29mdHdhcmUgTGljZW5zZSAodGhlICJMaWNlbnNlIikuIFlvdSBtYXkgbm90IHVzZQogKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzCiAqIGxvY2F0ZWQgYXQKICoKICogICAgaHR0cDovL2F3cy5hbWF6b24uY29tL2FzbC8KICoKICogb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZAogKiBvbiBhbiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcwogKiBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMKICogYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKi8KCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKCiAgY29ubmVjdC5DaGF0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKG1lZGlhSW5mbywgbWV0YWRhdGEpIHsKICAgIHZhciBsb2dnZXIgPSBjb25uZWN0LmdldExvZygpOwogICAgdmFyIGxvZ0NvbXBvbmVudCA9IGNvbm5lY3QuTG9nQ29tcG9uZW50LkNIQVQ7CgogICAgdmFyIGNyZWF0ZU1lZGlhSW5zdGFuY2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBtZWRpYSBjb250cm9sbGVyIGluaXQiLCBtZWRpYUluZm8uY29udGFjdElkKTsKICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAiQ2hhdCBtZWRpYSBjb250cm9sbGVyIGluaXQiKQogICAgICAgIC53aXRoT2JqZWN0KG1lZGlhSW5mbykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICAgIGNvbm5lY3QuQ2hhdFNlc3Npb24uc2V0R2xvYmFsQ29uZmlnKHsKICAgICAgICBsb2dnZXJDb25maWc6IHsKICAgICAgICAgIGxvZ2dlcjogbG9nZ2VyCiAgICAgICAgfSwKICAgICAgICByZWdpb246IG1ldGFkYXRhLnJlZ2lvbgogICAgICB9KTsKCiAgICAgIC8qKiBDb3VsZCBiZSBhbHNvIENVU1RPTUVSIC0gIEZvciBub3cgd2UgYXJlIGNyZWF0aW5nIG9ubHkgQWdlbnQgY29ubmVjdGlvbiBtZWRpYSBvYmplY3QgKi8KICAgICAgdmFyIGNvbnRyb2xsZXIgPSBjb25uZWN0LkNoYXRTZXNzaW9uLmNyZWF0ZSh7CiAgICAgICAgY2hhdERldGFpbHM6IG1lZGlhSW5mbywKICAgICAgICB0eXBlOiAiQUdFTlQiLAogICAgICAgIHdlYnNvY2tldE1hbmFnZXI6IGNvbm5lY3QuY29yZS5nZXRXZWJTb2NrZXRNYW5hZ2VyKCkKICAgICAgfSk7CiAgICAgIAogICAgICB0cmFja0NoYXRDb25uZWN0aW9uU3RhdHVzKGNvbnRyb2xsZXIpOwogICAgICByZXR1cm4gY29udHJvbGxlcgogICAgICAgIC5jb25uZWN0KCkKICAgICAgICAudGhlbihmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAiQ2hhdCBTZXNzaW9uIFN1Y2Nlc3NmdWxseSBlc3RhYmxpc2hlZCBmb3IgY29udGFjdElkICVzIiwgbWVkaWFJbmZvLmNvbnRhY3RJZCkKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgU2Vzc2lvbiBTdWNjZXNzZnVsbHkgZXN0YWJsaXNoZWQiLCBtZWRpYUluZm8uY29udGFjdElkKTsKICAgICAgICAgIHJldHVybiBjb250cm9sbGVyOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgbG9nZ2VyLmVycm9yKGxvZ0NvbXBvbmVudCwgIkNoYXQgU2Vzc2lvbiBlc3RhYmxpc2hlbWVudCBmYWlsZWQgZm9yIGNvbnRhY3QgJXMiLCBtZWRpYUluZm8uY29udGFjdElkKQogICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlcnJvcikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBTZXNzaW9uIGVzdGFibGlzaGVtZW50IGZhaWxlZCIsIG1lZGlhSW5mby5jb250YWN0SWQsIGVycm9yKTsKICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgIH0pOwogICAgfTsKCiAgICB2YXIgcHVibGlzaFRlbGVtZXRyeUV2ZW50ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgZGF0YSkgewogICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgIG5hbWU6IGV2ZW50TmFtZSwKICAgICAgICBjb250YWN0SWQ6IG1lZGlhSW5mby5jb250YWN0SWQsCiAgICAgICAgZGF0YTogZGF0YSB8fCBtZWRpYUluZm8KICAgICAgfSk7CiAgICB9OwoKICAgIHZhciB0cmFja0NoYXRDb25uZWN0aW9uU3RhdHVzID0gZnVuY3Rpb24gKGNvbnRyb2xsZXIpIHsKICAgICAgY29udHJvbGxlci5vbkNvbm5lY3Rpb25Ccm9rZW4oZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBsb2dnZXIuZXJyb3IobG9nQ29tcG9uZW50LCAiQ2hhdCBTZXNzaW9uIGNvbm5lY3Rpb24gYnJva2VuIikKICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDaGF0IFNlc3Npb24gY29ubmVjdGlvbiBicm9rZW4iLCBkYXRhKTsKICAgICAgfSk7CgogICAgICBjb250cm9sbGVyLm9uQ29ubmVjdGlvbkVzdGFibGlzaGVkKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAiQ2hhdCBTZXNzaW9uIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQiKQogICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgU2Vzc2lvbiBjb25uZWN0aW9uIGVzdGFibGlzaGVkIiwgZGF0YSk7CiAgICAgIH0pOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjcmVhdGVNZWRpYUluc3RhbmNlKCk7CiAgICAgIH0KICAgIH0KICB9Cn0pKCk7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBbWF6b24gU29mdHdhcmUgTGljZW5zZSAodGhlICJMaWNlbnNlIikuIFlvdSBtYXkgbm90IHVzZQogKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzCiAqIGxvY2F0ZWQgYXQKICoKICogICAgaHR0cDovL2F3cy5hbWF6b24uY29tL2FzbC8KICoKICogb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZAogKiBvbiBhbiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcwogKiBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMKICogYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKi8KCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKCiAgY29ubmVjdC5NZWRpYUZhY3RvcnkgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICAvKiogY29udHJvbGxlciBob2xkZXIgKi8KICAgIHZhciBtZWRpYUNvbnRyb2xsZXJzID0ge307CiAgICB2YXIgdG9CZURlc3Ryb3llZCA9IG5ldyBTZXQoKTsKCiAgICB2YXIgbG9nZ2VyID0gY29ubmVjdC5nZXRMb2coKTsKICAgIHZhciBsb2dDb21wb25lbnQgPSBjb25uZWN0LkxvZ0NvbXBvbmVudC5DSEFUOwoKICAgIHZhciBtZXRhZGF0YSA9IGNvbm5lY3QubWVyZ2Uoe30sIHBhcmFtcykgfHwge307CiAgICBtZXRhZGF0YS5yZWdpb24gPSAgbWV0YWRhdGEucmVnaW9uIHx8ICJ1cy13ZXN0LTIiOyAvLyBEZWZhdWx0IGl0IHRvIHVzLXdlc3QtMgoKICAgIHZhciBnZXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoY29ubmVjdGlvbk9iaikgewogICAgICB2YXIgY29ubmVjdGlvbklkID0gY29ubmVjdGlvbk9iai5nZXRDb25uZWN0aW9uSWQoKTsKICAgICAgdmFyIG1lZGlhSW5mbyA9IGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFJbmZvKCk7CiAgICAgIC8qKiBpZiB3ZSBkbyBub3QgaGF2ZSB0aGUgbWVkaWEgaW5mbyB0aGVuIGp1c3QgcmVqZWN0IHRoZSByZXF1ZXN0ICovCiAgICAgIGlmICghbWVkaWFJbmZvKSB7CiAgICAgICAgbG9nZ2VyLmVycm9yKGxvZ0NvbXBvbmVudCwgIk1lZGlhIGluZm8gZG9lcyBub3QgZXhpc3QgZm9yIGEgbWVkaWEgdHlwZSAlcyIsIGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFUeXBlKCkpCiAgICAgICAgICAud2l0aE9iamVjdChjb25uZWN0aW9uT2JqKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgiTWVkaWEgaW5mbyBkb2VzIG5vdCBleGlzdCBmb3IgdGhpcyBjb25uZWN0aW9uIik7CiAgICAgIH0KCiAgICAgIGlmICghbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdKSB7CiAgICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAibWVkaWEgY29udHJvbGxlciBvZiB0eXBlICVzIGluaXQiLCBjb25uZWN0aW9uT2JqLmdldE1lZGlhVHlwZSgpKQogICAgICAgICAgLndpdGhPYmplY3QoY29ubmVjdGlvbk9iaikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBzd2l0Y2ggKGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFUeXBlKCkpIHsKICAgICAgICAgIGNhc2UgY29ubmVjdC5NZWRpYVR5cGUuQ0hBVDoKICAgICAgICAgICAgcmV0dXJuIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXSA9IG5ldyBjb25uZWN0LkNoYXRNZWRpYUNvbnRyb2xsZXIoY29ubmVjdGlvbk9iai5nZXRNZWRpYUluZm8oKSwgbWV0YWRhdGEpLmdldCgpOwogICAgICAgICAgY2FzZSBjb25uZWN0Lk1lZGlhVHlwZS5TT0ZUUEhPTkU6CiAgICAgICAgICAgIHJldHVybiBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0gPSBuZXcgY29ubmVjdC5Tb2Z0cGhvbmVNZWRpYUNvbnRyb2xsZXIoY29ubmVjdGlvbk9iai5nZXRNZWRpYUluZm8oKSkuZ2V0KCk7CiAgICAgICAgICBjYXNlIGNvbm5lY3QuTWVkaWFUeXBlLlRBU0s6CiAgICAgICAgICAgIHJldHVybiBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0gPSBuZXcgY29ubmVjdC5UYXNrTWVkaWFDb250cm9sbGVyKGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFJbmZvKCkpLmdldCgpOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGxvZ0NvbXBvbmVudCwgIlVucmVjb2duaXplZCBtZWRpYSB0eXBlICVzICIsIGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFUeXBlKCkpCiAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdOwogICAgICB9CiAgICB9OwoKICAgIC8qKiBDaGVjayBhbGwgdGhlIGFjdGl2ZSBzdGF0ZXMgZm9yIHRoZSBjb25uZWN0aW9uICovCiAgICB2YXIgaWZDb25uZWN0aW9uQWN0aXZlID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25PYmopIHsKICAgICAgcmV0dXJuIGNvbm5lY3Rpb25PYmouaXNBY3RpdmUoKTsKICAgIH07CgogICAgdmFyIGdldCA9IGZ1bmN0aW9uIChjb25uZWN0aW9uT2JqKSB7CiAgICAgIGlmIChpZkNvbm5lY3Rpb25BY3RpdmUoY29ubmVjdGlvbk9iaikpIHsKICAgICAgICByZXR1cm4gZ2V0TWVkaWFDb250cm9sbGVyKGNvbm5lY3Rpb25PYmopOwogICAgICB9IGVsc2UgewogICAgICAgIGRlc3Ryb3koY29ubmVjdGlvbk9iai5nZXRDb25uZWN0aW9uSWQoKSk7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJNZWRpYSBDb250cm9sbGVyIGlzIG5vIGxvbmdlciBhdmFpbGFibGUgZm9yIHRoaXMgY29ubmVjdGlvbiIpOwogICAgICB9CiAgICB9OwoKICAgIHZhciBkZXN0cm95ID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25JZCkgewogICAgICBpZiAobWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdICYmICF0b0JlRGVzdHJveWVkLmhhcyhjb25uZWN0aW9uSWQpKSB7CiAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICBsb2dDb21wb25lbnQsCiAgICAgICAgICAiRGVzdHJveWluZyBtZWRpYUNvbnRyb2xsZXIgZm9yICVzIiwKICAgICAgICAgIGNvbm5lY3Rpb25JZAogICAgICAgICk7CiAgICAgICAgdG9CZURlc3Ryb3llZC5hZGQoY29ubmVjdGlvbklkKTsKICAgICAgICBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0KICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRyb2xsZXIuY2xlYW5VcCA9PT0gImZ1bmN0aW9uIikgY29udHJvbGxlci5jbGVhblVwKCk7CiAgICAgICAgICAgIGRlbGV0ZSBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF07CiAgICAgICAgICAgIHRvQmVEZXN0cm95ZWQuZGVsZXRlKGNvbm5lY3Rpb25JZCk7CiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBkZWxldGUgbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdOwogICAgICAgICAgICB0b0JlRGVzdHJveWVkLmRlbGV0ZShjb25uZWN0aW9uSWQpOwogICAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIHsKICAgICAgZ2V0OiBnZXQsCiAgICAgIGRlc3Ryb3k6IGRlc3Ryb3kKICAgIH07CiAgfQp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQW1hem9uIFNvZnR3YXJlIExpY2Vuc2UgKHRoZSAiTGljZW5zZSIpLiBZb3UgbWF5IG5vdCB1c2UKICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcwogKiBsb2NhdGVkIGF0CiAqCiAqICAgIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hc2wvCiAqCiAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQKICogb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3MKICogb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zCiAqIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIC8vIFRPRE8gbW92ZSBzb2Z0cGhvbmUgaW1wbGVtZW50YXRpb25zIGhlcmUgLSBXaWwgZG8gdGhpcyBmb3IgR0EKICBjb25uZWN0LlNvZnRwaG9uZU1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uIChtZWRpYUluZm8pIHsKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobWVkaWFJbmZvKQogICAgICB9CiAgICB9CiAgfQp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQW1hem9uIFNvZnR3YXJlIExpY2Vuc2UgKHRoZSAiTGljZW5zZSIpLiBZb3UgbWF5IG5vdCB1c2UKICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcwogKiBsb2NhdGVkIGF0CiAqCiAqICAgIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hc2wvCiAqCiAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQKICogb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3MKICogb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zCiAqIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIGNvbm5lY3QuVGFza01lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uIChtZWRpYUluZm8pIHsKICAgIHZhciBsb2dnZXIgPSBjb25uZWN0LmdldExvZygpOwogICAgdmFyIGxvZ0NvbXBvbmVudCA9IGNvbm5lY3QuTG9nQ29tcG9uZW50LlRBU0s7CgogICAgdmFyIGNyZWF0ZU1lZGlhSW5zdGFuY2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiVGFzayBtZWRpYSBjb250cm9sbGVyIGluaXQiLCBtZWRpYUluZm8uY29udGFjdElkKTsKICAgICAgbG9nZ2VyCiAgICAgICAgLmluZm8obG9nQ29tcG9uZW50LCAiVGFzayBtZWRpYSBjb250cm9sbGVyIGluaXQiKQogICAgICAgIC53aXRoT2JqZWN0KG1lZGlhSW5mbyk7CgogICAgICB2YXIgY29udHJvbGxlciA9IGNvbm5lY3QuVGFza1Nlc3Npb24uY3JlYXRlKHsKICAgICAgICBjb250YWN0SWQ6IG1lZGlhSW5mby5jb250YWN0SWQsCiAgICAgICAgaW5pdGlhbENvbnRhY3RJZDogbWVkaWFJbmZvLmluaXRpYWxDb250YWN0SWQsCiAgICAgICAgd2Vic29ja2V0TWFuYWdlcjogY29ubmVjdC5jb3JlLmdldFdlYlNvY2tldE1hbmFnZXIoKSwKICAgICAgfSk7CgogICAgICB0cmFja1Rhc2tDb25uZWN0aW9uU3RhdHVzKGNvbnRyb2xsZXIpOwoKICAgICAgcmV0dXJuIGNvbnRyb2xsZXIKICAgICAgICAuY29ubmVjdCgpCiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICAgIGxvZ0NvbXBvbmVudCwKICAgICAgICAgICAgIlRhc2sgU2Vzc2lvbiBTdWNjZXNzZnVsbHkgZXN0YWJsaXNoZWQgZm9yIGNvbnRhY3RJZCAlcyIsCiAgICAgICAgICAgIG1lZGlhSW5mby5jb250YWN0SWQKICAgICAgICAgICk7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoCiAgICAgICAgICAgICJUYXNrIFNlc3Npb24gU3VjY2Vzc2Z1bGx5IGVzdGFibGlzaGVkIiwKICAgICAgICAgICAgbWVkaWFJbmZvLmNvbnRhY3RJZAogICAgICAgICAgKTsKICAgICAgICAgIHJldHVybiBjb250cm9sbGVyOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgbG9nZ2VyCiAgICAgICAgICAgIC5lcnJvcigKICAgICAgICAgICAgICBsb2dDb21wb25lbnQsCiAgICAgICAgICAgICAgIlRhc2sgU2Vzc2lvbiBlc3RhYmxpc2hlbWVudCBmYWlsZWQgZm9yIGNvbnRhY3QgJXMiLAogICAgICAgICAgICAgIG1lZGlhSW5mby5jb250YWN0SWQKICAgICAgICAgICAgKQogICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlcnJvcik7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoCiAgICAgICAgICAgICJDaGF0IFNlc3Npb24gZXN0YWJsaXNoZW1lbnQgZmFpbGVkIiwKICAgICAgICAgICAgbWVkaWFJbmZvLmNvbnRhY3RJZCwKICAgICAgICAgICAgZXJyb3IKICAgICAgICAgICk7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9KTsKICAgIH07CgogICAgdmFyIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGRhdGEpIHsKICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICBuYW1lOiBldmVudE5hbWUsCiAgICAgICAgY29udGFjdElkOiBtZWRpYUluZm8uY29udGFjdElkLAogICAgICAgIGRhdGE6IGRhdGEgfHwgbWVkaWFJbmZvLAogICAgICB9KTsKICAgIH07CgogICAgdmFyIHRyYWNrVGFza0Nvbm5lY3Rpb25TdGF0dXMgPSBmdW5jdGlvbiAoY29udHJvbGxlcikgewogICAgICBjb250cm9sbGVyLm9uQ29ubmVjdGlvbkJyb2tlbihmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGxvZ2dlcgogICAgICAgICAgLmVycm9yKGxvZ0NvbXBvbmVudCwgIlRhc2sgU2Vzc2lvbiBjb25uZWN0aW9uIGJyb2tlbiIpCiAgICAgICAgICAud2l0aEV4Y2VwdGlvbihkYXRhKTsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlRhc2sgU2Vzc2lvbiBjb25uZWN0aW9uIGJyb2tlbiIsIGRhdGEpOwogICAgICB9KTsKCiAgICAgIGNvbnRyb2xsZXIub25Db25uZWN0aW9uRXN0YWJsaXNoZWQoZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBsb2dnZXIKICAgICAgICAgIC5pbmZvKGxvZ0NvbXBvbmVudCwgIlRhc2sgU2Vzc2lvbiBjb25uZWN0aW9uIGVzdGFibGlzaGVkIikKICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpOwogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiVGFzayBTZXNzaW9uIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQiLCBkYXRhKTsKICAgICAgfSk7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjcmVhdGVNZWRpYUluc3RhbmNlKCk7CiAgICAgIH0sCiAgICB9OwogIH07Cn0pKCk7CgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICBjb25uZWN0LmFnZW50QXBwID0ge307CgogIHZhciBBUFAgPSB7CiAgICBDQ1A6ICdjY3AnLAogIH07CgogIGNvbm5lY3QuYWdlbnRBcHAuaW5pdENDUCA9IGNvbm5lY3QuY29yZS5pbml0Q0NQOwogIGNvbm5lY3QuYWdlbnRBcHAuaXNJbml0aWFsaXplZCA9IGZ1bmN0aW9uIChpbnN0YW5jZUFsaWFzKSB7fTsKCiAgY29ubmVjdC5hZ2VudEFwcC5pbml0QXBwQ29tbXVuaWNhdGlvbiA9IGZ1bmN0aW9uIChpZnJhbWVJZCwgZW5kcG9pbnQpIHsKICAgIHZhciBpZnJhbWUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZnJhbWVJZCk7CiAgICB2YXIgaWZyYW1lQ29uZHVpdCA9IG5ldyBjb25uZWN0LklGcmFtZUNvbmR1aXQoZW5kcG9pbnQsIHdpbmRvdywgaWZyYW1lKTsKICAgIHZhciBCUk9BRENBU1RfVFlQRSA9IFtjb25uZWN0LkFnZW50RXZlbnRzLlVQREFURSwgY29ubmVjdC5Db250YWN0RXZlbnRzLlZJRVcsIGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFLCBjb25uZWN0LkV2ZW50VHlwZS5URVJNSU5BVEVEXTsKICAgIGlmcmFtZS5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgZnVuY3Rpb24gKGUpIHsKICAgICAgQlJPQURDQVNUX1RZUEUuZm9yRWFjaChmdW5jdGlvbiAodHlwZSkgewogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0odHlwZSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmcmFtZUNvbmR1aXQuc2VuZFVwc3RyZWFtKHR5cGUsIGRhdGEpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIHZhciBnZXRDb25uZWN0VXJsID0gZnVuY3Rpb24gKGNjcFVybCkgewogICAgdmFyIHBvcyA9IGNjcFVybC5pbmRleE9mKCdjY3AtdjInKTsKICAgIHJldHVybiBjY3BVcmwuc2xpY2UoMCwgcG9zIC0gMSk7CiAgfTsKCiAgdmFyIHNpZ25PdXRUaHJvdWdoQ0NQID0gZnVuY3Rpb24gKGNjcFVybCkgewogICAgdmFyIGxvZ291dFVybCA9IGdldENvbm5lY3RVcmwoY2NwVXJsKSArICcvbG9nb3V0JzsKICAgIHJldHVybiBjb25uZWN0LmZldGNoKGxvZ291dFVybCwgewogICAgICBjcmVkZW50aWFsczogJ2luY2x1ZGUnLAogICAgfSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBldmVudEJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgICBldmVudEJ1cy50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSkuY2F0Y2goZnVuY3Rpb24gKGUpIHsKICAgICAgY29ubmVjdAogICAgICAgIC5nZXRMb2coKQogICAgICAgIC5lcnJvcignQW4gZXJyb3Igb2NjdXJlZCBvbiBsb2dvdXQuJyArIGUpCiAgICAgICAgLndpdGhFeGNlcHRpb24oZSk7CiAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gbG9nb3V0VXJsOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9KTsKICB9OwoKICB2YXIgc2lnbkluVGhyb3VnaGluaXRDQ1AgPSBmdW5jdGlvbiAoY2NwVXJsLCBjb250YWluZXIsIGNvbmZpZykgewogICAgdmFyIGRlZmF1bHRQYXJhbXMgPSB7CiAgICAgIGNjcFVybDogY2NwVXJsLAogICAgICBjY3BMb2FkVGltZW91dDogMTAwMDAsCiAgICAgIGxvZ2luUG9wdXA6IHRydWUsCiAgICAgIGxvZ2luVXJsOiBnZXRDb25uZWN0VXJsKGNjcFVybCkgKyAnL2xvZ2luJywKICAgICAgc29mdHBob25lOiB7CiAgICAgICAgYWxsb3dGcmFtZWRTb2Z0cGhvbmU6IHRydWUsCiAgICAgICAgZGlzYWJsZVJpbmd0b25lOiBmYWxzZSwKICAgICAgfQogICAgfTsKICAgIHZhciBjY3BQYXJhbXMgPSBjb25uZWN0Lm1lcmdlKGRlZmF1bHRQYXJhbXMsIGNvbmZpZy5jY3BQYXJhbXMpOwogICAgY29ubmVjdC5jb3JlLmluaXRDQ1AoY29udGFpbmVyLCBjY3BQYXJhbXMpOwogIH07CgogIGNvbm5lY3QuYWdlbnRBcHAuaW5pdEFwcCA9IGZ1bmN0aW9uIChuYW1lLCBjb250YWluZXJJZCwgYXBwVXJsLCBjb25maWcpIHsKICAgIGNvbmZpZyA9IGNvbmZpZyA/IGNvbmZpZyA6IHt9OwogICAgdmFyIGVuZHBvaW50ID0gYXBwVXJsLmVuZHNXaXRoKCcvJykgPyBhcHBVcmwgOiBhcHBVcmwgKyAnLyc7CiAgICB2YXIgcmVnaXN0ZXJDb25maWcgPSB7IGVuZHBvaW50OiBlbmRwb2ludCwgc3R5bGU6IGNvbmZpZy5zdHlsZSB9OwogICAgY29ubmVjdC5hZ2VudEFwcC5BcHBSZWdpc3RyeS5yZWdpc3RlcihuYW1lLCByZWdpc3RlckNvbmZpZywgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY29udGFpbmVySWQpKTsKICAgIGNvbm5lY3QuYWdlbnRBcHAuQXBwUmVnaXN0cnkuc3RhcnQobmFtZSwgZnVuY3Rpb24gKG1vZHVsZURhdGEpIHsKICAgICAgdmFyIGVuZHBvaW50ID0gbW9kdWxlRGF0YS5lbmRwb2ludDsKICAgICAgdmFyIGNvbnRhaW5lckRPTSA9IG1vZHVsZURhdGEuY29udGFpbmVyRE9NOwogICAgICByZXR1cm4gewogICAgICAgIGluaXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChuYW1lID09PSBBUFAuQ0NQKSByZXR1cm4gc2lnbkluVGhyb3VnaGluaXRDQ1AoZW5kcG9pbnQsIGNvbnRhaW5lckRPTSwgY29uZmlnKTsKICAgICAgICAgIHJldHVybiBjb25uZWN0LmFnZW50QXBwLmluaXRBcHBDb21tdW5pY2F0aW9uKG5hbWUsIGVuZHBvaW50KTsKICAgICAgICB9LAogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChuYW1lID09PSBBUFAuQ0NQKSByZXR1cm4gc2lnbk91dFRocm91Z2hDQ1AoZW5kcG9pbnQpOwogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICB9OwogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5hZ2VudEFwcC5zdG9wQXBwID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgIHJldHVybiBjb25uZWN0LmFnZW50QXBwLkFwcFJlZ2lzdHJ5LnN0b3AobmFtZSk7CiAgfTsKfSkoKTsKCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKCiAgdmFyIEFQUCA9IHsKICAgIENDUDogJ2NjcCcsCiAgfTsKCiAgZnVuY3Rpb24gQXBwUmVnaXN0cnkoKSB7CiAgICB2YXIgbW9kdWxlRGF0YSA9IHt9OwogICAgdmFyIG1ha2VBcHBJZnJhbWUgPSBmdW5jdGlvbiAoYXBwTmFtZSwgZW5kcG9pbnQsIHN0eWxlKSB7CiAgICAgIHZhciBpZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpZnJhbWUnKTsKICAgICAgaWZyYW1lLnNyYyA9IGVuZHBvaW50OwogICAgICBpZnJhbWUuc3R5bGUgPSBzdHlsZSB8fCAnd2lkdGg6IDEwMCU7IGhlaWdodDoxMDAlOyc7CiAgICAgIGlmcmFtZS5pZCA9IGFwcE5hbWU7CiAgICAgIGlmcmFtZVsnYXJpYS1sYWJlbCddID0gYXBwTmFtZTsKICAgICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgKICAgICAgICAic2FuZGJveCIsCiAgICAgICAgImFsbG93LWZvcm1zIGFsbG93LXBvcHVwcyBhbGxvdy1wb3B1cHMtdG8tZXNjYXBlLXNhbmRib3ggYWxsb3ctc2FtZS1vcmlnaW4gYWxsb3ctc2NyaXB0cyIKICAgICAgKTsKICAgICAgLy8gVE9ETzogVXBkYXRlIHNhbmRib3ggb3B0aW9uIGZvciAzUCB3aWRnZXQKCiAgICAgIHJldHVybiBpZnJhbWU7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiAoYXBwTmFtZSwgY29uZmlnLCBjb250YWluZXJET00pIHsKICAgICAgICBtb2R1bGVEYXRhW2FwcE5hbWVdID0gewogICAgICAgICAgY29udGFpbmVyRE9NOiBjb250YWluZXJET00sCiAgICAgICAgICBlbmRwb2ludDogY29uZmlnLmVuZHBvaW50LAogICAgICAgICAgc3R5bGU6IGNvbmZpZy5zdHlsZSwKICAgICAgICAgIGluc3RhbmNlOiB1bmRlZmluZWQsCiAgICAgICAgfTsKICAgICAgfSwKICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChhcHBOYW1lLCBjcmVhdG9yKSB7CiAgICAgICAgaWYgKCFtb2R1bGVEYXRhW2FwcE5hbWVdKSByZXR1cm47CiAgICAgICAgdmFyIGNvbnRhaW5lckRPTSA9IG1vZHVsZURhdGFbYXBwTmFtZV0uY29udGFpbmVyRE9NOwogICAgICAgIHZhciBlbmRwb2ludCA9IG1vZHVsZURhdGFbYXBwTmFtZV0uZW5kcG9pbnQ7CiAgICAgICAgdmFyIHN0eWxlID0gbW9kdWxlRGF0YVthcHBOYW1lXS5zdHlsZTsKICAgICAgICBpZiAoYXBwTmFtZSAhPT0gQVBQLkNDUCkgewogICAgICAgICAgdmFyIGFwcCA9IG1ha2VBcHBJZnJhbWUoYXBwTmFtZSwgZW5kcG9pbnQsIHN0eWxlKTsKICAgICAgICAgIGNvbnRhaW5lckRPTS5hcHBlbmRDaGlsZChhcHApOwogICAgICAgIH0KCiAgICAgICAgbW9kdWxlRGF0YVthcHBOYW1lXS5pbnN0YW5jZSA9IGNyZWF0b3IobW9kdWxlRGF0YVthcHBOYW1lXSk7CiAgICAgICAgcmV0dXJuIG1vZHVsZURhdGFbYXBwTmFtZV0uaW5zdGFuY2UuaW5pdCgpOwogICAgICB9LAogICAgICBzdG9wOiBmdW5jdGlvbiAoYXBwTmFtZSkgewogICAgICAgIGlmICghbW9kdWxlRGF0YVthcHBOYW1lXSkgcmV0dXJuOwoKICAgICAgICB2YXIgZGF0YSA9IG1vZHVsZURhdGFbYXBwTmFtZV07CiAgICAgICAgdmFyIGFwcCA9IGRhdGEuY29udGFpbmVyRE9NLnF1ZXJ5U2VsZWN0b3IoJ2lmcmFtZScpOwogICAgICAgIGRhdGEuY29udGFpbmVyRE9NLnJlbW92ZUNoaWxkKGFwcCk7CgogICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgaWYgKGRhdGEuaW5zdGFuY2UpIHsKICAgICAgICAgIHJlc3VsdCA9IGRhdGEuaW5zdGFuY2UuZGVzdHJveSgpOwogICAgICAgICAgZGVsZXRlIGRhdGEuaW5zdGFuY2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICB9OwogIH0KCiAgZ2xvYmFsLmNvbm5lY3QuYWdlbnRBcHAuQXBwUmVnaXN0cnkgPSBBcHBSZWdpc3RyeSgpOwp9KSgpOwo=");I.prototype._createFramedCcp=function(I){var g=this.style||"margin: 0; border: 0; padding: 0px; width: 0px; height: 0px",C=document.createElement("iframe");return C.srcdoc=this.getContent(I),C.allow="microphone; autoplay",C.id=this.id,C.style=g,C.scrolling="no",C},I.prototype.getContent=function(I){return["<!DOCTYPE html>","<meta charset='UTF-8'>","<html>","<head>","<script type='text/javascript'>",g,"<\/script>","</head>","<body onload='init()'>","<div id=containerDiv style='width: 100%;height: "+this.height+"'></div>","<script type='text/javascript'>","function init() {","connect.core.initCCP(containerDiv,"+I+");","}","<\/script>","</body>","</html>"].join("")},globalConnect.Container=I}(),function(){var I=this;connect=I.connect||{},globalConnect=I.globalConnect||{},I.connect=connect,I.globalConnect=globalConnect,I.lily=connect,connect.core={},globalConnect.core={regions:{}};function G(I,g){if(connect.assertTrue("string"==typeof I,"Region provided "+I+" is not a valid string"),g=g||globalConnect.core.regions,!g.hasOwnProperty(I))throw new connect.ValueError("Region provided "+I+" is not found!")}var Z="465px",d=!0,c=function(I){I=window.getComputedStyle(I);return{height:I.getPropertyValue("height"),width:I.getPropertyValue("width"),display:I.getPropertyValue("display")}};globalConnect.core.initCCP=function(l,I){connect.assertNotNull(I.getPrimaryRegion,"getPrimaryRegion"),connect.assertTrue(connect.isFunction(I.getPrimaryRegion),"getPrimaryRegion must be a function");var g=I.getPrimaryRegion;delete I.getPrimaryRegion;var b=function(I,g){connect.assertNotNull(g.standByRegion,"ccpBackupResource"),connect.assertNotNull(g.standByRegion.ccpUrl,"ccpUrl"),connect.assertNotNull(g.standByRegion.loginUrl,"loginUrl"),connect.assertNotNull(g.standByRegion.region,"region");var C=g,g=Object.assign({},g,{ccpUrl:g.standByRegion.ccpUrl,loginUrl:g.standByRegion.loginUrl,region:g.standByRegion.region}),A=c(I);return"none"==A.display&&(d=!1),parseInt(A.height)<=0&&(I.style.height=Z,A.height=Z),[C,g].map(function(I){return connect.assertNotNull(I.ccpUrl,"ccpUrl"),connect.assertNotNull(I.loginUrl,"loginUrl"),connect.assertNotNull(I.region,"region"),delete I.standByRegion,I.loginPopup=!1,I.disasterRecoveryOn=!0,I.iframe_style="margin: 0; border: 0; padding:0px;width: 0px;height: 0px",I.height=A.height,I})}(l,I);g(function(A){var I=b.reduce(function(I,g){return I[g.region]=null,I},{});G(A,I);var g=b.map(function(I){return I.region===A&&(I.isPrimary=!0),new globalConnect.Container(I)}),C=g.map(function(I){return I.ccp.outerHTML}),Z=document.createElement("iframe");Z.style="margin: 0; border: 0; padding:0px;width: 100%;height: 100%",Z.id="globalCCP",Z.scrolling="no",Z.onload=function(){var C;d&&(C=Object.keys(I).find(function(I){return I!=A}),W(A,Z.id),V(C,Z.id)),g.map(function(I){globalConnect.core.regions[I.region]=Z.contentDocument.getElementById(I.id).contentWindow.connect;var g=globalConnect.core.regions[I.region];g.core.getUpstream().onUpstream(g.DisasterRecoveryEvents.FAILOVER,function(I){I.isPrimary?(connect=g,A=connect.core.region,d&&W(A,Z.id)):d&&(C=g.core.region,V(C,Z.id))})}),connect=globalConnect.core.regions[A]},Z.srcdoc=C.join(""),l.appendChild(Z)},function(){console.log("[Disaster Recovery] An error occured, while attempting to retrieve your primary region;")})};function C(g){return g=g||connect.core.region,Object.keys(globalConnect.core.regions).find(function(I){return I!==g})}var V=function(I,g){I=I.replace(/-/g,"_"),document.getElementById(g).contentDocument.getElementById(I).style="height: 0; width: 0; border: 0px"},W=function(I,g){I=I.replace(/-/g,"_"),document.getElementById(g).contentDocument.getElementById(I).style="height:800px;width:100%;border:0px"};globalConnect.core.failover=function(){globalConnect.core.failoverTo(C())},globalConnect.core.failoverTo=function(I){G(I);var g=C(I);A(g),l(I),connect=globalConnect.core.regions[I]};var A=function(I){I=globalConnect.core.regions[I];I.getLog().info("[Disaster Recovery] Deactivating %s region.",I.core.region).sendInternalLogToServer(),I.core.suppressContacts(!0),I.core.forceOffline()},l=function(I){I=globalConnect.core.regions[I];I.getLog().info("[Disaster Recovery] Activating %s region.",I.core.region).sendInternalLogToServer(),I.core.suppressContacts(!1)};connect.core.initCCP=globalConnect.core.initCCP}();