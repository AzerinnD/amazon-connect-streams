!function(){var I=function(){return I.cache.hasOwnProperty(arguments[0])||(I.cache[arguments[0]]=I.parse(arguments[0])),I.format.call(null,I.cache[arguments[0]],arguments)};function g(I){return Object.prototype.toString.call(I).slice(8,-1).toLowerCase()}function C(I,g){for(var C=[];g>0;C[--g]=I);return C.join("")}I.format=function(A,Z){var l,b,G,d,c,V,W,m=1,B=A.length,i="",X=[];for(b=0;b<B;b++)if("string"===(i=g(A[b])))X.push(A[b]);else if("array"===i){if((d=A[b])[2])for(l=Z[m],G=0;G<d[2].length;G++){if(!l.hasOwnProperty(d[2][G]))throw I('[sprintf] property "%s" does not exist',d[2][G]);l=l[d[2][G]]}else l=d[1]?Z[d[1]]:Z[m++];if(/[^s]/.test(d[8])&&"number"!=g(l))throw I("[sprintf] expecting number but found %s",g(l));switch(d[8]){case"b":l=l.toString(2);break;case"c":l=String.fromCharCode(l);break;case"d":l=parseInt(l,10);break;case"e":l=d[7]?l.toExponential(d[7]):l.toExponential();break;case"f":l=d[7]?parseFloat(l).toFixed(d[7]):parseFloat(l);break;case"o":l=l.toString(8);break;case"s":l=(l=String(l))&&d[7]?l.substring(0,d[7]):l;break;case"u":l>>>=0;break;case"x":l=l.toString(16);break;case"X":l=l.toString(16).toUpperCase()}l=/[def]/.test(d[8])&&d[3]&&l>=0?"+"+l:l,V=d[4]?"0"==d[4]?"0":d[4].charAt(1):" ",W=d[6]-String(l).length,c=d[6]?C(V,W):"",X.push(d[5]?l+c:c+l)}return X.join("")},I.cache={},I.parse=function(I){for(var g=I,C=[],A=[],Z=0;g;){if(null!==(C=/^[^\x25]+/.exec(g)))A.push(C[0]);else if(null!==(C=/^\x25{2}/.exec(g)))A.push("%");else{if(null===(C=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(g)))throw"[sprintf] huh?";if(C[2]){Z|=1;var l=[],b=C[2],G=[];if(null===(G=/^([a-z_][a-z_\d]*)/i.exec(b)))throw"[sprintf] huh?";for(l.push(G[1]);""!==(b=b.substring(G[0].length));)if(null!==(G=/^\.([a-z_][a-z_\d]*)/i.exec(b)))l.push(G[1]);else{if(null===(G=/^\[(\d+)\]/.exec(b)))throw"[sprintf] huh?";l.push(G[1])}C[2]=l}else Z|=2;if(3===Z)throw"[sprintf] mixing positional and named placeholders is not (yet) supported";A.push(C)}g=g.substring(C[0].length)}return A},this.sprintf=I,this.vsprintf=function(g,C,A){return(A=C.slice(0)).splice(0,0,g),I.apply(null,A)}}(),function(){var I=this;connect=I.connect||{},I.connect=connect,I.lily=connect;var g=navigator.userAgent,C=["bubbles","cancelBubble","cancelable","composed","data","defaultPrevented","eventPhase","isTrusted","lastEventId","origin","returnValue","timeStamp","type"];connect.sprintf=I.sprintf,connect.vsprintf=I.vsprintf,delete I.sprintf,delete I.vsprintf,connect.HTTP_STATUS_CODES={SUCCESS:200,TOO_MANY_REQUESTS:429,INTERNAL_SERVER_ERROR:500},connect.TRANSPORT_TYPES={CHAT_TOKEN:"chat_token",WEB_SOCKET:"web_socket"},connect.hitch=function(){var I=Array.prototype.slice.call(arguments),g=I.shift(),C=I.shift();return connect.assertNotNull(g,"scope"),connect.assertNotNull(C,"method"),connect.assertTrue(connect.isFunction(C),"method must be a function"),function(){var A=Array.prototype.slice.call(arguments);return C.apply(g,I.concat(A))}},connect.isFunction=function(I){return!!(I&&I.constructor&&I.call&&I.apply)},connect.isArray=function(I){return"[object Array]"===Object.prototype.toString.call(I)},connect.keys=function(I){var g=[];for(var C in connect.assertNotNull(I,"map"),I)g.push(C);return g},connect.values=function(I){var g=[];for(var C in connect.assertNotNull(I,"map"),I)g.push(I[C]);return g},connect.entries=function(I){var g=[];for(var C in I)g.push({key:C,value:I[C]});return g},connect.merge=function(){var I=Array.prototype.slice.call(arguments,0),g={};return I.forEach((function(I){connect.entries(I).forEach((function(I){g[I.key]=I.value}))})),g},connect.now=function(){return(new Date).getTime()},connect.find=function(I,g){for(var C=0;C<I.length;C++)if(g(I[C]))return I[C];return null},connect.contains=function(I,g){return I instanceof Array?null!=connect.find(I,(function(I){return I===g})):g in I},connect.containsValue=function(I,g){return I instanceof Array?null!=connect.find(I,(function(I){return I===g})):null!=connect.find(connect.values(I),(function(I){return I===g}))},connect.randomId=function(){return connect.sprintf("%s-%s",connect.now(),Math.random().toString(36).slice(2))},connect.makeEnum=function(I){var g={};return I.forEach((function(I){var C=I.replace(/\.?([a-z]+)_?/g,(function(I,g){return g.toUpperCase()+"_"})).replace(/_$/,"");g[C]=I})),g},connect.makeNamespacedEnum=function(I,g){var C=connect.makeEnum(g);return connect.keys(C).forEach((function(g){C[g]=connect.sprintf("%s::%s",I,C[g])})),C},connect.makeGenericNamespacedEnum=function(I,g,C){var A=connect.makeEnum(g);return connect.keys(A).forEach((function(g){A[g]=connect.sprintf("%s"+C+"%s",I,A[g])})),A},connect.isChromeBrowser=function(){return-1!==g.indexOf("Chrome")},connect.isFirefoxBrowser=function(){return-1!==g.indexOf("Firefox")},connect.isOperaBrowser=function(){return-1!==g.indexOf("Opera")},connect.getChromeBrowserVersion=function(){var I=g.substring(g.indexOf("Chrome")+7);return I?parseFloat(I):-1},connect.getFirefoxBrowserVersion=function(){var I=g.substring(g.indexOf("Firefox")+8);return I?parseFloat(I):-1},connect.isValidLocale=function(I){return[{id:"en_US",label:"English"},{id:"de_DE",label:"Deutsch"},{id:"es_ES",label:"Español"},{id:"fr_FR",label:"Français"},{id:"ja_JP",label:"日本語"},{id:"it_IT",label:"Italiano"},{id:"ko_KR",label:"한국어"},{id:"pt_BR",label:"Português"},{id:"zh_CN",label:"中文(简体)"},{id:"zh_TW",label:"中文(繁體)"}].map((function(I){return I.id})).includes(I)},connect.getOperaBrowserVersion=function(){var I=g.indexOf("Opera"),C=-1!==g.indexOf("Version")?g.substring(I+8):g.substring(I+6);return C?parseFloat(C):-1},connect.index=function(I,g){var C={};return I.forEach((function(I){C[g(I)]=I})),C},connect.set=function(I){var g={};return I.forEach((function(I){g[I]=1})),g},connect.relativeComplement=function(I,g){var C={};return connect.keys(g).forEach((function(A){A in I||(C[A]=g[A])})),C},connect.assertTrue=function(I,g){if(!I)throw new connect.ValueError(g)},connect.assertNotNull=function(I,g){return connect.assertTrue(null!=I&&void 0!==typeof I,connect.sprintf("%s must be provided",g||"A value")),I},connect.deepcopy=function(I){return JSON.parse(JSON.stringify(I))},connect.deepcopyCrossOriginEvent=function(I){const g={};return C.forEach((C=>{try{g[C]=I[C]}catch(I){connect.getLog().info("deepcopyCrossOriginEvent failed on key: ",C).sendInternalLogToServer()}})),connect.deepcopy(g)},connect.getBaseUrl=function(){var g=I.location;return connect.sprintf("%s//%s:%s",g.protocol,g.hostname,g.port)},connect.getUrlWithProtocol=function(g){var C=I.location.protocol;return g.substr(0,C.length)!==C?connect.sprintf("%s//%s",C,g):g},connect.isFramed=function(){try{return window.self!==window.top}catch(I){return!0}},connect.hasOtherConnectedCCPs=function(){return connect.numberOfConnectedCCPs>1},connect.fetch=function(I,g,C,A){return A=A||5,C=C||1e3,g=g||{},new Promise((function(Z,l){!function A(b){fetch(I,g).then((function(I){I.status===connect.HTTP_STATUS_CODES.SUCCESS?I.json().then((I=>Z(I))).catch((()=>Z({}))):1!==b&&(I.status>=connect.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR||I.status===connect.HTTP_STATUS_CODES.TOO_MANY_REQUESTS)?setTimeout((function(){A(--b)}),C):l(I)})).catch((function(I){l(I)}))}(A)}))},connect.backoff=function(g,C,A,Z){connect.assertTrue(connect.isFunction(g),"func must be a Function");var l=this;g({success:function(I){Z&&Z.success&&Z.success(I)},failure:function(b,G){if(A>0){var d=2*C*Math.random();I.setTimeout((function(){l.backoff(g,2*d,--A,Z)}),d)}else Z&&Z.failure&&Z.failure(b,G)}})},connect.publishMetric=function(I){connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST,{event:connect.EventType.CLIENT_METRIC,data:I})},connect.publishSoftphoneStats=function(I){connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST,{event:connect.EventType.SOFTPHONE_STATS,data:I})},connect.publishSoftphoneReport=function(I){connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST,{event:connect.EventType.SOFTPHONE_REPORT,data:I})},connect.publishClientSideLogs=function(I){connect.core.getEventBus().trigger(connect.EventType.CLIENT_SIDE_LOGS,I)},connect.PopupManager=function(){},connect.PopupManager.prototype.open=function(I,g,C){var A=this._getLastOpenedTimestamp(g),Z=(new Date).getTime(),l=null;if(Z-A>864e5){if(C){var b=C.height||578,G=C.width||433,d=C.top||0,c=C.left||0;(l=window.open("",g,"width="+G+", height="+b+", top="+d+", left="+c)).location!==I&&(l=window.open(I,g,"width="+G+", height="+b+", top="+d+", left="+c))}else(l=window.open("",g)).location!==I&&(l=window.open(I,g));this._setLastOpenedTimestamp(g,Z)}return l},connect.PopupManager.prototype.clear=function(g){var C=this._getLocalStorageKey(g);I.localStorage.removeItem(C)},connect.PopupManager.prototype._getLastOpenedTimestamp=function(g){var C=this._getLocalStorageKey(g),A=I.localStorage.getItem(C);return A?parseInt(A,10):0},connect.PopupManager.prototype._setLastOpenedTimestamp=function(g,C){var A=this._getLocalStorageKey(g);I.localStorage.setItem(A,""+C)},connect.PopupManager.prototype._getLocalStorageKey=function(I){return"connectPopupManager::"+I};var A=connect.makeEnum(["granted","denied","default"]);connect.NotificationManager=function(){this.queue=[],this.permission=A.DEFAULT},connect.NotificationManager.prototype.requestPermission=function(){var g=this;"Notification"in I?I.Notification.permission===A.DENIED?(connect.getLog().warn("The user has requested to not receive notifications.").sendInternalLogToServer(),this.permission=A.DENIED):this.permission!==A.GRANTED&&I.Notification.requestPermission().then((function(I){g.permission=I,I===A.GRANTED?g._showQueued():g.queue=[]})):(connect.getLog().warn("This browser doesn't support notifications.").sendInternalLogToServer(),this.permission=A.DENIED)},connect.NotificationManager.prototype.show=function(I,g){if(this.permission===A.GRANTED)return this._showImpl({title:I,options:g});if(this.permission===A.DENIED)connect.getLog().warn("Unable to show notification.").sendInternalLogToServer().withObject({title:I,options:g});else{var C={title:I,options:g};connect.getLog().warn("Deferring notification until user decides to allow or deny.").withObject(C).sendInternalLogToServer(),this.queue.push(C)}},connect.NotificationManager.prototype._showQueued=function(){var I=this,g=this.queue.map((function(g){return I._showImpl(g)}));return this.queue=[],g},connect.NotificationManager.prototype._showImpl=function(g){var C=new I.Notification(g.title,g.options);return g.options.clicked&&(C.onclick=function(){g.options.clicked.call(C)}),C},connect.BaseError=function(g,C){I.Error.call(this,connect.vsprintf(g,C))},connect.BaseError.prototype=Object.create(Error.prototype),connect.BaseError.prototype.constructor=connect.BaseError,connect.ValueError=function(){var I=Array.prototype.slice.call(arguments,0),g=I.shift();connect.BaseError.call(this,g,I)},connect.ValueError.prototype=Object.create(connect.BaseError.prototype),connect.ValueError.prototype.constructor=connect.ValueError,connect.NotImplementedError=function(){var I=Array.prototype.slice.call(arguments,0),g=I.shift();connect.BaseError.call(this,g,I)},connect.NotImplementedError.prototype=Object.create(connect.BaseError.prototype),connect.NotImplementedError.prototype.constructor=connect.NotImplementedError,connect.StateError=function(){var I=Array.prototype.slice.call(arguments,0),g=I.shift();connect.BaseError.call(this,g,I)},connect.StateError.prototype=Object.create(connect.BaseError.prototype),connect.StateError.prototype.constructor=connect.StateError,connect.VoiceIdError=function(I,g,C){var A={};return A.type=I,A.message=g,A.stack=Error(g).stack,A.err=C,A},connect.isCCP=function(){return"ConnectSharedWorkerConduit"===connect.core.getUpstream().name}}(),function(){var I=this;connect=I.connect||{},I.connect=connect,I.globalConnect={},I.lily=connect,globalConnect.Container=null;var g=window.atob("LyoqKioqKi8gKCgpID0+IHsgLy8gd2VicGFja0Jvb3RzdHJhcAovKioqKioqLyAJdmFyIF9fd2VicGFja19tb2R1bGVzX18gPSAoewoKLyoqKi8gODIxOgovKioqLyAoKCkgPT4gewoKKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgY29ubmVjdC5hZ2VudEFwcCA9IHt9OwoKICB2YXIgQVBQID0gewogICAgQ0NQOiAnY2NwJywKICB9OwoKICBjb25uZWN0LmFnZW50QXBwLmluaXRDQ1AgPSBjb25uZWN0LmNvcmUuaW5pdENDUDsKICBjb25uZWN0LmFnZW50QXBwLmlzSW5pdGlhbGl6ZWQgPSBmdW5jdGlvbiAoaW5zdGFuY2VBbGlhcykge307CgogIGNvbm5lY3QuYWdlbnRBcHAuaW5pdEFwcENvbW11bmljYXRpb24gPSBmdW5jdGlvbiAoaWZyYW1lSWQsIGVuZHBvaW50KSB7CiAgICB2YXIgaWZyYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWZyYW1lSWQpOwogICAgdmFyIGlmcmFtZUNvbmR1aXQgPSBuZXcgY29ubmVjdC5JRnJhbWVDb25kdWl0KGVuZHBvaW50LCB3aW5kb3csIGlmcmFtZSk7CiAgICB2YXIgQlJPQURDQVNUX1RZUEUgPSBbCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuVVBEQVRFLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuVklFVywKICAgICAgY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsCiAgICAgIGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURUQsCiAgICAgIGNvbm5lY3QuVGFza0V2ZW50cy5DUkVBVEVECiAgICBdOwogICAgaWZyYW1lLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmdW5jdGlvbiAoZSkgewogICAgICBCUk9BRENBU1RfVFlQRS5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbSh0eXBlLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWZyYW1lQ29uZHVpdC5zZW5kVXBzdHJlYW0odHlwZSwgZGF0YSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgdmFyIGdldENvbm5lY3RVcmwgPSBmdW5jdGlvbiAoY2NwVXJsKSB7CiAgICB2YXIgcG9zID0gY2NwVXJsLmluZGV4T2YoJ2NjcC12MicpOwogICAgcmV0dXJuIGNjcFVybC5zbGljZSgwLCBwb3MgLSAxKTsKICB9OwoKICB2YXIgc2lnbk91dFRocm91Z2hDQ1AgPSBmdW5jdGlvbiAoY2NwVXJsKSB7CiAgICB2YXIgbG9nb3V0VXJsID0gZ2V0Q29ubmVjdFVybChjY3BVcmwpICsgJy9sb2dvdXQnOwogICAgcmV0dXJuIGNvbm5lY3QuZmV0Y2gobG9nb3V0VXJsLCB7CiAgICAgIGNyZWRlbnRpYWxzOiAnaW5jbHVkZScsCiAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGV2ZW50QnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICAgIGV2ZW50QnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICBjb25uZWN0CiAgICAgICAgLmdldExvZygpCiAgICAgICAgLmVycm9yKCdBbiBlcnJvciBvY2N1cmVkIG9uIGxvZ291dC4nICsgZSkKICAgICAgICAud2l0aEV4Y2VwdGlvbihlKTsKICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBsb2dvdXRVcmw7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0pOwogIH07CgogIHZhciBzaWduSW5UaHJvdWdoaW5pdENDUCA9IGZ1bmN0aW9uIChjY3BVcmwsIGNvbnRhaW5lciwgY29uZmlnKSB7CiAgICB2YXIgZGVmYXVsdFBhcmFtcyA9IHsKICAgICAgY2NwVXJsOiBjY3BVcmwsCiAgICAgIGNjcExvYWRUaW1lb3V0OiAxMDAwMCwKICAgICAgbG9naW5Qb3B1cDogdHJ1ZSwKICAgICAgbG9naW5Vcmw6IGdldENvbm5lY3RVcmwoY2NwVXJsKSArICcvbG9naW4nLAogICAgICBzb2Z0cGhvbmU6IHsKICAgICAgICBhbGxvd0ZyYW1lZFNvZnRwaG9uZTogdHJ1ZSwKICAgICAgICBkaXNhYmxlUmluZ3RvbmU6IGZhbHNlLAogICAgICB9CiAgICB9OwogICAgdmFyIGNjcFBhcmFtcyA9IGNvbm5lY3QubWVyZ2UoZGVmYXVsdFBhcmFtcywgY29uZmlnLmNjcFBhcmFtcyk7CiAgICBjb25uZWN0LmNvcmUuaW5pdENDUChjb250YWluZXIsIGNjcFBhcmFtcyk7CiAgfTsKCiAgY29ubmVjdC5hZ2VudEFwcC5pbml0QXBwID0gZnVuY3Rpb24gKG5hbWUsIGNvbnRhaW5lcklkLCBhcHBVcmwsIGNvbmZpZykgewogICAgY29uZmlnID0gY29uZmlnID8gY29uZmlnIDoge307CiAgICB2YXIgZW5kcG9pbnQgPSBhcHBVcmwuZW5kc1dpdGgoJy8nKSA/IGFwcFVybCA6IGFwcFVybCArICcvJzsKICAgIHZhciBvbkxvYWQgPSBjb25maWcub25Mb2FkID8gY29uZmlnLm9uTG9hZCA6IG51bGw7CiAgICB2YXIgcmVnaXN0ZXJDb25maWcgPSB7IGVuZHBvaW50OiBlbmRwb2ludCwgc3R5bGU6IGNvbmZpZy5zdHlsZSwgb25Mb2FkOiBvbkxvYWQgfTsKICAgIGNvbm5lY3QuYWdlbnRBcHAuQXBwUmVnaXN0cnkucmVnaXN0ZXIobmFtZSwgcmVnaXN0ZXJDb25maWcsIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKSk7CiAgICBjb25uZWN0LmFnZW50QXBwLkFwcFJlZ2lzdHJ5LnN0YXJ0KG5hbWUsIGZ1bmN0aW9uIChtb2R1bGVEYXRhKSB7CiAgICAgIHZhciBlbmRwb2ludCA9IG1vZHVsZURhdGEuZW5kcG9pbnQ7CiAgICAgIHZhciBjb250YWluZXJET00gPSBtb2R1bGVEYXRhLmNvbnRhaW5lckRPTTsKICAgICAgcmV0dXJuIHsKICAgICAgICBpbml0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAobmFtZSA9PT0gQVBQLkNDUCkgcmV0dXJuIHNpZ25JblRocm91Z2hpbml0Q0NQKGVuZHBvaW50LCBjb250YWluZXJET00sIGNvbmZpZyk7CiAgICAgICAgICByZXR1cm4gY29ubmVjdC5hZ2VudEFwcC5pbml0QXBwQ29tbXVuaWNhdGlvbihuYW1lLCBlbmRwb2ludCk7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAobmFtZSA9PT0gQVBQLkNDUCkgcmV0dXJuIHNpZ25PdXRUaHJvdWdoQ0NQKGVuZHBvaW50KTsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgfTsKICAgIH0pOwogIH07CgogIGNvbm5lY3QuYWdlbnRBcHAuc3RvcEFwcCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICByZXR1cm4gY29ubmVjdC5hZ2VudEFwcC5BcHBSZWdpc3RyeS5zdG9wKG5hbWUpOwogIH07Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA1MDA6Ci8qKiovICgoKSA9PiB7CgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIHZhciBBUFAgPSB7CiAgICBDQ1A6ICdjY3AnLAogIH07CgogIGZ1bmN0aW9uIEFwcFJlZ2lzdHJ5KCkgewogICAgdmFyIG1vZHVsZURhdGEgPSB7fTsKICAgIHZhciBtYWtlQXBwSWZyYW1lID0gZnVuY3Rpb24gKGFwcE5hbWUsIGVuZHBvaW50LCBzdHlsZSwgb25Mb2FkKSB7CiAgICAgIHZhciBpZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpZnJhbWUnKTsKICAgICAgaWZyYW1lLnNyYyA9IGVuZHBvaW50OwogICAgICBpZnJhbWUuc3R5bGUgPSBzdHlsZSB8fCAnd2lkdGg6IDEwMCU7IGhlaWdodDoxMDAlOyc7CiAgICAgIGlmcmFtZS5pZCA9IGFwcE5hbWU7CiAgICAgIGlmcmFtZVsnYXJpYS1sYWJlbCddID0gYXBwTmFtZTsKICAgICAgaWZyYW1lLm9ubG9hZCA9IG9uTG9hZDsKICAgICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgKICAgICAgICAic2FuZGJveCIsCiAgICAgICAgImFsbG93LWZvcm1zIGFsbG93LXBvcHVwcyBhbGxvdy1wb3B1cHMtdG8tZXNjYXBlLXNhbmRib3ggYWxsb3ctc2FtZS1vcmlnaW4gYWxsb3ctc2NyaXB0cyIKICAgICAgKTsKICAgICAgLy8gVE9ETzogVXBkYXRlIHNhbmRib3ggb3B0aW9uIGZvciAzUCB3aWRnZXQKCiAgICAgIHJldHVybiBpZnJhbWU7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiAoYXBwTmFtZSwgY29uZmlnLCBjb250YWluZXJET00pIHsKICAgICAgICBtb2R1bGVEYXRhW2FwcE5hbWVdID0gewogICAgICAgICAgY29udGFpbmVyRE9NOiBjb250YWluZXJET00sCiAgICAgICAgICBlbmRwb2ludDogY29uZmlnLmVuZHBvaW50LAogICAgICAgICAgc3R5bGU6IGNvbmZpZy5zdHlsZSwKICAgICAgICAgIGluc3RhbmNlOiB1bmRlZmluZWQsCiAgICAgICAgICBvbkxvYWQ6IGNvbmZpZy5vbkxvYWQsCiAgICAgICAgfTsKICAgICAgfSwKICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChhcHBOYW1lLCBjcmVhdG9yKSB7CiAgICAgICAgaWYgKCFtb2R1bGVEYXRhW2FwcE5hbWVdKSByZXR1cm47CiAgICAgICAgdmFyIGNvbnRhaW5lckRPTSA9IG1vZHVsZURhdGFbYXBwTmFtZV0uY29udGFpbmVyRE9NOwogICAgICAgIHZhciBlbmRwb2ludCA9IG1vZHVsZURhdGFbYXBwTmFtZV0uZW5kcG9pbnQ7CiAgICAgICAgdmFyIHN0eWxlID0gbW9kdWxlRGF0YVthcHBOYW1lXS5zdHlsZTsKICAgICAgICB2YXIgb25Mb2FkID0gbW9kdWxlRGF0YVthcHBOYW1lXS5vbkxvYWQ7CiAgICAgICAgaWYgKGFwcE5hbWUgIT09IEFQUC5DQ1ApIHsKICAgICAgICAgIHZhciBhcHAgPSBtYWtlQXBwSWZyYW1lKGFwcE5hbWUsIGVuZHBvaW50LCBzdHlsZSwgb25Mb2FkKTsKICAgICAgICAgIGNvbnRhaW5lckRPTS5hcHBlbmRDaGlsZChhcHApOwogICAgICAgIH0KCiAgICAgICAgbW9kdWxlRGF0YVthcHBOYW1lXS5pbnN0YW5jZSA9IGNyZWF0b3IobW9kdWxlRGF0YVthcHBOYW1lXSk7CiAgICAgICAgcmV0dXJuIG1vZHVsZURhdGFbYXBwTmFtZV0uaW5zdGFuY2UuaW5pdCgpOwogICAgICB9LAogICAgICBzdG9wOiBmdW5jdGlvbiAoYXBwTmFtZSkgewogICAgICAgIGlmICghbW9kdWxlRGF0YVthcHBOYW1lXSkgcmV0dXJuOwoKICAgICAgICB2YXIgZGF0YSA9IG1vZHVsZURhdGFbYXBwTmFtZV07CiAgICAgICAgdmFyIGFwcCA9IGRhdGEuY29udGFpbmVyRE9NLnF1ZXJ5U2VsZWN0b3IoJ2lmcmFtZScpOwogICAgICAgIGRhdGEuY29udGFpbmVyRE9NLnJlbW92ZUNoaWxkKGFwcCk7CgogICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgaWYgKGRhdGEuaW5zdGFuY2UpIHsKICAgICAgICAgIHJlc3VsdCA9IGRhdGEuaW5zdGFuY2UuZGVzdHJveSgpOwogICAgICAgICAgZGVsZXRlIGRhdGEuaW5zdGFuY2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICB9OwogIH0KCiAgZ2xvYmFsLmNvbm5lY3QuYWdlbnRBcHAuQXBwUmVnaXN0cnkgPSBBcHBSZWdpc3RyeSgpOwp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gOTY1OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBBZ2VudFN0YXRlVHlwZQogICAqLwogIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdyb3V0YWJsZScsCiAgICAnbm90X3JvdXRhYmxlJywKICAgICdvZmZsaW5lJwogIF0pOwogIGNvbm5lY3QuQWdlbnRTdGF0dXNUeXBlID0gY29ubmVjdC5BZ2VudFN0YXRlVHlwZTsKCiAgLyoqCiAgICogZW51bSBBZ2VudEF2YWlsU3RhdGVzCiAgICovCiAgY29ubmVjdC5BZ2VudEF2YWlsU3RhdGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnSW5pdCcsCiAgICAnQnVzeScsCiAgICAnQWZ0ZXJDYWxsV29yaycsCiAgICAnQ2FsbGluZ0N1c3RvbWVyJywKICAgICdEaWFsaW5nJywKICAgICdKb2luaW5nJywKICAgICdQZW5kaW5nQXZhaWxhYmxlJywKICAgICdQZW5kaW5nQnVzeScKICBdKTsKCiAgLyoqCiAgICogZW51bSBBZ2VudEVycm9yU3RhdGVzCiAgICovCiAgY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnRXJyb3InLAogICAgJ0FnZW50SHVuZ1VwJywKICAgICdCYWRBZGRyZXNzQWdlbnQnLAogICAgJ0JhZEFkZHJlc3NDdXN0b21lcicsCiAgICAnRGVmYXVsdCcsCiAgICAnRmFpbGVkQ29ubmVjdEFnZW50JywKICAgICdGYWlsZWRDb25uZWN0Q3VzdG9tZXInLAogICAgJ0ludmFsaWRMb2NhbGUnLAogICAgJ0xpbmVFbmdhZ2VkQWdlbnQnLAogICAgJ0xpbmVFbmdhZ2VkQ3VzdG9tZXInLAogICAgJ01pc3NlZENhbGxBZ2VudCcsCiAgICAnTWlzc2VkQ2FsbEN1c3RvbWVyJywKICAgICdNdWx0aXBsZUNjcFdpbmRvd3MnLAogICAgJ1JlYWx0aW1lQ29tbXVuaWNhdGlvbkVycm9yJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIEFkZHJlc3NUeXBlCiAgICovCiAgY29ubmVjdC5FbmRwb2ludFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdwaG9uZV9udW1iZXInLAogICAgJ2FnZW50JywKICAgICdxdWV1ZScKICBdKTsKICBjb25uZWN0LkFkZHJlc3NUeXBlID0gY29ubmVjdC5FbmRwb2ludFR5cGU7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29ubmVjdGlvblR5cGUKICAgKi8KICBjb25uZWN0LkNvbm5lY3Rpb25UeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnYWdlbnQnLAogICAgJ2luYm91bmQnLAogICAgJ291dGJvdW5kJywKICAgICdtb25pdG9yaW5nJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIENvbm5lY3Rpb25TdGF0ZVR5cGUKICAgKi8KICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ2hvbGQnLAogICAgJ2Rpc2Nvbm5lY3RlZCcKICBdKTsKICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0dXNUeXBlID0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlOwoKICBjb25uZWN0LkNPTk5FQ1RJT05fQUNUSVZFX1NUQVRFUyA9IGNvbm5lY3Quc2V0KFsKICAgIGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNUSU5HLAogICAgY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RFRCwKICAgIGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5IT0xECiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdFN0YXRlVHlwZQogICAqLwogIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2luaXQnLAogICAgJ2luY29taW5nJywKICAgICdwZW5kaW5nJywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ21pc3NlZCcsCiAgICAnZXJyb3InLAogICAgJ2VuZGVkJwogIF0pOwogIGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUgPSBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGU7CgogIGNvbm5lY3QuQ09OVEFDVF9BQ1RJVkVfU1RBVEVTID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5jb21pbmcnLAogICAgJ3BlbmRpbmcnLAogICAgJ2Nvbm5lY3RpbmcnLAogICAgJ2Nvbm5lY3RlZCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBDb250YWN0VHlwZQogICAqLwogIGNvbm5lY3QuQ29udGFjdFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICd2b2ljZScsCiAgICAncXVldWVfY2FsbGJhY2snLAogICAgJ2NoYXQnLAogICAgJ3Rhc2snCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdEluaXRpYXRpb25NZXRob2QKICAgKi8KICBjb25uZWN0LkNvbnRhY3RJbml0aWF0aW9uTWV0aG9kID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5ib3VuZCcsCiAgICAnb3V0Ym91bmQnLAogICAgJ3RyYW5zZmVyJywKICAgICdxdWV1ZV90cmFuc2ZlcicsCiAgICAnY2FsbGJhY2snLAogICAgJ2FwaScsCiAgICAnZGlzY29ubmVjdCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBlbnVtIENoYW5uZWxUeXBlCiAgKi8KICBjb25uZWN0LkNoYW5uZWxUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnVk9JQ0UnLAogICAgJ0NIQVQnLAogICAgJ1RBU0snCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogZW51bSBNZWRpYVR5cGUKICAqLwogIGNvbm5lY3QuTWVkaWFUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnc29mdHBob25lJywKICAgICdjaGF0JywKICAgICd0YXNrJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIFNvZnRwaG9uZUNhbGxUeXBlCiAgICovCiAgY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2F1ZGlvX3ZpZGVvJywKICAgICd2aWRlb19vbmx5JywKICAgICdhdWRpb19vbmx5JywKICAgICdub25lJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBTb2Z0cGhvbmVFcnJvclR5cGVzCiAgICovCiAgY29ubmVjdC5Tb2Z0cGhvbmVFcnJvclR5cGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAndW5zdXBwb3J0ZWRfYnJvd3NlcicsCiAgICAnbWljcm9waG9uZV9ub3Rfc2hhcmVkJywKICAgICdzaWduYWxsaW5nX2hhbmRzaGFrZV9mYWlsdXJlJywKICAgICdzaWduYWxsaW5nX2Nvbm5lY3Rpb25fZmFpbHVyZScsCiAgICAnaWNlX2NvbGxlY3Rpb25fdGltZW91dCcsCiAgICAndXNlcl9idXN5X2Vycm9yJywKICAgICd3ZWJydGNfZXJyb3InLAogICAgJ3JlYWx0aW1lX2NvbW11bmljYXRpb25fZXJyb3InLAogICAgJ290aGVyJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBWb2ljZUlkRXJyb3JUeXBlcwogICAqLwogIGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdub19zcGVha2VyX2lkX2ZvdW5kJywKICAgICdzcGVha2VyX2lkX25vdF9lbnJvbGxlZCcsCiAgICAnZ2V0X3NwZWFrZXJfaWRfZmFpbGVkJywKICAgICdnZXRfc3BlYWtlcl9zdGF0dXNfZmFpbGVkJywKICAgICdvcHRfb3V0X3NwZWFrZXJfZmFpbGVkJywKICAgICdvcHRfb3V0X3NwZWFrZXJfaW5fbGNtc19mYWlsZWQnLAogICAgJ2RlbGV0ZV9zcGVha2VyX2ZhaWxlZCcsCiAgICAnc3RhcnRfc2Vzc2lvbl9mYWlsZWQnLAogICAgJ2V2YWx1YXRlX3NwZWFrZXJfZmFpbGVkJywKICAgICdzZXNzaW9uX25vdF9leGlzdHMnLAogICAgJ2Rlc2NyaWJlX3Nlc3Npb25fZmFpbGVkJywKICAgICdlbnJvbGxfc3BlYWtlcl9mYWlsZWQnLAogICAgJ3VwZGF0ZV9zcGVha2VyX2lkX2ZhaWxlZCcsCiAgICAndXBkYXRlX3NwZWFrZXJfaWRfaW5fbGNtc19mYWlsZWQnLAogICAgJ25vdF9zdXBwb3J0ZWRfb25fY29uZmVyZW5jZV9jYWxscycsCiAgICAnZW5yb2xsX3NwZWFrZXJfdGltZW91dCcsCiAgICAnZXZhbHVhdGVfc3BlYWtlcl90aW1lb3V0JywKICAgICdnZXRfZG9tYWluX2lkX2ZhaWxlZCcsCiAgICAnbm9fZG9tYWluX2lkX2ZvdW5kJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBDVEkgZXhjZXB0aW9ucwogICAqLwogIGNvbm5lY3QuQ1RJRXhjZXB0aW9ucyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgIkFjY2Vzc0RlbmllZEV4Y2VwdGlvbiIsCiAgICAiSW52YWxpZFN0YXRlRXhjZXB0aW9uIiwKICAgICJCYWRFbmRwb2ludEV4Y2VwdGlvbiIsCiAgICAiSW52YWxpZEFnZW50QVJORXhjZXB0aW9uIiwKICAgICJJbnZhbGlkQ29uZmlndXJhdGlvbkV4Y2VwdGlvbiIsCiAgICAiSW52YWxpZENvbnRhY3RUeXBlRXhjZXB0aW9uIiwKICAgICJQYWdpbmF0aW9uRXhjZXB0aW9uIiwKICAgICJSZWZyZXNoVG9rZW5FeHBpcmVkRXhjZXB0aW9uIiwKICAgICJTZW5kRGF0YUZhaWxlZEV4Y2VwdGlvbiIsCiAgICAiVW5hdXRob3JpemVkRXhjZXB0aW9uIiwKICAgICJRdW90YUV4Y2VlZGVkRXhjZXB0aW9uIgogIF0pOwogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIFZvaWNlSWQgc3RyZWFtaW5nIHN0YXR1cwogICAqLwogIGNvbm5lY3QuVm9pY2VJZFN0cmVhbWluZ1N0YXR1cyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgIk9OR09JTkciLAogICAgIkVOREVEIiwKICAgICJQRU5ESU5HX0NPTkZJR1VSQVRJT04iCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIFZvaWNlSWQgYXV0aGVudGljYXRpb24gZGVjaXNpb24KICAgKi8KICBjb25uZWN0LlZvaWNlSWRBdXRoZW50aWNhdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiQUNDRVBUIiwKICAgICJSRUpFQ1QiLAogICAgIk5PVF9FTk9VR0hfU1BFRUNIIiwKICAgICJTUEVBS0VSX05PVF9FTlJPTExFRCIsCiAgICAiU1BFQUtFUl9PUFRFRF9PVVQiLAogICAgIlNQRUFLRVJfSURfTk9UX1BST1ZJREVEIiwKICAgICJTUEVBS0VSX0VYUElSRUQiCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIFZvaWNlSWQgZnJhdWQgZGV0ZWN0aW9uIGRlY2lzaW9uCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkRnJhdWREZXRlY3Rpb25EZWNpc2lvbiA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgIk5PVF9FTk9VR0hfU1BFRUNIIiwKICAgICJISUdIX1JJU0siLAogICAgIkxPV19SSVNLIgogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBjb250YWN0IGZsb3cgYXV0aGVudGljYXRpb24gZGVjaXNpb24gCiAgICovCiAgY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24gPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJBdXRoZW50aWNhdGVkIiwKICAgICJOb3RBdXRoZW50aWNhdGVkIiwKICAgICJJbmNvbmNsdXNpdmUiLAogICAgIk5vdEVucm9sbGVkIiwKICAgICJPcHRlZE91dCIsCiAgICAiTm90RW5hYmxlZCIsCiAgICAiRXJyb3IiCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIGNvbnRhY3QgZmxvdyAgZnJhdWQgZGV0ZWN0aW9uIGRlY2lzaW9uCiAgICovCiAgY29ubmVjdC5Db250YWN0Rmxvd0ZyYXVkRGV0ZWN0aW9uRGVjaXNpb24gPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJIaWdoUmlzayIsCiAgICAiTG93UmlzayIsCiAgICAiSW5jb25jbHVzaXZlIiwKICAgICJOb3RFbmFibGVkIiwKICAgICJFcnJvciIKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZCBFbnJvbGxtZW50UmVxdWVzdCBTdGF0dXMgCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkRW5yb2xsbWVudFJlcXVlc3RTdGF0dXMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJOT1RfRU5PVUdIX1NQRUVDSCIsCiAgICAiSU5fUFJPR1JFU1MiLAogICAgIkNPTVBMRVRFRCIsCiAgICAiRkFJTEVEIgogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBWb2ljZUlkIFNwZWFrZXIgc3RhdHVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkU3BlYWtlclN0YXR1cyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgIk9QVEVEX09VVCIsCiAgICAiRU5ST0xMRUQiLAogICAgIlBFTkRJTkciCiAgXSk7CgogIGNvbm5lY3QuVm9pY2VJZENvbnN0YW50cyA9IHsKICAgIEVWQUxVQVRFX1NFU1NJT05fREVMQVk6IDEwMDAwLAogICAgRVZBTFVBVElPTl9NQVhfUE9MTF9USU1FUzogMjQsIC8vIEV2YWx1YXRlU3BlYWtlciBpcyBQb2xsaW5nIGZvciBtYXhpbXVtIDIgbWlucy4KICAgIEVWQUxVQVRJT05fUE9MTElOR19JTlRFUlZBTDogNTAwMCwKICAgIEVOUk9MTE1FTlRfTUFYX1BPTExfVElNRVM6IDEyMCwgLy8gRW5yb2xsbWVudFNwZWFrZXIgaXMgUG9sbGluZyBmb3IgbWF4aW11bSAxMCBtaW5zLgogICAgRU5ST0xMTUVOVF9QT0xMSU5HX0lOVEVSVkFMOiA1MDAwLAogICAgU1RBUlRfU0VTU0lPTl9ERUxBWTogODAwMAogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY29uc3RhbnRzIGZvciBBZ2VudFBlcm1pc3Npb25zCiAgICovCiAgY29ubmVjdC5BZ2VudFBlcm1pc3Npb25zID0gewogICAgT1VUQk9VTkRfQ0FMTDogJ291dGJvdW5kQ2FsbCcsCiAgICBWT0lDRV9JRDogJ3ZvaWNlSWQnCiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQWdlbnQKICAgKi8KICB2YXIgQWdlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuYWdlbnQuaW5pdGlhbGl6ZWQpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcigiVGhlIGFnZW50IGlzIG5vdCB5ZXQgaW5pdGlhbGl6ZWQhIik7CiAgICB9CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFnZW50RGF0YSgpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5fY3JlYXRlQ29udGFjdEFQSSA9IGZ1bmN0aW9uIChjb250YWN0RGF0YSkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdERhdGEuY29udGFjdElkKTsKICB9OwoKICAvKioKICAgKiBAZGVwcmVjYXRlZAogICAqIFVzZSBgY29udGFjdC5vblBlbmRpbmdgIGZvciBhbnkgcGFydGljdWxhciBjb250YWN0IGluc3RlYWQuCiAgICovCiAgQWdlbnQucHJvdG90eXBlLm9uQ29udGFjdFBlbmRpbmcgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLkNPTlRBQ1RfUEVORElORywgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uUmVmcmVzaCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuUkVGUkVTSCwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uUm91dGFibGUgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLlJPVVRBQkxFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25Ob3RSb3V0YWJsZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuTk9UX1JPVVRBQkxFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25PZmZsaW5lID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5PRkZMSU5FLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25FcnJvciA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuRVJST1IsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblNvZnRwaG9uZUVycm9yID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5TT0ZUUEhPTkVfRVJST1IsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbldlYlNvY2tldENvbm5lY3Rpb25Mb3N0ID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5XRUJTT0NLRVRfQ09OTkVDVElPTl9MT1NULCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vbldlYlNvY2tldENvbm5lY3Rpb25HYWluZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLldFQlNPQ0tFVF9DT05ORUNUSU9OX0dBSU5FRCwgZik7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUub25BZnRlckNhbGxXb3JrID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5BQ1csIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblN0YXRlQ2hhbmdlID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5TVEFURV9DSEFOR0UsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbk11dGVUb2dnbGUgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkFnZW50RXZlbnRzLk1VVEVfVE9HR0xFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25Mb2NhbE1lZGlhU3RyZWFtQ3JlYXRlZCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQWdlbnRFdmVudHMuTE9DQUxfTUVESUFfU1RSRUFNX0NSRUFURUQsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblNwZWFrZXJEZXZpY2VDaGFuZ2VkID0gZnVuY3Rpb24oZil7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TUEVBS0VSX0RFVklDRV9DSEFOR0VELCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vbk1pY3JvcGhvbmVEZXZpY2VDaGFuZ2VkID0gZnVuY3Rpb24oZil7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5NSUNST1BIT05FX0RFVklDRV9DSEFOR0VELCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vblJpbmdlckRldmljZUNoYW5nZWQgPSBmdW5jdGlvbihmKXsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlJJTkdFUl9ERVZJQ0VfQ0hBTkdFRCwgZik7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUubXV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsCiAgICAgIHsKICAgICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuTVVURSwKICAgICAgICBkYXRhOiB7IG11dGU6IHRydWUgfQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUudW5tdXRlID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwKICAgICAgewogICAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5NVVRFLAogICAgICAgIGRhdGE6IHsgbXV0ZTogZmFsc2UgfQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuc2V0U3BlYWtlckRldmljZSA9IGZ1bmN0aW9uIChkZXZpY2VJZCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9TUEVBS0VSX0RFVklDRSwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldE1pY3JvcGhvbmVEZXZpY2UgPSBmdW5jdGlvbiAoZGV2aWNlSWQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfTUlDUk9QSE9ORV9ERVZJQ0UsCiAgICAgIGRhdGE6IHsgZGV2aWNlSWQ6IGRldmljZUlkIH0KICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRSaW5nZXJEZXZpY2UgPSBmdW5jdGlvbiAoZGV2aWNlSWQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfUklOR0VSX0RFVklDRSwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldFN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5zdGF0ZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0TmV4dFN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5uZXh0U3RhdGU7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldEF2YWlsYWJpbGl0eVN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5hZ2VudEF2YWlsYWJpbGl0eVN0YXRlOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRTdGF0dXMgPSBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdGU7CgogIEFnZW50LnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Qubm93KCkgLSB0aGlzLl9nZXREYXRhKCkuc25hcHNob3Quc3RhdGUuc3RhcnRUaW1lc3RhbXAuZ2V0VGltZSgpICsgY29ubmVjdC5jb3JlLmdldFNrZXcoKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdHVzRHVyYXRpb24gPSBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdGVEdXJhdGlvbjsKCiAgQWdlbnQucHJvdG90eXBlLmdldFBlcm1pc3Npb25zID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnBlcm1pc3Npb25zOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRDb250YWN0cyA9IGZ1bmN0aW9uIChjb250YWN0VHlwZUZpbHRlcikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5jb250YWN0cy5tYXAoZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVDb250YWN0QVBJKGNvbnRhY3REYXRhKTsKICAgIH0pLmZpbHRlcihmdW5jdGlvbiAoY29udGFjdCkgewogICAgICByZXR1cm4gKCFjb250YWN0VHlwZUZpbHRlcikgfHwgY29udGFjdC5nZXRUeXBlKCkgPT09IGNvbnRhY3RUeXBlRmlsdGVyOwogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNvbmZpZ3VyYXRpb247CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldEFnZW50U3RhdGVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLmFnZW50U3RhdGVzOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRSb3V0aW5nUHJvZmlsZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5yb3V0aW5nUHJvZmlsZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0Q2hhbm5lbENvbmN1cnJlbmN5ID0gZnVuY3Rpb24gKGNoYW5uZWwpIHsKICAgIHZhciBjaGFubmVsQ29uY3VycmVuY3lNYXAgPSB0aGlzLmdldFJvdXRpbmdQcm9maWxlKCkuY2hhbm5lbENvbmN1cnJlbmN5TWFwOwogICAgaWYgKCFjaGFubmVsQ29uY3VycmVuY3lNYXApIHsKICAgICAgY2hhbm5lbENvbmN1cnJlbmN5TWFwID0gT2JqZWN0LmtleXMoY29ubmVjdC5DaGFubmVsVHlwZSkucmVkdWNlKGZ1bmN0aW9uIChhY2MsIGtleSkgewogICAgICAgIC8vIEV4Y2x1ZGUgVEFTSyBmcm9tIGRlZmF1bHQgY29uY3VycmVuY3kuCiAgICAgICAgaWYgKGtleSAhPT0gJ1RBU0snKSB7CiAgICAgICAgICBhY2NbY29ubmVjdC5DaGFubmVsVHlwZVtrZXldXSA9IDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhY2M7CiAgICAgIH0sIHt9KTsKICAgIH0KICAgIHJldHVybiBjaGFubmVsCiAgICAgID8gKGNoYW5uZWxDb25jdXJyZW5jeU1hcFtjaGFubmVsXSB8fCAwKQogICAgICA6IGNoYW5uZWxDb25jdXJyZW5jeU1hcDsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0TmFtZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5uYW1lOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRFeHRlbnNpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25maWd1cmF0aW9uKCkuZXh0ZW5zaW9uOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXREaWFsYWJsZUNvdW50cmllcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5kaWFsYWJsZUNvdW50cmllczsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuaXNTb2Z0cGhvbmVFbmFibGVkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnNvZnRwaG9uZUVuYWJsZWQ7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgaWYgKGNvbmZpZ3VyYXRpb24gJiYgY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzICYmICFjb25uZWN0LmlzVmFsaWRMb2NhbGUoY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzLmxvY2FsZSkpIHsKICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3MuZmFpbHVyZSkgewogICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGNvbm5lY3QuQWdlbnRFcnJvclN0YXRlcy5JTlZBTElEX0xPQ0FMRSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5VUERBVEVfQUdFTlRfQ09ORklHVVJBVElPTiwgewogICAgICAgIGNvbmZpZ3VyYXRpb246IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChjb25maWd1cmF0aW9uLCAnY29uZmlndXJhdGlvbicpCiAgICAgIH0sIHsKICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gYXNrIHRoZSBzaGFyZWQgd29ya2VyIHRvIHJlbG9hZCBhZ2VudCBjb25maWcKICAgICAgICAgICAgLy8gb25jZSB3ZSBjaGFuZ2UgaXQgc28gZXZlcnkgdGFiIGhhcyBhY2N1cmF0ZSBjb25maWcuCiAgICAgICAgICAgIHZhciBjb25kdWl0ID0gY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCk7CiAgICAgICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlJFTE9BRF9BR0VOVF9DT05GSUdVUkFUSU9OKTsKCiAgICAgICAgICAgIGlmIChjYWxsYmFja3Muc3VjY2VzcykgewogICAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgZmFpbHVyZTogY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlCiAgICAgIH0pOwogICAgfQogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRTdGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgY2FsbGJhY2tzLCBvcHRpb25zKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlBVVF9BR0VOVF9TVEFURSwgewogICAgICBzdGF0ZTogY29ubmVjdC5hc3NlcnROb3ROdWxsKHN0YXRlLCAnc3RhdGUnKSwKICAgICAgZW5xdWV1ZU5leHRTdGF0ZTogb3B0aW9ucyAmJiAhIW9wdGlvbnMuZW5xdWV1ZU5leHRTdGF0ZQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwogIEFnZW50LnByb3RvdHlwZS5vbkVucXVldWVkTmV4dFN0YXRlID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5FTlFVRVVFRF9ORVhUX1NUQVRFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuc2V0U3RhdHVzID0gQWdlbnQucHJvdG90eXBlLnNldFN0YXRlOwoKICBBZ2VudC5wcm90b3R5cGUuY29ubmVjdCA9IGZ1bmN0aW9uIChlbmRwb2ludEluLCBwYXJhbXMpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgZW5kcG9pbnQgPSBuZXcgY29ubmVjdC5FbmRwb2ludChlbmRwb2ludEluKTsKICAgIC8vIEhhdmUgdG8gcmVtb3ZlIHRoZSBlbmRwb2ludElkIGZpZWxkIG9yIEFXUyBKUyBTREsgZ2V0cyBtYWQuCiAgICBkZWxldGUgZW5kcG9pbnQuZW5kcG9pbnRJZDsKCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX09VVEJPVU5EX0NPTlRBQ1QsIHsKICAgICAgZW5kcG9pbnQ6IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChlbmRwb2ludCwgJ2VuZHBvaW50JyksCiAgICAgIHF1ZXVlQVJOOiAocGFyYW1zICYmIChwYXJhbXMucXVldWVBUk4gfHwgcGFyYW1zLnF1ZXVlSWQpKSB8fCB0aGlzLmdldFJvdXRpbmdQcm9maWxlKCkuZGVmYXVsdE91dGJvdW5kUXVldWUucXVldWVBUk4KICAgIH0sIHBhcmFtcyAmJiB7CiAgICAgICAgc3VjY2VzczogcGFyYW1zLnN1Y2Nlc3MsCiAgICAgICAgZmFpbHVyZTogcGFyYW1zLmZhaWx1cmUKICAgICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldEFsbFF1ZXVlQVJOcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5yb3V0aW5nUHJvZmlsZS5xdWV1ZXMubWFwKGZ1bmN0aW9uIChxdWV1ZSkgewogICAgICByZXR1cm4gcXVldWUucXVldWVBUk47CiAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0RW5kcG9pbnRzID0gZnVuY3Rpb24gKHF1ZXVlQVJOcywgY2FsbGJhY2tzLCBwYWdlSW5mb0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNhbGxiYWNrcywgImNhbGxiYWNrcyIpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNhbGxiYWNrcy5zdWNjZXNzLCAiY2FsbGJhY2tzLnN1Y2Nlc3MiKTsKICAgIHZhciBwYWdlSW5mbyA9IHBhZ2VJbmZvSW4gfHwgeyB9OwoKICAgIHBhZ2VJbmZvLmVuZHBvaW50cyA9IHBhZ2VJbmZvLmVuZHBvaW50cyB8fCBbXTsKICAgIHBhZ2VJbmZvLm1heFJlc3VsdHMgPSBwYWdlSW5mby5tYXhSZXN1bHRzIHx8IGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFOwoKICAgIC8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IGFsbG93aW5nIGEgc2luZ2xlIHF1ZXVlQVJOIHRvIGJlIHNwZWNpZmllZAogICAgLy8gaW5zdGVhZCBvZiBhbiBhcnJheS4KICAgIGlmICghY29ubmVjdC5pc0FycmF5KHF1ZXVlQVJOcykpIHsKICAgICAgcXVldWVBUk5zID0gW3F1ZXVlQVJOc107CiAgICB9CgogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9FTkRQT0lOVFMsIHsKICAgICAgcXVldWVBUk5zOiBxdWV1ZUFSTnMsCiAgICAgIG5leHRUb2tlbjogcGFnZUluZm8ubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhZ2VJbmZvLm1heFJlc3VsdHMKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEubmV4dFRva2VuKSB7CiAgICAgICAgICAgIHNlbGYuZ2V0RW5kcG9pbnRzKHF1ZXVlQVJOcywgY2FsbGJhY2tzLCB7CiAgICAgICAgICAgICAgbmV4dFRva2VuOiBkYXRhLm5leHRUb2tlbiwKICAgICAgICAgICAgICBtYXhSZXN1bHRzOiBwYWdlSW5mby5tYXhSZXN1bHRzLAogICAgICAgICAgICAgIGVuZHBvaW50czogcGFnZUluZm8uZW5kcG9pbnRzLmNvbmNhdChkYXRhLmVuZHBvaW50cykKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwYWdlSW5mby5lbmRwb2ludHMgPSBwYWdlSW5mby5lbmRwb2ludHMuY29uY2F0KGRhdGEuZW5kcG9pbnRzKTsKICAgICAgICAgICAgdmFyIGVuZHBvaW50cyA9IHBhZ2VJbmZvLmVuZHBvaW50cy5tYXAoZnVuY3Rpb24gKGVuZHBvaW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LkVuZHBvaW50KGVuZHBvaW50KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjYWxsYmFja3Muc3VjY2Vzcyh7CiAgICAgICAgICAgICAgZW5kcG9pbnRzOiBlbmRwb2ludHMsCiAgICAgICAgICAgICAgYWRkcmVzc2VzOiBlbmRwb2ludHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBjYWxsYmFja3MuZmFpbHVyZQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0QWRkcmVzc2VzID0gQWdlbnQucHJvdG90eXBlLmdldEVuZHBvaW50czsKCiAgLy9JbnRlcm5hbCBpZGVudGlmaWVyLgogIEFnZW50LnByb3RvdHlwZS5fZ2V0UmVzb3VyY2VJZCA9IGZ1bmN0aW9uKCkgewogICAgcXVldWVBcm5zID0gdGhpcy5nZXRBbGxRdWV1ZUFSTnMoKTsKICAgIGZvciAobGV0IHF1ZXVlQXJuIG9mIHF1ZXVlQXJucykgewogICAgICBjb25zdCBhZ2VudElkTWF0Y2ggPSBxdWV1ZUFybi5tYXRjaCgvXC9hZ2VudFwvKFteL10rKS8pOwogICAgICAKICAgICAgaWYgKGFnZW50SWRNYXRjaCkgewogICAgICAgIHJldHVybiBhZ2VudElkTWF0Y2hbMV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBuZXcgRXJyb3IoIkFnZW50LnByb3RvdHlwZS5fZ2V0UmVzb3VyY2VJZDogcXVldWVBcm5zIGRpZCBub3QgY29udGFpbiBhZ2VudFJlc291cmNlSWQ6ICIsIHF1ZXVlQXJucyk7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUudG9TbmFwc2hvdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5BZ2VudFNuYXBzaG90KHRoaXMuX2dldERhdGEoKSk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQWdlbnRTbmFwc2hvdAogICAqLwogIHZhciBBZ2VudFNuYXBzaG90ID0gZnVuY3Rpb24gKGFnZW50RGF0YSkgewogICAgY29ubmVjdC5BZ2VudC5jYWxsKHRoaXMpOwogICAgdGhpcy5hZ2VudERhdGEgPSBhZ2VudERhdGE7CiAgfTsKICBBZ2VudFNuYXBzaG90LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQWdlbnQucHJvdG90eXBlKTsKICBBZ2VudFNuYXBzaG90LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEFnZW50U25hcHNob3Q7CgogIEFnZW50U25hcHNob3QucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuYWdlbnREYXRhOwogIH07CgogIEFnZW50U25hcHNob3QucHJvdG90eXBlLl9jcmVhdGVDb250YWN0QVBJID0gZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ29udGFjdFNuYXBzaG90KGNvbnRhY3REYXRhKTsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBDb250YWN0CiAgICovCiAgdmFyIENvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICB0aGlzLmNvbnRhY3RJZCA9IGNvbnRhY3RJZDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmdldENvbnRhY3RJZCgpKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5fY3JlYXRlQ29ubmVjdGlvbkFQSSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uRGF0YSkgewogICAgaWYgKHRoaXMuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLkNIQVQpIHsKICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LkNoYXRDb25uZWN0aW9uKHRoaXMuY29udGFjdElkLCBjb25uZWN0aW9uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgfSBlbHNlIGlmICh0aGlzLmdldFR5cGUoKSA9PT0gY29ubmVjdC5Db250YWN0VHlwZS5UQVNLKSB7CiAgICAgIHJldHVybiBuZXcgY29ubmVjdC5UYXNrQ29ubmVjdGlvbih0aGlzLmNvbnRhY3RJZCwgY29ubmVjdGlvbkRhdGEuY29ubmVjdGlvbklkKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBuZXcgY29ubmVjdC5Wb2ljZUNvbm5lY3Rpb24odGhpcy5jb250YWN0SWQsIGNvbm5lY3Rpb25EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICB9CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0RXZlbnROYW1lID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGV2ZW50TmFtZSwgdGhpcy5nZXRDb250YWN0SWQoKSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25SZWZyZXNoID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLlJFRlJFU0gpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkluY29taW5nID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLklOQ09NSU5HKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25Db25uZWN0aW5nID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkNPTk5FQ1RJTkcpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vblBlbmRpbmcgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuUEVORElORyksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uQWNjZXB0ZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbk1pc3NlZCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkVuZGVkID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkVOREVEKSwgZik7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5ERVNUUk9ZRUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkRlc3Ryb3kgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuREVTVFJPWUVEKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25BQ1cgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNXKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25Db25uZWN0ZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQ09OTkVDVEVEKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25FcnJvciA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5FUlJPUiksIGYpOwogIH0KCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29udGFjdElkOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldE9yaWdpbmFsQ29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5pbml0aWFsQ29udGFjdElkOwogIH07CiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0SW5pdGlhbENvbnRhY3RJZCA9IENvbnRhY3QucHJvdG90eXBlLmdldE9yaWdpbmFsQ29udGFjdElkOwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS50eXBlOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENvbnRhY3REdXJhdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb250YWN0RHVyYXRpb247CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc3RhdGU7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdHVzID0gQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdGU7CgogIENvbnRhY3QucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5ub3coKSAtIHRoaXMuX2dldERhdGEoKS5zdGF0ZS50aW1lc3RhbXAuZ2V0VGltZSgpICsgY29ubmVjdC5jb3JlLmdldFNrZXcoKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0dXNEdXJhdGlvbiA9IENvbnRhY3QucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb247CgogIENvbnRhY3QucHJvdG90eXBlLmdldFF1ZXVlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5xdWV1ZTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRRdWV1ZVRpbWVzdGFtcCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkucXVldWVUaW1lc3RhbXA7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNvbm5lY3Rpb25zLm1hcChmdW5jdGlvbiAoY29ubkRhdGEpIHsKICAgICAgaWYgKHNlbGYuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLkNIQVQpIHsKICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ2hhdENvbm5lY3Rpb24oc2VsZi5jb250YWN0SWQsIGNvbm5EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICAgIH0gZWxzZSBpZiAoc2VsZi5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29udGFjdFR5cGUuVEFTSykgewogICAgICAgIHJldHVybiBuZXcgY29ubmVjdC5UYXNrQ29ubmVjdGlvbihzZWxmLmNvbnRhY3RJZCwgY29ubkRhdGEuY29ubmVjdGlvbklkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuVm9pY2VDb25uZWN0aW9uKHNlbGYuY29udGFjdElkLCBjb25uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgICB9CiAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRJbml0aWFsQ29ubmVjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmZpbmQodGhpcy5nZXRDb25uZWN0aW9ucygpLCBmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubi5pc0luaXRpYWxDb25uZWN0aW9uKCk7CiAgICB9KSB8fCBudWxsOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldEFjdGl2ZUluaXRpYWxDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGluaXRpYWxDb25uID0gdGhpcy5nZXRJbml0aWFsQ29ubmVjdGlvbigpOwogICAgaWYgKGluaXRpYWxDb25uICE9IG51bGwgJiYgaW5pdGlhbENvbm4uaXNBY3RpdmUoKSkgewogICAgICByZXR1cm4gaW5pdGlhbENvbm47CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRUaGlyZFBhcnR5Q29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25uZWN0aW9ucygpLmZpbHRlcihmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gIWNvbm4uaXNJbml0aWFsQ29ubmVjdGlvbigpICYmIGNvbm4uZ2V0VHlwZSgpICE9PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLkFHRU5UOwogICAgfSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0U2luZ2xlQWN0aXZlVGhpcmRQYXJ0eUNvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRUaGlyZFBhcnR5Q29ubmVjdGlvbnMoKS5maWx0ZXIoZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm4uaXNBY3RpdmUoKTsKICAgIH0pWzBdIHx8IG51bGw7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0QWdlbnRDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuZmluZCh0aGlzLmdldENvbm5lY3Rpb25zKCksIGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHZhciBjb25uVHlwZSA9IGNvbm4uZ2V0VHlwZSgpOwogICAgICByZXR1cm4gY29ublR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuQUdFTlQgfHwgY29ublR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuTU9OSVRPUklORzsKICAgIH0pOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldE5hbWUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLm5hbWU7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29udGFjdE1ldGFkYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb250YWN0TWV0YWRhdGE7CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5nZXREZXNjcmlwdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuZGVzY3JpcHRpb247CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0UmVmZXJlbmNlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkucmVmZXJlbmNlczsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRBdHRyaWJ1dGVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5hdHRyaWJ1dGVzOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENvbnRhY3RGZWF0dXJlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuY29udGFjdEZlYXR1cmVzOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmlzU29mdHBob25lQ2FsbCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmZpbmQodGhpcy5nZXRDb25uZWN0aW9ucygpLCBmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubi5nZXRTb2Z0cGhvbmVNZWRpYUluZm8oKSAhPSBudWxsOwogICAgfSkgIT0gbnVsbDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5faXNJbmJvdW5kID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGluaXRpYXRpb25NZXRob2QgPSB0aGlzLl9nZXREYXRhKCkuaW5pdGlhdGlvbk1ldGhvZDsKICAgIHJldHVybiAoaW5pdGlhdGlvbk1ldGhvZCA9PT0gY29ubmVjdC5Db250YWN0SW5pdGlhdGlvbk1ldGhvZC5PVVRCT1VORCkgPyBmYWxzZSA6IHRydWU7CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5pc0luYm91bmQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29ubiA9IHRoaXMuZ2V0SW5pdGlhbENvbm5lY3Rpb24oKTsKCiAgICAvLyBXZSB3aWxsIGdyYWR1YWxseSBjaGFuZ2UgY2hlY2tpbmcgaW5ib3VuZCBieSByZWx5aW5nIG9uIGNvbnRhY3QgaW5pdGlhdGlvbk1ldGhvZAogICAgaWYgKGNvbm4uZ2V0TWVkaWFUeXBlKCkgPT09IGNvbm5lY3QuTWVkaWFUeXBlLlRBU0spIHsKICAgICAgcmV0dXJuIHRoaXMuX2lzSW5ib3VuZCgpOwogICAgfQoKICAgIHJldHVybiBjb25uID8gY29ubi5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuSU5CT1VORCA6IGZhbHNlOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmlzQ29ubmVjdGVkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkNPTk5FQ1RFRDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5hY2NlcHQgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNvbnRhY3RJZCA9IHRoaXMuZ2V0Q29udGFjdElkKCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQUNDRVBUX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiBjb250YWN0SWQKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgICAgICBldmVudDogY29ubmVjdC5Db250YWN0RXZlbnRzLkFDQ0VQVEVELAogICAgICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkKICAgICAgICAgIH0pOwogICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgICAgIGV2ZW50OiBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQsIHNlbGYuZ2V0Q29udGFjdElkKCkpLAogICAgICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkKICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIEluIEZpcmVmb3gsIHRoZXJlJ3MgYSBicm93c2VyIHJlc3RyaWN0aW9uIHRoYXQgYW4gdW5mb2N1c2VkIGJyb3dzZXIgdGFiIGlzIG5vdCBhbGxvd2VkIHRvIGFjY2VzcyB0aGUgdXNlcidzIG1pY3JvcGhvbmUuCiAgICAgICAgICAvLyBUaGUgcHJvYmxlbSBpcyB0aGF0IHRoZSByZXN0cmljdGlvbiBjb3VsZCBjYXVzZSBhIHdlYnJ0YyBzZXNzaW9uIGNyZWF0aW9uIHRpbWVvdXQgZXJyb3Igd2hlbiB5b3UgZ2V0IGFuIGluY29taW5nIGNhbGwgd2hpbGUgeW91IGFyZSBub3Qgb24gdGhlIHByaW1hcnkgdGFiLgogICAgICAgICAgLy8gSXQgd2FzIGhhcmQgdG8gd29ya2Fyb3VuZCB0aGUgaXNzdWUgZXNwZWNpYWxseSB3aGVuIHlvdSBoYXZlIG11bHRpcGxlIHRhYnMgb3BlbiBiZWNhdXNlIHlvdSBuZWVkZWQgdG8gZmluZCB0aGUgcmlnaHQgdGFiIGFuZCBhY2NlcHQgdGhlIGNvbnRhY3QgYmVmb3JlIHRoZSB0aW1lb3V0LgogICAgICAgICAgLy8gVG8gYXZvaWQgdGhlIGVycm9yLCB3aGVuIG11bHRpcGxlIHRhYnMgYXJlIG9wZW4gaW4gRmlyZWZveCwgYSB3ZWJydGMgc2Vzc2lvbiBpcyBub3QgaW1tZWRpYXRlbHkgY3JlYXRlZCBhcyBhbiBpbmNvbWluZyBzb2Z0cGhvbmUgY29udGFjdCBpcyBkZXRlY3RlZC4KICAgICAgICAgIC8vIEluc3RlYWQsIGl0IHdhaXRzIHVudGlsIGNvbnRhY3QuYWNjZXB0KCkgaXMgY2FsbGVkIG9uIGEgdGFiIGFuZCBsZXRzIHRoZSB0YWIgYmVjb21lIHRoZSBuZXcgcHJpbWFyeSB0YWIgYW5kIHN0YXJ0IHRoZSB3ZWIgcnRjIHNlc3Npb24gdGhlcmUKICAgICAgICAgIC8vIGJlY2F1c2UgdGhlIHRhYiBzaG91bGQgYmUgZm9jdXNlZCBhdCB0aGUgbW9tZW50IGFuZCBoYXZlIGFjY2VzcyB0byB0aGUgdXNlcidzIG1pY3JvcGhvbmUuCiAgICAgICAgICB2YXIgY29udGFjdCA9IG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKTsKICAgICAgICAgIGlmIChjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIoKSAmJiBjb250YWN0LmlzU29mdHBob25lQ2FsbCgpKSB7CiAgICAgICAgICAgIGNvbm5lY3QuY29yZS50cmlnZ2VyUmVhZHlUb1N0YXJ0U2Vzc2lvbkV2ZW50KCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3Muc3VjY2VzcykgewogICAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGNhbGxiYWNrcyA/IGNhbGxiYWNrcy5mYWlsdXJlIDogbnVsbAogICAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJjb250YWN0LmRlc3Ryb3koKSBoYXMgYmVlbiBkZXByZWNhdGVkLiIpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnJlamVjdCA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuUkVKRUNUX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmNvbXBsZXRlID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DT01QTEVURV9DT05UQUNULCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ0xFQVJfQ09OVEFDVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUubm90aWZ5SXNzdWUgPSBmdW5jdGlvbiAoaXNzdWVDb2RlLCBkZXNjcmlwdGlvbiwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLk5PVElGWV9DT05UQUNUX0lTU1VFLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgaXNzdWVDb2RlOiBpc3N1ZUNvZGUsCiAgICAgIGRlc2NyaXB0aW9uOiBkZXNjcmlwdGlvbgogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5hZGRDb25uZWN0aW9uID0gZnVuY3Rpb24gKGVuZHBvaW50SW4sIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBlbmRwb2ludCA9IG5ldyBjb25uZWN0LkVuZHBvaW50KGVuZHBvaW50SW4pOwogICAgLy8gSGF2ZSB0byByZW1vdmUgdGhlIGVuZHBvaW50SWQgZmllbGQgb3IgQVdTIEpTIFNESyBnZXRzIG1hZC4KICAgIGRlbGV0ZSBlbmRwb2ludC5lbmRwb2ludElkOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfQURESVRJT05BTF9DT05ORUNUSU9OLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgZW5kcG9pbnQ6IGVuZHBvaW50CiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnRvZ2dsZUFjdGl2ZUNvbm5lY3Rpb25zID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBjb25uZWN0aW9uSWQgPSBudWxsOwogICAgdmFyIGhvbGRpbmdDb25uID0gY29ubmVjdC5maW5kKHRoaXMuZ2V0Q29ubmVjdGlvbnMoKSwgZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm4uZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkhPTEQ7CiAgICB9KTsKCiAgICBpZiAoaG9sZGluZ0Nvbm4gIT0gbnVsbCkgewogICAgICBjb25uZWN0aW9uSWQgPSBob2xkaW5nQ29ubi5nZXRDb25uZWN0aW9uSWQoKTsKCiAgICB9IGVsc2UgewogICAgICB2YXIgYWN0aXZlQ29ubnMgPSB0aGlzLmdldENvbm5lY3Rpb25zKCkuZmlsdGVyKGZ1bmN0aW9uIChjb25uKSB7CiAgICAgICAgcmV0dXJuIGNvbm4uaXNBY3RpdmUoKTsKICAgICAgfSk7CiAgICAgIGlmIChhY3RpdmVDb25ucy5sZW5ndGggPiAwKSB7CiAgICAgICAgY29ubmVjdGlvbklkID0gYWN0aXZlQ29ubnNbMF0uZ2V0Q29ubmVjdGlvbklkKCk7CiAgICAgIH0KICAgIH0KCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuVE9HR0xFX0FDVElWRV9DT05ORUNUSU9OUywgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogY29ubmVjdGlvbklkCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnNlbmRTb2Z0cGhvbmVNZXRyaWNzID0gZnVuY3Rpb24gKHNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MsIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuU0VORF9TT0ZUUEhPTkVfQ0FMTF9NRVRSSUNTLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2NwVmVyc2lvbjogZ2xvYmFsLmNjcFZlcnNpb24sCiAgICAgIHNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3M6IHNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MKICAgIH0sIGNhbGxiYWNrcyk7CgogICAgY29ubmVjdC5wdWJsaXNoU29mdHBob25lU3RhdHMoewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNjcFZlcnNpb246IGdsb2JhbC5jY3BWZXJzaW9uLAogICAgICBzdGF0czogc29mdHBob25lU3RyZWFtU3RhdGlzdGljcwogICAgfSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuc2VuZFNvZnRwaG9uZVJlcG9ydCA9IGZ1bmN0aW9uIChyZXBvcnQsIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX1NPRlRQSE9ORV9DQUxMX1JFUE9SVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNjcFZlcnNpb246IGdsb2JhbC5jY3BWZXJzaW9uLAogICAgICByZXBvcnQ6IHJlcG9ydAogICAgfSwgY2FsbGJhY2tzKTsKCiAgICBjb25uZWN0LnB1Ymxpc2hTb2Z0cGhvbmVSZXBvcnQoewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNjcFZlcnNpb246IGdsb2JhbC5jY3BWZXJzaW9uLAogICAgICByZXBvcnQ6IHJlcG9ydAogICAgfSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuY29uZmVyZW5jZUNvbm5lY3Rpb25zID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DT05GRVJFTkNFX0NPTk5FQ1RJT05TLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS50b1NuYXBzaG90ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkNvbnRhY3RTbmFwc2hvdCh0aGlzLl9nZXREYXRhKCkpOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbnRhY3RTbmFwc2hvdAogICAqLwogIHZhciBDb250YWN0U25hcHNob3QgPSBmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgIGNvbm5lY3QuQ29udGFjdC5jYWxsKHRoaXMsIGNvbnRhY3REYXRhLmNvbnRhY3RJZCk7CiAgICB0aGlzLmNvbnRhY3REYXRhID0gY29udGFjdERhdGE7CiAgfTsKICBDb250YWN0U25hcHNob3QucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb250YWN0LnByb3RvdHlwZSk7CiAgQ29udGFjdFNuYXBzaG90LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENvbnRhY3RTbmFwc2hvdDsKCiAgQ29udGFjdFNuYXBzaG90LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbnRhY3REYXRhOwogIH07CgogIENvbnRhY3RTbmFwc2hvdC5wcm90b3R5cGUuX2NyZWF0ZUNvbm5lY3Rpb25BUEkgPSBmdW5jdGlvbiAoY29ubmVjdGlvbkRhdGEpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db25uZWN0aW9uU25hcHNob3QoY29ubmVjdGlvbkRhdGEpOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbm5lY3Rpb24KICAgKi8KICB2YXIgQ29ubmVjdGlvbiA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgdGhpcy5jb250YWN0SWQgPSBjb250YWN0SWQ7CiAgICB0aGlzLmNvbm5lY3Rpb25JZCA9IGNvbm5lY3Rpb25JZDsKICAgIHRoaXMuX2luaXRNZWRpYUNvbnRyb2xsZXIoKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb25uZWN0aW9uRGF0YSgKICAgICAgdGhpcy5nZXRDb250YWN0SWQoKSwgdGhpcy5nZXRDb25uZWN0aW9uSWQoKSk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Q29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29udGFjdElkOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldENvbm5lY3Rpb25JZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbm5lY3Rpb25JZDsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRFbmRwb2ludCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5FbmRwb2ludCh0aGlzLl9nZXREYXRhKCkuZW5kcG9pbnQpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldEFkZHJlc3MgPSBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRFbmRwb2ludDsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnN0YXRlOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXR1cyA9IENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXRlOwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Qubm93KCkgLSB0aGlzLl9nZXREYXRhKCkuc3RhdGUudGltZXN0YW1wLmdldFRpbWUoKSArIGNvbm5lY3QuY29yZS5nZXRTa2V3KCk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdHVzRHVyYXRpb24gPSBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uOwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS50eXBlOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmlzSW5pdGlhbENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmluaXRpYWw7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNBY3RpdmUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb250YWlucyhjb25uZWN0LkNPTk5FQ1RJT05fQUNUSVZFX1NUQVRFUywgdGhpcy5nZXRTdGF0dXMoKS50eXBlKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5pc0Nvbm5lY3RlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNURUQ7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNDb25uZWN0aW5nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RJTkc7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNPbkhvbGQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuSE9MRDsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTb2Z0cGhvbmVNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNvZnRwaG9uZU1lZGlhSW5mbzsKICB9OwoKICAvKioKICAgKiBHZXRzIHRoZSBjdXJyZW50bHkgbW9uaXRvcmVkIGNvbnRhY3QgaW5mbywgUmV0dXJucyBudWxsIGlmIGRvZXMgbm90IGV4aXN0cy4KICAgKiBAcmV0dXJuIHt7YWdlbnROYW1lOnN0cmluZywgY3VzdG9tZXJOYW1lOnN0cmluZywgam9pblRpbWU6RGF0ZX19CiAgICovCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TW9uaXRvckluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLm1vbml0b3JpbmdJbmZvOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkRFU1RST1lfQ09OTkVDVElPTiwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5zZW5kRGlnaXRzID0gZnVuY3Rpb24gKGRpZ2l0cywgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfRElHSVRTLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY29ubmVjdGlvbklkOiB0aGlzLmdldENvbm5lY3Rpb25JZCgpLAogICAgICBkaWdpdHM6IGRpZ2l0cwogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5ob2xkID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5IT0xEX0NPTk5FQ1RJT04sIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUucmVzdW1lID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5SRVNVTUVfQ09OTkVDVElPTiwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS50b1NuYXBzaG90ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkNvbm5lY3Rpb25TbmFwc2hvdCh0aGlzLl9nZXREYXRhKCkpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLl9pbml0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMuZ2V0TWVkaWFJbmZvKCkpIHsKICAgICAgY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcykuY2F0Y2goZnVuY3Rpb24gKCkgeyB9KTsKICAgIH0KICB9CgogIC8vIE1ldGhvZCBmb3IgY2hlY2tpbmcgd2hldGhlciB0aGlzIGNvbm5lY3Rpb24gaXMgYW4gYWdlbnQtc2lkZSBjb25uZWN0aW9uIAogIC8vICh0eXBlIEFHRU5UIG9yIE1PTklUT1JJTkcpCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuX2lzQWdlbnRDb25uZWN0aW9uVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBjb25uZWN0aW9uVHlwZSA9IHRoaXMuZ2V0VHlwZSgpOwogICAgcmV0dXJuIGNvbm5lY3Rpb25UeXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLkFHRU5UIAogICAgICB8fCBjb25uZWN0aW9uVHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5NT05JVE9SSU5HOwogIH0KCiAgLyoqCiAgICogVXRpbGl0eSBtZXRob2QgZm9yIGNoZWNraW5nIHdoZXRoZXIgdGhpcyBjb25uZWN0aW9uIGlzIGFuIGFnZW50LXNpZGUgY29ubmVjdGlvbiAKICAgKiAodHlwZSBBR0VOVCBvciBNT05JVE9SSU5HKQogICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhpcyBjb25uZWN0aW9uIGlzIGFuIGFnZW50LXNpZGUgY29ubmVjdGlvbi4gRmFsc2Ugb3RoZXJ3aXNlLgogICAqLwogIENvbm5lY3Rpb24ucHJvdG90eXBlLl9pc0FnZW50Q29ubmVjdGlvblR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29ubmVjdGlvblR5cGUgPSB0aGlzLmdldFR5cGUoKTsKICAgIHJldHVybiBjb25uZWN0aW9uVHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5BR0VOVCAKICAgICAgfHwgY29ubmVjdGlvblR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuTU9OSVRPUklORzsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogVm9pY2UgYXV0aGVudGljYXRvciBWb2ljZUlkCiAgKi8KIAogIHZhciBWb2ljZUlkID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgdGhpcy5jb250YWN0SWQgPSBjb250YWN0SWQ7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuZ2V0U3BlYWtlcklkID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuR0VUX0NPTlRBQ1QsIHsKICAgICAgICAiY29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgImF3c0FjY291bnRJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFXU0FjY291bnRJZCgpCiAgICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgaWYoZGF0YS5jb250YWN0RGF0YS5jdXN0b21lcklkKSB7CiAgICAgICAgICAgICAgdmFyIG9iaiA9IHsKICAgICAgICAgICAgICAgIHNwZWFrZXJJZDogZGF0YS5jb250YWN0RGF0YS5jdXN0b21lcklkCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZ2V0U3BlYWtlcklkIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICByZXNvbHZlKG9iaik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5OT19TUEVBS0VSX0lEX0ZPVU5ELCAiTm8gc3BlYWtlcklkIGFzc290aWF0ZWQgd2l0aCB0aGlzIGNhbGwiKTsKICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgfSwKICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiR2V0IFNwZWFrZXJJZCBmYWlsZWQiKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgIGVycjogZXJyCiAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5HRVRfU1BFQUtFUl9JRF9GQUlMRUQsICJHZXQgU3BlYWtlcklkIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5nZXRTcGVha2VyU3RhdHVzID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgc2VsZi5nZXRTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5ERVNDUklCRV9TUEVBS0VSLCB7CiAgICAgICAgICAgICJTcGVha2VySWQiOiBjb25uZWN0LmFzc2VydE5vdE51bGwoZGF0YS5zcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXRTcGVha2VyU3RhdHVzIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3I7CiAgICAgICAgICAgICAgICB2YXIgcGFyc2VkRXJyID0gSlNPTi5wYXJzZShlcnIpOwogICAgICAgICAgICAgICAgc3dpdGNoKHBhcnNlZEVyci5zdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgY2FzZSA0MDA6CiAgICAgICAgICAgICAgICAgIGNhc2UgNDA0OgogICAgICAgICAgICAgICAgICAgIHZhciBkYXRhID0gcGFyc2VkRXJyOwogICAgICAgICAgICAgICAgICAgIGRhdGEudHlwZSA9IGRhdGEudHlwZSA/IGRhdGEudHlwZSA6IGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU1BFQUtFUl9JRF9OT1RfRU5ST0xMRUQ7CiAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJTcGVha2VyIGlzIG5vdCBlbnJvbGxlZC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0U3BlYWtlclN0YXR1cyBmYWlsZWQiKQogICAgICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgICAgIGVycjogZXJyCiAgICAgICAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkdFVF9TUEVBS0VSX1NUQVRVU19GQUlMRUQsICJHZXQgU3BlYWtlclN0YXR1cyBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIC8vIGludGVybmFsIG9ubHkKICBWb2ljZUlkLnByb3RvdHlwZS5fb3B0T3V0U3BlYWtlckluTGNtcyA9IGZ1bmN0aW9uIChzcGVha2VySWQpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5VUERBVEVfVk9JQ0VfSURfREFUQSwgewogICAgICAgICJDb250YWN0SWQiOiBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAiSW5zdGFuY2VJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEluc3RhbmNlSWQoKSwKICAgICAgICAiQVdTQWNjb3VudElkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0QVdTQWNjb3VudElkKCksCiAgICAgICAgIkN1c3RvbWVySWQiOiBjb25uZWN0LmFzc2VydE5vdE51bGwoc3BlYWtlcklkLCAnc3BlYWtlcklkJyksCiAgICAgICAgIlZvaWNlSWRSZXN1bHQiOiB7CiAgICAgICAgICAiU3BlYWtlck9wdGVkT3V0IjogdHJ1ZQogICAgICAgIH0KICAgICAgICB9LCB7CiAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIm9wdE91dFNwZWFrZXJJbkxjbXMgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgfSwKICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigib3B0T3V0U3BlYWtlckluTGNtcyBmYWlsZWQiKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5PUFRfT1VUX1NQRUFLRVJfSU5fTENNU19GQUlMRUQsICJvcHRPdXRTcGVha2VySW5MY21zIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLm9wdE91dFNwZWFrZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldFNwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgc2VsZi5nZXREb21haW5JZCgpLnRoZW4oZnVuY3Rpb24oZG9tYWluSWQpIHsKICAgICAgICAgIHZhciBzcGVha2VySWQgPSBkYXRhLnNwZWFrZXJJZDsKICAgICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLk9QVF9PVVRfU1BFQUtFUiwgewogICAgICAgICAgICAiU3BlYWtlcklkIjogY29ubmVjdC5hc3NlcnROb3ROdWxsKHNwZWFrZXJJZCwgJ3NwZWFrZXJJZCcpLAogICAgICAgICAgICAiRG9tYWluSWQiIDogZG9tYWluSWQKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICBzZWxmLl9vcHRPdXRTcGVha2VySW5MY21zKHNwZWFrZXJJZCkuY2F0Y2goZnVuY3Rpb24oKXt9KTsKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygib3B0T3V0U3BlYWtlciBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigib3B0T3V0U3BlYWtlciBmYWlsZWQiKQogICAgICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLk9QVF9PVVRfU1BFQUtFUl9GQUlMRUQsICJvcHRPdXRTcGVha2VyIGZhaWxlZC4iLCBlcnIpOwogICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgfSk7CiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycil7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuZGVsZXRlU3BlYWtlciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuZ2V0U3BlYWtlcklkKCkudGhlbihmdW5jdGlvbihkYXRhKXsKICAgICAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuREVMRVRFX1NQRUFLRVIsIHsKICAgICAgICAgICAgIlNwZWFrZXJJZCI6IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChkYXRhLnNwZWFrZXJJZCwgJ3NwZWFrZXJJZCcpLAogICAgICAgICAgICAiRG9tYWluSWQiIDogZG9tYWluSWQKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImRlbGV0ZVNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImRlbGV0ZVNwZWFrZXIgZmFpbGVkIikKICAgICAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5ERUxFVEVfU1BFQUtFUl9GQUlMRUQsICJkZWxldGVTcGVha2VyIGZhaWxlZC4iLCBlcnIpOwogICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgfSk7CiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycil7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuc3RhcnRTZXNzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgc2VsZi5nZXREb21haW5JZCgpLnRoZW4oZnVuY3Rpb24oZG9tYWluSWQpIHsKICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5TVEFSVF9WT0lDRV9JRF9TRVNTSU9OLCB7CiAgICAgICAgICAiY29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgICAiaW5zdGFuY2VJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEluc3RhbmNlSWQoKSwKICAgICAgICAgICJjdXN0b21lckFjY291bnRJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFXU0FjY291bnRJZCgpLAogICAgICAgICAgImNsaWVudFRva2VuIjogQVdTLnV0aWwudXVpZC52NCgpLAogICAgICAgICAgImRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgICB9LCB7CiAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgaWYoZGF0YS5zZXNzaW9uSWQpIHsKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN0YXJ0Vm9pY2VJZFNlc3Npb24gZmFpbGVkLCBubyBzZXNzaW9uIGlkIHJldHVybmVkIikKICAgICAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU1RBUlRfU0VTU0lPTl9GQUlMRUQsICJObyBzZXNzaW9uIGlkIHJldHVybmVkIGZyb20gc3RhcnQgc2Vzc2lvbiBhcGkiKTsKICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3RhcnRWb2ljZUlkU2Vzc2lvbiBmYWlsZWQiKQogICAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgICBlcnI6IGVycgogICAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlNUQVJUX1NFU1NJT05fRkFJTEVELCAic3RhcnRWb2ljZUlkU2Vzc2lvbiBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICByZWplY3QoZXJyKTsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5ldmFsdWF0ZVNwZWFrZXIgPSBmdW5jdGlvbiAoc3RhcnROZXcpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuY29udGFjdElkKTsKICAgIHZhciBwb2xsVGltZXMgPSAwOyAKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGZ1bmN0aW9uIGV2YWx1YXRlKCkgewogICAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5FVkFMVUFURV9TRVNTSU9OLCB7CiAgICAgICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICAgICAiRG9tYWluSWQiIDogZG9tYWluSWQKICAgICAgICAgIH0sIHsKICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICBpZigrK3BvbGxUaW1lcyA8IGNvbm5lY3QuVm9pY2VJZENvbnN0YW50cy5FVkFMVUFUSU9OX01BWF9QT0xMX1RJTUVTKSB7CiAgICAgICAgICAgICAgICBpZihkYXRhLlN0cmVhbWluZ1N0YXR1cyA9PT0gY29ubmVjdC5Wb2ljZUlkU3RyZWFtaW5nU3RhdHVzLlBFTkRJTkdfQ09ORklHVVJBVElPTikgewogICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGV2YWx1YXRlLCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRVZBTFVBVElPTl9QT0xMSU5HX0lOVEVSVkFMKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmKCFkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdCA9IHt9OwogICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5OT1RfRU5BQkxFRDsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgaWYoIWRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICBkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0ID0ge307CiAgICAgICAgICAgICAgICAgICAgZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLk5PVF9FTkFCTEVEOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlIGlmIGJvdGggYXV0aGVudGljYXRpb24gYW5kIGZyYXVkIGRldGVjdGlvbiBhcmUgbm90IGVuYWJsZWQuCiAgICAgICAgICAgICAgICAgIGlmKCFzZWxmLmlzQXV0aEVuYWJsZWQoZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikgJiYgCiAgICAgICAgICAgICAgICAgICAgIXNlbGYuaXNGcmF1ZEVuYWJsZWQoZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZXZhbHVhdGVTcGVha2VyIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmKGRhdGEuU3RyZWFtaW5nU3RhdHVzID09PSBjb25uZWN0LlZvaWNlSWRTdHJlYW1pbmdTdGF0dXMuRU5ERUQpIHsKICAgICAgICAgICAgICAgICAgICBpZihzZWxmLmlzQXV0aFJlc3VsdE5vdEVub3VnaFNwZWVjaChkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLklOQ09OQ0xVU0lWRTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYoc2VsZi5pc0ZyYXVkUmVzdWx0Tm90RW5vdWdoU3BlZWNoKGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0ZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uSU5DT05DTFVTSVZFOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAvLyBWb2ljZSBwcmludCBpcyBub3QgbG9uZyBlbm91Z2ggZm9yIGJvdGggYXV0aGVudGljYXRpb24gYW5kIGZyYXVkIGRldGVjdGlvbgogICAgICAgICAgICAgICAgICBpZihzZWxmLmlzQXV0aFJlc3VsdEluY29uY2x1c2l2ZShkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uKSAmJgogICAgICAgICAgICAgICAgICAgIHNlbGYuaXNGcmF1ZFJlc3VsdEluY29uY2x1c2l2ZShkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJldmFsdWF0ZVNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgaWYoIXNlbGYuaXNBdXRoUmVzdWx0Tm90RW5vdWdoU3BlZWNoKGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24pICYmIAogICAgICAgICAgICAgICAgICAgIHNlbGYuaXNBdXRoRW5hYmxlZChkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uKSkgewogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikgewogICAgICAgICAgICAgICAgICAgICAgY2FzZSBjb25uZWN0LlZvaWNlSWRBdXRoZW50aWNhdGlvbkRlY2lzaW9uLkFDQ0VQVDoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLkFVVEhFTlRJQ0FURUQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSBjb25uZWN0LlZvaWNlSWRBdXRoZW50aWNhdGlvbkRlY2lzaW9uLlJFSkVDVDoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLk5PVF9BVVRIRU5USUNBVEVEOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkQXV0aGVudGljYXRpb25EZWNpc2lvbi5TUEVBS0VSX09QVEVEX09VVDoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLk9QVEVEX09VVDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEF1dGhlbnRpY2F0aW9uRGVjaXNpb24uU1BFQUtFUl9OT1RfRU5ST0xMRUQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5OT1RfRU5ST0xMRUQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLkVSUk9SOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgaWYoIXNlbGYuaXNGcmF1ZFJlc3VsdE5vdEVub3VnaFNwZWVjaChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSAmJiAKICAgICAgICAgICAgICAgICAgICBzZWxmLmlzRnJhdWRFbmFibGVkKGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uSElHSF9SSVNLOgogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0ZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uSElHSF9SSVNLOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkRnJhdWREZXRlY3Rpb25EZWNpc2lvbi5MT1dfUklTSzoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLkxPV19SSVNLOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5FUlJPUjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmKCFzZWxmLmlzQXV0aFJlc3VsdE5vdEVub3VnaFNwZWVjaChkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uKSAmJgogICAgICAgICAgICAgICAgICAgICFzZWxmLmlzRnJhdWRSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmUgb25seSB3aGVuIGJvdGggYXV0aGVudGljYXRpb24gYW5kIGZyYXVkIGRldGVjdGlvbiBoYXZlIHJlc3VsdHMuIE90aGVyd2lzZSwga2VlcCBwb2xsaW5nLgogICAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJldmFsdWF0ZVNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGV2YWx1YXRlLCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRVZBTFVBVElPTl9QT0xMSU5HX0lOVEVSVkFMKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJldmFsdWF0ZVNwZWFrZXIgdGltZW91dCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkVWQUxVQVRFX1NQRUFLRVJfVElNRU9VVCwgImV2YWx1YXRlU3BlYWtlciB0aW1lb3V0Iik7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIHZhciBlcnJvcjsKICAgICAgICAgICAgICB2YXIgcGFyc2VkRXJyID0gSlNPTi5wYXJzZShlcnIpOwogICAgICAgICAgICAgIHN3aXRjaChwYXJzZWRFcnIuc3RhdHVzKSB7CiAgICAgICAgICAgICAgICBjYXNlIDQwMDoKICAgICAgICAgICAgICAgIGNhc2UgNDA0OgogICAgICAgICAgICAgICAgICBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU0VTU0lPTl9OT1RfRVhJU1RTLCAiZXZhbHVhdGVTcGVha2VyIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIiwgZXJyKTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZXZhbHVhdGVTcGVha2VyIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkVWQUxVQVRFX1NQRUFLRVJfRkFJTEVELCAiZXZhbHVhdGVTcGVha2VyIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImV2YWx1YXRlU3BlYWtlciBmYWlsZWQiKS53aXRoT2JqZWN0KHsgZXJyOiBlcnIgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsgICAgCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pCiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICAKICAgICAgaWYoIXN0YXJ0TmV3KSB7CiAgICAgICAgc2VsZi5zeW5jU3BlYWtlcklkKCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICBldmFsdWF0ZSgpOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN5bmNTcGVha2VySWQgZmFpbGVkIHdoZW4gc2Vzc2lvbiBzdGFydE5ldz1mYWxzZSIpCiAgICAgICAgICAgICAgICAud2l0aE9iamVjdCh7ZXJyOiBlcnJ9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgfSkKICAgICAgfSBlbHNlIHsgCiAgICAgICAgc2VsZi5zdGFydFNlc3Npb24oKS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgIHNlbGYuc3luY1NwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICBzZXRUaW1lb3V0KGV2YWx1YXRlLCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRVZBTFVBVEVfU0VTU0lPTl9ERUxBWSk7CiAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3luY1NwZWFrZXJJZCBmYWlsZWQgd2hlbiBzZXNzaW9uIHN0YXJ0TmV3PXRydWUiKQogICAgICAgICAgICAgICAgLndpdGhPYmplY3Qoe2VycjogZXJyfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJzdGFydFNlc3Npb24gZmFpbGVkIHdoZW4gc2Vzc2lvbiBzdGFydE5ldz10cnVlIikKICAgICAgICAgICAgICAud2l0aE9iamVjdCh7ZXJyOiBlcnJ9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVqZWN0KGVycikKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuZGVzY3JpYmVTZXNzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuY29udGFjdElkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuREVTQ1JJQkVfU0VTU0lPTiwgewogICAgICAgICAgIlNlc3Npb25OYW1lT3JJZCI6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgdGhpcy5jb250YWN0SWQsCiAgICAgICAgICAiRG9tYWluSWQiIDogZG9tYWluSWQKICAgICAgICB9LCB7CiAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICByZXNvbHZlKGRhdGEpCiAgICAgICAgICB9LAogICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJkZXNjcmliZVNlc3Npb24gZmFpbGVkIikKICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICBlcnI6IGVycgogICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuREVTQ1JJQkVfU0VTU0lPTl9GQUlMRUQsICJkZXNjcmliZVNlc3Npb24gZmFpbGVkIiwgZXJyKTsKICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICByZWplY3QoZXJyKTsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5jaGVja0Vucm9sbG1lbnRTdGF0dXMgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcG9sbGluZ1RpbWVzID0gMDsKCiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBmdW5jdGlvbiBkZXNjcmliZSAoKSB7CiAgICAgICAgaWYoKytwb2xsaW5nVGltZXMgPCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRU5ST0xMTUVOVF9NQVhfUE9MTF9USU1FUykgewogICAgICAgICAgc2VsZi5kZXNjcmliZVNlc3Npb24oKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICBzd2l0Y2goZGF0YS5TZXNzaW9uLkVucm9sbG1lbnRSZXF1ZXN0RGV0YWlscy5TdGF0dXMpIHsKICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLkNPTVBMRVRFRDoKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLklOX1BST0dSRVNTOgogICAgICAgICAgICAgICAgc2V0VGltZW91dChkZXNjcmliZSwgY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVOUk9MTE1FTlRfUE9MTElOR19JTlRFUlZBTCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLk5PVF9FTk9VR0hfU1BFRUNIOgogICAgICAgICAgICAgICAgaWYoZGF0YS5TZXNzaW9uLlN0cmVhbWluZ1N0YXR1cyAhPT0gY29ubmVjdC5Wb2ljZUlkU3RyZWFtaW5nU3RhdHVzLkVOREVEKSB7CiAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZGVzY3JpYmUsY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVOUk9MTE1FTlRfUE9MTElOR19JTlRFUlZBTCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zdGFydFNlc3Npb24oKS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaWJlKCk7CiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyLCBkYXRhKXsKICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB9LCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuU1RBUlRfU0VTU0lPTl9ERUxBWSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBkYXRhLlNlc3Npb24uRW5yb2xsbWVudFJlcXVlc3REZXRhaWxzLk1lc3NhZ2UgPyBkYXRhLlNlc3Npb24uRW5yb2xsbWVudFJlcXVlc3REZXRhaWxzLk1lc3NhZ2UgOiAiZW5yb2xsU3BlYWtlciBmYWlsZWQuIFVua25vd24gZW5yb2xsbWVudCBzdGF0dXMgaGFzIGJlZW4gcmVjZWl2ZWQiOwogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcihtZXNzYWdlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogIAkJICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuRU5ST0xMX1NQRUFLRVJfRkFJTEVELCBtZXNzYWdlLCBkYXRhLlNlc3Npb24uRW5yb2xsbWVudFJlcXVlc3REZXRhaWxzLlN0YXR1cyk7CiAgCQkgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImVucm9sbFNwZWFrZXIgdGltZW91dCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkVOUk9MTF9TUEVBS0VSX1RJTUVPVVQsICJlbnJvbGxTcGVha2VyIHRpbWVvdXQiKTsKICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGRlc2NyaWJlKCk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5lbnJvbGxTcGVha2VyID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuc3luY1NwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5nZXRTcGVha2VyU3RhdHVzKCkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICBpZihkYXRhLlNwZWFrZXIgJiYgZGF0YS5TcGVha2VyLlN0YXR1cyA9PSBjb25uZWN0LlZvaWNlSWRTcGVha2VyU3RhdHVzLk9QVEVEX09VVCkgewogICAgICAgICAgICBzZWxmLmRlbGV0ZVNwZWFrZXIoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNlbGYuZW5yb2xsU3BlYWtlckhlbHBlcihyZXNvbHZlLCByZWplY3QpOwogICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxmLmVucm9sbFNwZWFrZXJIZWxwZXIocmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgIH0KICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pCiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgIHJlamVjdChlcnIpCiAgICAgIH0pCiAgICB9KQogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuZW5yb2xsU3BlYWtlckhlbHBlciA9IGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5FTlJPTExfQllfU0VTU0lPTiwgewogICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICJEb21haW5JZCIgOiBkb21haW5JZAogICAgICAgIH0sIHsKICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgIGlmKGRhdGEuU3RhdHVzID09PSBjb25uZWN0LlZvaWNlSWRFbnJvbGxtZW50UmVxdWVzdFN0YXR1cy5DT01QTEVURUQpIHsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImVucm9sbFNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2VsZi5jaGVja0Vucm9sbG1lbnRTdGF0dXMoKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJlbnJvbGxTcGVha2VyIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImVucm9sbFNwZWFrZXIgZmFpbGVkIikKICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICBlcnI6IGVycgogICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuRU5ST0xMX1NQRUFLRVJfRkFJTEVELCAiZW5yb2xsU3BlYWtlciBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgIHJlamVjdChlcnIpOwogICAgfSk7CiAgfTsKCiAgLy8gaW50ZXJuYWwgb25seQogIFZvaWNlSWQucHJvdG90eXBlLl91cGRhdGVTcGVha2VySWRJbkxjbXMgPSBmdW5jdGlvbiAoc3BlYWtlcklkKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuVVBEQVRFX1ZPSUNFX0lEX0RBVEEsIHsKICAgICAgICAiQ29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgIkluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgIkFXU0FjY291bnRJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFXU0FjY291bnRJZCgpLAogICAgICAgICJDdXN0b21lcklkIjogY29ubmVjdC5hc3NlcnROb3ROdWxsKHNwZWFrZXJJZCwgJ3NwZWFrZXJJZCcpLAogICAgICAgICJWb2ljZUlkUmVzdWx0IjogewogICAgICAgICAgImdlbmVyYXRlZFNwZWFrZXJJZCI6IHNwZWFrZXJJZAogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInVwZGF0ZVNwZWFrZXJJZEluTGNtcyBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigidXBkYXRlU3BlYWtlcklkSW5MY21zIGZhaWxlZCIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5VUERBVEVfU1BFQUtFUl9JRF9JTl9MQ01TX0ZBSUxFRCwgInVwZGF0ZVNwZWFrZXJJZEluTGNtcyBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS51cGRhdGVTcGVha2VySWRJblZvaWNlSWQgPSBmdW5jdGlvbiAoc3BlYWtlcklkKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlVQREFURV9TRVNTSU9OLCB7CiAgICAgICAgICAiU2Vzc2lvbk5hbWVPcklkIjogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCB0aGlzLmNvbnRhY3RJZCwKICAgICAgICAgICJTcGVha2VySWQiOiBjb25uZWN0LmFzc2VydE5vdE51bGwoc3BlYWtlcklkLCAnc3BlYWtlcklkJyksCiAgICAgICAgICAiRG9tYWluSWQiIDogZG9tYWluSWQKICAgICAgICAgIH0sIHsKICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZCBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgc2VsZi5fdXBkYXRlU3BlYWtlcklkSW5MY21zKHNwZWFrZXJJZCkKICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIHZhciBlcnJvcjsKICAgICAgICAgICAgICB2YXIgcGFyc2VkRXJyID0gSlNPTi5wYXJzZShlcnIpOwogICAgICAgICAgICAgIHN3aXRjaChwYXJzZWRFcnIuc3RhdHVzKSB7CiAgICAgICAgICAgICAgICBjYXNlIDQwMDoKICAgICAgICAgICAgICAgIGNhc2UgNDA0OgogICAgICAgICAgICAgICAgICBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU0VTU0lPTl9OT1RfRVhJU1RTLCAidXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIiwgZXJyKTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigidXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlVQREFURV9TUEVBS0VSX0lEX0ZBSUxFRCwgInVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZCBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJ1cGRhdGVTcGVha2VySWRJblZvaWNlSWQgZmFpbGVkIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7ICAgIAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuc3luY1NwZWFrZXJJZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuZ2V0U3BlYWtlcklkKCkudGhlbihmdW5jdGlvbihkYXRhKXsKICAgICAgICBzZWxmLnVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZChkYXRhLnNwZWFrZXJJZCkudGhlbihmdW5jdGlvbihkYXRhKXsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9KQogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pCiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5nZXREb21haW5JZCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY29uc3QgYWdlbnQgPSBuZXcgY29ubmVjdC5BZ2VudCgpOwogICAgICBpZiAoIWFnZW50LmdldFBlcm1pc3Npb25zKCkuaW5jbHVkZXMoY29ubmVjdC5BZ2VudFBlcm1pc3Npb25zLlZPSUNFX0lEKSkgewogICAgICAgIHJlamVjdChuZXcgRXJyb3IoIkFnZW50IGRvZXNuJ3QgaGF2ZSB0aGUgcGVybWlzc2lvbiBmb3IgVm9pY2UgSUQiKSk7CiAgICAgIH0gZWxzZSBpZiAoY29ubmVjdC5jb3JlLnZvaWNlSWREb21haW5JZCkgewogICAgICAgIHJlc29sdmUoY29ubmVjdC5jb3JlLnZvaWNlSWREb21haW5JZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5MSVNUX0lOVEVHUkFUSU9OX0FTU09DSUFUSU9OUywgewogICAgICAgICAgIkluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgICAiSW50ZWdyYXRpb25UeXBlIjogIlZPSUNFX0lEIgogICAgICAgIH0sIHsKICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIGRvbWFpbklkOwogICAgICAgICAgICAgIGlmIChkYXRhLkludGVncmF0aW9uQXNzb2NpYXRpb25TdW1tYXJ5TGlzdC5sZW5ndGggPj0gMSkgewogICAgICAgICAgICAgICAgdmFyIGludGVncmF0aW9uQXJuID0gZGF0YS5JbnRlZ3JhdGlvbkFzc29jaWF0aW9uU3VtbWFyeUxpc3RbMF0uSW50ZWdyYXRpb25Bcm47CiAgICAgICAgICAgICAgICBkb21haW5JZCA9IGludGVncmF0aW9uQXJuLnJlcGxhY2UoL14uKmRvbWFpblwvL2ksICcnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFkb21haW5JZCkgewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXREb21haW5JZDogbm8gZG9tYWluSWQgZm91bmQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5OT19ET01BSU5fSURfRk9VTkQpOwogICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXREb21haW5JZCBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuVm9pY2VJZEV2ZW50cy5VUERBVEVfRE9NQUlOX0lELAogICAgICAgICAgICAgICAgZGF0YTogeyBkb21haW5JZDogZG9tYWluSWQgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJlc29sdmUoZG9tYWluSWQpOwogICAgICAgICAgICB9IGNhdGNoKGVycikgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldERvbWFpbklkIGZhaWxlZCIpLndpdGhPYmplY3QoeyBlcnI6IGVyciB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuR0VUX0RPTUFJTl9JRF9GQUlMRUQsICJnZXREb21haW5JZCBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldERvbWFpbklkIGZhaWxlZCIpLndpdGhPYmplY3QoeyBlcnI6IGVyciB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkdFVF9ET01BSU5fSURfRkFJTEVELCAiZ2V0RG9tYWluSWQgZmFpbGVkIiwgZXJyKTsKICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5jaGVja0NvbmZlcmVuY2VDYWxsID0gZnVuY3Rpb24oKXsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBpc0NvbmZlcmVuY2VDYWxsID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEoc2VsZi5jb250YWN0SWQpLmNvbm5lY3Rpb25zLmZpbHRlcihmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubmVjdC5jb250YWlucyhjb25uZWN0LkNPTk5FQ1RJT05fQUNUSVZFX1NUQVRFUywgY29ubi5zdGF0ZS50eXBlKTsKICAgIH0pLmxlbmd0aCA+IDI7CiAgICBpZihpc0NvbmZlcmVuY2VDYWxsKXsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvcigiVm9pY2VJZCBpcyBub3Qgc3VwcG9ydGVkIGZvciBjb25mZXJlbmNlIGNhbGxzIik7CiAgICB9CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5pc0F1dGhFbmFibGVkID0gZnVuY3Rpb24oYXV0aFJlc3VsdCkgewogICAgcmV0dXJuIGF1dGhSZXN1bHQgIT09IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLk5PVF9FTkFCTEVEOwogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuaXNBdXRoUmVzdWx0Tm90RW5vdWdoU3BlZWNoID0gZnVuY3Rpb24oYXV0aFJlc3VsdCkgewogICAgcmV0dXJuIGF1dGhSZXN1bHQgPT09IGNvbm5lY3QuVm9pY2VJZEF1dGhlbnRpY2F0aW9uRGVjaXNpb24uTk9UX0VOT1VHSF9TUEVFQ0g7CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5pc0F1dGhSZXN1bHRJbmNvbmNsdXNpdmUgPSBmdW5jdGlvbihhdXRoUmVzdWx0KSB7CiAgICByZXR1cm4gYXV0aFJlc3VsdCA9PT0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uSU5DT05DTFVTSVZFOwogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuaXNGcmF1ZEVuYWJsZWQgPSBmdW5jdGlvbihmcmF1ZFJlc3VsdCkgewogICAgcmV0dXJuIGZyYXVkUmVzdWx0ICE9PSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5OT1RfRU5BQkxFRDsKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmlzRnJhdWRSZXN1bHROb3RFbm91Z2hTcGVlY2ggPSBmdW5jdGlvbihmcmF1ZFJlc3VsdCkgewogICAgcmV0dXJuIGZyYXVkUmVzdWx0ID09PSBjb25uZWN0LlZvaWNlSWRGcmF1ZERldGVjdGlvbkRlY2lzaW9uLk5PVF9FTk9VR0hfU1BFRUNIOwogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuaXNGcmF1ZFJlc3VsdEluY29uY2x1c2l2ZSA9IGZ1bmN0aW9uKGZyYXVkUmVzdWx0KSB7CiAgICByZXR1cm4gZnJhdWRSZXN1bHQgPT09IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLklOQ09OQ0xVU0lWRTsKICB9CgogIC8qKgogICAqIEBjbGFzcyBWb2ljZUNvbm5lY3Rpb24KICAgKiBAcGFyYW0ge251bWJlcn0gY29udGFjdElkIAogICAqIEBwYXJhbSB7bnVtYmVyfSBjb25uZWN0aW9uSWQgCiAgICogQGRlc2NyaXB0aW9uIC0gUHJvdmlkZXMgdm9pY2UgbWVkaWEgc3BlY2lmaWMgb3BlcmF0aW9ucwogICAqLwogIHZhciBWb2ljZUNvbm5lY3Rpb24gPSBmdW5jdGlvbiAoY29udGFjdElkLCBjb25uZWN0aW9uSWQpIHsKICAgIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yID0gbmV3IFZvaWNlSWQoY29udGFjdElkKTsKICAgIENvbm5lY3Rpb24uY2FsbCh0aGlzLCBjb250YWN0SWQsIGNvbm5lY3Rpb25JZCk7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29ubmVjdGlvbi5wcm90b3R5cGUpOwogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBWb2ljZUNvbm5lY3Rpb247CgogIC8qKgogICogQGRlcHJlY2F0ZWQKICAqIFBsZWFzZSB1c2UgZ2V0TWVkaWFJbmZvIAogICovCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTb2Z0cGhvbmVNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNvZnRwaG9uZU1lZGlhSW5mbzsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhSW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc29mdHBob25lTWVkaWFJbmZvOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuTWVkaWFUeXBlLlNPRlRQSE9ORTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5LmdldCh0aGlzKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Vm9pY2VJZFNwZWFrZXJJZCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLmdldFNwZWFrZXJJZCgpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRWb2ljZUlkU3BlYWtlclN0YXR1cyA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLmdldFNwZWFrZXJTdGF0dXMoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUub3B0T3V0Vm9pY2VJZFNwZWFrZXIgPSBmdW5jdGlvbigpIHsKICAgIAogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLm9wdE91dFNwZWFrZXIoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZGVsZXRlVm9pY2VJZFNwZWFrZXIgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvci5kZWxldGVTcGVha2VyKCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmV2YWx1YXRlU3BlYWtlcldpdGhWb2ljZUlkID0gZnVuY3Rpb24oc3RhcnROZXcpIHsKICAgIHJldHVybiB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvci5ldmFsdWF0ZVNwZWFrZXIoc3RhcnROZXcpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5lbnJvbGxTcGVha2VySW5Wb2ljZUlkID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fc3BlYWtlckF1dGhlbnRpY2F0b3IuZW5yb2xsU3BlYWtlcigpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS51cGRhdGVWb2ljZUlkU3BlYWtlcklkID0gZnVuY3Rpb24oc3BlYWtlcklkKSB7CiAgICByZXR1cm4gdGhpcy5fc3BlYWtlckF1dGhlbnRpY2F0b3IudXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkKHNwZWFrZXJJZCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldFF1aWNrQ29ubmVjdE5hbWUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnF1aWNrQ29ubmVjdE5hbWU7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5pc011dGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLm11dGU7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5tdXRlUGFydGljaXBhbnQgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLk1VVEVfUEFSVElDSVBBTlQsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS51bm11dGVQYXJ0aWNpcGFudCA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuVU5NVVRFX1BBUlRJQ0lQQU5ULCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY29ubmVjdGlvbklkOiB0aGlzLmdldENvbm5lY3Rpb25JZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgoKICAvKioKICAgKiBAY2xhc3MgQ2hhdENvbm5lY3Rpb24KICAgKiBAcGFyYW0geyp9IGNvbnRhY3RJZCAKICAgKiBAcGFyYW0geyp9IGNvbm5lY3Rpb25JZCAKICAgKiBAZGVzY3JpcHRpb24gYWRkcyB0aGUgY2hhdCBtZWRpYSBzcGVjaWZpYyBmdW5jdGlvbmFsaXR5CiAgICovCiAgdmFyIENoYXRDb25uZWN0aW9uID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKSB7CiAgICBDb25uZWN0aW9uLmNhbGwodGhpcywgY29udGFjdElkLCBjb25uZWN0aW9uSWQpOwogIH07CgogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29ubmVjdGlvbi5wcm90b3R5cGUpOwogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENoYXRDb25uZWN0aW9uOwoKICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFJbmZvID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGRhdGEgPSB0aGlzLl9nZXREYXRhKCkuY2hhdE1lZGlhSW5mbzsKICAgIGlmICghZGF0YSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuY29udGFjdElkKTsKICAgICAgdmFyIG1lZGlhT2JqZWN0ID0gewogICAgICAgIGNvbnRhY3RJZDogdGhpcy5jb250YWN0SWQsCiAgICAgICAgaW5pdGlhbENvbnRhY3RJZDogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCB0aGlzLmNvbnRhY3RJZCwKICAgICAgICBwYXJ0aWNpcGFudElkOiB0aGlzLmNvbm5lY3Rpb25JZCwKICAgICAgICBnZXRDb25uZWN0aW9uVG9rZW46IGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5nZXRDb25uZWN0aW9uVG9rZW4pCiAgICAgIH07CiAgICAgIGlmIChkYXRhLmNvbm5lY3Rpb25EYXRhKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIG1lZGlhT2JqZWN0LnBhcnRpY2lwYW50VG9rZW4gPSBKU09OLnBhcnNlKGRhdGEuY29ubmVjdGlvbkRhdGEpLkNvbm5lY3Rpb25BdXRoZW50aWNhdGlvblRva2VuOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoY29ubmVjdC5Mb2dDb21wb25lbnQuQ0hBVCwgIkNvbm5lY3Rpb24gZGF0YSBpcyBpbnZhbGlkIikKICAgICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkKICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZSkKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICBtZWRpYU9iamVjdC5wYXJ0aWNpcGFudFRva2VuID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgICAgbWVkaWFPYmplY3QucGFydGljaXBhbnRUb2tlbiA9IG1lZGlhT2JqZWN0LnBhcnRpY2lwYW50VG9rZW4gfHwgbnVsbDsKICAgICAgLyoqIEp1c3QgdG8ga2VlcCB0aGUgZGF0YSBhY2Nlc3NpYmxlICovCiAgICAgIG1lZGlhT2JqZWN0Lm9yaWdpbmFsSW5mbyA9IHRoaXMuX2dldERhdGEoKS5jaGF0TWVkaWFJbmZvOwogICAgICByZXR1cm4gbWVkaWFPYmplY3Q7CiAgICB9CiAgfTsKCiAgLyoqCiAgKiBQcm92aWRlcyB0aGUgY2hhdCBjb25uZWN0aW9uVG9rZW4gdGhyb3VnaCB0aGUgY3JlYXRlX3RyYW5zcG9ydCBBUEkgZm9yIGEgc3BlY2lmaWMgY29udGFjdCBhbmQgcGFydGljaXBhbnQgSWQuIAogICogQHJldHVybnMgYSBwcm9taXNlIHdoaWNoLCB1cG9uIHN1Y2Nlc3MsIHJldHVybnMgdGhlIHJlc3BvbnNlIGZyb20gdGhlIGNyZWF0ZVRyYW5zcG9ydCBBUEkuCiAgKiBVc2FnZToKICAqIGNvbm5lY3Rpb24uZ2V0Q29ubmVjdGlvblRva2VuKCkKICAqICAudGhlbihyZXNwb25zZSA9PiB7fSkKICAqICAuY2F0Y2goZXJyb3IgPT4ge30pCiAgKi8KICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvblRva2VuID0gZnVuY3Rpb24gKCkgewogICAgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIGNvbnRhY3REYXRhID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEodGhpcy5jb250YWN0SWQpOwogICAgdmFyIHRyYW5zcG9ydERldGFpbHMgPSB7CiAgICAgIHRyYW5zcG9ydFR5cGU6IGNvbm5lY3QuVFJBTlNQT1JUX1RZUEVTLkNIQVRfVE9LRU4sCiAgICAgIHBhcnRpY2lwYW50SWQ6IHRoaXMuY29ubmVjdGlvbklkLAogICAgICBjb250YWN0SWQ6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgdGhpcy5jb250YWN0SWQKICAgIH07CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX1RSQU5TUE9SVCwgdHJhbnNwb3J0RGV0YWlscywgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImdldENvbm5lY3Rpb25Ub2tlbiBzdWNjZWVkZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldENvbm5lY3Rpb25Ub2tlbiBmYWlsZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJnZXRDb25uZWN0aW9uVG9rZW4gZmFpbGVkIikpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuTWVkaWFUeXBlLkNIQVQ7CiAgfTsKCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5LmdldCh0aGlzKTsKICB9OwoKICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuX2luaXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAvLyBOb3RlIHRoYXQgYSBjaGF0IG1lZGlhIGNvbnRyb2xsZXIgb25seSBuZWVkcyB0byBiZSBwcm9kdWNlZCBmb3IgYWdlbnQgdHlwZSBjb25uZWN0aW9ucy4KICAgIGlmICh0aGlzLl9pc0FnZW50Q29ubmVjdGlvblR5cGUoKSkgewogICAgICBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5LmdldCh0aGlzKS5jYXRjaChmdW5jdGlvbiAoKSB7IH0pOwogICAgfQogIH0KCiAgLyoqCiAgICogQGNsYXNzIFRhc2tDb25uZWN0aW9uCiAgICogQHBhcmFtIHsqfSBjb250YWN0SWQgCiAgICogQHBhcmFtIHsqfSBjb25uZWN0aW9uSWQgCiAgICogQGRlc2NyaXB0aW9uIGFkZHMgdGhlIHRhc2sgbWVkaWEgc3BlY2lmaWMgZnVuY3Rpb25hbGl0eQogICAqLwogIHZhciBUYXNrQ29ubmVjdGlvbiA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgQ29ubmVjdGlvbi5jYWxsKHRoaXMsIGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKTsKICB9OwogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29ubmVjdGlvbi5wcm90b3R5cGUpOwogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFRhc2tDb25uZWN0aW9uOwoKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuTWVkaWFUeXBlLlRBU0s7CiAgfQoKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFJbmZvID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICAgIHZhciBtZWRpYU9iamVjdCA9IHsKICAgICAgICBjb250YWN0SWQ6IHRoaXMuY29udGFjdElkLAogICAgICAgIGluaXRpYWxDb250YWN0SWQ6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgdGhpcy5jb250YWN0SWQsCiAgICAgIH07CiAgICAgIHJldHVybiBtZWRpYU9iamVjdDsKICB9OwoKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkuZ2V0KHRoaXMpOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbm5lY3Rpb25TbmFwc2hvdAogICAqLwogIHZhciBDb25uZWN0aW9uU25hcHNob3QgPSBmdW5jdGlvbiAoY29ubmVjdGlvbkRhdGEpIHsKICAgIGNvbm5lY3QuQ29ubmVjdGlvbi5jYWxsKHRoaXMsIGNvbm5lY3Rpb25EYXRhLmNvbnRhY3RJZCwgY29ubmVjdGlvbkRhdGEuY29ubmVjdGlvbklkKTsKICAgIHRoaXMuY29ubmVjdGlvbkRhdGEgPSBjb25uZWN0aW9uRGF0YTsKICB9OwogIENvbm5lY3Rpb25TbmFwc2hvdC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbm5lY3Rpb24ucHJvdG90eXBlKTsKICBDb25uZWN0aW9uU25hcHNob3QucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQ29ubmVjdGlvblNuYXBzaG90OwoKICBDb25uZWN0aW9uU25hcHNob3QucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvbkRhdGE7CiAgfTsKCiAgQ29ubmVjdGlvblNuYXBzaG90LnByb3RvdHlwZS5faW5pdE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsgfTsKCiAgdmFyIEVuZHBvaW50ID0gZnVuY3Rpb24gKHBhcmFtc0luKSB7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICB0aGlzLmVuZHBvaW50QVJOID0gcGFyYW1zLmVuZHBvaW50SWQgfHwgcGFyYW1zLmVuZHBvaW50QVJOIHx8IG51bGw7CiAgICB0aGlzLmVuZHBvaW50SWQgPSB0aGlzLmVuZHBvaW50QVJOOwogICAgdGhpcy50eXBlID0gcGFyYW1zLnR5cGUgfHwgbnVsbDsKICAgIHRoaXMubmFtZSA9IHBhcmFtcy5uYW1lIHx8IG51bGw7CiAgICB0aGlzLnBob25lTnVtYmVyID0gcGFyYW1zLnBob25lTnVtYmVyIHx8IG51bGw7CiAgICB0aGlzLmFnZW50TG9naW4gPSBwYXJhbXMuYWdlbnRMb2dpbiB8fCBudWxsOwogICAgdGhpcy5xdWV1ZSA9IHBhcmFtcy5xdWV1ZSB8fCBudWxsOwogIH07CgogIC8qKgogICAqIFN0cmlwIHRoZSBTSVAgZW5kcG9pbnQgY29tcG9uZW50cyBmcm9tIHRoZSBwaG9uZU51bWJlciBmaWVsZC4KICAgKi8KICBFbmRwb2ludC5wcm90b3R5cGUuc3RyaXBQaG9uZU51bWJlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLnBob25lTnVtYmVyID8gdGhpcy5waG9uZU51bWJlci5yZXBsYWNlKC9zaXA6KFteQF0qKUAuKi8sICIkMSIpIDogIiI7CiAgfTsKCiAgLyoqCiAgICogQ3JlYXRlIGFuIEVuZHBvaW50IG9iamVjdCBmcm9tIHRoZSBnaXZlbiBwaG9uZSBudW1iZXIgYW5kIG5hbWUuCiAgICovCiAgRW5kcG9pbnQuYnlQaG9uZU51bWJlciA9IGZ1bmN0aW9uIChudW1iZXIsIG5hbWUpIHsKICAgIHJldHVybiBuZXcgRW5kcG9pbnQoewogICAgICB0eXBlOiBjb25uZWN0LkVuZHBvaW50VHlwZS5QSE9ORV9OVU1CRVIsCiAgICAgIHBob25lTnVtYmVyOiBudW1iZXIsCiAgICAgIG5hbWU6IG5hbWUgfHwgbnVsbAogICAgfSk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgU29mdHBob25lRXJyb3IKICAgKi8KICB2YXIgU29mdHBob25lRXJyb3IgPSBmdW5jdGlvbiAoZXJyb3JUeXBlLCBlcnJvck1lc3NhZ2UsIGVuZFBvaW50VXJsKSB7CiAgICB0aGlzLmVycm9yVHlwZSA9IGVycm9yVHlwZTsKICAgIHRoaXMuZXJyb3JNZXNzYWdlID0gZXJyb3JNZXNzYWdlOwogICAgdGhpcy5lbmRQb2ludFVybCA9IGVuZFBvaW50VXJsOwogIH07CiAgU29mdHBob25lRXJyb3IucHJvdG90eXBlLmdldEVycm9yVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmVycm9yVHlwZTsKICB9OwogIFNvZnRwaG9uZUVycm9yLnByb3RvdHlwZS5nZXRFcnJvck1lc3NhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5lcnJvck1lc3NhZ2U7CiAgfTsKICBTb2Z0cGhvbmVFcnJvci5wcm90b3R5cGUuZ2V0RW5kUG9pbnRVcmwgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5lbmRQb2ludFVybDsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBSb290IFN1YnNjcmlwdGlvbiBBUElzLgogICAqLwogIGNvbm5lY3QuYWdlbnQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgdmFyIHN1YiA9IGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5JTklULCBmKTsKICAgIGlmIChjb25uZWN0LmFnZW50LmluaXRpYWxpemVkKSB7CiAgICAgIGYobmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICB9CiAgICByZXR1cm4gc3ViOwogIH07CiAgY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCA9IGZhbHNlOwoKICBjb25uZWN0LmNvbnRhY3QgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgcmV0dXJuIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5Db250YWN0RXZlbnRzLklOSVQsIGYpOwogIH07CgogIGNvbm5lY3Qub25XZWJzb2NrZXRJbml0RmFpbHVyZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICB2YXIgc3ViID0gYnVzLnN1YnNjcmliZShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5JTklUX0ZBSUxVUkUsIGYpOwogICAgaWYgKGNvbm5lY3Qud2ViU29ja2V0SW5pdEZhaWxlZCkgewogICAgICBmKCk7CiAgICB9CiAgICByZXR1cm4gc3ViOwogIH07CgogIC8qKgogICAqIFN0YXJ0cyB0aGUgZ2l2ZW4gZnVuY3Rpb24gYXN5bmNocm9ub3VzbHkgb25seSBpZiB0aGUgc2hhcmVkIHdvcmtlcgogICAqIHNheXMgd2UgYXJlIHRoZSBtYXN0ZXIgZm9yIHRoZSBnaXZlbiB0b3BpYy4gIElmIHRoZXJlIGlzIG5vIG1hc3RlciBmb3IKICAgKiB0aGUgZ2l2ZW4gdG9waWMsIHdlIGJlY29tZSB0aGUgbWFzdGVyIGFuZCBzdGFydCB0aGUgZnVuY3Rpb24gdW5sZXNzCiAgICogc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lIGlzIHRydWUuCiAgICoKICAgKiBAcGFyYW0gdG9waWMgVGhlIG1hc3RlciB0b3BpYyB3ZSBhcmUgY29uY2VybmVkIGFib3V0LgogICAqIEBwYXJhbSBmX3RydWUgVGhlIGNhbGxiYWNrIHRvIGJlIGludm9rZWQgaWYgd2UgYXJlIHRoZSBtYXN0ZXIuCiAgICogQHBhcmFtIGZfZWxzZSBbb3B0aW9uYWxdIEEgY2FsbGJhY2sgdG8gYmUgaW52b2tlZCBpZiB3ZSBhcmUgbm90IHRoZSBtYXN0ZXIuCiAgICogQHBhcmFtIHNob3VsZE5vdEJlY29tZU1hc3RlcklmTm9uZSBbb3B0aW9uYWxdIGlmIHRydWUsIHRoaXMgdGFiIHdvbid0IGJlY29tZSBtYXN0ZXIuCiAgICovCiAgY29ubmVjdC5pZk1hc3RlciA9IGZ1bmN0aW9uICh0b3BpYywgZl90cnVlLCBmX2Vsc2UsIHNob3VsZE5vdEJlY29tZU1hc3RlcklmTm9uZSkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljLCAiQSB0b3BpYyBtdXN0IGJlIHByb3ZpZGVkLiIpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGZfdHJ1ZSwgIkEgdHJ1ZSBjYWxsYmFjayBtdXN0IGJlIHByb3ZpZGVkLiIpOwoKICAgIGlmICghY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCkgewogICAgICAvLyBXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGZvciB0b3BpYyAnJXMnIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEiLCB0b3BpYykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgaWYgKGZfZWxzZSkgewogICAgICAgIGZfZWxzZSgpOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgbWFzdGVyQ2xpZW50ID0gY29ubmVjdC5jb3JlLmdldE1hc3RlckNsaWVudCgpOwogICAgbWFzdGVyQ2xpZW50LmNhbGwoY29ubmVjdC5NYXN0ZXJNZXRob2RzLkNIRUNLX01BU1RFUiwgewogICAgICB0b3BpYzogdG9waWMsCiAgICAgIHNob3VsZE5vdEJlY29tZU1hc3RlcklmTm9uZTogc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLmlzTWFzdGVyKSB7CiAgICAgICAgICAgIGZfdHJ1ZSgpOwoKICAgICAgICAgIH0gZWxzZSBpZiAoZl9lbHNlKSB7CiAgICAgICAgICAgIGZfZWxzZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgfTsKCiAgLyoqCiAgICogTm90aWZ5IHRoZSBzaGFyZWQgd29ya2VyIGFuZCBvdGhlciBDQ1AgdGFicyB0aGF0IHdlIGFyZSBub3cgdGhlIG1hc3RlciBmb3IgdGhlIGdpdmVuIHRvcGljLgogICAqLwogIGNvbm5lY3QuYmVjb21lTWFzdGVyID0gZnVuY3Rpb24gKHRvcGljLCBzdWNjZXNzQ2FsbGJhY2ssIGZhaWx1cmVDYWxsYmFjaykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljLCAiQSB0b3BpYyBtdXN0IGJlIHByb3ZpZGVkLiIpOwoKICAgIGlmICghY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCkgewogICAgICAvLyBXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGZvciB0b3BpYyAnJXMnIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEiLCB0b3BpYyk7CiAgICAgIGlmIChmYWlsdXJlQ2FsbGJhY2spIHsKICAgICAgICBmYWlsdXJlQ2FsbGJhY2soKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIG1hc3RlckNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRNYXN0ZXJDbGllbnQoKTsKICAgICAgbWFzdGVyQ2xpZW50LmNhbGwoY29ubmVjdC5NYXN0ZXJNZXRob2RzLkJFQ09NRV9NQVNURVIsIHsKICAgICAgICB0b3BpYzogdG9waWMKICAgICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChzdWNjZXNzQ2FsbGJhY2spIHsKICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwoKICBjb25uZWN0LkFnZW50ID0gQWdlbnQ7CiAgY29ubmVjdC5BZ2VudFNuYXBzaG90ID0gQWdlbnRTbmFwc2hvdDsKICBjb25uZWN0LkNvbnRhY3QgPSBDb250YWN0OwogIGNvbm5lY3QuQ29udGFjdFNuYXBzaG90ID0gQ29udGFjdFNuYXBzaG90OwogIC8qKiBEZWZhdWx0IHdpbGwgZ2V0IHRoZSBWb2ljZSBjb25uZWN0aW9uICovCiAgY29ubmVjdC5Db25uZWN0aW9uID0gVm9pY2VDb25uZWN0aW9uOwogIGNvbm5lY3QuQmFzZUNvbm5lY3Rpb24gPSBDb25uZWN0aW9uOwogIGNvbm5lY3QuVm9pY2VDb25uZWN0aW9uID0gVm9pY2VDb25uZWN0aW9uOwogIGNvbm5lY3QuQ2hhdENvbm5lY3Rpb24gPSBDaGF0Q29ubmVjdGlvbjsKICBjb25uZWN0LlRhc2tDb25uZWN0aW9uID0gVGFza0Nvbm5lY3Rpb247CiAgY29ubmVjdC5Db25uZWN0aW9uU25hcHNob3QgPSBDb25uZWN0aW9uU25hcHNob3Q7CiAgY29ubmVjdC5FbmRwb2ludCA9IEVuZHBvaW50OwogIGNvbm5lY3QuQWRkcmVzcyA9IEVuZHBvaW50OwogIGNvbm5lY3QuU29mdHBob25lRXJyb3IgPSBTb2Z0cGhvbmVFcnJvcjsKICBjb25uZWN0LlZvaWNlSWQgPSBWb2ljZUlkOwp9KSgpOwoKCgovKioqLyB9KSwKCi8qKiovIDgyNzoKLyoqKi8gKChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pID0+IHsKCnZhciBfX1dFQlBBQ0tfQU1EX0RFRklORV9SRVNVTFRfXzsvLyBBV1MgU0RLIGZvciBKYXZhU2NyaXB0IHYyLjU1My4wCi8vIENvcHlyaWdodCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgovLyBMaWNlbnNlIGF0IGh0dHBzOi8vc2RrLmFtYXpvbmF3cy5jb20vanMvQlVORExFX0xJQ0VOU0UudHh0CihmdW5jdGlvbigpe2Z1bmN0aW9uIHIoZSxuLHQpe2Z1bmN0aW9uIG8oaSxmKXtpZighbltpXSl7aWYoIWVbaV0pe3ZhciBjPXVuZGVmaW5lZDtpZighZiYmYylyZXR1cm4gcmVxdWlyZShpLCEwKTtpZih1KXJldHVybiB1KGksITApO3ZhciBhPW5ldyBFcnJvcigiQ2Fubm90IGZpbmQgbW9kdWxlICciK2krIiciKTt0aHJvdyBhLmNvZGU9Ik1PRFVMRV9OT1RfRk9VTkQiLGF9dmFyIHA9bltpXT17ZXhwb3J0czp7fX07ZVtpXVswXS5jYWxsKHAuZXhwb3J0cyxmdW5jdGlvbihyKXt2YXIgbj1lW2ldWzFdW3JdO3JldHVybiBvKG58fHIpfSxwLHAuZXhwb3J0cyxyLGUsbix0KX1yZXR1cm4gbltpXS5leHBvcnRzfWZvcih2YXIgdT11bmRlZmluZWQsaT0wO2k8dC5sZW5ndGg7aSsrKW8odFtpXSk7cmV0dXJuIG99cmV0dXJuIHJ9KSgpKHsxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBtb2R1bGUuZXhwb3J0cz17CiAgICAidmVyc2lvbiI6ICIyLjAiLAogICAgIm1ldGFkYXRhIjogewogICAgICAiYXBpVmVyc2lvbiI6ICIyMDE0LTA2LTMwIiwKICAgICAgImVuZHBvaW50UHJlZml4IjogImNvZ25pdG8taWRlbnRpdHkiLAogICAgICAianNvblZlcnNpb24iOiAiMS4xIiwKICAgICAgInByb3RvY29sIjogImpzb24iLAogICAgICAic2VydmljZUZ1bGxOYW1lIjogIkFtYXpvbiBDb2duaXRvIElkZW50aXR5IiwKICAgICAgInNlcnZpY2VJZCI6ICJDb2duaXRvIElkZW50aXR5IiwKICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAidjQiLAogICAgICAidGFyZ2V0UHJlZml4IjogIkFXU0NvZ25pdG9JZGVudGl0eVNlcnZpY2UiLAogICAgICAidWlkIjogImNvZ25pdG8taWRlbnRpdHktMjAxNC0wNi0zMCIKICAgIH0sCiAgICAib3BlcmF0aW9ucyI6IHsKICAgICAgIkNyZWF0ZUlkZW50aXR5UG9vbCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlQb29sTmFtZSIsCiAgICAgICAgICAgICJBbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xOYW1lIjoge30sCiAgICAgICAgICAgICJBbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlN1cHBvcnRlZExvZ2luUHJvdmlkZXJzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTNCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgICAiT3BlbklkQ29ubmVjdFByb3ZpZGVyQVJOcyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzgiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJDb2duaXRvSWRlbnRpdHlQcm92aWRlcnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNhIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiU2FtbFByb3ZpZGVyQVJOcyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2YiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xUYWdzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTZyIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTaiIKICAgICAgICB9CiAgICAgIH0sCiAgICAgICJEZWxldGVJZGVudGl0aWVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eUlkc1RvRGVsZXRlIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZHNUb0RlbGV0ZSI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlVucHJvY2Vzc2VkSWRlbnRpdHlJZHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgICAgICAgIkVycm9yQ29kZSI6IHt9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiRGVsZXRlSWRlbnRpdHlQb29sIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJEZXNjcmliZUlkZW50aXR5IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eUlkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInNoYXBlIjogIlN1IgogICAgICAgIH0KICAgICAgfSwKICAgICAgIkRlc2NyaWJlSWRlbnRpdHlQb29sIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAic2hhcGUiOiAiU2oiCiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIkxvZ2lucyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU3oiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJDdXN0b21Sb2xlQXJuIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJDcmVkZW50aWFscyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgIkFjY2Vzc0tleUlkIjoge30sCiAgICAgICAgICAgICAgICAiU2VjcmV0S2V5Ijoge30sCiAgICAgICAgICAgICAgICAiU2Vzc2lvblRva2VuIjoge30sCiAgICAgICAgICAgICAgICAiRXhwaXJhdGlvbiI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldElkIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkFjY291bnRJZCI6IHt9LAogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICAgIkxvZ2lucyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU3oiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRJZGVudGl0eVBvb2xSb2xlcyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICAgIlJvbGVzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMWIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJSb2xlTWFwcGluZ3MiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMxZCIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldE9wZW5JZFRva2VuIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eUlkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTeiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIlRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRPcGVuSWRUb2tlbkZvckRldmVsb3BlcklkZW50aXR5IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgICAgICJMb2dpbnMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTeiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlRva2VuRHVyYXRpb24iOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIlRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJMaXN0SWRlbnRpdGllcyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiLAogICAgICAgICAgICAiTWF4UmVzdWx0cyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICJNYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJOZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgIkhpZGVEaXNhYmxlZCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICAgIklkZW50aXRpZXMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTdSIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJOZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkxpc3RJZGVudGl0eVBvb2xzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJNYXhSZXN1bHRzIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiTWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiTmV4dFRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAgICAgICAiSWRlbnRpdHlQb29sTmFtZSI6IHt9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAiTmV4dFRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJMaXN0VGFnc0ZvclJlc291cmNlIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJSZXNvdXJjZUFybiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlJlc291cmNlQXJuIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJUYWdzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTZyIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkxvb2t1cERldmVsb3BlcklkZW50aXR5IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJEZXZlbG9wZXJVc2VySWRlbnRpZmllciI6IHt9LAogICAgICAgICAgICAiTWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiTmV4dFRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJEZXZlbG9wZXJVc2VySWRlbnRpZmllckxpc3QiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJOZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIk1lcmdlRGV2ZWxvcGVySWRlbnRpdGllcyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiU291cmNlVXNlcklkZW50aWZpZXIiLAogICAgICAgICAgICAiRGVzdGluYXRpb25Vc2VySWRlbnRpZmllciIsCiAgICAgICAgICAgICJEZXZlbG9wZXJQcm92aWRlck5hbWUiLAogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJTb3VyY2VVc2VySWRlbnRpZmllciI6IHt9LAogICAgICAgICAgICAiRGVzdGluYXRpb25Vc2VySWRlbnRpZmllciI6IHt9LAogICAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2V0SWRlbnRpdHlQb29sUm9sZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICAgIlJvbGVzIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICAgIlJvbGVzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMWIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJSb2xlTWFwcGluZ3MiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMxZCIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlRhZ1Jlc291cmNlIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJSZXNvdXJjZUFybiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlJlc291cmNlQXJuIjoge30sCiAgICAgICAgICAgICJUYWdzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTZyIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVW5saW5rRGV2ZWxvcGVySWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWQiLAogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiLAogICAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIiwKICAgICAgICAgICAgIkRldmVsb3BlclVzZXJJZGVudGlmaWVyIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgICAiRGV2ZWxvcGVyVXNlcklkZW50aWZpZXIiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlVubGlua0lkZW50aXR5IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eUlkIiwKICAgICAgICAgICAgIkxvZ2lucyIsCiAgICAgICAgICAgICJMb2dpbnNUb1JlbW92ZSIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIkxvZ2lucyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU3oiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJMb2dpbnNUb1JlbW92ZSI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU3YiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJVbnRhZ1Jlc291cmNlIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJSZXNvdXJjZUFybiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlJlc291cmNlQXJuIjoge30sCiAgICAgICAgICAgICJUYWdLZXlzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJVcGRhdGVJZGVudGl0eVBvb2wiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInNoYXBlIjogIlNqIgogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTaiIKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAic2hhcGVzIjogewogICAgICAiUzQiOiB7CiAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAia2V5Ijoge30sCiAgICAgICAgInZhbHVlIjoge30KICAgICAgfSwKICAgICAgIlM4IjogewogICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICJtZW1iZXIiOiB7fQogICAgICB9LAogICAgICAiU2EiOiB7CiAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgICAiQ2xpZW50SWQiOiB7fSwKICAgICAgICAgICAgIlNlcnZlclNpZGVUb2tlbkNoZWNrIjogewogICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTZiI6IHsKICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAibWVtYmVyIjoge30KICAgICAgfSwKICAgICAgIlNnIjogewogICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgImtleSI6IHt9LAogICAgICAgICJ2YWx1ZSI6IHt9CiAgICAgIH0sCiAgICAgICJTaiI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgICAiSWRlbnRpdHlQb29sTmFtZSIsCiAgICAgICAgICAiQWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICJJZGVudGl0eVBvb2xOYW1lIjoge30sCiAgICAgICAgICAiQWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzIjogewogICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgfSwKICAgICAgICAgICJTdXBwb3J0ZWRMb2dpblByb3ZpZGVycyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgfSwKICAgICAgICAgICJEZXZlbG9wZXJQcm92aWRlck5hbWUiOiB7fSwKICAgICAgICAgICJPcGVuSWRDb25uZWN0UHJvdmlkZXJBUk5zIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzgiCiAgICAgICAgICB9LAogICAgICAgICAgIkNvZ25pdG9JZGVudGl0eVByb3ZpZGVycyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNhIgogICAgICAgICAgfSwKICAgICAgICAgICJTYW1sUHJvdmlkZXJBUk5zIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2YiCiAgICAgICAgICB9LAogICAgICAgICAgIklkZW50aXR5UG9vbFRhZ3MiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTZyIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTdSI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTdiIKICAgICAgICAgIH0sCiAgICAgICAgICAiQ3JlYXRpb25EYXRlIjogewogICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICB9LAogICAgICAgICAgIkxhc3RNb2RpZmllZERhdGUiOiB7CiAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTdiI6IHsKICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAibWVtYmVyIjoge30KICAgICAgfSwKICAgICAgIlN6IjogewogICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgImtleSI6IHt9LAogICAgICAgICJ2YWx1ZSI6IHt9CiAgICAgIH0sCiAgICAgICJTMWIiOiB7CiAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAia2V5Ijoge30sCiAgICAgICAgInZhbHVlIjoge30KICAgICAgfSwKICAgICAgIlMxZCI6IHsKICAgICAgICAidHlwZSI6ICJtYXAiLAogICAgICAgICJrZXkiOiB7fSwKICAgICAgICAidmFsdWUiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiVHlwZSIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlR5cGUiOiB7fSwKICAgICAgICAgICAgIkFtYmlndW91c1JvbGVSZXNvbHV0aW9uIjoge30sCiAgICAgICAgICAgICJSdWxlc0NvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAiUnVsZXMiCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJSdWxlcyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAiQ2xhaW0iLAogICAgICAgICAgICAgICAgICAgICAgIk1hdGNoVHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAiVmFsdWUiLAogICAgICAgICAgICAgICAgICAgICAgIlJvbGVBUk4iCiAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICJDbGFpbSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgIk1hdGNoVHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgIlZhbHVlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAiUm9sZUFSTiI6IHt9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIH0se31dLDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzPXsKICAgICJwYWdpbmF0aW9uIjogewogICAgfQogIH0KICAKICB9LHt9XSwzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBtb2R1bGUuZXhwb3J0cz17CiAgICAidmVyc2lvbiI6ICIyLjAiLAogICAgIm1ldGFkYXRhIjogewogICAgICAiYXBpVmVyc2lvbiI6ICIyMDE3LTAyLTE1IiwKICAgICAgImVuZHBvaW50UHJlZml4IjogImNvbm5lY3QiLAogICAgICAianNvblZlcnNpb24iOiAiMS4wIiwKICAgICAgInByb3RvY29sIjogImpzb24iLAogICAgICAic2VydmljZUFiYnJldmlhdGlvbiI6ICJDb25uZWN0IiwKICAgICAgInNlcnZpY2VGdWxsTmFtZSI6ICJBbWF6b25Db25uZWN0Q1RJU2VydmljZSIsCiAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogIiIsCiAgICAgICJ0YXJnZXRQcmVmaXgiOiAiQW1hem9uQ29ubmVjdENUSVNlcnZpY2UiLAogICAgICAidWlkIjogImNvbm5lY3QtMjAxNy0wMi0xNSIKICAgIH0sCiAgICAib3BlcmF0aW9ucyI6IHsKICAgICAgIkFjY2VwdENvbnRhY3QiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJDbGVhckNvbnRhY3QiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJDb21wbGV0ZUNvbnRhY3QiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJDb25mZXJlbmNlQ29ubmVjdGlvbnMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJDcmVhdGVBZGRpdGlvbmFsQ29ubmVjdGlvbiI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgImVuZHBvaW50IgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICJlbmRwb2ludCI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2UiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNyZWF0ZU91dGJvdW5kQ29udGFjdCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiZW5kcG9pbnQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJlbmRwb2ludCI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2UiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJxdWV1ZUFSTiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJDcmVhdGVUYXNrQ29udGFjdCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiZW5kcG9pbnQiLAogICAgICAgICAgICAibmFtZSIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImVuZHBvaW50IjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInByZXZpb3VzQ29udGFjdElkIjoge30sCiAgICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6IHt9LAogICAgICAgICAgICAicmVmZXJlbmNlcyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU3IiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJpZGVtcG90ZW5jeVRva2VuIjoge30sCiAgICAgICAgICAgICJzY2hlZHVsZWRUaW1lIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNyZWF0ZVRyYW5zcG9ydCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAidHJhbnNwb3J0VHlwZSIsCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgInRyYW5zcG9ydFR5cGUiOiB7fSwKICAgICAgICAgICAgInBhcnRpY2lwYW50SWQiOiB7fSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAic29mdHBob25lQ2xpZW50SWQiOiB7fSwKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIndlYlNvY2tldFRyYW5zcG9ydCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICJ1cmwiLAogICAgICAgICAgICAgICAgInRyYW5zcG9ydExpZmVUaW1lSW5TZWNvbmRzIgogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAidXJsIjoge30sCiAgICAgICAgICAgICAgICAidHJhbnNwb3J0TGlmZVRpbWVJblNlY29uZHMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImV4cGlyeSI6IHt9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAiY2hhdFRva2VuVHJhbnNwb3J0IjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgInBhcnRpY2lwYW50VG9rZW4iLAogICAgICAgICAgICAgICAgImV4cGlyeSIKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgInBhcnRpY2lwYW50VG9rZW4iOiB7fSwKICAgICAgICAgICAgICAgICJleHBpcnkiOiB7fQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgInNvZnRwaG9uZVRyYW5zcG9ydCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICJzb2Z0cGhvbmVNZWRpYUNvbm5lY3Rpb25zIgogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAic29mdHBob25lTWVkaWFDb25uZWN0aW9ucyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAidXNlcm5hbWUiLAogICAgICAgICAgICAgICAgICAgICAgImNyZWRlbnRpYWwiLAogICAgICAgICAgICAgICAgICAgICAgInVybHMiCiAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICJ1c2VybmFtZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgImNyZWRlbnRpYWwiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJ1cmxzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiRGVzdHJveUNvbm5lY3Rpb24iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRBZ2VudENvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImNvbmZpZ3VyYXRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJjb25maWd1cmF0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMWgiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRBZ2VudFBlcm1pc3Npb25zIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgInBlcm1pc3Npb25zIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAicGVybWlzc2lvbnMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldEFnZW50U25hcHNob3QiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30sCiAgICAgICAgICAgICJ0aW1lb3V0IjogewogICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAic25hcHNob3QiLAogICAgICAgICAgICAibmV4dFRva2VuIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAic25hcHNob3QiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAic3RhdGUiLAogICAgICAgICAgICAgICAgImNvbnRhY3RzIiwKICAgICAgICAgICAgICAgICJzbmFwc2hvdFRpbWVzdGFtcCIKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgInN0YXRlIjogewogICAgICAgICAgICAgICAgICAic2hhcGUiOiAiUzIwIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJuZXh0U3RhdGUiOiB7CiAgICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTMjAiCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImFnZW50QXZhaWxhYmlsaXR5U3RhdGUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICJzdGF0ZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICJ0aW1lU3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImNvbnRhY3RzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAgICAgICAgICAgInR5cGUiLAogICAgICAgICAgICAgICAgICAgICAgInN0YXRlIiwKICAgICAgICAgICAgICAgICAgICAgICJjb25uZWN0aW9ucyIsCiAgICAgICAgICAgICAgICAgICAgICAiYXR0cmlidXRlcyIKICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgImluaXRpYWxDb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAic3RhdGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICJxdWV1ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInNoYXBlIjogIlNrIgogICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICJxdWV1ZVRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICJjb25uZWN0aW9ucyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY29ubmVjdGlvbklkIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaW5pdGlhbCIKICAgICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImVuZHBvaW50IjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAic2hhcGUiOiAiU2UiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXRlIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImluaXRpYWwiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInNvZnRwaG9uZU1lZGlhSW5mbyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNhbGxUeXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImF1dG9BY2NlcHQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lZGlhTGVnQ29udGV4dFRva2VuIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNhbGxDb250ZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2FsbENvbmZpZ0pzb24iOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImNoYXRNZWRpYUluZm8iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjaGF0QXV0b0FjY2VwdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY29ubmVjdGlvbkRhdGEiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY3VzdG9tZXJOYW1lIjoge30KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtb25pdG9yaW5nSW5mbyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImFnZW50IjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYWdlbnROYW1lIjoge30KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJqb2luVGltZVN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtdXRlIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJxdWlja0Nvbm5lY3ROYW1lIjoge30KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAiYXR0cmlidXRlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAgICAgICAgICAgICAgICAgImtleSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibmFtZSIKICAgICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgImNvbnRhY3REdXJhdGlvbiI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgInJlZmVyZW5jZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTciIKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAiaW5pdGlhdGlvbk1ldGhvZCI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgImNvbnRhY3RGZWF0dXJlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgImF0dGFjaG1lbnRzRW5hYmxlZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAibWVzc2FnaW5nTWFya2Rvd25FbmFibGVkIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic25hcHNob3RUaW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldEFnZW50U3RhdGVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgInN0YXRlcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgInN0YXRlcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlMyMCIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldERpYWxhYmxlQ291bnRyeUNvZGVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImNvdW50cnlDb2RlcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImNvdW50cnlDb2RlcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0RW5kcG9pbnRzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJxdWV1ZUFSTnMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJxdWV1ZUFSTnMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgIm1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImVuZHBvaW50cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlNlIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0TmV3QXV0aFRva2VuIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJyZWZyZXNoVG9rZW4iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJyZWZyZXNoVG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIm5ld0F1dGhUb2tlbiI6IHt9LAogICAgICAgICAgICAiZXhwaXJhdGlvbkRhdGVUaW1lIjogewogICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldFJvdXRpbmdQcm9maWxlUXVldWVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJyb3V0aW5nUHJvZmlsZUFSTiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInJvdXRpbmdQcm9maWxlQVJOIjoge30sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgIm1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJxdWV1ZXMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJxdWV1ZXMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTayIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkhvbGRDb25uZWN0aW9uIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTXV0ZVBhcnRpY2lwYW50IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTm90aWZ5Q29udGFjdElzc3VlIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImlzc3VlQ29kZSI6IHt9LAogICAgICAgICAgICAiZGVzY3JpcHRpb24iOiB7fSwKICAgICAgICAgICAgImNsaWVudExvZ3MiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiUHV0QWdlbnRTdGF0ZSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAic3RhdGUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJzdGF0ZSI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIwIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiZW5xdWV1ZU5leHRTdGF0ZSI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJSZWplY3RDb250YWN0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJjb250YWN0SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiUmVzdW1lQ29ubmVjdGlvbiI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNlbmRDbGllbnRMb2dzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJsb2dFdmVudHMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJsb2dFdmVudHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICJjb21wb25lbnQiOiB7fSwKICAgICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiB7fQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2VuZERpZ2l0cyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCIsCiAgICAgICAgICAgICJkaWdpdHMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9LAogICAgICAgICAgICAiZGlnaXRzIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNlbmRTb2Z0cGhvbmVDYWxsTWV0cmljcyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgInNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNjcFZlcnNpb24iOiB7fSwKICAgICAgICAgICAgInNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMzciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2VuZFNvZnRwaG9uZUNhbGxSZXBvcnQiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJyZXBvcnQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNjcFZlcnNpb24iOiB7fSwKICAgICAgICAgICAgInJlcG9ydCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgImNhbGxTdGFydFRpbWUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiY2FsbEVuZFRpbWUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic29mdHBob25lU3RyZWFtU3RhdGlzdGljcyI6IHsKICAgICAgICAgICAgICAgICAgInNoYXBlIjogIlMzciIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiZ3VtVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiaW5pdGlhbGl6YXRpb25UaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJpY2VDb2xsZWN0aW9uVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic2lnbmFsbGluZ0Nvbm5lY3RUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJoYW5kc2hha2VUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJwcmVUYWxrVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAidGFsa1RpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImNsZWFudXBUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJpY2VDb2xsZWN0aW9uRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic2lnbmFsbGluZ0Nvbm5lY3Rpb25GYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJoYW5kc2hha2VGYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJndW1PdGhlckZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImd1bVRpbWVvdXRGYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJjcmVhdGVPZmZlckZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgInNldExvY2FsRGVzY3JpcHRpb25GYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJ1c2VyQnVzeUZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImludmFsaWRSZW1vdGVTRFBGYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJub1JlbW90ZUljZUNhbmRpZGF0ZUZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgInNldFJlbW90ZURlc2NyaXB0aW9uRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlRvZ2dsZUFjdGl2ZUNvbm5lY3Rpb25zIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVW5tdXRlUGFydGljaXBhbnQiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJVcGRhdGVBZ2VudENvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbmZpZ3VyYXRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb25maWd1cmF0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMWgiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJzaGFwZXMiOiB7CiAgICAgICJTMiI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImFnZW50QVJOIjoge30sCiAgICAgICAgICAiYXV0aFRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTZSI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJ0eXBlIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiZW5kcG9pbnRBUk4iOiB7fSwKICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICAgInBob25lTnVtYmVyIjoge30sCiAgICAgICAgICAiYWdlbnRMb2dpbiI6IHt9LAogICAgICAgICAgInF1ZXVlIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2siOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJxdWV1ZUFSTiI6IHt9LAogICAgICAgICAgIm5hbWUiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNyIjogewogICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgImtleSI6IHt9LAogICAgICAgICJ2YWx1ZSI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJ2YWx1ZSIsCiAgICAgICAgICAgICJ0eXBlIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAidmFsdWUiOiB7fSwKICAgICAgICAgICAgInR5cGUiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlMxaCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJuYW1lIiwKICAgICAgICAgICJzb2Z0cGhvbmVFbmFibGVkIiwKICAgICAgICAgICJzb2Z0cGhvbmVBdXRvQWNjZXB0IiwKICAgICAgICAgICJleHRlbnNpb24iLAogICAgICAgICAgInJvdXRpbmdQcm9maWxlIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICAgInVzZXJuYW1lIjoge30sCiAgICAgICAgICAic29mdHBob25lRW5hYmxlZCI6IHsKICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgIH0sCiAgICAgICAgICAic29mdHBob25lQXV0b0FjY2VwdCI6IHsKICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgIH0sCiAgICAgICAgICAiZXh0ZW5zaW9uIjoge30sCiAgICAgICAgICAicm91dGluZ1Byb2ZpbGUiOiB7CiAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAgICAgInJvdXRpbmdQcm9maWxlQVJOIjoge30sCiAgICAgICAgICAgICAgImRlZmF1bHRPdXRib3VuZFF1ZXVlIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlNrIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImNoYW5uZWxDb25jdXJyZW5jeU1hcCI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgICAgICAgICAia2V5Ijoge30sCiAgICAgICAgICAgICAgICAidmFsdWUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgImFnZW50UHJlZmVyZW5jZXMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgICAgICJrZXkiOiB7fSwKICAgICAgICAgICAgInZhbHVlIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTMjAiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAidHlwZSIsCiAgICAgICAgICAibmFtZSIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImFnZW50U3RhdGVBUk4iOiB7fSwKICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICAgInN0YXJ0VGltZXN0YW1wIjogewogICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiUzNyIjogewogICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJ0aW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICB9LAogICAgICAgICAgICAic29mdHBob25lU3RyZWFtVHlwZSI6IHt9LAogICAgICAgICAgICAicGFja2V0Q291bnQiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInBhY2tldHNMb3N0IjogewogICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJhdWRpb0xldmVsIjogewogICAgICAgICAgICAgICJ0eXBlIjogImRvdWJsZSIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImppdHRlckJ1ZmZlck1pbGxpcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9LAogICAgICAgICAgICAicm91bmRUcmlwVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIH0se31dLDQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzPXsKICAgICJhY20iOiB7CiAgICAgICJuYW1lIjogIkFDTSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJhcGlnYXRld2F5IjogewogICAgICAibmFtZSI6ICJBUElHYXRld2F5IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFwcGxpY2F0aW9uYXV0b3NjYWxpbmciOiB7CiAgICAgICJwcmVmaXgiOiAiYXBwbGljYXRpb24tYXV0b3NjYWxpbmciLAogICAgICAibmFtZSI6ICJBcHBsaWNhdGlvbkF1dG9TY2FsaW5nIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFwcHN0cmVhbSI6IHsKICAgICAgIm5hbWUiOiAiQXBwU3RyZWFtIgogICAgfSwKICAgICJhdXRvc2NhbGluZyI6IHsKICAgICAgIm5hbWUiOiAiQXV0b1NjYWxpbmciLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiYmF0Y2giOiB7CiAgICAgICJuYW1lIjogIkJhdGNoIgogICAgfSwKICAgICJidWRnZXRzIjogewogICAgICAibmFtZSI6ICJCdWRnZXRzIgogICAgfSwKICAgICJjbG91ZGRpcmVjdG9yeSI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWREaXJlY3RvcnkiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTYtMDUtMTAqIgogICAgICBdCiAgICB9LAogICAgImNsb3VkZm9ybWF0aW9uIjogewogICAgICAibmFtZSI6ICJDbG91ZEZvcm1hdGlvbiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjbG91ZGZyb250IjogewogICAgICAibmFtZSI6ICJDbG91ZEZyb250IiwKICAgICAgInZlcnNpb25zIjogWwogICAgICAgICIyMDEzLTA1LTEyKiIsCiAgICAgICAgIjIwMTMtMTEtMTEqIiwKICAgICAgICAiMjAxNC0wNS0zMSoiLAogICAgICAgICIyMDE0LTEwLTIxKiIsCiAgICAgICAgIjIwMTQtMTEtMDYqIiwKICAgICAgICAiMjAxNS0wNC0xNyoiLAogICAgICAgICIyMDE1LTA3LTI3KiIsCiAgICAgICAgIjIwMTUtMDktMTcqIiwKICAgICAgICAiMjAxNi0wMS0xMyoiLAogICAgICAgICIyMDE2LTAxLTI4KiIsCiAgICAgICAgIjIwMTYtMDgtMDEqIiwKICAgICAgICAiMjAxNi0wOC0yMCoiLAogICAgICAgICIyMDE2LTA5LTA3KiIsCiAgICAgICAgIjIwMTYtMDktMjkqIiwKICAgICAgICAiMjAxNi0xMS0yNSoiLAogICAgICAgICIyMDE3LTAzLTI1KiIsCiAgICAgICAgIjIwMTctMTAtMzAqIiwKICAgICAgICAiMjAxOC0wNi0xOCoiLAogICAgICAgICIyMDE4LTExLTA1KiIKICAgICAgXSwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNsb3VkaHNtIjogewogICAgICAibmFtZSI6ICJDbG91ZEhTTSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjbG91ZHNlYXJjaCI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWRTZWFyY2giCiAgICB9LAogICAgImNsb3Vkc2VhcmNoZG9tYWluIjogewogICAgICAibmFtZSI6ICJDbG91ZFNlYXJjaERvbWFpbiIKICAgIH0sCiAgICAiY2xvdWR0cmFpbCI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWRUcmFpbCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjbG91ZHdhdGNoIjogewogICAgICAicHJlZml4IjogIm1vbml0b3JpbmciLAogICAgICAibmFtZSI6ICJDbG91ZFdhdGNoIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNsb3Vkd2F0Y2hldmVudHMiOiB7CiAgICAgICJwcmVmaXgiOiAiZXZlbnRzIiwKICAgICAgIm5hbWUiOiAiQ2xvdWRXYXRjaEV2ZW50cyIsCiAgICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgICAiMjAxNC0wMi0wMyoiCiAgICAgIF0sCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjbG91ZHdhdGNobG9ncyI6IHsKICAgICAgInByZWZpeCI6ICJsb2dzIiwKICAgICAgIm5hbWUiOiAiQ2xvdWRXYXRjaExvZ3MiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29kZWJ1aWxkIjogewogICAgICAibmFtZSI6ICJDb2RlQnVpbGQiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29kZWNvbW1pdCI6IHsKICAgICAgIm5hbWUiOiAiQ29kZUNvbW1pdCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb2RlZGVwbG95IjogewogICAgICAibmFtZSI6ICJDb2RlRGVwbG95IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvZGVwaXBlbGluZSI6IHsKICAgICAgIm5hbWUiOiAiQ29kZVBpcGVsaW5lIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvZ25pdG9pZGVudGl0eSI6IHsKICAgICAgInByZWZpeCI6ICJjb2duaXRvLWlkZW50aXR5IiwKICAgICAgIm5hbWUiOiAiQ29nbml0b0lkZW50aXR5IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvZ25pdG9pZGVudGl0eXNlcnZpY2Vwcm92aWRlciI6IHsKICAgICAgInByZWZpeCI6ICJjb2duaXRvLWlkcCIsCiAgICAgICJuYW1lIjogIkNvZ25pdG9JZGVudGl0eVNlcnZpY2VQcm92aWRlciIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb2duaXRvc3luYyI6IHsKICAgICAgInByZWZpeCI6ICJjb2duaXRvLXN5bmMiLAogICAgICAibmFtZSI6ICJDb2duaXRvU3luYyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb25maWdzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogImNvbmZpZyIsCiAgICAgICJuYW1lIjogIkNvbmZpZ1NlcnZpY2UiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29ubmVjdCI6IHsKICAgICAgICAibmFtZSI6ICJDb25uZWN0IiwKICAgICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY3VyIjogewogICAgICAibmFtZSI6ICJDVVIiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZGF0YXBpcGVsaW5lIjogewogICAgICAibmFtZSI6ICJEYXRhUGlwZWxpbmUiCiAgICB9LAogICAgImRldmljZWZhcm0iOiB7CiAgICAgICJuYW1lIjogIkRldmljZUZhcm0iLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZGlyZWN0Y29ubmVjdCI6IHsKICAgICAgIm5hbWUiOiAiRGlyZWN0Q29ubmVjdCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJkaXJlY3RvcnlzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogImRzIiwKICAgICAgIm5hbWUiOiAiRGlyZWN0b3J5U2VydmljZSIKICAgIH0sCiAgICAiZGlzY292ZXJ5IjogewogICAgICAibmFtZSI6ICJEaXNjb3ZlcnkiCiAgICB9LAogICAgImRtcyI6IHsKICAgICAgIm5hbWUiOiAiRE1TIgogICAgfSwKICAgICJkeW5hbW9kYiI6IHsKICAgICAgIm5hbWUiOiAiRHluYW1vREIiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZHluYW1vZGJzdHJlYW1zIjogewogICAgICAicHJlZml4IjogInN0cmVhbXMuZHluYW1vZGIiLAogICAgICAibmFtZSI6ICJEeW5hbW9EQlN0cmVhbXMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZWMyIjogewogICAgICAibmFtZSI6ICJFQzIiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTMtMDYtMTUqIiwKICAgICAgICAiMjAxMy0xMC0xNSoiLAogICAgICAgICIyMDE0LTAyLTAxKiIsCiAgICAgICAgIjIwMTQtMDUtMDEqIiwKICAgICAgICAiMjAxNC0wNi0xNSoiLAogICAgICAgICIyMDE0LTA5LTAxKiIsCiAgICAgICAgIjIwMTQtMTAtMDEqIiwKICAgICAgICAiMjAxNS0wMy0wMSoiLAogICAgICAgICIyMDE1LTA0LTE1KiIsCiAgICAgICAgIjIwMTUtMTAtMDEqIiwKICAgICAgICAiMjAxNi0wNC0wMSoiLAogICAgICAgICIyMDE2LTA5LTE1KiIKICAgICAgXSwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVjciI6IHsKICAgICAgIm5hbWUiOiAiRUNSIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVjcyI6IHsKICAgICAgIm5hbWUiOiAiRUNTIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVmcyI6IHsKICAgICAgInByZWZpeCI6ICJlbGFzdGljZmlsZXN5c3RlbSIsCiAgICAgICJuYW1lIjogIkVGUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlbGFzdGljYWNoZSI6IHsKICAgICAgIm5hbWUiOiAiRWxhc3RpQ2FjaGUiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTItMTEtMTUqIiwKICAgICAgICAiMjAxNC0wMy0yNCoiLAogICAgICAgICIyMDE0LTA3LTE1KiIsCiAgICAgICAgIjIwMTQtMDktMzAqIgogICAgICBdLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZWxhc3RpY2JlYW5zdGFsayI6IHsKICAgICAgIm5hbWUiOiAiRWxhc3RpY0JlYW5zdGFsayIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlbGIiOiB7CiAgICAgICJwcmVmaXgiOiAiZWxhc3RpY2xvYWRiYWxhbmNpbmciLAogICAgICAibmFtZSI6ICJFTEIiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZWxidjIiOiB7CiAgICAgICJwcmVmaXgiOiAiZWxhc3RpY2xvYWRiYWxhbmNpbmd2MiIsCiAgICAgICJuYW1lIjogIkVMQnYyIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVtciI6IHsKICAgICAgInByZWZpeCI6ICJlbGFzdGljbWFwcmVkdWNlIiwKICAgICAgIm5hbWUiOiAiRU1SIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVzIjogewogICAgICAibmFtZSI6ICJFUyIKICAgIH0sCiAgICAiZWxhc3RpY3RyYW5zY29kZXIiOiB7CiAgICAgICJuYW1lIjogIkVsYXN0aWNUcmFuc2NvZGVyIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImZpcmVob3NlIjogewogICAgICAibmFtZSI6ICJGaXJlaG9zZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJnYW1lbGlmdCI6IHsKICAgICAgIm5hbWUiOiAiR2FtZUxpZnQiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZ2xhY2llciI6IHsKICAgICAgIm5hbWUiOiAiR2xhY2llciIKICAgIH0sCiAgICAiaGVhbHRoIjogewogICAgICAibmFtZSI6ICJIZWFsdGgiCiAgICB9LAogICAgImlhbSI6IHsKICAgICAgIm5hbWUiOiAiSUFNIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImltcG9ydGV4cG9ydCI6IHsKICAgICAgIm5hbWUiOiAiSW1wb3J0RXhwb3J0IgogICAgfSwKICAgICJpbnNwZWN0b3IiOiB7CiAgICAgICJuYW1lIjogIkluc3BlY3RvciIsCiAgICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgICAiMjAxNS0wOC0xOCoiCiAgICAgIF0sCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJpb3QiOiB7CiAgICAgICJuYW1lIjogIklvdCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJpb3RkYXRhIjogewogICAgICAicHJlZml4IjogImlvdC1kYXRhIiwKICAgICAgIm5hbWUiOiAiSW90RGF0YSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJraW5lc2lzIjogewogICAgICAibmFtZSI6ICJLaW5lc2lzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImtpbmVzaXNhbmFseXRpY3MiOiB7CiAgICAgICJuYW1lIjogIktpbmVzaXNBbmFseXRpY3MiCiAgICB9LAogICAgImttcyI6IHsKICAgICAgIm5hbWUiOiAiS01TIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImxhbWJkYSI6IHsKICAgICAgIm5hbWUiOiAiTGFtYmRhIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImxleHJ1bnRpbWUiOiB7CiAgICAgICJwcmVmaXgiOiAicnVudGltZS5sZXgiLAogICAgICAibmFtZSI6ICJMZXhSdW50aW1lIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImxpZ2h0c2FpbCI6IHsKICAgICAgIm5hbWUiOiAiTGlnaHRzYWlsIgogICAgfSwKICAgICJtYWNoaW5lbGVhcm5pbmciOiB7CiAgICAgICJuYW1lIjogIk1hY2hpbmVMZWFybmluZyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJtYXJrZXRwbGFjZWNvbW1lcmNlYW5hbHl0aWNzIjogewogICAgICAibmFtZSI6ICJNYXJrZXRwbGFjZUNvbW1lcmNlQW5hbHl0aWNzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIm1hcmtldHBsYWNlbWV0ZXJpbmciOiB7CiAgICAgICJwcmVmaXgiOiAibWV0ZXJpbmdtYXJrZXRwbGFjZSIsCiAgICAgICJuYW1lIjogIk1hcmtldHBsYWNlTWV0ZXJpbmciCiAgICB9LAogICAgIm10dXJrIjogewogICAgICAicHJlZml4IjogIm10dXJrLXJlcXVlc3RlciIsCiAgICAgICJuYW1lIjogIk1UdXJrIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIm1vYmlsZWFuYWx5dGljcyI6IHsKICAgICAgIm5hbWUiOiAiTW9iaWxlQW5hbHl0aWNzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIm9wc3dvcmtzIjogewogICAgICAibmFtZSI6ICJPcHNXb3JrcyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJvcHN3b3Jrc2NtIjogewogICAgICAibmFtZSI6ICJPcHNXb3Jrc0NNIgogICAgfSwKICAgICJvcmdhbml6YXRpb25zIjogewogICAgICAibmFtZSI6ICJPcmdhbml6YXRpb25zIgogICAgfSwKICAgICJwaW5wb2ludCI6IHsKICAgICAgIm5hbWUiOiAiUGlucG9pbnQiCiAgICB9LAogICAgInBvbGx5IjogewogICAgICAibmFtZSI6ICJQb2xseSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJyZHMiOiB7CiAgICAgICJuYW1lIjogIlJEUyIsCiAgICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgICAiMjAxNC0wOS0wMSoiCiAgICAgIF0sCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJyZWRzaGlmdCI6IHsKICAgICAgIm5hbWUiOiAiUmVkc2hpZnQiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAicmVrb2duaXRpb24iOiB7CiAgICAgICJuYW1lIjogIlJla29nbml0aW9uIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInJlc291cmNlZ3JvdXBzdGFnZ2luZ2FwaSI6IHsKICAgICAgIm5hbWUiOiAiUmVzb3VyY2VHcm91cHNUYWdnaW5nQVBJIgogICAgfSwKICAgICJyb3V0ZTUzIjogewogICAgICAibmFtZSI6ICJSb3V0ZTUzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInJvdXRlNTNkb21haW5zIjogewogICAgICAibmFtZSI6ICJSb3V0ZTUzRG9tYWlucyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzMyI6IHsKICAgICAgIm5hbWUiOiAiUzMiLAogICAgICAiZHVhbHN0YWNrQXZhaWxhYmxlIjogdHJ1ZSwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInMzY29udHJvbCI6IHsKICAgICAgIm5hbWUiOiAiUzNDb250cm9sIiwKICAgICAgImR1YWxzdGFja0F2YWlsYWJsZSI6IHRydWUKICAgIH0sCiAgICAic2VydmljZWNhdGFsb2ciOiB7CiAgICAgICJuYW1lIjogIlNlcnZpY2VDYXRhbG9nIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInNlcyI6IHsKICAgICAgInByZWZpeCI6ICJlbWFpbCIsCiAgICAgICJuYW1lIjogIlNFUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzaGllbGQiOiB7CiAgICAgICJuYW1lIjogIlNoaWVsZCIKICAgIH0sCiAgICAic2ltcGxlZGIiOiB7CiAgICAgICJwcmVmaXgiOiAic2RiIiwKICAgICAgIm5hbWUiOiAiU2ltcGxlREIiCiAgICB9LAogICAgInNtcyI6IHsKICAgICAgIm5hbWUiOiAiU01TIgogICAgfSwKICAgICJzbm93YmFsbCI6IHsKICAgICAgIm5hbWUiOiAiU25vd2JhbGwiCiAgICB9LAogICAgInNucyI6IHsKICAgICAgIm5hbWUiOiAiU05TIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInNxcyI6IHsKICAgICAgIm5hbWUiOiAiU1FTIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInNzbSI6IHsKICAgICAgIm5hbWUiOiAiU1NNIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInN0b3JhZ2VnYXRld2F5IjogewogICAgICAibmFtZSI6ICJTdG9yYWdlR2F0ZXdheSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzdGVwZnVuY3Rpb25zIjogewogICAgICAicHJlZml4IjogInN0YXRlcyIsCiAgICAgICJuYW1lIjogIlN0ZXBGdW5jdGlvbnMiCiAgICB9LAogICAgInN0cyI6IHsKICAgICAgIm5hbWUiOiAiU1RTIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInN1cHBvcnQiOiB7CiAgICAgICJuYW1lIjogIlN1cHBvcnQiCiAgICB9LAogICAgInN3ZiI6IHsKICAgICAgIm5hbWUiOiAiU1dGIgogICAgfSwKICAgICJ4cmF5IjogewogICAgICAibmFtZSI6ICJYUmF5IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIndhZiI6IHsKICAgICAgIm5hbWUiOiAiV0FGIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIndhZnJlZ2lvbmFsIjogewogICAgICAicHJlZml4IjogIndhZi1yZWdpb25hbCIsCiAgICAgICJuYW1lIjogIldBRlJlZ2lvbmFsIgogICAgfSwKICAgICJ3b3JrZG9jcyI6IHsKICAgICAgIm5hbWUiOiAiV29ya0RvY3MiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAid29ya3NwYWNlcyI6IHsKICAgICAgIm5hbWUiOiAiV29ya1NwYWNlcyIKICAgIH0sCiAgICAiY29kZXN0YXIiOiB7CiAgICAgICJuYW1lIjogIkNvZGVTdGFyIgogICAgfSwKICAgICJsZXhtb2RlbGJ1aWxkaW5nc2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJsZXgtbW9kZWxzIiwKICAgICAgIm5hbWUiOiAiTGV4TW9kZWxCdWlsZGluZ1NlcnZpY2UiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAibWFya2V0cGxhY2VlbnRpdGxlbWVudHNlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAiZW50aXRsZW1lbnQubWFya2V0cGxhY2UiLAogICAgICAibmFtZSI6ICJNYXJrZXRwbGFjZUVudGl0bGVtZW50U2VydmljZSIKICAgIH0sCiAgICAiYXRoZW5hIjogewogICAgICAibmFtZSI6ICJBdGhlbmEiCiAgICB9LAogICAgImdyZWVuZ3Jhc3MiOiB7CiAgICAgICJuYW1lIjogIkdyZWVuZ3Jhc3MiCiAgICB9LAogICAgImRheCI6IHsKICAgICAgIm5hbWUiOiAiREFYIgogICAgfSwKICAgICJtaWdyYXRpb25odWIiOiB7CiAgICAgICJwcmVmaXgiOiAiQVdTTWlncmF0aW9uSHViIiwKICAgICAgIm5hbWUiOiAiTWlncmF0aW9uSHViIgogICAgfSwKICAgICJjbG91ZGhzbXYyIjogewogICAgICAibmFtZSI6ICJDbG91ZEhTTVYyIgogICAgfSwKICAgICJnbHVlIjogewogICAgICAibmFtZSI6ICJHbHVlIgogICAgfSwKICAgICJtb2JpbGUiOiB7CiAgICAgICJuYW1lIjogIk1vYmlsZSIKICAgIH0sCiAgICAicHJpY2luZyI6IHsKICAgICAgIm5hbWUiOiAiUHJpY2luZyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb3N0ZXhwbG9yZXIiOiB7CiAgICAgICJwcmVmaXgiOiAiY2UiLAogICAgICAibmFtZSI6ICJDb3N0RXhwbG9yZXIiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAibWVkaWFjb252ZXJ0IjogewogICAgICAibmFtZSI6ICJNZWRpYUNvbnZlcnQiCiAgICB9LAogICAgIm1lZGlhbGl2ZSI6IHsKICAgICAgIm5hbWUiOiAiTWVkaWFMaXZlIgogICAgfSwKICAgICJtZWRpYXBhY2thZ2UiOiB7CiAgICAgICJuYW1lIjogIk1lZGlhUGFja2FnZSIKICAgIH0sCiAgICAibWVkaWFzdG9yZSI6IHsKICAgICAgIm5hbWUiOiAiTWVkaWFTdG9yZSIKICAgIH0sCiAgICAibWVkaWFzdG9yZWRhdGEiOiB7CiAgICAgICJwcmVmaXgiOiAibWVkaWFzdG9yZS1kYXRhIiwKICAgICAgIm5hbWUiOiAiTWVkaWFTdG9yZURhdGEiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiYXBwc3luYyI6IHsKICAgICAgIm5hbWUiOiAiQXBwU3luYyIKICAgIH0sCiAgICAiZ3VhcmRkdXR5IjogewogICAgICAibmFtZSI6ICJHdWFyZER1dHkiCiAgICB9LAogICAgIm1xIjogewogICAgICAibmFtZSI6ICJNUSIKICAgIH0sCiAgICAiY29tcHJlaGVuZCI6IHsKICAgICAgIm5hbWUiOiAiQ29tcHJlaGVuZCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJpb3Rqb2JzZGF0YXBsYW5lIjogewogICAgICAicHJlZml4IjogImlvdC1qb2JzLWRhdGEiLAogICAgICAibmFtZSI6ICJJb1RKb2JzRGF0YVBsYW5lIgogICAgfSwKICAgICJraW5lc2lzdmlkZW9hcmNoaXZlZG1lZGlhIjogewogICAgICAicHJlZml4IjogImtpbmVzaXMtdmlkZW8tYXJjaGl2ZWQtbWVkaWEiLAogICAgICAibmFtZSI6ICJLaW5lc2lzVmlkZW9BcmNoaXZlZE1lZGlhIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImtpbmVzaXN2aWRlb21lZGlhIjogewogICAgICAicHJlZml4IjogImtpbmVzaXMtdmlkZW8tbWVkaWEiLAogICAgICAibmFtZSI6ICJLaW5lc2lzVmlkZW9NZWRpYSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJraW5lc2lzdmlkZW8iOiB7CiAgICAgICJuYW1lIjogIktpbmVzaXNWaWRlbyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzYWdlbWFrZXJydW50aW1lIjogewogICAgICAicHJlZml4IjogInJ1bnRpbWUuc2FnZW1ha2VyIiwKICAgICAgIm5hbWUiOiAiU2FnZU1ha2VyUnVudGltZSIKICAgIH0sCiAgICAic2FnZW1ha2VyIjogewogICAgICAibmFtZSI6ICJTYWdlTWFrZXIiCiAgICB9LAogICAgInRyYW5zbGF0ZSI6IHsKICAgICAgIm5hbWUiOiAiVHJhbnNsYXRlIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInJlc291cmNlZ3JvdXBzIjogewogICAgICAicHJlZml4IjogInJlc291cmNlLWdyb3VwcyIsCiAgICAgICJuYW1lIjogIlJlc291cmNlR3JvdXBzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFsZXhhZm9yYnVzaW5lc3MiOiB7CiAgICAgICJuYW1lIjogIkFsZXhhRm9yQnVzaW5lc3MiCiAgICB9LAogICAgImNsb3VkOSI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWQ5IgogICAgfSwKICAgICJzZXJ2ZXJsZXNzYXBwbGljYXRpb25yZXBvc2l0b3J5IjogewogICAgICAicHJlZml4IjogInNlcnZlcmxlc3NyZXBvIiwKICAgICAgIm5hbWUiOiAiU2VydmVybGVzc0FwcGxpY2F0aW9uUmVwb3NpdG9yeSIKICAgIH0sCiAgICAic2VydmljZWRpc2NvdmVyeSI6IHsKICAgICAgIm5hbWUiOiAiU2VydmljZURpc2NvdmVyeSIKICAgIH0sCiAgICAid29ya21haWwiOiB7CiAgICAgICJuYW1lIjogIldvcmtNYWlsIgogICAgfSwKICAgICJhdXRvc2NhbGluZ3BsYW5zIjogewogICAgICAicHJlZml4IjogImF1dG9zY2FsaW5nLXBsYW5zIiwKICAgICAgIm5hbWUiOiAiQXV0b1NjYWxpbmdQbGFucyIKICAgIH0sCiAgICAidHJhbnNjcmliZXNlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAidHJhbnNjcmliZSIsCiAgICAgICJuYW1lIjogIlRyYW5zY3JpYmVTZXJ2aWNlIgogICAgfSwKICAgICJhY21wY2EiOiB7CiAgICAgICJwcmVmaXgiOiAiYWNtLXBjYSIsCiAgICAgICJuYW1lIjogIkFDTVBDQSIKICAgIH0sCiAgICAiZm1zIjogewogICAgICAibmFtZSI6ICJGTVMiCiAgICB9LAogICAgInNlY3JldHNtYW5hZ2VyIjogewogICAgICAibmFtZSI6ICJTZWNyZXRzTWFuYWdlciIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJpb3RhbmFseXRpY3MiOiB7CiAgICAgICJuYW1lIjogIklvVEFuYWx5dGljcyIsCiAgICAgICJjb3JzIjogdHJ1ZQkKICAgIH0sCiAgICAiaW90MWNsaWNrZGV2aWNlc3NlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAiaW90MWNsaWNrLWRldmljZXMiLAogICAgICAibmFtZSI6ICJJb1QxQ2xpY2tEZXZpY2VzU2VydmljZSIKICAgIH0sCiAgICAiaW90MWNsaWNrcHJvamVjdHMiOiB7CiAgICAgICJwcmVmaXgiOiAiaW90MWNsaWNrLXByb2plY3RzIiwKICAgICAgIm5hbWUiOiAiSW9UMUNsaWNrUHJvamVjdHMiCiAgICB9LAogICAgInBpIjogewogICAgICAibmFtZSI6ICJQSSIKICAgIH0sCiAgICAibmVwdHVuZSI6IHsKICAgICAgIm5hbWUiOiAiTmVwdHVuZSIKICAgIH0sCiAgICAibWVkaWF0YWlsb3IiOiB7CiAgICAgICJuYW1lIjogIk1lZGlhVGFpbG9yIgogICAgfSwKICAgICJla3MiOiB7CiAgICAgICJuYW1lIjogIkVLUyIKICAgIH0sCiAgICAibWFjaWUiOiB7CiAgICAgICJuYW1lIjogIk1hY2llIgogICAgfSwKICAgICJkbG0iOiB7CiAgICAgICJuYW1lIjogIkRMTSIKICAgIH0sCiAgICAic2lnbmVyIjogewogICAgICAibmFtZSI6ICJTaWduZXIiCiAgICB9LAogICAgImNoaW1lIjogewogICAgICAibmFtZSI6ICJDaGltZSIKICAgIH0sCiAgICAicGlucG9pbnRlbWFpbCI6IHsKICAgICAgInByZWZpeCI6ICJwaW5wb2ludC1lbWFpbCIsCiAgICAgICJuYW1lIjogIlBpbnBvaW50RW1haWwiCiAgICB9LAogICAgInJhbSI6IHsKICAgICAgIm5hbWUiOiAiUkFNIgogICAgfSwKICAgICJyb3V0ZTUzcmVzb2x2ZXIiOiB7CiAgICAgICJuYW1lIjogIlJvdXRlNTNSZXNvbHZlciIKICAgIH0sCiAgICAicGlucG9pbnRzbXN2b2ljZSI6IHsKICAgICAgInByZWZpeCI6ICJzbXMtdm9pY2UiLAogICAgICAibmFtZSI6ICJQaW5wb2ludFNNU1ZvaWNlIgogICAgfSwKICAgICJxdWlja3NpZ2h0IjogewogICAgICAibmFtZSI6ICJRdWlja1NpZ2h0IgogICAgfSwKICAgICJyZHNkYXRhc2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJyZHMtZGF0YSIsCiAgICAgICJuYW1lIjogIlJEU0RhdGFTZXJ2aWNlIgogICAgfSwKICAgICJhbXBsaWZ5IjogewogICAgICAibmFtZSI6ICJBbXBsaWZ5IgogICAgfSwKICAgICJkYXRhc3luYyI6IHsKICAgICAgIm5hbWUiOiAiRGF0YVN5bmMiCiAgICB9LAogICAgInJvYm9tYWtlciI6IHsKICAgICAgIm5hbWUiOiAiUm9ib01ha2VyIgogICAgfSwKICAgICJ0cmFuc2ZlciI6IHsKICAgICAgIm5hbWUiOiAiVHJhbnNmZXIiCiAgICB9LAogICAgImdsb2JhbGFjY2VsZXJhdG9yIjogewogICAgICAibmFtZSI6ICJHbG9iYWxBY2NlbGVyYXRvciIKICAgIH0sCiAgICAiY29tcHJlaGVuZG1lZGljYWwiOiB7CiAgICAgICJuYW1lIjogIkNvbXByZWhlbmRNZWRpY2FsIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImtpbmVzaXNhbmFseXRpY3N2MiI6IHsKICAgICAgIm5hbWUiOiAiS2luZXNpc0FuYWx5dGljc1YyIgogICAgfSwKICAgICJtZWRpYWNvbm5lY3QiOiB7CiAgICAgICJuYW1lIjogIk1lZGlhQ29ubmVjdCIKICAgIH0sCiAgICAiZnN4IjogewogICAgICAibmFtZSI6ICJGU3giCiAgICB9LAogICAgInNlY3VyaXR5aHViIjogewogICAgICAibmFtZSI6ICJTZWN1cml0eUh1YiIKICAgIH0sCiAgICAiYXBwbWVzaCI6IHsKICAgICAgIm5hbWUiOiAiQXBwTWVzaCIsCiAgICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgICAiMjAxOC0xMC0wMSoiCiAgICAgIF0KICAgIH0sCiAgICAibGljZW5zZW1hbmFnZXIiOiB7CiAgICAgICJwcmVmaXgiOiAibGljZW5zZS1tYW5hZ2VyIiwKICAgICAgIm5hbWUiOiAiTGljZW5zZU1hbmFnZXIiCiAgICB9LAogICAgImthZmthIjogewogICAgICAibmFtZSI6ICJLYWZrYSIKICAgIH0sCiAgICAiYXBpZ2F0ZXdheW1hbmFnZW1lbnRhcGkiOiB7CiAgICAgICJuYW1lIjogIkFwaUdhdGV3YXlNYW5hZ2VtZW50QXBpIgogICAgfSwKICAgICJhcGlnYXRld2F5djIiOiB7CiAgICAgICJuYW1lIjogIkFwaUdhdGV3YXlWMiIKICAgIH0sCiAgICAiZG9jZGIiOiB7CiAgICAgICJuYW1lIjogIkRvY0RCIgogICAgfSwKICAgICJiYWNrdXAiOiB7CiAgICAgICJuYW1lIjogIkJhY2t1cCIKICAgIH0sCiAgICAid29ya2xpbmsiOiB7CiAgICAgICJuYW1lIjogIldvcmtMaW5rIgogICAgfSwKICAgICJ0ZXh0cmFjdCI6IHsKICAgICAgIm5hbWUiOiAiVGV4dHJhY3QiCiAgICB9LAogICAgIm1hbmFnZWRibG9ja2NoYWluIjogewogICAgICAibmFtZSI6ICJNYW5hZ2VkQmxvY2tjaGFpbiIKICAgIH0sCiAgICAibWVkaWFwYWNrYWdldm9kIjogewogICAgICAicHJlZml4IjogIm1lZGlhcGFja2FnZS12b2QiLAogICAgICAibmFtZSI6ICJNZWRpYVBhY2thZ2VWb2QiCiAgICB9LAogICAgImdyb3VuZHN0YXRpb24iOiB7CiAgICAgICJuYW1lIjogIkdyb3VuZFN0YXRpb24iCiAgICB9LAogICAgImlvdHRoaW5nc2dyYXBoIjogewogICAgICAibmFtZSI6ICJJb1RUaGluZ3NHcmFwaCIKICAgIH0sCiAgICAiaW90ZXZlbnRzIjogewogICAgICAibmFtZSI6ICJJb1RFdmVudHMiCiAgICB9LAogICAgImlvdGV2ZW50c2RhdGEiOiB7CiAgICAgICJwcmVmaXgiOiAiaW90ZXZlbnRzLWRhdGEiLAogICAgICAibmFtZSI6ICJJb1RFdmVudHNEYXRhIgogICAgfSwKICAgICJwZXJzb25hbGl6ZSI6IHsKICAgICAgIm5hbWUiOiAiUGVyc29uYWxpemUiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAicGVyc29uYWxpemVldmVudHMiOiB7CiAgICAgICJwcmVmaXgiOiAicGVyc29uYWxpemUtZXZlbnRzIiwKICAgICAgIm5hbWUiOiAiUGVyc29uYWxpemVFdmVudHMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAicGVyc29uYWxpemVydW50aW1lIjogewogICAgICAicHJlZml4IjogInBlcnNvbmFsaXplLXJ1bnRpbWUiLAogICAgICAibmFtZSI6ICJQZXJzb25hbGl6ZVJ1bnRpbWUiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiYXBwbGljYXRpb25pbnNpZ2h0cyI6IHsKICAgICAgInByZWZpeCI6ICJhcHBsaWNhdGlvbi1pbnNpZ2h0cyIsCiAgICAgICJuYW1lIjogIkFwcGxpY2F0aW9uSW5zaWdodHMiCiAgICB9LAogICAgInNlcnZpY2VxdW90YXMiOiB7CiAgICAgICJwcmVmaXgiOiAic2VydmljZS1xdW90YXMiLAogICAgICAibmFtZSI6ICJTZXJ2aWNlUXVvdGFzIgogICAgfSwKICAgICJlYzJpbnN0YW5jZWNvbm5lY3QiOiB7CiAgICAgICJwcmVmaXgiOiAiZWMyLWluc3RhbmNlLWNvbm5lY3QiLAogICAgICAibmFtZSI6ICJFQzJJbnN0YW5jZUNvbm5lY3QiCiAgICB9LAogICAgImV2ZW50YnJpZGdlIjogewogICAgICAibmFtZSI6ICJFdmVudEJyaWRnZSIKICAgIH0sCiAgICAibGFrZWZvcm1hdGlvbiI6IHsKICAgICAgIm5hbWUiOiAiTGFrZUZvcm1hdGlvbiIKICAgIH0sCiAgICAiZm9yZWNhc3RzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogImZvcmVjYXN0IiwKICAgICAgIm5hbWUiOiAiRm9yZWNhc3RTZXJ2aWNlIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImZvcmVjYXN0cXVlcnlzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogImZvcmVjYXN0cXVlcnkiLAogICAgICAibmFtZSI6ICJGb3JlY2FzdFF1ZXJ5U2VydmljZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJxbGRiIjogewogICAgICAibmFtZSI6ICJRTERCIgogICAgfSwKICAgICJxbGRic2Vzc2lvbiI6IHsKICAgICAgInByZWZpeCI6ICJxbGRiLXNlc3Npb24iLAogICAgICAibmFtZSI6ICJRTERCU2Vzc2lvbiIKICAgIH0sCiAgICAid29ya21haWxtZXNzYWdlZmxvdyI6IHsKICAgICAgIm5hbWUiOiAiV29ya01haWxNZXNzYWdlRmxvdyIKICAgIH0KICB9CiAgCiAgfSx7fV0sNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHM9ewogICAgInZlcnNpb24iOiAiMi4wIiwKICAgICJtZXRhZGF0YSI6IHsKICAgICAgImFwaVZlcnNpb24iOiAiMjAxMS0wNi0xNSIsCiAgICAgICJlbmRwb2ludFByZWZpeCI6ICJzdHMiLAogICAgICAiZ2xvYmFsRW5kcG9pbnQiOiAic3RzLmFtYXpvbmF3cy5jb20iLAogICAgICAicHJvdG9jb2wiOiAicXVlcnkiLAogICAgICAic2VydmljZUFiYnJldmlhdGlvbiI6ICJBV1MgU1RTIiwKICAgICAgInNlcnZpY2VGdWxsTmFtZSI6ICJBV1MgU2VjdXJpdHkgVG9rZW4gU2VydmljZSIsCiAgICAgICJzZXJ2aWNlSWQiOiAiU1RTIiwKICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAidjQiLAogICAgICAidWlkIjogInN0cy0yMDExLTA2LTE1IiwKICAgICAgInhtbE5hbWVzcGFjZSI6ICJodHRwczovL3N0cy5hbWF6b25hd3MuY29tL2RvYy8yMDExLTA2LTE1LyIKICAgIH0sCiAgICAib3BlcmF0aW9ucyI6IHsKICAgICAgIkFzc3VtZVJvbGUiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJvbGVBcm4iLAogICAgICAgICAgICAiUm9sZVNlc3Npb25OYW1lIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUm9sZUFybiI6IHt9LAogICAgICAgICAgICAiUm9sZVNlc3Npb25OYW1lIjoge30sCiAgICAgICAgICAgICJQb2xpY3lBcm5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTNCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlBvbGljeSI6IHt9LAogICAgICAgICAgICAiRHVyYXRpb25TZWNvbmRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJFeHRlcm5hbElkIjoge30sCiAgICAgICAgICAgICJTZXJpYWxOdW1iZXIiOiB7fSwKICAgICAgICAgICAgIlRva2VuQ29kZSI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiQXNzdW1lUm9sZVJlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJDcmVkZW50aWFscyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2MiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJBc3N1bWVkUm9sZVVzZXIiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNoIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUGFja2VkUG9saWN5U2l6ZSI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQXNzdW1lUm9sZVdpdGhTQU1MIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJSb2xlQXJuIiwKICAgICAgICAgICAgIlByaW5jaXBhbEFybiIsCiAgICAgICAgICAgICJTQU1MQXNzZXJ0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUm9sZUFybiI6IHt9LAogICAgICAgICAgICAiUHJpbmNpcGFsQXJuIjoge30sCiAgICAgICAgICAgICJTQU1MQXNzZXJ0aW9uIjoge30sCiAgICAgICAgICAgICJQb2xpY3lBcm5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTNCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlBvbGljeSI6IHt9LAogICAgICAgICAgICAiRHVyYXRpb25TZWNvbmRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJBc3N1bWVSb2xlV2l0aFNBTUxSZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNjIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiQXNzdW1lZFJvbGVVc2VyIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTaCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlBhY2tlZFBvbGljeVNpemUiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlN1YmplY3QiOiB7fSwKICAgICAgICAgICAgIlN1YmplY3RUeXBlIjoge30sCiAgICAgICAgICAgICJJc3N1ZXIiOiB7fSwKICAgICAgICAgICAgIkF1ZGllbmNlIjoge30sCiAgICAgICAgICAgICJOYW1lUXVhbGlmaWVyIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJBc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJSb2xlQXJuIiwKICAgICAgICAgICAgIlJvbGVTZXNzaW9uTmFtZSIsCiAgICAgICAgICAgICJXZWJJZGVudGl0eVRva2VuIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUm9sZUFybiI6IHt9LAogICAgICAgICAgICAiUm9sZVNlc3Npb25OYW1lIjoge30sCiAgICAgICAgICAgICJXZWJJZGVudGl0eVRva2VuIjoge30sCiAgICAgICAgICAgICJQcm92aWRlcklkIjoge30sCiAgICAgICAgICAgICJQb2xpY3lBcm5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTNCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlBvbGljeSI6IHt9LAogICAgICAgICAgICAiRHVyYXRpb25TZWNvbmRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJBc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5UmVzdWx0IiwKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTYyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlN1YmplY3RGcm9tV2ViSWRlbnRpdHlUb2tlbiI6IHt9LAogICAgICAgICAgICAiQXNzdW1lZFJvbGVVc2VyIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTaCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlBhY2tlZFBvbGljeVNpemUiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlByb3ZpZGVyIjoge30sCiAgICAgICAgICAgICJBdWRpZW5jZSI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiRGVjb2RlQXV0aG9yaXphdGlvbk1lc3NhZ2UiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIkVuY29kZWRNZXNzYWdlIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiRW5jb2RlZE1lc3NhZ2UiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkRlY29kZUF1dGhvcml6YXRpb25NZXNzYWdlUmVzdWx0IiwKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkRlY29kZWRNZXNzYWdlIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRBY2Nlc3NLZXlJbmZvIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJBY2Nlc3NLZXlJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkFjY2Vzc0tleUlkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJHZXRBY2Nlc3NLZXlJbmZvUmVzdWx0IiwKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkFjY291bnQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldENhbGxlcklkZW50aXR5IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiR2V0Q2FsbGVySWRlbnRpdHlSZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiVXNlcklkIjoge30sCiAgICAgICAgICAgICJBY2NvdW50Ijoge30sCiAgICAgICAgICAgICJBcm4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldEZlZGVyYXRpb25Ub2tlbiI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiTmFtZSIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIk5hbWUiOiB7fSwKICAgICAgICAgICAgIlBvbGljeSI6IHt9LAogICAgICAgICAgICAiUG9saWN5QXJucyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJEdXJhdGlvblNlY29uZHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkdldEZlZGVyYXRpb25Ub2tlblJlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJDcmVkZW50aWFscyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2MiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJGZWRlcmF0ZWRVc2VyIjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgIkZlZGVyYXRlZFVzZXJJZCIsCiAgICAgICAgICAgICAgICAiQXJuIgogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAiRmVkZXJhdGVkVXNlcklkIjoge30sCiAgICAgICAgICAgICAgICAiQXJuIjoge30KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQYWNrZWRQb2xpY3lTaXplIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRTZXNzaW9uVG9rZW4iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiRHVyYXRpb25TZWNvbmRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJTZXJpYWxOdW1iZXIiOiB7fSwKICAgICAgICAgICAgIlRva2VuQ29kZSI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiR2V0U2Vzc2lvblRva2VuUmVzdWx0IiwKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTYyIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJzaGFwZXMiOiB7CiAgICAgICJTNCI6IHsKICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXJuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTYyI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJBY2Nlc3NLZXlJZCIsCiAgICAgICAgICAiU2VjcmV0QWNjZXNzS2V5IiwKICAgICAgICAgICJTZXNzaW9uVG9rZW4iLAogICAgICAgICAgIkV4cGlyYXRpb24iCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJBY2Nlc3NLZXlJZCI6IHt9LAogICAgICAgICAgIlNlY3JldEFjY2Vzc0tleSI6IHt9LAogICAgICAgICAgIlNlc3Npb25Ub2tlbiI6IHt9LAogICAgICAgICAgIkV4cGlyYXRpb24iOiB7CiAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTaCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJBc3N1bWVkUm9sZUlkIiwKICAgICAgICAgICJBcm4iCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJBc3N1bWVkUm9sZUlkIjoge30sCiAgICAgICAgICAiQXJuIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgfSx7fV0sNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgYXJndW1lbnRzWzRdWzJdWzBdLmFwcGx5KGV4cG9ydHMsYXJndW1lbnRzKQogIH0seyJkdXAiOjJ9XSw3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICByZXF1aXJlKCcuLi9saWIvbm9kZV9sb2FkZXInKTsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vbGliL2NvcmUnKTsKICB2YXIgU2VydmljZSA9IEFXUy5TZXJ2aWNlOwogIHZhciBhcGlMb2FkZXIgPSBBV1MuYXBpTG9hZGVyOwogIAogIGFwaUxvYWRlci5zZXJ2aWNlc1snY29nbml0b2lkZW50aXR5J10gPSB7fTsKICBBV1MuQ29nbml0b0lkZW50aXR5ID0gU2VydmljZS5kZWZpbmVTZXJ2aWNlKCdjb2duaXRvaWRlbnRpdHknLCBbJzIwMTQtMDYtMzAnXSk7CiAgcmVxdWlyZSgnLi4vbGliL3NlcnZpY2VzL2NvZ25pdG9pZGVudGl0eScpOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShhcGlMb2FkZXIuc2VydmljZXNbJ2NvZ25pdG9pZGVudGl0eSddLCAnMjAxNC0wNi0zMCcsIHsKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICB2YXIgbW9kZWwgPSByZXF1aXJlKCcuLi9hcGlzL2NvZ25pdG8taWRlbnRpdHktMjAxNC0wNi0zMC5taW4uanNvbicpOwogICAgICBtb2RlbC5wYWdpbmF0b3JzID0gcmVxdWlyZSgnLi4vYXBpcy9jb2duaXRvLWlkZW50aXR5LTIwMTQtMDYtMzAucGFnaW5hdG9ycy5qc29uJykucGFnaW5hdGlvbjsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBjb25maWd1cmFibGU6IHRydWUKICB9KTsKICAKICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5Db2duaXRvSWRlbnRpdHk7CiAgCiAgfSx7Ii4uL2FwaXMvY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwLm1pbi5qc29uIjoxLCIuLi9hcGlzL2NvZ25pdG8taWRlbnRpdHktMjAxNC0wNi0zMC5wYWdpbmF0b3JzLmpzb24iOjIsIi4uL2xpYi9jb3JlIjoxOCwiLi4vbGliL25vZGVfbG9hZGVyIjoxNiwiLi4vbGliL3NlcnZpY2VzL2NvZ25pdG9pZGVudGl0eSI6NjB9XSw4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICByZXF1aXJlKCcuLi9saWIvbm9kZV9sb2FkZXInKTsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vbGliL2NvcmUnKTsKICB2YXIgU2VydmljZSA9IEFXUy5TZXJ2aWNlOwogIHZhciBhcGlMb2FkZXIgPSBBV1MuYXBpTG9hZGVyOwogIAogIGFwaUxvYWRlci5zZXJ2aWNlc1snc3RzJ10gPSB7fTsKICBBV1MuU1RTID0gU2VydmljZS5kZWZpbmVTZXJ2aWNlKCdzdHMnLCBbJzIwMTEtMDYtMTUnXSk7CiAgcmVxdWlyZSgnLi4vbGliL3NlcnZpY2VzL3N0cycpOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShhcGlMb2FkZXIuc2VydmljZXNbJ3N0cyddLCAnMjAxMS0wNi0xNScsIHsKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICB2YXIgbW9kZWwgPSByZXF1aXJlKCcuLi9hcGlzL3N0cy0yMDExLTA2LTE1Lm1pbi5qc29uJyk7CiAgICAgIG1vZGVsLnBhZ2luYXRvcnMgPSByZXF1aXJlKCcuLi9hcGlzL3N0cy0yMDExLTA2LTE1LnBhZ2luYXRvcnMuanNvbicpLnBhZ2luYXRpb247CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlCiAgfSk7CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU1RTOwogIAogIH0seyIuLi9hcGlzL3N0cy0yMDExLTA2LTE1Lm1pbi5qc29uIjo1LCIuLi9hcGlzL3N0cy0yMDExLTA2LTE1LnBhZ2luYXRvcnMuanNvbiI6NiwiLi4vbGliL2NvcmUiOjE4LCIuLi9saWIvbm9kZV9sb2FkZXIiOjE2LCIuLi9saWIvc2VydmljZXMvc3RzIjo2MX1dLDk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIGZ1bmN0aW9uIGFwaUxvYWRlcihzdmMsIHZlcnNpb24pIHsKICAgIGlmICghYXBpTG9hZGVyLnNlcnZpY2VzLmhhc093blByb3BlcnR5KHN2YykpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkU2VydmljZTogRmFpbGVkIHRvIGxvYWQgYXBpIGZvciAnICsgc3ZjKTsKICAgIH0KICAgIHJldHVybiBhcGlMb2FkZXIuc2VydmljZXNbc3ZjXVt2ZXJzaW9uXTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICoKICAgKiBUaGlzIG1lbWJlciBvZiBBV1MuYXBpTG9hZGVyIGlzIHByaXZhdGUsIGJ1dCBjaGFuZ2luZyBpdCB3aWxsIG5lY2Vzc2l0YXRlIGEKICAgKiBjaGFuZ2UgdG8gLi4vc2NyaXB0cy9zZXJ2aWNlcy10YWJsZS1nZW5lcmF0b3IudHMKICAgKi8KICBhcGlMb2FkZXIuc2VydmljZXMgPSB7fTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IGFwaUxvYWRlcjsKICAKICB9LHt9XSwxMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEhtYWMgPSByZXF1aXJlKCcuL2Jyb3dzZXJIbWFjJyk7CiAgdmFyIE1kNSA9IHJlcXVpcmUoJy4vYnJvd3Nlck1kNScpOwogIHZhciBTaGExID0gcmVxdWlyZSgnLi9icm93c2VyU2hhMScpOwogIHZhciBTaGEyNTYgPSByZXF1aXJlKCcuL2Jyb3dzZXJTaGEyNTYnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSB7CiAgICAgIGNyZWF0ZUhhc2g6IGZ1bmN0aW9uIGNyZWF0ZUhhc2goYWxnKSB7CiAgICAgICAgYWxnID0gYWxnLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgaWYgKGFsZyA9PT0gJ21kNScpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWQ1KCk7CiAgICAgICAgfSBlbHNlIGlmIChhbGcgPT09ICdzaGEyNTYnKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFNoYTI1NigpOwogICAgICAgIH0gZWxzZSBpZiAoYWxnID09PSAnc2hhMScpIHsKICAgICAgICAgIHJldHVybiBuZXcgU2hhMSgpOwogICAgICAgIH0KICAKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0hhc2ggYWxnb3JpdGhtICcgKyBhbGcgKyAnIGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhlIGJyb3dzZXIgU0RLJyk7CiAgICAgIH0sCiAgICAgIGNyZWF0ZUhtYWM6IGZ1bmN0aW9uIGNyZWF0ZUhtYWMoYWxnLCBrZXkpIHsKICAgICAgICBhbGcgPSBhbGcudG9Mb3dlckNhc2UoKTsKICAgICAgICBpZiAoYWxnID09PSAnbWQ1JykgewogICAgICAgICAgcmV0dXJuIG5ldyBIbWFjKE1kNSwga2V5KTsKICAgICAgICB9IGVsc2UgaWYgKGFsZyA9PT0gJ3NoYTI1NicpIHsKICAgICAgICAgIHJldHVybiBuZXcgSG1hYyhTaGEyNTYsIGtleSk7CiAgICAgICAgfSBlbHNlIGlmIChhbGcgPT09ICdzaGExJykgewogICAgICAgICAgcmV0dXJuIG5ldyBIbWFjKFNoYTEsIGtleSk7CiAgICAgICAgfQogIAogICAgICAgIHRocm93IG5ldyBFcnJvcignSE1BQyBhbGdvcml0aG0gJyArIGFsZyArICcgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGUgYnJvd3NlciBTREsnKTsKICAgICAgfSwKICAgICAgY3JlYXRlU2lnbjogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdjcmVhdGVTaWduIGlzIG5vdCBpbXBsZW1lbnRlZCBpbiB0aGUgYnJvd3NlcicpOwogICAgICB9CiAgICB9OwogIAogIH0seyIuL2Jyb3dzZXJIbWFjIjoxMiwiLi9icm93c2VyTWQ1IjoxMywiLi9icm93c2VyU2hhMSI6MTQsIi4vYnJvd3NlclNoYTI1NiI6MTV9XSwxMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEJ1ZmZlciA9IHJlcXVpcmUoJ2J1ZmZlci8nKS5CdWZmZXI7CiAgCiAgLyoqCiAgICogVGhpcyBpcyBhIHBvbHlmaWxsIGZvciB0aGUgc3RhdGljIG1ldGhvZCBgaXNWaWV3YCBvZiBgQXJyYXlCdWZmZXJgLCB3aGljaCBpcwogICAqIGUuZy4gbWlzc2luZyBpbiBJRSAxMC4KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGlmICgKICAgICAgdHlwZW9mIEFycmF5QnVmZmVyICE9PSAndW5kZWZpbmVkJyAmJgogICAgICB0eXBlb2YgQXJyYXlCdWZmZXIuaXNWaWV3ID09PSAndW5kZWZpbmVkJwogICkgewogICAgICBBcnJheUJ1ZmZlci5pc1ZpZXcgPSBmdW5jdGlvbihhcmcpIHsKICAgICAgICAgIHJldHVybiB2aWV3U3RyaW5ncy5pbmRleE9mKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChhcmcpKSA+IC0xOwogICAgICB9OwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgdmlld1N0cmluZ3MgPSBbCiAgICAgICdbb2JqZWN0IEludDhBcnJheV0nLAogICAgICAnW29iamVjdCBVaW50OEFycmF5XScsCiAgICAgICdbb2JqZWN0IFVpbnQ4Q2xhbXBlZEFycmF5XScsCiAgICAgICdbb2JqZWN0IEludDE2QXJyYXldJywKICAgICAgJ1tvYmplY3QgVWludDE2QXJyYXldJywKICAgICAgJ1tvYmplY3QgSW50MzJBcnJheV0nLAogICAgICAnW29iamVjdCBVaW50MzJBcnJheV0nLAogICAgICAnW29iamVjdCBGbG9hdDMyQXJyYXldJywKICAgICAgJ1tvYmplY3QgRmxvYXQ2NEFycmF5XScsCiAgICAgICdbb2JqZWN0IERhdGFWaWV3XScsCiAgXTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBpc0VtcHR5RGF0YShkYXRhKSB7CiAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIHJldHVybiBkYXRhLmxlbmd0aCA9PT0gMDsKICAgICAgfQogICAgICByZXR1cm4gZGF0YS5ieXRlTGVuZ3RoID09PSAwOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBjb252ZXJ0VG9CdWZmZXIoZGF0YSkgewogICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBkYXRhID0gbmV3IEJ1ZmZlcihkYXRhLCAndXRmOCcpOwogICAgICB9CiAgCiAgICAgIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcoZGF0YSkpIHsKICAgICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0LCBkYXRhLmJ5dGVMZW5ndGggLyBVaW50OEFycmF5LkJZVEVTX1BFUl9FTEVNRU5UKTsKICAgICAgfQogIAogICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoZGF0YSk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IHsKICAgICAgaXNFbXB0eURhdGE6IGlzRW1wdHlEYXRhLAogICAgICBjb252ZXJ0VG9CdWZmZXI6IGNvbnZlcnRUb0J1ZmZlciwKICB9OwogIAogIH0seyJidWZmZXIvIjo4MX1dLDEyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgaGFzaFV0aWxzID0gcmVxdWlyZSgnLi9icm93c2VySGFzaFV0aWxzJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gSG1hYyhoYXNoQ3Rvciwgc2VjcmV0KSB7CiAgICAgIHRoaXMuaGFzaCA9IG5ldyBoYXNoQ3RvcigpOwogICAgICB0aGlzLm91dGVyID0gbmV3IGhhc2hDdG9yKCk7CiAgCiAgICAgIHZhciBpbm5lciA9IGJ1ZmZlckZyb21TZWNyZXQoaGFzaEN0b3IsIHNlY3JldCk7CiAgICAgIHZhciBvdXRlciA9IG5ldyBVaW50OEFycmF5KGhhc2hDdG9yLkJMT0NLX1NJWkUpOwogICAgICBvdXRlci5zZXQoaW5uZXIpOwogIAogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhhc2hDdG9yLkJMT0NLX1NJWkU7IGkrKykgewogICAgICAgICAgaW5uZXJbaV0gXj0gMHgzNjsKICAgICAgICAgIG91dGVyW2ldIF49IDB4NWM7CiAgICAgIH0KICAKICAgICAgdGhpcy5oYXNoLnVwZGF0ZShpbm5lcik7CiAgICAgIHRoaXMub3V0ZXIudXBkYXRlKG91dGVyKTsKICAKICAgICAgLy8gWmVybyBvdXQgdGhlIGNvcGllZCBrZXkgYnVmZmVyLgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGlubmVyLmJ5dGVMZW5ndGg7IGkrKykgewogICAgICAgICAgaW5uZXJbaV0gPSAwOwogICAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IEhtYWM7CiAgCiAgSG1hYy5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKHRvSGFzaCkgewogICAgICBpZiAoaGFzaFV0aWxzLmlzRW1wdHlEYXRhKHRvSGFzaCkgfHwgdGhpcy5lcnJvcikgewogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAKICAgICAgdHJ5IHsKICAgICAgICAgIHRoaXMuaGFzaC51cGRhdGUoaGFzaFV0aWxzLmNvbnZlcnRUb0J1ZmZlcih0b0hhc2gpKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgdGhpcy5lcnJvciA9IGU7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBIbWFjLnByb3RvdHlwZS5kaWdlc3QgPSBmdW5jdGlvbiAoZW5jb2RpbmcpIHsKICAgICAgaWYgKCF0aGlzLm91dGVyLmZpbmlzaGVkKSB7CiAgICAgICAgICB0aGlzLm91dGVyLnVwZGF0ZSh0aGlzLmhhc2guZGlnZXN0KCkpOwogICAgICB9CiAgCiAgICAgIHJldHVybiB0aGlzLm91dGVyLmRpZ2VzdChlbmNvZGluZyk7CiAgfTsKICAKICBmdW5jdGlvbiBidWZmZXJGcm9tU2VjcmV0KGhhc2hDdG9yLCBzZWNyZXQpIHsKICAgICAgdmFyIGlucHV0ID0gaGFzaFV0aWxzLmNvbnZlcnRUb0J1ZmZlcihzZWNyZXQpOwogICAgICBpZiAoaW5wdXQuYnl0ZUxlbmd0aCA+IGhhc2hDdG9yLkJMT0NLX1NJWkUpIHsKICAgICAgICAgIHZhciBidWZmZXJIYXNoID0gbmV3IGhhc2hDdG9yOwogICAgICAgICAgYnVmZmVySGFzaC51cGRhdGUoaW5wdXQpOwogICAgICAgICAgaW5wdXQgPSBidWZmZXJIYXNoLmRpZ2VzdCgpOwogICAgICB9CiAgICAgIHZhciBidWZmZXIgPSBuZXcgVWludDhBcnJheShoYXNoQ3Rvci5CTE9DS19TSVpFKTsKICAgICAgYnVmZmVyLnNldChpbnB1dCk7CiAgICAgIHJldHVybiBidWZmZXI7CiAgfQogIAogIH0seyIuL2Jyb3dzZXJIYXNoVXRpbHMiOjExfV0sMTM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBoYXNoVXRpbHMgPSByZXF1aXJlKCcuL2Jyb3dzZXJIYXNoVXRpbHMnKTsKICB2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKICAKICB2YXIgQkxPQ0tfU0laRSA9IDY0OwogIAogIHZhciBESUdFU1RfTEVOR1RIID0gMTY7CiAgCiAgdmFyIElOSVQgPSBbCiAgICAgIDB4Njc0NTIzMDEsCiAgICAgIDB4ZWZjZGFiODksCiAgICAgIDB4OThiYWRjZmUsCiAgICAgIDB4MTAzMjU0NzYsCiAgXTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBNZDUoKSB7CiAgICAgIHRoaXMuc3RhdGUgPSBbCiAgICAgICAgICAweDY3NDUyMzAxLAogICAgICAgICAgMHhlZmNkYWI4OSwKICAgICAgICAgIDB4OThiYWRjZmUsCiAgICAgICAgICAweDEwMzI1NDc2LAogICAgICBdOwogICAgICB0aGlzLmJ1ZmZlciA9IG5ldyBEYXRhVmlldyhuZXcgQXJyYXlCdWZmZXIoQkxPQ0tfU0laRSkpOwogICAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICAgIHRoaXMuYnl0ZXNIYXNoZWQgPSAwOwogICAgICB0aGlzLmZpbmlzaGVkID0gZmFsc2U7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IE1kNTsKICAKICBNZDUuQkxPQ0tfU0laRSA9IEJMT0NLX1NJWkU7CiAgCiAgTWQ1LnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoc291cmNlRGF0YSkgewogICAgICBpZiAoaGFzaFV0aWxzLmlzRW1wdHlEYXRhKHNvdXJjZURhdGEpKSB7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSBlbHNlIGlmICh0aGlzLmZpbmlzaGVkKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F0dGVtcHRlZCB0byB1cGRhdGUgYW4gYWxyZWFkeSBmaW5pc2hlZCBoYXNoLicpOwogICAgICB9CiAgCiAgICAgIHZhciBkYXRhID0gaGFzaFV0aWxzLmNvbnZlcnRUb0J1ZmZlcihzb3VyY2VEYXRhKTsKICAgICAgdmFyIHBvc2l0aW9uID0gMDsKICAgICAgdmFyIGJ5dGVMZW5ndGggPSBkYXRhLmJ5dGVMZW5ndGg7CiAgICAgIHRoaXMuYnl0ZXNIYXNoZWQgKz0gYnl0ZUxlbmd0aDsKICAgICAgd2hpbGUgKGJ5dGVMZW5ndGggPiAwKSB7CiAgICAgICAgICB0aGlzLmJ1ZmZlci5zZXRVaW50OCh0aGlzLmJ1ZmZlckxlbmd0aCsrLCBkYXRhW3Bvc2l0aW9uKytdKTsKICAgICAgICAgIGJ5dGVMZW5ndGgtLTsKICAgICAgICAgIGlmICh0aGlzLmJ1ZmZlckxlbmd0aCA9PT0gQkxPQ0tfU0laRSkgewogICAgICAgICAgICAgIHRoaXMuaGFzaEJ1ZmZlcigpOwogICAgICAgICAgICAgIHRoaXMuYnVmZmVyTGVuZ3RoID0gMDsKICAgICAgICAgIH0KICAgICAgfQogIAogICAgICByZXR1cm4gdGhpczsKICB9OwogIAogIE1kNS5wcm90b3R5cGUuZGlnZXN0ID0gZnVuY3Rpb24gKGVuY29kaW5nKSB7CiAgICAgIGlmICghdGhpcy5maW5pc2hlZCkgewogICAgICAgICAgdmFyIF9hID0gdGhpcywgYnVmZmVyID0gX2EuYnVmZmVyLCB1bmRlY29yYXRlZExlbmd0aCA9IF9hLmJ1ZmZlckxlbmd0aCwgYnl0ZXNIYXNoZWQgPSBfYS5ieXRlc0hhc2hlZDsKICAgICAgICAgIHZhciBiaXRzSGFzaGVkID0gYnl0ZXNIYXNoZWQgKiA4OwogICAgICAgICAgYnVmZmVyLnNldFVpbnQ4KHRoaXMuYnVmZmVyTGVuZ3RoKyssIDEyOCk7CiAgICAgICAgICAvLyBFbnN1cmUgdGhlIGZpbmFsIGJsb2NrIGhhcyBlbm91Z2ggcm9vbSBmb3IgdGhlIGhhc2hlZCBsZW5ndGgKICAgICAgICAgIGlmICh1bmRlY29yYXRlZExlbmd0aCAlIEJMT0NLX1NJWkUgPj0gQkxPQ0tfU0laRSAtIDgpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5idWZmZXJMZW5ndGg7IGkgPCBCTE9DS19TSVpFOyBpKyspIHsKICAgICAgICAgICAgICAgICAgYnVmZmVyLnNldFVpbnQ4KGksIDApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgICAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5idWZmZXJMZW5ndGg7IGkgPCBCTE9DS19TSVpFIC0gODsgaSsrKSB7CiAgICAgICAgICAgICAgYnVmZmVyLnNldFVpbnQ4KGksIDApOwogICAgICAgICAgfQogICAgICAgICAgYnVmZmVyLnNldFVpbnQzMihCTE9DS19TSVpFIC0gOCwgYml0c0hhc2hlZCA+Pj4gMCwgdHJ1ZSk7CiAgICAgICAgICBidWZmZXIuc2V0VWludDMyKEJMT0NLX1NJWkUgLSA0LCBNYXRoLmZsb29yKGJpdHNIYXNoZWQgLyAweDEwMDAwMDAwMCksIHRydWUpOwogICAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgICB0aGlzLmZpbmlzaGVkID0gdHJ1ZTsKICAgICAgfQogICAgICB2YXIgb3V0ID0gbmV3IERhdGFWaWV3KG5ldyBBcnJheUJ1ZmZlcihESUdFU1RfTEVOR1RIKSk7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgNDsgaSsrKSB7CiAgICAgICAgICBvdXQuc2V0VWludDMyKGkgKiA0LCB0aGlzLnN0YXRlW2ldLCB0cnVlKTsKICAgICAgfQogICAgICB2YXIgYnVmZiA9IG5ldyBCdWZmZXIob3V0LmJ1ZmZlciwgb3V0LmJ5dGVPZmZzZXQsIG91dC5ieXRlTGVuZ3RoKTsKICAgICAgcmV0dXJuIGVuY29kaW5nID8gYnVmZi50b1N0cmluZyhlbmNvZGluZykgOiBidWZmOwogIH07CiAgCiAgTWQ1LnByb3RvdHlwZS5oYXNoQnVmZmVyID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2EgPSB0aGlzLCBidWZmZXIgPSBfYS5idWZmZXIsIHN0YXRlID0gX2Euc3RhdGU7CiAgICAgIHZhciBhID0gc3RhdGVbMF0sIGIgPSBzdGF0ZVsxXSwgYyA9IHN0YXRlWzJdLCBkID0gc3RhdGVbM107CiAgICAgIGEgPSBmZihhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDAsIHRydWUpLCA3LCAweGQ3NmFhNDc4KTsKICAgICAgZCA9IGZmKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNCwgdHJ1ZSksIDEyLCAweGU4YzdiNzU2KTsKICAgICAgYyA9IGZmKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoOCwgdHJ1ZSksIDE3LCAweDI0MjA3MGRiKTsKICAgICAgYiA9IGZmKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMTIsIHRydWUpLCAyMiwgMHhjMWJkY2VlZSk7CiAgICAgIGEgPSBmZihhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDE2LCB0cnVlKSwgNywgMHhmNTdjMGZhZik7CiAgICAgIGQgPSBmZihkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDIwLCB0cnVlKSwgMTIsIDB4NDc4N2M2MmEpOwogICAgICBjID0gZmYoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMigyNCwgdHJ1ZSksIDE3LCAweGE4MzA0NjEzKTsKICAgICAgYiA9IGZmKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMjgsIHRydWUpLCAyMiwgMHhmZDQ2OTUwMSk7CiAgICAgIGEgPSBmZihhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDMyLCB0cnVlKSwgNywgMHg2OTgwOThkOCk7CiAgICAgIGQgPSBmZihkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDM2LCB0cnVlKSwgMTIsIDB4OGI0NGY3YWYpOwogICAgICBjID0gZmYoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig0MCwgdHJ1ZSksIDE3LCAweGZmZmY1YmIxKTsKICAgICAgYiA9IGZmKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNDQsIHRydWUpLCAyMiwgMHg4OTVjZDdiZSk7CiAgICAgIGEgPSBmZihhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDQ4LCB0cnVlKSwgNywgMHg2YjkwMTEyMik7CiAgICAgIGQgPSBmZihkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDUyLCB0cnVlKSwgMTIsIDB4ZmQ5ODcxOTMpOwogICAgICBjID0gZmYoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig1NiwgdHJ1ZSksIDE3LCAweGE2Nzk0MzhlKTsKICAgICAgYiA9IGZmKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNjAsIHRydWUpLCAyMiwgMHg0OWI0MDgyMSk7CiAgICAgIGEgPSBnZyhhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDQsIHRydWUpLCA1LCAweGY2MWUyNTYyKTsKICAgICAgZCA9IGdnKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMjQsIHRydWUpLCA5LCAweGMwNDBiMzQwKTsKICAgICAgYyA9IGdnKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNDQsIHRydWUpLCAxNCwgMHgyNjVlNWE1MSk7CiAgICAgIGIgPSBnZyhiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDAsIHRydWUpLCAyMCwgMHhlOWI2YzdhYSk7CiAgICAgIGEgPSBnZyhhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDIwLCB0cnVlKSwgNSwgMHhkNjJmMTA1ZCk7CiAgICAgIGQgPSBnZyhkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDQwLCB0cnVlKSwgOSwgMHgwMjQ0MTQ1Myk7CiAgICAgIGMgPSBnZyhjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDYwLCB0cnVlKSwgMTQsIDB4ZDhhMWU2ODEpOwogICAgICBiID0gZ2coYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigxNiwgdHJ1ZSksIDIwLCAweGU3ZDNmYmM4KTsKICAgICAgYSA9IGdnKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMzYsIHRydWUpLCA1LCAweDIxZTFjZGU2KTsKICAgICAgZCA9IGdnKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNTYsIHRydWUpLCA5LCAweGMzMzcwN2Q2KTsKICAgICAgYyA9IGdnKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMTIsIHRydWUpLCAxNCwgMHhmNGQ1MGQ4Nyk7CiAgICAgIGIgPSBnZyhiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDMyLCB0cnVlKSwgMjAsIDB4NDU1YTE0ZWQpOwogICAgICBhID0gZ2coYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMig1MiwgdHJ1ZSksIDUsIDB4YTllM2U5MDUpOwogICAgICBkID0gZ2coZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig4LCB0cnVlKSwgOSwgMHhmY2VmYTNmOCk7CiAgICAgIGMgPSBnZyhjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDI4LCB0cnVlKSwgMTQsIDB4Njc2ZjAyZDkpOwogICAgICBiID0gZ2coYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig0OCwgdHJ1ZSksIDIwLCAweDhkMmE0YzhhKTsKICAgICAgYSA9IGhoKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMjAsIHRydWUpLCA0LCAweGZmZmEzOTQyKTsKICAgICAgZCA9IGhoKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMzIsIHRydWUpLCAxMSwgMHg4NzcxZjY4MSk7CiAgICAgIGMgPSBoaChjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDQ0LCB0cnVlKSwgMTYsIDB4NmQ5ZDYxMjIpOwogICAgICBiID0gaGgoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig1NiwgdHJ1ZSksIDIzLCAweGZkZTUzODBjKTsKICAgICAgYSA9IGhoKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNCwgdHJ1ZSksIDQsIDB4YTRiZWVhNDQpOwogICAgICBkID0gaGgoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigxNiwgdHJ1ZSksIDExLCAweDRiZGVjZmE5KTsKICAgICAgYyA9IGhoKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMjgsIHRydWUpLCAxNiwgMHhmNmJiNGI2MCk7CiAgICAgIGIgPSBoaChiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDQwLCB0cnVlKSwgMjMsIDB4YmViZmJjNzApOwogICAgICBhID0gaGgoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMig1MiwgdHJ1ZSksIDQsIDB4Mjg5YjdlYzYpOwogICAgICBkID0gaGgoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigwLCB0cnVlKSwgMTEsIDB4ZWFhMTI3ZmEpOwogICAgICBjID0gaGgoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMigxMiwgdHJ1ZSksIDE2LCAweGQ0ZWYzMDg1KTsKICAgICAgYiA9IGhoKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMjQsIHRydWUpLCAyMywgMHgwNDg4MWQwNSk7CiAgICAgIGEgPSBoaChhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDM2LCB0cnVlKSwgNCwgMHhkOWQ0ZDAzOSk7CiAgICAgIGQgPSBoaChkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDQ4LCB0cnVlKSwgMTEsIDB4ZTZkYjk5ZTUpOwogICAgICBjID0gaGgoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig2MCwgdHJ1ZSksIDE2LCAweDFmYTI3Y2Y4KTsKICAgICAgYiA9IGhoKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoOCwgdHJ1ZSksIDIzLCAweGM0YWM1NjY1KTsKICAgICAgYSA9IGlpKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMCwgdHJ1ZSksIDYsIDB4ZjQyOTIyNDQpOwogICAgICBkID0gaWkoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigyOCwgdHJ1ZSksIDEwLCAweDQzMmFmZjk3KTsKICAgICAgYyA9IGlpKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNTYsIHRydWUpLCAxNSwgMHhhYjk0MjNhNyk7CiAgICAgIGIgPSBpaShiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDIwLCB0cnVlKSwgMjEsIDB4ZmM5M2EwMzkpOwogICAgICBhID0gaWkoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMig0OCwgdHJ1ZSksIDYsIDB4NjU1YjU5YzMpOwogICAgICBkID0gaWkoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigxMiwgdHJ1ZSksIDEwLCAweDhmMGNjYzkyKTsKICAgICAgYyA9IGlpKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNDAsIHRydWUpLCAxNSwgMHhmZmVmZjQ3ZCk7CiAgICAgIGIgPSBpaShiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDQsIHRydWUpLCAyMSwgMHg4NTg0NWRkMSk7CiAgICAgIGEgPSBpaShhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDMyLCB0cnVlKSwgNiwgMHg2ZmE4N2U0Zik7CiAgICAgIGQgPSBpaShkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDYwLCB0cnVlKSwgMTAsIDB4ZmUyY2U2ZTApOwogICAgICBjID0gaWkoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMigyNCwgdHJ1ZSksIDE1LCAweGEzMDE0MzE0KTsKICAgICAgYiA9IGlpKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNTIsIHRydWUpLCAyMSwgMHg0ZTA4MTFhMSk7CiAgICAgIGEgPSBpaShhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDE2LCB0cnVlKSwgNiwgMHhmNzUzN2U4Mik7CiAgICAgIGQgPSBpaShkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDQ0LCB0cnVlKSwgMTAsIDB4YmQzYWYyMzUpOwogICAgICBjID0gaWkoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig4LCB0cnVlKSwgMTUsIDB4MmFkN2QyYmIpOwogICAgICBiID0gaWkoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigzNiwgdHJ1ZSksIDIxLCAweGViODZkMzkxKTsKICAgICAgc3RhdGVbMF0gPSAoYSArIHN0YXRlWzBdKSAmIDB4RkZGRkZGRkY7CiAgICAgIHN0YXRlWzFdID0gKGIgKyBzdGF0ZVsxXSkgJiAweEZGRkZGRkZGOwogICAgICBzdGF0ZVsyXSA9IChjICsgc3RhdGVbMl0pICYgMHhGRkZGRkZGRjsKICAgICAgc3RhdGVbM10gPSAoZCArIHN0YXRlWzNdKSAmIDB4RkZGRkZGRkY7CiAgfTsKICAKICBmdW5jdGlvbiBjbW4ocSwgYSwgYiwgeCwgcywgdCkgewogICAgICBhID0gKCgoYSArIHEpICYgMHhGRkZGRkZGRikgKyAoKHggKyB0KSAmIDB4RkZGRkZGRkYpKSAmIDB4RkZGRkZGRkY7CiAgICAgIHJldHVybiAoKChhIDw8IHMpIHwgKGEgPj4+ICgzMiAtIHMpKSkgKyBiKSAmIDB4RkZGRkZGRkY7CiAgfQogIAogIGZ1bmN0aW9uIGZmKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgICAgcmV0dXJuIGNtbigoYiAmIGMpIHwgKCh+YikgJiBkKSwgYSwgYiwgeCwgcywgdCk7CiAgfQogIAogIGZ1bmN0aW9uIGdnKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgICAgcmV0dXJuIGNtbigoYiAmIGQpIHwgKGMgJiAofmQpKSwgYSwgYiwgeCwgcywgdCk7CiAgfQogIAogIGZ1bmN0aW9uIGhoKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgICAgcmV0dXJuIGNtbihiIF4gYyBeIGQsIGEsIGIsIHgsIHMsIHQpOwogIH0KICAKICBmdW5jdGlvbiBpaShhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICAgIHJldHVybiBjbW4oYyBeIChiIHwgKH5kKSksIGEsIGIsIHgsIHMsIHQpOwogIH0KICAKICB9LHsiLi9icm93c2VySGFzaFV0aWxzIjoxMSwiYnVmZmVyLyI6ODF9XSwxNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEJ1ZmZlciA9IHJlcXVpcmUoJ2J1ZmZlci8nKS5CdWZmZXI7CiAgdmFyIGhhc2hVdGlscyA9IHJlcXVpcmUoJy4vYnJvd3Nlckhhc2hVdGlscycpOwogIAogIHZhciBCTE9DS19TSVpFID0gNjQ7CiAgCiAgdmFyIERJR0VTVF9MRU5HVEggPSAyMDsKICAKICB2YXIgS0VZID0gbmV3IFVpbnQzMkFycmF5KFsKICAgICAgMHg1YTgyNzk5OSwKICAgICAgMHg2ZWQ5ZWJhMSwKICAgICAgMHg4ZjFiYmNkYyB8IDAsCiAgICAgIDB4Y2E2MmMxZDYgfCAwCiAgXSk7CiAgCiAgdmFyIElOSVQgPSBbCiAgICAgIDB4NmEwOWU2NjcsCiAgICAgIDB4YmI2N2FlODUsCiAgICAgIDB4M2M2ZWYzNzIsCiAgICAgIDB4YTU0ZmY1M2EsCiAgICAgIDB4NTEwZTUyN2YsCiAgICAgIDB4OWIwNTY4OGMsCiAgICAgIDB4MWY4M2Q5YWIsCiAgICAgIDB4NWJlMGNkMTksCiAgXTsKICAKICB2YXIgTUFYX0hBU0hBQkxFX0xFTkdUSCA9IE1hdGgucG93KDIsIDUzKSAtIDE7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gU2hhMSgpIHsKICAgICAgdGhpcy5oMCA9IDB4Njc0NTIzMDE7CiAgICAgIHRoaXMuaDEgPSAweEVGQ0RBQjg5OwogICAgICB0aGlzLmgyID0gMHg5OEJBRENGRTsKICAgICAgdGhpcy5oMyA9IDB4MTAzMjU0NzY7CiAgICAgIHRoaXMuaDQgPSAweEMzRDJFMUYwOwogICAgICAvLyBUaGUgZmlyc3QgNjQgYnl0ZXMgKDE2IHdvcmRzKSBpcyB0aGUgZGF0YSBjaHVuawogICAgICB0aGlzLmJsb2NrID0gbmV3IFVpbnQzMkFycmF5KDgwKTsKICAgICAgdGhpcy5vZmZzZXQgPSAwOwogICAgICB0aGlzLnNoaWZ0ID0gMjQ7CiAgICAgIHRoaXMudG90YWxMZW5ndGggPSAwOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBTaGExOwogIAogIFNoYTEuQkxPQ0tfU0laRSA9IEJMT0NLX1NJWkU7CiAgCiAgU2hhMS5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgaWYgKHRoaXMuZmluaXNoZWQpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQXR0ZW1wdGVkIHRvIHVwZGF0ZSBhbiBhbHJlYWR5IGZpbmlzaGVkIGhhc2guJyk7CiAgICAgIH0KICAKICAgICAgaWYgKGhhc2hVdGlscy5pc0VtcHR5RGF0YShkYXRhKSkgewogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAKICAgICAgZGF0YSA9IGhhc2hVdGlscy5jb252ZXJ0VG9CdWZmZXIoZGF0YSk7CiAgCiAgICAgIHZhciBsZW5ndGggPSBkYXRhLmxlbmd0aDsKICAgICAgdGhpcy50b3RhbExlbmd0aCArPSBsZW5ndGggKiA4OwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB0aGlzLndyaXRlKGRhdGFbaV0pOwogICAgICB9CiAgCiAgICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgU2hhMS5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbiB3cml0ZShieXRlKSB7CiAgICAgIHRoaXMuYmxvY2tbdGhpcy5vZmZzZXRdIHw9IChieXRlICYgMHhmZikgPDwgdGhpcy5zaGlmdDsKICAgICAgaWYgKHRoaXMuc2hpZnQpIHsKICAgICAgICAgIHRoaXMuc2hpZnQgLT0gODsKICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMub2Zmc2V0Kys7CiAgICAgICAgICB0aGlzLnNoaWZ0ID0gMjQ7CiAgICAgIH0KICAKICAgICAgaWYgKHRoaXMub2Zmc2V0ID09PSAxNikgdGhpcy5wcm9jZXNzQmxvY2soKTsKICB9OwogIAogIFNoYTEucHJvdG90eXBlLmRpZ2VzdCA9IGZ1bmN0aW9uIChlbmNvZGluZykgewogICAgICAvLyBQYWQKICAgICAgdGhpcy53cml0ZSgweDgwKTsKICAgICAgaWYgKHRoaXMub2Zmc2V0ID4gMTQgfHwgKHRoaXMub2Zmc2V0ID09PSAxNCAmJiB0aGlzLnNoaWZ0IDwgMjQpKSB7CiAgICAgICAgdGhpcy5wcm9jZXNzQmxvY2soKTsKICAgICAgfQogICAgICB0aGlzLm9mZnNldCA9IDE0OwogICAgICB0aGlzLnNoaWZ0ID0gMjQ7CiAgCiAgICAgIC8vIDY0LWJpdCBsZW5ndGggYmlnLWVuZGlhbgogICAgICB0aGlzLndyaXRlKDB4MDApOyAvLyBudW1iZXJzIHRoaXMgYmlnIGFyZW4ndCBhY2N1cmF0ZSBpbiBqYXZhc2NyaXB0IGFueXdheQogICAgICB0aGlzLndyaXRlKDB4MDApOyAvLyAuLlNvIGp1c3QgaGFyZC1jb2RlIHRvIHplcm8uCiAgICAgIHRoaXMud3JpdGUodGhpcy50b3RhbExlbmd0aCA+IDB4ZmZmZmZmZmZmZiA/IHRoaXMudG90YWxMZW5ndGggLyAweDEwMDAwMDAwMDAwIDogMHgwMCk7CiAgICAgIHRoaXMud3JpdGUodGhpcy50b3RhbExlbmd0aCA+IDB4ZmZmZmZmZmYgPyB0aGlzLnRvdGFsTGVuZ3RoIC8gMHgxMDAwMDAwMDAgOiAweDAwKTsKICAgICAgZm9yICh2YXIgcyA9IDI0OyBzID49IDA7IHMgLT0gOCkgewogICAgICAgICAgdGhpcy53cml0ZSh0aGlzLnRvdGFsTGVuZ3RoID4+IHMpOwogICAgICB9CiAgICAgIC8vIFRoZSB2YWx1ZSBpbiBzdGF0ZSBpcyBsaXR0bGUtZW5kaWFuIHJhdGhlciB0aGFuIGJpZy1lbmRpYW4sIHNvIGZsaXAKICAgICAgLy8gZWFjaCB3b3JkIGludG8gYSBuZXcgVWludDhBcnJheQogICAgICB2YXIgb3V0ID0gbmV3IEJ1ZmZlcihESUdFU1RfTEVOR1RIKTsKICAgICAgdmFyIG91dFZpZXcgPSBuZXcgRGF0YVZpZXcob3V0LmJ1ZmZlcik7CiAgICAgIG91dFZpZXcuc2V0VWludDMyKDAsIHRoaXMuaDAsIGZhbHNlKTsKICAgICAgb3V0Vmlldy5zZXRVaW50MzIoNCwgdGhpcy5oMSwgZmFsc2UpOwogICAgICBvdXRWaWV3LnNldFVpbnQzMig4LCB0aGlzLmgyLCBmYWxzZSk7CiAgICAgIG91dFZpZXcuc2V0VWludDMyKDEyLCB0aGlzLmgzLCBmYWxzZSk7CiAgICAgIG91dFZpZXcuc2V0VWludDMyKDE2LCB0aGlzLmg0LCBmYWxzZSk7CiAgCiAgICAgIHJldHVybiBlbmNvZGluZyA/IG91dC50b1N0cmluZyhlbmNvZGluZykgOiBvdXQ7CiAgfTsKICAKICBTaGExLnByb3RvdHlwZS5wcm9jZXNzQmxvY2sgPSBmdW5jdGlvbiBwcm9jZXNzQmxvY2soKSB7CiAgICAgIC8vIEV4dGVuZCB0aGUgc2l4dGVlbiAzMi1iaXQgd29yZHMgaW50byBlaWdodHkgMzItYml0IHdvcmRzOgogICAgICBmb3IgKHZhciBpID0gMTY7IGkgPCA4MDsgaSsrKSB7CiAgICAgICAgdmFyIHcgPSB0aGlzLmJsb2NrW2kgLSAzXSBeIHRoaXMuYmxvY2tbaSAtIDhdIF4gdGhpcy5ibG9ja1tpIC0gMTRdIF4gdGhpcy5ibG9ja1tpIC0gMTZdOwogICAgICAgIHRoaXMuYmxvY2tbaV0gPSAodyA8PCAxKSB8ICh3ID4+PiAzMSk7CiAgICAgIH0KICAKICAgICAgLy8gSW5pdGlhbGl6ZSBoYXNoIHZhbHVlIGZvciB0aGlzIGNodW5rOgogICAgICB2YXIgYSA9IHRoaXMuaDA7CiAgICAgIHZhciBiID0gdGhpcy5oMTsKICAgICAgdmFyIGMgPSB0aGlzLmgyOwogICAgICB2YXIgZCA9IHRoaXMuaDM7CiAgICAgIHZhciBlID0gdGhpcy5oNDsKICAgICAgdmFyIGYsIGs7CiAgCiAgICAgIC8vIE1haW4gbG9vcDoKICAgICAgZm9yIChpID0gMDsgaSA8IDgwOyBpKyspIHsKICAgICAgICBpZiAoaSA8IDIwKSB7CiAgICAgICAgICBmID0gZCBeIChiICYgKGMgXiBkKSk7CiAgICAgICAgICBrID0gMHg1QTgyNzk5OTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoaSA8IDQwKSB7CiAgICAgICAgICBmID0gYiBeIGMgXiBkOwogICAgICAgICAgayA9IDB4NkVEOUVCQTE7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGkgPCA2MCkgewogICAgICAgICAgZiA9IChiICYgYykgfCAoZCAmIChiIHwgYykpOwogICAgICAgICAgayA9IDB4OEYxQkJDREM7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgZiA9IGIgXiBjIF4gZDsKICAgICAgICAgIGsgPSAweENBNjJDMUQ2OwogICAgICAgIH0KICAgICAgICB2YXIgdGVtcCA9IChhIDw8IDUgfCBhID4+PiAyNykgKyBmICsgZSArIGsgKyAodGhpcy5ibG9ja1tpXXwwKTsKICAgICAgICBlID0gZDsKICAgICAgICBkID0gYzsKICAgICAgICBjID0gKGIgPDwgMzAgfCBiID4+PiAyKTsKICAgICAgICBiID0gYTsKICAgICAgICBhID0gdGVtcDsKICAgICAgfQogIAogICAgICAvLyBBZGQgdGhpcyBjaHVuaydzIGhhc2ggdG8gcmVzdWx0IHNvIGZhcjoKICAgICAgdGhpcy5oMCA9ICh0aGlzLmgwICsgYSkgfCAwOwogICAgICB0aGlzLmgxID0gKHRoaXMuaDEgKyBiKSB8IDA7CiAgICAgIHRoaXMuaDIgPSAodGhpcy5oMiArIGMpIHwgMDsKICAgICAgdGhpcy5oMyA9ICh0aGlzLmgzICsgZCkgfCAwOwogICAgICB0aGlzLmg0ID0gKHRoaXMuaDQgKyBlKSB8IDA7CiAgCiAgICAgIC8vIFRoZSBibG9jayBpcyBub3cgcmV1c2FibGUuCiAgICAgIHRoaXMub2Zmc2V0ID0gMDsKICAgICAgZm9yIChpID0gMDsgaSA8IDE2OyBpKyspIHsKICAgICAgICAgIHRoaXMuYmxvY2tbaV0gPSAwOwogICAgICB9CiAgfTsKICAKICB9LHsiLi9icm93c2VySGFzaFV0aWxzIjoxMSwiYnVmZmVyLyI6ODF9XSwxNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEJ1ZmZlciA9IHJlcXVpcmUoJ2J1ZmZlci8nKS5CdWZmZXI7CiAgdmFyIGhhc2hVdGlscyA9IHJlcXVpcmUoJy4vYnJvd3Nlckhhc2hVdGlscycpOwogIAogIHZhciBCTE9DS19TSVpFID0gNjQ7CiAgCiAgdmFyIERJR0VTVF9MRU5HVEggPSAzMjsKICAKICB2YXIgS0VZID0gbmV3IFVpbnQzMkFycmF5KFsKICAgICAgMHg0MjhhMmY5OCwKICAgICAgMHg3MTM3NDQ5MSwKICAgICAgMHhiNWMwZmJjZiwKICAgICAgMHhlOWI1ZGJhNSwKICAgICAgMHgzOTU2YzI1YiwKICAgICAgMHg1OWYxMTFmMSwKICAgICAgMHg5MjNmODJhNCwKICAgICAgMHhhYjFjNWVkNSwKICAgICAgMHhkODA3YWE5OCwKICAgICAgMHgxMjgzNWIwMSwKICAgICAgMHgyNDMxODViZSwKICAgICAgMHg1NTBjN2RjMywKICAgICAgMHg3MmJlNWQ3NCwKICAgICAgMHg4MGRlYjFmZSwKICAgICAgMHg5YmRjMDZhNywKICAgICAgMHhjMTliZjE3NCwKICAgICAgMHhlNDliNjljMSwKICAgICAgMHhlZmJlNDc4NiwKICAgICAgMHgwZmMxOWRjNiwKICAgICAgMHgyNDBjYTFjYywKICAgICAgMHgyZGU5MmM2ZiwKICAgICAgMHg0YTc0ODRhYSwKICAgICAgMHg1Y2IwYTlkYywKICAgICAgMHg3NmY5ODhkYSwKICAgICAgMHg5ODNlNTE1MiwKICAgICAgMHhhODMxYzY2ZCwKICAgICAgMHhiMDAzMjdjOCwKICAgICAgMHhiZjU5N2ZjNywKICAgICAgMHhjNmUwMGJmMywKICAgICAgMHhkNWE3OTE0NywKICAgICAgMHgwNmNhNjM1MSwKICAgICAgMHgxNDI5Mjk2NywKICAgICAgMHgyN2I3MGE4NSwKICAgICAgMHgyZTFiMjEzOCwKICAgICAgMHg0ZDJjNmRmYywKICAgICAgMHg1MzM4MGQxMywKICAgICAgMHg2NTBhNzM1NCwKICAgICAgMHg3NjZhMGFiYiwKICAgICAgMHg4MWMyYzkyZSwKICAgICAgMHg5MjcyMmM4NSwKICAgICAgMHhhMmJmZThhMSwKICAgICAgMHhhODFhNjY0YiwKICAgICAgMHhjMjRiOGI3MCwKICAgICAgMHhjNzZjNTFhMywKICAgICAgMHhkMTkyZTgxOSwKICAgICAgMHhkNjk5MDYyNCwKICAgICAgMHhmNDBlMzU4NSwKICAgICAgMHgxMDZhYTA3MCwKICAgICAgMHgxOWE0YzExNiwKICAgICAgMHgxZTM3NmMwOCwKICAgICAgMHgyNzQ4Nzc0YywKICAgICAgMHgzNGIwYmNiNSwKICAgICAgMHgzOTFjMGNiMywKICAgICAgMHg0ZWQ4YWE0YSwKICAgICAgMHg1YjljY2E0ZiwKICAgICAgMHg2ODJlNmZmMywKICAgICAgMHg3NDhmODJlZSwKICAgICAgMHg3OGE1NjM2ZiwKICAgICAgMHg4NGM4NzgxNCwKICAgICAgMHg4Y2M3MDIwOCwKICAgICAgMHg5MGJlZmZmYSwKICAgICAgMHhhNDUwNmNlYiwKICAgICAgMHhiZWY5YTNmNywKICAgICAgMHhjNjcxNzhmMgogIF0pOwogIAogIHZhciBJTklUID0gWwogICAgICAweDZhMDllNjY3LAogICAgICAweGJiNjdhZTg1LAogICAgICAweDNjNmVmMzcyLAogICAgICAweGE1NGZmNTNhLAogICAgICAweDUxMGU1MjdmLAogICAgICAweDliMDU2ODhjLAogICAgICAweDFmODNkOWFiLAogICAgICAweDViZTBjZDE5LAogIF07CiAgCiAgdmFyIE1BWF9IQVNIQUJMRV9MRU5HVEggPSBNYXRoLnBvdygyLCA1MykgLSAxOwogIAogIC8qKgogICAqIEBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gU2hhMjU2KCkgewogICAgICB0aGlzLnN0YXRlID0gWwogICAgICAgICAgMHg2YTA5ZTY2NywKICAgICAgICAgIDB4YmI2N2FlODUsCiAgICAgICAgICAweDNjNmVmMzcyLAogICAgICAgICAgMHhhNTRmZjUzYSwKICAgICAgICAgIDB4NTEwZTUyN2YsCiAgICAgICAgICAweDliMDU2ODhjLAogICAgICAgICAgMHgxZjgzZDlhYiwKICAgICAgICAgIDB4NWJlMGNkMTksCiAgICAgIF07CiAgICAgIHRoaXMudGVtcCA9IG5ldyBJbnQzMkFycmF5KDY0KTsKICAgICAgdGhpcy5idWZmZXIgPSBuZXcgVWludDhBcnJheSg2NCk7CiAgICAgIHRoaXMuYnVmZmVyTGVuZ3RoID0gMDsKICAgICAgdGhpcy5ieXRlc0hhc2hlZCA9IDA7CiAgICAgIC8qKgogICAgICAgKiBAcHJpdmF0ZQogICAgICAgKi8KICAgICAgdGhpcy5maW5pc2hlZCA9IGZhbHNlOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBTaGEyNTY7CiAgCiAgU2hhMjU2LkJMT0NLX1NJWkUgPSBCTE9DS19TSVpFOwogIAogIFNoYTI1Ni5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgaWYgKHRoaXMuZmluaXNoZWQpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQXR0ZW1wdGVkIHRvIHVwZGF0ZSBhbiBhbHJlYWR5IGZpbmlzaGVkIGhhc2guJyk7CiAgICAgIH0KICAKICAgICAgaWYgKGhhc2hVdGlscy5pc0VtcHR5RGF0YShkYXRhKSkgewogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAKICAgICAgZGF0YSA9IGhhc2hVdGlscy5jb252ZXJ0VG9CdWZmZXIoZGF0YSk7CiAgCiAgICAgIHZhciBwb3NpdGlvbiA9IDA7CiAgICAgIHZhciBieXRlTGVuZ3RoID0gZGF0YS5ieXRlTGVuZ3RoOwogICAgICB0aGlzLmJ5dGVzSGFzaGVkICs9IGJ5dGVMZW5ndGg7CiAgICAgIGlmICh0aGlzLmJ5dGVzSGFzaGVkICogOCA+IE1BWF9IQVNIQUJMRV9MRU5HVEgpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGhhc2ggbW9yZSB0aGFuIDJeNTMgLSAxIGJpdHMnKTsKICAgICAgfQogIAogICAgICB3aGlsZSAoYnl0ZUxlbmd0aCA+IDApIHsKICAgICAgICAgIHRoaXMuYnVmZmVyW3RoaXMuYnVmZmVyTGVuZ3RoKytdID0gZGF0YVtwb3NpdGlvbisrXTsKICAgICAgICAgIGJ5dGVMZW5ndGgtLTsKICAgICAgICAgIGlmICh0aGlzLmJ1ZmZlckxlbmd0aCA9PT0gQkxPQ0tfU0laRSkgewogICAgICAgICAgICAgIHRoaXMuaGFzaEJ1ZmZlcigpOwogICAgICAgICAgICAgIHRoaXMuYnVmZmVyTGVuZ3RoID0gMDsKICAgICAgICAgIH0KICAgICAgfQogIAogICAgICByZXR1cm4gdGhpczsKICB9OwogIAogIFNoYTI1Ni5wcm90b3R5cGUuZGlnZXN0ID0gZnVuY3Rpb24gKGVuY29kaW5nKSB7CiAgICAgIGlmICghdGhpcy5maW5pc2hlZCkgewogICAgICAgICAgdmFyIGJpdHNIYXNoZWQgPSB0aGlzLmJ5dGVzSGFzaGVkICogODsKICAgICAgICAgIHZhciBidWZmZXJWaWV3ID0gbmV3IERhdGFWaWV3KHRoaXMuYnVmZmVyLmJ1ZmZlciwgdGhpcy5idWZmZXIuYnl0ZU9mZnNldCwgdGhpcy5idWZmZXIuYnl0ZUxlbmd0aCk7CiAgICAgICAgICB2YXIgdW5kZWNvcmF0ZWRMZW5ndGggPSB0aGlzLmJ1ZmZlckxlbmd0aDsKICAgICAgICAgIGJ1ZmZlclZpZXcuc2V0VWludDgodGhpcy5idWZmZXJMZW5ndGgrKywgMHg4MCk7CiAgICAgICAgICAvLyBFbnN1cmUgdGhlIGZpbmFsIGJsb2NrIGhhcyBlbm91Z2ggcm9vbSBmb3IgdGhlIGhhc2hlZCBsZW5ndGgKICAgICAgICAgIGlmICh1bmRlY29yYXRlZExlbmd0aCAlIEJMT0NLX1NJWkUgPj0gQkxPQ0tfU0laRSAtIDgpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5idWZmZXJMZW5ndGg7IGkgPCBCTE9DS19TSVpFOyBpKyspIHsKICAgICAgICAgICAgICAgICAgYnVmZmVyVmlldy5zZXRVaW50OChpLCAwKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICAgICAgfQogICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuYnVmZmVyTGVuZ3RoOyBpIDwgQkxPQ0tfU0laRSAtIDg7IGkrKykgewogICAgICAgICAgICAgIGJ1ZmZlclZpZXcuc2V0VWludDgoaSwgMCk7CiAgICAgICAgICB9CiAgICAgICAgICBidWZmZXJWaWV3LnNldFVpbnQzMihCTE9DS19TSVpFIC0gOCwgTWF0aC5mbG9vcihiaXRzSGFzaGVkIC8gMHgxMDAwMDAwMDApLCB0cnVlKTsKICAgICAgICAgIGJ1ZmZlclZpZXcuc2V0VWludDMyKEJMT0NLX1NJWkUgLSA0LCBiaXRzSGFzaGVkKTsKICAgICAgICAgIHRoaXMuaGFzaEJ1ZmZlcigpOwogICAgICAgICAgdGhpcy5maW5pc2hlZCA9IHRydWU7CiAgICAgIH0KICAgICAgLy8gVGhlIHZhbHVlIGluIHN0YXRlIGlzIGxpdHRsZS1lbmRpYW4gcmF0aGVyIHRoYW4gYmlnLWVuZGlhbiwgc28gZmxpcAogICAgICAvLyBlYWNoIHdvcmQgaW50byBhIG5ldyBVaW50OEFycmF5CiAgICAgIHZhciBvdXQgPSBuZXcgQnVmZmVyKERJR0VTVF9MRU5HVEgpOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDg7IGkrKykgewogICAgICAgICAgb3V0W2kgKiA0XSA9ICh0aGlzLnN0YXRlW2ldID4+PiAyNCkgJiAweGZmOwogICAgICAgICAgb3V0W2kgKiA0ICsgMV0gPSAodGhpcy5zdGF0ZVtpXSA+Pj4gMTYpICYgMHhmZjsKICAgICAgICAgIG91dFtpICogNCArIDJdID0gKHRoaXMuc3RhdGVbaV0gPj4+IDgpICYgMHhmZjsKICAgICAgICAgIG91dFtpICogNCArIDNdID0gKHRoaXMuc3RhdGVbaV0gPj4+IDApICYgMHhmZjsKICAgICAgfQogICAgICByZXR1cm4gZW5jb2RpbmcgPyBvdXQudG9TdHJpbmcoZW5jb2RpbmcpIDogb3V0OwogIH07CiAgCiAgU2hhMjU2LnByb3RvdHlwZS5oYXNoQnVmZmVyID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2EgPSB0aGlzLAogICAgICAgICAgYnVmZmVyID0gX2EuYnVmZmVyLAogICAgICAgICAgc3RhdGUgPSBfYS5zdGF0ZTsKICAgICAgdmFyIHN0YXRlMCA9IHN0YXRlWzBdLAogICAgICAgICAgc3RhdGUxID0gc3RhdGVbMV0sCiAgICAgICAgICBzdGF0ZTIgPSBzdGF0ZVsyXSwKICAgICAgICAgIHN0YXRlMyA9IHN0YXRlWzNdLAogICAgICAgICAgc3RhdGU0ID0gc3RhdGVbNF0sCiAgICAgICAgICBzdGF0ZTUgPSBzdGF0ZVs1XSwKICAgICAgICAgIHN0YXRlNiA9IHN0YXRlWzZdLAogICAgICAgICAgc3RhdGU3ID0gc3RhdGVbN107CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgQkxPQ0tfU0laRTsgaSsrKSB7CiAgICAgICAgICBpZiAoaSA8IDE2KSB7CiAgICAgICAgICAgICAgdGhpcy50ZW1wW2ldID0gKCgoYnVmZmVyW2kgKiA0XSAmIDB4ZmYpIDw8IDI0KSB8CiAgICAgICAgICAgICAgICAgICgoYnVmZmVyWyhpICogNCkgKyAxXSAmIDB4ZmYpIDw8IDE2KSB8CiAgICAgICAgICAgICAgICAgICgoYnVmZmVyWyhpICogNCkgKyAyXSAmIDB4ZmYpIDw8IDgpIHwKICAgICAgICAgICAgICAgICAgKGJ1ZmZlclsoaSAqIDQpICsgM10gJiAweGZmKSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICB2YXIgdSA9IHRoaXMudGVtcFtpIC0gMl07CiAgICAgICAgICAgICAgdmFyIHQxXzEgPSAodSA+Pj4gMTcgfCB1IDw8IDE1KSBeCiAgICAgICAgICAgICAgICAgICh1ID4+PiAxOSB8IHUgPDwgMTMpIF4KICAgICAgICAgICAgICAgICAgKHUgPj4+IDEwKTsKICAgICAgICAgICAgICB1ID0gdGhpcy50ZW1wW2kgLSAxNV07CiAgICAgICAgICAgICAgdmFyIHQyXzEgPSAodSA+Pj4gNyB8IHUgPDwgMjUpIF4KICAgICAgICAgICAgICAgICAgKHUgPj4+IDE4IHwgdSA8PCAxNCkgXgogICAgICAgICAgICAgICAgICAodSA+Pj4gMyk7CiAgICAgICAgICAgICAgdGhpcy50ZW1wW2ldID0gKHQxXzEgKyB0aGlzLnRlbXBbaSAtIDddIHwgMCkgKwogICAgICAgICAgICAgICAgICAodDJfMSArIHRoaXMudGVtcFtpIC0gMTZdIHwgMCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdDEgPSAoKCgoKHN0YXRlNCA+Pj4gNiB8IHN0YXRlNCA8PCAyNikgXgogICAgICAgICAgICAgIChzdGF0ZTQgPj4+IDExIHwgc3RhdGU0IDw8IDIxKSBeCiAgICAgICAgICAgICAgKHN0YXRlNCA+Pj4gMjUgfCBzdGF0ZTQgPDwgNykpCiAgICAgICAgICAgICAgKyAoKHN0YXRlNCAmIHN0YXRlNSkgXiAofnN0YXRlNCAmIHN0YXRlNikpKSB8IDApCiAgICAgICAgICAgICAgKyAoKHN0YXRlNyArICgoS0VZW2ldICsgdGhpcy50ZW1wW2ldKSB8IDApKSB8IDApKSB8IDA7CiAgICAgICAgICB2YXIgdDIgPSAoKChzdGF0ZTAgPj4+IDIgfCBzdGF0ZTAgPDwgMzApIF4KICAgICAgICAgICAgICAoc3RhdGUwID4+PiAxMyB8IHN0YXRlMCA8PCAxOSkgXgogICAgICAgICAgICAgIChzdGF0ZTAgPj4+IDIyIHwgc3RhdGUwIDw8IDEwKSkgKyAoKHN0YXRlMCAmIHN0YXRlMSkgXiAoc3RhdGUwICYgc3RhdGUyKSBeIChzdGF0ZTEgJiBzdGF0ZTIpKSkgfCAwOwogICAgICAgICAgc3RhdGU3ID0gc3RhdGU2OwogICAgICAgICAgc3RhdGU2ID0gc3RhdGU1OwogICAgICAgICAgc3RhdGU1ID0gc3RhdGU0OwogICAgICAgICAgc3RhdGU0ID0gKHN0YXRlMyArIHQxKSB8IDA7CiAgICAgICAgICBzdGF0ZTMgPSBzdGF0ZTI7CiAgICAgICAgICBzdGF0ZTIgPSBzdGF0ZTE7CiAgICAgICAgICBzdGF0ZTEgPSBzdGF0ZTA7CiAgICAgICAgICBzdGF0ZTAgPSAodDEgKyB0MikgfCAwOwogICAgICB9CiAgICAgIHN0YXRlWzBdICs9IHN0YXRlMDsKICAgICAgc3RhdGVbMV0gKz0gc3RhdGUxOwogICAgICBzdGF0ZVsyXSArPSBzdGF0ZTI7CiAgICAgIHN0YXRlWzNdICs9IHN0YXRlMzsKICAgICAgc3RhdGVbNF0gKz0gc3RhdGU0OwogICAgICBzdGF0ZVs1XSArPSBzdGF0ZTU7CiAgICAgIHN0YXRlWzZdICs9IHN0YXRlNjsKICAgICAgc3RhdGVbN10gKz0gc3RhdGU3OwogIH07CiAgCiAgfSx7Ii4vYnJvd3Nlckhhc2hVdGlscyI6MTEsImJ1ZmZlci8iOjgxfV0sMTY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAocHJvY2Vzcyl7KGZ1bmN0aW9uICgpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7CiAgCiAgLy8gYnJvd3NlciBzcGVjaWZpYyBtb2R1bGVzCiAgdXRpbC5jcnlwdG8ubGliID0gcmVxdWlyZSgnLi9icm93c2VyQ3J5cHRvTGliJyk7CiAgdXRpbC5CdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwogIHV0aWwudXJsID0gcmVxdWlyZSgndXJsLycpOwogIHV0aWwucXVlcnlzdHJpbmcgPSByZXF1aXJlKCdxdWVyeXN0cmluZy8nKTsKICB1dGlsLnJlYWxDbG9jayA9IHJlcXVpcmUoJy4vcmVhbGNsb2NrL2Jyb3dzZXJDbG9jaycpOwogIHV0aWwuZW52aXJvbm1lbnQgPSAnanMnOwogIHV0aWwuY3JlYXRlRXZlbnRTdHJlYW0gPSByZXF1aXJlKCcuL2V2ZW50LXN0cmVhbS9idWZmZXJlZC1jcmVhdGUtZXZlbnQtc3RyZWFtJykuY3JlYXRlRXZlbnRTdHJlYW07CiAgdXRpbC5pc0Jyb3dzZXIgPSBmdW5jdGlvbigpIHsgcmV0dXJuIHRydWU7IH07CiAgdXRpbC5pc05vZGUgPSBmdW5jdGlvbigpIHsgcmV0dXJuIGZhbHNlOyB9OwogIAogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUzsKICAKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscy9jcmVkZW50aWFsX3Byb3ZpZGVyX2NoYWluJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscy90ZW1wb3JhcnlfY3JlZGVudGlhbHMnKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzL2NoYWluYWJsZV90ZW1wb3JhcnlfY3JlZGVudGlhbHMnKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzL3dlYl9pZGVudGl0eV9jcmVkZW50aWFscycpOwogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMvY29nbml0b19pZGVudGl0eV9jcmVkZW50aWFscycpOwogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMvc2FtbF9jcmVkZW50aWFscycpOwogIAogIC8vIExvYWQgdGhlIERPTVBhcnNlciBYTUwgcGFyc2VyCiAgQVdTLlhNTC5QYXJzZXIgPSByZXF1aXJlKCcuL3htbC9icm93c2VyX3BhcnNlcicpOwogIAogIC8vIExvYWQgdGhlIFhIUiBIdHRwQ2xpZW50CiAgcmVxdWlyZSgnLi9odHRwL3hocicpOwogIAogIGlmICh0eXBlb2YgcHJvY2VzcyA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgIHZhciBwcm9jZXNzID0gewogICAgICBicm93c2VyOiB0cnVlCiAgICB9OwogIH0KICAKICB9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCiAgfSx7Ii4vYnJvd3NlckNyeXB0b0xpYiI6MTAsIi4vY29yZSI6MTgsIi4vY3JlZGVudGlhbHMiOjE5LCIuL2NyZWRlbnRpYWxzL2NoYWluYWJsZV90ZW1wb3JhcnlfY3JlZGVudGlhbHMiOjIwLCIuL2NyZWRlbnRpYWxzL2NvZ25pdG9faWRlbnRpdHlfY3JlZGVudGlhbHMiOjIxLCIuL2NyZWRlbnRpYWxzL2NyZWRlbnRpYWxfcHJvdmlkZXJfY2hhaW4iOjIyLCIuL2NyZWRlbnRpYWxzL3NhbWxfY3JlZGVudGlhbHMiOjIzLCIuL2NyZWRlbnRpYWxzL3RlbXBvcmFyeV9jcmVkZW50aWFscyI6MjQsIi4vY3JlZGVudGlhbHMvd2ViX2lkZW50aXR5X2NyZWRlbnRpYWxzIjoyNSwiLi9ldmVudC1zdHJlYW0vYnVmZmVyZWQtY3JlYXRlLWV2ZW50LXN0cmVhbSI6MjcsIi4vaHR0cC94aHIiOjM1LCIuL3JlYWxjbG9jay9icm93c2VyQ2xvY2siOjUyLCIuL3V0aWwiOjcxLCIuL3htbC9icm93c2VyX3BhcnNlciI6NzIsIl9wcm9jZXNzIjo4NiwiYnVmZmVyLyI6ODEsInF1ZXJ5c3RyaW5nLyI6OTIsInVybC8iOjk0fV0sMTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscy9jcmVkZW50aWFsX3Byb3ZpZGVyX2NoYWluJyk7CiAgdmFyIFByb21pc2VzRGVwZW5kZW5jeTsKICAKICAvKioKICAgKiBUaGUgbWFpbiBjb25maWd1cmF0aW9uIGNsYXNzIHVzZWQgYnkgYWxsIHNlcnZpY2Ugb2JqZWN0cyB0byBzZXQKICAgKiB0aGUgcmVnaW9uLCBjcmVkZW50aWFscywgYW5kIG90aGVyIG9wdGlvbnMgZm9yIHJlcXVlc3RzLgogICAqCiAgICogQnkgZGVmYXVsdCwgY3JlZGVudGlhbHMgYW5kIHJlZ2lvbiBzZXR0aW5ncyBhcmUgbGVmdCB1bmNvbmZpZ3VyZWQuCiAgICogVGhpcyBzaG91bGQgYmUgY29uZmlndXJlZCBieSB0aGUgYXBwbGljYXRpb24gYmVmb3JlIHVzaW5nIGFueQogICAqIEFXUyBzZXJ2aWNlIEFQSXMuCiAgICoKICAgKiBJbiBvcmRlciB0byBzZXQgZ2xvYmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9ucywgcHJvcGVydGllcyBzaG91bGQKICAgKiBiZSBhc3NpZ25lZCB0byB0aGUgZ2xvYmFsIHtBV1MuY29uZmlnfSBvYmplY3QuCiAgICoKICAgKiBAc2VlIEFXUy5jb25maWcKICAgKgogICAqIEAhZ3JvdXAgR2VuZXJhbCBDb25maWd1cmF0aW9uIE9wdGlvbnMKICAgKgogICAqIEAhYXR0cmlidXRlIGNyZWRlbnRpYWxzCiAgICogICBAcmV0dXJuIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBBV1MgY3JlZGVudGlhbHMgdG8gc2lnbiByZXF1ZXN0cyB3aXRoLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcmVnaW9uCiAgICogICBAZXhhbXBsZSBTZXQgdGhlIGdsb2JhbCByZWdpb24gc2V0dGluZyB0byB1cy13ZXN0LTIKICAgKiAgICAgQVdTLmNvbmZpZy51cGRhdGUoe3JlZ2lvbjogJ3VzLXdlc3QtMid9KTsKICAgKiAgIEByZXR1cm4gW0FXUy5DcmVkZW50aWFsc10gVGhlIHJlZ2lvbiB0byBzZW5kIHNlcnZpY2UgcmVxdWVzdHMgdG8uCiAgICogICBAc2VlIGh0dHA6Ly9kb2NzLmFtYXpvbndlYnNlcnZpY2VzLmNvbS9nZW5lcmFsL2xhdGVzdC9nci9yYW5kZS5odG1sCiAgICogICAgIEEgbGlzdCBvZiBhdmFpbGFibGUgZW5kcG9pbnRzIGZvciBlYWNoIEFXUyBzZXJ2aWNlCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBtYXhSZXRyaWVzCiAgICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbWF4aW11bSBhbW91bnQgb2YgcmV0cmllcyB0byBwZXJmb3JtIGZvciBhCiAgICogICAgIHNlcnZpY2UgcmVxdWVzdC4gQnkgZGVmYXVsdCB0aGlzIHZhbHVlIGlzIGNhbGN1bGF0ZWQgYnkgdGhlIHNwZWNpZmljCiAgICogICAgIHNlcnZpY2Ugb2JqZWN0IHRoYXQgdGhlIHJlcXVlc3QgaXMgYmVpbmcgbWFkZSB0by4KICAgKgogICAqIEAhYXR0cmlidXRlIG1heFJlZGlyZWN0cwogICAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIG1heGltdW0gYW1vdW50IG9mIHJlZGlyZWN0cyB0byBmb2xsb3cgZm9yIGEKICAgKiAgICAgc2VydmljZSByZXF1ZXN0LiBEZWZhdWx0cyB0byAxMC4KICAgKgogICAqIEAhYXR0cmlidXRlIHBhcmFtVmFsaWRhdGlvbgogICAqICAgQHJldHVybiBbQm9vbGVhbnxtYXBdIHdoZXRoZXIgaW5wdXQgcGFyYW1ldGVycyBzaG91bGQgYmUgdmFsaWRhdGVkIGFnYWluc3QKICAgKiAgICAgdGhlIG9wZXJhdGlvbiBkZXNjcmlwdGlvbiBiZWZvcmUgc2VuZGluZyB0aGUgcmVxdWVzdC4gRGVmYXVsdHMgdG8gdHJ1ZS4KICAgKiAgICAgUGFzcyBhIG1hcCB0byBlbmFibGUgYW55IG9mIHRoZSBmb2xsb3dpbmcgc3BlY2lmaWMgdmFsaWRhdGlvbiBmZWF0dXJlczoKICAgKgogICAqICAgICAqICoqbWluKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWluCiAgICogICAgICAgY29uc3RyYWludC4gVGhpcyBpcyBlbmFibGVkIGJ5IGRlZmF1bHQgd2hlbiBwYXJhbVZhbGlkYXRpb24gaXMgc2V0CiAgICogICAgICAgdG8gYHRydWVgLgogICAqICAgICAqICoqbWF4KiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWF4CiAgICogICAgICAgY29uc3RyYWludC4KICAgKiAgICAgKiAqKnBhdHRlcm4qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIGEKICAgKiAgICAgICByZWd1bGFyIGV4cHJlc3Npb24uCiAgICogICAgICogKiplbnVtKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBvbmUKICAgKiAgICAgICBvZiB0aGUgYWxsb3dhYmxlIGVudW0gdmFsdWVzLgogICAqCiAgICogQCFhdHRyaWJ1dGUgY29tcHV0ZUNoZWNrc3VtcwogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBjb21wdXRlIGNoZWNrc3VtcyBmb3IgcGF5bG9hZCBib2RpZXMgd2hlbgogICAqICAgICB0aGUgc2VydmljZSBhY2NlcHRzIGl0IChjdXJyZW50bHkgc3VwcG9ydGVkIGluIFMzIG9ubHkpLgogICAqCiAgICogQCFhdHRyaWJ1dGUgY29udmVydFJlc3BvbnNlVHlwZXMKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdHlwZXMgYXJlIGNvbnZlcnRlZCB3aGVuIHBhcnNpbmcgcmVzcG9uc2UgZGF0YS4KICAgKiAgICAgQ3VycmVudGx5IG9ubHkgc3VwcG9ydGVkIGZvciBKU09OIGJhc2VkIHNlcnZpY2VzLiBUdXJuaW5nIHRoaXMgb2ZmIG1heQogICAqICAgICBpbXByb3ZlIHBlcmZvcm1hbmNlIG9uIGxhcmdlIHJlc3BvbnNlIHBheWxvYWRzLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBjb3JyZWN0Q2xvY2tTa2V3CiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIGFwcGx5IGEgY2xvY2sgc2tldyBjb3JyZWN0aW9uIGFuZCByZXRyeQogICAqICAgICByZXF1ZXN0cyB0aGF0IGZhaWwgYmVjYXVzZSBvZiBhbiBza2V3ZWQgY2xpZW50IGNsb2NrLiBEZWZhdWx0cyB0bwogICAqICAgICBgZmFsc2VgLgogICAqCiAgICogQCFhdHRyaWJ1dGUgc3NsRW5hYmxlZAogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciBTU0wgaXMgZW5hYmxlZCBmb3IgcmVxdWVzdHMKICAgKgogICAqIEAhYXR0cmlidXRlIHMzRm9yY2VQYXRoU3R5bGUKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gZm9yY2UgcGF0aCBzdHlsZSBVUkxzIGZvciBTMyBvYmplY3RzCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzM0J1Y2tldEVuZHBvaW50CiAgICogICBAbm90ZSBTZXR0aW5nIHRoaXMgY29uZmlndXJhdGlvbiBvcHRpb24gcmVxdWlyZXMgYW4gYGVuZHBvaW50YCB0byBiZQogICAqICAgICBwcm92aWRlZCBleHBsaWNpdGx5IHRvIHRoZSBzZXJ2aWNlIGNvbnN0cnVjdG9yLgogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0aGUgcHJvdmlkZWQgZW5kcG9pbnQgYWRkcmVzc2VzIGFuIGluZGl2aWR1YWwKICAgKiAgICAgYnVja2V0IChmYWxzZSBpZiBpdCBhZGRyZXNzZXMgdGhlIHJvb3QgQVBJIGVuZHBvaW50KS4KICAgKgogICAqIEAhYXR0cmlidXRlIHMzRGlzYWJsZUJvZHlTaWduaW5nCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIGRpc2FibGUgUzMgYm9keSBzaWduaW5nIHdoZW4gdXNpbmcgc2lnbmF0dXJlIHZlcnNpb24gYHY0YC4KICAgKiAgICAgQm9keSBzaWduaW5nIGNhbiBvbmx5IGJlIGRpc2FibGVkIHdoZW4gdXNpbmcgaHR0cHMuIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgKgogICAqIEAhYXR0cmlidXRlIHVzZUFjY2VsZXJhdGVFbmRwb2ludAogICAqICAgQG5vdGUgVGhpcyBjb25maWd1cmF0aW9uIG9wdGlvbiBpcyBvbmx5IGNvbXBhdGlibGUgd2l0aCBTMyB3aGlsZSBhY2Nlc3NpbmcKICAgKiAgICAgZG5zLWNvbXBhdGlibGUgYnVja2V0cy4KICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIFdoZXRoZXIgdG8gdXNlIHRoZSBBY2NlbGVyYXRlIGVuZHBvaW50IHdpdGggdGhlIFMzIHNlcnZpY2UuCiAgICogICAgIERlZmF1bHRzIHRvIGBmYWxzZWAuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSByZXRyeURlbGF5T3B0aW9ucwogICAqICAgQGV4YW1wbGUgU2V0IHRoZSBiYXNlIHJldHJ5IGRlbGF5IGZvciBhbGwgc2VydmljZXMgdG8gMzAwIG1zCiAgICogICAgIEFXUy5jb25maWcudXBkYXRlKHtyZXRyeURlbGF5T3B0aW9uczoge2Jhc2U6IDMwMH19KTsKICAgKiAgICAgLy8gRGVsYXlzIHdpdGggbWF4UmV0cmllcyA9IDM6IDMwMCwgNjAwLCAxMjAwCiAgICogICBAZXhhbXBsZSBTZXQgYSBjdXN0b20gYmFja29mZiBmdW5jdGlvbiB0byBwcm92aWRlIGRlbGF5IHZhbHVlcyBvbiByZXRyaWVzCiAgICogICAgIEFXUy5jb25maWcudXBkYXRlKHtyZXRyeURlbGF5T3B0aW9uczoge2N1c3RvbUJhY2tvZmY6IGZ1bmN0aW9uKHJldHJ5Q291bnQpIHsKICAgKiAgICAgICAvLyByZXR1cm5zIGRlbGF5IGluIG1zCiAgICogICAgIH19fSk7CiAgICogICBAcmV0dXJuIFttYXBdIEEgc2V0IG9mIG9wdGlvbnMgdG8gY29uZmlndXJlIHRoZSByZXRyeSBkZWxheSBvbiByZXRyeWFibGUgZXJyb3JzLgogICAqICAgICBDdXJyZW50bHkgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogICAqCiAgICogICAgICogKipiYXNlKiogW0ludGVnZXJdICZtZGFzaDsgVGhlIGJhc2UgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB1c2UgaW4gdGhlCiAgICogICAgICAgZXhwb25lbnRpYWwgYmFja29mZiBmb3Igb3BlcmF0aW9uIHJldHJpZXMuIERlZmF1bHRzIHRvIDEwMCBtcyBmb3IgYWxsIHNlcnZpY2VzIGV4Y2VwdAogICAqICAgICAgIER5bmFtb0RCLCB3aGVyZSBpdCBkZWZhdWx0cyB0byA1MG1zLgogICAqICAgICAqICoqY3VzdG9tQmFja29mZiAqKiBbZnVuY3Rpb25dICZtZGFzaDsgQSBjdXN0b20gZnVuY3Rpb24gdGhhdCBhY2NlcHRzIGEgcmV0cnkgY291bnQKICAgKiAgICAgICBhbmQgcmV0dXJucyB0aGUgYW1vdW50IG9mIHRpbWUgdG8gZGVsYXkgaW4gbWlsbGlzZWNvbmRzLiBUaGUgYGJhc2VgIG9wdGlvbiB3aWxsIGJlCiAgICogICAgICAgaWdub3JlZCBpZiB0aGlzIG9wdGlvbiBpcyBzdXBwbGllZC4KICAgKgogICAqIEAhYXR0cmlidXRlIGh0dHBPcHRpb25zCiAgICogICBAcmV0dXJuIFttYXBdIEEgc2V0IG9mIG9wdGlvbnMgdG8gcGFzcyB0byB0aGUgbG93LWxldmVsIEhUVFAgcmVxdWVzdC4KICAgKiAgICAgQ3VycmVudGx5IHN1cHBvcnRlZCBvcHRpb25zIGFyZToKICAgKgogICAqICAgICAqICoqcHJveHkqKiBbU3RyaW5nXSAmbWRhc2g7IHRoZSBVUkwgdG8gcHJveHkgcmVxdWVzdHMgdGhyb3VnaAogICAqICAgICAqICoqYWdlbnQqKiBbaHR0cC5BZ2VudCwgaHR0cHMuQWdlbnRdICZtZGFzaDsgdGhlIEFnZW50IG9iamVjdCB0byBwZXJmb3JtCiAgICogICAgICAgSFRUUCByZXF1ZXN0cyB3aXRoLiBVc2VkIGZvciBjb25uZWN0aW9uIHBvb2xpbmcuIE5vdGUgdGhhdCBmb3IKICAgKiAgICAgICBTU0wgY29ubmVjdGlvbnMsIGEgc3BlY2lhbCBBZ2VudCBvYmplY3QgaXMgdXNlZCBpbiBvcmRlciB0byBlbmFibGUKICAgKiAgICAgICBwZWVyIGNlcnRpZmljYXRlIHZlcmlmaWNhdGlvbi4gVGhpcyBmZWF0dXJlIGlzIG9ubHkgc3VwcG9ydGVkIGluIHRoZQogICAqICAgICAgIE5vZGUuanMgZW52aXJvbm1lbnQuCiAgICogICAgICogKipjb25uZWN0VGltZW91dCoqIFtJbnRlZ2VyXSAmbWRhc2g7IFNldHMgdGhlIHNvY2tldCB0byB0aW1lb3V0IGFmdGVyCiAgICogICAgICAgZmFpbGluZyB0byBlc3RhYmxpc2ggYSBjb25uZWN0aW9uIHdpdGggdGhlIHNlcnZlciBhZnRlcgogICAqICAgICAgIGBjb25uZWN0VGltZW91dGAgbWlsbGlzZWNvbmRzLiBUaGlzIHRpbWVvdXQgaGFzIG5vIGVmZmVjdCBvbmNlIGEgc29ja2V0CiAgICogICAgICAgY29ubmVjdGlvbiBoYXMgYmVlbiBlc3RhYmxpc2hlZC4KICAgKiAgICAgKiAqKnRpbWVvdXQqKiBbSW50ZWdlcl0gJm1kYXNoOyBTZXRzIHRoZSBzb2NrZXQgdG8gdGltZW91dCBhZnRlciB0aW1lb3V0CiAgICogICAgICAgbWlsbGlzZWNvbmRzIG9mIGluYWN0aXZpdHkgb24gdGhlIHNvY2tldC4gRGVmYXVsdHMgdG8gdHdvIG1pbnV0ZXMKICAgKiAgICAgICAoMTIwMDAwKQogICAqICAgICAqICoqeGhyQXN5bmMqKiBbQm9vbGVhbl0gJm1kYXNoOyBXaGV0aGVyIHRoZSBTREsgd2lsbCBzZW5kIGFzeW5jaHJvbm91cwogICAqICAgICAgIEhUVFAgcmVxdWVzdHMuIFVzZWQgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQgb25seS4gU2V0IHRvIGZhbHNlIHRvCiAgICogICAgICAgc2VuZCByZXF1ZXN0cyBzeW5jaHJvbm91c2x5LiBEZWZhdWx0cyB0byB0cnVlIChhc3luYyBvbikuCiAgICogICAgICogKip4aHJXaXRoQ3JlZGVudGlhbHMqKiBbQm9vbGVhbl0gJm1kYXNoOyBTZXRzIHRoZSAid2l0aENyZWRlbnRpYWxzIgogICAqICAgICAgIHByb3BlcnR5IG9mIGFuIFhNTEh0dHBSZXF1ZXN0IG9iamVjdC4gVXNlZCBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudAogICAqICAgICAgIG9ubHkuIERlZmF1bHRzIHRvIGZhbHNlLgogICAqIEAhYXR0cmlidXRlIGxvZ2dlcgogICAqICAgQHJldHVybiBbI3dyaXRlLCNsb2ddIGFuIG9iamVjdCB0aGF0IHJlc3BvbmRzIHRvIC53cml0ZSgpIChsaWtlIGEgc3RyZWFtKQogICAqICAgICBvciAubG9nKCkgKGxpa2UgdGhlIGNvbnNvbGUgb2JqZWN0KSBpbiBvcmRlciB0byBsb2cgaW5mb3JtYXRpb24gYWJvdXQKICAgKiAgICAgcmVxdWVzdHMKICAgKgogICAqIEAhYXR0cmlidXRlIHN5c3RlbUNsb2NrT2Zmc2V0CiAgICogICBAcmV0dXJuIFtOdW1iZXJdIGFuIG9mZnNldCB2YWx1ZSBpbiBtaWxsaXNlY29uZHMgdG8gYXBwbHkgdG8gYWxsIHNpZ25pbmcKICAgKiAgICAgdGltZXMuIFVzZSB0aGlzIHRvIGNvbXBlbnNhdGUgZm9yIGNsb2NrIHNrZXcgd2hlbiB5b3VyIHN5c3RlbSBtYXkgYmUKICAgKiAgICAgb3V0IG9mIHN5bmMgd2l0aCB0aGUgc2VydmljZSB0aW1lLiBOb3RlIHRoYXQgdGhpcyBjb25maWd1cmF0aW9uIG9wdGlvbgogICAqICAgICBjYW4gb25seSBiZSBhcHBsaWVkIHRvIHRoZSBnbG9iYWwgYEFXUy5jb25maWdgIG9iamVjdCBhbmQgY2Fubm90IGJlCiAgICogICAgIG92ZXJyaWRkZW4gaW4gc2VydmljZS1zcGVjaWZpYyBjb25maWd1cmF0aW9uLiBEZWZhdWx0cyB0byAwIG1pbGxpc2Vjb25kcy4KICAgKgogICAqIEAhYXR0cmlidXRlIHNpZ25hdHVyZVZlcnNpb24KICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIHNpZ25hdHVyZSB2ZXJzaW9uIHRvIHNpZ24gcmVxdWVzdHMgd2l0aCAob3ZlcnJpZGluZwogICAqICAgICB0aGUgQVBJIGNvbmZpZ3VyYXRpb24pLiBQb3NzaWJsZSB2YWx1ZXMgYXJlOiAndjInLCAndjMnLCAndjQnLgogICAqCiAgICogQCFhdHRyaWJ1dGUgc2lnbmF0dXJlQ2FjaGUKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIHNpZ25hdHVyZSB0byBzaWduIHJlcXVlc3RzIHdpdGggKG92ZXJyaWRpbmcKICAgKiAgICAgdGhlIEFQSSBjb25maWd1cmF0aW9uKSBpcyBjYWNoZWQuIE9ubHkgYXBwbGllcyB0byB0aGUgc2lnbmF0dXJlIHZlcnNpb24gJ3Y0Jy4KICAgKiAgICAgRGVmYXVsdHMgdG8gYHRydWVgLgogICAqCiAgICogQCFhdHRyaWJ1dGUgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIGVuYWJsZSBlbmRwb2ludCBkaXNjb3ZlcnkgZm9yIG9wZXJhdGlvbnMgdGhhdAogICAqICAgICBhbGxvdyBvcHRpb25hbGx5IHVzaW5nIGFuIGVuZHBvaW50IHJldHVybmVkIGJ5IHRoZSBzZXJ2aWNlLgogICAqICAgICBEZWZhdWx0cyB0byAnZmFsc2UnCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBlbmRwb2ludENhY2hlU2l6ZQogICAqICAgQHJldHVybiBbTnVtYmVyXSB0aGUgc2l6ZSBvZiB0aGUgZ2xvYmFsIGNhY2hlIHN0b3JpbmcgZW5kcG9pbnRzIGZyb20gZW5kcG9pbnQKICAgKiAgICAgZGlzY292ZXJ5IG9wZXJhdGlvbnMuIE9uY2UgZW5kcG9pbnQgY2FjaGUgaXMgY3JlYXRlZCwgdXBkYXRpbmcgdGhpcyBzZXR0aW5nCiAgICogICAgIGNhbm5vdCBjaGFuZ2UgZXhpc3RpbmcgY2FjaGUgc2l6ZS4KICAgKiAgICAgRGVmYXVsdHMgdG8gMTAwMAogICAqCiAgICogQCFhdHRyaWJ1dGUgaG9zdFByZWZpeEVuYWJsZWQKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gbWFyc2hhbCByZXF1ZXN0IHBhcmFtZXRlcnMgdG8gdGhlIHByZWZpeCBvZgogICAqICAgICBob3N0bmFtZS4gRGVmYXVsdHMgdG8gYHRydWVgLgogICAqCiAgICogQCFhdHRyaWJ1dGUgc3RzUmVnaW9uYWxFbmRwb2ludHMKICAgKiAgIEByZXR1cm4gWydsZWdhY3knfCdyZWdpb25hbCddIHdoZXRoZXIgdG8gc2VuZCBzdHMgcmVxdWVzdCB0byBnbG9iYWwgZW5kcG9pbnRzIG9yCiAgICogICAgIHJlZ2lvbmFsIGVuZHBvaW50cy4KICAgKiAgICAgRGVmYXVsdHMgdG8gJ2xlZ2FjeScKICAgKi8KICBBV1MuQ29uZmlnID0gQVdTLnV0aWwuaW5oZXJpdCh7CiAgICAvKioKICAgICAqIEAhZW5kZ3JvdXAKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IGNvbmZpZ3VyYXRpb24gb2JqZWN0LiBUaGlzIGlzIHRoZSBvYmplY3QgdGhhdCBwYXNzZXMKICAgICAqIG9wdGlvbiBkYXRhIGFsb25nIHRvIHNlcnZpY2UgcmVxdWVzdHMsIGluY2x1ZGluZyBjcmVkZW50aWFscywgc2VjdXJpdHksCiAgICAgKiByZWdpb24gaW5mb3JtYXRpb24sIGFuZCBzb21lIHNlcnZpY2Ugc3BlY2lmaWMgc2V0dGluZ3MuCiAgICAgKgogICAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY29uZmlndXJhdGlvbiBvYmplY3Qgd2l0aCBjcmVkZW50aWFscyBhbmQgcmVnaW9uCiAgICAgKiAgIHZhciBjb25maWcgPSBuZXcgQVdTLkNvbmZpZyh7CiAgICAgKiAgICAgYWNjZXNzS2V5SWQ6ICdBS0lEJywgc2VjcmV0QWNjZXNzS2V5OiAnU0VDUkVUJywgcmVnaW9uOiAndXMtd2VzdC0yJwogICAgICogICB9KTsKICAgICAqIEBvcHRpb24gb3B0aW9ucyBhY2Nlc3NLZXlJZCBbU3RyaW5nXSB5b3VyIEFXUyBhY2Nlc3Mga2V5IElELgogICAgICogQG9wdGlvbiBvcHRpb25zIHNlY3JldEFjY2Vzc0tleSBbU3RyaW5nXSB5b3VyIEFXUyBzZWNyZXQgYWNjZXNzIGtleS4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzZXNzaW9uVG9rZW4gW0FXUy5DcmVkZW50aWFsc10gdGhlIG9wdGlvbmFsIEFXUwogICAgICogICBzZXNzaW9uIHRva2VuIHRvIHNpZ24gcmVxdWVzdHMgd2l0aC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBjcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgQVdTIGNyZWRlbnRpYWxzCiAgICAgKiAgIHRvIHNpZ24gcmVxdWVzdHMgd2l0aC4gWW91IGNhbiBlaXRoZXIgc3BlY2lmeSB0aGlzIG9iamVjdCwgb3IKICAgICAqICAgc3BlY2lmeSB0aGUgYWNjZXNzS2V5SWQgYW5kIHNlY3JldEFjY2Vzc0tleSBvcHRpb25zIGRpcmVjdGx5LgogICAgICogQG9wdGlvbiBvcHRpb25zIGNyZWRlbnRpYWxQcm92aWRlciBbQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluXSB0aGUKICAgICAqICAgcHJvdmlkZXIgY2hhaW4gdXNlZCB0byByZXNvbHZlIGNyZWRlbnRpYWxzIGlmIG5vIHN0YXRpYyBgY3JlZGVudGlhbHNgCiAgICAgKiAgIHByb3BlcnR5IGlzIHNldC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyByZWdpb24gW1N0cmluZ10gdGhlIHJlZ2lvbiB0byBzZW5kIHNlcnZpY2UgcmVxdWVzdHMgdG8uCiAgICAgKiAgIFNlZSB7cmVnaW9ufSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBtYXhSZXRyaWVzIFtJbnRlZ2VyXSB0aGUgbWF4aW11bSBhbW91bnQgb2YgcmV0cmllcyB0bwogICAgICogICBhdHRlbXB0IHdpdGggYSByZXF1ZXN0LiBTZWUge21heFJldHJpZXN9IGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICogQG9wdGlvbiBvcHRpb25zIG1heFJlZGlyZWN0cyBbSW50ZWdlcl0gdGhlIG1heGltdW0gYW1vdW50IG9mIHJlZGlyZWN0cyB0bwogICAgICogICBmb2xsb3cgd2l0aCBhIHJlcXVlc3QuIFNlZSB7bWF4UmVkaXJlY3RzfSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzc2xFbmFibGVkIFtCb29sZWFuXSB3aGV0aGVyIHRvIGVuYWJsZSBTU0wgZm9yCiAgICAgKiAgIHJlcXVlc3RzLgogICAgICogQG9wdGlvbiBvcHRpb25zIHBhcmFtVmFsaWRhdGlvbiBbQm9vbGVhbnxtYXBdIHdoZXRoZXIgaW5wdXQgcGFyYW1ldGVycwogICAgICogICBzaG91bGQgYmUgdmFsaWRhdGVkIGFnYWluc3QgdGhlIG9wZXJhdGlvbiBkZXNjcmlwdGlvbiBiZWZvcmUgc2VuZGluZwogICAgICogICB0aGUgcmVxdWVzdC4gRGVmYXVsdHMgdG8gdHJ1ZS4gUGFzcyBhIG1hcCB0byBlbmFibGUgYW55IG9mIHRoZQogICAgICogICBmb2xsb3dpbmcgc3BlY2lmaWMgdmFsaWRhdGlvbiBmZWF0dXJlczoKICAgICAqCiAgICAgKiAgICogKiptaW4qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHZhbHVlIG1lZXRzIHRoZSBtaW4KICAgICAqICAgICBjb25zdHJhaW50LiBUaGlzIGlzIGVuYWJsZWQgYnkgZGVmYXVsdCB3aGVuIHBhcmFtVmFsaWRhdGlvbiBpcyBzZXQKICAgICAqICAgICB0byBgdHJ1ZWAuCiAgICAgKiAgICogKiptYXgqKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHZhbHVlIG1lZXRzIHRoZSBtYXgKICAgICAqICAgICBjb25zdHJhaW50LgogICAgICogICAqICoqcGF0dGVybioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgYQogICAgICogICAgIHJlZ3VsYXIgZXhwcmVzc2lvbi4KICAgICAqICAgKiAqKmVudW0qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIG9uZQogICAgICogICAgIG9mIHRoZSBhbGxvd2FibGUgZW51bSB2YWx1ZXMuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgY29tcHV0ZUNoZWNrc3VtcyBbQm9vbGVhbl0gd2hldGhlciB0byBjb21wdXRlIGNoZWNrc3VtcwogICAgICogICBmb3IgcGF5bG9hZCBib2RpZXMgd2hlbiB0aGUgc2VydmljZSBhY2NlcHRzIGl0IChjdXJyZW50bHkgc3VwcG9ydGVkCiAgICAgKiAgIGluIFMzIG9ubHkpCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgY29udmVydFJlc3BvbnNlVHlwZXMgW0Jvb2xlYW5dIHdoZXRoZXIgdHlwZXMgYXJlIGNvbnZlcnRlZAogICAgICogICAgIHdoZW4gcGFyc2luZyByZXNwb25zZSBkYXRhLiBDdXJyZW50bHkgb25seSBzdXBwb3J0ZWQgZm9yIEpTT04gYmFzZWQKICAgICAqICAgICBzZXJ2aWNlcy4gVHVybmluZyB0aGlzIG9mZiBtYXkgaW1wcm92ZSBwZXJmb3JtYW5jZSBvbiBsYXJnZSByZXNwb25zZQogICAgICogICAgIHBheWxvYWRzLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgY29ycmVjdENsb2NrU2tldyBbQm9vbGVhbl0gd2hldGhlciB0byBhcHBseSBhIGNsb2NrIHNrZXcKICAgICAqICAgICBjb3JyZWN0aW9uIGFuZCByZXRyeSByZXF1ZXN0cyB0aGF0IGZhaWwgYmVjYXVzZSBvZiBhbiBza2V3ZWQgY2xpZW50CiAgICAgKiAgICAgY2xvY2suIERlZmF1bHRzIHRvIGBmYWxzZWAuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgczNGb3JjZVBhdGhTdHlsZSBbQm9vbGVhbl0gd2hldGhlciB0byBmb3JjZSBwYXRoCiAgICAgKiAgIHN0eWxlIFVSTHMgZm9yIFMzIG9iamVjdHMuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgczNCdWNrZXRFbmRwb2ludCBbQm9vbGVhbl0gd2hldGhlciB0aGUgcHJvdmlkZWQgZW5kcG9pbnQKICAgICAqICAgYWRkcmVzc2VzIGFuIGluZGl2aWR1YWwgYnVja2V0IChmYWxzZSBpZiBpdCBhZGRyZXNzZXMgdGhlIHJvb3QgQVBJCiAgICAgKiAgIGVuZHBvaW50KS4gTm90ZSB0aGF0IHNldHRpbmcgdGhpcyBjb25maWd1cmF0aW9uIG9wdGlvbiByZXF1aXJlcyBhbgogICAgICogICBgZW5kcG9pbnRgIHRvIGJlIHByb3ZpZGVkIGV4cGxpY2l0bHkgdG8gdGhlIHNlcnZpY2UgY29uc3RydWN0b3IuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgczNEaXNhYmxlQm9keVNpZ25pbmcgW0Jvb2xlYW5dIHdoZXRoZXIgUzMgYm9keSBzaWduaW5nCiAgICAgKiAgIHNob3VsZCBiZSBkaXNhYmxlZCB3aGVuIHVzaW5nIHNpZ25hdHVyZSB2ZXJzaW9uIGB2NGAuIEJvZHkgc2lnbmluZwogICAgICogICBjYW4gb25seSBiZSBkaXNhYmxlZCB3aGVuIHVzaW5nIGh0dHBzLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICAgKgogICAgICogQG9wdGlvbiBvcHRpb25zIHJldHJ5RGVsYXlPcHRpb25zIFttYXBdIEEgc2V0IG9mIG9wdGlvbnMgdG8gY29uZmlndXJlCiAgICAgKiAgIHRoZSByZXRyeSBkZWxheSBvbiByZXRyeWFibGUgZXJyb3JzLiBDdXJyZW50bHkgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogICAgICoKICAgICAqICAgKiAqKmJhc2UqKiBbSW50ZWdlcl0gJm1kYXNoOyBUaGUgYmFzZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHVzZSBpbiB0aGUKICAgICAqICAgICBleHBvbmVudGlhbCBiYWNrb2ZmIGZvciBvcGVyYXRpb24gcmV0cmllcy4gRGVmYXVsdHMgdG8gMTAwIG1zIGZvciBhbGwKICAgICAqICAgICBzZXJ2aWNlcyBleGNlcHQgRHluYW1vREIsIHdoZXJlIGl0IGRlZmF1bHRzIHRvIDUwbXMuCiAgICAgKiAgICogKipjdXN0b21CYWNrb2ZmICoqIFtmdW5jdGlvbl0gJm1kYXNoOyBBIGN1c3RvbSBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgYSByZXRyeSBjb3VudAogICAgICogICAgIGFuZCByZXR1cm5zIHRoZSBhbW91bnQgb2YgdGltZSB0byBkZWxheSBpbiBtaWxsaXNlY29uZHMuIFRoZSBgYmFzZWAgb3B0aW9uIHdpbGwgYmUKICAgICAqICAgICBpZ25vcmVkIGlmIHRoaXMgb3B0aW9uIGlzIHN1cHBsaWVkLgogICAgICogQG9wdGlvbiBvcHRpb25zIGh0dHBPcHRpb25zIFttYXBdIEEgc2V0IG9mIG9wdGlvbnMgdG8gcGFzcyB0byB0aGUgbG93LWxldmVsCiAgICAgKiAgIEhUVFAgcmVxdWVzdC4gQ3VycmVudGx5IHN1cHBvcnRlZCBvcHRpb25zIGFyZToKICAgICAqCiAgICAgKiAgICogKipwcm94eSoqIFtTdHJpbmddICZtZGFzaDsgdGhlIFVSTCB0byBwcm94eSByZXF1ZXN0cyB0aHJvdWdoCiAgICAgKiAgICogKiphZ2VudCoqIFtodHRwLkFnZW50LCBodHRwcy5BZ2VudF0gJm1kYXNoOyB0aGUgQWdlbnQgb2JqZWN0IHRvIHBlcmZvcm0KICAgICAqICAgICBIVFRQIHJlcXVlc3RzIHdpdGguIFVzZWQgZm9yIGNvbm5lY3Rpb24gcG9vbGluZy4gRGVmYXVsdHMgdG8gdGhlIGdsb2JhbAogICAgICogICAgIGFnZW50IChgaHR0cC5nbG9iYWxBZ2VudGApIGZvciBub24tU1NMIGNvbm5lY3Rpb25zLiBOb3RlIHRoYXQgZm9yCiAgICAgKiAgICAgU1NMIGNvbm5lY3Rpb25zLCBhIHNwZWNpYWwgQWdlbnQgb2JqZWN0IGlzIHVzZWQgaW4gb3JkZXIgdG8gZW5hYmxlCiAgICAgKiAgICAgcGVlciBjZXJ0aWZpY2F0ZSB2ZXJpZmljYXRpb24uIFRoaXMgZmVhdHVyZSBpcyBvbmx5IGF2YWlsYWJsZSBpbiB0aGUKICAgICAqICAgICBOb2RlLmpzIGVudmlyb25tZW50LgogICAgICogICAqICoqY29ubmVjdFRpbWVvdXQqKiBbSW50ZWdlcl0gJm1kYXNoOyBTZXRzIHRoZSBzb2NrZXQgdG8gdGltZW91dCBhZnRlcgogICAgICogICAgIGZhaWxpbmcgdG8gZXN0YWJsaXNoIGEgY29ubmVjdGlvbiB3aXRoIHRoZSBzZXJ2ZXIgYWZ0ZXIKICAgICAqICAgICBgY29ubmVjdFRpbWVvdXRgIG1pbGxpc2Vjb25kcy4gVGhpcyB0aW1lb3V0IGhhcyBubyBlZmZlY3Qgb25jZSBhIHNvY2tldAogICAgICogICAgIGNvbm5lY3Rpb24gaGFzIGJlZW4gZXN0YWJsaXNoZWQuCiAgICAgKiAgICogKip0aW1lb3V0KiogW0ludGVnZXJdICZtZGFzaDsgU2V0cyB0aGUgc29ja2V0IHRvIHRpbWVvdXQgYWZ0ZXIgdGltZW91dAogICAgICogICAgIG1pbGxpc2Vjb25kcyBvZiBpbmFjdGl2aXR5IG9uIHRoZSBzb2NrZXQuIERlZmF1bHRzIHRvIHR3byBtaW51dGVzCiAgICAgKiAgICAgKDEyMDAwMCkuCiAgICAgKiAgICogKip4aHJBc3luYyoqIFtCb29sZWFuXSAmbWRhc2g7IFdoZXRoZXIgdGhlIFNESyB3aWxsIHNlbmQgYXN5bmNocm9ub3VzCiAgICAgKiAgICAgSFRUUCByZXF1ZXN0cy4gVXNlZCBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudCBvbmx5LiBTZXQgdG8gZmFsc2UgdG8KICAgICAqICAgICBzZW5kIHJlcXVlc3RzIHN5bmNocm9ub3VzbHkuIERlZmF1bHRzIHRvIHRydWUgKGFzeW5jIG9uKS4KICAgICAqICAgKiAqKnhocldpdGhDcmVkZW50aWFscyoqIFtCb29sZWFuXSAmbWRhc2g7IFNldHMgdGhlICJ3aXRoQ3JlZGVudGlhbHMiCiAgICAgKiAgICAgcHJvcGVydHkgb2YgYW4gWE1MSHR0cFJlcXVlc3Qgb2JqZWN0LiBVc2VkIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50CiAgICAgKiAgICAgb25seS4gRGVmYXVsdHMgdG8gZmFsc2UuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgYXBpVmVyc2lvbiBbU3RyaW5nLCBEYXRlXSBhIFN0cmluZyBpbiBZWVlZLU1NLUREIGZvcm1hdAogICAgICogICAob3IgYSBkYXRlKSB0aGF0IHJlcHJlc2VudHMgdGhlIGxhdGVzdCBwb3NzaWJsZSBBUEkgdmVyc2lvbiB0aGF0IGNhbiBiZQogICAgICogICB1c2VkIGluIGFsbCBzZXJ2aWNlcyAodW5sZXNzIG92ZXJyaWRkZW4gYnkgYGFwaVZlcnNpb25zYCkuIFNwZWNpZnkKICAgICAqICAgJ2xhdGVzdCcgdG8gdXNlIHRoZSBsYXRlc3QgcG9zc2libGUgdmVyc2lvbi4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBhcGlWZXJzaW9ucyBbbWFwPFN0cmluZywgU3RyaW5nfERhdGU+XSBhIG1hcCBvZiBzZXJ2aWNlCiAgICAgKiAgIGlkZW50aWZpZXJzICh0aGUgbG93ZXJjYXNlIHNlcnZpY2UgY2xhc3MgbmFtZSkgd2l0aCB0aGUgQVBJIHZlcnNpb24gdG8KICAgICAqICAgdXNlIHdoZW4gaW5zdGFudGlhdGluZyBhIHNlcnZpY2UuIFNwZWNpZnkgJ2xhdGVzdCcgZm9yIGVhY2ggaW5kaXZpZHVhbAogICAgICogICB0aGF0IGNhbiB1c2UgdGhlIGxhdGVzdCBhdmFpbGFibGUgdmVyc2lvbi4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBsb2dnZXIgWyN3cml0ZSwjbG9nXSBhbiBvYmplY3QgdGhhdCByZXNwb25kcyB0byAud3JpdGUoKQogICAgICogICAobGlrZSBhIHN0cmVhbSkgb3IgLmxvZygpIChsaWtlIHRoZSBjb25zb2xlIG9iamVjdCkgaW4gb3JkZXIgdG8gbG9nCiAgICAgKiAgIGluZm9ybWF0aW9uIGFib3V0IHJlcXVlc3RzCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgc3lzdGVtQ2xvY2tPZmZzZXQgW051bWJlcl0gYW4gb2Zmc2V0IHZhbHVlIGluIG1pbGxpc2Vjb25kcwogICAgICogICB0byBhcHBseSB0byBhbGwgc2lnbmluZyB0aW1lcy4gVXNlIHRoaXMgdG8gY29tcGVuc2F0ZSBmb3IgY2xvY2sgc2tldwogICAgICogICB3aGVuIHlvdXIgc3lzdGVtIG1heSBiZSBvdXQgb2Ygc3luYyB3aXRoIHRoZSBzZXJ2aWNlIHRpbWUuIE5vdGUgdGhhdAogICAgICogICB0aGlzIGNvbmZpZ3VyYXRpb24gb3B0aW9uIGNhbiBvbmx5IGJlIGFwcGxpZWQgdG8gdGhlIGdsb2JhbCBgQVdTLmNvbmZpZ2AKICAgICAqICAgb2JqZWN0IGFuZCBjYW5ub3QgYmUgb3ZlcnJpZGRlbiBpbiBzZXJ2aWNlLXNwZWNpZmljIGNvbmZpZ3VyYXRpb24uCiAgICAgKiAgIERlZmF1bHRzIHRvIDAgbWlsbGlzZWNvbmRzLgogICAgICogQG9wdGlvbiBvcHRpb25zIHNpZ25hdHVyZVZlcnNpb24gW1N0cmluZ10gdGhlIHNpZ25hdHVyZSB2ZXJzaW9uIHRvIHNpZ24KICAgICAqICAgcmVxdWVzdHMgd2l0aCAob3ZlcnJpZGluZyB0aGUgQVBJIGNvbmZpZ3VyYXRpb24pLiBQb3NzaWJsZSB2YWx1ZXMgYXJlOgogICAgICogICAndjInLCAndjMnLCAndjQnLgogICAgICogQG9wdGlvbiBvcHRpb25zIHNpZ25hdHVyZUNhY2hlIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBzaWduYXR1cmUgdG8gc2lnbgogICAgICogICByZXF1ZXN0cyB3aXRoIChvdmVycmlkaW5nIHRoZSBBUEkgY29uZmlndXJhdGlvbikgaXMgY2FjaGVkLiBPbmx5IGFwcGxpZXMKICAgICAqICAgdG8gdGhlIHNpZ25hdHVyZSB2ZXJzaW9uICd2NCcuIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBkeW5hbW9EYkNyYzMyIFtCb29sZWFuXSB3aGV0aGVyIHRvIHZhbGlkYXRlIHRoZSBDUkMzMgogICAgICogICBjaGVja3N1bSBvZiBIVFRQIHJlc3BvbnNlIGJvZGllcyByZXR1cm5lZCBieSBEeW5hbW9EQi4gRGVmYXVsdDogYHRydWVgLgogICAgICogQG9wdGlvbiBvcHRpb25zIHVzZUFjY2VsZXJhdGVFbmRwb2ludCBbQm9vbGVhbl0gV2hldGhlciB0byB1c2UgdGhlCiAgICAgKiAgIFMzIFRyYW5zZmVyIEFjY2VsZXJhdGlvbiBlbmRwb2ludCB3aXRoIHRoZSBTMyBzZXJ2aWNlLiBEZWZhdWx0OiBgZmFsc2VgLgogICAgICogQG9wdGlvbiBvcHRpb25zIGNsaWVudFNpZGVNb25pdG9yaW5nIFtCb29sZWFuXSB3aGV0aGVyIHRvIGNvbGxlY3QgYW5kCiAgICAgKiAgIHB1Ymxpc2ggdGhpcyBjbGllbnQncyBwZXJmb3JtYW5jZSBtZXRyaWNzIG9mIGFsbCBpdHMgQVBJIHJlcXVlc3RzLgogICAgICogQG9wdGlvbiBvcHRpb25zIGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZCBbQm9vbGVhbl0gd2hldGhlciB0byBlbmFibGUgZW5kcG9pbnQKICAgICAqICAgZGlzY292ZXJ5IGZvciBvcGVyYXRpb25zIHRoYXQgYWxsb3cgb3B0aW9uYWxseSB1c2luZyBhbiBlbmRwb2ludCByZXR1cm5lZCBieQogICAgICogICB0aGUgc2VydmljZS4KICAgICAqICAgRGVmYXVsdHMgdG8gJ2ZhbHNlJwogICAgICogQG9wdGlvbiBvcHRpb25zIGVuZHBvaW50Q2FjaGVTaXplIFtOdW1iZXJdIHRoZSBzaXplIG9mIHRoZSBnbG9iYWwgY2FjaGUgc3RvcmluZwogICAgICogICBlbmRwb2ludHMgZnJvbSBlbmRwb2ludCBkaXNjb3Zlcnkgb3BlcmF0aW9ucy4gT25jZSBlbmRwb2ludCBjYWNoZSBpcyBjcmVhdGVkLAogICAgICogICB1cGRhdGluZyB0aGlzIHNldHRpbmcgY2Fubm90IGNoYW5nZSBleGlzdGluZyBjYWNoZSBzaXplLgogICAgICogICBEZWZhdWx0cyB0byAxMDAwCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgaG9zdFByZWZpeEVuYWJsZWQgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gbWFyc2hhbCByZXF1ZXN0CiAgICAgKiAgIHBhcmFtZXRlcnMgdG8gdGhlIHByZWZpeCBvZiBob3N0bmFtZS4KICAgICAqICAgRGVmYXVsdHMgdG8gYHRydWVgLgogICAgICogQG9wdGlvbiBvcHRpb25zIHN0c1JlZ2lvbmFsRW5kcG9pbnRzIFsnbGVnYWN5J3wncmVnaW9uYWwnXSB3aGV0aGVyIHRvIHNlbmQgc3RzIHJlcXVlc3QKICAgICAqICAgdG8gZ2xvYmFsIGVuZHBvaW50cyBvciByZWdpb25hbCBlbmRwb2ludHMuCiAgICAgKiAgIERlZmF1bHRzIHRvICdsZWdhY3knLgogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gQ29uZmlnKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHVuZGVmaW5lZCkgb3B0aW9ucyA9IHt9OwogICAgICBvcHRpb25zID0gdGhpcy5leHRyYWN0Q3JlZGVudGlhbHMob3B0aW9ucyk7CiAgCiAgICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLmtleXMsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgdGhpcy5zZXQoa2V5LCBvcHRpb25zW2tleV0sIHZhbHVlKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAIWdyb3VwIE1hbmFnaW5nIENyZWRlbnRpYWxzCiAgICAgKi8KICAKICAgIC8qKgogICAgICogTG9hZHMgY3JlZGVudGlhbHMgZnJvbSB0aGUgY29uZmlndXJhdGlvbiBvYmplY3QuIFRoaXMgaXMgdXNlZCBpbnRlcm5hbGx5CiAgICAgKiBieSB0aGUgU0RLIHRvIGVuc3VyZSB0aGF0IHJlZnJlc2hhYmxlIHtDcmVkZW50aWFsc30gb2JqZWN0cyBhcmUgcHJvcGVybHkKICAgICAqIHJlZnJlc2hlZCBhbmQgbG9hZGVkIHdoZW4gc2VuZGluZyBhIHJlcXVlc3QuIElmIHlvdSB3YW50IHRvIGVuc3VyZSB0aGF0CiAgICAgKiB5b3VyIGNyZWRlbnRpYWxzIGFyZSBsb2FkZWQgcHJpb3IgdG8gYSByZXF1ZXN0LCB5b3UgY2FuIHVzZSB0aGlzIG1ldGhvZAogICAgICogZGlyZWN0bHkgdG8gcHJvdmlkZSBhY2N1cmF0ZSBjcmVkZW50aWFsIGRhdGEgc3RvcmVkIGluIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogQG5vdGUgSWYgeW91IGNvbmZpZ3VyZSB0aGUgU0RLIHdpdGggc3RhdGljIG9yIGVudmlyb25tZW50IGNyZWRlbnRpYWxzLAogICAgICogICB0aGUgY3JlZGVudGlhbCBkYXRhIHNob3VsZCBhbHJlYWR5IGJlIHByZXNlbnQgaW4ge2NyZWRlbnRpYWxzfSBhdHRyaWJ1dGUuCiAgICAgKiAgIFRoaXMgbWV0aG9kIGlzIHByaW1hcmlseSBuZWNlc3NhcnkgdG8gbG9hZCBjcmVkZW50aWFscyBmcm9tIGFzeW5jaHJvbm91cwogICAgICogICBzb3VyY2VzLCBvciBzb3VyY2VzIHRoYXQgY2FuIHJlZnJlc2ggY3JlZGVudGlhbHMgcGVyaW9kaWNhbGx5LgogICAgICogQGV4YW1wbGUgR2V0dGluZyB5b3VyIGFjY2VzcyBrZXkKICAgICAqICAgQVdTLmNvbmZpZy5nZXRDcmVkZW50aWFscyhmdW5jdGlvbihlcnIpIHsKICAgICAqICAgICBpZiAoZXJyKSBjb25zb2xlLmxvZyhlcnIuc3RhY2spOyAvLyBjcmVkZW50aWFscyBub3QgbG9hZGVkCiAgICAgKiAgICAgZWxzZSBjb25zb2xlLmxvZygiQWNjZXNzIEtleToiLCBBV1MuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkKTsKICAgICAqICAgfSkKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIENhbGxlZCB3aGVuIHRoZSB7Y3JlZGVudGlhbHN9IGhhdmUgYmVlbiBwcm9wZXJseSBzZXQgb24gdGhlIGNvbmZpZ3VyYXRpb24KICAgICAqICAgb2JqZWN0LgogICAgICoKICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIHRoaXMgaXMgc2V0LCBjcmVkZW50aWFscyB3ZXJlIG5vdCBzdWNjZXNzZnVsbHkKICAgICAqICAgICBsb2FkZWQgYW5kIHRoaXMgZXJyb3IgcHJvdmlkZXMgaW5mb3JtYXRpb24gd2h5LgogICAgICogQHNlZSBjcmVkZW50aWFscwogICAgICogQHNlZSBDcmVkZW50aWFscwogICAgICovCiAgICBnZXRDcmVkZW50aWFsczogZnVuY3Rpb24gZ2V0Q3JlZGVudGlhbHMoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogIAogICAgICBmdW5jdGlvbiBmaW5pc2goZXJyKSB7CiAgICAgICAgY2FsbGJhY2soZXJyLCBlcnIgPyBudWxsIDogc2VsZi5jcmVkZW50aWFscyk7CiAgICAgIH0KICAKICAgICAgZnVuY3Rpb24gY3JlZEVycm9yKG1zZywgZXJyKSB7CiAgICAgICAgcmV0dXJuIG5ldyBBV1MudXRpbC5lcnJvcihlcnIgfHwgbmV3IEVycm9yKCksIHsKICAgICAgICAgIGNvZGU6ICdDcmVkZW50aWFsc0Vycm9yJywKICAgICAgICAgIG1lc3NhZ2U6IG1zZywKICAgICAgICAgIG5hbWU6ICdDcmVkZW50aWFsc0Vycm9yJwogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIGZ1bmN0aW9uIGdldEFzeW5jQ3JlZGVudGlhbHMoKSB7CiAgICAgICAgc2VsZi5jcmVkZW50aWFscy5nZXQoZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIHZhciBtc2cgPSAnQ291bGQgbm90IGxvYWQgY3JlZGVudGlhbHMgZnJvbSAnICsKICAgICAgICAgICAgICBzZWxmLmNyZWRlbnRpYWxzLmNvbnN0cnVjdG9yLm5hbWU7CiAgICAgICAgICAgIGVyciA9IGNyZWRFcnJvcihtc2csIGVycik7CiAgICAgICAgICB9CiAgICAgICAgICBmaW5pc2goZXJyKTsKICAgICAgICB9KTsKICAgICAgfQogIAogICAgICBmdW5jdGlvbiBnZXRTdGF0aWNDcmVkZW50aWFscygpIHsKICAgICAgICB2YXIgZXJyID0gbnVsbDsKICAgICAgICBpZiAoIXNlbGYuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgfHwgIXNlbGYuY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5KSB7CiAgICAgICAgICBlcnIgPSBjcmVkRXJyb3IoJ01pc3NpbmcgY3JlZGVudGlhbHMnKTsKICAgICAgICB9CiAgICAgICAgZmluaXNoKGVycik7CiAgICAgIH0KICAKICAgICAgaWYgKHNlbGYuY3JlZGVudGlhbHMpIHsKICAgICAgICBpZiAodHlwZW9mIHNlbGYuY3JlZGVudGlhbHMuZ2V0ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBnZXRBc3luY0NyZWRlbnRpYWxzKCk7CiAgICAgICAgfSBlbHNlIHsgLy8gc3RhdGljIGNyZWRlbnRpYWxzCiAgICAgICAgICBnZXRTdGF0aWNDcmVkZW50aWFscygpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChzZWxmLmNyZWRlbnRpYWxQcm92aWRlcikgewogICAgICAgIHNlbGYuY3JlZGVudGlhbFByb3ZpZGVyLnJlc29sdmUoZnVuY3Rpb24oZXJyLCBjcmVkcykgewogICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICBlcnIgPSBjcmVkRXJyb3IoJ0NvdWxkIG5vdCBsb2FkIGNyZWRlbnRpYWxzIGZyb20gYW55IHByb3ZpZGVycycsIGVycik7CiAgICAgICAgICB9CiAgICAgICAgICBzZWxmLmNyZWRlbnRpYWxzID0gY3JlZHM7CiAgICAgICAgICBmaW5pc2goZXJyKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmaW5pc2goY3JlZEVycm9yKCdObyBjcmVkZW50aWFscyB0byBsb2FkJykpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAIWdyb3VwIExvYWRpbmcgYW5kIFNldHRpbmcgQ29uZmlndXJhdGlvbiBPcHRpb25zCiAgICAgKi8KICAKICAgIC8qKgogICAgICogQG92ZXJsb2FkIHVwZGF0ZShvcHRpb25zLCBhbGxvd1Vua25vd25LZXlzID0gZmFsc2UpCiAgICAgKiAgIFVwZGF0ZXMgdGhlIGN1cnJlbnQgY29uZmlndXJhdGlvbiBvYmplY3Qgd2l0aCBuZXcgb3B0aW9ucy4KICAgICAqCiAgICAgKiAgIEBleGFtcGxlIFVwZGF0ZSBtYXhSZXRyaWVzIHByb3BlcnR5IG9mIGEgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAqICAgICBjb25maWcudXBkYXRlKHttYXhSZXRyaWVzOiAxMH0pOwogICAgICogICBAcGFyYW0gW09iamVjdF0gb3B0aW9ucyBhIG1hcCBvZiBvcHRpb24ga2V5cyBhbmQgdmFsdWVzLgogICAgICogICBAcGFyYW0gW0Jvb2xlYW5dIGFsbG93VW5rbm93bktleXMgd2hldGhlciB1bmtub3duIGtleXMgY2FuIGJlIHNldCBvbgogICAgICogICAgIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdC4gRGVmYXVsdHMgdG8gYGZhbHNlYC4KICAgICAqICAgQHNlZSBjb25zdHJ1Y3RvcgogICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShvcHRpb25zLCBhbGxvd1Vua25vd25LZXlzKSB7CiAgICAgIGFsbG93VW5rbm93bktleXMgPSBhbGxvd1Vua25vd25LZXlzIHx8IGZhbHNlOwogICAgICBvcHRpb25zID0gdGhpcy5leHRyYWN0Q3JlZGVudGlhbHMob3B0aW9ucyk7CiAgICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCBvcHRpb25zLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgIGlmIChhbGxvd1Vua25vd25LZXlzIHx8IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLmtleXMsIGtleSkgfHwKICAgICAgICAgICAgQVdTLlNlcnZpY2UuaGFzU2VydmljZShrZXkpKSB7CiAgICAgICAgICB0aGlzLnNldChrZXksIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogTG9hZHMgY29uZmlndXJhdGlvbiBkYXRhIGZyb20gYSBKU09OIGZpbGUgaW50byB0aGlzIGNvbmZpZyBvYmplY3QuCiAgICAgKiBAbm90ZSBMb2FkaW5nIGNvbmZpZ3VyYXRpb24gd2lsbCByZXNldCBhbGwgZXhpc3RpbmcgY29uZmlndXJhdGlvbgogICAgICogICBvbiB0aGUgb2JqZWN0LgogICAgICogQCFtYWNybyBub2Jyb3dzZXIKICAgICAqIEBwYXJhbSBwYXRoIFtTdHJpbmddIHRoZSBwYXRoIHJlbGF0aXZlIHRvIHlvdXIgcHJvY2VzcydzIGN1cnJlbnQKICAgICAqICAgIHdvcmtpbmcgZGlyZWN0b3J5IHRvIGxvYWQgY29uZmlndXJhdGlvbiBmcm9tLgogICAgICogQHJldHVybiBbQVdTLkNvbmZpZ10gdGhlIHNhbWUgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAqLwogICAgbG9hZEZyb21QYXRoOiBmdW5jdGlvbiBsb2FkRnJvbVBhdGgocGF0aCkgewogICAgICB0aGlzLmNsZWFyKCk7CiAgCiAgICAgIHZhciBvcHRpb25zID0gSlNPTi5wYXJzZShBV1MudXRpbC5yZWFkRmlsZVN5bmMocGF0aCkpOwogICAgICB2YXIgZmlsZVN5c3RlbUNyZWRzID0gbmV3IEFXUy5GaWxlU3lzdGVtQ3JlZGVudGlhbHMocGF0aCk7CiAgICAgIHZhciBjaGFpbiA9IG5ldyBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4oKTsKICAgICAgY2hhaW4ucHJvdmlkZXJzLnVuc2hpZnQoZmlsZVN5c3RlbUNyZWRzKTsKICAgICAgY2hhaW4ucmVzb2x2ZShmdW5jdGlvbiAoZXJyLCBjcmVkcykgewogICAgICAgIGlmIChlcnIpIHRocm93IGVycjsKICAgICAgICBlbHNlIG9wdGlvbnMuY3JlZGVudGlhbHMgPSBjcmVkczsKICAgICAgfSk7CiAgCiAgICAgIHRoaXMuY29uc3RydWN0b3Iob3B0aW9ucyk7CiAgCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8qKgogICAgICogQ2xlYXJzIGNvbmZpZ3VyYXRpb24gZGF0YSBvbiB0aGlzIG9iamVjdAogICAgICoKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjbGVhcjogZnVuY3Rpb24gY2xlYXIoKSB7CiAgICAgIC8qanNoaW50IGZvcmluOmZhbHNlICovCiAgICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLmtleXMsIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBkZWxldGUgdGhpc1trZXldOwogICAgICB9KTsKICAKICAgICAgLy8gcmVzZXQgY3JlZGVudGlhbCBwcm92aWRlcgogICAgICB0aGlzLnNldCgnY3JlZGVudGlhbHMnLCB1bmRlZmluZWQpOwogICAgICB0aGlzLnNldCgnY3JlZGVudGlhbFByb3ZpZGVyJywgdW5kZWZpbmVkKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFNldHMgYSBwcm9wZXJ0eSBvbiB0aGUgY29uZmlndXJhdGlvbiBvYmplY3QsIGFsbG93aW5nIGZvciBhCiAgICAgKiBkZWZhdWx0IHZhbHVlCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc2V0OiBmdW5jdGlvbiBzZXQocHJvcGVydHksIHZhbHVlLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAoZGVmYXVsdFZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGRlZmF1bHRWYWx1ZSA9IHRoaXMua2V5c1twcm9wZXJ0eV07CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgZGVmYXVsdFZhbHVlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICB0aGlzW3Byb3BlcnR5XSA9IGRlZmF1bHRWYWx1ZS5jYWxsKHRoaXMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzW3Byb3BlcnR5XSA9IGRlZmF1bHRWYWx1ZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAocHJvcGVydHkgPT09ICdodHRwT3B0aW9ucycgJiYgdGhpc1twcm9wZXJ0eV0pIHsKICAgICAgICAvLyBkZWVwIG1lcmdlIGh0dHBPcHRpb25zCiAgICAgICAgdGhpc1twcm9wZXJ0eV0gPSBBV1MudXRpbC5tZXJnZSh0aGlzW3Byb3BlcnR5XSwgdmFsdWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXNbcHJvcGVydHldID0gdmFsdWU7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEFsbCBvZiB0aGUga2V5cyB3aXRoIHRoZWlyIGRlZmF1bHQgdmFsdWVzLgogICAgICoKICAgICAqIEBjb25zdGFudAogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGtleXM6IHsKICAgICAgY3JlZGVudGlhbHM6IG51bGwsCiAgICAgIGNyZWRlbnRpYWxQcm92aWRlcjogbnVsbCwKICAgICAgcmVnaW9uOiBudWxsLAogICAgICBsb2dnZXI6IG51bGwsCiAgICAgIGFwaVZlcnNpb25zOiB7fSwKICAgICAgYXBpVmVyc2lvbjogbnVsbCwKICAgICAgZW5kcG9pbnQ6IHVuZGVmaW5lZCwKICAgICAgaHR0cE9wdGlvbnM6IHsKICAgICAgICB0aW1lb3V0OiAxMjAwMDAKICAgICAgfSwKICAgICAgbWF4UmV0cmllczogdW5kZWZpbmVkLAogICAgICBtYXhSZWRpcmVjdHM6IDEwLAogICAgICBwYXJhbVZhbGlkYXRpb246IHRydWUsCiAgICAgIHNzbEVuYWJsZWQ6IHRydWUsCiAgICAgIHMzRm9yY2VQYXRoU3R5bGU6IGZhbHNlLAogICAgICBzM0J1Y2tldEVuZHBvaW50OiBmYWxzZSwKICAgICAgczNEaXNhYmxlQm9keVNpZ25pbmc6IHRydWUsCiAgICAgIGNvbXB1dGVDaGVja3N1bXM6IHRydWUsCiAgICAgIGNvbnZlcnRSZXNwb25zZVR5cGVzOiB0cnVlLAogICAgICBjb3JyZWN0Q2xvY2tTa2V3OiBmYWxzZSwKICAgICAgY3VzdG9tVXNlckFnZW50OiBudWxsLAogICAgICBkeW5hbW9EYkNyYzMyOiB0cnVlLAogICAgICBzeXN0ZW1DbG9ja09mZnNldDogMCwKICAgICAgc2lnbmF0dXJlVmVyc2lvbjogbnVsbCwKICAgICAgc2lnbmF0dXJlQ2FjaGU6IHRydWUsCiAgICAgIHJldHJ5RGVsYXlPcHRpb25zOiB7fSwKICAgICAgdXNlQWNjZWxlcmF0ZUVuZHBvaW50OiBmYWxzZSwKICAgICAgY2xpZW50U2lkZU1vbml0b3Jpbmc6IGZhbHNlLAogICAgICBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWQ6IGZhbHNlLAogICAgICBlbmRwb2ludENhY2hlU2l6ZTogMTAwMCwKICAgICAgaG9zdFByZWZpeEVuYWJsZWQ6IHRydWUsCiAgICAgIHN0c1JlZ2lvbmFsRW5kcG9pbnRzOiBudWxsCiAgICB9LAogIAogICAgLyoqCiAgICAgKiBFeHRyYWN0cyBhY2Nlc3NLZXlJZCwgc2VjcmV0QWNjZXNzS2V5IGFuZCBzZXNzaW9uVG9rZW4KICAgICAqIGZyb20gYSBjb25maWd1cmF0aW9uIGhhc2guCiAgICAgKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGV4dHJhY3RDcmVkZW50aWFsczogZnVuY3Rpb24gZXh0cmFjdENyZWRlbnRpYWxzKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMuYWNjZXNzS2V5SWQgJiYgb3B0aW9ucy5zZWNyZXRBY2Nlc3NLZXkpIHsKICAgICAgICBvcHRpb25zID0gQVdTLnV0aWwuY29weShvcHRpb25zKTsKICAgICAgICBvcHRpb25zLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5DcmVkZW50aWFscyhvcHRpb25zKTsKICAgICAgfQogICAgICByZXR1cm4gb3B0aW9uczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFNldHMgdGhlIHByb21pc2UgZGVwZW5kZW5jeSB0aGUgU0RLIHdpbGwgdXNlIHdoZXJldmVyIFByb21pc2VzIGFyZSByZXR1cm5lZC4KICAgICAqIFBhc3NpbmcgYG51bGxgIHdpbGwgZm9yY2UgdGhlIFNESyB0byB1c2UgbmF0aXZlIFByb21pc2VzIGlmIHRoZXkgYXJlIGF2YWlsYWJsZS4KICAgICAqIElmIG5hdGl2ZSBQcm9taXNlcyBhcmUgbm90IGF2YWlsYWJsZSwgcGFzc2luZyBgbnVsbGAgd2lsbCBoYXZlIG5vIGVmZmVjdC4KICAgICAqIEBwYXJhbSBbQ29uc3RydWN0b3JdIGRlcCBBIHJlZmVyZW5jZSB0byBhIFByb21pc2UgY29uc3RydWN0b3IKICAgICAqLwogICAgc2V0UHJvbWlzZXNEZXBlbmRlbmN5OiBmdW5jdGlvbiBzZXRQcm9taXNlc0RlcGVuZGVuY3koZGVwKSB7CiAgICAgIFByb21pc2VzRGVwZW5kZW5jeSA9IGRlcDsKICAgICAgLy8gaWYgbnVsbCB3YXMgcGFzc2VkIGluLCB3ZSBzaG91bGQgdHJ5IHRvIHVzZSBuYXRpdmUgcHJvbWlzZXMKICAgICAgaWYgKGRlcCA9PT0gbnVsbCAmJiB0eXBlb2YgUHJvbWlzZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIFByb21pc2VzRGVwZW5kZW5jeSA9IFByb21pc2U7CiAgICAgIH0KICAgICAgdmFyIGNvbnN0cnVjdG9ycyA9IFtBV1MuUmVxdWVzdCwgQVdTLkNyZWRlbnRpYWxzLCBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW5dOwogICAgICBpZiAoQVdTLlMzKSB7CiAgICAgICAgY29uc3RydWN0b3JzLnB1c2goQVdTLlMzKTsKICAgICAgICBpZiAoQVdTLlMzLk1hbmFnZWRVcGxvYWQpIHsKICAgICAgICAgIGNvbnN0cnVjdG9ycy5wdXNoKEFXUy5TMy5NYW5hZ2VkVXBsb2FkKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgQVdTLnV0aWwuYWRkUHJvbWlzZXMoY29uc3RydWN0b3JzLCBQcm9taXNlc0RlcGVuZGVuY3kpOwogICAgfSwKICAKICAgIC8qKgogICAgICogR2V0cyB0aGUgcHJvbWlzZSBkZXBlbmRlbmN5IHNldCBieSBgQVdTLmNvbmZpZy5zZXRQcm9taXNlc0RlcGVuZGVuY3lgLgogICAgICovCiAgICBnZXRQcm9taXNlc0RlcGVuZGVuY3k6IGZ1bmN0aW9uIGdldFByb21pc2VzRGVwZW5kZW5jeSgpIHsKICAgICAgcmV0dXJuIFByb21pc2VzRGVwZW5kZW5jeTsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAcmV0dXJuIFtBV1MuQ29uZmlnXSBUaGUgZ2xvYmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0IHNpbmdsZXRvbiBpbnN0YW5jZQogICAqIEByZWFkb25seQogICAqIEBzZWUgQVdTLkNvbmZpZwogICAqLwogIEFXUy5jb25maWcgPSBuZXcgQVdTLkNvbmZpZygpOwogIAogIH0seyIuL2NvcmUiOjE4LCIuL2NyZWRlbnRpYWxzIjoxOSwiLi9jcmVkZW50aWFscy9jcmVkZW50aWFsX3Byb3ZpZGVyX2NoYWluIjoyMn1dLDE4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvKioKICAgKiBUaGUgbWFpbiBBV1MgbmFtZXNwYWNlCiAgICovCiAgdmFyIEFXUyA9IHsgdXRpbDogcmVxdWlyZSgnLi91dGlsJykgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAIW1hY3JvIFtuZXddIG5vYnJvd3NlcgogICAqICAgQG5vdGUgVGhpcyBmZWF0dXJlIGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQgb2YgdGhlIFNESy4KICAgKi8KICB2YXIgX2hpZGRlbiA9IHt9OyBfaGlkZGVuLnRvU3RyaW5nKCk7IC8vIGhhY2sgdG8gcGFyc2UgbWFjcm8KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUzsKICAKICBBV1MudXRpbC51cGRhdGUoQVdTLCB7CiAgCiAgICAvKioKICAgICAqIEBjb25zdGFudAogICAgICovCiAgICBWRVJTSU9OOiAnMi41NTMuMCcsCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBTaWduZXJzOiB7fSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIFByb3RvY29sOiB7CiAgICAgIEpzb246IHJlcXVpcmUoJy4vcHJvdG9jb2wvanNvbicpLAogICAgICBRdWVyeTogcmVxdWlyZSgnLi9wcm90b2NvbC9xdWVyeScpLAogICAgICBSZXN0OiByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3QnKSwKICAgICAgUmVzdEpzb246IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdF9qc29uJyksCiAgICAgIFJlc3RYbWw6IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdF94bWwnKQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIFhNTDogewogICAgICBCdWlsZGVyOiByZXF1aXJlKCcuL3htbC9idWlsZGVyJyksCiAgICAgIFBhcnNlcjogbnVsbCAvLyBjb25kaXRpb25hbGx5IHNldCBiYXNlZCBvbiBlbnZpcm9ubWVudAogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIEpTT046IHsKICAgICAgQnVpbGRlcjogcmVxdWlyZSgnLi9qc29uL2J1aWxkZXInKSwKICAgICAgUGFyc2VyOiByZXF1aXJlKCcuL2pzb24vcGFyc2VyJykKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBNb2RlbDogewogICAgICBBcGk6IHJlcXVpcmUoJy4vbW9kZWwvYXBpJyksCiAgICAgIE9wZXJhdGlvbjogcmVxdWlyZSgnLi9tb2RlbC9vcGVyYXRpb24nKSwKICAgICAgU2hhcGU6IHJlcXVpcmUoJy4vbW9kZWwvc2hhcGUnKSwKICAgICAgUGFnaW5hdG9yOiByZXF1aXJlKCcuL21vZGVsL3BhZ2luYXRvcicpLAogICAgICBSZXNvdXJjZVdhaXRlcjogcmVxdWlyZSgnLi9tb2RlbC9yZXNvdXJjZV93YWl0ZXInKQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwaUxvYWRlcjogcmVxdWlyZSgnLi9hcGlfbG9hZGVyJyksCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBFbmRwb2ludENhY2hlOiByZXF1aXJlKCcuLi92ZW5kb3IvZW5kcG9pbnQtY2FjaGUnKS5FbmRwb2ludENhY2hlCiAgfSk7CiAgcmVxdWlyZSgnLi9zZXF1ZW50aWFsX2V4ZWN1dG9yJyk7CiAgcmVxdWlyZSgnLi9zZXJ2aWNlJyk7CiAgcmVxdWlyZSgnLi9jb25maWcnKTsKICByZXF1aXJlKCcuL2h0dHAnKTsKICByZXF1aXJlKCcuL2V2ZW50X2xpc3RlbmVycycpOwogIHJlcXVpcmUoJy4vcmVxdWVzdCcpOwogIHJlcXVpcmUoJy4vcmVzcG9uc2UnKTsKICByZXF1aXJlKCcuL3Jlc291cmNlX3dhaXRlcicpOwogIHJlcXVpcmUoJy4vc2lnbmVycy9yZXF1ZXN0X3NpZ25lcicpOwogIHJlcXVpcmUoJy4vcGFyYW1fdmFsaWRhdG9yJyk7CiAgCiAgLyoqCiAgICogQHJlYWRvbmx5CiAgICogQHJldHVybiBbQVdTLlNlcXVlbnRpYWxFeGVjdXRvcl0gYSBjb2xsZWN0aW9uIG9mIGdsb2JhbCBldmVudCBsaXN0ZW5lcnMgdGhhdAogICAqICAgYXJlIGF0dGFjaGVkIHRvIGV2ZXJ5IHNlbnQgcmVxdWVzdC4KICAgKiBAc2VlIEFXUy5SZXF1ZXN0IEFXUy5SZXF1ZXN0IGZvciBhIGxpc3Qgb2YgZXZlbnRzIHRvIGxpc3RlbiBmb3IKICAgKiBAZXhhbXBsZSBMb2dnaW5nIHRoZSB0aW1lIHRha2VuIHRvIHNlbmQgYSByZXF1ZXN0CiAgICogICBBV1MuZXZlbnRzLm9uKCdzZW5kJywgZnVuY3Rpb24gc3RhcnRTZW5kKHJlc3ApIHsKICAgKiAgICAgcmVzcC5zdGFydFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgKiAgIH0pLm9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uIGNhbGN1bGF0ZVRpbWUocmVzcCkgewogICAqICAgICB2YXIgdGltZSA9IChuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHJlc3Auc3RhcnRUaW1lKSAvIDEwMDA7CiAgICogICAgIGNvbnNvbGUubG9nKCdSZXF1ZXN0IHRvb2sgJyArIHRpbWUgKyAnIHNlY29uZHMnKTsKICAgKiAgIH0pOwogICAqCiAgICogICBuZXcgQVdTLlMzKCkubGlzdEJ1Y2tldHMoKTsgLy8gcHJpbnRzICdSZXF1ZXN0IHRvb2sgMC4yODUgc2Vjb25kcycKICAgKi8KICBBV1MuZXZlbnRzID0gbmV3IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IoKTsKICAKICAvL2NyZWF0ZSBlbmRwb2ludCBjYWNoZSBsYXppbHkKICBBV1MudXRpbC5tZW1vaXplZFByb3BlcnR5KEFXUywgJ2VuZHBvaW50Q2FjaGUnLCBmdW5jdGlvbigpIHsKICAgIHJldHVybiBuZXcgQVdTLkVuZHBvaW50Q2FjaGUoQVdTLmNvbmZpZy5lbmRwb2ludENhY2hlU2l6ZSk7CiAgfSwgdHJ1ZSk7CiAgCiAgfSx7Ii4uL3ZlbmRvci9lbmRwb2ludC1jYWNoZSI6MTAzLCIuL2FwaV9sb2FkZXIiOjksIi4vY29uZmlnIjoxNywiLi9ldmVudF9saXN0ZW5lcnMiOjMzLCIuL2h0dHAiOjM0LCIuL2pzb24vYnVpbGRlciI6MzYsIi4vanNvbi9wYXJzZXIiOjM3LCIuL21vZGVsL2FwaSI6MzgsIi4vbW9kZWwvb3BlcmF0aW9uIjo0MCwiLi9tb2RlbC9wYWdpbmF0b3IiOjQxLCIuL21vZGVsL3Jlc291cmNlX3dhaXRlciI6NDIsIi4vbW9kZWwvc2hhcGUiOjQzLCIuL3BhcmFtX3ZhbGlkYXRvciI6NDQsIi4vcHJvdG9jb2wvanNvbiI6NDYsIi4vcHJvdG9jb2wvcXVlcnkiOjQ3LCIuL3Byb3RvY29sL3Jlc3QiOjQ4LCIuL3Byb3RvY29sL3Jlc3RfanNvbiI6NDksIi4vcHJvdG9jb2wvcmVzdF94bWwiOjUwLCIuL3JlcXVlc3QiOjU1LCIuL3Jlc291cmNlX3dhaXRlciI6NTYsIi4vcmVzcG9uc2UiOjU3LCIuL3NlcXVlbnRpYWxfZXhlY3V0b3IiOjU4LCIuL3NlcnZpY2UiOjU5LCIuL3NpZ25lcnMvcmVxdWVzdF9zaWduZXIiOjYzLCIuL3V0aWwiOjcxLCIuL3htbC9idWlsZGVyIjo3M31dLDE5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyB5b3VyIEFXUyBzZWN1cml0eSBjcmVkZW50aWFscywgc3BlY2lmaWNhbGx5IHRoZQogICAqIHthY2Nlc3NLZXlJZH0sIHtzZWNyZXRBY2Nlc3NLZXl9LCBhbmQgb3B0aW9uYWwge3Nlc3Npb25Ub2tlbn0uCiAgICogQ3JlYXRpbmcgYSBgQ3JlZGVudGlhbHNgIG9iamVjdCBhbGxvd3MgeW91IHRvIHBhc3MgYXJvdW5kIHlvdXIKICAgKiBzZWN1cml0eSBpbmZvcm1hdGlvbiB0byBjb25maWd1cmF0aW9uIGFuZCBzZXJ2aWNlIG9iamVjdHMuCiAgICoKICAgKiBOb3RlIHRoYXQgdGhpcyBjbGFzcyB0eXBpY2FsbHkgZG9lcyBub3QgbmVlZCB0byBiZSBjb25zdHJ1Y3RlZCBtYW51YWxseSwKICAgKiBhcyB0aGUge0FXUy5Db25maWd9IGFuZCB7QVdTLlNlcnZpY2V9IGNsYXNzZXMgYm90aCBhY2NlcHQgc2ltcGxlCiAgICogb3B0aW9ucyBoYXNoZXMgd2l0aCB0aGUgdGhyZWUga2V5cy4gVGhlc2Ugc3RydWN0dXJlcyB3aWxsIGJlIGNvbnZlcnRlZAogICAqIGludG8gQ3JlZGVudGlhbHMgb2JqZWN0cyBhdXRvbWF0aWNhbGx5LgogICAqCiAgICogIyMgRXhwaXJpbmcgYW5kIFJlZnJlc2hpbmcgQ3JlZGVudGlhbHMKICAgKgogICAqIE9jY2FzaW9uYWxseSBjcmVkZW50aWFscyBjYW4gZXhwaXJlIGluIHRoZSBtaWRkbGUgb2YgYSBsb25nLXJ1bm5pbmcKICAgKiBhcHBsaWNhdGlvbi4gSW4gdGhpcyBjYXNlLCB0aGUgU0RLIHdpbGwgYXV0b21hdGljYWxseSBhdHRlbXB0IHRvCiAgICogcmVmcmVzaCB0aGUgY3JlZGVudGlhbHMgZnJvbSB0aGUgc3RvcmFnZSBsb2NhdGlvbiBpZiB0aGUgQ3JlZGVudGlhbHMKICAgKiBjbGFzcyBpbXBsZW1lbnRzIHRoZSB7cmVmcmVzaH0gbWV0aG9kLgogICAqCiAgICogSWYgeW91IGFyZSBpbXBsZW1lbnRpbmcgYSBjcmVkZW50aWFsIHN0b3JhZ2UgbG9jYXRpb24sIHlvdQogICAqIHdpbGwgd2FudCB0byBjcmVhdGUgYSBzdWJjbGFzcyBvZiB0aGUgYENyZWRlbnRpYWxzYCBjbGFzcyBhbmQKICAgKiBvdmVycmlkZSB0aGUge3JlZnJlc2h9IG1ldGhvZC4gVGhpcyBtZXRob2QgYWxsb3dzIGNyZWRlbnRpYWxzIHRvIGJlCiAgICogcmV0cmlldmVkIGZyb20gdGhlIGJhY2tpbmcgc3RvcmUsIGJlIGl0IGEgZmlsZSBzeXN0ZW0sIGRhdGFiYXNlLCBvcgogICAqIHNvbWUgbmV0d29yayBzdG9yYWdlLiBUaGUgbWV0aG9kIHNob3VsZCByZXNldCB0aGUgY3JlZGVudGlhbCBhdHRyaWJ1dGVzCiAgICogb24gdGhlIG9iamVjdC4KICAgKgogICAqIEAhYXR0cmlidXRlIGV4cGlyZWQKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIGNyZWRlbnRpYWxzIGhhdmUgYmVlbiBleHBpcmVkIGFuZAogICAqICAgICByZXF1aXJlIGEgcmVmcmVzaC4gVXNlZCBpbiBjb25qdW5jdGlvbiB3aXRoIHtleHBpcmVUaW1lfS4KICAgKiBAIWF0dHJpYnV0ZSBleHBpcmVUaW1lCiAgICogICBAcmV0dXJuIFtEYXRlXSBhIHRpbWUgd2hlbiBjcmVkZW50aWFscyBzaG91bGQgYmUgY29uc2lkZXJlZCBleHBpcmVkLiBVc2VkCiAgICogICAgIGluIGNvbmp1bmN0aW9uIHdpdGgge2V4cGlyZWR9LgogICAqIEAhYXR0cmlidXRlIGFjY2Vzc0tleUlkCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBBV1MgYWNjZXNzIGtleSBJRAogICAqIEAhYXR0cmlidXRlIHNlY3JldEFjY2Vzc0tleQogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgQVdTIHNlY3JldCBhY2Nlc3Mga2V5CiAgICogQCFhdHRyaWJ1dGUgc2Vzc2lvblRva2VuCiAgICogICBAcmV0dXJuIFtTdHJpbmddIGFuIG9wdGlvbmFsIEFXUyBzZXNzaW9uIHRva2VuCiAgICovCiAgQVdTLkNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdCh7CiAgICAvKioKICAgICAqIEEgY3JlZGVudGlhbHMgb2JqZWN0IGNhbiBiZSBjcmVhdGVkIHVzaW5nIHBvc2l0aW9uYWwgYXJndW1lbnRzIG9yIGFuIG9wdGlvbnMKICAgICAqIGhhc2guCiAgICAgKgogICAgICogQG92ZXJsb2FkIEFXUy5DcmVkZW50aWFscyhhY2Nlc3NLZXlJZCwgc2VjcmV0QWNjZXNzS2V5LCBzZXNzaW9uVG9rZW49bnVsbCkKICAgICAqICAgQ3JlYXRlcyBhIENyZWRlbnRpYWxzIG9iamVjdCB3aXRoIGEgZ2l2ZW4gc2V0IG9mIGNyZWRlbnRpYWwgaW5mb3JtYXRpb24KICAgICAqICAgYXMgcG9zaXRpb25hbCBhcmd1bWVudHMuCiAgICAgKiAgIEBwYXJhbSBhY2Nlc3NLZXlJZCBbU3RyaW5nXSB0aGUgQVdTIGFjY2VzcyBrZXkgSUQKICAgICAqICAgQHBhcmFtIHNlY3JldEFjY2Vzc0tleSBbU3RyaW5nXSB0aGUgQVdTIHNlY3JldCBhY2Nlc3Mga2V5CiAgICAgKiAgIEBwYXJhbSBzZXNzaW9uVG9rZW4gW1N0cmluZ10gdGhlIG9wdGlvbmFsIEFXUyBzZXNzaW9uIHRva2VuCiAgICAgKiAgIEBleGFtcGxlIENyZWF0ZSBhIGNyZWRlbnRpYWxzIG9iamVjdCB3aXRoIEFXUyBjcmVkZW50aWFscwogICAgICogICAgIHZhciBjcmVkcyA9IG5ldyBBV1MuQ3JlZGVudGlhbHMoJ2FraWQnLCAnc2VjcmV0JywgJ3Nlc3Npb24nKTsKICAgICAqIEBvdmVybG9hZCBBV1MuQ3JlZGVudGlhbHMob3B0aW9ucykKICAgICAqICAgQ3JlYXRlcyBhIENyZWRlbnRpYWxzIG9iamVjdCB3aXRoIGEgZ2l2ZW4gc2V0IG9mIGNyZWRlbnRpYWwgaW5mb3JtYXRpb24KICAgICAqICAgYXMgYW4gb3B0aW9ucyBoYXNoLgogICAgICogICBAb3B0aW9uIG9wdGlvbnMgYWNjZXNzS2V5SWQgW1N0cmluZ10gdGhlIEFXUyBhY2Nlc3Mga2V5IElECiAgICAgKiAgIEBvcHRpb24gb3B0aW9ucyBzZWNyZXRBY2Nlc3NLZXkgW1N0cmluZ10gdGhlIEFXUyBzZWNyZXQgYWNjZXNzIGtleQogICAgICogICBAb3B0aW9uIG9wdGlvbnMgc2Vzc2lvblRva2VuIFtTdHJpbmddIHRoZSBvcHRpb25hbCBBV1Mgc2Vzc2lvbiB0b2tlbgogICAgICogICBAZXhhbXBsZSBDcmVhdGUgYSBjcmVkZW50aWFscyBvYmplY3Qgd2l0aCBBV1MgY3JlZGVudGlhbHMKICAgICAqICAgICB2YXIgY3JlZHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKHsKICAgICAqICAgICAgIGFjY2Vzc0tleUlkOiAnYWtpZCcsIHNlY3JldEFjY2Vzc0tleTogJ3NlY3JldCcsIHNlc3Npb25Ub2tlbjogJ3Nlc3Npb24nCiAgICAgKiAgICAgfSk7CiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDcmVkZW50aWFscygpIHsKICAgICAgLy8gaGlkZSBzZWNyZXRBY2Nlc3NLZXkgZnJvbSBiZWluZyBkaXNwbGF5ZWQgd2l0aCB1dGlsLmluc3BlY3QKICAgICAgQVdTLnV0aWwuaGlkZVByb3BlcnRpZXModGhpcywgWydzZWNyZXRBY2Nlc3NLZXknXSk7CiAgCiAgICAgIHRoaXMuZXhwaXJlZCA9IGZhbHNlOwogICAgICB0aGlzLmV4cGlyZVRpbWUgPSBudWxsOwogICAgICB0aGlzLnJlZnJlc2hDYWxsYmFja3MgPSBbXTsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEgJiYgdHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gJ29iamVjdCcpIHsKICAgICAgICB2YXIgY3JlZHMgPSBhcmd1bWVudHNbMF0uY3JlZGVudGlhbHMgfHwgYXJndW1lbnRzWzBdOwogICAgICAgIHRoaXMuYWNjZXNzS2V5SWQgPSBjcmVkcy5hY2Nlc3NLZXlJZDsKICAgICAgICB0aGlzLnNlY3JldEFjY2Vzc0tleSA9IGNyZWRzLnNlY3JldEFjY2Vzc0tleTsKICAgICAgICB0aGlzLnNlc3Npb25Ub2tlbiA9IGNyZWRzLnNlc3Npb25Ub2tlbjsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmFjY2Vzc0tleUlkID0gYXJndW1lbnRzWzBdOwogICAgICAgIHRoaXMuc2VjcmV0QWNjZXNzS2V5ID0gYXJndW1lbnRzWzFdOwogICAgICAgIHRoaXMuc2Vzc2lvblRva2VuID0gYXJndW1lbnRzWzJdOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbnVtYmVyIG9mIHNlY29uZHMgYmVmb3JlIHtleHBpcmVUaW1lfSBkdXJpbmcgd2hpY2gKICAgICAqICAgdGhlIGNyZWRlbnRpYWxzIHdpbGwgYmUgY29uc2lkZXJlZCBleHBpcmVkLgogICAgICovCiAgICBleHBpcnlXaW5kb3c6IDE1LAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBjcmVkZW50aWFscyBvYmplY3Qgc2hvdWxkIGNhbGwge3JlZnJlc2h9CiAgICAgKiBAbm90ZSBTdWJjbGFzc2VzIHNob3VsZCBvdmVycmlkZSB0aGlzIG1ldGhvZCB0byBwcm92aWRlIGN1c3RvbSByZWZyZXNoCiAgICAgKiAgIGxvZ2ljLgogICAgICovCiAgICBuZWVkc1JlZnJlc2g6IGZ1bmN0aW9uIG5lZWRzUmVmcmVzaCgpIHsKICAgICAgdmFyIGN1cnJlbnRUaW1lID0gQVdTLnV0aWwuZGF0ZS5nZXREYXRlKCkuZ2V0VGltZSgpOwogICAgICB2YXIgYWRqdXN0ZWRUaW1lID0gbmV3IERhdGUoY3VycmVudFRpbWUgKyB0aGlzLmV4cGlyeVdpbmRvdyAqIDEwMDApOwogIAogICAgICBpZiAodGhpcy5leHBpcmVUaW1lICYmIGFkanVzdGVkVGltZSA+IHRoaXMuZXhwaXJlVGltZSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmV4cGlyZWQgfHwgIXRoaXMuYWNjZXNzS2V5SWQgfHwgIXRoaXMuc2VjcmV0QWNjZXNzS2V5OwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBleGlzdGluZyBjcmVkZW50aWFscywgcmVmcmVzaGluZyB0aGVtIGlmIHRoZXkgYXJlIG5vdCB5ZXQgbG9hZGVkCiAgICAgKiBvciBoYXZlIGV4cGlyZWQuIFVzZXJzIHNob3VsZCBjYWxsIHRoaXMgbWV0aG9kIGJlZm9yZSB1c2luZyB7cmVmcmVzaH0sCiAgICAgKiBhcyB0aGlzIHdpbGwgbm90IGF0dGVtcHQgdG8gcmVsb2FkIGNyZWRlbnRpYWxzIHdoZW4gdGhleSBhcmUgYWxyZWFkeQogICAgICogbG9hZGVkIGludG8gdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICBXaGVuIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIGVpdGhlciBjcmVkZW50aWFscwogICAgICogICBkbyBub3QgbmVlZCB0byBiZSByZWZyZXNoZWQgb3IgcmVmcmVzaGVkIGNyZWRlbnRpYWxzIGluZm9ybWF0aW9uIGhhcwogICAgICogICBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLCBgc2VjcmV0QWNjZXNzS2V5YCwKICAgICAqICAgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqLwogICAgZ2V0OiBmdW5jdGlvbiBnZXQoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZiAodGhpcy5uZWVkc1JlZnJlc2goKSkgewogICAgICAgIHRoaXMucmVmcmVzaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIGlmICghZXJyKSBzZWxmLmV4cGlyZWQgPSBmYWxzZTsgLy8gcmVzZXQgZXhwaXJlZCBmbGFnCiAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKGVycik7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAoY2FsbGJhY2spIHsKICAgICAgICBjYWxsYmFjaygpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAIW1ldGhvZCAgZ2V0UHJvbWlzZSgpCiAgICAgKiAgIFJldHVybnMgYSAndGhlbmFibGUnIHByb21pc2UuCiAgICAgKiAgIEdldHMgdGhlIGV4aXN0aW5nIGNyZWRlbnRpYWxzLCByZWZyZXNoaW5nIHRoZW0gaWYgdGhleSBhcmUgbm90IHlldCBsb2FkZWQKICAgICAqICAgb3IgaGF2ZSBleHBpcmVkLiBVc2VycyBzaG91bGQgY2FsbCB0aGlzIG1ldGhvZCBiZWZvcmUgdXNpbmcge3JlZnJlc2h9LAogICAgICogICBhcyB0aGlzIHdpbGwgbm90IGF0dGVtcHQgdG8gcmVsb2FkIGNyZWRlbnRpYWxzIHdoZW4gdGhleSBhcmUgYWxyZWFkeQogICAgICogICBsb2FkZWQgaW50byB0aGUgb2JqZWN0LgogICAgICoKICAgICAqICAgVHdvIGNhbGxiYWNrcyBjYW4gYmUgcHJvdmlkZWQgdG8gdGhlIGB0aGVuYCBtZXRob2Qgb24gdGhlIHJldHVybmVkIHByb21pc2UuCiAgICAgKiAgIFRoZSBmaXJzdCBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQsIGFuZCB0aGUgc2Vjb25kCiAgICAgKiAgIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICBAY2FsbGJhY2sgZnVsZmlsbGVkQ2FsbGJhY2sgZnVuY3Rpb24oKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQuIFdoZW4gdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQsIGl0CiAgICAgKiAgICAgbWVhbnMgZWl0aGVyIGNyZWRlbnRpYWxzIGRvIG5vdCBuZWVkIHRvIGJlIHJlZnJlc2hlZCBvciByZWZyZXNoZWQKICAgICAqICAgICBjcmVkZW50aWFscyBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUKICAgICAqICAgICBgYWNjZXNzS2V5SWRgLCBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAY2FsbGJhY2sgcmVqZWN0ZWRDYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogICBAcmV0dXJuIFtQcm9taXNlXSBBIHByb21pc2UgdGhhdCByZXByZXNlbnRzIHRoZSBzdGF0ZSBvZiB0aGUgYGdldGAgY2FsbC4KICAgICAqICAgQGV4YW1wbGUgQ2FsbGluZyB0aGUgYGdldFByb21pc2VgIG1ldGhvZC4KICAgICAqICAgICB2YXIgcHJvbWlzZSA9IGNyZWRQcm92aWRlci5nZXRQcm9taXNlKCk7CiAgICAgKiAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKCkgeyAuLi4gfSwgZnVuY3Rpb24oZXJyKSB7IC4uLiB9KTsKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBAIW1ldGhvZCAgcmVmcmVzaFByb21pc2UoKQogICAgICogICBSZXR1cm5zIGEgJ3RoZW5hYmxlJyBwcm9taXNlLgogICAgICogICBSZWZyZXNoZXMgdGhlIGNyZWRlbnRpYWxzLiBVc2VycyBzaG91bGQgY2FsbCB7Z2V0fSBiZWZvcmUgYXR0ZW1wdGluZwogICAgICogICB0byBmb3JjaWJseSByZWZyZXNoIGNyZWRlbnRpYWxzLgogICAgICoKICAgICAqICAgVHdvIGNhbGxiYWNrcyBjYW4gYmUgcHJvdmlkZWQgdG8gdGhlIGB0aGVuYCBtZXRob2Qgb24gdGhlIHJldHVybmVkIHByb21pc2UuCiAgICAgKiAgIFRoZSBmaXJzdCBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQsIGFuZCB0aGUgc2Vjb25kCiAgICAgKiAgIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICBAY2FsbGJhY2sgZnVsZmlsbGVkQ2FsbGJhY2sgZnVuY3Rpb24oKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQuIFdoZW4gdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQsIGl0CiAgICAgKiAgICAgbWVhbnMgcmVmcmVzaGVkIGNyZWRlbnRpYWxzIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QKICAgICAqICAgICAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBjYWxsYmFjayByZWplY3RlZENhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICAgKiAgICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKiAgIEByZXR1cm4gW1Byb21pc2VdIEEgcHJvbWlzZSB0aGF0IHJlcHJlc2VudHMgdGhlIHN0YXRlIG9mIHRoZSBgcmVmcmVzaGAgY2FsbC4KICAgICAqICAgQGV4YW1wbGUgQ2FsbGluZyB0aGUgYHJlZnJlc2hQcm9taXNlYCBtZXRob2QuCiAgICAgKiAgICAgdmFyIHByb21pc2UgPSBjcmVkUHJvdmlkZXIucmVmcmVzaFByb21pc2UoKTsKICAgICAqICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24oKSB7IC4uLiB9LCBmdW5jdGlvbihlcnIpIHsgLi4uIH0pOwogICAgICovCiAgCiAgICAvKioKICAgICAqIFJlZnJlc2hlcyB0aGUgY3JlZGVudGlhbHMuIFVzZXJzIHNob3VsZCBjYWxsIHtnZXR9IGJlZm9yZSBhdHRlbXB0aW5nCiAgICAgKiB0byBmb3JjaWJseSByZWZyZXNoIGNyZWRlbnRpYWxzLgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIFdoZW4gdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgcmVmcmVzaGVkCiAgICAgKiAgIGNyZWRlbnRpYWxzIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZQogICAgICogICBgYWNjZXNzS2V5SWRgLCBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqIEBub3RlIFN1YmNsYXNzZXMgc2hvdWxkIG92ZXJyaWRlIHRoaXMgY2xhc3MgdG8gcmVzZXQgdGhlCiAgICAgKiAgIHthY2Nlc3NLZXlJZH0sIHtzZWNyZXRBY2Nlc3NLZXl9IGFuZCBvcHRpb25hbCB7c2Vzc2lvblRva2VufQogICAgICogICBvbiB0aGUgY3JlZGVudGlhbHMgb2JqZWN0IGFuZCB0aGVuIGNhbGwgdGhlIGNhbGxiYWNrIHdpdGgKICAgICAqICAgYW55IGVycm9yIGluZm9ybWF0aW9uLgogICAgICogQHNlZSBnZXQKICAgICAqLwogICAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaChjYWxsYmFjaykgewogICAgICB0aGlzLmV4cGlyZWQgPSBmYWxzZTsKICAgICAgY2FsbGJhY2soKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICogQHBhcmFtIGNhbGxiYWNrCiAgICAgKi8KICAgIGNvYWxlc2NlUmVmcmVzaDogZnVuY3Rpb24gY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrLCBzeW5jKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgaWYgKHNlbGYucmVmcmVzaENhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKSA9PT0gMSkgewogICAgICAgIHNlbGYubG9hZChmdW5jdGlvbiBvbkxvYWQoZXJyKSB7CiAgICAgICAgICBBV1MudXRpbC5hcnJheUVhY2goc2VsZi5yZWZyZXNoQ2FsbGJhY2tzLCBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgICBpZiAoc3luYykgewogICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gY2FsbGJhY2sgY291bGQgdGhyb3csIHNvIGRlZmVyIHRvIGVuc3VyZSBhbGwgY2FsbGJhY2tzIGFyZSBub3RpZmllZAogICAgICAgICAgICAgIEFXUy51dGlsLmRlZmVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgc2VsZi5yZWZyZXNoQ2FsbGJhY2tzLmxlbmd0aCA9IDA7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICogQHBhcmFtIGNhbGxiYWNrCiAgICAgKi8KICAgIGxvYWQ6IGZ1bmN0aW9uIGxvYWQoY2FsbGJhY2spIHsKICAgICAgY2FsbGJhY2soKTsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuQ3JlZGVudGlhbHMuYWRkUHJvbWlzZXNUb0NsYXNzID0gZnVuY3Rpb24gYWRkUHJvbWlzZXNUb0NsYXNzKFByb21pc2VEZXBlbmRlbmN5KSB7CiAgICB0aGlzLnByb3RvdHlwZS5nZXRQcm9taXNlID0gQVdTLnV0aWwucHJvbWlzaWZ5TWV0aG9kKCdnZXQnLCBQcm9taXNlRGVwZW5kZW5jeSk7CiAgICB0aGlzLnByb3RvdHlwZS5yZWZyZXNoUHJvbWlzZSA9IEFXUy51dGlsLnByb21pc2lmeU1ldGhvZCgncmVmcmVzaCcsIFByb21pc2VEZXBlbmRlbmN5KTsKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5DcmVkZW50aWFscy5kZWxldGVQcm9taXNlc0Zyb21DbGFzcyA9IGZ1bmN0aW9uIGRlbGV0ZVByb21pc2VzRnJvbUNsYXNzKCkgewogICAgZGVsZXRlIHRoaXMucHJvdG90eXBlLmdldFByb21pc2U7CiAgICBkZWxldGUgdGhpcy5wcm90b3R5cGUucmVmcmVzaFByb21pc2U7CiAgfTsKICAKICBBV1MudXRpbC5hZGRQcm9taXNlcyhBV1MuQ3JlZGVudGlhbHMpOwogIAogIH0seyIuL2NvcmUiOjE4fV0sMjA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIFNUUyA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvc3RzJyk7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgcmV0cmlldmVkIGZyb20ge0FXUy5TVFN9LiBXaXRob3V0IGFueQogICAqIGV4dHJhIHBhcmFtZXRlcnMsIGNyZWRlbnRpYWxzIHdpbGwgYmUgZmV0Y2hlZCBmcm9tIHRoZQogICAqIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0gb3BlcmF0aW9uLiBJZiBhbiBJQU0gcm9sZSBpcyBwcm92aWRlZCwgdGhlCiAgICoge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3BlcmF0aW9uIHdpbGwgYmUgdXNlZCB0byBmZXRjaCBjcmVkZW50aWFscyBmb3IgdGhlCiAgICogcm9sZSBpbnN0ZWFkLgogICAqCiAgICogQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzIGRpZmZlcnMgZnJvbSBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgaW4KICAgKiB0aGUgd2F5IG1hc3RlckNyZWRlbnRpYWxzIGFuZCByZWZyZXNoZXMgYXJlIGhhbmRsZWQuCiAgICogQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzIHJlZnJlc2hlcyBleHBpcmVkIGNyZWRlbnRpYWxzIHVzaW5nIHRoZQogICAqIG1hc3RlckNyZWRlbnRpYWxzIHBhc3NlZCBieSB0aGUgdXNlciB0byBzdXBwb3J0IGNoYWluaW5nIG9mIFNUUyBjcmVkZW50aWFscy4KICAgKiBIb3dldmVyLCBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgcmVjdXJzaXZlbHkgY29sbGFwc2VzIHRoZSBtYXN0ZXJDcmVkZW50aWFscwogICAqIGR1cmluZyBpbnN0YW50aWF0aW9uLCBwcmVjbHVkaW5nIHRoZSBhYmlsaXR5IHRvIHJlZnJlc2ggY3JlZGVudGlhbHMgd2hpY2gKICAgKiByZXF1aXJlIGludGVybWVkaWF0ZSwgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLgogICAqCiAgICogRm9yIGV4YW1wbGUsIGlmIHRoZSBhcHBsaWNhdGlvbiBzaG91bGQgdXNlIFJvbGVBLCB3aGljaCBtdXN0IGJlIGFzc3VtZWQgZnJvbQogICAqIFJvbGVCLCBhbmQgdGhlIGVudmlyb25tZW50IHByb3ZpZGVzIGNyZWRlbnRpYWxzIHdoaWNoIGNhbiBhc3N1bWUgUm9sZUIsIHRoZW4KICAgKiBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgbXVzdCBiZSB1c2VkIHRvIHN1cHBvcnQgcmVmcmVzaGluZyB0aGUKICAgKiB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZm9yIFJvbGVBOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIHZhciByb2xlQUNyZWRzID0gbmV3IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyh7CiAgICogICBwYXJhbXM6IHtSb2xlQXJuOiAnUm9sZUEnfSwKICAgKiAgIG1hc3RlckNyZWRlbnRpYWxzOiBuZXcgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICAgKiAgICAgcGFyYW1zOiB7Um9sZUFybjogJ1JvbGVCJ30sCiAgICogICAgIG1hc3RlckNyZWRlbnRpYWxzOiBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FXUycpCiAgICogICB9KQogICAqIH0pOwogICAqIGBgYAogICAqCiAgICogSWYgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzIGhhZCBiZWVuIHVzZWQgaW4gdGhlIHByZXZpb3VzIGV4YW1wbGUsCiAgICogYHJvbGVBQ3JlZHNgIHdvdWxkIGZhaWwgdG8gcmVmcmVzaCBiZWNhdXNlIGByb2xlQUNyZWRzYCB3b3VsZAogICAqIHVzZSB0aGUgZW52aXJvbm1lbnQgY3JlZGVudGlhbHMgZm9yIHRoZSBBc3N1bWVSb2xlIHJlcXVlc3QuCiAgICoKICAgKiBBbm90aGVyIGRpZmZlcmVuY2UgaXMgdGhhdCBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgY3JlYXRlcyB0aGUgU1RTCiAgICogc2VydmljZSBpbnN0YW5jZSBkdXJpbmcgaW5zdGFudGlhdGlvbiB3aGlsZSBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgY3JlYXRlcwogICAqIHRoZSBTVFMgc2VydmljZSBpbnN0YW5jZSBkdXJpbmcgdGhlIGZpcnN0IHJlZnJlc2guIENyZWF0aW5nIHRoZSBzZXJ2aWNlCiAgICogaW5zdGFuY2UgZHVyaW5nIGluc3RhbnRpYXRpb24gZWZmZWN0aXZlbHkgY2FwdHVyZXMgdGhlIG1hc3RlciBjcmVkZW50aWFscwogICAqIGZyb20gdGhlIGdsb2JhbCBjb25maWcsIHNvIHRoYXQgc3Vic2VxdWVudCBjaGFuZ2VzIHRvIHRoZSBnbG9iYWwgY29uZmlnIGRvCiAgICogbm90IGFmZmVjdCB0aGUgbWFzdGVyIGNyZWRlbnRpYWxzIHVzZWQgdG8gcmVmcmVzaCB0aGUgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLgogICAqCiAgICogVGhpcyBhbGxvd3MgYW4gaW5zdGFuY2Ugb2YgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzIHRvIGJlIGFzc2lnbmVkCiAgICogdG8gQVdTLmNvbmZpZy5jcmVkZW50aWFsczoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiB2YXIgZW52Q3JlZHMgPSBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FXUycpOwogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBlbnZDcmVkczsKICAgKiAvLyBtYXN0ZXJDcmVkZW50aWFscyB3aWxsIGJlIGVudkNyZWRzCiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogICAqICAgcGFyYW1zOiB7Um9sZUFybjogJy4uLid9CiAgICogfSk7CiAgICogYGBgCiAgICoKICAgKiBTaW1pbGFybHksIHRvIHVzZSB0aGUgQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4ncyBkZWZhdWx0IHByb3ZpZGVycyBhcyB0aGUKICAgKiBtYXN0ZXIgY3JlZGVudGlhbHMsIHNpbXBseSBjcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YKICAgKiBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHM6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBDaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyh7CiAgICogICBwYXJhbXM6IHtSb2xlQXJuOiAnLi4uJ30KICAgKiB9KTsKICAgKiBgYGAKICAgKgogICAqIEAhYXR0cmlidXRlIHNlcnZpY2UKICAgKiAgIEByZXR1cm4gW0FXUy5TVFNdIHRoZSBTVFMgc2VydmljZSBpbnN0YW5jZSB1c2VkIHRvCiAgICogICAgIGdldCBhbmQgcmVmcmVzaCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZnJvbSBBV1MgU1RTLgogICAqIEBub3RlIChzZWUgY29uc3RydWN0b3IpCiAgICovCiAgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgb2JqZWN0LgogICAgICoKICAgICAqIEBwYXJhbSBvcHRpb25zIFttYXBdIGEgc2V0IG9mIG9wdGlvbnMKICAgICAqIEBvcHRpb24gb3B0aW9ucyBwYXJhbXMgW21hcF0gKHt9KSBhIG1hcCBvZiBvcHRpb25zIHRoYXQgYXJlIHBhc3NlZCB0byB0aGUKICAgICAqICAge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3Ige0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSBvcGVyYXRpb25zLgogICAgICogICBJZiBhIGBSb2xlQXJuYCBwYXJhbWV0ZXIgaXMgcGFzc2VkIGluLCBjcmVkZW50aWFscyB3aWxsIGJlIGJhc2VkIG9uIHRoZQogICAgICogICBJQU0gcm9sZS4gSWYgYSBgU2VyaWFsTnVtYmVyYCBwYXJhbWV0ZXIgaXMgcGFzc2VkIGluLCB7dG9rZW5Db2RlRm59IG11c3QKICAgICAqICAgYWxzbyBiZSBwYXNzZWQgaW4gb3IgYW4gZXJyb3Igd2lsbCBiZSB0aHJvd24uCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgbWFzdGVyQ3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gdGhlIG1hc3RlciBjcmVkZW50aWFscwogICAgICogICB1c2VkIHRvIGdldCBhbmQgcmVmcmVzaCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZnJvbSBBV1MgU1RTLiBCeSBkZWZhdWx0LAogICAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzIG9yIEFXUy5jb25maWcuY3JlZGVudGlhbFByb3ZpZGVyIHdpbGwgYmUgdXNlZC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyB0b2tlbkNvZGVGbiBbRnVuY3Rpb25dIChudWxsKSBGdW5jdGlvbiB0byBwcm92aWRlCiAgICAgKiAgIGBUb2tlbkNvZGVgLCBpZiBgU2VyaWFsTnVtYmVyYCBpcyBwcm92aWRlZCBmb3IgcHJvZmlsZSBpbiB7cGFyYW1zfS4gRnVuY3Rpb24KICAgICAqICAgaXMgY2FsbGVkIHdpdGggdmFsdWUgb2YgYFNlcmlhbE51bWJlcmAgYW5kIGBjYWxsYmFja2AsIGFuZCBzaG91bGQgcHJvdmlkZQogICAgICogICB0aGUgYFRva2VuQ29kZWAgb3IgYW4gZXJyb3IgdG8gdGhlIGNhbGxiYWNrIGluIHRoZSBmb3JtYXQKICAgICAqICAgYGNhbGxiYWNrKGVyciwgdG9rZW4pYC4KICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdCBmb3IgZ2VuZXJpYyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoKTsKICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdCBmb3IgYW4gSUFNIHJvbGUKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogICAgICogICAgIHBhcmFtczogewogICAgICogICAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvVGVtcG9yYXJ5Q3JlZGVudGlhbHMnCiAgICAgKiAgICAgfQogICAgICogICB9KTsKICAgICAqIEBzZWUgQVdTLlNUUy5hc3N1bWVSb2xlCiAgICAgKiBAc2VlIEFXUy5TVFMuZ2V0U2Vzc2lvblRva2VuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyhvcHRpb25zKSB7CiAgICAgIEFXUy5DcmVkZW50aWFscy5jYWxsKHRoaXMpOwogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgdGhpcy5lcnJvckNvZGUgPSAnQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHNQcm92aWRlckZhaWx1cmUnOwogICAgICB0aGlzLmV4cGlyZWQgPSB0cnVlOwogICAgICB0aGlzLnRva2VuQ29kZUZuID0gbnVsbDsKICAKICAgICAgdmFyIHBhcmFtcyA9IEFXUy51dGlsLmNvcHkob3B0aW9ucy5wYXJhbXMpIHx8IHt9OwogICAgICBpZiAocGFyYW1zLlJvbGVBcm4pIHsKICAgICAgICBwYXJhbXMuUm9sZVNlc3Npb25OYW1lID0gcGFyYW1zLlJvbGVTZXNzaW9uTmFtZSB8fCAndGVtcG9yYXJ5LWNyZWRlbnRpYWxzJzsKICAgICAgfQogICAgICBpZiAocGFyYW1zLlNlcmlhbE51bWJlcikgewogICAgICAgIGlmICghb3B0aW9ucy50b2tlbkNvZGVGbiB8fCAodHlwZW9mIG9wdGlvbnMudG9rZW5Db2RlRm4gIT09ICdmdW5jdGlvbicpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgQVdTLnV0aWwuZXJyb3IoCiAgICAgICAgICAgIG5ldyBFcnJvcigndG9rZW5Db2RlRm4gbXVzdCBiZSBhIGZ1bmN0aW9uIHdoZW4gcGFyYW1zLlNlcmlhbE51bWJlciBpcyBnaXZlbicpLAogICAgICAgICAgICB7Y29kZTogdGhpcy5lcnJvckNvZGV9CiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnRva2VuQ29kZUZuID0gb3B0aW9ucy50b2tlbkNvZGVGbjsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIGNvbmZpZyA9IEFXUy51dGlsLm1lcmdlKAogICAgICAgIHsKICAgICAgICAgIHBhcmFtczogcGFyYW1zLAogICAgICAgICAgY3JlZGVudGlhbHM6IG9wdGlvbnMubWFzdGVyQ3JlZGVudGlhbHMgfHwgQVdTLmNvbmZpZy5jcmVkZW50aWFscwogICAgICAgIH0sCiAgICAgICAgb3B0aW9ucy5zdHNDb25maWcgfHwge30KICAgICAgKTsKICAgICAgdGhpcy5zZXJ2aWNlID0gbmV3IFNUUyhjb25maWcpOwogICAgfSwKICAKICAgIC8qKgogICAgICogUmVmcmVzaGVzIGNyZWRlbnRpYWxzIHVzaW5nIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9yCiAgICAgKiB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59LCBkZXBlbmRpbmcgb24gd2hldGhlciBhbiBJQU0gcm9sZSBBUk4gd2FzIHBhc3NlZAogICAgICogdG8gdGhlIGNyZWRlbnRpYWxzIHtjb25zdHJ1Y3Rvcn0uCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgQ2FsbGVkIHdoZW4gdGhlIFNUUyBzZXJ2aWNlIHJlc3BvbmRzIChvciBmYWlscykuIFdoZW4KICAgICAqICAgdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgdGhhdCB0aGUgY3JlZGVudGlhbHMKICAgICAqICAgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsCiAgICAgKiAgIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogQHNlZSBBV1MuQ3JlZGVudGlhbHMuZ2V0CiAgICAgKi8KICAgIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2goY2FsbGJhY2spIHsKICAgICAgdGhpcy5jb2FsZXNjZVJlZnJlc2goY2FsbGJhY2sgfHwgQVdTLnV0aWwuZm4uY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgICAqLwogICAgbG9hZDogZnVuY3Rpb24gbG9hZChjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBvcGVyYXRpb24gPSBzZWxmLnNlcnZpY2UuY29uZmlnLnBhcmFtcy5Sb2xlQXJuID8gJ2Fzc3VtZVJvbGUnIDogJ2dldFNlc3Npb25Ub2tlbic7CiAgICAgIHRoaXMuZ2V0VG9rZW5Db2RlKGZ1bmN0aW9uIChlcnIsIHRva2VuQ29kZSkgewogICAgICAgIHZhciBwYXJhbXMgPSB7fTsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodG9rZW5Db2RlKSB7CiAgICAgICAgICBwYXJhbXMuVG9rZW5Db2RlID0gdG9rZW5Db2RlOwogICAgICAgIH0KICAgICAgICBzZWxmLnNlcnZpY2Vbb3BlcmF0aW9uXShwYXJhbXMsIGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICAgIHNlbGYuc2VydmljZS5jcmVkZW50aWFsc0Zyb20oZGF0YSwgc2VsZik7CiAgICAgICAgICB9CiAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRUb2tlbkNvZGU6IGZ1bmN0aW9uIGdldFRva2VuQ29kZShjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmICh0aGlzLnRva2VuQ29kZUZuKSB7CiAgICAgICAgdGhpcy50b2tlbkNvZGVGbih0aGlzLnNlcnZpY2UuY29uZmlnLnBhcmFtcy5TZXJpYWxOdW1iZXIsIGZ1bmN0aW9uIChlcnIsIHRva2VuKSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gZXJyOwogICAgICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICAgICAgICBtZXNzYWdlID0gZXJyLm1lc3NhZ2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FsbGJhY2soCiAgICAgICAgICAgICAgQVdTLnV0aWwuZXJyb3IoCiAgICAgICAgICAgICAgICBuZXcgRXJyb3IoJ0Vycm9yIGZldGNoaW5nIE1GQSB0b2tlbjogJyArIG1lc3NhZ2UpLAogICAgICAgICAgICAgICAgeyBjb2RlOiBzZWxmLmVycm9yQ29kZX0KICAgICAgICAgICAgICApCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHRva2VuKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFjayhudWxsKTsKICAgICAgfQogICAgfQogIH0pOwogIAogIH0seyIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTh9XSwyMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgQ29nbml0b0lkZW50aXR5ID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9jb2duaXRvaWRlbnRpdHknKTsKICB2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIGNyZWRlbnRpYWxzIHJldHJpZXZlZCBmcm9tIFNUUyBXZWIgSWRlbnRpdHkgRmVkZXJhdGlvbiB1c2luZwogICAqIHRoZSBBbWF6b24gQ29nbml0byBJZGVudGl0eSBzZXJ2aWNlLgogICAqCiAgICogQnkgZGVmYXVsdCB0aGlzIHByb3ZpZGVyIGdldHMgY3JlZGVudGlhbHMgdXNpbmcgdGhlCiAgICoge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eX0gc2VydmljZSBvcGVyYXRpb24sIHdoaWNoCiAgICogcmVxdWlyZXMgZWl0aGVyIGFuIGBJZGVudGl0eUlkYCBvciBhbiBgSWRlbnRpdHlQb29sSWRgIChBbWF6b24gQ29nbml0bwogICAqIElkZW50aXR5IFBvb2wgSUQpLCB3aGljaCBpcyB1c2VkIHRvIGNhbGwge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0SWR9IHRvCiAgICogb2J0YWluIGFuIGBJZGVudGl0eUlkYC4gSWYgdGhlIGlkZW50aXR5IG9yIGlkZW50aXR5IHBvb2wgaXMgbm90IGNvbmZpZ3VyZWQgaW4KICAgKiB0aGUgQW1hem9uIENvZ25pdG8gQ29uc29sZSB0byB1c2UgSUFNIHJvbGVzIHdpdGggdGhlIGFwcHJvcHJpYXRlIHBlcm1pc3Npb25zLAogICAqIHRoZW4gYWRkaXRpb25hbGx5IGEgYFJvbGVBcm5gIGlzIHJlcXVpcmVkIGNvbnRhaW5pbmcgdGhlIEFSTiBvZiB0aGUgSUFNIHRydXN0CiAgICogcG9saWN5IGZvciB0aGUgQW1hem9uIENvZ25pdG8gcm9sZSB0aGF0IHRoZSB1c2VyIHdpbGwgbG9nIGludG8uIElmIGEgYFJvbGVBcm5gCiAgICogaXMgcHJvdmlkZWQsIHRoZW4gdGhpcyBwcm92aWRlciBnZXRzIGNyZWRlbnRpYWxzIHVzaW5nIHRoZQogICAqIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9IHNlcnZpY2Ugb3BlcmF0aW9uLCBhZnRlciBmaXJzdCBnZXR0aW5nIGFuCiAgICogT3BlbiBJRCB0b2tlbiBmcm9tIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldE9wZW5JZFRva2VufS4KICAgKgogICAqIEluIGFkZGl0aW9uLCBpZiB0aGlzIGNyZWRlbnRpYWwgcHJvdmlkZXIgaXMgdXNlZCB0byBwcm92aWRlIGF1dGhlbnRpY2F0ZWQKICAgKiBsb2dpbiwgdGhlIGBMb2dpbnNgIG1hcCBtYXkgYmUgc2V0IHRvIHRoZSB0b2tlbnMgcHJvdmlkZWQgYnkgdGhlIHJlc3BlY3RpdmUKICAgKiBpZGVudGl0eSBwcm92aWRlcnMuIFNlZSB7Y29uc3RydWN0b3J9IGZvciBhbiBleGFtcGxlIG9uIGNyZWF0aW5nIGEgY3JlZGVudGlhbHMKICAgKiBvYmplY3Qgd2l0aCBwcm9wZXIgcHJvcGVydHkgdmFsdWVzLgogICAqCiAgICogIyMgUmVmcmVzaGluZyBDcmVkZW50aWFscyBmcm9tIElkZW50aXR5IFNlcnZpY2UKICAgKgogICAqIEluIGFkZGl0aW9uIHRvIEFXUyBjcmVkZW50aWFscyBleHBpcmluZyBhZnRlciBhIGdpdmVuIGFtb3VudCBvZiB0aW1lLCB0aGUKICAgKiBsb2dpbiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlciB3aWxsIGFsc28gZXhwaXJlLiBPbmNlIHRoaXMgdG9rZW4KICAgKiBleHBpcmVzLCBpdCB3aWxsIG5vdCBiZSB1c2FibGUgdG8gcmVmcmVzaCBBV1MgY3JlZGVudGlhbHMsIGFuZCBhbm90aGVyCiAgICogdG9rZW4gd2lsbCBiZSBuZWVkZWQuIFRoZSBTREsgZG9lcyBub3QgbWFuYWdlIHJlZnJlc2hpbmcgb2YgdGhlIHRva2VuIHZhbHVlLAogICAqIGJ1dCB0aGlzIGNhbiBiZSBkb25lIHRocm91Z2ggYSAicmVmcmVzaCB0b2tlbiIgc3VwcG9ydGVkIGJ5IG1vc3QgaWRlbnRpdHkKICAgKiBwcm92aWRlcnMuIENvbnN1bHQgdGhlIGRvY3VtZW50YXRpb24gZm9yIHRoZSBpZGVudGl0eSBwcm92aWRlciBmb3IgcmVmcmVzaGluZwogICAqIHRva2Vucy4gT25jZSB0aGUgcmVmcmVzaGVkIHRva2VuIGlzIGFjcXVpcmVkLCB5b3Ugc2hvdWxkIG1ha2Ugc3VyZSB0byB1cGRhdGUKICAgKiB0aGlzIG5ldyB0b2tlbiBpbiB0aGUgY3JlZGVudGlhbHMgb2JqZWN0J3Mge3BhcmFtc30gcHJvcGVydHkuIFRoZSBmb2xsb3dpbmcKICAgKiBjb2RlIHdpbGwgdXBkYXRlIHRoZSBXZWJJZGVudGl0eVRva2VuLCBhc3N1bWluZyB5b3UgaGF2ZSByZXRyaWV2ZWQgYW4gdXBkYXRlZAogICAqIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMucGFyYW1zLkxvZ2luc1snZ3JhcGguZmFjZWJvb2suY29tJ10gPSB1cGRhdGVkVG9rZW47CiAgICogYGBgCiAgICoKICAgKiBGdXR1cmUgY2FsbHMgdG8gYGNyZWRlbnRpYWxzLnJlZnJlc2goKWAgd2lsbCBub3cgdXNlIHRoZSBuZXcgdG9rZW4uCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBwYXJhbXMKICAgKiAgIEByZXR1cm4gW21hcF0gdGhlIG1hcCBvZiBwYXJhbXMgcGFzc2VkIHRvCiAgICogICAgIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldElkfSwKICAgKiAgICAge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0T3BlbklkVG9rZW59LCBhbmQKICAgKiAgICAge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uIFRvIHVwZGF0ZSB0aGUgdG9rZW4sIHNldCB0aGUKICAgKiAgICAgYHBhcmFtcy5XZWJJZGVudGl0eVRva2VuYCBwcm9wZXJ0eS4KICAgKiBAIWF0dHJpYnV0ZSBkYXRhCiAgICogICBAcmV0dXJuIFttYXBdIHRoZSByYXcgZGF0YSByZXNwb25zZSBmcm9tIHRoZSBjYWxsIHRvCiAgICogICAgIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHl9LCBvcgogICAqICAgICB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4gVXNlIHRoaXMgaWYgeW91IHdhbnQgdG8gZ2V0CiAgICogICAgIGFjY2VzcyB0byBvdGhlciBwcm9wZXJ0aWVzIGZyb20gdGhlIHJlc3BvbnNlLgogICAqIEAhYXR0cmlidXRlIGlkZW50aXR5SWQKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIENvZ25pdG8gSUQgcmV0dXJuZWQgYnkgdGhlIGxhc3QgY2FsbCB0bwogICAqICAgICB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRPcGVuSWRUb2tlbn0uIFRoaXMgSUQgcmVwcmVzZW50cyB0aGUgYWN0dWFsCiAgICogICAgIGZpbmFsIHJlc29sdmVkIGlkZW50aXR5IElEIGZyb20gQW1hem9uIENvZ25pdG8uCiAgICovCiAgQVdTLkNvZ25pdG9JZGVudGl0eUNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxvY2FsU3RvcmFnZUtleTogewogICAgICBpZDogJ2F3cy5jb2duaXRvLmlkZW50aXR5LWlkLicsCiAgICAgIHByb3ZpZGVyczogJ2F3cy5jb2duaXRvLmlkZW50aXR5LXByb3ZpZGVycy4nCiAgICB9LAogIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdC4KICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdAogICAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5Db2duaXRvSWRlbnRpdHlDcmVkZW50aWFscyh7CiAgICAgKgogICAgICogICAgIC8vIGVpdGhlciBJZGVudGl0eVBvb2xJZCBvciBJZGVudGl0eUlkIGlzIHJlcXVpcmVkCiAgICAgKiAgICAgLy8gU2VlIHRoZSBJZGVudGl0eVBvb2xJZCBwYXJhbSBmb3IgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRJRCAobGlua2VkIGJlbG93KQogICAgICogICAgIC8vIFNlZSB0aGUgSWRlbnRpdHlJZCBwYXJhbSBmb3IgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5CiAgICAgKiAgICAgLy8gb3IgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRPcGVuSWRUb2tlbiAobGlua2VkIGJlbG93KQogICAgICogICAgIElkZW50aXR5UG9vbElkOiAndXMtZWFzdC0xOjE2OTllYmMwLTc5MDAtNDA5OS1iOTEwLTJkZjk0ZjUyYTAzMCcsCiAgICAgKiAgICAgSWRlbnRpdHlJZDogJ3VzLWVhc3QtMToxMjhkMGE3NC1jODJmLTQ1NTMtOTE2ZC05MDA1M2U0YThiMGYnCiAgICAgKgogICAgICogICAgIC8vIG9wdGlvbmFsLCBvbmx5IG5lY2Vzc2FyeSB3aGVuIHRoZSBpZGVudGl0eSBwb29sIGlzIG5vdCBjb25maWd1cmVkCiAgICAgKiAgICAgLy8gdG8gdXNlIElBTSByb2xlcyBpbiB0aGUgQW1hem9uIENvZ25pdG8gQ29uc29sZQogICAgICogICAgIC8vIFNlZSB0aGUgUm9sZUFybiBwYXJhbSBmb3IgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5IChsaW5rZWQgYmVsb3cpCiAgICAgKiAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvTVlBUFAtQ29nbml0b0lkZW50aXR5JywKICAgICAqCiAgICAgKiAgICAgLy8gb3B0aW9uYWwgdG9rZW5zLCB1c2VkIGZvciBhdXRoZW50aWNhdGVkIGxvZ2luCiAgICAgKiAgICAgLy8gU2VlIHRoZSBMb2dpbnMgcGFyYW0gZm9yIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0SUQgKGxpbmtlZCBiZWxvdykKICAgICAqICAgICBMb2dpbnM6IHsKICAgICAqICAgICAgICdncmFwaC5mYWNlYm9vay5jb20nOiAnRkJUT0tFTicsCiAgICAgKiAgICAgICAnd3d3LmFtYXpvbi5jb20nOiAnQU1BWk9OVE9LRU4nLAogICAgICogICAgICAgJ2FjY291bnRzLmdvb2dsZS5jb20nOiAnR09PR0xFVE9LRU4nLAogICAgICogICAgICAgJ2FwaS50d2l0dGVyLmNvbSc6ICdUV0lUVEVSVE9LRU4nLAogICAgICogICAgICAgJ3d3dy5kaWdpdHMuY29tJzogJ0RJR0lUU1RPS0VOJwogICAgICogICAgIH0sCiAgICAgKgogICAgICogICAgIC8vIG9wdGlvbmFsIG5hbWUsIGRlZmF1bHRzIHRvIHdlYi1pZGVudGl0eQogICAgICogICAgIC8vIFNlZSB0aGUgUm9sZVNlc3Npb25OYW1lIHBhcmFtIGZvciBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkgKGxpbmtlZCBiZWxvdykKICAgICAqICAgICBSb2xlU2Vzc2lvbk5hbWU6ICd3ZWInLAogICAgICoKICAgICAqICAgICAvLyBvcHRpb25hbCwgb25seSBuZWNlc3Nhcnkgd2hlbiBhcHBsaWNhdGlvbiBydW5zIGluIGEgYnJvd3NlcgogICAgICogICAgIC8vIGFuZCBtdWx0aXBsZSB1c2VycyBhcmUgc2lnbmVkIGluIGF0IG9uY2UsIHVzZWQgZm9yIGNhY2hpbmcKICAgICAqICAgICBMb2dpbklkOiAnZXhhbXBsZUBnbWFpbC5jb20nCiAgICAgKgogICAgICogICB9LCB7CiAgICAgKiAgICAgIC8vIG9wdGlvbmFsbHkgcHJvdmlkZSBjb25maWd1cmF0aW9uIHRvIGFwcGx5IHRvIHRoZSB1bmRlcmx5aW5nIHNlcnZpY2UgY2xpZW50cwogICAgICogICAgICAvLyBpZiBjb25maWd1cmF0aW9uIGlzIG5vdCBwcm92aWRlZCwgdGhlbiBjb25maWd1cmF0aW9uIHdpbGwgYmUgcHVsbGVkIGZyb20gQVdTLmNvbmZpZwogICAgICoKICAgICAqICAgICAgLy8gcmVnaW9uIHNob3VsZCBtYXRjaCB0aGUgcmVnaW9uIHlvdXIgaWRlbnRpdHkgcG9vbCBpcyBsb2NhdGVkIGluCiAgICAgKiAgICAgIHJlZ2lvbjogJ3VzLWVhc3QtMScsCiAgICAgKgogICAgICogICAgICAvLyBzcGVjaWZ5IHRpbWVvdXQgb3B0aW9ucwogICAgICogICAgICBodHRwT3B0aW9uczogewogICAgICogICAgICAgIHRpbWVvdXQ6IDEwMAogICAgICogICAgICB9CiAgICAgKiAgIH0pOwogICAgICogQHNlZSBBV1MuQ29nbml0b0lkZW50aXR5LmdldElkCiAgICAgKiBAc2VlIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eQogICAgICogQHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkKICAgICAqIEBzZWUgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRPcGVuSWRUb2tlbgogICAgICogQHNlZSBBV1MuQ29uZmlnCiAgICAgKiBAbm90ZSBJZiBhIHJlZ2lvbiBpcyBub3QgcHJvdmlkZWQgaW4gdGhlIGdsb2JhbCBBV1MuY29uZmlnLCBvcgogICAgICogICBzcGVjaWZpZWQgaW4gdGhlIGBjbGllbnRDb25maWdgIHRvIHRoZSBDb2duaXRvSWRlbnRpdHlDcmVkZW50aWFscwogICAgICogICBjb25zdHJ1Y3RvciwgeW91IG1heSBlbmNvdW50ZXIgYSAnTWlzc2luZyBjcmVkZW50aWFscyBpbiBjb25maWcnIGVycm9yCiAgICAgKiAgIHdoZW4gY2FsbGluZyBtYWtpbmcgYSBzZXJ2aWNlIGNhbGwuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDb2duaXRvSWRlbnRpdHlDcmVkZW50aWFscyhwYXJhbXMsIGNsaWVudENvbmZpZykgewogICAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKICAgICAgdGhpcy5wYXJhbXMgPSBwYXJhbXM7CiAgICAgIHRoaXMuZGF0YSA9IG51bGw7CiAgICAgIHRoaXMuX2lkZW50aXR5SWQgPSBudWxsOwogICAgICB0aGlzLl9jbGllbnRDb25maWcgPSBBV1MudXRpbC5jb3B5KGNsaWVudENvbmZpZyB8fCB7fSk7CiAgICAgIHRoaXMubG9hZENhY2hlZElkKCk7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdpZGVudGl0eUlkJywgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICBzZWxmLmxvYWRDYWNoZWRJZCgpOwogICAgICAgICAgcmV0dXJuIHNlbGYuX2lkZW50aXR5SWQgfHwgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZDsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24oaWRlbnRpdHlJZCkgewogICAgICAgICAgc2VsZi5faWRlbnRpdHlJZCA9IGlkZW50aXR5SWQ7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFJlZnJlc2hlcyBjcmVkZW50aWFscyB1c2luZyB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5fSwKICAgICAqIG9yIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIENhbGxlZCB3aGVuIHRoZSBTVFMgc2VydmljZSByZXNwb25kcyAob3IgZmFpbHMpLiBXaGVuCiAgICAgKiAgIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHRoYXQgdGhlIGNyZWRlbnRpYWxzCiAgICAgKiAgIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLAogICAgICogICBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqIEBzZWUgQVdTLkNyZWRlbnRpYWxzLmdldAogICAgICovCiAgICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrIHx8IEFXUy51dGlsLmZuLmNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICogQHBhcmFtIGNhbGxiYWNrCiAgICAgKi8KICAgIGxvYWQ6IGZ1bmN0aW9uIGxvYWQoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzZWxmLmNyZWF0ZUNsaWVudHMoKTsKICAgICAgc2VsZi5kYXRhID0gbnVsbDsKICAgICAgc2VsZi5faWRlbnRpdHlJZCA9IG51bGw7CiAgICAgIHNlbGYuZ2V0SWQoZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgIGlmICghc2VsZi5wYXJhbXMuUm9sZUFybikgewogICAgICAgICAgICBzZWxmLmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkoY2FsbGJhY2spOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZi5nZXRDcmVkZW50aWFsc0Zyb21TVFMoY2FsbGJhY2spOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxmLmNsZWFySWRPbk5vdEF1dGhvcml6ZWQoZXJyKTsKICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIENsZWFycyB0aGUgY2FjaGVkIENvZ25pdG8gSUQgYXNzb2NpYXRlZCB3aXRoIHRoZSBjdXJyZW50bHkgY29uZmlndXJlZAogICAgICogaWRlbnRpdHkgcG9vbCBJRC4gVXNlIHRoaXMgdG8gbWFudWFsbHkgaW52YWxpZGF0ZSB5b3VyIGNhY2hlIGlmCiAgICAgKiB0aGUgaWRlbnRpdHkgcG9vbCBJRCB3YXMgZGVsZXRlZC4KICAgICAqLwogICAgY2xlYXJDYWNoZWRJZDogZnVuY3Rpb24gY2xlYXJDYWNoZSgpIHsKICAgICAgdGhpcy5faWRlbnRpdHlJZCA9IG51bGw7CiAgICAgIGRlbGV0ZSB0aGlzLnBhcmFtcy5JZGVudGl0eUlkOwogIAogICAgICB2YXIgcG9vbElkID0gdGhpcy5wYXJhbXMuSWRlbnRpdHlQb29sSWQ7CiAgICAgIHZhciBsb2dpbklkID0gdGhpcy5wYXJhbXMuTG9naW5JZCB8fCAnJzsKICAgICAgZGVsZXRlIHRoaXMuc3RvcmFnZVt0aGlzLmxvY2FsU3RvcmFnZUtleS5pZCArIHBvb2xJZCArIGxvZ2luSWRdOwogICAgICBkZWxldGUgdGhpcy5zdG9yYWdlW3RoaXMubG9jYWxTdG9yYWdlS2V5LnByb3ZpZGVycyArIHBvb2xJZCArIGxvZ2luSWRdOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNsZWFySWRPbk5vdEF1dGhvcml6ZWQ6IGZ1bmN0aW9uIGNsZWFySWRPbk5vdEF1dGhvcml6ZWQoZXJyKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgaWYgKGVyci5jb2RlID09ICdOb3RBdXRob3JpemVkRXhjZXB0aW9uJykgewogICAgICAgIHNlbGYuY2xlYXJDYWNoZWRJZCgpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBSZXRyaWV2ZXMgYSBDb2duaXRvIElELCBsb2FkaW5nIGZyb20gY2FjaGUgaWYgaXQgd2FzIGFscmVhZHkgcmV0cmlldmVkCiAgICAgKiBvbiB0aGlzIGRldmljZS4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBpZGVudGl0eUlkKQogICAgICogICBAcGFyYW0gZXJyIFtFcnJvciwgbnVsbF0gYW4gZXJyb3Igb2JqZWN0IGlmIHRoZSBjYWxsIGZhaWxlZCBvciBudWxsIGlmCiAgICAgKiAgICAgaXQgc3VjY2VlZGVkLgogICAgICogICBAcGFyYW0gaWRlbnRpdHlJZCBbU3RyaW5nLCBudWxsXSBpZiBzdWNjZXNzZnVsLCB0aGUgY2FsbGJhY2sgd2lsbCByZXR1cm4KICAgICAqICAgICB0aGUgQ29nbml0byBJRC4KICAgICAqIEBub3RlIElmIG5vdCBsb2FkZWQgZXhwbGljaXRseSwgdGhlIENvZ25pdG8gSUQgaXMgbG9hZGVkIGFuZCBzdG9yZWQgaW4KICAgICAqICAgbG9jYWxTdG9yYWdlIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50IG9mIGEgZGV2aWNlLgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldElkOiBmdW5jdGlvbiBnZXRJZChjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmICh0eXBlb2Ygc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCA9PT0gJ3N0cmluZycpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCk7CiAgICAgIH0KICAKICAgICAgc2VsZi5jb2duaXRvLmdldElkKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgIGlmICghZXJyICYmIGRhdGEuSWRlbnRpdHlJZCkgewogICAgICAgICAgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCA9IGRhdGEuSWRlbnRpdHlJZDsKICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGRhdGEuSWRlbnRpdHlJZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkQ3JlZGVudGlhbHM6IGZ1bmN0aW9uIGxvYWRDcmVkZW50aWFscyhkYXRhLCBjcmVkZW50aWFscykgewogICAgICBpZiAoIWRhdGEgfHwgIWNyZWRlbnRpYWxzKSByZXR1cm47CiAgICAgIGNyZWRlbnRpYWxzLmV4cGlyZWQgPSBmYWxzZTsKICAgICAgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgPSBkYXRhLkNyZWRlbnRpYWxzLkFjY2Vzc0tleUlkOwogICAgICBjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXkgPSBkYXRhLkNyZWRlbnRpYWxzLlNlY3JldEtleTsKICAgICAgY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuID0gZGF0YS5DcmVkZW50aWFscy5TZXNzaW9uVG9rZW47CiAgICAgIGNyZWRlbnRpYWxzLmV4cGlyZVRpbWUgPSBkYXRhLkNyZWRlbnRpYWxzLkV4cGlyYXRpb247CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eTogZnVuY3Rpb24gZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eShjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHNlbGYuY29nbml0by5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5KGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICBzZWxmLmNhY2hlSWQoZGF0YSk7CiAgICAgICAgICBzZWxmLmRhdGEgPSBkYXRhOwogICAgICAgICAgc2VsZi5sb2FkQ3JlZGVudGlhbHMoc2VsZi5kYXRhLCBzZWxmKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5jbGVhcklkT25Ob3RBdXRob3JpemVkKGVycik7CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldENyZWRlbnRpYWxzRnJvbVNUUzogZnVuY3Rpb24gZ2V0Q3JlZGVudGlhbHNGcm9tU1RTKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgc2VsZi5jb2duaXRvLmdldE9wZW5JZFRva2VuKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICBzZWxmLmNhY2hlSWQoZGF0YSk7CiAgICAgICAgICBzZWxmLnBhcmFtcy5XZWJJZGVudGl0eVRva2VuID0gZGF0YS5Ub2tlbjsKICAgICAgICAgIHNlbGYud2ViSWRlbnRpdHlDcmVkZW50aWFscy5yZWZyZXNoKGZ1bmN0aW9uKHdlYkVycikgewogICAgICAgICAgICBpZiAoIXdlYkVycikgewogICAgICAgICAgICAgIHNlbGYuZGF0YSA9IHNlbGYud2ViSWRlbnRpdHlDcmVkZW50aWFscy5kYXRhOwogICAgICAgICAgICAgIHNlbGYuc3RzLmNyZWRlbnRpYWxzRnJvbShzZWxmLmRhdGEsIHNlbGYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbGxiYWNrKHdlYkVycik7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5jbGVhcklkT25Ob3RBdXRob3JpemVkKGVycik7CiAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZENhY2hlZElkOiBmdW5jdGlvbiBsb2FkQ2FjaGVkSWQoKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAKICAgICAgLy8gaW4gdGhlIGJyb3dzZXIgd2Ugc291cmNlIGRlZmF1bHQgSWRlbnRpdHlJZCBmcm9tIGxvY2FsU3RvcmFnZQogICAgICBpZiAoQVdTLnV0aWwuaXNCcm93c2VyKCkgJiYgIXNlbGYucGFyYW1zLklkZW50aXR5SWQpIHsKICAgICAgICB2YXIgaWQgPSBzZWxmLmdldFN0b3JhZ2UoJ2lkJyk7CiAgICAgICAgaWYgKGlkICYmIHNlbGYucGFyYW1zLkxvZ2lucykgewogICAgICAgICAgdmFyIGFjdHVhbFByb3ZpZGVycyA9IE9iamVjdC5rZXlzKHNlbGYucGFyYW1zLkxvZ2lucyk7CiAgICAgICAgICB2YXIgY2FjaGVkUHJvdmlkZXJzID0KICAgICAgICAgICAgKHNlbGYuZ2V0U3RvcmFnZSgncHJvdmlkZXJzJykgfHwgJycpLnNwbGl0KCcsJyk7CiAgCiAgICAgICAgICAvLyBvbmx5IGxvYWQgSUQgaWYgYXQgbGVhc3Qgb25lIHByb3ZpZGVyIHVzZWQgdGhpcyBJRCBiZWZvcmUKICAgICAgICAgIHZhciBpbnRlcnNlY3QgPSBjYWNoZWRQcm92aWRlcnMuZmlsdGVyKGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgcmV0dXJuIGFjdHVhbFByb3ZpZGVycy5pbmRleE9mKG4pICE9PSAtMTsKICAgICAgICAgIH0pOwogICAgICAgICAgaWYgKGludGVyc2VjdC5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCA9IGlkOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoaWQpIHsKICAgICAgICAgIHNlbGYucGFyYW1zLklkZW50aXR5SWQgPSBpZDsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjcmVhdGVDbGllbnRzOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNsaWVudENvbmZpZyA9IHRoaXMuX2NsaWVudENvbmZpZzsKICAgICAgdGhpcy53ZWJJZGVudGl0eUNyZWRlbnRpYWxzID0gdGhpcy53ZWJJZGVudGl0eUNyZWRlbnRpYWxzIHx8CiAgICAgICAgbmV3IEFXUy5XZWJJZGVudGl0eUNyZWRlbnRpYWxzKHRoaXMucGFyYW1zLCBjbGllbnRDb25maWcpOwogICAgICBpZiAoIXRoaXMuY29nbml0bykgewogICAgICAgIHZhciBjb2duaXRvQ29uZmlnID0gQVdTLnV0aWwubWVyZ2Uoe30sIGNsaWVudENvbmZpZyk7CiAgICAgICAgY29nbml0b0NvbmZpZy5wYXJhbXMgPSB0aGlzLnBhcmFtczsKICAgICAgICB0aGlzLmNvZ25pdG8gPSBuZXcgQ29nbml0b0lkZW50aXR5KGNvZ25pdG9Db25maWcpOwogICAgICB9CiAgICAgIHRoaXMuc3RzID0gdGhpcy5zdHMgfHwgbmV3IFNUUyhjbGllbnRDb25maWcpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNhY2hlSWQ6IGZ1bmN0aW9uIGNhY2hlSWQoZGF0YSkgewogICAgICB0aGlzLl9pZGVudGl0eUlkID0gZGF0YS5JZGVudGl0eUlkOwogICAgICB0aGlzLnBhcmFtcy5JZGVudGl0eUlkID0gdGhpcy5faWRlbnRpdHlJZDsKICAKICAgICAgLy8gY2FjaGUgdGhpcyBJZGVudGl0eUlkIGluIGJyb3dzZXIgbG9jYWxTdG9yYWdlIGlmIHBvc3NpYmxlCiAgICAgIGlmIChBV1MudXRpbC5pc0Jyb3dzZXIoKSkgewogICAgICAgIHRoaXMuc2V0U3RvcmFnZSgnaWQnLCBkYXRhLklkZW50aXR5SWQpOwogIAogICAgICAgIGlmICh0aGlzLnBhcmFtcy5Mb2dpbnMpIHsKICAgICAgICAgIHRoaXMuc2V0U3RvcmFnZSgncHJvdmlkZXJzJywgT2JqZWN0LmtleXModGhpcy5wYXJhbXMuTG9naW5zKS5qb2luKCcsJykpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldFN0b3JhZ2U6IGZ1bmN0aW9uIGdldFN0b3JhZ2Uoa2V5KSB7CiAgICAgIHJldHVybiB0aGlzLnN0b3JhZ2VbdGhpcy5sb2NhbFN0b3JhZ2VLZXlba2V5XSArIHRoaXMucGFyYW1zLklkZW50aXR5UG9vbElkICsgKHRoaXMucGFyYW1zLkxvZ2luSWQgfHwgJycpXTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzZXRTdG9yYWdlOiBmdW5jdGlvbiBzZXRTdG9yYWdlKGtleSwgdmFsKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdGhpcy5zdG9yYWdlW3RoaXMubG9jYWxTdG9yYWdlS2V5W2tleV0gKyB0aGlzLnBhcmFtcy5JZGVudGl0eVBvb2xJZCArICh0aGlzLnBhcmFtcy5Mb2dpbklkIHx8ICcnKV0gPSB2YWw7CiAgICAgIH0gY2F0Y2ggKF8pIHt9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc3RvcmFnZTogKGZ1bmN0aW9uKCkgewogICAgICB0cnkgewogICAgICAgIHZhciBzdG9yYWdlID0gQVdTLnV0aWwuaXNCcm93c2VyKCkgJiYgd2luZG93LmxvY2FsU3RvcmFnZSAhPT0gbnVsbCAmJiB0eXBlb2Ygd2luZG93LmxvY2FsU3RvcmFnZSA9PT0gJ29iamVjdCcgPwogICAgICAgICAgICB3aW5kb3cubG9jYWxTdG9yYWdlIDoge307CiAgCiAgICAgICAgLy8gVGVzdCBzZXQvcmVtb3ZlIHdoaWNoIHdvdWxkIHRocm93IGFuIGVycm9yIGluIFNhZmFyaSdzIHByaXZhdGUgYnJvd3NpbmcKICAgICAgICBzdG9yYWdlWydhd3MudGVzdC1zdG9yYWdlJ10gPSAnZm9vYmFyJzsKICAgICAgICBkZWxldGUgc3RvcmFnZVsnYXdzLnRlc3Qtc3RvcmFnZSddOwogIAogICAgICAgIHJldHVybiBzdG9yYWdlOwogICAgICB9IGNhdGNoIChfKSB7CiAgICAgICAgcmV0dXJuIHt9OwogICAgICB9CiAgICB9KSgpCiAgfSk7CiAgCiAgfSx7Ii4uLy4uL2NsaWVudHMvY29nbml0b2lkZW50aXR5Ijo3LCIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTh9XSwyMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICAKICAvKioKICAgKiBDcmVhdGVzIGEgY3JlZGVudGlhbCBwcm92aWRlciBjaGFpbiB0aGF0IHNlYXJjaGVzIGZvciBBV1MgY3JlZGVudGlhbHMKICAgKiBpbiBhIGxpc3Qgb2YgY3JlZGVudGlhbCBwcm92aWRlcnMgc3BlY2lmaWVkIGJ5IHRoZSB7cHJvdmlkZXJzfSBwcm9wZXJ0eS4KICAgKgogICAqIEJ5IGRlZmF1bHQsIHRoZSBjaGFpbiB3aWxsIHVzZSB0aGUge2RlZmF1bHRQcm92aWRlcnN9IHRvIHJlc29sdmUgY3JlZGVudGlhbHMuCiAgICogVGhlc2UgcHJvdmlkZXJzIHdpbGwgbG9vayBpbiB0aGUgZW52aXJvbm1lbnQgdXNpbmcgdGhlCiAgICoge0FXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzfSBjbGFzcyB3aXRoIHRoZSAnQVdTJyBhbmQgJ0FNQVpPTicgcHJlZml4ZXMuCiAgICoKICAgKiAjIyBTZXR0aW5nIFByb3ZpZGVycwogICAqCiAgICogRWFjaCBwcm92aWRlciBpbiB0aGUge3Byb3ZpZGVyc30gbGlzdCBzaG91bGQgYmUgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMKICAgKiBhIHtBV1MuQ3JlZGVudGlhbHN9IG9iamVjdCwgb3IgYSBoYXJkY29kZWQgY3JlZGVudGlhbHMgb2JqZWN0LiBUaGUgZnVuY3Rpb24KICAgKiBmb3JtIGFsbG93cyBmb3IgZGVsYXllZCBleGVjdXRpb24gb2YgdGhlIGNyZWRlbnRpYWwgY29uc3RydWN0aW9uLgogICAqCiAgICogIyMgUmVzb2x2aW5nIENyZWRlbnRpYWxzIGZyb20gYSBDaGFpbgogICAqCiAgICogQ2FsbCB7cmVzb2x2ZX0gdG8gcmV0dXJuIHRoZSBmaXJzdCB2YWxpZCBjcmVkZW50aWFsIG9iamVjdCB0aGF0IGNhbiBiZQogICAqIGxvYWRlZCBieSB0aGUgcHJvdmlkZXIgY2hhaW4uCiAgICoKICAgKiBGb3IgZXhhbXBsZSwgdG8gcmVzb2x2ZSBhIGNoYWluIHdpdGggYSBjdXN0b20gcHJvdmlkZXIgdGhhdCBjaGVja3MgYSBmaWxlCiAgICogb24gZGlzayBhZnRlciB0aGUgc2V0IG9mIHtkZWZhdWx0UHJvdmlkZXJzfToKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiB2YXIgZGlza1Byb3ZpZGVyID0gbmV3IEFXUy5GaWxlU3lzdGVtQ3JlZGVudGlhbHMoJy4vY3JlZHMuanNvbicpOwogICAqIHZhciBjaGFpbiA9IG5ldyBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4oKTsKICAgKiBjaGFpbi5wcm92aWRlcnMucHVzaChkaXNrUHJvdmlkZXIpOwogICAqIGNoYWluLnJlc29sdmUoKTsKICAgKiBgYGAKICAgKgogICAqIFRoZSBhYm92ZSBjb2RlIHdpbGwgcmV0dXJuIHRoZSBgZGlza1Byb3ZpZGVyYCBvYmplY3QgaWYgdGhlCiAgICogZmlsZSBjb250YWlucyBjcmVkZW50aWFscyBhbmQgdGhlIGBkZWZhdWx0UHJvdmlkZXJzYCBkbyBub3QgY29udGFpbgogICAqIGFueSBjcmVkZW50aWFsIHNldHRpbmdzLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcHJvdmlkZXJzCiAgICogICBAcmV0dXJuIFtBcnJheTxBV1MuQ3JlZGVudGlhbHMsIEZ1bmN0aW9uPl0KICAgKiAgICAgYSBsaXN0IG9mIGNyZWRlbnRpYWxzIG9iamVjdHMgb3IgZnVuY3Rpb25zIHRoYXQgcmV0dXJuIGNyZWRlbnRpYWxzCiAgICogICAgIG9iamVjdHMuIElmIHRoZSBwcm92aWRlciBpcyBhIGZ1bmN0aW9uLCB0aGUgZnVuY3Rpb24gd2lsbCBiZQogICAqICAgICBleGVjdXRlZCBsYXppbHkgd2hlbiB0aGUgcHJvdmlkZXIgbmVlZHMgdG8gYmUgY2hlY2tlZCBmb3IgdmFsaWQKICAgKiAgICAgY3JlZGVudGlhbHMuIEJ5IGRlZmF1bHQsIHRoaXMgb2JqZWN0IHdpbGwgYmUgc2V0IHRvIHRoZQogICAqICAgICB7ZGVmYXVsdFByb3ZpZGVyc30uCiAgICogICBAc2VlIGRlZmF1bHRQcm92aWRlcnMKICAgKi8KICBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4gPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IENyZWRlbnRpYWxQcm92aWRlckNoYWluIHdpdGggYSBkZWZhdWx0IHNldCBvZiBwcm92aWRlcnMKICAgICAqIHNwZWNpZmllZCBieSB7ZGVmYXVsdFByb3ZpZGVyc30uCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDcmVkZW50aWFsUHJvdmlkZXJDaGFpbihwcm92aWRlcnMpIHsKICAgICAgaWYgKHByb3ZpZGVycykgewogICAgICAgIHRoaXMucHJvdmlkZXJzID0gcHJvdmlkZXJzOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucHJvdmlkZXJzID0gQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmRlZmF1bHRQcm92aWRlcnMuc2xpY2UoMCk7CiAgICAgIH0KICAgICAgdGhpcy5yZXNvbHZlQ2FsbGJhY2tzID0gW107CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAIW1ldGhvZCAgcmVzb2x2ZVByb21pc2UoKQogICAgICogICBSZXR1cm5zIGEgJ3RoZW5hYmxlJyBwcm9taXNlLgogICAgICogICBSZXNvbHZlcyB0aGUgcHJvdmlkZXIgY2hhaW4gYnkgc2VhcmNoaW5nIGZvciB0aGUgZmlyc3Qgc2V0IG9mCiAgICAgKiAgIGNyZWRlbnRpYWxzIGluIHtwcm92aWRlcnN9LgogICAgICoKICAgICAqICAgVHdvIGNhbGxiYWNrcyBjYW4gYmUgcHJvdmlkZWQgdG8gdGhlIGB0aGVuYCBtZXRob2Qgb24gdGhlIHJldHVybmVkIHByb21pc2UuCiAgICAgKiAgIFRoZSBmaXJzdCBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQsIGFuZCB0aGUgc2Vjb25kCiAgICAgKiAgIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICBAY2FsbGJhY2sgZnVsZmlsbGVkQ2FsbGJhY2sgZnVuY3Rpb24oY3JlZGVudGlhbHMpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZCBhbmQgdGhlIHByb3ZpZGVyIHJlc29sdmVzIHRoZSBjaGFpbgogICAgICogICAgIHRvIGEgY3JlZGVudGlhbHMgb2JqZWN0CiAgICAgKiAgICAgQHBhcmFtIGNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBjcmVkZW50aWFscyBvYmplY3QgcmVzb2x2ZWQKICAgICAqICAgICAgIGJ5IHRoZSBwcm92aWRlciBjaGFpbi4KICAgICAqICAgQGNhbGxiYWNrIHJlamVjdGVkQ2FsbGJhY2sgZnVuY3Rpb24oZXJyb3IpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGlmIG5vIGNyZWRlbnRpYWxzIGFyZSBmb3VuZC4KICAgICAqICAgQHJldHVybiBbUHJvbWlzZV0gQSBwcm9taXNlIHRoYXQgcmVwcmVzZW50cyB0aGUgc3RhdGUgb2YgdGhlIGByZXNvbHZlYCBtZXRob2QgY2FsbC4KICAgICAqICAgQGV4YW1wbGUgQ2FsbGluZyB0aGUgYHJlc29sdmVQcm9taXNlYCBtZXRob2QuCiAgICAgKiAgICAgdmFyIHByb21pc2UgPSBjaGFpbi5yZXNvbHZlUHJvbWlzZSgpOwogICAgICogICAgIHByb21pc2UudGhlbihmdW5jdGlvbihjcmVkZW50aWFscykgeyAuLi4gfSwgZnVuY3Rpb24oZXJyKSB7IC4uLiB9KTsKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBSZXNvbHZlcyB0aGUgcHJvdmlkZXIgY2hhaW4gYnkgc2VhcmNoaW5nIGZvciB0aGUgZmlyc3Qgc2V0IG9mCiAgICAgKiBjcmVkZW50aWFscyBpbiB7cHJvdmlkZXJzfS4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBjcmVkZW50aWFscykKICAgICAqICAgQ2FsbGVkIHdoZW4gdGhlIHByb3ZpZGVyIHJlc29sdmVzIHRoZSBjaGFpbiB0byBhIGNyZWRlbnRpYWxzIG9iamVjdAogICAgICogICBvciBudWxsIGlmIG5vIGNyZWRlbnRpYWxzIGNhbiBiZSBmb3VuZC4KICAgICAqCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGlmIG5vIGNyZWRlbnRpYWxzIGFyZQogICAgICogICAgIGZvdW5kLgogICAgICogICBAcGFyYW0gY3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCByZXNvbHZlZAogICAgICogICAgIGJ5IHRoZSBwcm92aWRlciBjaGFpbi4KICAgICAqIEByZXR1cm4gW0FXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbl0gdGhlIHByb3ZpZGVyLCBmb3IgY2hhaW5pbmcuCiAgICAgKi8KICAgIHJlc29sdmU6IGZ1bmN0aW9uIHJlc29sdmUoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZiAoc2VsZi5wcm92aWRlcnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgY2FsbGJhY2sobmV3IEVycm9yKCdObyBwcm92aWRlcnMnKSk7CiAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgIH0KICAKICAgICAgaWYgKHNlbGYucmVzb2x2ZUNhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKSA9PT0gMSkgewogICAgICAgIHZhciBpbmRleCA9IDA7CiAgICAgICAgdmFyIHByb3ZpZGVycyA9IHNlbGYucHJvdmlkZXJzLnNsaWNlKDApOwogIAogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVOZXh0KGVyciwgY3JlZHMpIHsKICAgICAgICAgIGlmICgoIWVyciAmJiBjcmVkcykgfHwgaW5kZXggPT09IHByb3ZpZGVycy5sZW5ndGgpIHsKICAgICAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHNlbGYucmVzb2x2ZUNhbGxiYWNrcywgZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2soZXJyLCBjcmVkcyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzZWxmLnJlc29sdmVDYWxsYmFja3MubGVuZ3RoID0gMDsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogIAogICAgICAgICAgdmFyIHByb3ZpZGVyID0gcHJvdmlkZXJzW2luZGV4KytdOwogICAgICAgICAgaWYgKHR5cGVvZiBwcm92aWRlciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBjcmVkcyA9IHByb3ZpZGVyLmNhbGwoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNyZWRzID0gcHJvdmlkZXI7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBpZiAoY3JlZHMuZ2V0KSB7CiAgICAgICAgICAgIGNyZWRzLmdldChmdW5jdGlvbiAoZ2V0RXJyKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZU5leHQoZ2V0RXJyLCBnZXRFcnIgPyBudWxsIDogY3JlZHMpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc29sdmVOZXh0KG51bGwsIGNyZWRzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgCiAgICAgICAgcmVzb2x2ZU5leHQoKTsKICAgICAgfQogIAogICAgICByZXR1cm4gc2VsZjsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBUaGUgZGVmYXVsdCBzZXQgb2YgcHJvdmlkZXJzIHVzZWQgYnkgYSB2YW5pbGxhIENyZWRlbnRpYWxQcm92aWRlckNoYWluLgogICAqCiAgICogSW4gdGhlIGJyb3dzZXI6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmRlZmF1bHRQcm92aWRlcnMgPSBbXQogICAqIGBgYAogICAqCiAgICogSW4gTm9kZS5qczoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uZGVmYXVsdFByb3ZpZGVycyA9IFsKICAgKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFscygnQVdTJyk7IH0sCiAgICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FNQVpPTicpOyB9LAogICAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5TaGFyZWRJbmlGaWxlQ3JlZGVudGlhbHMoKTsgfSwKICAgKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuRUNTQ3JlZGVudGlhbHMoKTsgfSwKICAgKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuUHJvY2Vzc0NyZWRlbnRpYWxzKCk7IH0sCiAgICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLlRva2VuRmlsZVdlYklkZW50aXR5Q3JlZGVudGlhbHMoKTsgfSwKICAgKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuRUMyTWV0YWRhdGFDcmVkZW50aWFscygpIH0KICAgKiBdCiAgICogYGBgCiAgICovCiAgQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmRlZmF1bHRQcm92aWRlcnMgPSBbXTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uYWRkUHJvbWlzZXNUb0NsYXNzID0gZnVuY3Rpb24gYWRkUHJvbWlzZXNUb0NsYXNzKFByb21pc2VEZXBlbmRlbmN5KSB7CiAgICB0aGlzLnByb3RvdHlwZS5yZXNvbHZlUHJvbWlzZSA9IEFXUy51dGlsLnByb21pc2lmeU1ldGhvZCgncmVzb2x2ZScsIFByb21pc2VEZXBlbmRlbmN5KTsKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5kZWxldGVQcm9taXNlc0Zyb21DbGFzcyA9IGZ1bmN0aW9uIGRlbGV0ZVByb21pc2VzRnJvbUNsYXNzKCkgewogICAgZGVsZXRlIHRoaXMucHJvdG90eXBlLnJlc29sdmVQcm9taXNlOwogIH07CiAgCiAgQVdTLnV0aWwuYWRkUHJvbWlzZXMoQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluKTsKICAKICB9LHsiLi4vY29yZSI6MTh9XSwyMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIGNyZWRlbnRpYWxzIHJldHJpZXZlZCBmcm9tIFNUUyBTQU1MIHN1cHBvcnQuCiAgICoKICAgKiBCeSBkZWZhdWx0IHRoaXMgcHJvdmlkZXIgZ2V0cyBjcmVkZW50aWFscyB1c2luZyB0aGUKICAgKiB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFNBTUx9IHNlcnZpY2Ugb3BlcmF0aW9uLiBUaGlzIG9wZXJhdGlvbgogICAqIHJlcXVpcmVzIGEgYFJvbGVBcm5gIGNvbnRhaW5pbmcgdGhlIEFSTiBvZiB0aGUgSUFNIHRydXN0IHBvbGljeSBmb3IgdGhlCiAgICogYXBwbGljYXRpb24gZm9yIHdoaWNoIGNyZWRlbnRpYWxzIHdpbGwgYmUgZ2l2ZW4sIGFzIHdlbGwgYXMgYSBgUHJpbmNpcGFsQXJuYAogICAqIHJlcHJlc2VudGluZyB0aGUgQVJOIGZvciB0aGUgU0FNTCBpZGVudGl0eSBwcm92aWRlci4gSW4gYWRkaXRpb24sIHRoZQogICAqIGBTQU1MQXNzZXJ0aW9uYCBtdXN0IGJlIHNldCB0byB0aGUgdG9rZW4gcHJvdmlkZWQgYnkgdGhlIGlkZW50aXR5CiAgICogcHJvdmlkZXIuIFNlZSB7Y29uc3RydWN0b3J9IGZvciBhbiBleGFtcGxlIG9uIGNyZWF0aW5nIGEgY3JlZGVudGlhbHMKICAgKiBvYmplY3Qgd2l0aCBwcm9wZXIgYFJvbGVBcm5gLCBgUHJpbmNpcGFsQXJuYCwgYW5kIGBTQU1MQXNzZXJ0aW9uYCB2YWx1ZXMuCiAgICoKICAgKiAjIyBSZWZyZXNoaW5nIENyZWRlbnRpYWxzIGZyb20gSWRlbnRpdHkgU2VydmljZQogICAqCiAgICogSW4gYWRkaXRpb24gdG8gQVdTIGNyZWRlbnRpYWxzIGV4cGlyaW5nIGFmdGVyIGEgZ2l2ZW4gYW1vdW50IG9mIHRpbWUsIHRoZQogICAqIGxvZ2luIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyIHdpbGwgYWxzbyBleHBpcmUuIE9uY2UgdGhpcyB0b2tlbgogICAqIGV4cGlyZXMsIGl0IHdpbGwgbm90IGJlIHVzYWJsZSB0byByZWZyZXNoIEFXUyBjcmVkZW50aWFscywgYW5kIGFub3RoZXIKICAgKiB0b2tlbiB3aWxsIGJlIG5lZWRlZC4gVGhlIFNESyBkb2VzIG5vdCBtYW5hZ2UgcmVmcmVzaGluZyBvZiB0aGUgdG9rZW4gdmFsdWUsCiAgICogYnV0IHRoaXMgY2FuIGJlIGRvbmUgdGhyb3VnaCBhICJyZWZyZXNoIHRva2VuIiBzdXBwb3J0ZWQgYnkgbW9zdCBpZGVudGl0eQogICAqIHByb3ZpZGVycy4gQ29uc3VsdCB0aGUgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIGlkZW50aXR5IHByb3ZpZGVyIGZvciByZWZyZXNoaW5nCiAgICogdG9rZW5zLiBPbmNlIHRoZSByZWZyZXNoZWQgdG9rZW4gaXMgYWNxdWlyZWQsIHlvdSBzaG91bGQgbWFrZSBzdXJlIHRvIHVwZGF0ZQogICAqIHRoaXMgbmV3IHRva2VuIGluIHRoZSBjcmVkZW50aWFscyBvYmplY3QncyB7cGFyYW1zfSBwcm9wZXJ0eS4gVGhlIGZvbGxvd2luZwogICAqIGNvZGUgd2lsbCB1cGRhdGUgdGhlIFNBTUxBc3NlcnRpb24sIGFzc3VtaW5nIHlvdSBoYXZlIHJldHJpZXZlZCBhbiB1cGRhdGVkCiAgICogdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXI6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscy5wYXJhbXMuU0FNTEFzc2VydGlvbiA9IHVwZGF0ZWRUb2tlbjsKICAgKiBgYGAKICAgKgogICAqIEZ1dHVyZSBjYWxscyB0byBgY3JlZGVudGlhbHMucmVmcmVzaCgpYCB3aWxsIG5vdyB1c2UgdGhlIG5ldyB0b2tlbi4KICAgKgogICAqIEAhYXR0cmlidXRlIHBhcmFtcwogICAqICAgQHJldHVybiBbbWFwXSB0aGUgbWFwIG9mIHBhcmFtcyBwYXNzZWQgdG8KICAgKiAgICAge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhTQU1MfS4gVG8gdXBkYXRlIHRoZSB0b2tlbiwgc2V0IHRoZQogICAqICAgICBgcGFyYW1zLlNBTUxBc3NlcnRpb25gIHByb3BlcnR5LgogICAqLwogIEFXUy5TQU1MQ3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdC4KICAgICAqIEBwYXJhbSAoc2VlIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhTQU1MKQogICAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0CiAgICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLlNBTUxDcmVkZW50aWFscyh7CiAgICAgKiAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvU0FNTFJvbGUnLAogICAgICogICAgIFByaW5jaXBhbEFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvU0FNTFByaW5jaXBhbCcsCiAgICAgKiAgICAgU0FNTEFzc2VydGlvbjogJ2Jhc2U2NC10b2tlbicsIC8vIGJhc2U2NC1lbmNvZGVkIHRva2VuIGZyb20gSWRQCiAgICAgKiAgIH0pOwogICAgICogQHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoU0FNTAogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gU0FNTENyZWRlbnRpYWxzKHBhcmFtcykgewogICAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKICAgICAgdGhpcy5wYXJhbXMgPSBwYXJhbXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBSZWZyZXNoZXMgY3JlZGVudGlhbHMgdXNpbmcge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhTQU1MfQogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIENhbGxlZCB3aGVuIHRoZSBTVFMgc2VydmljZSByZXNwb25kcyAob3IgZmFpbHMpLiBXaGVuCiAgICAgKiAgIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHRoYXQgdGhlIGNyZWRlbnRpYWxzCiAgICAgKiAgIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLAogICAgICogICBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqIEBzZWUgZ2V0CiAgICAgKi8KICAgIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2goY2FsbGJhY2spIHsKICAgICAgdGhpcy5jb2FsZXNjZVJlZnJlc2goY2FsbGJhY2sgfHwgQVdTLnV0aWwuZm4uY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxvYWQ6IGZ1bmN0aW9uIGxvYWQoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzZWxmLmNyZWF0ZUNsaWVudHMoKTsKICAgICAgc2VsZi5zZXJ2aWNlLmFzc3VtZVJvbGVXaXRoU0FNTChmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgIHNlbGYuc2VydmljZS5jcmVkZW50aWFsc0Zyb20oZGF0YSwgc2VsZik7CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNyZWF0ZUNsaWVudHM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnNlcnZpY2UgPSB0aGlzLnNlcnZpY2UgfHwgbmV3IFNUUyh7cGFyYW1zOiB0aGlzLnBhcmFtc30pOwogICAgfQogIAogIH0pOwogIAogIH0seyIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTh9XSwyNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIHRlbXBvcmFyeSBjcmVkZW50aWFscyByZXRyaWV2ZWQgZnJvbSB7QVdTLlNUU30uIFdpdGhvdXQgYW55CiAgICogZXh0cmEgcGFyYW1ldGVycywgY3JlZGVudGlhbHMgd2lsbCBiZSBmZXRjaGVkIGZyb20gdGhlCiAgICoge0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSBvcGVyYXRpb24uIElmIGFuIElBTSByb2xlIGlzIHByb3ZpZGVkLCB0aGUKICAgKiB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvcGVyYXRpb24gd2lsbCBiZSB1c2VkIHRvIGZldGNoIGNyZWRlbnRpYWxzIGZvciB0aGUKICAgKiByb2xlIGluc3RlYWQuCiAgICoKICAgKiBAbm90ZSBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgaXMgZGVwcmVjYXRlZCwgYnV0IHJlbWFpbnMgYXZhaWxhYmxlIGZvcgogICAqICAgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuIHtBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHN9IGlzIHRoZQogICAqICAgcHJlZmVycmVkIGNsYXNzIGZvciB0ZW1wb3JhcnkgY3JlZGVudGlhbHMuCiAgICoKICAgKiBUbyBzZXR1cCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMsIGNvbmZpZ3VyZSBhIHNldCBvZiBtYXN0ZXIgY3JlZGVudGlhbHMKICAgKiB1c2luZyB0aGUgc3RhbmRhcmQgY3JlZGVudGlhbHMgcHJvdmlkZXJzIChlbnZpcm9ubWVudCwgRUMyIGluc3RhbmNlIG1ldGFkYXRhLAogICAqIG9yIGZyb20gdGhlIGZpbGVzeXN0ZW0pLCB0aGVuIHNldCB0aGUgZ2xvYmFsIGNyZWRlbnRpYWxzIHRvIGEgbmV3CiAgICogdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIG9iamVjdDoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiAvLyBOb3RlIHRoYXQgZW52aXJvbm1lbnQgY3JlZGVudGlhbHMgYXJlIGxvYWRlZCBieSBkZWZhdWx0LAogICAqIC8vIHRoZSBmb2xsb3dpbmcgbGluZSBpcyBzaG93biBmb3IgY2xhcml0eToKICAgKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzKCdBV1MnKTsKICAgKgogICAqIC8vIE5vdyBzZXQgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIHNlZWRlZCBmcm9tIHRoZSBtYXN0ZXIgY3JlZGVudGlhbHMKICAgKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscygpOwogICAqCiAgICogLy8gc3Vic2VxdWVudCByZXF1ZXN0cyB3aWxsIG5vdyB1c2UgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZyb20gQVdTIFNUUy4KICAgKiBuZXcgQVdTLlMzKCkubGlzdEJ1Y2tldChmdW5jdGlvbihlcnIsIGRhdGEpIHsgLi4uIH0pOwogICAqIGBgYAogICAqCiAgICogQCFhdHRyaWJ1dGUgbWFzdGVyQ3JlZGVudGlhbHMKICAgKiAgIEByZXR1cm4gW0FXUy5DcmVkZW50aWFsc10gdGhlIG1hc3RlciAobm9uLXRlbXBvcmFyeSkgY3JlZGVudGlhbHMgdXNlZCB0bwogICAqICAgICBnZXQgYW5kIHJlZnJlc2ggdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZyb20gQVdTIFNUUy4KICAgKiBAbm90ZSAoc2VlIGNvbnN0cnVjdG9yKQogICAqLwogIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIG9iamVjdC4KICAgICAqCiAgICAgKiBAbm90ZSBJbiBvcmRlciB0byBjcmVhdGUgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLCB5b3UgZmlyc3QgbmVlZCB0byBoYXZlCiAgICAgKiAgICJtYXN0ZXIiIGNyZWRlbnRpYWxzIGNvbmZpZ3VyZWQgaW4ge0FXUy5Db25maWcuY3JlZGVudGlhbHN9LiBUaGVzZQogICAgICogICBtYXN0ZXIgY3JlZGVudGlhbHMgYXJlIG5lY2Vzc2FyeSB0byByZXRyaWV2ZSB0aGUgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLAogICAgICogICBhcyB3ZWxsIGFzIHJlZnJlc2ggdGhlIGNyZWRlbnRpYWxzIHdoZW4gdGhleSBleHBpcmUuCiAgICAgKiBAcGFyYW0gcGFyYW1zIFttYXBdIGEgbWFwIG9mIG9wdGlvbnMgdGhhdCBhcmUgcGFzc2VkIHRvIHRoZQogICAgICogICB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvciB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59IG9wZXJhdGlvbnMuCiAgICAgKiAgIElmIGEgYFJvbGVBcm5gIHBhcmFtZXRlciBpcyBwYXNzZWQgaW4sIGNyZWRlbnRpYWxzIHdpbGwgYmUgYmFzZWQgb24gdGhlCiAgICAgKiAgIElBTSByb2xlLgogICAgICogQHBhcmFtIG1hc3RlckNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBtYXN0ZXIgKG5vbi10ZW1wb3JhcnkpIGNyZWRlbnRpYWxzCiAgICAgKiAgdXNlZCB0byBnZXQgYW5kIHJlZnJlc2ggdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZyb20gQVdTIFNUUy4KICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdCBmb3IgZ2VuZXJpYyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMoKTsKICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdCBmb3IgYW4gSUFNIHJvbGUKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogICAgICogICAgIFJvbGVBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL1RlbXBvcmFyeUNyZWRlbnRpYWxzJywKICAgICAqICAgfSk7CiAgICAgKiBAc2VlIEFXUy5TVFMuYXNzdW1lUm9sZQogICAgICogQHNlZSBBV1MuU1RTLmdldFNlc3Npb25Ub2tlbgogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gVGVtcG9yYXJ5Q3JlZGVudGlhbHMocGFyYW1zLCBtYXN0ZXJDcmVkZW50aWFscykgewogICAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5sb2FkTWFzdGVyQ3JlZGVudGlhbHMobWFzdGVyQ3JlZGVudGlhbHMpOwogICAgICB0aGlzLmV4cGlyZWQgPSB0cnVlOwogIAogICAgICB0aGlzLnBhcmFtcyA9IHBhcmFtcyB8fCB7fTsKICAgICAgaWYgKHRoaXMucGFyYW1zLlJvbGVBcm4pIHsKICAgICAgICB0aGlzLnBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgPQogICAgICAgICAgdGhpcy5wYXJhbXMuUm9sZVNlc3Npb25OYW1lIHx8ICd0ZW1wb3JhcnktY3JlZGVudGlhbHMnOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBSZWZyZXNoZXMgY3JlZGVudGlhbHMgdXNpbmcge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3IKICAgICAqIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0sIGRlcGVuZGluZyBvbiB3aGV0aGVyIGFuIElBTSByb2xlIEFSTiB3YXMgcGFzc2VkCiAgICAgKiB0byB0aGUgY3JlZGVudGlhbHMge2NvbnN0cnVjdG9yfS4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICBDYWxsZWQgd2hlbiB0aGUgU1RTIHNlcnZpY2UgcmVzcG9uZHMgKG9yIGZhaWxzKS4gV2hlbgogICAgICogICB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyB0aGF0IHRoZSBjcmVkZW50aWFscwogICAgICogICBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwKICAgICAqICAgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKiBAc2VlIGdldAogICAgICovCiAgICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoIChjYWxsYmFjaykgewogICAgICB0aGlzLmNvYWxlc2NlUmVmcmVzaChjYWxsYmFjayB8fCBBV1MudXRpbC5mbi5jYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZDogZnVuY3Rpb24gbG9hZCAoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzZWxmLmNyZWF0ZUNsaWVudHMoKTsKICAgICAgc2VsZi5tYXN0ZXJDcmVkZW50aWFscy5nZXQoZnVuY3Rpb24gKCkgewogICAgICAgIHNlbGYuc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMgPSBzZWxmLm1hc3RlckNyZWRlbnRpYWxzOwogICAgICAgIHZhciBvcGVyYXRpb24gPSBzZWxmLnBhcmFtcy5Sb2xlQXJuID8KICAgICAgICAgIHNlbGYuc2VydmljZS5hc3N1bWVSb2xlIDogc2VsZi5zZXJ2aWNlLmdldFNlc3Npb25Ub2tlbjsKICAgICAgICBvcGVyYXRpb24uY2FsbChzZWxmLnNlcnZpY2UsIGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICAgIHNlbGYuc2VydmljZS5jcmVkZW50aWFsc0Zyb20oZGF0YSwgc2VsZik7CiAgICAgICAgICB9CiAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkTWFzdGVyQ3JlZGVudGlhbHM6IGZ1bmN0aW9uIGxvYWRNYXN0ZXJDcmVkZW50aWFscyAobWFzdGVyQ3JlZGVudGlhbHMpIHsKICAgICAgdGhpcy5tYXN0ZXJDcmVkZW50aWFscyA9IG1hc3RlckNyZWRlbnRpYWxzIHx8IEFXUy5jb25maWcuY3JlZGVudGlhbHM7CiAgICAgIHdoaWxlICh0aGlzLm1hc3RlckNyZWRlbnRpYWxzLm1hc3RlckNyZWRlbnRpYWxzKSB7CiAgICAgICAgdGhpcy5tYXN0ZXJDcmVkZW50aWFscyA9IHRoaXMubWFzdGVyQ3JlZGVudGlhbHMubWFzdGVyQ3JlZGVudGlhbHM7CiAgICAgIH0KICAKICAgICAgaWYgKHR5cGVvZiB0aGlzLm1hc3RlckNyZWRlbnRpYWxzLmdldCAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRoaXMubWFzdGVyQ3JlZGVudGlhbHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKHRoaXMubWFzdGVyQ3JlZGVudGlhbHMpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY3JlYXRlQ2xpZW50czogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLnNlcnZpY2UgPSB0aGlzLnNlcnZpY2UgfHwgbmV3IFNUUyh7cGFyYW1zOiB0aGlzLnBhcmFtc30pOwogICAgfQogIAogIH0pOwogIAogIH0seyIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTh9XSwyNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIGNyZWRlbnRpYWxzIHJldHJpZXZlZCBmcm9tIFNUUyBXZWIgSWRlbnRpdHkgRmVkZXJhdGlvbiBzdXBwb3J0LgogICAqCiAgICogQnkgZGVmYXVsdCB0aGlzIHByb3ZpZGVyIGdldHMgY3JlZGVudGlhbHMgdXNpbmcgdGhlCiAgICoge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0gc2VydmljZSBvcGVyYXRpb24uIFRoaXMgb3BlcmF0aW9uCiAgICogcmVxdWlyZXMgYSBgUm9sZUFybmAgY29udGFpbmluZyB0aGUgQVJOIG9mIHRoZSBJQU0gdHJ1c3QgcG9saWN5IGZvciB0aGUKICAgKiBhcHBsaWNhdGlvbiBmb3Igd2hpY2ggY3JlZGVudGlhbHMgd2lsbCBiZSBnaXZlbi4gSW4gYWRkaXRpb24sIHRoZQogICAqIGBXZWJJZGVudGl0eVRva2VuYCBtdXN0IGJlIHNldCB0byB0aGUgdG9rZW4gcHJvdmlkZWQgYnkgdGhlIGlkZW50aXR5CiAgICogcHJvdmlkZXIuIFNlZSB7Y29uc3RydWN0b3J9IGZvciBhbiBleGFtcGxlIG9uIGNyZWF0aW5nIGEgY3JlZGVudGlhbHMKICAgKiBvYmplY3Qgd2l0aCBwcm9wZXIgYFJvbGVBcm5gIGFuZCBgV2ViSWRlbnRpdHlUb2tlbmAgdmFsdWVzLgogICAqCiAgICogIyMgUmVmcmVzaGluZyBDcmVkZW50aWFscyBmcm9tIElkZW50aXR5IFNlcnZpY2UKICAgKgogICAqIEluIGFkZGl0aW9uIHRvIEFXUyBjcmVkZW50aWFscyBleHBpcmluZyBhZnRlciBhIGdpdmVuIGFtb3VudCBvZiB0aW1lLCB0aGUKICAgKiBsb2dpbiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlciB3aWxsIGFsc28gZXhwaXJlLiBPbmNlIHRoaXMgdG9rZW4KICAgKiBleHBpcmVzLCBpdCB3aWxsIG5vdCBiZSB1c2FibGUgdG8gcmVmcmVzaCBBV1MgY3JlZGVudGlhbHMsIGFuZCBhbm90aGVyCiAgICogdG9rZW4gd2lsbCBiZSBuZWVkZWQuIFRoZSBTREsgZG9lcyBub3QgbWFuYWdlIHJlZnJlc2hpbmcgb2YgdGhlIHRva2VuIHZhbHVlLAogICAqIGJ1dCB0aGlzIGNhbiBiZSBkb25lIHRocm91Z2ggYSAicmVmcmVzaCB0b2tlbiIgc3VwcG9ydGVkIGJ5IG1vc3QgaWRlbnRpdHkKICAgKiBwcm92aWRlcnMuIENvbnN1bHQgdGhlIGRvY3VtZW50YXRpb24gZm9yIHRoZSBpZGVudGl0eSBwcm92aWRlciBmb3IgcmVmcmVzaGluZwogICAqIHRva2Vucy4gT25jZSB0aGUgcmVmcmVzaGVkIHRva2VuIGlzIGFjcXVpcmVkLCB5b3Ugc2hvdWxkIG1ha2Ugc3VyZSB0byB1cGRhdGUKICAgKiB0aGlzIG5ldyB0b2tlbiBpbiB0aGUgY3JlZGVudGlhbHMgb2JqZWN0J3Mge3BhcmFtc30gcHJvcGVydHkuIFRoZSBmb2xsb3dpbmcKICAgKiBjb2RlIHdpbGwgdXBkYXRlIHRoZSBXZWJJZGVudGl0eVRva2VuLCBhc3N1bWluZyB5b3UgaGF2ZSByZXRyaWV2ZWQgYW4gdXBkYXRlZAogICAqIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMucGFyYW1zLldlYklkZW50aXR5VG9rZW4gPSB1cGRhdGVkVG9rZW47CiAgICogYGBgCiAgICoKICAgKiBGdXR1cmUgY2FsbHMgdG8gYGNyZWRlbnRpYWxzLnJlZnJlc2goKWAgd2lsbCBub3cgdXNlIHRoZSBuZXcgdG9rZW4uCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBwYXJhbXMKICAgKiAgIEByZXR1cm4gW21hcF0gdGhlIG1hcCBvZiBwYXJhbXMgcGFzc2VkIHRvCiAgICogICAgIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LiBUbyB1cGRhdGUgdGhlIHRva2VuLCBzZXQgdGhlCiAgICogICAgIGBwYXJhbXMuV2ViSWRlbnRpdHlUb2tlbmAgcHJvcGVydHkuCiAgICogQCFhdHRyaWJ1dGUgZGF0YQogICAqICAgQHJldHVybiBbbWFwXSB0aGUgcmF3IGRhdGEgcmVzcG9uc2UgZnJvbSB0aGUgY2FsbCB0bwogICAqICAgICB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4gVXNlIHRoaXMgaWYgeW91IHdhbnQgdG8gZ2V0CiAgICogICAgIGFjY2VzcyB0byBvdGhlciBwcm9wZXJ0aWVzIGZyb20gdGhlIHJlc3BvbnNlLgogICAqLwogIEFXUy5XZWJJZGVudGl0eUNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QuCiAgICAgKiBAcGFyYW0gKHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkpCiAgICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuV2ViSWRlbnRpdHlDcmVkZW50aWFscyh7CiAgICAgKiAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvV2ViSWRlbnRpdHknLAogICAgICogICAgIFdlYklkZW50aXR5VG9rZW46ICdBQkNERUZHSElKS0xNTk9QJywgLy8gdG9rZW4gZnJvbSBpZGVudGl0eSBzZXJ2aWNlCiAgICAgKiAgICAgUm9sZVNlc3Npb25OYW1lOiAnd2ViJyAvLyBvcHRpb25hbCBuYW1lLCBkZWZhdWx0cyB0byB3ZWItaWRlbnRpdHkKICAgICAqICAgfSwgewogICAgICogICAgIC8vIG9wdGlvbmFsbHkgcHJvdmlkZSBjb25maWd1cmF0aW9uIHRvIGFwcGx5IHRvIHRoZSB1bmRlcmx5aW5nIEFXUy5TVFMgc2VydmljZSBjbGllbnQKICAgICAqICAgICAvLyBpZiBjb25maWd1cmF0aW9uIGlzIG5vdCBwcm92aWRlZCwgdGhlbiBjb25maWd1cmF0aW9uIHdpbGwgYmUgcHVsbGVkIGZyb20gQVdTLmNvbmZpZwogICAgICoKICAgICAqICAgICAvLyBzcGVjaWZ5IHRpbWVvdXQgb3B0aW9ucwogICAgICogICAgIGh0dHBPcHRpb25zOiB7CiAgICAgKiAgICAgICB0aW1lb3V0OiAxMDAKICAgICAqICAgICB9CiAgICAgKiAgIH0pOwogICAgICogQHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkKICAgICAqIEBzZWUgQVdTLkNvbmZpZwogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gV2ViSWRlbnRpdHlDcmVkZW50aWFscyhwYXJhbXMsIGNsaWVudENvbmZpZykgewogICAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKICAgICAgdGhpcy5wYXJhbXMgPSBwYXJhbXM7CiAgICAgIHRoaXMucGFyYW1zLlJvbGVTZXNzaW9uTmFtZSA9IHRoaXMucGFyYW1zLlJvbGVTZXNzaW9uTmFtZSB8fCAnd2ViLWlkZW50aXR5JzsKICAgICAgdGhpcy5kYXRhID0gbnVsbDsKICAgICAgdGhpcy5fY2xpZW50Q29uZmlnID0gQVdTLnV0aWwuY29weShjbGllbnRDb25maWcgfHwge30pOwogICAgfSwKICAKICAgIC8qKgogICAgICogUmVmcmVzaGVzIGNyZWRlbnRpYWxzIHVzaW5nIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9CiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgQ2FsbGVkIHdoZW4gdGhlIFNUUyBzZXJ2aWNlIHJlc3BvbmRzIChvciBmYWlscykuIFdoZW4KICAgICAqICAgdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgdGhhdCB0aGUgY3JlZGVudGlhbHMKICAgICAqICAgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsCiAgICAgKiAgIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogQHNlZSBnZXQKICAgICAqLwogICAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaChjYWxsYmFjaykgewogICAgICB0aGlzLmNvYWxlc2NlUmVmcmVzaChjYWxsYmFjayB8fCBBV1MudXRpbC5mbi5jYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZDogZnVuY3Rpb24gbG9hZChjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHNlbGYuY3JlYXRlQ2xpZW50cygpOwogICAgICBzZWxmLnNlcnZpY2UuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eShmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgc2VsZi5kYXRhID0gbnVsbDsKICAgICAgICBpZiAoIWVycikgewogICAgICAgICAgc2VsZi5kYXRhID0gZGF0YTsKICAgICAgICAgIHNlbGYuc2VydmljZS5jcmVkZW50aWFsc0Zyb20oZGF0YSwgc2VsZik7CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNyZWF0ZUNsaWVudHM6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMuc2VydmljZSkgewogICAgICAgIHZhciBzdHNDb25maWcgPSBBV1MudXRpbC5tZXJnZSh7fSwgdGhpcy5fY2xpZW50Q29uZmlnKTsKICAgICAgICBzdHNDb25maWcucGFyYW1zID0gdGhpcy5wYXJhbXM7CiAgICAgICAgdGhpcy5zZXJ2aWNlID0gbmV3IFNUUyhzdHNDb25maWcpOwogICAgICB9CiAgICB9CiAgCiAgfSk7CiAgCiAgfSx7Ii4uLy4uL2NsaWVudHMvc3RzIjo4LCIuLi9jb3JlIjoxOH1dLDI2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKHByb2Nlc3MpeyhmdW5jdGlvbiAoKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuL3V0aWwnKTsKICB2YXIgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkRW52cyA9IFsnQVdTX0VOQUJMRV9FTkRQT0lOVF9ESVNDT1ZFUlknLCAnQVdTX0VORFBPSU5UX0RJU0NPVkVSWV9FTkFCTEVEJ107CiAgCiAgLyoqCiAgICogR2VuZXJhdGUga2V5IChleGNlcHQgcmVzb3VyY2VzIGFuZCBvcGVyYXRpb24gcGFydCkgdG8gaW5kZXggdGhlIGVuZHBvaW50cyBpbiB0aGUgY2FjaGUKICAgKiBJZiBpbnB1dCBzaGFwZSBoYXMgZW5kcG9pbnRkaXNjb3ZlcnlpZCB0cmFpdCB0aGVuIHVzZQogICAqICAgYWNjZXNzS2V5ICsgb3BlcmF0aW9uICsgcmVzb3VyY2VzICsgcmVnaW9uICsgc2VydmljZSBhcyBjYWNoZSBrZXkKICAgKiBJZiBpbnB1dCBzaGFwZSBkb2Vzbid0IGhhdmUgZW5kcG9pbnRkaXNjb3ZlcnlpZCB0cmFpdCB0aGVuIHVzZQogICAqICAgYWNjZXNzS2V5ICsgcmVnaW9uICsgc2VydmljZSBhcyBjYWNoZSBrZXkKICAgKiBAcmV0dXJuIFttYXA8U3RyaW5nLFN0cmluZz5dIG9iamVjdCB3aXRoIGtleXMgdG8gaW5kZXggZW5kcG9pbnRzLgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGdldENhY2hlS2V5KHJlcXVlc3QpIHsKICAgIHZhciBzZXJ2aWNlID0gcmVxdWVzdC5zZXJ2aWNlOwogICAgdmFyIGFwaSA9IHNlcnZpY2UuYXBpIHx8IHt9OwogICAgdmFyIG9wZXJhdGlvbnMgPSBhcGkub3BlcmF0aW9uczsKICAgIHZhciBpZGVudGlmaWVycyA9IHt9OwogICAgaWYgKHNlcnZpY2UuY29uZmlnLnJlZ2lvbikgewogICAgICBpZGVudGlmaWVycy5yZWdpb24gPSBzZXJ2aWNlLmNvbmZpZy5yZWdpb247CiAgICB9CiAgICBpZiAoYXBpLnNlcnZpY2VJZCkgewogICAgICBpZGVudGlmaWVycy5zZXJ2aWNlSWQgPSBhcGkuc2VydmljZUlkOwogICAgfQogICAgaWYgKHNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkKSB7CiAgICAgIGlkZW50aWZpZXJzLmFjY2Vzc0tleUlkID0gc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQ7CiAgICB9CiAgICByZXR1cm4gaWRlbnRpZmllcnM7CiAgfQogIAogIC8qKgogICAqIFJlY3Vyc2l2ZSBoZWxwZXIgZm9yIG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnMoKS4KICAgKiBMb29rcyBmb3IgcmVxdWlyZWQgc3RyaW5nIGlucHV0IG1lbWJlcnMgdGhhdCBoYXZlICdlbmRwb2ludGRpc2NvdmVyeWlkJyB0cmFpdC4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzSGVscGVyKHJlc3VsdCwgcGFyYW1zLCBzaGFwZSkgewogICAgaWYgKCFzaGFwZSB8fCBwYXJhbXMgPT09IHVuZGVmaW5lZCB8fCBwYXJhbXMgPT09IG51bGwpIHJldHVybjsKICAgIGlmIChzaGFwZS50eXBlID09PSAnc3RydWN0dXJlJyAmJiBzaGFwZS5yZXF1aXJlZCAmJiBzaGFwZS5yZXF1aXJlZC5sZW5ndGggPiAwKSB7CiAgICAgIHV0aWwuYXJyYXlFYWNoKHNoYXBlLnJlcXVpcmVkLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgdmFyIG1lbWJlclNoYXBlID0gc2hhcGUubWVtYmVyc1tuYW1lXTsKICAgICAgICBpZiAobWVtYmVyU2hhcGUuZW5kcG9pbnREaXNjb3ZlcnlJZCA9PT0gdHJ1ZSkgewogICAgICAgICAgdmFyIGxvY2F0aW9uTmFtZSA9IG1lbWJlclNoYXBlLmlzTG9jYXRpb25OYW1lID8gbWVtYmVyU2hhcGUubmFtZSA6IG5hbWU7CiAgICAgICAgICByZXN1bHRbbG9jYXRpb25OYW1lXSA9IFN0cmluZyhwYXJhbXNbbmFtZV0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzSGVscGVyKHJlc3VsdCwgcGFyYW1zW25hbWVdLCBtZW1iZXJTaGFwZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogR2V0IGN1c3RvbSBpZGVudGlmaWVycyBmb3IgY2FjaGUga2V5LgogICAqIElkZW50aWZpZXMgY3VzdG9tIGlkZW50aWZpZXJzIGJ5IGNoZWNraW5nIGVhY2ggc2hhcGUncyBgZW5kcG9pbnREaXNjb3ZlcnlJZGAgdHJhaXQuCiAgICogQHBhcmFtIFtvYmplY3RdIHJlcXVlc3Qgb2JqZWN0CiAgICogQHBhcmFtIFtvYmplY3RdIGlucHV0IHNoYXBlIG9mIHRoZSBnaXZlbiBvcGVyYXRpb24ncyBhcGkKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzKHJlcXVlc3QsIHNoYXBlKSB7CiAgICB2YXIgaWRlbnRpZmllcnMgPSB7fTsKICAgIG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnNIZWxwZXIoaWRlbnRpZmllcnMsIHJlcXVlc3QucGFyYW1zLCBzaGFwZSk7CiAgICByZXR1cm4gaWRlbnRpZmllcnM7CiAgfQogIAogIC8qKgogICAqIENhbGwgZW5kcG9pbnQgZGlzY292ZXJ5IG9wZXJhdGlvbiB3aGVuIGl0J3Mgb3B0aW9uYWwuCiAgICogV2hlbiBlbmRwb2ludCBpcyBhdmFpbGFibGUgaW4gY2FjaGUgdGhlbiB1c2UgdGhlIGNhY2hlZCBlbmRwb2ludHMuIElmIGVuZHBvaW50cwogICAqIGFyZSB1bmF2YWlsYWJsZSB0aGVuIHVzZSByZWdpb25hbCBlbmRwb2ludHMgYW5kIGNhbGwgZW5kcG9pbnQgZGlzY292ZXJ5IG9wZXJhdGlvbgogICAqIGFzeW5jaHJvbm91c2x5LiBUaGlzIGlzIHR1cm5lZCBvZmYgYnkgZGVmYXVsdC4KICAgKiBAcGFyYW0gW29iamVjdF0gcmVxdWVzdCBvYmplY3QKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBvcHRpb25hbERpc2NvdmVyRW5kcG9pbnQocmVxdWVzdCkgewogICAgdmFyIHNlcnZpY2UgPSByZXF1ZXN0LnNlcnZpY2U7CiAgICB2YXIgYXBpID0gc2VydmljZS5hcGk7CiAgICB2YXIgb3BlcmF0aW9uTW9kZWwgPSBhcGkub3BlcmF0aW9ucyA/IGFwaS5vcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXSA6IHVuZGVmaW5lZDsKICAgIHZhciBpbnB1dFNoYXBlID0gb3BlcmF0aW9uTW9kZWwgPyBvcGVyYXRpb25Nb2RlbC5pbnB1dCA6IHVuZGVmaW5lZDsKICAKICAgIHZhciBpZGVudGlmaWVycyA9IG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnMocmVxdWVzdCwgaW5wdXRTaGFwZSk7CiAgICB2YXIgY2FjaGVLZXkgPSBnZXRDYWNoZUtleShyZXF1ZXN0KTsKICAgIGlmIChPYmplY3Qua2V5cyhpZGVudGlmaWVycykubGVuZ3RoID4gMCkgewogICAgICBjYWNoZUtleSA9IHV0aWwudXBkYXRlKGNhY2hlS2V5LCBpZGVudGlmaWVycyk7CiAgICAgIGlmIChvcGVyYXRpb25Nb2RlbCkgY2FjaGVLZXkub3BlcmF0aW9uID0gb3BlcmF0aW9uTW9kZWwubmFtZTsKICAgIH0KICAgIHZhciBlbmRwb2ludHMgPSBBV1MuZW5kcG9pbnRDYWNoZS5nZXQoY2FjaGVLZXkpOwogICAgaWYgKGVuZHBvaW50cyAmJiBlbmRwb2ludHMubGVuZ3RoID09PSAxICYmIGVuZHBvaW50c1swXS5BZGRyZXNzID09PSAnJykgewogICAgICAvL2VuZHBvaW50IG9wZXJhdGlvbiBpcyBiZWluZyBtYWRlIGJ1dCByZXNwb25zZSBub3QgeWV0IHJlY2VpdmVkCiAgICAgIC8vb3IgZW5kcG9pbnQgb3BlcmF0aW9uIGp1c3QgZmFpbGVkIGluIDEgbWludXRlCiAgICAgIHJldHVybjsKICAgIH0gZWxzZSBpZiAoZW5kcG9pbnRzICYmIGVuZHBvaW50cy5sZW5ndGggPiAwKSB7CiAgICAgIC8vZm91bmQgZW5kcG9pbnQgcmVjb3JkIGZyb20gY2FjaGUKICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC51cGRhdGVFbmRwb2ludChlbmRwb2ludHNbMF0uQWRkcmVzcyk7CiAgICB9IGVsc2UgewogICAgICAvL2VuZHBvaW50IHJlY29yZCBub3QgaW4gY2FjaGUgb3Igb3V0ZGF0ZWQuIG1ha2UgZGlzY292ZXJ5IG9wZXJhdGlvbgogICAgICB2YXIgZW5kcG9pbnRSZXF1ZXN0ID0gc2VydmljZS5tYWtlUmVxdWVzdChhcGkuZW5kcG9pbnRPcGVyYXRpb24sIHsKICAgICAgICBPcGVyYXRpb246IG9wZXJhdGlvbk1vZGVsLm5hbWUsCiAgICAgICAgSWRlbnRpZmllcnM6IGlkZW50aWZpZXJzLAogICAgICB9KTsKICAgICAgYWRkQXBpVmVyc2lvbkhlYWRlcihlbmRwb2ludFJlcXVlc3QpOwogICAgICBlbmRwb2ludFJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUEFSQU1FVEVSUyk7CiAgICAgIGVuZHBvaW50UmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigncmV0cnknLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5SRVRSWV9DSEVDSyk7CiAgICAgIC8vcHV0IGluIGEgcGxhY2Vob2xkZXIgZm9yIGVuZHBvaW50cyBhbHJlYWR5IHJlcXVlc3RlZCwgcHJldmVudAogICAgICAvL3RvbyBtdWNoIGluLWZsaWdodCBjYWxscwogICAgICBBV1MuZW5kcG9pbnRDYWNoZS5wdXQoY2FjaGVLZXksIFt7CiAgICAgICAgQWRkcmVzczogJycsCiAgICAgICAgQ2FjaGVQZXJpb2RJbk1pbnV0ZXM6IDEKICAgICAgfV0pOwogICAgICBlbmRwb2ludFJlcXVlc3Quc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLkVuZHBvaW50cykgewogICAgICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucHV0KGNhY2hlS2V5LCBkYXRhLkVuZHBvaW50cyk7CiAgICAgICAgfSBlbHNlIGlmIChlcnIpIHsKICAgICAgICAgIEFXUy5lbmRwb2ludENhY2hlLnB1dChjYWNoZUtleSwgW3sKICAgICAgICAgICAgQWRkcmVzczogJycsCiAgICAgICAgICAgIENhY2hlUGVyaW9kSW5NaW51dGVzOiAxIC8vbm90IHRvIG1ha2UgbW9yZSBlbmRwb2ludCBvcGVyYXRpb24gaW4gbmV4dCAxIG1pbnV0ZQogICAgICAgICAgfV0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfQogIAogIHZhciByZXF1ZXN0UXVldWUgPSB7fTsKICAKICAvKioKICAgKiBDYWxsIGVuZHBvaW50IGRpc2NvdmVyeSBvcGVyYXRpb24gd2hlbiBpdCdzIHJlcXVpcmVkLgogICAqIFdoZW4gZW5kcG9pbnQgaXMgYXZhaWxhYmxlIGluIGNhY2hlIHRoZW4gdXNlIGNhY2hlZCBvbmVzLiBJZiBlbmRwb2ludHMgYXJlCiAgICogdW5hdmFpbGFibGUgdGhlbiBTREsgc2hvdWxkIGNhbGwgZW5kcG9pbnQgb3BlcmF0aW9uIHRoZW4gdXNlIHJldHVybmVkIG5ldwogICAqIGVuZHBvaW50IGZvciB0aGUgYXBpIGNhbGwuIFNESyB3aWxsIGF1dG9tYXRpY2FsbHkgYXR0ZW1wdCB0byBkbyBlbmRwb2ludAogICAqIGRpc2NvdmVyeS4gVGhpcyBpcyB0dXJuZWQgb2ZmIGJ5IGRlZmF1bHQKICAgKiBAcGFyYW0gW29iamVjdF0gcmVxdWVzdCBvYmplY3QKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiByZXF1aXJlZERpc2NvdmVyRW5kcG9pbnQocmVxdWVzdCwgZG9uZSkgewogICAgdmFyIHNlcnZpY2UgPSByZXF1ZXN0LnNlcnZpY2U7CiAgICB2YXIgYXBpID0gc2VydmljZS5hcGk7CiAgICB2YXIgb3BlcmF0aW9uTW9kZWwgPSBhcGkub3BlcmF0aW9ucyA/IGFwaS5vcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXSA6IHVuZGVmaW5lZDsKICAgIHZhciBpbnB1dFNoYXBlID0gb3BlcmF0aW9uTW9kZWwgPyBvcGVyYXRpb25Nb2RlbC5pbnB1dCA6IHVuZGVmaW5lZDsKICAKICAgIHZhciBpZGVudGlmaWVycyA9IG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnMocmVxdWVzdCwgaW5wdXRTaGFwZSk7CiAgICB2YXIgY2FjaGVLZXkgPSBnZXRDYWNoZUtleShyZXF1ZXN0KTsKICAgIGlmIChPYmplY3Qua2V5cyhpZGVudGlmaWVycykubGVuZ3RoID4gMCkgewogICAgICBjYWNoZUtleSA9IHV0aWwudXBkYXRlKGNhY2hlS2V5LCBpZGVudGlmaWVycyk7CiAgICAgIGlmIChvcGVyYXRpb25Nb2RlbCkgY2FjaGVLZXkub3BlcmF0aW9uID0gb3BlcmF0aW9uTW9kZWwubmFtZTsKICAgIH0KICAgIHZhciBjYWNoZUtleVN0ciA9IEFXUy5FbmRwb2ludENhY2hlLmdldEtleVN0cmluZyhjYWNoZUtleSk7CiAgICB2YXIgZW5kcG9pbnRzID0gQVdTLmVuZHBvaW50Q2FjaGUuZ2V0KGNhY2hlS2V5U3RyKTsgLy9lbmRwb2ludCBjYWNoZSBhbHNvIGFjY2VwdHMgc3RyaW5nIGtleXMKICAgIGlmIChlbmRwb2ludHMgJiYgZW5kcG9pbnRzLmxlbmd0aCA9PT0gMSAmJiBlbmRwb2ludHNbMF0uQWRkcmVzcyA9PT0gJycpIHsKICAgICAgLy9lbmRwb2ludCBvcGVyYXRpb24gaXMgYmVpbmcgbWFkZSBidXQgcmVzcG9uc2Ugbm90IHlldCByZWNlaXZlZAogICAgICAvL3B1c2ggcmVxdWVzdCBvYmplY3QgdG8gYSBwZW5kaW5nIHF1ZXVlCiAgICAgIGlmICghcmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXSkgcmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXSA9IFtdOwogICAgICByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdLnB1c2goe3JlcXVlc3Q6IHJlcXVlc3QsIGNhbGxiYWNrOiBkb25lfSk7CiAgICAgIHJldHVybjsKICAgIH0gZWxzZSBpZiAoZW5kcG9pbnRzICYmIGVuZHBvaW50cy5sZW5ndGggPiAwKSB7CiAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QudXBkYXRlRW5kcG9pbnQoZW5kcG9pbnRzWzBdLkFkZHJlc3MpOwogICAgICBkb25lKCk7CiAgICB9IGVsc2UgewogICAgICB2YXIgZW5kcG9pbnRSZXF1ZXN0ID0gc2VydmljZS5tYWtlUmVxdWVzdChhcGkuZW5kcG9pbnRPcGVyYXRpb24sIHsKICAgICAgICBPcGVyYXRpb246IG9wZXJhdGlvbk1vZGVsLm5hbWUsCiAgICAgICAgSWRlbnRpZmllcnM6IGlkZW50aWZpZXJzLAogICAgICB9KTsKICAgICAgZW5kcG9pbnRSZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1BBUkFNRVRFUlMpOwogICAgICBhZGRBcGlWZXJzaW9uSGVhZGVyKGVuZHBvaW50UmVxdWVzdCk7CiAgCiAgICAgIC8vcHV0IGluIGEgcGxhY2Vob2xkZXIgZm9yIGVuZHBvaW50cyBhbHJlYWR5IHJlcXVlc3RlZCwgcHJldmVudAogICAgICAvL3RvbyBtdWNoIGluLWZsaWdodCBjYWxscwogICAgICBBV1MuZW5kcG9pbnRDYWNoZS5wdXQoY2FjaGVLZXlTdHIsIFt7CiAgICAgICAgQWRkcmVzczogJycsCiAgICAgICAgQ2FjaGVQZXJpb2RJbk1pbnV0ZXM6IDYwIC8vbG9uZy1saXZlIGNhY2hlCiAgICAgIH1dKTsKICAgICAgZW5kcG9pbnRSZXF1ZXN0LnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgdmFyIGVycm9yUGFyYW1zID0gewogICAgICAgICAgICBjb2RlOiAnRW5kcG9pbnREaXNjb3ZlcnlFeGNlcHRpb24nLAogICAgICAgICAgICBtZXNzYWdlOiAnUmVxdWVzdCBjYW5ub3QgYmUgZnVsZmlsbGVkIHdpdGhvdXQgc3BlY2lmeWluZyBhbiBlbmRwb2ludCcsCiAgICAgICAgICAgIHJldHJ5YWJsZTogZmFsc2UKICAgICAgICAgIH07CiAgICAgICAgICByZXF1ZXN0LnJlc3BvbnNlLmVycm9yID0gdXRpbC5lcnJvcihlcnIsIGVycm9yUGFyYW1zKTsKICAgICAgICAgIEFXUy5lbmRwb2ludENhY2hlLnJlbW92ZShjYWNoZUtleSk7CiAgCiAgICAgICAgICAvL2ZhaWwgYWxsIHRoZSBwZW5kaW5nIHJlcXVlc3RzIGluIGJhdGNoCiAgICAgICAgICBpZiAocmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXSkgewogICAgICAgICAgICB2YXIgcGVuZGluZ1JlcXVlc3RzID0gcmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXTsKICAgICAgICAgICAgdXRpbC5hcnJheUVhY2gocGVuZGluZ1JlcXVlc3RzLCBmdW5jdGlvbihyZXF1ZXN0Q29udGV4dCkgewogICAgICAgICAgICAgIHJlcXVlc3RDb250ZXh0LnJlcXVlc3QucmVzcG9uc2UuZXJyb3IgPSB1dGlsLmVycm9yKGVyciwgZXJyb3JQYXJhbXMpOwogICAgICAgICAgICAgIHJlcXVlc3RDb250ZXh0LmNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkZWxldGUgcmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGRhdGEpIHsKICAgICAgICAgIEFXUy5lbmRwb2ludENhY2hlLnB1dChjYWNoZUtleVN0ciwgZGF0YS5FbmRwb2ludHMpOwogICAgICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC51cGRhdGVFbmRwb2ludChkYXRhLkVuZHBvaW50c1swXS5BZGRyZXNzKTsKICAKICAgICAgICAgIC8vdXBkYXRlIHRoZSBlbmRwb2ludCBmb3IgYWxsIHRoZSBwZW5kaW5nIHJlcXVlc3RzIGluIGJhdGNoCiAgICAgICAgICBpZiAocmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXSkgewogICAgICAgICAgICB2YXIgcGVuZGluZ1JlcXVlc3RzID0gcmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXTsKICAgICAgICAgICAgdXRpbC5hcnJheUVhY2gocGVuZGluZ1JlcXVlc3RzLCBmdW5jdGlvbihyZXF1ZXN0Q29udGV4dCkgewogICAgICAgICAgICAgIHJlcXVlc3RDb250ZXh0LnJlcXVlc3QuaHR0cFJlcXVlc3QudXBkYXRlRW5kcG9pbnQoZGF0YS5FbmRwb2ludHNbMF0uQWRkcmVzcyk7CiAgICAgICAgICAgICAgcmVxdWVzdENvbnRleHQuY2FsbGJhY2soKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRlbGV0ZSByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBkb25lKCk7CiAgICAgIH0pOwogICAgfQogIH0KICAKICAvKioKICAgKiBhZGQgYXBpIHZlcnNpb24gaGVhZGVyIHRvIGVuZHBvaW50IG9wZXJhdGlvbgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGFkZEFwaVZlcnNpb25IZWFkZXIoZW5kcG9pbnRSZXF1ZXN0KSB7CiAgICB2YXIgYXBpID0gZW5kcG9pbnRSZXF1ZXN0LnNlcnZpY2UuYXBpOwogICAgdmFyIGFwaVZlcnNpb24gPSBhcGkuYXBpVmVyc2lvbjsKICAgIGlmIChhcGlWZXJzaW9uICYmICFlbmRwb2ludFJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1sneC1hbXotYXBpLXZlcnNpb24nXSkgewogICAgICBlbmRwb2ludFJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1sneC1hbXotYXBpLXZlcnNpb24nXSA9IGFwaVZlcnNpb247CiAgICB9CiAgfQogIAogIC8qKgogICAqIElmIGFwaSBjYWxsIGdldHMgaW52YWxpZCBlbmRwb2ludCBleGNlcHRpb24sIFNESyBzaG91bGQgYXR0ZW1wdCB0byByZW1vdmUgdGhlIGludmFsaWQKICAgKiBlbmRwb2ludCBmcm9tIGNhY2hlLgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGludmFsaWRhdGVDYWNoZWRFbmRwb2ludHMocmVzcG9uc2UpIHsKICAgIHZhciBlcnJvciA9IHJlc3BvbnNlLmVycm9yOwogICAgdmFyIGh0dHBSZXNwb25zZSA9IHJlc3BvbnNlLmh0dHBSZXNwb25zZTsKICAgIGlmIChlcnJvciAmJgogICAgICAoZXJyb3IuY29kZSA9PT0gJ0ludmFsaWRFbmRwb2ludEV4Y2VwdGlvbicgfHwgaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDQyMSkKICAgICkgewogICAgICB2YXIgcmVxdWVzdCA9IHJlc3BvbnNlLnJlcXVlc3Q7CiAgICAgIHZhciBvcGVyYXRpb25zID0gcmVxdWVzdC5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zIHx8IHt9OwogICAgICB2YXIgaW5wdXRTaGFwZSA9IG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dID8gb3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0uaW5wdXQgOiB1bmRlZmluZWQ7CiAgICAgIHZhciBpZGVudGlmaWVycyA9IG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnMocmVxdWVzdCwgaW5wdXRTaGFwZSk7CiAgICAgIHZhciBjYWNoZUtleSA9IGdldENhY2hlS2V5KHJlcXVlc3QpOwogICAgICBpZiAoT2JqZWN0LmtleXMoaWRlbnRpZmllcnMpLmxlbmd0aCA+IDApIHsKICAgICAgICBjYWNoZUtleSA9IHV0aWwudXBkYXRlKGNhY2hlS2V5LCBpZGVudGlmaWVycyk7CiAgICAgICAgaWYgKG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dKSBjYWNoZUtleS5vcGVyYXRpb24gPSBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXS5uYW1lOwogICAgICB9CiAgICAgIEFXUy5lbmRwb2ludENhY2hlLnJlbW92ZShjYWNoZUtleSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIElmIGVuZHBvaW50IGlzIGV4cGxpY2l0bHkgY29uZmlndXJlZCwgU0RLIHNob3VsZCBub3QgZG8gZW5kcG9pbnQgZGlzY292ZXJ5IGluIGFueXRpbWUuCiAgICogQHBhcmFtIFtvYmplY3RdIGNsaWVudCBTZXJ2aWNlIGNsaWVudCBvYmplY3QuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gaGFzQ3VzdG9tRW5kcG9pbnQoY2xpZW50KSB7CiAgICAvL2lmIHNldCBlbmRwb2ludCBpcyBzZXQgZm9yIHNwZWNpZmljIGNsaWVudCwgZW5hYmxlIGVuZHBvaW50IGRpc2NvdmVyeSB3aWxsIHJhaXNlIGFuIGVycm9yLgogICAgaWYgKGNsaWVudC5fb3JpZ2luYWxDb25maWcgJiYgY2xpZW50Ll9vcmlnaW5hbENvbmZpZy5lbmRwb2ludCAmJiBjbGllbnQuX29yaWdpbmFsQ29uZmlnLmVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZCA9PT0gdHJ1ZSkgewogICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogJ0NvbmZpZ3VyYXRpb25FeGNlcHRpb24nLAogICAgICAgIG1lc3NhZ2U6ICdDdXN0b20gZW5kcG9pbnQgaXMgc3VwcGxpZWQ7IGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZCBtdXN0IG5vdCBiZSB0cnVlLicKICAgICAgfSk7CiAgICB9OwogICAgdmFyIHN2Y0NvbmZpZyA9IEFXUy5jb25maWdbY2xpZW50LnNlcnZpY2VJZGVudGlmaWVyXSB8fCB7fTsKICAgIHJldHVybiBCb29sZWFuKEFXUy5jb25maWcuZW5kcG9pbnQgfHwgc3ZjQ29uZmlnLmVuZHBvaW50IHx8IChjbGllbnQuX29yaWdpbmFsQ29uZmlnICYmIGNsaWVudC5fb3JpZ2luYWxDb25maWcuZW5kcG9pbnQpKTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gaXNGYWxzeSh2YWx1ZSkgewogICAgcmV0dXJuIFsnZmFsc2UnLCAnMCddLmluZGV4T2YodmFsdWUpID49IDA7CiAgfQogIAogIC8qKgogICAqIElmIGVuZHBvaW50IGRpc2NvdmVyeSBzaG91bGQgcGVyZm9ybSBmb3IgdGhpcyByZXF1ZXN0IHdoZW4gZW5kcG9pbnQgZGlzY292ZXJ5IGlzIG9wdGlvbmFsLgogICAqIFNESyBwZXJmb3JtcyBjb25maWcgcmVzb2x1dGlvbiBpbiBvcmRlciBsaWtlIGJlbG93OgogICAqIDEuIElmIHR1cm5lZCBvbiBjbGllbnQgY29uZmlndXJhdGlvbihkZWZhdWx0IHRvIG9mZikgdGhlbiB0dXJuIG9uIGVuZHBvaW50IGRpc2NvdmVyeS4KICAgKiAyLiBJZiB0dXJuZWQgb24gaW4gZW52IEFXU19FTkFCTEVfRU5EUE9JTlRfRElTQ09WRVJZIHRoZW4gdHVybiBvbiBlbmRwb2ludCBkaXNjb3ZlcnkuCiAgICogMy4gSWYgdHVybmVkIG9uIGluIHNoYXJlZCBpbmkgY29uZmlnIGZpbGUgd2l0aCBrZXkgJ2VuZHBvaW50X2Rpc2NvdmVyeV9lbmFibGVkJywgdGhlbgogICAqICAgdHVybiBvbiBlbmRwb2ludCBkaXNjb3ZlcnkuCiAgICogQHBhcmFtIFtvYmplY3RdIHJlcXVlc3QgcmVxdWVzdCBvYmplY3QuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gaXNFbmRwb2ludERpc2NvdmVyeUFwcGxpY2FibGUocmVxdWVzdCkgewogICAgdmFyIHNlcnZpY2UgPSByZXF1ZXN0LnNlcnZpY2UgfHwge307CiAgICBpZiAoc2VydmljZS5jb25maWcuZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkID09PSB0cnVlKSByZXR1cm4gdHJ1ZTsKICAKICAgIC8vc2hhcmVkIGluaSBmaWxlIGlzIG9ubHkgYXZhaWxhYmxlIGluIE5vZGUKICAgIC8vbm90IHRvIGNoZWNrIGVudiBpbiBicm93c2VyCiAgICBpZiAodXRpbC5pc0Jyb3dzZXIoKSkgcmV0dXJuIGZhbHNlOwogIAogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWRFbnZzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBlbnYgPSBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWRFbnZzW2ldOwogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHByb2Nlc3MuZW52LCBlbnYpKSB7CiAgICAgICAgaWYgKHByb2Nlc3MuZW52W2Vudl0gPT09ICcnIHx8IHByb2Nlc3MuZW52W2Vudl0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgICAgICBjb2RlOiAnQ29uZmlndXJhdGlvbkV4Y2VwdGlvbicsCiAgICAgICAgICAgIG1lc3NhZ2U6ICdlbnZpcm9ubWVudGFsIHZhcmlhYmxlICcgKyBlbnYgKyAnIGNhbm5vdCBiZSBzZXQgdG8gbm90aGluZycKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoIWlzRmFsc3kocHJvY2Vzcy5lbnZbZW52XSkpIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CiAgCiAgICB2YXIgY29uZmlnRmlsZSA9IHt9OwogICAgdHJ5IHsKICAgICAgY29uZmlnRmlsZSA9IEFXUy51dGlsLmluaUxvYWRlciA/IEFXUy51dGlsLmluaUxvYWRlci5sb2FkRnJvbSh7CiAgICAgICAgaXNDb25maWc6IHRydWUsCiAgICAgICAgZmlsZW5hbWU6IHByb2Nlc3MuZW52W0FXUy51dGlsLnNoYXJlZENvbmZpZ0ZpbGVFbnZdCiAgICAgIH0pIDoge307CiAgICB9IGNhdGNoIChlKSB7fQogICAgdmFyIHNoYXJlZEZpbGVDb25maWcgPSBjb25maWdGaWxlWwogICAgICBwcm9jZXNzLmVudi5BV1NfUFJPRklMRSB8fCBBV1MudXRpbC5kZWZhdWx0UHJvZmlsZQogICAgXSB8fCB7fTsKICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc2hhcmVkRmlsZUNvbmZpZywgJ2VuZHBvaW50X2Rpc2NvdmVyeV9lbmFibGVkJykpIHsKICAgICAgaWYgKHNoYXJlZEZpbGVDb25maWcuZW5kcG9pbnRfZGlzY292ZXJ5X2VuYWJsZWQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICAgIGNvZGU6ICdDb25maWd1cmF0aW9uRXhjZXB0aW9uJywKICAgICAgICAgIG1lc3NhZ2U6ICdjb25maWcgZmlsZSBlbnRyeSBcJ2VuZHBvaW50X2Rpc2NvdmVyeV9lbmFibGVkXCcgY2Fubm90IGJlIHNldCB0byBub3RoaW5nJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICghaXNGYWxzeShzaGFyZWRGaWxlQ29uZmlnLmVuZHBvaW50X2Rpc2NvdmVyeV9lbmFibGVkKSkgcmV0dXJuIHRydWU7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIAogIC8qKgogICAqIGF0dGFjaCBlbmRwb2ludCBkaXNjb3ZlcnkgbG9naWMgdG8gcmVxdWVzdCBvYmplY3QKICAgKiBAcGFyYW0gW29iamVjdF0gcmVxdWVzdAogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGRpc2NvdmVyRW5kcG9pbnQocmVxdWVzdCwgZG9uZSkgewogICAgdmFyIHNlcnZpY2UgPSByZXF1ZXN0LnNlcnZpY2UgfHwge307CiAgICBpZiAoaGFzQ3VzdG9tRW5kcG9pbnQoc2VydmljZSkgfHwgcmVxdWVzdC5pc1ByZXNpZ25lZCgpKSByZXR1cm4gZG9uZSgpOwogIAogICAgaWYgKCFpc0VuZHBvaW50RGlzY292ZXJ5QXBwbGljYWJsZShyZXF1ZXN0KSkgcmV0dXJuIGRvbmUoKTsKICAKICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuYXBwZW5kVG9Vc2VyQWdlbnQoJ2VuZHBvaW50LWRpc2NvdmVyeScpOwogIAogICAgdmFyIG9wZXJhdGlvbnMgPSBzZXJ2aWNlLmFwaS5vcGVyYXRpb25zIHx8IHt9OwogICAgdmFyIG9wZXJhdGlvbk1vZGVsID0gb3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICB2YXIgaXNFbmRwb2ludERpc2NvdmVyeVJlcXVpcmVkID0gb3BlcmF0aW9uTW9kZWwgPyBvcGVyYXRpb25Nb2RlbC5lbmRwb2ludERpc2NvdmVyeVJlcXVpcmVkIDogJ05VTEwnOwogICAgc3dpdGNoIChpc0VuZHBvaW50RGlzY292ZXJ5UmVxdWlyZWQpIHsKICAgICAgY2FzZSAnT1BUSU9OQUwnOgogICAgICAgIG9wdGlvbmFsRGlzY292ZXJFbmRwb2ludChyZXF1ZXN0KTsKICAgICAgICByZXF1ZXN0LmFkZE5hbWVkTGlzdGVuZXIoJ0lOVkFMSURBVEVfQ0FDSEVEX0VORFBPSU5UUycsICdleHRyYWN0RXJyb3InLCBpbnZhbGlkYXRlQ2FjaGVkRW5kcG9pbnRzKTsKICAgICAgICBkb25lKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ1JFUVVJUkVEJzoKICAgICAgICByZXF1ZXN0LmFkZE5hbWVkTGlzdGVuZXIoJ0lOVkFMSURBVEVfQ0FDSEVEX0VORFBPSU5UUycsICdleHRyYWN0RXJyb3InLCBpbnZhbGlkYXRlQ2FjaGVkRW5kcG9pbnRzKTsKICAgICAgICByZXF1aXJlZERpc2NvdmVyRW5kcG9pbnQocmVxdWVzdCwgZG9uZSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ05VTEwnOgogICAgICBkZWZhdWx0OgogICAgICAgIGRvbmUoKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBkaXNjb3ZlckVuZHBvaW50OiBkaXNjb3ZlckVuZHBvaW50LAogICAgcmVxdWlyZWREaXNjb3ZlckVuZHBvaW50OiByZXF1aXJlZERpc2NvdmVyRW5kcG9pbnQsCiAgICBvcHRpb25hbERpc2NvdmVyRW5kcG9pbnQ6IG9wdGlvbmFsRGlzY292ZXJFbmRwb2ludCwKICAgIG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnM6IG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnMsCiAgICBnZXRDYWNoZUtleTogZ2V0Q2FjaGVLZXksCiAgICBpbnZhbGlkYXRlQ2FjaGVkRW5kcG9pbnQ6IGludmFsaWRhdGVDYWNoZWRFbmRwb2ludHMsCiAgfTsKICAKICB9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCiAgfSx7Ii4vY29yZSI6MTgsIi4vdXRpbCI6NzEsIl9wcm9jZXNzIjo4Nn1dLDI3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgZXZlbnRNZXNzYWdlQ2h1bmtlciA9IHJlcXVpcmUoJy4uL2V2ZW50LXN0cmVhbS9ldmVudC1tZXNzYWdlLWNodW5rZXInKS5ldmVudE1lc3NhZ2VDaHVua2VyOwogIHZhciBwYXJzZUV2ZW50ID0gcmVxdWlyZSgnLi9wYXJzZS1ldmVudCcpLnBhcnNlRXZlbnQ7CiAgCiAgZnVuY3Rpb24gY3JlYXRlRXZlbnRTdHJlYW0oYm9keSwgcGFyc2VyLCBtb2RlbCkgewogICAgICB2YXIgZXZlbnRNZXNzYWdlcyA9IGV2ZW50TWVzc2FnZUNodW5rZXIoYm9keSk7CiAgCiAgICAgIHZhciBldmVudHMgPSBbXTsKICAKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudE1lc3NhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBldmVudHMucHVzaChwYXJzZUV2ZW50KHBhcnNlciwgZXZlbnRNZXNzYWdlc1tpXSwgbW9kZWwpKTsKICAgICAgfQogIAogICAgICByZXR1cm4gZXZlbnRzOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgY3JlYXRlRXZlbnRTdHJlYW06IGNyZWF0ZUV2ZW50U3RyZWFtCiAgfTsKICAKICB9LHsiLi4vZXZlbnQtc3RyZWFtL2V2ZW50LW1lc3NhZ2UtY2h1bmtlciI6MjgsIi4vcGFyc2UtZXZlbnQiOjMwfV0sMjg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8qKgogICAqIFRha2VzIGluIGEgYnVmZmVyIG9mIGV2ZW50IG1lc3NhZ2VzIGFuZCBzcGxpdHMgdGhlbSBpbnRvIGluZGl2aWR1YWwgbWVzc2FnZXMuCiAgICogQHBhcmFtIHtCdWZmZXJ9IGJ1ZmZlcgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGV2ZW50TWVzc2FnZUNodW5rZXIoYnVmZmVyKSB7CiAgICAgIC8qKiBAdHlwZSBCdWZmZXJbXSAqLwogICAgICB2YXIgbWVzc2FnZXMgPSBbXTsKICAgICAgdmFyIG9mZnNldCA9IDA7CiAgCiAgICAgIHdoaWxlIChvZmZzZXQgPCBidWZmZXIubGVuZ3RoKSB7CiAgICAgICAgICB2YXIgdG90YWxMZW5ndGggPSBidWZmZXIucmVhZEludDMyQkUob2Zmc2V0KTsKICAKICAgICAgICAgIC8vIGNyZWF0ZSBuZXcgYnVmZmVyIGZvciBpbmRpdmlkdWFsIG1lc3NhZ2UgKHNoYXJlcyBtZW1vcnkgd2l0aCBvcmlnaW5hbCkKICAgICAgICAgIHZhciBtZXNzYWdlID0gYnVmZmVyLnNsaWNlKG9mZnNldCwgdG90YWxMZW5ndGggKyBvZmZzZXQpOwogICAgICAgICAgLy8gaW5jcmVtZW50IG9mZnNldCB0byBpdCBzdGFydHMgYXQgdGhlIG5leHQgbWVzc2FnZQogICAgICAgICAgb2Zmc2V0ICs9IHRvdGFsTGVuZ3RoOwogIAogICAgICAgICAgbWVzc2FnZXMucHVzaChtZXNzYWdlKTsKICAgICAgfQogIAogICAgICByZXR1cm4gbWVzc2FnZXM7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBldmVudE1lc3NhZ2VDaHVua2VyOiBldmVudE1lc3NhZ2VDaHVua2VyCiAgfTsKICAKICB9LHt9XSwyOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi9jb3JlJykudXRpbDsKICB2YXIgdG9CdWZmZXIgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcjsKICAKICAvKioKICAgKiBBIGxvc3NsZXNzIHJlcHJlc2VudGF0aW9uIG9mIGEgc2lnbmVkLCA2NC1iaXQgaW50ZWdlci4gSW5zdGFuY2VzIG9mIHRoaXMKICAgKiBjbGFzcyBtYXkgYmUgdXNlZCBpbiBhcml0aG1ldGljIGV4cHJlc3Npb25zIGFzIGlmIHRoZXkgd2VyZSBudW1lcmljCiAgICogcHJpbWl0aXZlcywgYnV0IHRoZSBiaW5hcnkgcmVwcmVzZW50YXRpb24gd2lsbCBiZSBwcmVzZXJ2ZWQgdW5jaGFuZ2VkIGFzIHRoZQogICAqIGBieXRlc2AgcHJvcGVydHkgb2YgdGhlIG9iamVjdC4gVGhlIGJ5dGVzIHNob3VsZCBiZSBlbmNvZGVkIGFzIGJpZy1lbmRpYW4sCiAgICogdHdvJ3MgY29tcGxlbWVudCBpbnRlZ2Vycy4KICAgKiBAcGFyYW0ge0J1ZmZlcn0gYnl0ZXMKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIEludDY0KGJ5dGVzKSB7CiAgICAgIGlmIChieXRlcy5sZW5ndGggIT09IDgpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW50NjQgYnVmZmVycyBtdXN0IGJlIGV4YWN0bHkgOCBieXRlcycpOwogICAgICB9CiAgICAgIGlmICghdXRpbC5CdWZmZXIuaXNCdWZmZXIoYnl0ZXMpKSBieXRlcyA9IHRvQnVmZmVyKGJ5dGVzKTsKICAKICAgICAgdGhpcy5ieXRlcyA9IGJ5dGVzOwogIH0KICAKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gbnVtYmVyCiAgICogQHJldHVybnMge0ludDY0fQogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgSW50NjQuZnJvbU51bWJlciA9IGZ1bmN0aW9uKG51bWJlcikgewogICAgICBpZiAobnVtYmVyID4gOTIyMzM3MjAzNjg1NDc3NTgwNyB8fCBudW1iZXIgPCAtOTIyMzM3MjAzNjg1NDc3NTgwOCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAgIG51bWJlciArICcgaXMgdG9vIGxhcmdlIChvciwgaWYgbmVnYXRpdmUsIHRvbyBzbWFsbCkgdG8gcmVwcmVzZW50IGFzIGFuIEludDY0JwogICAgICAgICAgKTsKICAgICAgfQogIAogICAgICB2YXIgYnl0ZXMgPSBuZXcgVWludDhBcnJheSg4KTsKICAgICAgZm9yICgKICAgICAgICAgIHZhciBpID0gNywgcmVtYWluaW5nID0gTWF0aC5hYnMoTWF0aC5yb3VuZChudW1iZXIpKTsKICAgICAgICAgIGkgPiAtMSAmJiByZW1haW5pbmcgPiAwOwogICAgICAgICAgaS0tLCByZW1haW5pbmcgLz0gMjU2CiAgICAgICkgewogICAgICAgICAgYnl0ZXNbaV0gPSByZW1haW5pbmc7CiAgICAgIH0KICAKICAgICAgaWYgKG51bWJlciA8IDApIHsKICAgICAgICAgIG5lZ2F0ZShieXRlcyk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIG5ldyBJbnQ2NChieXRlcyk7CiAgfTsKICAKICAvKioKICAgKiBAcmV0dXJucyB7bnVtYmVyfQogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgSW50NjQucHJvdG90eXBlLnZhbHVlT2YgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGJ5dGVzID0gdGhpcy5ieXRlcy5zbGljZSgwKTsKICAgICAgdmFyIG5lZ2F0aXZlID0gYnl0ZXNbMF0gJiAxMjg7CiAgICAgIGlmIChuZWdhdGl2ZSkgewogICAgICAgICAgbmVnYXRlKGJ5dGVzKTsKICAgICAgfQogIAogICAgICByZXR1cm4gcGFyc2VJbnQoYnl0ZXMudG9TdHJpbmcoJ2hleCcpLCAxNikgKiAobmVnYXRpdmUgPyAtMSA6IDEpOwogIH07CiAgCiAgSW50NjQucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBTdHJpbmcodGhpcy52YWx1ZU9mKCkpOwogIH07CiAgCiAgLyoqCiAgICogQHBhcmFtIHtCdWZmZXJ9IGJ5dGVzCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBuZWdhdGUoYnl0ZXMpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCA4OyBpKyspIHsKICAgICAgICAgIGJ5dGVzW2ldIF49IDB4RkY7CiAgICAgIH0KICAgICAgZm9yICh2YXIgaSA9IDc7IGkgPiAtMTsgaS0tKSB7CiAgICAgICAgICBieXRlc1tpXSsrOwogICAgICAgICAgaWYgKGJ5dGVzW2ldICE9PSAwKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIEludDY0OiBJbnQ2NAogIH07CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sMzA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBwYXJzZU1lc3NhZ2UgPSByZXF1aXJlKCcuL3BhcnNlLW1lc3NhZ2UnKS5wYXJzZU1lc3NhZ2U7CiAgCiAgLyoqCiAgICoKICAgKiBAcGFyYW0geyp9IHBhcnNlcgogICAqIEBwYXJhbSB7QnVmZmVyfSBtZXNzYWdlCiAgICogQHBhcmFtIHsqfSBzaGFwZQogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHBhcnNlRXZlbnQocGFyc2VyLCBtZXNzYWdlLCBzaGFwZSkgewogICAgICB2YXIgcGFyc2VkTWVzc2FnZSA9IHBhcnNlTWVzc2FnZShtZXNzYWdlKTsKICAKICAgICAgLy8gY2hlY2sgaWYgbWVzc2FnZSBpcyBhbiBldmVudCBvciBlcnJvcgogICAgICB2YXIgbWVzc2FnZVR5cGUgPSBwYXJzZWRNZXNzYWdlLmhlYWRlcnNbJzptZXNzYWdlLXR5cGUnXTsKICAgICAgaWYgKG1lc3NhZ2VUeXBlKSB7CiAgICAgICAgICBpZiAobWVzc2FnZVR5cGUudmFsdWUgPT09ICdlcnJvcicpIHsKICAgICAgICAgICAgICB0aHJvdyBwYXJzZUVycm9yKHBhcnNlZE1lc3NhZ2UpOwogICAgICAgICAgfSBlbHNlIGlmIChtZXNzYWdlVHlwZS52YWx1ZSAhPT0gJ2V2ZW50JykgewogICAgICAgICAgICAgIC8vIG5vdCBzdXJlIGhvdyB0byBwYXJzZSBub24tZXZlbnRzL25vbi1lcnJvcnMsIGlnbm9yZSBmb3Igbm93CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICB9CiAgCiAgICAgIC8vIGRldGVybWluZSBldmVudCB0eXBlCiAgICAgIHZhciBldmVudFR5cGUgPSBwYXJzZWRNZXNzYWdlLmhlYWRlcnNbJzpldmVudC10eXBlJ107CiAgICAgIC8vIGNoZWNrIHRoYXQgdGhlIGV2ZW50IHR5cGUgaXMgbW9kZWxlZAogICAgICB2YXIgZXZlbnRNb2RlbCA9IHNoYXBlLm1lbWJlcnNbZXZlbnRUeXBlLnZhbHVlXTsKICAgICAgaWYgKCFldmVudE1vZGVsKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgIH0KICAKICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICAvLyBjaGVjayBpZiBhbiBldmVudCBwYXlsb2FkIGV4aXN0cwogICAgICB2YXIgZXZlbnRQYXlsb2FkTWVtYmVyTmFtZSA9IGV2ZW50TW9kZWwuZXZlbnRQYXlsb2FkTWVtYmVyTmFtZTsKICAgICAgaWYgKGV2ZW50UGF5bG9hZE1lbWJlck5hbWUpIHsKICAgICAgICAgIHZhciBwYXlsb2FkU2hhcGUgPSBldmVudE1vZGVsLm1lbWJlcnNbZXZlbnRQYXlsb2FkTWVtYmVyTmFtZV07CiAgICAgICAgICAvLyBpZiB0aGUgc2hhcGUgaXMgYmluYXJ5LCByZXR1cm4gdGhlIGJ5dGUgYXJyYXkKICAgICAgICAgIGlmIChwYXlsb2FkU2hhcGUudHlwZSA9PT0gJ2JpbmFyeScpIHsKICAgICAgICAgICAgICByZXN1bHRbZXZlbnRQYXlsb2FkTWVtYmVyTmFtZV0gPSBwYXJzZWRNZXNzYWdlLmJvZHk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc3VsdFtldmVudFBheWxvYWRNZW1iZXJOYW1lXSA9IHBhcnNlci5wYXJzZShwYXJzZWRNZXNzYWdlLmJvZHkudG9TdHJpbmcoKSwgcGF5bG9hZFNoYXBlKTsKICAgICAgICAgIH0KICAgICAgfQogIAogICAgICAvLyByZWFkIGV2ZW50IGhlYWRlcnMKICAgICAgdmFyIGV2ZW50SGVhZGVyTmFtZXMgPSBldmVudE1vZGVsLmV2ZW50SGVhZGVyTWVtYmVyTmFtZXM7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnRIZWFkZXJOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIG5hbWUgPSBldmVudEhlYWRlck5hbWVzW2ldOwogICAgICAgICAgaWYgKHBhcnNlZE1lc3NhZ2UuaGVhZGVyc1tuYW1lXSkgewogICAgICAgICAgICAgIC8vIHBhcnNlIHRoZSBoZWFkZXIhCiAgICAgICAgICAgICAgcmVzdWx0W25hbWVdID0gZXZlbnRNb2RlbC5tZW1iZXJzW25hbWVdLnRvVHlwZShwYXJzZWRNZXNzYWdlLmhlYWRlcnNbbmFtZV0udmFsdWUpOwogICAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHZhciBvdXRwdXQgPSB7fTsKICAgICAgb3V0cHV0W2V2ZW50VHlwZS52YWx1ZV0gPSByZXN1bHQ7CiAgICAgIHJldHVybiBvdXRwdXQ7CiAgfQogIAogIGZ1bmN0aW9uIHBhcnNlRXJyb3IobWVzc2FnZSkgewogICAgICB2YXIgZXJyb3JDb2RlID0gbWVzc2FnZS5oZWFkZXJzWyc6ZXJyb3ItY29kZSddOwogICAgICB2YXIgZXJyb3JNZXNzYWdlID0gbWVzc2FnZS5oZWFkZXJzWyc6ZXJyb3ItbWVzc2FnZSddOwogICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoZXJyb3JNZXNzYWdlLnZhbHVlIHx8IGVycm9yTWVzc2FnZSk7CiAgICAgIGVycm9yLmNvZGUgPSBlcnJvci5uYW1lID0gZXJyb3JDb2RlLnZhbHVlIHx8IGVycm9yQ29kZTsKICAgICAgcmV0dXJuIGVycm9yOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgcGFyc2VFdmVudDogcGFyc2VFdmVudAogIH07CiAgCiAgfSx7Ii4vcGFyc2UtbWVzc2FnZSI6MzF9XSwzMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEludDY0ID0gcmVxdWlyZSgnLi9pbnQ2NCcpLkludDY0OwogIAogIHZhciBzcGxpdE1lc3NhZ2UgPSByZXF1aXJlKCcuL3NwbGl0LW1lc3NhZ2UnKS5zcGxpdE1lc3NhZ2U7CiAgCiAgdmFyIEJPT0xFQU5fVEFHID0gJ2Jvb2xlYW4nOwogIHZhciBCWVRFX1RBRyA9ICdieXRlJzsKICB2YXIgU0hPUlRfVEFHID0gJ3Nob3J0JzsKICB2YXIgSU5UX1RBRyA9ICdpbnRlZ2VyJzsKICB2YXIgTE9OR19UQUcgPSAnbG9uZyc7CiAgdmFyIEJJTkFSWV9UQUcgPSAnYmluYXJ5JzsKICB2YXIgU1RSSU5HX1RBRyA9ICdzdHJpbmcnOwogIHZhciBUSU1FU1RBTVBfVEFHID0gJ3RpbWVzdGFtcCc7CiAgdmFyIFVVSURfVEFHID0gJ3V1aWQnOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqCiAgICogQHBhcmFtIHtCdWZmZXJ9IGhlYWRlcnMKICAgKi8KICBmdW5jdGlvbiBwYXJzZUhlYWRlcnMoaGVhZGVycykgewogICAgICB2YXIgb3V0ID0ge307CiAgICAgIHZhciBwb3NpdGlvbiA9IDA7CiAgICAgIHdoaWxlIChwb3NpdGlvbiA8IGhlYWRlcnMubGVuZ3RoKSB7CiAgICAgICAgICB2YXIgbmFtZUxlbmd0aCA9IGhlYWRlcnMucmVhZFVJbnQ4KHBvc2l0aW9uKyspOwogICAgICAgICAgdmFyIG5hbWUgPSBoZWFkZXJzLnNsaWNlKHBvc2l0aW9uLCBwb3NpdGlvbiArIG5hbWVMZW5ndGgpLnRvU3RyaW5nKCk7CiAgICAgICAgICBwb3NpdGlvbiArPSBuYW1lTGVuZ3RoOwogICAgICAgICAgc3dpdGNoIChoZWFkZXJzLnJlYWRVSW50OChwb3NpdGlvbisrKSkgewogICAgICAgICAgICAgIGNhc2UgMCAvKiBib29sVHJ1ZSAqLzoKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogQk9PTEVBTl9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdHJ1ZQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDEgLyogYm9vbEZhbHNlICovOgogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBCT09MRUFOX1RBRywKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmYWxzZQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDIgLyogYnl0ZSAqLzoKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogQllURV9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5yZWFkSW50OChwb3NpdGlvbisrKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDMgLyogc2hvcnQgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFNIT1JUX1RBRywKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBoZWFkZXJzLnJlYWRJbnQxNkJFKHBvc2l0aW9uKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSAyOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDQgLyogaW50ZWdlciAqLzoKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogSU5UX1RBRywKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBoZWFkZXJzLnJlYWRJbnQzMkJFKHBvc2l0aW9uKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSA0OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDUgLyogbG9uZyAqLzoKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogTE9OR19UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbmV3IEludDY0KGhlYWRlcnMuc2xpY2UocG9zaXRpb24sIHBvc2l0aW9uICsgOCkpCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgNiAvKiBieXRlQXJyYXkgKi86CiAgICAgICAgICAgICAgICAgIHZhciBiaW5hcnlMZW5ndGggPSBoZWFkZXJzLnJlYWRVSW50MTZCRShwb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDI7CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IEJJTkFSWV9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyBiaW5hcnlMZW5ndGgpCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IGJpbmFyeUxlbmd0aDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA3IC8qIHN0cmluZyAqLzoKICAgICAgICAgICAgICAgICAgdmFyIHN0cmluZ0xlbmd0aCA9IGhlYWRlcnMucmVhZFVJbnQxNkJFKHBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gMjsKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogU1RSSU5HX1RBRywKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBoZWFkZXJzLnNsaWNlKAogICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICsgc3RyaW5nTGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgICApLnRvU3RyaW5nKCkKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gc3RyaW5nTGVuZ3RoOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDggLyogdGltZXN0YW1wICovOgogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBUSU1FU1RBTVBfVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG5ldyBEYXRlKAogICAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBJbnQ2NChoZWFkZXJzLnNsaWNlKHBvc2l0aW9uLCBwb3NpdGlvbiArIDgpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudmFsdWVPZigpCiAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgOSAvKiB1dWlkICovOgogICAgICAgICAgICAgICAgICB2YXIgdXVpZENoYXJzID0gaGVhZGVycy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyAxNikKICAgICAgICAgICAgICAgICAgICAgIC50b1N0cmluZygnaGV4Jyk7CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDE2OwogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBVVUlEX1RBRywKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiB1dWlkQ2hhcnMuc3Vic3RyKDAsIDgpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgICB1dWlkQ2hhcnMuc3Vic3RyKDgsIDQpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgICB1dWlkQ2hhcnMuc3Vic3RyKDEyLCA0KSArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgdXVpZENoYXJzLnN1YnN0cigxNiwgNCkgKyAnLScgKwogICAgICAgICAgICAgICAgICAgICAgICAgIHV1aWRDaGFycy5zdWJzdHIoMjApCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5yZWNvZ25pemVkIGhlYWRlciB0eXBlIHRhZycpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBvdXQ7CiAgfQogIAogIGZ1bmN0aW9uIHBhcnNlTWVzc2FnZShtZXNzYWdlKSB7CiAgICAgIHZhciBwYXJzZWQgPSBzcGxpdE1lc3NhZ2UobWVzc2FnZSk7CiAgICAgIHJldHVybiB7IGhlYWRlcnM6IHBhcnNlSGVhZGVycyhwYXJzZWQuaGVhZGVycyksIGJvZHk6IHBhcnNlZC5ib2R5IH07CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBwYXJzZU1lc3NhZ2U6IHBhcnNlTWVzc2FnZQogIH07CiAgCiAgfSx7Ii4vaW50NjQiOjI5LCIuL3NwbGl0LW1lc3NhZ2UiOjMyfV0sMzI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vY29yZScpLnV0aWw7CiAgdmFyIHRvQnVmZmVyID0gdXRpbC5idWZmZXIudG9CdWZmZXI7CiAgCiAgLy8gQWxsIHByZWx1ZGUgY29tcG9uZW50cyBhcmUgdW5zaWduZWQsIDMyLWJpdCBpbnRlZ2VycwogIHZhciBQUkVMVURFX01FTUJFUl9MRU5HVEggPSA0OwogIC8vIFRoZSBwcmVsdWRlIGNvbnNpc3RzIG9mIHR3byBjb21wb25lbnRzCiAgdmFyIFBSRUxVREVfTEVOR1RIID0gUFJFTFVERV9NRU1CRVJfTEVOR1RIICogMjsKICAvLyBDaGVja3N1bXMgYXJlIGFsd2F5cyBDUkMzMiBoYXNoZXMuCiAgdmFyIENIRUNLU1VNX0xFTkdUSCA9IDQ7CiAgLy8gTWVzc2FnZXMgbXVzdCBpbmNsdWRlIGEgZnVsbCBwcmVsdWRlLCBhIHByZWx1ZGUgY2hlY2tzdW0sIGFuZCBhIG1lc3NhZ2UgY2hlY2tzdW0KICB2YXIgTUlOSU1VTV9NRVNTQUdFX0xFTkdUSCA9IFBSRUxVREVfTEVOR1RIICsgQ0hFQ0tTVU1fTEVOR1RIICogMjsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKgogICAqIEBwYXJhbSB7QnVmZmVyfSBtZXNzYWdlCiAgICovCiAgZnVuY3Rpb24gc3BsaXRNZXNzYWdlKG1lc3NhZ2UpIHsKICAgICAgaWYgKCF1dGlsLkJ1ZmZlci5pc0J1ZmZlcihtZXNzYWdlKSkgbWVzc2FnZSA9IHRvQnVmZmVyKG1lc3NhZ2UpOwogIAogICAgICBpZiAobWVzc2FnZS5sZW5ndGggPCBNSU5JTVVNX01FU1NBR0VfTEVOR1RIKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Byb3ZpZGVkIG1lc3NhZ2UgdG9vIHNob3J0IHRvIGFjY29tbW9kYXRlIGV2ZW50IHN0cmVhbSBtZXNzYWdlIG92ZXJoZWFkJyk7CiAgICAgIH0KICAKICAgICAgaWYgKG1lc3NhZ2UubGVuZ3RoICE9PSBtZXNzYWdlLnJlYWRVSW50MzJCRSgwKSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZXBvcnRlZCBtZXNzYWdlIGxlbmd0aCBkb2VzIG5vdCBtYXRjaCByZWNlaXZlZCBtZXNzYWdlIGxlbmd0aCcpOwogICAgICB9CiAgCiAgICAgIHZhciBleHBlY3RlZFByZWx1ZGVDaGVja3N1bSA9IG1lc3NhZ2UucmVhZFVJbnQzMkJFKFBSRUxVREVfTEVOR1RIKTsKICAKICAgICAgaWYgKAogICAgICAgICAgZXhwZWN0ZWRQcmVsdWRlQ2hlY2tzdW0gIT09IHV0aWwuY3J5cHRvLmNyYzMyKAogICAgICAgICAgICAgIG1lc3NhZ2Uuc2xpY2UoMCwgUFJFTFVERV9MRU5HVEgpCiAgICAgICAgICApCiAgICAgICkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAgICdUaGUgcHJlbHVkZSBjaGVja3N1bSBzcGVjaWZpZWQgaW4gdGhlIG1lc3NhZ2UgKCcgKwogICAgICAgICAgICAgIGV4cGVjdGVkUHJlbHVkZUNoZWNrc3VtICsKICAgICAgICAgICAgICAnKSBkb2VzIG5vdCBtYXRjaCB0aGUgY2FsY3VsYXRlZCBDUkMzMiBjaGVja3N1bS4nCiAgICAgICAgICApOwogICAgICB9CiAgCiAgICAgIHZhciBleHBlY3RlZE1lc3NhZ2VDaGVja3N1bSA9IG1lc3NhZ2UucmVhZFVJbnQzMkJFKG1lc3NhZ2UubGVuZ3RoIC0gQ0hFQ0tTVU1fTEVOR1RIKTsKICAKICAgICAgaWYgKAogICAgICAgICAgZXhwZWN0ZWRNZXNzYWdlQ2hlY2tzdW0gIT09IHV0aWwuY3J5cHRvLmNyYzMyKAogICAgICAgICAgICAgIG1lc3NhZ2Uuc2xpY2UoMCwgbWVzc2FnZS5sZW5ndGggLSBDSEVDS1NVTV9MRU5HVEgpCiAgICAgICAgICApCiAgICAgICkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAgICdUaGUgbWVzc2FnZSBjaGVja3N1bSBkaWQgbm90IG1hdGNoIHRoZSBleHBlY3RlZCB2YWx1ZSBvZiAnICsKICAgICAgICAgICAgICAgICAgZXhwZWN0ZWRNZXNzYWdlQ2hlY2tzdW0KICAgICAgICAgICk7CiAgICAgIH0KICAKICAgICAgdmFyIGhlYWRlcnNTdGFydCA9IFBSRUxVREVfTEVOR1RIICsgQ0hFQ0tTVU1fTEVOR1RIOwogICAgICB2YXIgaGVhZGVyc0VuZCA9IGhlYWRlcnNTdGFydCArIG1lc3NhZ2UucmVhZFVJbnQzMkJFKFBSRUxVREVfTUVNQkVSX0xFTkdUSCk7CiAgCiAgICAgIHJldHVybiB7CiAgICAgICAgICBoZWFkZXJzOiBtZXNzYWdlLnNsaWNlKGhlYWRlcnNTdGFydCwgaGVhZGVyc0VuZCksCiAgICAgICAgICBib2R5OiBtZXNzYWdlLnNsaWNlKGhlYWRlcnNFbmQsIG1lc3NhZ2UubGVuZ3RoIC0gQ0hFQ0tTVU1fTEVOR1RIKSwKICAgICAgfTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIHNwbGl0TWVzc2FnZTogc3BsaXRNZXNzYWdlCiAgfTsKICAKICB9LHsiLi4vY29yZSI6MTh9XSwzMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHZhciBTZXF1ZW50aWFsRXhlY3V0b3IgPSByZXF1aXJlKCcuL3NlcXVlbnRpYWxfZXhlY3V0b3InKTsKICB2YXIgRElTQ09WRVJfRU5EUE9JTlQgPSByZXF1aXJlKCcuL2Rpc2NvdmVyX2VuZHBvaW50JykuZGlzY292ZXJFbmRwb2ludDsKICAvKioKICAgKiBUaGUgbmFtZXNwYWNlIHVzZWQgdG8gcmVnaXN0ZXIgZ2xvYmFsIGV2ZW50IGxpc3RlbmVycyBmb3IgcmVxdWVzdCBidWlsZGluZwogICAqIGFuZCBzZW5kaW5nLgogICAqLwogIEFXUy5FdmVudExpc3RlbmVycyA9IHsKICAgIC8qKgogICAgICogQCFhdHRyaWJ1dGUgVkFMSURBVEVfQ1JFREVOVElBTFMKICAgICAqICAgQSByZXF1ZXN0IGxpc3RlbmVyIHRoYXQgdmFsaWRhdGVzIHdoZXRoZXIgdGhlIHJlcXVlc3QgaXMgYmVpbmcKICAgICAqICAgc2VudCB3aXRoIGNyZWRlbnRpYWxzLgogICAgICogICBIYW5kbGVzIHRoZSB7QVdTLlJlcXVlc3R+dmFsaWRhdGUgJ3ZhbGlkYXRlJyBSZXF1ZXN0IGV2ZW50fQogICAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRob3V0IHZhbGlkYXRpbmcgY3JlZGVudGlhbHMKICAgICAqICAgICB2YXIgbGlzdGVuZXIgPSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9DUkVERU5USUFMUzsKICAgICAqICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsIGxpc3RlbmVyKTsKICAgICAqICAgQHJlYWRvbmx5CiAgICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAgICogQCFhdHRyaWJ1dGUgVkFMSURBVEVfUkVHSU9OCiAgICAgKiAgIEEgcmVxdWVzdCBsaXN0ZW5lciB0aGF0IHZhbGlkYXRlcyB3aGV0aGVyIHRoZSByZWdpb24gaXMgc2V0CiAgICAgKiAgIGZvciBhIHJlcXVlc3QuCiAgICAgKiAgIEhhbmRsZXMgdGhlIHtBV1MuUmVxdWVzdH52YWxpZGF0ZSAndmFsaWRhdGUnIFJlcXVlc3QgZXZlbnR9CiAgICAgKiAgIEBleGFtcGxlIFNlbmRpbmcgYSByZXF1ZXN0IHdpdGhvdXQgdmFsaWRhdGluZyByZWdpb24gY29uZmlndXJhdGlvbgogICAgICogICAgIHZhciBsaXN0ZW5lciA9IEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1JFR0lPTjsKICAgICAqICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsIGxpc3RlbmVyKTsKICAgICAqICAgQHJlYWRvbmx5CiAgICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAgICogQCFhdHRyaWJ1dGUgVkFMSURBVEVfUEFSQU1FVEVSUwogICAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCB2YWxpZGF0ZXMgaW5wdXQgcGFyYW1ldGVycyBpbiBhIHJlcXVlc3QuCiAgICAgKiAgIEhhbmRsZXMgdGhlIHtBV1MuUmVxdWVzdH52YWxpZGF0ZSAndmFsaWRhdGUnIFJlcXVlc3QgZXZlbnR9CiAgICAgKiAgIEBleGFtcGxlIFNlbmRpbmcgYSByZXF1ZXN0IHdpdGhvdXQgdmFsaWRhdGluZyBwYXJhbWV0ZXJzCiAgICAgKiAgICAgdmFyIGxpc3RlbmVyID0gQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUEFSQU1FVEVSUzsKICAgICAqICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsIGxpc3RlbmVyKTsKICAgICAqICAgQGV4YW1wbGUgRGlzYWJsZSBwYXJhbWV0ZXIgdmFsaWRhdGlvbiBnbG9iYWxseQogICAgICogICAgIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsCiAgICAgKiAgICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9SRUdJT04pOwogICAgICogICBAcmVhZG9ubHkKICAgICAqICAgQHJldHVybiBbRnVuY3Rpb25dCiAgICAgKiBAIWF0dHJpYnV0ZSBTRU5ECiAgICAgKiAgIEEgcmVxdWVzdCBsaXN0ZW5lciB0aGF0IGluaXRpYXRlcyB0aGUgSFRUUCBjb25uZWN0aW9uIGZvciBhCiAgICAgKiAgIHJlcXVlc3QgYmVpbmcgc2VudC4gSGFuZGxlcyB0aGUge0FXUy5SZXF1ZXN0fnNlbmQgJ3NlbmQnIFJlcXVlc3QgZXZlbnR9CiAgICAgKiAgIEBleGFtcGxlIFJlcGxhY2luZyB0aGUgSFRUUCBoYW5kbGVyCiAgICAgKiAgICAgdmFyIGxpc3RlbmVyID0gQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuU0VORDsKICAgICAqICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdzZW5kJywgbGlzdGVuZXIpOwogICAgICogICAgIHJlcXVlc3Qub24oJ3NlbmQnLCBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICogICAgICAgY3VzdG9tSGFuZGxlci5zZW5kKHJlc3BvbnNlKTsKICAgICAqICAgICB9KTsKICAgICAqICAgQHJldHVybiBbRnVuY3Rpb25dCiAgICAgKiAgIEByZWFkb25seQogICAgICogQCFhdHRyaWJ1dGUgSFRUUF9EQVRBCiAgICAgKiAgIEEgcmVxdWVzdCBsaXN0ZW5lciB0aGF0IHJlYWRzIGRhdGEgZnJvbSB0aGUgSFRUUCBjb25uZWN0aW9uIGluIG9yZGVyCiAgICAgKiAgIHRvIGJ1aWxkIHRoZSByZXNwb25zZSBkYXRhLgogICAgICogICBIYW5kbGVzIHRoZSB7QVdTLlJlcXVlc3R+aHR0cERhdGEgJ2h0dHBEYXRhJyBSZXF1ZXN0IGV2ZW50fS4KICAgICAqICAgUmVtb3ZlIHRoaXMgaGFuZGxlciBpZiB5b3UgYXJlIG92ZXJyaWRpbmcgdGhlICdodHRwRGF0YScgZXZlbnQgYW5kCiAgICAgKiAgIGRvIG5vdCB3YW50IGV4dHJhIGRhdGEgcHJvY2Vzc2luZyBhbmQgYnVmZmVyaW5nIG92ZXJoZWFkLgogICAgICogICBAZXhhbXBsZSBEaXNhYmxpbmcgZGVmYXVsdCBkYXRhIHByb2Nlc3NpbmcKICAgICAqICAgICB2YXIgbGlzdGVuZXIgPSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5IVFRQX0RBVEE7CiAgICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcignaHR0cERhdGEnLCBsaXN0ZW5lcik7CiAgICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAgICogICBAcmVhZG9ubHkKICAgICAqLwogICAgQ29yZToge30gLyogZG9jIGhhY2sgKi8KICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGdldE9wZXJhdGlvbkF1dGh0eXBlKHJlcSkgewogICAgaWYgKCFyZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucykgewogICAgICByZXR1cm4gJyc7CiAgICB9CiAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICByZXR1cm4gb3BlcmF0aW9uID8gb3BlcmF0aW9uLmF1dGh0eXBlIDogJyc7CiAgfQogIAogIEFXUy5FdmVudExpc3RlbmVycyA9IHsKICAgIENvcmU6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQsIGFkZEFzeW5jKSB7CiAgICAgIGFkZEFzeW5jKCdWQUxJREFURV9DUkVERU5USUFMUycsICd2YWxpZGF0ZScsCiAgICAgICAgICBmdW5jdGlvbiBWQUxJREFURV9DUkVERU5USUFMUyhyZXEsIGRvbmUpIHsKICAgICAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5zaWduYXR1cmVWZXJzaW9uICYmICFyZXEuc2VydmljZS5jb25maWcuc2lnbmF0dXJlVmVyc2lvbikgcmV0dXJuIGRvbmUoKTsgLy8gbm9uZQogICAgICAgIHJlcS5zZXJ2aWNlLmNvbmZpZy5nZXRDcmVkZW50aWFscyhmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgcmVxLnJlc3BvbnNlLmVycm9yID0gQVdTLnV0aWwuZXJyb3IoZXJyLAogICAgICAgICAgICAgIHtjb2RlOiAnQ3JlZGVudGlhbHNFcnJvcicsIG1lc3NhZ2U6ICdNaXNzaW5nIGNyZWRlbnRpYWxzIGluIGNvbmZpZyd9KTsKICAgICAgICAgIH0KICAgICAgICAgIGRvbmUoKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgCiAgICAgIGFkZCgnVkFMSURBVEVfUkVHSU9OJywgJ3ZhbGlkYXRlJywgZnVuY3Rpb24gVkFMSURBVEVfUkVHSU9OKHJlcSkgewogICAgICAgIGlmICghcmVxLnNlcnZpY2UuY29uZmlnLnJlZ2lvbiAmJiAhcmVxLnNlcnZpY2UuaXNHbG9iYWxFbmRwb2ludCkgewogICAgICAgICAgcmVxLnJlc3BvbnNlLmVycm9yID0gQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksCiAgICAgICAgICAgIHtjb2RlOiAnQ29uZmlnRXJyb3InLCBtZXNzYWdlOiAnTWlzc2luZyByZWdpb24gaW4gY29uZmlnJ30pOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnQlVJTERfSURFTVBPVEVOQ1lfVE9LRU5TJywgJ3ZhbGlkYXRlJywgZnVuY3Rpb24gQlVJTERfSURFTVBPVEVOQ1lfVE9LRU5TKHJlcSkgewogICAgICAgIGlmICghcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgICAgIGlmICghb3BlcmF0aW9uKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBpZGVtcG90ZW50TWVtYmVycyA9IG9wZXJhdGlvbi5pZGVtcG90ZW50TWVtYmVyczsKICAgICAgICBpZiAoIWlkZW1wb3RlbnRNZW1iZXJzLmxlbmd0aCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvLyBjcmVhdGVzIGEgY29weSBvZiBwYXJhbXMgc28gdXNlcidzIHBhcmFtIG9iamVjdCBpc24ndCBtdXRhdGVkCiAgICAgICAgdmFyIHBhcmFtcyA9IEFXUy51dGlsLmNvcHkocmVxLnBhcmFtcyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBpZGVtcG90ZW50TWVtYmVycy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgIGlmICghcGFyYW1zW2lkZW1wb3RlbnRNZW1iZXJzW2ldXSkgewogICAgICAgICAgICAvLyBhZGQgdGhlIG1lbWJlcgogICAgICAgICAgICBwYXJhbXNbaWRlbXBvdGVudE1lbWJlcnNbaV1dID0gQVdTLnV0aWwudXVpZC52NCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXEucGFyYW1zID0gcGFyYW1zOwogICAgICB9KTsKICAKICAgICAgYWRkKCdWQUxJREFURV9QQVJBTUVURVJTJywgJ3ZhbGlkYXRlJywgZnVuY3Rpb24gVkFMSURBVEVfUEFSQU1FVEVSUyhyZXEpIHsKICAgICAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBydWxlcyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmlucHV0OwogICAgICAgIHZhciB2YWxpZGF0aW9uID0gcmVxLnNlcnZpY2UuY29uZmlnLnBhcmFtVmFsaWRhdGlvbjsKICAgICAgICBuZXcgQVdTLlBhcmFtVmFsaWRhdG9yKHZhbGlkYXRpb24pLnZhbGlkYXRlKHJ1bGVzLCByZXEucGFyYW1zKTsKICAgICAgfSk7CiAgCiAgICAgIGFkZEFzeW5jKCdDT01QVVRFX1NIQTI1NicsICdhZnRlckJ1aWxkJywgZnVuY3Rpb24gQ09NUFVURV9TSEEyNTYocmVxLCBkb25lKSB7CiAgICAgICAgcmVxLmhhbHRIYW5kbGVyc09uRXJyb3IoKTsKICAgICAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgICAgICB2YXIgYXV0aHR5cGUgPSBvcGVyYXRpb24gPyBvcGVyYXRpb24uYXV0aHR5cGUgOiAnJzsKICAgICAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5zaWduYXR1cmVWZXJzaW9uICYmICFhdXRodHlwZSAmJiAhcmVxLnNlcnZpY2UuY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIHJldHVybiBkb25lKCk7IC8vIG5vbmUKICAgICAgICBpZiAocmVxLnNlcnZpY2UuZ2V0U2lnbmVyQ2xhc3MocmVxKSA9PT0gQVdTLlNpZ25lcnMuVjQpIHsKICAgICAgICAgIHZhciBib2R5ID0gcmVxLmh0dHBSZXF1ZXN0LmJvZHkgfHwgJyc7CiAgICAgICAgICBpZiAoYXV0aHR5cGUuaW5kZXhPZigndW5zaWduZWQtYm9keScpID49IDApIHsKICAgICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LUNvbnRlbnQtU2hhMjU2J10gPSAnVU5TSUdORUQtUEFZTE9BRCc7CiAgICAgICAgICAgIHJldHVybiBkb25lKCk7CiAgICAgICAgICB9CiAgICAgICAgICBBV1MudXRpbC5jb21wdXRlU2hhMjU2KGJvZHksIGZ1bmN0aW9uKGVyciwgc2hhKSB7CiAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICBkb25lKGVycik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LUNvbnRlbnQtU2hhMjU2J10gPSBzaGE7CiAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZG9uZSgpOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnU0VUX0NPTlRFTlRfTEVOR1RIJywgJ2FmdGVyQnVpbGQnLCBmdW5jdGlvbiBTRVRfQ09OVEVOVF9MRU5HVEgocmVxKSB7CiAgICAgICAgdmFyIGF1dGh0eXBlID0gZ2V0T3BlcmF0aW9uQXV0aHR5cGUocmVxKTsKICAgICAgICB2YXIgcGF5bG9hZE1lbWJlciA9IEFXUy51dGlsLmdldFJlcXVlc3RQYXlsb2FkU2hhcGUocmVxKTsKICAgICAgICBpZiAocmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtTGVuZ3RoJ10gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIGxlbmd0aCA9IEFXUy51dGlsLnN0cmluZy5ieXRlTGVuZ3RoKHJlcS5odHRwUmVxdWVzdC5ib2R5KTsKICAgICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtTGVuZ3RoJ10gPSBsZW5ndGg7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgaWYgKHBheWxvYWRNZW1iZXIgJiYgcGF5bG9hZE1lbWJlci5pc1N0cmVhbWluZykgewogICAgICAgICAgICAgIGlmIChwYXlsb2FkTWVtYmVyLnJlcXVpcmVzTGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAvL3N0cmVhbWluZyBwYXlsb2FkIHJlcXVpcmVzIGxlbmd0aChzMywgZ2xhY2llcikKICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGF1dGh0eXBlLmluZGV4T2YoJ3Vuc2lnbmVkLWJvZHknKSA+PSAwKSB7CiAgICAgICAgICAgICAgICAvL3VuYm91bmRlZCBzdHJlYW1pbmcgcGF5bG9hZChsZXgsIG1lZGlhc3RvcmUpCiAgICAgICAgICAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snVHJhbnNmZXItRW5jb2RpbmcnXSA9ICdjaHVua2VkJzsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdTRVRfSFRUUF9IT1NUJywgJ2FmdGVyQnVpbGQnLCBmdW5jdGlvbiBTRVRfSFRUUF9IT1NUKHJlcSkgewogICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydIb3N0J10gPSByZXEuaHR0cFJlcXVlc3QuZW5kcG9pbnQuaG9zdDsKICAgICAgfSk7CiAgCiAgICAgIGFkZCgnUkVTVEFSVCcsICdyZXN0YXJ0JywgZnVuY3Rpb24gUkVTVEFSVCgpIHsKICAgICAgICB2YXIgZXJyID0gdGhpcy5yZXNwb25zZS5lcnJvcjsKICAgICAgICBpZiAoIWVyciB8fCAhZXJyLnJldHJ5YWJsZSkgcmV0dXJuOwogIAogICAgICAgIHRoaXMuaHR0cFJlcXVlc3QgPSBuZXcgQVdTLkh0dHBSZXF1ZXN0KAogICAgICAgICAgdGhpcy5zZXJ2aWNlLmVuZHBvaW50LAogICAgICAgICAgdGhpcy5zZXJ2aWNlLnJlZ2lvbgogICAgICAgICk7CiAgCiAgICAgICAgaWYgKHRoaXMucmVzcG9uc2UucmV0cnlDb3VudCA8IHRoaXMuc2VydmljZS5jb25maWcubWF4UmV0cmllcykgewogICAgICAgICAgdGhpcy5yZXNwb25zZS5yZXRyeUNvdW50Kys7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMucmVzcG9uc2UuZXJyb3IgPSBudWxsOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIHZhciBhZGRUb0hlYWQgPSB0cnVlOwogICAgICBhZGRBc3luYygnRElTQ09WRVJfRU5EUE9JTlQnLCAnc2lnbicsIERJU0NPVkVSX0VORFBPSU5ULCBhZGRUb0hlYWQpOwogIAogICAgICBhZGRBc3luYygnU0lHTicsICdzaWduJywgZnVuY3Rpb24gU0lHTihyZXEsIGRvbmUpIHsKICAgICAgICB2YXIgc2VydmljZSA9IHJlcS5zZXJ2aWNlOwogICAgICAgIHZhciBvcGVyYXRpb25zID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMgfHwge307CiAgICAgICAgdmFyIG9wZXJhdGlvbiA9IG9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICAgICAgdmFyIGF1dGh0eXBlID0gb3BlcmF0aW9uID8gb3BlcmF0aW9uLmF1dGh0eXBlIDogJyc7CiAgICAgICAgaWYgKCFzZXJ2aWNlLmFwaS5zaWduYXR1cmVWZXJzaW9uICYmICFhdXRodHlwZSAmJiAhc2VydmljZS5jb25maWcuc2lnbmF0dXJlVmVyc2lvbikgcmV0dXJuIGRvbmUoKTsgLy8gbm9uZQogIAogICAgICAgIHNlcnZpY2UuY29uZmlnLmdldENyZWRlbnRpYWxzKGZ1bmN0aW9uIChlcnIsIGNyZWRlbnRpYWxzKSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIHJlcS5yZXNwb25zZS5lcnJvciA9IGVycjsKICAgICAgICAgICAgcmV0dXJuIGRvbmUoKTsKICAgICAgICAgIH0KICAKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBkYXRlID0gc2VydmljZS5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpOwogICAgICAgICAgICB2YXIgU2lnbmVyQ2xhc3MgPSBzZXJ2aWNlLmdldFNpZ25lckNsYXNzKHJlcSk7CiAgICAgICAgICAgIHZhciBzaWduZXIgPSBuZXcgU2lnbmVyQ2xhc3MocmVxLmh0dHBSZXF1ZXN0LAogICAgICAgICAgICAgIHNlcnZpY2UuYXBpLnNpZ25pbmdOYW1lIHx8IHNlcnZpY2UuYXBpLmVuZHBvaW50UHJlZml4LAogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHNpZ25hdHVyZUNhY2hlOiBzZXJ2aWNlLmNvbmZpZy5zaWduYXR1cmVDYWNoZSwKICAgICAgICAgICAgICAgIG9wZXJhdGlvbjogb3BlcmF0aW9uLAogICAgICAgICAgICAgICAgc2lnbmF0dXJlVmVyc2lvbjogc2VydmljZS5hcGkuc2lnbmF0dXJlVmVyc2lvbgogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzaWduZXIuc2V0U2VydmljZUNsaWVudElkKHNlcnZpY2UuX2NsaWVudElkKTsKICAKICAgICAgICAgICAgLy8gY2xlYXIgb2xkIGF1dGhvcml6YXRpb24gaGVhZGVycwogICAgICAgICAgICBkZWxldGUgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXTsKICAgICAgICAgICAgZGVsZXRlIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydEYXRlJ107CiAgICAgICAgICAgIGRlbGV0ZSByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snWC1BbXotRGF0ZSddOwogIAogICAgICAgICAgICAvLyBhZGQgbmV3IGF1dGhvcml6YXRpb24KICAgICAgICAgICAgc2lnbmVyLmFkZEF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGUpOwogICAgICAgICAgICByZXEuc2lnbmVkQXQgPSBkYXRlOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXEucmVzcG9uc2UuZXJyb3IgPSBlOwogICAgICAgICAgfQogICAgICAgICAgZG9uZSgpOwogICAgICAgIH0pOwogICAgICB9KTsKICAKICAgICAgYWRkKCdWQUxJREFURV9SRVNQT05TRScsICd2YWxpZGF0ZVJlc3BvbnNlJywgZnVuY3Rpb24gVkFMSURBVEVfUkVTUE9OU0UocmVzcCkgewogICAgICAgIGlmICh0aGlzLnNlcnZpY2Uuc3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3AsIHRoaXMpKSB7CiAgICAgICAgICByZXNwLmRhdGEgPSB7fTsKICAgICAgICAgIHJlc3AuZXJyb3IgPSBudWxsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXNwLmRhdGEgPSBudWxsOwogICAgICAgICAgcmVzcC5lcnJvciA9IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAgICB7Y29kZTogJ1Vua25vd25FcnJvcicsIG1lc3NhZ2U6ICdBbiB1bmtub3duIGVycm9yIG9jY3VycmVkLid9KTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGRBc3luYygnU0VORCcsICdzZW5kJywgZnVuY3Rpb24gU0VORChyZXNwLCBkb25lKSB7CiAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UuX2Fib3J0Q2FsbGJhY2sgPSBkb25lOwogICAgICAgIHJlc3AuZXJyb3IgPSBudWxsOwogICAgICAgIHJlc3AuZGF0YSA9IG51bGw7CiAgCiAgICAgICAgZnVuY3Rpb24gY2FsbGJhY2soaHR0cFJlc3ApIHsKICAgICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLnN0cmVhbSA9IGh0dHBSZXNwOwogICAgICAgICAgdmFyIHN0cmVhbSA9IHJlc3AucmVxdWVzdC5odHRwUmVxdWVzdC5zdHJlYW07CiAgICAgICAgICB2YXIgc2VydmljZSA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlOwogICAgICAgICAgdmFyIGFwaSA9IHNlcnZpY2UuYXBpOwogICAgICAgICAgdmFyIG9wZXJhdGlvbk5hbWUgPSByZXNwLnJlcXVlc3Qub3BlcmF0aW9uOwogICAgICAgICAgdmFyIG9wZXJhdGlvbiA9IGFwaS5vcGVyYXRpb25zW29wZXJhdGlvbk5hbWVdIHx8IHt9OwogIAogICAgICAgICAgaHR0cFJlc3Aub24oJ2hlYWRlcnMnLCBmdW5jdGlvbiBvbkhlYWRlcnMoc3RhdHVzQ29kZSwgaGVhZGVycywgc3RhdHVzTWVzc2FnZSkgewogICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgKICAgICAgICAgICAgICAnaHR0cEhlYWRlcnMnLAogICAgICAgICAgICAgIFtzdGF0dXNDb2RlLCBoZWFkZXJzLCByZXNwLCBzdGF0dXNNZXNzYWdlXQogICAgICAgICAgICApOwogIAogICAgICAgICAgICBpZiAoIXJlc3AuaHR0cFJlc3BvbnNlLnN0cmVhbWluZykgewogICAgICAgICAgICAgIGlmIChBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMikgeyAvLyBzdHJlYW1zMiBBUEkgY2hlY2sKICAgICAgICAgICAgICAgIC8vIGlmIHdlIGRldGVjdCBldmVudCBzdHJlYW1zLCB3ZSdyZSBnb2luZyB0byBoYXZlIHRvCiAgICAgICAgICAgICAgICAvLyByZXR1cm4gdGhlIHN0cmVhbSBpbW1lZGlhdGVseQogICAgICAgICAgICAgICAgaWYgKG9wZXJhdGlvbi5oYXNFdmVudE91dHB1dCAmJiBzZXJ2aWNlLnN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwKSkgewogICAgICAgICAgICAgICAgICAvLyBza2lwIHJlYWRpbmcgdGhlIEluY29taW5nU3RyZWFtCiAgICAgICAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRG9uZScpOwogICAgICAgICAgICAgICAgICBkb25lKCk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAKICAgICAgICAgICAgICAgIGh0dHBSZXNwLm9uKCdyZWFkYWJsZScsIGZ1bmN0aW9uIG9uUmVhZGFibGUoKSB7CiAgICAgICAgICAgICAgICAgIHZhciBkYXRhID0gaHR0cFJlc3AucmVhZCgpOwogICAgICAgICAgICAgICAgICBpZiAoZGF0YSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRGF0YScsIFtkYXRhLCByZXNwXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7IC8vIGxlZ2FjeSBzdHJlYW1zIEFQSQogICAgICAgICAgICAgICAgaHR0cFJlc3Aub24oJ2RhdGEnLCBmdW5jdGlvbiBvbkRhdGEoZGF0YSkgewogICAgICAgICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERhdGEnLCBbZGF0YSwgcmVzcF0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAKICAgICAgICAgIGh0dHBSZXNwLm9uKCdlbmQnLCBmdW5jdGlvbiBvbkVuZCgpIHsKICAgICAgICAgICAgaWYgKCFzdHJlYW0gfHwgIXN0cmVhbS5kaWRDYWxsYmFjaykgewogICAgICAgICAgICAgIGlmIChBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMiAmJiAob3BlcmF0aW9uLmhhc0V2ZW50T3V0cHV0ICYmIHNlcnZpY2Uuc3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3ApKSkgewogICAgICAgICAgICAgICAgLy8gZG9uJ3QgY29uY2F0ZW5hdGUgcmVzcG9uc2UgY2h1bmtzIHdoZW4gc3RyZWFtaW5nIGV2ZW50IHN0cmVhbSBkYXRhIHdoZW4gcmVzcG9uc2UgaXMgc3VjY2Vzc2Z1bAogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERvbmUnKTsKICAgICAgICAgICAgICBkb25lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAKICAgICAgICBmdW5jdGlvbiBwcm9ncmVzcyhodHRwUmVzcCkgewogICAgICAgICAgaHR0cFJlc3Aub24oJ3NlbmRQcm9ncmVzcycsIGZ1bmN0aW9uIG9uU2VuZFByb2dyZXNzKHZhbHVlKSB7CiAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwVXBsb2FkUHJvZ3Jlc3MnLCBbdmFsdWUsIHJlc3BdKTsKICAgICAgICAgIH0pOwogIAogICAgICAgICAgaHR0cFJlc3Aub24oJ3JlY2VpdmVQcm9ncmVzcycsIGZ1bmN0aW9uIG9uUmVjZWl2ZVByb2dyZXNzKHZhbHVlKSB7CiAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRG93bmxvYWRQcm9ncmVzcycsIFt2YWx1ZSwgcmVzcF0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogIAogICAgICAgIGZ1bmN0aW9uIGVycm9yKGVycikgewogICAgICAgICAgaWYgKGVyci5jb2RlICE9PSAnUmVxdWVzdEFib3J0ZWRFcnJvcicpIHsKICAgICAgICAgICAgdmFyIGVyckNvZGUgPSBlcnIuY29kZSA9PT0gJ1RpbWVvdXRFcnJvcicgPyBlcnIuY29kZSA6ICdOZXR3b3JraW5nRXJyb3InOwogICAgICAgICAgICBlcnIgPSBBV1MudXRpbC5lcnJvcihlcnIsIHsKICAgICAgICAgICAgICBjb2RlOiBlcnJDb2RlLAogICAgICAgICAgICAgIHJlZ2lvbjogcmVzcC5yZXF1ZXN0Lmh0dHBSZXF1ZXN0LnJlZ2lvbiwKICAgICAgICAgICAgICBob3N0bmFtZTogcmVzcC5yZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50Lmhvc3RuYW1lLAogICAgICAgICAgICAgIHJldHJ5YWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3AuZXJyb3IgPSBlcnI7CiAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cEVycm9yJywgW3Jlc3AuZXJyb3IsIHJlc3BdLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogIAogICAgICAgIGZ1bmN0aW9uIGV4ZWN1dGVTZW5kKCkgewogICAgICAgICAgdmFyIGh0dHAgPSBBV1MuSHR0cENsaWVudC5nZXRJbnN0YW5jZSgpOwogICAgICAgICAgdmFyIGh0dHBPcHRpb25zID0gcmVzcC5yZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmh0dHBPcHRpb25zIHx8IHt9OwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIHN0cmVhbSA9IGh0dHAuaGFuZGxlUmVxdWVzdChyZXNwLnJlcXVlc3QuaHR0cFJlcXVlc3QsIGh0dHBPcHRpb25zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLCBlcnJvcik7CiAgICAgICAgICAgIHByb2dyZXNzKHN0cmVhbSk7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgZXJyb3IoZXJyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHRpbWVEaWZmID0gKHJlc3AucmVxdWVzdC5zZXJ2aWNlLmdldFNrZXdDb3JyZWN0ZWREYXRlKCkgLSB0aGlzLnNpZ25lZEF0KSAvIDEwMDA7CiAgICAgICAgaWYgKHRpbWVEaWZmID49IDYwICogMTApIHsgLy8gaWYgd2Ugc2lnbmVkIDEwbWluIGFnbywgcmUtc2lnbgogICAgICAgICAgdGhpcy5lbWl0KCdzaWduJywgW3RoaXNdLCBmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgaWYgKGVycikgZG9uZShlcnIpOwogICAgICAgICAgICBlbHNlIGV4ZWN1dGVTZW5kKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZXhlY3V0ZVNlbmQoKTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0hUVFBfSEVBREVSUycsICdodHRwSGVhZGVycycsCiAgICAgICAgICBmdW5jdGlvbiBIVFRQX0hFQURFUlMoc3RhdHVzQ29kZSwgaGVhZGVycywgcmVzcCwgc3RhdHVzTWVzc2FnZSkgewogICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUgPSBzdGF0dXNDb2RlOwogICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c01lc3NhZ2UgPSBzdGF0dXNNZXNzYWdlOwogICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnMgPSBoZWFkZXJzOwogICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkgPSBBV1MudXRpbC5idWZmZXIudG9CdWZmZXIoJycpOwogICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLmJ1ZmZlcnMgPSBbXTsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5udW1CeXRlcyA9IDA7CiAgICAgICAgdmFyIGRhdGVIZWFkZXIgPSBoZWFkZXJzLmRhdGUgfHwgaGVhZGVycy5EYXRlOwogICAgICAgIHZhciBzZXJ2aWNlID0gcmVzcC5yZXF1ZXN0LnNlcnZpY2U7CiAgICAgICAgaWYgKGRhdGVIZWFkZXIpIHsKICAgICAgICAgIHZhciBzZXJ2ZXJUaW1lID0gRGF0ZS5wYXJzZShkYXRlSGVhZGVyKTsKICAgICAgICAgIGlmIChzZXJ2aWNlLmNvbmZpZy5jb3JyZWN0Q2xvY2tTa2V3CiAgICAgICAgICAgICAgJiYgc2VydmljZS5pc0Nsb2NrU2tld2VkKHNlcnZlclRpbWUpKSB7CiAgICAgICAgICAgIHNlcnZpY2UuYXBwbHlDbG9ja09mZnNldChzZXJ2ZXJUaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0hUVFBfREFUQScsICdodHRwRGF0YScsIGZ1bmN0aW9uIEhUVFBfREFUQShjaHVuaywgcmVzcCkgewogICAgICAgIGlmIChjaHVuaykgewogICAgICAgICAgaWYgKEFXUy51dGlsLmlzTm9kZSgpKSB7CiAgICAgICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLm51bUJ5dGVzICs9IGNodW5rLmxlbmd0aDsKICAKICAgICAgICAgICAgdmFyIHRvdGFsID0gcmVzcC5odHRwUmVzcG9uc2UuaGVhZGVyc1snY29udGVudC1sZW5ndGgnXTsKICAgICAgICAgICAgdmFyIHByb2dyZXNzID0geyBsb2FkZWQ6IHJlc3AuaHR0cFJlc3BvbnNlLm51bUJ5dGVzLCB0b3RhbDogdG90YWwgfTsKICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEb3dubG9hZFByb2dyZXNzJywgW3Byb2dyZXNzLCByZXNwXSk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzLnB1c2goQVdTLnV0aWwuYnVmZmVyLnRvQnVmZmVyKGNodW5rKSk7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdIVFRQX0RPTkUnLCAnaHR0cERvbmUnLCBmdW5jdGlvbiBIVFRQX0RPTkUocmVzcCkgewogICAgICAgIC8vIGNvbnZlcnQgYnVmZmVycyBhcnJheSBpbnRvIHNpbmdsZSBidWZmZXIKICAgICAgICBpZiAocmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycyAmJiByZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHZhciBib2R5ID0gQVdTLnV0aWwuYnVmZmVyLmNvbmNhdChyZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzKTsKICAgICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkgPSBib2R5OwogICAgICAgIH0KICAgICAgICBkZWxldGUgcmVzcC5odHRwUmVzcG9uc2UubnVtQnl0ZXM7CiAgICAgICAgZGVsZXRlIHJlc3AuaHR0cFJlc3BvbnNlLmJ1ZmZlcnM7CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0ZJTkFMSVpFX0VSUk9SJywgJ3JldHJ5JywgZnVuY3Rpb24gRklOQUxJWkVfRVJST1IocmVzcCkgewogICAgICAgIGlmIChyZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlKSB7CiAgICAgICAgICByZXNwLmVycm9yLnN0YXR1c0NvZGUgPSByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICAgICAgaWYgKHJlc3AuZXJyb3IucmV0cnlhYmxlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmVzcC5lcnJvci5yZXRyeWFibGUgPSB0aGlzLnNlcnZpY2UucmV0cnlhYmxlRXJyb3IocmVzcC5lcnJvciwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdJTlZBTElEQVRFX0NSRURFTlRJQUxTJywgJ3JldHJ5JywgZnVuY3Rpb24gSU5WQUxJREFURV9DUkVERU5USUFMUyhyZXNwKSB7CiAgICAgICAgaWYgKCFyZXNwLmVycm9yKSByZXR1cm47CiAgICAgICAgc3dpdGNoIChyZXNwLmVycm9yLmNvZGUpIHsKICAgICAgICAgIGNhc2UgJ1JlcXVlc3RFeHBpcmVkJzogLy8gRUMyIG9ubHkKICAgICAgICAgIGNhc2UgJ0V4cGlyZWRUb2tlbkV4Y2VwdGlvbic6CiAgICAgICAgICBjYXNlICdFeHBpcmVkVG9rZW4nOgogICAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgICAgICAgIHJlc3AucmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscy5leHBpcmVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0VYUElSRURfU0lHTkFUVVJFJywgJ3JldHJ5JywgZnVuY3Rpb24gRVhQSVJFRF9TSUdOQVRVUkUocmVzcCkgewogICAgICAgIHZhciBlcnIgPSByZXNwLmVycm9yOwogICAgICAgIGlmICghZXJyKSByZXR1cm47CiAgICAgICAgaWYgKHR5cGVvZiBlcnIuY29kZSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIGVyci5tZXNzYWdlID09PSAnc3RyaW5nJykgewogICAgICAgICAgaWYgKGVyci5jb2RlLm1hdGNoKC9TaWduYXR1cmUvKSAmJiBlcnIubWVzc2FnZS5tYXRjaCgvZXhwaXJlZC8pKSB7CiAgICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0NMT0NLX1NLRVdFRCcsICdyZXRyeScsIGZ1bmN0aW9uIENMT0NLX1NLRVdFRChyZXNwKSB7CiAgICAgICAgaWYgKCFyZXNwLmVycm9yKSByZXR1cm47CiAgICAgICAgaWYgKHRoaXMuc2VydmljZS5jbG9ja1NrZXdFcnJvcihyZXNwLmVycm9yKQogICAgICAgICAgICAmJiB0aGlzLnNlcnZpY2UuY29uZmlnLmNvcnJlY3RDbG9ja1NrZXcpIHsKICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1JFRElSRUNUJywgJ3JldHJ5JywgZnVuY3Rpb24gUkVESVJFQ1QocmVzcCkgewogICAgICAgIGlmIChyZXNwLmVycm9yICYmIHJlc3AuZXJyb3Iuc3RhdHVzQ29kZSA+PSAzMDAgJiYKICAgICAgICAgICAgcmVzcC5lcnJvci5zdGF0dXNDb2RlIDwgNDAwICYmIHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ2xvY2F0aW9uJ10pIHsKICAgICAgICAgIHRoaXMuaHR0cFJlcXVlc3QuZW5kcG9pbnQgPQogICAgICAgICAgICBuZXcgQVdTLkVuZHBvaW50KHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ2xvY2F0aW9uJ10pOwogICAgICAgICAgdGhpcy5odHRwUmVxdWVzdC5oZWFkZXJzWydIb3N0J10gPSB0aGlzLmh0dHBSZXF1ZXN0LmVuZHBvaW50Lmhvc3Q7CiAgICAgICAgICByZXNwLmVycm9yLnJlZGlyZWN0ID0gdHJ1ZTsKICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1JFVFJZX0NIRUNLJywgJ3JldHJ5JywgZnVuY3Rpb24gUkVUUllfQ0hFQ0socmVzcCkgewogICAgICAgIGlmIChyZXNwLmVycm9yKSB7CiAgICAgICAgICBpZiAocmVzcC5lcnJvci5yZWRpcmVjdCAmJiByZXNwLnJlZGlyZWN0Q291bnQgPCByZXNwLm1heFJlZGlyZWN0cykgewogICAgICAgICAgICByZXNwLmVycm9yLnJldHJ5RGVsYXkgPSAwOwogICAgICAgICAgfSBlbHNlIGlmIChyZXNwLnJldHJ5Q291bnQgPCByZXNwLm1heFJldHJpZXMpIHsKICAgICAgICAgICAgcmVzcC5lcnJvci5yZXRyeURlbGF5ID0gdGhpcy5zZXJ2aWNlLnJldHJ5RGVsYXlzKHJlc3AucmV0cnlDb3VudCkgfHwgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGRBc3luYygnUkVTRVRfUkVUUllfU1RBVEUnLCAnYWZ0ZXJSZXRyeScsIGZ1bmN0aW9uIFJFU0VUX1JFVFJZX1NUQVRFKHJlc3AsIGRvbmUpIHsKICAgICAgICB2YXIgZGVsYXksIHdpbGxSZXRyeSA9IGZhbHNlOwogIAogICAgICAgIGlmIChyZXNwLmVycm9yKSB7CiAgICAgICAgICBkZWxheSA9IHJlc3AuZXJyb3IucmV0cnlEZWxheSB8fCAwOwogICAgICAgICAgaWYgKHJlc3AuZXJyb3IucmV0cnlhYmxlICYmIHJlc3AucmV0cnlDb3VudCA8IHJlc3AubWF4UmV0cmllcykgewogICAgICAgICAgICByZXNwLnJldHJ5Q291bnQrKzsKICAgICAgICAgICAgd2lsbFJldHJ5ID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAocmVzcC5lcnJvci5yZWRpcmVjdCAmJiByZXNwLnJlZGlyZWN0Q291bnQgPCByZXNwLm1heFJlZGlyZWN0cykgewogICAgICAgICAgICByZXNwLnJlZGlyZWN0Q291bnQrKzsKICAgICAgICAgICAgd2lsbFJldHJ5ID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgCiAgICAgICAgaWYgKHdpbGxSZXRyeSkgewogICAgICAgICAgcmVzcC5lcnJvciA9IG51bGw7CiAgICAgICAgICBzZXRUaW1lb3V0KGRvbmUsIGRlbGF5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZG9uZSgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KSwKICAKICAgIENvcmVQb3N0OiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICAgIGFkZCgnRVhUUkFDVF9SRVFVRVNUX0lEJywgJ2V4dHJhY3REYXRhJywgQVdTLnV0aWwuZXh0cmFjdFJlcXVlc3RJZCk7CiAgICAgIGFkZCgnRVhUUkFDVF9SRVFVRVNUX0lEJywgJ2V4dHJhY3RFcnJvcicsIEFXUy51dGlsLmV4dHJhY3RSZXF1ZXN0SWQpOwogIAogICAgICBhZGQoJ0VOT1RGT1VORF9FUlJPUicsICdodHRwRXJyb3InLCBmdW5jdGlvbiBFTk9URk9VTkRfRVJST1IoZXJyKSB7CiAgICAgICAgaWYgKGVyci5jb2RlID09PSAnTmV0d29ya2luZ0Vycm9yJyAmJiBlcnIuZXJybm8gPT09ICdFTk9URk9VTkQnKSB7CiAgICAgICAgICB2YXIgbWVzc2FnZSA9ICdJbmFjY2Vzc2libGUgaG9zdDogYCcgKyBlcnIuaG9zdG5hbWUgKwogICAgICAgICAgICAnXCcuIFRoaXMgc2VydmljZSBtYXkgbm90IGJlIGF2YWlsYWJsZSBpbiB0aGUgYCcgKyBlcnIucmVnaW9uICsKICAgICAgICAgICAgJ1wnIHJlZ2lvbi4nOwogICAgICAgICAgdGhpcy5yZXNwb25zZS5lcnJvciA9IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcihtZXNzYWdlKSwgewogICAgICAgICAgICBjb2RlOiAnVW5rbm93bkVuZHBvaW50JywKICAgICAgICAgICAgcmVnaW9uOiBlcnIucmVnaW9uLAogICAgICAgICAgICBob3N0bmFtZTogZXJyLmhvc3RuYW1lLAogICAgICAgICAgICByZXRyeWFibGU6IHRydWUsCiAgICAgICAgICAgIG9yaWdpbmFsRXJyb3I6IGVycgogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pLAogIAogICAgTG9nZ2VyOiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICAgIGFkZCgnTE9HX1JFUVVFU1QnLCAnY29tcGxldGUnLCBmdW5jdGlvbiBMT0dfUkVRVUVTVChyZXNwKSB7CiAgICAgICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgICAgICB2YXIgbG9nZ2VyID0gcmVxLnNlcnZpY2UuY29uZmlnLmxvZ2dlcjsKICAgICAgICBpZiAoIWxvZ2dlcikgcmV0dXJuOwogICAgICAgIGZ1bmN0aW9uIGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLCBzaGFwZSkgewogICAgICAgICAgaWYgKCFzaGFwZSkgewogICAgICAgICAgICByZXR1cm4gc2hhcGU7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKGlucHV0U2hhcGUudHlwZSkgewogICAgICAgICAgICBjYXNlICdzdHJ1Y3R1cmUnOgogICAgICAgICAgICAgIHZhciBzdHJ1Y3QgPSB7fTsKICAgICAgICAgICAgICBBV1MudXRpbC5lYWNoKHNoYXBlLCBmdW5jdGlvbihzdWJTaGFwZU5hbWUsIHN1YlNoYXBlKSB7CiAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGlucHV0U2hhcGUubWVtYmVycywgc3ViU2hhcGVOYW1lKSkgewogICAgICAgICAgICAgICAgICBzdHJ1Y3Rbc3ViU2hhcGVOYW1lXSA9IGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLm1lbWJlcnNbc3ViU2hhcGVOYW1lXSwgc3ViU2hhcGUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgc3RydWN0W3N1YlNoYXBlTmFtZV0gPSBzdWJTaGFwZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXR1cm4gc3RydWN0OwogICAgICAgICAgICBjYXNlICdsaXN0JzoKICAgICAgICAgICAgICB2YXIgbGlzdCA9IFtdOwogICAgICAgICAgICAgIEFXUy51dGlsLmFycmF5RWFjaChzaGFwZSwgZnVuY3Rpb24oc3ViU2hhcGUsIGluZGV4KSB7CiAgICAgICAgICAgICAgICBsaXN0LnB1c2goZmlsdGVyU2Vuc2l0aXZlTG9nKGlucHV0U2hhcGUubWVtYmVyLCBzdWJTaGFwZSkpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybiBsaXN0OwogICAgICAgICAgICBjYXNlICdtYXAnOgogICAgICAgICAgICAgIHZhciBtYXAgPSB7fTsKICAgICAgICAgICAgICBBV1MudXRpbC5lYWNoKHNoYXBlLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICAgICBtYXBba2V5XSA9IGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLnZhbHVlLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBpZiAoaW5wdXRTaGFwZS5pc1NlbnNpdGl2ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICcqKipTZW5zaXRpdmVJbmZvcm1hdGlvbioqKic7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBzaGFwZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogIAogICAgICAgIGZ1bmN0aW9uIGJ1aWxkTWVzc2FnZSgpIHsKICAgICAgICAgIHZhciB0aW1lID0gcmVzcC5yZXF1ZXN0LnNlcnZpY2UuZ2V0U2tld0NvcnJlY3RlZERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgICB2YXIgZGVsdGEgPSAodGltZSAtIHJlcS5zdGFydFRpbWUuZ2V0VGltZSgpKSAvIDEwMDA7CiAgICAgICAgICB2YXIgYW5zaSA9IGxvZ2dlci5pc1RUWSA/IHRydWUgOiBmYWxzZTsKICAgICAgICAgIHZhciBzdGF0dXMgPSByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICAgICAgdmFyIGNlbnNvcmVkUGFyYW1zID0gcmVxLnBhcmFtczsKICAgICAgICAgIGlmICgKICAgICAgICAgICAgcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMgJiYKICAgICAgICAgICAgICAgIHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dICYmCiAgICAgICAgICAgICAgICByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dAogICAgICAgICAgKSB7CiAgICAgICAgICAgIHZhciBpbnB1dFNoYXBlID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQ7CiAgICAgICAgICAgIGNlbnNvcmVkUGFyYW1zID0gZmlsdGVyU2Vuc2l0aXZlTG9nKGlucHV0U2hhcGUsIHJlcS5wYXJhbXMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBhcmFtcyA9IHJlcXVpcmUoJ3V0aWwnKS5pbnNwZWN0KGNlbnNvcmVkUGFyYW1zLCB0cnVlLCBudWxsKTsKICAgICAgICAgIHZhciBtZXNzYWdlID0gJyc7CiAgICAgICAgICBpZiAoYW5zaSkgbWVzc2FnZSArPSAnXHgxQlszM20nOwogICAgICAgICAgbWVzc2FnZSArPSAnW0FXUyAnICsgcmVxLnNlcnZpY2Uuc2VydmljZUlkZW50aWZpZXIgKyAnICcgKyBzdGF0dXM7CiAgICAgICAgICBtZXNzYWdlICs9ICcgJyArIGRlbHRhLnRvU3RyaW5nKCkgKyAncyAnICsgcmVzcC5yZXRyeUNvdW50ICsgJyByZXRyaWVzXSc7CiAgICAgICAgICBpZiAoYW5zaSkgbWVzc2FnZSArPSAnXHgxQlswOzFtJzsKICAgICAgICAgIG1lc3NhZ2UgKz0gJyAnICsgQVdTLnV0aWwuc3RyaW5nLmxvd2VyRmlyc3QocmVxLm9wZXJhdGlvbik7CiAgICAgICAgICBtZXNzYWdlICs9ICcoJyArIHBhcmFtcyArICcpJzsKICAgICAgICAgIGlmIChhbnNpKSBtZXNzYWdlICs9ICdceDFCWzBtJzsKICAgICAgICAgIHJldHVybiBtZXNzYWdlOwogICAgICAgIH0KICAKICAgICAgICB2YXIgbGluZSA9IGJ1aWxkTWVzc2FnZSgpOwogICAgICAgIGlmICh0eXBlb2YgbG9nZ2VyLmxvZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgbG9nZ2VyLmxvZyhsaW5lKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBsb2dnZXIud3JpdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGxvZ2dlci53cml0ZShsaW5lICsgJ1xuJyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pLAogIAogICAgSnNvbjogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICB2YXIgc3ZjID0gcmVxdWlyZSgnLi9wcm90b2NvbC9qc29uJyk7CiAgICAgIGFkZCgnQlVJTEQnLCAnYnVpbGQnLCBzdmMuYnVpbGRSZXF1ZXN0KTsKICAgICAgYWRkKCdFWFRSQUNUX0RBVEEnLCAnZXh0cmFjdERhdGEnLCBzdmMuZXh0cmFjdERhdGEpOwogICAgICBhZGQoJ0VYVFJBQ1RfRVJST1InLCAnZXh0cmFjdEVycm9yJywgc3ZjLmV4dHJhY3RFcnJvcik7CiAgICB9KSwKICAKICAgIFJlc3Q6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdCcpOwogICAgICBhZGQoJ0JVSUxEJywgJ2J1aWxkJywgc3ZjLmJ1aWxkUmVxdWVzdCk7CiAgICAgIGFkZCgnRVhUUkFDVF9EQVRBJywgJ2V4dHJhY3REYXRhJywgc3ZjLmV4dHJhY3REYXRhKTsKICAgICAgYWRkKCdFWFRSQUNUX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIHN2Yy5leHRyYWN0RXJyb3IpOwogICAgfSksCiAgCiAgICBSZXN0SnNvbjogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICB2YXIgc3ZjID0gcmVxdWlyZSgnLi9wcm90b2NvbC9yZXN0X2pzb24nKTsKICAgICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICAgIH0pLAogIAogICAgUmVzdFhtbDogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICB2YXIgc3ZjID0gcmVxdWlyZSgnLi9wcm90b2NvbC9yZXN0X3htbCcpOwogICAgICBhZGQoJ0JVSUxEJywgJ2J1aWxkJywgc3ZjLmJ1aWxkUmVxdWVzdCk7CiAgICAgIGFkZCgnRVhUUkFDVF9EQVRBJywgJ2V4dHJhY3REYXRhJywgc3ZjLmV4dHJhY3REYXRhKTsKICAgICAgYWRkKCdFWFRSQUNUX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIHN2Yy5leHRyYWN0RXJyb3IpOwogICAgfSksCiAgCiAgICBRdWVyeTogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICB2YXIgc3ZjID0gcmVxdWlyZSgnLi9wcm90b2NvbC9xdWVyeScpOwogICAgICBhZGQoJ0JVSUxEJywgJ2J1aWxkJywgc3ZjLmJ1aWxkUmVxdWVzdCk7CiAgICAgIGFkZCgnRVhUUkFDVF9EQVRBJywgJ2V4dHJhY3REYXRhJywgc3ZjLmV4dHJhY3REYXRhKTsKICAgICAgYWRkKCdFWFRSQUNUX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIHN2Yy5leHRyYWN0RXJyb3IpOwogICAgfSkKICB9OwogIAogIH0seyIuL2NvcmUiOjE4LCIuL2Rpc2NvdmVyX2VuZHBvaW50IjoyNiwiLi9wcm90b2NvbC9qc29uIjo0NiwiLi9wcm90b2NvbC9xdWVyeSI6NDcsIi4vcHJvdG9jb2wvcmVzdCI6NDgsIi4vcHJvdG9jb2wvcmVzdF9qc29uIjo0OSwiLi9wcm90b2NvbC9yZXN0X3htbCI6NTAsIi4vc2VxdWVudGlhbF9leGVjdXRvciI6NTgsInV0aWwiOjk3fV0sMzQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgLyoqCiAgICogVGhlIGVuZHBvaW50IHRoYXQgYSBzZXJ2aWNlIHdpbGwgdGFsayB0bywgZm9yIGV4YW1wbGUsCiAgICogYCdodHRwczovL2VjMi5hcC1zb3V0aGVhc3QtMS5hbWF6b25hd3MuY29tJ2AuIElmCiAgICogeW91IG5lZWQgdG8gb3ZlcnJpZGUgYW4gZW5kcG9pbnQgZm9yIGEgc2VydmljZSwgeW91IGNhbgogICAqIHNldCB0aGUgZW5kcG9pbnQgb24gYSBzZXJ2aWNlIGJ5IHBhc3NpbmcgdGhlIGVuZHBvaW50CiAgICogb2JqZWN0IHdpdGggdGhlIGBlbmRwb2ludGAgb3B0aW9uIGtleToKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiB2YXIgZXAgPSBuZXcgQVdTLkVuZHBvaW50KCdhd3Nwcm94eS5leGFtcGxlLmNvbScpOwogICAqIHZhciBzMyA9IG5ldyBBV1MuUzMoe2VuZHBvaW50OiBlcH0pOwogICAqIHMzLnNlcnZpY2UuZW5kcG9pbnQuaG9zdG5hbWUgPT0gJ2F3c3Byb3h5LmV4YW1wbGUuY29tJwogICAqIGBgYAogICAqCiAgICogTm90ZSB0aGF0IGlmIHlvdSBkbyBub3Qgc3BlY2lmeSBhIHByb3RvY29sLCB0aGUgcHJvdG9jb2wgd2lsbAogICAqIGJlIHNlbGVjdGVkIGJhc2VkIG9uIHlvdXIgY3VycmVudCB7QVdTLmNvbmZpZ30gY29uZmlndXJhdGlvbi4KICAgKgogICAqIEAhYXR0cmlidXRlIHByb3RvY29sCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBwcm90b2NvbCAoaHR0cCBvciBodHRwcykgb2YgdGhlIGVuZHBvaW50CiAgICogICAgIFVSTAogICAqIEAhYXR0cmlidXRlIGhvc3RuYW1lCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBob3N0IHBvcnRpb24gb2YgdGhlIGVuZHBvaW50LCBlLmcuLAogICAqICAgICBleGFtcGxlLmNvbQogICAqIEAhYXR0cmlidXRlIGhvc3QKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIGhvc3QgcG9ydGlvbiBvZiB0aGUgZW5kcG9pbnQgaW5jbHVkaW5nCiAgICogICAgIHRoZSBwb3J0LCBlLmcuLCBleGFtcGxlLmNvbTo4MAogICAqIEAhYXR0cmlidXRlIHBvcnQKICAgKiAgIEByZXR1cm4gW0ludGVnZXJdIHRoZSBwb3J0IG9mIHRoZSBlbmRwb2ludAogICAqIEAhYXR0cmlidXRlIGhyZWYKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIGZ1bGwgVVJMIG9mIHRoZSBlbmRwb2ludAogICAqLwogIEFXUy5FbmRwb2ludCA9IGluaGVyaXQoewogIAogICAgLyoqCiAgICAgKiBAb3ZlcmxvYWQgRW5kcG9pbnQoZW5kcG9pbnQpCiAgICAgKiAgIENvbnN0cnVjdHMgYSBuZXcgZW5kcG9pbnQgZ2l2ZW4gYW4gZW5kcG9pbnQgVVJMLiBJZiB0aGUKICAgICAqICAgVVJMIG9taXRzIGEgcHJvdG9jb2wgKGh0dHAgb3IgaHR0cHMpLCB0aGUgZGVmYXVsdCBwcm90b2NvbAogICAgICogICBzZXQgaW4gdGhlIGdsb2JhbCB7QVdTLmNvbmZpZ30gd2lsbCBiZSB1c2VkLgogICAgICogICBAcGFyYW0gZW5kcG9pbnQgW1N0cmluZ10gdGhlIFVSTCB0byBjb25zdHJ1Y3QgYW4gZW5kcG9pbnQgZnJvbQogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gRW5kcG9pbnQoZW5kcG9pbnQsIGNvbmZpZykgewogICAgICBBV1MudXRpbC5oaWRlUHJvcGVydGllcyh0aGlzLCBbJ3NsYXNoZXMnLCAnYXV0aCcsICdoYXNoJywgJ3NlYXJjaCcsICdxdWVyeSddKTsKICAKICAgICAgaWYgKHR5cGVvZiBlbmRwb2ludCA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5kcG9pbnQgPT09IG51bGwpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgZW5kcG9pbnQ6ICcgKyBlbmRwb2ludCk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGVuZHBvaW50ICE9PSAnc3RyaW5nJykgewogICAgICAgIHJldHVybiBBV1MudXRpbC5jb3B5KGVuZHBvaW50KTsKICAgICAgfQogIAogICAgICBpZiAoIWVuZHBvaW50Lm1hdGNoKC9eaHR0cC8pKSB7CiAgICAgICAgdmFyIHVzZVNTTCA9IGNvbmZpZyAmJiBjb25maWcuc3NsRW5hYmxlZCAhPT0gdW5kZWZpbmVkID8KICAgICAgICAgIGNvbmZpZy5zc2xFbmFibGVkIDogQVdTLmNvbmZpZy5zc2xFbmFibGVkOwogICAgICAgIGVuZHBvaW50ID0gKHVzZVNTTCA/ICdodHRwcycgOiAnaHR0cCcpICsgJzovLycgKyBlbmRwb2ludDsKICAgICAgfQogIAogICAgICBBV1MudXRpbC51cGRhdGUodGhpcywgQVdTLnV0aWwudXJsUGFyc2UoZW5kcG9pbnQpKTsKICAKICAgICAgLy8gRW5zdXJlIHRoZSBwb3J0IHByb3BlcnR5IGlzIHNldCBhcyBhbiBpbnRlZ2VyCiAgICAgIGlmICh0aGlzLnBvcnQpIHsKICAgICAgICB0aGlzLnBvcnQgPSBwYXJzZUludCh0aGlzLnBvcnQsIDEwKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnBvcnQgPSB0aGlzLnByb3RvY29sID09PSAnaHR0cHM6JyA/IDQ0MyA6IDgwOwogICAgICB9CiAgICB9CiAgCiAgfSk7CiAgCiAgLyoqCiAgICogVGhlIGxvdyBsZXZlbCBIVFRQIHJlcXVlc3Qgb2JqZWN0LCBlbmNhcHN1bGF0aW5nIGFsbCBIVFRQIGhlYWRlcgogICAqIGFuZCBib2R5IGRhdGEgc2VudCBieSBhIHNlcnZpY2UgcmVxdWVzdC4KICAgKgogICAqIEAhYXR0cmlidXRlIG1ldGhvZAogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgSFRUUCBtZXRob2Qgb2YgdGhlIHJlcXVlc3QKICAgKiBAIWF0dHJpYnV0ZSBwYXRoCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBwYXRoIHBvcnRpb24gb2YgdGhlIFVSSSwgZS5nLiwKICAgKiAgICAgIi9saXN0Lz9zdGFydD01Jm51bT0xMCIKICAgKiBAIWF0dHJpYnV0ZSBoZWFkZXJzCiAgICogICBAcmV0dXJuIFttYXA8U3RyaW5nLFN0cmluZz5dCiAgICogICAgIGEgbWFwIG9mIGhlYWRlciBrZXlzIGFuZCB0aGVpciByZXNwZWN0aXZlIHZhbHVlcwogICAqIEAhYXR0cmlidXRlIGJvZHkKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIHJlcXVlc3QgYm9keSBwYXlsb2FkCiAgICogQCFhdHRyaWJ1dGUgZW5kcG9pbnQKICAgKiAgIEByZXR1cm4gW0FXUy5FbmRwb2ludF0gdGhlIGVuZHBvaW50IGZvciB0aGUgcmVxdWVzdAogICAqIEAhYXR0cmlidXRlIHJlZ2lvbgogICAqICAgQGFwaSBwcml2YXRlCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSByZWdpb24sIGZvciBzaWduaW5nIHB1cnBvc2VzIG9ubHkuCiAgICovCiAgQVdTLkh0dHBSZXF1ZXN0ID0gaW5oZXJpdCh7CiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gSHR0cFJlcXVlc3QoZW5kcG9pbnQsIHJlZ2lvbikgewogICAgICBlbmRwb2ludCA9IG5ldyBBV1MuRW5kcG9pbnQoZW5kcG9pbnQpOwogICAgICB0aGlzLm1ldGhvZCA9ICdQT1NUJzsKICAgICAgdGhpcy5wYXRoID0gZW5kcG9pbnQucGF0aCB8fCAnLyc7CiAgICAgIHRoaXMuaGVhZGVycyA9IHt9OwogICAgICB0aGlzLmJvZHkgPSAnJzsKICAgICAgdGhpcy5lbmRwb2ludCA9IGVuZHBvaW50OwogICAgICB0aGlzLnJlZ2lvbiA9IHJlZ2lvbjsKICAgICAgdGhpcy5fdXNlckFnZW50ID0gJyc7CiAgICAgIHRoaXMuc2V0VXNlckFnZW50KCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc2V0VXNlckFnZW50OiBmdW5jdGlvbiBzZXRVc2VyQWdlbnQoKSB7CiAgICAgIHRoaXMuX3VzZXJBZ2VudCA9IHRoaXMuaGVhZGVyc1t0aGlzLmdldFVzZXJBZ2VudEhlYWRlck5hbWUoKV0gPSBBV1MudXRpbC51c2VyQWdlbnQoKTsKICAgIH0sCiAgCiAgICBnZXRVc2VyQWdlbnRIZWFkZXJOYW1lOiBmdW5jdGlvbiBnZXRVc2VyQWdlbnRIZWFkZXJOYW1lKCkgewogICAgICB2YXIgcHJlZml4ID0gQVdTLnV0aWwuaXNCcm93c2VyKCkgPyAnWC1BbXotJyA6ICcnOwogICAgICByZXR1cm4gcHJlZml4ICsgJ1VzZXItQWdlbnQnOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwcGVuZFRvVXNlckFnZW50OiBmdW5jdGlvbiBhcHBlbmRUb1VzZXJBZ2VudChhZ2VudFBhcnRpYWwpIHsKICAgICAgaWYgKHR5cGVvZiBhZ2VudFBhcnRpYWwgPT09ICdzdHJpbmcnICYmIGFnZW50UGFydGlhbCkgewogICAgICAgIHRoaXMuX3VzZXJBZ2VudCArPSAnICcgKyBhZ2VudFBhcnRpYWw7CiAgICAgIH0KICAgICAgdGhpcy5oZWFkZXJzW3RoaXMuZ2V0VXNlckFnZW50SGVhZGVyTmFtZSgpXSA9IHRoaXMuX3VzZXJBZ2VudDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRVc2VyQWdlbnQ6IGZ1bmN0aW9uIGdldFVzZXJBZ2VudCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3VzZXJBZ2VudDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEByZXR1cm4gW1N0cmluZ10gdGhlIHBhcnQgb2YgdGhlIHtwYXRofSBleGNsdWRpbmcgdGhlCiAgICAgKiAgIHF1ZXJ5IHN0cmluZwogICAgICovCiAgICBwYXRobmFtZTogZnVuY3Rpb24gcGF0aG5hbWUoKSB7CiAgICAgIHJldHVybiB0aGlzLnBhdGguc3BsaXQoJz8nLCAxKVswXTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEByZXR1cm4gW1N0cmluZ10gdGhlIHF1ZXJ5IHN0cmluZyBwb3J0aW9uIG9mIHRoZSB7cGF0aH0KICAgICAqLwogICAgc2VhcmNoOiBmdW5jdGlvbiBzZWFyY2goKSB7CiAgICAgIHZhciBxdWVyeSA9IHRoaXMucGF0aC5zcGxpdCgnPycsIDIpWzFdOwogICAgICBpZiAocXVlcnkpIHsKICAgICAgICBxdWVyeSA9IEFXUy51dGlsLnF1ZXJ5U3RyaW5nUGFyc2UocXVlcnkpOwogICAgICAgIHJldHVybiBBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHF1ZXJ5KTsKICAgICAgfQogICAgICByZXR1cm4gJyc7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqIHVwZGF0ZSBodHRwUmVxdWVzdCBlbmRwb2ludCB3aXRoIGVuZHBvaW50IHN0cmluZwogICAgICovCiAgICB1cGRhdGVFbmRwb2ludDogZnVuY3Rpb24gdXBkYXRlRW5kcG9pbnQoZW5kcG9pbnRTdHIpIHsKICAgICAgdmFyIG5ld0VuZHBvaW50ID0gbmV3IEFXUy5FbmRwb2ludChlbmRwb2ludFN0cik7CiAgICAgIHRoaXMuZW5kcG9pbnQgPSBuZXdFbmRwb2ludDsKICAgICAgdGhpcy5wYXRoID0gbmV3RW5kcG9pbnQucGF0aCB8fCAnLyc7CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICogVGhlIGxvdyBsZXZlbCBIVFRQIHJlc3BvbnNlIG9iamVjdCwgZW5jYXBzdWxhdGluZyBhbGwgSFRUUCBoZWFkZXIKICAgKiBhbmQgYm9keSBkYXRhIHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzdGF0dXNDb2RlCiAgICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgSFRUUCBzdGF0dXMgY29kZSBvZiB0aGUgcmVzcG9uc2UgKGUuZy4sIDIwMCwgNDA0KQogICAqIEAhYXR0cmlidXRlIGhlYWRlcnMKICAgKiAgIEByZXR1cm4gW21hcDxTdHJpbmcsU3RyaW5nPl0KICAgKiAgICAgIGEgbWFwIG9mIHJlc3BvbnNlIGhlYWRlciBrZXlzIGFuZCB0aGVpciByZXNwZWN0aXZlIHZhbHVlcwogICAqIEAhYXR0cmlidXRlIGJvZHkKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIHJlc3BvbnNlIGJvZHkgcGF5bG9hZAogICAqIEAhYXR0cmlidXRlIFtyXSBzdHJlYW1pbmcKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhpcyByZXNwb25zZSBpcyBiZWluZyBzdHJlYW1lZCBhdCBhIGxvdy1sZXZlbC4KICAgKiAgICAgRGVmYXVsdHMgdG8gYGZhbHNlYCAoYnVmZmVyZWQgcmVhZHMpLiBEbyBub3QgbW9kaWZ5IHRoaXMgbWFudWFsbHksIHVzZQogICAqICAgICB7Y3JlYXRlVW5idWZmZXJlZFN0cmVhbX0gdG8gY29udmVydCB0aGUgc3RyZWFtIHRvIHVuYnVmZmVyZWQgbW9kZQogICAqICAgICBpbnN0ZWFkLgogICAqLwogIEFXUy5IdHRwUmVzcG9uc2UgPSBpbmhlcml0KHsKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBIdHRwUmVzcG9uc2UoKSB7CiAgICAgIHRoaXMuc3RhdHVzQ29kZSA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5oZWFkZXJzID0ge307CiAgICAgIHRoaXMuYm9keSA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5zdHJlYW1pbmcgPSBmYWxzZTsKICAgICAgdGhpcy5zdHJlYW0gPSBudWxsOwogICAgfSwKICAKICAgIC8qKgogICAgICogRGlzYWJsZXMgYnVmZmVyaW5nIG9uIHRoZSBIVFRQIHJlc3BvbnNlIGFuZCByZXR1cm5zIHRoZSBzdHJlYW0gZm9yIHJlYWRpbmcuCiAgICAgKiBAcmV0dXJuIFtTdHJlYW0sIFhNTEh0dHBSZXF1ZXN0LCBudWxsXSB0aGUgdW5kZXJseWluZyBzdHJlYW0gb2JqZWN0LgogICAgICogICBVc2UgdGhpcyBvYmplY3QgdG8gZGlyZWN0bHkgcmVhZCBkYXRhIG9mZiBvZiB0aGUgc3RyZWFtLgogICAgICogQG5vdGUgVGhpcyBvYmplY3QgaXMgb25seSBhdmFpbGFibGUgYWZ0ZXIgdGhlIHtBV1MuUmVxdWVzdH5odHRwSGVhZGVyc30KICAgICAqICAgZXZlbnQgaGFzIGZpcmVkLiBUaGlzIG1ldGhvZCBtdXN0IGJlIGNhbGxlZCBwcmlvciB0bwogICAgICogICB7QVdTLlJlcXVlc3R+aHR0cERhdGF9LgogICAgICogQGV4YW1wbGUgVGFraW5nIGNvbnRyb2wgb2YgYSBzdHJlYW0KICAgICAqICAgcmVxdWVzdC5vbignaHR0cEhlYWRlcnMnLCBmdW5jdGlvbihzdGF0dXNDb2RlLCBoZWFkZXJzKSB7CiAgICAgKiAgICAgaWYgKHN0YXR1c0NvZGUgPCAzMDApIHsKICAgICAqICAgICAgIGlmIChoZWFkZXJzLmV0YWcgPT09ICd4eXonKSB7CiAgICAgKiAgICAgICAgIC8vIHBpcGUgdGhlIHN0cmVhbSwgZGlzYWJsaW5nIGJ1ZmZlcmluZwogICAgICogICAgICAgICB2YXIgc3RyZWFtID0gdGhpcy5yZXNwb25zZS5odHRwUmVzcG9uc2UuY3JlYXRlVW5idWZmZXJlZFN0cmVhbSgpOwogICAgICogICAgICAgICBzdHJlYW0ucGlwZShwcm9jZXNzLnN0ZG91dCk7CiAgICAgKiAgICAgICB9IGVsc2UgeyAvLyBhYm9ydCB0aGlzIHJlcXVlc3QgYW5kIHNldCBhIGJldHRlciBlcnJvciBtZXNzYWdlCiAgICAgKiAgICAgICAgIHRoaXMuYWJvcnQoKTsKICAgICAqICAgICAgICAgdGhpcy5yZXNwb25zZS5lcnJvciA9IG5ldyBFcnJvcignSW52YWxpZCBFVGFnJyk7CiAgICAgKiAgICAgICB9CiAgICAgKiAgICAgfQogICAgICogICB9KS5zZW5kKGNvbnNvbGUubG9nKTsKICAgICAqLwogICAgY3JlYXRlVW5idWZmZXJlZFN0cmVhbTogZnVuY3Rpb24gY3JlYXRlVW5idWZmZXJlZFN0cmVhbSgpIHsKICAgICAgdGhpcy5zdHJlYW1pbmcgPSB0cnVlOwogICAgICByZXR1cm4gdGhpcy5zdHJlYW07CiAgICB9CiAgfSk7CiAgCiAgCiAgQVdTLkh0dHBDbGllbnQgPSBpbmhlcml0KHt9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuSHR0cENsaWVudC5nZXRJbnN0YW5jZSA9IGZ1bmN0aW9uIGdldEluc3RhbmNlKCkgewogICAgaWYgKHRoaXMuc2luZ2xldG9uID09PSB1bmRlZmluZWQpIHsKICAgICAgdGhpcy5zaW5nbGV0b24gPSBuZXcgdGhpcygpOwogICAgfQogICAgcmV0dXJuIHRoaXMuc2luZ2xldG9uOwogIH07CiAgCiAgfSx7Ii4vY29yZSI6MTh9XSwzNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykuRXZlbnRFbWl0dGVyOwogIHJlcXVpcmUoJy4uL2h0dHAnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuWEhSQ2xpZW50ID0gQVdTLnV0aWwuaW5oZXJpdCh7CiAgICBoYW5kbGVSZXF1ZXN0OiBmdW5jdGlvbiBoYW5kbGVSZXF1ZXN0KGh0dHBSZXF1ZXN0LCBodHRwT3B0aW9ucywgY2FsbGJhY2ssIGVyckNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGVuZHBvaW50ID0gaHR0cFJlcXVlc3QuZW5kcG9pbnQ7CiAgICAgIHZhciBlbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcigpOwogICAgICB2YXIgaHJlZiA9IGVuZHBvaW50LnByb3RvY29sICsgJy8vJyArIGVuZHBvaW50Lmhvc3RuYW1lOwogICAgICBpZiAoZW5kcG9pbnQucG9ydCAhPT0gODAgJiYgZW5kcG9pbnQucG9ydCAhPT0gNDQzKSB7CiAgICAgICAgaHJlZiArPSAnOicgKyBlbmRwb2ludC5wb3J0OwogICAgICB9CiAgICAgIGhyZWYgKz0gaHR0cFJlcXVlc3QucGF0aDsKICAKICAgICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpLCBoZWFkZXJzRW1pdHRlZCA9IGZhbHNlOwogICAgICBodHRwUmVxdWVzdC5zdHJlYW0gPSB4aHI7CiAgCiAgICAgIHhoci5hZGRFdmVudExpc3RlbmVyKCdyZWFkeXN0YXRlY2hhbmdlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGlmICh4aHIuc3RhdHVzID09PSAwKSByZXR1cm47IC8vIDAgY29kZSBpcyBpbnZhbGlkCiAgICAgICAgfSBjYXRjaCAoZSkgeyByZXR1cm47IH0KICAKICAgICAgICBpZiAodGhpcy5yZWFkeVN0YXRlID49IHRoaXMuSEVBREVSU19SRUNFSVZFRCAmJiAhaGVhZGVyc0VtaXR0ZWQpIHsKICAgICAgICAgIGVtaXR0ZXIuc3RhdHVzQ29kZSA9IHhoci5zdGF0dXM7CiAgICAgICAgICBlbWl0dGVyLmhlYWRlcnMgPSBzZWxmLnBhcnNlSGVhZGVycyh4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkpOwogICAgICAgICAgZW1pdHRlci5lbWl0KAogICAgICAgICAgICAnaGVhZGVycycsCiAgICAgICAgICAgIGVtaXR0ZXIuc3RhdHVzQ29kZSwKICAgICAgICAgICAgZW1pdHRlci5oZWFkZXJzLAogICAgICAgICAgICB4aHIuc3RhdHVzVGV4dAogICAgICAgICAgKTsKICAgICAgICAgIGhlYWRlcnNFbWl0dGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA9PT0gdGhpcy5ET05FKSB7CiAgICAgICAgICBzZWxmLmZpbmlzaFJlcXVlc3QoeGhyLCBlbWl0dGVyKTsKICAgICAgICB9CiAgICAgIH0sIGZhbHNlKTsKICAgICAgeGhyLnVwbG9hZC5hZGRFdmVudExpc3RlbmVyKCdwcm9ncmVzcycsIGZ1bmN0aW9uIChldnQpIHsKICAgICAgICBlbWl0dGVyLmVtaXQoJ3NlbmRQcm9ncmVzcycsIGV2dCk7CiAgICAgIH0pOwogICAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcigncHJvZ3Jlc3MnLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgZW1pdHRlci5lbWl0KCdyZWNlaXZlUHJvZ3Jlc3MnLCBldnQpOwogICAgICB9LCBmYWxzZSk7CiAgICAgIHhoci5hZGRFdmVudExpc3RlbmVyKCd0aW1lb3V0JywgZnVuY3Rpb24gKCkgewogICAgICAgIGVyckNhbGxiYWNrKEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcignVGltZW91dCcpLCB7Y29kZTogJ1RpbWVvdXRFcnJvcid9KSk7CiAgICAgIH0sIGZhbHNlKTsKICAgICAgeGhyLmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgZnVuY3Rpb24gKCkgewogICAgICAgIGVyckNhbGxiYWNrKEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcignTmV0d29yayBGYWlsdXJlJyksIHsKICAgICAgICAgIGNvZGU6ICdOZXR3b3JraW5nRXJyb3InCiAgICAgICAgfSkpOwogICAgICB9LCBmYWxzZSk7CiAgICAgIHhoci5hZGRFdmVudExpc3RlbmVyKCdhYm9ydCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICBlcnJDYWxsYmFjayhBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ1JlcXVlc3QgYWJvcnRlZCcpLCB7CiAgICAgICAgICBjb2RlOiAnUmVxdWVzdEFib3J0ZWRFcnJvcicKICAgICAgICB9KSk7CiAgICAgIH0sIGZhbHNlKTsKICAKICAgICAgY2FsbGJhY2soZW1pdHRlcik7CiAgICAgIHhoci5vcGVuKGh0dHBSZXF1ZXN0Lm1ldGhvZCwgaHJlZiwgaHR0cE9wdGlvbnMueGhyQXN5bmMgIT09IGZhbHNlKTsKICAgICAgQVdTLnV0aWwuZWFjaChodHRwUmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgIGlmIChrZXkgIT09ICdDb250ZW50LUxlbmd0aCcgJiYga2V5ICE9PSAnVXNlci1BZ2VudCcgJiYga2V5ICE9PSAnSG9zdCcpIHsKICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGlmIChodHRwT3B0aW9ucy50aW1lb3V0ICYmIGh0dHBPcHRpb25zLnhockFzeW5jICE9PSBmYWxzZSkgewogICAgICAgIHhoci50aW1lb3V0ID0gaHR0cE9wdGlvbnMudGltZW91dDsKICAgICAgfQogIAogICAgICBpZiAoaHR0cE9wdGlvbnMueGhyV2l0aENyZWRlbnRpYWxzKSB7CiAgICAgICAgeGhyLndpdGhDcmVkZW50aWFscyA9IHRydWU7CiAgICAgIH0KICAgICAgdHJ5IHsgeGhyLnJlc3BvbnNlVHlwZSA9ICdhcnJheWJ1ZmZlcic7IH0gY2F0Y2ggKGUpIHt9CiAgCiAgICAgIHRyeSB7CiAgICAgICAgaWYgKGh0dHBSZXF1ZXN0LmJvZHkpIHsKICAgICAgICAgIHhoci5zZW5kKGh0dHBSZXF1ZXN0LmJvZHkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB4aHIuc2VuZCgpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgaWYgKGh0dHBSZXF1ZXN0LmJvZHkgJiYgdHlwZW9mIGh0dHBSZXF1ZXN0LmJvZHkuYnVmZmVyID09PSAnb2JqZWN0JykgewogICAgICAgICAgeGhyLnNlbmQoaHR0cFJlcXVlc3QuYm9keS5idWZmZXIpOyAvLyBzZW5kIEFycmF5QnVmZmVyIGRpcmVjdGx5CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IGVycjsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgcmV0dXJuIGVtaXR0ZXI7CiAgICB9LAogIAogICAgcGFyc2VIZWFkZXJzOiBmdW5jdGlvbiBwYXJzZUhlYWRlcnMocmF3SGVhZGVycykgewogICAgICB2YXIgaGVhZGVycyA9IHt9OwogICAgICBBV1MudXRpbC5hcnJheUVhY2gocmF3SGVhZGVycy5zcGxpdCgvXHI/XG4vKSwgZnVuY3Rpb24gKGxpbmUpIHsKICAgICAgICB2YXIga2V5ID0gbGluZS5zcGxpdCgnOicsIDEpWzBdOwogICAgICAgIHZhciB2YWx1ZSA9IGxpbmUuc3Vic3RyaW5nKGtleS5sZW5ndGggKyAyKTsKICAgICAgICBpZiAoa2V5Lmxlbmd0aCA+IDApIGhlYWRlcnNba2V5LnRvTG93ZXJDYXNlKCldID0gdmFsdWU7CiAgICAgIH0pOwogICAgICByZXR1cm4gaGVhZGVyczsKICAgIH0sCiAgCiAgICBmaW5pc2hSZXF1ZXN0OiBmdW5jdGlvbiBmaW5pc2hSZXF1ZXN0KHhociwgZW1pdHRlcikgewogICAgICB2YXIgYnVmZmVyOwogICAgICBpZiAoeGhyLnJlc3BvbnNlVHlwZSA9PT0gJ2FycmF5YnVmZmVyJyAmJiB4aHIucmVzcG9uc2UpIHsKICAgICAgICB2YXIgYWIgPSB4aHIucmVzcG9uc2U7CiAgICAgICAgYnVmZmVyID0gbmV3IEFXUy51dGlsLkJ1ZmZlcihhYi5ieXRlTGVuZ3RoKTsKICAgICAgICB2YXIgdmlldyA9IG5ldyBVaW50OEFycmF5KGFiKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGJ1ZmZlci5sZW5ndGg7ICsraSkgewogICAgICAgICAgYnVmZmVyW2ldID0gdmlld1tpXTsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgdHJ5IHsKICAgICAgICBpZiAoIWJ1ZmZlciAmJiB0eXBlb2YgeGhyLnJlc3BvbnNlVGV4dCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGJ1ZmZlciA9IG5ldyBBV1MudXRpbC5CdWZmZXIoeGhyLnJlc3BvbnNlVGV4dCk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7fQogIAogICAgICBpZiAoYnVmZmVyKSBlbWl0dGVyLmVtaXQoJ2RhdGEnLCBidWZmZXIpOwogICAgICBlbWl0dGVyLmVtaXQoJ2VuZCcpOwogICAgfQogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5IdHRwQ2xpZW50LnByb3RvdHlwZSA9IEFXUy5YSFJDbGllbnQucHJvdG90eXBlOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID0gMTsKICAKICB9LHsiLi4vY29yZSI6MTgsIi4uL2h0dHAiOjM0LCJldmVudHMiOjgyfV0sMzY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIAogIGZ1bmN0aW9uIEpzb25CdWlsZGVyKCkgeyB9CiAgCiAgSnNvbkJ1aWxkZXIucHJvdG90eXBlLmJ1aWxkID0gZnVuY3Rpb24odmFsdWUsIHNoYXBlKSB7CiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodHJhbnNsYXRlKHZhbHVlLCBzaGFwZSkpOwogIH07CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZSkgewogICAgaWYgKCFzaGFwZSB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogIAogICAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICAgIGNhc2UgJ3N0cnVjdHVyZSc6IHJldHVybiB0cmFuc2xhdGVTdHJ1Y3R1cmUodmFsdWUsIHNoYXBlKTsKICAgICAgY2FzZSAnbWFwJzogcmV0dXJuIHRyYW5zbGF0ZU1hcCh2YWx1ZSwgc2hhcGUpOwogICAgICBjYXNlICdsaXN0JzogcmV0dXJuIHRyYW5zbGF0ZUxpc3QodmFsdWUsIHNoYXBlKTsKICAgICAgZGVmYXVsdDogcmV0dXJuIHRyYW5zbGF0ZVNjYWxhcih2YWx1ZSwgc2hhcGUpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiB0cmFuc2xhdGVTdHJ1Y3R1cmUoc3RydWN0dXJlLCBzaGFwZSkgewogICAgdmFyIHN0cnVjdCA9IHt9OwogICAgdXRpbC5lYWNoKHN0cnVjdHVyZSwgZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgdmFyIG1lbWJlclNoYXBlID0gc2hhcGUubWVtYmVyc1tuYW1lXTsKICAgICAgaWYgKG1lbWJlclNoYXBlKSB7CiAgICAgICAgaWYgKG1lbWJlclNoYXBlLmxvY2F0aW9uICE9PSAnYm9keScpIHJldHVybjsKICAgICAgICB2YXIgbG9jYXRpb25OYW1lID0gbWVtYmVyU2hhcGUuaXNMb2NhdGlvbk5hbWUgPyBtZW1iZXJTaGFwZS5uYW1lIDogbmFtZTsKICAgICAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBtZW1iZXJTaGFwZSk7CiAgICAgICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSBzdHJ1Y3RbbG9jYXRpb25OYW1lXSA9IHJlc3VsdDsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gc3RydWN0OwogIH0KICAKICBmdW5jdGlvbiB0cmFuc2xhdGVMaXN0KGxpc3QsIHNoYXBlKSB7CiAgICB2YXIgb3V0ID0gW107CiAgICB1dGlsLmFycmF5RWFjaChsaXN0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZS5tZW1iZXIpOwogICAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIG91dC5wdXNoKHJlc3VsdCk7CiAgICB9KTsKICAgIHJldHVybiBvdXQ7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZU1hcChtYXAsIHNoYXBlKSB7CiAgICB2YXIgb3V0ID0ge307CiAgICB1dGlsLmVhY2gobWFwLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIHZhciByZXN1bHQgPSB0cmFuc2xhdGUodmFsdWUsIHNoYXBlLnZhbHVlKTsKICAgICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSBvdXRba2V5XSA9IHJlc3VsdDsKICAgIH0pOwogICAgcmV0dXJuIG91dDsKICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlU2NhbGFyKHZhbHVlLCBzaGFwZSkgewogICAgcmV0dXJuIHNoYXBlLnRvV2lyZUZvcm1hdCh2YWx1ZSk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gSnNvbkJ1aWxkZXI7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxfV0sMzc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIAogIGZ1bmN0aW9uIEpzb25QYXJzZXIoKSB7IH0KICAKICBKc29uUGFyc2VyLnByb3RvdHlwZS5wYXJzZSA9IGZ1bmN0aW9uKHZhbHVlLCBzaGFwZSkgewogICAgcmV0dXJuIHRyYW5zbGF0ZShKU09OLnBhcnNlKHZhbHVlKSwgc2hhcGUpOwogIH07CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZSkgewogICAgaWYgKCFzaGFwZSB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gdW5kZWZpbmVkOwogIAogICAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICAgIGNhc2UgJ3N0cnVjdHVyZSc6IHJldHVybiB0cmFuc2xhdGVTdHJ1Y3R1cmUodmFsdWUsIHNoYXBlKTsKICAgICAgY2FzZSAnbWFwJzogcmV0dXJuIHRyYW5zbGF0ZU1hcCh2YWx1ZSwgc2hhcGUpOwogICAgICBjYXNlICdsaXN0JzogcmV0dXJuIHRyYW5zbGF0ZUxpc3QodmFsdWUsIHNoYXBlKTsKICAgICAgZGVmYXVsdDogcmV0dXJuIHRyYW5zbGF0ZVNjYWxhcih2YWx1ZSwgc2hhcGUpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiB0cmFuc2xhdGVTdHJ1Y3R1cmUoc3RydWN0dXJlLCBzaGFwZSkgewogICAgaWYgKHN0cnVjdHVyZSA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogIAogICAgdmFyIHN0cnVjdCA9IHt9OwogICAgdmFyIHNoYXBlTWVtYmVycyA9IHNoYXBlLm1lbWJlcnM7CiAgICB1dGlsLmVhY2goc2hhcGVNZW1iZXJzLCBmdW5jdGlvbihuYW1lLCBtZW1iZXJTaGFwZSkgewogICAgICB2YXIgbG9jYXRpb25OYW1lID0gbWVtYmVyU2hhcGUuaXNMb2NhdGlvbk5hbWUgPyBtZW1iZXJTaGFwZS5uYW1lIDogbmFtZTsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzdHJ1Y3R1cmUsIGxvY2F0aW9uTmFtZSkpIHsKICAgICAgICB2YXIgdmFsdWUgPSBzdHJ1Y3R1cmVbbG9jYXRpb25OYW1lXTsKICAgICAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBtZW1iZXJTaGFwZSk7CiAgICAgICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSBzdHJ1Y3RbbmFtZV0gPSByZXN1bHQ7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHN0cnVjdDsKICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlTGlzdChsaXN0LCBzaGFwZSkgewogICAgaWYgKGxpc3QgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAKICAgIHZhciBvdXQgPSBbXTsKICAgIHV0aWwuYXJyYXlFYWNoKGxpc3QsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhciByZXN1bHQgPSB0cmFuc2xhdGUodmFsdWUsIHNoYXBlLm1lbWJlcik7CiAgICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkgb3V0LnB1c2gobnVsbCk7CiAgICAgIGVsc2Ugb3V0LnB1c2gocmVzdWx0KTsKICAgIH0pOwogICAgcmV0dXJuIG91dDsKICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlTWFwKG1hcCwgc2hhcGUpIHsKICAgIGlmIChtYXAgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAKICAgIHZhciBvdXQgPSB7fTsKICAgIHV0aWwuZWFjaChtYXAsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUudmFsdWUpOwogICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIG91dFtrZXldID0gbnVsbDsKICAgICAgZWxzZSBvdXRba2V5XSA9IHJlc3VsdDsKICAgIH0pOwogICAgcmV0dXJuIG91dDsKICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlU2NhbGFyKHZhbHVlLCBzaGFwZSkgewogICAgcmV0dXJuIHNoYXBlLnRvVHlwZSh2YWx1ZSk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gSnNvblBhcnNlcjsKICAKICB9LHsiLi4vdXRpbCI6NzF9XSwzODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIENvbGxlY3Rpb24gPSByZXF1aXJlKCcuL2NvbGxlY3Rpb24nKTsKICB2YXIgT3BlcmF0aW9uID0gcmVxdWlyZSgnLi9vcGVyYXRpb24nKTsKICB2YXIgU2hhcGUgPSByZXF1aXJlKCcuL3NoYXBlJyk7CiAgdmFyIFBhZ2luYXRvciA9IHJlcXVpcmUoJy4vcGFnaW5hdG9yJyk7CiAgdmFyIFJlc291cmNlV2FpdGVyID0gcmVxdWlyZSgnLi9yZXNvdXJjZV93YWl0ZXInKTsKICAKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgcHJvcGVydHkgPSB1dGlsLnByb3BlcnR5OwogIHZhciBtZW1vaXplZFByb3BlcnR5ID0gdXRpbC5tZW1vaXplZFByb3BlcnR5OwogIAogIGZ1bmN0aW9uIEFwaShhcGksIG9wdGlvbnMpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGFwaSA9IGFwaSB8fCB7fTsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgb3B0aW9ucy5hcGkgPSB0aGlzOwogIAogICAgYXBpLm1ldGFkYXRhID0gYXBpLm1ldGFkYXRhIHx8IHt9OwogIAogICAgcHJvcGVydHkodGhpcywgJ2lzQXBpJywgdHJ1ZSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2FwaVZlcnNpb24nLCBhcGkubWV0YWRhdGEuYXBpVmVyc2lvbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZW5kcG9pbnRQcmVmaXgnLCBhcGkubWV0YWRhdGEuZW5kcG9pbnRQcmVmaXgpOwogICAgcHJvcGVydHkodGhpcywgJ3NpZ25pbmdOYW1lJywgYXBpLm1ldGFkYXRhLnNpZ25pbmdOYW1lKTsKICAgIHByb3BlcnR5KHRoaXMsICdnbG9iYWxFbmRwb2ludCcsIGFwaS5tZXRhZGF0YS5nbG9iYWxFbmRwb2ludCk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnc2lnbmF0dXJlVmVyc2lvbicsIGFwaS5tZXRhZGF0YS5zaWduYXR1cmVWZXJzaW9uKTsKICAgIHByb3BlcnR5KHRoaXMsICdqc29uVmVyc2lvbicsIGFwaS5tZXRhZGF0YS5qc29uVmVyc2lvbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAndGFyZ2V0UHJlZml4JywgYXBpLm1ldGFkYXRhLnRhcmdldFByZWZpeCk7CiAgICBwcm9wZXJ0eSh0aGlzLCAncHJvdG9jb2wnLCBhcGkubWV0YWRhdGEucHJvdG9jb2wpOwogICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsIGFwaS5tZXRhZGF0YS50aW1lc3RhbXBGb3JtYXQpOwogICAgcHJvcGVydHkodGhpcywgJ3htbE5hbWVzcGFjZVVyaScsIGFwaS5tZXRhZGF0YS54bWxOYW1lc3BhY2UpOwogICAgcHJvcGVydHkodGhpcywgJ2FiYnJldmlhdGlvbicsIGFwaS5tZXRhZGF0YS5zZXJ2aWNlQWJicmV2aWF0aW9uKTsKICAgIHByb3BlcnR5KHRoaXMsICdmdWxsTmFtZScsIGFwaS5tZXRhZGF0YS5zZXJ2aWNlRnVsbE5hbWUpOwogICAgcHJvcGVydHkodGhpcywgJ3NlcnZpY2VJZCcsIGFwaS5tZXRhZGF0YS5zZXJ2aWNlSWQpOwogIAogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnY2xhc3NOYW1lJywgZnVuY3Rpb24oKSB7CiAgICAgIHZhciBuYW1lID0gYXBpLm1ldGFkYXRhLnNlcnZpY2VBYmJyZXZpYXRpb24gfHwgYXBpLm1ldGFkYXRhLnNlcnZpY2VGdWxsTmFtZTsKICAgICAgaWYgKCFuYW1lKSByZXR1cm4gbnVsbDsKICAKICAgICAgbmFtZSA9IG5hbWUucmVwbGFjZSgvXkFtYXpvbnxBV1Nccyp8XCguKnxccyt8XFcrL2csICcnKTsKICAgICAgaWYgKG5hbWUgPT09ICdFbGFzdGljTG9hZEJhbGFuY2luZycpIG5hbWUgPSAnRUxCJzsKICAgICAgcmV0dXJuIG5hbWU7CiAgICB9KTsKICAKICAgIGZ1bmN0aW9uIGFkZEVuZHBvaW50T3BlcmF0aW9uKG5hbWUsIG9wZXJhdGlvbikgewogICAgICBpZiAob3BlcmF0aW9uLmVuZHBvaW50b3BlcmF0aW9uID09PSB0cnVlKSB7CiAgICAgICAgcHJvcGVydHkoc2VsZiwgJ2VuZHBvaW50T3BlcmF0aW9uJywgdXRpbC5zdHJpbmcubG93ZXJGaXJzdChuYW1lKSk7CiAgICAgIH0KICAgIH0KICAKICAgIHByb3BlcnR5KHRoaXMsICdvcGVyYXRpb25zJywgbmV3IENvbGxlY3Rpb24oYXBpLm9wZXJhdGlvbnMsIG9wdGlvbnMsIGZ1bmN0aW9uKG5hbWUsIG9wZXJhdGlvbikgewogICAgICByZXR1cm4gbmV3IE9wZXJhdGlvbihuYW1lLCBvcGVyYXRpb24sIG9wdGlvbnMpOwogICAgfSwgdXRpbC5zdHJpbmcubG93ZXJGaXJzdCwgYWRkRW5kcG9pbnRPcGVyYXRpb24pKTsKICAKICAgIHByb3BlcnR5KHRoaXMsICdzaGFwZXMnLCBuZXcgQ29sbGVjdGlvbihhcGkuc2hhcGVzLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCBzaGFwZSkgewogICAgICByZXR1cm4gU2hhcGUuY3JlYXRlKHNoYXBlLCBvcHRpb25zKTsKICAgIH0pKTsKICAKICAgIHByb3BlcnR5KHRoaXMsICdwYWdpbmF0b3JzJywgbmV3IENvbGxlY3Rpb24oYXBpLnBhZ2luYXRvcnMsIG9wdGlvbnMsIGZ1bmN0aW9uKG5hbWUsIHBhZ2luYXRvcikgewogICAgICByZXR1cm4gbmV3IFBhZ2luYXRvcihuYW1lLCBwYWdpbmF0b3IsIG9wdGlvbnMpOwogICAgfSkpOwogIAogICAgcHJvcGVydHkodGhpcywgJ3dhaXRlcnMnLCBuZXcgQ29sbGVjdGlvbihhcGkud2FpdGVycywgb3B0aW9ucywgZnVuY3Rpb24obmFtZSwgd2FpdGVyKSB7CiAgICAgIHJldHVybiBuZXcgUmVzb3VyY2VXYWl0ZXIobmFtZSwgd2FpdGVyLCBvcHRpb25zKTsKICAgIH0sIHV0aWwuc3RyaW5nLmxvd2VyRmlyc3QpKTsKICAKICAgIGlmIChvcHRpb25zLmRvY3VtZW50YXRpb24pIHsKICAgICAgcHJvcGVydHkodGhpcywgJ2RvY3VtZW50YXRpb24nLCBhcGkuZG9jdW1lbnRhdGlvbik7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uVXJsJywgYXBpLmRvY3VtZW50YXRpb25VcmwpOwogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFwaTsKICAKICB9LHsiLi4vdXRpbCI6NzEsIi4vY29sbGVjdGlvbiI6MzksIi4vb3BlcmF0aW9uIjo0MCwiLi9wYWdpbmF0b3IiOjQxLCIuL3Jlc291cmNlX3dhaXRlciI6NDIsIi4vc2hhcGUiOjQzfV0sMzk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBtZW1vaXplZFByb3BlcnR5ID0gcmVxdWlyZSgnLi4vdXRpbCcpLm1lbW9pemVkUHJvcGVydHk7CiAgCiAgZnVuY3Rpb24gbWVtb2l6ZShuYW1lLCB2YWx1ZSwgZmFjdG9yeSwgbmFtZVRyKSB7CiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsIG5hbWVUcihuYW1lKSwgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBmYWN0b3J5KG5hbWUsIHZhbHVlKTsKICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBDb2xsZWN0aW9uKGl0ZXJhYmxlLCBvcHRpb25zLCBmYWN0b3J5LCBuYW1lVHIsIGNhbGxiYWNrKSB7CiAgICBuYW1lVHIgPSBuYW1lVHIgfHwgU3RyaW5nOwogICAgdmFyIHNlbGYgPSB0aGlzOwogIAogICAgZm9yICh2YXIgaWQgaW4gaXRlcmFibGUpIHsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChpdGVyYWJsZSwgaWQpKSB7CiAgICAgICAgbWVtb2l6ZS5jYWxsKHNlbGYsIGlkLCBpdGVyYWJsZVtpZF0sIGZhY3RvcnksIG5hbWVUcik7CiAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayhpZCwgaXRlcmFibGVbaWRdKTsKICAgICAgfQogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IENvbGxlY3Rpb247CiAgCiAgfSx7Ii4uL3V0aWwiOjcxfV0sNDA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBTaGFwZSA9IHJlcXVpcmUoJy4vc2hhcGUnKTsKICAKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgcHJvcGVydHkgPSB1dGlsLnByb3BlcnR5OwogIHZhciBtZW1vaXplZFByb3BlcnR5ID0gdXRpbC5tZW1vaXplZFByb3BlcnR5OwogIAogIGZ1bmN0aW9uIE9wZXJhdGlvbihuYW1lLCBvcGVyYXRpb24sIG9wdGlvbnMpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIAogICAgcHJvcGVydHkodGhpcywgJ25hbWUnLCBvcGVyYXRpb24ubmFtZSB8fCBuYW1lKTsKICAgIHByb3BlcnR5KHRoaXMsICdhcGknLCBvcHRpb25zLmFwaSwgZmFsc2UpOwogIAogICAgb3BlcmF0aW9uLmh0dHAgPSBvcGVyYXRpb24uaHR0cCB8fCB7fTsKICAgIHByb3BlcnR5KHRoaXMsICdlbmRwb2ludCcsIG9wZXJhdGlvbi5lbmRwb2ludCk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaHR0cE1ldGhvZCcsIG9wZXJhdGlvbi5odHRwLm1ldGhvZCB8fCAnUE9TVCcpOwogICAgcHJvcGVydHkodGhpcywgJ2h0dHBQYXRoJywgb3BlcmF0aW9uLmh0dHAucmVxdWVzdFVyaSB8fCAnLycpOwogICAgcHJvcGVydHkodGhpcywgJ2F1dGh0eXBlJywgb3BlcmF0aW9uLmF1dGh0eXBlIHx8ICcnKTsKICAgIHByb3BlcnR5KAogICAgICB0aGlzLAogICAgICAnZW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCcsCiAgICAgIG9wZXJhdGlvbi5lbmRwb2ludGRpc2NvdmVyeSA/CiAgICAgICAgKG9wZXJhdGlvbi5lbmRwb2ludGRpc2NvdmVyeS5yZXF1aXJlZCA/ICdSRVFVSVJFRCcgOiAnT1BUSU9OQUwnKSA6CiAgICAgICdOVUxMJwogICAgKTsKICAKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2lucHV0JywgZnVuY3Rpb24oKSB7CiAgICAgIGlmICghb3BlcmF0aW9uLmlucHV0KSB7CiAgICAgICAgcmV0dXJuIG5ldyBTaGFwZS5jcmVhdGUoe3R5cGU6ICdzdHJ1Y3R1cmUnfSwgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShvcGVyYXRpb24uaW5wdXQsIG9wdGlvbnMpOwogICAgfSk7CiAgCiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdvdXRwdXQnLCBmdW5jdGlvbigpIHsKICAgICAgaWYgKCFvcGVyYXRpb24ub3V0cHV0KSB7CiAgICAgICAgcmV0dXJuIG5ldyBTaGFwZS5jcmVhdGUoe3R5cGU6ICdzdHJ1Y3R1cmUnfSwgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShvcGVyYXRpb24ub3V0cHV0LCBvcHRpb25zKTsKICAgIH0pOwogIAogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnZXJyb3JzJywgZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsaXN0ID0gW107CiAgICAgIGlmICghb3BlcmF0aW9uLmVycm9ycykgcmV0dXJuIG51bGw7CiAgCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb3BlcmF0aW9uLmVycm9ycy5sZW5ndGg7IGkrKykgewogICAgICAgIGxpc3QucHVzaChTaGFwZS5jcmVhdGUob3BlcmF0aW9uLmVycm9yc1tpXSwgb3B0aW9ucykpOwogICAgICB9CiAgCiAgICAgIHJldHVybiBsaXN0OwogICAgfSk7CiAgCiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdwYWdpbmF0b3InLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG9wdGlvbnMuYXBpLnBhZ2luYXRvcnNbbmFtZV07CiAgICB9KTsKICAKICAgIGlmIChvcHRpb25zLmRvY3VtZW50YXRpb24pIHsKICAgICAgcHJvcGVydHkodGhpcywgJ2RvY3VtZW50YXRpb24nLCBvcGVyYXRpb24uZG9jdW1lbnRhdGlvbik7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uVXJsJywgb3BlcmF0aW9uLmRvY3VtZW50YXRpb25VcmwpOwogICAgfQogIAogICAgLy8gaWRlbXBvdGVudE1lbWJlcnMgb25seSB0cmFja3MgdG9wLWxldmVsIGlucHV0IHNoYXBlcwogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnaWRlbXBvdGVudE1lbWJlcnMnLCBmdW5jdGlvbigpIHsKICAgICAgdmFyIGlkZW1wb3RlbnRNZW1iZXJzID0gW107CiAgICAgIHZhciBpbnB1dCA9IHNlbGYuaW5wdXQ7CiAgICAgIHZhciBtZW1iZXJzID0gaW5wdXQubWVtYmVyczsKICAgICAgaWYgKCFpbnB1dC5tZW1iZXJzKSB7CiAgICAgICAgcmV0dXJuIGlkZW1wb3RlbnRNZW1iZXJzOwogICAgICB9CiAgICAgIGZvciAodmFyIG5hbWUgaW4gbWVtYmVycykgewogICAgICAgIGlmICghbWVtYmVycy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGlmIChtZW1iZXJzW25hbWVdLmlzSWRlbXBvdGVudCA9PT0gdHJ1ZSkgewogICAgICAgICAgaWRlbXBvdGVudE1lbWJlcnMucHVzaChuYW1lKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGlkZW1wb3RlbnRNZW1iZXJzOwogICAgfSk7CiAgCiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdoYXNFdmVudE91dHB1dCcsIGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3V0cHV0ID0gc2VsZi5vdXRwdXQ7CiAgICAgIHJldHVybiBoYXNFdmVudFN0cmVhbShvdXRwdXQpOwogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIGhhc0V2ZW50U3RyZWFtKHRvcExldmVsU2hhcGUpIHsKICAgIHZhciBtZW1iZXJzID0gdG9wTGV2ZWxTaGFwZS5tZW1iZXJzOwogICAgdmFyIHBheWxvYWQgPSB0b3BMZXZlbFNoYXBlLnBheWxvYWQ7CiAgCiAgICBpZiAoIXRvcExldmVsU2hhcGUubWVtYmVycykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgCiAgICBpZiAocGF5bG9hZCkgewogICAgICB2YXIgcGF5bG9hZE1lbWJlciA9IG1lbWJlcnNbcGF5bG9hZF07CiAgICAgIHJldHVybiBwYXlsb2FkTWVtYmVyLmlzRXZlbnRTdHJlYW07CiAgICB9CiAgCiAgICAvLyBjaGVjayBpZiBhbnkgbWVtYmVyIGlzIGFuIGV2ZW50IHN0cmVhbQogICAgZm9yICh2YXIgbmFtZSBpbiBtZW1iZXJzKSB7CiAgICAgIGlmICghbWVtYmVycy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgIGlmIChtZW1iZXJzW25hbWVdLmlzRXZlbnRTdHJlYW0gPT09IHRydWUpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IE9wZXJhdGlvbjsKICAKICB9LHsiLi4vdXRpbCI6NzEsIi4vc2hhcGUiOjQzfV0sNDE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBwcm9wZXJ0eSA9IHJlcXVpcmUoJy4uL3V0aWwnKS5wcm9wZXJ0eTsKICAKICBmdW5jdGlvbiBQYWdpbmF0b3IobmFtZSwgcGFnaW5hdG9yKSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaW5wdXRUb2tlbicsIHBhZ2luYXRvci5pbnB1dF90b2tlbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnbGltaXRLZXknLCBwYWdpbmF0b3IubGltaXRfa2V5KTsKICAgIHByb3BlcnR5KHRoaXMsICdtb3JlUmVzdWx0cycsIHBhZ2luYXRvci5tb3JlX3Jlc3VsdHMpOwogICAgcHJvcGVydHkodGhpcywgJ291dHB1dFRva2VuJywgcGFnaW5hdG9yLm91dHB1dF90b2tlbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAncmVzdWx0S2V5JywgcGFnaW5hdG9yLnJlc3VsdF9rZXkpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IFBhZ2luYXRvcjsKICAKICB9LHsiLi4vdXRpbCI6NzF9XSw0MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIHByb3BlcnR5ID0gdXRpbC5wcm9wZXJ0eTsKICAKICBmdW5jdGlvbiBSZXNvdXJjZVdhaXRlcihuYW1lLCB3YWl0ZXIsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgcHJvcGVydHkodGhpcywgJ25hbWUnLCBuYW1lKTsKICAgIHByb3BlcnR5KHRoaXMsICdhcGknLCBvcHRpb25zLmFwaSwgZmFsc2UpOwogIAogICAgaWYgKHdhaXRlci5vcGVyYXRpb24pIHsKICAgICAgcHJvcGVydHkodGhpcywgJ29wZXJhdGlvbicsIHV0aWwuc3RyaW5nLmxvd2VyRmlyc3Qod2FpdGVyLm9wZXJhdGlvbikpOwogICAgfQogIAogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGtleXMgPSBbCiAgICAgICd0eXBlJywKICAgICAgJ2Rlc2NyaXB0aW9uJywKICAgICAgJ2RlbGF5JywKICAgICAgJ21heEF0dGVtcHRzJywKICAgICAgJ2FjY2VwdG9ycycKICAgIF07CiAgCiAgICBrZXlzLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgIHZhciB2YWx1ZSA9IHdhaXRlcltrZXldOwogICAgICBpZiAodmFsdWUpIHsKICAgICAgICBwcm9wZXJ0eShzZWxmLCBrZXksIHZhbHVlKTsKICAgICAgfQogICAgfSk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gUmVzb3VyY2VXYWl0ZXI7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxfV0sNDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBDb2xsZWN0aW9uID0gcmVxdWlyZSgnLi9jb2xsZWN0aW9uJyk7CiAgCiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgCiAgZnVuY3Rpb24gcHJvcGVydHkob2JqLCBuYW1lLCB2YWx1ZSkgewogICAgaWYgKHZhbHVlICE9PSBudWxsICYmIHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgdXRpbC5wcm9wZXJ0eS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBtZW1vaXplZFByb3BlcnR5KG9iaiwgbmFtZSkgewogICAgaWYgKCFvYmouY29uc3RydWN0b3IucHJvdG90eXBlW25hbWVdKSB7CiAgICAgIHV0aWwubWVtb2l6ZWRQcm9wZXJ0eS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBTaGFwZShzaGFwZSwgb3B0aW9ucywgbWVtYmVyTmFtZSkgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAnc2hhcGUnLCBzaGFwZS5zaGFwZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnYXBpJywgb3B0aW9ucy5hcGksIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICd0eXBlJywgc2hhcGUudHlwZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZW51bScsIHNoYXBlLmVudW0pOwogICAgcHJvcGVydHkodGhpcywgJ21pbicsIHNoYXBlLm1pbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnbWF4Jywgc2hhcGUubWF4KTsKICAgIHByb3BlcnR5KHRoaXMsICdwYXR0ZXJuJywgc2hhcGUucGF0dGVybik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnbG9jYXRpb24nLCBzaGFwZS5sb2NhdGlvbiB8fCB0aGlzLmxvY2F0aW9uIHx8ICdib2R5Jyk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnbmFtZScsIHRoaXMubmFtZSB8fCBzaGFwZS54bWxOYW1lIHx8IHNoYXBlLnF1ZXJ5TmFtZSB8fAogICAgICBzaGFwZS5sb2NhdGlvbk5hbWUgfHwgbWVtYmVyTmFtZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNTdHJlYW1pbmcnLCBzaGFwZS5zdHJlYW1pbmcgfHwgdGhpcy5pc1N0cmVhbWluZyB8fCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAncmVxdWlyZXNMZW5ndGgnLCBzaGFwZS5yZXF1aXJlc0xlbmd0aCwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzQ29tcG9zaXRlJywgc2hhcGUuaXNDb21wb3NpdGUgfHwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzU2hhcGUnLCB0cnVlLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNRdWVyeU5hbWUnLCBCb29sZWFuKHNoYXBlLnF1ZXJ5TmFtZSksIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0xvY2F0aW9uTmFtZScsIEJvb2xlYW4oc2hhcGUubG9jYXRpb25OYW1lKSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzSWRlbXBvdGVudCcsIHNoYXBlLmlkZW1wb3RlbmN5VG9rZW4gPT09IHRydWUpOwogICAgcHJvcGVydHkodGhpcywgJ2lzSnNvblZhbHVlJywgc2hhcGUuanNvbnZhbHVlID09PSB0cnVlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc1NlbnNpdGl2ZScsIHNoYXBlLnNlbnNpdGl2ZSA9PT0gdHJ1ZSB8fCBzaGFwZS5wcm90b3R5cGUgJiYgc2hhcGUucHJvdG90eXBlLnNlbnNpdGl2ZSA9PT0gdHJ1ZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNFdmVudFN0cmVhbScsIEJvb2xlYW4oc2hhcGUuZXZlbnRzdHJlYW0pLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNFdmVudCcsIEJvb2xlYW4oc2hhcGUuZXZlbnQpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNFdmVudFBheWxvYWQnLCBCb29sZWFuKHNoYXBlLmV2ZW50cGF5bG9hZCksIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0V2ZW50SGVhZGVyJywgQm9vbGVhbihzaGFwZS5ldmVudGhlYWRlciksIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc1RpbWVzdGFtcEZvcm1hdFNldCcsIEJvb2xlYW4oc2hhcGUudGltZXN0YW1wRm9ybWF0KSB8fCBzaGFwZS5wcm90b3R5cGUgJiYgc2hhcGUucHJvdG90eXBlLmlzVGltZXN0YW1wRm9ybWF0U2V0ID09PSB0cnVlLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZW5kcG9pbnREaXNjb3ZlcnlJZCcsIEJvb2xlYW4oc2hhcGUuZW5kcG9pbnRkaXNjb3ZlcnlpZCksIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdob3N0TGFiZWwnLCBCb29sZWFuKHNoYXBlLmhvc3RMYWJlbCksIGZhbHNlKTsKICAKICAgIGlmIChvcHRpb25zLmRvY3VtZW50YXRpb24pIHsKICAgICAgcHJvcGVydHkodGhpcywgJ2RvY3VtZW50YXRpb24nLCBzaGFwZS5kb2N1bWVudGF0aW9uKTsKICAgICAgcHJvcGVydHkodGhpcywgJ2RvY3VtZW50YXRpb25VcmwnLCBzaGFwZS5kb2N1bWVudGF0aW9uVXJsKTsKICAgIH0KICAKICAgIGlmIChzaGFwZS54bWxBdHRyaWJ1dGUpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ2lzWG1sQXR0cmlidXRlJywgc2hhcGUueG1sQXR0cmlidXRlIHx8IGZhbHNlKTsKICAgIH0KICAKICAgIC8vIHR5cGUgY29udmVyc2lvbiBhbmQgcGFyc2luZwogICAgcHJvcGVydHkodGhpcywgJ2RlZmF1bHRWYWx1ZScsIG51bGwpOwogICAgdGhpcy50b1dpcmVGb3JtYXQgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuICcnOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9OwogICAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgeyByZXR1cm4gdmFsdWU7IH07CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIFNoYXBlLm5vcm1hbGl6ZWRUeXBlcyA9IHsKICAgIGNoYXJhY3RlcjogJ3N0cmluZycsCiAgICBkb3VibGU6ICdmbG9hdCcsCiAgICBsb25nOiAnaW50ZWdlcicsCiAgICBzaG9ydDogJ2ludGVnZXInLAogICAgYmlnaW50ZWdlcjogJ2ludGVnZXInLAogICAgYmlnZGVjaW1hbDogJ2Zsb2F0JywKICAgIGJsb2I6ICdiaW5hcnknCiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBTaGFwZS50eXBlcyA9IHsKICAgICdzdHJ1Y3R1cmUnOiBTdHJ1Y3R1cmVTaGFwZSwKICAgICdsaXN0JzogTGlzdFNoYXBlLAogICAgJ21hcCc6IE1hcFNoYXBlLAogICAgJ2Jvb2xlYW4nOiBCb29sZWFuU2hhcGUsCiAgICAndGltZXN0YW1wJzogVGltZXN0YW1wU2hhcGUsCiAgICAnZmxvYXQnOiBGbG9hdFNoYXBlLAogICAgJ2ludGVnZXInOiBJbnRlZ2VyU2hhcGUsCiAgICAnc3RyaW5nJzogU3RyaW5nU2hhcGUsCiAgICAnYmFzZTY0JzogQmFzZTY0U2hhcGUsCiAgICAnYmluYXJ5JzogQmluYXJ5U2hhcGUKICB9OwogIAogIFNoYXBlLnJlc29sdmUgPSBmdW5jdGlvbiByZXNvbHZlKHNoYXBlLCBvcHRpb25zKSB7CiAgICBpZiAoc2hhcGUuc2hhcGUpIHsKICAgICAgdmFyIHJlZlNoYXBlID0gb3B0aW9ucy5hcGkuc2hhcGVzW3NoYXBlLnNoYXBlXTsKICAgICAgaWYgKCFyZWZTaGFwZSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGZpbmQgc2hhcGUgcmVmZXJlbmNlOiAnICsgc2hhcGUuc2hhcGUpOwogICAgICB9CiAgCiAgICAgIHJldHVybiByZWZTaGFwZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogIH07CiAgCiAgU2hhcGUuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKHNoYXBlLCBvcHRpb25zLCBtZW1iZXJOYW1lKSB7CiAgICBpZiAoc2hhcGUuaXNTaGFwZSkgcmV0dXJuIHNoYXBlOwogIAogICAgdmFyIHJlZlNoYXBlID0gU2hhcGUucmVzb2x2ZShzaGFwZSwgb3B0aW9ucyk7CiAgICBpZiAocmVmU2hhcGUpIHsKICAgICAgdmFyIGZpbHRlcmVkS2V5cyA9IE9iamVjdC5rZXlzKHNoYXBlKTsKICAgICAgaWYgKCFvcHRpb25zLmRvY3VtZW50YXRpb24pIHsKICAgICAgICBmaWx0ZXJlZEtleXMgPSBmaWx0ZXJlZEtleXMuZmlsdGVyKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHJldHVybiAhbmFtZS5tYXRjaCgvZG9jdW1lbnRhdGlvbi8pOwogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIC8vIGNyZWF0ZSBhbiBpbmxpbmUgc2hhcGUgd2l0aCBleHRyYSBtZW1iZXJzCiAgICAgIHZhciBJbmxpbmVTaGFwZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJlZlNoYXBlLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgc2hhcGUsIG9wdGlvbnMsIG1lbWJlck5hbWUpOwogICAgICB9OwogICAgICBJbmxpbmVTaGFwZS5wcm90b3R5cGUgPSByZWZTaGFwZTsKICAgICAgcmV0dXJuIG5ldyBJbmxpbmVTaGFwZSgpOwogICAgfSBlbHNlIHsKICAgICAgLy8gc2V0IHR5cGUgaWYgbm90IHNldAogICAgICBpZiAoIXNoYXBlLnR5cGUpIHsKICAgICAgICBpZiAoc2hhcGUubWVtYmVycykgc2hhcGUudHlwZSA9ICdzdHJ1Y3R1cmUnOwogICAgICAgIGVsc2UgaWYgKHNoYXBlLm1lbWJlcikgc2hhcGUudHlwZSA9ICdsaXN0JzsKICAgICAgICBlbHNlIGlmIChzaGFwZS5rZXkpIHNoYXBlLnR5cGUgPSAnbWFwJzsKICAgICAgICBlbHNlIHNoYXBlLnR5cGUgPSAnc3RyaW5nJzsKICAgICAgfQogIAogICAgICAvLyBub3JtYWxpemUgdHlwZXMKICAgICAgdmFyIG9yaWdUeXBlID0gc2hhcGUudHlwZTsKICAgICAgaWYgKFNoYXBlLm5vcm1hbGl6ZWRUeXBlc1tzaGFwZS50eXBlXSkgewogICAgICAgIHNoYXBlLnR5cGUgPSBTaGFwZS5ub3JtYWxpemVkVHlwZXNbc2hhcGUudHlwZV07CiAgICAgIH0KICAKICAgICAgaWYgKFNoYXBlLnR5cGVzW3NoYXBlLnR5cGVdKSB7CiAgICAgICAgcmV0dXJuIG5ldyBTaGFwZS50eXBlc1tzaGFwZS50eXBlXShzaGFwZSwgb3B0aW9ucywgbWVtYmVyTmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnJlY29nbml6ZWQgc2hhcGUgdHlwZTogJyArIG9yaWdUeXBlKTsKICAgICAgfQogICAgfQogIH07CiAgCiAgZnVuY3Rpb24gQ29tcG9zaXRlU2hhcGUoc2hhcGUpIHsKICAgIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNDb21wb3NpdGUnLCB0cnVlKTsKICAKICAgIGlmIChzaGFwZS5mbGF0dGVuZWQpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ2ZsYXR0ZW5lZCcsIHNoYXBlLmZsYXR0ZW5lZCB8fCBmYWxzZSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIFN0cnVjdHVyZVNoYXBlKHNoYXBlLCBvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcmVxdWlyZWRNYXAgPSBudWxsLCBmaXJzdEluaXQgPSAhdGhpcy5pc1NoYXBlOwogIAogICAgQ29tcG9zaXRlU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAKICAgIGlmIChmaXJzdEluaXQpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ2RlZmF1bHRWYWx1ZScsIGZ1bmN0aW9uKCkgeyByZXR1cm4ge307IH0pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAnbWVtYmVycycsIHt9KTsKICAgICAgcHJvcGVydHkodGhpcywgJ21lbWJlck5hbWVzJywgW10pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAncmVxdWlyZWQnLCBbXSk7CiAgICAgIHByb3BlcnR5KHRoaXMsICdpc1JlcXVpcmVkJywgZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZTsgfSk7CiAgICB9CiAgCiAgICBpZiAoc2hhcGUubWVtYmVycykgewogICAgICBwcm9wZXJ0eSh0aGlzLCAnbWVtYmVycycsIG5ldyBDb2xsZWN0aW9uKHNoYXBlLm1lbWJlcnMsIG9wdGlvbnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlcikgewogICAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUobWVtYmVyLCBvcHRpb25zLCBuYW1lKTsKICAgICAgfSkpOwogICAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdtZW1iZXJOYW1lcycsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzaGFwZS54bWxPcmRlciB8fCBPYmplY3Qua2V5cyhzaGFwZS5tZW1iZXJzKTsKICAgICAgfSk7CiAgCiAgICAgIGlmIChzaGFwZS5ldmVudCkgewogICAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2V2ZW50UGF5bG9hZE1lbWJlck5hbWUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBtZW1iZXJzID0gc2VsZi5tZW1iZXJzOwogICAgICAgICAgdmFyIG1lbWJlck5hbWVzID0gc2VsZi5tZW1iZXJOYW1lczsKICAgICAgICAgIC8vIGl0ZXJhdGUgb3ZlciBtZW1iZXJzIHRvIGZpbmQgb25lcyB0aGF0IGFyZSBldmVudCBwYXlsb2FkcwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBtZW1iZXJOYW1lcy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgICAgaWYgKG1lbWJlcnNbbWVtYmVyTmFtZXNbaV1dLmlzRXZlbnRQYXlsb2FkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG1lbWJlck5hbWVzW2ldOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgCiAgICAgICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnZXZlbnRIZWFkZXJNZW1iZXJOYW1lcycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIG1lbWJlcnMgPSBzZWxmLm1lbWJlcnM7CiAgICAgICAgICB2YXIgbWVtYmVyTmFtZXMgPSBzZWxmLm1lbWJlck5hbWVzOwogICAgICAgICAgdmFyIGV2ZW50SGVhZGVyTWVtYmVyTmFtZXMgPSBbXTsKICAgICAgICAgIC8vIGl0ZXJhdGUgb3ZlciBtZW1iZXJzIHRvIGZpbmQgb25lcyB0aGF0IGFyZSBldmVudCBoZWFkZXJzCiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IG1lbWJlck5hbWVzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICBpZiAobWVtYmVyc1ttZW1iZXJOYW1lc1tpXV0uaXNFdmVudEhlYWRlcikgewogICAgICAgICAgICAgIGV2ZW50SGVhZGVyTWVtYmVyTmFtZXMucHVzaChtZW1iZXJOYW1lc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBldmVudEhlYWRlck1lbWJlck5hbWVzOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgCiAgICBpZiAoc2hhcGUucmVxdWlyZWQpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ3JlcXVpcmVkJywgc2hhcGUucmVxdWlyZWQpOwogICAgICBwcm9wZXJ0eSh0aGlzLCAnaXNSZXF1aXJlZCcsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICBpZiAoIXJlcXVpcmVkTWFwKSB7CiAgICAgICAgICByZXF1aXJlZE1hcCA9IHt9OwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzaGFwZS5yZXF1aXJlZC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICByZXF1aXJlZE1hcFtzaGFwZS5yZXF1aXJlZFtpXV0gPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAKICAgICAgICByZXR1cm4gcmVxdWlyZWRNYXBbbmFtZV07CiAgICAgIH0sIGZhbHNlLCB0cnVlKTsKICAgIH0KICAKICAgIHByb3BlcnR5KHRoaXMsICdyZXN1bHRXcmFwcGVyJywgc2hhcGUucmVzdWx0V3JhcHBlciB8fCBudWxsKTsKICAKICAgIGlmIChzaGFwZS5wYXlsb2FkKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdwYXlsb2FkJywgc2hhcGUucGF5bG9hZCk7CiAgICB9CiAgCiAgICBpZiAodHlwZW9mIHNoYXBlLnhtbE5hbWVzcGFjZSA9PT0gJ3N0cmluZycpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ3htbE5hbWVzcGFjZVVyaScsIHNoYXBlLnhtbE5hbWVzcGFjZSk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBzaGFwZS54bWxOYW1lc3BhY2UgPT09ICdvYmplY3QnKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd4bWxOYW1lc3BhY2VQcmVmaXgnLCBzaGFwZS54bWxOYW1lc3BhY2UucHJlZml4KTsKICAgICAgcHJvcGVydHkodGhpcywgJ3htbE5hbWVzcGFjZVVyaScsIHNoYXBlLnhtbE5hbWVzcGFjZS51cmkpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBMaXN0U2hhcGUoc2hhcGUsIG9wdGlvbnMpIHsKICAgIHZhciBzZWxmID0gdGhpcywgZmlyc3RJbml0ID0gIXRoaXMuaXNTaGFwZTsKICAgIENvbXBvc2l0ZVNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICBpZiAoZmlyc3RJbml0KSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkZWZhdWx0VmFsdWUnLCBmdW5jdGlvbigpIHsgcmV0dXJuIFtdOyB9KTsKICAgIH0KICAKICAgIGlmIChzaGFwZS5tZW1iZXIpIHsKICAgICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnbWVtYmVyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShzaGFwZS5tZW1iZXIsIG9wdGlvbnMpOwogICAgICB9KTsKICAgIH0KICAKICAgIGlmICh0aGlzLmZsYXR0ZW5lZCkgewogICAgICB2YXIgb2xkTmFtZSA9IHRoaXMubmFtZTsKICAgICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnbmFtZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzZWxmLm1lbWJlci5uYW1lIHx8IG9sZE5hbWU7CiAgICAgIH0pOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBNYXBTaGFwZShzaGFwZSwgb3B0aW9ucykgewogICAgdmFyIGZpcnN0SW5pdCA9ICF0aGlzLmlzU2hhcGU7CiAgICBDb21wb3NpdGVTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgaWYgKGZpcnN0SW5pdCkgewogICAgICBwcm9wZXJ0eSh0aGlzLCAnZGVmYXVsdFZhbHVlJywgZnVuY3Rpb24oKSB7IHJldHVybiB7fTsgfSk7CiAgICAgIHByb3BlcnR5KHRoaXMsICdrZXknLCBTaGFwZS5jcmVhdGUoe3R5cGU6ICdzdHJpbmcnfSwgb3B0aW9ucykpOwogICAgICBwcm9wZXJ0eSh0aGlzLCAndmFsdWUnLCBTaGFwZS5jcmVhdGUoe3R5cGU6ICdzdHJpbmcnfSwgb3B0aW9ucykpOwogICAgfQogIAogICAgaWYgKHNoYXBlLmtleSkgewogICAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdrZXknLCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gU2hhcGUuY3JlYXRlKHNoYXBlLmtleSwgb3B0aW9ucyk7CiAgICAgIH0pOwogICAgfQogICAgaWYgKHNoYXBlLnZhbHVlKSB7CiAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ3ZhbHVlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShzaGFwZS52YWx1ZSwgb3B0aW9ucyk7CiAgICAgIH0pOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBUaW1lc3RhbXBTaGFwZShzaGFwZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAKICAgIGlmIChzaGFwZS50aW1lc3RhbXBGb3JtYXQpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsIHNoYXBlLnRpbWVzdGFtcEZvcm1hdCk7CiAgICB9IGVsc2UgaWYgKHNlbGYuaXNUaW1lc3RhbXBGb3JtYXRTZXQgJiYgdGhpcy50aW1lc3RhbXBGb3JtYXQpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsIHRoaXMudGltZXN0YW1wRm9ybWF0KTsKICAgIH0gZWxzZSBpZiAodGhpcy5sb2NhdGlvbiA9PT0gJ2hlYWRlcicpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsICdyZmM4MjInKTsKICAgIH0gZWxzZSBpZiAodGhpcy5sb2NhdGlvbiA9PT0gJ3F1ZXJ5c3RyaW5nJykgewogICAgICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0JywgJ2lzbzg2MDEnKTsKICAgIH0gZWxzZSBpZiAodGhpcy5hcGkpIHsKICAgICAgc3dpdGNoICh0aGlzLmFwaS5wcm90b2NvbCkgewogICAgICAgIGNhc2UgJ2pzb24nOgogICAgICAgIGNhc2UgJ3Jlc3QtanNvbic6CiAgICAgICAgICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0JywgJ3VuaXhUaW1lc3RhbXAnKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ3Jlc3QteG1sJzoKICAgICAgICBjYXNlICdxdWVyeSc6CiAgICAgICAgY2FzZSAnZWMyJzoKICAgICAgICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCAnaXNvODYwMScpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAKICAgIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgICBpZiAodHlwZW9mIHZhbHVlLnRvVVRDU3RyaW5nID09PSAnZnVuY3Rpb24nKSByZXR1cm4gdmFsdWU7CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgPwogICAgICAgICAgICAgdXRpbC5kYXRlLnBhcnNlVGltZXN0YW1wKHZhbHVlKSA6IG51bGw7CiAgICB9OwogIAogICAgdGhpcy50b1dpcmVGb3JtYXQgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdXRpbC5kYXRlLmZvcm1hdCh2YWx1ZSwgc2VsZi50aW1lc3RhbXBGb3JtYXQpOwogICAgfTsKICB9CiAgCiAgZnVuY3Rpb24gU3RyaW5nU2hhcGUoKSB7CiAgICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgdmFyIG51bGxMZXNzUHJvdG9jb2xzID0gWydyZXN0LXhtbCcsICdxdWVyeScsICdlYzInXTsKICAgIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFsdWUgPSB0aGlzLmFwaSAmJiBudWxsTGVzc1Byb3RvY29scy5pbmRleE9mKHRoaXMuYXBpLnByb3RvY29sKSA+IC0xID8KICAgICAgICB2YWx1ZSB8fCAnJyA6IHZhbHVlOwogICAgICBpZiAodGhpcy5pc0pzb25WYWx1ZSkgewogICAgICAgIHJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKICAgICAgfQogIAogICAgICByZXR1cm4gdmFsdWUgJiYgdHlwZW9mIHZhbHVlLnRvU3RyaW5nID09PSAnZnVuY3Rpb24nID8KICAgICAgICB2YWx1ZS50b1N0cmluZygpIDogdmFsdWU7CiAgICB9OwogIAogICAgdGhpcy50b1dpcmVGb3JtYXQgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdGhpcy5pc0pzb25WYWx1ZSA/IEpTT04uc3RyaW5naWZ5KHZhbHVlKSA6IHZhbHVlOwogICAgfTsKICB9CiAgCiAgZnVuY3Rpb24gRmxvYXRTaGFwZSgpIHsKICAgIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHBhcnNlRmxvYXQodmFsdWUpOwogICAgfTsKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gdGhpcy50b1R5cGU7CiAgfQogIAogIGZ1bmN0aW9uIEludGVnZXJTaGFwZSgpIHsKICAgIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHBhcnNlSW50KHZhbHVlLCAxMCk7CiAgICB9OwogICAgdGhpcy50b1dpcmVGb3JtYXQgPSB0aGlzLnRvVHlwZTsKICB9CiAgCiAgZnVuY3Rpb24gQmluYXJ5U2hhcGUoKSB7CiAgICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICB2YXIgYnVmID0gdXRpbC5iYXNlNjQuZGVjb2RlKHZhbHVlKTsKICAgICAgaWYgKHRoaXMuaXNTZW5zaXRpdmUgJiYgdXRpbC5pc05vZGUoKSAmJiB0eXBlb2YgdXRpbC5CdWZmZXIuYWxsb2MgPT09ICdmdW5jdGlvbicpIHsKICAgIC8qIE5vZGUuanMgY2FuIGNyZWF0ZSBhIEJ1ZmZlciB0aGF0IGlzIG5vdCBpc29sYXRlZC4KICAgICAqIGkuZS4gYnVmLmJ5dGVMZW5ndGggIT09IGJ1Zi5idWZmZXIuYnl0ZUxlbmd0aAogICAgICogVGhpcyBtZWFucyB0aGF0IHRoZSBzZW5zaXRpdmUgZGF0YSBpcyBhY2Nlc3NpYmxlIHRvIGFueW9uZSB3aXRoIGFjY2VzcyB0byBidWYuYnVmZmVyLgogICAgICogSWYgdGhpcyBpcyB0aGUgbm9kZSBzaGFyZWQgQnVmZmVyLCB0aGVuIG90aGVyIGNvZGUgd2l0aGluIHRoaXMgcHJvY2VzcyBfY291bGRfIGZpbmQgdGhpcyBzZWNyZXQuCiAgICAgKiBDb3B5IHNlbnNpdGl2ZSBkYXRhIHRvIGFuIGlzb2xhdGVkIEJ1ZmZlciBhbmQgemVybyB0aGUgc2Vuc2l0aXZlIGRhdGEuCiAgICAgKiBXaGlsZSB0aGlzIGlzIHNhZmUgdG8gZG8gaGVyZSwgY29weWluZyB0aGlzIGNvZGUgc29tZXdoZXJlIGVsc2UgbWF5IHByb2R1Y2UgdW5leHBlY3RlZCByZXN1bHRzLgogICAgICovCiAgICAgICAgdmFyIHNlY3VyZUJ1ZiA9IHV0aWwuQnVmZmVyLmFsbG9jKGJ1Zi5sZW5ndGgsIGJ1Zik7CiAgICAgICAgYnVmLmZpbGwoMCk7CiAgICAgICAgYnVmID0gc2VjdXJlQnVmOwogICAgICB9CiAgICAgIHJldHVybiBidWY7CiAgICB9OwogICAgdGhpcy50b1dpcmVGb3JtYXQgPSB1dGlsLmJhc2U2NC5lbmNvZGU7CiAgfQogIAogIGZ1bmN0aW9uIEJhc2U2NFNoYXBlKCkgewogICAgQmluYXJ5U2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9CiAgCiAgZnVuY3Rpb24gQm9vbGVhblNoYXBlKCkgewogICAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAKICAgIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nKSByZXR1cm4gdmFsdWU7CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHZhbHVlID09PSAndHJ1ZSc7CiAgICB9OwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBTaGFwZS5zaGFwZXMgPSB7CiAgICBTdHJ1Y3R1cmVTaGFwZTogU3RydWN0dXJlU2hhcGUsCiAgICBMaXN0U2hhcGU6IExpc3RTaGFwZSwKICAgIE1hcFNoYXBlOiBNYXBTaGFwZSwKICAgIFN0cmluZ1NoYXBlOiBTdHJpbmdTaGFwZSwKICAgIEJvb2xlYW5TaGFwZTogQm9vbGVhblNoYXBlLAogICAgQmFzZTY0U2hhcGU6IEJhc2U2NFNoYXBlCiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IFNoYXBlOwogIAogIH0seyIuLi91dGlsIjo3MSwiLi9jb2xsZWN0aW9uIjozOX1dLDQ0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlBhcmFtVmFsaWRhdG9yID0gQVdTLnV0aWwuaW5oZXJpdCh7CiAgICAvKioKICAgICAqIENyZWF0ZSBhIG5ldyB2YWxpZGF0b3Igb2JqZWN0LgogICAgICoKICAgICAqIEBwYXJhbSB2YWxpZGF0aW9uIFtCb29sZWFufG1hcF0gd2hldGhlciBpbnB1dCBwYXJhbWV0ZXJzIHNob3VsZCBiZQogICAgICogICAgIHZhbGlkYXRlZCBhZ2FpbnN0IHRoZSBvcGVyYXRpb24gZGVzY3JpcHRpb24gYmVmb3JlIHNlbmRpbmcgdGhlCiAgICAgKiAgICAgcmVxdWVzdC4gUGFzcyBhIG1hcCB0byBlbmFibGUgYW55IG9mIHRoZSBmb2xsb3dpbmcgc3BlY2lmaWMKICAgICAqICAgICB2YWxpZGF0aW9uIGZlYXR1cmVzOgogICAgICoKICAgICAqICAgICAqICoqbWluKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWluCiAgICAgKiAgICAgICBjb25zdHJhaW50LiBUaGlzIGlzIGVuYWJsZWQgYnkgZGVmYXVsdCB3aGVuIHBhcmFtVmFsaWRhdGlvbiBpcyBzZXQKICAgICAqICAgICAgIHRvIGB0cnVlYC4KICAgICAqICAgICAqICoqbWF4KiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWF4CiAgICAgKiAgICAgICBjb25zdHJhaW50LgogICAgICogICAgICogKipwYXR0ZXJuKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBhCiAgICAgKiAgICAgICByZWd1bGFyIGV4cHJlc3Npb24uCiAgICAgKiAgICAgKiAqKmVudW0qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIG9uZQogICAgICogICAgICAgb2YgdGhlIGFsbG93YWJsZSBlbnVtIHZhbHVlcy4KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFBhcmFtVmFsaWRhdG9yKHZhbGlkYXRpb24pIHsKICAgICAgaWYgKHZhbGlkYXRpb24gPT09IHRydWUgfHwgdmFsaWRhdGlvbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdmFsaWRhdGlvbiA9IHsnbWluJzogdHJ1ZX07CiAgICAgIH0KICAgICAgdGhpcy52YWxpZGF0aW9uID0gdmFsaWRhdGlvbjsKICAgIH0sCiAgCiAgICB2YWxpZGF0ZTogZnVuY3Rpb24gdmFsaWRhdGUoc2hhcGUsIHBhcmFtcywgY29udGV4dCkgewogICAgICB0aGlzLmVycm9ycyA9IFtdOwogICAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKHNoYXBlLCBwYXJhbXMgfHwge30sIGNvbnRleHQgfHwgJ3BhcmFtcycpOwogIAogICAgICBpZiAodGhpcy5lcnJvcnMubGVuZ3RoID4gMSkgewogICAgICAgIHZhciBtc2cgPSB0aGlzLmVycm9ycy5qb2luKCdcbiogJyk7CiAgICAgICAgbXNnID0gJ1RoZXJlIHdlcmUgJyArIHRoaXMuZXJyb3JzLmxlbmd0aCArCiAgICAgICAgICAnIHZhbGlkYXRpb24gZXJyb3JzOlxuKiAnICsgbXNnOwogICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcihtc2cpLAogICAgICAgICAge2NvZGU6ICdNdWx0aXBsZVZhbGlkYXRpb25FcnJvcnMnLCBlcnJvcnM6IHRoaXMuZXJyb3JzfSk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5lcnJvcnMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdGhyb3cgdGhpcy5lcnJvcnNbMF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0sCiAgCiAgICBmYWlsOiBmdW5jdGlvbiBmYWlsKGNvZGUsIG1lc3NhZ2UpIHsKICAgICAgdGhpcy5lcnJvcnMucHVzaChBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IobWVzc2FnZSksIHtjb2RlOiBjb2RlfSkpOwogICAgfSwKICAKICAgIHZhbGlkYXRlU3RydWN0dXJlOiBmdW5jdGlvbiB2YWxpZGF0ZVN0cnVjdHVyZShzaGFwZSwgcGFyYW1zLCBjb250ZXh0KSB7CiAgICAgIHRoaXMudmFsaWRhdGVUeXBlKHBhcmFtcywgY29udGV4dCwgWydvYmplY3QnXSwgJ3N0cnVjdHVyZScpOwogIAogICAgICB2YXIgcGFyYW1OYW1lOwogICAgICBmb3IgKHZhciBpID0gMDsgc2hhcGUucmVxdWlyZWQgJiYgaSA8IHNoYXBlLnJlcXVpcmVkLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcGFyYW1OYW1lID0gc2hhcGUucmVxdWlyZWRbaV07CiAgICAgICAgdmFyIHZhbHVlID0gcGFyYW1zW3BhcmFtTmFtZV07CiAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgIHRoaXMuZmFpbCgnTWlzc2luZ1JlcXVpcmVkUGFyYW1ldGVyJywKICAgICAgICAgICAgJ01pc3NpbmcgcmVxdWlyZWQga2V5IFwnJyArIHBhcmFtTmFtZSArICdcJyBpbiAnICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIC8vIHZhbGlkYXRlIGhhc2ggbWVtYmVycwogICAgICBmb3IgKHBhcmFtTmFtZSBpbiBwYXJhbXMpIHsKICAgICAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwYXJhbXMsIHBhcmFtTmFtZSkpIGNvbnRpbnVlOwogIAogICAgICAgIHZhciBwYXJhbVZhbHVlID0gcGFyYW1zW3BhcmFtTmFtZV0sCiAgICAgICAgICAgIG1lbWJlclNoYXBlID0gc2hhcGUubWVtYmVyc1twYXJhbU5hbWVdOwogIAogICAgICAgIGlmIChtZW1iZXJTaGFwZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB2YXIgbWVtYmVyQ29udGV4dCA9IFtjb250ZXh0LCBwYXJhbU5hbWVdLmpvaW4oJy4nKTsKICAgICAgICAgIHRoaXMudmFsaWRhdGVNZW1iZXIobWVtYmVyU2hhcGUsIHBhcmFtVmFsdWUsIG1lbWJlckNvbnRleHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ1VuZXhwZWN0ZWRQYXJhbWV0ZXInLAogICAgICAgICAgICAnVW5leHBlY3RlZCBrZXkgXCcnICsgcGFyYW1OYW1lICsgJ1wnIGZvdW5kIGluICcgKyBjb250ZXh0KTsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogIAogICAgdmFsaWRhdGVNZW1iZXI6IGZ1bmN0aW9uIHZhbGlkYXRlTWVtYmVyKHNoYXBlLCBwYXJhbSwgY29udGV4dCkgewogICAgICBzd2l0Y2ggKHNoYXBlLnR5cGUpIHsKICAgICAgICBjYXNlICdzdHJ1Y3R1cmUnOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVTdHJ1Y3R1cmUoc2hhcGUsIHBhcmFtLCBjb250ZXh0KTsKICAgICAgICBjYXNlICdsaXN0JzoKICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlTGlzdChzaGFwZSwgcGFyYW0sIGNvbnRleHQpOwogICAgICAgIGNhc2UgJ21hcCc6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZU1hcChzaGFwZSwgcGFyYW0sIGNvbnRleHQpOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVNjYWxhcihzaGFwZSwgcGFyYW0sIGNvbnRleHQpOwogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVMaXN0OiBmdW5jdGlvbiB2YWxpZGF0ZUxpc3Qoc2hhcGUsIHBhcmFtcywgY29udGV4dCkgewogICAgICBpZiAodGhpcy52YWxpZGF0ZVR5cGUocGFyYW1zLCBjb250ZXh0LCBbQXJyYXldKSkgewogICAgICAgIHRoaXMudmFsaWRhdGVSYW5nZShzaGFwZSwgcGFyYW1zLmxlbmd0aCwgY29udGV4dCwgJ2xpc3QgbWVtYmVyIGNvdW50Jyk7CiAgICAgICAgLy8gdmFsaWRhdGUgYXJyYXkgbWVtYmVycwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFyYW1zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKHNoYXBlLm1lbWJlciwgcGFyYW1zW2ldLCBjb250ZXh0ICsgJ1snICsgaSArICddJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVNYXA6IGZ1bmN0aW9uIHZhbGlkYXRlTWFwKHNoYXBlLCBwYXJhbXMsIGNvbnRleHQpIHsKICAgICAgaWYgKHRoaXMudmFsaWRhdGVUeXBlKHBhcmFtcywgY29udGV4dCwgWydvYmplY3QnXSwgJ21hcCcpKSB7CiAgICAgICAgLy8gQnVpbGQgdXAgYSBjb3VudCBvZiBtYXAgbWVtYmVycyB0byB2YWxpZGF0ZSByYW5nZSB0cmFpdHMuCiAgICAgICAgdmFyIG1hcENvdW50ID0gMDsKICAgICAgICBmb3IgKHZhciBwYXJhbSBpbiBwYXJhbXMpIHsKICAgICAgICAgIGlmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHBhcmFtcywgcGFyYW0pKSBjb250aW51ZTsKICAgICAgICAgIC8vIFZhbGlkYXRlIGFueSBtYXAga2V5IHRyYWl0IGNvbnN0cmFpbnRzCiAgICAgICAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKHNoYXBlLmtleSwgcGFyYW0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQgKyAnW2tleT1cJycgKyBwYXJhbSArICdcJ10nKTsKICAgICAgICAgIHRoaXMudmFsaWRhdGVNZW1iZXIoc2hhcGUudmFsdWUsIHBhcmFtc1twYXJhbV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQgKyAnW1wnJyArIHBhcmFtICsgJ1wnXScpOwogICAgICAgICAgbWFwQ291bnQrKzsKICAgICAgICB9CiAgICAgICAgdGhpcy52YWxpZGF0ZVJhbmdlKHNoYXBlLCBtYXBDb3VudCwgY29udGV4dCwgJ21hcCBtZW1iZXIgY291bnQnKTsKICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlU2NhbGFyOiBmdW5jdGlvbiB2YWxpZGF0ZVNjYWxhcihzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICAgICAgY2FzZSBudWxsOgogICAgICAgIGNhc2UgdW5kZWZpbmVkOgogICAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVN0cmluZyhzaGFwZSwgdmFsdWUsIGNvbnRleHQpOwogICAgICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlUGF5bG9hZCh2YWx1ZSwgY29udGV4dCk7CiAgICAgICAgY2FzZSAnaW50ZWdlcic6CiAgICAgICAgY2FzZSAnZmxvYXQnOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVOdW1iZXIoc2hhcGUsIHZhbHVlLCBjb250ZXh0KTsKICAgICAgICBjYXNlICdib29sZWFuJzoKICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlVHlwZSh2YWx1ZSwgY29udGV4dCwgWydib29sZWFuJ10pOwogICAgICAgIGNhc2UgJ3RpbWVzdGFtcCc6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVR5cGUodmFsdWUsIGNvbnRleHQsIFtEYXRlLAogICAgICAgICAgICAvXlxkezR9LVxkezJ9LVxkezJ9VFxkezJ9OlxkezJ9OlxkezJ9KFwuXGQrKT9aJC8sICdudW1iZXInXSwKICAgICAgICAgICAgJ0RhdGUgb2JqZWN0LCBJU08tODYwMSBzdHJpbmcsIG9yIGEgVU5JWCB0aW1lc3RhbXAnKTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIHRoaXMuZmFpbCgnVW5rb3duVHlwZScsICdVbmhhbmRsZWQgdHlwZSAnICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcGUudHlwZSArICcgZm9yICcgKyBjb250ZXh0KTsKICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlU3RyaW5nOiBmdW5jdGlvbiB2YWxpZGF0ZVN0cmluZyhzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgdmFyIHZhbGlkVHlwZXMgPSBbJ3N0cmluZyddOwogICAgICBpZiAoc2hhcGUuaXNKc29uVmFsdWUpIHsKICAgICAgICB2YWxpZFR5cGVzID0gdmFsaWRUeXBlcy5jb25jYXQoWydudW1iZXInLCAnb2JqZWN0JywgJ2Jvb2xlYW4nXSk7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlICE9PSBudWxsICYmIHRoaXMudmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCB2YWxpZFR5cGVzKSkgewogICAgICAgIHRoaXMudmFsaWRhdGVFbnVtKHNoYXBlLCB2YWx1ZSwgY29udGV4dCk7CiAgICAgICAgdGhpcy52YWxpZGF0ZVJhbmdlKHNoYXBlLCB2YWx1ZS5sZW5ndGgsIGNvbnRleHQsICdzdHJpbmcgbGVuZ3RoJyk7CiAgICAgICAgdGhpcy52YWxpZGF0ZVBhdHRlcm4oc2hhcGUsIHZhbHVlLCBjb250ZXh0KTsKICAgICAgICB0aGlzLnZhbGlkYXRlVXJpKHNoYXBlLCB2YWx1ZSwgY29udGV4dCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVVyaTogZnVuY3Rpb24gdmFsaWRhdGVVcmkoc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIGlmIChzaGFwZVsnbG9jYXRpb24nXSA9PT0gJ3VyaScpIHsKICAgICAgICBpZiAodmFsdWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ1VyaVBhcmFtZXRlckVycm9yJywgJ0V4cGVjdGVkIHVyaSBwYXJhbWV0ZXIgdG8gaGF2ZSBsZW5ndGggPj0gMSwnCiAgICAgICAgICAgICsgJyBidXQgZm91bmQgIicgKyB2YWx1ZSArJyIgZm9yICcgKyBjb250ZXh0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVBhdHRlcm46IGZ1bmN0aW9uIHZhbGlkYXRlUGF0dGVybihzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgaWYgKHRoaXMudmFsaWRhdGlvblsncGF0dGVybiddICYmIHNoYXBlWydwYXR0ZXJuJ10gIT09IHVuZGVmaW5lZCkgewogICAgICAgIGlmICghKG5ldyBSZWdFeHAoc2hhcGVbJ3BhdHRlcm4nXSkpLnRlc3QodmFsdWUpKSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ1BhdHRlcm5NYXRjaEVycm9yJywgJ1Byb3ZpZGVkIHZhbHVlICInICsgdmFsdWUgKyAnIiAnCiAgICAgICAgICAgICsgJ2RvZXMgbm90IG1hdGNoIHJlZ2V4IHBhdHRlcm4gLycgKyBzaGFwZVsncGF0dGVybiddICsgJy8gZm9yICcKICAgICAgICAgICAgKyBjb250ZXh0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVJhbmdlOiBmdW5jdGlvbiB2YWxpZGF0ZVJhbmdlKHNoYXBlLCB2YWx1ZSwgY29udGV4dCwgZGVzY3JpcHRvcikgewogICAgICBpZiAodGhpcy52YWxpZGF0aW9uWydtaW4nXSkgewogICAgICAgIGlmIChzaGFwZVsnbWluJ10gIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSA8IHNoYXBlWydtaW4nXSkgewogICAgICAgICAgdGhpcy5mYWlsKCdNaW5SYW5nZUVycm9yJywgJ0V4cGVjdGVkICcgKyBkZXNjcmlwdG9yICsgJyA+PSAnCiAgICAgICAgICAgICsgc2hhcGVbJ21pbiddICsgJywgYnV0IGZvdW5kICcgKyB2YWx1ZSArICcgZm9yICcgKyBjb250ZXh0KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHRoaXMudmFsaWRhdGlvblsnbWF4J10pIHsKICAgICAgICBpZiAoc2hhcGVbJ21heCddICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgPiBzaGFwZVsnbWF4J10pIHsKICAgICAgICAgIHRoaXMuZmFpbCgnTWF4UmFuZ2VFcnJvcicsICdFeHBlY3RlZCAnICsgZGVzY3JpcHRvciArICcgPD0gJwogICAgICAgICAgICArIHNoYXBlWydtYXgnXSArICcsIGJ1dCBmb3VuZCAnICsgdmFsdWUgKyAnIGZvciAnICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVFbnVtOiBmdW5jdGlvbiB2YWxpZGF0ZVJhbmdlKHNoYXBlLCB2YWx1ZSwgY29udGV4dCkgewogICAgICBpZiAodGhpcy52YWxpZGF0aW9uWydlbnVtJ10gJiYgc2hhcGVbJ2VudW0nXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgLy8gRmFpbCBpZiB0aGUgc3RyaW5nIHZhbHVlIGlzIG5vdCBwcmVzZW50IGluIHRoZSBlbnVtIGxpc3QKICAgICAgICBpZiAoc2hhcGVbJ2VudW0nXS5pbmRleE9mKHZhbHVlKSA9PT0gLTEpIHsKICAgICAgICAgIHRoaXMuZmFpbCgnRW51bUVycm9yJywgJ0ZvdW5kIHN0cmluZyB2YWx1ZSBvZiAnICsgdmFsdWUgKyAnLCBidXQgJwogICAgICAgICAgICArICdleHBlY3RlZCAnICsgc2hhcGVbJ2VudW0nXS5qb2luKCd8JykgKyAnIGZvciAnICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVUeXBlOiBmdW5jdGlvbiB2YWxpZGF0ZVR5cGUodmFsdWUsIGNvbnRleHQsIGFjY2VwdGVkVHlwZXMsIHR5cGUpIHsKICAgICAgLy8gV2Ugd2lsbCBub3QgbG9nIGFuIGVycm9yIGZvciBudWxsIG9yIHVuZGVmaW5lZCwgYnV0IHdlIHdpbGwgcmV0dXJuCiAgICAgIC8vIGZhbHNlIHNvIHRoYXQgY2FsbGVycyBrbm93IHRoYXQgdGhlIGV4cGVjdGVkIHR5cGUgd2FzIG5vdCBzdHJpY3RseSBtZXQuCiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gZmFsc2U7CiAgCiAgICAgIHZhciBmb3VuZEludmFsaWRUeXBlID0gZmFsc2U7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYWNjZXB0ZWRUeXBlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICh0eXBlb2YgYWNjZXB0ZWRUeXBlc1tpXSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09IGFjY2VwdGVkVHlwZXNbaV0pIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAoYWNjZXB0ZWRUeXBlc1tpXSBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgICAgaWYgKCh2YWx1ZSB8fCAnJykudG9TdHJpbmcoKS5tYXRjaChhY2NlcHRlZFR5cGVzW2ldKSkgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIGFjY2VwdGVkVHlwZXNbaV0pIHJldHVybiB0cnVlOwogICAgICAgICAgaWYgKEFXUy51dGlsLmlzVHlwZSh2YWx1ZSwgYWNjZXB0ZWRUeXBlc1tpXSkpIHJldHVybiB0cnVlOwogICAgICAgICAgaWYgKCF0eXBlICYmICFmb3VuZEludmFsaWRUeXBlKSBhY2NlcHRlZFR5cGVzID0gYWNjZXB0ZWRUeXBlcy5zbGljZSgpOwogICAgICAgICAgYWNjZXB0ZWRUeXBlc1tpXSA9IEFXUy51dGlsLnR5cGVOYW1lKGFjY2VwdGVkVHlwZXNbaV0pOwogICAgICAgIH0KICAgICAgICBmb3VuZEludmFsaWRUeXBlID0gdHJ1ZTsKICAgICAgfQogIAogICAgICB2YXIgYWNjZXB0ZWRUeXBlID0gdHlwZTsKICAgICAgaWYgKCFhY2NlcHRlZFR5cGUpIHsKICAgICAgICBhY2NlcHRlZFR5cGUgPSBhY2NlcHRlZFR5cGVzLmpvaW4oJywgJykucmVwbGFjZSgvLChbXixdKykkLywgJywgb3IkMScpOwogICAgICB9CiAgCiAgICAgIHZhciB2b3dlbCA9IGFjY2VwdGVkVHlwZS5tYXRjaCgvXlthZWlvdV0vaSkgPyAnbicgOiAnJzsKICAgICAgdGhpcy5mYWlsKCdJbnZhbGlkUGFyYW1ldGVyVHlwZScsICdFeHBlY3RlZCAnICsgY29udGV4dCArICcgdG8gYmUgYScgKwogICAgICAgICAgICAgICAgdm93ZWwgKyAnICcgKyBhY2NlcHRlZFR5cGUpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAogIAogICAgdmFsaWRhdGVOdW1iZXI6IGZ1bmN0aW9uIHZhbGlkYXRlTnVtYmVyKHNoYXBlLCB2YWx1ZSwgY29udGV4dCkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgewogICAgICAgIHZhciBjYXN0ZWRWYWx1ZSA9IHBhcnNlRmxvYXQodmFsdWUpOwogICAgICAgIGlmIChjYXN0ZWRWYWx1ZS50b1N0cmluZygpID09PSB2YWx1ZSkgdmFsdWUgPSBjYXN0ZWRWYWx1ZTsKICAgICAgfQogICAgICBpZiAodGhpcy52YWxpZGF0ZVR5cGUodmFsdWUsIGNvbnRleHQsIFsnbnVtYmVyJ10pKSB7CiAgICAgICAgdGhpcy52YWxpZGF0ZVJhbmdlKHNoYXBlLCB2YWx1ZSwgY29udGV4dCwgJ251bWVyaWMgdmFsdWUnKTsKICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlUGF5bG9hZDogZnVuY3Rpb24gdmFsaWRhdGVQYXlsb2FkKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSByZXR1cm47CiAgICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUuYnl0ZUxlbmd0aCA9PT0gJ251bWJlcicpIHJldHVybjsgLy8gdHlwZWQgYXJyYXlzCiAgICAgIGlmIChBV1MudXRpbC5pc05vZGUoKSkgeyAvLyBzcGVjaWFsIGNoZWNrIGZvciBidWZmZXIvc3RyZWFtIGluIE5vZGUuanMKICAgICAgICB2YXIgU3RyZWFtID0gQVdTLnV0aWwuc3RyZWFtLlN0cmVhbTsKICAgICAgICBpZiAoQVdTLnV0aWwuQnVmZmVyLmlzQnVmZmVyKHZhbHVlKSB8fCB2YWx1ZSBpbnN0YW5jZW9mIFN0cmVhbSkgcmV0dXJuOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICh0eXBlb2YgQmxvYiAhPT0gdm9pZCAwICYmIHZhbHVlIGluc3RhbmNlb2YgQmxvYikgcmV0dXJuOwogICAgICB9CiAgCiAgICAgIHZhciB0eXBlcyA9IFsnQnVmZmVyJywgJ1N0cmVhbScsICdGaWxlJywgJ0Jsb2InLCAnQXJyYXlCdWZmZXInLCAnRGF0YVZpZXcnXTsKICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0eXBlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKEFXUy51dGlsLmlzVHlwZSh2YWx1ZSwgdHlwZXNbaV0pKSByZXR1cm47CiAgICAgICAgICBpZiAoQVdTLnV0aWwudHlwZU5hbWUodmFsdWUuY29uc3RydWN0b3IpID09PSB0eXBlc1tpXSkgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQogIAogICAgICB0aGlzLmZhaWwoJ0ludmFsaWRQYXJhbWV0ZXJUeXBlJywgJ0V4cGVjdGVkICcgKyBjb250ZXh0ICsgJyB0byBiZSBhICcgKwogICAgICAgICdzdHJpbmcsIEJ1ZmZlciwgU3RyZWFtLCBCbG9iLCBvciB0eXBlZCBhcnJheSBvYmplY3QnKTsKICAgIH0KICB9KTsKICAKICB9LHsiLi9jb3JlIjoxOH1dLDQ1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9ICByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICAKICAvKioKICAgKiBQcmVwZW5kIHByZWZpeCBkZWZpbmVkIGJ5IEFQSSBtb2RlbCB0byBlbmRwb2ludCB0aGF0J3MgYWxyZWFkeQogICAqIGNvbnN0cnVjdGVkLiBUaGlzIGZlYXR1cmUgZG9lcyBub3QgYXBwbHkgdG8gb3BlcmF0aW9ucyB1c2luZwogICAqIGVuZHBvaW50IGRpc2NvdmVyeSBhbmQgY2FuIGJlIGRpc2FibGVkLgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHBvcHVsYXRlSG9zdFByZWZpeChyZXF1ZXN0KSAgewogICAgdmFyIGVuYWJsZWQgPSByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmhvc3RQcmVmaXhFbmFibGVkOwogICAgaWYgKCFlbmFibGVkKSByZXR1cm4gcmVxdWVzdDsKICAgIHZhciBvcGVyYXRpb25Nb2RlbCA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICAvL2Rvbid0IG1hcnNoYWwgaG9zdCBwcmVmaXggd2hlbiBvcGVyYXRpb24gaGFzIGVuZHBvaW50IGRpc2NvdmVyeSB0cmFpdHMKICAgIGlmIChoYXNFbmRwb2ludERpc2NvdmVyKHJlcXVlc3QpKSByZXR1cm4gcmVxdWVzdDsKICAgIGlmIChvcGVyYXRpb25Nb2RlbC5lbmRwb2ludCAmJiBvcGVyYXRpb25Nb2RlbC5lbmRwb2ludC5ob3N0UHJlZml4KSB7CiAgICAgIHZhciBob3N0UHJlZml4Tm90YXRpb24gPSBvcGVyYXRpb25Nb2RlbC5lbmRwb2ludC5ob3N0UHJlZml4OwogICAgICB2YXIgaG9zdFByZWZpeCA9IGV4cGFuZEhvc3RQcmVmaXgoaG9zdFByZWZpeE5vdGF0aW9uLCByZXF1ZXN0LnBhcmFtcywgb3BlcmF0aW9uTW9kZWwuaW5wdXQpOwogICAgICBwcmVwZW5kRW5kcG9pbnRQcmVmaXgocmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludCwgaG9zdFByZWZpeCk7CiAgICAgIHZhbGlkYXRlSG9zdG5hbWUocmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludC5ob3N0bmFtZSk7CiAgICB9CiAgICByZXR1cm4gcmVxdWVzdDsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gaGFzRW5kcG9pbnREaXNjb3ZlcihyZXF1ZXN0KSB7CiAgICB2YXIgYXBpID0gcmVxdWVzdC5zZXJ2aWNlLmFwaTsKICAgIHZhciBvcGVyYXRpb25Nb2RlbCA9IGFwaS5vcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXTsKICAgIHZhciBpc0VuZHBvaW50T3BlcmF0aW9uID0gYXBpLmVuZHBvaW50T3BlcmF0aW9uICYmIChhcGkuZW5kcG9pbnRPcGVyYXRpb24gPT09IHV0aWwuc3RyaW5nLmxvd2VyRmlyc3Qob3BlcmF0aW9uTW9kZWwubmFtZSkpOwogICAgcmV0dXJuIChvcGVyYXRpb25Nb2RlbC5lbmRwb2ludERpc2NvdmVyeVJlcXVpcmVkICE9PSAnTlVMTCcgfHwgaXNFbmRwb2ludE9wZXJhdGlvbiA9PT0gdHJ1ZSk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGV4cGFuZEhvc3RQcmVmaXgoaG9zdFByZWZpeE5vdGF0aW9uLCBwYXJhbXMsIHNoYXBlKSB7CiAgICB1dGlsLmVhY2goc2hhcGUubWVtYmVycywgZnVuY3Rpb24obmFtZSwgbWVtYmVyKSB7CiAgICAgIGlmIChtZW1iZXIuaG9zdExhYmVsID09PSB0cnVlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBwYXJhbXNbbmFtZV0gIT09ICdzdHJpbmcnIHx8IHBhcmFtc1tuYW1lXSA9PT0gJycpIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICAgICAgbWVzc2FnZTogJ1BhcmFtZXRlciAnICsgbmFtZSArICcgc2hvdWxkIGJlIGEgbm9uLWVtcHR5IHN0cmluZy4nLAogICAgICAgICAgICBjb2RlOiAnSW52YWxpZFBhcmFtZXRlcicKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB2YXIgcmVnZXggPSBuZXcgUmVnRXhwKCdcXHsnICsgbmFtZSArICdcXH0nLCAnZycpOwogICAgICAgIGhvc3RQcmVmaXhOb3RhdGlvbiA9IGhvc3RQcmVmaXhOb3RhdGlvbi5yZXBsYWNlKHJlZ2V4LCBwYXJhbXNbbmFtZV0pOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBob3N0UHJlZml4Tm90YXRpb247CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHByZXBlbmRFbmRwb2ludFByZWZpeChlbmRwb2ludCwgcHJlZml4KSB7CiAgICBpZiAoZW5kcG9pbnQuaG9zdCkgewogICAgICBlbmRwb2ludC5ob3N0ID0gcHJlZml4ICsgZW5kcG9pbnQuaG9zdDsKICAgIH0KICAgIGlmIChlbmRwb2ludC5ob3N0bmFtZSkgewogICAgICBlbmRwb2ludC5ob3N0bmFtZSA9IHByZWZpeCArIGVuZHBvaW50Lmhvc3RuYW1lOwogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiB2YWxpZGF0ZUhvc3RuYW1lKGhvc3RuYW1lKSB7CiAgICB2YXIgbGFiZWxzID0gaG9zdG5hbWUuc3BsaXQoJy4nKTsKICAgIC8vUmVmZXJlbmNlOiBodHRwczovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMTEyMyNzZWN0aW9uLTIKICAgIHZhciBob3N0UGF0dGVybiA9IC9eW2EtekEtWjAtOV17MX0kfF5bYS16QS1aMC05XVthLXpBLVowLTlcLV0qW2EtekEtWjAtOV0kLzsKICAgIHV0aWwuYXJyYXlFYWNoKGxhYmVscywgZnVuY3Rpb24obGFiZWwpIHsKICAgICAgaWYgKCFsYWJlbC5sZW5ndGggfHwgbGFiZWwubGVuZ3RoIDwgMSB8fCBsYWJlbC5sZW5ndGggPiA2MykgewogICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICAgIGNvZGU6ICdWYWxpZGF0aW9uRXJyb3InLAogICAgICAgICAgbWVzc2FnZTogJ0hvc3RuYW1lIGxhYmVsIGxlbmd0aCBzaG91bGQgYmUgYmV0d2VlbiAxIHRvIDYzIGNoYXJhY3RlcnMsIGluY2x1c2l2ZS4nCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKCFob3N0UGF0dGVybi50ZXN0KGxhYmVsKSkgewogICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAge2NvZGU6ICdWYWxpZGF0aW9uRXJyb3InLCBtZXNzYWdlOiBsYWJlbCArICcgaXMgbm90IGhvc3RuYW1lIGNvbXBhdGlibGUuJ30pOwogICAgICB9CiAgICB9KTsKICB9CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBwb3B1bGF0ZUhvc3RQcmVmaXg6IHBvcHVsYXRlSG9zdFByZWZpeAogIH07CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuLi91dGlsIjo3MX1dLDQ2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgSnNvbkJ1aWxkZXIgPSByZXF1aXJlKCcuLi9qc29uL2J1aWxkZXInKTsKICB2YXIgSnNvblBhcnNlciA9IHJlcXVpcmUoJy4uL2pzb24vcGFyc2VyJyk7CiAgdmFyIHBvcHVsYXRlSG9zdFByZWZpeCA9IHJlcXVpcmUoJy4vaGVscGVycycpLnBvcHVsYXRlSG9zdFByZWZpeDsKICAKICBmdW5jdGlvbiBidWlsZFJlcXVlc3QocmVxKSB7CiAgICB2YXIgaHR0cFJlcXVlc3QgPSByZXEuaHR0cFJlcXVlc3Q7CiAgICB2YXIgYXBpID0gcmVxLnNlcnZpY2UuYXBpOwogICAgdmFyIHRhcmdldCA9IGFwaS50YXJnZXRQcmVmaXggKyAnLicgKyBhcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5uYW1lOwogICAgdmFyIHZlcnNpb24gPSBhcGkuanNvblZlcnNpb24gfHwgJzEuMCc7CiAgICB2YXIgaW5wdXQgPSBhcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dDsKICAgIHZhciBidWlsZGVyID0gbmV3IEpzb25CdWlsZGVyKCk7CiAgCiAgICBpZiAodmVyc2lvbiA9PT0gMSkgdmVyc2lvbiA9ICcxLjAnOwogICAgaHR0cFJlcXVlc3QuYm9keSA9IGJ1aWxkZXIuYnVpbGQocmVxLnBhcmFtcyB8fCB7fSwgaW5wdXQpOwogICAgaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ10gPSAnYXBwbGljYXRpb24veC1hbXotanNvbi0nICsgdmVyc2lvbjsKICAgIGh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LVRhcmdldCddID0gdGFyZ2V0OwogIAogICAgcG9wdWxhdGVIb3N0UHJlZml4KHJlcSk7CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3RFcnJvcihyZXNwKSB7CiAgICB2YXIgZXJyb3IgPSB7fTsKICAgIHZhciBodHRwUmVzcG9uc2UgPSByZXNwLmh0dHBSZXNwb25zZTsKICAKICAgIGVycm9yLmNvZGUgPSBodHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXpuLWVycm9ydHlwZSddIHx8ICdVbmtub3duRXJyb3InOwogICAgaWYgKHR5cGVvZiBlcnJvci5jb2RlID09PSAnc3RyaW5nJykgewogICAgICBlcnJvci5jb2RlID0gZXJyb3IuY29kZS5zcGxpdCgnOicpWzBdOwogICAgfQogIAogICAgaWYgKGh0dHBSZXNwb25zZS5ib2R5Lmxlbmd0aCA+IDApIHsKICAgICAgdHJ5IHsKICAgICAgICB2YXIgZSA9IEpTT04ucGFyc2UoaHR0cFJlc3BvbnNlLmJvZHkudG9TdHJpbmcoKSk7CiAgICAgICAgaWYgKGUuX190eXBlIHx8IGUuY29kZSkgewogICAgICAgICAgZXJyb3IuY29kZSA9IChlLl9fdHlwZSB8fCBlLmNvZGUpLnNwbGl0KCcjJykucG9wKCk7CiAgICAgICAgfQogICAgICAgIGlmIChlcnJvci5jb2RlID09PSAnUmVxdWVzdEVudGl0eVRvb0xhcmdlJykgewogICAgICAgICAgZXJyb3IubWVzc2FnZSA9ICdSZXF1ZXN0IGJvZHkgbXVzdCBiZSBsZXNzIHRoYW4gMSBNQic7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVycm9yLm1lc3NhZ2UgPSAoZS5tZXNzYWdlIHx8IGUuTWVzc2FnZSB8fCBudWxsKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBlcnJvci5zdGF0dXNDb2RlID0gaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgICAgZXJyb3IubWVzc2FnZSA9IGh0dHBSZXNwb25zZS5zdGF0dXNNZXNzYWdlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlcnJvci5zdGF0dXNDb2RlID0gaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgIGVycm9yLm1lc3NhZ2UgPSBodHRwUmVzcG9uc2Uuc3RhdHVzQ29kZS50b1N0cmluZygpOwogICAgfQogIAogICAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIGVycm9yKTsKICB9CiAgCiAgZnVuY3Rpb24gZXh0cmFjdERhdGEocmVzcCkgewogICAgdmFyIGJvZHkgPSByZXNwLmh0dHBSZXNwb25zZS5ib2R5LnRvU3RyaW5nKCkgfHwgJ3t9JzsKICAgIGlmIChyZXNwLnJlcXVlc3Quc2VydmljZS5jb25maWcuY29udmVydFJlc3BvbnNlVHlwZXMgPT09IGZhbHNlKSB7CiAgICAgIHJlc3AuZGF0YSA9IEpTT04ucGFyc2UoYm9keSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgb3BlcmF0aW9uID0gcmVzcC5yZXF1ZXN0LnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVzcC5yZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICAgIHZhciBzaGFwZSA9IG9wZXJhdGlvbi5vdXRwdXQgfHwge307CiAgICAgIHZhciBwYXJzZXIgPSBuZXcgSnNvblBhcnNlcigpOwogICAgICByZXNwLmRhdGEgPSBwYXJzZXIucGFyc2UoYm9keSwgc2hhcGUpOwogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIGJ1aWxkUmVxdWVzdDogYnVpbGRSZXF1ZXN0LAogICAgZXh0cmFjdEVycm9yOiBleHRyYWN0RXJyb3IsCiAgICBleHRyYWN0RGF0YTogZXh0cmFjdERhdGEKICB9OwogIAogIH0seyIuLi9qc29uL2J1aWxkZXIiOjM2LCIuLi9qc29uL3BhcnNlciI6MzcsIi4uL3V0aWwiOjcxLCIuL2hlbHBlcnMiOjQ1fV0sNDc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIFF1ZXJ5UGFyYW1TZXJpYWxpemVyID0gcmVxdWlyZSgnLi4vcXVlcnkvcXVlcnlfcGFyYW1fc2VyaWFsaXplcicpOwogIHZhciBTaGFwZSA9IHJlcXVpcmUoJy4uL21vZGVsL3NoYXBlJyk7CiAgdmFyIHBvcHVsYXRlSG9zdFByZWZpeCA9IHJlcXVpcmUoJy4vaGVscGVycycpLnBvcHVsYXRlSG9zdFByZWZpeDsKICAKICBmdW5jdGlvbiBidWlsZFJlcXVlc3QocmVxKSB7CiAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICB2YXIgaHR0cFJlcXVlc3QgPSByZXEuaHR0cFJlcXVlc3Q7CiAgICBodHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXSA9CiAgICAgICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7IGNoYXJzZXQ9dXRmLTgnOwogICAgaHR0cFJlcXVlc3QucGFyYW1zID0gewogICAgICBWZXJzaW9uOiByZXEuc2VydmljZS5hcGkuYXBpVmVyc2lvbiwKICAgICAgQWN0aW9uOiBvcGVyYXRpb24ubmFtZQogICAgfTsKICAKICAgIC8vIGNvbnZlcnQgdGhlIHJlcXVlc3QgcGFyYW1ldGVycyBpbnRvIGEgbGlzdCBvZiBxdWVyeSBwYXJhbXMsCiAgICAvLyBlLmcuIERlZXBseS5OZXN0ZWRQYXJhbS4wLk5hbWU9dmFsdWUKICAgIHZhciBidWlsZGVyID0gbmV3IFF1ZXJ5UGFyYW1TZXJpYWxpemVyKCk7CiAgICBidWlsZGVyLnNlcmlhbGl6ZShyZXEucGFyYW1zLCBvcGVyYXRpb24uaW5wdXQsIGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgIGh0dHBSZXF1ZXN0LnBhcmFtc1tuYW1lXSA9IHZhbHVlOwogICAgfSk7CiAgICBodHRwUmVxdWVzdC5ib2R5ID0gdXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKGh0dHBSZXF1ZXN0LnBhcmFtcyk7CiAgCiAgICBwb3B1bGF0ZUhvc3RQcmVmaXgocmVxKTsKICB9CiAgCiAgZnVuY3Rpb24gZXh0cmFjdEVycm9yKHJlc3ApIHsKICAgIHZhciBkYXRhLCBib2R5ID0gcmVzcC5odHRwUmVzcG9uc2UuYm9keS50b1N0cmluZygpOwogICAgaWYgKGJvZHkubWF0Y2goJzxVbmtub3duT3BlcmF0aW9uRXhjZXB0aW9uJykpIHsKICAgICAgZGF0YSA9IHsKICAgICAgICBDb2RlOiAnVW5rbm93bk9wZXJhdGlvbicsCiAgICAgICAgTWVzc2FnZTogJ1Vua25vd24gb3BlcmF0aW9uICcgKyByZXNwLnJlcXVlc3Qub3BlcmF0aW9uCiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICB0cnkgewogICAgICAgIGRhdGEgPSBuZXcgQVdTLlhNTC5QYXJzZXIoKS5wYXJzZShib2R5KTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGRhdGEgPSB7CiAgICAgICAgICBDb2RlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlLAogICAgICAgICAgTWVzc2FnZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzTWVzc2FnZQogICAgICAgIH07CiAgICAgIH0KICAgIH0KICAKICAgIGlmIChkYXRhLnJlcXVlc3RJZCAmJiAhcmVzcC5yZXF1ZXN0SWQpIHJlc3AucmVxdWVzdElkID0gZGF0YS5yZXF1ZXN0SWQ7CiAgICBpZiAoZGF0YS5FcnJvcnMpIGRhdGEgPSBkYXRhLkVycm9yczsKICAgIGlmIChkYXRhLkVycm9yKSBkYXRhID0gZGF0YS5FcnJvcjsKICAgIGlmIChkYXRhLkNvZGUpIHsKICAgICAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiBkYXRhLkNvZGUsCiAgICAgICAgbWVzc2FnZTogZGF0YS5NZXNzYWdlCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlLAogICAgICAgIG1lc3NhZ2U6IG51bGwKICAgICAgfSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICB2YXIgc2hhcGUgPSBvcGVyYXRpb24ub3V0cHV0IHx8IHt9OwogICAgdmFyIG9yaWdSdWxlcyA9IHNoYXBlOwogIAogICAgaWYgKG9yaWdSdWxlcy5yZXN1bHRXcmFwcGVyKSB7CiAgICAgIHZhciB0bXAgPSBTaGFwZS5jcmVhdGUoe3R5cGU6ICdzdHJ1Y3R1cmUnfSk7CiAgICAgIHRtcC5tZW1iZXJzW29yaWdSdWxlcy5yZXN1bHRXcmFwcGVyXSA9IHNoYXBlOwogICAgICB0bXAubWVtYmVyTmFtZXMgPSBbb3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXJdOwogICAgICB1dGlsLnByb3BlcnR5KHNoYXBlLCAnbmFtZScsIHNoYXBlLnJlc3VsdFdyYXBwZXIpOwogICAgICBzaGFwZSA9IHRtcDsKICAgIH0KICAKICAgIHZhciBwYXJzZXIgPSBuZXcgQVdTLlhNTC5QYXJzZXIoKTsKICAKICAgIC8vIFRPRE86IFJlZmFjdG9yIFhNTCBQYXJzZXIgdG8gcGFyc2UgUmVxdWVzdElkIGZyb20gcmVzcG9uc2UuCiAgICBpZiAoc2hhcGUgJiYgc2hhcGUubWVtYmVycyAmJiAhc2hhcGUubWVtYmVycy5fWEFNWlJlcXVlc3RJZCkgewogICAgICB2YXIgcmVxdWVzdElkU2hhcGUgPSBTaGFwZS5jcmVhdGUoCiAgICAgICAgeyB0eXBlOiAnc3RyaW5nJyB9LAogICAgICAgIHsgYXBpOiB7IHByb3RvY29sOiAncXVlcnknIH0gfSwKICAgICAgICAncmVxdWVzdElkJwogICAgICApOwogICAgICBzaGFwZS5tZW1iZXJzLl9YQU1aUmVxdWVzdElkID0gcmVxdWVzdElkU2hhcGU7CiAgICB9CiAgCiAgICB2YXIgZGF0YSA9IHBhcnNlci5wYXJzZShyZXNwLmh0dHBSZXNwb25zZS5ib2R5LnRvU3RyaW5nKCksIHNoYXBlKTsKICAgIHJlc3AucmVxdWVzdElkID0gZGF0YS5fWEFNWlJlcXVlc3RJZCB8fCBkYXRhLnJlcXVlc3RJZDsKICAKICAgIGlmIChkYXRhLl9YQU1aUmVxdWVzdElkKSBkZWxldGUgZGF0YS5fWEFNWlJlcXVlc3RJZDsKICAKICAgIGlmIChvcmlnUnVsZXMucmVzdWx0V3JhcHBlcikgewogICAgICBpZiAoZGF0YVtvcmlnUnVsZXMucmVzdWx0V3JhcHBlcl0pIHsKICAgICAgICB1dGlsLnVwZGF0ZShkYXRhLCBkYXRhW29yaWdSdWxlcy5yZXN1bHRXcmFwcGVyXSk7CiAgICAgICAgZGVsZXRlIGRhdGFbb3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXJdOwogICAgICB9CiAgICB9CiAgCiAgICByZXNwLmRhdGEgPSBkYXRhOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIGJ1aWxkUmVxdWVzdDogYnVpbGRSZXF1ZXN0LAogICAgZXh0cmFjdEVycm9yOiBleHRyYWN0RXJyb3IsCiAgICBleHRyYWN0RGF0YTogZXh0cmFjdERhdGEKICB9OwogIAogIH0seyIuLi9jb3JlIjoxOCwiLi4vbW9kZWwvc2hhcGUiOjQzLCIuLi9xdWVyeS9xdWVyeV9wYXJhbV9zZXJpYWxpemVyIjo1MSwiLi4vdXRpbCI6NzEsIi4vaGVscGVycyI6NDV9XSw0ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIHBvcHVsYXRlSG9zdFByZWZpeCA9IHJlcXVpcmUoJy4vaGVscGVycycpLnBvcHVsYXRlSG9zdFByZWZpeDsKICAKICBmdW5jdGlvbiBwb3B1bGF0ZU1ldGhvZChyZXEpIHsKICAgIHJlcS5odHRwUmVxdWVzdC5tZXRob2QgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5odHRwTWV0aG9kOwogIH0KICAKICBmdW5jdGlvbiBnZW5lcmF0ZVVSSShlbmRwb2ludFBhdGgsIG9wZXJhdGlvblBhdGgsIGlucHV0LCBwYXJhbXMpIHsKICAgIHZhciB1cmkgPSBbZW5kcG9pbnRQYXRoLCBvcGVyYXRpb25QYXRoXS5qb2luKCcvJyk7CiAgICB1cmkgPSB1cmkucmVwbGFjZSgvXC8rL2csICcvJyk7CiAgCiAgICB2YXIgcXVlcnlTdHJpbmcgPSB7fSwgcXVlcnlTdHJpbmdTZXQgPSBmYWxzZTsKICAgIHV0aWwuZWFjaChpbnB1dC5tZW1iZXJzLCBmdW5jdGlvbiAobmFtZSwgbWVtYmVyKSB7CiAgICAgIHZhciBwYXJhbVZhbHVlID0gcGFyYW1zW25hbWVdOwogICAgICBpZiAocGFyYW1WYWx1ZSA9PT0gbnVsbCB8fCBwYXJhbVZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ3VyaScpIHsKICAgICAgICB2YXIgcmVnZXggPSBuZXcgUmVnRXhwKCdcXHsnICsgbWVtYmVyLm5hbWUgKyAnKFxcKyk/XFx9Jyk7CiAgICAgICAgdXJpID0gdXJpLnJlcGxhY2UocmVnZXgsIGZ1bmN0aW9uKF8sIHBsdXMpIHsKICAgICAgICAgIHZhciBmbiA9IHBsdXMgPyB1dGlsLnVyaUVzY2FwZVBhdGggOiB1dGlsLnVyaUVzY2FwZTsKICAgICAgICAgIHJldHVybiBmbihTdHJpbmcocGFyYW1WYWx1ZSkpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ3F1ZXJ5c3RyaW5nJykgewogICAgICAgIHF1ZXJ5U3RyaW5nU2V0ID0gdHJ1ZTsKICAKICAgICAgICBpZiAobWVtYmVyLnR5cGUgPT09ICdsaXN0JykgewogICAgICAgICAgcXVlcnlTdHJpbmdbbWVtYmVyLm5hbWVdID0gcGFyYW1WYWx1ZS5tYXAoZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgIHJldHVybiB1dGlsLnVyaUVzY2FwZShtZW1iZXIubWVtYmVyLnRvV2lyZUZvcm1hdCh2YWwpLnRvU3RyaW5nKCkpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmIChtZW1iZXIudHlwZSA9PT0gJ21hcCcpIHsKICAgICAgICAgIHV0aWwuZWFjaChwYXJhbVZhbHVlLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgIHF1ZXJ5U3RyaW5nW2tleV0gPSB2YWx1ZS5tYXAoZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXRpbC51cmlFc2NhcGUoU3RyaW5nKHZhbCkpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHF1ZXJ5U3RyaW5nW2tleV0gPSB1dGlsLnVyaUVzY2FwZShTdHJpbmcodmFsdWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHF1ZXJ5U3RyaW5nW21lbWJlci5uYW1lXSA9IHV0aWwudXJpRXNjYXBlKG1lbWJlci50b1dpcmVGb3JtYXQocGFyYW1WYWx1ZSkudG9TdHJpbmcoKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAKICAgIGlmIChxdWVyeVN0cmluZ1NldCkgewogICAgICB1cmkgKz0gKHVyaS5pbmRleE9mKCc/JykgPj0gMCA/ICcmJyA6ICc/Jyk7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICB1dGlsLmFycmF5RWFjaChPYmplY3Qua2V5cyhxdWVyeVN0cmluZykuc29ydCgpLCBmdW5jdGlvbihrZXkpIHsKICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkocXVlcnlTdHJpbmdba2V5XSkpIHsKICAgICAgICAgIHF1ZXJ5U3RyaW5nW2tleV0gPSBbcXVlcnlTdHJpbmdba2V5XV07CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVlcnlTdHJpbmdba2V5XS5sZW5ndGg7IGkrKykgewogICAgICAgICAgcGFydHMucHVzaCh1dGlsLnVyaUVzY2FwZShTdHJpbmcoa2V5KSkgKyAnPScgKyBxdWVyeVN0cmluZ1trZXldW2ldKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICB1cmkgKz0gcGFydHMuam9pbignJicpOwogICAgfQogIAogICAgcmV0dXJuIHVyaTsKICB9CiAgCiAgZnVuY3Rpb24gcG9wdWxhdGVVUkkocmVxKSB7CiAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICB2YXIgaW5wdXQgPSBvcGVyYXRpb24uaW5wdXQ7CiAgCiAgICB2YXIgdXJpID0gZ2VuZXJhdGVVUkkocmVxLmh0dHBSZXF1ZXN0LmVuZHBvaW50LnBhdGgsIG9wZXJhdGlvbi5odHRwUGF0aCwgaW5wdXQsIHJlcS5wYXJhbXMpOwogICAgcmVxLmh0dHBSZXF1ZXN0LnBhdGggPSB1cmk7CiAgfQogIAogIGZ1bmN0aW9uIHBvcHVsYXRlSGVhZGVycyhyZXEpIHsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHV0aWwuZWFjaChvcGVyYXRpb24uaW5wdXQubWVtYmVycywgZnVuY3Rpb24gKG5hbWUsIG1lbWJlcikgewogICAgICB2YXIgdmFsdWUgPSByZXEucGFyYW1zW25hbWVdOwogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogIAogICAgICBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAnaGVhZGVycycgJiYgbWVtYmVyLnR5cGUgPT09ICdtYXAnKSB7CiAgICAgICAgdXRpbC5lYWNoKHZhbHVlLCBmdW5jdGlvbihrZXksIG1lbWJlclZhbHVlKSB7CiAgICAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1ttZW1iZXIubmFtZSArIGtleV0gPSBtZW1iZXJWYWx1ZTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdoZWFkZXInKSB7CiAgICAgICAgdmFsdWUgPSBtZW1iZXIudG9XaXJlRm9ybWF0KHZhbHVlKS50b1N0cmluZygpOwogICAgICAgIGlmIChtZW1iZXIuaXNKc29uVmFsdWUpIHsKICAgICAgICAgIHZhbHVlID0gdXRpbC5iYXNlNjQuZW5jb2RlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbbWVtYmVyLm5hbWVdID0gdmFsdWU7CiAgICAgIH0KICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBidWlsZFJlcXVlc3QocmVxKSB7CiAgICBwb3B1bGF0ZU1ldGhvZChyZXEpOwogICAgcG9wdWxhdGVVUkkocmVxKTsKICAgIHBvcHVsYXRlSGVhZGVycyhyZXEpOwogICAgcG9wdWxhdGVIb3N0UHJlZml4KHJlcSk7CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3RFcnJvcigpIHsKICB9CiAgCiAgZnVuY3Rpb24gZXh0cmFjdERhdGEocmVzcCkgewogICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgIHZhciBkYXRhID0ge307CiAgICB2YXIgciA9IHJlc3AuaHR0cFJlc3BvbnNlOwogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIG91dHB1dCA9IG9wZXJhdGlvbi5vdXRwdXQ7CiAgCiAgICAvLyBub3JtYWxpemUgaGVhZGVycyBuYW1lcyB0byBsb3dlci1jYXNlZCBrZXlzIGZvciBtYXRjaGluZwogICAgdmFyIGhlYWRlcnMgPSB7fTsKICAgIHV0aWwuZWFjaChyLmhlYWRlcnMsIGZ1bmN0aW9uIChrLCB2KSB7CiAgICAgIGhlYWRlcnNbay50b0xvd2VyQ2FzZSgpXSA9IHY7CiAgICB9KTsKICAKICAgIHV0aWwuZWFjaChvdXRwdXQubWVtYmVycywgZnVuY3Rpb24obmFtZSwgbWVtYmVyKSB7CiAgICAgIHZhciBoZWFkZXIgPSAobWVtYmVyLm5hbWUgfHwgbmFtZSkudG9Mb3dlckNhc2UoKTsKICAgICAgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ2hlYWRlcnMnICYmIG1lbWJlci50eXBlID09PSAnbWFwJykgewogICAgICAgIGRhdGFbbmFtZV0gPSB7fTsKICAgICAgICB2YXIgbG9jYXRpb24gPSBtZW1iZXIuaXNMb2NhdGlvbk5hbWUgPyBtZW1iZXIubmFtZSA6ICcnOwogICAgICAgIHZhciBwYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXicgKyBsb2NhdGlvbiArICcoLispJywgJ2knKTsKICAgICAgICB1dGlsLmVhY2goci5oZWFkZXJzLCBmdW5jdGlvbiAoaywgdikgewogICAgICAgICAgdmFyIHJlc3VsdCA9IGsubWF0Y2gocGF0dGVybik7CiAgICAgICAgICBpZiAocmVzdWx0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIGRhdGFbbmFtZV1bcmVzdWx0WzFdXSA9IHY7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAnaGVhZGVyJykgewogICAgICAgIGlmIChoZWFkZXJzW2hlYWRlcl0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdmFyIHZhbHVlID0gbWVtYmVyLmlzSnNvblZhbHVlID8KICAgICAgICAgICAgdXRpbC5iYXNlNjQuZGVjb2RlKGhlYWRlcnNbaGVhZGVyXSkgOgogICAgICAgICAgICBoZWFkZXJzW2hlYWRlcl07CiAgICAgICAgICBkYXRhW25hbWVdID0gbWVtYmVyLnRvVHlwZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ3N0YXR1c0NvZGUnKSB7CiAgICAgICAgZGF0YVtuYW1lXSA9IHBhcnNlSW50KHIuc3RhdHVzQ29kZSwgMTApOwogICAgICB9CiAgICB9KTsKICAKICAgIHJlc3AuZGF0YSA9IGRhdGE7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgYnVpbGRSZXF1ZXN0OiBidWlsZFJlcXVlc3QsCiAgICBleHRyYWN0RXJyb3I6IGV4dHJhY3RFcnJvciwKICAgIGV4dHJhY3REYXRhOiBleHRyYWN0RGF0YSwKICAgIGdlbmVyYXRlVVJJOiBnZW5lcmF0ZVVSSQogIH07CiAgCiAgfSx7Ii4uL3V0aWwiOjcxLCIuL2hlbHBlcnMiOjQ1fV0sNDk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBSZXN0ID0gcmVxdWlyZSgnLi9yZXN0Jyk7CiAgdmFyIEpzb24gPSByZXF1aXJlKCcuL2pzb24nKTsKICB2YXIgSnNvbkJ1aWxkZXIgPSByZXF1aXJlKCcuLi9qc29uL2J1aWxkZXInKTsKICB2YXIgSnNvblBhcnNlciA9IHJlcXVpcmUoJy4uL2pzb24vcGFyc2VyJyk7CiAgCiAgZnVuY3Rpb24gcG9wdWxhdGVCb2R5KHJlcSkgewogICAgdmFyIGJ1aWxkZXIgPSBuZXcgSnNvbkJ1aWxkZXIoKTsKICAgIHZhciBpbnB1dCA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmlucHV0OwogIAogICAgaWYgKGlucHV0LnBheWxvYWQpIHsKICAgICAgdmFyIHBhcmFtcyA9IHt9OwogICAgICB2YXIgcGF5bG9hZFNoYXBlID0gaW5wdXQubWVtYmVyc1tpbnB1dC5wYXlsb2FkXTsKICAgICAgcGFyYW1zID0gcmVxLnBhcmFtc1tpbnB1dC5wYXlsb2FkXTsKICAgICAgaWYgKHBhcmFtcyA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgCiAgICAgIGlmIChwYXlsb2FkU2hhcGUudHlwZSA9PT0gJ3N0cnVjdHVyZScpIHsKICAgICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IGJ1aWxkZXIuYnVpbGQocGFyYW1zLCBwYXlsb2FkU2hhcGUpOwogICAgICAgIGFwcGx5Q29udGVudFR5cGVIZWFkZXIocmVxKTsKICAgICAgfSBlbHNlIHsgLy8gbm9uLUpTT04gcGF5bG9hZAogICAgICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gcGFyYW1zOwogICAgICAgIGlmIChwYXlsb2FkU2hhcGUudHlwZSA9PT0gJ2JpbmFyeScgfHwgcGF5bG9hZFNoYXBlLmlzU3RyZWFtaW5nKSB7CiAgICAgICAgICBhcHBseUNvbnRlbnRUeXBlSGVhZGVyKHJlcSwgdHJ1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgYm9keSA9IGJ1aWxkZXIuYnVpbGQocmVxLnBhcmFtcywgaW5wdXQpOwogICAgICBpZiAoYm9keSAhPT0gJ3t9JyB8fCByZXEuaHR0cFJlcXVlc3QubWV0aG9kICE9PSAnR0VUJykgeyAvL2Rvbid0IHNlbmQgZW1wdHkgYm9keSBmb3IgR0VUIG1ldGhvZAogICAgICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gYm9keTsKICAgICAgfQogICAgICBhcHBseUNvbnRlbnRUeXBlSGVhZGVyKHJlcSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGFwcGx5Q29udGVudFR5cGVIZWFkZXIocmVxLCBpc0JpbmFyeSkgewogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIGlucHV0ID0gb3BlcmF0aW9uLmlucHV0OwogIAogICAgaWYgKCFyZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ10pIHsKICAgICAgdmFyIHR5cGUgPSBpc0JpbmFyeSA/ICdiaW5hcnkvb2N0ZXQtc3RyZWFtJyA6ICdhcHBsaWNhdGlvbi9qc29uJzsKICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID0gdHlwZTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogICAgUmVzdC5idWlsZFJlcXVlc3QocmVxKTsKICAKICAgIC8vIG5ldmVyIHNlbmQgYm9keSBwYXlsb2FkIG9uIEhFQUQvREVMRVRFCiAgICBpZiAoWydIRUFEJywgJ0RFTEVURSddLmluZGV4T2YocmVxLmh0dHBSZXF1ZXN0Lm1ldGhvZCkgPCAwKSB7CiAgICAgIHBvcHVsYXRlQm9keShyZXEpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RXJyb3IocmVzcCkgewogICAgSnNvbi5leHRyYWN0RXJyb3IocmVzcCk7CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICAgIFJlc3QuZXh0cmFjdERhdGEocmVzcCk7CiAgCiAgICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIHJ1bGVzID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0ub3V0cHV0IHx8IHt9OwogICAgdmFyIHBhcnNlcjsKICAgIHZhciBoYXNFdmVudE91dHB1dCA9IG9wZXJhdGlvbi5oYXNFdmVudE91dHB1dDsKICAKICAgIGlmIChydWxlcy5wYXlsb2FkKSB7CiAgICAgIHZhciBwYXlsb2FkTWVtYmVyID0gcnVsZXMubWVtYmVyc1tydWxlcy5wYXlsb2FkXTsKICAgICAgdmFyIGJvZHkgPSByZXNwLmh0dHBSZXNwb25zZS5ib2R5OwogICAgICBpZiAocGF5bG9hZE1lbWJlci5pc0V2ZW50U3RyZWFtKSB7CiAgICAgICAgcGFyc2VyID0gbmV3IEpzb25QYXJzZXIoKTsKICAgICAgICByZXNwLmRhdGFbcGF5bG9hZF0gPSB1dGlsLmNyZWF0ZUV2ZW50U3RyZWFtKAogICAgICAgICAgQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIgPyByZXNwLmh0dHBSZXNwb25zZS5zdHJlYW0gOiBib2R5LAogICAgICAgICAgcGFyc2VyLAogICAgICAgICAgcGF5bG9hZE1lbWJlcgogICAgICAgICk7CiAgICAgIH0gZWxzZSBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnc3RydWN0dXJlJyB8fCBwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdsaXN0JykgewogICAgICAgIHZhciBwYXJzZXIgPSBuZXcgSnNvblBhcnNlcigpOwogICAgICAgIHJlc3AuZGF0YVtydWxlcy5wYXlsb2FkXSA9IHBhcnNlci5wYXJzZShib2R5LCBwYXlsb2FkTWVtYmVyKTsKICAgICAgfSBlbHNlIGlmIChwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdiaW5hcnknIHx8IHBheWxvYWRNZW1iZXIuaXNTdHJlYW1pbmcpIHsKICAgICAgICByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0gPSBib2R5OwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3AuZGF0YVtydWxlcy5wYXlsb2FkXSA9IHBheWxvYWRNZW1iZXIudG9UeXBlKGJvZHkpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgZGF0YSA9IHJlc3AuZGF0YTsKICAgICAgSnNvbi5leHRyYWN0RGF0YShyZXNwKTsKICAgICAgcmVzcC5kYXRhID0gdXRpbC5tZXJnZShkYXRhLCByZXNwLmRhdGEpOwogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIGJ1aWxkUmVxdWVzdDogYnVpbGRSZXF1ZXN0LAogICAgZXh0cmFjdEVycm9yOiBleHRyYWN0RXJyb3IsCiAgICBleHRyYWN0RGF0YTogZXh0cmFjdERhdGEKICB9OwogIAogIH0seyIuLi9qc29uL2J1aWxkZXIiOjM2LCIuLi9qc29uL3BhcnNlciI6MzcsIi4uL3V0aWwiOjcxLCIuL2pzb24iOjQ2LCIuL3Jlc3QiOjQ4fV0sNTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIFJlc3QgPSByZXF1aXJlKCcuL3Jlc3QnKTsKICAKICBmdW5jdGlvbiBwb3B1bGF0ZUJvZHkocmVxKSB7CiAgICB2YXIgaW5wdXQgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dDsKICAgIHZhciBidWlsZGVyID0gbmV3IEFXUy5YTUwuQnVpbGRlcigpOwogICAgdmFyIHBhcmFtcyA9IHJlcS5wYXJhbXM7CiAgCiAgICB2YXIgcGF5bG9hZCA9IGlucHV0LnBheWxvYWQ7CiAgICBpZiAocGF5bG9hZCkgewogICAgICB2YXIgcGF5bG9hZE1lbWJlciA9IGlucHV0Lm1lbWJlcnNbcGF5bG9hZF07CiAgICAgIHBhcmFtcyA9IHBhcmFtc1twYXlsb2FkXTsKICAgICAgaWYgKHBhcmFtcyA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgCiAgICAgIGlmIChwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgICAgdmFyIHJvb3RFbGVtZW50ID0gcGF5bG9hZE1lbWJlci5uYW1lOwogICAgICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gYnVpbGRlci50b1hNTChwYXJhbXMsIHBheWxvYWRNZW1iZXIsIHJvb3RFbGVtZW50LCB0cnVlKTsKICAgICAgfSBlbHNlIHsgLy8gbm9uLXhtbCBwYXlsb2FkCiAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmJvZHkgPSBwYXJhbXM7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gYnVpbGRlci50b1hNTChwYXJhbXMsIGlucHV0LCBpbnB1dC5uYW1lIHx8CiAgICAgICAgaW5wdXQuc2hhcGUgfHwgdXRpbC5zdHJpbmcudXBwZXJGaXJzdChyZXEub3BlcmF0aW9uKSArICdSZXF1ZXN0Jyk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGJ1aWxkUmVxdWVzdChyZXEpIHsKICAgIFJlc3QuYnVpbGRSZXF1ZXN0KHJlcSk7CiAgCiAgICAvLyBuZXZlciBzZW5kIGJvZHkgcGF5bG9hZCBvbiBHRVQvSEVBRAogICAgaWYgKFsnR0VUJywgJ0hFQUQnXS5pbmRleE9mKHJlcS5odHRwUmVxdWVzdC5tZXRob2QpIDwgMCkgewogICAgICBwb3B1bGF0ZUJvZHkocmVxKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gZXh0cmFjdEVycm9yKHJlc3ApIHsKICAgIFJlc3QuZXh0cmFjdEVycm9yKHJlc3ApOwogIAogICAgdmFyIGRhdGE7CiAgICB0cnkgewogICAgICBkYXRhID0gbmV3IEFXUy5YTUwuUGFyc2VyKCkucGFyc2UocmVzcC5odHRwUmVzcG9uc2UuYm9keS50b1N0cmluZygpKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZGF0YSA9IHsKICAgICAgICBDb2RlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlLAogICAgICAgIE1lc3NhZ2U6IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c01lc3NhZ2UKICAgICAgfTsKICAgIH0KICAKICAgIGlmIChkYXRhLkVycm9ycykgZGF0YSA9IGRhdGEuRXJyb3JzOwogICAgaWYgKGRhdGEuRXJyb3IpIGRhdGEgPSBkYXRhLkVycm9yOwogICAgaWYgKGRhdGEuQ29kZSkgewogICAgICByZXNwLmVycm9yID0gdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgIGNvZGU6IGRhdGEuQ29kZSwKICAgICAgICBtZXNzYWdlOiBkYXRhLk1lc3NhZ2UKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICByZXNwLmVycm9yID0gdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgIGNvZGU6IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUsCiAgICAgICAgbWVzc2FnZTogbnVsbAogICAgICB9KTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gZXh0cmFjdERhdGEocmVzcCkgewogICAgUmVzdC5leHRyYWN0RGF0YShyZXNwKTsKICAKICAgIHZhciBwYXJzZXI7CiAgICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogICAgdmFyIGJvZHkgPSByZXNwLmh0dHBSZXNwb25zZS5ib2R5OwogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIG91dHB1dCA9IG9wZXJhdGlvbi5vdXRwdXQ7CiAgCiAgICB2YXIgaGFzRXZlbnRPdXRwdXQgPSBvcGVyYXRpb24uaGFzRXZlbnRPdXRwdXQ7CiAgCiAgICB2YXIgcGF5bG9hZCA9IG91dHB1dC5wYXlsb2FkOwogICAgaWYgKHBheWxvYWQpIHsKICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBvdXRwdXQubWVtYmVyc1twYXlsb2FkXTsKICAgICAgaWYgKHBheWxvYWRNZW1iZXIuaXNFdmVudFN0cmVhbSkgewogICAgICAgIHBhcnNlciA9IG5ldyBBV1MuWE1MLlBhcnNlcigpOwogICAgICAgIHJlc3AuZGF0YVtwYXlsb2FkXSA9IHV0aWwuY3JlYXRlRXZlbnRTdHJlYW0oCiAgICAgICAgICBBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMiA/IHJlc3AuaHR0cFJlc3BvbnNlLnN0cmVhbSA6IHJlc3AuaHR0cFJlc3BvbnNlLmJvZHksCiAgICAgICAgICBwYXJzZXIsCiAgICAgICAgICBwYXlsb2FkTWVtYmVyCiAgICAgICAgKTsKICAgICAgfSBlbHNlIGlmIChwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgICAgcGFyc2VyID0gbmV3IEFXUy5YTUwuUGFyc2VyKCk7CiAgICAgICAgcmVzcC5kYXRhW3BheWxvYWRdID0gcGFyc2VyLnBhcnNlKGJvZHkudG9TdHJpbmcoKSwgcGF5bG9hZE1lbWJlcik7CiAgICAgIH0gZWxzZSBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnYmluYXJ5JyB8fCBwYXlsb2FkTWVtYmVyLmlzU3RyZWFtaW5nKSB7CiAgICAgICAgcmVzcC5kYXRhW3BheWxvYWRdID0gYm9keTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXNwLmRhdGFbcGF5bG9hZF0gPSBwYXlsb2FkTWVtYmVyLnRvVHlwZShib2R5KTsKICAgICAgfQogICAgfSBlbHNlIGlmIChib2R5Lmxlbmd0aCA+IDApIHsKICAgICAgcGFyc2VyID0gbmV3IEFXUy5YTUwuUGFyc2VyKCk7CiAgICAgIHZhciBkYXRhID0gcGFyc2VyLnBhcnNlKGJvZHkudG9TdHJpbmcoKSwgb3V0cHV0KTsKICAgICAgdXRpbC51cGRhdGUocmVzcC5kYXRhLCBkYXRhKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICAgIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogICAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhCiAgfTsKICAKICB9LHsiLi4vY29yZSI6MTgsIi4uL3V0aWwiOjcxLCIuL3Jlc3QiOjQ4fV0sNTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIAogIGZ1bmN0aW9uIFF1ZXJ5UGFyYW1TZXJpYWxpemVyKCkgewogIH0KICAKICBRdWVyeVBhcmFtU2VyaWFsaXplci5wcm90b3R5cGUuc2VyaWFsaXplID0gZnVuY3Rpb24ocGFyYW1zLCBzaGFwZSwgZm4pIHsKICAgIHNlcmlhbGl6ZVN0cnVjdHVyZSgnJywgcGFyYW1zLCBzaGFwZSwgZm4pOwogIH07CiAgCiAgZnVuY3Rpb24gdWNmaXJzdChzaGFwZSkgewogICAgaWYgKHNoYXBlLmlzUXVlcnlOYW1lIHx8IHNoYXBlLmFwaS5wcm90b2NvbCAhPT0gJ2VjMicpIHsKICAgICAgcmV0dXJuIHNoYXBlLm5hbWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gc2hhcGUubmFtZVswXS50b1VwcGVyQ2FzZSgpICsgc2hhcGUubmFtZS5zdWJzdHIoMSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZVN0cnVjdHVyZShwcmVmaXgsIHN0cnVjdCwgcnVsZXMsIGZuKSB7CiAgICB1dGlsLmVhY2gocnVsZXMubWVtYmVycywgZnVuY3Rpb24obmFtZSwgbWVtYmVyKSB7CiAgICAgIHZhciB2YWx1ZSA9IHN0cnVjdFtuYW1lXTsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAKICAgICAgdmFyIG1lbWJlck5hbWUgPSB1Y2ZpcnN0KG1lbWJlcik7CiAgICAgIG1lbWJlck5hbWUgPSBwcmVmaXggPyBwcmVmaXggKyAnLicgKyBtZW1iZXJOYW1lIDogbWVtYmVyTmFtZTsKICAgICAgc2VyaWFsaXplTWVtYmVyKG1lbWJlck5hbWUsIHZhbHVlLCBtZW1iZXIsIGZuKTsKICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVNYXAobmFtZSwgbWFwLCBydWxlcywgZm4pIHsKICAgIHZhciBpID0gMTsKICAgIHV0aWwuZWFjaChtYXAsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgIHZhciBwcmVmaXggPSBydWxlcy5mbGF0dGVuZWQgPyAnLicgOiAnLmVudHJ5Lic7CiAgICAgIHZhciBwb3NpdGlvbiA9IHByZWZpeCArIChpKyspICsgJy4nOwogICAgICB2YXIga2V5TmFtZSA9IHBvc2l0aW9uICsgKHJ1bGVzLmtleS5uYW1lIHx8ICdrZXknKTsKICAgICAgdmFyIHZhbHVlTmFtZSA9IHBvc2l0aW9uICsgKHJ1bGVzLnZhbHVlLm5hbWUgfHwgJ3ZhbHVlJyk7CiAgICAgIHNlcmlhbGl6ZU1lbWJlcihuYW1lICsga2V5TmFtZSwga2V5LCBydWxlcy5rZXksIGZuKTsKICAgICAgc2VyaWFsaXplTWVtYmVyKG5hbWUgKyB2YWx1ZU5hbWUsIHZhbHVlLCBydWxlcy52YWx1ZSwgZm4pOwogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZUxpc3QobmFtZSwgbGlzdCwgcnVsZXMsIGZuKSB7CiAgICB2YXIgbWVtYmVyUnVsZXMgPSBydWxlcy5tZW1iZXIgfHwge307CiAgCiAgICBpZiAobGlzdC5sZW5ndGggPT09IDApIHsKICAgICAgZm4uY2FsbCh0aGlzLCBuYW1lLCBudWxsKTsKICAgICAgcmV0dXJuOwogICAgfQogIAogICAgdXRpbC5hcnJheUVhY2gobGlzdCwgZnVuY3Rpb24gKHYsIG4pIHsKICAgICAgdmFyIHN1ZmZpeCA9ICcuJyArIChuICsgMSk7CiAgICAgIGlmIChydWxlcy5hcGkucHJvdG9jb2wgPT09ICdlYzInKSB7CiAgICAgICAgLy8gRG8gbm90aGluZyBmb3IgRUMyCiAgICAgICAgc3VmZml4ID0gc3VmZml4ICsgJyc7IC8vIG1ha2UgbGludGVyIGhhcHB5CiAgICAgIH0gZWxzZSBpZiAocnVsZXMuZmxhdHRlbmVkKSB7CiAgICAgICAgaWYgKG1lbWJlclJ1bGVzLm5hbWUpIHsKICAgICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJy4nKTsKICAgICAgICAgIHBhcnRzLnBvcCgpOwogICAgICAgICAgcGFydHMucHVzaCh1Y2ZpcnN0KG1lbWJlclJ1bGVzKSk7CiAgICAgICAgICBuYW1lID0gcGFydHMuam9pbignLicpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzdWZmaXggPSAnLicgKyAobWVtYmVyUnVsZXMubmFtZSA/IG1lbWJlclJ1bGVzLm5hbWUgOiAnbWVtYmVyJykgKyBzdWZmaXg7CiAgICAgIH0KICAgICAgc2VyaWFsaXplTWVtYmVyKG5hbWUgKyBzdWZmaXgsIHYsIG1lbWJlclJ1bGVzLCBmbik7CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplTWVtYmVyKG5hbWUsIHZhbHVlLCBydWxlcywgZm4pIHsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICBpZiAocnVsZXMudHlwZSA9PT0gJ3N0cnVjdHVyZScpIHsKICAgICAgc2VyaWFsaXplU3RydWN0dXJlKG5hbWUsIHZhbHVlLCBydWxlcywgZm4pOwogICAgfSBlbHNlIGlmIChydWxlcy50eXBlID09PSAnbGlzdCcpIHsKICAgICAgc2VyaWFsaXplTGlzdChuYW1lLCB2YWx1ZSwgcnVsZXMsIGZuKTsKICAgIH0gZWxzZSBpZiAocnVsZXMudHlwZSA9PT0gJ21hcCcpIHsKICAgICAgc2VyaWFsaXplTWFwKG5hbWUsIHZhbHVlLCBydWxlcywgZm4pOwogICAgfSBlbHNlIHsKICAgICAgZm4obmFtZSwgcnVsZXMudG9XaXJlRm9ybWF0KHZhbHVlKS50b1N0cmluZygpKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBRdWVyeVBhcmFtU2VyaWFsaXplcjsKICAKICB9LHsiLi4vdXRpbCI6NzF9XSw1MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAvL3Byb3ZpZGUgcmVhbHRpbWUgY2xvY2sgZm9yIHBlcmZvcm1hbmNlIG1lYXN1cmVtZW50CiAgICBub3c6IGZ1bmN0aW9uIG5vdygpIHsKICAgICAgaWYgKHR5cGVvZiBwZXJmb3JtYW5jZSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIHBlcmZvcm1hbmNlLm5vdyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJldHVybiBwZXJmb3JtYW5jZS5ub3coKTsKICAgICAgfQogICAgICByZXR1cm4gRGF0ZS5ub3coKTsKICAgIH0KICB9OwogIAogIH0se31dLDUzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4vdXRpbCcpOwogIHZhciByZWdpb25Db25maWcgPSByZXF1aXJlKCcuL3JlZ2lvbl9jb25maWdfZGF0YS5qc29uJyk7CiAgCiAgZnVuY3Rpb24gZ2VuZXJhdGVSZWdpb25QcmVmaXgocmVnaW9uKSB7CiAgICBpZiAoIXJlZ2lvbikgcmV0dXJuIG51bGw7CiAgCiAgICB2YXIgcGFydHMgPSByZWdpb24uc3BsaXQoJy0nKTsKICAgIGlmIChwYXJ0cy5sZW5ndGggPCAzKSByZXR1cm4gbnVsbDsKICAgIHJldHVybiBwYXJ0cy5zbGljZSgwLCBwYXJ0cy5sZW5ndGggLSAyKS5qb2luKCctJykgKyAnLSonOwogIH0KICAKICBmdW5jdGlvbiBkZXJpdmVkS2V5cyhzZXJ2aWNlKSB7CiAgICB2YXIgcmVnaW9uID0gc2VydmljZS5jb25maWcucmVnaW9uOwogICAgdmFyIHJlZ2lvblByZWZpeCA9IGdlbmVyYXRlUmVnaW9uUHJlZml4KHJlZ2lvbik7CiAgICB2YXIgZW5kcG9pbnRQcmVmaXggPSBzZXJ2aWNlLmFwaS5lbmRwb2ludFByZWZpeDsKICAKICAgIHJldHVybiBbCiAgICAgIFtyZWdpb24sIGVuZHBvaW50UHJlZml4XSwKICAgICAgW3JlZ2lvblByZWZpeCwgZW5kcG9pbnRQcmVmaXhdLAogICAgICBbcmVnaW9uLCAnKiddLAogICAgICBbcmVnaW9uUHJlZml4LCAnKiddLAogICAgICBbJyonLCBlbmRwb2ludFByZWZpeF0sCiAgICAgIFsnKicsICcqJ10KICAgIF0ubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgcmV0dXJuIGl0ZW1bMF0gJiYgaXRlbVsxXSA/IGl0ZW0uam9pbignLycpIDogbnVsbDsKICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBhcHBseUNvbmZpZyhzZXJ2aWNlLCBjb25maWcpIHsKICAgIHV0aWwuZWFjaChjb25maWcsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgaWYgKGtleSA9PT0gJ2dsb2JhbEVuZHBvaW50JykgcmV0dXJuOwogICAgICBpZiAoc2VydmljZS5jb25maWdba2V5XSA9PT0gdW5kZWZpbmVkIHx8IHNlcnZpY2UuY29uZmlnW2tleV0gPT09IG51bGwpIHsKICAgICAgICBzZXJ2aWNlLmNvbmZpZ1trZXldID0gdmFsdWU7CiAgICAgIH0KICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBjb25maWd1cmVFbmRwb2ludChzZXJ2aWNlKSB7CiAgICB2YXIga2V5cyA9IGRlcml2ZWRLZXlzKHNlcnZpY2UpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICBpZiAoIWtleSkgY29udGludWU7CiAgCiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocmVnaW9uQ29uZmlnLnJ1bGVzLCBrZXkpKSB7CiAgICAgICAgdmFyIGNvbmZpZyA9IHJlZ2lvbkNvbmZpZy5ydWxlc1trZXldOwogICAgICAgIGlmICh0eXBlb2YgY29uZmlnID09PSAnc3RyaW5nJykgewogICAgICAgICAgY29uZmlnID0gcmVnaW9uQ29uZmlnLnBhdHRlcm5zW2NvbmZpZ107CiAgICAgICAgfQogIAogICAgICAgIC8vIHNldCBkdWFsc3RhY2sgZW5kcG9pbnQKICAgICAgICBpZiAoc2VydmljZS5jb25maWcudXNlRHVhbHN0YWNrICYmIHV0aWwuaXNEdWFsc3RhY2tBdmFpbGFibGUoc2VydmljZSkpIHsKICAgICAgICAgIGNvbmZpZyA9IHV0aWwuY29weShjb25maWcpOwogICAgICAgICAgY29uZmlnLmVuZHBvaW50ID0gJ3tzZXJ2aWNlfS5kdWFsc3RhY2sue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSc7CiAgICAgICAgfQogIAogICAgICAgIC8vIHNldCBnbG9iYWwgZW5kcG9pbnQKICAgICAgICBzZXJ2aWNlLmlzR2xvYmFsRW5kcG9pbnQgPSAhIWNvbmZpZy5nbG9iYWxFbmRwb2ludDsKICAKICAgICAgICAvLyBzaWduYXR1cmUgdmVyc2lvbgogICAgICAgIGlmICghY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIGNvbmZpZy5zaWduYXR1cmVWZXJzaW9uID0gJ3Y0JzsKICAKICAgICAgICAvLyBtZXJnZSBjb25maWcKICAgICAgICBhcHBseUNvbmZpZyhzZXJ2aWNlLCBjb25maWcpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IGNvbmZpZ3VyZUVuZHBvaW50OwogIAogIH0seyIuL3JlZ2lvbl9jb25maWdfZGF0YS5qc29uIjo1NCwiLi91dGlsIjo3MX1dLDU0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBtb2R1bGUuZXhwb3J0cz17CiAgICAicnVsZXMiOiB7CiAgICAgICIqLyoiOiB7CiAgICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hbWF6b25hd3MuY29tIgogICAgICB9LAogICAgICAiY24tKi8qIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbS5jbiIKICAgICAgfSwKICAgICAgIiovYnVkZ2V0cyI6ICJnbG9iYWxTU0wiLAogICAgICAiKi9jbG91ZGZyb250IjogImdsb2JhbFNTTCIsCiAgICAgICIqL2lhbSI6ICJnbG9iYWxTU0wiLAogICAgICAiKi9zdHMiOiAiZ2xvYmFsU1NMIiwKICAgICAgIiovaW1wb3J0ZXhwb3J0IjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0uYW1hem9uYXdzLmNvbSIsCiAgICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAidjIiLAogICAgICAgICJnbG9iYWxFbmRwb2ludCI6IHRydWUKICAgICAgfSwKICAgICAgIiovcm91dGU1MyI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAiaHR0cHM6Ly97c2VydmljZX0uYW1hem9uYXdzLmNvbSIsCiAgICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAidjNodHRwcyIsCiAgICAgICAgImdsb2JhbEVuZHBvaW50IjogdHJ1ZQogICAgICB9LAogICAgICAiKi93YWYiOiAiZ2xvYmFsU1NMIiwKICAgICAgInVzLWdvdi0qL2lhbSI6ICJnbG9iYWxHb3ZDbG91ZCIsCiAgICAgICJ1cy1nb3YtKi9zdHMiOiB7CiAgICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hbWF6b25hd3MuY29tIgogICAgICB9LAogICAgICAidXMtZ292LXdlc3QtMS9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAgICJ1cy13ZXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAidXMtd2VzdC0yL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICAgImV1LXdlc3QtMS9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAgICJhcC1zb3V0aGVhc3QtMS9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAgICJhcC1zb3V0aGVhc3QtMi9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAgICJhcC1ub3J0aGVhc3QtMS9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAgICJzYS1lYXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAidXMtZWFzdC0xL3MzIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0uYW1hem9uYXdzLmNvbSIsCiAgICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAiczMiCiAgICAgIH0sCiAgICAgICJ1cy1lYXN0LTEvc2RiIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0uYW1hem9uYXdzLmNvbSIsCiAgICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAidjIiCiAgICAgIH0sCiAgICAgICIqL3NkYiI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInYyIgogICAgICB9CiAgICB9LAogIAogICAgInBhdHRlcm5zIjogewogICAgICAiZ2xvYmFsU1NMIjogewogICAgICAgICJlbmRwb2ludCI6ICJodHRwczovL3tzZXJ2aWNlfS5hbWF6b25hd3MuY29tIiwKICAgICAgICAiZ2xvYmFsRW5kcG9pbnQiOiB0cnVlCiAgICAgIH0sCiAgICAgICJnbG9iYWxHb3ZDbG91ZCI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LnVzLWdvdi5hbWF6b25hd3MuY29tIgogICAgICB9LAogICAgICAiczNzaWduYXR1cmUiOiB7CiAgICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hbWF6b25hd3MuY29tIiwKICAgICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJzMyIKICAgICAgfQogICAgfQogIH0KICAKICB9LHt9XSw1NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChwcm9jZXNzKXsoZnVuY3Rpb24gKCl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHZhciBBY2NlcHRvclN0YXRlTWFjaGluZSA9IHJlcXVpcmUoJy4vc3RhdGVfbWFjaGluZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICB2YXIgZG9tYWluID0gQVdTLnV0aWwuZG9tYWluOwogIHZhciBqbWVzcGF0aCA9IHJlcXVpcmUoJ2ptZXNwYXRoJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIGhhcmRFcnJvclN0YXRlcyA9IHtzdWNjZXNzOiAxLCBlcnJvcjogMSwgY29tcGxldGU6IDF9OwogIAogIGZ1bmN0aW9uIGlzVGVybWluYWxTdGF0ZShtYWNoaW5lKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGhhcmRFcnJvclN0YXRlcywgbWFjaGluZS5fYXNtLmN1cnJlbnRTdGF0ZSk7CiAgfQogIAogIHZhciBmc20gPSBuZXcgQWNjZXB0b3JTdGF0ZU1hY2hpbmUoKTsKICBmc20uc2V0dXBTdGF0ZXMgPSBmdW5jdGlvbigpIHsKICAgIHZhciB0cmFuc2l0aW9uID0gZnVuY3Rpb24oXywgZG9uZSkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHNlbGYuX2hhbHRIYW5kbGVyc09uRXJyb3IgPSBmYWxzZTsKICAKICAgICAgc2VsZi5lbWl0KHNlbGYuX2FzbS5jdXJyZW50U3RhdGUsIGZ1bmN0aW9uKGVycikgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIGlmIChpc1Rlcm1pbmFsU3RhdGUoc2VsZikpIHsKICAgICAgICAgICAgaWYgKGRvbWFpbiAmJiBzZWxmLmRvbWFpbiBpbnN0YW5jZW9mIGRvbWFpbi5Eb21haW4pIHsKICAgICAgICAgICAgICBlcnIuZG9tYWluRW1pdHRlciA9IHNlbGY7CiAgICAgICAgICAgICAgZXJyLmRvbWFpbiA9IHNlbGYuZG9tYWluOwogICAgICAgICAgICAgIGVyci5kb21haW5UaHJvd24gPSBmYWxzZTsKICAgICAgICAgICAgICBzZWxmLmRvbWFpbi5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxmLnJlc3BvbnNlLmVycm9yID0gZXJyOwogICAgICAgICAgICBkb25lKGVycik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRvbmUoc2VsZi5yZXNwb25zZS5lcnJvcik7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgIH07CiAgCiAgICB0aGlzLmFkZFN0YXRlKCd2YWxpZGF0ZScsICdidWlsZCcsICdlcnJvcicsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnYnVpbGQnLCAnYWZ0ZXJCdWlsZCcsICdyZXN0YXJ0JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdhZnRlckJ1aWxkJywgJ3NpZ24nLCAncmVzdGFydCcsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnc2lnbicsICdzZW5kJywgJ3JldHJ5JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdyZXRyeScsICdhZnRlclJldHJ5JywgJ2FmdGVyUmV0cnknLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ2FmdGVyUmV0cnknLCAnc2lnbicsICdlcnJvcicsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnc2VuZCcsICd2YWxpZGF0ZVJlc3BvbnNlJywgJ3JldHJ5JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCd2YWxpZGF0ZVJlc3BvbnNlJywgJ2V4dHJhY3REYXRhJywgJ2V4dHJhY3RFcnJvcicsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnZXh0cmFjdEVycm9yJywgJ2V4dHJhY3REYXRhJywgJ3JldHJ5JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdleHRyYWN0RGF0YScsICdzdWNjZXNzJywgJ3JldHJ5JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdyZXN0YXJ0JywgJ2J1aWxkJywgJ2Vycm9yJywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdzdWNjZXNzJywgJ2NvbXBsZXRlJywgJ2NvbXBsZXRlJywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdlcnJvcicsICdjb21wbGV0ZScsICdjb21wbGV0ZScsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnY29tcGxldGUnLCBudWxsLCBudWxsLCB0cmFuc2l0aW9uKTsKICB9OwogIGZzbS5zZXR1cFN0YXRlcygpOwogIAogIC8qKgogICAqICMjIEFzeW5jaHJvbm91cyBSZXF1ZXN0cwogICAqCiAgICogQWxsIHJlcXVlc3RzIG1hZGUgdGhyb3VnaCB0aGUgU0RLIGFyZSBhc3luY2hyb25vdXMgYW5kIHVzZSBhCiAgICogY2FsbGJhY2sgaW50ZXJmYWNlLiBFYWNoIHNlcnZpY2UgbWV0aG9kIHRoYXQga2lja3Mgb2ZmIGEgcmVxdWVzdAogICAqIHJldHVybnMgYW4gYEFXUy5SZXF1ZXN0YCBvYmplY3QgdGhhdCB5b3UgY2FuIHVzZSB0byByZWdpc3RlcgogICAqIGNhbGxiYWNrcy4KICAgKgogICAqIEZvciBleGFtcGxlLCB0aGUgZm9sbG93aW5nIHNlcnZpY2UgbWV0aG9kIHJldHVybnMgdGhlIHJlcXVlc3QKICAgKiBvYmplY3QgYXMgInJlcXVlc3QiLCB3aGljaCBjYW4gYmUgdXNlZCB0byByZWdpc3RlciBjYWxsYmFja3M6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogLy8gcmVxdWVzdCBpcyBhbiBBV1MuUmVxdWVzdCBvYmplY3QKICAgKiB2YXIgcmVxdWVzdCA9IGVjMi5kZXNjcmliZUluc3RhbmNlcygpOwogICAqCiAgICogLy8gcmVnaXN0ZXIgY2FsbGJhY2tzIG9uIHJlcXVlc3QgdG8gcmV0cmlldmUgcmVzcG9uc2UgZGF0YQogICAqIHJlcXVlc3Qub24oJ3N1Y2Nlc3MnLCBmdW5jdGlvbihyZXNwb25zZSkgewogICAqICAgY29uc29sZS5sb2cocmVzcG9uc2UuZGF0YSk7CiAgICogfSk7CiAgICogYGBgCiAgICoKICAgKiBXaGVuIGEgcmVxdWVzdCBpcyByZWFkeSB0byBiZSBzZW50LCB0aGUge3NlbmR9IG1ldGhvZCBzaG91bGQKICAgKiBiZSBjYWxsZWQ6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogcmVxdWVzdC5zZW5kKCk7CiAgICogYGBgCiAgICoKICAgKiBTaW5jZSByZWdpc3RlcmVkIGNhbGxiYWNrcyBtYXkgb3IgbWF5IG5vdCBiZSBpZGVtcG90ZW50LCByZXF1ZXN0cyBzaG91bGQgb25seQogICAqIGJlIHNlbnQgb25jZS4gVG8gcGVyZm9ybSB0aGUgc2FtZSBvcGVyYXRpb24gbXVsdGlwbGUgdGltZXMsIHlvdSB3aWxsIG5lZWQgdG8KICAgKiBjcmVhdGUgbXVsdGlwbGUgcmVxdWVzdCBvYmplY3RzLCBlYWNoIHdpdGggaXRzIG93biByZWdpc3RlcmVkIGNhbGxiYWNrcy4KICAgKgogICAqICMjIFJlbW92aW5nIERlZmF1bHQgTGlzdGVuZXJzIGZvciBFdmVudHMKICAgKgogICAqIFJlcXVlc3Qgb2JqZWN0cyBhcmUgYnVpbHQgd2l0aCBkZWZhdWx0IGxpc3RlbmVycyBmb3IgdGhlIHZhcmlvdXMgZXZlbnRzLAogICAqIGRlcGVuZGluZyBvbiB0aGUgc2VydmljZSB0eXBlLiBJbiBzb21lIGNhc2VzLCB5b3UgbWF5IHdhbnQgdG8gcmVtb3ZlCiAgICogc29tZSBidWlsdC1pbiBsaXN0ZW5lcnMgdG8gY3VzdG9taXplIGJlaGF2aW91ci4gRG9pbmcgdGhpcyByZXF1aXJlcwogICAqIGFjY2VzcyB0byB0aGUgYnVpbHQtaW4gbGlzdGVuZXIgZnVuY3Rpb25zLCB3aGljaCBhcmUgZXhwb3NlZCB0aHJvdWdoCiAgICogdGhlIHtBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZX0gbmFtZXNwYWNlLiBGb3IgaW5zdGFuY2UsIHlvdSBtYXkKICAgKiB3YW50IHRvIGN1c3RvbWl6ZSB0aGUgSFRUUCBoYW5kbGVyIHVzZWQgd2hlbiBzZW5kaW5nIGEgcmVxdWVzdC4gSW4gdGhpcwogICAqIGNhc2UsIHlvdSBjYW4gcmVtb3ZlIHRoZSBidWlsdC1pbiBsaXN0ZW5lciBhc3NvY2lhdGVkIHdpdGggdGhlICdzZW5kJwogICAqIGV2ZW50LCB0aGUge0FXUy5FdmVudExpc3RlbmVycy5Db3JlLlNFTkR9IGxpc3RlbmVyIGFuZCBhZGQgeW91ciBvd24uCiAgICoKICAgKiAjIyBNdWx0aXBsZSBDYWxsYmFja3MgYW5kIENoYWluaW5nCiAgICoKICAgKiBZb3UgY2FuIHJlZ2lzdGVyIG11bHRpcGxlIGNhbGxiYWNrcyBvbiBhbnkgcmVxdWVzdCBvYmplY3QuIFRoZQogICAqIGNhbGxiYWNrcyBjYW4gYmUgcmVnaXN0ZXJlZCBmb3IgZGlmZmVyZW50IGV2ZW50cywgb3IgYWxsIGZvciB0aGUKICAgKiBzYW1lIGV2ZW50LiBJbiBhZGRpdGlvbiwgeW91IGNhbiBjaGFpbiBjYWxsYmFjayByZWdpc3RyYXRpb24sIGZvcgogICAqIGV4YW1wbGU6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogcmVxdWVzdC4KICAgKiAgIG9uKCdzdWNjZXNzJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgKiAgICAgY29uc29sZS5sb2coIlN1Y2Nlc3MhIik7CiAgICogICB9KS4KICAgKiAgIG9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycm9yLCByZXNwb25zZSkgewogICAqICAgICBjb25zb2xlLmxvZygiRXJyb3IhIik7CiAgICogICB9KS4KICAgKiAgIG9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICogICAgIGNvbnNvbGUubG9nKCJBbHdheXMhIik7CiAgICogICB9KS4KICAgKiAgIHNlbmQoKTsKICAgKiBgYGAKICAgKgogICAqIFRoZSBhYm92ZSBleGFtcGxlIHdpbGwgcHJpbnQgZWl0aGVyICJTdWNjZXNzISBBbHdheXMhIiwgb3IgIkVycm9yISBBbHdheXMhIiwKICAgKiBkZXBlbmRpbmcgb24gd2hldGhlciB0aGUgcmVxdWVzdCBzdWNjZWVkZWQgb3Igbm90LgogICAqCiAgICogQCFhdHRyaWJ1dGUgaHR0cFJlcXVlc3QKICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBIVFRQIFByb3BlcnRpZXMKICAgKiAgIEByZXR1cm4gW0FXUy5IdHRwUmVxdWVzdF0gdGhlIHJhdyBIVFRQIHJlcXVlc3Qgb2JqZWN0CiAgICogICAgIGNvbnRhaW5pbmcgcmVxdWVzdCBoZWFkZXJzIGFuZCBib2R5IGluZm9ybWF0aW9uCiAgICogICAgIHNlbnQgYnkgdGhlIHNlcnZpY2UuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzdGFydFRpbWUKICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBPcGVyYXRpb24gUHJvcGVydGllcwogICAqICAgQHJldHVybiBbRGF0ZV0gdGhlIHRpbWUgdGhhdCB0aGUgcmVxdWVzdCBzdGFydGVkCiAgICoKICAgKiBAIWdyb3VwIFJlcXVlc3QgQnVpbGRpbmcgRXZlbnRzCiAgICoKICAgKiBAIWV2ZW50IHZhbGlkYXRlKHJlcXVlc3QpCiAgICogICBUcmlnZ2VyZWQgd2hlbiBhIHJlcXVlc3QgaXMgYmVpbmcgdmFsaWRhdGVkLiBMaXN0ZW5lcnMKICAgKiAgIHNob3VsZCB0aHJvdyBhbiBlcnJvciBpZiB0aGUgcmVxdWVzdCBzaG91bGQgbm90IGJlIHNlbnQuCiAgICogICBAcGFyYW0gcmVxdWVzdCBbUmVxdWVzdF0gdGhlIHJlcXVlc3Qgb2JqZWN0IGJlaW5nIHNlbnQKICAgKiAgIEBzZWUgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfQ1JFREVOVElBTFMKICAgKiAgIEBzZWUgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUkVHSU9OCiAgICogICBAZXhhbXBsZSBFbnN1cmluZyB0aGF0IGEgY2VydGFpbiBwYXJhbWV0ZXIgaXMgc2V0IGJlZm9yZSBzZW5kaW5nIGEgcmVxdWVzdAogICAqICAgICB2YXIgcmVxID0gczMucHV0T2JqZWN0KHBhcmFtcyk7CiAgICogICAgIHJlcS5vbigndmFsaWRhdGUnLCBmdW5jdGlvbigpIHsKICAgKiAgICAgICBpZiAoIXJlcS5wYXJhbXMuQm9keS5tYXRjaCgvXkhlbGxvXHMvKSkgewogICAqICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCb2R5IG11c3Qgc3RhcnQgd2l0aCAiSGVsbG8gIicpOwogICAqICAgICAgIH0KICAgKiAgICAgfSk7CiAgICogICAgIHJlcS5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgeyAuLi4gfSk7CiAgICoKICAgKiBAIWV2ZW50IGJ1aWxkKHJlcXVlc3QpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgcmVxdWVzdCBwYXlsb2FkIGlzIGJlaW5nIGJ1aWx0LiBMaXN0ZW5lcnMKICAgKiAgIHNob3VsZCBmaWxsIHRoZSBuZWNlc3NhcnkgaW5mb3JtYXRpb24gdG8gc2VuZCB0aGUgcmVxdWVzdAogICAqICAgb3ZlciBIVFRQLgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+dmFsaWRhdGUpCiAgICogICBAZXhhbXBsZSBBZGQgYSBjdXN0b20gSFRUUCBoZWFkZXIgdG8gYSByZXF1ZXN0CiAgICogICAgIHZhciByZXEgPSBzMy5wdXRPYmplY3QocGFyYW1zKTsKICAgKiAgICAgcmVxLm9uKCdidWlsZCcsIGZ1bmN0aW9uKCkgewogICAqICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDdXN0b20tSGVhZGVyJ10gPSAndmFsdWUnOwogICAqICAgICB9KTsKICAgKiAgICAgcmVxLnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7IC4uLiB9KTsKICAgKgogICAqIEAhZXZlbnQgc2lnbihyZXF1ZXN0KQogICAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIHJlcXVlc3QgaXMgYmVpbmcgc2lnbmVkLiBMaXN0ZW5lcnMgc2hvdWxkCiAgICogICBhZGQgdGhlIGNvcnJlY3QgYXV0aGVudGljYXRpb24gaGVhZGVycyBhbmQvb3IgYWRqdXN0IHRoZSBib2R5LAogICAqICAgZGVwZW5kaW5nIG9uIHRoZSBhdXRoZW50aWNhdGlvbiBtZWNoYW5pc20gYmVpbmcgdXNlZC4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnZhbGlkYXRlKQogICAqCiAgICogQCFncm91cCBSZXF1ZXN0IFNlbmRpbmcgRXZlbnRzCiAgICoKICAgKiBAIWV2ZW50IHNlbmQocmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgcmVxdWVzdCBpcyByZWFkeSB0byBiZSBzZW50LiBMaXN0ZW5lcnMKICAgKiAgIHNob3VsZCBjYWxsIHRoZSB1bmRlcmx5aW5nIHRyYW5zcG9ydCBsYXllciB0byBpbml0aWF0ZQogICAqICAgdGhlIHNlbmRpbmcgb2YgdGhlIHJlcXVlc3QuCiAgICogICBAcGFyYW0gcmVzcG9uc2UgW1Jlc3BvbnNlXSB0aGUgcmVzcG9uc2Ugb2JqZWN0CiAgICogICBAY29udGV4dCBbUmVxdWVzdF0gdGhlIHJlcXVlc3Qgb2JqZWN0IHRoYXQgd2FzIHNlbnQKICAgKiAgIEBzZWUgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuU0VORAogICAqCiAgICogQCFldmVudCByZXRyeShyZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIGEgcmVxdWVzdCBmYWlsZWQgYW5kIG1pZ2h0IG5lZWQgdG8gYmUgcmV0cmllZCBvciByZWRpcmVjdGVkLgogICAqICAgSWYgdGhlIHJlc3BvbnNlIGlzIHJldHJ5YWJsZSwgdGhlIGxpc3RlbmVyIHNob3VsZCBzZXQgdGhlCiAgICogICBgcmVzcG9uc2UuZXJyb3IucmV0cnlhYmxlYCBwcm9wZXJ0eSB0byBgdHJ1ZWAsIGFuZCBvcHRpb25hbGx5IHNldAogICAqICAgYHJlc3BvbnNlLmVycm9yLnJldHJ5RGVsYXlgIHRvIHRoZSBtaWxsaXNlY29uZCBkZWxheSBmb3IgdGhlIG5leHQgYXR0ZW1wdC4KICAgKiAgIEluIHRoZSBjYXNlIG9mIGEgcmVkaXJlY3QsIGByZXNwb25zZS5lcnJvci5yZWRpcmVjdGAgc2hvdWxkIGJlIHNldCB0bwogICAqICAgYHRydWVgIHdpdGggYHJldHJ5RGVsYXlgIHNldCB0byBhbiBvcHRpb25hbCBkZWxheSBvbiB0aGUgbmV4dCByZXF1ZXN0LgogICAqCiAgICogICBJZiBhIGxpc3RlbmVyIGRlY2lkZXMgdGhhdCBhIHJlcXVlc3Qgc2hvdWxkIG5vdCBiZSByZXRyaWVkLAogICAqICAgaXQgc2hvdWxkIHNldCBib3RoIGByZXRyeWFibGVgIGFuZCBgcmVkaXJlY3RgIHRvIGZhbHNlLgogICAqCiAgICogICBOb3RlIHRoYXQgYSByZXRyeWFibGUgZXJyb3Igd2lsbCBiZSByZXRyaWVkIGF0IG1vc3QKICAgKiAgIHtBV1MuQ29uZmlnLm1heFJldHJpZXN9IHRpbWVzIChiYXNlZCBvbiB0aGUgc2VydmljZSBvYmplY3QncyBjb25maWcpLgogICAqICAgU2ltaWxhcmx5LCBhIHJlcXVlc3QgdGhhdCBpcyByZWRpcmVjdGVkIHdpbGwgb25seSByZWRpcmVjdCBhdCBtb3N0CiAgICogICB7QVdTLkNvbmZpZy5tYXhSZWRpcmVjdHN9IHRpbWVzLgogICAqCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGV4YW1wbGUgQWRkaW5nIGEgY3VzdG9tIHJldHJ5IGZvciBhIDQwNCByZXNwb25zZQogICAqICAgICByZXF1ZXN0Lm9uKCdyZXRyeScsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICogICAgICAgLy8gdGhpcyByZXNvdXJjZSBpcyBub3QgeWV0IGF2YWlsYWJsZSwgd2FpdCAxMCBzZWNvbmRzIHRvIGdldCBpdCBhZ2FpbgogICAqICAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gNDA0ICYmIHJlc3BvbnNlLmVycm9yKSB7CiAgICogICAgICAgICByZXNwb25zZS5lcnJvci5yZXRyeWFibGUgPSB0cnVlOyAgIC8vIHJldHJ5IHRoaXMgZXJyb3IKICAgKiAgICAgICAgIHJlc3BvbnNlLmVycm9yLnJldHJ5RGVsYXkgPSAxMDAwMDsgLy8gd2FpdCAxMCBzZWNvbmRzCiAgICogICAgICAgfQogICAqICAgICB9KTsKICAgKgogICAqIEAhZ3JvdXAgRGF0YSBQYXJzaW5nIEV2ZW50cwogICAqCiAgICogQCFldmVudCBleHRyYWN0RXJyb3IocmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgb24gYWxsIG5vbi0yeHggcmVxdWVzdHMgc28gdGhhdCBsaXN0ZW5lcnMgY2FuIGV4dHJhY3QKICAgKiAgIGVycm9yIGRldGFpbHMgZnJvbSB0aGUgcmVzcG9uc2UgYm9keS4gTGlzdGVuZXJzIHRvIHRoaXMgZXZlbnQKICAgKiAgIHNob3VsZCBzZXQgdGhlIGByZXNwb25zZS5lcnJvcmAgcHJvcGVydHkuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQCFldmVudCBleHRyYWN0RGF0YShyZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCBpbiBzdWNjZXNzZnVsIHJlcXVlc3RzIHRvIGFsbG93IGxpc3RlbmVycyB0bwogICAqICAgZGUtc2VyaWFsaXplIHRoZSByZXNwb25zZSBib2R5IGludG8gYHJlc3BvbnNlLmRhdGFgLgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEAhZ3JvdXAgQ29tcGxldGlvbiBFdmVudHMKICAgKgogICAqIEAhZXZlbnQgc3VjY2VzcyhyZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSByZXF1ZXN0IGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkuCiAgICogICBgcmVzcG9uc2UuZGF0YWAgd2lsbCBjb250YWluIHRoZSByZXNwb25zZSBkYXRhIGFuZAogICAqICAgYHJlc3BvbnNlLmVycm9yYCB3aWxsIGJlIG51bGwuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQCFldmVudCBlcnJvcihlcnJvciwgcmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiBhbiBlcnJvciBvY2N1cnMgYXQgYW55IHBvaW50IGR1cmluZyB0aGUKICAgKiAgIHJlcXVlc3QuIGByZXNwb25zZS5lcnJvcmAgd2lsbCBjb250YWluIGRldGFpbHMgYWJvdXQgdGhlIGVycm9yCiAgICogICB0aGF0IG9jY3VycmVkLiBgcmVzcG9uc2UuZGF0YWAgd2lsbCBiZSBudWxsLgogICAqICAgQHBhcmFtIGVycm9yIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCBjb250YWluaW5nIGRldGFpbHMgYWJvdXQKICAgKiAgICAgdGhlIGVycm9yIHRoYXQgb2NjdXJyZWQuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQCFldmVudCBjb21wbGV0ZShyZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuZXZlciBhIHJlcXVlc3QgY3ljbGUgY29tcGxldGVzLiBgcmVzcG9uc2UuZXJyb3JgCiAgICogICBzaG91bGQgYmUgY2hlY2tlZCwgc2luY2UgdGhlIHJlcXVlc3QgbWF5IGhhdmUgZmFpbGVkLgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEAhZ3JvdXAgSFRUUCBFdmVudHMKICAgKgogICAqIEAhZXZlbnQgaHR0cEhlYWRlcnMoc3RhdHVzQ29kZSwgaGVhZGVycywgcmVzcG9uc2UsIHN0YXR1c01lc3NhZ2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiBoZWFkZXJzIGFyZSBzZW50IGJ5IHRoZSByZW1vdGUgc2VydmVyCiAgICogICBAcGFyYW0gc3RhdHVzQ29kZSBbSW50ZWdlcl0gdGhlIEhUVFAgcmVzcG9uc2UgY29kZQogICAqICAgQHBhcmFtIGhlYWRlcnMgW21hcDxTdHJpbmcsU3RyaW5nPl0gdGhlIHJlc3BvbnNlIGhlYWRlcnMKICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAcGFyYW0gc3RhdHVzTWVzc2FnZSBbU3RyaW5nXSBBIHN0YXR1cyBtZXNzYWdlIGNvcnJlc3BvbmRpbmcgdG8gdGhlIEhUVFAKICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlIGNvZGUKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEAhZXZlbnQgaHR0cERhdGEoY2h1bmssIHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gZGF0YSBpcyBzZW50IGJ5IHRoZSByZW1vdGUgc2VydmVyCiAgICogICBAcGFyYW0gY2h1bmsgW0J1ZmZlcl0gdGhlIGJ1ZmZlciBkYXRhIGNvbnRhaW5pbmcgdGhlIG5leHQgZGF0YSBjaHVuawogICAqICAgICBmcm9tIHRoZSBzZXJ2ZXIKICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAc2VlIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLkhUVFBfREFUQQogICAqCiAgICogQCFldmVudCBodHRwVXBsb2FkUHJvZ3Jlc3MocHJvZ3Jlc3MsIHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIEhUVFAgcmVxdWVzdCBoYXMgdXBsb2FkZWQgbW9yZSBkYXRhCiAgICogICBAcGFyYW0gcHJvZ3Jlc3MgW21hcF0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGBsb2FkZWRgIGFuZCBgdG90YWxgIGJ5dGVzCiAgICogICAgIG9mIHRoZSByZXF1ZXN0LgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBub3RlIFRoaXMgZXZlbnQgd2lsbCBub3QgYmUgZW1pdHRlZCBpbiBOb2RlLmpzIDAuOC54LgogICAqCiAgICogQCFldmVudCBodHRwRG93bmxvYWRQcm9ncmVzcyhwcm9ncmVzcywgcmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgSFRUUCByZXF1ZXN0IGhhcyBkb3dubG9hZGVkIG1vcmUgZGF0YQogICAqICAgQHBhcmFtIHByb2dyZXNzIFttYXBdIEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBgbG9hZGVkYCBhbmQgYHRvdGFsYCBieXRlcwogICAqICAgICBvZiB0aGUgcmVxdWVzdC4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAbm90ZSBUaGlzIGV2ZW50IHdpbGwgbm90IGJlIGVtaXR0ZWQgaW4gTm9kZS5qcyAwLjgueC4KICAgKgogICAqIEAhZXZlbnQgaHR0cEVycm9yKGVycm9yLCByZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSBIVFRQIHJlcXVlc3QgZmFpbGVkCiAgICogICBAcGFyYW0gZXJyb3IgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHRoYXQgd2FzIHRocm93bgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEAhZXZlbnQgaHR0cERvbmUocmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgc2VydmVyIGlzIGZpbmlzaGVkIHNlbmRpbmcgZGF0YQogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEBzZWUgQVdTLlJlc3BvbnNlCiAgICovCiAgQVdTLlJlcXVlc3QgPSBpbmhlcml0KHsKICAKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHJlcXVlc3QgZm9yIGFuIG9wZXJhdGlvbiBvbiBhIGdpdmVuIHNlcnZpY2Ugd2l0aAogICAgICogYSBzZXQgb2YgaW5wdXQgcGFyYW1ldGVycy4KICAgICAqCiAgICAgKiBAcGFyYW0gc2VydmljZSBbQVdTLlNlcnZpY2VdIHRoZSBzZXJ2aWNlIHRvIHBlcmZvcm0gdGhlIG9wZXJhdGlvbiBvbgogICAgICogQHBhcmFtIG9wZXJhdGlvbiBbU3RyaW5nXSB0aGUgb3BlcmF0aW9uIHRvIHBlcmZvcm0gb24gdGhlIHNlcnZpY2UKICAgICAqIEBwYXJhbSBwYXJhbXMgW09iamVjdF0gcGFyYW1ldGVycyB0byBzZW5kIHRvIHRoZSBvcGVyYXRpb24uCiAgICAgKiAgIFNlZSB0aGUgb3BlcmF0aW9uJ3MgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIGZvcm1hdCBvZiB0aGUKICAgICAqICAgcGFyYW1ldGVycy4KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFJlcXVlc3Qoc2VydmljZSwgb3BlcmF0aW9uLCBwYXJhbXMpIHsKICAgICAgdmFyIGVuZHBvaW50ID0gc2VydmljZS5lbmRwb2ludDsKICAgICAgdmFyIHJlZ2lvbiA9IHNlcnZpY2UuY29uZmlnLnJlZ2lvbjsKICAgICAgdmFyIGN1c3RvbVVzZXJBZ2VudCA9IHNlcnZpY2UuY29uZmlnLmN1c3RvbVVzZXJBZ2VudDsKICAKICAgICAgLy8gZ2xvYmFsIGVuZHBvaW50cyBzaWduIGFzIHVzLWVhc3QtMQogICAgICBpZiAoc2VydmljZS5pc0dsb2JhbEVuZHBvaW50KSByZWdpb24gPSAndXMtZWFzdC0xJzsKICAKICAgICAgdGhpcy5kb21haW4gPSBkb21haW4gJiYgZG9tYWluLmFjdGl2ZTsKICAgICAgdGhpcy5zZXJ2aWNlID0gc2VydmljZTsKICAgICAgdGhpcy5vcGVyYXRpb24gPSBvcGVyYXRpb247CiAgICAgIHRoaXMucGFyYW1zID0gcGFyYW1zIHx8IHt9OwogICAgICB0aGlzLmh0dHBSZXF1ZXN0ID0gbmV3IEFXUy5IdHRwUmVxdWVzdChlbmRwb2ludCwgcmVnaW9uKTsKICAgICAgdGhpcy5odHRwUmVxdWVzdC5hcHBlbmRUb1VzZXJBZ2VudChjdXN0b21Vc2VyQWdlbnQpOwogICAgICB0aGlzLnN0YXJ0VGltZSA9IHNlcnZpY2UuZ2V0U2tld0NvcnJlY3RlZERhdGUoKTsKICAKICAgICAgdGhpcy5yZXNwb25zZSA9IG5ldyBBV1MuUmVzcG9uc2UodGhpcyk7CiAgICAgIHRoaXMuX2FzbSA9IG5ldyBBY2NlcHRvclN0YXRlTWFjaGluZShmc20uc3RhdGVzLCAndmFsaWRhdGUnKTsKICAgICAgdGhpcy5faGFsdEhhbmRsZXJzT25FcnJvciA9IGZhbHNlOwogIAogICAgICBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuZW1pdCA9IHRoaXMuZW1pdEV2ZW50OwogICAgfSwKICAKICAgIC8qKgogICAgICogQCFncm91cCBTZW5kaW5nIGEgUmVxdWVzdAogICAgICovCiAgCiAgICAvKioKICAgICAqIEBvdmVybG9hZCBzZW5kKGNhbGxiYWNrID0gbnVsbCkKICAgICAqICAgU2VuZHMgdGhlIHJlcXVlc3Qgb2JqZWN0LgogICAgICoKICAgICAqICAgQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgICAqICAgICBJZiBhIGNhbGxiYWNrIGlzIHN1cHBsaWVkLCBpdCBpcyBjYWxsZWQgd2hlbiBhIHJlc3BvbnNlIGlzIHJldHVybmVkCiAgICAgKiAgICAgZnJvbSB0aGUgc2VydmljZS4KICAgICAqICAgICBAY29udGV4dCBbQVdTLlJlcXVlc3RdIHRoZSByZXF1ZXN0IG9iamVjdCBiZWluZyBzZW50LgogICAgICogICAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICAgKiAgICAgICBTZXQgdG8gYG51bGxgIGlmIHRoZSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwuCiAgICAgKiAgICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgZGF0YSByZXR1cm5lZCBmcm9tCiAgICAgKiAgICAgICB0aGUgcmVxdWVzdC4gU2V0IHRvIGBudWxsYCBpZiBhIHJlcXVlc3QgZXJyb3Igb2NjdXJzLgogICAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRoIGEgY2FsbGJhY2sKICAgICAqICAgICByZXF1ZXN0ID0gczMucHV0T2JqZWN0KHtCdWNrZXQ6ICdidWNrZXQnLCBLZXk6ICdrZXknfSk7CiAgICAgKiAgICAgcmVxdWVzdC5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgeyBjb25zb2xlLmxvZyhlcnIsIGRhdGEpOyB9KTsKICAgICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3Qgd2l0aCBubyBjYWxsYmFjayAodXNpbmcgZXZlbnQgaGFuZGxlcnMpCiAgICAgKiAgICAgcmVxdWVzdCA9IHMzLnB1dE9iamVjdCh7QnVja2V0OiAnYnVja2V0JywgS2V5OiAna2V5J30pOwogICAgICogICAgIHJlcXVlc3Qub24oJ2NvbXBsZXRlJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsgLi4uIH0pOyAvLyByZWdpc3RlciBhIGNhbGxiYWNrCiAgICAgKiAgICAgcmVxdWVzdC5zZW5kKCk7CiAgICAgKi8KICAgIHNlbmQ6IGZ1bmN0aW9uIHNlbmQoY2FsbGJhY2spIHsKICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgLy8gYXBwZW5kIHRvIHVzZXIgYWdlbnQKICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0LmFwcGVuZFRvVXNlckFnZW50KCdjYWxsYmFjaycpOwogICAgICAgIHRoaXMub24oJ2NvbXBsZXRlJywgZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICAgIGNhbGxiYWNrLmNhbGwocmVzcCwgcmVzcC5lcnJvciwgcmVzcC5kYXRhKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICB0aGlzLnJ1blRvKCk7CiAgCiAgICAgIHJldHVybiB0aGlzLnJlc3BvbnNlOwogICAgfSwKICAKICAgIC8qKgogICAgICogQCFtZXRob2QgIHByb21pc2UoKQogICAgICogICBTZW5kcyB0aGUgcmVxdWVzdCBhbmQgcmV0dXJucyBhICd0aGVuYWJsZScgcHJvbWlzZS4KICAgICAqCiAgICAgKiAgIFR3byBjYWxsYmFja3MgY2FuIGJlIHByb3ZpZGVkIHRvIHRoZSBgdGhlbmAgbWV0aG9kIG9uIHRoZSByZXR1cm5lZCBwcm9taXNlLgogICAgICogICBUaGUgZmlyc3QgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLCBhbmQgdGhlIHNlY29uZAogICAgICogICBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAqICAgQGNhbGxiYWNrIGZ1bGZpbGxlZENhbGxiYWNrIGZ1bmN0aW9uKGRhdGEpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZC4KICAgICAqICAgICBAcGFyYW0gZGF0YSBbT2JqZWN0XSB0aGUgZGUtc2VyaWFsaXplZCBkYXRhIHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICAgKiAgIEBjYWxsYmFjayByZWplY3RlZENhbGxiYWNrIGZ1bmN0aW9uKGVycm9yKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAqICAgICBAcGFyYW0gZXJyb3IgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICAgKiAgIEByZXR1cm4gW1Byb21pc2VdIEEgcHJvbWlzZSB0aGF0IHJlcHJlc2VudHMgdGhlIHN0YXRlIG9mIHRoZSByZXF1ZXN0LgogICAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB1c2luZyBwcm9taXNlcy4KICAgICAqICAgICB2YXIgcmVxdWVzdCA9IHMzLnB1dE9iamVjdCh7QnVja2V0OiAnYnVja2V0JywgS2V5OiAna2V5J30pOwogICAgICogICAgIHZhciByZXN1bHQgPSByZXF1ZXN0LnByb21pc2UoKTsKICAgICAqICAgICByZXN1bHQudGhlbihmdW5jdGlvbihkYXRhKSB7IC4uLiB9LCBmdW5jdGlvbihlcnJvcikgeyAuLi4gfSk7CiAgICAgKi8KICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGJ1aWxkOiBmdW5jdGlvbiBidWlsZChjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5ydW5Ubygnc2VuZCcsIGNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBydW5UbzogZnVuY3Rpb24gcnVuVG8oc3RhdGUsIGRvbmUpIHsKICAgICAgdGhpcy5fYXNtLnJ1blRvKHN0YXRlLCBkb25lLCB0aGlzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBBYm9ydHMgYSByZXF1ZXN0LCBlbWl0dGluZyB0aGUgZXJyb3IgYW5kIGNvbXBsZXRlIGV2ZW50cy4KICAgICAqCiAgICAgKiBAIW1hY3JvIG5vYnJvd3NlcgogICAgICogQGV4YW1wbGUgQWJvcnRpbmcgYSByZXF1ZXN0IGFmdGVyIHNlbmRpbmcKICAgICAqICAgdmFyIHBhcmFtcyA9IHsKICAgICAqICAgICBCdWNrZXQ6ICdidWNrZXQnLCBLZXk6ICdrZXknLAogICAgICogICAgIEJvZHk6IEJ1ZmZlci5hbGxvYygxMDI0ICogMTAyNCAqIDUpIC8vIDVNQiBwYXlsb2FkCiAgICAgKiAgIH07CiAgICAgKiAgIHZhciByZXF1ZXN0ID0gczMucHV0T2JqZWN0KHBhcmFtcyk7CiAgICAgKiAgIHJlcXVlc3Quc2VuZChmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgKiAgICAgaWYgKGVycikgY29uc29sZS5sb2coIkVycm9yOiIsIGVyci5jb2RlLCBlcnIubWVzc2FnZSk7CiAgICAgKiAgICAgZWxzZSBjb25zb2xlLmxvZyhkYXRhKTsKICAgICAqICAgfSk7CiAgICAgKgogICAgICogICAvLyBhYm9ydCByZXF1ZXN0IGluIDEgc2Vjb25kCiAgICAgKiAgIHNldFRpbWVvdXQocmVxdWVzdC5hYm9ydC5iaW5kKHJlcXVlc3QpLCAxMDAwKTsKICAgICAqCiAgICAgKiAgIC8vIHByaW50cyAiRXJyb3I6IFJlcXVlc3RBYm9ydGVkRXJyb3IgUmVxdWVzdCBhYm9ydGVkIGJ5IHVzZXIiCiAgICAgKiBAcmV0dXJuIFtBV1MuUmVxdWVzdF0gdGhlIHNhbWUgcmVxdWVzdCBvYmplY3QsIGZvciBjaGFpbmluZy4KICAgICAqIEBzaW5jZSB2MS40LjAKICAgICAqLwogICAgYWJvcnQ6IGZ1bmN0aW9uIGFib3J0KCkgewogICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygndmFsaWRhdGVSZXNwb25zZScpOwogICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygnZXh0cmFjdEVycm9yJyk7CiAgICAgIHRoaXMub24oJ3ZhbGlkYXRlUmVzcG9uc2UnLCBmdW5jdGlvbiBhZGRBYm9ydGVkRXJyb3IocmVzcCkgewogICAgICAgIHJlc3AuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ1JlcXVlc3QgYWJvcnRlZCBieSB1c2VyJyksIHsKICAgICAgICAgICBjb2RlOiAnUmVxdWVzdEFib3J0ZWRFcnJvcicsIHJldHJ5YWJsZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgfSk7CiAgCiAgICAgIGlmICh0aGlzLmh0dHBSZXF1ZXN0LnN0cmVhbSAmJiAhdGhpcy5odHRwUmVxdWVzdC5zdHJlYW0uZGlkQ2FsbGJhY2spIHsgLy8gYWJvcnQgSFRUUCBzdHJlYW0KICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0LnN0cmVhbS5hYm9ydCgpOwogICAgICAgIGlmICh0aGlzLmh0dHBSZXF1ZXN0Ll9hYm9ydENhbGxiYWNrKSB7CiAgICAgICAgICAgdGhpcy5odHRwUmVxdWVzdC5fYWJvcnRDYWxsYmFjaygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygnc2VuZCcpOyAvLyBoYXZlbid0IHNlbnQgeWV0LCBzbyBsZXQncyBub3QKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBJdGVyYXRlcyBvdmVyIGVhY2ggcGFnZSBvZiByZXN1bHRzIGdpdmVuIGEgcGFnZWFibGUgcmVxdWVzdCwgY2FsbGluZwogICAgICogdGhlIHByb3ZpZGVkIGNhbGxiYWNrIHdpdGggZWFjaCBwYWdlIG9mIGRhdGEuIEFmdGVyIGFsbCBwYWdlcyBoYXZlIGJlZW4KICAgICAqIHJldHJpZXZlZCwgdGhlIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIGBudWxsYCBkYXRhLgogICAgICoKICAgICAqIEBub3RlIFRoaXMgb3BlcmF0aW9uIGNhbiBnZW5lcmF0ZSBtdWx0aXBsZSByZXF1ZXN0cyB0byBhIHNlcnZpY2UuCiAgICAgKiBAZXhhbXBsZSBJdGVyYXRpbmcgb3ZlciBtdWx0aXBsZSBwYWdlcyBvZiBvYmplY3RzIGluIGFuIFMzIGJ1Y2tldAogICAgICogICB2YXIgcGFnZXMgPSAxOwogICAgICogICBzMy5saXN0T2JqZWN0cygpLmVhY2hQYWdlKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICogICAgIGlmIChlcnIpIHJldHVybjsKICAgICAqICAgICBjb25zb2xlLmxvZygiUGFnZSIsIHBhZ2VzKyspOwogICAgICogICAgIGNvbnNvbGUubG9nKGRhdGEpOwogICAgICogICB9KTsKICAgICAqIEBleGFtcGxlIEl0ZXJhdGluZyBvdmVyIG11bHRpcGxlIHBhZ2VzIHdpdGggYW4gYXN5bmNocm9ub3VzIGNhbGxiYWNrCiAgICAgKiAgIHMzLmxpc3RPYmplY3RzKHBhcmFtcykuZWFjaFBhZ2UoZnVuY3Rpb24oZXJyLCBkYXRhLCBkb25lKSB7CiAgICAgKiAgICAgZG9Tb21ldGhpbmdBc3luY0FuZE9yRXhwZW5zaXZlKGZ1bmN0aW9uKCkgewogICAgICogICAgICAgLy8gVGhlIG5leHQgcGFnZSBvZiByZXN1bHRzIGlzbid0IGZldGNoZWQgdW50aWwgZG9uZSBpcyBjYWxsZWQKICAgICAqICAgICAgIGRvbmUoKTsKICAgICAqICAgICB9KTsKICAgICAqICAgfSk7CiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBkYXRhLCBbZG9uZUNhbGxiYWNrXSkKICAgICAqICAgQ2FsbGVkIHdpdGggZWFjaCBwYWdlIG9mIHJlc3VsdGluZyBkYXRhIGZyb20gdGhlIHJlcXVlc3QuIElmIHRoZQogICAgICogICBvcHRpb25hbCBgZG9uZUNhbGxiYWNrYCBpcyBwcm92aWRlZCBpbiB0aGUgZnVuY3Rpb24sIGl0IG11c3QgYmUgY2FsbGVkCiAgICAgKiAgIHdoZW4gdGhlIGNhbGxiYWNrIGlzIGNvbXBsZXRlLgogICAgICoKICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGFuIGVycm9yIG9iamVjdCwgaWYgYW4gZXJyb3Igb2NjdXJyZWQuCiAgICAgKiAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIGEgc2luZ2xlIHBhZ2Ugb2YgcmVzcG9uc2UgZGF0YS4gSWYgdGhlcmUgaXMgbm8KICAgICAqICAgICBtb3JlIGRhdGEsIHRoaXMgb2JqZWN0IHdpbGwgYmUgYG51bGxgLgogICAgICogICBAcGFyYW0gZG9uZUNhbGxiYWNrIFtGdW5jdGlvbl0gYW4gb3B0aW9uYWwgZG9uZSBjYWxsYmFjay4gSWYgdGhpcwogICAgICogICAgIGFyZ3VtZW50IGlzIGRlZmluZWQgaW4gdGhlIGZ1bmN0aW9uIGRlY2xhcmF0aW9uLCBpdCBzaG91bGQgYmUgY2FsbGVkCiAgICAgKiAgICAgd2hlbiB0aGUgbmV4dCBwYWdlIGlzIHJlYWR5IHRvIGJlIHJldHJpZXZlZC4gVGhpcyBpcyB1c2VmdWwgZm9yCiAgICAgKiAgICAgY29udHJvbGxpbmcgc2VyaWFsIHBhZ2luYXRpb24gYWNyb3NzIGFzeW5jaHJvbm91cyBvcGVyYXRpb25zLgogICAgICogICBAcmV0dXJuIFtCb29sZWFuXSBpZiB0aGUgY2FsbGJhY2sgcmV0dXJucyBgZmFsc2VgLCBwYWdpbmF0aW9uIHdpbGwKICAgICAqICAgICBzdG9wLgogICAgICoKICAgICAqIEBzZWUgQVdTLlJlcXVlc3QuZWFjaEl0ZW0KICAgICAqIEBzZWUgQVdTLlJlc3BvbnNlLm5leHRQYWdlCiAgICAgKiBAc2luY2UgdjEuNC4wCiAgICAgKi8KICAgIGVhY2hQYWdlOiBmdW5jdGlvbiBlYWNoUGFnZShjYWxsYmFjaykgewogICAgICAvLyBNYWtlIGFsbCBjYWxsYmFja3MgYXN5bmMtaXNoCiAgICAgIGNhbGxiYWNrID0gQVdTLnV0aWwuZm4ubWFrZUFzeW5jKGNhbGxiYWNrLCAzKTsKICAKICAgICAgZnVuY3Rpb24gd3JhcHBlZENhbGxiYWNrKHJlc3BvbnNlKSB7CiAgICAgICAgY2FsbGJhY2suY2FsbChyZXNwb25zZSwgcmVzcG9uc2UuZXJyb3IsIHJlc3BvbnNlLmRhdGEsIGZ1bmN0aW9uIChyZXN1bHQpIHsKICAgICAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKSByZXR1cm47CiAgCiAgICAgICAgICBpZiAocmVzcG9uc2UuaGFzTmV4dFBhZ2UoKSkgewogICAgICAgICAgICByZXNwb25zZS5uZXh0UGFnZSgpLm9uKCdjb21wbGV0ZScsIHdyYXBwZWRDYWxsYmFjaykuc2VuZCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2FsbGJhY2suY2FsbChyZXNwb25zZSwgbnVsbCwgbnVsbCwgQVdTLnV0aWwuZm4ubm9vcCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAKICAgICAgdGhpcy5vbignY29tcGxldGUnLCB3cmFwcGVkQ2FsbGJhY2spLnNlbmQoKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEVudW1lcmF0ZXMgb3ZlciBpbmRpdmlkdWFsIGl0ZW1zIG9mIGEgcmVxdWVzdCwgcGFnaW5nIHRoZSByZXNwb25zZXMgaWYKICAgICAqIG5lY2Vzc2FyeS4KICAgICAqCiAgICAgKiBAYXBpIGV4cGVyaW1lbnRhbAogICAgICogQHNpbmNlIHYxLjQuMAogICAgICovCiAgICBlYWNoSXRlbTogZnVuY3Rpb24gZWFjaEl0ZW0oY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBmdW5jdGlvbiB3cmFwcGVkQ2FsbGJhY2soZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKGVycikgcmV0dXJuIGNhbGxiYWNrKGVyciwgbnVsbCk7CiAgICAgICAgaWYgKGRhdGEgPT09IG51bGwpIHJldHVybiBjYWxsYmFjayhudWxsLCBudWxsKTsKICAKICAgICAgICB2YXIgY29uZmlnID0gc2VsZi5zZXJ2aWNlLnBhZ2luYXRpb25Db25maWcoc2VsZi5vcGVyYXRpb24pOwogICAgICAgIHZhciByZXN1bHRLZXkgPSBjb25maWcucmVzdWx0S2V5OwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdEtleSkpIHJlc3VsdEtleSA9IHJlc3VsdEtleVswXTsKICAgICAgICB2YXIgaXRlbXMgPSBqbWVzcGF0aC5zZWFyY2goZGF0YSwgcmVzdWx0S2V5KTsKICAgICAgICB2YXIgY29udGludWVJdGVyYXRpb24gPSB0cnVlOwogICAgICAgIEFXUy51dGlsLmFycmF5RWFjaChpdGVtcywgZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgY29udGludWVJdGVyYXRpb24gPSBjYWxsYmFjayhudWxsLCBpdGVtKTsKICAgICAgICAgIGlmIChjb250aW51ZUl0ZXJhdGlvbiA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgcmV0dXJuIEFXUy51dGlsLmFib3J0OwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBjb250aW51ZUl0ZXJhdGlvbjsKICAgICAgfQogIAogICAgICB0aGlzLmVhY2hQYWdlKHdyYXBwZWRDYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBvcGVyYXRpb24gY2FuIHJldHVybiBtdWx0aXBsZSBwYWdlcyBvZgogICAgICogICByZXNwb25zZSBkYXRhLgogICAgICogQHNlZSBBV1MuUmVzcG9uc2UuZWFjaFBhZ2UKICAgICAqIEBzaW5jZSB2MS40LjAKICAgICAqLwogICAgaXNQYWdlYWJsZTogZnVuY3Rpb24gaXNQYWdlYWJsZSgpIHsKICAgICAgcmV0dXJuIHRoaXMuc2VydmljZS5wYWdpbmF0aW9uQ29uZmlnKHRoaXMub3BlcmF0aW9uKSA/IHRydWUgOiBmYWxzZTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFNlbmRzIHRoZSByZXF1ZXN0IGFuZCBjb252ZXJ0cyB0aGUgcmVxdWVzdCBvYmplY3QgaW50byBhIHJlYWRhYmxlIHN0cmVhbQogICAgICogdGhhdCBjYW4gYmUgcmVhZCBmcm9tIG9yIHBpcGVkIGludG8gYSB3cml0YWJsZSBzdHJlYW0uCiAgICAgKgogICAgICogQG5vdGUgVGhlIGRhdGEgcmVhZCBmcm9tIGEgcmVhZGFibGUgc3RyZWFtIGNvbnRhaW5zIG9ubHkKICAgICAqICAgdGhlIHJhdyBIVFRQIGJvZHkgY29udGVudHMuCiAgICAgKiBAZXhhbXBsZSBNYW51YWxseSByZWFkaW5nIGZyb20gYSBzdHJlYW0KICAgICAqICAgcmVxdWVzdC5jcmVhdGVSZWFkU3RyZWFtKCkub24oJ2RhdGEnLCBmdW5jdGlvbihkYXRhKSB7CiAgICAgKiAgICAgY29uc29sZS5sb2coIkdvdCBkYXRhOiIsIGRhdGEudG9TdHJpbmcoKSk7CiAgICAgKiAgIH0pOwogICAgICogQGV4YW1wbGUgUGlwaW5nIGEgcmVxdWVzdCBib2R5IGludG8gYSBmaWxlCiAgICAgKiAgIHZhciBvdXQgPSBmcy5jcmVhdGVXcml0ZVN0cmVhbSgnL3BhdGgvdG8vb3V0ZmlsZS5qcGcnKTsKICAgICAqICAgczMuc2VydmljZS5nZXRPYmplY3QocGFyYW1zKS5jcmVhdGVSZWFkU3RyZWFtKCkucGlwZShvdXQpOwogICAgICogQHJldHVybiBbU3RyZWFtXSB0aGUgcmVhZGFibGUgc3RyZWFtIG9iamVjdCB0aGF0IGNhbiBiZSBwaXBlZAogICAgICogICBvciByZWFkIGZyb20gKGJ5IHJlZ2lzdGVyaW5nICdkYXRhJyBldmVudCBsaXN0ZW5lcnMpLgogICAgICogQCFtYWNybyBub2Jyb3dzZXIKICAgICAqLwogICAgY3JlYXRlUmVhZFN0cmVhbTogZnVuY3Rpb24gY3JlYXRlUmVhZFN0cmVhbSgpIHsKICAgICAgdmFyIHN0cmVhbXMgPSBBV1MudXRpbC5zdHJlYW07CiAgICAgIHZhciByZXEgPSB0aGlzOwogICAgICB2YXIgc3RyZWFtID0gbnVsbDsKICAKICAgICAgaWYgKEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyKSB7CiAgICAgICAgc3RyZWFtID0gbmV3IHN0cmVhbXMuUGFzc1Rocm91Z2goKTsKICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgeyByZXEuc2VuZCgpOyB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdHJlYW0gPSBuZXcgc3RyZWFtcy5TdHJlYW0oKTsKICAgICAgICBzdHJlYW0ucmVhZGFibGUgPSB0cnVlOwogIAogICAgICAgIHN0cmVhbS5zZW50ID0gZmFsc2U7CiAgICAgICAgc3RyZWFtLm9uKCduZXdMaXN0ZW5lcicsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICBpZiAoIXN0cmVhbS5zZW50ICYmIGV2ZW50ID09PSAnZGF0YScpIHsKICAgICAgICAgICAgc3RyZWFtLnNlbnQgPSB0cnVlOwogICAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgeyByZXEuc2VuZCgpOyB9KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogIAogICAgICB0aGlzLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycikgewogICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgIH0pOwogIAogICAgICB0aGlzLm9uKCdodHRwSGVhZGVycycsIGZ1bmN0aW9uIHN0cmVhbUhlYWRlcnMoc3RhdHVzQ29kZSwgaGVhZGVycywgcmVzcCkgewogICAgICAgIGlmIChzdGF0dXNDb2RlIDwgMzAwKSB7CiAgICAgICAgICByZXEucmVtb3ZlTGlzdGVuZXIoJ2h0dHBEYXRhJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuSFRUUF9EQVRBKTsKICAgICAgICAgIHJlcS5yZW1vdmVMaXN0ZW5lcignaHR0cEVycm9yJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuSFRUUF9FUlJPUik7CiAgICAgICAgICByZXEub24oJ2h0dHBFcnJvcicsIGZ1bmN0aW9uIHN0cmVhbUh0dHBFcnJvcihlcnJvcikgewogICAgICAgICAgICByZXNwLmVycm9yID0gZXJyb3I7CiAgICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gZmFsc2U7CiAgICAgICAgICB9KTsKICAKICAgICAgICAgIHZhciBzaG91bGRDaGVja0NvbnRlbnRMZW5ndGggPSBmYWxzZTsKICAgICAgICAgIHZhciBleHBlY3RlZExlbjsKICAgICAgICAgIGlmIChyZXEuaHR0cFJlcXVlc3QubWV0aG9kICE9PSAnSEVBRCcpIHsKICAgICAgICAgICAgZXhwZWN0ZWRMZW4gPSBwYXJzZUludChoZWFkZXJzWydjb250ZW50LWxlbmd0aCddLCAxMCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXhwZWN0ZWRMZW4gIT09IHVuZGVmaW5lZCAmJiAhaXNOYU4oZXhwZWN0ZWRMZW4pICYmIGV4cGVjdGVkTGVuID49IDApIHsKICAgICAgICAgICAgc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIHJlY2VpdmVkTGVuID0gMDsKICAgICAgICAgIH0KICAKICAgICAgICAgIHZhciBjaGVja0NvbnRlbnRMZW5ndGhBbmRFbWl0ID0gZnVuY3Rpb24gY2hlY2tDb250ZW50TGVuZ3RoQW5kRW1pdCgpIHsKICAgICAgICAgICAgaWYgKHNob3VsZENoZWNrQ29udGVudExlbmd0aCAmJiByZWNlaXZlZExlbiAhPT0gZXhwZWN0ZWRMZW4pIHsKICAgICAgICAgICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBBV1MudXRpbC5lcnJvcigKICAgICAgICAgICAgICAgIG5ldyBFcnJvcignU3RyZWFtIGNvbnRlbnQgbGVuZ3RoIG1pc21hdGNoLiBSZWNlaXZlZCAnICsKICAgICAgICAgICAgICAgICAgcmVjZWl2ZWRMZW4gKyAnIG9mICcgKyBleHBlY3RlZExlbiArICcgYnl0ZXMuJyksCiAgICAgICAgICAgICAgICB7IGNvZGU6ICdTdHJlYW1Db250ZW50TGVuZ3RoTWlzbWF0Y2gnIH0KICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMikgewogICAgICAgICAgICAgIHN0cmVhbS5lbmQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdHJlYW0uZW1pdCgnZW5kJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgCiAgICAgICAgICB2YXIgaHR0cFN0cmVhbSA9IHJlc3AuaHR0cFJlc3BvbnNlLmNyZWF0ZVVuYnVmZmVyZWRTdHJlYW0oKTsKICAKICAgICAgICAgIGlmIChBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMikgewogICAgICAgICAgICBpZiAoc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoKSB7CiAgICAgICAgICAgICAgdmFyIGxlbmd0aEFjY3VtdWxhdG9yID0gbmV3IHN0cmVhbXMuUGFzc1Rocm91Z2goKTsKICAgICAgICAgICAgICBsZW5ndGhBY2N1bXVsYXRvci5fd3JpdGUgPSBmdW5jdGlvbihjaHVuaykgewogICAgICAgICAgICAgICAgaWYgKGNodW5rICYmIGNodW5rLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICByZWNlaXZlZExlbiArPSBjaHVuay5sZW5ndGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gc3RyZWFtcy5QYXNzVGhyb3VnaC5wcm90b3R5cGUuX3dyaXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgfTsKICAKICAgICAgICAgICAgICBsZW5ndGhBY2N1bXVsYXRvci5vbignZW5kJywgY2hlY2tDb250ZW50TGVuZ3RoQW5kRW1pdCk7CiAgICAgICAgICAgICAgc3RyZWFtLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgICAgc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoID0gZmFsc2U7CiAgICAgICAgICAgICAgICBodHRwU3RyZWFtLnVucGlwZShsZW5ndGhBY2N1bXVsYXRvcik7CiAgICAgICAgICAgICAgICBsZW5ndGhBY2N1bXVsYXRvci5lbWl0KCdlbmQnKTsKICAgICAgICAgICAgICAgIGxlbmd0aEFjY3VtdWxhdG9yLmVuZCgpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGh0dHBTdHJlYW0ucGlwZShsZW5ndGhBY2N1bXVsYXRvcikucGlwZShzdHJlYW0sIHsgZW5kOiBmYWxzZSB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBodHRwU3RyZWFtLnBpcGUoc3RyZWFtKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAKICAgICAgICAgICAgaWYgKHNob3VsZENoZWNrQ29udGVudExlbmd0aCkgewogICAgICAgICAgICAgIGh0dHBTdHJlYW0ub24oJ2RhdGEnLCBmdW5jdGlvbihhcmcpIHsKICAgICAgICAgICAgICAgIGlmIChhcmcgJiYgYXJnLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICByZWNlaXZlZExlbiArPSBhcmcubGVuZ3RoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgCiAgICAgICAgICAgIGh0dHBTdHJlYW0ub24oJ2RhdGEnLCBmdW5jdGlvbihhcmcpIHsKICAgICAgICAgICAgICBzdHJlYW0uZW1pdCgnZGF0YScsIGFyZyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBodHRwU3RyZWFtLm9uKCdlbmQnLCBjaGVja0NvbnRlbnRMZW5ndGhBbmRFbWl0KTsKICAgICAgICAgIH0KICAKICAgICAgICAgIGh0dHBTdHJlYW0ub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgIHNob3VsZENoZWNrQ29udGVudExlbmd0aCA9IGZhbHNlOwogICAgICAgICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBlcnIpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgcmV0dXJuIHN0cmVhbTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBwYXJhbSBbQXJyYXksUmVzcG9uc2VdIGFyZ3MgVGhpcyBzaG91bGQgYmUgdGhlIHJlc3BvbnNlIG9iamVjdCwKICAgICAqICAgb3IgYW4gYXJyYXkgb2YgYXJncyB0byBzZW5kIHRvIHRoZSBldmVudC4KICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBlbWl0RXZlbnQ6IGZ1bmN0aW9uIGVtaXQoZXZlbnROYW1lLCBhcmdzLCBkb25lKSB7CiAgICAgIGlmICh0eXBlb2YgYXJncyA9PT0gJ2Z1bmN0aW9uJykgeyBkb25lID0gYXJnczsgYXJncyA9IG51bGw7IH0KICAgICAgaWYgKCFkb25lKSBkb25lID0gZnVuY3Rpb24oKSB7IH07CiAgICAgIGlmICghYXJncykgYXJncyA9IHRoaXMuZXZlbnRQYXJhbWV0ZXJzKGV2ZW50TmFtZSwgdGhpcy5yZXNwb25zZSk7CiAgCiAgICAgIHZhciBvcmlnRW1pdCA9IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IucHJvdG90eXBlLmVtaXQ7CiAgICAgIG9yaWdFbWl0LmNhbGwodGhpcywgZXZlbnROYW1lLCBhcmdzLCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgaWYgKGVycikgdGhpcy5yZXNwb25zZS5lcnJvciA9IGVycjsKICAgICAgICBkb25lLmNhbGwodGhpcywgZXJyKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZXZlbnRQYXJhbWV0ZXJzOiBmdW5jdGlvbiBldmVudFBhcmFtZXRlcnMoZXZlbnROYW1lKSB7CiAgICAgIHN3aXRjaCAoZXZlbnROYW1lKSB7CiAgICAgICAgY2FzZSAncmVzdGFydCc6CiAgICAgICAgY2FzZSAndmFsaWRhdGUnOgogICAgICAgIGNhc2UgJ3NpZ24nOgogICAgICAgIGNhc2UgJ2J1aWxkJzoKICAgICAgICBjYXNlICdhZnRlclZhbGlkYXRlJzoKICAgICAgICBjYXNlICdhZnRlckJ1aWxkJzoKICAgICAgICAgIHJldHVybiBbdGhpc107CiAgICAgICAgY2FzZSAnZXJyb3InOgogICAgICAgICAgcmV0dXJuIFt0aGlzLnJlc3BvbnNlLmVycm9yLCB0aGlzLnJlc3BvbnNlXTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIFt0aGlzLnJlc3BvbnNlXTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHByZXNpZ246IGZ1bmN0aW9uIHByZXNpZ24oZXhwaXJlcywgY2FsbGJhY2spIHsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgZXhwaXJlcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGNhbGxiYWNrID0gZXhwaXJlczsKICAgICAgICBleHBpcmVzID0gbnVsbDsKICAgICAgfQogICAgICByZXR1cm4gbmV3IEFXUy5TaWduZXJzLlByZXNpZ24oKS5zaWduKHRoaXMudG9HZXQoKSwgZXhwaXJlcywgY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGlzUHJlc2lnbmVkOiBmdW5jdGlvbiBpc1ByZXNpZ25lZCgpIHsKICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLmh0dHBSZXF1ZXN0LmhlYWRlcnMsICdwcmVzaWduZWQtZXhwaXJlcycpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHRvVW5hdXRoZW50aWNhdGVkOiBmdW5jdGlvbiB0b1VuYXV0aGVudGljYXRlZCgpIHsKICAgICAgdGhpcy5fdW5BdXRoZW50aWNhdGVkID0gdHJ1ZTsKICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9DUkVERU5USUFMUyk7CiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ3NpZ24nLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5TSUdOKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdG9HZXQ6IGZ1bmN0aW9uIHRvR2V0KCkgewogICAgICBpZiAodGhpcy5zZXJ2aWNlLmFwaS5wcm90b2NvbCA9PT0gJ3F1ZXJ5JyB8fAogICAgICAgICAgdGhpcy5zZXJ2aWNlLmFwaS5wcm90b2NvbCA9PT0gJ2VjMicpIHsKICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKCdidWlsZCcsIHRoaXMuYnVpbGRBc0dldCk7CiAgICAgICAgdGhpcy5hZGRMaXN0ZW5lcignYnVpbGQnLCB0aGlzLmJ1aWxkQXNHZXQpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGJ1aWxkQXNHZXQ6IGZ1bmN0aW9uIGJ1aWxkQXNHZXQocmVxdWVzdCkgewogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0Lm1ldGhvZCA9ICdHRVQnOwogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnBhdGggPSByZXF1ZXN0LnNlcnZpY2UuZW5kcG9pbnQucGF0aCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc/JyArIHJlcXVlc3QuaHR0cFJlcXVlc3QuYm9keTsKICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC5ib2R5ID0gJyc7CiAgCiAgICAgIC8vIGRvbid0IG5lZWQgdGhlc2UgaGVhZGVycyBvbiBhIEdFVCByZXF1ZXN0CiAgICAgIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtTGVuZ3RoJ107CiAgICAgIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGhhbHRIYW5kbGVyc09uRXJyb3I6IGZ1bmN0aW9uIGhhbHRIYW5kbGVyc09uRXJyb3IoKSB7CiAgICAgIHRoaXMuX2hhbHRIYW5kbGVyc09uRXJyb3IgPSB0cnVlOwogICAgfQogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5SZXF1ZXN0LmFkZFByb21pc2VzVG9DbGFzcyA9IGZ1bmN0aW9uIGFkZFByb21pc2VzVG9DbGFzcyhQcm9taXNlRGVwZW5kZW5jeSkgewogICAgdGhpcy5wcm90b3R5cGUucHJvbWlzZSA9IGZ1bmN0aW9uIHByb21pc2UoKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgLy8gYXBwZW5kIHRvIHVzZXIgYWdlbnQKICAgICAgdGhpcy5odHRwUmVxdWVzdC5hcHBlbmRUb1VzZXJBZ2VudCgncHJvbWlzZScpOwogICAgICByZXR1cm4gbmV3IFByb21pc2VEZXBlbmRlbmN5KGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIHNlbGYub24oJ2NvbXBsZXRlJywgZnVuY3Rpb24ocmVzcCkgewogICAgICAgICAgaWYgKHJlc3AuZXJyb3IpIHsKICAgICAgICAgICAgcmVqZWN0KHJlc3AuZXJyb3IpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gZGVmaW5lICRyZXNwb25zZSBwcm9wZXJ0eSBzbyB0aGF0IGl0IGlzIG5vdCBlbnVtYmVyYWJsZQogICAgICAgICAgICAvLyB0aGlzIHByZXZlbnRzIGNpcmN1bGFyIHJlZmVyZW5jZSBlcnJvcnMgd2hlbiBzdHJpbmdpZnlpbmcgdGhlIEpTT04gb2JqZWN0CiAgICAgICAgICAgIHJlc29sdmUoT2JqZWN0LmRlZmluZVByb3BlcnR5KAogICAgICAgICAgICAgIHJlc3AuZGF0YSB8fCB7fSwKICAgICAgICAgICAgICAnJHJlc3BvbnNlJywKICAgICAgICAgICAgICB7dmFsdWU6IHJlc3B9CiAgICAgICAgICAgICkpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHNlbGYucnVuVG8oKTsKICAgICAgfSk7CiAgICB9OwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlJlcXVlc3QuZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MgPSBmdW5jdGlvbiBkZWxldGVQcm9taXNlc0Zyb21DbGFzcygpIHsKICAgIGRlbGV0ZSB0aGlzLnByb3RvdHlwZS5wcm9taXNlOwogIH07CiAgCiAgQVdTLnV0aWwuYWRkUHJvbWlzZXMoQVdTLlJlcXVlc3QpOwogIAogIEFXUy51dGlsLm1peGluKEFXUy5SZXF1ZXN0LCBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKTsKICAKICB9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCiAgfSx7Ii4vY29yZSI6MTgsIi4vc3RhdGVfbWFjaGluZSI6NzAsIl9wcm9jZXNzIjo4Niwiam1lc3BhdGgiOjg1fV0sNTY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8qKgogICAqIENvcHlyaWdodCAyMDEyLTIwMTMgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICAgKgogICAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpLiBZb3UKICAgKiBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mCiAgICogdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdAogICAqCiAgICogICAgIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hcGFjaGUyLjAvCiAgICoKICAgKiBvciBpbiB0aGUgImxpY2Vuc2UiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzCiAgICogZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YKICAgKiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMKICAgKiBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogICAqLwogIAogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgdmFyIGptZXNwYXRoID0gcmVxdWlyZSgnam1lc3BhdGgnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBDSEVDS19BQ0NFUFRPUlMocmVzcCkgewogICAgdmFyIHdhaXRlciA9IHJlc3AucmVxdWVzdC5fd2FpdGVyOwogICAgdmFyIGFjY2VwdG9ycyA9IHdhaXRlci5jb25maWcuYWNjZXB0b3JzOwogICAgdmFyIGFjY2VwdG9yTWF0Y2hlZCA9IGZhbHNlOwogICAgdmFyIHN0YXRlID0gJ3JldHJ5JzsKICAKICAgIGFjY2VwdG9ycy5mb3JFYWNoKGZ1bmN0aW9uKGFjY2VwdG9yKSB7CiAgICAgIGlmICghYWNjZXB0b3JNYXRjaGVkKSB7CiAgICAgICAgdmFyIG1hdGNoZXIgPSB3YWl0ZXIubWF0Y2hlcnNbYWNjZXB0b3IubWF0Y2hlcl07CiAgICAgICAgaWYgKG1hdGNoZXIgJiYgbWF0Y2hlcihyZXNwLCBhY2NlcHRvci5leHBlY3RlZCwgYWNjZXB0b3IuYXJndW1lbnQpKSB7CiAgICAgICAgICBhY2NlcHRvck1hdGNoZWQgPSB0cnVlOwogICAgICAgICAgc3RhdGUgPSBhY2NlcHRvci5zdGF0ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIAogICAgaWYgKCFhY2NlcHRvck1hdGNoZWQgJiYgcmVzcC5lcnJvcikgc3RhdGUgPSAnZmFpbHVyZSc7CiAgCiAgICBpZiAoc3RhdGUgPT09ICdzdWNjZXNzJykgewogICAgICB3YWl0ZXIuc2V0U3VjY2VzcyhyZXNwKTsKICAgIH0gZWxzZSB7CiAgICAgIHdhaXRlci5zZXRFcnJvcihyZXNwLCBzdGF0ZSA9PT0gJ3JldHJ5Jyk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5SZXNvdXJjZVdhaXRlciA9IGluaGVyaXQoewogICAgLyoqCiAgICAgKiBXYWl0cyBmb3IgYSBnaXZlbiBzdGF0ZSBvbiBhIHNlcnZpY2Ugb2JqZWN0CiAgICAgKiBAcGFyYW0gc2VydmljZSBbU2VydmljZV0gdGhlIHNlcnZpY2Ugb2JqZWN0IHRvIHdhaXQgb24KICAgICAqIEBwYXJhbSBzdGF0ZSBbU3RyaW5nXSB0aGUgc3RhdGUgKGRlZmluZWQgaW4gd2FpdGVyIGNvbmZpZ3VyYXRpb24pIHRvIHdhaXQKICAgICAqICAgZm9yLgogICAgICogQGV4YW1wbGUgQ3JlYXRlIGEgd2FpdGVyIGZvciBydW5uaW5nIEVDMiBpbnN0YW5jZXMKICAgICAqICAgdmFyIGVjMiA9IG5ldyBBV1MuRUMyOwogICAgICogICB2YXIgd2FpdGVyID0gbmV3IEFXUy5SZXNvdXJjZVdhaXRlcihlYzIsICdpbnN0YW5jZVJ1bm5pbmcnKTsKICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIGNvbnN0cnVjdG9yKHNlcnZpY2UsIHN0YXRlKSB7CiAgICAgIHRoaXMuc2VydmljZSA9IHNlcnZpY2U7CiAgICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTsKICAgICAgdGhpcy5sb2FkV2FpdGVyQ29uZmlnKHRoaXMuc3RhdGUpOwogICAgfSwKICAKICAgIHNlcnZpY2U6IG51bGwsCiAgCiAgICBzdGF0ZTogbnVsbCwKICAKICAgIGNvbmZpZzogbnVsbCwKICAKICAgIG1hdGNoZXJzOiB7CiAgICAgIHBhdGg6IGZ1bmN0aW9uKHJlc3AsIGV4cGVjdGVkLCBhcmd1bWVudCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gam1lc3BhdGguc2VhcmNoKHJlc3AuZGF0YSwgYXJndW1lbnQpOwogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAKICAgICAgICByZXR1cm4gam1lc3BhdGguc3RyaWN0RGVlcEVxdWFsKHJlc3VsdCxleHBlY3RlZCk7CiAgICAgIH0sCiAgCiAgICAgIHBhdGhBbGw6IGZ1bmN0aW9uKHJlc3AsIGV4cGVjdGVkLCBhcmd1bWVudCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgcmVzdWx0cyA9IGptZXNwYXRoLnNlYXJjaChyZXNwLmRhdGEsIGFyZ3VtZW50KTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgCiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdHMpKSByZXN1bHRzID0gW3Jlc3VsdHNdOwogICAgICAgIHZhciBudW1SZXN1bHRzID0gcmVzdWx0cy5sZW5ndGg7CiAgICAgICAgaWYgKCFudW1SZXN1bHRzKSByZXR1cm4gZmFsc2U7CiAgICAgICAgZm9yICh2YXIgaW5kID0gMCA7IGluZCA8IG51bVJlc3VsdHM7IGluZCsrKSB7CiAgICAgICAgICBpZiAoIWptZXNwYXRoLnN0cmljdERlZXBFcXVhbChyZXN1bHRzW2luZF0sIGV4cGVjdGVkKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9LAogIAogICAgICBwYXRoQW55OiBmdW5jdGlvbihyZXNwLCBleHBlY3RlZCwgYXJndW1lbnQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIHJlc3VsdHMgPSBqbWVzcGF0aC5zZWFyY2gocmVzcC5kYXRhLCBhcmd1bWVudCk7CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogIAogICAgICAgIGlmICghQXJyYXkuaXNBcnJheShyZXN1bHRzKSkgcmVzdWx0cyA9IFtyZXN1bHRzXTsKICAgICAgICB2YXIgbnVtUmVzdWx0cyA9IHJlc3VsdHMubGVuZ3RoOwogICAgICAgIGZvciAodmFyIGluZCA9IDAgOyBpbmQgPCBudW1SZXN1bHRzOyBpbmQrKykgewogICAgICAgICAgaWYgKGptZXNwYXRoLnN0cmljdERlZXBFcXVhbChyZXN1bHRzW2luZF0sIGV4cGVjdGVkKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9LAogIAogICAgICBzdGF0dXM6IGZ1bmN0aW9uKHJlc3AsIGV4cGVjdGVkKSB7CiAgICAgICAgdmFyIHN0YXR1c0NvZGUgPSByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICAgIHJldHVybiAodHlwZW9mIHN0YXR1c0NvZGUgPT09ICdudW1iZXInKSAmJiAoc3RhdHVzQ29kZSA9PT0gZXhwZWN0ZWQpOwogICAgICB9LAogIAogICAgICBlcnJvcjogZnVuY3Rpb24ocmVzcCwgZXhwZWN0ZWQpIHsKICAgICAgICBpZiAodHlwZW9mIGV4cGVjdGVkID09PSAnc3RyaW5nJyAmJiByZXNwLmVycm9yKSB7CiAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQgPT09IHJlc3AuZXJyb3IuY29kZTsKICAgICAgICB9CiAgICAgICAgLy8gaWYgZXhwZWN0ZWQgaXMgbm90IHN0cmluZywgY2FuIGJlIGJvb2xlYW4gaW5kaWNhdGluZyBwcmVzZW5jZSBvZiBlcnJvcgogICAgICAgIHJldHVybiBleHBlY3RlZCA9PT0gISFyZXNwLmVycm9yOwogICAgICB9CiAgICB9LAogIAogICAgbGlzdGVuZXJzOiBuZXcgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICBhZGQoJ1JFVFJZX0NIRUNLJywgJ3JldHJ5JywgZnVuY3Rpb24ocmVzcCkgewogICAgICAgIHZhciB3YWl0ZXIgPSByZXNwLnJlcXVlc3QuX3dhaXRlcjsKICAgICAgICBpZiAocmVzcC5lcnJvciAmJiByZXNwLmVycm9yLmNvZGUgPT09ICdSZXNvdXJjZU5vdFJlYWR5JykgewogICAgICAgICAgcmVzcC5lcnJvci5yZXRyeURlbGF5ID0gKHdhaXRlci5jb25maWcuZGVsYXkgfHwgMCkgKiAxMDAwOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnQ0hFQ0tfT1VUUFVUJywgJ2V4dHJhY3REYXRhJywgQ0hFQ0tfQUNDRVBUT1JTKTsKICAKICAgICAgYWRkKCdDSEVDS19FUlJPUicsICdleHRyYWN0RXJyb3InLCBDSEVDS19BQ0NFUFRPUlMpOwogICAgfSksCiAgCiAgICAvKioKICAgICAqIEByZXR1cm4gW0FXUy5SZXF1ZXN0XQogICAgICovCiAgICB3YWl0OiBmdW5jdGlvbiB3YWl0KHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBjYWxsYmFjayA9IHBhcmFtczsgcGFyYW1zID0gdW5kZWZpbmVkOwogICAgICB9CiAgCiAgICAgIGlmIChwYXJhbXMgJiYgcGFyYW1zLiR3YWl0ZXIpIHsKICAgICAgICBwYXJhbXMgPSBBV1MudXRpbC5jb3B5KHBhcmFtcyk7CiAgICAgICAgaWYgKHR5cGVvZiBwYXJhbXMuJHdhaXRlci5kZWxheSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHRoaXMuY29uZmlnLmRlbGF5ID0gcGFyYW1zLiR3YWl0ZXIuZGVsYXk7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgcGFyYW1zLiR3YWl0ZXIubWF4QXR0ZW1wdHMgPT09ICdudW1iZXInKSB7CiAgICAgICAgICB0aGlzLmNvbmZpZy5tYXhBdHRlbXB0cyA9IHBhcmFtcy4kd2FpdGVyLm1heEF0dGVtcHRzOwogICAgICAgIH0KICAgICAgICBkZWxldGUgcGFyYW1zLiR3YWl0ZXI7CiAgICAgIH0KICAKICAgICAgdmFyIHJlcXVlc3QgPSB0aGlzLnNlcnZpY2UubWFrZVJlcXVlc3QodGhpcy5jb25maWcub3BlcmF0aW9uLCBwYXJhbXMpOwogICAgICByZXF1ZXN0Ll93YWl0ZXIgPSB0aGlzOwogICAgICByZXF1ZXN0LnJlc3BvbnNlLm1heFJldHJpZXMgPSB0aGlzLmNvbmZpZy5tYXhBdHRlbXB0czsKICAgICAgcmVxdWVzdC5hZGRMaXN0ZW5lcnModGhpcy5saXN0ZW5lcnMpOwogIAogICAgICBpZiAoY2FsbGJhY2spIHJlcXVlc3Quc2VuZChjYWxsYmFjayk7CiAgICAgIHJldHVybiByZXF1ZXN0OwogICAgfSwKICAKICAgIHNldFN1Y2Nlc3M6IGZ1bmN0aW9uIHNldFN1Y2Nlc3MocmVzcCkgewogICAgICByZXNwLmVycm9yID0gbnVsbDsKICAgICAgcmVzcC5kYXRhID0gcmVzcC5kYXRhIHx8IHt9OwogICAgICByZXNwLnJlcXVlc3QucmVtb3ZlQWxsTGlzdGVuZXJzKCdleHRyYWN0RGF0YScpOwogICAgfSwKICAKICAgIHNldEVycm9yOiBmdW5jdGlvbiBzZXRFcnJvcihyZXNwLCByZXRyeWFibGUpIHsKICAgICAgcmVzcC5kYXRhID0gbnVsbDsKICAgICAgcmVzcC5lcnJvciA9IEFXUy51dGlsLmVycm9yKHJlc3AuZXJyb3IgfHwgbmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiAnUmVzb3VyY2VOb3RSZWFkeScsCiAgICAgICAgbWVzc2FnZTogJ1Jlc291cmNlIGlzIG5vdCBpbiB0aGUgc3RhdGUgJyArIHRoaXMuc3RhdGUsCiAgICAgICAgcmV0cnlhYmxlOiByZXRyeWFibGUKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBMb2FkcyB3YWl0ZXIgY29uZmlndXJhdGlvbiBmcm9tIEFQSSBjb25maWd1cmF0aW9uCiAgICAgKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxvYWRXYWl0ZXJDb25maWc6IGZ1bmN0aW9uIGxvYWRXYWl0ZXJDb25maWcoc3RhdGUpIHsKICAgICAgaWYgKCF0aGlzLnNlcnZpY2UuYXBpLndhaXRlcnNbc3RhdGVdKSB7CiAgICAgICAgdGhyb3cgbmV3IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICBjb2RlOiAnU3RhdGVOb3RGb3VuZEVycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdTdGF0ZSAnICsgc3RhdGUgKyAnIG5vdCBmb3VuZC4nCiAgICAgICAgfSk7CiAgICAgIH0KICAKICAgICAgdGhpcy5jb25maWcgPSBBV1MudXRpbC5jb3B5KHRoaXMuc2VydmljZS5hcGkud2FpdGVyc1tzdGF0ZV0pOwogICAgfQogIH0pOwogIAogIH0seyIuL2NvcmUiOjE4LCJqbWVzcGF0aCI6ODV9XSw1NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICB2YXIgam1lc3BhdGggPSByZXF1aXJlKCdqbWVzcGF0aCcpOwogIAogIC8qKgogICAqIFRoaXMgY2xhc3MgZW5jYXBzdWxhdGVzIHRoZSByZXNwb25zZSBpbmZvcm1hdGlvbgogICAqIGZyb20gYSBzZXJ2aWNlIHJlcXVlc3Qgb3BlcmF0aW9uIHNlbnQgdGhyb3VnaCB7QVdTLlJlcXVlc3R9LgogICAqIFRoZSByZXNwb25zZSBvYmplY3QgaGFzIHR3byBtYWluIHByb3BlcnRpZXMgZm9yIGdldHRpbmcgaW5mb3JtYXRpb24KICAgKiBiYWNrIGZyb20gYSByZXF1ZXN0OgogICAqCiAgICogIyMgVGhlIGBkYXRhYCBwcm9wZXJ0eQogICAqCiAgICogVGhlIGByZXNwb25zZS5kYXRhYCBwcm9wZXJ0eSBjb250YWlucyB0aGUgc2VyaWFsaXplZCBvYmplY3QgZGF0YQogICAqIHJldHJpZXZlZCBmcm9tIHRoZSBzZXJ2aWNlIHJlcXVlc3QuIEZvciBpbnN0YW5jZSwgZm9yIGFuCiAgICogQW1hem9uIER5bmFtb0RCIGBsaXN0VGFibGVzYCBtZXRob2QgY2FsbCwgdGhlIHJlc3BvbnNlIGRhdGEgbWlnaHQKICAgKiBsb29rIGxpa2U6CiAgICoKICAgKiBgYGAKICAgKiA+IHJlc3AuZGF0YQogICAqIHsgVGFibGVOYW1lczoKICAgKiAgICBbICd0YWJsZTEnLCAndGFibGUyJywgLi4uIF0gfQogICAqIGBgYAogICAqCiAgICogVGhlIGBkYXRhYCBwcm9wZXJ0eSBjYW4gYmUgbnVsbCBpZiBhbiBlcnJvciBvY2N1cnMgKHNlZSBiZWxvdykuCiAgICoKICAgKiAjIyBUaGUgYGVycm9yYCBwcm9wZXJ0eQogICAqCiAgICogSW4gdGhlIGV2ZW50IG9mIGEgc2VydmljZSBlcnJvciAob3IgdHJhbnNmZXIgZXJyb3IpLCB0aGUKICAgKiBgcmVzcG9uc2UuZXJyb3JgIHByb3BlcnR5IHdpbGwgYmUgZmlsbGVkIHdpdGggdGhlIGdpdmVuCiAgICogZXJyb3IgZGF0YSBpbiB0aGUgZm9ybToKICAgKgogICAqIGBgYAogICAqIHsgY29kZTogJ1NIT1JUX1VOSVFVRV9FUlJPUl9DT0RFJywKICAgKiAgIG1lc3NhZ2U6ICdTb21lIGh1bWFuIHJlYWRhYmxlIGVycm9yIG1lc3NhZ2UnIH0KICAgKiBgYGAKICAgKgogICAqIEluIHRoZSBjYXNlIG9mIGFuIGVycm9yLCB0aGUgYGRhdGFgIHByb3BlcnR5IHdpbGwgYmUgYG51bGxgLgogICAqIE5vdGUgdGhhdCBpZiB5b3UgaGFuZGxlIGV2ZW50cyB0aGF0IGNhbiBiZSBpbiBhIGZhaWx1cmUgc3RhdGUsCiAgICogeW91IHNob3VsZCBhbHdheXMgY2hlY2sgd2hldGhlciBgcmVzcG9uc2UuZXJyb3JgIGlzIHNldAogICAqIGJlZm9yZSBhdHRlbXB0aW5nIHRvIGFjY2VzcyB0aGUgYHJlc3BvbnNlLmRhdGFgIHByb3BlcnR5LgogICAqCiAgICogQCFhdHRyaWJ1dGUgZGF0YQogICAqICAgQHJlYWRvbmx5CiAgICogICBAIWdyb3VwIERhdGEgUHJvcGVydGllcwogICAqICAgQG5vdGUgSW5zaWRlIG9mIGEge0FXUy5SZXF1ZXN0fmh0dHBEYXRhfSBldmVudCwgdGhpcwogICAqICAgICBwcm9wZXJ0eSBjb250YWlucyBhIHNpbmdsZSByYXcgcGFja2V0IGluc3RlYWQgb2YgdGhlCiAgICogICAgIGZ1bGwgZGUtc2VyaWFsaXplZCBzZXJ2aWNlIHJlc3BvbnNlLgogICAqICAgQHJldHVybiBbT2JqZWN0XSB0aGUgZGUtc2VyaWFsaXplZCByZXNwb25zZSBkYXRhCiAgICogICAgIGZyb20gdGhlIHNlcnZpY2UuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBlcnJvcgogICAqICAgQW4gc3RydWN0dXJlIGNvbnRhaW5pbmcgaW5mb3JtYXRpb24gYWJvdXQgYSBzZXJ2aWNlCiAgICogICBvciBuZXR3b3JraW5nIGVycm9yLgogICAqICAgQHJlYWRvbmx5CiAgICogICBAIWdyb3VwIERhdGEgUHJvcGVydGllcwogICAqICAgQG5vdGUgVGhpcyBhdHRyaWJ1dGUgaXMgb25seSBmaWxsZWQgaWYgYSBzZXJ2aWNlIG9yCiAgICogICAgIG5ldHdvcmtpbmcgZXJyb3Igb2NjdXJzLgogICAqICAgQHJldHVybiBbRXJyb3JdCiAgICogICAgICogY29kZSBbU3RyaW5nXSBhIHVuaXF1ZSBzaG9ydCBjb2RlIHJlcHJlc2VudGluZyB0aGUKICAgKiAgICAgICBlcnJvciB0aGF0IHdhcyBlbWl0dGVkLgogICAqICAgICAqIG1lc3NhZ2UgW1N0cmluZ10gYSBsb25nZXIgaHVtYW4gcmVhZGFibGUgZXJyb3IgbWVzc2FnZQogICAqICAgICAqIHJldHJ5YWJsZSBbQm9vbGVhbl0gd2hldGhlciB0aGUgZXJyb3IgbWVzc2FnZSBpcwogICAqICAgICAgIHJldHJ5YWJsZS4KICAgKiAgICAgKiBzdGF0dXNDb2RlIFtOdW1lcmljXSBpbiB0aGUgY2FzZSBvZiBhIHJlcXVlc3QgdGhhdCByZWFjaGVkIHRoZSBzZXJ2aWNlLAogICAqICAgICAgIHRoaXMgdmFsdWUgY29udGFpbnMgdGhlIHJlc3BvbnNlIHN0YXR1cyBjb2RlLgogICAqICAgICAqIHRpbWUgW0RhdGVdIHRoZSBkYXRlIHRpbWUgb2JqZWN0IHdoZW4gdGhlIGVycm9yIG9jY3VycmVkLgogICAqICAgICAqIGhvc3RuYW1lIFtTdHJpbmddIHNldCB3aGVuIGEgbmV0d29ya2luZyBlcnJvciBvY2N1cnMgdG8gZWFzaWx5CiAgICogICAgICAgaWRlbnRpZnkgdGhlIGVuZHBvaW50IG9mIHRoZSByZXF1ZXN0LgogICAqICAgICAqIHJlZ2lvbiBbU3RyaW5nXSBzZXQgd2hlbiBhIG5ldHdvcmtpbmcgZXJyb3Igb2NjdXJzIHRvIGVhc2lseQogICAqICAgICAgIGlkZW50aWZ5IHRoZSByZWdpb24gb2YgdGhlIHJlcXVlc3QuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSByZXF1ZXN0SWQKICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBEYXRhIFByb3BlcnRpZXMKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIHVuaXF1ZSByZXF1ZXN0IElEIGFzc29jaWF0ZWQgd2l0aCB0aGUgcmVzcG9uc2UuCiAgICogICAgIExvZyB0aGlzIHZhbHVlIHdoZW4gZGVidWdnaW5nIHJlcXVlc3RzIGZvciBBV1Mgc3VwcG9ydC4KICAgKgogICAqIEAhYXR0cmlidXRlIHJldHJ5Q291bnQKICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBPcGVyYXRpb24gUHJvcGVydGllcwogICAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIG51bWJlciBvZiByZXRyaWVzIHRoYXQgd2VyZQogICAqICAgICBhdHRlbXB0ZWQgYmVmb3JlIHRoZSByZXF1ZXN0IHdhcyBjb21wbGV0ZWQuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSByZWRpcmVjdENvdW50CiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgT3BlcmF0aW9uIFByb3BlcnRpZXMKICAgKiAgIEByZXR1cm4gW0ludGVnZXJdIHRoZSBudW1iZXIgb2YgcmVkaXJlY3RzIHRoYXQgd2VyZQogICAqICAgICBmb2xsb3dlZCBiZWZvcmUgdGhlIHJlcXVlc3Qgd2FzIGNvbXBsZXRlZC4KICAgKgogICAqIEAhYXR0cmlidXRlIGh0dHBSZXNwb25zZQogICAqICAgQHJlYWRvbmx5CiAgICogICBAIWdyb3VwIEhUVFAgUHJvcGVydGllcwogICAqICAgQHJldHVybiBbQVdTLkh0dHBSZXNwb25zZV0gdGhlIHJhdyBIVFRQIHJlc3BvbnNlIG9iamVjdAogICAqICAgICBjb250YWluaW5nIHRoZSByZXNwb25zZSBoZWFkZXJzIGFuZCBib2R5IGluZm9ybWF0aW9uCiAgICogICAgIGZyb20gdGhlIHNlcnZlci4KICAgKgogICAqIEBzZWUgQVdTLlJlcXVlc3QKICAgKi8KICBBV1MuUmVzcG9uc2UgPSBpbmhlcml0KHsKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBSZXNwb25zZShyZXF1ZXN0KSB7CiAgICAgIHRoaXMucmVxdWVzdCA9IHJlcXVlc3Q7CiAgICAgIHRoaXMuZGF0YSA9IG51bGw7CiAgICAgIHRoaXMuZXJyb3IgPSBudWxsOwogICAgICB0aGlzLnJldHJ5Q291bnQgPSAwOwogICAgICB0aGlzLnJlZGlyZWN0Q291bnQgPSAwOwogICAgICB0aGlzLmh0dHBSZXNwb25zZSA9IG5ldyBBV1MuSHR0cFJlc3BvbnNlKCk7CiAgICAgIGlmIChyZXF1ZXN0KSB7CiAgICAgICAgdGhpcy5tYXhSZXRyaWVzID0gcmVxdWVzdC5zZXJ2aWNlLm51bVJldHJpZXMoKTsKICAgICAgICB0aGlzLm1heFJlZGlyZWN0cyA9IHJlcXVlc3Quc2VydmljZS5jb25maWcubWF4UmVkaXJlY3RzOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IHJlcXVlc3QgZm9yIHRoZSBuZXh0IHBhZ2Ugb2YgcmVzcG9uc2UgZGF0YSwgY2FsbGluZyB0aGUKICAgICAqIGNhbGxiYWNrIHdpdGggdGhlIHBhZ2UgZGF0YSBpZiBhIGNhbGxiYWNrIGlzIHByb3ZpZGVkLgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEpCiAgICAgKiAgIENhbGxlZCB3aGVuIGEgcGFnZSBvZiBkYXRhIGlzIHJldHVybmVkIGZyb20gdGhlIG5leHQgcmVxdWVzdC4KICAgICAqCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBhbiBlcnJvciBvYmplY3QsIGlmIGFuIGVycm9yIG9jY3VycmVkIGluIHRoZSByZXF1ZXN0CiAgICAgKiAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBuZXh0IHBhZ2Ugb2YgZGF0YSwgb3IgbnVsbCwgaWYgdGhlcmUgYXJlIG5vCiAgICAgKiAgICAgbW9yZSBwYWdlcyBsZWZ0LgogICAgICogQHJldHVybiBbQVdTLlJlcXVlc3RdIHRoZSByZXF1ZXN0IG9iamVjdCBmb3IgdGhlIG5leHQgcGFnZSBvZiBkYXRhCiAgICAgKiBAcmV0dXJuIFtudWxsXSBpZiBubyBjYWxsYmFjayBpcyBwcm92aWRlZCBhbmQgdGhlcmUgYXJlIG5vIHBhZ2VzIGxlZnQKICAgICAqICAgdG8gcmV0cmlldmUuCiAgICAgKiBAc2luY2UgdjEuNC4wCiAgICAgKi8KICAgIG5leHRQYWdlOiBmdW5jdGlvbiBuZXh0UGFnZShjYWxsYmFjaykgewogICAgICB2YXIgY29uZmlnOwogICAgICB2YXIgc2VydmljZSA9IHRoaXMucmVxdWVzdC5zZXJ2aWNlOwogICAgICB2YXIgb3BlcmF0aW9uID0gdGhpcy5yZXF1ZXN0Lm9wZXJhdGlvbjsKICAgICAgdHJ5IHsKICAgICAgICBjb25maWcgPSBzZXJ2aWNlLnBhZ2luYXRpb25Db25maWcob3BlcmF0aW9uLCB0cnVlKTsKICAgICAgfSBjYXRjaCAoZSkgeyB0aGlzLmVycm9yID0gZTsgfQogIAogICAgICBpZiAoIXRoaXMuaGFzTmV4dFBhZ2UoKSkgewogICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2sodGhpcy5lcnJvciwgbnVsbCk7CiAgICAgICAgZWxzZSBpZiAodGhpcy5lcnJvcikgdGhyb3cgdGhpcy5lcnJvcjsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogIAogICAgICB2YXIgcGFyYW1zID0gQVdTLnV0aWwuY29weSh0aGlzLnJlcXVlc3QucGFyYW1zKTsKICAgICAgaWYgKCF0aGlzLm5leHRQYWdlVG9rZW5zKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrID8gY2FsbGJhY2sobnVsbCwgbnVsbCkgOiBudWxsOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBpbnB1dFRva2VucyA9IGNvbmZpZy5pbnB1dFRva2VuOwogICAgICAgIGlmICh0eXBlb2YgaW5wdXRUb2tlbnMgPT09ICdzdHJpbmcnKSBpbnB1dFRva2VucyA9IFtpbnB1dFRva2Vuc107CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbnB1dFRva2Vucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgcGFyYW1zW2lucHV0VG9rZW5zW2ldXSA9IHRoaXMubmV4dFBhZ2VUb2tlbnNbaV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBzZXJ2aWNlLm1ha2VSZXF1ZXN0KHRoaXMucmVxdWVzdC5vcGVyYXRpb24sIHBhcmFtcywgY2FsbGJhY2spOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIG1vcmUgcGFnZXMgb2YgZGF0YSBjYW4gYmUgcmV0dXJuZWQgYnkgZnVydGhlcgogICAgICogICByZXF1ZXN0cwogICAgICogQHNpbmNlIHYxLjQuMAogICAgICovCiAgICBoYXNOZXh0UGFnZTogZnVuY3Rpb24gaGFzTmV4dFBhZ2UoKSB7CiAgICAgIHRoaXMuY2FjaGVOZXh0UGFnZVRva2VucygpOwogICAgICBpZiAodGhpcy5uZXh0UGFnZVRva2VucykgcmV0dXJuIHRydWU7CiAgICAgIGlmICh0aGlzLm5leHRQYWdlVG9rZW5zID09PSB1bmRlZmluZWQpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIGVsc2UgcmV0dXJuIGZhbHNlOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNhY2hlTmV4dFBhZ2VUb2tlbnM6IGZ1bmN0aW9uIGNhY2hlTmV4dFBhZ2VUb2tlbnMoKSB7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcywgJ25leHRQYWdlVG9rZW5zJykpIHJldHVybiB0aGlzLm5leHRQYWdlVG9rZW5zOwogICAgICB0aGlzLm5leHRQYWdlVG9rZW5zID0gdW5kZWZpbmVkOwogIAogICAgICB2YXIgY29uZmlnID0gdGhpcy5yZXF1ZXN0LnNlcnZpY2UucGFnaW5hdGlvbkNvbmZpZyh0aGlzLnJlcXVlc3Qub3BlcmF0aW9uKTsKICAgICAgaWYgKCFjb25maWcpIHJldHVybiB0aGlzLm5leHRQYWdlVG9rZW5zOwogIAogICAgICB0aGlzLm5leHRQYWdlVG9rZW5zID0gbnVsbDsKICAgICAgaWYgKGNvbmZpZy5tb3JlUmVzdWx0cykgewogICAgICAgIGlmICgham1lc3BhdGguc2VhcmNoKHRoaXMuZGF0YSwgY29uZmlnLm1vcmVSZXN1bHRzKSkgewogICAgICAgICAgcmV0dXJuIHRoaXMubmV4dFBhZ2VUb2tlbnM7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHZhciBleHBycyA9IGNvbmZpZy5vdXRwdXRUb2tlbjsKICAgICAgaWYgKHR5cGVvZiBleHBycyA9PT0gJ3N0cmluZycpIGV4cHJzID0gW2V4cHJzXTsKICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoLmNhbGwodGhpcywgZXhwcnMsIGZ1bmN0aW9uIChleHByKSB7CiAgICAgICAgdmFyIG91dHB1dCA9IGptZXNwYXRoLnNlYXJjaCh0aGlzLmRhdGEsIGV4cHIpOwogICAgICAgIGlmIChvdXRwdXQpIHsKICAgICAgICAgIHRoaXMubmV4dFBhZ2VUb2tlbnMgPSB0aGlzLm5leHRQYWdlVG9rZW5zIHx8IFtdOwogICAgICAgICAgdGhpcy5uZXh0UGFnZVRva2Vucy5wdXNoKG91dHB1dCk7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgcmV0dXJuIHRoaXMubmV4dFBhZ2VUb2tlbnM7CiAgICB9CiAgCiAgfSk7CiAgCiAgfSx7Ii4vY29yZSI6MTgsImptZXNwYXRoIjo4NX1dLDU4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICogQCFtZXRob2Qgb24oZXZlbnROYW1lLCBjYWxsYmFjaykKICAgKiAgIFJlZ2lzdGVycyBhbiBldmVudCBsaXN0ZW5lciBjYWxsYmFjayBmb3IgdGhlIGV2ZW50IGdpdmVuIGJ5IGBldmVudE5hbWVgLgogICAqICAgUGFyYW1ldGVycyBwYXNzZWQgdG8gdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIGRlcGVuZCBvbiB0aGUgaW5kaXZpZHVhbCBldmVudAogICAqICAgYmVpbmcgdHJpZ2dlcmVkLiBTZWUgdGhlIGV2ZW50IGRvY3VtZW50YXRpb24gZm9yIHRob3NlIHBhcmFtZXRlcnMuCiAgICoKICAgKiAgIEBwYXJhbSBldmVudE5hbWUgW1N0cmluZ10gdGhlIGV2ZW50IG5hbWUgdG8gcmVnaXN0ZXIgdGhlIGxpc3RlbmVyIGZvcgogICAqICAgQHBhcmFtIGNhbGxiYWNrIFtGdW5jdGlvbl0gdGhlIGxpc3RlbmVyIGNhbGxiYWNrIGZ1bmN0aW9uCiAgICogICBAcGFyYW0gdG9IZWFkIFtCb29sZWFuXSBhdHRhY2ggdGhlIGxpc3RlbmVyIGNhbGxiYWNrIHRvIHRoZSBoZWFkIG9mIGNhbGxiYWNrIGFycmF5IGlmIHNldCB0byB0cnVlLgogICAqICAgICBEZWZhdWx0IHRvIGJlIGZhbHNlLgogICAqICAgQHJldHVybiBbQVdTLlNlcXVlbnRpYWxFeGVjdXRvcl0gdGhlIHNhbWUgb2JqZWN0IGZvciBjaGFpbmluZwogICAqLwogIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IgPSBBV1MudXRpbC5pbmhlcml0KHsKICAKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBTZXF1ZW50aWFsRXhlY3V0b3IoKSB7CiAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxpc3RlbmVyczogZnVuY3Rpb24gbGlzdGVuZXJzKGV2ZW50TmFtZSkgewogICAgICByZXR1cm4gdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0gPyB0aGlzLl9ldmVudHNbZXZlbnROYW1lXS5zbGljZSgwKSA6IFtdOwogICAgfSwKICAKICAgIG9uOiBmdW5jdGlvbiBvbihldmVudE5hbWUsIGxpc3RlbmVyLCB0b0hlYWQpIHsKICAgICAgaWYgKHRoaXMuX2V2ZW50c1tldmVudE5hbWVdKSB7CiAgICAgICAgdG9IZWFkID8KICAgICAgICAgIHRoaXMuX2V2ZW50c1tldmVudE5hbWVdLnVuc2hpZnQobGlzdGVuZXIpIDoKICAgICAgICAgIHRoaXMuX2V2ZW50c1tldmVudE5hbWVdLnB1c2gobGlzdGVuZXIpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX2V2ZW50c1tldmVudE5hbWVdID0gW2xpc3RlbmVyXTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICBvbkFzeW5jOiBmdW5jdGlvbiBvbkFzeW5jKGV2ZW50TmFtZSwgbGlzdGVuZXIsIHRvSGVhZCkgewogICAgICBsaXN0ZW5lci5faXNBc3luYyA9IHRydWU7CiAgICAgIHJldHVybiB0aGlzLm9uKGV2ZW50TmFtZSwgbGlzdGVuZXIsIHRvSGVhZCk7CiAgICB9LAogIAogICAgcmVtb3ZlTGlzdGVuZXI6IGZ1bmN0aW9uIHJlbW92ZUxpc3RlbmVyKGV2ZW50TmFtZSwgbGlzdGVuZXIpIHsKICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1tldmVudE5hbWVdOwogICAgICBpZiAobGlzdGVuZXJzKSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IGxpc3RlbmVycy5sZW5ndGg7CiAgICAgICAgdmFyIHBvc2l0aW9uID0gLTE7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgaWYgKGxpc3RlbmVyc1tpXSA9PT0gbGlzdGVuZXIpIHsKICAgICAgICAgICAgcG9zaXRpb24gPSBpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAocG9zaXRpb24gPiAtMSkgewogICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShwb3NpdGlvbiwgMSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIHJlbW92ZUFsbExpc3RlbmVyczogZnVuY3Rpb24gcmVtb3ZlQWxsTGlzdGVuZXJzKGV2ZW50TmFtZSkgewogICAgICBpZiAoZXZlbnROYW1lKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2V2ZW50c1tldmVudE5hbWVdOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGVtaXQ6IGZ1bmN0aW9uIGVtaXQoZXZlbnROYW1lLCBldmVudEFyZ3MsIGRvbmVDYWxsYmFjaykgewogICAgICBpZiAoIWRvbmVDYWxsYmFjaykgZG9uZUNhbGxiYWNrID0gZnVuY3Rpb24oKSB7IH07CiAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLmxpc3RlbmVycyhldmVudE5hbWUpOwogICAgICB2YXIgY291bnQgPSBsaXN0ZW5lcnMubGVuZ3RoOwogICAgICB0aGlzLmNhbGxMaXN0ZW5lcnMobGlzdGVuZXJzLCBldmVudEFyZ3MsIGRvbmVDYWxsYmFjayk7CiAgICAgIHJldHVybiBjb3VudCA+IDA7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY2FsbExpc3RlbmVyczogZnVuY3Rpb24gY2FsbExpc3RlbmVycyhsaXN0ZW5lcnMsIGFyZ3MsIGRvbmVDYWxsYmFjaywgcHJldkVycm9yKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGVycm9yID0gcHJldkVycm9yIHx8IG51bGw7CiAgCiAgICAgIGZ1bmN0aW9uIGNhbGxOZXh0TGlzdGVuZXIoZXJyKSB7CiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgZXJyb3IgPSBBV1MudXRpbC5lcnJvcihlcnJvciB8fCBuZXcgRXJyb3IoKSwgZXJyKTsKICAgICAgICAgIGlmIChzZWxmLl9oYWx0SGFuZGxlcnNPbkVycm9yKSB7CiAgICAgICAgICAgIHJldHVybiBkb25lQ2FsbGJhY2suY2FsbChzZWxmLCBlcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHNlbGYuY2FsbExpc3RlbmVycyhsaXN0ZW5lcnMsIGFyZ3MsIGRvbmVDYWxsYmFjaywgZXJyb3IpOwogICAgICB9CiAgCiAgICAgIHdoaWxlIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgIHZhciBsaXN0ZW5lciA9IGxpc3RlbmVycy5zaGlmdCgpOwogICAgICAgIGlmIChsaXN0ZW5lci5faXNBc3luYykgeyAvLyBhc3luY2hyb25vdXMgbGlzdGVuZXIKICAgICAgICAgIGxpc3RlbmVyLmFwcGx5KHNlbGYsIGFyZ3MuY29uY2F0KFtjYWxsTmV4dExpc3RlbmVyXSkpOwogICAgICAgICAgcmV0dXJuOyAvLyBzdG9wIGhlcmUsIGNhbGxOZXh0TGlzdGVuZXIgd2lsbCBjb250aW51ZQogICAgICAgIH0gZWxzZSB7IC8vIHN5bmNocm9ub3VzIGxpc3RlbmVyCiAgICAgICAgICB0cnkgewogICAgICAgICAgICBsaXN0ZW5lci5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICBlcnJvciA9IEFXUy51dGlsLmVycm9yKGVycm9yIHx8IG5ldyBFcnJvcigpLCBlcnIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGVycm9yICYmIHNlbGYuX2hhbHRIYW5kbGVyc09uRXJyb3IpIHsKICAgICAgICAgICAgZG9uZUNhbGxiYWNrLmNhbGwoc2VsZiwgZXJyb3IpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGRvbmVDYWxsYmFjay5jYWxsKHNlbGYsIGVycm9yKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEFkZHMgb3IgY29waWVzIGEgc2V0IG9mIGxpc3RlbmVycyBmcm9tIGFub3RoZXIgbGlzdCBvZgogICAgICogbGlzdGVuZXJzIG9yIFNlcXVlbnRpYWxFeGVjdXRvciBvYmplY3QuCiAgICAgKgogICAgICogQHBhcmFtIGxpc3RlbmVycyBbbWFwPFN0cmluZyxBcnJheTxGdW5jdGlvbj4+LCBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yXQogICAgICogICBhIGxpc3Qgb2YgZXZlbnRzIGFuZCBjYWxsYmFja3MsIG9yIGFuIGV2ZW50IGVtaXR0ZXIgb2JqZWN0CiAgICAgKiAgIGNvbnRhaW5pbmcgbGlzdGVuZXJzIHRvIGFkZCB0byB0aGlzIGVtaXR0ZXIgb2JqZWN0LgogICAgICogQHJldHVybiBbQVdTLlNlcXVlbnRpYWxFeGVjdXRvcl0gdGhlIGVtaXR0ZXIgb2JqZWN0LCBmb3IgY2hhaW5pbmcuCiAgICAgKiBAZXhhbXBsZSBBZGRpbmcgbGlzdGVuZXJzIGZyb20gYSBtYXAgb2YgbGlzdGVuZXJzCiAgICAgKiAgIGVtaXR0ZXIuYWRkTGlzdGVuZXJzKHsKICAgICAqICAgICBldmVudDE6IFtmdW5jdGlvbigpIHsgLi4uIH0sIGZ1bmN0aW9uKCkgeyAuLi4gfV0sCiAgICAgKiAgICAgZXZlbnQyOiBbZnVuY3Rpb24oKSB7IC4uLiB9XQogICAgICogICB9KTsKICAgICAqICAgZW1pdHRlci5lbWl0KCdldmVudDEnKTsgLy8gZW1pdHRlciBoYXMgZXZlbnQxCiAgICAgKiAgIGVtaXR0ZXIuZW1pdCgnZXZlbnQyJyk7IC8vIGVtaXR0ZXIgaGFzIGV2ZW50MgogICAgICogQGV4YW1wbGUgQWRkaW5nIGxpc3RlbmVycyBmcm9tIGFub3RoZXIgZW1pdHRlciBvYmplY3QKICAgICAqICAgdmFyIGVtaXR0ZXIxID0gbmV3IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IoKTsKICAgICAqICAgZW1pdHRlcjEub24oJ2V2ZW50MScsIGZ1bmN0aW9uKCkgeyAuLi4gfSk7CiAgICAgKiAgIGVtaXR0ZXIxLm9uKCdldmVudDInLCBmdW5jdGlvbigpIHsgLi4uIH0pOwogICAgICogICB2YXIgZW1pdHRlcjIgPSBuZXcgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcigpOwogICAgICogICBlbWl0dGVyMi5hZGRMaXN0ZW5lcnMoZW1pdHRlcjEpOwogICAgICogICBlbWl0dGVyMi5lbWl0KCdldmVudDEnKTsgLy8gZW1pdHRlcjIgaGFzIGV2ZW50MQogICAgICogICBlbWl0dGVyMi5lbWl0KCdldmVudDInKTsgLy8gZW1pdHRlcjIgaGFzIGV2ZW50MgogICAgICovCiAgICBhZGRMaXN0ZW5lcnM6IGZ1bmN0aW9uIGFkZExpc3RlbmVycyhsaXN0ZW5lcnMpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogIAogICAgICAvLyBleHRyYWN0IGxpc3RlbmVycyBpZiBwYXJhbWV0ZXIgaXMgYW4gU2VxdWVudGlhbEV4ZWN1dG9yIG9iamVjdAogICAgICBpZiAobGlzdGVuZXJzLl9ldmVudHMpIGxpc3RlbmVycyA9IGxpc3RlbmVycy5fZXZlbnRzOwogIAogICAgICBBV1MudXRpbC5lYWNoKGxpc3RlbmVycywgZnVuY3Rpb24oZXZlbnQsIGNhbGxiYWNrcykgewogICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2tzID09PSAnZnVuY3Rpb24nKSBjYWxsYmFja3MgPSBbY2FsbGJhY2tzXTsKICAgICAgICBBV1MudXRpbC5hcnJheUVhY2goY2FsbGJhY2tzLCBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgc2VsZi5vbihldmVudCwgY2FsbGJhY2spOwogICAgICAgIH0pOwogICAgICB9KTsKICAKICAgICAgcmV0dXJuIHNlbGY7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBSZWdpc3RlcnMgYW4gZXZlbnQgd2l0aCB7b259IGFuZCBzYXZlcyB0aGUgY2FsbGJhY2sgaGFuZGxlIGZ1bmN0aW9uCiAgICAgKiBhcyBhIHByb3BlcnR5IG9uIHRoZSBlbWl0dGVyIG9iamVjdCB1c2luZyBhIGdpdmVuIGBuYW1lYC4KICAgICAqCiAgICAgKiBAcGFyYW0gbmFtZSBbU3RyaW5nXSB0aGUgcHJvcGVydHkgbmFtZSB0byBzZXQgb24gdGhpcyBvYmplY3QgY29udGFpbmluZwogICAgICogICB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gaGFuZGxlIHNvIHRoYXQgdGhlIGxpc3RlbmVyIGNhbiBiZSByZW1vdmVkIGluCiAgICAgKiAgIHRoZSBmdXR1cmUuCiAgICAgKiBAcGFyYW0gKHNlZSBvbikKICAgICAqIEByZXR1cm4gKHNlZSBvbikKICAgICAqIEBleGFtcGxlIEFkZGluZyBhIG5hbWVkIGxpc3RlbmVyIERBVEFfQ0FMTEJBQ0sKICAgICAqICAgdmFyIGxpc3RlbmVyID0gZnVuY3Rpb24oKSB7IGRvU29tZXRoaW5nKCk7IH07CiAgICAgKiAgIGVtaXR0ZXIuYWRkTmFtZWRMaXN0ZW5lcignREFUQV9DQUxMQkFDSycsICdkYXRhJywgbGlzdGVuZXIpOwogICAgICoKICAgICAqICAgLy8gdGhlIGZvbGxvd2luZyBwcmludHM6IHRydWUKICAgICAqICAgY29uc29sZS5sb2coZW1pdHRlci5EQVRBX0NBTExCQUNLID09IGxpc3RlbmVyKTsKICAgICAqLwogICAgYWRkTmFtZWRMaXN0ZW5lcjogZnVuY3Rpb24gYWRkTmFtZWRMaXN0ZW5lcihuYW1lLCBldmVudE5hbWUsIGNhbGxiYWNrLCB0b0hlYWQpIHsKICAgICAgdGhpc1tuYW1lXSA9IGNhbGxiYWNrOwogICAgICB0aGlzLmFkZExpc3RlbmVyKGV2ZW50TmFtZSwgY2FsbGJhY2ssIHRvSGVhZCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFkZE5hbWVkQXN5bmNMaXN0ZW5lcjogZnVuY3Rpb24gYWRkTmFtZWRBc3luY0xpc3RlbmVyKG5hbWUsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIHRvSGVhZCkgewogICAgICBjYWxsYmFjay5faXNBc3luYyA9IHRydWU7CiAgICAgIHJldHVybiB0aGlzLmFkZE5hbWVkTGlzdGVuZXIobmFtZSwgZXZlbnROYW1lLCBjYWxsYmFjaywgdG9IZWFkKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEhlbHBlciBtZXRob2QgdG8gYWRkIGEgc2V0IG9mIG5hbWVkIGxpc3RlbmVycyB1c2luZwogICAgICoge2FkZE5hbWVkTGlzdGVuZXJ9LiBUaGUgY2FsbGJhY2sgY29udGFpbnMgYSBwYXJhbWV0ZXIKICAgICAqIHdpdGggYSBoYW5kbGUgdG8gdGhlIGBhZGROYW1lZExpc3RlbmVyYCBtZXRob2QuCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGFkZCkKICAgICAqICAgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIGlzIGNhbGxlZCBpbW1lZGlhdGVseSBpbiBvcmRlciB0byBwcm92aWRlCiAgICAgKiAgIHRoZSBgYWRkYCBmdW5jdGlvbiB0byB0aGUgYmxvY2suIFRoaXMgc2ltcGxpZmllcyB0aGUgYWRkaXRpb24gb2YKICAgICAqICAgYSBsYXJnZSBncm91cCBvZiBuYW1lZCBsaXN0ZW5lcnMuCiAgICAgKiAgIEBwYXJhbSBhZGQgW0Z1bmN0aW9uXSB0aGUge2FkZE5hbWVkTGlzdGVuZXJ9IGZ1bmN0aW9uIHRvIGNhbGwKICAgICAqICAgICB3aGVuIHJlZ2lzdGVyaW5nIGxpc3RlbmVycy4KICAgICAqIEBleGFtcGxlIEFkZGluZyBhIHNldCBvZiBuYW1lZCBsaXN0ZW5lcnMKICAgICAqICAgZW1pdHRlci5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAqICAgICBhZGQoJ0RBVEFfQ0FMTEJBQ0snLCAnZGF0YScsIGZ1bmN0aW9uKCkgeyAuLi4gfSk7CiAgICAgKiAgICAgYWRkKCdPVEhFUicsICdvdGhlckV2ZW50JywgZnVuY3Rpb24oKSB7IC4uLiB9KTsKICAgICAqICAgICBhZGQoJ0xBU1QnLCAnbGFzdEV2ZW50JywgZnVuY3Rpb24oKSB7IC4uLiB9KTsKICAgICAqICAgfSk7CiAgICAgKgogICAgICogICAvLyB0aGVzZSBwcm9wZXJ0aWVzIGFyZSBub3cgc2V0OgogICAgICogICBlbWl0dGVyLkRBVEFfQ0FMTEJBQ0s7CiAgICAgKiAgIGVtaXR0ZXIuT1RIRVI7CiAgICAgKiAgIGVtaXR0ZXIuTEFTVDsKICAgICAqLwogICAgYWRkTmFtZWRMaXN0ZW5lcnM6IGZ1bmN0aW9uIGFkZE5hbWVkTGlzdGVuZXJzKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgY2FsbGJhY2soCiAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICBzZWxmLmFkZE5hbWVkTGlzdGVuZXIuYXBwbHkoc2VsZiwgYXJndW1lbnRzKTsKICAgICAgICB9LAogICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgc2VsZi5hZGROYW1lZEFzeW5jTGlzdGVuZXIuYXBwbHkoc2VsZiwgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICAgICk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH0pOwogIAogIC8qKgogICAqIHtvbn0gaXMgdGhlIHByZWZlcmVkIG1ldGhvZC4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLnByb3RvdHlwZS5hZGRMaXN0ZW5lciA9IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IucHJvdG90eXBlLm9uOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNlcXVlbnRpYWxFeGVjdXRvcjsKICAKICB9LHsiLi9jb3JlIjoxOH1dLDU5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKHByb2Nlc3MpeyhmdW5jdGlvbiAoKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgdmFyIEFwaSA9IHJlcXVpcmUoJy4vbW9kZWwvYXBpJyk7CiAgdmFyIHJlZ2lvbkNvbmZpZyA9IHJlcXVpcmUoJy4vcmVnaW9uX2NvbmZpZycpOwogIAogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICB2YXIgY2xpZW50Q291bnQgPSAwOwogIAogIC8qKgogICAqIFRoZSBzZXJ2aWNlIGNsYXNzIHJlcHJlc2VudGluZyBhbiBBV1Mgc2VydmljZS4KICAgKgogICAqIEBjbGFzc19hYnN0cmFjdCBUaGlzIGNsYXNzIGlzIGFuIGFic3RyYWN0IGNsYXNzLgogICAqCiAgICogQCFhdHRyaWJ1dGUgYXBpVmVyc2lvbnMKICAgKiAgIEByZXR1cm4gW0FycmF5PFN0cmluZz5dIHRoZSBsaXN0IG9mIEFQSSB2ZXJzaW9ucyBzdXBwb3J0ZWQgYnkgdGhpcyBzZXJ2aWNlLgogICAqICAgQHJlYWRvbmx5CiAgICovCiAgQVdTLlNlcnZpY2UgPSBpbmhlcml0KHsKICAgIC8qKgogICAgICogQ3JlYXRlIGEgbmV3IHNlcnZpY2Ugb2JqZWN0IHdpdGggYSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICoKICAgICAqIEBwYXJhbSBjb25maWcgW21hcF0gYSBtYXAgb2YgY29uZmlndXJhdGlvbiBvcHRpb25zCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBTZXJ2aWNlKGNvbmZpZykgewogICAgICBpZiAoIXRoaXMubG9hZFNlcnZpY2VDbGFzcykgewogICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAgJ1NlcnZpY2UgbXVzdCBiZSBjb25zdHJ1Y3RlZCB3aXRoIGBuZXdcJyBvcGVyYXRvcicpOwogICAgICB9CiAgICAgIHZhciBTZXJ2aWNlQ2xhc3MgPSB0aGlzLmxvYWRTZXJ2aWNlQ2xhc3MoY29uZmlnIHx8IHt9KTsKICAgICAgaWYgKFNlcnZpY2VDbGFzcykgewogICAgICAgIHZhciBvcmlnaW5hbENvbmZpZyA9IEFXUy51dGlsLmNvcHkoY29uZmlnKTsKICAgICAgICB2YXIgc3ZjID0gbmV3IFNlcnZpY2VDbGFzcyhjb25maWcpOwogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShzdmMsICdfb3JpZ2luYWxDb25maWcnLCB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gb3JpZ2luYWxDb25maWc7IH0sCiAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIHN2Yy5fY2xpZW50SWQgPSArK2NsaWVudENvdW50OwogICAgICAgIHJldHVybiBzdmM7CiAgICAgIH0KICAgICAgdGhpcy5pbml0aWFsaXplKGNvbmZpZyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gaW5pdGlhbGl6ZShjb25maWcpIHsKICAgICAgdmFyIHN2Y0NvbmZpZyA9IEFXUy5jb25maWdbdGhpcy5zZXJ2aWNlSWRlbnRpZmllcl07CiAgICAgIHRoaXMuY29uZmlnID0gbmV3IEFXUy5Db25maWcoQVdTLmNvbmZpZyk7CiAgICAgIGlmIChzdmNDb25maWcpIHRoaXMuY29uZmlnLnVwZGF0ZShzdmNDb25maWcsIHRydWUpOwogICAgICBpZiAoY29uZmlnKSB0aGlzLmNvbmZpZy51cGRhdGUoY29uZmlnLCB0cnVlKTsKICAKICAgICAgdGhpcy52YWxpZGF0ZVNlcnZpY2UoKTsKICAgICAgaWYgKCF0aGlzLmNvbmZpZy5lbmRwb2ludCkgcmVnaW9uQ29uZmlnKHRoaXMpOwogIAogICAgICB0aGlzLmNvbmZpZy5lbmRwb2ludCA9IHRoaXMuZW5kcG9pbnRGcm9tVGVtcGxhdGUodGhpcy5jb25maWcuZW5kcG9pbnQpOwogICAgICB0aGlzLnNldEVuZHBvaW50KHRoaXMuY29uZmlnLmVuZHBvaW50KTsKICAgICAgLy9lbmFibGUgYXR0YWNoaW5nIGxpc3RlbmVycyB0byBzZXJ2aWNlIGNsaWVudAogICAgICBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLmNhbGwodGhpcyk7CiAgICAgIEFXUy5TZXJ2aWNlLmFkZERlZmF1bHRNb25pdG9yaW5nTGlzdGVuZXJzKHRoaXMpOwogICAgICBpZiAoKHRoaXMuY29uZmlnLmNsaWVudFNpZGVNb25pdG9yaW5nIHx8IEFXUy5TZXJ2aWNlLl9jbGllbnRTaWRlTW9uaXRvcmluZykgJiYgdGhpcy5wdWJsaXNoZXIpIHsKICAgICAgICB2YXIgcHVibGlzaGVyID0gdGhpcy5wdWJsaXNoZXI7CiAgICAgICAgdGhpcy5hZGROYW1lZExpc3RlbmVyKCdQVUJMSVNIX0FQSV9DQUxMJywgJ2FwaUNhbGwnLCBmdW5jdGlvbiBQVUJMSVNIX0FQSV9DQUxMKGV2ZW50KSB7CiAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkge3B1Ymxpc2hlci5ldmVudEhhbmRsZXIoZXZlbnQpO30pOwogICAgICAgIH0pOwogICAgICAgIHRoaXMuYWRkTmFtZWRMaXN0ZW5lcignUFVCTElTSF9BUElfQVRURU1QVCcsICdhcGlDYWxsQXR0ZW1wdCcsIGZ1bmN0aW9uIFBVQkxJU0hfQVBJX0FUVEVNUFQoZXZlbnQpIHsKICAgICAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7cHVibGlzaGVyLmV2ZW50SGFuZGxlcihldmVudCk7fSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICB2YWxpZGF0ZVNlcnZpY2U6IGZ1bmN0aW9uIHZhbGlkYXRlU2VydmljZSgpIHsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkU2VydmljZUNsYXNzOiBmdW5jdGlvbiBsb2FkU2VydmljZUNsYXNzKHNlcnZpY2VDb25maWcpIHsKICAgICAgdmFyIGNvbmZpZyA9IHNlcnZpY2VDb25maWc7CiAgICAgIGlmICghQVdTLnV0aWwuaXNFbXB0eSh0aGlzLmFwaSkpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSBlbHNlIGlmIChjb25maWcuYXBpQ29uZmlnKSB7CiAgICAgICAgcmV0dXJuIEFXUy5TZXJ2aWNlLmRlZmluZVNlcnZpY2VBcGkodGhpcy5jb25zdHJ1Y3RvciwgY29uZmlnLmFwaUNvbmZpZyk7CiAgICAgIH0gZWxzZSBpZiAoIXRoaXMuY29uc3RydWN0b3Iuc2VydmljZXMpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25maWcgPSBuZXcgQVdTLkNvbmZpZyhBV1MuY29uZmlnKTsKICAgICAgICBjb25maWcudXBkYXRlKHNlcnZpY2VDb25maWcsIHRydWUpOwogICAgICAgIHZhciB2ZXJzaW9uID0gY29uZmlnLmFwaVZlcnNpb25zW3RoaXMuY29uc3RydWN0b3Iuc2VydmljZUlkZW50aWZpZXJdOwogICAgICAgIHZlcnNpb24gPSB2ZXJzaW9uIHx8IGNvbmZpZy5hcGlWZXJzaW9uOwogICAgICAgIHJldHVybiB0aGlzLmdldExhdGVzdFNlcnZpY2VDbGFzcyh2ZXJzaW9uKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldExhdGVzdFNlcnZpY2VDbGFzczogZnVuY3Rpb24gZ2V0TGF0ZXN0U2VydmljZUNsYXNzKHZlcnNpb24pIHsKICAgICAgdmVyc2lvbiA9IHRoaXMuZ2V0TGF0ZXN0U2VydmljZVZlcnNpb24odmVyc2lvbik7CiAgICAgIGlmICh0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzW3ZlcnNpb25dID09PSBudWxsKSB7CiAgICAgICAgQVdTLlNlcnZpY2UuZGVmaW5lU2VydmljZUFwaSh0aGlzLmNvbnN0cnVjdG9yLCB2ZXJzaW9uKTsKICAgICAgfQogIAogICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlc1t2ZXJzaW9uXTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRMYXRlc3RTZXJ2aWNlVmVyc2lvbjogZnVuY3Rpb24gZ2V0TGF0ZXN0U2VydmljZVZlcnNpb24odmVyc2lvbikgewogICAgICBpZiAoIXRoaXMuY29uc3RydWN0b3Iuc2VydmljZXMgfHwgdGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlcy5sZW5ndGggPT09IDApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHNlcnZpY2VzIGRlZmluZWQgb24gJyArCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3Iuc2VydmljZUlkZW50aWZpZXIpOwogICAgICB9CiAgCiAgICAgIGlmICghdmVyc2lvbikgewogICAgICAgIHZlcnNpb24gPSAnbGF0ZXN0JzsKICAgICAgfSBlbHNlIGlmIChBV1MudXRpbC5pc1R5cGUodmVyc2lvbiwgRGF0ZSkpIHsKICAgICAgICB2ZXJzaW9uID0gQVdTLnV0aWwuZGF0ZS5pc284NjAxKHZlcnNpb24pLnNwbGl0KCdUJylbMF07CiAgICAgIH0KICAKICAgICAgaWYgKE9iamVjdC5oYXNPd25Qcm9wZXJ0eSh0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzLCB2ZXJzaW9uKSkgewogICAgICAgIHJldHVybiB2ZXJzaW9uOwogICAgICB9CiAgCiAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXModGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlcykuc29ydCgpOwogICAgICB2YXIgc2VsZWN0ZWRWZXJzaW9uID0gbnVsbDsKICAgICAgZm9yICh2YXIgaSA9IGtleXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAvLyB2ZXJzaW9ucyB0aGF0IGVuZCBpbiAiKiIgYXJlIG5vdCBhdmFpbGFibGUgb24gZGlzayBhbmQgY2FuIGJlCiAgICAgICAgLy8gc2tpcHBlZCwgc28gZG8gbm90IGNob29zZSB0aGVzZSBhcyBzZWxlY3RlZFZlcnNpb25zCiAgICAgICAgaWYgKGtleXNbaV1ba2V5c1tpXS5sZW5ndGggLSAxXSAhPT0gJyonKSB7CiAgICAgICAgICBzZWxlY3RlZFZlcnNpb24gPSBrZXlzW2ldOwogICAgICAgIH0KICAgICAgICBpZiAoa2V5c1tpXS5zdWJzdHIoMCwgMTApIDw9IHZlcnNpb24pIHsKICAgICAgICAgIHJldHVybiBzZWxlY3RlZFZlcnNpb247CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGZpbmQgJyArIHRoaXMuY29uc3RydWN0b3Iuc2VydmljZUlkZW50aWZpZXIgKwogICAgICAgICAgICAgICAgICAgICAgJyBBUEkgdG8gc2F0aXNmeSB2ZXJzaW9uIGNvbnN0cmFpbnQgYCcgKyB2ZXJzaW9uICsgJ1wnJyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXBpOiB7fSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGRlZmF1bHRSZXRyeUNvdW50OiAzLAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY3VzdG9taXplUmVxdWVzdHM6IGZ1bmN0aW9uIGN1c3RvbWl6ZVJlcXVlc3RzKGNhbGxiYWNrKSB7CiAgICAgIGlmICghY2FsbGJhY2spIHsKICAgICAgICB0aGlzLmN1c3RvbVJlcXVlc3RIYW5kbGVyID0gbnVsbDsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0aGlzLmN1c3RvbVJlcXVlc3RIYW5kbGVyID0gY2FsbGJhY2s7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGNhbGxiYWNrIHR5cGUgXCcnICsgdHlwZW9mIGNhbGxiYWNrICsgJ1wnIHByb3ZpZGVkIGluIGN1c3RvbWl6ZVJlcXVlc3RzJyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIENhbGxzIGFuIG9wZXJhdGlvbiBvbiBhIHNlcnZpY2Ugd2l0aCB0aGUgZ2l2ZW4gaW5wdXQgcGFyYW1ldGVycy4KICAgICAqCiAgICAgKiBAcGFyYW0gb3BlcmF0aW9uIFtTdHJpbmddIHRoZSBuYW1lIG9mIHRoZSBvcGVyYXRpb24gdG8gY2FsbCBvbiB0aGUgc2VydmljZS4KICAgICAqIEBwYXJhbSBwYXJhbXMgW21hcF0gYSBtYXAgb2YgaW5wdXQgb3B0aW9ucyBmb3IgdGhlIG9wZXJhdGlvbgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgICAqICAgSWYgYSBjYWxsYmFjayBpcyBzdXBwbGllZCwgaXQgaXMgY2FsbGVkIHdoZW4gYSByZXNwb25zZSBpcyByZXR1cm5lZAogICAgICogICBmcm9tIHRoZSBzZXJ2aWNlLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAgICogICAgIFNldCB0byBgbnVsbGAgaWYgdGhlIHJlcXVlc3QgaXMgc3VjY2Vzc2Z1bC4KICAgICAqICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgZGF0YSByZXR1cm5lZCBmcm9tCiAgICAgKiAgICAgdGhlIHJlcXVlc3QuIFNldCB0byBgbnVsbGAgaWYgYSByZXF1ZXN0IGVycm9yIG9jY3Vycy4KICAgICAqLwogICAgbWFrZVJlcXVlc3Q6IGZ1bmN0aW9uIG1ha2VSZXF1ZXN0KG9wZXJhdGlvbiwgcGFyYW1zLCBjYWxsYmFjaykgewogICAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGNhbGxiYWNrID0gcGFyYW1zOwogICAgICAgIHBhcmFtcyA9IG51bGw7CiAgICAgIH0KICAKICAgICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9OwogICAgICBpZiAodGhpcy5jb25maWcucGFyYW1zKSB7IC8vIGNvcHkgb25seSB0b3BsZXZlbCBib3VuZCBwYXJhbXMKICAgICAgICB2YXIgcnVsZXMgPSB0aGlzLmFwaS5vcGVyYXRpb25zW29wZXJhdGlvbl07CiAgICAgICAgaWYgKHJ1bGVzKSB7CiAgICAgICAgICBwYXJhbXMgPSBBV1MudXRpbC5jb3B5KHBhcmFtcyk7CiAgICAgICAgICBBV1MudXRpbC5lYWNoKHRoaXMuY29uZmlnLnBhcmFtcywgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAocnVsZXMuaW5wdXQubWVtYmVyc1trZXldKSB7CiAgICAgICAgICAgICAgaWYgKHBhcmFtc1trZXldID09PSB1bmRlZmluZWQgfHwgcGFyYW1zW2tleV0gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHBhcmFtc1trZXldID0gdmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgdmFyIHJlcXVlc3QgPSBuZXcgQVdTLlJlcXVlc3QodGhpcywgb3BlcmF0aW9uLCBwYXJhbXMpOwogICAgICB0aGlzLmFkZEFsbFJlcXVlc3RMaXN0ZW5lcnMocmVxdWVzdCk7CiAgICAgIHRoaXMuYXR0YWNoTW9uaXRvcmluZ0VtaXR0ZXIocmVxdWVzdCk7CiAgICAgIGlmIChjYWxsYmFjaykgcmVxdWVzdC5zZW5kKGNhbGxiYWNrKTsKICAgICAgcmV0dXJuIHJlcXVlc3Q7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBDYWxscyBhbiBvcGVyYXRpb24gb24gYSBzZXJ2aWNlIHdpdGggdGhlIGdpdmVuIGlucHV0IHBhcmFtZXRlcnMsIHdpdGhvdXQKICAgICAqIGFueSBhdXRoZW50aWNhdGlvbiBkYXRhLiBUaGlzIG1ldGhvZCBpcyB1c2VmdWwgZm9yICJwdWJsaWMiIEFQSSBvcGVyYXRpb25zLgogICAgICoKICAgICAqIEBwYXJhbSBvcGVyYXRpb24gW1N0cmluZ10gdGhlIG5hbWUgb2YgdGhlIG9wZXJhdGlvbiB0byBjYWxsIG9uIHRoZSBzZXJ2aWNlLgogICAgICogQHBhcmFtIHBhcmFtcyBbbWFwXSBhIG1hcCBvZiBpbnB1dCBvcHRpb25zIGZvciB0aGUgb3BlcmF0aW9uCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBkYXRhKQogICAgICogICBJZiBhIGNhbGxiYWNrIGlzIHN1cHBsaWVkLCBpdCBpcyBjYWxsZWQgd2hlbiBhIHJlc3BvbnNlIGlzIHJldHVybmVkCiAgICAgKiAgIGZyb20gdGhlIHNlcnZpY2UuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICAgKiAgICAgU2V0IHRvIGBudWxsYCBpZiB0aGUgcmVxdWVzdCBpcyBzdWNjZXNzZnVsLgogICAgICogICBAcGFyYW0gZGF0YSBbT2JqZWN0XSB0aGUgZGUtc2VyaWFsaXplZCBkYXRhIHJldHVybmVkIGZyb20KICAgICAqICAgICB0aGUgcmVxdWVzdC4gU2V0IHRvIGBudWxsYCBpZiBhIHJlcXVlc3QgZXJyb3Igb2NjdXJzLgogICAgICovCiAgICBtYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdDogZnVuY3Rpb24gbWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3Qob3BlcmF0aW9uLCBwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIGlmICh0eXBlb2YgcGFyYW1zID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2FsbGJhY2sgPSBwYXJhbXM7CiAgICAgICAgcGFyYW1zID0ge307CiAgICAgIH0KICAKICAgICAgdmFyIHJlcXVlc3QgPSB0aGlzLm1ha2VSZXF1ZXN0KG9wZXJhdGlvbiwgcGFyYW1zKS50b1VuYXV0aGVudGljYXRlZCgpOwogICAgICByZXR1cm4gY2FsbGJhY2sgPyByZXF1ZXN0LnNlbmQoY2FsbGJhY2spIDogcmVxdWVzdDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFdhaXRzIGZvciBhIGdpdmVuIHN0YXRlCiAgICAgKgogICAgICogQHBhcmFtIHN0YXRlIFtTdHJpbmddIHRoZSBzdGF0ZSBvbiB0aGUgc2VydmljZSB0byB3YWl0IGZvcgogICAgICogQHBhcmFtIHBhcmFtcyBbbWFwXSBhIG1hcCBvZiBwYXJhbWV0ZXJzIHRvIHBhc3Mgd2l0aCBlYWNoIHJlcXVlc3QKICAgICAqIEBvcHRpb24gcGFyYW1zICR3YWl0ZXIgW21hcF0gYSBtYXAgb2YgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgd2FpdGVyCiAgICAgKiBAb3B0aW9uIHBhcmFtcyAkd2FpdGVyLmRlbGF5IFtOdW1iZXJdIFRoZSBudW1iZXIgb2Ygc2Vjb25kcyB0byB3YWl0IGJldHdlZW4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdHMKICAgICAqIEBvcHRpb24gcGFyYW1zICR3YWl0ZXIubWF4QXR0ZW1wdHMgW051bWJlcl0gVGhlIG1heGltdW0gbnVtYmVyIG9mIHJlcXVlc3RzCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIHNlbmQgd2hpbGUgd2FpdGluZwogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgICAqICAgSWYgYSBjYWxsYmFjayBpcyBzdXBwbGllZCwgaXQgaXMgY2FsbGVkIHdoZW4gYSByZXNwb25zZSBpcyByZXR1cm5lZAogICAgICogICBmcm9tIHRoZSBzZXJ2aWNlLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAgICogICAgIFNldCB0byBgbnVsbGAgaWYgdGhlIHJlcXVlc3QgaXMgc3VjY2Vzc2Z1bC4KICAgICAqICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgZGF0YSByZXR1cm5lZCBmcm9tCiAgICAgKiAgICAgdGhlIHJlcXVlc3QuIFNldCB0byBgbnVsbGAgaWYgYSByZXF1ZXN0IGVycm9yIG9jY3Vycy4KICAgICAqLwogICAgd2FpdEZvcjogZnVuY3Rpb24gd2FpdEZvcihzdGF0ZSwgcGFyYW1zLCBjYWxsYmFjaykgewogICAgICB2YXIgd2FpdGVyID0gbmV3IEFXUy5SZXNvdXJjZVdhaXRlcih0aGlzLCBzdGF0ZSk7CiAgICAgIHJldHVybiB3YWl0ZXIud2FpdChwYXJhbXMsIGNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhZGRBbGxSZXF1ZXN0TGlzdGVuZXJzOiBmdW5jdGlvbiBhZGRBbGxSZXF1ZXN0TGlzdGVuZXJzKHJlcXVlc3QpIHsKICAgICAgdmFyIGxpc3QgPSBbQVdTLmV2ZW50cywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUsIHRoaXMuc2VydmljZUludGVyZmFjZSgpLAogICAgICAgICAgICAgICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZVBvc3RdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAobGlzdFtpXSkgcmVxdWVzdC5hZGRMaXN0ZW5lcnMobGlzdFtpXSk7CiAgICAgIH0KICAKICAgICAgLy8gZGlzYWJsZSBwYXJhbWV0ZXIgdmFsaWRhdGlvbgogICAgICBpZiAoIXRoaXMuY29uZmlnLnBhcmFtVmFsaWRhdGlvbikgewogICAgICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywKICAgICAgICAgIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1BBUkFNRVRFUlMpOwogICAgICB9CiAgCiAgICAgIGlmICh0aGlzLmNvbmZpZy5sb2dnZXIpIHsgLy8gYWRkIGxvZ2dpbmcgZXZlbnRzCiAgICAgICAgcmVxdWVzdC5hZGRMaXN0ZW5lcnMoQVdTLkV2ZW50TGlzdGVuZXJzLkxvZ2dlcik7CiAgICAgIH0KICAKICAgICAgdGhpcy5zZXR1cFJlcXVlc3RMaXN0ZW5lcnMocmVxdWVzdCk7CiAgICAgIC8vIGNhbGwgcHJvdG90eXBlJ3MgY3VzdG9tUmVxdWVzdEhhbmRsZXIKICAgICAgaWYgKHR5cGVvZiB0aGlzLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5jdXN0b21SZXF1ZXN0SGFuZGxlciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRoaXMuY29uc3RydWN0b3IucHJvdG90eXBlLmN1c3RvbVJlcXVlc3RIYW5kbGVyKHJlcXVlc3QpOwogICAgICB9CiAgICAgIC8vIGNhbGwgaW5zdGFuY2UncyBjdXN0b21SZXF1ZXN0SGFuZGxlcgogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMsICdjdXN0b21SZXF1ZXN0SGFuZGxlcicpICYmIHR5cGVvZiB0aGlzLmN1c3RvbVJlcXVlc3RIYW5kbGVyID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhpcy5jdXN0b21SZXF1ZXN0SGFuZGxlcihyZXF1ZXN0KTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogRXZlbnQgcmVjb3JkaW5nIG1ldHJpY3MgZm9yIGEgd2hvbGUgQVBJIGNhbGwuCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBhIHN1YnNldCBvZiBhcGkgY2FsbCBtZXRyaWNzCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXBpQ2FsbEV2ZW50OiBmdW5jdGlvbiBhcGlDYWxsRXZlbnQocmVxdWVzdCkgewogICAgICB2YXIgYXBpID0gcmVxdWVzdC5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXTsKICAgICAgdmFyIG1vbml0b3JpbmdFdmVudCA9IHsKICAgICAgICBUeXBlOiAnQXBpQ2FsbCcsCiAgICAgICAgQXBpOiBhcGkgPyBhcGkubmFtZSA6IHJlcXVlc3Qub3BlcmF0aW9uLAogICAgICAgIFZlcnNpb246IDEsCiAgICAgICAgU2VydmljZTogcmVxdWVzdC5zZXJ2aWNlLmFwaS5zZXJ2aWNlSWQgfHwgcmVxdWVzdC5zZXJ2aWNlLmFwaS5lbmRwb2ludFByZWZpeCwKICAgICAgICBSZWdpb246IHJlcXVlc3QuaHR0cFJlcXVlc3QucmVnaW9uLAogICAgICAgIE1heFJldHJpZXNFeGNlZWRlZDogMCwKICAgICAgICBVc2VyQWdlbnQ6IHJlcXVlc3QuaHR0cFJlcXVlc3QuZ2V0VXNlckFnZW50KCksCiAgICAgIH07CiAgICAgIHZhciByZXNwb25zZSA9IHJlcXVlc3QucmVzcG9uc2U7CiAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5GaW5hbEh0dHBTdGF0dXNDb2RlID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgIH0KICAgICAgaWYgKHJlc3BvbnNlLmVycm9yKSB7CiAgICAgICAgdmFyIGVycm9yID0gcmVzcG9uc2UuZXJyb3I7CiAgICAgICAgdmFyIHN0YXR1c0NvZGUgPSByZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICBpZiAoc3RhdHVzQ29kZSA+IDI5OSkgewogICAgICAgICAgaWYgKGVycm9yLmNvZGUpIG1vbml0b3JpbmdFdmVudC5GaW5hbEF3c0V4Y2VwdGlvbiA9IGVycm9yLmNvZGU7CiAgICAgICAgICBpZiAoZXJyb3IubWVzc2FnZSkgbW9uaXRvcmluZ0V2ZW50LkZpbmFsQXdzRXhjZXB0aW9uTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChlcnJvci5jb2RlIHx8IGVycm9yLm5hbWUpIG1vbml0b3JpbmdFdmVudC5GaW5hbFNka0V4Y2VwdGlvbiA9IGVycm9yLmNvZGUgfHwgZXJyb3IubmFtZTsKICAgICAgICAgIGlmIChlcnJvci5tZXNzYWdlKSBtb25pdG9yaW5nRXZlbnQuRmluYWxTZGtFeGNlcHRpb25NZXNzYWdlID0gZXJyb3IubWVzc2FnZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG1vbml0b3JpbmdFdmVudDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEV2ZW50IHJlY29yZGluZyBtZXRyaWNzIGZvciBhbiBBUEkgY2FsbCBhdHRlbXB0LgogICAgICogQHJldHVybnMge29iamVjdH0gYSBzdWJzZXQgb2YgYXBpIGNhbGwgYXR0ZW1wdCBtZXRyaWNzCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXBpQXR0ZW1wdEV2ZW50OiBmdW5jdGlvbiBhcGlBdHRlbXB0RXZlbnQocmVxdWVzdCkgewogICAgICB2YXIgYXBpID0gcmVxdWVzdC5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXTsKICAgICAgdmFyIG1vbml0b3JpbmdFdmVudCA9IHsKICAgICAgICBUeXBlOiAnQXBpQ2FsbEF0dGVtcHQnLAogICAgICAgIEFwaTogYXBpID8gYXBpLm5hbWUgOiByZXF1ZXN0Lm9wZXJhdGlvbiwKICAgICAgICBWZXJzaW9uOiAxLAogICAgICAgIFNlcnZpY2U6IHJlcXVlc3Quc2VydmljZS5hcGkuc2VydmljZUlkIHx8IHJlcXVlc3Quc2VydmljZS5hcGkuZW5kcG9pbnRQcmVmaXgsCiAgICAgICAgRnFkbjogcmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludC5ob3N0bmFtZSwKICAgICAgICBVc2VyQWdlbnQ6IHJlcXVlc3QuaHR0cFJlcXVlc3QuZ2V0VXNlckFnZW50KCksCiAgICAgIH07CiAgICAgIHZhciByZXNwb25zZSA9IHJlcXVlc3QucmVzcG9uc2U7CiAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5IdHRwU3RhdHVzQ29kZSA9IHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICB9CiAgICAgIGlmICgKICAgICAgICAhcmVxdWVzdC5fdW5BdXRoZW50aWNhdGVkICYmCiAgICAgICAgcmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscyAmJgogICAgICAgIHJlcXVlc3Quc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQKICAgICAgKSB7CiAgICAgICAgbW9uaXRvcmluZ0V2ZW50LkFjY2Vzc0tleSA9IHJlcXVlc3Quc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQ7CiAgICAgIH0KICAgICAgaWYgKCFyZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVycykgcmV0dXJuIG1vbml0b3JpbmdFdmVudDsKICAgICAgaWYgKHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1sneC1hbXotc2VjdXJpdHktdG9rZW4nXSkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5TZXNzaW9uVG9rZW4gPSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LXNlY3VyaXR5LXRva2VuJ107CiAgICAgIH0KICAgICAgaWYgKHJlc3BvbnNlLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtem4tcmVxdWVzdGlkJ10pIHsKICAgICAgICBtb25pdG9yaW5nRXZlbnQuWEFtem5SZXF1ZXN0SWQgPSByZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXpuLXJlcXVlc3RpZCddOwogICAgICB9CiAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXotcmVxdWVzdC1pZCddKSB7CiAgICAgICAgbW9uaXRvcmluZ0V2ZW50LlhBbXpSZXF1ZXN0SWQgPSByZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXotcmVxdWVzdC1pZCddOwogICAgICB9CiAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXotaWQtMiddKSB7CiAgICAgICAgbW9uaXRvcmluZ0V2ZW50LlhBbXpJZDIgPSByZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXotaWQtMiddOwogICAgICB9CiAgICAgIHJldHVybiBtb25pdG9yaW5nRXZlbnQ7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBBZGQgbWV0cmljcyBvZiBmYWlsZWQgcmVxdWVzdC4KICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhdHRlbXB0RmFpbEV2ZW50OiBmdW5jdGlvbiBhdHRlbXB0RmFpbEV2ZW50KHJlcXVlc3QpIHsKICAgICAgdmFyIG1vbml0b3JpbmdFdmVudCA9IHRoaXMuYXBpQXR0ZW1wdEV2ZW50KHJlcXVlc3QpOwogICAgICB2YXIgcmVzcG9uc2UgPSByZXF1ZXN0LnJlc3BvbnNlOwogICAgICB2YXIgZXJyb3IgPSByZXNwb25zZS5lcnJvcjsKICAgICAgaWYgKHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlID4gMjk5ICkgewogICAgICAgIGlmIChlcnJvci5jb2RlKSBtb25pdG9yaW5nRXZlbnQuQXdzRXhjZXB0aW9uID0gZXJyb3IuY29kZTsKICAgICAgICBpZiAoZXJyb3IubWVzc2FnZSkgbW9uaXRvcmluZ0V2ZW50LkF3c0V4Y2VwdGlvbk1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChlcnJvci5jb2RlIHx8IGVycm9yLm5hbWUpIG1vbml0b3JpbmdFdmVudC5TZGtFeGNlcHRpb24gPSBlcnJvci5jb2RlIHx8IGVycm9yLm5hbWU7CiAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIG1vbml0b3JpbmdFdmVudC5TZGtFeGNlcHRpb25NZXNzYWdlID0gZXJyb3IubWVzc2FnZTsKICAgICAgfQogICAgICByZXR1cm4gbW9uaXRvcmluZ0V2ZW50OwogICAgfSwKICAKICAgIC8qKgogICAgICogQXR0YWNoIGxpc3RlbmVycyB0byByZXF1ZXN0IG9iamVjdCB0byBmZXRjaCBtZXRyaWNzIG9mIGVhY2ggcmVxdWVzdAogICAgICogYW5kIGVtaXQgZGF0YSBvYmplY3QgdGhyb3VnaCBcJ0FwaUNhbGxcJyBhbmQgXCdBcGlDYWxsQXR0ZW1wdFwnIGV2ZW50cy4KICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhdHRhY2hNb25pdG9yaW5nRW1pdHRlcjogZnVuY3Rpb24gYXR0YWNoTW9uaXRvcmluZ0VtaXR0ZXIocmVxdWVzdCkgewogICAgICB2YXIgYXR0ZW1wdFRpbWVzdGFtcDsgLy90aW1lc3RhbXAgbWFya2luZyB0aGUgYmVnaW5uaW5nIG9mIGEgcmVxdWVzdCBhdHRlbXB0CiAgICAgIHZhciBhdHRlbXB0U3RhcnRSZWFsVGltZTsgLy9TdGFydCB0aW1lIG9mIHJlcXVlc3QgYXR0ZW1wdC4gVXNlZCB0byBjYWxjdWxhdGluZyBhdHRlbXB0TGF0ZW5jeQogICAgICB2YXIgYXR0ZW1wdExhdGVuY3k7IC8vbGF0ZW5jeSBmcm9tIHJlcXVlc3Qgc2VudCBvdXQgdG8gaHR0cCByZXNwb25zZSByZWFjaGluZyBTREsKICAgICAgdmFyIGNhbGxTdGFydFJlYWxUaW1lOyAvL1N0YXJ0IHRpbWUgb2YgQVBJIGNhbGwuIFVzZWQgdG8gY2FsY3VsYXRpbmcgQVBJIGNhbGwgbGF0ZW5jeQogICAgICB2YXIgYXR0ZW1wdENvdW50ID0gMDsgLy9yZXF1ZXN0LnJldHJ5Q291bnQgaXMgbm90IHJlbGlhYmxlIGhlcmUKICAgICAgdmFyIHJlZ2lvbjsgLy9yZWdpb24gY2FjaGUgcmVnaW9uIGZvciBlYWNoIGF0dGVtcHQgc2luY2UgaXQgY2FuIGJlIHVwZGF0ZWQgaW4gcGxhc2UgKGUuZy4gczMpCiAgICAgIHZhciBjYWxsVGltZXN0YW1wOyAvL3RpbWVzdGFtcCB3aGVuIHRoZSByZXF1ZXN0IGlzIGNyZWF0ZWQKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgYWRkVG9IZWFkID0gdHJ1ZTsKICAKICAgICAgcmVxdWVzdC5vbigndmFsaWRhdGUnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgY2FsbFN0YXJ0UmVhbFRpbWUgPSBBV1MudXRpbC5yZWFsQ2xvY2subm93KCk7CiAgICAgICAgY2FsbFRpbWVzdGFtcCA9IERhdGUubm93KCk7CiAgICAgIH0sIGFkZFRvSGVhZCk7CiAgICAgIHJlcXVlc3Qub24oJ3NpZ24nLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgYXR0ZW1wdFN0YXJ0UmVhbFRpbWUgPSBBV1MudXRpbC5yZWFsQ2xvY2subm93KCk7CiAgICAgICAgYXR0ZW1wdFRpbWVzdGFtcCA9IERhdGUubm93KCk7CiAgICAgICAgcmVnaW9uID0gcmVxdWVzdC5odHRwUmVxdWVzdC5yZWdpb247CiAgICAgICAgYXR0ZW1wdENvdW50Kys7CiAgICAgIH0sIGFkZFRvSGVhZCk7CiAgICAgIHJlcXVlc3Qub24oJ3ZhbGlkYXRlUmVzcG9uc2UnLCBmdW5jdGlvbigpIHsKICAgICAgICBhdHRlbXB0TGF0ZW5jeSA9IE1hdGgucm91bmQoQVdTLnV0aWwucmVhbENsb2NrLm5vdygpIC0gYXR0ZW1wdFN0YXJ0UmVhbFRpbWUpOwogICAgICB9KTsKICAgICAgcmVxdWVzdC5hZGROYW1lZExpc3RlbmVyKCdBUElfQ0FMTF9BVFRFTVBUJywgJ3N1Y2Nlc3MnLCBmdW5jdGlvbiBBUElfQ0FMTF9BVFRFTVBUKCkgewogICAgICAgIHZhciBhcGlBdHRlbXB0RXZlbnQgPSBzZWxmLmFwaUF0dGVtcHRFdmVudChyZXF1ZXN0KTsKICAgICAgICBhcGlBdHRlbXB0RXZlbnQuVGltZXN0YW1wID0gYXR0ZW1wdFRpbWVzdGFtcDsKICAgICAgICBhcGlBdHRlbXB0RXZlbnQuQXR0ZW1wdExhdGVuY3kgPSBhdHRlbXB0TGF0ZW5jeSA+PSAwID8gYXR0ZW1wdExhdGVuY3kgOiAwOwogICAgICAgIGFwaUF0dGVtcHRFdmVudC5SZWdpb24gPSByZWdpb247CiAgICAgICAgc2VsZi5lbWl0KCdhcGlDYWxsQXR0ZW1wdCcsIFthcGlBdHRlbXB0RXZlbnRdKTsKICAgICAgfSk7CiAgICAgIHJlcXVlc3QuYWRkTmFtZWRMaXN0ZW5lcignQVBJX0NBTExfQVRURU1QVF9SRVRSWScsICdyZXRyeScsIGZ1bmN0aW9uIEFQSV9DQUxMX0FUVEVNUFRfUkVUUlkoKSB7CiAgICAgICAgdmFyIGFwaUF0dGVtcHRFdmVudCA9IHNlbGYuYXR0ZW1wdEZhaWxFdmVudChyZXF1ZXN0KTsKICAgICAgICBhcGlBdHRlbXB0RXZlbnQuVGltZXN0YW1wID0gYXR0ZW1wdFRpbWVzdGFtcDsKICAgICAgICAvL2F0dGVtcHRMYXRlbmN5IG1heSBub3QgYmUgYXZhaWxhYmxlIGlmIGZhaWwgYmVmb3JlIHJlc3BvbnNlCiAgICAgICAgYXR0ZW1wdExhdGVuY3kgPSBhdHRlbXB0TGF0ZW5jeSB8fAogICAgICAgICAgTWF0aC5yb3VuZChBV1MudXRpbC5yZWFsQ2xvY2subm93KCkgLSBhdHRlbXB0U3RhcnRSZWFsVGltZSk7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LkF0dGVtcHRMYXRlbmN5ID0gYXR0ZW1wdExhdGVuY3kgPj0gMCA/IGF0dGVtcHRMYXRlbmN5IDogMDsKICAgICAgICBhcGlBdHRlbXB0RXZlbnQuUmVnaW9uID0gcmVnaW9uOwogICAgICAgIHNlbGYuZW1pdCgnYXBpQ2FsbEF0dGVtcHQnLCBbYXBpQXR0ZW1wdEV2ZW50XSk7CiAgICAgIH0pOwogICAgICByZXF1ZXN0LmFkZE5hbWVkTGlzdGVuZXIoJ0FQSV9DQUxMJywgJ2NvbXBsZXRlJywgZnVuY3Rpb24gQVBJX0NBTEwoKSB7CiAgICAgICAgdmFyIGFwaUNhbGxFdmVudCA9IHNlbGYuYXBpQ2FsbEV2ZW50KHJlcXVlc3QpOwogICAgICAgIGFwaUNhbGxFdmVudC5BdHRlbXB0Q291bnQgPSBhdHRlbXB0Q291bnQ7CiAgICAgICAgaWYgKGFwaUNhbGxFdmVudC5BdHRlbXB0Q291bnQgPD0gMCkgcmV0dXJuOwogICAgICAgIGFwaUNhbGxFdmVudC5UaW1lc3RhbXAgPSBjYWxsVGltZXN0YW1wOwogICAgICAgIHZhciBsYXRlbmN5ID0gTWF0aC5yb3VuZChBV1MudXRpbC5yZWFsQ2xvY2subm93KCkgLSBjYWxsU3RhcnRSZWFsVGltZSk7CiAgICAgICAgYXBpQ2FsbEV2ZW50LkxhdGVuY3kgPSBsYXRlbmN5ID49IDAgPyBsYXRlbmN5IDogMDsKICAgICAgICB2YXIgcmVzcG9uc2UgPSByZXF1ZXN0LnJlc3BvbnNlOwogICAgICAgIGlmICgKICAgICAgICAgIHR5cGVvZiByZXNwb25zZS5yZXRyeUNvdW50ID09PSAnbnVtYmVyJyAmJgogICAgICAgICAgdHlwZW9mIHJlc3BvbnNlLm1heFJldHJpZXMgPT09ICdudW1iZXInICYmCiAgICAgICAgICAocmVzcG9uc2UucmV0cnlDb3VudCA+PSByZXNwb25zZS5tYXhSZXRyaWVzKQogICAgICAgICkgewogICAgICAgICAgYXBpQ2FsbEV2ZW50Lk1heFJldHJpZXNFeGNlZWRlZCA9IDE7CiAgICAgICAgfQogICAgICAgIHNlbGYuZW1pdCgnYXBpQ2FsbCcsIFthcGlDYWxsRXZlbnRdKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBzZXR1cCBhbnkgY3VzdG9tIHJlcXVlc3QgbGlzdGVuZXJzIGZvciBlYWNoCiAgICAgKiBuZXcgcmVxdWVzdCB0byB0aGUgc2VydmljZS4KICAgICAqCiAgICAgKiBAbWV0aG9kX2Fic3RyYWN0IFRoaXMgaXMgYW4gYWJzdHJhY3QgbWV0aG9kLgogICAgICovCiAgICBzZXR1cFJlcXVlc3RMaXN0ZW5lcnM6IGZ1bmN0aW9uIHNldHVwUmVxdWVzdExpc3RlbmVycyhyZXF1ZXN0KSB7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBzaWduZXIgY2xhc3MgZm9yIGEgZ2l2ZW4gcmVxdWVzdAogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldFNpZ25lckNsYXNzOiBmdW5jdGlvbiBnZXRTaWduZXJDbGFzcyhyZXF1ZXN0KSB7CiAgICAgIHZhciB2ZXJzaW9uOwogICAgICAvLyBnZXQgb3BlcmF0aW9uIGF1dGh0eXBlIGlmIHByZXNlbnQKICAgICAgdmFyIG9wZXJhdGlvbiA9IG51bGw7CiAgICAgIHZhciBhdXRodHlwZSA9ICcnOwogICAgICBpZiAocmVxdWVzdCkgewogICAgICAgIHZhciBvcGVyYXRpb25zID0gcmVxdWVzdC5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zIHx8IHt9OwogICAgICAgIG9wZXJhdGlvbiA9IG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dIHx8IG51bGw7CiAgICAgICAgYXV0aHR5cGUgPSBvcGVyYXRpb24gPyBvcGVyYXRpb24uYXV0aHR5cGUgOiAnJzsKICAgICAgfQogICAgICBpZiAodGhpcy5jb25maWcuc2lnbmF0dXJlVmVyc2lvbikgewogICAgICAgIHZlcnNpb24gPSB0aGlzLmNvbmZpZy5zaWduYXR1cmVWZXJzaW9uOwogICAgICB9IGVsc2UgaWYgKGF1dGh0eXBlID09PSAndjQnIHx8IGF1dGh0eXBlID09PSAndjQtdW5zaWduZWQtYm9keScpIHsKICAgICAgICB2ZXJzaW9uID0gJ3Y0JzsKICAgICAgfSBlbHNlIHsKICAgICAgICB2ZXJzaW9uID0gdGhpcy5hcGkuc2lnbmF0dXJlVmVyc2lvbjsKICAgICAgfQogICAgICByZXR1cm4gQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lci5nZXRWZXJzaW9uKHZlcnNpb24pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNlcnZpY2VJbnRlcmZhY2U6IGZ1bmN0aW9uIHNlcnZpY2VJbnRlcmZhY2UoKSB7CiAgICAgIHN3aXRjaCAodGhpcy5hcGkucHJvdG9jb2wpIHsKICAgICAgICBjYXNlICdlYzInOiByZXR1cm4gQVdTLkV2ZW50TGlzdGVuZXJzLlF1ZXJ5OwogICAgICAgIGNhc2UgJ3F1ZXJ5JzogcmV0dXJuIEFXUy5FdmVudExpc3RlbmVycy5RdWVyeTsKICAgICAgICBjYXNlICdqc29uJzogcmV0dXJuIEFXUy5FdmVudExpc3RlbmVycy5Kc29uOwogICAgICAgIGNhc2UgJ3Jlc3QtanNvbic6IHJldHVybiBBV1MuRXZlbnRMaXN0ZW5lcnMuUmVzdEpzb247CiAgICAgICAgY2FzZSAncmVzdC14bWwnOiByZXR1cm4gQVdTLkV2ZW50TGlzdGVuZXJzLlJlc3RYbWw7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuYXBpLnByb3RvY29sKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHNlcnZpY2UgYHByb3RvY29sXCcgJyArCiAgICAgICAgICB0aGlzLmFwaS5wcm90b2NvbCArICcgaW4gQVBJIGNvbmZpZycpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc3VjY2Vzc2Z1bFJlc3BvbnNlOiBmdW5jdGlvbiBzdWNjZXNzZnVsUmVzcG9uc2UocmVzcCkgewogICAgICByZXR1cm4gcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSA8IDMwMDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEhvdyBtYW55IHRpbWVzIGEgZmFpbGVkIHJlcXVlc3Qgc2hvdWxkIGJlIHJldHJpZWQgYmVmb3JlIGdpdmluZyB1cC4KICAgICAqIHRoZSBkZWZhdWx0UmV0cnlDb3VudCBjYW4gYmUgb3ZlcnJpZGVuIGJ5IHNlcnZpY2UgY2xhc3Nlcy4KICAgICAqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbnVtUmV0cmllczogZnVuY3Rpb24gbnVtUmV0cmllcygpIHsKICAgICAgaWYgKHRoaXMuY29uZmlnLm1heFJldHJpZXMgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiB0aGlzLmNvbmZpZy5tYXhSZXRyaWVzOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmRlZmF1bHRSZXRyeUNvdW50OwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgcmV0cnlEZWxheXM6IGZ1bmN0aW9uIHJldHJ5RGVsYXlzKHJldHJ5Q291bnQpIHsKICAgICAgcmV0dXJuIEFXUy51dGlsLmNhbGN1bGF0ZVJldHJ5RGVsYXkocmV0cnlDb3VudCwgdGhpcy5jb25maWcucmV0cnlEZWxheU9wdGlvbnMpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHJldHJ5YWJsZUVycm9yOiBmdW5jdGlvbiByZXRyeWFibGVFcnJvcihlcnJvcikgewogICAgICBpZiAodGhpcy50aW1lb3V0RXJyb3IoZXJyb3IpKSByZXR1cm4gdHJ1ZTsKICAgICAgaWYgKHRoaXMubmV0d29ya2luZ0Vycm9yKGVycm9yKSkgcmV0dXJuIHRydWU7CiAgICAgIGlmICh0aGlzLmV4cGlyZWRDcmVkZW50aWFsc0Vycm9yKGVycm9yKSkgcmV0dXJuIHRydWU7CiAgICAgIGlmICh0aGlzLnRocm90dGxlZEVycm9yKGVycm9yKSkgcmV0dXJuIHRydWU7CiAgICAgIGlmIChlcnJvci5zdGF0dXNDb2RlID49IDUwMCkgcmV0dXJuIHRydWU7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBuZXR3b3JraW5nRXJyb3I6IGZ1bmN0aW9uIG5ldHdvcmtpbmdFcnJvcihlcnJvcikgewogICAgICByZXR1cm4gZXJyb3IuY29kZSA9PT0gJ05ldHdvcmtpbmdFcnJvcic7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdGltZW91dEVycm9yOiBmdW5jdGlvbiB0aW1lb3V0RXJyb3IoZXJyb3IpIHsKICAgICAgcmV0dXJuIGVycm9yLmNvZGUgPT09ICdUaW1lb3V0RXJyb3InOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGV4cGlyZWRDcmVkZW50aWFsc0Vycm9yOiBmdW5jdGlvbiBleHBpcmVkQ3JlZGVudGlhbHNFcnJvcihlcnJvcikgewogICAgICAvLyBUT0RPIDogdGhpcyBvbmx5IGhhbmRsZXMgKm9uZSogb2YgdGhlIGV4cGlyZWQgY3JlZGVudGlhbCBjb2RlcwogICAgICByZXR1cm4gKGVycm9yLmNvZGUgPT09ICdFeHBpcmVkVG9rZW5FeGNlcHRpb24nKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjbG9ja1NrZXdFcnJvcjogZnVuY3Rpb24gY2xvY2tTa2V3RXJyb3IoZXJyb3IpIHsKICAgICAgc3dpdGNoIChlcnJvci5jb2RlKSB7CiAgICAgICAgY2FzZSAnUmVxdWVzdFRpbWVUb29Ta2V3ZWQnOgogICAgICAgIGNhc2UgJ1JlcXVlc3RFeHBpcmVkJzoKICAgICAgICBjYXNlICdJbnZhbGlkU2lnbmF0dXJlRXhjZXB0aW9uJzoKICAgICAgICBjYXNlICdTaWduYXR1cmVEb2VzTm90TWF0Y2gnOgogICAgICAgIGNhc2UgJ0F1dGhGYWlsdXJlJzoKICAgICAgICBjYXNlICdSZXF1ZXN0SW5UaGVGdXR1cmUnOgogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgZGVmYXVsdDogcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0U2tld0NvcnJlY3RlZERhdGU6IGZ1bmN0aW9uIGdldFNrZXdDb3JyZWN0ZWREYXRlKCkgewogICAgICByZXR1cm4gbmV3IERhdGUoRGF0ZS5ub3coKSArIHRoaXMuY29uZmlnLnN5c3RlbUNsb2NrT2Zmc2V0KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhcHBseUNsb2NrT2Zmc2V0OiBmdW5jdGlvbiBhcHBseUNsb2NrT2Zmc2V0KG5ld1NlcnZlclRpbWUpIHsKICAgICAgaWYgKG5ld1NlcnZlclRpbWUpIHsKICAgICAgICB0aGlzLmNvbmZpZy5zeXN0ZW1DbG9ja09mZnNldCA9IG5ld1NlcnZlclRpbWUgLSBEYXRlLm5vdygpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaXNDbG9ja1NrZXdlZDogZnVuY3Rpb24gaXNDbG9ja1NrZXdlZChuZXdTZXJ2ZXJUaW1lKSB7CiAgICAgIGlmIChuZXdTZXJ2ZXJUaW1lKSB7CiAgICAgICAgcmV0dXJuIE1hdGguYWJzKHRoaXMuZ2V0U2tld0NvcnJlY3RlZERhdGUoKS5nZXRUaW1lKCkgLSBuZXdTZXJ2ZXJUaW1lKSA+PSAzMDAwMDsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHRocm90dGxlZEVycm9yOiBmdW5jdGlvbiB0aHJvdHRsZWRFcnJvcihlcnJvcikgewogICAgICAvLyB0aGlzIGxvZ2ljIHZhcmllcyBiZXR3ZWVuIHNlcnZpY2VzCiAgICAgIGlmIChlcnJvci5zdGF0dXNDb2RlID09PSA0MjkpIHJldHVybiB0cnVlOwogICAgICBzd2l0Y2ggKGVycm9yLmNvZGUpIHsKICAgICAgICBjYXNlICdQcm92aXNpb25lZFRocm91Z2hwdXRFeGNlZWRlZEV4Y2VwdGlvbic6CiAgICAgICAgY2FzZSAnVGhyb3R0bGluZyc6CiAgICAgICAgY2FzZSAnVGhyb3R0bGluZ0V4Y2VwdGlvbic6CiAgICAgICAgY2FzZSAnUmVxdWVzdExpbWl0RXhjZWVkZWQnOgogICAgICAgIGNhc2UgJ1JlcXVlc3RUaHJvdHRsZWQnOgogICAgICAgIGNhc2UgJ1JlcXVlc3RUaHJvdHRsZWRFeGNlcHRpb24nOgogICAgICAgIGNhc2UgJ1Rvb01hbnlSZXF1ZXN0c0V4Y2VwdGlvbic6CiAgICAgICAgY2FzZSAnVHJhbnNhY3Rpb25JblByb2dyZXNzRXhjZXB0aW9uJzogLy9keW5hbW9kYgogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGVuZHBvaW50RnJvbVRlbXBsYXRlOiBmdW5jdGlvbiBlbmRwb2ludEZyb21UZW1wbGF0ZShlbmRwb2ludCkgewogICAgICBpZiAodHlwZW9mIGVuZHBvaW50ICE9PSAnc3RyaW5nJykgcmV0dXJuIGVuZHBvaW50OwogIAogICAgICB2YXIgZSA9IGVuZHBvaW50OwogICAgICBlID0gZS5yZXBsYWNlKC9ce3NlcnZpY2VcfS9nLCB0aGlzLmFwaS5lbmRwb2ludFByZWZpeCk7CiAgICAgIGUgPSBlLnJlcGxhY2UoL1x7cmVnaW9uXH0vZywgdGhpcy5jb25maWcucmVnaW9uKTsKICAgICAgZSA9IGUucmVwbGFjZSgvXHtzY2hlbWVcfS9nLCB0aGlzLmNvbmZpZy5zc2xFbmFibGVkID8gJ2h0dHBzJyA6ICdodHRwJyk7CiAgICAgIHJldHVybiBlOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNldEVuZHBvaW50OiBmdW5jdGlvbiBzZXRFbmRwb2ludChlbmRwb2ludCkgewogICAgICB0aGlzLmVuZHBvaW50ID0gbmV3IEFXUy5FbmRwb2ludChlbmRwb2ludCwgdGhpcy5jb25maWcpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHBhZ2luYXRpb25Db25maWc6IGZ1bmN0aW9uIHBhZ2luYXRpb25Db25maWcob3BlcmF0aW9uLCB0aHJvd0V4Y2VwdGlvbikgewogICAgICB2YXIgcGFnaW5hdG9yID0gdGhpcy5hcGkub3BlcmF0aW9uc1tvcGVyYXRpb25dLnBhZ2luYXRvcjsKICAgICAgaWYgKCFwYWdpbmF0b3IpIHsKICAgICAgICBpZiAodGhyb3dFeGNlcHRpb24pIHsKICAgICAgICAgIHZhciBlID0gbmV3IEVycm9yKCk7CiAgICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihlLCAnTm8gcGFnaW5hdGlvbiBjb25maWd1cmF0aW9uIGZvciAnICsgb3BlcmF0aW9uKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHBhZ2luYXRvcjsKICAgIH0KICB9KTsKICAKICBBV1MudXRpbC51cGRhdGUoQVdTLlNlcnZpY2UsIHsKICAKICAgIC8qKgogICAgICogQWRkcyBvbmUgbWV0aG9kIGZvciBlYWNoIG9wZXJhdGlvbiBkZXNjcmliZWQgaW4gdGhlIGFwaSBjb25maWd1cmF0aW9uCiAgICAgKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGRlZmluZU1ldGhvZHM6IGZ1bmN0aW9uIGRlZmluZU1ldGhvZHMoc3ZjKSB7CiAgICAgIEFXUy51dGlsLmVhY2goc3ZjLnByb3RvdHlwZS5hcGkub3BlcmF0aW9ucywgZnVuY3Rpb24gaXRlcmF0b3IobWV0aG9kKSB7CiAgICAgICAgaWYgKHN2Yy5wcm90b3R5cGVbbWV0aG9kXSkgcmV0dXJuOwogICAgICAgIHZhciBvcGVyYXRpb24gPSBzdmMucHJvdG90eXBlLmFwaS5vcGVyYXRpb25zW21ldGhvZF07CiAgICAgICAgaWYgKG9wZXJhdGlvbi5hdXRodHlwZSA9PT0gJ25vbmUnKSB7CiAgICAgICAgICBzdmMucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbiAocGFyYW1zLCBjYWxsYmFjaykgewogICAgICAgICAgICByZXR1cm4gdGhpcy5tYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdChtZXRob2QsIHBhcmFtcywgY2FsbGJhY2spOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3ZjLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24gKHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFrZVJlcXVlc3QobWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIERlZmluZXMgYSBuZXcgU2VydmljZSBjbGFzcyB1c2luZyBhIHNlcnZpY2UgaWRlbnRpZmllciBhbmQgbGlzdCBvZiB2ZXJzaW9ucwogICAgICogaW5jbHVkaW5nIGFuIG9wdGlvbmFsIHNldCBvZiBmZWF0dXJlcyAoZnVuY3Rpb25zKSB0byBhcHBseSB0byB0aGUgY2xhc3MKICAgICAqIHByb3RvdHlwZS4KICAgICAqCiAgICAgKiBAcGFyYW0gc2VydmljZUlkZW50aWZpZXIgW1N0cmluZ10gdGhlIGlkZW50aWZpZXIgZm9yIHRoZSBzZXJ2aWNlCiAgICAgKiBAcGFyYW0gdmVyc2lvbnMgW0FycmF5PFN0cmluZz5dIGEgbGlzdCBvZiB2ZXJzaW9ucyB0aGF0IHdvcmsgd2l0aCB0aGlzCiAgICAgKiAgIHNlcnZpY2UKICAgICAqIEBwYXJhbSBmZWF0dXJlcyBbT2JqZWN0XSBhbiBvYmplY3QgdG8gYXR0YWNoIHRvIHRoZSBwcm90b3R5cGUKICAgICAqIEByZXR1cm4gW0NsYXNzPFNlcnZpY2U+XSB0aGUgc2VydmljZSBjbGFzcyBkZWZpbmVkIGJ5IHRoaXMgZnVuY3Rpb24uCiAgICAgKi8KICAgIGRlZmluZVNlcnZpY2U6IGZ1bmN0aW9uIGRlZmluZVNlcnZpY2Uoc2VydmljZUlkZW50aWZpZXIsIHZlcnNpb25zLCBmZWF0dXJlcykgewogICAgICBBV1MuU2VydmljZS5fc2VydmljZU1hcFtzZXJ2aWNlSWRlbnRpZmllcl0gPSB0cnVlOwogICAgICBpZiAoIUFycmF5LmlzQXJyYXkodmVyc2lvbnMpKSB7CiAgICAgICAgZmVhdHVyZXMgPSB2ZXJzaW9uczsKICAgICAgICB2ZXJzaW9ucyA9IFtdOwogICAgICB9CiAgCiAgICAgIHZhciBzdmMgPSBpbmhlcml0KEFXUy5TZXJ2aWNlLCBmZWF0dXJlcyB8fCB7fSk7CiAgCiAgICAgIGlmICh0eXBlb2Ygc2VydmljZUlkZW50aWZpZXIgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgQVdTLlNlcnZpY2UuYWRkVmVyc2lvbnMoc3ZjLCB2ZXJzaW9ucyk7CiAgCiAgICAgICAgdmFyIGlkZW50aWZpZXIgPSBzdmMuc2VydmljZUlkZW50aWZpZXIgfHwgc2VydmljZUlkZW50aWZpZXI7CiAgICAgICAgc3ZjLnNlcnZpY2VJZGVudGlmaWVyID0gaWRlbnRpZmllcjsKICAgICAgfSBlbHNlIHsgLy8gZGVmaW5lU2VydmljZSBjYWxsZWQgd2l0aCBhbiBBUEkKICAgICAgICBzdmMucHJvdG90eXBlLmFwaSA9IHNlcnZpY2VJZGVudGlmaWVyOwogICAgICAgIEFXUy5TZXJ2aWNlLmRlZmluZU1ldGhvZHMoc3ZjKTsKICAgICAgfQogICAgICBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLmNhbGwodGhpcy5wcm90b3R5cGUpOwogICAgICAvL3V0aWwuY2xpZW50U2lkZU1vbml0b3JpbmcgaXMgb25seSBhdmFpbGFibGUgaW4gbm9kZQogICAgICBpZiAoIXRoaXMucHJvdG90eXBlLnB1Ymxpc2hlciAmJiBBV1MudXRpbC5jbGllbnRTaWRlTW9uaXRvcmluZykgewogICAgICAgIHZhciBQdWJsaXNoZXIgPSBBV1MudXRpbC5jbGllbnRTaWRlTW9uaXRvcmluZy5QdWJsaXNoZXI7CiAgICAgICAgdmFyIGNvbmZpZ1Byb3ZpZGVyID0gQVdTLnV0aWwuY2xpZW50U2lkZU1vbml0b3JpbmcuY29uZmlnUHJvdmlkZXI7CiAgICAgICAgdmFyIHB1Ymxpc2hlckNvbmZpZyA9IGNvbmZpZ1Byb3ZpZGVyKCk7CiAgICAgICAgdGhpcy5wcm90b3R5cGUucHVibGlzaGVyID0gbmV3IFB1Ymxpc2hlcihwdWJsaXNoZXJDb25maWcpOwogICAgICAgIGlmIChwdWJsaXNoZXJDb25maWcuZW5hYmxlZCkgewogICAgICAgICAgLy9pZiBjc20gaXMgZW5hYmxlZCBpbiBlbnZpcm9ubWVudCwgU0RLIHNob3VsZCBzZW5kIGFsbCBtZXRyaWNzCiAgICAgICAgICBBV1MuU2VydmljZS5fY2xpZW50U2lkZU1vbml0b3JpbmcgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLmNhbGwoc3ZjLnByb3RvdHlwZSk7CiAgICAgIEFXUy5TZXJ2aWNlLmFkZERlZmF1bHRNb25pdG9yaW5nTGlzdGVuZXJzKHN2Yy5wcm90b3R5cGUpOwogICAgICByZXR1cm4gc3ZjOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFkZFZlcnNpb25zOiBmdW5jdGlvbiBhZGRWZXJzaW9ucyhzdmMsIHZlcnNpb25zKSB7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheSh2ZXJzaW9ucykpIHZlcnNpb25zID0gW3ZlcnNpb25zXTsKICAKICAgICAgc3ZjLnNlcnZpY2VzID0gc3ZjLnNlcnZpY2VzIHx8IHt9OwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZlcnNpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHN2Yy5zZXJ2aWNlc1t2ZXJzaW9uc1tpXV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgc3ZjLnNlcnZpY2VzW3ZlcnNpb25zW2ldXSA9IG51bGw7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHN2Yy5hcGlWZXJzaW9ucyA9IE9iamVjdC5rZXlzKHN2Yy5zZXJ2aWNlcykuc29ydCgpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGRlZmluZVNlcnZpY2VBcGk6IGZ1bmN0aW9uIGRlZmluZVNlcnZpY2VBcGkoc3VwZXJjbGFzcywgdmVyc2lvbiwgYXBpQ29uZmlnKSB7CiAgICAgIHZhciBzdmMgPSBpbmhlcml0KHN1cGVyY2xhc3MsIHsKICAgICAgICBzZXJ2aWNlSWRlbnRpZmllcjogc3VwZXJjbGFzcy5zZXJ2aWNlSWRlbnRpZmllcgogICAgICB9KTsKICAKICAgICAgZnVuY3Rpb24gc2V0QXBpKGFwaSkgewogICAgICAgIGlmIChhcGkuaXNBcGkpIHsKICAgICAgICAgIHN2Yy5wcm90b3R5cGUuYXBpID0gYXBpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdmMucHJvdG90eXBlLmFwaSA9IG5ldyBBcGkoYXBpKTsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgaWYgKHR5cGVvZiB2ZXJzaW9uID09PSAnc3RyaW5nJykgewogICAgICAgIGlmIChhcGlDb25maWcpIHsKICAgICAgICAgIHNldEFwaShhcGlDb25maWcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZXRBcGkoQVdTLmFwaUxvYWRlcihzdXBlcmNsYXNzLnNlcnZpY2VJZGVudGlmaWVyLCB2ZXJzaW9uKSk7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IoZXJyLCB7CiAgICAgICAgICAgICAgbWVzc2FnZTogJ0NvdWxkIG5vdCBmaW5kIEFQSSBjb25maWd1cmF0aW9uICcgKwogICAgICAgICAgICAgICAgc3VwZXJjbGFzcy5zZXJ2aWNlSWRlbnRpZmllciArICctJyArIHZlcnNpb24KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHN1cGVyY2xhc3Muc2VydmljZXMsIHZlcnNpb24pKSB7CiAgICAgICAgICBzdXBlcmNsYXNzLmFwaVZlcnNpb25zID0gc3VwZXJjbGFzcy5hcGlWZXJzaW9ucy5jb25jYXQodmVyc2lvbikuc29ydCgpOwogICAgICAgIH0KICAgICAgICBzdXBlcmNsYXNzLnNlcnZpY2VzW3ZlcnNpb25dID0gc3ZjOwogICAgICB9IGVsc2UgewogICAgICAgIHNldEFwaSh2ZXJzaW9uKTsKICAgICAgfQogIAogICAgICBBV1MuU2VydmljZS5kZWZpbmVNZXRob2RzKHN2Yyk7CiAgICAgIHJldHVybiBzdmM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaGFzU2VydmljZTogZnVuY3Rpb24oaWRlbnRpZmllcikgewogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKEFXUy5TZXJ2aWNlLl9zZXJ2aWNlTWFwLCBpZGVudGlmaWVyKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBwYXJhbSBhdHRhY2hPbiBhdHRhY2ggZGVmYXVsdCBtb25pdG9yaW5nIGxpc3RlbmVycyB0byBvYmplY3QKICAgICAqCiAgICAgKiBFYWNoIG1vbml0b3JpbmcgZXZlbnQgc2hvdWxkIGJlIGVtaXR0ZWQgZnJvbSBzZXJ2aWNlIGNsaWVudCB0byBzZXJ2aWNlIGNvbnN0cnVjdG9yIHByb3RvdHlwZSBhbmQgdGhlbgogICAgICogdG8gZ2xvYmFsIHNlcnZpY2UgcHJvdG90eXBlIGxpa2UgYnViYmxpbmcgdXAuIFRoZXNlIGRlZmF1bHQgbW9uaXRvcmluZyBldmVudHMgbGlzdGVuZXIgd2lsbCB0cmFuc2ZlcgogICAgICogdGhlIG1vbml0b3JpbmcgZXZlbnRzIHRvIHRoZSB1cHBlciBsYXllci4KICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhZGREZWZhdWx0TW9uaXRvcmluZ0xpc3RlbmVyczogZnVuY3Rpb24gYWRkRGVmYXVsdE1vbml0b3JpbmdMaXN0ZW5lcnMoYXR0YWNoT24pIHsKICAgICAgYXR0YWNoT24uYWRkTmFtZWRMaXN0ZW5lcignTU9OSVRPUl9FVkVOVFNfQlVCQkxFJywgJ2FwaUNhbGxBdHRlbXB0JywgZnVuY3Rpb24gRVZFTlRTX0JVQkJMRShldmVudCkgewogICAgICAgIHZhciBiYXNlQ2xhc3MgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoYXR0YWNoT24pOwogICAgICAgIGlmIChiYXNlQ2xhc3MuX2V2ZW50cykgYmFzZUNsYXNzLmVtaXQoJ2FwaUNhbGxBdHRlbXB0JywgW2V2ZW50XSk7CiAgICAgIH0pOwogICAgICBhdHRhY2hPbi5hZGROYW1lZExpc3RlbmVyKCdDQUxMX0VWRU5UU19CVUJCTEUnLCAnYXBpQ2FsbCcsIGZ1bmN0aW9uIENBTExfRVZFTlRTX0JVQkJMRShldmVudCkgewogICAgICAgIHZhciBiYXNlQ2xhc3MgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoYXR0YWNoT24pOwogICAgICAgIGlmIChiYXNlQ2xhc3MuX2V2ZW50cykgYmFzZUNsYXNzLmVtaXQoJ2FwaUNhbGwnLCBbZXZlbnRdKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgX3NlcnZpY2VNYXA6IHt9CiAgfSk7CiAgCiAgQVdTLnV0aWwubWl4aW4oQVdTLlNlcnZpY2UsIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNlcnZpY2U7CiAgCiAgfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQogIH0seyIuL2NvcmUiOjE4LCIuL21vZGVsL2FwaSI6MzgsIi4vcmVnaW9uX2NvbmZpZyI6NTMsIl9wcm9jZXNzIjo4Nn1dLDYwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIAogIEFXUy51dGlsLnVwZGF0ZShBV1MuQ29nbml0b0lkZW50aXR5LnByb3RvdHlwZSwgewogICAgZ2V0T3BlbklkVG9rZW46IGZ1bmN0aW9uIGdldE9wZW5JZFRva2VuKHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHRoaXMubWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3QoJ2dldE9wZW5JZFRva2VuJywgcGFyYW1zLCBjYWxsYmFjayk7CiAgICB9LAogIAogICAgZ2V0SWQ6IGZ1bmN0aW9uIGdldElkKHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHRoaXMubWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3QoJ2dldElkJywgcGFyYW1zLCBjYWxsYmFjayk7CiAgICB9LAogIAogICAgZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eTogZnVuY3Rpb24gZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eShwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLm1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KCdnZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5JywgcGFyYW1zLCBjYWxsYmFjayk7CiAgICB9CiAgfSk7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sNjE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAocHJvY2Vzcyl7KGZ1bmN0aW9uICgpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIHJlZ2lvbkNvbmZpZyA9IHJlcXVpcmUoJy4uL3JlZ2lvbl9jb25maWcnKTsKICB2YXIgRU5WX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQgPSAnQVdTX1NUU19SRUdJT05BTF9FTkRQT0lOVFMnOwogIHZhciBDT05GSUdfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRCA9ICdzdHNfcmVnaW9uYWxfZW5kcG9pbnRzJzsKICAKICBBV1MudXRpbC51cGRhdGUoQVdTLlNUUy5wcm90b3R5cGUsIHsKICAgIC8qKgogICAgICogQG92ZXJsb2FkIGNyZWRlbnRpYWxzRnJvbShkYXRhLCBjcmVkZW50aWFscyA9IG51bGwpCiAgICAgKiAgIENyZWF0ZXMgYSBjcmVkZW50aWFscyBvYmplY3QgZnJvbSBTVFMgcmVzcG9uc2UgZGF0YSBjb250YWluaW5nCiAgICAgKiAgIGNyZWRlbnRpYWxzIGluZm9ybWF0aW9uLiBVc2VmdWwgZm9yIHF1aWNrbHkgc2V0dGluZyBBV1MgY3JlZGVudGlhbHMuCiAgICAgKgogICAgICogICBAbm90ZSBUaGlzIGlzIGEgbG93LWxldmVsIHV0aWxpdHkgZnVuY3Rpb24uIElmIHlvdSB3YW50IHRvIGxvYWQgdGVtcG9yYXJ5CiAgICAgKiAgICAgY3JlZGVudGlhbHMgaW50byB5b3VyIHByb2Nlc3MgZm9yIHN1YnNlcXVlbnQgcmVxdWVzdHMgdG8gQVdTIHJlc291cmNlcywKICAgICAqICAgICB5b3Ugc2hvdWxkIHVzZSB7QVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzfSBpbnN0ZWFkLgogICAgICogICBAcGFyYW0gZGF0YSBbbWFwXSBkYXRhIHJldHJpZXZlZCBmcm9tIGEgY2FsbCB0byB7Z2V0RmVkZXJhdGVkVG9rZW59LAogICAgICogICAgIHtnZXRTZXNzaW9uVG9rZW59LCB7YXNzdW1lUm9sZX0sIG9yIHthc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4KICAgICAqICAgQHBhcmFtIGNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIGFuIG9wdGlvbmFsIGNyZWRlbnRpYWxzIG9iamVjdCB0bwogICAgICogICAgIGZpbGwgaW5zdGVhZCBvZiBjcmVhdGluZyBhIG5ldyBvYmplY3QuIFVzZWZ1bCB3aGVuIG1vZGlmeWluZyBhbgogICAgICogICAgIGV4aXN0aW5nIGNyZWRlbnRpYWxzIG9iamVjdCBmcm9tIGEgcmVmcmVzaCBjYWxsLgogICAgICogICBAcmV0dXJuIFtBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHNdIHRoZSBzZXQgb2YgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzCiAgICAgKiAgICAgbG9hZGVkIGZyb20gYSByYXcgU1RTIG9wZXJhdGlvbiByZXNwb25zZS4KICAgICAqICAgQGV4YW1wbGUgVXNpbmcgY3JlZGVudGlhbHNGcm9tIHRvIGxvYWQgZ2xvYmFsIEFXUyBjcmVkZW50aWFscwogICAgICogICAgIHZhciBzdHMgPSBuZXcgQVdTLlNUUygpOwogICAgICogICAgIHN0cy5nZXRTZXNzaW9uVG9rZW4oZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICogICAgICAgaWYgKGVycikgY29uc29sZS5sb2coIkVycm9yIGdldHRpbmcgY3JlZGVudGlhbHMiKTsKICAgICAqICAgICAgIGVsc2UgewogICAgICogICAgICAgICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gc3RzLmNyZWRlbnRpYWxzRnJvbShkYXRhKTsKICAgICAqICAgICAgIH0KICAgICAqICAgICB9KTsKICAgICAqICAgQHNlZSBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMKICAgICAqLwogICAgY3JlZGVudGlhbHNGcm9tOiBmdW5jdGlvbiBjcmVkZW50aWFsc0Zyb20oZGF0YSwgY3JlZGVudGlhbHMpIHsKICAgICAgaWYgKCFkYXRhKSByZXR1cm4gbnVsbDsKICAgICAgaWYgKCFjcmVkZW50aWFscykgY3JlZGVudGlhbHMgPSBuZXcgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzKCk7CiAgICAgIGNyZWRlbnRpYWxzLmV4cGlyZWQgPSBmYWxzZTsKICAgICAgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgPSBkYXRhLkNyZWRlbnRpYWxzLkFjY2Vzc0tleUlkOwogICAgICBjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXkgPSBkYXRhLkNyZWRlbnRpYWxzLlNlY3JldEFjY2Vzc0tleTsKICAgICAgY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuID0gZGF0YS5DcmVkZW50aWFscy5TZXNzaW9uVG9rZW47CiAgICAgIGNyZWRlbnRpYWxzLmV4cGlyZVRpbWUgPSBkYXRhLkNyZWRlbnRpYWxzLkV4cGlyYXRpb247CiAgICAgIHJldHVybiBjcmVkZW50aWFsczsKICAgIH0sCiAgCiAgICBhc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5OiBmdW5jdGlvbiBhc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5KHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHRoaXMubWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3QoJ2Fzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHknLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICBhc3N1bWVSb2xlV2l0aFNBTUw6IGZ1bmN0aW9uIGFzc3VtZVJvbGVXaXRoU0FNTChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLm1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KCdhc3N1bWVSb2xlV2l0aFNBTUwnLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICB2YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZ1ZhbHVlOiBmdW5jdGlvbiB2YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZ1ZhbHVlKGNvbmZpZ1ZhbHVlLCBlcnJvck9wdGlvbnMpIHsKICAgICAgaWYgKHR5cGVvZiBjb25maWdWYWx1ZSA9PT0gJ3N0cmluZycgJiYgWydsZWdhY3knLCAncmVnaW9uYWwnXS5pbmRleE9mKGNvbmZpZ1ZhbHVlLnRvTG93ZXJDYXNlKCkpID49IDApIHsKICAgICAgICB0aGlzLmNvbmZpZy5zdHNSZWdpb25hbEVuZHBvaW50cyA9IGNvbmZpZ1ZhbHVlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLCBlcnJvck9wdGlvbnMpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWc6IGZ1bmN0aW9uIHZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnKCkgewogICAgICAvL3ZhbGlkYXRlIGNvbmZpZyB2YWx1ZQogICAgICB2YXIgY29uZmlnID0gdGhpcy5jb25maWc7CiAgICAgIGlmIChjb25maWcuc3RzUmVnaW9uYWxFbmRwb2ludHMpIHsKICAgICAgICB0aGlzLnZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnVmFsdWUoY29uZmlnLnN0c1JlZ2lvbmFsRW5kcG9pbnRzLCB7CiAgICAgICAgICBjb2RlOiAnSW52YWxpZENvbmZpZ3VyYXRpb24nLAogICAgICAgICAgbWVzc2FnZTogJ2ludmFsaWQgInN0c1JlZ2lvbmFsRW5kcG9pbnRzIiBjb25maWd1cmF0aW9uLiBFeHBlY3QgImxlZ2FjeSIgJyArCiAgICAgICAgICAnIG9yICJyZWdpb25hbCIuIEdvdCAiJyArIGNvbmZpZy5zdHNSZWdpb25hbEVuZHBvaW50cyArICciLicKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoIUFXUy51dGlsLmlzTm9kZSgpKSByZXR1cm47CiAgICAgIC8vdmFsaWRhdGUgZW52aXJvbm1lbnRhbCB2YXJpYWJsZQogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHByb2Nlc3MuZW52LCBFTlZfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRCkpIHsKICAgICAgICB2YXIgZW52RmxhZyA9IHByb2Nlc3MuZW52W0VOVl9SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEXTsKICAgICAgICB0aGlzLnZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnVmFsdWUoZW52RmxhZywgewogICAgICAgICAgY29kZTogJ0ludmFsaWRFbnZpcm9ubWVudGFsVmFyaWFibGUnLAogICAgICAgICAgbWVzc2FnZTogJ2ludmFsaWQgJyArIEVOVl9SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEICsgJyBlbnZpcm9ubWVudGFsIHZhcmlhYmxlLiBFeHBlY3QgImxlZ2FjeSIgJyArCiAgICAgICAgICAnIG9yICJyZWdpb25hbCIuIEdvdCAiJyArIHByb2Nlc3MuZW52W0VOVl9SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEXSArICciLicKICAgICAgICB9KTsKICAgICAgfQogICAgICAvL3ZhbGlkYXRlIHNoYXJlZCBjb25maWcgZmlsZQogICAgICB2YXIgcHJvZmlsZSA9IHt9OwogICAgICB0cnkgewogICAgICAgIHZhciBwcm9maWxlcyA9IEFXUy51dGlsLmdldFByb2ZpbGVzRnJvbVNoYXJlZENvbmZpZyhBV1MudXRpbC5pbmlMb2FkZXIpOwogICAgICAgIHByb2ZpbGUgPSBwcm9maWxlc1twcm9jZXNzLmVudi5BV1NfUFJPRklMRSB8fCBBV1MudXRpbC5kZWZhdWx0UHJvZmlsZV07CiAgICAgIH0gY2F0Y2ggKGUpIHt9OwogICAgICBpZiAocHJvZmlsZSAmJiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocHJvZmlsZSwgQ09ORklHX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQpKSB7CiAgICAgICAgdmFyIGZpbGVGbGFnID0gcHJvZmlsZVtDT05GSUdfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRF07CiAgICAgICAgdGhpcy52YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZ1ZhbHVlKGZpbGVGbGFnLCB7CiAgICAgICAgICBjb2RlOiAnSW52YWxpZENvbmZpZ3VyYXRpb24nLAogICAgICAgICAgbWVzc2FnZTogJ2ludmFsaWQgJytDT05GSUdfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRCsnIHByb2ZpbGUgY29uZmlnLiBFeHBlY3QgImxlZ2FjeSIgJyArCiAgICAgICAgICAnIG9yICJyZWdpb25hbCIuIEdvdCAiJyArIHByb2ZpbGVbQ09ORklHX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRURdICsgJyIuJwogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgb3B0SW5SZWdpb25hbEVuZHBvaW50OiBmdW5jdGlvbiBvcHRJblJlZ2lvbmFsRW5kcG9pbnQoKSB7CiAgICAgIHRoaXMudmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWcoKTsKICAgICAgdmFyIGNvbmZpZyA9IHRoaXMuY29uZmlnOwogICAgICBpZiAoY29uZmlnLnN0c1JlZ2lvbmFsRW5kcG9pbnRzID09PSAncmVnaW9uYWwnKSB7CiAgICAgICAgcmVnaW9uQ29uZmlnKHRoaXMpOwogICAgICAgIGlmICghdGhpcy5pc0dsb2JhbEVuZHBvaW50KSByZXR1cm47CiAgICAgICAgdGhpcy5pc0dsb2JhbEVuZHBvaW50ID0gZmFsc2U7CiAgICAgICAgLy9jbGllbnQgd2lsbCB0aHJvdyBpZiByZWdpb24gaXMgbm90IHN1cHBsaWVkOyByZXF1ZXN0IHdpbGwgYmUgc2lnbmVkIHdpdGggc3BlY2lmaWVkIHJlZ2lvbgogICAgICAgIGlmICghY29uZmlnLnJlZ2lvbikgewogICAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksCiAgICAgICAgICAgIHtjb2RlOiAnQ29uZmlnRXJyb3InLCBtZXNzYWdlOiAnTWlzc2luZyByZWdpb24gaW4gY29uZmlnJ30pOwogICAgICAgIH0KICAgICAgICB2YXIgaW5zZXJ0UG9pbnQgPSBjb25maWcuZW5kcG9pbnQuaW5kZXhPZignLmFtYXpvbmF3cy5jb20nKTsKICAgICAgICBjb25maWcuZW5kcG9pbnQgPSBjb25maWcuZW5kcG9pbnQuc3Vic3RyaW5nKDAsIGluc2VydFBvaW50KSArCiAgICAgICAgICAnLicgKyBjb25maWcucmVnaW9uICsgY29uZmlnLmVuZHBvaW50LnN1YnN0cmluZyhpbnNlcnRQb2ludCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVNlcnZpY2U6IGZ1bmN0aW9uIHZhbGlkYXRlU2VydmljZSgpIHsKICAgICAgdGhpcy5vcHRJblJlZ2lvbmFsRW5kcG9pbnQoKTsKICAgIH0KICAKICB9KTsKICAKICB9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCiAgfSx7Ii4uL2NvcmUiOjE4LCIuLi9yZWdpb25fY29uZmlnIjo1MywiX3Byb2Nlc3MiOjg2fV0sNjI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciBleHBpcmVzSGVhZGVyID0gJ3ByZXNpZ25lZC1leHBpcmVzJzsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBzaWduZWRVcmxCdWlsZGVyKHJlcXVlc3QpIHsKICAgIHZhciBleHBpcmVzID0gcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdOwogICAgdmFyIHNpZ25lckNsYXNzID0gcmVxdWVzdC5zZXJ2aWNlLmdldFNpZ25lckNsYXNzKHJlcXVlc3QpOwogIAogICAgZGVsZXRlIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snVXNlci1BZ2VudCddOwogICAgZGVsZXRlIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snWC1BbXotVXNlci1BZ2VudCddOwogIAogICAgaWYgKHNpZ25lckNsYXNzID09PSBBV1MuU2lnbmVycy5WNCkgewogICAgICBpZiAoZXhwaXJlcyA+IDYwNDgwMCkgeyAvLyBvbmUgd2VlayBleHBpcnkgaXMgaW52YWxpZAogICAgICAgIHZhciBtZXNzYWdlID0gJ1ByZXNpZ25pbmcgZG9lcyBub3Qgc3VwcG9ydCBleHBpcnkgdGltZSBncmVhdGVyICcgKwogICAgICAgICAgICAgICAgICAgICAgJ3RoYW4gYSB3ZWVrIHdpdGggU2lnVjQgc2lnbmluZy4nOwogICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICBjb2RlOiAnSW52YWxpZEV4cGlyeVRpbWUnLCBtZXNzYWdlOiBtZXNzYWdlLCByZXRyeWFibGU6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdID0gZXhwaXJlczsKICAgIH0gZWxzZSBpZiAoc2lnbmVyQ2xhc3MgPT09IEFXUy5TaWduZXJzLlMzKSB7CiAgICAgIHZhciBub3cgPSByZXF1ZXN0LnNlcnZpY2UgPyByZXF1ZXN0LnNlcnZpY2UuZ2V0U2tld0NvcnJlY3RlZERhdGUoKSA6IEFXUy51dGlsLmRhdGUuZ2V0RGF0ZSgpOwogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl0gPSBwYXJzZUludCgKICAgICAgICBBV1MudXRpbC5kYXRlLnVuaXhUaW1lc3RhbXAobm93KSArIGV4cGlyZXMsIDEwKS50b1N0cmluZygpOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBtZXNzYWdlOiAnUHJlc2lnbmluZyBvbmx5IHN1cHBvcnRzIFMzIG9yIFNpZ1Y0IHNpZ25pbmcuJywKICAgICAgICBjb2RlOiAnVW5zdXBwb3J0ZWRTaWduZXInLCByZXRyeWFibGU6IGZhbHNlCiAgICAgIH0pOwogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBzaWduZWRVcmxTaWduZXIocmVxdWVzdCkgewogICAgdmFyIGVuZHBvaW50ID0gcmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludDsKICAgIHZhciBwYXJzZWRVcmwgPSBBV1MudXRpbC51cmxQYXJzZShyZXF1ZXN0Lmh0dHBSZXF1ZXN0LnBhdGgpOwogICAgdmFyIHF1ZXJ5UGFyYW1zID0ge307CiAgCiAgICBpZiAocGFyc2VkVXJsLnNlYXJjaCkgewogICAgICBxdWVyeVBhcmFtcyA9IEFXUy51dGlsLnF1ZXJ5U3RyaW5nUGFyc2UocGFyc2VkVXJsLnNlYXJjaC5zdWJzdHIoMSkpOwogICAgfQogIAogICAgdmFyIGF1dGggPSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXS5zcGxpdCgnICcpOwogICAgaWYgKGF1dGhbMF0gPT09ICdBV1MnKSB7CiAgICAgIGF1dGggPSBhdXRoWzFdLnNwbGl0KCc6Jyk7CiAgICAgIHF1ZXJ5UGFyYW1zWydBV1NBY2Nlc3NLZXlJZCddID0gYXV0aFswXTsKICAgICAgcXVlcnlQYXJhbXNbJ1NpZ25hdHVyZSddID0gYXV0aFsxXTsKICAKICAgICAgQVdTLnV0aWwuZWFjaChyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKGtleSA9PT0gZXhwaXJlc0hlYWRlcikga2V5ID0gJ0V4cGlyZXMnOwogICAgICAgIGlmIChrZXkuaW5kZXhPZigneC1hbXotbWV0YS0nKSA9PT0gMCkgewogICAgICAgICAgLy8gRGVsZXRlIGV4aXN0aW5nLCBwb3RlbnRpYWxseSBub3Qgbm9ybWFsaXplZCBrZXkKICAgICAgICAgIGRlbGV0ZSBxdWVyeVBhcmFtc1trZXldOwogICAgICAgICAga2V5ID0ga2V5LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgfQogICAgICAgIHF1ZXJ5UGFyYW1zW2tleV0gPSB2YWx1ZTsKICAgICAgfSk7CiAgICAgIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl07CiAgICAgIGRlbGV0ZSBxdWVyeVBhcmFtc1snQXV0aG9yaXphdGlvbiddOwogICAgICBkZWxldGUgcXVlcnlQYXJhbXNbJ0hvc3QnXTsKICAgIH0gZWxzZSBpZiAoYXV0aFswXSA9PT0gJ0FXUzQtSE1BQy1TSEEyNTYnKSB7IC8vIFNpZ1Y0IHNpZ25pbmcKICAgICAgYXV0aC5zaGlmdCgpOwogICAgICB2YXIgcmVzdCA9IGF1dGguam9pbignICcpOwogICAgICB2YXIgc2lnbmF0dXJlID0gcmVzdC5tYXRjaCgvU2lnbmF0dXJlPSguKj8pKD86LHxcc3xccj9cbnwkKS8pWzFdOwogICAgICBxdWVyeVBhcmFtc1snWC1BbXotU2lnbmF0dXJlJ10gPSBzaWduYXR1cmU7CiAgICAgIGRlbGV0ZSBxdWVyeVBhcmFtc1snRXhwaXJlcyddOwogICAgfQogIAogICAgLy8gYnVpbGQgVVJMCiAgICBlbmRwb2ludC5wYXRobmFtZSA9IHBhcnNlZFVybC5wYXRobmFtZTsKICAgIGVuZHBvaW50LnNlYXJjaCA9IEFXUy51dGlsLnF1ZXJ5UGFyYW1zVG9TdHJpbmcocXVlcnlQYXJhbXMpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuU2lnbmVycy5QcmVzaWduID0gaW5oZXJpdCh7CiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzaWduOiBmdW5jdGlvbiBzaWduKHJlcXVlc3QsIGV4cGlyZVRpbWUsIGNhbGxiYWNrKSB7CiAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXSA9IGV4cGlyZVRpbWUgfHwgMzYwMDsKICAgICAgcmVxdWVzdC5vbignYnVpbGQnLCBzaWduZWRVcmxCdWlsZGVyKTsKICAgICAgcmVxdWVzdC5vbignc2lnbicsIHNpZ25lZFVybFNpZ25lcik7CiAgICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ2FmdGVyQnVpbGQnLAogICAgICAgIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlNFVF9DT05URU5UX0xFTkdUSCk7CiAgICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ2FmdGVyQnVpbGQnLAogICAgICAgIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLkNPTVBVVEVfU0hBMjU2KTsKICAKICAgICAgcmVxdWVzdC5lbWl0KCdiZWZvcmVQcmVzaWduJywgW3JlcXVlc3RdKTsKICAKICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgcmVxdWVzdC5idWlsZChmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICh0aGlzLnJlc3BvbnNlLmVycm9yKSBjYWxsYmFjayh0aGlzLnJlc3BvbnNlLmVycm9yKTsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICBjYWxsYmFjayhudWxsLCBBV1MudXRpbC51cmxGb3JtYXQocmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludCkpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHJlcXVlc3QuYnVpbGQoKTsKICAgICAgICBpZiAocmVxdWVzdC5yZXNwb25zZS5lcnJvcikgdGhyb3cgcmVxdWVzdC5yZXNwb25zZS5lcnJvcjsKICAgICAgICByZXR1cm4gQVdTLnV0aWwudXJsRm9ybWF0KHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQpOwogICAgICB9CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5QcmVzaWduOwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDYzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIAogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyID0gaW5oZXJpdCh7CiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gUmVxdWVzdFNpZ25lcihyZXF1ZXN0KSB7CiAgICAgIHRoaXMucmVxdWVzdCA9IHJlcXVlc3Q7CiAgICB9LAogIAogICAgc2V0U2VydmljZUNsaWVudElkOiBmdW5jdGlvbiBzZXRTZXJ2aWNlQ2xpZW50SWQoaWQpIHsKICAgICAgdGhpcy5zZXJ2aWNlQ2xpZW50SWQgPSBpZDsKICAgIH0sCiAgCiAgICBnZXRTZXJ2aWNlQ2xpZW50SWQ6IGZ1bmN0aW9uIGdldFNlcnZpY2VDbGllbnRJZCgpIHsKICAgICAgcmV0dXJuIHRoaXMuc2VydmljZUNsaWVudElkOwogICAgfQogIH0pOwogIAogIEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIuZ2V0VmVyc2lvbiA9IGZ1bmN0aW9uIGdldFZlcnNpb24odmVyc2lvbikgewogICAgc3dpdGNoICh2ZXJzaW9uKSB7CiAgICAgIGNhc2UgJ3YyJzogcmV0dXJuIEFXUy5TaWduZXJzLlYyOwogICAgICBjYXNlICd2Myc6IHJldHVybiBBV1MuU2lnbmVycy5WMzsKICAgICAgY2FzZSAnczN2NCc6IHJldHVybiBBV1MuU2lnbmVycy5WNDsKICAgICAgY2FzZSAndjQnOiByZXR1cm4gQVdTLlNpZ25lcnMuVjQ7CiAgICAgIGNhc2UgJ3MzJzogcmV0dXJuIEFXUy5TaWduZXJzLlMzOwogICAgICBjYXNlICd2M2h0dHBzJzogcmV0dXJuIEFXUy5TaWduZXJzLlYzSHR0cHM7CiAgICB9CiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gc2lnbmluZyB2ZXJzaW9uICcgKyB2ZXJzaW9uKTsKICB9OwogIAogIHJlcXVpcmUoJy4vdjInKTsKICByZXF1aXJlKCcuL3YzJyk7CiAgcmVxdWlyZSgnLi92M2h0dHBzJyk7CiAgcmVxdWlyZSgnLi92NCcpOwogIHJlcXVpcmUoJy4vczMnKTsKICByZXF1aXJlKCcuL3ByZXNpZ24nKTsKICAKICB9LHsiLi4vY29yZSI6MTgsIi4vcHJlc2lnbiI6NjIsIi4vczMiOjY0LCIuL3YyIjo2NSwiLi92MyI6NjYsIi4vdjNodHRwcyI6NjcsIi4vdjQiOjY4fV0sNjQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5TaWduZXJzLlMzID0gaW5oZXJpdChBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLCB7CiAgICAvKioKICAgICAqIFdoZW4gYnVpbGRpbmcgdGhlIHN0cmluZ1RvU2lnbiwgdGhlc2Ugc3ViIHJlc291cmNlIHBhcmFtcyBzaG91bGQgYmUKICAgICAqIHBhcnQgb2YgdGhlIGNhbm9uaWNhbCByZXNvdXJjZSBzdHJpbmcgd2l0aCB0aGVpciBOT04tZGVjb2RlZCB2YWx1ZXMKICAgICAqLwogICAgc3ViUmVzb3VyY2VzOiB7CiAgICAgICdhY2wnOiAxLAogICAgICAnYWNjZWxlcmF0ZSc6IDEsCiAgICAgICdhbmFseXRpY3MnOiAxLAogICAgICAnY29ycyc6IDEsCiAgICAgICdsaWZlY3ljbGUnOiAxLAogICAgICAnZGVsZXRlJzogMSwKICAgICAgJ2ludmVudG9yeSc6IDEsCiAgICAgICdsb2NhdGlvbic6IDEsCiAgICAgICdsb2dnaW5nJzogMSwKICAgICAgJ21ldHJpY3MnOiAxLAogICAgICAnbm90aWZpY2F0aW9uJzogMSwKICAgICAgJ3BhcnROdW1iZXInOiAxLAogICAgICAncG9saWN5JzogMSwKICAgICAgJ3JlcXVlc3RQYXltZW50JzogMSwKICAgICAgJ3JlcGxpY2F0aW9uJzogMSwKICAgICAgJ3Jlc3RvcmUnOiAxLAogICAgICAndGFnZ2luZyc6IDEsCiAgICAgICd0b3JyZW50JzogMSwKICAgICAgJ3VwbG9hZElkJzogMSwKICAgICAgJ3VwbG9hZHMnOiAxLAogICAgICAndmVyc2lvbklkJzogMSwKICAgICAgJ3ZlcnNpb25pbmcnOiAxLAogICAgICAndmVyc2lvbnMnOiAxLAogICAgICAnd2Vic2l0ZSc6IDEKICAgIH0sCiAgCiAgICAvLyB3aGVuIGJ1aWxkaW5nIHRoZSBzdHJpbmdUb1NpZ24sIHRoZXNlIHF1ZXJ5c3RyaW5nIHBhcmFtcyBzaG91bGQgYmUKICAgIC8vIHBhcnQgb2YgdGhlIGNhbm9uaWNhbCByZXNvdXJjZSBzdHJpbmcgd2l0aCB0aGVpciBOT04tZW5jb2RlZCB2YWx1ZXMKICAgIHJlc3BvbnNlSGVhZGVyczogewogICAgICAncmVzcG9uc2UtY29udGVudC10eXBlJzogMSwKICAgICAgJ3Jlc3BvbnNlLWNvbnRlbnQtbGFuZ3VhZ2UnOiAxLAogICAgICAncmVzcG9uc2UtZXhwaXJlcyc6IDEsCiAgICAgICdyZXNwb25zZS1jYWNoZS1jb250cm9sJzogMSwKICAgICAgJ3Jlc3BvbnNlLWNvbnRlbnQtZGlzcG9zaXRpb24nOiAxLAogICAgICAncmVzcG9uc2UtY29udGVudC1lbmNvZGluZyc6IDEKICAgIH0sCiAgCiAgICBhZGRBdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhZGRBdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRlKSB7CiAgICAgIGlmICghdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ3ByZXNpZ25lZC1leHBpcmVzJ10pIHsKICAgICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snWC1BbXotRGF0ZSddID0gQVdTLnV0aWwuZGF0ZS5yZmM4MjIoZGF0ZSk7CiAgICAgIH0KICAKICAgICAgaWYgKGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbikgewogICAgICAgIC8vIHByZXNpZ25lZCBVUkxzIHJlcXVpcmUgdGhpcyBoZWFkZXIgdG8gYmUgbG93ZXJjYXNlZAogICAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWyd4LWFtei1zZWN1cml0eS10b2tlbiddID0gY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuOwogICAgICB9CiAgCiAgICAgIHZhciBzaWduYXR1cmUgPSB0aGlzLnNpZ24oY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5LCB0aGlzLnN0cmluZ1RvU2lnbigpKTsKICAgICAgdmFyIGF1dGggPSAnQVdTICcgKyBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCArICc6JyArIHNpZ25hdHVyZTsKICAKICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXSA9IGF1dGg7CiAgICB9LAogIAogICAgc3RyaW5nVG9TaWduOiBmdW5jdGlvbiBzdHJpbmdUb1NpZ24oKSB7CiAgICAgIHZhciByID0gdGhpcy5yZXF1ZXN0OwogIAogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgcGFydHMucHVzaChyLm1ldGhvZCk7CiAgICAgIHBhcnRzLnB1c2goci5oZWFkZXJzWydDb250ZW50LU1ENSddIHx8ICcnKTsKICAgICAgcGFydHMucHVzaChyLmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddIHx8ICcnKTsKICAKICAgICAgLy8gVGhpcyBpcyB0aGUgIkRhdGUiIGhlYWRlciwgYnV0IHdlIHVzZSBYLUFtei1EYXRlLgogICAgICAvLyBUaGUgUzMgc2lnbmluZyBtZWNoYW5pc20gcmVxdWlyZXMgdXMgdG8gcGFzcyBhbiBlbXB0eQogICAgICAvLyBzdHJpbmcgZm9yIHRoaXMgRGF0ZSBoZWFkZXIgcmVnYXJkbGVzcy4KICAgICAgcGFydHMucHVzaChyLmhlYWRlcnNbJ3ByZXNpZ25lZC1leHBpcmVzJ10gfHwgJycpOwogIAogICAgICB2YXIgaGVhZGVycyA9IHRoaXMuY2Fub25pY2FsaXplZEFtekhlYWRlcnMoKTsKICAgICAgaWYgKGhlYWRlcnMpIHBhcnRzLnB1c2goaGVhZGVycyk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5jYW5vbmljYWxpemVkUmVzb3VyY2UoKSk7CiAgCiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogIAogICAgfSwKICAKICAgIGNhbm9uaWNhbGl6ZWRBbXpIZWFkZXJzOiBmdW5jdGlvbiBjYW5vbmljYWxpemVkQW16SGVhZGVycygpIHsKICAKICAgICAgdmFyIGFtekhlYWRlcnMgPSBbXTsKICAKICAgICAgQVdTLnV0aWwuZWFjaCh0aGlzLnJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICBpZiAobmFtZS5tYXRjaCgvXngtYW16LS9pKSkKICAgICAgICAgIGFtekhlYWRlcnMucHVzaChuYW1lKTsKICAgICAgfSk7CiAgCiAgICAgIGFtekhlYWRlcnMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICAgIHJldHVybiBhLnRvTG93ZXJDYXNlKCkgPCBiLnRvTG93ZXJDYXNlKCkgPyAtMSA6IDE7CiAgICAgIH0pOwogIAogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoLmNhbGwodGhpcywgYW16SGVhZGVycywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICBwYXJ0cy5wdXNoKG5hbWUudG9Mb3dlckNhc2UoKSArICc6JyArIFN0cmluZyh0aGlzLnJlcXVlc3QuaGVhZGVyc1tuYW1lXSkpOwogICAgICB9KTsKICAKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CiAgCiAgICB9LAogIAogICAgY2Fub25pY2FsaXplZFJlc291cmNlOiBmdW5jdGlvbiBjYW5vbmljYWxpemVkUmVzb3VyY2UoKSB7CiAgCiAgICAgIHZhciByID0gdGhpcy5yZXF1ZXN0OwogIAogICAgICB2YXIgcGFydHMgPSByLnBhdGguc3BsaXQoJz8nKTsKICAgICAgdmFyIHBhdGggPSBwYXJ0c1swXTsKICAgICAgdmFyIHF1ZXJ5c3RyaW5nID0gcGFydHNbMV07CiAgCiAgICAgIHZhciByZXNvdXJjZSA9ICcnOwogIAogICAgICBpZiAoci52aXJ0dWFsSG9zdGVkQnVja2V0KQogICAgICAgIHJlc291cmNlICs9ICcvJyArIHIudmlydHVhbEhvc3RlZEJ1Y2tldDsKICAKICAgICAgcmVzb3VyY2UgKz0gcGF0aDsKICAKICAgICAgaWYgKHF1ZXJ5c3RyaW5nKSB7CiAgCiAgICAgICAgLy8gY29sbGVjdCBhIGxpc3Qgb2Ygc3ViIHJlc291cmNlcyBhbmQgcXVlcnkgcGFyYW1zIHRoYXQgbmVlZCB0byBiZSBzaWduZWQKICAgICAgICB2YXIgcmVzb3VyY2VzID0gW107CiAgCiAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoLmNhbGwodGhpcywgcXVlcnlzdHJpbmcuc3BsaXQoJyYnKSwgZnVuY3Rpb24gKHBhcmFtKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IHBhcmFtLnNwbGl0KCc9JylbMF07CiAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJhbS5zcGxpdCgnPScpWzFdOwogICAgICAgICAgaWYgKHRoaXMuc3ViUmVzb3VyY2VzW25hbWVdIHx8IHRoaXMucmVzcG9uc2VIZWFkZXJzW25hbWVdKSB7CiAgICAgICAgICAgIHZhciBzdWJyZXNvdXJjZSA9IHsgbmFtZTogbmFtZSB9OwogICAgICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIGlmICh0aGlzLnN1YlJlc291cmNlc1tuYW1lXSkgewogICAgICAgICAgICAgICAgc3VicmVzb3VyY2UudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3VicmVzb3VyY2UudmFsdWUgPSBkZWNvZGVVUklDb21wb25lbnQodmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXNvdXJjZXMucHVzaChzdWJyZXNvdXJjZSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgCiAgICAgICAgcmVzb3VyY2VzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsgcmV0dXJuIGEubmFtZSA8IGIubmFtZSA/IC0xIDogMTsgfSk7CiAgCiAgICAgICAgaWYgKHJlc291cmNlcy5sZW5ndGgpIHsKICAKICAgICAgICAgIHF1ZXJ5c3RyaW5nID0gW107CiAgICAgICAgICBBV1MudXRpbC5hcnJheUVhY2gocmVzb3VyY2VzLCBmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgICAgIGlmIChyZXMudmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIHF1ZXJ5c3RyaW5nLnB1c2gocmVzLm5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHF1ZXJ5c3RyaW5nLnB1c2gocmVzLm5hbWUgKyAnPScgKyByZXMudmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAKICAgICAgICAgIHJlc291cmNlICs9ICc/JyArIHF1ZXJ5c3RyaW5nLmpvaW4oJyYnKTsKICAgICAgICB9CiAgCiAgICAgIH0KICAKICAgICAgcmV0dXJuIHJlc291cmNlOwogIAogICAgfSwKICAKICAgIHNpZ246IGZ1bmN0aW9uIHNpZ24oc2VjcmV0LCBzdHJpbmcpIHsKICAgICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5obWFjKHNlY3JldCwgc3RyaW5nLCAnYmFzZTY0JywgJ3NoYTEnKTsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlMzOwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDY1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuU2lnbmVycy5WMiA9IGluaGVyaXQoQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lciwgewogICAgYWRkQXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYWRkQXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZSkgewogIAogICAgICBpZiAoIWRhdGUpIGRhdGUgPSBBV1MudXRpbC5kYXRlLmdldERhdGUoKTsKICAKICAgICAgdmFyIHIgPSB0aGlzLnJlcXVlc3Q7CiAgCiAgICAgIHIucGFyYW1zLlRpbWVzdGFtcCA9IEFXUy51dGlsLmRhdGUuaXNvODYwMShkYXRlKTsKICAgICAgci5wYXJhbXMuU2lnbmF0dXJlVmVyc2lvbiA9ICcyJzsKICAgICAgci5wYXJhbXMuU2lnbmF0dXJlTWV0aG9kID0gJ0htYWNTSEEyNTYnOwogICAgICByLnBhcmFtcy5BV1NBY2Nlc3NLZXlJZCA9IGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkOwogIAogICAgICBpZiAoY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuKSB7CiAgICAgICAgci5wYXJhbXMuU2VjdXJpdHlUb2tlbiA9IGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbjsKICAgICAgfQogIAogICAgICBkZWxldGUgci5wYXJhbXMuU2lnbmF0dXJlOyAvLyBkZWxldGUgb2xkIFNpZ25hdHVyZSBmb3IgcmUtc2lnbmluZwogICAgICByLnBhcmFtcy5TaWduYXR1cmUgPSB0aGlzLnNpZ25hdHVyZShjcmVkZW50aWFscyk7CiAgCiAgICAgIHIuYm9keSA9IEFXUy51dGlsLnF1ZXJ5UGFyYW1zVG9TdHJpbmcoci5wYXJhbXMpOwogICAgICByLmhlYWRlcnNbJ0NvbnRlbnQtTGVuZ3RoJ10gPSByLmJvZHkubGVuZ3RoOwogICAgfSwKICAKICAgIHNpZ25hdHVyZTogZnVuY3Rpb24gc2lnbmF0dXJlKGNyZWRlbnRpYWxzKSB7CiAgICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uaG1hYyhjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXksIHRoaXMuc3RyaW5nVG9TaWduKCksICdiYXNlNjQnKTsKICAgIH0sCiAgCiAgICBzdHJpbmdUb1NpZ246IGZ1bmN0aW9uIHN0cmluZ1RvU2lnbigpIHsKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0Lm1ldGhvZCk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0LmVuZHBvaW50Lmhvc3QudG9Mb3dlckNhc2UoKSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0LnBhdGhuYW1lKCkpOwogICAgICBwYXJ0cy5wdXNoKEFXUy51dGlsLnF1ZXJ5UGFyYW1zVG9TdHJpbmcodGhpcy5yZXF1ZXN0LnBhcmFtcykpOwogICAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKICAgIH0KICAKICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlYyOwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDY2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuU2lnbmVycy5WMyA9IGluaGVyaXQoQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lciwgewogICAgYWRkQXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYWRkQXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZSkgewogIAogICAgICB2YXIgZGF0ZXRpbWUgPSBBV1MudXRpbC5kYXRlLnJmYzgyMihkYXRlKTsKICAKICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXSA9IGRhdGV0aW1lOwogIAogICAgICBpZiAoY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuKSB7CiAgICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LXNlY3VyaXR5LXRva2VuJ10gPSBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW47CiAgICAgIH0KICAKICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ1gtQW16bi1BdXRob3JpemF0aW9uJ10gPQogICAgICAgIHRoaXMuYXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZXRpbWUpOwogIAogICAgfSwKICAKICAgIGF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMpIHsKICAgICAgcmV0dXJuICdBV1MzICcgKwogICAgICAgICdBV1NBY2Nlc3NLZXlJZD0nICsgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgKyAnLCcgKwogICAgICAgICdBbGdvcml0aG09SG1hY1NIQTI1NiwnICsKICAgICAgICAnU2lnbmVkSGVhZGVycz0nICsgdGhpcy5zaWduZWRIZWFkZXJzKCkgKyAnLCcgKwogICAgICAgICdTaWduYXR1cmU9JyArIHRoaXMuc2lnbmF0dXJlKGNyZWRlbnRpYWxzKTsKICAgIH0sCiAgCiAgICBzaWduZWRIZWFkZXJzOiBmdW5jdGlvbiBzaWduZWRIZWFkZXJzKCkgewogICAgICB2YXIgaGVhZGVycyA9IFtdOwogICAgICBBV1MudXRpbC5hcnJheUVhY2godGhpcy5oZWFkZXJzVG9TaWduKCksIGZ1bmN0aW9uIGl0ZXJhdG9yKGgpIHsKICAgICAgICBoZWFkZXJzLnB1c2goaC50b0xvd2VyQ2FzZSgpKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBoZWFkZXJzLnNvcnQoKS5qb2luKCc7Jyk7CiAgICB9LAogIAogICAgY2Fub25pY2FsSGVhZGVyczogZnVuY3Rpb24gY2Fub25pY2FsSGVhZGVycygpIHsKICAgICAgdmFyIGhlYWRlcnMgPSB0aGlzLnJlcXVlc3QuaGVhZGVyczsKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIEFXUy51dGlsLmFycmF5RWFjaCh0aGlzLmhlYWRlcnNUb1NpZ24oKSwgZnVuY3Rpb24gaXRlcmF0b3IoaCkgewogICAgICAgIHBhcnRzLnB1c2goaC50b0xvd2VyQ2FzZSgpLnRyaW0oKSArICc6JyArIFN0cmluZyhoZWFkZXJzW2hdKS50cmltKCkpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHBhcnRzLnNvcnQoKS5qb2luKCdcbicpICsgJ1xuJzsKICAgIH0sCiAgCiAgICBoZWFkZXJzVG9TaWduOiBmdW5jdGlvbiBoZWFkZXJzVG9TaWduKCkgewogICAgICB2YXIgaGVhZGVycyA9IFtdOwogICAgICBBV1MudXRpbC5lYWNoKHRoaXMucmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiBpdGVyYXRvcihrKSB7CiAgICAgICAgaWYgKGsgPT09ICdIb3N0JyB8fCBrID09PSAnQ29udGVudC1FbmNvZGluZycgfHwgay5tYXRjaCgvXlgtQW16L2kpKSB7CiAgICAgICAgICBoZWFkZXJzLnB1c2goayk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIGhlYWRlcnM7CiAgICB9LAogIAogICAgc2lnbmF0dXJlOiBmdW5jdGlvbiBzaWduYXR1cmUoY3JlZGVudGlhbHMpIHsKICAgICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5obWFjKGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSwgdGhpcy5zdHJpbmdUb1NpZ24oKSwgJ2Jhc2U2NCcpOwogICAgfSwKICAKICAgIHN0cmluZ1RvU2lnbjogZnVuY3Rpb24gc3RyaW5nVG9TaWduKCkgewogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3QubWV0aG9kKTsKICAgICAgcGFydHMucHVzaCgnLycpOwogICAgICBwYXJ0cy5wdXNoKCcnKTsKICAgICAgcGFydHMucHVzaCh0aGlzLmNhbm9uaWNhbEhlYWRlcnMoKSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0LmJvZHkpOwogICAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLnNoYTI1NihwYXJ0cy5qb2luKCdcbicpKTsKICAgIH0KICAKICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlYzOwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDY3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICAKICByZXF1aXJlKCcuL3YzJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuVjNIdHRwcyA9IGluaGVyaXQoQVdTLlNpZ25lcnMuVjMsIHsKICAgIGF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMpIHsKICAgICAgcmV0dXJuICdBV1MzLUhUVFBTICcgKwogICAgICAgICdBV1NBY2Nlc3NLZXlJZD0nICsgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgKyAnLCcgKwogICAgICAgICdBbGdvcml0aG09SG1hY1NIQTI1NiwnICsKICAgICAgICAnU2lnbmF0dXJlPScgKyB0aGlzLnNpZ25hdHVyZShjcmVkZW50aWFscyk7CiAgICB9LAogIAogICAgc3RyaW5nVG9TaWduOiBmdW5jdGlvbiBzdHJpbmdUb1NpZ24oKSB7CiAgICAgIHJldHVybiB0aGlzLnJlcXVlc3QuaGVhZGVyc1snWC1BbXotRGF0ZSddOwogICAgfQogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuVjNIdHRwczsKICAKICB9LHsiLi4vY29yZSI6MTgsIi4vdjMiOjY2fV0sNjg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIHY0Q3JlZGVudGlhbHMgPSByZXF1aXJlKCcuL3Y0X2NyZWRlbnRpYWxzJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciBleHBpcmVzSGVhZGVyID0gJ3ByZXNpZ25lZC1leHBpcmVzJzsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuU2lnbmVycy5WNCA9IGluaGVyaXQoQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lciwgewogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFY0KHJlcXVlc3QsIHNlcnZpY2VOYW1lLCBvcHRpb25zKSB7CiAgICAgIEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIuY2FsbCh0aGlzLCByZXF1ZXN0KTsKICAgICAgdGhpcy5zZXJ2aWNlTmFtZSA9IHNlcnZpY2VOYW1lOwogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgdGhpcy5zaWduYXR1cmVDYWNoZSA9IHR5cGVvZiBvcHRpb25zLnNpZ25hdHVyZUNhY2hlID09PSAnYm9vbGVhbicgPyBvcHRpb25zLnNpZ25hdHVyZUNhY2hlIDogdHJ1ZTsKICAgICAgdGhpcy5vcGVyYXRpb24gPSBvcHRpb25zLm9wZXJhdGlvbjsKICAgICAgdGhpcy5zaWduYXR1cmVWZXJzaW9uID0gb3B0aW9ucy5zaWduYXR1cmVWZXJzaW9uOwogICAgfSwKICAKICAgIGFsZ29yaXRobTogJ0FXUzQtSE1BQy1TSEEyNTYnLAogIAogICAgYWRkQXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYWRkQXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZSkgewogICAgICB2YXIgZGF0ZXRpbWUgPSBBV1MudXRpbC5kYXRlLmlzbzg2MDEoZGF0ZSkucmVwbGFjZSgvWzpcLV18XC5cZHszfS9nLCAnJyk7CiAgCiAgICAgIGlmICh0aGlzLmlzUHJlc2lnbmVkKCkpIHsKICAgICAgICB0aGlzLnVwZGF0ZUZvclByZXNpZ25lZChjcmVkZW50aWFscywgZGF0ZXRpbWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYWRkSGVhZGVycyhjcmVkZW50aWFscywgZGF0ZXRpbWUpOwogICAgICB9CiAgCiAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydBdXRob3JpemF0aW9uJ10gPQogICAgICAgIHRoaXMuYXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZXRpbWUpOwogICAgfSwKICAKICAgIGFkZEhlYWRlcnM6IGZ1bmN0aW9uIGFkZEhlYWRlcnMoY3JlZGVudGlhbHMsIGRhdGV0aW1lKSB7CiAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydYLUFtei1EYXRlJ10gPSBkYXRldGltZTsKICAgICAgaWYgKGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbikgewogICAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWyd4LWFtei1zZWN1cml0eS10b2tlbiddID0gY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuOwogICAgICB9CiAgICB9LAogIAogICAgdXBkYXRlRm9yUHJlc2lnbmVkOiBmdW5jdGlvbiB1cGRhdGVGb3JQcmVzaWduZWQoY3JlZGVudGlhbHMsIGRhdGV0aW1lKSB7CiAgICAgIHZhciBjcmVkU3RyaW5nID0gdGhpcy5jcmVkZW50aWFsU3RyaW5nKGRhdGV0aW1lKTsKICAgICAgdmFyIHFzID0gewogICAgICAgICdYLUFtei1EYXRlJzogZGF0ZXRpbWUsCiAgICAgICAgJ1gtQW16LUFsZ29yaXRobSc6IHRoaXMuYWxnb3JpdGhtLAogICAgICAgICdYLUFtei1DcmVkZW50aWFsJzogY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgKyAnLycgKyBjcmVkU3RyaW5nLAogICAgICAgICdYLUFtei1FeHBpcmVzJzogdGhpcy5yZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl0sCiAgICAgICAgJ1gtQW16LVNpZ25lZEhlYWRlcnMnOiB0aGlzLnNpZ25lZEhlYWRlcnMoKQogICAgICB9OwogIAogICAgICBpZiAoY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuKSB7CiAgICAgICAgcXNbJ1gtQW16LVNlY3VyaXR5LVRva2VuJ10gPSBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW47CiAgICAgIH0KICAKICAgICAgaWYgKHRoaXMucmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXSkgewogICAgICAgIHFzWydDb250ZW50LVR5cGUnXSA9IHRoaXMucmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXTsKICAgICAgfQogICAgICBpZiAodGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtTUQ1J10pIHsKICAgICAgICBxc1snQ29udGVudC1NRDUnXSA9IHRoaXMucmVxdWVzdC5oZWFkZXJzWydDb250ZW50LU1ENSddOwogICAgICB9CiAgICAgIGlmICh0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ2FjaGUtQ29udHJvbCddKSB7CiAgICAgICAgcXNbJ0NhY2hlLUNvbnRyb2wnXSA9IHRoaXMucmVxdWVzdC5oZWFkZXJzWydDYWNoZS1Db250cm9sJ107CiAgICAgIH0KICAKICAgICAgLy8gbmVlZCB0byBwdWxsIGluIGFueSBvdGhlciBYLUFtei0qIGhlYWRlcnMKICAgICAgQVdTLnV0aWwuZWFjaC5jYWxsKHRoaXMsIHRoaXMucmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKGtleSA9PT0gZXhwaXJlc0hlYWRlcikgcmV0dXJuOwogICAgICAgIGlmICh0aGlzLmlzU2lnbmFibGVIZWFkZXIoa2V5KSkgewogICAgICAgICAgdmFyIGxvd2VyS2V5ID0ga2V5LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAvLyBNZXRhZGF0YSBzaG91bGQgYmUgbm9ybWFsaXplZAogICAgICAgICAgaWYgKGxvd2VyS2V5LmluZGV4T2YoJ3gtYW16LW1ldGEtJykgPT09IDApIHsKICAgICAgICAgICAgcXNbbG93ZXJLZXldID0gdmFsdWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGxvd2VyS2V5LmluZGV4T2YoJ3gtYW16LScpID09PSAwKSB7CiAgICAgICAgICAgIHFzW2tleV0gPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICB2YXIgc2VwID0gdGhpcy5yZXF1ZXN0LnBhdGguaW5kZXhPZignPycpID49IDAgPyAnJicgOiAnPyc7CiAgICAgIHRoaXMucmVxdWVzdC5wYXRoICs9IHNlcCArIEFXUy51dGlsLnF1ZXJ5UGFyYW1zVG9TdHJpbmcocXMpOwogICAgfSwKICAKICAgIGF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGV0aW1lKSB7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICB2YXIgY3JlZFN0cmluZyA9IHRoaXMuY3JlZGVudGlhbFN0cmluZyhkYXRldGltZSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5hbGdvcml0aG0gKyAnIENyZWRlbnRpYWw9JyArCiAgICAgICAgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgKyAnLycgKyBjcmVkU3RyaW5nKTsKICAgICAgcGFydHMucHVzaCgnU2lnbmVkSGVhZGVycz0nICsgdGhpcy5zaWduZWRIZWFkZXJzKCkpOwogICAgICBwYXJ0cy5wdXNoKCdTaWduYXR1cmU9JyArIHRoaXMuc2lnbmF0dXJlKGNyZWRlbnRpYWxzLCBkYXRldGltZSkpOwogICAgICByZXR1cm4gcGFydHMuam9pbignLCAnKTsKICAgIH0sCiAgCiAgICBzaWduYXR1cmU6IGZ1bmN0aW9uIHNpZ25hdHVyZShjcmVkZW50aWFscywgZGF0ZXRpbWUpIHsKICAgICAgdmFyIHNpZ25pbmdLZXkgPSB2NENyZWRlbnRpYWxzLmdldFNpZ25pbmdLZXkoCiAgICAgICAgY3JlZGVudGlhbHMsCiAgICAgICAgZGF0ZXRpbWUuc3Vic3RyKDAsIDgpLAogICAgICAgIHRoaXMucmVxdWVzdC5yZWdpb24sCiAgICAgICAgdGhpcy5zZXJ2aWNlTmFtZSwKICAgICAgICB0aGlzLnNpZ25hdHVyZUNhY2hlCiAgICAgICk7CiAgICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uaG1hYyhzaWduaW5nS2V5LCB0aGlzLnN0cmluZ1RvU2lnbihkYXRldGltZSksICdoZXgnKTsKICAgIH0sCiAgCiAgICBzdHJpbmdUb1NpZ246IGZ1bmN0aW9uIHN0cmluZ1RvU2lnbihkYXRldGltZSkgewogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgcGFydHMucHVzaCgnQVdTNC1ITUFDLVNIQTI1NicpOwogICAgICBwYXJ0cy5wdXNoKGRhdGV0aW1lKTsKICAgICAgcGFydHMucHVzaCh0aGlzLmNyZWRlbnRpYWxTdHJpbmcoZGF0ZXRpbWUpKTsKICAgICAgcGFydHMucHVzaCh0aGlzLmhleEVuY29kZWRIYXNoKHRoaXMuY2Fub25pY2FsU3RyaW5nKCkpKTsKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CiAgICB9LAogIAogICAgY2Fub25pY2FsU3RyaW5nOiBmdW5jdGlvbiBjYW5vbmljYWxTdHJpbmcoKSB7CiAgICAgIHZhciBwYXJ0cyA9IFtdLCBwYXRobmFtZSA9IHRoaXMucmVxdWVzdC5wYXRobmFtZSgpOwogICAgICBpZiAodGhpcy5zZXJ2aWNlTmFtZSAhPT0gJ3MzJyAmJiB0aGlzLnNpZ25hdHVyZVZlcnNpb24gIT09ICdzM3Y0JykgcGF0aG5hbWUgPSBBV1MudXRpbC51cmlFc2NhcGVQYXRoKHBhdGhuYW1lKTsKICAKICAgICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3QubWV0aG9kKTsKICAgICAgcGFydHMucHVzaChwYXRobmFtZSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0LnNlYXJjaCgpKTsKICAgICAgcGFydHMucHVzaCh0aGlzLmNhbm9uaWNhbEhlYWRlcnMoKSArICdcbicpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMuc2lnbmVkSGVhZGVycygpKTsKICAgICAgcGFydHMucHVzaCh0aGlzLmhleEVuY29kZWRCb2R5SGFzaCgpKTsKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CiAgICB9LAogIAogICAgY2Fub25pY2FsSGVhZGVyczogZnVuY3Rpb24gY2Fub25pY2FsSGVhZGVycygpIHsKICAgICAgdmFyIGhlYWRlcnMgPSBbXTsKICAgICAgQVdTLnV0aWwuZWFjaC5jYWxsKHRoaXMsIHRoaXMucmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiAoa2V5LCBpdGVtKSB7CiAgICAgICAgaGVhZGVycy5wdXNoKFtrZXksIGl0ZW1dKTsKICAgICAgfSk7CiAgICAgIGhlYWRlcnMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICAgIHJldHVybiBhWzBdLnRvTG93ZXJDYXNlKCkgPCBiWzBdLnRvTG93ZXJDYXNlKCkgPyAtMSA6IDE7CiAgICAgIH0pOwogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoLmNhbGwodGhpcywgaGVhZGVycywgZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICB2YXIga2V5ID0gaXRlbVswXS50b0xvd2VyQ2FzZSgpOwogICAgICAgIGlmICh0aGlzLmlzU2lnbmFibGVIZWFkZXIoa2V5KSkgewogICAgICAgICAgdmFyIHZhbHVlID0gaXRlbVsxXTsKICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnIHx8IHZhbHVlID09PSBudWxsIHx8IHR5cGVvZiB2YWx1ZS50b1N0cmluZyAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ0hlYWRlciAnICsga2V5ICsgJyBjb250YWlucyBpbnZhbGlkIHZhbHVlJyksIHsKICAgICAgICAgICAgICBjb2RlOiAnSW52YWxpZEhlYWRlcicKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBwYXJ0cy5wdXNoKGtleSArICc6JyArCiAgICAgICAgICAgIHRoaXMuY2Fub25pY2FsSGVhZGVyVmFsdWVzKHZhbHVlLnRvU3RyaW5nKCkpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKICAgIH0sCiAgCiAgICBjYW5vbmljYWxIZWFkZXJWYWx1ZXM6IGZ1bmN0aW9uIGNhbm9uaWNhbEhlYWRlclZhbHVlcyh2YWx1ZXMpIHsKICAgICAgcmV0dXJuIHZhbHVlcy5yZXBsYWNlKC9ccysvZywgJyAnKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpOwogICAgfSwKICAKICAgIHNpZ25lZEhlYWRlcnM6IGZ1bmN0aW9uIHNpZ25lZEhlYWRlcnMoKSB7CiAgICAgIHZhciBrZXlzID0gW107CiAgICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLnJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gKGtleSkgewogICAgICAgIGtleSA9IGtleS50b0xvd2VyQ2FzZSgpOwogICAgICAgIGlmICh0aGlzLmlzU2lnbmFibGVIZWFkZXIoa2V5KSkga2V5cy5wdXNoKGtleSk7CiAgICAgIH0pOwogICAgICByZXR1cm4ga2V5cy5zb3J0KCkuam9pbignOycpOwogICAgfSwKICAKICAgIGNyZWRlbnRpYWxTdHJpbmc6IGZ1bmN0aW9uIGNyZWRlbnRpYWxTdHJpbmcoZGF0ZXRpbWUpIHsKICAgICAgcmV0dXJuIHY0Q3JlZGVudGlhbHMuY3JlYXRlU2NvcGUoCiAgICAgICAgZGF0ZXRpbWUuc3Vic3RyKDAsIDgpLAogICAgICAgIHRoaXMucmVxdWVzdC5yZWdpb24sCiAgICAgICAgdGhpcy5zZXJ2aWNlTmFtZQogICAgICApOwogICAgfSwKICAKICAgIGhleEVuY29kZWRIYXNoOiBmdW5jdGlvbiBoYXNoKHN0cmluZykgewogICAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLnNoYTI1NihzdHJpbmcsICdoZXgnKTsKICAgIH0sCiAgCiAgICBoZXhFbmNvZGVkQm9keUhhc2g6IGZ1bmN0aW9uIGhleEVuY29kZWRCb2R5SGFzaCgpIHsKICAgICAgdmFyIHJlcXVlc3QgPSB0aGlzLnJlcXVlc3Q7CiAgICAgIGlmICh0aGlzLmlzUHJlc2lnbmVkKCkgJiYgdGhpcy5zZXJ2aWNlTmFtZSA9PT0gJ3MzJyAmJiAhcmVxdWVzdC5ib2R5KSB7CiAgICAgICAgcmV0dXJuICdVTlNJR05FRC1QQVlMT0FEJzsKICAgICAgfSBlbHNlIGlmIChyZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LUNvbnRlbnQtU2hhMjU2J10pIHsKICAgICAgICByZXR1cm4gcmVxdWVzdC5oZWFkZXJzWydYLUFtei1Db250ZW50LVNoYTI1NiddOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmhleEVuY29kZWRIYXNoKHRoaXMucmVxdWVzdC5ib2R5IHx8ICcnKTsKICAgICAgfQogICAgfSwKICAKICAgIHVuc2lnbmFibGVIZWFkZXJzOiBbCiAgICAgICdhdXRob3JpemF0aW9uJywKICAgICAgJ2NvbnRlbnQtdHlwZScsCiAgICAgICdjb250ZW50LWxlbmd0aCcsCiAgICAgICd1c2VyLWFnZW50JywKICAgICAgZXhwaXJlc0hlYWRlciwKICAgICAgJ2V4cGVjdCcsCiAgICAgICd4LWFtem4tdHJhY2UtaWQnCiAgICBdLAogIAogICAgaXNTaWduYWJsZUhlYWRlcjogZnVuY3Rpb24gaXNTaWduYWJsZUhlYWRlcihrZXkpIHsKICAgICAgaWYgKGtleS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJ3gtYW16LScpID09PSAwKSByZXR1cm4gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXMudW5zaWduYWJsZUhlYWRlcnMuaW5kZXhPZihrZXkpIDwgMDsKICAgIH0sCiAgCiAgICBpc1ByZXNpZ25lZDogZnVuY3Rpb24gaXNQcmVzaWduZWQoKSB7CiAgICAgIHJldHVybiB0aGlzLnJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXSA/IHRydWUgOiBmYWxzZTsKICAgIH0KICAKICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlY0OwogIAogIH0seyIuLi9jb3JlIjoxOCwiLi92NF9jcmVkZW50aWFscyI6Njl9XSw2OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgY2FjaGVkU2VjcmV0ID0ge307CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIGNhY2hlUXVldWUgPSBbXTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgbWF4Q2FjaGVFbnRyaWVzID0gNTA7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIHY0SWRlbnRpZmllciA9ICdhd3M0X3JlcXVlc3QnOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW0gZGF0ZSBbU3RyaW5nXQogICAgICogQHBhcmFtIHJlZ2lvbiBbU3RyaW5nXQogICAgICogQHBhcmFtIHNlcnZpY2VOYW1lIFtTdHJpbmddCiAgICAgKiBAcmV0dXJuIFtTdHJpbmddCiAgICAgKi8KICAgIGNyZWF0ZVNjb3BlOiBmdW5jdGlvbiBjcmVhdGVTY29wZShkYXRlLCByZWdpb24sIHNlcnZpY2VOYW1lKSB7CiAgICAgIHJldHVybiBbCiAgICAgICAgZGF0ZS5zdWJzdHIoMCwgOCksCiAgICAgICAgcmVnaW9uLAogICAgICAgIHNlcnZpY2VOYW1lLAogICAgICAgIHY0SWRlbnRpZmllcgogICAgICBdLmpvaW4oJy8nKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICoKICAgICAqIEBwYXJhbSBjcmVkZW50aWFscyBbQ3JlZGVudGlhbHNdCiAgICAgKiBAcGFyYW0gZGF0ZSBbU3RyaW5nXQogICAgICogQHBhcmFtIHJlZ2lvbiBbU3RyaW5nXQogICAgICogQHBhcmFtIHNlcnZpY2UgW1N0cmluZ10KICAgICAqIEBwYXJhbSBzaG91bGRDYWNoZSBbQm9vbGVhbl0KICAgICAqIEByZXR1cm4gW1N0cmluZ10KICAgICAqLwogICAgZ2V0U2lnbmluZ0tleTogZnVuY3Rpb24gZ2V0U2lnbmluZ0tleSgKICAgICAgY3JlZGVudGlhbHMsCiAgICAgIGRhdGUsCiAgICAgIHJlZ2lvbiwKICAgICAgc2VydmljZSwKICAgICAgc2hvdWxkQ2FjaGUKICAgICkgewogICAgICB2YXIgY3JlZHNJZGVudGlmaWVyID0gQVdTLnV0aWwuY3J5cHRvCiAgICAgICAgLmhtYWMoY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5LCBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCwgJ2Jhc2U2NCcpOwogICAgICB2YXIgY2FjaGVLZXkgPSBbY3JlZHNJZGVudGlmaWVyLCBkYXRlLCByZWdpb24sIHNlcnZpY2VdLmpvaW4oJ18nKTsKICAgICAgc2hvdWxkQ2FjaGUgPSBzaG91bGRDYWNoZSAhPT0gZmFsc2U7CiAgICAgIGlmIChzaG91bGRDYWNoZSAmJiAoY2FjaGVLZXkgaW4gY2FjaGVkU2VjcmV0KSkgewogICAgICAgIHJldHVybiBjYWNoZWRTZWNyZXRbY2FjaGVLZXldOwogICAgICB9CiAgCiAgICAgIHZhciBrRGF0ZSA9IEFXUy51dGlsLmNyeXB0by5obWFjKAogICAgICAgICdBV1M0JyArIGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSwKICAgICAgICBkYXRlLAogICAgICAgICdidWZmZXInCiAgICAgICk7CiAgICAgIHZhciBrUmVnaW9uID0gQVdTLnV0aWwuY3J5cHRvLmhtYWMoa0RhdGUsIHJlZ2lvbiwgJ2J1ZmZlcicpOwogICAgICB2YXIga1NlcnZpY2UgPSBBV1MudXRpbC5jcnlwdG8uaG1hYyhrUmVnaW9uLCBzZXJ2aWNlLCAnYnVmZmVyJyk7CiAgCiAgICAgIHZhciBzaWduaW5nS2V5ID0gQVdTLnV0aWwuY3J5cHRvLmhtYWMoa1NlcnZpY2UsIHY0SWRlbnRpZmllciwgJ2J1ZmZlcicpOwogICAgICBpZiAoc2hvdWxkQ2FjaGUpIHsKICAgICAgICBjYWNoZWRTZWNyZXRbY2FjaGVLZXldID0gc2lnbmluZ0tleTsKICAgICAgICBjYWNoZVF1ZXVlLnB1c2goY2FjaGVLZXkpOwogICAgICAgIGlmIChjYWNoZVF1ZXVlLmxlbmd0aCA+IG1heENhY2hlRW50cmllcykgewogICAgICAgICAgLy8gcmVtb3ZlIHRoZSBvbGRlc3QgZW50cnkgKG5vdCB0aGUgbGVhc3QgcmVjZW50bHkgdXNlZCkKICAgICAgICAgIGRlbGV0ZSBjYWNoZWRTZWNyZXRbY2FjaGVRdWV1ZS5zaGlmdCgpXTsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHNpZ25pbmdLZXk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqCiAgICAgKiBFbXB0aWVzIHRoZSBkZXJpdmVkIHNpZ25pbmcga2V5IGNhY2hlLiBNYWRlIGF2YWlsYWJsZSBmb3IgdGVzdGluZyBwdXJwb3NlcwogICAgICogb25seS4KICAgICAqLwogICAgZW1wdHlDYWNoZTogZnVuY3Rpb24gZW1wdHlDYWNoZSgpIHsKICAgICAgY2FjaGVkU2VjcmV0ID0ge307CiAgICAgIGNhY2hlUXVldWUgPSBbXTsKICAgIH0KICB9OwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDcwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBmdW5jdGlvbiBBY2NlcHRvclN0YXRlTWFjaGluZShzdGF0ZXMsIHN0YXRlKSB7CiAgICB0aGlzLmN1cnJlbnRTdGF0ZSA9IHN0YXRlIHx8IG51bGw7CiAgICB0aGlzLnN0YXRlcyA9IHN0YXRlcyB8fCB7fTsKICB9CiAgCiAgQWNjZXB0b3JTdGF0ZU1hY2hpbmUucHJvdG90eXBlLnJ1blRvID0gZnVuY3Rpb24gcnVuVG8oZmluYWxTdGF0ZSwgZG9uZSwgYmluZE9iamVjdCwgaW5wdXRFcnJvcikgewogICAgaWYgKHR5cGVvZiBmaW5hbFN0YXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGlucHV0RXJyb3IgPSBiaW5kT2JqZWN0OyBiaW5kT2JqZWN0ID0gZG9uZTsKICAgICAgZG9uZSA9IGZpbmFsU3RhdGU7IGZpbmFsU3RhdGUgPSBudWxsOwogICAgfQogIAogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHN0YXRlID0gc2VsZi5zdGF0ZXNbc2VsZi5jdXJyZW50U3RhdGVdOwogICAgc3RhdGUuZm4uY2FsbChiaW5kT2JqZWN0IHx8IHNlbGYsIGlucHV0RXJyb3IsIGZ1bmN0aW9uKGVycikgewogICAgICBpZiAoZXJyKSB7CiAgICAgICAgaWYgKHN0YXRlLmZhaWwpIHNlbGYuY3VycmVudFN0YXRlID0gc3RhdGUuZmFpbDsKICAgICAgICBlbHNlIHJldHVybiBkb25lID8gZG9uZS5jYWxsKGJpbmRPYmplY3QsIGVycikgOiBudWxsOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChzdGF0ZS5hY2NlcHQpIHNlbGYuY3VycmVudFN0YXRlID0gc3RhdGUuYWNjZXB0OwogICAgICAgIGVsc2UgcmV0dXJuIGRvbmUgPyBkb25lLmNhbGwoYmluZE9iamVjdCkgOiBudWxsOwogICAgICB9CiAgICAgIGlmIChzZWxmLmN1cnJlbnRTdGF0ZSA9PT0gZmluYWxTdGF0ZSkgewogICAgICAgIHJldHVybiBkb25lID8gZG9uZS5jYWxsKGJpbmRPYmplY3QsIGVycikgOiBudWxsOwogICAgICB9CiAgCiAgICAgIHNlbGYucnVuVG8oZmluYWxTdGF0ZSwgZG9uZSwgYmluZE9iamVjdCwgZXJyKTsKICAgIH0pOwogIH07CiAgCiAgQWNjZXB0b3JTdGF0ZU1hY2hpbmUucHJvdG90eXBlLmFkZFN0YXRlID0gZnVuY3Rpb24gYWRkU3RhdGUobmFtZSwgYWNjZXB0U3RhdGUsIGZhaWxTdGF0ZSwgZm4pIHsKICAgIGlmICh0eXBlb2YgYWNjZXB0U3RhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgZm4gPSBhY2NlcHRTdGF0ZTsgYWNjZXB0U3RhdGUgPSBudWxsOyBmYWlsU3RhdGUgPSBudWxsOwogICAgfSBlbHNlIGlmICh0eXBlb2YgZmFpbFN0YXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGZuID0gZmFpbFN0YXRlOyBmYWlsU3RhdGUgPSBudWxsOwogICAgfQogIAogICAgaWYgKCF0aGlzLmN1cnJlbnRTdGF0ZSkgdGhpcy5jdXJyZW50U3RhdGUgPSBuYW1lOwogICAgdGhpcy5zdGF0ZXNbbmFtZV0gPSB7IGFjY2VwdDogYWNjZXB0U3RhdGUsIGZhaWw6IGZhaWxTdGF0ZSwgZm46IGZuIH07CiAgICByZXR1cm4gdGhpczsKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQWNjZXB0b3JTdGF0ZU1hY2hpbmU7CiAgCiAgfSx7fV0sNzE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAocHJvY2VzcyxzZXRJbW1lZGlhdGUpeyhmdW5jdGlvbiAoKXsKICAvKiBlc2xpbnQgZ3VhcmQtZm9yLWluOjAgKi8KICB2YXIgQVdTOwogIAogIC8qKgogICAqIEEgc2V0IG9mIHV0aWxpdHkgbWV0aG9kcyBmb3IgdXNlIHdpdGggdGhlIEFXUyBTREsuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBhYm9ydAogICAqICAgUmV0dXJuIHRoaXMgdmFsdWUgZnJvbSBhbiBpdGVyYXRvciBmdW5jdGlvbiB7ZWFjaH0gb3Ige2FycmF5RWFjaH0KICAgKiAgIHRvIGJyZWFrIG91dCBvZiB0aGUgaXRlcmF0aW9uLgogICAqICAgQGV4YW1wbGUgQnJlYWtpbmcgb3V0IG9mIGFuIGl0ZXJhdG9yIGZ1bmN0aW9uCiAgICogICAgIEFXUy51dGlsLmVhY2goe2E6IDEsIGI6IDIsIGM6IDN9LCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICogICAgICAgaWYgKGtleSA9PSAnYicpIHJldHVybiBBV1MudXRpbC5hYm9ydDsKICAgKiAgICAgfSk7CiAgICogICBAc2VlIGVhY2gKICAgKiAgIEBzZWUgYXJyYXlFYWNoCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIHV0aWwgPSB7CiAgICBlbnZpcm9ubWVudDogJ25vZGVqcycsCiAgICBlbmdpbmU6IGZ1bmN0aW9uIGVuZ2luZSgpIHsKICAgICAgaWYgKHV0aWwuaXNCcm93c2VyKCkgJiYgdHlwZW9mIG5hdmlnYXRvciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICByZXR1cm4gbmF2aWdhdG9yLnVzZXJBZ2VudDsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgZW5naW5lID0gcHJvY2Vzcy5wbGF0Zm9ybSArICcvJyArIHByb2Nlc3MudmVyc2lvbjsKICAgICAgICBpZiAocHJvY2Vzcy5lbnYuQVdTX0VYRUNVVElPTl9FTlYpIHsKICAgICAgICAgIGVuZ2luZSArPSAnIGV4ZWMtZW52LycgKyBwcm9jZXNzLmVudi5BV1NfRVhFQ1VUSU9OX0VOVjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGVuZ2luZTsKICAgICAgfQogICAgfSwKICAKICAgIHVzZXJBZ2VudDogZnVuY3Rpb24gdXNlckFnZW50KCkgewogICAgICB2YXIgbmFtZSA9IHV0aWwuZW52aXJvbm1lbnQ7CiAgICAgIHZhciBhZ2VudCA9ICdhd3Mtc2RrLScgKyBuYW1lICsgJy8nICsgcmVxdWlyZSgnLi9jb3JlJykuVkVSU0lPTjsKICAgICAgaWYgKG5hbWUgPT09ICdub2RlanMnKSBhZ2VudCArPSAnICcgKyB1dGlsLmVuZ2luZSgpOwogICAgICByZXR1cm4gYWdlbnQ7CiAgICB9LAogIAogICAgdXJpRXNjYXBlOiBmdW5jdGlvbiB1cmlFc2NhcGUoc3RyaW5nKSB7CiAgICAgIHZhciBvdXRwdXQgPSBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5nKTsKICAgICAgb3V0cHV0ID0gb3V0cHV0LnJlcGxhY2UoL1teQS1aYS16MC05Xy5+XC0lXSsvZywgZXNjYXBlKTsKICAKICAgICAgLy8gQVdTIHBlcmNlbnQtZW5jb2RlcyBzb21lIGV4dHJhIG5vbi1zdGFuZGFyZCBjaGFyYWN0ZXJzIGluIGEgVVJJCiAgICAgIG91dHB1dCA9IG91dHB1dC5yZXBsYWNlKC9bKl0vZywgZnVuY3Rpb24oY2gpIHsKICAgICAgICByZXR1cm4gJyUnICsgY2guY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikudG9VcHBlckNhc2UoKTsKICAgICAgfSk7CiAgCiAgICAgIHJldHVybiBvdXRwdXQ7CiAgICB9LAogIAogICAgdXJpRXNjYXBlUGF0aDogZnVuY3Rpb24gdXJpRXNjYXBlUGF0aChzdHJpbmcpIHsKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIHV0aWwuYXJyYXlFYWNoKHN0cmluZy5zcGxpdCgnLycpLCBmdW5jdGlvbiAocGFydCkgewogICAgICAgIHBhcnRzLnB1c2godXRpbC51cmlFc2NhcGUocGFydCkpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJy8nKTsKICAgIH0sCiAgCiAgICB1cmxQYXJzZTogZnVuY3Rpb24gdXJsUGFyc2UodXJsKSB7CiAgICAgIHJldHVybiB1dGlsLnVybC5wYXJzZSh1cmwpOwogICAgfSwKICAKICAgIHVybEZvcm1hdDogZnVuY3Rpb24gdXJsRm9ybWF0KHVybCkgewogICAgICByZXR1cm4gdXRpbC51cmwuZm9ybWF0KHVybCk7CiAgICB9LAogIAogICAgcXVlcnlTdHJpbmdQYXJzZTogZnVuY3Rpb24gcXVlcnlTdHJpbmdQYXJzZShxcykgewogICAgICByZXR1cm4gdXRpbC5xdWVyeXN0cmluZy5wYXJzZShxcyk7CiAgICB9LAogIAogICAgcXVlcnlQYXJhbXNUb1N0cmluZzogZnVuY3Rpb24gcXVlcnlQYXJhbXNUb1N0cmluZyhwYXJhbXMpIHsKICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgIHZhciBlc2NhcGUgPSB1dGlsLnVyaUVzY2FwZTsKICAgICAgdmFyIHNvcnRlZEtleXMgPSBPYmplY3Qua2V5cyhwYXJhbXMpLnNvcnQoKTsKICAKICAgICAgdXRpbC5hcnJheUVhY2goc29ydGVkS2V5cywgZnVuY3Rpb24obmFtZSkgewogICAgICAgIHZhciB2YWx1ZSA9IHBhcmFtc1tuYW1lXTsKICAgICAgICB2YXIgZW5hbWUgPSBlc2NhcGUobmFtZSk7CiAgICAgICAgdmFyIHJlc3VsdCA9IGVuYW1lICsgJz0nOwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgdmFyIHZhbHMgPSBbXTsKICAgICAgICAgIHV0aWwuYXJyYXlFYWNoKHZhbHVlLCBmdW5jdGlvbihpdGVtKSB7IHZhbHMucHVzaChlc2NhcGUoaXRlbSkpOyB9KTsKICAgICAgICAgIHJlc3VsdCA9IGVuYW1lICsgJz0nICsgdmFscy5zb3J0KCkuam9pbignJicgKyBlbmFtZSArICc9Jyk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgICByZXN1bHQgPSBlbmFtZSArICc9JyArIGVzY2FwZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGl0ZW1zLnB1c2gocmVzdWx0KTsKICAgICAgfSk7CiAgCiAgICAgIHJldHVybiBpdGVtcy5qb2luKCcmJyk7CiAgICB9LAogIAogICAgcmVhZEZpbGVTeW5jOiBmdW5jdGlvbiByZWFkRmlsZVN5bmMocGF0aCkgewogICAgICBpZiAodXRpbC5pc0Jyb3dzZXIoKSkgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiByZXF1aXJlKCdmcycpLnJlYWRGaWxlU3luYyhwYXRoLCAndXRmLTgnKTsKICAgIH0sCiAgCiAgICBiYXNlNjQ6IHsKICAgICAgZW5jb2RlOiBmdW5jdGlvbiBlbmNvZGU2NChzdHJpbmcpIHsKICAgICAgICBpZiAodHlwZW9mIHN0cmluZyA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdDYW5ub3QgYmFzZTY0IGVuY29kZSBudW1iZXIgJyArIHN0cmluZykpOwogICAgICAgIH0KICAgICAgICBpZiAoc3RyaW5nID09PSBudWxsIHx8IHR5cGVvZiBzdHJpbmcgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgIH0KICAgICAgICB2YXIgYnVmID0gdXRpbC5idWZmZXIudG9CdWZmZXIoc3RyaW5nKTsKICAgICAgICByZXR1cm4gYnVmLnRvU3RyaW5nKCdiYXNlNjQnKTsKICAgICAgfSwKICAKICAgICAgZGVjb2RlOiBmdW5jdGlvbiBkZWNvZGU2NChzdHJpbmcpIHsKICAgICAgICBpZiAodHlwZW9mIHN0cmluZyA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdDYW5ub3QgYmFzZTY0IGRlY29kZSBudW1iZXIgJyArIHN0cmluZykpOwogICAgICAgIH0KICAgICAgICBpZiAoc3RyaW5nID09PSBudWxsIHx8IHR5cGVvZiBzdHJpbmcgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdXRpbC5idWZmZXIudG9CdWZmZXIoc3RyaW5nLCAnYmFzZTY0Jyk7CiAgICAgIH0KICAKICAgIH0sCiAgCiAgICBidWZmZXI6IHsKICAgICAgLyoqCiAgICAgICAqIEJ1ZmZlciBjb25zdHJ1Y3RvciBmb3IgTm9kZSBidWZmZXIgYW5kIGJ1ZmZlciBwb2xseWZpbGwKICAgICAgICovCiAgICAgIHRvQnVmZmVyOiBmdW5jdGlvbihkYXRhLCBlbmNvZGluZykgewogICAgICAgIHJldHVybiAodHlwZW9mIHV0aWwuQnVmZmVyLmZyb20gPT09ICdmdW5jdGlvbicgJiYgdXRpbC5CdWZmZXIuZnJvbSAhPT0gVWludDhBcnJheS5mcm9tKSA/CiAgICAgICAgICB1dGlsLkJ1ZmZlci5mcm9tKGRhdGEsIGVuY29kaW5nKSA6IG5ldyB1dGlsLkJ1ZmZlcihkYXRhLCBlbmNvZGluZyk7CiAgICAgIH0sCiAgCiAgICAgIGFsbG9jOiBmdW5jdGlvbihzaXplLCBmaWxsLCBlbmNvZGluZykgewogICAgICAgIGlmICh0eXBlb2Ygc2l6ZSAhPT0gJ251bWJlcicpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignc2l6ZSBwYXNzZWQgdG8gYWxsb2MgbXVzdCBiZSBhIG51bWJlci4nKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiB1dGlsLkJ1ZmZlci5hbGxvYyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgcmV0dXJuIHV0aWwuQnVmZmVyLmFsbG9jKHNpemUsIGZpbGwsIGVuY29kaW5nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGJ1ZiA9IG5ldyB1dGlsLkJ1ZmZlcihzaXplKTsKICAgICAgICAgIGlmIChmaWxsICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIGJ1Zi5maWxsID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGJ1Zi5maWxsKGZpbGwsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBlbmNvZGluZyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYnVmOwogICAgICAgIH0KICAgICAgfSwKICAKICAgICAgdG9TdHJlYW06IGZ1bmN0aW9uIHRvU3RyZWFtKGJ1ZmZlcikgewogICAgICAgIGlmICghdXRpbC5CdWZmZXIuaXNCdWZmZXIoYnVmZmVyKSkgYnVmZmVyID0gIHV0aWwuYnVmZmVyLnRvQnVmZmVyKGJ1ZmZlcik7CiAgCiAgICAgICAgdmFyIHJlYWRhYmxlID0gbmV3ICh1dGlsLnN0cmVhbS5SZWFkYWJsZSkoKTsKICAgICAgICB2YXIgcG9zID0gMDsKICAgICAgICByZWFkYWJsZS5fcmVhZCA9IGZ1bmN0aW9uKHNpemUpIHsKICAgICAgICAgIGlmIChwb3MgPj0gYnVmZmVyLmxlbmd0aCkgcmV0dXJuIHJlYWRhYmxlLnB1c2gobnVsbCk7CiAgCiAgICAgICAgICB2YXIgZW5kID0gcG9zICsgc2l6ZTsKICAgICAgICAgIGlmIChlbmQgPiBidWZmZXIubGVuZ3RoKSBlbmQgPSBidWZmZXIubGVuZ3RoOwogICAgICAgICAgcmVhZGFibGUucHVzaChidWZmZXIuc2xpY2UocG9zLCBlbmQpKTsKICAgICAgICAgIHBvcyA9IGVuZDsKICAgICAgICB9OwogIAogICAgICAgIHJldHVybiByZWFkYWJsZTsKICAgICAgfSwKICAKICAgICAgLyoqCiAgICAgICAqIENvbmNhdGVuYXRlcyBhIGxpc3Qgb2YgQnVmZmVyIG9iamVjdHMuCiAgICAgICAqLwogICAgICBjb25jYXQ6IGZ1bmN0aW9uKGJ1ZmZlcnMpIHsKICAgICAgICB2YXIgbGVuZ3RoID0gMCwKICAgICAgICAgICAgb2Zmc2V0ID0gMCwKICAgICAgICAgICAgYnVmZmVyID0gbnVsbCwgaTsKICAKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYnVmZmVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgbGVuZ3RoICs9IGJ1ZmZlcnNbaV0ubGVuZ3RoOwogICAgICAgIH0KICAKICAgICAgICBidWZmZXIgPSB1dGlsLmJ1ZmZlci5hbGxvYyhsZW5ndGgpOwogIAogICAgICAgIGZvciAoaSA9IDA7IGkgPCBidWZmZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBidWZmZXJzW2ldLmNvcHkoYnVmZmVyLCBvZmZzZXQpOwogICAgICAgICAgb2Zmc2V0ICs9IGJ1ZmZlcnNbaV0ubGVuZ3RoOwogICAgICAgIH0KICAKICAgICAgICByZXR1cm4gYnVmZmVyOwogICAgICB9CiAgICB9LAogIAogICAgc3RyaW5nOiB7CiAgICAgIGJ5dGVMZW5ndGg6IGZ1bmN0aW9uIGJ5dGVMZW5ndGgoc3RyaW5nKSB7CiAgICAgICAgaWYgKHN0cmluZyA9PT0gbnVsbCB8fCBzdHJpbmcgPT09IHVuZGVmaW5lZCkgcmV0dXJuIDA7CiAgICAgICAgaWYgKHR5cGVvZiBzdHJpbmcgPT09ICdzdHJpbmcnKSBzdHJpbmcgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcihzdHJpbmcpOwogIAogICAgICAgIGlmICh0eXBlb2Ygc3RyaW5nLmJ5dGVMZW5ndGggPT09ICdudW1iZXInKSB7CiAgICAgICAgICByZXR1cm4gc3RyaW5nLmJ5dGVMZW5ndGg7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3RyaW5nLmxlbmd0aCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHJldHVybiBzdHJpbmcubGVuZ3RoOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0cmluZy5zaXplID09PSAnbnVtYmVyJykgewogICAgICAgICAgcmV0dXJuIHN0cmluZy5zaXplOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0cmluZy5wYXRoID09PSAnc3RyaW5nJykgewogICAgICAgICAgcmV0dXJuIHJlcXVpcmUoJ2ZzJykubHN0YXRTeW5jKHN0cmluZy5wYXRoKS5zaXplOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignQ2Fubm90IGRldGVybWluZSBsZW5ndGggb2YgJyArIHN0cmluZyksCiAgICAgICAgICAgIHsgb2JqZWN0OiBzdHJpbmcgfSk7CiAgICAgICAgfQogICAgICB9LAogIAogICAgICB1cHBlckZpcnN0OiBmdW5jdGlvbiB1cHBlckZpcnN0KHN0cmluZykgewogICAgICAgIHJldHVybiBzdHJpbmdbMF0udG9VcHBlckNhc2UoKSArIHN0cmluZy5zdWJzdHIoMSk7CiAgICAgIH0sCiAgCiAgICAgIGxvd2VyRmlyc3Q6IGZ1bmN0aW9uIGxvd2VyRmlyc3Qoc3RyaW5nKSB7CiAgICAgICAgcmV0dXJuIHN0cmluZ1swXS50b0xvd2VyQ2FzZSgpICsgc3RyaW5nLnN1YnN0cigxKTsKICAgICAgfQogICAgfSwKICAKICAgIGluaTogewogICAgICBwYXJzZTogZnVuY3Rpb24gc3RyaW5nKGluaSkgewogICAgICAgIHZhciBjdXJyZW50U2VjdGlvbiwgbWFwID0ge307CiAgICAgICAgdXRpbC5hcnJheUVhY2goaW5pLnNwbGl0KC9ccj9cbi8pLCBmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgICBsaW5lID0gbGluZS5zcGxpdCgvKF58XHMpWzsjXS8pWzBdOyAvLyByZW1vdmUgY29tbWVudHMKICAgICAgICAgIHZhciBzZWN0aW9uID0gbGluZS5tYXRjaCgvXlxzKlxbKFteXFtcXV0rKVxdXHMqJC8pOwogICAgICAgICAgaWYgKHNlY3Rpb24pIHsKICAgICAgICAgICAgY3VycmVudFNlY3Rpb24gPSBzZWN0aW9uWzFdOwogICAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50U2VjdGlvbikgewogICAgICAgICAgICB2YXIgaXRlbSA9IGxpbmUubWF0Y2goL15ccyooLis/KVxzKj1ccyooLis/KVxzKiQvKTsKICAgICAgICAgICAgaWYgKGl0ZW0pIHsKICAgICAgICAgICAgICBtYXBbY3VycmVudFNlY3Rpb25dID0gbWFwW2N1cnJlbnRTZWN0aW9uXSB8fCB7fTsKICAgICAgICAgICAgICBtYXBbY3VycmVudFNlY3Rpb25dW2l0ZW1bMV1dID0gaXRlbVsyXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogIAogICAgICAgIHJldHVybiBtYXA7CiAgICAgIH0KICAgIH0sCiAgCiAgICBmbjogewogICAgICBub29wOiBmdW5jdGlvbigpIHt9LAogICAgICBjYWxsYmFjazogZnVuY3Rpb24gKGVycikgeyBpZiAoZXJyKSB0aHJvdyBlcnI7IH0sCiAgCiAgICAgIC8qKgogICAgICAgKiBUdXJuIGEgc3luY2hyb25vdXMgZnVuY3Rpb24gaW50byBhcyAiYXN5bmMiIGZ1bmN0aW9uIGJ5IG1ha2luZyBpdCBjYWxsCiAgICAgICAqIGEgY2FsbGJhY2suIFRoZSB1bmRlcmx5aW5nIGZ1bmN0aW9uIGlzIGNhbGxlZCB3aXRoIGFsbCBidXQgdGhlIGxhc3QgYXJndW1lbnQsCiAgICAgICAqIHdoaWNoIGlzIHRyZWF0ZWQgYXMgdGhlIGNhbGxiYWNrLiBUaGUgY2FsbGJhY2sgaXMgcGFzc2VkIHBhc3NlZCBhIGZpcnN0IGFyZ3VtZW50CiAgICAgICAqIG9mIG51bGwgb24gc3VjY2VzcyB0byBtaW1pY2sgc3RhbmRhcmQgbm9kZSBjYWxsYmFja3MuCiAgICAgICAqLwogICAgICBtYWtlQXN5bmM6IGZ1bmN0aW9uIG1ha2VBc3luYyhmbiwgZXhwZWN0ZWRBcmdzKSB7CiAgICAgICAgaWYgKGV4cGVjdGVkQXJncyAmJiBleHBlY3RlZEFyZ3MgPD0gZm4ubGVuZ3RoKSB7CiAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgfQogIAogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgICAgICAgIHZhciBjYWxsYmFjayA9IGFyZ3MucG9wKCk7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gZm4uYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgICBjYWxsYmFjayhyZXN1bHQpOwogICAgICAgIH07CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIERhdGUgYW5kIHRpbWUgdXRpbGl0eSBmdW5jdGlvbnMuCiAgICAgKi8KICAgIGRhdGU6IHsKICAKICAgICAgLyoqCiAgICAgICAqIEByZXR1cm4gW0RhdGVdIHRoZSBjdXJyZW50IEphdmFTY3JpcHQgZGF0ZSBvYmplY3QuIFNpbmNlIGFsbAogICAgICAgKiAgIEFXUyBzZXJ2aWNlcyByZWx5IG9uIHRoaXMgZGF0ZSBvYmplY3QsIHlvdSBjYW4gb3ZlcnJpZGUKICAgICAgICogICB0aGlzIGZ1bmN0aW9uIHRvIHByb3ZpZGUgYSBzcGVjaWFsIHRpbWUgdmFsdWUgdG8gQVdTIHNlcnZpY2UKICAgICAgICogICByZXF1ZXN0cy4KICAgICAgICovCiAgICAgIGdldERhdGU6IGZ1bmN0aW9uIGdldERhdGUoKSB7CiAgICAgICAgaWYgKCFBV1MpIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogICAgICAgIGlmIChBV1MuY29uZmlnLnN5c3RlbUNsb2NrT2Zmc2V0KSB7IC8vIHVzZSBvZmZzZXQgd2hlbiBub24temVybwogICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKG5ldyBEYXRlKCkuZ2V0VGltZSgpICsgQVdTLmNvbmZpZy5zeXN0ZW1DbG9ja09mZnNldCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBuZXcgRGF0ZSgpOwogICAgICAgIH0KICAgICAgfSwKICAKICAgICAgLyoqCiAgICAgICAqIEByZXR1cm4gW1N0cmluZ10gdGhlIGRhdGUgaW4gSVNPLTg2MDEgZm9ybWF0CiAgICAgICAqLwogICAgICBpc284NjAxOiBmdW5jdGlvbiBpc284NjAxKGRhdGUpIHsKICAgICAgICBpZiAoZGF0ZSA9PT0gdW5kZWZpbmVkKSB7IGRhdGUgPSB1dGlsLmRhdGUuZ2V0RGF0ZSgpOyB9CiAgICAgICAgcmV0dXJuIGRhdGUudG9JU09TdHJpbmcoKS5yZXBsYWNlKC9cLlxkezN9WiQvLCAnWicpOwogICAgICB9LAogIAogICAgICAvKioKICAgICAgICogQHJldHVybiBbU3RyaW5nXSB0aGUgZGF0ZSBpbiBSRkMgODIyIGZvcm1hdAogICAgICAgKi8KICAgICAgcmZjODIyOiBmdW5jdGlvbiByZmM4MjIoZGF0ZSkgewogICAgICAgIGlmIChkYXRlID09PSB1bmRlZmluZWQpIHsgZGF0ZSA9IHV0aWwuZGF0ZS5nZXREYXRlKCk7IH0KICAgICAgICByZXR1cm4gZGF0ZS50b1VUQ1N0cmluZygpOwogICAgICB9LAogIAogICAgICAvKioKICAgICAgICogQHJldHVybiBbSW50ZWdlcl0gdGhlIFVOSVggdGltZXN0YW1wIHZhbHVlIGZvciB0aGUgY3VycmVudCB0aW1lCiAgICAgICAqLwogICAgICB1bml4VGltZXN0YW1wOiBmdW5jdGlvbiB1bml4VGltZXN0YW1wKGRhdGUpIHsKICAgICAgICBpZiAoZGF0ZSA9PT0gdW5kZWZpbmVkKSB7IGRhdGUgPSB1dGlsLmRhdGUuZ2V0RGF0ZSgpOyB9CiAgICAgICAgcmV0dXJuIGRhdGUuZ2V0VGltZSgpIC8gMTAwMDsKICAgICAgfSwKICAKICAgICAgLyoqCiAgICAgICAqIEBwYXJhbSBbU3RyaW5nLG51bWJlcixEYXRlXSBkYXRlCiAgICAgICAqIEByZXR1cm4gW0RhdGVdCiAgICAgICAqLwogICAgICBmcm9tOiBmdW5jdGlvbiBmb3JtYXQoZGF0ZSkgewogICAgICAgIGlmICh0eXBlb2YgZGF0ZSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShkYXRlICogMTAwMCk7IC8vIHVuaXggdGltZXN0YW1wCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShkYXRlKTsKICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIC8qKgogICAgICAgKiBHaXZlbiBhIERhdGUgb3IgZGF0ZS1saWtlIHZhbHVlLCB0aGlzIGZ1bmN0aW9uIGZvcm1hdHMgdGhlCiAgICAgICAqIGRhdGUgaW50byBhIHN0cmluZyBvZiB0aGUgcmVxdWVzdGVkIHZhbHVlLgogICAgICAgKiBAcGFyYW0gW1N0cmluZyxudW1iZXIsRGF0ZV0gZGF0ZQogICAgICAgKiBAcGFyYW0gW1N0cmluZ10gZm9ybWF0dGVyIFZhbGlkIGZvcm1hdHMgYXJlOgogICAgICAgIyAgICogJ2lzbzg2MDEnCiAgICAgICAjICAgKiAncmZjODIyJwogICAgICAgIyAgICogJ3VuaXhUaW1lc3RhbXAnCiAgICAgICAqIEByZXR1cm4gW1N0cmluZ10KICAgICAgICovCiAgICAgIGZvcm1hdDogZnVuY3Rpb24gZm9ybWF0KGRhdGUsIGZvcm1hdHRlcikgewogICAgICAgIGlmICghZm9ybWF0dGVyKSBmb3JtYXR0ZXIgPSAnaXNvODYwMSc7CiAgICAgICAgcmV0dXJuIHV0aWwuZGF0ZVtmb3JtYXR0ZXJdKHV0aWwuZGF0ZS5mcm9tKGRhdGUpKTsKICAgICAgfSwKICAKICAgICAgcGFyc2VUaW1lc3RhbXA6IGZ1bmN0aW9uIHBhcnNlVGltZXN0YW1wKHZhbHVlKSB7CiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicpIHsgLy8gdW5peCB0aW1lc3RhbXAgKG51bWJlcikKICAgICAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWx1ZSAqIDEwMDApOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWUubWF0Y2goL15cZCskLykpIHsgLy8gdW5peCB0aW1lc3RhbXAKICAgICAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWx1ZSAqIDEwMDApOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWUubWF0Y2goL15cZHs0fS8pKSB7IC8vIGlzbzg2MDEKICAgICAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5tYXRjaCgvXlx3ezN9LC8pKSB7IC8vIHJmYzgyMgogICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcigKICAgICAgICAgICAgbmV3IEVycm9yKCd1bmhhbmRsZWQgdGltZXN0YW1wIGZvcm1hdDogJyArIHZhbHVlKSwKICAgICAgICAgICAge2NvZGU6ICdUaW1lc3RhbXBQYXJzZXJFcnJvcid9KTsKICAgICAgICB9CiAgICAgIH0KICAKICAgIH0sCiAgCiAgICBjcnlwdG86IHsKICAgICAgY3JjMzJUYWJsZTogWwogICAgICAgMHgwMDAwMDAwMCwgMHg3NzA3MzA5NiwgMHhFRTBFNjEyQywgMHg5OTA5NTFCQSwgMHgwNzZEQzQxOSwKICAgICAgIDB4NzA2QUY0OEYsIDB4RTk2M0E1MzUsIDB4OUU2NDk1QTMsIDB4MEVEQjg4MzIsIDB4NzlEQ0I4QTQsCiAgICAgICAweEUwRDVFOTFFLCAweDk3RDJEOTg4LCAweDA5QjY0QzJCLCAweDdFQjE3Q0JELCAweEU3QjgyRDA3LAogICAgICAgMHg5MEJGMUQ5MSwgMHgxREI3MTA2NCwgMHg2QUIwMjBGMiwgMHhGM0I5NzE0OCwgMHg4NEJFNDFERSwKICAgICAgIDB4MUFEQUQ0N0QsIDB4NkREREU0RUIsIDB4RjRENEI1NTEsIDB4ODNEMzg1QzcsIDB4MTM2Qzk4NTYsCiAgICAgICAweDY0NkJBOEMwLCAweEZENjJGOTdBLCAweDhBNjVDOUVDLCAweDE0MDE1QzRGLCAweDYzMDY2Q0Q5LAogICAgICAgMHhGQTBGM0Q2MywgMHg4RDA4MERGNSwgMHgzQjZFMjBDOCwgMHg0QzY5MTA1RSwgMHhENTYwNDFFNCwKICAgICAgIDB4QTI2NzcxNzIsIDB4M0MwM0U0RDEsIDB4NEIwNEQ0NDcsIDB4RDIwRDg1RkQsIDB4QTUwQUI1NkIsCiAgICAgICAweDM1QjVBOEZBLCAweDQyQjI5ODZDLCAweERCQkJDOUQ2LCAweEFDQkNGOTQwLCAweDMyRDg2Q0UzLAogICAgICAgMHg0NURGNUM3NSwgMHhEQ0Q2MERDRiwgMHhBQkQxM0Q1OSwgMHgyNkQ5MzBBQywgMHg1MURFMDAzQSwKICAgICAgIDB4QzhENzUxODAsIDB4QkZEMDYxMTYsIDB4MjFCNEY0QjUsIDB4NTZCM0M0MjMsIDB4Q0ZCQTk1OTksCiAgICAgICAweEI4QkRBNTBGLCAweDI4MDJCODlFLCAweDVGMDU4ODA4LCAweEM2MENEOUIyLCAweEIxMEJFOTI0LAogICAgICAgMHgyRjZGN0M4NywgMHg1ODY4NEMxMSwgMHhDMTYxMURBQiwgMHhCNjY2MkQzRCwgMHg3NkRDNDE5MCwKICAgICAgIDB4MDFEQjcxMDYsIDB4OThEMjIwQkMsIDB4RUZENTEwMkEsIDB4NzFCMTg1ODksIDB4MDZCNkI1MUYsCiAgICAgICAweDlGQkZFNEE1LCAweEU4QjhENDMzLCAweDc4MDdDOUEyLCAweDBGMDBGOTM0LCAweDk2MDlBODhFLAogICAgICAgMHhFMTBFOTgxOCwgMHg3RjZBMERCQiwgMHgwODZEM0QyRCwgMHg5MTY0NkM5NywgMHhFNjYzNUMwMSwKICAgICAgIDB4NkI2QjUxRjQsIDB4MUM2QzYxNjIsIDB4ODU2NTMwRDgsIDB4RjI2MjAwNEUsIDB4NkMwNjk1RUQsCiAgICAgICAweDFCMDFBNTdCLCAweDgyMDhGNEMxLCAweEY1MEZDNDU3LCAweDY1QjBEOUM2LCAweDEyQjdFOTUwLAogICAgICAgMHg4QkJFQjhFQSwgMHhGQ0I5ODg3QywgMHg2MkREMURERiwgMHgxNURBMkQ0OSwgMHg4Q0QzN0NGMywKICAgICAgIDB4RkJENDRDNjUsIDB4NERCMjYxNTgsIDB4M0FCNTUxQ0UsIDB4QTNCQzAwNzQsIDB4RDRCQjMwRTIsCiAgICAgICAweDRBREZBNTQxLCAweDNERDg5NUQ3LCAweEE0RDFDNDZELCAweEQzRDZGNEZCLCAweDQzNjlFOTZBLAogICAgICAgMHgzNDZFRDlGQywgMHhBRDY3ODg0NiwgMHhEQTYwQjhEMCwgMHg0NDA0MkQ3MywgMHgzMzAzMURFNSwKICAgICAgIDB4QUEwQTRDNUYsIDB4REQwRDdDQzksIDB4NTAwNTcxM0MsIDB4MjcwMjQxQUEsIDB4QkUwQjEwMTAsCiAgICAgICAweEM5MEMyMDg2LCAweDU3NjhCNTI1LCAweDIwNkY4NUIzLCAweEI5NjZENDA5LCAweENFNjFFNDlGLAogICAgICAgMHg1RURFRjkwRSwgMHgyOUQ5Qzk5OCwgMHhCMEQwOTgyMiwgMHhDN0Q3QThCNCwgMHg1OUIzM0QxNywKICAgICAgIDB4MkVCNDBEODEsIDB4QjdCRDVDM0IsIDB4QzBCQTZDQUQsIDB4RURCODgzMjAsIDB4OUFCRkIzQjYsCiAgICAgICAweDAzQjZFMjBDLCAweDc0QjFEMjlBLCAweEVBRDU0NzM5LCAweDlERDI3N0FGLCAweDA0REIyNjE1LAogICAgICAgMHg3M0RDMTY4MywgMHhFMzYzMEIxMiwgMHg5NDY0M0I4NCwgMHgwRDZENkEzRSwgMHg3QTZBNUFBOCwKICAgICAgIDB4RTQwRUNGMEIsIDB4OTMwOUZGOUQsIDB4MEEwMEFFMjcsIDB4N0QwNzlFQjEsIDB4RjAwRjkzNDQsCiAgICAgICAweDg3MDhBM0QyLCAweDFFMDFGMjY4LCAweDY5MDZDMkZFLCAweEY3NjI1NzVELCAweDgwNjU2N0NCLAogICAgICAgMHgxOTZDMzY3MSwgMHg2RTZCMDZFNywgMHhGRUQ0MUI3NiwgMHg4OUQzMkJFMCwgMHgxMERBN0E1QSwKICAgICAgIDB4NjdERDRBQ0MsIDB4RjlCOURGNkYsIDB4OEVCRUVGRjksIDB4MTdCN0JFNDMsIDB4NjBCMDhFRDUsCiAgICAgICAweEQ2RDZBM0U4LCAweEExRDE5MzdFLCAweDM4RDhDMkM0LCAweDRGREZGMjUyLCAweEQxQkI2N0YxLAogICAgICAgMHhBNkJDNTc2NywgMHgzRkI1MDZERCwgMHg0OEIyMzY0QiwgMHhEODBEMkJEQSwgMHhBRjBBMUI0QywKICAgICAgIDB4MzYwMzRBRjYsIDB4NDEwNDdBNjAsIDB4REY2MEVGQzMsIDB4QTg2N0RGNTUsIDB4MzE2RThFRUYsCiAgICAgICAweDQ2NjlCRTc5LCAweENCNjFCMzhDLCAweEJDNjY4MzFBLCAweDI1NkZEMkEwLCAweDUyNjhFMjM2LAogICAgICAgMHhDQzBDNzc5NSwgMHhCQjBCNDcwMywgMHgyMjAyMTZCOSwgMHg1NTA1MjYyRiwgMHhDNUJBM0JCRSwKICAgICAgIDB4QjJCRDBCMjgsIDB4MkJCNDVBOTIsIDB4NUNCMzZBMDQsIDB4QzJEN0ZGQTcsIDB4QjVEMENGMzEsCiAgICAgICAweDJDRDk5RThCLCAweDVCREVBRTFELCAweDlCNjRDMkIwLCAweEVDNjNGMjI2LCAweDc1NkFBMzlDLAogICAgICAgMHgwMjZEOTMwQSwgMHg5QzA5MDZBOSwgMHhFQjBFMzYzRiwgMHg3MjA3Njc4NSwgMHgwNTAwNTcxMywKICAgICAgIDB4OTVCRjRBODIsIDB4RTJCODdBMTQsIDB4N0JCMTJCQUUsIDB4MENCNjFCMzgsIDB4OTJEMjhFOUIsCiAgICAgICAweEU1RDVCRTBELCAweDdDRENFRkI3LCAweDBCREJERjIxLCAweDg2RDNEMkQ0LCAweEYxRDRFMjQyLAogICAgICAgMHg2OEREQjNGOCwgMHgxRkRBODM2RSwgMHg4MUJFMTZDRCwgMHhGNkI5MjY1QiwgMHg2RkIwNzdFMSwKICAgICAgIDB4MThCNzQ3NzcsIDB4ODgwODVBRTYsIDB4RkYwRjZBNzAsIDB4NjYwNjNCQ0EsIDB4MTEwMTBCNUMsCiAgICAgICAweDhGNjU5RUZGLCAweEY4NjJBRTY5LCAweDYxNkJGRkQzLCAweDE2NkNDRjQ1LCAweEEwMEFFMjc4LAogICAgICAgMHhENzBERDJFRSwgMHg0RTA0ODM1NCwgMHgzOTAzQjNDMiwgMHhBNzY3MjY2MSwgMHhEMDYwMTZGNywKICAgICAgIDB4NDk2OTQ3NEQsIDB4M0U2RTc3REIsIDB4QUVEMTZBNEEsIDB4RDlENjVBREMsIDB4NDBERjBCNjYsCiAgICAgICAweDM3RDgzQkYwLCAweEE5QkNBRTUzLCAweERFQkI5RUM1LCAweDQ3QjJDRjdGLCAweDMwQjVGRkU5LAogICAgICAgMHhCREJERjIxQywgMHhDQUJBQzI4QSwgMHg1M0IzOTMzMCwgMHgyNEI0QTNBNiwgMHhCQUQwMzYwNSwKICAgICAgIDB4Q0RENzA2OTMsIDB4NTRERTU3MjksIDB4MjNEOTY3QkYsIDB4QjM2NjdBMkUsIDB4QzQ2MTRBQjgsCiAgICAgICAweDVENjgxQjAyLCAweDJBNkYyQjk0LCAweEI0MEJCRTM3LCAweEMzMEM4RUExLCAweDVBMDVERjFCLAogICAgICAgMHgyRDAyRUY4RF0sCiAgCiAgICAgIGNyYzMyOiBmdW5jdGlvbiBjcmMzMihkYXRhKSB7CiAgICAgICAgdmFyIHRibCA9IHV0aWwuY3J5cHRvLmNyYzMyVGFibGU7CiAgICAgICAgdmFyIGNyYyA9IDAgXiAtMTsKICAKICAgICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBkYXRhID0gdXRpbC5idWZmZXIudG9CdWZmZXIoZGF0YSk7CiAgICAgICAgfQogIAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGNvZGUgPSBkYXRhLnJlYWRVSW50OChpKTsKICAgICAgICAgIGNyYyA9IChjcmMgPj4+IDgpIF4gdGJsWyhjcmMgXiBjb2RlKSAmIDB4RkZdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gKGNyYyBeIC0xKSA+Pj4gMDsKICAgICAgfSwKICAKICAgICAgaG1hYzogZnVuY3Rpb24gaG1hYyhrZXksIHN0cmluZywgZGlnZXN0LCBmbikgewogICAgICAgIGlmICghZGlnZXN0KSBkaWdlc3QgPSAnYmluYXJ5JzsKICAgICAgICBpZiAoZGlnZXN0ID09PSAnYnVmZmVyJykgeyBkaWdlc3QgPSB1bmRlZmluZWQ7IH0KICAgICAgICBpZiAoIWZuKSBmbiA9ICdzaGEyNTYnOwogICAgICAgIGlmICh0eXBlb2Ygc3RyaW5nID09PSAnc3RyaW5nJykgc3RyaW5nID0gdXRpbC5idWZmZXIudG9CdWZmZXIoc3RyaW5nKTsKICAgICAgICByZXR1cm4gdXRpbC5jcnlwdG8ubGliLmNyZWF0ZUhtYWMoZm4sIGtleSkudXBkYXRlKHN0cmluZykuZGlnZXN0KGRpZ2VzdCk7CiAgICAgIH0sCiAgCiAgICAgIG1kNTogZnVuY3Rpb24gbWQ1KGRhdGEsIGRpZ2VzdCwgY2FsbGJhY2spIHsKICAgICAgICByZXR1cm4gdXRpbC5jcnlwdG8uaGFzaCgnbWQ1JywgZGF0YSwgZGlnZXN0LCBjYWxsYmFjayk7CiAgICAgIH0sCiAgCiAgICAgIHNoYTI1NjogZnVuY3Rpb24gc2hhMjU2KGRhdGEsIGRpZ2VzdCwgY2FsbGJhY2spIHsKICAgICAgICByZXR1cm4gdXRpbC5jcnlwdG8uaGFzaCgnc2hhMjU2JywgZGF0YSwgZGlnZXN0LCBjYWxsYmFjayk7CiAgICAgIH0sCiAgCiAgICAgIGhhc2g6IGZ1bmN0aW9uKGFsZ29yaXRobSwgZGF0YSwgZGlnZXN0LCBjYWxsYmFjaykgewogICAgICAgIHZhciBoYXNoID0gdXRpbC5jcnlwdG8uY3JlYXRlSGFzaChhbGdvcml0aG0pOwogICAgICAgIGlmICghZGlnZXN0KSB7IGRpZ2VzdCA9ICdiaW5hcnknOyB9CiAgICAgICAgaWYgKGRpZ2VzdCA9PT0gJ2J1ZmZlcicpIHsgZGlnZXN0ID0gdW5kZWZpbmVkOyB9CiAgICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgZGF0YSA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyKGRhdGEpOwogICAgICAgIHZhciBzbGljZUZuID0gdXRpbC5hcnJheVNsaWNlRm4oZGF0YSk7CiAgICAgICAgdmFyIGlzQnVmZmVyID0gdXRpbC5CdWZmZXIuaXNCdWZmZXIoZGF0YSk7CiAgICAgICAgLy9JZGVudGlmeWluZyBvYmplY3RzIHdpdGggYW4gQXJyYXlCdWZmZXIgYXMgYnVmZmVycwogICAgICAgIGlmICh1dGlsLmlzQnJvd3NlcigpICYmIHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gJ3VuZGVmaW5lZCcgJiYgZGF0YSAmJiBkYXRhLmJ1ZmZlciBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSBpc0J1ZmZlciA9IHRydWU7CiAgCiAgICAgICAgaWYgKGNhbGxiYWNrICYmIHR5cGVvZiBkYXRhID09PSAnb2JqZWN0JyAmJgogICAgICAgICAgICB0eXBlb2YgZGF0YS5vbiA9PT0gJ2Z1bmN0aW9uJyAmJiAhaXNCdWZmZXIpIHsKICAgICAgICAgIGRhdGEub24oJ2RhdGEnLCBmdW5jdGlvbihjaHVuaykgeyBoYXNoLnVwZGF0ZShjaHVuayk7IH0pOwogICAgICAgICAgZGF0YS5vbignZXJyb3InLCBmdW5jdGlvbihlcnIpIHsgY2FsbGJhY2soZXJyKTsgfSk7CiAgICAgICAgICBkYXRhLm9uKCdlbmQnLCBmdW5jdGlvbigpIHsgY2FsbGJhY2sobnVsbCwgaGFzaC5kaWdlc3QoZGlnZXN0KSk7IH0pOwogICAgICAgIH0gZWxzZSBpZiAoY2FsbGJhY2sgJiYgc2xpY2VGbiAmJiAhaXNCdWZmZXIgJiYKICAgICAgICAgICAgICAgICAgIHR5cGVvZiBGaWxlUmVhZGVyICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgLy8gdGhpcyBtaWdodCBiZSBhIEZpbGUvQmxvYgogICAgICAgICAgdmFyIGluZGV4ID0gMCwgc2l6ZSA9IDEwMjQgKiA1MTI7CiAgICAgICAgICB2YXIgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTsKICAgICAgICAgIHJlYWRlci5vbmVycm9yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcignRmFpbGVkIHRvIHJlYWQgZGF0YS4nKSk7CiAgICAgICAgICB9OwogICAgICAgICAgcmVhZGVyLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYnVmID0gbmV3IHV0aWwuQnVmZmVyKG5ldyBVaW50OEFycmF5KHJlYWRlci5yZXN1bHQpKTsKICAgICAgICAgICAgaGFzaC51cGRhdGUoYnVmKTsKICAgICAgICAgICAgaW5kZXggKz0gYnVmLmxlbmd0aDsKICAgICAgICAgICAgcmVhZGVyLl9jb250aW51ZVJlYWRpbmcoKTsKICAgICAgICAgIH07CiAgICAgICAgICByZWFkZXIuX2NvbnRpbnVlUmVhZGluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoaW5kZXggPj0gZGF0YS5zaXplKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgaGFzaC5kaWdlc3QoZGlnZXN0KSk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgCiAgICAgICAgICAgIHZhciBiYWNrID0gaW5kZXggKyBzaXplOwogICAgICAgICAgICBpZiAoYmFjayA+IGRhdGEuc2l6ZSkgYmFjayA9IGRhdGEuc2l6ZTsKICAgICAgICAgICAgcmVhZGVyLnJlYWRBc0FycmF5QnVmZmVyKHNsaWNlRm4uY2FsbChkYXRhLCBpbmRleCwgYmFjaykpOwogICAgICAgICAgfTsKICAKICAgICAgICAgIHJlYWRlci5fY29udGludWVSZWFkaW5nKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICh1dGlsLmlzQnJvd3NlcigpICYmIHR5cGVvZiBkYXRhID09PSAnb2JqZWN0JyAmJiAhaXNCdWZmZXIpIHsKICAgICAgICAgICAgZGF0YSA9IG5ldyB1dGlsLkJ1ZmZlcihuZXcgVWludDhBcnJheShkYXRhKSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgb3V0ID0gaGFzaC51cGRhdGUoZGF0YSkuZGlnZXN0KGRpZ2VzdCk7CiAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKG51bGwsIG91dCk7CiAgICAgICAgICByZXR1cm4gb3V0OwogICAgICAgIH0KICAgICAgfSwKICAKICAgICAgdG9IZXg6IGZ1bmN0aW9uIHRvSGV4KGRhdGEpIHsKICAgICAgICB2YXIgb3V0ID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBvdXQucHVzaCgoJzAnICsgZGF0YS5jaGFyQ29kZUF0KGkpLnRvU3RyaW5nKDE2KSkuc3Vic3RyKC0yLCAyKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvdXQuam9pbignJyk7CiAgICAgIH0sCiAgCiAgICAgIGNyZWF0ZUhhc2g6IGZ1bmN0aW9uIGNyZWF0ZUhhc2goYWxnb3JpdGhtKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuY3J5cHRvLmxpYi5jcmVhdGVIYXNoKGFsZ29yaXRobSk7CiAgICAgIH0KICAKICAgIH0sCiAgCiAgICAvKiogQCFpZ25vcmUgKi8KICAKICAgIC8qIEFib3J0IGNvbnN0YW50ICovCiAgICBhYm9ydDoge30sCiAgCiAgICBlYWNoOiBmdW5jdGlvbiBlYWNoKG9iamVjdCwgaXRlckZ1bmN0aW9uKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSkgewogICAgICAgICAgdmFyIHJldCA9IGl0ZXJGdW5jdGlvbi5jYWxsKHRoaXMsIGtleSwgb2JqZWN0W2tleV0pOwogICAgICAgICAgaWYgKHJldCA9PT0gdXRpbC5hYm9ydCkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgYXJyYXlFYWNoOiBmdW5jdGlvbiBhcnJheUVhY2goYXJyYXksIGl0ZXJGdW5jdGlvbikgewogICAgICBmb3IgKHZhciBpZHggaW4gYXJyYXkpIHsKICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGFycmF5LCBpZHgpKSB7CiAgICAgICAgICB2YXIgcmV0ID0gaXRlckZ1bmN0aW9uLmNhbGwodGhpcywgYXJyYXlbaWR4XSwgcGFyc2VJbnQoaWR4LCAxMCkpOwogICAgICAgICAgaWYgKHJldCA9PT0gdXRpbC5hYm9ydCkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgdXBkYXRlOiBmdW5jdGlvbiB1cGRhdGUob2JqMSwgb2JqMikgewogICAgICB1dGlsLmVhY2gob2JqMiwgZnVuY3Rpb24gaXRlcmF0b3Ioa2V5LCBpdGVtKSB7CiAgICAgICAgb2JqMVtrZXldID0gaXRlbTsKICAgICAgfSk7CiAgICAgIHJldHVybiBvYmoxOwogICAgfSwKICAKICAgIG1lcmdlOiBmdW5jdGlvbiBtZXJnZShvYmoxLCBvYmoyKSB7CiAgICAgIHJldHVybiB1dGlsLnVwZGF0ZSh1dGlsLmNvcHkob2JqMSksIG9iajIpOwogICAgfSwKICAKICAgIGNvcHk6IGZ1bmN0aW9uIGNvcHkob2JqZWN0KSB7CiAgICAgIGlmIChvYmplY3QgPT09IG51bGwgfHwgb2JqZWN0ID09PSB1bmRlZmluZWQpIHJldHVybiBvYmplY3Q7CiAgICAgIHZhciBkdXBlID0ge307CiAgICAgIC8vIGpzaGludCBmb3JpbjpmYWxzZQogICAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSB7CiAgICAgICAgZHVwZVtrZXldID0gb2JqZWN0W2tleV07CiAgICAgIH0KICAgICAgcmV0dXJuIGR1cGU7CiAgICB9LAogIAogICAgaXNFbXB0eTogZnVuY3Rpb24gaXNFbXB0eShvYmopIHsKICAgICAgZm9yICh2YXIgcHJvcCBpbiBvYmopIHsKICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogIAogICAgYXJyYXlTbGljZUZuOiBmdW5jdGlvbiBhcnJheVNsaWNlRm4ob2JqKSB7CiAgICAgIHZhciBmbiA9IG9iai5zbGljZSB8fCBvYmoud2Via2l0U2xpY2UgfHwgb2JqLm1velNsaWNlOwogICAgICByZXR1cm4gdHlwZW9mIGZuID09PSAnZnVuY3Rpb24nID8gZm4gOiBudWxsOwogICAgfSwKICAKICAgIGlzVHlwZTogZnVuY3Rpb24gaXNUeXBlKG9iaiwgdHlwZSkgewogICAgICAvLyBoYW5kbGUgY3Jvc3MtImZyYW1lIiBvYmplY3RzCiAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gJ2Z1bmN0aW9uJykgdHlwZSA9IHV0aWwudHlwZU5hbWUodHlwZSk7CiAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgJyArIHR5cGUgKyAnXSc7CiAgICB9LAogIAogICAgdHlwZU5hbWU6IGZ1bmN0aW9uIHR5cGVOYW1lKHR5cGUpIHsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0eXBlLCAnbmFtZScpKSByZXR1cm4gdHlwZS5uYW1lOwogICAgICB2YXIgc3RyID0gdHlwZS50b1N0cmluZygpOwogICAgICB2YXIgbWF0Y2ggPSBzdHIubWF0Y2goL15ccypmdW5jdGlvbiAoLispXCgvKTsKICAgICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiBzdHI7CiAgICB9LAogIAogICAgZXJyb3I6IGZ1bmN0aW9uIGVycm9yKGVyciwgb3B0aW9ucykgewogICAgICB2YXIgb3JpZ2luYWxFcnJvciA9IG51bGw7CiAgICAgIGlmICh0eXBlb2YgZXJyLm1lc3NhZ2UgPT09ICdzdHJpbmcnICYmIGVyci5tZXNzYWdlICE9PSAnJykgewogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycgfHwgKG9wdGlvbnMgJiYgb3B0aW9ucy5tZXNzYWdlKSkgewogICAgICAgICAgb3JpZ2luYWxFcnJvciA9IHV0aWwuY29weShlcnIpOwogICAgICAgICAgb3JpZ2luYWxFcnJvci5tZXNzYWdlID0gZXJyLm1lc3NhZ2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIGVyci5tZXNzYWdlID0gZXJyLm1lc3NhZ2UgfHwgbnVsbDsKICAKICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJykgewogICAgICAgIGVyci5tZXNzYWdlID0gb3B0aW9uczsKICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ29iamVjdCcgJiYgb3B0aW9ucyAhPT0gbnVsbCkgewogICAgICAgIHV0aWwudXBkYXRlKGVyciwgb3B0aW9ucyk7CiAgICAgICAgaWYgKG9wdGlvbnMubWVzc2FnZSkKICAgICAgICAgIGVyci5tZXNzYWdlID0gb3B0aW9ucy5tZXNzYWdlOwogICAgICAgIGlmIChvcHRpb25zLmNvZGUgfHwgb3B0aW9ucy5uYW1lKQogICAgICAgICAgZXJyLmNvZGUgPSBvcHRpb25zLmNvZGUgfHwgb3B0aW9ucy5uYW1lOwogICAgICAgIGlmIChvcHRpb25zLnN0YWNrKQogICAgICAgICAgZXJyLnN0YWNrID0gb3B0aW9ucy5zdGFjazsKICAgICAgfQogIAogICAgICBpZiAodHlwZW9mIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlcnIsICduYW1lJywge3dyaXRhYmxlOiB0cnVlLCBlbnVtZXJhYmxlOiBmYWxzZX0pOwogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlcnIsICdtZXNzYWdlJywge2VudW1lcmFibGU6IHRydWV9KTsKICAgICAgfQogIAogICAgICBlcnIubmFtZSA9IG9wdGlvbnMgJiYgb3B0aW9ucy5uYW1lIHx8IGVyci5uYW1lIHx8IGVyci5jb2RlIHx8ICdFcnJvcic7CiAgICAgIGVyci50aW1lID0gbmV3IERhdGUoKTsKICAKICAgICAgaWYgKG9yaWdpbmFsRXJyb3IpIGVyci5vcmlnaW5hbEVycm9yID0gb3JpZ2luYWxFcnJvcjsKICAKICAgICAgcmV0dXJuIGVycjsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBpbmhlcml0OiBmdW5jdGlvbiBpbmhlcml0KGtsYXNzLCBmZWF0dXJlcykgewogICAgICB2YXIgbmV3T2JqZWN0ID0gbnVsbDsKICAgICAgaWYgKGZlYXR1cmVzID09PSB1bmRlZmluZWQpIHsKICAgICAgICBmZWF0dXJlcyA9IGtsYXNzOwogICAgICAgIGtsYXNzID0gT2JqZWN0OwogICAgICAgIG5ld09iamVjdCA9IHt9OwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBjdG9yID0gZnVuY3Rpb24gQ29uc3RydWN0b3JXcmFwcGVyKCkge307CiAgICAgICAgY3Rvci5wcm90b3R5cGUgPSBrbGFzcy5wcm90b3R5cGU7CiAgICAgICAgbmV3T2JqZWN0ID0gbmV3IGN0b3IoKTsKICAgICAgfQogIAogICAgICAvLyBjb25zdHJ1Y3RvciBub3Qgc3VwcGxpZWQsIGNyZWF0ZSBwYXNzLXRocm91Z2ggY3RvcgogICAgICBpZiAoZmVhdHVyZXMuY29uc3RydWN0b3IgPT09IE9iamVjdCkgewogICAgICAgIGZlYXR1cmVzLmNvbnN0cnVjdG9yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoa2xhc3MgIT09IE9iamVjdCkgewogICAgICAgICAgICByZXR1cm4ga2xhc3MuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgCiAgICAgIGZlYXR1cmVzLmNvbnN0cnVjdG9yLnByb3RvdHlwZSA9IG5ld09iamVjdDsKICAgICAgdXRpbC51cGRhdGUoZmVhdHVyZXMuY29uc3RydWN0b3IucHJvdG90eXBlLCBmZWF0dXJlcyk7CiAgICAgIGZlYXR1cmVzLmNvbnN0cnVjdG9yLl9fc3VwZXJfXyA9IGtsYXNzOwogICAgICByZXR1cm4gZmVhdHVyZXMuY29uc3RydWN0b3I7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbWl4aW46IGZ1bmN0aW9uIG1peGluKCkgewogICAgICB2YXIga2xhc3MgPSBhcmd1bWVudHNbMF07CiAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgLy8ganNoaW50IGZvcmluOmZhbHNlCiAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBhcmd1bWVudHNbaV0ucHJvdG90eXBlKSB7CiAgICAgICAgICB2YXIgZm4gPSBhcmd1bWVudHNbaV0ucHJvdG90eXBlW3Byb3BdOwogICAgICAgICAgaWYgKHByb3AgIT09ICdjb25zdHJ1Y3RvcicpIHsKICAgICAgICAgICAga2xhc3MucHJvdG90eXBlW3Byb3BdID0gZm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBrbGFzczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBoaWRlUHJvcGVydGllczogZnVuY3Rpb24gaGlkZVByb3BlcnRpZXMob2JqLCBwcm9wcykgewogICAgICBpZiAodHlwZW9mIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSAhPT0gJ2Z1bmN0aW9uJykgcmV0dXJuOwogIAogICAgICB1dGlsLmFycmF5RWFjaChwcm9wcywgZnVuY3Rpb24gKGtleSkgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgewogICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsIHdyaXRhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHByb3BlcnR5OiBmdW5jdGlvbiBwcm9wZXJ0eShvYmosIG5hbWUsIHZhbHVlLCBlbnVtZXJhYmxlLCBpc1ZhbHVlKSB7CiAgICAgIHZhciBvcHRzID0gewogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICBlbnVtZXJhYmxlOiBlbnVtZXJhYmxlICE9PSB1bmRlZmluZWQgPyBlbnVtZXJhYmxlIDogdHJ1ZQogICAgICB9OwogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nICYmICFpc1ZhbHVlKSB7CiAgICAgICAgb3B0cy5nZXQgPSB2YWx1ZTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICBvcHRzLnZhbHVlID0gdmFsdWU7IG9wdHMud3JpdGFibGUgPSB0cnVlOwogICAgICB9CiAgCiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIG5hbWUsIG9wdHMpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIG1lbW9pemVkUHJvcGVydHk6IGZ1bmN0aW9uIG1lbW9pemVkUHJvcGVydHkob2JqLCBuYW1lLCBnZXQsIGVudW1lcmFibGUpIHsKICAgICAgdmFyIGNhY2hlZFZhbHVlID0gbnVsbDsKICAKICAgICAgLy8gYnVpbGQgZW51bWVyYWJsZSBhdHRyaWJ1dGUgZm9yIGVhY2ggdmFsdWUgd2l0aCBsYXp5IGFjY2Vzc29yLgogICAgICB1dGlsLnByb3BlcnR5KG9iaiwgbmFtZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKGNhY2hlZFZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICBjYWNoZWRWYWx1ZSA9IGdldCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY2FjaGVkVmFsdWU7CiAgICAgIH0sIGVudW1lcmFibGUpOwogICAgfSwKICAKICAgIC8qKgogICAgICogVE9ETyBSZW1vdmUgaW4gbWFqb3IgdmVyc2lvbiByZXZpc2lvbgogICAgICogVGhpcyBiYWNrZmlsbCBwb3B1bGF0ZXMgcmVzcG9uc2UgZGF0YSB3aXRob3V0IHRoZQogICAgICogdG9wLWxldmVsIHBheWxvYWQgbmFtZS4KICAgICAqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaG9pc3RQYXlsb2FkTWVtYmVyOiBmdW5jdGlvbiBob2lzdFBheWxvYWRNZW1iZXIocmVzcCkgewogICAgICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogICAgICB2YXIgb3BlcmF0aW9uTmFtZSA9IHJlcS5vcGVyYXRpb247CiAgICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tvcGVyYXRpb25OYW1lXTsKICAgICAgdmFyIG91dHB1dCA9IG9wZXJhdGlvbi5vdXRwdXQ7CiAgICAgIGlmIChvdXRwdXQucGF5bG9hZCAmJiAhb3BlcmF0aW9uLmhhc0V2ZW50T3V0cHV0KSB7CiAgICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBvdXRwdXQubWVtYmVyc1tvdXRwdXQucGF5bG9hZF07CiAgICAgICAgdmFyIHJlc3BvbnNlUGF5bG9hZCA9IHJlc3AuZGF0YVtvdXRwdXQucGF5bG9hZF07CiAgICAgICAgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ3N0cnVjdHVyZScpIHsKICAgICAgICAgIHV0aWwuZWFjaChyZXNwb25zZVBheWxvYWQsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgdXRpbC5wcm9wZXJ0eShyZXNwLmRhdGEsIGtleSwgdmFsdWUsIGZhbHNlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQ29tcHV0ZSBTSEEtMjU2IGNoZWNrc3VtcyBvZiBzdHJlYW1zCiAgICAgKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNvbXB1dGVTaGEyNTY6IGZ1bmN0aW9uIGNvbXB1dGVTaGEyNTYoYm9keSwgZG9uZSkgewogICAgICBpZiAodXRpbC5pc05vZGUoKSkgewogICAgICAgIHZhciBTdHJlYW0gPSB1dGlsLnN0cmVhbS5TdHJlYW07CiAgICAgICAgdmFyIGZzID0gcmVxdWlyZSgnZnMnKTsKICAgICAgICBpZiAodHlwZW9mIFN0cmVhbSA9PT0gJ2Z1bmN0aW9uJyAmJiBib2R5IGluc3RhbmNlb2YgU3RyZWFtKSB7CiAgICAgICAgICBpZiAodHlwZW9mIGJvZHkucGF0aCA9PT0gJ3N0cmluZycpIHsgLy8gYXNzdW1lIGZpbGUgb2JqZWN0CiAgICAgICAgICAgIHZhciBzZXR0aW5ncyA9IHt9OwogICAgICAgICAgICBpZiAodHlwZW9mIGJvZHkuc3RhcnQgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgc2V0dGluZ3Muc3RhcnQgPSBib2R5LnN0YXJ0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgYm9keS5lbmQgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgc2V0dGluZ3MuZW5kID0gYm9keS5lbmQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYm9keSA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0oYm9keS5wYXRoLCBzZXR0aW5ncyk7CiAgICAgICAgICB9IGVsc2UgeyAvLyBUT0RPIHN1cHBvcnQgb3RoZXIgc3RyZWFtIHR5cGVzCiAgICAgICAgICAgIHJldHVybiBkb25lKG5ldyBFcnJvcignTm9uLWZpbGUgc3RyZWFtIG9iamVjdHMgYXJlICcgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ25vdCBzdXBwb3J0ZWQgd2l0aCBTaWdWNCcpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAKICAgICAgdXRpbC5jcnlwdG8uc2hhMjU2KGJvZHksICdoZXgnLCBmdW5jdGlvbihlcnIsIHNoYSkgewogICAgICAgIGlmIChlcnIpIGRvbmUoZXJyKTsKICAgICAgICBlbHNlIGRvbmUobnVsbCwgc2hhKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaXNDbG9ja1NrZXdlZDogZnVuY3Rpb24gaXNDbG9ja1NrZXdlZChzZXJ2ZXJUaW1lKSB7CiAgICAgIGlmIChzZXJ2ZXJUaW1lKSB7CiAgICAgICAgdXRpbC5wcm9wZXJ0eShBV1MuY29uZmlnLCAnaXNDbG9ja1NrZXdlZCcsCiAgICAgICAgICBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHNlcnZlclRpbWUpID49IDMwMDAwMCwgZmFsc2UpOwogICAgICAgIHJldHVybiBBV1MuY29uZmlnLmlzQ2xvY2tTa2V3ZWQ7CiAgICAgIH0KICAgIH0sCiAgCiAgICBhcHBseUNsb2NrT2Zmc2V0OiBmdW5jdGlvbiBhcHBseUNsb2NrT2Zmc2V0KHNlcnZlclRpbWUpIHsKICAgICAgaWYgKHNlcnZlclRpbWUpCiAgICAgICAgQVdTLmNvbmZpZy5zeXN0ZW1DbG9ja09mZnNldCA9IHNlcnZlclRpbWUgLSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBleHRyYWN0UmVxdWVzdElkOiBmdW5jdGlvbiBleHRyYWN0UmVxdWVzdElkKHJlc3ApIHsKICAgICAgdmFyIHJlcXVlc3RJZCA9IHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LXJlcXVlc3QtaWQnXSB8fAogICAgICAgICAgICAgICAgICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16bi1yZXF1ZXN0aWQnXTsKICAKICAgICAgaWYgKCFyZXF1ZXN0SWQgJiYgcmVzcC5kYXRhICYmIHJlc3AuZGF0YS5SZXNwb25zZU1ldGFkYXRhKSB7CiAgICAgICAgcmVxdWVzdElkID0gcmVzcC5kYXRhLlJlc3BvbnNlTWV0YWRhdGEuUmVxdWVzdElkOwogICAgICB9CiAgCiAgICAgIGlmIChyZXF1ZXN0SWQpIHsKICAgICAgICByZXNwLnJlcXVlc3RJZCA9IHJlcXVlc3RJZDsKICAgICAgfQogIAogICAgICBpZiAocmVzcC5lcnJvcikgewogICAgICAgIHJlc3AuZXJyb3IucmVxdWVzdElkID0gcmVxdWVzdElkOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYWRkUHJvbWlzZXM6IGZ1bmN0aW9uIGFkZFByb21pc2VzKGNvbnN0cnVjdG9ycywgUHJvbWlzZURlcGVuZGVuY3kpIHsKICAgICAgdmFyIGRlbGV0ZVByb21pc2VzID0gZmFsc2U7CiAgICAgIGlmIChQcm9taXNlRGVwZW5kZW5jeSA9PT0gdW5kZWZpbmVkICYmIEFXUyAmJiBBV1MuY29uZmlnKSB7CiAgICAgICAgUHJvbWlzZURlcGVuZGVuY3kgPSBBV1MuY29uZmlnLmdldFByb21pc2VzRGVwZW5kZW5jeSgpOwogICAgICB9CiAgICAgIGlmIChQcm9taXNlRGVwZW5kZW5jeSA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiBQcm9taXNlICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIFByb21pc2VEZXBlbmRlbmN5ID0gUHJvbWlzZTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIFByb21pc2VEZXBlbmRlbmN5ICE9PSAnZnVuY3Rpb24nKSBkZWxldGVQcm9taXNlcyA9IHRydWU7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShjb25zdHJ1Y3RvcnMpKSBjb25zdHJ1Y3RvcnMgPSBbY29uc3RydWN0b3JzXTsKICAKICAgICAgZm9yICh2YXIgaW5kID0gMDsgaW5kIDwgY29uc3RydWN0b3JzLmxlbmd0aDsgaW5kKyspIHsKICAgICAgICB2YXIgY29uc3RydWN0b3IgPSBjb25zdHJ1Y3RvcnNbaW5kXTsKICAgICAgICBpZiAoZGVsZXRlUHJvbWlzZXMpIHsKICAgICAgICAgIGlmIChjb25zdHJ1Y3Rvci5kZWxldGVQcm9taXNlc0Zyb21DbGFzcykgewogICAgICAgICAgICBjb25zdHJ1Y3Rvci5kZWxldGVQcm9taXNlc0Zyb21DbGFzcygpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoY29uc3RydWN0b3IuYWRkUHJvbWlzZXNUb0NsYXNzKSB7CiAgICAgICAgICBjb25zdHJ1Y3Rvci5hZGRQcm9taXNlc1RvQ2xhc3MoUHJvbWlzZURlcGVuZGVuY3kpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKiBSZXR1cm4gYSBmdW5jdGlvbiB0aGF0IHdpbGwgcmV0dXJuIGEgcHJvbWlzZSB3aG9zZSBmYXRlIGlzIGRlY2lkZWQgYnkgdGhlCiAgICAgKiBjYWxsYmFjayBiZWhhdmlvciBvZiB0aGUgZ2l2ZW4gbWV0aG9kIHdpdGggYG1ldGhvZE5hbWVgLiBUaGUgbWV0aG9kIHRvIGJlCiAgICAgKiBwcm9taXNpZmllZCBzaG91bGQgY29uZm9ybSB0byBub2RlLmpzIGNvbnZlbnRpb24gb2YgYWNjZXB0aW5nIGEgY2FsbGJhY2sgYXMKICAgICAqIGxhc3QgYXJndW1lbnQgYW5kIGNhbGxpbmcgdGhhdCBjYWxsYmFjayB3aXRoIGVycm9yIGFzIHRoZSBmaXJzdCBhcmd1bWVudAogICAgICogYW5kIHN1Y2Nlc3MgdmFsdWUgb24gdGhlIHNlY29uZCBhcmd1bWVudC4KICAgICAqLwogICAgcHJvbWlzaWZ5TWV0aG9kOiBmdW5jdGlvbiBwcm9taXNpZnlNZXRob2QobWV0aG9kTmFtZSwgUHJvbWlzZURlcGVuZGVuY3kpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIHByb21pc2UoKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2VEZXBlbmRlbmN5KGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgYXJncy5wdXNoKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBzZWxmW21ldGhvZE5hbWVdLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgICAgIH0pOwogICAgICB9OwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGlzRHVhbHN0YWNrQXZhaWxhYmxlOiBmdW5jdGlvbiBpc0R1YWxzdGFja0F2YWlsYWJsZShzZXJ2aWNlKSB7CiAgICAgIGlmICghc2VydmljZSkgcmV0dXJuIGZhbHNlOwogICAgICB2YXIgbWV0YWRhdGEgPSByZXF1aXJlKCcuLi9hcGlzL21ldGFkYXRhLmpzb24nKTsKICAgICAgaWYgKHR5cGVvZiBzZXJ2aWNlICE9PSAnc3RyaW5nJykgc2VydmljZSA9IHNlcnZpY2Uuc2VydmljZUlkZW50aWZpZXI7CiAgICAgIGlmICh0eXBlb2Ygc2VydmljZSAhPT0gJ3N0cmluZycgfHwgIW1ldGFkYXRhLmhhc093blByb3BlcnR5KHNlcnZpY2UpKSByZXR1cm4gZmFsc2U7CiAgICAgIHJldHVybiAhIW1ldGFkYXRhW3NlcnZpY2VdLmR1YWxzdGFja0F2YWlsYWJsZTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjYWxjdWxhdGVSZXRyeURlbGF5OiBmdW5jdGlvbiBjYWxjdWxhdGVSZXRyeURlbGF5KHJldHJ5Q291bnQsIHJldHJ5RGVsYXlPcHRpb25zKSB7CiAgICAgIGlmICghcmV0cnlEZWxheU9wdGlvbnMpIHJldHJ5RGVsYXlPcHRpb25zID0ge307CiAgICAgIHZhciBjdXN0b21CYWNrb2ZmID0gcmV0cnlEZWxheU9wdGlvbnMuY3VzdG9tQmFja29mZiB8fCBudWxsOwogICAgICBpZiAodHlwZW9mIGN1c3RvbUJhY2tvZmYgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm4gY3VzdG9tQmFja29mZihyZXRyeUNvdW50KTsKICAgICAgfQogICAgICB2YXIgYmFzZSA9IHR5cGVvZiByZXRyeURlbGF5T3B0aW9ucy5iYXNlID09PSAnbnVtYmVyJyA/IHJldHJ5RGVsYXlPcHRpb25zLmJhc2UgOiAxMDA7CiAgICAgIHZhciBkZWxheSA9IE1hdGgucmFuZG9tKCkgKiAoTWF0aC5wb3coMiwgcmV0cnlDb3VudCkgKiBiYXNlKTsKICAgICAgcmV0dXJuIGRlbGF5OwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGhhbmRsZVJlcXVlc3RXaXRoUmV0cmllczogZnVuY3Rpb24gaGFuZGxlUmVxdWVzdFdpdGhSZXRyaWVzKGh0dHBSZXF1ZXN0LCBvcHRpb25zLCBjYikgewogICAgICBpZiAoIW9wdGlvbnMpIG9wdGlvbnMgPSB7fTsKICAgICAgdmFyIGh0dHAgPSBBV1MuSHR0cENsaWVudC5nZXRJbnN0YW5jZSgpOwogICAgICB2YXIgaHR0cE9wdGlvbnMgPSBvcHRpb25zLmh0dHBPcHRpb25zIHx8IHt9OwogICAgICB2YXIgcmV0cnlDb3VudCA9IDA7CiAgCiAgICAgIHZhciBlcnJDYWxsYmFjayA9IGZ1bmN0aW9uKGVycikgewogICAgICAgIHZhciBtYXhSZXRyaWVzID0gb3B0aW9ucy5tYXhSZXRyaWVzIHx8IDA7CiAgICAgICAgaWYgKGVyciAmJiBlcnIuY29kZSA9PT0gJ1RpbWVvdXRFcnJvcicpIGVyci5yZXRyeWFibGUgPSB0cnVlOwogICAgICAgIGlmIChlcnIgJiYgZXJyLnJldHJ5YWJsZSAmJiByZXRyeUNvdW50IDwgbWF4UmV0cmllcykgewogICAgICAgICAgcmV0cnlDb3VudCsrOwogICAgICAgICAgdmFyIGRlbGF5ID0gdXRpbC5jYWxjdWxhdGVSZXRyeURlbGF5KHJldHJ5Q291bnQsIG9wdGlvbnMucmV0cnlEZWxheU9wdGlvbnMpOwogICAgICAgICAgc2V0VGltZW91dChzZW5kUmVxdWVzdCwgZGVsYXkgKyAoZXJyLnJldHJ5QWZ0ZXIgfHwgMCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjYihlcnIpOwogICAgICAgIH0KICAgICAgfTsKICAKICAgICAgdmFyIHNlbmRSZXF1ZXN0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGRhdGEgPSAnJzsKICAgICAgICBodHRwLmhhbmRsZVJlcXVlc3QoaHR0cFJlcXVlc3QsIGh0dHBPcHRpb25zLCBmdW5jdGlvbihodHRwUmVzcG9uc2UpIHsKICAgICAgICAgIGh0dHBSZXNwb25zZS5vbignZGF0YScsIGZ1bmN0aW9uKGNodW5rKSB7IGRhdGEgKz0gY2h1bmsudG9TdHJpbmcoKTsgfSk7CiAgICAgICAgICBodHRwUmVzcG9uc2Uub24oJ2VuZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgc3RhdHVzQ29kZSA9IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICAgICAgICBpZiAoc3RhdHVzQ29kZSA8IDMwMCkgewogICAgICAgICAgICAgIGNiKG51bGwsIGRhdGEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciByZXRyeUFmdGVyID0gcGFyc2VJbnQoaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3JldHJ5LWFmdGVyJ10sIDEwKSAqIDEwMDAgfHwgMDsKICAgICAgICAgICAgICB2YXIgZXJyID0gdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgICAgICAgIHsgcmV0cnlhYmxlOiBzdGF0dXNDb2RlID49IDUwMCB8fCBzdGF0dXNDb2RlID09PSA0MjkgfQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKHJldHJ5QWZ0ZXIgJiYgZXJyLnJldHJ5YWJsZSkgZXJyLnJldHJ5QWZ0ZXIgPSByZXRyeUFmdGVyOwogICAgICAgICAgICAgIGVyckNhbGxiYWNrKGVycik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0sIGVyckNhbGxiYWNrKTsKICAgICAgfTsKICAKICAgICAgQVdTLnV0aWwuZGVmZXIoc2VuZFJlcXVlc3QpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHV1aWQ6IHsKICAgICAgdjQ6IGZ1bmN0aW9uIHV1aWRWNCgpIHsKICAgICAgICByZXR1cm4gcmVxdWlyZSgndXVpZCcpLnY0KCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjb252ZXJ0UGF5bG9hZFRvU3RyaW5nOiBmdW5jdGlvbiBjb252ZXJ0UGF5bG9hZFRvU3RyaW5nKHJlc3ApIHsKICAgICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5vcGVyYXRpb247CiAgICAgIHZhciBydWxlcyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW29wZXJhdGlvbl0ub3V0cHV0IHx8IHt9OwogICAgICBpZiAocnVsZXMucGF5bG9hZCAmJiByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0pIHsKICAgICAgICByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0gPSByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0udG9TdHJpbmcoKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGRlZmVyOiBmdW5jdGlvbiBkZWZlcihjYWxsYmFjaykgewogICAgICBpZiAodHlwZW9mIHByb2Nlc3MgPT09ICdvYmplY3QnICYmIHR5cGVvZiBwcm9jZXNzLm5leHRUaWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhjYWxsYmFjayk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHNldEltbWVkaWF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHNldEltbWVkaWF0ZShjYWxsYmFjayk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0VGltZW91dChjYWxsYmFjaywgMCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRSZXF1ZXN0UGF5bG9hZFNoYXBlOiBmdW5jdGlvbiBnZXRSZXF1ZXN0UGF5bG9hZFNoYXBlKHJlcSkgewogICAgICB2YXIgb3BlcmF0aW9ucyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zOwogICAgICBpZiAoIW9wZXJhdGlvbnMpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIHZhciBvcGVyYXRpb24gPSAob3BlcmF0aW9ucyB8fCB7fSlbcmVxLm9wZXJhdGlvbl07CiAgICAgIGlmICghb3BlcmF0aW9uIHx8ICFvcGVyYXRpb24uaW5wdXQgfHwgIW9wZXJhdGlvbi5pbnB1dC5wYXlsb2FkKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICByZXR1cm4gb3BlcmF0aW9uLmlucHV0Lm1lbWJlcnNbb3BlcmF0aW9uLmlucHV0LnBheWxvYWRdOwogICAgfSwKICAKICAgIGdldFByb2ZpbGVzRnJvbVNoYXJlZENvbmZpZzogZnVuY3Rpb24gZ2V0UHJvZmlsZXNGcm9tU2hhcmVkQ29uZmlnKGluaUxvYWRlciwgZmlsZW5hbWUpIHsKICAgICAgdmFyIHByb2ZpbGVzID0ge307CiAgICAgIHZhciBwcm9maWxlc0Zyb21Db25maWcgPSB7fTsKICAgICAgaWYgKHByb2Nlc3MuZW52W3V0aWwuY29uZmlnT3B0SW5FbnZdKSB7CiAgICAgICAgdmFyIHByb2ZpbGVzRnJvbUNvbmZpZyA9IGluaUxvYWRlci5sb2FkRnJvbSh7CiAgICAgICAgICBpc0NvbmZpZzogdHJ1ZSwKICAgICAgICAgIGZpbGVuYW1lOiBwcm9jZXNzLmVudlt1dGlsLnNoYXJlZENvbmZpZ0ZpbGVFbnZdCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgdmFyIHByb2ZpbGVzRnJvbUNyZWRzID0gaW5pTG9hZGVyLmxvYWRGcm9tKHsKICAgICAgICBmaWxlbmFtZTogZmlsZW5hbWUgfHwKICAgICAgICAgIChwcm9jZXNzLmVudlt1dGlsLmNvbmZpZ09wdEluRW52XSAmJiBwcm9jZXNzLmVudlt1dGlsLnNoYXJlZENyZWRlbnRpYWxzRmlsZUVudl0pCiAgICAgIH0pOwogICAgICBmb3IgKHZhciBpID0gMCwgcHJvZmlsZU5hbWVzID0gT2JqZWN0LmtleXMocHJvZmlsZXNGcm9tQ29uZmlnKTsgaSA8IHByb2ZpbGVOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgIHByb2ZpbGVzW3Byb2ZpbGVOYW1lc1tpXV0gPSBwcm9maWxlc0Zyb21Db25maWdbcHJvZmlsZU5hbWVzW2ldXTsKICAgICAgfQogICAgICBmb3IgKHZhciBpID0gMCwgcHJvZmlsZU5hbWVzID0gT2JqZWN0LmtleXMocHJvZmlsZXNGcm9tQ3JlZHMpOyBpIDwgcHJvZmlsZU5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcHJvZmlsZXNbcHJvZmlsZU5hbWVzW2ldXSA9IHByb2ZpbGVzRnJvbUNyZWRzW3Byb2ZpbGVOYW1lc1tpXV07CiAgICAgIH0KICAgICAgcmV0dXJuIHByb2ZpbGVzOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGRlZmF1bHRQcm9maWxlOiAnZGVmYXVsdCcsCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjb25maWdPcHRJbkVudjogJ0FXU19TREtfTE9BRF9DT05GSUcnLAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc2hhcmVkQ3JlZGVudGlhbHNGaWxlRW52OiAnQVdTX1NIQVJFRF9DUkVERU5USUFMU19GSUxFJywKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNoYXJlZENvbmZpZ0ZpbGVFbnY6ICdBV1NfQ09ORklHX0ZJTEUnLAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaW1kc0Rpc2FibGVkRW52OiAnQVdTX0VDMl9NRVRBREFUQV9ESVNBQkxFRCcKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gdXRpbDsKICAKICB9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykscmVxdWlyZSgidGltZXJzIikuc2V0SW1tZWRpYXRlKQogIH0seyIuLi9hcGlzL21ldGFkYXRhLmpzb24iOjQsIi4vY29yZSI6MTgsIl9wcm9jZXNzIjo4NiwiZnMiOjc5LCJ0aW1lcnMiOjkzLCJ1dWlkIjo5OH1dLDcyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgU2hhcGUgPSByZXF1aXJlKCcuLi9tb2RlbC9zaGFwZScpOwogIAogIGZ1bmN0aW9uIERvbVhtbFBhcnNlcigpIHsgfQogIAogIERvbVhtbFBhcnNlci5wcm90b3R5cGUucGFyc2UgPSBmdW5jdGlvbih4bWwsIHNoYXBlKSB7CiAgICBpZiAoeG1sLnJlcGxhY2UoL15ccysvLCAnJykgPT09ICcnKSByZXR1cm4ge307CiAgCiAgICB2YXIgcmVzdWx0LCBlcnJvcjsKICAgIHRyeSB7CiAgICAgIGlmICh3aW5kb3cuRE9NUGFyc2VyKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBwYXJzZXIgPSBuZXcgRE9NUGFyc2VyKCk7CiAgICAgICAgICByZXN1bHQgPSBwYXJzZXIucGFyc2VGcm9tU3RyaW5nKHhtbCwgJ3RleHQveG1sJyk7CiAgICAgICAgfSBjYXRjaCAoc3ludGF4RXJyb3IpIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdQYXJzZSBlcnJvciBpbiBkb2N1bWVudCcpLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgb3JpZ2luYWxFcnJvcjogc3ludGF4RXJyb3IsCiAgICAgICAgICAgICAgY29kZTogJ1hNTFBhcnNlckVycm9yJywKICAgICAgICAgICAgICByZXRyeWFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogIAogICAgICAgIGlmIChyZXN1bHQuZG9jdW1lbnRFbGVtZW50ID09PSBudWxsKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignQ2Fubm90IHBhcnNlIGVtcHR5IGRvY3VtZW50LicpLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29kZTogJ1hNTFBhcnNlckVycm9yJywKICAgICAgICAgICAgICByZXRyeWFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogIAogICAgICAgIHZhciBpc0Vycm9yID0gcmVzdWx0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdwYXJzZXJlcnJvcicpWzBdOwogICAgICAgIGlmIChpc0Vycm9yICYmIChpc0Vycm9yLnBhcmVudE5vZGUgPT09IHJlc3VsdCB8fAogICAgICAgICAgICBpc0Vycm9yLnBhcmVudE5vZGUubm9kZU5hbWUgPT09ICdib2R5JyB8fAogICAgICAgICAgICBpc0Vycm9yLnBhcmVudE5vZGUucGFyZW50Tm9kZSA9PT0gcmVzdWx0IHx8CiAgICAgICAgICAgIGlzRXJyb3IucGFyZW50Tm9kZS5wYXJlbnROb2RlLm5vZGVOYW1lID09PSAnYm9keScpKSB7CiAgICAgICAgICB2YXIgZXJyb3JFbGVtZW50ID0gaXNFcnJvci5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZGl2JylbMF0gfHwgaXNFcnJvcjsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKGVycm9yRWxlbWVudC50ZXh0Q29udGVudCB8fCAnUGFyc2VyIGVycm9yIGluIGRvY3VtZW50JyksCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjb2RlOiAnWE1MUGFyc2VyRXJyb3InLAogICAgICAgICAgICAgIHJldHJ5YWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAod2luZG93LkFjdGl2ZVhPYmplY3QpIHsKICAgICAgICByZXN1bHQgPSBuZXcgd2luZG93LkFjdGl2ZVhPYmplY3QoJ01pY3Jvc29mdC5YTUxET00nKTsKICAgICAgICByZXN1bHQuYXN5bmMgPSBmYWxzZTsKICAKICAgICAgICBpZiAoIXJlc3VsdC5sb2FkWE1MKHhtbCkpIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdQYXJzZSBlcnJvciBpbiBkb2N1bWVudCcpLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29kZTogJ1hNTFBhcnNlckVycm9yJywKICAgICAgICAgICAgICByZXRyeWFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGxvYWQgWE1MIHBhcnNlcicpOwogICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGVycm9yID0gZTsKICAgIH0KICAKICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0LmRvY3VtZW50RWxlbWVudCAmJiAhZXJyb3IpIHsKICAgICAgdmFyIGRhdGEgPSBwYXJzZVhtbChyZXN1bHQuZG9jdW1lbnRFbGVtZW50LCBzaGFwZSk7CiAgICAgIHZhciBtZXRhZGF0YSA9IGdldEVsZW1lbnRCeVRhZ05hbWUocmVzdWx0LmRvY3VtZW50RWxlbWVudCwgJ1Jlc3BvbnNlTWV0YWRhdGEnKTsKICAgICAgaWYgKG1ldGFkYXRhKSB7CiAgICAgICAgZGF0YS5SZXNwb25zZU1ldGFkYXRhID0gcGFyc2VYbWwobWV0YWRhdGEsIHt9KTsKICAgICAgfQogICAgICByZXR1cm4gZGF0YTsKICAgIH0gZWxzZSBpZiAoZXJyb3IpIHsKICAgICAgdGhyb3cgdXRpbC5lcnJvcihlcnJvciB8fCBuZXcgRXJyb3IoKSwge2NvZGU6ICdYTUxQYXJzZXJFcnJvcicsIHJldHJ5YWJsZTogdHJ1ZX0pOwogICAgfSBlbHNlIHsgLy8gZW1wdHkgeG1sIGRvY3VtZW50CiAgICAgIHJldHVybiB7fTsKICAgIH0KICB9OwogIAogIGZ1bmN0aW9uIGdldEVsZW1lbnRCeVRhZ05hbWUoeG1sLCB0YWcpIHsKICAgIHZhciBlbGVtZW50cyA9IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpOwogICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBlbGVtZW50cy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgaWYgKGVsZW1lbnRzW2ldLnBhcmVudE5vZGUgPT09IHhtbCkgewogICAgICAgIHJldHVybiBlbGVtZW50c1tpXTsKICAgICAgfQogICAgfQogIH0KICAKICBmdW5jdGlvbiBwYXJzZVhtbCh4bWwsIHNoYXBlKSB7CiAgICBpZiAoIXNoYXBlKSBzaGFwZSA9IHt9OwogICAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICAgIGNhc2UgJ3N0cnVjdHVyZSc6IHJldHVybiBwYXJzZVN0cnVjdHVyZSh4bWwsIHNoYXBlKTsKICAgICAgY2FzZSAnbWFwJzogcmV0dXJuIHBhcnNlTWFwKHhtbCwgc2hhcGUpOwogICAgICBjYXNlICdsaXN0JzogcmV0dXJuIHBhcnNlTGlzdCh4bWwsIHNoYXBlKTsKICAgICAgY2FzZSB1bmRlZmluZWQ6IGNhc2UgbnVsbDogcmV0dXJuIHBhcnNlVW5rbm93bih4bWwpOwogICAgICBkZWZhdWx0OiByZXR1cm4gcGFyc2VTY2FsYXIoeG1sLCBzaGFwZSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIHBhcnNlU3RydWN0dXJlKHhtbCwgc2hhcGUpIHsKICAgIHZhciBkYXRhID0ge307CiAgICBpZiAoeG1sID09PSBudWxsKSByZXR1cm4gZGF0YTsKICAKICAgIHV0aWwuZWFjaChzaGFwZS5tZW1iZXJzLCBmdW5jdGlvbihtZW1iZXJOYW1lLCBtZW1iZXJTaGFwZSkgewogICAgICBpZiAobWVtYmVyU2hhcGUuaXNYbWxBdHRyaWJ1dGUpIHsKICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHhtbC5hdHRyaWJ1dGVzLCBtZW1iZXJTaGFwZS5uYW1lKSkgewogICAgICAgICAgdmFyIHZhbHVlID0geG1sLmF0dHJpYnV0ZXNbbWVtYmVyU2hhcGUubmFtZV0udmFsdWU7CiAgICAgICAgICBkYXRhW21lbWJlck5hbWVdID0gcGFyc2VYbWwoe3RleHRDb250ZW50OiB2YWx1ZX0sIG1lbWJlclNoYXBlKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHhtbENoaWxkID0gbWVtYmVyU2hhcGUuZmxhdHRlbmVkID8geG1sIDoKICAgICAgICAgIGdldEVsZW1lbnRCeVRhZ05hbWUoeG1sLCBtZW1iZXJTaGFwZS5uYW1lKTsKICAgICAgICBpZiAoeG1sQ2hpbGQpIHsKICAgICAgICAgIGRhdGFbbWVtYmVyTmFtZV0gPSBwYXJzZVhtbCh4bWxDaGlsZCwgbWVtYmVyU2hhcGUpOwogICAgICAgIH0gZWxzZSBpZiAoIW1lbWJlclNoYXBlLmZsYXR0ZW5lZCAmJiBtZW1iZXJTaGFwZS50eXBlID09PSAnbGlzdCcpIHsKICAgICAgICAgIGRhdGFbbWVtYmVyTmFtZV0gPSBtZW1iZXJTaGFwZS5kZWZhdWx0VmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAKICAgIHJldHVybiBkYXRhOwogIH0KICAKICBmdW5jdGlvbiBwYXJzZU1hcCh4bWwsIHNoYXBlKSB7CiAgICB2YXIgZGF0YSA9IHt9OwogICAgdmFyIHhtbEtleSA9IHNoYXBlLmtleS5uYW1lIHx8ICdrZXknOwogICAgdmFyIHhtbFZhbHVlID0gc2hhcGUudmFsdWUubmFtZSB8fCAndmFsdWUnOwogICAgdmFyIHRhZ05hbWUgPSBzaGFwZS5mbGF0dGVuZWQgPyBzaGFwZS5uYW1lIDogJ2VudHJ5JzsKICAKICAgIHZhciBjaGlsZCA9IHhtbC5maXJzdEVsZW1lbnRDaGlsZDsKICAgIHdoaWxlIChjaGlsZCkgewogICAgICBpZiAoY2hpbGQubm9kZU5hbWUgPT09IHRhZ05hbWUpIHsKICAgICAgICB2YXIga2V5ID0gZ2V0RWxlbWVudEJ5VGFnTmFtZShjaGlsZCwgeG1sS2V5KS50ZXh0Q29udGVudDsKICAgICAgICB2YXIgdmFsdWUgPSBnZXRFbGVtZW50QnlUYWdOYW1lKGNoaWxkLCB4bWxWYWx1ZSk7CiAgICAgICAgZGF0YVtrZXldID0gcGFyc2VYbWwodmFsdWUsIHNoYXBlLnZhbHVlKTsKICAgICAgfQogICAgICBjaGlsZCA9IGNoaWxkLm5leHRFbGVtZW50U2libGluZzsKICAgIH0KICAgIHJldHVybiBkYXRhOwogIH0KICAKICBmdW5jdGlvbiBwYXJzZUxpc3QoeG1sLCBzaGFwZSkgewogICAgdmFyIGRhdGEgPSBbXTsKICAgIHZhciB0YWdOYW1lID0gc2hhcGUuZmxhdHRlbmVkID8gc2hhcGUubmFtZSA6IChzaGFwZS5tZW1iZXIubmFtZSB8fCAnbWVtYmVyJyk7CiAgCiAgICB2YXIgY2hpbGQgPSB4bWwuZmlyc3RFbGVtZW50Q2hpbGQ7CiAgICB3aGlsZSAoY2hpbGQpIHsKICAgICAgaWYgKGNoaWxkLm5vZGVOYW1lID09PSB0YWdOYW1lKSB7CiAgICAgICAgZGF0YS5wdXNoKHBhcnNlWG1sKGNoaWxkLCBzaGFwZS5tZW1iZXIpKTsKICAgICAgfQogICAgICBjaGlsZCA9IGNoaWxkLm5leHRFbGVtZW50U2libGluZzsKICAgIH0KICAgIHJldHVybiBkYXRhOwogIH0KICAKICBmdW5jdGlvbiBwYXJzZVNjYWxhcih4bWwsIHNoYXBlKSB7CiAgICBpZiAoeG1sLmdldEF0dHJpYnV0ZSkgewogICAgICB2YXIgZW5jb2RpbmcgPSB4bWwuZ2V0QXR0cmlidXRlKCdlbmNvZGluZycpOwogICAgICBpZiAoZW5jb2RpbmcgPT09ICdiYXNlNjQnKSB7CiAgICAgICAgc2hhcGUgPSBuZXcgU2hhcGUuY3JlYXRlKHt0eXBlOiBlbmNvZGluZ30pOwogICAgICB9CiAgICB9CiAgCiAgICB2YXIgdGV4dCA9IHhtbC50ZXh0Q29udGVudDsKICAgIGlmICh0ZXh0ID09PSAnJykgdGV4dCA9IG51bGw7CiAgICBpZiAodHlwZW9mIHNoYXBlLnRvVHlwZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICByZXR1cm4gc2hhcGUudG9UeXBlKHRleHQpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIHBhcnNlVW5rbm93bih4bWwpIHsKICAgIGlmICh4bWwgPT09IHVuZGVmaW5lZCB8fCB4bWwgPT09IG51bGwpIHJldHVybiAnJzsKICAKICAgIC8vIGVtcHR5IG9iamVjdAogICAgaWYgKCF4bWwuZmlyc3RFbGVtZW50Q2hpbGQpIHsKICAgICAgaWYgKHhtbC5wYXJlbnROb2RlLnBhcmVudE5vZGUgPT09IG51bGwpIHJldHVybiB7fTsKICAgICAgaWYgKHhtbC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuICcnOwogICAgICBlbHNlIHJldHVybiB4bWwudGV4dENvbnRlbnQ7CiAgICB9CiAgCiAgICAvLyBvYmplY3QsIHBhcnNlIGFzIHN0cnVjdHVyZQogICAgdmFyIHNoYXBlID0ge3R5cGU6ICdzdHJ1Y3R1cmUnLCBtZW1iZXJzOiB7fX07CiAgICB2YXIgY2hpbGQgPSB4bWwuZmlyc3RFbGVtZW50Q2hpbGQ7CiAgICB3aGlsZSAoY2hpbGQpIHsKICAgICAgdmFyIHRhZyA9IGNoaWxkLm5vZGVOYW1lOwogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNoYXBlLm1lbWJlcnMsIHRhZykpIHsKICAgICAgICAvLyBtdWx0aXBsZSB0YWdzIG9mIHRoZSBzYW1lIG5hbWUgbWFrZXMgaXQgYSBsaXN0CiAgICAgICAgc2hhcGUubWVtYmVyc1t0YWddLnR5cGUgPSAnbGlzdCc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2hhcGUubWVtYmVyc1t0YWddID0ge25hbWU6IHRhZ307CiAgICAgIH0KICAgICAgY2hpbGQgPSBjaGlsZC5uZXh0RWxlbWVudFNpYmxpbmc7CiAgICB9CiAgICByZXR1cm4gcGFyc2VTdHJ1Y3R1cmUoeG1sLCBzaGFwZSk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gRG9tWG1sUGFyc2VyOwogIAogIH0seyIuLi9tb2RlbC9zaGFwZSI6NDMsIi4uL3V0aWwiOjcxfV0sNzM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBYbWxOb2RlID0gcmVxdWlyZSgnLi94bWwtbm9kZScpLlhtbE5vZGU7CiAgdmFyIFhtbFRleHQgPSByZXF1aXJlKCcuL3htbC10ZXh0JykuWG1sVGV4dDsKICAKICBmdW5jdGlvbiBYbWxCdWlsZGVyKCkgeyB9CiAgCiAgWG1sQnVpbGRlci5wcm90b3R5cGUudG9YTUwgPSBmdW5jdGlvbihwYXJhbXMsIHNoYXBlLCByb290RWxlbWVudCwgbm9FbXB0eSkgewogICAgdmFyIHhtbCA9IG5ldyBYbWxOb2RlKHJvb3RFbGVtZW50KTsKICAgIGFwcGx5TmFtZXNwYWNlcyh4bWwsIHNoYXBlLCB0cnVlKTsKICAgIHNlcmlhbGl6ZSh4bWwsIHBhcmFtcywgc2hhcGUpOwogICAgcmV0dXJuIHhtbC5jaGlsZHJlbi5sZW5ndGggPiAwIHx8IG5vRW1wdHkgPyB4bWwudG9TdHJpbmcoKSA6ICcnOwogIH07CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplKHhtbCwgdmFsdWUsIHNoYXBlKSB7CiAgICBzd2l0Y2ggKHNoYXBlLnR5cGUpIHsKICAgICAgY2FzZSAnc3RydWN0dXJlJzogcmV0dXJuIHNlcmlhbGl6ZVN0cnVjdHVyZSh4bWwsIHZhbHVlLCBzaGFwZSk7CiAgICAgIGNhc2UgJ21hcCc6IHJldHVybiBzZXJpYWxpemVNYXAoeG1sLCB2YWx1ZSwgc2hhcGUpOwogICAgICBjYXNlICdsaXN0JzogcmV0dXJuIHNlcmlhbGl6ZUxpc3QoeG1sLCB2YWx1ZSwgc2hhcGUpOwogICAgICBkZWZhdWx0OiByZXR1cm4gc2VyaWFsaXplU2NhbGFyKHhtbCwgdmFsdWUsIHNoYXBlKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplU3RydWN0dXJlKHhtbCwgcGFyYW1zLCBzaGFwZSkgewogICAgdXRpbC5hcnJheUVhY2goc2hhcGUubWVtYmVyTmFtZXMsIGZ1bmN0aW9uKG1lbWJlck5hbWUpIHsKICAgICAgdmFyIG1lbWJlclNoYXBlID0gc2hhcGUubWVtYmVyc1ttZW1iZXJOYW1lXTsKICAgICAgaWYgKG1lbWJlclNoYXBlLmxvY2F0aW9uICE9PSAnYm9keScpIHJldHVybjsKICAKICAgICAgdmFyIHZhbHVlID0gcGFyYW1zW21lbWJlck5hbWVdOwogICAgICB2YXIgbmFtZSA9IG1lbWJlclNoYXBlLm5hbWU7CiAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgaWYgKG1lbWJlclNoYXBlLmlzWG1sQXR0cmlidXRlKSB7CiAgICAgICAgICB4bWwuYWRkQXR0cmlidXRlKG5hbWUsIHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKG1lbWJlclNoYXBlLmZsYXR0ZW5lZCkgewogICAgICAgICAgc2VyaWFsaXplKHhtbCwgdmFsdWUsIG1lbWJlclNoYXBlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGVsZW1lbnQgPSBuZXcgWG1sTm9kZShuYW1lKTsKICAgICAgICAgIHhtbC5hZGRDaGlsZE5vZGUoZWxlbWVudCk7CiAgICAgICAgICBhcHBseU5hbWVzcGFjZXMoZWxlbWVudCwgbWVtYmVyU2hhcGUpOwogICAgICAgICAgc2VyaWFsaXplKGVsZW1lbnQsIHZhbHVlLCBtZW1iZXJTaGFwZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplTWFwKHhtbCwgbWFwLCBzaGFwZSkgewogICAgdmFyIHhtbEtleSA9IHNoYXBlLmtleS5uYW1lIHx8ICdrZXknOwogICAgdmFyIHhtbFZhbHVlID0gc2hhcGUudmFsdWUubmFtZSB8fCAndmFsdWUnOwogIAogICAgdXRpbC5lYWNoKG1hcCwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICB2YXIgZW50cnkgPSBuZXcgWG1sTm9kZShzaGFwZS5mbGF0dGVuZWQgPyBzaGFwZS5uYW1lIDogJ2VudHJ5Jyk7CiAgICAgIHhtbC5hZGRDaGlsZE5vZGUoZW50cnkpOwogIAogICAgICB2YXIgZW50cnlLZXkgPSBuZXcgWG1sTm9kZSh4bWxLZXkpOwogICAgICB2YXIgZW50cnlWYWx1ZSA9IG5ldyBYbWxOb2RlKHhtbFZhbHVlKTsKICAgICAgZW50cnkuYWRkQ2hpbGROb2RlKGVudHJ5S2V5KTsKICAgICAgZW50cnkuYWRkQ2hpbGROb2RlKGVudHJ5VmFsdWUpOwogIAogICAgICBzZXJpYWxpemUoZW50cnlLZXksIGtleSwgc2hhcGUua2V5KTsKICAgICAgc2VyaWFsaXplKGVudHJ5VmFsdWUsIHZhbHVlLCBzaGFwZS52YWx1ZSk7CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplTGlzdCh4bWwsIGxpc3QsIHNoYXBlKSB7CiAgICBpZiAoc2hhcGUuZmxhdHRlbmVkKSB7CiAgICAgIHV0aWwuYXJyYXlFYWNoKGxpc3QsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIG5hbWUgPSBzaGFwZS5tZW1iZXIubmFtZSB8fCBzaGFwZS5uYW1lOwogICAgICAgIHZhciBlbGVtZW50ID0gbmV3IFhtbE5vZGUobmFtZSk7CiAgICAgICAgeG1sLmFkZENoaWxkTm9kZShlbGVtZW50KTsKICAgICAgICBzZXJpYWxpemUoZWxlbWVudCwgdmFsdWUsIHNoYXBlLm1lbWJlcik7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgdXRpbC5hcnJheUVhY2gobGlzdCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgbmFtZSA9IHNoYXBlLm1lbWJlci5uYW1lIHx8ICdtZW1iZXInOwogICAgICAgIHZhciBlbGVtZW50ID0gbmV3IFhtbE5vZGUobmFtZSk7CiAgICAgICAgeG1sLmFkZENoaWxkTm9kZShlbGVtZW50KTsKICAgICAgICBzZXJpYWxpemUoZWxlbWVudCwgdmFsdWUsIHNoYXBlLm1lbWJlcik7CiAgICAgIH0pOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVTY2FsYXIoeG1sLCB2YWx1ZSwgc2hhcGUpIHsKICAgIHhtbC5hZGRDaGlsZE5vZGUoCiAgICAgIG5ldyBYbWxUZXh0KHNoYXBlLnRvV2lyZUZvcm1hdCh2YWx1ZSkpCiAgICApOwogIH0KICAKICBmdW5jdGlvbiBhcHBseU5hbWVzcGFjZXMoeG1sLCBzaGFwZSwgaXNSb290KSB7CiAgICB2YXIgdXJpLCBwcmVmaXggPSAneG1sbnMnOwogICAgaWYgKHNoYXBlLnhtbE5hbWVzcGFjZVVyaSkgewogICAgICB1cmkgPSBzaGFwZS54bWxOYW1lc3BhY2VVcmk7CiAgICAgIGlmIChzaGFwZS54bWxOYW1lc3BhY2VQcmVmaXgpIHByZWZpeCArPSAnOicgKyBzaGFwZS54bWxOYW1lc3BhY2VQcmVmaXg7CiAgICB9IGVsc2UgaWYgKGlzUm9vdCAmJiBzaGFwZS5hcGkueG1sTmFtZXNwYWNlVXJpKSB7CiAgICAgIHVyaSA9IHNoYXBlLmFwaS54bWxOYW1lc3BhY2VVcmk7CiAgICB9CiAgCiAgICBpZiAodXJpKSB4bWwuYWRkQXR0cmlidXRlKHByZWZpeCwgdXJpKTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBYbWxCdWlsZGVyOwogIAogIH0seyIuLi91dGlsIjo3MSwiLi94bWwtbm9kZSI6NzYsIi4veG1sLXRleHQiOjc3fV0sNzQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8qKgogICAqIEVzY2FwZXMgY2hhcmFjdGVycyB0aGF0IGNhbiBub3QgYmUgaW4gYW4gWE1MIGF0dHJpYnV0ZS4KICAgKi8KICBmdW5jdGlvbiBlc2NhcGVBdHRyaWJ1dGUodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoLyYvZywgJyZhbXA7JykucmVwbGFjZSgvJy9nLCAnJmFwb3M7JykucmVwbGFjZSgvPC9nLCAnJmx0OycpLnJlcGxhY2UoLz4vZywgJyZndDsnKS5yZXBsYWNlKC8iL2csICcmcXVvdDsnKTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGVzY2FwZUF0dHJpYnV0ZTogZXNjYXBlQXR0cmlidXRlCiAgfTsKICAKICB9LHt9XSw3NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLyoqCiAgICogRXNjYXBlcyBjaGFyYWN0ZXJzIHRoYXQgY2FuIG5vdCBiZSBpbiBhbiBYTUwgZWxlbWVudC4KICAgKi8KICBmdW5jdGlvbiBlc2NhcGVFbGVtZW50KHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZS5yZXBsYWNlKC8mL2csICcmYW1wOycpLnJlcGxhY2UoLzwvZywgJyZsdDsnKS5yZXBsYWNlKC8+L2csICcmZ3Q7Jyk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBlc2NhcGVFbGVtZW50OiBlc2NhcGVFbGVtZW50CiAgfTsKICAKICB9LHt9XSw3NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIGVzY2FwZUF0dHJpYnV0ZSA9IHJlcXVpcmUoJy4vZXNjYXBlLWF0dHJpYnV0ZScpLmVzY2FwZUF0dHJpYnV0ZTsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIGFuIFhNTCBub2RlLgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIFhtbE5vZGUobmFtZSwgY2hpbGRyZW4pIHsKICAgICAgaWYgKGNoaWxkcmVuID09PSB2b2lkIDApIHsgY2hpbGRyZW4gPSBbXTsgfQogICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICB0aGlzLmNoaWxkcmVuID0gY2hpbGRyZW47CiAgICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogIH0KICBYbWxOb2RlLnByb3RvdHlwZS5hZGRBdHRyaWJ1dGUgPSBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgdGhpcy5hdHRyaWJ1dGVzW25hbWVdID0gdmFsdWU7CiAgICAgIHJldHVybiB0aGlzOwogIH07CiAgWG1sTm9kZS5wcm90b3R5cGUuYWRkQ2hpbGROb2RlID0gZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgIHRoaXMuY2hpbGRyZW4ucHVzaChjaGlsZCk7CiAgICAgIHJldHVybiB0aGlzOwogIH07CiAgWG1sTm9kZS5wcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgZGVsZXRlIHRoaXMuYXR0cmlidXRlc1tuYW1lXTsKICAgICAgcmV0dXJuIHRoaXM7CiAgfTsKICBYbWxOb2RlLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGhhc0NoaWxkcmVuID0gQm9vbGVhbih0aGlzLmNoaWxkcmVuLmxlbmd0aCk7CiAgICAgIHZhciB4bWxUZXh0ID0gJzwnICsgdGhpcy5uYW1lOwogICAgICAvLyBhZGQgYXR0cmlidXRlcwogICAgICB2YXIgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlczsKICAgICAgZm9yICh2YXIgaSA9IDAsIGF0dHJpYnV0ZU5hbWVzID0gT2JqZWN0LmtleXMoYXR0cmlidXRlcyk7IGkgPCBhdHRyaWJ1dGVOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGF0dHJpYnV0ZU5hbWUgPSBhdHRyaWJ1dGVOYW1lc1tpXTsKICAgICAgICAgIHZhciBhdHRyaWJ1dGUgPSBhdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdOwogICAgICAgICAgaWYgKHR5cGVvZiBhdHRyaWJ1dGUgIT09ICd1bmRlZmluZWQnICYmIGF0dHJpYnV0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHhtbFRleHQgKz0gJyAnICsgYXR0cmlidXRlTmFtZSArICc9XCInICsgZXNjYXBlQXR0cmlidXRlKCcnICsgYXR0cmlidXRlKSArICdcIic7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHhtbFRleHQgKz0gIWhhc0NoaWxkcmVuID8gJy8+JyA6ICc+JyArIHRoaXMuY2hpbGRyZW4ubWFwKGZ1bmN0aW9uIChjKSB7IHJldHVybiBjLnRvU3RyaW5nKCk7IH0pLmpvaW4oJycpICsgJzwvJyArIHRoaXMubmFtZSArICc+JzsKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBYbWxOb2RlOiBYbWxOb2RlCiAgfTsKICAKICB9LHsiLi9lc2NhcGUtYXR0cmlidXRlIjo3NH1dLDc3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgZXNjYXBlRWxlbWVudCA9IHJlcXVpcmUoJy4vZXNjYXBlLWVsZW1lbnQnKS5lc2NhcGVFbGVtZW50OwogIAogIC8qKgogICAqIFJlcHJlc2VudHMgYW4gWE1MIHRleHQgdmFsdWUuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gWG1sVGV4dCh2YWx1ZSkgewogICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgfQogIAogIFhtbFRleHQucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gZXNjYXBlRWxlbWVudCgnJyArIHRoaXMudmFsdWUpOwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIFhtbFRleHQ6IFhtbFRleHQKICB9OwogIAogIH0seyIuL2VzY2FwZS1lbGVtZW50Ijo3NX1dLDc4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAndXNlIHN0cmljdCcKICAKICBleHBvcnRzLmJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoCiAgZXhwb3J0cy50b0J5dGVBcnJheSA9IHRvQnl0ZUFycmF5CiAgZXhwb3J0cy5mcm9tQnl0ZUFycmF5ID0gZnJvbUJ5dGVBcnJheQogIAogIHZhciBsb29rdXAgPSBbXQogIHZhciByZXZMb29rdXAgPSBbXQogIHZhciBBcnIgPSB0eXBlb2YgVWludDhBcnJheSAhPT0gJ3VuZGVmaW5lZCcgPyBVaW50OEFycmF5IDogQXJyYXkKICAKICB2YXIgY29kZSA9ICdBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OSsvJwogIGZvciAodmFyIGkgPSAwLCBsZW4gPSBjb2RlLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICBsb29rdXBbaV0gPSBjb2RlW2ldCiAgICByZXZMb29rdXBbY29kZS5jaGFyQ29kZUF0KGkpXSA9IGkKICB9CiAgCiAgLy8gU3VwcG9ydCBkZWNvZGluZyBVUkwtc2FmZSBiYXNlNjQgc3RyaW5ncywgYXMgTm9kZS5qcyBkb2VzLgogIC8vIFNlZTogaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQmFzZTY0I1VSTF9hcHBsaWNhdGlvbnMKICByZXZMb29rdXBbJy0nLmNoYXJDb2RlQXQoMCldID0gNjIKICByZXZMb29rdXBbJ18nLmNoYXJDb2RlQXQoMCldID0gNjMKICAKICBmdW5jdGlvbiBnZXRMZW5zIChiNjQpIHsKICAgIHZhciBsZW4gPSBiNjQubGVuZ3RoCiAgCiAgICBpZiAobGVuICUgNCA+IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHN0cmluZy4gTGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA0JykKICAgIH0KICAKICAgIC8vIFRyaW0gb2ZmIGV4dHJhIGJ5dGVzIGFmdGVyIHBsYWNlaG9sZGVyIGJ5dGVzIGFyZSBmb3VuZAogICAgLy8gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vYmVhdGdhbW1pdC9iYXNlNjQtanMvaXNzdWVzLzQyCiAgICB2YXIgdmFsaWRMZW4gPSBiNjQuaW5kZXhPZignPScpCiAgICBpZiAodmFsaWRMZW4gPT09IC0xKSB2YWxpZExlbiA9IGxlbgogIAogICAgdmFyIHBsYWNlSG9sZGVyc0xlbiA9IHZhbGlkTGVuID09PSBsZW4KICAgICAgPyAwCiAgICAgIDogNCAtICh2YWxpZExlbiAlIDQpCiAgCiAgICByZXR1cm4gW3ZhbGlkTGVuLCBwbGFjZUhvbGRlcnNMZW5dCiAgfQogIAogIC8vIGJhc2U2NCBpcyA0LzMgKyB1cCB0byB0d28gY2hhcmFjdGVycyBvZiB0aGUgb3JpZ2luYWwgZGF0YQogIGZ1bmN0aW9uIGJ5dGVMZW5ndGggKGI2NCkgewogICAgdmFyIGxlbnMgPSBnZXRMZW5zKGI2NCkKICAgIHZhciB2YWxpZExlbiA9IGxlbnNbMF0KICAgIHZhciBwbGFjZUhvbGRlcnNMZW4gPSBsZW5zWzFdCiAgICByZXR1cm4gKCh2YWxpZExlbiArIHBsYWNlSG9sZGVyc0xlbikgKiAzIC8gNCkgLSBwbGFjZUhvbGRlcnNMZW4KICB9CiAgCiAgZnVuY3Rpb24gX2J5dGVMZW5ndGggKGI2NCwgdmFsaWRMZW4sIHBsYWNlSG9sZGVyc0xlbikgewogICAgcmV0dXJuICgodmFsaWRMZW4gKyBwbGFjZUhvbGRlcnNMZW4pICogMyAvIDQpIC0gcGxhY2VIb2xkZXJzTGVuCiAgfQogIAogIGZ1bmN0aW9uIHRvQnl0ZUFycmF5IChiNjQpIHsKICAgIHZhciB0bXAKICAgIHZhciBsZW5zID0gZ2V0TGVucyhiNjQpCiAgICB2YXIgdmFsaWRMZW4gPSBsZW5zWzBdCiAgICB2YXIgcGxhY2VIb2xkZXJzTGVuID0gbGVuc1sxXQogIAogICAgdmFyIGFyciA9IG5ldyBBcnIoX2J5dGVMZW5ndGgoYjY0LCB2YWxpZExlbiwgcGxhY2VIb2xkZXJzTGVuKSkKICAKICAgIHZhciBjdXJCeXRlID0gMAogIAogICAgLy8gaWYgdGhlcmUgYXJlIHBsYWNlaG9sZGVycywgb25seSBnZXQgdXAgdG8gdGhlIGxhc3QgY29tcGxldGUgNCBjaGFycwogICAgdmFyIGxlbiA9IHBsYWNlSG9sZGVyc0xlbiA+IDAKICAgICAgPyB2YWxpZExlbiAtIDQKICAgICAgOiB2YWxpZExlbgogIAogICAgdmFyIGkKICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkgKz0gNCkgewogICAgICB0bXAgPQogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSldIDw8IDE4KSB8CiAgICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMSldIDw8IDEyKSB8CiAgICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMildIDw8IDYpIHwKICAgICAgICByZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDMpXQogICAgICBhcnJbY3VyQnl0ZSsrXSA9ICh0bXAgPj4gMTYpICYgMHhGRgogICAgICBhcnJbY3VyQnl0ZSsrXSA9ICh0bXAgPj4gOCkgJiAweEZGCiAgICAgIGFycltjdXJCeXRlKytdID0gdG1wICYgMHhGRgogICAgfQogIAogICAgaWYgKHBsYWNlSG9sZGVyc0xlbiA9PT0gMikgewogICAgICB0bXAgPQogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSldIDw8IDIpIHwKICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAxKV0gPj4gNCkKICAgICAgYXJyW2N1ckJ5dGUrK10gPSB0bXAgJiAweEZGCiAgICB9CiAgCiAgICBpZiAocGxhY2VIb2xkZXJzTGVuID09PSAxKSB7CiAgICAgIHRtcCA9CiAgICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpKV0gPDwgMTApIHwKICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAxKV0gPDwgNCkgfAogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDIpXSA+PiAyKQogICAgICBhcnJbY3VyQnl0ZSsrXSA9ICh0bXAgPj4gOCkgJiAweEZGCiAgICAgIGFycltjdXJCeXRlKytdID0gdG1wICYgMHhGRgogICAgfQogIAogICAgcmV0dXJuIGFycgogIH0KICAKICBmdW5jdGlvbiB0cmlwbGV0VG9CYXNlNjQgKG51bSkgewogICAgcmV0dXJuIGxvb2t1cFtudW0gPj4gMTggJiAweDNGXSArCiAgICAgIGxvb2t1cFtudW0gPj4gMTIgJiAweDNGXSArCiAgICAgIGxvb2t1cFtudW0gPj4gNiAmIDB4M0ZdICsKICAgICAgbG9va3VwW251bSAmIDB4M0ZdCiAgfQogIAogIGZ1bmN0aW9uIGVuY29kZUNodW5rICh1aW50OCwgc3RhcnQsIGVuZCkgewogICAgdmFyIHRtcAogICAgdmFyIG91dHB1dCA9IFtdCiAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7IGkgKz0gMykgewogICAgICB0bXAgPQogICAgICAgICgodWludDhbaV0gPDwgMTYpICYgMHhGRjAwMDApICsKICAgICAgICAoKHVpbnQ4W2kgKyAxXSA8PCA4KSAmIDB4RkYwMCkgKwogICAgICAgICh1aW50OFtpICsgMl0gJiAweEZGKQogICAgICBvdXRwdXQucHVzaCh0cmlwbGV0VG9CYXNlNjQodG1wKSkKICAgIH0KICAgIHJldHVybiBvdXRwdXQuam9pbignJykKICB9CiAgCiAgZnVuY3Rpb24gZnJvbUJ5dGVBcnJheSAodWludDgpIHsKICAgIHZhciB0bXAKICAgIHZhciBsZW4gPSB1aW50OC5sZW5ndGgKICAgIHZhciBleHRyYUJ5dGVzID0gbGVuICUgMyAvLyBpZiB3ZSBoYXZlIDEgYnl0ZSBsZWZ0LCBwYWQgMiBieXRlcwogICAgdmFyIHBhcnRzID0gW10KICAgIHZhciBtYXhDaHVua0xlbmd0aCA9IDE2MzgzIC8vIG11c3QgYmUgbXVsdGlwbGUgb2YgMwogIAogICAgLy8gZ28gdGhyb3VnaCB0aGUgYXJyYXkgZXZlcnkgdGhyZWUgYnl0ZXMsIHdlJ2xsIGRlYWwgd2l0aCB0cmFpbGluZyBzdHVmZiBsYXRlcgogICAgZm9yICh2YXIgaSA9IDAsIGxlbjIgPSBsZW4gLSBleHRyYUJ5dGVzOyBpIDwgbGVuMjsgaSArPSBtYXhDaHVua0xlbmd0aCkgewogICAgICBwYXJ0cy5wdXNoKGVuY29kZUNodW5rKHVpbnQ4LCBpLCAoaSArIG1heENodW5rTGVuZ3RoKSA+IGxlbjIgPyBsZW4yIDogKGkgKyBtYXhDaHVua0xlbmd0aCkpKQogICAgfQogIAogICAgLy8gcGFkIHRoZSBlbmQgd2l0aCB6ZXJvcywgYnV0IG1ha2Ugc3VyZSB0byBub3QgZm9yZ2V0IHRoZSBleHRyYSBieXRlcwogICAgaWYgKGV4dHJhQnl0ZXMgPT09IDEpIHsKICAgICAgdG1wID0gdWludDhbbGVuIC0gMV0KICAgICAgcGFydHMucHVzaCgKICAgICAgICBsb29rdXBbdG1wID4+IDJdICsKICAgICAgICBsb29rdXBbKHRtcCA8PCA0KSAmIDB4M0ZdICsKICAgICAgICAnPT0nCiAgICAgICkKICAgIH0gZWxzZSBpZiAoZXh0cmFCeXRlcyA9PT0gMikgewogICAgICB0bXAgPSAodWludDhbbGVuIC0gMl0gPDwgOCkgKyB1aW50OFtsZW4gLSAxXQogICAgICBwYXJ0cy5wdXNoKAogICAgICAgIGxvb2t1cFt0bXAgPj4gMTBdICsKICAgICAgICBsb29rdXBbKHRtcCA+PiA0KSAmIDB4M0ZdICsKICAgICAgICBsb29rdXBbKHRtcCA8PCAyKSAmIDB4M0ZdICsKICAgICAgICAnPScKICAgICAgKQogICAgfQogIAogICAgcmV0dXJuIHBhcnRzLmpvaW4oJycpCiAgfQogIAogIH0se31dLDc5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAKICB9LHt9XSw4MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChnbG9iYWwpeyhmdW5jdGlvbiAoKXsKICAvKiEgaHR0cHM6Ly9tdGhzLmJlL3B1bnljb2RlIHYxLjMuMiBieSBAbWF0aGlhcyAqLwogIDsoZnVuY3Rpb24ocm9vdCkgewogIAogICAgLyoqIERldGVjdCBmcmVlIHZhcmlhYmxlcyAqLwogICAgdmFyIGZyZWVFeHBvcnRzID0gdHlwZW9mIGV4cG9ydHMgPT0gJ29iamVjdCcgJiYgZXhwb3J0cyAmJgogICAgICAhZXhwb3J0cy5ub2RlVHlwZSAmJiBleHBvcnRzOwogICAgdmFyIGZyZWVNb2R1bGUgPSB0eXBlb2YgbW9kdWxlID09ICdvYmplY3QnICYmIG1vZHVsZSAmJgogICAgICAhbW9kdWxlLm5vZGVUeXBlICYmIG1vZHVsZTsKICAgIHZhciBmcmVlR2xvYmFsID0gdHlwZW9mIGdsb2JhbCA9PSAnb2JqZWN0JyAmJiBnbG9iYWw7CiAgICBpZiAoCiAgICAgIGZyZWVHbG9iYWwuZ2xvYmFsID09PSBmcmVlR2xvYmFsIHx8CiAgICAgIGZyZWVHbG9iYWwud2luZG93ID09PSBmcmVlR2xvYmFsIHx8CiAgICAgIGZyZWVHbG9iYWwuc2VsZiA9PT0gZnJlZUdsb2JhbAogICAgKSB7CiAgICAgIHJvb3QgPSBmcmVlR2xvYmFsOwogICAgfQogIAogICAgLyoqCiAgICAgKiBUaGUgYHB1bnljb2RlYCBvYmplY3QuCiAgICAgKiBAbmFtZSBwdW55Y29kZQogICAgICogQHR5cGUgT2JqZWN0CiAgICAgKi8KICAgIHZhciBwdW55Y29kZSwKICAKICAgIC8qKiBIaWdoZXN0IHBvc2l0aXZlIHNpZ25lZCAzMi1iaXQgZmxvYXQgdmFsdWUgKi8KICAgIG1heEludCA9IDIxNDc0ODM2NDcsIC8vIGFrYS4gMHg3RkZGRkZGRiBvciAyXjMxLTEKICAKICAgIC8qKiBCb290c3RyaW5nIHBhcmFtZXRlcnMgKi8KICAgIGJhc2UgPSAzNiwKICAgIHRNaW4gPSAxLAogICAgdE1heCA9IDI2LAogICAgc2tldyA9IDM4LAogICAgZGFtcCA9IDcwMCwKICAgIGluaXRpYWxCaWFzID0gNzIsCiAgICBpbml0aWFsTiA9IDEyOCwgLy8gMHg4MAogICAgZGVsaW1pdGVyID0gJy0nLCAvLyAnXHgyRCcKICAKICAgIC8qKiBSZWd1bGFyIGV4cHJlc3Npb25zICovCiAgICByZWdleFB1bnljb2RlID0gL154bi0tLywKICAgIHJlZ2V4Tm9uQVNDSUkgPSAvW15ceDIwLVx4N0VdLywgLy8gdW5wcmludGFibGUgQVNDSUkgY2hhcnMgKyBub24tQVNDSUkgY2hhcnMKICAgIHJlZ2V4U2VwYXJhdG9ycyA9IC9bXHgyRVx1MzAwMlx1RkYwRVx1RkY2MV0vZywgLy8gUkZDIDM0OTAgc2VwYXJhdG9ycwogIAogICAgLyoqIEVycm9yIG1lc3NhZ2VzICovCiAgICBlcnJvcnMgPSB7CiAgICAgICdvdmVyZmxvdyc6ICdPdmVyZmxvdzogaW5wdXQgbmVlZHMgd2lkZXIgaW50ZWdlcnMgdG8gcHJvY2VzcycsCiAgICAgICdub3QtYmFzaWMnOiAnSWxsZWdhbCBpbnB1dCA+PSAweDgwIChub3QgYSBiYXNpYyBjb2RlIHBvaW50KScsCiAgICAgICdpbnZhbGlkLWlucHV0JzogJ0ludmFsaWQgaW5wdXQnCiAgICB9LAogIAogICAgLyoqIENvbnZlbmllbmNlIHNob3J0Y3V0cyAqLwogICAgYmFzZU1pbnVzVE1pbiA9IGJhc2UgLSB0TWluLAogICAgZmxvb3IgPSBNYXRoLmZsb29yLAogICAgc3RyaW5nRnJvbUNoYXJDb2RlID0gU3RyaW5nLmZyb21DaGFyQ29kZSwKICAKICAgIC8qKiBUZW1wb3JhcnkgdmFyaWFibGUgKi8KICAgIGtleTsKICAKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIAogICAgLyoqCiAgICAgKiBBIGdlbmVyaWMgZXJyb3IgdXRpbGl0eSBmdW5jdGlvbi4KICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgZXJyb3IgdHlwZS4KICAgICAqIEByZXR1cm5zIHtFcnJvcn0gVGhyb3dzIGEgYFJhbmdlRXJyb3JgIHdpdGggdGhlIGFwcGxpY2FibGUgZXJyb3IgbWVzc2FnZS4KICAgICAqLwogICAgZnVuY3Rpb24gZXJyb3IodHlwZSkgewogICAgICB0aHJvdyBSYW5nZUVycm9yKGVycm9yc1t0eXBlXSk7CiAgICB9CiAgCiAgICAvKioKICAgICAqIEEgZ2VuZXJpYyBgQXJyYXkjbWFwYCB1dGlsaXR5IGZ1bmN0aW9uLgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdGhhdCBnZXRzIGNhbGxlZCBmb3IgZXZlcnkgYXJyYXkKICAgICAqIGl0ZW0uCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IEEgbmV3IGFycmF5IG9mIHZhbHVlcyByZXR1cm5lZCBieSB0aGUgY2FsbGJhY2sgZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1hcChhcnJheSwgZm4pIHsKICAgICAgdmFyIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICByZXN1bHRbbGVuZ3RoXSA9IGZuKGFycmF5W2xlbmd0aF0pOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgCiAgICAvKioKICAgICAqIEEgc2ltcGxlIGBBcnJheSNtYXBgLWxpa2Ugd3JhcHBlciB0byB3b3JrIHdpdGggZG9tYWluIG5hbWUgc3RyaW5ncyBvciBlbWFpbAogICAgICogYWRkcmVzc2VzLgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBkb21haW4gVGhlIGRvbWFpbiBuYW1lIG9yIGVtYWlsIGFkZHJlc3MuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdGhhdCBnZXRzIGNhbGxlZCBmb3IgZXZlcnkKICAgICAqIGNoYXJhY3Rlci4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gQSBuZXcgc3RyaW5nIG9mIGNoYXJhY3RlcnMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrCiAgICAgKiBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gbWFwRG9tYWluKHN0cmluZywgZm4pIHsKICAgICAgdmFyIHBhcnRzID0gc3RyaW5nLnNwbGl0KCdAJyk7CiAgICAgIHZhciByZXN1bHQgPSAnJzsKICAgICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEpIHsKICAgICAgICAvLyBJbiBlbWFpbCBhZGRyZXNzZXMsIG9ubHkgdGhlIGRvbWFpbiBuYW1lIHNob3VsZCBiZSBwdW55Y29kZWQuIExlYXZlCiAgICAgICAgLy8gdGhlIGxvY2FsIHBhcnQgKGkuZS4gZXZlcnl0aGluZyB1cCB0byBgQGApIGludGFjdC4KICAgICAgICByZXN1bHQgPSBwYXJ0c1swXSArICdAJzsKICAgICAgICBzdHJpbmcgPSBwYXJ0c1sxXTsKICAgICAgfQogICAgICAvLyBBdm9pZCBgc3BsaXQocmVnZXgpYCBmb3IgSUU4IGNvbXBhdGliaWxpdHkuIFNlZSAjMTcuCiAgICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKHJlZ2V4U2VwYXJhdG9ycywgJ1x4MkUnKTsKICAgICAgdmFyIGxhYmVscyA9IHN0cmluZy5zcGxpdCgnLicpOwogICAgICB2YXIgZW5jb2RlZCA9IG1hcChsYWJlbHMsIGZuKS5qb2luKCcuJyk7CiAgICAgIHJldHVybiByZXN1bHQgKyBlbmNvZGVkOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IGNvbnRhaW5pbmcgdGhlIG51bWVyaWMgY29kZSBwb2ludHMgb2YgZWFjaCBVbmljb2RlCiAgICAgKiBjaGFyYWN0ZXIgaW4gdGhlIHN0cmluZy4gV2hpbGUgSmF2YVNjcmlwdCB1c2VzIFVDUy0yIGludGVybmFsbHksCiAgICAgKiB0aGlzIGZ1bmN0aW9uIHdpbGwgY29udmVydCBhIHBhaXIgb2Ygc3Vycm9nYXRlIGhhbHZlcyAoZWFjaCBvZiB3aGljaAogICAgICogVUNTLTIgZXhwb3NlcyBhcyBzZXBhcmF0ZSBjaGFyYWN0ZXJzKSBpbnRvIGEgc2luZ2xlIGNvZGUgcG9pbnQsCiAgICAgKiBtYXRjaGluZyBVVEYtMTYuCiAgICAgKiBAc2VlIGBwdW55Y29kZS51Y3MyLmVuY29kZWAKICAgICAqIEBzZWUgPGh0dHBzOi8vbWF0aGlhc2J5bmVucy5iZS9ub3Rlcy9qYXZhc2NyaXB0LWVuY29kaW5nPgogICAgICogQG1lbWJlck9mIHB1bnljb2RlLnVjczIKICAgICAqIEBuYW1lIGRlY29kZQogICAgICogQHBhcmFtIHtTdHJpbmd9IHN0cmluZyBUaGUgVW5pY29kZSBpbnB1dCBzdHJpbmcgKFVDUy0yKS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gVGhlIG5ldyBhcnJheSBvZiBjb2RlIHBvaW50cy4KICAgICAqLwogICAgZnVuY3Rpb24gdWNzMmRlY29kZShzdHJpbmcpIHsKICAgICAgdmFyIG91dHB1dCA9IFtdLAogICAgICAgICAgY291bnRlciA9IDAsCiAgICAgICAgICBsZW5ndGggPSBzdHJpbmcubGVuZ3RoLAogICAgICAgICAgdmFsdWUsCiAgICAgICAgICBleHRyYTsKICAgICAgd2hpbGUgKGNvdW50ZXIgPCBsZW5ndGgpIHsKICAgICAgICB2YWx1ZSA9IHN0cmluZy5jaGFyQ29kZUF0KGNvdW50ZXIrKyk7CiAgICAgICAgaWYgKHZhbHVlID49IDB4RDgwMCAmJiB2YWx1ZSA8PSAweERCRkYgJiYgY291bnRlciA8IGxlbmd0aCkgewogICAgICAgICAgLy8gaGlnaCBzdXJyb2dhdGUsIGFuZCB0aGVyZSBpcyBhIG5leHQgY2hhcmFjdGVyCiAgICAgICAgICBleHRyYSA9IHN0cmluZy5jaGFyQ29kZUF0KGNvdW50ZXIrKyk7CiAgICAgICAgICBpZiAoKGV4dHJhICYgMHhGQzAwKSA9PSAweERDMDApIHsgLy8gbG93IHN1cnJvZ2F0ZQogICAgICAgICAgICBvdXRwdXQucHVzaCgoKHZhbHVlICYgMHgzRkYpIDw8IDEwKSArIChleHRyYSAmIDB4M0ZGKSArIDB4MTAwMDApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gdW5tYXRjaGVkIHN1cnJvZ2F0ZTsgb25seSBhcHBlbmQgdGhpcyBjb2RlIHVuaXQsIGluIGNhc2UgdGhlIG5leHQKICAgICAgICAgICAgLy8gY29kZSB1bml0IGlzIHRoZSBoaWdoIHN1cnJvZ2F0ZSBvZiBhIHN1cnJvZ2F0ZSBwYWlyCiAgICAgICAgICAgIG91dHB1dC5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgY291bnRlci0tOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBvdXRwdXQ7CiAgICB9CiAgCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBzdHJpbmcgYmFzZWQgb24gYW4gYXJyYXkgb2YgbnVtZXJpYyBjb2RlIHBvaW50cy4KICAgICAqIEBzZWUgYHB1bnljb2RlLnVjczIuZGVjb2RlYAogICAgICogQG1lbWJlck9mIHB1bnljb2RlLnVjczIKICAgICAqIEBuYW1lIGVuY29kZQogICAgICogQHBhcmFtIHtBcnJheX0gY29kZVBvaW50cyBUaGUgYXJyYXkgb2YgbnVtZXJpYyBjb2RlIHBvaW50cy4KICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IFRoZSBuZXcgVW5pY29kZSBzdHJpbmcgKFVDUy0yKS4KICAgICAqLwogICAgZnVuY3Rpb24gdWNzMmVuY29kZShhcnJheSkgewogICAgICByZXR1cm4gbWFwKGFycmF5LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHZhciBvdXRwdXQgPSAnJzsKICAgICAgICBpZiAodmFsdWUgPiAweEZGRkYpIHsKICAgICAgICAgIHZhbHVlIC09IDB4MTAwMDA7CiAgICAgICAgICBvdXRwdXQgKz0gc3RyaW5nRnJvbUNoYXJDb2RlKHZhbHVlID4+PiAxMCAmIDB4M0ZGIHwgMHhEODAwKTsKICAgICAgICAgIHZhbHVlID0gMHhEQzAwIHwgdmFsdWUgJiAweDNGRjsKICAgICAgICB9CiAgICAgICAgb3V0cHV0ICs9IHN0cmluZ0Zyb21DaGFyQ29kZSh2YWx1ZSk7CiAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgfSkuam9pbignJyk7CiAgICB9CiAgCiAgICAvKioKICAgICAqIENvbnZlcnRzIGEgYmFzaWMgY29kZSBwb2ludCBpbnRvIGEgZGlnaXQvaW50ZWdlci4KICAgICAqIEBzZWUgYGRpZ2l0VG9CYXNpYygpYAogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBjb2RlUG9pbnQgVGhlIGJhc2ljIG51bWVyaWMgY29kZSBwb2ludCB2YWx1ZS4KICAgICAqIEByZXR1cm5zIHtOdW1iZXJ9IFRoZSBudW1lcmljIHZhbHVlIG9mIGEgYmFzaWMgY29kZSBwb2ludCAoZm9yIHVzZSBpbgogICAgICogcmVwcmVzZW50aW5nIGludGVnZXJzKSBpbiB0aGUgcmFuZ2UgYDBgIHRvIGBiYXNlIC0gMWAsIG9yIGBiYXNlYCBpZgogICAgICogdGhlIGNvZGUgcG9pbnQgZG9lcyBub3QgcmVwcmVzZW50IGEgdmFsdWUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2ljVG9EaWdpdChjb2RlUG9pbnQpIHsKICAgICAgaWYgKGNvZGVQb2ludCAtIDQ4IDwgMTApIHsKICAgICAgICByZXR1cm4gY29kZVBvaW50IC0gMjI7CiAgICAgIH0KICAgICAgaWYgKGNvZGVQb2ludCAtIDY1IDwgMjYpIHsKICAgICAgICByZXR1cm4gY29kZVBvaW50IC0gNjU7CiAgICAgIH0KICAgICAgaWYgKGNvZGVQb2ludCAtIDk3IDwgMjYpIHsKICAgICAgICByZXR1cm4gY29kZVBvaW50IC0gOTc7CiAgICAgIH0KICAgICAgcmV0dXJuIGJhc2U7CiAgICB9CiAgCiAgICAvKioKICAgICAqIENvbnZlcnRzIGEgZGlnaXQvaW50ZWdlciBpbnRvIGEgYmFzaWMgY29kZSBwb2ludC4KICAgICAqIEBzZWUgYGJhc2ljVG9EaWdpdCgpYAogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBkaWdpdCBUaGUgbnVtZXJpYyB2YWx1ZSBvZiBhIGJhc2ljIGNvZGUgcG9pbnQuCiAgICAgKiBAcmV0dXJucyB7TnVtYmVyfSBUaGUgYmFzaWMgY29kZSBwb2ludCB3aG9zZSB2YWx1ZSAod2hlbiB1c2VkIGZvcgogICAgICogcmVwcmVzZW50aW5nIGludGVnZXJzKSBpcyBgZGlnaXRgLCB3aGljaCBuZWVkcyB0byBiZSBpbiB0aGUgcmFuZ2UKICAgICAqIGAwYCB0byBgYmFzZSAtIDFgLiBJZiBgZmxhZ2AgaXMgbm9uLXplcm8sIHRoZSB1cHBlcmNhc2UgZm9ybSBpcwogICAgICogdXNlZDsgZWxzZSwgdGhlIGxvd2VyY2FzZSBmb3JtIGlzIHVzZWQuIFRoZSBiZWhhdmlvciBpcyB1bmRlZmluZWQKICAgICAqIGlmIGBmbGFnYCBpcyBub24temVybyBhbmQgYGRpZ2l0YCBoYXMgbm8gdXBwZXJjYXNlIGZvcm0uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRpZ2l0VG9CYXNpYyhkaWdpdCwgZmxhZykgewogICAgICAvLyAgMC4uMjUgbWFwIHRvIEFTQ0lJIGEuLnogb3IgQS4uWgogICAgICAvLyAyNi4uMzUgbWFwIHRvIEFTQ0lJIDAuLjkKICAgICAgcmV0dXJuIGRpZ2l0ICsgMjIgKyA3NSAqIChkaWdpdCA8IDI2KSAtICgoZmxhZyAhPSAwKSA8PCA1KTsKICAgIH0KICAKICAgIC8qKgogICAgICogQmlhcyBhZGFwdGF0aW9uIGZ1bmN0aW9uIGFzIHBlciBzZWN0aW9uIDMuNCBvZiBSRkMgMzQ5Mi4KICAgICAqIGh0dHA6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzM0OTIjc2VjdGlvbi0zLjQKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFkYXB0KGRlbHRhLCBudW1Qb2ludHMsIGZpcnN0VGltZSkgewogICAgICB2YXIgayA9IDA7CiAgICAgIGRlbHRhID0gZmlyc3RUaW1lID8gZmxvb3IoZGVsdGEgLyBkYW1wKSA6IGRlbHRhID4+IDE7CiAgICAgIGRlbHRhICs9IGZsb29yKGRlbHRhIC8gbnVtUG9pbnRzKTsKICAgICAgZm9yICgvKiBubyBpbml0aWFsaXphdGlvbiAqLzsgZGVsdGEgPiBiYXNlTWludXNUTWluICogdE1heCA+PiAxOyBrICs9IGJhc2UpIHsKICAgICAgICBkZWx0YSA9IGZsb29yKGRlbHRhIC8gYmFzZU1pbnVzVE1pbik7CiAgICAgIH0KICAgICAgcmV0dXJuIGZsb29yKGsgKyAoYmFzZU1pbnVzVE1pbiArIDEpICogZGVsdGEgLyAoZGVsdGEgKyBza2V3KSk7CiAgICB9CiAgCiAgICAvKioKICAgICAqIENvbnZlcnRzIGEgUHVueWNvZGUgc3RyaW5nIG9mIEFTQ0lJLW9ubHkgc3ltYm9scyB0byBhIHN0cmluZyBvZiBVbmljb2RlCiAgICAgKiBzeW1ib2xzLgogICAgICogQG1lbWJlck9mIHB1bnljb2RlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gaW5wdXQgVGhlIFB1bnljb2RlIHN0cmluZyBvZiBBU0NJSS1vbmx5IHN5bWJvbHMuCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBUaGUgcmVzdWx0aW5nIHN0cmluZyBvZiBVbmljb2RlIHN5bWJvbHMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRlY29kZShpbnB1dCkgewogICAgICAvLyBEb24ndCB1c2UgVUNTLTIKICAgICAgdmFyIG91dHB1dCA9IFtdLAogICAgICAgICAgaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGgsCiAgICAgICAgICBvdXQsCiAgICAgICAgICBpID0gMCwKICAgICAgICAgIG4gPSBpbml0aWFsTiwKICAgICAgICAgIGJpYXMgPSBpbml0aWFsQmlhcywKICAgICAgICAgIGJhc2ljLAogICAgICAgICAgaiwKICAgICAgICAgIGluZGV4LAogICAgICAgICAgb2xkaSwKICAgICAgICAgIHcsCiAgICAgICAgICBrLAogICAgICAgICAgZGlnaXQsCiAgICAgICAgICB0LAogICAgICAgICAgLyoqIENhY2hlZCBjYWxjdWxhdGlvbiByZXN1bHRzICovCiAgICAgICAgICBiYXNlTWludXNUOwogIAogICAgICAvLyBIYW5kbGUgdGhlIGJhc2ljIGNvZGUgcG9pbnRzOiBsZXQgYGJhc2ljYCBiZSB0aGUgbnVtYmVyIG9mIGlucHV0IGNvZGUKICAgICAgLy8gcG9pbnRzIGJlZm9yZSB0aGUgbGFzdCBkZWxpbWl0ZXIsIG9yIGAwYCBpZiB0aGVyZSBpcyBub25lLCB0aGVuIGNvcHkKICAgICAgLy8gdGhlIGZpcnN0IGJhc2ljIGNvZGUgcG9pbnRzIHRvIHRoZSBvdXRwdXQuCiAgCiAgICAgIGJhc2ljID0gaW5wdXQubGFzdEluZGV4T2YoZGVsaW1pdGVyKTsKICAgICAgaWYgKGJhc2ljIDwgMCkgewogICAgICAgIGJhc2ljID0gMDsKICAgICAgfQogIAogICAgICBmb3IgKGogPSAwOyBqIDwgYmFzaWM7ICsraikgewogICAgICAgIC8vIGlmIGl0J3Mgbm90IGEgYmFzaWMgY29kZSBwb2ludAogICAgICAgIGlmIChpbnB1dC5jaGFyQ29kZUF0KGopID49IDB4ODApIHsKICAgICAgICAgIGVycm9yKCdub3QtYmFzaWMnKTsKICAgICAgICB9CiAgICAgICAgb3V0cHV0LnB1c2goaW5wdXQuY2hhckNvZGVBdChqKSk7CiAgICAgIH0KICAKICAgICAgLy8gTWFpbiBkZWNvZGluZyBsb29wOiBzdGFydCBqdXN0IGFmdGVyIHRoZSBsYXN0IGRlbGltaXRlciBpZiBhbnkgYmFzaWMgY29kZQogICAgICAvLyBwb2ludHMgd2VyZSBjb3BpZWQ7IHN0YXJ0IGF0IHRoZSBiZWdpbm5pbmcgb3RoZXJ3aXNlLgogIAogICAgICBmb3IgKGluZGV4ID0gYmFzaWMgPiAwID8gYmFzaWMgKyAxIDogMDsgaW5kZXggPCBpbnB1dExlbmd0aDsgLyogbm8gZmluYWwgZXhwcmVzc2lvbiAqLykgewogIAogICAgICAgIC8vIGBpbmRleGAgaXMgdGhlIGluZGV4IG9mIHRoZSBuZXh0IGNoYXJhY3RlciB0byBiZSBjb25zdW1lZC4KICAgICAgICAvLyBEZWNvZGUgYSBnZW5lcmFsaXplZCB2YXJpYWJsZS1sZW5ndGggaW50ZWdlciBpbnRvIGBkZWx0YWAsCiAgICAgICAgLy8gd2hpY2ggZ2V0cyBhZGRlZCB0byBgaWAuIFRoZSBvdmVyZmxvdyBjaGVja2luZyBpcyBlYXNpZXIKICAgICAgICAvLyBpZiB3ZSBpbmNyZWFzZSBgaWAgYXMgd2UgZ28sIHRoZW4gc3VidHJhY3Qgb2ZmIGl0cyBzdGFydGluZwogICAgICAgIC8vIHZhbHVlIGF0IHRoZSBlbmQgdG8gb2J0YWluIGBkZWx0YWAuCiAgICAgICAgZm9yIChvbGRpID0gaSwgdyA9IDEsIGsgPSBiYXNlOyAvKiBubyBjb25kaXRpb24gKi87IGsgKz0gYmFzZSkgewogIAogICAgICAgICAgaWYgKGluZGV4ID49IGlucHV0TGVuZ3RoKSB7CiAgICAgICAgICAgIGVycm9yKCdpbnZhbGlkLWlucHV0Jyk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBkaWdpdCA9IGJhc2ljVG9EaWdpdChpbnB1dC5jaGFyQ29kZUF0KGluZGV4KyspKTsKICAKICAgICAgICAgIGlmIChkaWdpdCA+PSBiYXNlIHx8IGRpZ2l0ID4gZmxvb3IoKG1heEludCAtIGkpIC8gdykpIHsKICAgICAgICAgICAgZXJyb3IoJ292ZXJmbG93Jyk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBpICs9IGRpZ2l0ICogdzsKICAgICAgICAgIHQgPSBrIDw9IGJpYXMgPyB0TWluIDogKGsgPj0gYmlhcyArIHRNYXggPyB0TWF4IDogayAtIGJpYXMpOwogIAogICAgICAgICAgaWYgKGRpZ2l0IDwgdCkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAKICAgICAgICAgIGJhc2VNaW51c1QgPSBiYXNlIC0gdDsKICAgICAgICAgIGlmICh3ID4gZmxvb3IobWF4SW50IC8gYmFzZU1pbnVzVCkpIHsKICAgICAgICAgICAgZXJyb3IoJ292ZXJmbG93Jyk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICB3ICo9IGJhc2VNaW51c1Q7CiAgCiAgICAgICAgfQogIAogICAgICAgIG91dCA9IG91dHB1dC5sZW5ndGggKyAxOwogICAgICAgIGJpYXMgPSBhZGFwdChpIC0gb2xkaSwgb3V0LCBvbGRpID09IDApOwogIAogICAgICAgIC8vIGBpYCB3YXMgc3VwcG9zZWQgdG8gd3JhcCBhcm91bmQgZnJvbSBgb3V0YCB0byBgMGAsCiAgICAgICAgLy8gaW5jcmVtZW50aW5nIGBuYCBlYWNoIHRpbWUsIHNvIHdlJ2xsIGZpeCB0aGF0IG5vdzoKICAgICAgICBpZiAoZmxvb3IoaSAvIG91dCkgPiBtYXhJbnQgLSBuKSB7CiAgICAgICAgICBlcnJvcignb3ZlcmZsb3cnKTsKICAgICAgICB9CiAgCiAgICAgICAgbiArPSBmbG9vcihpIC8gb3V0KTsKICAgICAgICBpICU9IG91dDsKICAKICAgICAgICAvLyBJbnNlcnQgYG5gIGF0IHBvc2l0aW9uIGBpYCBvZiB0aGUgb3V0cHV0CiAgICAgICAgb3V0cHV0LnNwbGljZShpKyssIDAsIG4pOwogIAogICAgICB9CiAgCiAgICAgIHJldHVybiB1Y3MyZW5jb2RlKG91dHB1dCk7CiAgICB9CiAgCiAgICAvKioKICAgICAqIENvbnZlcnRzIGEgc3RyaW5nIG9mIFVuaWNvZGUgc3ltYm9scyAoZS5nLiBhIGRvbWFpbiBuYW1lIGxhYmVsKSB0byBhCiAgICAgKiBQdW55Y29kZSBzdHJpbmcgb2YgQVNDSUktb25seSBzeW1ib2xzLgogICAgICogQG1lbWJlck9mIHB1bnljb2RlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gaW5wdXQgVGhlIHN0cmluZyBvZiBVbmljb2RlIHN5bWJvbHMuCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBUaGUgcmVzdWx0aW5nIFB1bnljb2RlIHN0cmluZyBvZiBBU0NJSS1vbmx5IHN5bWJvbHMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVuY29kZShpbnB1dCkgewogICAgICB2YXIgbiwKICAgICAgICAgIGRlbHRhLAogICAgICAgICAgaGFuZGxlZENQQ291bnQsCiAgICAgICAgICBiYXNpY0xlbmd0aCwKICAgICAgICAgIGJpYXMsCiAgICAgICAgICBqLAogICAgICAgICAgbSwKICAgICAgICAgIHEsCiAgICAgICAgICBrLAogICAgICAgICAgdCwKICAgICAgICAgIGN1cnJlbnRWYWx1ZSwKICAgICAgICAgIG91dHB1dCA9IFtdLAogICAgICAgICAgLyoqIGBpbnB1dExlbmd0aGAgd2lsbCBob2xkIHRoZSBudW1iZXIgb2YgY29kZSBwb2ludHMgaW4gYGlucHV0YC4gKi8KICAgICAgICAgIGlucHV0TGVuZ3RoLAogICAgICAgICAgLyoqIENhY2hlZCBjYWxjdWxhdGlvbiByZXN1bHRzICovCiAgICAgICAgICBoYW5kbGVkQ1BDb3VudFBsdXNPbmUsCiAgICAgICAgICBiYXNlTWludXNULAogICAgICAgICAgcU1pbnVzVDsKICAKICAgICAgLy8gQ29udmVydCB0aGUgaW5wdXQgaW4gVUNTLTIgdG8gVW5pY29kZQogICAgICBpbnB1dCA9IHVjczJkZWNvZGUoaW5wdXQpOwogIAogICAgICAvLyBDYWNoZSB0aGUgbGVuZ3RoCiAgICAgIGlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoOwogIAogICAgICAvLyBJbml0aWFsaXplIHRoZSBzdGF0ZQogICAgICBuID0gaW5pdGlhbE47CiAgICAgIGRlbHRhID0gMDsKICAgICAgYmlhcyA9IGluaXRpYWxCaWFzOwogIAogICAgICAvLyBIYW5kbGUgdGhlIGJhc2ljIGNvZGUgcG9pbnRzCiAgICAgIGZvciAoaiA9IDA7IGogPCBpbnB1dExlbmd0aDsgKytqKSB7CiAgICAgICAgY3VycmVudFZhbHVlID0gaW5wdXRbal07CiAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSA8IDB4ODApIHsKICAgICAgICAgIG91dHB1dC5wdXNoKHN0cmluZ0Zyb21DaGFyQ29kZShjdXJyZW50VmFsdWUpKTsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgaGFuZGxlZENQQ291bnQgPSBiYXNpY0xlbmd0aCA9IG91dHB1dC5sZW5ndGg7CiAgCiAgICAgIC8vIGBoYW5kbGVkQ1BDb3VudGAgaXMgdGhlIG51bWJlciBvZiBjb2RlIHBvaW50cyB0aGF0IGhhdmUgYmVlbiBoYW5kbGVkOwogICAgICAvLyBgYmFzaWNMZW5ndGhgIGlzIHRoZSBudW1iZXIgb2YgYmFzaWMgY29kZSBwb2ludHMuCiAgCiAgICAgIC8vIEZpbmlzaCB0aGUgYmFzaWMgc3RyaW5nIC0gaWYgaXQgaXMgbm90IGVtcHR5IC0gd2l0aCBhIGRlbGltaXRlcgogICAgICBpZiAoYmFzaWNMZW5ndGgpIHsKICAgICAgICBvdXRwdXQucHVzaChkZWxpbWl0ZXIpOwogICAgICB9CiAgCiAgICAgIC8vIE1haW4gZW5jb2RpbmcgbG9vcDoKICAgICAgd2hpbGUgKGhhbmRsZWRDUENvdW50IDwgaW5wdXRMZW5ndGgpIHsKICAKICAgICAgICAvLyBBbGwgbm9uLWJhc2ljIGNvZGUgcG9pbnRzIDwgbiBoYXZlIGJlZW4gaGFuZGxlZCBhbHJlYWR5LiBGaW5kIHRoZSBuZXh0CiAgICAgICAgLy8gbGFyZ2VyIG9uZToKICAgICAgICBmb3IgKG0gPSBtYXhJbnQsIGogPSAwOyBqIDwgaW5wdXRMZW5ndGg7ICsraikgewogICAgICAgICAgY3VycmVudFZhbHVlID0gaW5wdXRbal07CiAgICAgICAgICBpZiAoY3VycmVudFZhbHVlID49IG4gJiYgY3VycmVudFZhbHVlIDwgbSkgewogICAgICAgICAgICBtID0gY3VycmVudFZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAKICAgICAgICAvLyBJbmNyZWFzZSBgZGVsdGFgIGVub3VnaCB0byBhZHZhbmNlIHRoZSBkZWNvZGVyJ3MgPG4saT4gc3RhdGUgdG8gPG0sMD4sCiAgICAgICAgLy8gYnV0IGd1YXJkIGFnYWluc3Qgb3ZlcmZsb3cKICAgICAgICBoYW5kbGVkQ1BDb3VudFBsdXNPbmUgPSBoYW5kbGVkQ1BDb3VudCArIDE7CiAgICAgICAgaWYgKG0gLSBuID4gZmxvb3IoKG1heEludCAtIGRlbHRhKSAvIGhhbmRsZWRDUENvdW50UGx1c09uZSkpIHsKICAgICAgICAgIGVycm9yKCdvdmVyZmxvdycpOwogICAgICAgIH0KICAKICAgICAgICBkZWx0YSArPSAobSAtIG4pICogaGFuZGxlZENQQ291bnRQbHVzT25lOwogICAgICAgIG4gPSBtOwogIAogICAgICAgIGZvciAoaiA9IDA7IGogPCBpbnB1dExlbmd0aDsgKytqKSB7CiAgICAgICAgICBjdXJyZW50VmFsdWUgPSBpbnB1dFtqXTsKICAKICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgPCBuICYmICsrZGVsdGEgPiBtYXhJbnQpIHsKICAgICAgICAgICAgZXJyb3IoJ292ZXJmbG93Jyk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBpZiAoY3VycmVudFZhbHVlID09IG4pIHsKICAgICAgICAgICAgLy8gUmVwcmVzZW50IGRlbHRhIGFzIGEgZ2VuZXJhbGl6ZWQgdmFyaWFibGUtbGVuZ3RoIGludGVnZXIKICAgICAgICAgICAgZm9yIChxID0gZGVsdGEsIGsgPSBiYXNlOyAvKiBubyBjb25kaXRpb24gKi87IGsgKz0gYmFzZSkgewogICAgICAgICAgICAgIHQgPSBrIDw9IGJpYXMgPyB0TWluIDogKGsgPj0gYmlhcyArIHRNYXggPyB0TWF4IDogayAtIGJpYXMpOwogICAgICAgICAgICAgIGlmIChxIDwgdCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHFNaW51c1QgPSBxIC0gdDsKICAgICAgICAgICAgICBiYXNlTWludXNUID0gYmFzZSAtIHQ7CiAgICAgICAgICAgICAgb3V0cHV0LnB1c2goCiAgICAgICAgICAgICAgICBzdHJpbmdGcm9tQ2hhckNvZGUoZGlnaXRUb0Jhc2ljKHQgKyBxTWludXNUICUgYmFzZU1pbnVzVCwgMCkpCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBxID0gZmxvb3IocU1pbnVzVCAvIGJhc2VNaW51c1QpOwogICAgICAgICAgICB9CiAgCiAgICAgICAgICAgIG91dHB1dC5wdXNoKHN0cmluZ0Zyb21DaGFyQ29kZShkaWdpdFRvQmFzaWMocSwgMCkpKTsKICAgICAgICAgICAgYmlhcyA9IGFkYXB0KGRlbHRhLCBoYW5kbGVkQ1BDb3VudFBsdXNPbmUsIGhhbmRsZWRDUENvdW50ID09IGJhc2ljTGVuZ3RoKTsKICAgICAgICAgICAgZGVsdGEgPSAwOwogICAgICAgICAgICArK2hhbmRsZWRDUENvdW50OwogICAgICAgICAgfQogICAgICAgIH0KICAKICAgICAgICArK2RlbHRhOwogICAgICAgICsrbjsKICAKICAgICAgfQogICAgICByZXR1cm4gb3V0cHV0LmpvaW4oJycpOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhIFB1bnljb2RlIHN0cmluZyByZXByZXNlbnRpbmcgYSBkb21haW4gbmFtZSBvciBhbiBlbWFpbCBhZGRyZXNzCiAgICAgKiB0byBVbmljb2RlLiBPbmx5IHRoZSBQdW55Y29kZWQgcGFydHMgb2YgdGhlIGlucHV0IHdpbGwgYmUgY29udmVydGVkLCBpLmUuCiAgICAgKiBpdCBkb2Vzbid0IG1hdHRlciBpZiB5b3UgY2FsbCBpdCBvbiBhIHN0cmluZyB0aGF0IGhhcyBhbHJlYWR5IGJlZW4KICAgICAqIGNvbnZlcnRlZCB0byBVbmljb2RlLgogICAgICogQG1lbWJlck9mIHB1bnljb2RlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gaW5wdXQgVGhlIFB1bnljb2RlZCBkb21haW4gbmFtZSBvciBlbWFpbCBhZGRyZXNzIHRvCiAgICAgKiBjb252ZXJ0IHRvIFVuaWNvZGUuCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBUaGUgVW5pY29kZSByZXByZXNlbnRhdGlvbiBvZiB0aGUgZ2l2ZW4gUHVueWNvZGUKICAgICAqIHN0cmluZy4KICAgICAqLwogICAgZnVuY3Rpb24gdG9Vbmljb2RlKGlucHV0KSB7CiAgICAgIHJldHVybiBtYXBEb21haW4oaW5wdXQsIGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgIHJldHVybiByZWdleFB1bnljb2RlLnRlc3Qoc3RyaW5nKQogICAgICAgICAgPyBkZWNvZGUoc3RyaW5nLnNsaWNlKDQpLnRvTG93ZXJDYXNlKCkpCiAgICAgICAgICA6IHN0cmluZzsKICAgICAgfSk7CiAgICB9CiAgCiAgICAvKioKICAgICAqIENvbnZlcnRzIGEgVW5pY29kZSBzdHJpbmcgcmVwcmVzZW50aW5nIGEgZG9tYWluIG5hbWUgb3IgYW4gZW1haWwgYWRkcmVzcyB0bwogICAgICogUHVueWNvZGUuIE9ubHkgdGhlIG5vbi1BU0NJSSBwYXJ0cyBvZiB0aGUgZG9tYWluIG5hbWUgd2lsbCBiZSBjb252ZXJ0ZWQsCiAgICAgKiBpLmUuIGl0IGRvZXNuJ3QgbWF0dGVyIGlmIHlvdSBjYWxsIGl0IHdpdGggYSBkb21haW4gdGhhdCdzIGFscmVhZHkgaW4KICAgICAqIEFTQ0lJLgogICAgICogQG1lbWJlck9mIHB1bnljb2RlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gaW5wdXQgVGhlIGRvbWFpbiBuYW1lIG9yIGVtYWlsIGFkZHJlc3MgdG8gY29udmVydCwgYXMgYQogICAgICogVW5pY29kZSBzdHJpbmcuCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBUaGUgUHVueWNvZGUgcmVwcmVzZW50YXRpb24gb2YgdGhlIGdpdmVuIGRvbWFpbiBuYW1lIG9yCiAgICAgKiBlbWFpbCBhZGRyZXNzLgogICAgICovCiAgICBmdW5jdGlvbiB0b0FTQ0lJKGlucHV0KSB7CiAgICAgIHJldHVybiBtYXBEb21haW4oaW5wdXQsIGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgIHJldHVybiByZWdleE5vbkFTQ0lJLnRlc3Qoc3RyaW5nKQogICAgICAgICAgPyAneG4tLScgKyBlbmNvZGUoc3RyaW5nKQogICAgICAgICAgOiBzdHJpbmc7CiAgICAgIH0pOwogICAgfQogIAogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgCiAgICAvKiogRGVmaW5lIHRoZSBwdWJsaWMgQVBJICovCiAgICBwdW55Y29kZSA9IHsKICAgICAgLyoqCiAgICAgICAqIEEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgY3VycmVudCBQdW55Y29kZS5qcyB2ZXJzaW9uIG51bWJlci4KICAgICAgICogQG1lbWJlck9mIHB1bnljb2RlCiAgICAgICAqIEB0eXBlIFN0cmluZwogICAgICAgKi8KICAgICAgJ3ZlcnNpb24nOiAnMS4zLjInLAogICAgICAvKioKICAgICAgICogQW4gb2JqZWN0IG9mIG1ldGhvZHMgdG8gY29udmVydCBmcm9tIEphdmFTY3JpcHQncyBpbnRlcm5hbCBjaGFyYWN0ZXIKICAgICAgICogcmVwcmVzZW50YXRpb24gKFVDUy0yKSB0byBVbmljb2RlIGNvZGUgcG9pbnRzLCBhbmQgYmFjay4KICAgICAgICogQHNlZSA8aHR0cHM6Ly9tYXRoaWFzYnluZW5zLmJlL25vdGVzL2phdmFzY3JpcHQtZW5jb2Rpbmc+CiAgICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZQogICAgICAgKiBAdHlwZSBPYmplY3QKICAgICAgICovCiAgICAgICd1Y3MyJzogewogICAgICAgICdkZWNvZGUnOiB1Y3MyZGVjb2RlLAogICAgICAgICdlbmNvZGUnOiB1Y3MyZW5jb2RlCiAgICAgIH0sCiAgICAgICdkZWNvZGUnOiBkZWNvZGUsCiAgICAgICdlbmNvZGUnOiBlbmNvZGUsCiAgICAgICd0b0FTQ0lJJzogdG9BU0NJSSwKICAgICAgJ3RvVW5pY29kZSc6IHRvVW5pY29kZQogICAgfTsKICAKICAgIC8qKiBFeHBvc2UgYHB1bnljb2RlYCAqLwogICAgLy8gU29tZSBBTUQgYnVpbGQgb3B0aW1pemVycywgbGlrZSByLmpzLCBjaGVjayBmb3Igc3BlY2lmaWMgY29uZGl0aW9uIHBhdHRlcm5zCiAgICAvLyBsaWtlIHRoZSBmb2xsb3dpbmc6CiAgICBpZiAoCiAgICAgIHRydWUKICAgICkgewogICAgICAhKF9fV0VCUEFDS19BTURfREVGSU5FX1JFU1VMVF9fID0gKGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBwdW55Y29kZTsKICAgICAgfSkuY2FsbChleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fLCBleHBvcnRzLCBtb2R1bGUpLAoJCV9fV0VCUEFDS19BTURfREVGSU5FX1JFU1VMVF9fICE9PSB1bmRlZmluZWQgJiYgKG1vZHVsZS5leHBvcnRzID0gX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18pKTsKICAgIH0gZWxzZSB7fQogIAogIH0odGhpcykpOwogIAogIH0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMsdHlwZW9mIF9fd2VicGFja19yZXF1aXJlX18uZyAhPT0gInVuZGVmaW5lZCIgPyBfX3dlYnBhY2tfcmVxdWlyZV9fLmcgOiB0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIgPyBzZWxmIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSkKICB9LHt9XSw4MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChnbG9iYWwsQnVmZmVyKXsoZnVuY3Rpb24gKCl7CiAgLyohCiAgICogVGhlIGJ1ZmZlciBtb2R1bGUgZnJvbSBub2RlLmpzLCBmb3IgdGhlIGJyb3dzZXIuCiAgICoKICAgKiBAYXV0aG9yICAgRmVyb3NzIEFib3VraGFkaWplaCA8ZmVyb3NzQGZlcm9zcy5vcmc+IDxodHRwOi8vZmVyb3NzLm9yZz4KICAgKiBAbGljZW5zZSAgTUlUCiAgICovCiAgLyogZXNsaW50LWRpc2FibGUgbm8tcHJvdG8gKi8KICAKICAndXNlIHN0cmljdCcKICAKICB2YXIgYmFzZTY0ID0gcmVxdWlyZSgnYmFzZTY0LWpzJykKICB2YXIgaWVlZTc1NCA9IHJlcXVpcmUoJ2llZWU3NTQnKQogIHZhciBpc0FycmF5ID0gcmVxdWlyZSgnaXNhcnJheScpCiAgCiAgZXhwb3J0cy5CdWZmZXIgPSBCdWZmZXIKICBleHBvcnRzLlNsb3dCdWZmZXIgPSBTbG93QnVmZmVyCiAgZXhwb3J0cy5JTlNQRUNUX01BWF9CWVRFUyA9IDUwCiAgCiAgLyoqCiAgICogSWYgYEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUYDoKICAgKiAgID09PSB0cnVlICAgIFVzZSBVaW50OEFycmF5IGltcGxlbWVudGF0aW9uIChmYXN0ZXN0KQogICAqICAgPT09IGZhbHNlICAgVXNlIE9iamVjdCBpbXBsZW1lbnRhdGlvbiAobW9zdCBjb21wYXRpYmxlLCBldmVuIElFNikKICAgKgogICAqIEJyb3dzZXJzIHRoYXQgc3VwcG9ydCB0eXBlZCBhcnJheXMgYXJlIElFIDEwKywgRmlyZWZveCA0KywgQ2hyb21lIDcrLCBTYWZhcmkgNS4xKywKICAgKiBPcGVyYSAxMS42KywgaU9TIDQuMisuCiAgICoKICAgKiBEdWUgdG8gdmFyaW91cyBicm93c2VyIGJ1Z3MsIHNvbWV0aW1lcyB0aGUgT2JqZWN0IGltcGxlbWVudGF0aW9uIHdpbGwgYmUgdXNlZCBldmVuCiAgICogd2hlbiB0aGUgYnJvd3NlciBzdXBwb3J0cyB0eXBlZCBhcnJheXMuCiAgICoKICAgKiBOb3RlOgogICAqCiAgICogICAtIEZpcmVmb3ggNC0yOSBsYWNrcyBzdXBwb3J0IGZvciBhZGRpbmcgbmV3IHByb3BlcnRpZXMgdG8gYFVpbnQ4QXJyYXlgIGluc3RhbmNlcywKICAgKiAgICAgU2VlOiBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD02OTU0MzguCiAgICoKICAgKiAgIC0gQ2hyb21lIDktMTAgaXMgbWlzc2luZyB0aGUgYFR5cGVkQXJyYXkucHJvdG90eXBlLnN1YmFycmF5YCBmdW5jdGlvbi4KICAgKgogICAqICAgLSBJRTEwIGhhcyBhIGJyb2tlbiBgVHlwZWRBcnJheS5wcm90b3R5cGUuc3ViYXJyYXlgIGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYXJyYXlzIG9mCiAgICogICAgIGluY29ycmVjdCBsZW5ndGggaW4gc29tZSBzaXR1YXRpb25zLgogIAogICAqIFdlIGRldGVjdCB0aGVzZSBidWdneSBicm93c2VycyBhbmQgc2V0IGBCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVGAgdG8gYGZhbHNlYCBzbyB0aGV5CiAgICogZ2V0IHRoZSBPYmplY3QgaW1wbGVtZW50YXRpb24sIHdoaWNoIGlzIHNsb3dlciBidXQgYmVoYXZlcyBjb3JyZWN0bHkuCiAgICovCiAgQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQgPSBnbG9iYWwuVFlQRURfQVJSQVlfU1VQUE9SVCAhPT0gdW5kZWZpbmVkCiAgICA/IGdsb2JhbC5UWVBFRF9BUlJBWV9TVVBQT1JUCiAgICA6IHR5cGVkQXJyYXlTdXBwb3J0KCkKICAKICAvKgogICAqIEV4cG9ydCBrTWF4TGVuZ3RoIGFmdGVyIHR5cGVkIGFycmF5IHN1cHBvcnQgaXMgZGV0ZXJtaW5lZC4KICAgKi8KICBleHBvcnRzLmtNYXhMZW5ndGggPSBrTWF4TGVuZ3RoKCkKICAKICBmdW5jdGlvbiB0eXBlZEFycmF5U3VwcG9ydCAoKSB7CiAgICB0cnkgewogICAgICB2YXIgYXJyID0gbmV3IFVpbnQ4QXJyYXkoMSkKICAgICAgYXJyLl9fcHJvdG9fXyA9IHtfX3Byb3RvX186IFVpbnQ4QXJyYXkucHJvdG90eXBlLCBmb286IGZ1bmN0aW9uICgpIHsgcmV0dXJuIDQyIH19CiAgICAgIHJldHVybiBhcnIuZm9vKCkgPT09IDQyICYmIC8vIHR5cGVkIGFycmF5IGluc3RhbmNlcyBjYW4gYmUgYXVnbWVudGVkCiAgICAgICAgICB0eXBlb2YgYXJyLnN1YmFycmF5ID09PSAnZnVuY3Rpb24nICYmIC8vIGNocm9tZSA5LTEwIGxhY2sgYHN1YmFycmF5YAogICAgICAgICAgYXJyLnN1YmFycmF5KDEsIDEpLmJ5dGVMZW5ndGggPT09IDAgLy8gaWUxMCBoYXMgYnJva2VuIGBzdWJhcnJheWAKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGtNYXhMZW5ndGggKCkgewogICAgcmV0dXJuIEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUCiAgICAgID8gMHg3ZmZmZmZmZgogICAgICA6IDB4M2ZmZmZmZmYKICB9CiAgCiAgZnVuY3Rpb24gY3JlYXRlQnVmZmVyICh0aGF0LCBsZW5ndGgpIHsKICAgIGlmIChrTWF4TGVuZ3RoKCkgPCBsZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0ludmFsaWQgdHlwZWQgYXJyYXkgbGVuZ3RoJykKICAgIH0KICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICAvLyBSZXR1cm4gYW4gYXVnbWVudGVkIGBVaW50OEFycmF5YCBpbnN0YW5jZSwgZm9yIGJlc3QgcGVyZm9ybWFuY2UKICAgICAgdGhhdCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCkKICAgICAgdGhhdC5fX3Byb3RvX18gPSBCdWZmZXIucHJvdG90eXBlCiAgICB9IGVsc2UgewogICAgICAvLyBGYWxsYmFjazogUmV0dXJuIGFuIG9iamVjdCBpbnN0YW5jZSBvZiB0aGUgQnVmZmVyIGNsYXNzCiAgICAgIGlmICh0aGF0ID09PSBudWxsKSB7CiAgICAgICAgdGhhdCA9IG5ldyBCdWZmZXIobGVuZ3RoKQogICAgICB9CiAgICAgIHRoYXQubGVuZ3RoID0gbGVuZ3RoCiAgICB9CiAgCiAgICByZXR1cm4gdGhhdAogIH0KICAKICAvKioKICAgKiBUaGUgQnVmZmVyIGNvbnN0cnVjdG9yIHJldHVybnMgaW5zdGFuY2VzIG9mIGBVaW50OEFycmF5YCB0aGF0IGhhdmUgdGhlaXIKICAgKiBwcm90b3R5cGUgY2hhbmdlZCB0byBgQnVmZmVyLnByb3RvdHlwZWAuIEZ1cnRoZXJtb3JlLCBgQnVmZmVyYCBpcyBhIHN1YmNsYXNzIG9mCiAgICogYFVpbnQ4QXJyYXlgLCBzbyB0aGUgcmV0dXJuZWQgaW5zdGFuY2VzIHdpbGwgaGF2ZSBhbGwgdGhlIG5vZGUgYEJ1ZmZlcmAgbWV0aG9kcwogICAqIGFuZCB0aGUgYFVpbnQ4QXJyYXlgIG1ldGhvZHMuIFNxdWFyZSBicmFja2V0IG5vdGF0aW9uIHdvcmtzIGFzIGV4cGVjdGVkIC0tIGl0CiAgICogcmV0dXJucyBhIHNpbmdsZSBvY3RldC4KICAgKgogICAqIFRoZSBgVWludDhBcnJheWAgcHJvdG90eXBlIHJlbWFpbnMgdW5tb2RpZmllZC4KICAgKi8KICAKICBmdW5jdGlvbiBCdWZmZXIgKGFyZywgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKSB7CiAgICBpZiAoIUJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUICYmICEodGhpcyBpbnN0YW5jZW9mIEJ1ZmZlcikpIHsKICAgICAgcmV0dXJuIG5ldyBCdWZmZXIoYXJnLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpCiAgICB9CiAgCiAgICAvLyBDb21tb24gY2FzZS4KICAgIGlmICh0eXBlb2YgYXJnID09PSAnbnVtYmVyJykgewogICAgICBpZiAodHlwZW9mIGVuY29kaW5nT3JPZmZzZXQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgJ0lmIGVuY29kaW5nIGlzIHNwZWNpZmllZCB0aGVuIHRoZSBmaXJzdCBhcmd1bWVudCBtdXN0IGJlIGEgc3RyaW5nJwogICAgICAgICkKICAgICAgfQogICAgICByZXR1cm4gYWxsb2NVbnNhZmUodGhpcywgYXJnKQogICAgfQogICAgcmV0dXJuIGZyb20odGhpcywgYXJnLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpCiAgfQogIAogIEJ1ZmZlci5wb29sU2l6ZSA9IDgxOTIgLy8gbm90IHVzZWQgYnkgdGhpcyBpbXBsZW1lbnRhdGlvbgogIAogIC8vIFRPRE86IExlZ2FjeSwgbm90IG5lZWRlZCBhbnltb3JlLiBSZW1vdmUgaW4gbmV4dCBtYWpvciB2ZXJzaW9uLgogIEJ1ZmZlci5fYXVnbWVudCA9IGZ1bmN0aW9uIChhcnIpIHsKICAgIGFyci5fX3Byb3RvX18gPSBCdWZmZXIucHJvdG90eXBlCiAgICByZXR1cm4gYXJyCiAgfQogIAogIGZ1bmN0aW9uIGZyb20gKHRoYXQsIHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpIHsKICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJ2YWx1ZSIgYXJndW1lbnQgbXVzdCBub3QgYmUgYSBudW1iZXInKQogICAgfQogIAogICAgaWYgKHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gJ3VuZGVmaW5lZCcgJiYgdmFsdWUgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgewogICAgICByZXR1cm4gZnJvbUFycmF5QnVmZmVyKHRoYXQsIHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpCiAgICB9CiAgCiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gZnJvbVN0cmluZyh0aGF0LCB2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCkKICAgIH0KICAKICAgIHJldHVybiBmcm9tT2JqZWN0KHRoYXQsIHZhbHVlKQogIH0KICAKICAvKioKICAgKiBGdW5jdGlvbmFsbHkgZXF1aXZhbGVudCB0byBCdWZmZXIoYXJnLCBlbmNvZGluZykgYnV0IHRocm93cyBhIFR5cGVFcnJvcgogICAqIGlmIHZhbHVlIGlzIGEgbnVtYmVyLgogICAqIEJ1ZmZlci5mcm9tKHN0clssIGVuY29kaW5nXSkKICAgKiBCdWZmZXIuZnJvbShhcnJheSkKICAgKiBCdWZmZXIuZnJvbShidWZmZXIpCiAgICogQnVmZmVyLmZyb20oYXJyYXlCdWZmZXJbLCBieXRlT2Zmc2V0WywgbGVuZ3RoXV0pCiAgICoqLwogIEJ1ZmZlci5mcm9tID0gZnVuY3Rpb24gKHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpIHsKICAgIHJldHVybiBmcm9tKG51bGwsIHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpCiAgfQogIAogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgQnVmZmVyLnByb3RvdHlwZS5fX3Byb3RvX18gPSBVaW50OEFycmF5LnByb3RvdHlwZQogICAgQnVmZmVyLl9fcHJvdG9fXyA9IFVpbnQ4QXJyYXkKICAgIGlmICh0eXBlb2YgU3ltYm9sICE9PSAndW5kZWZpbmVkJyAmJiBTeW1ib2wuc3BlY2llcyAmJgogICAgICAgIEJ1ZmZlcltTeW1ib2wuc3BlY2llc10gPT09IEJ1ZmZlcikgewogICAgICAvLyBGaXggc3ViYXJyYXkoKSBpbiBFUzIwMTYuIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2Zlcm9zcy9idWZmZXIvcHVsbC85NwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQnVmZmVyLCBTeW1ib2wuc3BlY2llcywgewogICAgICAgIHZhbHVlOiBudWxsLAogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICB9KQogICAgfQogIH0KICAKICBmdW5jdGlvbiBhc3NlcnRTaXplIChzaXplKSB7CiAgICBpZiAodHlwZW9mIHNpemUgIT09ICdudW1iZXInKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJzaXplIiBhcmd1bWVudCBtdXN0IGJlIGEgbnVtYmVyJykKICAgIH0gZWxzZSBpZiAoc2l6ZSA8IDApIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJyJzaXplIiBhcmd1bWVudCBtdXN0IG5vdCBiZSBuZWdhdGl2ZScpCiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGFsbG9jICh0aGF0LCBzaXplLCBmaWxsLCBlbmNvZGluZykgewogICAgYXNzZXJ0U2l6ZShzaXplKQogICAgaWYgKHNpemUgPD0gMCkgewogICAgICByZXR1cm4gY3JlYXRlQnVmZmVyKHRoYXQsIHNpemUpCiAgICB9CiAgICBpZiAoZmlsbCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIC8vIE9ubHkgcGF5IGF0dGVudGlvbiB0byBlbmNvZGluZyBpZiBpdCdzIGEgc3RyaW5nLiBUaGlzCiAgICAgIC8vIHByZXZlbnRzIGFjY2lkZW50YWxseSBzZW5kaW5nIGluIGEgbnVtYmVyIHRoYXQgd291bGQKICAgICAgLy8gYmUgaW50ZXJwcmV0dGVkIGFzIGEgc3RhcnQgb2Zmc2V0LgogICAgICByZXR1cm4gdHlwZW9mIGVuY29kaW5nID09PSAnc3RyaW5nJwogICAgICAgID8gY3JlYXRlQnVmZmVyKHRoYXQsIHNpemUpLmZpbGwoZmlsbCwgZW5jb2RpbmcpCiAgICAgICAgOiBjcmVhdGVCdWZmZXIodGhhdCwgc2l6ZSkuZmlsbChmaWxsKQogICAgfQogICAgcmV0dXJuIGNyZWF0ZUJ1ZmZlcih0aGF0LCBzaXplKQogIH0KICAKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IGZpbGxlZCBCdWZmZXIgaW5zdGFuY2UuCiAgICogYWxsb2Moc2l6ZVssIGZpbGxbLCBlbmNvZGluZ11dKQogICAqKi8KICBCdWZmZXIuYWxsb2MgPSBmdW5jdGlvbiAoc2l6ZSwgZmlsbCwgZW5jb2RpbmcpIHsKICAgIHJldHVybiBhbGxvYyhudWxsLCBzaXplLCBmaWxsLCBlbmNvZGluZykKICB9CiAgCiAgZnVuY3Rpb24gYWxsb2NVbnNhZmUgKHRoYXQsIHNpemUpIHsKICAgIGFzc2VydFNpemUoc2l6ZSkKICAgIHRoYXQgPSBjcmVhdGVCdWZmZXIodGhhdCwgc2l6ZSA8IDAgPyAwIDogY2hlY2tlZChzaXplKSB8IDApCiAgICBpZiAoIUJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2l6ZTsgKytpKSB7CiAgICAgICAgdGhhdFtpXSA9IDAKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoYXQKICB9CiAgCiAgLyoqCiAgICogRXF1aXZhbGVudCB0byBCdWZmZXIobnVtKSwgYnkgZGVmYXVsdCBjcmVhdGVzIGEgbm9uLXplcm8tZmlsbGVkIEJ1ZmZlciBpbnN0YW5jZS4KICAgKiAqLwogIEJ1ZmZlci5hbGxvY1Vuc2FmZSA9IGZ1bmN0aW9uIChzaXplKSB7CiAgICByZXR1cm4gYWxsb2NVbnNhZmUobnVsbCwgc2l6ZSkKICB9CiAgLyoqCiAgICogRXF1aXZhbGVudCB0byBTbG93QnVmZmVyKG51bSksIGJ5IGRlZmF1bHQgY3JlYXRlcyBhIG5vbi16ZXJvLWZpbGxlZCBCdWZmZXIgaW5zdGFuY2UuCiAgICovCiAgQnVmZmVyLmFsbG9jVW5zYWZlU2xvdyA9IGZ1bmN0aW9uIChzaXplKSB7CiAgICByZXR1cm4gYWxsb2NVbnNhZmUobnVsbCwgc2l6ZSkKICB9CiAgCiAgZnVuY3Rpb24gZnJvbVN0cmluZyAodGhhdCwgc3RyaW5nLCBlbmNvZGluZykgewogICAgaWYgKHR5cGVvZiBlbmNvZGluZyAhPT0gJ3N0cmluZycgfHwgZW5jb2RpbmcgPT09ICcnKSB7CiAgICAgIGVuY29kaW5nID0gJ3V0ZjgnCiAgICB9CiAgCiAgICBpZiAoIUJ1ZmZlci5pc0VuY29kaW5nKGVuY29kaW5nKSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCciZW5jb2RpbmciIG11c3QgYmUgYSB2YWxpZCBzdHJpbmcgZW5jb2RpbmcnKQogICAgfQogIAogICAgdmFyIGxlbmd0aCA9IGJ5dGVMZW5ndGgoc3RyaW5nLCBlbmNvZGluZykgfCAwCiAgICB0aGF0ID0gY3JlYXRlQnVmZmVyKHRoYXQsIGxlbmd0aCkKICAKICAgIHZhciBhY3R1YWwgPSB0aGF0LndyaXRlKHN0cmluZywgZW5jb2RpbmcpCiAgCiAgICBpZiAoYWN0dWFsICE9PSBsZW5ndGgpIHsKICAgICAgLy8gV3JpdGluZyBhIGhleCBzdHJpbmcsIGZvciBleGFtcGxlLCB0aGF0IGNvbnRhaW5zIGludmFsaWQgY2hhcmFjdGVycyB3aWxsCiAgICAgIC8vIGNhdXNlIGV2ZXJ5dGhpbmcgYWZ0ZXIgdGhlIGZpcnN0IGludmFsaWQgY2hhcmFjdGVyIHRvIGJlIGlnbm9yZWQuIChlLmcuCiAgICAgIC8vICdhYnh4Y2QnIHdpbGwgYmUgdHJlYXRlZCBhcyAnYWInKQogICAgICB0aGF0ID0gdGhhdC5zbGljZSgwLCBhY3R1YWwpCiAgICB9CiAgCiAgICByZXR1cm4gdGhhdAogIH0KICAKICBmdW5jdGlvbiBmcm9tQXJyYXlMaWtlICh0aGF0LCBhcnJheSkgewogICAgdmFyIGxlbmd0aCA9IGFycmF5Lmxlbmd0aCA8IDAgPyAwIDogY2hlY2tlZChhcnJheS5sZW5ndGgpIHwgMAogICAgdGhhdCA9IGNyZWF0ZUJ1ZmZlcih0aGF0LCBsZW5ndGgpCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAxKSB7CiAgICAgIHRoYXRbaV0gPSBhcnJheVtpXSAmIDI1NQogICAgfQogICAgcmV0dXJuIHRoYXQKICB9CiAgCiAgZnVuY3Rpb24gZnJvbUFycmF5QnVmZmVyICh0aGF0LCBhcnJheSwgYnl0ZU9mZnNldCwgbGVuZ3RoKSB7CiAgICBhcnJheS5ieXRlTGVuZ3RoIC8vIHRoaXMgdGhyb3dzIGlmIGBhcnJheWAgaXMgbm90IGEgdmFsaWQgQXJyYXlCdWZmZXIKICAKICAgIGlmIChieXRlT2Zmc2V0IDwgMCB8fCBhcnJheS5ieXRlTGVuZ3RoIDwgYnl0ZU9mZnNldCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignXCdvZmZzZXRcJyBpcyBvdXQgb2YgYm91bmRzJykKICAgIH0KICAKICAgIGlmIChhcnJheS5ieXRlTGVuZ3RoIDwgYnl0ZU9mZnNldCArIChsZW5ndGggfHwgMCkpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ1wnbGVuZ3RoXCcgaXMgb3V0IG9mIGJvdW5kcycpCiAgICB9CiAgCiAgICBpZiAoYnl0ZU9mZnNldCA9PT0gdW5kZWZpbmVkICYmIGxlbmd0aCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXkpCiAgICB9IGVsc2UgaWYgKGxlbmd0aCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXksIGJ5dGVPZmZzZXQpCiAgICB9IGVsc2UgewogICAgICBhcnJheSA9IG5ldyBVaW50OEFycmF5KGFycmF5LCBieXRlT2Zmc2V0LCBsZW5ndGgpCiAgICB9CiAgCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgLy8gUmV0dXJuIGFuIGF1Z21lbnRlZCBgVWludDhBcnJheWAgaW5zdGFuY2UsIGZvciBiZXN0IHBlcmZvcm1hbmNlCiAgICAgIHRoYXQgPSBhcnJheQogICAgICB0aGF0Ll9fcHJvdG9fXyA9IEJ1ZmZlci5wcm90b3R5cGUKICAgIH0gZWxzZSB7CiAgICAgIC8vIEZhbGxiYWNrOiBSZXR1cm4gYW4gb2JqZWN0IGluc3RhbmNlIG9mIHRoZSBCdWZmZXIgY2xhc3MKICAgICAgdGhhdCA9IGZyb21BcnJheUxpa2UodGhhdCwgYXJyYXkpCiAgICB9CiAgICByZXR1cm4gdGhhdAogIH0KICAKICBmdW5jdGlvbiBmcm9tT2JqZWN0ICh0aGF0LCBvYmopIHsKICAgIGlmIChCdWZmZXIuaXNCdWZmZXIob2JqKSkgewogICAgICB2YXIgbGVuID0gY2hlY2tlZChvYmoubGVuZ3RoKSB8IDAKICAgICAgdGhhdCA9IGNyZWF0ZUJ1ZmZlcih0aGF0LCBsZW4pCiAgCiAgICAgIGlmICh0aGF0Lmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiB0aGF0CiAgICAgIH0KICAKICAgICAgb2JqLmNvcHkodGhhdCwgMCwgMCwgbGVuKQogICAgICByZXR1cm4gdGhhdAogICAgfQogIAogICAgaWYgKG9iaikgewogICAgICBpZiAoKHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gJ3VuZGVmaW5lZCcgJiYKICAgICAgICAgIG9iai5idWZmZXIgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgfHwgJ2xlbmd0aCcgaW4gb2JqKSB7CiAgICAgICAgaWYgKHR5cGVvZiBvYmoubGVuZ3RoICE9PSAnbnVtYmVyJyB8fCBpc25hbihvYmoubGVuZ3RoKSkgewogICAgICAgICAgcmV0dXJuIGNyZWF0ZUJ1ZmZlcih0aGF0LCAwKQogICAgICAgIH0KICAgICAgICByZXR1cm4gZnJvbUFycmF5TGlrZSh0aGF0LCBvYmopCiAgICAgIH0KICAKICAgICAgaWYgKG9iai50eXBlID09PSAnQnVmZmVyJyAmJiBpc0FycmF5KG9iai5kYXRhKSkgewogICAgICAgIHJldHVybiBmcm9tQXJyYXlMaWtlKHRoYXQsIG9iai5kYXRhKQogICAgICB9CiAgICB9CiAgCiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdGaXJzdCBhcmd1bWVudCBtdXN0IGJlIGEgc3RyaW5nLCBCdWZmZXIsIEFycmF5QnVmZmVyLCBBcnJheSwgb3IgYXJyYXktbGlrZSBvYmplY3QuJykKICB9CiAgCiAgZnVuY3Rpb24gY2hlY2tlZCAobGVuZ3RoKSB7CiAgICAvLyBOb3RlOiBjYW5ub3QgdXNlIGBsZW5ndGggPCBrTWF4TGVuZ3RoKClgIGhlcmUgYmVjYXVzZSB0aGF0IGZhaWxzIHdoZW4KICAgIC8vIGxlbmd0aCBpcyBOYU4gKHdoaWNoIGlzIG90aGVyd2lzZSBjb2VyY2VkIHRvIHplcm8uKQogICAgaWYgKGxlbmd0aCA+PSBrTWF4TGVuZ3RoKCkpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0F0dGVtcHQgdG8gYWxsb2NhdGUgQnVmZmVyIGxhcmdlciB0aGFuIG1heGltdW0gJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICdzaXplOiAweCcgKyBrTWF4TGVuZ3RoKCkudG9TdHJpbmcoMTYpICsgJyBieXRlcycpCiAgICB9CiAgICByZXR1cm4gbGVuZ3RoIHwgMAogIH0KICAKICBmdW5jdGlvbiBTbG93QnVmZmVyIChsZW5ndGgpIHsKICAgIGlmICgrbGVuZ3RoICE9IGxlbmd0aCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGVxZXFlcQogICAgICBsZW5ndGggPSAwCiAgICB9CiAgICByZXR1cm4gQnVmZmVyLmFsbG9jKCtsZW5ndGgpCiAgfQogIAogIEJ1ZmZlci5pc0J1ZmZlciA9IGZ1bmN0aW9uIGlzQnVmZmVyIChiKSB7CiAgICByZXR1cm4gISEoYiAhPSBudWxsICYmIGIuX2lzQnVmZmVyKQogIH0KICAKICBCdWZmZXIuY29tcGFyZSA9IGZ1bmN0aW9uIGNvbXBhcmUgKGEsIGIpIHsKICAgIGlmICghQnVmZmVyLmlzQnVmZmVyKGEpIHx8ICFCdWZmZXIuaXNCdWZmZXIoYikpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJndW1lbnRzIG11c3QgYmUgQnVmZmVycycpCiAgICB9CiAgCiAgICBpZiAoYSA9PT0gYikgcmV0dXJuIDAKICAKICAgIHZhciB4ID0gYS5sZW5ndGgKICAgIHZhciB5ID0gYi5sZW5ndGgKICAKICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBNYXRoLm1pbih4LCB5KTsgaSA8IGxlbjsgKytpKSB7CiAgICAgIGlmIChhW2ldICE9PSBiW2ldKSB7CiAgICAgICAgeCA9IGFbaV0KICAgICAgICB5ID0gYltpXQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KICAKICAgIGlmICh4IDwgeSkgcmV0dXJuIC0xCiAgICBpZiAoeSA8IHgpIHJldHVybiAxCiAgICByZXR1cm4gMAogIH0KICAKICBCdWZmZXIuaXNFbmNvZGluZyA9IGZ1bmN0aW9uIGlzRW5jb2RpbmcgKGVuY29kaW5nKSB7CiAgICBzd2l0Y2ggKFN0cmluZyhlbmNvZGluZykudG9Mb3dlckNhc2UoKSkgewogICAgICBjYXNlICdoZXgnOgogICAgICBjYXNlICd1dGY4JzoKICAgICAgY2FzZSAndXRmLTgnOgogICAgICBjYXNlICdhc2NpaSc6CiAgICAgIGNhc2UgJ2xhdGluMSc6CiAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgIGNhc2UgJ3VjczInOgogICAgICBjYXNlICd1Y3MtMic6CiAgICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gZmFsc2UKICAgIH0KICB9CiAgCiAgQnVmZmVyLmNvbmNhdCA9IGZ1bmN0aW9uIGNvbmNhdCAobGlzdCwgbGVuZ3RoKSB7CiAgICBpZiAoIWlzQXJyYXkobGlzdCkpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignImxpc3QiIGFyZ3VtZW50IG11c3QgYmUgYW4gQXJyYXkgb2YgQnVmZmVycycpCiAgICB9CiAgCiAgICBpZiAobGlzdC5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIEJ1ZmZlci5hbGxvYygwKQogICAgfQogIAogICAgdmFyIGkKICAgIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCkgewogICAgICBsZW5ndGggPSAwCiAgICAgIGZvciAoaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgbGVuZ3RoICs9IGxpc3RbaV0ubGVuZ3RoCiAgICAgIH0KICAgIH0KICAKICAgIHZhciBidWZmZXIgPSBCdWZmZXIuYWxsb2NVbnNhZmUobGVuZ3RoKQogICAgdmFyIHBvcyA9IDAKICAgIGZvciAoaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBidWYgPSBsaXN0W2ldCiAgICAgIGlmICghQnVmZmVyLmlzQnVmZmVyKGJ1ZikpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCcibGlzdCIgYXJndW1lbnQgbXVzdCBiZSBhbiBBcnJheSBvZiBCdWZmZXJzJykKICAgICAgfQogICAgICBidWYuY29weShidWZmZXIsIHBvcykKICAgICAgcG9zICs9IGJ1Zi5sZW5ndGgKICAgIH0KICAgIHJldHVybiBidWZmZXIKICB9CiAgCiAgZnVuY3Rpb24gYnl0ZUxlbmd0aCAoc3RyaW5nLCBlbmNvZGluZykgewogICAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihzdHJpbmcpKSB7CiAgICAgIHJldHVybiBzdHJpbmcubGVuZ3RoCiAgICB9CiAgICBpZiAodHlwZW9mIEFycmF5QnVmZmVyICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgQXJyYXlCdWZmZXIuaXNWaWV3ID09PSAnZnVuY3Rpb24nICYmCiAgICAgICAgKEFycmF5QnVmZmVyLmlzVmlldyhzdHJpbmcpIHx8IHN0cmluZyBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSkgewogICAgICByZXR1cm4gc3RyaW5nLmJ5dGVMZW5ndGgKICAgIH0KICAgIGlmICh0eXBlb2Ygc3RyaW5nICE9PSAnc3RyaW5nJykgewogICAgICBzdHJpbmcgPSAnJyArIHN0cmluZwogICAgfQogIAogICAgdmFyIGxlbiA9IHN0cmluZy5sZW5ndGgKICAgIGlmIChsZW4gPT09IDApIHJldHVybiAwCiAgCiAgICAvLyBVc2UgYSBmb3IgbG9vcCB0byBhdm9pZCByZWN1cnNpb24KICAgIHZhciBsb3dlcmVkQ2FzZSA9IGZhbHNlCiAgICBmb3IgKDs7KSB7CiAgICAgIHN3aXRjaCAoZW5jb2RpbmcpIHsKICAgICAgICBjYXNlICdhc2NpaSc6CiAgICAgICAgY2FzZSAnbGF0aW4xJzoKICAgICAgICBjYXNlICdiaW5hcnknOgogICAgICAgICAgcmV0dXJuIGxlbgogICAgICAgIGNhc2UgJ3V0ZjgnOgogICAgICAgIGNhc2UgJ3V0Zi04JzoKICAgICAgICBjYXNlIHVuZGVmaW5lZDoKICAgICAgICAgIHJldHVybiB1dGY4VG9CeXRlcyhzdHJpbmcpLmxlbmd0aAogICAgICAgIGNhc2UgJ3VjczInOgogICAgICAgIGNhc2UgJ3Vjcy0yJzoKICAgICAgICBjYXNlICd1dGYxNmxlJzoKICAgICAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgICAgICByZXR1cm4gbGVuICogMgogICAgICAgIGNhc2UgJ2hleCc6CiAgICAgICAgICByZXR1cm4gbGVuID4+PiAxCiAgICAgICAgY2FzZSAnYmFzZTY0JzoKICAgICAgICAgIHJldHVybiBiYXNlNjRUb0J5dGVzKHN0cmluZykubGVuZ3RoCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGlmIChsb3dlcmVkQ2FzZSkgcmV0dXJuIHV0ZjhUb0J5dGVzKHN0cmluZykubGVuZ3RoIC8vIGFzc3VtZSB1dGY4CiAgICAgICAgICBlbmNvZGluZyA9ICgnJyArIGVuY29kaW5nKS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICBsb3dlcmVkQ2FzZSA9IHRydWUKICAgICAgfQogICAgfQogIH0KICBCdWZmZXIuYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGgKICAKICBmdW5jdGlvbiBzbG93VG9TdHJpbmcgKGVuY29kaW5nLCBzdGFydCwgZW5kKSB7CiAgICB2YXIgbG93ZXJlZENhc2UgPSBmYWxzZQogIAogICAgLy8gTm8gbmVlZCB0byB2ZXJpZnkgdGhhdCAidGhpcy5sZW5ndGggPD0gTUFYX1VJTlQzMiIgc2luY2UgaXQncyBhIHJlYWQtb25seQogICAgLy8gcHJvcGVydHkgb2YgYSB0eXBlZCBhcnJheS4KICAKICAgIC8vIFRoaXMgYmVoYXZlcyBuZWl0aGVyIGxpa2UgU3RyaW5nIG5vciBVaW50OEFycmF5IGluIHRoYXQgd2Ugc2V0IHN0YXJ0L2VuZAogICAgLy8gdG8gdGhlaXIgdXBwZXIvbG93ZXIgYm91bmRzIGlmIHRoZSB2YWx1ZSBwYXNzZWQgaXMgb3V0IG9mIHJhbmdlLgogICAgLy8gdW5kZWZpbmVkIGlzIGhhbmRsZWQgc3BlY2lhbGx5IGFzIHBlciBFQ01BLTI2MiA2dGggRWRpdGlvbiwKICAgIC8vIFNlY3Rpb24gMTMuMy4zLjcgUnVudGltZSBTZW1hbnRpY3M6IEtleWVkQmluZGluZ0luaXRpYWxpemF0aW9uLgogICAgaWYgKHN0YXJ0ID09PSB1bmRlZmluZWQgfHwgc3RhcnQgPCAwKSB7CiAgICAgIHN0YXJ0ID0gMAogICAgfQogICAgLy8gUmV0dXJuIGVhcmx5IGlmIHN0YXJ0ID4gdGhpcy5sZW5ndGguIERvbmUgaGVyZSB0byBwcmV2ZW50IHBvdGVudGlhbCB1aW50MzIKICAgIC8vIGNvZXJjaW9uIGZhaWwgYmVsb3cuCiAgICBpZiAoc3RhcnQgPiB0aGlzLmxlbmd0aCkgewogICAgICByZXR1cm4gJycKICAgIH0KICAKICAgIGlmIChlbmQgPT09IHVuZGVmaW5lZCB8fCBlbmQgPiB0aGlzLmxlbmd0aCkgewogICAgICBlbmQgPSB0aGlzLmxlbmd0aAogICAgfQogIAogICAgaWYgKGVuZCA8PSAwKSB7CiAgICAgIHJldHVybiAnJwogICAgfQogIAogICAgLy8gRm9yY2UgY29lcnNpb24gdG8gdWludDMyLiBUaGlzIHdpbGwgYWxzbyBjb2VyY2UgZmFsc2V5L05hTiB2YWx1ZXMgdG8gMC4KICAgIGVuZCA+Pj49IDAKICAgIHN0YXJ0ID4+Pj0gMAogIAogICAgaWYgKGVuZCA8PSBzdGFydCkgewogICAgICByZXR1cm4gJycKICAgIH0KICAKICAgIGlmICghZW5jb2RpbmcpIGVuY29kaW5nID0gJ3V0ZjgnCiAgCiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBzd2l0Y2ggKGVuY29kaW5nKSB7CiAgICAgICAgY2FzZSAnaGV4JzoKICAgICAgICAgIHJldHVybiBoZXhTbGljZSh0aGlzLCBzdGFydCwgZW5kKQogIAogICAgICAgIGNhc2UgJ3V0ZjgnOgogICAgICAgIGNhc2UgJ3V0Zi04JzoKICAgICAgICAgIHJldHVybiB1dGY4U2xpY2UodGhpcywgc3RhcnQsIGVuZCkKICAKICAgICAgICBjYXNlICdhc2NpaSc6CiAgICAgICAgICByZXR1cm4gYXNjaWlTbGljZSh0aGlzLCBzdGFydCwgZW5kKQogIAogICAgICAgIGNhc2UgJ2xhdGluMSc6CiAgICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgICAgIHJldHVybiBsYXRpbjFTbGljZSh0aGlzLCBzdGFydCwgZW5kKQogIAogICAgICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgICAgICByZXR1cm4gYmFzZTY0U2xpY2UodGhpcywgc3RhcnQsIGVuZCkKICAKICAgICAgICBjYXNlICd1Y3MyJzoKICAgICAgICBjYXNlICd1Y3MtMic6CiAgICAgICAgY2FzZSAndXRmMTZsZSc6CiAgICAgICAgY2FzZSAndXRmLTE2bGUnOgogICAgICAgICAgcmV0dXJuIHV0ZjE2bGVTbGljZSh0aGlzLCBzdGFydCwgZW5kKQogIAogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBpZiAobG93ZXJlZENhc2UpIHRocm93IG5ldyBUeXBlRXJyb3IoJ1Vua25vd24gZW5jb2Rpbmc6ICcgKyBlbmNvZGluZykKICAgICAgICAgIGVuY29kaW5nID0gKGVuY29kaW5nICsgJycpLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIGxvd2VyZWRDYXNlID0gdHJ1ZQogICAgICB9CiAgICB9CiAgfQogIAogIC8vIFRoZSBwcm9wZXJ0eSBpcyB1c2VkIGJ5IGBCdWZmZXIuaXNCdWZmZXJgIGFuZCBgaXMtYnVmZmVyYCAoaW4gU2FmYXJpIDUtNykgdG8gZGV0ZWN0CiAgLy8gQnVmZmVyIGluc3RhbmNlcy4KICBCdWZmZXIucHJvdG90eXBlLl9pc0J1ZmZlciA9IHRydWUKICAKICBmdW5jdGlvbiBzd2FwIChiLCBuLCBtKSB7CiAgICB2YXIgaSA9IGJbbl0KICAgIGJbbl0gPSBiW21dCiAgICBiW21dID0gaQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnN3YXAxNiA9IGZ1bmN0aW9uIHN3YXAxNiAoKSB7CiAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGgKICAgIGlmIChsZW4gJSAyICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdCdWZmZXIgc2l6ZSBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMTYtYml0cycpCiAgICB9CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSArPSAyKSB7CiAgICAgIHN3YXAodGhpcywgaSwgaSArIDEpCiAgICB9CiAgICByZXR1cm4gdGhpcwogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnN3YXAzMiA9IGZ1bmN0aW9uIHN3YXAzMiAoKSB7CiAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGgKICAgIGlmIChsZW4gJSA0ICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdCdWZmZXIgc2l6ZSBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMzItYml0cycpCiAgICB9CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSArPSA0KSB7CiAgICAgIHN3YXAodGhpcywgaSwgaSArIDMpCiAgICAgIHN3YXAodGhpcywgaSArIDEsIGkgKyAyKQogICAgfQogICAgcmV0dXJuIHRoaXMKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5zd2FwNjQgPSBmdW5jdGlvbiBzd2FwNjQgKCkgewogICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoCiAgICBpZiAobGVuICUgOCAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDY0LWJpdHMnKQogICAgfQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkgKz0gOCkgewogICAgICBzd2FwKHRoaXMsIGksIGkgKyA3KQogICAgICBzd2FwKHRoaXMsIGkgKyAxLCBpICsgNikKICAgICAgc3dhcCh0aGlzLCBpICsgMiwgaSArIDUpCiAgICAgIHN3YXAodGhpcywgaSArIDMsIGkgKyA0KQogICAgfQogICAgcmV0dXJuIHRoaXMKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uIHRvU3RyaW5nICgpIHsKICAgIHZhciBsZW5ndGggPSB0aGlzLmxlbmd0aCB8IDAKICAgIGlmIChsZW5ndGggPT09IDApIHJldHVybiAnJwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHJldHVybiB1dGY4U2xpY2UodGhpcywgMCwgbGVuZ3RoKQogICAgcmV0dXJuIHNsb3dUb1N0cmluZy5hcHBseSh0aGlzLCBhcmd1bWVudHMpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24gZXF1YWxzIChiKSB7CiAgICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihiKSkgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJndW1lbnQgbXVzdCBiZSBhIEJ1ZmZlcicpCiAgICBpZiAodGhpcyA9PT0gYikgcmV0dXJuIHRydWUKICAgIHJldHVybiBCdWZmZXIuY29tcGFyZSh0aGlzLCBiKSA9PT0gMAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLmluc3BlY3QgPSBmdW5jdGlvbiBpbnNwZWN0ICgpIHsKICAgIHZhciBzdHIgPSAnJwogICAgdmFyIG1heCA9IGV4cG9ydHMuSU5TUEVDVF9NQVhfQllURVMKICAgIGlmICh0aGlzLmxlbmd0aCA+IDApIHsKICAgICAgc3RyID0gdGhpcy50b1N0cmluZygnaGV4JywgMCwgbWF4KS5tYXRjaCgvLnsyfS9nKS5qb2luKCcgJykKICAgICAgaWYgKHRoaXMubGVuZ3RoID4gbWF4KSBzdHIgKz0gJyAuLi4gJwogICAgfQogICAgcmV0dXJuICc8QnVmZmVyICcgKyBzdHIgKyAnPicKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5jb21wYXJlID0gZnVuY3Rpb24gY29tcGFyZSAodGFyZ2V0LCBzdGFydCwgZW5kLCB0aGlzU3RhcnQsIHRoaXNFbmQpIHsKICAgIGlmICghQnVmZmVyLmlzQnVmZmVyKHRhcmdldCkpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJndW1lbnQgbXVzdCBiZSBhIEJ1ZmZlcicpCiAgICB9CiAgCiAgICBpZiAoc3RhcnQgPT09IHVuZGVmaW5lZCkgewogICAgICBzdGFydCA9IDAKICAgIH0KICAgIGlmIChlbmQgPT09IHVuZGVmaW5lZCkgewogICAgICBlbmQgPSB0YXJnZXQgPyB0YXJnZXQubGVuZ3RoIDogMAogICAgfQogICAgaWYgKHRoaXNTdGFydCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHRoaXNTdGFydCA9IDAKICAgIH0KICAgIGlmICh0aGlzRW5kID09PSB1bmRlZmluZWQpIHsKICAgICAgdGhpc0VuZCA9IHRoaXMubGVuZ3RoCiAgICB9CiAgCiAgICBpZiAoc3RhcnQgPCAwIHx8IGVuZCA+IHRhcmdldC5sZW5ndGggfHwgdGhpc1N0YXJ0IDwgMCB8fCB0aGlzRW5kID4gdGhpcy5sZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ291dCBvZiByYW5nZSBpbmRleCcpCiAgICB9CiAgCiAgICBpZiAodGhpc1N0YXJ0ID49IHRoaXNFbmQgJiYgc3RhcnQgPj0gZW5kKSB7CiAgICAgIHJldHVybiAwCiAgICB9CiAgICBpZiAodGhpc1N0YXJ0ID49IHRoaXNFbmQpIHsKICAgICAgcmV0dXJuIC0xCiAgICB9CiAgICBpZiAoc3RhcnQgPj0gZW5kKSB7CiAgICAgIHJldHVybiAxCiAgICB9CiAgCiAgICBzdGFydCA+Pj49IDAKICAgIGVuZCA+Pj49IDAKICAgIHRoaXNTdGFydCA+Pj49IDAKICAgIHRoaXNFbmQgPj4+PSAwCiAgCiAgICBpZiAodGhpcyA9PT0gdGFyZ2V0KSByZXR1cm4gMAogIAogICAgdmFyIHggPSB0aGlzRW5kIC0gdGhpc1N0YXJ0CiAgICB2YXIgeSA9IGVuZCAtIHN0YXJ0CiAgICB2YXIgbGVuID0gTWF0aC5taW4oeCwgeSkKICAKICAgIHZhciB0aGlzQ29weSA9IHRoaXMuc2xpY2UodGhpc1N0YXJ0LCB0aGlzRW5kKQogICAgdmFyIHRhcmdldENvcHkgPSB0YXJnZXQuc2xpY2Uoc3RhcnQsIGVuZCkKICAKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgICAgaWYgKHRoaXNDb3B5W2ldICE9PSB0YXJnZXRDb3B5W2ldKSB7CiAgICAgICAgeCA9IHRoaXNDb3B5W2ldCiAgICAgICAgeSA9IHRhcmdldENvcHlbaV0KICAgICAgICBicmVhawogICAgICB9CiAgICB9CiAgCiAgICBpZiAoeCA8IHkpIHJldHVybiAtMQogICAgaWYgKHkgPCB4KSByZXR1cm4gMQogICAgcmV0dXJuIDAKICB9CiAgCiAgLy8gRmluZHMgZWl0aGVyIHRoZSBmaXJzdCBpbmRleCBvZiBgdmFsYCBpbiBgYnVmZmVyYCBhdCBvZmZzZXQgPj0gYGJ5dGVPZmZzZXRgLAogIC8vIE9SIHRoZSBsYXN0IGluZGV4IG9mIGB2YWxgIGluIGBidWZmZXJgIGF0IG9mZnNldCA8PSBgYnl0ZU9mZnNldGAuCiAgLy8KICAvLyBBcmd1bWVudHM6CiAgLy8gLSBidWZmZXIgLSBhIEJ1ZmZlciB0byBzZWFyY2gKICAvLyAtIHZhbCAtIGEgc3RyaW5nLCBCdWZmZXIsIG9yIG51bWJlcgogIC8vIC0gYnl0ZU9mZnNldCAtIGFuIGluZGV4IGludG8gYGJ1ZmZlcmA7IHdpbGwgYmUgY2xhbXBlZCB0byBhbiBpbnQzMgogIC8vIC0gZW5jb2RpbmcgLSBhbiBvcHRpb25hbCBlbmNvZGluZywgcmVsZXZhbnQgaXMgdmFsIGlzIGEgc3RyaW5nCiAgLy8gLSBkaXIgLSB0cnVlIGZvciBpbmRleE9mLCBmYWxzZSBmb3IgbGFzdEluZGV4T2YKICBmdW5jdGlvbiBiaWRpcmVjdGlvbmFsSW5kZXhPZiAoYnVmZmVyLCB2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCBkaXIpIHsKICAgIC8vIEVtcHR5IGJ1ZmZlciBtZWFucyBubyBtYXRjaAogICAgaWYgKGJ1ZmZlci5sZW5ndGggPT09IDApIHJldHVybiAtMQogIAogICAgLy8gTm9ybWFsaXplIGJ5dGVPZmZzZXQKICAgIGlmICh0eXBlb2YgYnl0ZU9mZnNldCA9PT0gJ3N0cmluZycpIHsKICAgICAgZW5jb2RpbmcgPSBieXRlT2Zmc2V0CiAgICAgIGJ5dGVPZmZzZXQgPSAwCiAgICB9IGVsc2UgaWYgKGJ5dGVPZmZzZXQgPiAweDdmZmZmZmZmKSB7CiAgICAgIGJ5dGVPZmZzZXQgPSAweDdmZmZmZmZmCiAgICB9IGVsc2UgaWYgKGJ5dGVPZmZzZXQgPCAtMHg4MDAwMDAwMCkgewogICAgICBieXRlT2Zmc2V0ID0gLTB4ODAwMDAwMDAKICAgIH0KICAgIGJ5dGVPZmZzZXQgPSArYnl0ZU9mZnNldCAgLy8gQ29lcmNlIHRvIE51bWJlci4KICAgIGlmIChpc05hTihieXRlT2Zmc2V0KSkgewogICAgICAvLyBieXRlT2Zmc2V0OiBpdCBpdCdzIHVuZGVmaW5lZCwgbnVsbCwgTmFOLCAiZm9vIiwgZXRjLCBzZWFyY2ggd2hvbGUgYnVmZmVyCiAgICAgIGJ5dGVPZmZzZXQgPSBkaXIgPyAwIDogKGJ1ZmZlci5sZW5ndGggLSAxKQogICAgfQogIAogICAgLy8gTm9ybWFsaXplIGJ5dGVPZmZzZXQ6IG5lZ2F0aXZlIG9mZnNldHMgc3RhcnQgZnJvbSB0aGUgZW5kIG9mIHRoZSBidWZmZXIKICAgIGlmIChieXRlT2Zmc2V0IDwgMCkgYnl0ZU9mZnNldCA9IGJ1ZmZlci5sZW5ndGggKyBieXRlT2Zmc2V0CiAgICBpZiAoYnl0ZU9mZnNldCA+PSBidWZmZXIubGVuZ3RoKSB7CiAgICAgIGlmIChkaXIpIHJldHVybiAtMQogICAgICBlbHNlIGJ5dGVPZmZzZXQgPSBidWZmZXIubGVuZ3RoIC0gMQogICAgfSBlbHNlIGlmIChieXRlT2Zmc2V0IDwgMCkgewogICAgICBpZiAoZGlyKSBieXRlT2Zmc2V0ID0gMAogICAgICBlbHNlIHJldHVybiAtMQogICAgfQogIAogICAgLy8gTm9ybWFsaXplIHZhbAogICAgaWYgKHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnKSB7CiAgICAgIHZhbCA9IEJ1ZmZlci5mcm9tKHZhbCwgZW5jb2RpbmcpCiAgICB9CiAgCiAgICAvLyBGaW5hbGx5LCBzZWFyY2ggZWl0aGVyIGluZGV4T2YgKGlmIGRpciBpcyB0cnVlKSBvciBsYXN0SW5kZXhPZgogICAgaWYgKEJ1ZmZlci5pc0J1ZmZlcih2YWwpKSB7CiAgICAgIC8vIFNwZWNpYWwgY2FzZTogbG9va2luZyBmb3IgZW1wdHkgc3RyaW5nL2J1ZmZlciBhbHdheXMgZmFpbHMKICAgICAgaWYgKHZhbC5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gLTEKICAgICAgfQogICAgICByZXR1cm4gYXJyYXlJbmRleE9mKGJ1ZmZlciwgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZGlyKQogICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgICB2YWwgPSB2YWwgJiAweEZGIC8vIFNlYXJjaCBmb3IgYSBieXRlIHZhbHVlIFswLTI1NV0KICAgICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUICYmCiAgICAgICAgICB0eXBlb2YgVWludDhBcnJheS5wcm90b3R5cGUuaW5kZXhPZiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGlmIChkaXIpIHsKICAgICAgICAgIHJldHVybiBVaW50OEFycmF5LnByb3RvdHlwZS5pbmRleE9mLmNhbGwoYnVmZmVyLCB2YWwsIGJ5dGVPZmZzZXQpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBVaW50OEFycmF5LnByb3RvdHlwZS5sYXN0SW5kZXhPZi5jYWxsKGJ1ZmZlciwgdmFsLCBieXRlT2Zmc2V0KQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gYXJyYXlJbmRleE9mKGJ1ZmZlciwgWyB2YWwgXSwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGRpcikKICAgIH0KICAKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ3ZhbCBtdXN0IGJlIHN0cmluZywgbnVtYmVyIG9yIEJ1ZmZlcicpCiAgfQogIAogIGZ1bmN0aW9uIGFycmF5SW5kZXhPZiAoYXJyLCB2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCBkaXIpIHsKICAgIHZhciBpbmRleFNpemUgPSAxCiAgICB2YXIgYXJyTGVuZ3RoID0gYXJyLmxlbmd0aAogICAgdmFyIHZhbExlbmd0aCA9IHZhbC5sZW5ndGgKICAKICAgIGlmIChlbmNvZGluZyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGVuY29kaW5nID0gU3RyaW5nKGVuY29kaW5nKS50b0xvd2VyQ2FzZSgpCiAgICAgIGlmIChlbmNvZGluZyA9PT0gJ3VjczInIHx8IGVuY29kaW5nID09PSAndWNzLTInIHx8CiAgICAgICAgICBlbmNvZGluZyA9PT0gJ3V0ZjE2bGUnIHx8IGVuY29kaW5nID09PSAndXRmLTE2bGUnKSB7CiAgICAgICAgaWYgKGFyci5sZW5ndGggPCAyIHx8IHZhbC5sZW5ndGggPCAyKSB7CiAgICAgICAgICByZXR1cm4gLTEKICAgICAgICB9CiAgICAgICAgaW5kZXhTaXplID0gMgogICAgICAgIGFyckxlbmd0aCAvPSAyCiAgICAgICAgdmFsTGVuZ3RoIC89IDIKICAgICAgICBieXRlT2Zmc2V0IC89IDIKICAgICAgfQogICAgfQogIAogICAgZnVuY3Rpb24gcmVhZCAoYnVmLCBpKSB7CiAgICAgIGlmIChpbmRleFNpemUgPT09IDEpIHsKICAgICAgICByZXR1cm4gYnVmW2ldCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGJ1Zi5yZWFkVUludDE2QkUoaSAqIGluZGV4U2l6ZSkKICAgICAgfQogICAgfQogIAogICAgdmFyIGkKICAgIGlmIChkaXIpIHsKICAgICAgdmFyIGZvdW5kSW5kZXggPSAtMQogICAgICBmb3IgKGkgPSBieXRlT2Zmc2V0OyBpIDwgYXJyTGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAocmVhZChhcnIsIGkpID09PSByZWFkKHZhbCwgZm91bmRJbmRleCA9PT0gLTEgPyAwIDogaSAtIGZvdW5kSW5kZXgpKSB7CiAgICAgICAgICBpZiAoZm91bmRJbmRleCA9PT0gLTEpIGZvdW5kSW5kZXggPSBpCiAgICAgICAgICBpZiAoaSAtIGZvdW5kSW5kZXggKyAxID09PSB2YWxMZW5ndGgpIHJldHVybiBmb3VuZEluZGV4ICogaW5kZXhTaXplCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChmb3VuZEluZGV4ICE9PSAtMSkgaSAtPSBpIC0gZm91bmRJbmRleAogICAgICAgICAgZm91bmRJbmRleCA9IC0xCiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoYnl0ZU9mZnNldCArIHZhbExlbmd0aCA+IGFyckxlbmd0aCkgYnl0ZU9mZnNldCA9IGFyckxlbmd0aCAtIHZhbExlbmd0aAogICAgICBmb3IgKGkgPSBieXRlT2Zmc2V0OyBpID49IDA7IGktLSkgewogICAgICAgIHZhciBmb3VuZCA9IHRydWUKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHZhbExlbmd0aDsgaisrKSB7CiAgICAgICAgICBpZiAocmVhZChhcnIsIGkgKyBqKSAhPT0gcmVhZCh2YWwsIGopKSB7CiAgICAgICAgICAgIGZvdW5kID0gZmFsc2UKICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGZvdW5kKSByZXR1cm4gaQogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gLTEKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5pbmNsdWRlcyA9IGZ1bmN0aW9uIGluY2x1ZGVzICh2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKSB7CiAgICByZXR1cm4gdGhpcy5pbmRleE9mKHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpICE9PSAtMQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLmluZGV4T2YgPSBmdW5jdGlvbiBpbmRleE9mICh2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKSB7CiAgICByZXR1cm4gYmlkaXJlY3Rpb25hbEluZGV4T2YodGhpcywgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgdHJ1ZSkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5sYXN0SW5kZXhPZiA9IGZ1bmN0aW9uIGxhc3RJbmRleE9mICh2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKSB7CiAgICByZXR1cm4gYmlkaXJlY3Rpb25hbEluZGV4T2YodGhpcywgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZmFsc2UpCiAgfQogIAogIGZ1bmN0aW9uIGhleFdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIG9mZnNldCA9IE51bWJlcihvZmZzZXQpIHx8IDAKICAgIHZhciByZW1haW5pbmcgPSBidWYubGVuZ3RoIC0gb2Zmc2V0CiAgICBpZiAoIWxlbmd0aCkgewogICAgICBsZW5ndGggPSByZW1haW5pbmcKICAgIH0gZWxzZSB7CiAgICAgIGxlbmd0aCA9IE51bWJlcihsZW5ndGgpCiAgICAgIGlmIChsZW5ndGggPiByZW1haW5pbmcpIHsKICAgICAgICBsZW5ndGggPSByZW1haW5pbmcKICAgICAgfQogICAgfQogIAogICAgLy8gbXVzdCBiZSBhbiBldmVuIG51bWJlciBvZiBkaWdpdHMKICAgIHZhciBzdHJMZW4gPSBzdHJpbmcubGVuZ3RoCiAgICBpZiAoc3RyTGVuICUgMiAhPT0gMCkgdGhyb3cgbmV3IFR5cGVFcnJvcignSW52YWxpZCBoZXggc3RyaW5nJykKICAKICAgIGlmIChsZW5ndGggPiBzdHJMZW4gLyAyKSB7CiAgICAgIGxlbmd0aCA9IHN0ckxlbiAvIDIKICAgIH0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgdmFyIHBhcnNlZCA9IHBhcnNlSW50KHN0cmluZy5zdWJzdHIoaSAqIDIsIDIpLCAxNikKICAgICAgaWYgKGlzTmFOKHBhcnNlZCkpIHJldHVybiBpCiAgICAgIGJ1ZltvZmZzZXQgKyBpXSA9IHBhcnNlZAogICAgfQogICAgcmV0dXJuIGkKICB9CiAgCiAgZnVuY3Rpb24gdXRmOFdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIHJldHVybiBibGl0QnVmZmVyKHV0ZjhUb0J5dGVzKHN0cmluZywgYnVmLmxlbmd0aCAtIG9mZnNldCksIGJ1Ziwgb2Zmc2V0LCBsZW5ndGgpCiAgfQogIAogIGZ1bmN0aW9uIGFzY2lpV3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogICAgcmV0dXJuIGJsaXRCdWZmZXIoYXNjaWlUb0J5dGVzKHN0cmluZyksIGJ1Ziwgb2Zmc2V0LCBsZW5ndGgpCiAgfQogIAogIGZ1bmN0aW9uIGxhdGluMVdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIHJldHVybiBhc2NpaVdyaXRlKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKICB9CiAgCiAgZnVuY3Rpb24gYmFzZTY0V3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogICAgcmV0dXJuIGJsaXRCdWZmZXIoYmFzZTY0VG9CeXRlcyhzdHJpbmcpLCBidWYsIG9mZnNldCwgbGVuZ3RoKQogIH0KICAKICBmdW5jdGlvbiB1Y3MyV3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogICAgcmV0dXJuIGJsaXRCdWZmZXIodXRmMTZsZVRvQnl0ZXMoc3RyaW5nLCBidWYubGVuZ3RoIC0gb2Zmc2V0KSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZSA9IGZ1bmN0aW9uIHdyaXRlIChzdHJpbmcsIG9mZnNldCwgbGVuZ3RoLCBlbmNvZGluZykgewogICAgLy8gQnVmZmVyI3dyaXRlKHN0cmluZykKICAgIGlmIChvZmZzZXQgPT09IHVuZGVmaW5lZCkgewogICAgICBlbmNvZGluZyA9ICd1dGY4JwogICAgICBsZW5ndGggPSB0aGlzLmxlbmd0aAogICAgICBvZmZzZXQgPSAwCiAgICAvLyBCdWZmZXIjd3JpdGUoc3RyaW5nLCBlbmNvZGluZykKICAgIH0gZWxzZSBpZiAobGVuZ3RoID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIG9mZnNldCA9PT0gJ3N0cmluZycpIHsKICAgICAgZW5jb2RpbmcgPSBvZmZzZXQKICAgICAgbGVuZ3RoID0gdGhpcy5sZW5ndGgKICAgICAgb2Zmc2V0ID0gMAogICAgLy8gQnVmZmVyI3dyaXRlKHN0cmluZywgb2Zmc2V0WywgbGVuZ3RoXVssIGVuY29kaW5nXSkKICAgIH0gZWxzZSBpZiAoaXNGaW5pdGUob2Zmc2V0KSkgewogICAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICAgIGlmIChpc0Zpbml0ZShsZW5ndGgpKSB7CiAgICAgICAgbGVuZ3RoID0gbGVuZ3RoIHwgMAogICAgICAgIGlmIChlbmNvZGluZyA9PT0gdW5kZWZpbmVkKSBlbmNvZGluZyA9ICd1dGY4JwogICAgICB9IGVsc2UgewogICAgICAgIGVuY29kaW5nID0gbGVuZ3RoCiAgICAgICAgbGVuZ3RoID0gdW5kZWZpbmVkCiAgICAgIH0KICAgIC8vIGxlZ2FjeSB3cml0ZShzdHJpbmcsIGVuY29kaW5nLCBvZmZzZXQsIGxlbmd0aCkgLSByZW1vdmUgaW4gdjAuMTMKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAnQnVmZmVyLndyaXRlKHN0cmluZywgZW5jb2RpbmcsIG9mZnNldFssIGxlbmd0aF0pIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQnCiAgICAgICkKICAgIH0KICAKICAgIHZhciByZW1haW5pbmcgPSB0aGlzLmxlbmd0aCAtIG9mZnNldAogICAgaWYgKGxlbmd0aCA9PT0gdW5kZWZpbmVkIHx8IGxlbmd0aCA+IHJlbWFpbmluZykgbGVuZ3RoID0gcmVtYWluaW5nCiAgCiAgICBpZiAoKHN0cmluZy5sZW5ndGggPiAwICYmIChsZW5ndGggPCAwIHx8IG9mZnNldCA8IDApKSB8fCBvZmZzZXQgPiB0aGlzLmxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQXR0ZW1wdCB0byB3cml0ZSBvdXRzaWRlIGJ1ZmZlciBib3VuZHMnKQogICAgfQogIAogICAgaWYgKCFlbmNvZGluZykgZW5jb2RpbmcgPSAndXRmOCcKICAKICAgIHZhciBsb3dlcmVkQ2FzZSA9IGZhbHNlCiAgICBmb3IgKDs7KSB7CiAgICAgIHN3aXRjaCAoZW5jb2RpbmcpIHsKICAgICAgICBjYXNlICdoZXgnOgogICAgICAgICAgcmV0dXJuIGhleFdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgCiAgICAgICAgY2FzZSAndXRmOCc6CiAgICAgICAgY2FzZSAndXRmLTgnOgogICAgICAgICAgcmV0dXJuIHV0ZjhXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogIAogICAgICAgIGNhc2UgJ2FzY2lpJzoKICAgICAgICAgIHJldHVybiBhc2NpaVdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgCiAgICAgICAgY2FzZSAnbGF0aW4xJzoKICAgICAgICBjYXNlICdiaW5hcnknOgogICAgICAgICAgcmV0dXJuIGxhdGluMVdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgCiAgICAgICAgY2FzZSAnYmFzZTY0JzoKICAgICAgICAgIC8vIFdhcm5pbmc6IG1heExlbmd0aCBub3QgdGFrZW4gaW50byBhY2NvdW50IGluIGJhc2U2NFdyaXRlCiAgICAgICAgICByZXR1cm4gYmFzZTY0V3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKICAKICAgICAgICBjYXNlICd1Y3MyJzoKICAgICAgICBjYXNlICd1Y3MtMic6CiAgICAgICAgY2FzZSAndXRmMTZsZSc6CiAgICAgICAgY2FzZSAndXRmLTE2bGUnOgogICAgICAgICAgcmV0dXJuIHVjczJXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogIAogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBpZiAobG93ZXJlZENhc2UpIHRocm93IG5ldyBUeXBlRXJyb3IoJ1Vua25vd24gZW5jb2Rpbmc6ICcgKyBlbmNvZGluZykKICAgICAgICAgIGVuY29kaW5nID0gKCcnICsgZW5jb2RpbmcpLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIGxvd2VyZWRDYXNlID0gdHJ1ZQogICAgICB9CiAgICB9CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gdG9KU09OICgpIHsKICAgIHJldHVybiB7CiAgICAgIHR5cGU6ICdCdWZmZXInLAogICAgICBkYXRhOiBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0aGlzLl9hcnIgfHwgdGhpcywgMCkKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gYmFzZTY0U2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogICAgaWYgKHN0YXJ0ID09PSAwICYmIGVuZCA9PT0gYnVmLmxlbmd0aCkgewogICAgICByZXR1cm4gYmFzZTY0LmZyb21CeXRlQXJyYXkoYnVmKQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGJhc2U2NC5mcm9tQnl0ZUFycmF5KGJ1Zi5zbGljZShzdGFydCwgZW5kKSkKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gdXRmOFNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICAgIGVuZCA9IE1hdGgubWluKGJ1Zi5sZW5ndGgsIGVuZCkKICAgIHZhciByZXMgPSBbXQogIAogICAgdmFyIGkgPSBzdGFydAogICAgd2hpbGUgKGkgPCBlbmQpIHsKICAgICAgdmFyIGZpcnN0Qnl0ZSA9IGJ1ZltpXQogICAgICB2YXIgY29kZVBvaW50ID0gbnVsbAogICAgICB2YXIgYnl0ZXNQZXJTZXF1ZW5jZSA9IChmaXJzdEJ5dGUgPiAweEVGKSA/IDQKICAgICAgICA6IChmaXJzdEJ5dGUgPiAweERGKSA/IDMKICAgICAgICA6IChmaXJzdEJ5dGUgPiAweEJGKSA/IDIKICAgICAgICA6IDEKICAKICAgICAgaWYgKGkgKyBieXRlc1BlclNlcXVlbmNlIDw9IGVuZCkgewogICAgICAgIHZhciBzZWNvbmRCeXRlLCB0aGlyZEJ5dGUsIGZvdXJ0aEJ5dGUsIHRlbXBDb2RlUG9pbnQKICAKICAgICAgICBzd2l0Y2ggKGJ5dGVzUGVyU2VxdWVuY2UpIHsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgaWYgKGZpcnN0Qnl0ZSA8IDB4ODApIHsKICAgICAgICAgICAgICBjb2RlUG9pbnQgPSBmaXJzdEJ5dGUKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICBzZWNvbmRCeXRlID0gYnVmW2kgKyAxXQogICAgICAgICAgICBpZiAoKHNlY29uZEJ5dGUgJiAweEMwKSA9PT0gMHg4MCkgewogICAgICAgICAgICAgIHRlbXBDb2RlUG9pbnQgPSAoZmlyc3RCeXRlICYgMHgxRikgPDwgMHg2IHwgKHNlY29uZEJ5dGUgJiAweDNGKQogICAgICAgICAgICAgIGlmICh0ZW1wQ29kZVBvaW50ID4gMHg3RikgewogICAgICAgICAgICAgICAgY29kZVBvaW50ID0gdGVtcENvZGVQb2ludAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICBzZWNvbmRCeXRlID0gYnVmW2kgKyAxXQogICAgICAgICAgICB0aGlyZEJ5dGUgPSBidWZbaSArIDJdCiAgICAgICAgICAgIGlmICgoc2Vjb25kQnl0ZSAmIDB4QzApID09PSAweDgwICYmICh0aGlyZEJ5dGUgJiAweEMwKSA9PT0gMHg4MCkgewogICAgICAgICAgICAgIHRlbXBDb2RlUG9pbnQgPSAoZmlyc3RCeXRlICYgMHhGKSA8PCAweEMgfCAoc2Vjb25kQnl0ZSAmIDB4M0YpIDw8IDB4NiB8ICh0aGlyZEJ5dGUgJiAweDNGKQogICAgICAgICAgICAgIGlmICh0ZW1wQ29kZVBvaW50ID4gMHg3RkYgJiYgKHRlbXBDb2RlUG9pbnQgPCAweEQ4MDAgfHwgdGVtcENvZGVQb2ludCA+IDB4REZGRikpIHsKICAgICAgICAgICAgICAgIGNvZGVQb2ludCA9IHRlbXBDb2RlUG9pbnQKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgc2Vjb25kQnl0ZSA9IGJ1ZltpICsgMV0KICAgICAgICAgICAgdGhpcmRCeXRlID0gYnVmW2kgKyAyXQogICAgICAgICAgICBmb3VydGhCeXRlID0gYnVmW2kgKyAzXQogICAgICAgICAgICBpZiAoKHNlY29uZEJ5dGUgJiAweEMwKSA9PT0gMHg4MCAmJiAodGhpcmRCeXRlICYgMHhDMCkgPT09IDB4ODAgJiYgKGZvdXJ0aEJ5dGUgJiAweEMwKSA9PT0gMHg4MCkgewogICAgICAgICAgICAgIHRlbXBDb2RlUG9pbnQgPSAoZmlyc3RCeXRlICYgMHhGKSA8PCAweDEyIHwgKHNlY29uZEJ5dGUgJiAweDNGKSA8PCAweEMgfCAodGhpcmRCeXRlICYgMHgzRikgPDwgMHg2IHwgKGZvdXJ0aEJ5dGUgJiAweDNGKQogICAgICAgICAgICAgIGlmICh0ZW1wQ29kZVBvaW50ID4gMHhGRkZGICYmIHRlbXBDb2RlUG9pbnQgPCAweDExMDAwMCkgewogICAgICAgICAgICAgICAgY29kZVBvaW50ID0gdGVtcENvZGVQb2ludAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogIAogICAgICBpZiAoY29kZVBvaW50ID09PSBudWxsKSB7CiAgICAgICAgLy8gd2UgZGlkIG5vdCBnZW5lcmF0ZSBhIHZhbGlkIGNvZGVQb2ludCBzbyBpbnNlcnQgYQogICAgICAgIC8vIHJlcGxhY2VtZW50IGNoYXIgKFUrRkZGRCkgYW5kIGFkdmFuY2Ugb25seSAxIGJ5dGUKICAgICAgICBjb2RlUG9pbnQgPSAweEZGRkQKICAgICAgICBieXRlc1BlclNlcXVlbmNlID0gMQogICAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA+IDB4RkZGRikgewogICAgICAgIC8vIGVuY29kZSB0byB1dGYxNiAoc3Vycm9nYXRlIHBhaXIgZGFuY2UpCiAgICAgICAgY29kZVBvaW50IC09IDB4MTAwMDAKICAgICAgICByZXMucHVzaChjb2RlUG9pbnQgPj4+IDEwICYgMHgzRkYgfCAweEQ4MDApCiAgICAgICAgY29kZVBvaW50ID0gMHhEQzAwIHwgY29kZVBvaW50ICYgMHgzRkYKICAgICAgfQogIAogICAgICByZXMucHVzaChjb2RlUG9pbnQpCiAgICAgIGkgKz0gYnl0ZXNQZXJTZXF1ZW5jZQogICAgfQogIAogICAgcmV0dXJuIGRlY29kZUNvZGVQb2ludHNBcnJheShyZXMpCiAgfQogIAogIC8vIEJhc2VkIG9uIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzIyNzQ3MjcyLzY4MDc0MiwgdGhlIGJyb3dzZXIgd2l0aAogIC8vIHRoZSBsb3dlc3QgbGltaXQgaXMgQ2hyb21lLCB3aXRoIDB4MTAwMDAgYXJncy4KICAvLyBXZSBnbyAxIG1hZ25pdHVkZSBsZXNzLCBmb3Igc2FmZXR5CiAgdmFyIE1BWF9BUkdVTUVOVFNfTEVOR1RIID0gMHgxMDAwCiAgCiAgZnVuY3Rpb24gZGVjb2RlQ29kZVBvaW50c0FycmF5IChjb2RlUG9pbnRzKSB7CiAgICB2YXIgbGVuID0gY29kZVBvaW50cy5sZW5ndGgKICAgIGlmIChsZW4gPD0gTUFYX0FSR1VNRU5UU19MRU5HVEgpIHsKICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoU3RyaW5nLCBjb2RlUG9pbnRzKSAvLyBhdm9pZCBleHRyYSBzbGljZSgpCiAgICB9CiAgCiAgICAvLyBEZWNvZGUgaW4gY2h1bmtzIHRvIGF2b2lkICJjYWxsIHN0YWNrIHNpemUgZXhjZWVkZWQiLgogICAgdmFyIHJlcyA9ICcnCiAgICB2YXIgaSA9IDAKICAgIHdoaWxlIChpIDwgbGVuKSB7CiAgICAgIHJlcyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KAogICAgICAgIFN0cmluZywKICAgICAgICBjb2RlUG9pbnRzLnNsaWNlKGksIGkgKz0gTUFYX0FSR1VNRU5UU19MRU5HVEgpCiAgICAgICkKICAgIH0KICAgIHJldHVybiByZXMKICB9CiAgCiAgZnVuY3Rpb24gYXNjaWlTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgICB2YXIgcmV0ID0gJycKICAgIGVuZCA9IE1hdGgubWluKGJ1Zi5sZW5ndGgsIGVuZCkKICAKICAgIGZvciAodmFyIGkgPSBzdGFydDsgaSA8IGVuZDsgKytpKSB7CiAgICAgIHJldCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ1ZltpXSAmIDB4N0YpCiAgICB9CiAgICByZXR1cm4gcmV0CiAgfQogIAogIGZ1bmN0aW9uIGxhdGluMVNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICAgIHZhciByZXQgPSAnJwogICAgZW5kID0gTWF0aC5taW4oYnVmLmxlbmd0aCwgZW5kKQogIAogICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgZW5kOyArK2kpIHsKICAgICAgcmV0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnVmW2ldKQogICAgfQogICAgcmV0dXJuIHJldAogIH0KICAKICBmdW5jdGlvbiBoZXhTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgICB2YXIgbGVuID0gYnVmLmxlbmd0aAogIAogICAgaWYgKCFzdGFydCB8fCBzdGFydCA8IDApIHN0YXJ0ID0gMAogICAgaWYgKCFlbmQgfHwgZW5kIDwgMCB8fCBlbmQgPiBsZW4pIGVuZCA9IGxlbgogIAogICAgdmFyIG91dCA9ICcnCiAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7ICsraSkgewogICAgICBvdXQgKz0gdG9IZXgoYnVmW2ldKQogICAgfQogICAgcmV0dXJuIG91dAogIH0KICAKICBmdW5jdGlvbiB1dGYxNmxlU2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogICAgdmFyIGJ5dGVzID0gYnVmLnNsaWNlKHN0YXJ0LCBlbmQpCiAgICB2YXIgcmVzID0gJycKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYnl0ZXMubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgcmVzICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnl0ZXNbaV0gKyBieXRlc1tpICsgMV0gKiAyNTYpCiAgICB9CiAgICByZXR1cm4gcmVzCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuc2xpY2UgPSBmdW5jdGlvbiBzbGljZSAoc3RhcnQsIGVuZCkgewogICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoCiAgICBzdGFydCA9IH5+c3RhcnQKICAgIGVuZCA9IGVuZCA9PT0gdW5kZWZpbmVkID8gbGVuIDogfn5lbmQKICAKICAgIGlmIChzdGFydCA8IDApIHsKICAgICAgc3RhcnQgKz0gbGVuCiAgICAgIGlmIChzdGFydCA8IDApIHN0YXJ0ID0gMAogICAgfSBlbHNlIGlmIChzdGFydCA+IGxlbikgewogICAgICBzdGFydCA9IGxlbgogICAgfQogIAogICAgaWYgKGVuZCA8IDApIHsKICAgICAgZW5kICs9IGxlbgogICAgICBpZiAoZW5kIDwgMCkgZW5kID0gMAogICAgfSBlbHNlIGlmIChlbmQgPiBsZW4pIHsKICAgICAgZW5kID0gbGVuCiAgICB9CiAgCiAgICBpZiAoZW5kIDwgc3RhcnQpIGVuZCA9IHN0YXJ0CiAgCiAgICB2YXIgbmV3QnVmCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgbmV3QnVmID0gdGhpcy5zdWJhcnJheShzdGFydCwgZW5kKQogICAgICBuZXdCdWYuX19wcm90b19fID0gQnVmZmVyLnByb3RvdHlwZQogICAgfSBlbHNlIHsKICAgICAgdmFyIHNsaWNlTGVuID0gZW5kIC0gc3RhcnQKICAgICAgbmV3QnVmID0gbmV3IEJ1ZmZlcihzbGljZUxlbiwgdW5kZWZpbmVkKQogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNsaWNlTGVuOyArK2kpIHsKICAgICAgICBuZXdCdWZbaV0gPSB0aGlzW2kgKyBzdGFydF0KICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIG5ld0J1ZgogIH0KICAKICAvKgogICAqIE5lZWQgdG8gbWFrZSBzdXJlIHRoYXQgYnVmZmVyIGlzbid0IHRyeWluZyB0byB3cml0ZSBvdXQgb2YgYm91bmRzLgogICAqLwogIGZ1bmN0aW9uIGNoZWNrT2Zmc2V0IChvZmZzZXQsIGV4dCwgbGVuZ3RoKSB7CiAgICBpZiAoKG9mZnNldCAlIDEpICE9PSAwIHx8IG9mZnNldCA8IDApIHRocm93IG5ldyBSYW5nZUVycm9yKCdvZmZzZXQgaXMgbm90IHVpbnQnKQogICAgaWYgKG9mZnNldCArIGV4dCA+IGxlbmd0aCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ1RyeWluZyB0byBhY2Nlc3MgYmV5b25kIGJ1ZmZlciBsZW5ndGgnKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50TEUgPSBmdW5jdGlvbiByZWFkVUludExFIChvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgYnl0ZUxlbmd0aCwgdGhpcy5sZW5ndGgpCiAgCiAgICB2YXIgdmFsID0gdGhpc1tvZmZzZXRdCiAgICB2YXIgbXVsID0gMQogICAgdmFyIGkgPSAwCiAgICB3aGlsZSAoKytpIDwgYnl0ZUxlbmd0aCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICB2YWwgKz0gdGhpc1tvZmZzZXQgKyBpXSAqIG11bAogICAgfQogIAogICAgcmV0dXJuIHZhbAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50QkUgPSBmdW5jdGlvbiByZWFkVUludEJFIChvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIHsKICAgICAgY2hlY2tPZmZzZXQob2Zmc2V0LCBieXRlTGVuZ3RoLCB0aGlzLmxlbmd0aCkKICAgIH0KICAKICAgIHZhciB2YWwgPSB0aGlzW29mZnNldCArIC0tYnl0ZUxlbmd0aF0KICAgIHZhciBtdWwgPSAxCiAgICB3aGlsZSAoYnl0ZUxlbmd0aCA+IDAgJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgdmFsICs9IHRoaXNbb2Zmc2V0ICsgLS1ieXRlTGVuZ3RoXSAqIG11bAogICAgfQogIAogICAgcmV0dXJuIHZhbAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50OCA9IGZ1bmN0aW9uIHJlYWRVSW50OCAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAxLCB0aGlzLmxlbmd0aCkKICAgIHJldHVybiB0aGlzW29mZnNldF0KICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDE2TEUgPSBmdW5jdGlvbiByZWFkVUludDE2TEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpCiAgICByZXR1cm4gdGhpc1tvZmZzZXRdIHwgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDE2QkUgPSBmdW5jdGlvbiByZWFkVUludDE2QkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpCiAgICByZXR1cm4gKHRoaXNbb2Zmc2V0XSA8PCA4KSB8IHRoaXNbb2Zmc2V0ICsgMV0KICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDMyTEUgPSBmdW5jdGlvbiByZWFkVUludDMyTEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCiAgCiAgICByZXR1cm4gKCh0aGlzW29mZnNldF0pIHwKICAgICAgICAodGhpc1tvZmZzZXQgKyAxXSA8PCA4KSB8CiAgICAgICAgKHRoaXNbb2Zmc2V0ICsgMl0gPDwgMTYpKSArCiAgICAgICAgKHRoaXNbb2Zmc2V0ICsgM10gKiAweDEwMDAwMDApCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQzMkJFID0gZnVuY3Rpb24gcmVhZFVJbnQzMkJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQogIAogICAgcmV0dXJuICh0aGlzW29mZnNldF0gKiAweDEwMDAwMDApICsKICAgICAgKCh0aGlzW29mZnNldCArIDFdIDw8IDE2KSB8CiAgICAgICh0aGlzW29mZnNldCArIDJdIDw8IDgpIHwKICAgICAgdGhpc1tvZmZzZXQgKyAzXSkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50TEUgPSBmdW5jdGlvbiByZWFkSW50TEUgKG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCBieXRlTGVuZ3RoLCB0aGlzLmxlbmd0aCkKICAKICAgIHZhciB2YWwgPSB0aGlzW29mZnNldF0KICAgIHZhciBtdWwgPSAxCiAgICB2YXIgaSA9IDAKICAgIHdoaWxlICgrK2kgPCBieXRlTGVuZ3RoICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICAgIHZhbCArPSB0aGlzW29mZnNldCArIGldICogbXVsCiAgICB9CiAgICBtdWwgKj0gMHg4MAogIAogICAgaWYgKHZhbCA+PSBtdWwpIHZhbCAtPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCkKICAKICAgIHJldHVybiB2YWwKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50QkUgPSBmdW5jdGlvbiByZWFkSW50QkUgKG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCBieXRlTGVuZ3RoLCB0aGlzLmxlbmd0aCkKICAKICAgIHZhciBpID0gYnl0ZUxlbmd0aAogICAgdmFyIG11bCA9IDEKICAgIHZhciB2YWwgPSB0aGlzW29mZnNldCArIC0taV0KICAgIHdoaWxlIChpID4gMCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICB2YWwgKz0gdGhpc1tvZmZzZXQgKyAtLWldICogbXVsCiAgICB9CiAgICBtdWwgKj0gMHg4MAogIAogICAgaWYgKHZhbCA+PSBtdWwpIHZhbCAtPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCkKICAKICAgIHJldHVybiB2YWwKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50OCA9IGZ1bmN0aW9uIHJlYWRJbnQ4IChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDEsIHRoaXMubGVuZ3RoKQogICAgaWYgKCEodGhpc1tvZmZzZXRdICYgMHg4MCkpIHJldHVybiAodGhpc1tvZmZzZXRdKQogICAgcmV0dXJuICgoMHhmZiAtIHRoaXNbb2Zmc2V0XSArIDEpICogLTEpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludDE2TEUgPSBmdW5jdGlvbiByZWFkSW50MTZMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCkKICAgIHZhciB2YWwgPSB0aGlzW29mZnNldF0gfCAodGhpc1tvZmZzZXQgKyAxXSA8PCA4KQogICAgcmV0dXJuICh2YWwgJiAweDgwMDApID8gdmFsIHwgMHhGRkZGMDAwMCA6IHZhbAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQxNkJFID0gZnVuY3Rpb24gcmVhZEludDE2QkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpCiAgICB2YXIgdmFsID0gdGhpc1tvZmZzZXQgKyAxXSB8ICh0aGlzW29mZnNldF0gPDwgOCkKICAgIHJldHVybiAodmFsICYgMHg4MDAwKSA/IHZhbCB8IDB4RkZGRjAwMDAgOiB2YWwKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50MzJMRSA9IGZ1bmN0aW9uIHJlYWRJbnQzMkxFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQogIAogICAgcmV0dXJuICh0aGlzW29mZnNldF0pIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCkgfAogICAgICAodGhpc1tvZmZzZXQgKyAyXSA8PCAxNikgfAogICAgICAodGhpc1tvZmZzZXQgKyAzXSA8PCAyNCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50MzJCRSA9IGZ1bmN0aW9uIHJlYWRJbnQzMkJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQogIAogICAgcmV0dXJuICh0aGlzW29mZnNldF0gPDwgMjQpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgMTYpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMl0gPDwgOCkgfAogICAgICAodGhpc1tvZmZzZXQgKyAzXSkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkRmxvYXRMRSA9IGZ1bmN0aW9uIHJlYWRGbG9hdExFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQogICAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIHRydWUsIDIzLCA0KQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRGbG9hdEJFID0gZnVuY3Rpb24gcmVhZEZsb2F0QkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCiAgICByZXR1cm4gaWVlZTc1NC5yZWFkKHRoaXMsIG9mZnNldCwgZmFsc2UsIDIzLCA0KQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWREb3VibGVMRSA9IGZ1bmN0aW9uIHJlYWREb3VibGVMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA4LCB0aGlzLmxlbmd0aCkKICAgIHJldHVybiBpZWVlNzU0LnJlYWQodGhpcywgb2Zmc2V0LCB0cnVlLCA1MiwgOCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkRG91YmxlQkUgPSBmdW5jdGlvbiByZWFkRG91YmxlQkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgOCwgdGhpcy5sZW5ndGgpCiAgICByZXR1cm4gaWVlZTc1NC5yZWFkKHRoaXMsIG9mZnNldCwgZmFsc2UsIDUyLCA4KQogIH0KICAKICBmdW5jdGlvbiBjaGVja0ludCAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBleHQsIG1heCwgbWluKSB7CiAgICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihidWYpKSB0aHJvdyBuZXcgVHlwZUVycm9yKCciYnVmZmVyIiBhcmd1bWVudCBtdXN0IGJlIGEgQnVmZmVyIGluc3RhbmNlJykKICAgIGlmICh2YWx1ZSA+IG1heCB8fCB2YWx1ZSA8IG1pbikgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJyJ2YWx1ZSIgYXJndW1lbnQgaXMgb3V0IG9mIGJvdW5kcycpCiAgICBpZiAob2Zmc2V0ICsgZXh0ID4gYnVmLmxlbmd0aCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0luZGV4IG91dCBvZiByYW5nZScpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50TEUgPSBmdW5jdGlvbiB3cml0ZVVJbnRMRSAodmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIHsKICAgICAgdmFyIG1heEJ5dGVzID0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgpIC0gMQogICAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBtYXhCeXRlcywgMCkKICAgIH0KICAKICAgIHZhciBtdWwgPSAxCiAgICB2YXIgaSA9IDAKICAgIHRoaXNbb2Zmc2V0XSA9IHZhbHVlICYgMHhGRgogICAgd2hpbGUgKCsraSA8IGJ5dGVMZW5ndGggJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgdGhpc1tvZmZzZXQgKyBpXSA9ICh2YWx1ZSAvIG11bCkgJiAweEZGCiAgICB9CiAgCiAgICByZXR1cm4gb2Zmc2V0ICsgYnl0ZUxlbmd0aAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlVUludEJFID0gZnVuY3Rpb24gd3JpdGVVSW50QkUgKHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIHZhciBtYXhCeXRlcyA9IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoKSAtIDEKICAgICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbWF4Qnl0ZXMsIDApCiAgICB9CiAgCiAgICB2YXIgaSA9IGJ5dGVMZW5ndGggLSAxCiAgICB2YXIgbXVsID0gMQogICAgdGhpc1tvZmZzZXQgKyBpXSA9IHZhbHVlICYgMHhGRgogICAgd2hpbGUgKC0taSA+PSAwICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSAodmFsdWUgLyBtdWwpICYgMHhGRgogICAgfQogIAogICAgcmV0dXJuIG9mZnNldCArIGJ5dGVMZW5ndGgKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnQ4ID0gZnVuY3Rpb24gd3JpdGVVSW50OCAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAxLCAweGZmLCAwKQogICAgaWYgKCFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgdmFsdWUgPSBNYXRoLmZsb29yKHZhbHVlKQogICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICAgIHJldHVybiBvZmZzZXQgKyAxCiAgfQogIAogIGZ1bmN0aW9uIG9iamVjdFdyaXRlVUludDE2IChidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbikgewogICAgaWYgKHZhbHVlIDwgMCkgdmFsdWUgPSAweGZmZmYgKyB2YWx1ZSArIDEKICAgIGZvciAodmFyIGkgPSAwLCBqID0gTWF0aC5taW4oYnVmLmxlbmd0aCAtIG9mZnNldCwgMik7IGkgPCBqOyArK2kpIHsKICAgICAgYnVmW29mZnNldCArIGldID0gKHZhbHVlICYgKDB4ZmYgPDwgKDggKiAobGl0dGxlRW5kaWFuID8gaSA6IDEgLSBpKSkpKSA+Pj4KICAgICAgICAobGl0dGxlRW5kaWFuID8gaSA6IDEgLSBpKSAqIDgKICAgIH0KICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnQxNkxFID0gZnVuY3Rpb24gd3JpdGVVSW50MTZMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweGZmZmYsIDApCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICAgICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gOCkKICAgIH0gZWxzZSB7CiAgICAgIG9iamVjdFdyaXRlVUludDE2KHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUpCiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgMgogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDE2QkUgPSBmdW5jdGlvbiB3cml0ZVVJbnQxNkJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDIsIDB4ZmZmZiwgMCkKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDgpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgJiAweGZmKQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UpCiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgMgogIH0KICAKICBmdW5jdGlvbiBvYmplY3RXcml0ZVVJbnQzMiAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4pIHsKICAgIGlmICh2YWx1ZSA8IDApIHZhbHVlID0gMHhmZmZmZmZmZiArIHZhbHVlICsgMQogICAgZm9yICh2YXIgaSA9IDAsIGogPSBNYXRoLm1pbihidWYubGVuZ3RoIC0gb2Zmc2V0LCA0KTsgaSA8IGo7ICsraSkgewogICAgICBidWZbb2Zmc2V0ICsgaV0gPSAodmFsdWUgPj4+IChsaXR0bGVFbmRpYW4gPyBpIDogMyAtIGkpICogOCkgJiAweGZmCiAgICB9CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50MzJMRSA9IGZ1bmN0aW9uIHdyaXRlVUludDMyTEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgNCwgMHhmZmZmZmZmZiwgMCkKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldCArIDNdID0gKHZhbHVlID4+PiAyNCkKICAgICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gMTYpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDgpCiAgICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDQKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnQzMkJFID0gZnVuY3Rpb24gd3JpdGVVSW50MzJCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweGZmZmZmZmZmLCAwKQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSA+Pj4gMjQpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDE2KQogICAgICB0aGlzW29mZnNldCArIDJdID0gKHZhbHVlID4+PiA4KQogICAgICB0aGlzW29mZnNldCArIDNdID0gKHZhbHVlICYgMHhmZikKICAgIH0gZWxzZSB7CiAgICAgIG9iamVjdFdyaXRlVUludDMyKHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDQKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUludExFID0gZnVuY3Rpb24gd3JpdGVJbnRMRSAodmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIHZhciBsaW1pdCA9IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoIC0gMSkKICAKICAgICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbGltaXQgLSAxLCAtbGltaXQpCiAgICB9CiAgCiAgICB2YXIgaSA9IDAKICAgIHZhciBtdWwgPSAxCiAgICB2YXIgc3ViID0gMAogICAgdGhpc1tvZmZzZXRdID0gdmFsdWUgJiAweEZGCiAgICB3aGlsZSAoKytpIDwgYnl0ZUxlbmd0aCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICBpZiAodmFsdWUgPCAwICYmIHN1YiA9PT0gMCAmJiB0aGlzW29mZnNldCArIGkgLSAxXSAhPT0gMCkgewogICAgICAgIHN1YiA9IDEKICAgICAgfQogICAgICB0aGlzW29mZnNldCArIGldID0gKCh2YWx1ZSAvIG11bCkgPj4gMCkgLSBzdWIgJiAweEZGCiAgICB9CiAgCiAgICByZXR1cm4gb2Zmc2V0ICsgYnl0ZUxlbmd0aAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlSW50QkUgPSBmdW5jdGlvbiB3cml0ZUludEJFICh2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIHsKICAgICAgdmFyIGxpbWl0ID0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGggLSAxKQogIAogICAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBsaW1pdCAtIDEsIC1saW1pdCkKICAgIH0KICAKICAgIHZhciBpID0gYnl0ZUxlbmd0aCAtIDEKICAgIHZhciBtdWwgPSAxCiAgICB2YXIgc3ViID0gMAogICAgdGhpc1tvZmZzZXQgKyBpXSA9IHZhbHVlICYgMHhGRgogICAgd2hpbGUgKC0taSA+PSAwICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICAgIGlmICh2YWx1ZSA8IDAgJiYgc3ViID09PSAwICYmIHRoaXNbb2Zmc2V0ICsgaSArIDFdICE9PSAwKSB7CiAgICAgICAgc3ViID0gMQogICAgICB9CiAgICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSAoKHZhbHVlIC8gbXVsKSA+PiAwKSAtIHN1YiAmIDB4RkYKICAgIH0KICAKICAgIHJldHVybiBvZmZzZXQgKyBieXRlTGVuZ3RoCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQ4ID0gZnVuY3Rpb24gd3JpdGVJbnQ4ICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDEsIDB4N2YsIC0weDgwKQogICAgaWYgKCFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgdmFsdWUgPSBNYXRoLmZsb29yKHZhbHVlKQogICAgaWYgKHZhbHVlIDwgMCkgdmFsdWUgPSAweGZmICsgdmFsdWUgKyAxCiAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogICAgcmV0dXJuIG9mZnNldCArIDEKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDE2TEUgPSBmdW5jdGlvbiB3cml0ZUludDE2TEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMiwgMHg3ZmZmLCAtMHg4MDAwKQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDgpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQxNih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDIKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDE2QkUgPSBmdW5jdGlvbiB3cml0ZUludDE2QkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMiwgMHg3ZmZmLCAtMHg4MDAwKQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSA+Pj4gOCkKICAgICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQxNih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyAyCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQzMkxFID0gZnVuY3Rpb24gd3JpdGVJbnQzMkxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDQsIDB4N2ZmZmZmZmYsIC0weDgwMDAwMDAwKQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDgpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMl0gPSAodmFsdWUgPj4+IDE2KQogICAgICB0aGlzW29mZnNldCArIDNdID0gKHZhbHVlID4+PiAyNCkKICAgIH0gZWxzZSB7CiAgICAgIG9iamVjdFdyaXRlVUludDMyKHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUpCiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgNAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlSW50MzJCRSA9IGZ1bmN0aW9uIHdyaXRlSW50MzJCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweDdmZmZmZmZmLCAtMHg4MDAwMDAwMCkKICAgIGlmICh2YWx1ZSA8IDApIHZhbHVlID0gMHhmZmZmZmZmZiArIHZhbHVlICsgMQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSA+Pj4gMjQpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDE2KQogICAgICB0aGlzW29mZnNldCArIDJdID0gKHZhbHVlID4+PiA4KQogICAgICB0aGlzW29mZnNldCArIDNdID0gKHZhbHVlICYgMHhmZikKICAgIH0gZWxzZSB7CiAgICAgIG9iamVjdFdyaXRlVUludDMyKHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDQKICB9CiAgCiAgZnVuY3Rpb24gY2hlY2tJRUVFNzU0IChidWYsIHZhbHVlLCBvZmZzZXQsIGV4dCwgbWF4LCBtaW4pIHsKICAgIGlmIChvZmZzZXQgKyBleHQgPiBidWYubGVuZ3RoKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW5kZXggb3V0IG9mIHJhbmdlJykKICAgIGlmIChvZmZzZXQgPCAwKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW5kZXggb3V0IG9mIHJhbmdlJykKICB9CiAgCiAgZnVuY3Rpb24gd3JpdGVGbG9hdCAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIGNoZWNrSUVFRTc1NChidWYsIHZhbHVlLCBvZmZzZXQsIDQsIDMuNDAyODIzNDY2Mzg1Mjg4NmUrMzgsIC0zLjQwMjgyMzQ2NjM4NTI4ODZlKzM4KQogICAgfQogICAgaWVlZTc1NC53cml0ZShidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbiwgMjMsIDQpCiAgICByZXR1cm4gb2Zmc2V0ICsgNAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlRmxvYXRMRSA9IGZ1bmN0aW9uIHdyaXRlRmxvYXRMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHJldHVybiB3cml0ZUZsb2F0KHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUsIG5vQXNzZXJ0KQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlRmxvYXRCRSA9IGZ1bmN0aW9uIHdyaXRlRmxvYXRCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHJldHVybiB3cml0ZUZsb2F0KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlLCBub0Fzc2VydCkKICB9CiAgCiAgZnVuY3Rpb24gd3JpdGVEb3VibGUgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgewogICAgICBjaGVja0lFRUU3NTQoYnVmLCB2YWx1ZSwgb2Zmc2V0LCA4LCAxLjc5NzY5MzEzNDg2MjMxNTdFKzMwOCwgLTEuNzk3NjkzMTM0ODYyMzE1N0UrMzA4KQogICAgfQogICAgaWVlZTc1NC53cml0ZShidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbiwgNTIsIDgpCiAgICByZXR1cm4gb2Zmc2V0ICsgOAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlRG91YmxlTEUgPSBmdW5jdGlvbiB3cml0ZURvdWJsZUxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgcmV0dXJuIHdyaXRlRG91YmxlKHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUsIG5vQXNzZXJ0KQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlRG91YmxlQkUgPSBmdW5jdGlvbiB3cml0ZURvdWJsZUJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgcmV0dXJuIHdyaXRlRG91YmxlKHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlLCBub0Fzc2VydCkKICB9CiAgCiAgLy8gY29weSh0YXJnZXRCdWZmZXIsIHRhcmdldFN0YXJ0PTAsIHNvdXJjZVN0YXJ0PTAsIHNvdXJjZUVuZD1idWZmZXIubGVuZ3RoKQogIEJ1ZmZlci5wcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uIGNvcHkgKHRhcmdldCwgdGFyZ2V0U3RhcnQsIHN0YXJ0LCBlbmQpIHsKICAgIGlmICghc3RhcnQpIHN0YXJ0ID0gMAogICAgaWYgKCFlbmQgJiYgZW5kICE9PSAwKSBlbmQgPSB0aGlzLmxlbmd0aAogICAgaWYgKHRhcmdldFN0YXJ0ID49IHRhcmdldC5sZW5ndGgpIHRhcmdldFN0YXJ0ID0gdGFyZ2V0Lmxlbmd0aAogICAgaWYgKCF0YXJnZXRTdGFydCkgdGFyZ2V0U3RhcnQgPSAwCiAgICBpZiAoZW5kID4gMCAmJiBlbmQgPCBzdGFydCkgZW5kID0gc3RhcnQKICAKICAgIC8vIENvcHkgMCBieXRlczsgd2UncmUgZG9uZQogICAgaWYgKGVuZCA9PT0gc3RhcnQpIHJldHVybiAwCiAgICBpZiAodGFyZ2V0Lmxlbmd0aCA9PT0gMCB8fCB0aGlzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIDAKICAKICAgIC8vIEZhdGFsIGVycm9yIGNvbmRpdGlvbnMKICAgIGlmICh0YXJnZXRTdGFydCA8IDApIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ3RhcmdldFN0YXJ0IG91dCBvZiBib3VuZHMnKQogICAgfQogICAgaWYgKHN0YXJ0IDwgMCB8fCBzdGFydCA+PSB0aGlzLmxlbmd0aCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ3NvdXJjZVN0YXJ0IG91dCBvZiBib3VuZHMnKQogICAgaWYgKGVuZCA8IDApIHRocm93IG5ldyBSYW5nZUVycm9yKCdzb3VyY2VFbmQgb3V0IG9mIGJvdW5kcycpCiAgCiAgICAvLyBBcmUgd2Ugb29iPwogICAgaWYgKGVuZCA+IHRoaXMubGVuZ3RoKSBlbmQgPSB0aGlzLmxlbmd0aAogICAgaWYgKHRhcmdldC5sZW5ndGggLSB0YXJnZXRTdGFydCA8IGVuZCAtIHN0YXJ0KSB7CiAgICAgIGVuZCA9IHRhcmdldC5sZW5ndGggLSB0YXJnZXRTdGFydCArIHN0YXJ0CiAgICB9CiAgCiAgICB2YXIgbGVuID0gZW5kIC0gc3RhcnQKICAgIHZhciBpCiAgCiAgICBpZiAodGhpcyA9PT0gdGFyZ2V0ICYmIHN0YXJ0IDwgdGFyZ2V0U3RhcnQgJiYgdGFyZ2V0U3RhcnQgPCBlbmQpIHsKICAgICAgLy8gZGVzY2VuZGluZyBjb3B5IGZyb20gZW5kCiAgICAgIGZvciAoaSA9IGxlbiAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgdGFyZ2V0W2kgKyB0YXJnZXRTdGFydF0gPSB0aGlzW2kgKyBzdGFydF0KICAgICAgfQogICAgfSBlbHNlIGlmIChsZW4gPCAxMDAwIHx8ICFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICAvLyBhc2NlbmRpbmcgY29weSBmcm9tIHN0YXJ0CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICAgIHRhcmdldFtpICsgdGFyZ2V0U3RhcnRdID0gdGhpc1tpICsgc3RhcnRdCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIFVpbnQ4QXJyYXkucHJvdG90eXBlLnNldC5jYWxsKAogICAgICAgIHRhcmdldCwKICAgICAgICB0aGlzLnN1YmFycmF5KHN0YXJ0LCBzdGFydCArIGxlbiksCiAgICAgICAgdGFyZ2V0U3RhcnQKICAgICAgKQogICAgfQogIAogICAgcmV0dXJuIGxlbgogIH0KICAKICAvLyBVc2FnZToKICAvLyAgICBidWZmZXIuZmlsbChudW1iZXJbLCBvZmZzZXRbLCBlbmRdXSkKICAvLyAgICBidWZmZXIuZmlsbChidWZmZXJbLCBvZmZzZXRbLCBlbmRdXSkKICAvLyAgICBidWZmZXIuZmlsbChzdHJpbmdbLCBvZmZzZXRbLCBlbmRdXVssIGVuY29kaW5nXSkKICBCdWZmZXIucHJvdG90eXBlLmZpbGwgPSBmdW5jdGlvbiBmaWxsICh2YWwsIHN0YXJ0LCBlbmQsIGVuY29kaW5nKSB7CiAgICAvLyBIYW5kbGUgc3RyaW5nIGNhc2VzOgogICAgaWYgKHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnKSB7CiAgICAgIGlmICh0eXBlb2Ygc3RhcnQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgZW5jb2RpbmcgPSBzdGFydAogICAgICAgIHN0YXJ0ID0gMAogICAgICAgIGVuZCA9IHRoaXMubGVuZ3RoCiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGVuZCA9PT0gJ3N0cmluZycpIHsKICAgICAgICBlbmNvZGluZyA9IGVuZAogICAgICAgIGVuZCA9IHRoaXMubGVuZ3RoCiAgICAgIH0KICAgICAgaWYgKHZhbC5sZW5ndGggPT09IDEpIHsKICAgICAgICB2YXIgY29kZSA9IHZhbC5jaGFyQ29kZUF0KDApCiAgICAgICAgaWYgKGNvZGUgPCAyNTYpIHsKICAgICAgICAgIHZhbCA9IGNvZGUKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGVuY29kaW5nICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIGVuY29kaW5nICE9PSAnc3RyaW5nJykgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2VuY29kaW5nIG11c3QgYmUgYSBzdHJpbmcnKQogICAgICB9CiAgICAgIGlmICh0eXBlb2YgZW5jb2RpbmcgPT09ICdzdHJpbmcnICYmICFCdWZmZXIuaXNFbmNvZGluZyhlbmNvZGluZykpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jb2RpbmcpCiAgICAgIH0KICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpIHsKICAgICAgdmFsID0gdmFsICYgMjU1CiAgICB9CiAgCiAgICAvLyBJbnZhbGlkIHJhbmdlcyBhcmUgbm90IHNldCB0byBhIGRlZmF1bHQsIHNvIGNhbiByYW5nZSBjaGVjayBlYXJseS4KICAgIGlmIChzdGFydCA8IDAgfHwgdGhpcy5sZW5ndGggPCBzdGFydCB8fCB0aGlzLmxlbmd0aCA8IGVuZCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignT3V0IG9mIHJhbmdlIGluZGV4JykKICAgIH0KICAKICAgIGlmIChlbmQgPD0gc3RhcnQpIHsKICAgICAgcmV0dXJuIHRoaXMKICAgIH0KICAKICAgIHN0YXJ0ID0gc3RhcnQgPj4+IDAKICAgIGVuZCA9IGVuZCA9PT0gdW5kZWZpbmVkID8gdGhpcy5sZW5ndGggOiBlbmQgPj4+IDAKICAKICAgIGlmICghdmFsKSB2YWwgPSAwCiAgCiAgICB2YXIgaQogICAgaWYgKHR5cGVvZiB2YWwgPT09ICdudW1iZXInKSB7CiAgICAgIGZvciAoaSA9IHN0YXJ0OyBpIDwgZW5kOyArK2kpIHsKICAgICAgICB0aGlzW2ldID0gdmFsCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhciBieXRlcyA9IEJ1ZmZlci5pc0J1ZmZlcih2YWwpCiAgICAgICAgPyB2YWwKICAgICAgICA6IHV0ZjhUb0J5dGVzKG5ldyBCdWZmZXIodmFsLCBlbmNvZGluZykudG9TdHJpbmcoKSkKICAgICAgdmFyIGxlbiA9IGJ5dGVzLmxlbmd0aAogICAgICBmb3IgKGkgPSAwOyBpIDwgZW5kIC0gc3RhcnQ7ICsraSkgewogICAgICAgIHRoaXNbaSArIHN0YXJ0XSA9IGJ5dGVzW2kgJSBsZW5dCiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiB0aGlzCiAgfQogIAogIC8vIEhFTFBFUiBGVU5DVElPTlMKICAvLyA9PT09PT09PT09PT09PT09CiAgCiAgdmFyIElOVkFMSURfQkFTRTY0X1JFID0gL1teK1wvMC05QS1aYS16LV9dL2cKICAKICBmdW5jdGlvbiBiYXNlNjRjbGVhbiAoc3RyKSB7CiAgICAvLyBOb2RlIHN0cmlwcyBvdXQgaW52YWxpZCBjaGFyYWN0ZXJzIGxpa2UgXG4gYW5kIFx0IGZyb20gdGhlIHN0cmluZywgYmFzZTY0LWpzIGRvZXMgbm90CiAgICBzdHIgPSBzdHJpbmd0cmltKHN0cikucmVwbGFjZShJTlZBTElEX0JBU0U2NF9SRSwgJycpCiAgICAvLyBOb2RlIGNvbnZlcnRzIHN0cmluZ3Mgd2l0aCBsZW5ndGggPCAyIHRvICcnCiAgICBpZiAoc3RyLmxlbmd0aCA8IDIpIHJldHVybiAnJwogICAgLy8gTm9kZSBhbGxvd3MgZm9yIG5vbi1wYWRkZWQgYmFzZTY0IHN0cmluZ3MgKG1pc3NpbmcgdHJhaWxpbmcgPT09KSwgYmFzZTY0LWpzIGRvZXMgbm90CiAgICB3aGlsZSAoc3RyLmxlbmd0aCAlIDQgIT09IDApIHsKICAgICAgc3RyID0gc3RyICsgJz0nCiAgICB9CiAgICByZXR1cm4gc3RyCiAgfQogIAogIGZ1bmN0aW9uIHN0cmluZ3RyaW0gKHN0cikgewogICAgaWYgKHN0ci50cmltKSByZXR1cm4gc3RyLnRyaW0oKQogICAgcmV0dXJuIHN0ci5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpCiAgfQogIAogIGZ1bmN0aW9uIHRvSGV4IChuKSB7CiAgICBpZiAobiA8IDE2KSByZXR1cm4gJzAnICsgbi50b1N0cmluZygxNikKICAgIHJldHVybiBuLnRvU3RyaW5nKDE2KQogIH0KICAKICBmdW5jdGlvbiB1dGY4VG9CeXRlcyAoc3RyaW5nLCB1bml0cykgewogICAgdW5pdHMgPSB1bml0cyB8fCBJbmZpbml0eQogICAgdmFyIGNvZGVQb2ludAogICAgdmFyIGxlbmd0aCA9IHN0cmluZy5sZW5ndGgKICAgIHZhciBsZWFkU3Vycm9nYXRlID0gbnVsbAogICAgdmFyIGJ5dGVzID0gW10KICAKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgY29kZVBvaW50ID0gc3RyaW5nLmNoYXJDb2RlQXQoaSkKICAKICAgICAgLy8gaXMgc3Vycm9nYXRlIGNvbXBvbmVudAogICAgICBpZiAoY29kZVBvaW50ID4gMHhEN0ZGICYmIGNvZGVQb2ludCA8IDB4RTAwMCkgewogICAgICAgIC8vIGxhc3QgY2hhciB3YXMgYSBsZWFkCiAgICAgICAgaWYgKCFsZWFkU3Vycm9nYXRlKSB7CiAgICAgICAgICAvLyBubyBsZWFkIHlldAogICAgICAgICAgaWYgKGNvZGVQb2ludCA+IDB4REJGRikgewogICAgICAgICAgICAvLyB1bmV4cGVjdGVkIHRyYWlsCiAgICAgICAgICAgIGlmICgodW5pdHMgLT0gMykgPiAtMSkgYnl0ZXMucHVzaCgweEVGLCAweEJGLCAweEJEKQogICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgfSBlbHNlIGlmIChpICsgMSA9PT0gbGVuZ3RoKSB7CiAgICAgICAgICAgIC8vIHVucGFpcmVkIGxlYWQKICAgICAgICAgICAgaWYgKCh1bml0cyAtPSAzKSA+IC0xKSBieXRlcy5wdXNoKDB4RUYsIDB4QkYsIDB4QkQpCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICB9CiAgCiAgICAgICAgICAvLyB2YWxpZCBsZWFkCiAgICAgICAgICBsZWFkU3Vycm9nYXRlID0gY29kZVBvaW50CiAgCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KICAKICAgICAgICAvLyAyIGxlYWRzIGluIGEgcm93CiAgICAgICAgaWYgKGNvZGVQb2ludCA8IDB4REMwMCkgewogICAgICAgICAgaWYgKCh1bml0cyAtPSAzKSA+IC0xKSBieXRlcy5wdXNoKDB4RUYsIDB4QkYsIDB4QkQpCiAgICAgICAgICBsZWFkU3Vycm9nYXRlID0gY29kZVBvaW50CiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KICAKICAgICAgICAvLyB2YWxpZCBzdXJyb2dhdGUgcGFpcgogICAgICAgIGNvZGVQb2ludCA9IChsZWFkU3Vycm9nYXRlIC0gMHhEODAwIDw8IDEwIHwgY29kZVBvaW50IC0gMHhEQzAwKSArIDB4MTAwMDAKICAgICAgfSBlbHNlIGlmIChsZWFkU3Vycm9nYXRlKSB7CiAgICAgICAgLy8gdmFsaWQgYm1wIGNoYXIsIGJ1dCBsYXN0IGNoYXIgd2FzIGEgbGVhZAogICAgICAgIGlmICgodW5pdHMgLT0gMykgPiAtMSkgYnl0ZXMucHVzaCgweEVGLCAweEJGLCAweEJEKQogICAgICB9CiAgCiAgICAgIGxlYWRTdXJyb2dhdGUgPSBudWxsCiAgCiAgICAgIC8vIGVuY29kZSB1dGY4CiAgICAgIGlmIChjb2RlUG9pbnQgPCAweDgwKSB7CiAgICAgICAgaWYgKCh1bml0cyAtPSAxKSA8IDApIGJyZWFrCiAgICAgICAgYnl0ZXMucHVzaChjb2RlUG9pbnQpCiAgICAgIH0gZWxzZSBpZiAoY29kZVBvaW50IDwgMHg4MDApIHsKICAgICAgICBpZiAoKHVuaXRzIC09IDIpIDwgMCkgYnJlYWsKICAgICAgICBieXRlcy5wdXNoKAogICAgICAgICAgY29kZVBvaW50ID4+IDB4NiB8IDB4QzAsCiAgICAgICAgICBjb2RlUG9pbnQgJiAweDNGIHwgMHg4MAogICAgICAgICkKICAgICAgfSBlbHNlIGlmIChjb2RlUG9pbnQgPCAweDEwMDAwKSB7CiAgICAgICAgaWYgKCh1bml0cyAtPSAzKSA8IDApIGJyZWFrCiAgICAgICAgYnl0ZXMucHVzaCgKICAgICAgICAgIGNvZGVQb2ludCA+PiAweEMgfCAweEUwLAogICAgICAgICAgY29kZVBvaW50ID4+IDB4NiAmIDB4M0YgfCAweDgwLAogICAgICAgICAgY29kZVBvaW50ICYgMHgzRiB8IDB4ODAKICAgICAgICApCiAgICAgIH0gZWxzZSBpZiAoY29kZVBvaW50IDwgMHgxMTAwMDApIHsKICAgICAgICBpZiAoKHVuaXRzIC09IDQpIDwgMCkgYnJlYWsKICAgICAgICBieXRlcy5wdXNoKAogICAgICAgICAgY29kZVBvaW50ID4+IDB4MTIgfCAweEYwLAogICAgICAgICAgY29kZVBvaW50ID4+IDB4QyAmIDB4M0YgfCAweDgwLAogICAgICAgICAgY29kZVBvaW50ID4+IDB4NiAmIDB4M0YgfCAweDgwLAogICAgICAgICAgY29kZVBvaW50ICYgMHgzRiB8IDB4ODAKICAgICAgICApCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGNvZGUgcG9pbnQnKQogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gYnl0ZXMKICB9CiAgCiAgZnVuY3Rpb24gYXNjaWlUb0J5dGVzIChzdHIpIHsKICAgIHZhciBieXRlQXJyYXkgPSBbXQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHsKICAgICAgLy8gTm9kZSdzIGNvZGUgc2VlbXMgdG8gYmUgZG9pbmcgdGhpcyBhbmQgbm90ICYgMHg3Ri4uCiAgICAgIGJ5dGVBcnJheS5wdXNoKHN0ci5jaGFyQ29kZUF0KGkpICYgMHhGRikKICAgIH0KICAgIHJldHVybiBieXRlQXJyYXkKICB9CiAgCiAgZnVuY3Rpb24gdXRmMTZsZVRvQnl0ZXMgKHN0ciwgdW5pdHMpIHsKICAgIHZhciBjLCBoaSwgbG8KICAgIHZhciBieXRlQXJyYXkgPSBbXQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKCh1bml0cyAtPSAyKSA8IDApIGJyZWFrCiAgCiAgICAgIGMgPSBzdHIuY2hhckNvZGVBdChpKQogICAgICBoaSA9IGMgPj4gOAogICAgICBsbyA9IGMgJSAyNTYKICAgICAgYnl0ZUFycmF5LnB1c2gobG8pCiAgICAgIGJ5dGVBcnJheS5wdXNoKGhpKQogICAgfQogIAogICAgcmV0dXJuIGJ5dGVBcnJheQogIH0KICAKICBmdW5jdGlvbiBiYXNlNjRUb0J5dGVzIChzdHIpIHsKICAgIHJldHVybiBiYXNlNjQudG9CeXRlQXJyYXkoYmFzZTY0Y2xlYW4oc3RyKSkKICB9CiAgCiAgZnVuY3Rpb24gYmxpdEJ1ZmZlciAoc3JjLCBkc3QsIG9mZnNldCwgbGVuZ3RoKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGlmICgoaSArIG9mZnNldCA+PSBkc3QubGVuZ3RoKSB8fCAoaSA+PSBzcmMubGVuZ3RoKSkgYnJlYWsKICAgICAgZHN0W2kgKyBvZmZzZXRdID0gc3JjW2ldCiAgICB9CiAgICByZXR1cm4gaQogIH0KICAKICBmdW5jdGlvbiBpc25hbiAodmFsKSB7CiAgICByZXR1cm4gdmFsICE9PSB2YWwgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1zZWxmLWNvbXBhcmUKICB9CiAgCiAgfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyx0eXBlb2YgX193ZWJwYWNrX3JlcXVpcmVfXy5nICE9PSAidW5kZWZpbmVkIiA/IF9fd2VicGFja19yZXF1aXJlX18uZyA6IHR5cGVvZiBzZWxmICE9PSAidW5kZWZpbmVkIiA/IHNlbGYgOiB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiA/IHdpbmRvdyA6IHt9LHJlcXVpcmUoImJ1ZmZlciIpLkJ1ZmZlcikKICB9LHsiYmFzZTY0LWpzIjo3OCwiYnVmZmVyIjo4MSwiaWVlZTc1NCI6ODMsImlzYXJyYXkiOjg0fV0sODI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgogIC8vCiAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKICAvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiAgLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwogIC8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKICAvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CiAgLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCiAgLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgLy8KICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAogIC8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogIC8vCiAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICAvLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiAgLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgogIC8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAogIC8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgogIC8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKICAvLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogIAogIGZ1bmN0aW9uIEV2ZW50RW1pdHRlcigpIHsKICAgIHRoaXMuX2V2ZW50cyA9IHRoaXMuX2V2ZW50cyB8fCB7fTsKICAgIHRoaXMuX21heExpc3RlbmVycyA9IHRoaXMuX21heExpc3RlbmVycyB8fCB1bmRlZmluZWQ7CiAgfQogIG1vZHVsZS5leHBvcnRzID0gRXZlbnRFbWl0dGVyOwogIAogIC8vIEJhY2t3YXJkcy1jb21wYXQgd2l0aCBub2RlIDAuMTAueAogIEV2ZW50RW1pdHRlci5FdmVudEVtaXR0ZXIgPSBFdmVudEVtaXR0ZXI7CiAgCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fZXZlbnRzID0gdW5kZWZpbmVkOwogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuX21heExpc3RlbmVycyA9IHVuZGVmaW5lZDsKICAKICAvLyBCeSBkZWZhdWx0IEV2ZW50RW1pdHRlcnMgd2lsbCBwcmludCBhIHdhcm5pbmcgaWYgbW9yZSB0aGFuIDEwIGxpc3RlbmVycyBhcmUKICAvLyBhZGRlZCB0byBpdC4gVGhpcyBpcyBhIHVzZWZ1bCBkZWZhdWx0IHdoaWNoIGhlbHBzIGZpbmRpbmcgbWVtb3J5IGxlYWtzLgogIEV2ZW50RW1pdHRlci5kZWZhdWx0TWF4TGlzdGVuZXJzID0gMTA7CiAgCiAgLy8gT2J2aW91c2x5IG5vdCBhbGwgRW1pdHRlcnMgc2hvdWxkIGJlIGxpbWl0ZWQgdG8gMTAuIFRoaXMgZnVuY3Rpb24gYWxsb3dzCiAgLy8gdGhhdCB0byBiZSBpbmNyZWFzZWQuIFNldCB0byB6ZXJvIGZvciB1bmxpbWl0ZWQuCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5zZXRNYXhMaXN0ZW5lcnMgPSBmdW5jdGlvbihuKSB7CiAgICBpZiAoIWlzTnVtYmVyKG4pIHx8IG4gPCAwIHx8IGlzTmFOKG4pKQogICAgICB0aHJvdyBUeXBlRXJyb3IoJ24gbXVzdCBiZSBhIHBvc2l0aXZlIG51bWJlcicpOwogICAgdGhpcy5fbWF4TGlzdGVuZXJzID0gbjsKICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5lbWl0ID0gZnVuY3Rpb24odHlwZSkgewogICAgdmFyIGVyLCBoYW5kbGVyLCBsZW4sIGFyZ3MsIGksIGxpc3RlbmVyczsKICAKICAgIGlmICghdGhpcy5fZXZlbnRzKQogICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAKICAgIC8vIElmIHRoZXJlIGlzIG5vICdlcnJvcicgZXZlbnQgbGlzdGVuZXIgdGhlbiB0aHJvdy4KICAgIGlmICh0eXBlID09PSAnZXJyb3InKSB7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzLmVycm9yIHx8CiAgICAgICAgICAoaXNPYmplY3QodGhpcy5fZXZlbnRzLmVycm9yKSAmJiAhdGhpcy5fZXZlbnRzLmVycm9yLmxlbmd0aCkpIHsKICAgICAgICBlciA9IGFyZ3VtZW50c1sxXTsKICAgICAgICBpZiAoZXIgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgICAgdGhyb3cgZXI7IC8vIFVuaGFuZGxlZCAnZXJyb3InIGV2ZW50CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIEF0IGxlYXN0IGdpdmUgc29tZSBraW5kIG9mIGNvbnRleHQgdG8gdGhlIHVzZXIKICAgICAgICAgIHZhciBlcnIgPSBuZXcgRXJyb3IoJ1VuY2F1Z2h0LCB1bnNwZWNpZmllZCAiZXJyb3IiIGV2ZW50LiAoJyArIGVyICsgJyknKTsKICAgICAgICAgIGVyci5jb250ZXh0ID0gZXI7CiAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgCiAgICBoYW5kbGVyID0gdGhpcy5fZXZlbnRzW3R5cGVdOwogIAogICAgaWYgKGlzVW5kZWZpbmVkKGhhbmRsZXIpKQogICAgICByZXR1cm4gZmFsc2U7CiAgCiAgICBpZiAoaXNGdW5jdGlvbihoYW5kbGVyKSkgewogICAgICBzd2l0Y2ggKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAvLyBmYXN0IGNhc2VzCiAgICAgICAgY2FzZSAxOgogICAgICAgICAgaGFuZGxlci5jYWxsKHRoaXMpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAyOgogICAgICAgICAgaGFuZGxlci5jYWxsKHRoaXMsIGFyZ3VtZW50c1sxXSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDM6CiAgICAgICAgICBoYW5kbGVyLmNhbGwodGhpcywgYXJndW1lbnRzWzFdLCBhcmd1bWVudHNbMl0pOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gc2xvd2VyCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgaGFuZGxlci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc09iamVjdChoYW5kbGVyKSkgewogICAgICBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgbGlzdGVuZXJzID0gaGFuZGxlci5zbGljZSgpOwogICAgICBsZW4gPSBsaXN0ZW5lcnMubGVuZ3RoOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspCiAgICAgICAgbGlzdGVuZXJzW2ldLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfQogIAogICAgcmV0dXJuIHRydWU7CiAgfTsKICAKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLmFkZExpc3RlbmVyID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIpIHsKICAgIHZhciBtOwogIAogICAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkKICAgICAgdGhyb3cgVHlwZUVycm9yKCdsaXN0ZW5lciBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAKICAgIGlmICghdGhpcy5fZXZlbnRzKQogICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAKICAgIC8vIFRvIGF2b2lkIHJlY3Vyc2lvbiBpbiB0aGUgY2FzZSB0aGF0IHR5cGUgPT09ICJuZXdMaXN0ZW5lciIhIEJlZm9yZQogICAgLy8gYWRkaW5nIGl0IHRvIHRoZSBsaXN0ZW5lcnMsIGZpcnN0IGVtaXQgIm5ld0xpc3RlbmVyIi4KICAgIGlmICh0aGlzLl9ldmVudHMubmV3TGlzdGVuZXIpCiAgICAgIHRoaXMuZW1pdCgnbmV3TGlzdGVuZXInLCB0eXBlLAogICAgICAgICAgICAgICAgaXNGdW5jdGlvbihsaXN0ZW5lci5saXN0ZW5lcikgPwogICAgICAgICAgICAgICAgbGlzdGVuZXIubGlzdGVuZXIgOiBsaXN0ZW5lcik7CiAgCiAgICBpZiAoIXRoaXMuX2V2ZW50c1t0eXBlXSkKICAgICAgLy8gT3B0aW1pemUgdGhlIGNhc2Ugb2Ygb25lIGxpc3RlbmVyLiBEb24ndCBuZWVkIHRoZSBleHRyYSBhcnJheSBvYmplY3QuCiAgICAgIHRoaXMuX2V2ZW50c1t0eXBlXSA9IGxpc3RlbmVyOwogICAgZWxzZSBpZiAoaXNPYmplY3QodGhpcy5fZXZlbnRzW3R5cGVdKSkKICAgICAgLy8gSWYgd2UndmUgYWxyZWFkeSBnb3QgYW4gYXJyYXksIGp1c3QgYXBwZW5kLgogICAgICB0aGlzLl9ldmVudHNbdHlwZV0ucHVzaChsaXN0ZW5lcik7CiAgICBlbHNlCiAgICAgIC8vIEFkZGluZyB0aGUgc2Vjb25kIGVsZW1lbnQsIG5lZWQgdG8gY2hhbmdlIHRvIGFycmF5LgogICAgICB0aGlzLl9ldmVudHNbdHlwZV0gPSBbdGhpcy5fZXZlbnRzW3R5cGVdLCBsaXN0ZW5lcl07CiAgCiAgICAvLyBDaGVjayBmb3IgbGlzdGVuZXIgbGVhawogICAgaWYgKGlzT2JqZWN0KHRoaXMuX2V2ZW50c1t0eXBlXSkgJiYgIXRoaXMuX2V2ZW50c1t0eXBlXS53YXJuZWQpIHsKICAgICAgaWYgKCFpc1VuZGVmaW5lZCh0aGlzLl9tYXhMaXN0ZW5lcnMpKSB7CiAgICAgICAgbSA9IHRoaXMuX21heExpc3RlbmVyczsKICAgICAgfSBlbHNlIHsKICAgICAgICBtID0gRXZlbnRFbWl0dGVyLmRlZmF1bHRNYXhMaXN0ZW5lcnM7CiAgICAgIH0KICAKICAgICAgaWYgKG0gJiYgbSA+IDAgJiYgdGhpcy5fZXZlbnRzW3R5cGVdLmxlbmd0aCA+IG0pIHsKICAgICAgICB0aGlzLl9ldmVudHNbdHlwZV0ud2FybmVkID0gdHJ1ZTsKICAgICAgICBjb25zb2xlLmVycm9yKCcobm9kZSkgd2FybmluZzogcG9zc2libGUgRXZlbnRFbWl0dGVyIG1lbW9yeSAnICsKICAgICAgICAgICAgICAgICAgICAgICdsZWFrIGRldGVjdGVkLiAlZCBsaXN0ZW5lcnMgYWRkZWQuICcgKwogICAgICAgICAgICAgICAgICAgICAgJ1VzZSBlbWl0dGVyLnNldE1heExpc3RlbmVycygpIHRvIGluY3JlYXNlIGxpbWl0LicsCiAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9ldmVudHNbdHlwZV0ubGVuZ3RoKTsKICAgICAgICBpZiAodHlwZW9mIGNvbnNvbGUudHJhY2UgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIC8vIG5vdCBzdXBwb3J0ZWQgaW4gSUUgMTAKICAgICAgICAgIGNvbnNvbGUudHJhY2UoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vbiA9IEV2ZW50RW1pdHRlci5wcm90b3R5cGUuYWRkTGlzdGVuZXI7CiAgCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIpIHsKICAgIGlmICghaXNGdW5jdGlvbihsaXN0ZW5lcikpCiAgICAgIHRocm93IFR5cGVFcnJvcignbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgCiAgICB2YXIgZmlyZWQgPSBmYWxzZTsKICAKICAgIGZ1bmN0aW9uIGcoKSB7CiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgZyk7CiAgCiAgICAgIGlmICghZmlyZWQpIHsKICAgICAgICBmaXJlZCA9IHRydWU7CiAgICAgICAgbGlzdGVuZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfQogIAogICAgZy5saXN0ZW5lciA9IGxpc3RlbmVyOwogICAgdGhpcy5vbih0eXBlLCBnKTsKICAKICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgLy8gZW1pdHMgYSAncmVtb3ZlTGlzdGVuZXInIGV2ZW50IGlmZiB0aGUgbGlzdGVuZXIgd2FzIHJlbW92ZWQKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLnJlbW92ZUxpc3RlbmVyID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIpIHsKICAgIHZhciBsaXN0LCBwb3NpdGlvbiwgbGVuZ3RoLCBpOwogIAogICAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkKICAgICAgdGhyb3cgVHlwZUVycm9yKCdsaXN0ZW5lciBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAKICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICF0aGlzLl9ldmVudHNbdHlwZV0pCiAgICAgIHJldHVybiB0aGlzOwogIAogICAgbGlzdCA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKICAgIGxlbmd0aCA9IGxpc3QubGVuZ3RoOwogICAgcG9zaXRpb24gPSAtMTsKICAKICAgIGlmIChsaXN0ID09PSBsaXN0ZW5lciB8fAogICAgICAgIChpc0Z1bmN0aW9uKGxpc3QubGlzdGVuZXIpICYmIGxpc3QubGlzdGVuZXIgPT09IGxpc3RlbmVyKSkgewogICAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwogICAgICBpZiAodGhpcy5fZXZlbnRzLnJlbW92ZUxpc3RlbmVyKQogICAgICAgIHRoaXMuZW1pdCgncmVtb3ZlTGlzdGVuZXInLCB0eXBlLCBsaXN0ZW5lcik7CiAgCiAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KGxpc3QpKSB7CiAgICAgIGZvciAoaSA9IGxlbmd0aDsgaS0tID4gMDspIHsKICAgICAgICBpZiAobGlzdFtpXSA9PT0gbGlzdGVuZXIgfHwKICAgICAgICAgICAgKGxpc3RbaV0ubGlzdGVuZXIgJiYgbGlzdFtpXS5saXN0ZW5lciA9PT0gbGlzdGVuZXIpKSB7CiAgICAgICAgICBwb3NpdGlvbiA9IGk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgaWYgKHBvc2l0aW9uIDwgMCkKICAgICAgICByZXR1cm4gdGhpczsKICAKICAgICAgaWYgKGxpc3QubGVuZ3RoID09PSAxKSB7CiAgICAgICAgbGlzdC5sZW5ndGggPSAwOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGlzdC5zcGxpY2UocG9zaXRpb24sIDEpOwogICAgICB9CiAgCiAgICAgIGlmICh0aGlzLl9ldmVudHMucmVtb3ZlTGlzdGVuZXIpCiAgICAgICAgdGhpcy5lbWl0KCdyZW1vdmVMaXN0ZW5lcicsIHR5cGUsIGxpc3RlbmVyKTsKICAgIH0KICAKICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVBbGxMaXN0ZW5lcnMgPSBmdW5jdGlvbih0eXBlKSB7CiAgICB2YXIga2V5LCBsaXN0ZW5lcnM7CiAgCiAgICBpZiAoIXRoaXMuX2V2ZW50cykKICAgICAgcmV0dXJuIHRoaXM7CiAgCiAgICAvLyBub3QgbGlzdGVuaW5nIGZvciByZW1vdmVMaXN0ZW5lciwgbm8gbmVlZCB0byBlbWl0CiAgICBpZiAoIXRoaXMuX2V2ZW50cy5yZW1vdmVMaXN0ZW5lcikgewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkKICAgICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgICAgZWxzZSBpZiAodGhpcy5fZXZlbnRzW3R5cGVdKQogICAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIAogICAgLy8gZW1pdCByZW1vdmVMaXN0ZW5lciBmb3IgYWxsIGxpc3RlbmVycyBvbiBhbGwgZXZlbnRzCiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICBmb3IgKGtleSBpbiB0aGlzLl9ldmVudHMpIHsKICAgICAgICBpZiAoa2V5ID09PSAncmVtb3ZlTGlzdGVuZXInKSBjb250aW51ZTsKICAgICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycyhrZXkpOwogICAgICB9CiAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCdyZW1vdmVMaXN0ZW5lcicpOwogICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgCiAgICBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbdHlwZV07CiAgCiAgICBpZiAoaXNGdW5jdGlvbihsaXN0ZW5lcnMpKSB7CiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgbGlzdGVuZXJzKTsKICAgIH0gZWxzZSBpZiAobGlzdGVuZXJzKSB7CiAgICAgIC8vIExJRk8gb3JkZXIKICAgICAgd2hpbGUgKGxpc3RlbmVycy5sZW5ndGgpCiAgICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcnNbbGlzdGVuZXJzLmxlbmd0aCAtIDFdKTsKICAgIH0KICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07CiAgCiAgICByZXR1cm4gdGhpczsKICB9OwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUubGlzdGVuZXJzID0gZnVuY3Rpb24odHlwZSkgewogICAgdmFyIHJldDsKICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICF0aGlzLl9ldmVudHNbdHlwZV0pCiAgICAgIHJldCA9IFtdOwogICAgZWxzZSBpZiAoaXNGdW5jdGlvbih0aGlzLl9ldmVudHNbdHlwZV0pKQogICAgICByZXQgPSBbdGhpcy5fZXZlbnRzW3R5cGVdXTsKICAgIGVsc2UKICAgICAgcmV0ID0gdGhpcy5fZXZlbnRzW3R5cGVdLnNsaWNlKCk7CiAgICByZXR1cm4gcmV0OwogIH07CiAgCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5saXN0ZW5lckNvdW50ID0gZnVuY3Rpb24odHlwZSkgewogICAgaWYgKHRoaXMuX2V2ZW50cykgewogICAgICB2YXIgZXZsaXN0ZW5lciA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKICAKICAgICAgaWYgKGlzRnVuY3Rpb24oZXZsaXN0ZW5lcikpCiAgICAgICAgcmV0dXJuIDE7CiAgICAgIGVsc2UgaWYgKGV2bGlzdGVuZXIpCiAgICAgICAgcmV0dXJuIGV2bGlzdGVuZXIubGVuZ3RoOwogICAgfQogICAgcmV0dXJuIDA7CiAgfTsKICAKICBFdmVudEVtaXR0ZXIubGlzdGVuZXJDb3VudCA9IGZ1bmN0aW9uKGVtaXR0ZXIsIHR5cGUpIHsKICAgIHJldHVybiBlbWl0dGVyLmxpc3RlbmVyQ291bnQodHlwZSk7CiAgfTsKICAKICBmdW5jdGlvbiBpc0Z1bmN0aW9uKGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdmdW5jdGlvbic7CiAgfQogIAogIGZ1bmN0aW9uIGlzTnVtYmVyKGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdudW1iZXInOwogIH0KICAKICBmdW5jdGlvbiBpc09iamVjdChhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JyAmJiBhcmcgIT09IG51bGw7CiAgfQogIAogIGZ1bmN0aW9uIGlzVW5kZWZpbmVkKGFyZykgewogICAgcmV0dXJuIGFyZyA9PT0gdm9pZCAwOwogIH0KICAKICB9LHt9XSw4MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgZXhwb3J0cy5yZWFkID0gZnVuY3Rpb24gKGJ1ZmZlciwgb2Zmc2V0LCBpc0xFLCBtTGVuLCBuQnl0ZXMpIHsKICAgIHZhciBlLCBtCiAgICB2YXIgZUxlbiA9IChuQnl0ZXMgKiA4KSAtIG1MZW4gLSAxCiAgICB2YXIgZU1heCA9ICgxIDw8IGVMZW4pIC0gMQogICAgdmFyIGVCaWFzID0gZU1heCA+PiAxCiAgICB2YXIgbkJpdHMgPSAtNwogICAgdmFyIGkgPSBpc0xFID8gKG5CeXRlcyAtIDEpIDogMAogICAgdmFyIGQgPSBpc0xFID8gLTEgOiAxCiAgICB2YXIgcyA9IGJ1ZmZlcltvZmZzZXQgKyBpXQogIAogICAgaSArPSBkCiAgCiAgICBlID0gcyAmICgoMSA8PCAoLW5CaXRzKSkgLSAxKQogICAgcyA+Pj0gKC1uQml0cykKICAgIG5CaXRzICs9IGVMZW4KICAgIGZvciAoOyBuQml0cyA+IDA7IGUgPSAoZSAqIDI1NikgKyBidWZmZXJbb2Zmc2V0ICsgaV0sIGkgKz0gZCwgbkJpdHMgLT0gOCkge30KICAKICAgIG0gPSBlICYgKCgxIDw8ICgtbkJpdHMpKSAtIDEpCiAgICBlID4+PSAoLW5CaXRzKQogICAgbkJpdHMgKz0gbUxlbgogICAgZm9yICg7IG5CaXRzID4gMDsgbSA9IChtICogMjU2KSArIGJ1ZmZlcltvZmZzZXQgKyBpXSwgaSArPSBkLCBuQml0cyAtPSA4KSB7fQogIAogICAgaWYgKGUgPT09IDApIHsKICAgICAgZSA9IDEgLSBlQmlhcwogICAgfSBlbHNlIGlmIChlID09PSBlTWF4KSB7CiAgICAgIHJldHVybiBtID8gTmFOIDogKChzID8gLTEgOiAxKSAqIEluZmluaXR5KQogICAgfSBlbHNlIHsKICAgICAgbSA9IG0gKyBNYXRoLnBvdygyLCBtTGVuKQogICAgICBlID0gZSAtIGVCaWFzCiAgICB9CiAgICByZXR1cm4gKHMgPyAtMSA6IDEpICogbSAqIE1hdGgucG93KDIsIGUgLSBtTGVuKQogIH0KICAKICBleHBvcnRzLndyaXRlID0gZnVuY3Rpb24gKGJ1ZmZlciwgdmFsdWUsIG9mZnNldCwgaXNMRSwgbUxlbiwgbkJ5dGVzKSB7CiAgICB2YXIgZSwgbSwgYwogICAgdmFyIGVMZW4gPSAobkJ5dGVzICogOCkgLSBtTGVuIC0gMQogICAgdmFyIGVNYXggPSAoMSA8PCBlTGVuKSAtIDEKICAgIHZhciBlQmlhcyA9IGVNYXggPj4gMQogICAgdmFyIHJ0ID0gKG1MZW4gPT09IDIzID8gTWF0aC5wb3coMiwgLTI0KSAtIE1hdGgucG93KDIsIC03NykgOiAwKQogICAgdmFyIGkgPSBpc0xFID8gMCA6IChuQnl0ZXMgLSAxKQogICAgdmFyIGQgPSBpc0xFID8gMSA6IC0xCiAgICB2YXIgcyA9IHZhbHVlIDwgMCB8fCAodmFsdWUgPT09IDAgJiYgMSAvIHZhbHVlIDwgMCkgPyAxIDogMAogIAogICAgdmFsdWUgPSBNYXRoLmFicyh2YWx1ZSkKICAKICAgIGlmIChpc05hTih2YWx1ZSkgfHwgdmFsdWUgPT09IEluZmluaXR5KSB7CiAgICAgIG0gPSBpc05hTih2YWx1ZSkgPyAxIDogMAogICAgICBlID0gZU1heAogICAgfSBlbHNlIHsKICAgICAgZSA9IE1hdGguZmxvb3IoTWF0aC5sb2codmFsdWUpIC8gTWF0aC5MTjIpCiAgICAgIGlmICh2YWx1ZSAqIChjID0gTWF0aC5wb3coMiwgLWUpKSA8IDEpIHsKICAgICAgICBlLS0KICAgICAgICBjICo9IDIKICAgICAgfQogICAgICBpZiAoZSArIGVCaWFzID49IDEpIHsKICAgICAgICB2YWx1ZSArPSBydCAvIGMKICAgICAgfSBlbHNlIHsKICAgICAgICB2YWx1ZSArPSBydCAqIE1hdGgucG93KDIsIDEgLSBlQmlhcykKICAgICAgfQogICAgICBpZiAodmFsdWUgKiBjID49IDIpIHsKICAgICAgICBlKysKICAgICAgICBjIC89IDIKICAgICAgfQogIAogICAgICBpZiAoZSArIGVCaWFzID49IGVNYXgpIHsKICAgICAgICBtID0gMAogICAgICAgIGUgPSBlTWF4CiAgICAgIH0gZWxzZSBpZiAoZSArIGVCaWFzID49IDEpIHsKICAgICAgICBtID0gKCh2YWx1ZSAqIGMpIC0gMSkgKiBNYXRoLnBvdygyLCBtTGVuKQogICAgICAgIGUgPSBlICsgZUJpYXMKICAgICAgfSBlbHNlIHsKICAgICAgICBtID0gdmFsdWUgKiBNYXRoLnBvdygyLCBlQmlhcyAtIDEpICogTWF0aC5wb3coMiwgbUxlbikKICAgICAgICBlID0gMAogICAgICB9CiAgICB9CiAgCiAgICBmb3IgKDsgbUxlbiA+PSA4OyBidWZmZXJbb2Zmc2V0ICsgaV0gPSBtICYgMHhmZiwgaSArPSBkLCBtIC89IDI1NiwgbUxlbiAtPSA4KSB7fQogIAogICAgZSA9IChlIDw8IG1MZW4pIHwgbQogICAgZUxlbiArPSBtTGVuCiAgICBmb3IgKDsgZUxlbiA+IDA7IGJ1ZmZlcltvZmZzZXQgKyBpXSA9IGUgJiAweGZmLCBpICs9IGQsIGUgLz0gMjU2LCBlTGVuIC09IDgpIHt9CiAgCiAgICBidWZmZXJbb2Zmc2V0ICsgaSAtIGRdIHw9IHMgKiAxMjgKICB9CiAgCiAgfSx7fV0sODQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB0b1N0cmluZyA9IHt9LnRvU3RyaW5nOwogIAogIG1vZHVsZS5leHBvcnRzID0gQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiAoYXJyKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChhcnIpID09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKICAKICB9LHt9XSw4NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAKICAgIGZ1bmN0aW9uIGlzQXJyYXkob2JqKSB7CiAgICAgIGlmIChvYmogIT09IG51bGwpIHsKICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICJbb2JqZWN0IEFycmF5XSI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgCiAgICBmdW5jdGlvbiBpc09iamVjdChvYmopIHsKICAgICAgaWYgKG9iaiAhPT0gbnVsbCkgewogICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gIltvYmplY3QgT2JqZWN0XSI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgCiAgICBmdW5jdGlvbiBzdHJpY3REZWVwRXF1YWwoZmlyc3QsIHNlY29uZCkgewogICAgICAvLyBDaGVjayB0aGUgc2NhbGFyIGNhc2UgZmlyc3QuCiAgICAgIGlmIChmaXJzdCA9PT0gc2Vjb25kKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAKICAgICAgLy8gQ2hlY2sgaWYgdGhleSBhcmUgdGhlIHNhbWUgdHlwZS4KICAgICAgdmFyIGZpcnN0VHlwZSA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChmaXJzdCk7CiAgICAgIGlmIChmaXJzdFR5cGUgIT09IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChzZWNvbmQpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8vIFdlIGtub3cgdGhhdCBmaXJzdCBhbmQgc2Vjb25kIGhhdmUgdGhlIHNhbWUgdHlwZSBzbyB3ZSBjYW4ganVzdCBjaGVjayB0aGUKICAgICAgLy8gZmlyc3QgdHlwZSBmcm9tIG5vdyBvbi4KICAgICAgaWYgKGlzQXJyYXkoZmlyc3QpID09PSB0cnVlKSB7CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiB0aGV5J3JlIG5vdCB0aGUgc2FtZSBsZW5ndGg7CiAgICAgICAgaWYgKGZpcnN0Lmxlbmd0aCAhPT0gc2Vjb25kLmxlbmd0aCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZpcnN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoc3RyaWN0RGVlcEVxdWFsKGZpcnN0W2ldLCBzZWNvbmRbaV0pID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmIChpc09iamVjdChmaXJzdCkgPT09IHRydWUpIHsKICAgICAgICAvLyBBbiBvYmplY3QgaXMgZXF1YWwgaWYgaXQgaGFzIHRoZSBzYW1lIGtleS92YWx1ZSBwYWlycy4KICAgICAgICB2YXIga2V5c1NlZW4gPSB7fTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZmlyc3QpIHsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGZpcnN0LCBrZXkpKSB7CiAgICAgICAgICAgIGlmIChzdHJpY3REZWVwRXF1YWwoZmlyc3Rba2V5XSwgc2Vjb25kW2tleV0pID09PSBmYWxzZSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBrZXlzU2VlbltrZXldID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gTm93IGNoZWNrIHRoYXQgdGhlcmUgYXJlbid0IGFueSBrZXlzIGluIHNlY29uZCB0aGF0IHdlcmVuJ3QKICAgICAgICAvLyBpbiBmaXJzdC4KICAgICAgICBmb3IgKHZhciBrZXkyIGluIHNlY29uZCkgewogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoc2Vjb25kLCBrZXkyKSkgewogICAgICAgICAgICBpZiAoa2V5c1NlZW5ba2V5Ml0gIT09IHRydWUpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIAogICAgZnVuY3Rpb24gaXNGYWxzZShvYmopIHsKICAgICAgLy8gRnJvbSB0aGUgc3BlYzoKICAgICAgLy8gQSBmYWxzZSB2YWx1ZSBjb3JyZXNwb25kcyB0byB0aGUgZm9sbG93aW5nIHZhbHVlczoKICAgICAgLy8gRW1wdHkgbGlzdAogICAgICAvLyBFbXB0eSBvYmplY3QKICAgICAgLy8gRW1wdHkgc3RyaW5nCiAgICAgIC8vIEZhbHNlIGJvb2xlYW4KICAgICAgLy8gbnVsbCB2YWx1ZQogIAogICAgICAvLyBGaXJzdCBjaGVjayB0aGUgc2NhbGFyIHZhbHVlcy4KICAgICAgaWYgKG9iaiA9PT0gIiIgfHwgb2JqID09PSBmYWxzZSB8fCBvYmogPT09IG51bGwpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgaWYgKGlzQXJyYXkob2JqKSAmJiBvYmoubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAvLyBDaGVjayBmb3IgYW4gZW1wdHkgYXJyYXkuCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmIChpc09iamVjdChvYmopKSB7CiAgICAgICAgICAvLyBDaGVjayBmb3IgYW4gZW1wdHkgb2JqZWN0LgogICAgICAgICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICAgICAgICAgIC8vIElmIHRoZXJlIGFyZSBhbnkga2V5cywgdGhlbgogICAgICAgICAgICAgIC8vIHRoZSBvYmplY3QgaXMgbm90IGVtcHR5IHNvIHRoZSBvYmplY3QKICAgICAgICAgICAgICAvLyBpcyBub3QgZmFsc2UuCiAgICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAKICAgIGZ1bmN0aW9uIG9ialZhbHVlcyhvYmopIHsKICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvYmopOwogICAgICB2YXIgdmFsdWVzID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhbHVlcy5wdXNoKG9ialtrZXlzW2ldXSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbHVlczsKICAgIH0KICAKICAgIGZ1bmN0aW9uIG1lcmdlKGEsIGIpIHsKICAgICAgICB2YXIgbWVyZ2VkID0ge307CiAgICAgICAgZm9yICh2YXIga2V5IGluIGEpIHsKICAgICAgICAgICAgbWVyZ2VkW2tleV0gPSBhW2tleV07CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGtleTIgaW4gYikgewogICAgICAgICAgICBtZXJnZWRba2V5Ml0gPSBiW2tleTJdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbWVyZ2VkOwogICAgfQogIAogICAgdmFyIHRyaW1MZWZ0OwogICAgaWYgKHR5cGVvZiBTdHJpbmcucHJvdG90eXBlLnRyaW1MZWZ0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRyaW1MZWZ0ID0gZnVuY3Rpb24oc3RyKSB7CiAgICAgICAgcmV0dXJuIHN0ci50cmltTGVmdCgpOwogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgdHJpbUxlZnQgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICByZXR1cm4gc3RyLm1hdGNoKC9eXHMqKC4qKS8pWzFdOwogICAgICB9OwogICAgfQogIAogICAgLy8gVHlwZSBjb25zdGFudHMgdXNlZCB0byBkZWZpbmUgZnVuY3Rpb25zLgogICAgdmFyIFRZUEVfTlVNQkVSID0gMDsKICAgIHZhciBUWVBFX0FOWSA9IDE7CiAgICB2YXIgVFlQRV9TVFJJTkcgPSAyOwogICAgdmFyIFRZUEVfQVJSQVkgPSAzOwogICAgdmFyIFRZUEVfT0JKRUNUID0gNDsKICAgIHZhciBUWVBFX0JPT0xFQU4gPSA1OwogICAgdmFyIFRZUEVfRVhQUkVGID0gNjsKICAgIHZhciBUWVBFX05VTEwgPSA3OwogICAgdmFyIFRZUEVfQVJSQVlfTlVNQkVSID0gODsKICAgIHZhciBUWVBFX0FSUkFZX1NUUklORyA9IDk7CiAgCiAgICB2YXIgVE9LX0VPRiA9ICJFT0YiOwogICAgdmFyIFRPS19VTlFVT1RFRElERU5USUZJRVIgPSAiVW5xdW90ZWRJZGVudGlmaWVyIjsKICAgIHZhciBUT0tfUVVPVEVESURFTlRJRklFUiA9ICJRdW90ZWRJZGVudGlmaWVyIjsKICAgIHZhciBUT0tfUkJSQUNLRVQgPSAiUmJyYWNrZXQiOwogICAgdmFyIFRPS19SUEFSRU4gPSAiUnBhcmVuIjsKICAgIHZhciBUT0tfQ09NTUEgPSAiQ29tbWEiOwogICAgdmFyIFRPS19DT0xPTiA9ICJDb2xvbiI7CiAgICB2YXIgVE9LX1JCUkFDRSA9ICJSYnJhY2UiOwogICAgdmFyIFRPS19OVU1CRVIgPSAiTnVtYmVyIjsKICAgIHZhciBUT0tfQ1VSUkVOVCA9ICJDdXJyZW50IjsKICAgIHZhciBUT0tfRVhQUkVGID0gIkV4cHJlZiI7CiAgICB2YXIgVE9LX1BJUEUgPSAiUGlwZSI7CiAgICB2YXIgVE9LX09SID0gIk9yIjsKICAgIHZhciBUT0tfQU5EID0gIkFuZCI7CiAgICB2YXIgVE9LX0VRID0gIkVRIjsKICAgIHZhciBUT0tfR1QgPSAiR1QiOwogICAgdmFyIFRPS19MVCA9ICJMVCI7CiAgICB2YXIgVE9LX0dURSA9ICJHVEUiOwogICAgdmFyIFRPS19MVEUgPSAiTFRFIjsKICAgIHZhciBUT0tfTkUgPSAiTkUiOwogICAgdmFyIFRPS19GTEFUVEVOID0gIkZsYXR0ZW4iOwogICAgdmFyIFRPS19TVEFSID0gIlN0YXIiOwogICAgdmFyIFRPS19GSUxURVIgPSAiRmlsdGVyIjsKICAgIHZhciBUT0tfRE9UID0gIkRvdCI7CiAgICB2YXIgVE9LX05PVCA9ICJOb3QiOwogICAgdmFyIFRPS19MQlJBQ0UgPSAiTGJyYWNlIjsKICAgIHZhciBUT0tfTEJSQUNLRVQgPSAiTGJyYWNrZXQiOwogICAgdmFyIFRPS19MUEFSRU49ICJMcGFyZW4iOwogICAgdmFyIFRPS19MSVRFUkFMPSAiTGl0ZXJhbCI7CiAgCiAgICAvLyBUaGUgIiYiLCAiWyIsICI8IiwgIj4iIHRva2VucwogICAgLy8gYXJlIG5vdCBpbiBiYXNpY1Rva2VuIGJlY2F1c2UKICAgIC8vIHRoZXJlIGFyZSB0d28gdG9rZW4gdmFyaWFudHMKICAgIC8vICgiJiYiLCAiWz8iLCAiPD0iLCAiPj0iKS4gIFRoaXMgaXMgc3BlY2lhbGx5IGhhbmRsZWQKICAgIC8vIGJlbG93LgogIAogICAgdmFyIGJhc2ljVG9rZW5zID0gewogICAgICAiLiI6IFRPS19ET1QsCiAgICAgICIqIjogVE9LX1NUQVIsCiAgICAgICIsIjogVE9LX0NPTU1BLAogICAgICAiOiI6IFRPS19DT0xPTiwKICAgICAgInsiOiBUT0tfTEJSQUNFLAogICAgICAifSI6IFRPS19SQlJBQ0UsCiAgICAgICJdIjogVE9LX1JCUkFDS0VULAogICAgICAiKCI6IFRPS19MUEFSRU4sCiAgICAgICIpIjogVE9LX1JQQVJFTiwKICAgICAgIkAiOiBUT0tfQ1VSUkVOVAogICAgfTsKICAKICAgIHZhciBvcGVyYXRvclN0YXJ0VG9rZW4gPSB7CiAgICAgICAgIjwiOiB0cnVlLAogICAgICAgICI+IjogdHJ1ZSwKICAgICAgICAiPSI6IHRydWUsCiAgICAgICAgIiEiOiB0cnVlCiAgICB9OwogIAogICAgdmFyIHNraXBDaGFycyA9IHsKICAgICAgICAiICI6IHRydWUsCiAgICAgICAgIlx0IjogdHJ1ZSwKICAgICAgICAiXG4iOiB0cnVlCiAgICB9OwogIAogIAogICAgZnVuY3Rpb24gaXNBbHBoYShjaCkgewogICAgICAgIHJldHVybiAoY2ggPj0gImEiICYmIGNoIDw9ICJ6IikgfHwKICAgICAgICAgICAgICAgKGNoID49ICJBIiAmJiBjaCA8PSAiWiIpIHx8CiAgICAgICAgICAgICAgIGNoID09PSAiXyI7CiAgICB9CiAgCiAgICBmdW5jdGlvbiBpc051bShjaCkgewogICAgICAgIHJldHVybiAoY2ggPj0gIjAiICYmIGNoIDw9ICI5IikgfHwKICAgICAgICAgICAgICAgY2ggPT09ICItIjsKICAgIH0KICAgIGZ1bmN0aW9uIGlzQWxwaGFOdW0oY2gpIHsKICAgICAgICByZXR1cm4gKGNoID49ICJhIiAmJiBjaCA8PSAieiIpIHx8CiAgICAgICAgICAgICAgIChjaCA+PSAiQSIgJiYgY2ggPD0gIloiKSB8fAogICAgICAgICAgICAgICAoY2ggPj0gIjAiICYmIGNoIDw9ICI5IikgfHwKICAgICAgICAgICAgICAgY2ggPT09ICJfIjsKICAgIH0KICAKICAgIGZ1bmN0aW9uIExleGVyKCkgewogICAgfQogICAgTGV4ZXIucHJvdG90eXBlID0gewogICAgICAgIHRva2VuaXplOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdmFyIHRva2VucyA9IFtdOwogICAgICAgICAgICB0aGlzLl9jdXJyZW50ID0gMDsKICAgICAgICAgICAgdmFyIHN0YXJ0OwogICAgICAgICAgICB2YXIgaWRlbnRpZmllcjsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICB3aGlsZSAodGhpcy5fY3VycmVudCA8IHN0cmVhbS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGlmIChpc0FscGhhKHN0cmVhbVt0aGlzLl9jdXJyZW50XSkpIHsKICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgaWRlbnRpZmllciA9IHRoaXMuX2NvbnN1bWVVbnF1b3RlZElkZW50aWZpZXIoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX1VOUVVPVEVESURFTlRJRklFUiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGlkZW50aWZpZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChiYXNpY1Rva2Vuc1tzdHJlYW1bdGhpcy5fY3VycmVudF1dICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogYmFzaWNUb2tlbnNbc3RyZWFtW3RoaXMuX2N1cnJlbnRdXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogc3RyZWFtW3RoaXMuX2N1cnJlbnRdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiB0aGlzLl9jdXJyZW50fSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc051bShzdHJlYW1bdGhpcy5fY3VycmVudF0pKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW4gPSB0aGlzLl9jb25zdW1lTnVtYmVyKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJbIikgewogICAgICAgICAgICAgICAgICAgIC8vIE5vIG5lZWQgdG8gaW5jcmVtZW50IHRoaXMuX2N1cnJlbnQuICBUaGlzIGhhcHBlbnMKICAgICAgICAgICAgICAgICAgICAvLyBpbiBfY29uc3VtZUxCcmFja2V0CiAgICAgICAgICAgICAgICAgICAgdG9rZW4gPSB0aGlzLl9jb25zdW1lTEJyYWNrZXQoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh0b2tlbik7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIlwiIikgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgICBpZGVudGlmaWVyID0gdGhpcy5fY29uc3VtZVF1b3RlZElkZW50aWZpZXIoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX1FVT1RFRElERU5USUZJRVIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpZGVudGlmaWVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiJyIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgaWRlbnRpZmllciA9IHRoaXMuX2NvbnN1bWVSYXdTdHJpbmdMaXRlcmFsKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19MSVRFUkFMLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaWRlbnRpZmllciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gImAiKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICAgIHZhciBsaXRlcmFsID0gdGhpcy5fY29uc3VtZUxpdGVyYWwoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX0xJVEVSQUwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBsaXRlcmFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3JTdGFydFRva2VuW3N0cmVhbVt0aGlzLl9jdXJyZW50XV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHRoaXMuX2NvbnN1bWVPcGVyYXRvcihzdHJlYW0pKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2tpcENoYXJzW3N0cmVhbVt0aGlzLl9jdXJyZW50XV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSB3aGl0ZXNwYWNlLgogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiJiIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICImIikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfQU5ELCB2YWx1ZTogIiYmIiwgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19FWFBSRUYsIHZhbHVlOiAiJiIsIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAifCIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJ8IikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfT1IsIHZhbHVlOiAifHwiLCBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX1BJUEUsIHZhbHVlOiAifCIsIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJVbmtub3duIGNoYXJhY3RlcjoiICsgc3RyZWFtW3RoaXMuX2N1cnJlbnRdKTsKICAgICAgICAgICAgICAgICAgICBlcnJvci5uYW1lID0gIkxleGVyRXJyb3IiOwogICAgICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0b2tlbnM7CiAgICAgICAgfSwKICAKICAgICAgICBfY29uc3VtZVVucXVvdGVkSWRlbnRpZmllcjogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2N1cnJlbnQgPCBzdHJlYW0ubGVuZ3RoICYmIGlzQWxwaGFOdW0oc3RyZWFtW3RoaXMuX2N1cnJlbnRdKSkgewogICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzdHJlYW0uc2xpY2Uoc3RhcnQsIHRoaXMuX2N1cnJlbnQpOwogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVRdW90ZWRJZGVudGlmaWVyOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICB2YXIgbWF4TGVuZ3RoID0gc3RyZWFtLmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSAhPT0gIlwiIiAmJiB0aGlzLl9jdXJyZW50IDwgbWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAvLyBZb3UgY2FuIGVzY2FwZSBhIGRvdWJsZSBxdW90ZSBhbmQgeW91IGNhbiBlc2NhcGUgYW4gZXNjYXBlLgogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgaWYgKHN0cmVhbVtjdXJyZW50XSA9PT0gIlxcIiAmJiAoc3RyZWFtW2N1cnJlbnQgKyAxXSA9PT0gIlxcIiB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtW2N1cnJlbnQgKyAxXSA9PT0gIlwiIikpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50ICs9IDI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQgPSBjdXJyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2Uoc3RyZWFtLnNsaWNlKHN0YXJ0LCB0aGlzLl9jdXJyZW50KSk7CiAgICAgICAgfSwKICAKICAgICAgICBfY29uc3VtZVJhd1N0cmluZ0xpdGVyYWw6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHZhciBtYXhMZW5ndGggPSBzdHJlYW0ubGVuZ3RoOwogICAgICAgICAgICB3aGlsZSAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdICE9PSAiJyIgJiYgdGhpcy5fY3VycmVudCA8IG1heExlbmd0aCkgewogICAgICAgICAgICAgICAgLy8gWW91IGNhbiBlc2NhcGUgYSBzaW5nbGUgcXVvdGUgYW5kIHlvdSBjYW4gZXNjYXBlIGFuIGVzY2FwZS4KICAgICAgICAgICAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bY3VycmVudF0gPT09ICJcXCIgJiYgKHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICJcXCIgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICInIikpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50ICs9IDI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQgPSBjdXJyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgdmFyIGxpdGVyYWwgPSBzdHJlYW0uc2xpY2Uoc3RhcnQgKyAxLCB0aGlzLl9jdXJyZW50IC0gMSk7CiAgICAgICAgICAgIHJldHVybiBsaXRlcmFsLnJlcGxhY2UoIlxcJyIsICInIik7CiAgICAgICAgfSwKICAKICAgICAgICBfY29uc3VtZU51bWJlcjogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgdmFyIG1heExlbmd0aCA9IHN0cmVhbS5sZW5ndGg7CiAgICAgICAgICAgIHdoaWxlIChpc051bShzdHJlYW1bdGhpcy5fY3VycmVudF0pICYmIHRoaXMuX2N1cnJlbnQgPCBtYXhMZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJzZUludChzdHJlYW0uc2xpY2Uoc3RhcnQsIHRoaXMuX2N1cnJlbnQpKTsKICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTlVNQkVSLCB2YWx1ZTogdmFsdWUsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgfSwKICAKICAgICAgICBfY29uc3VtZUxCcmFja2V0OiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiPyIpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0ZJTFRFUiwgdmFsdWU6ICJbPyIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiXSIpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0ZMQVRURU4sIHZhbHVlOiAiW10iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTEJSQUNLRVQsIHZhbHVlOiAiWyIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIF9jb25zdW1lT3BlcmF0b3I6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICB2YXIgc3RhcnRpbmdDaGFyID0gc3RyZWFtW3N0YXJ0XTsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICBpZiAoc3RhcnRpbmdDaGFyID09PSAiISIpIHsKICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICI9IikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19ORSwgdmFsdWU6ICIhPSIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19OT1QsIHZhbHVlOiAiISIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnRpbmdDaGFyID09PSAiPCIpIHsKICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICI9IikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19MVEUsIHZhbHVlOiAiPD0iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19MVCwgdmFsdWU6ICI8Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFydGluZ0NoYXIgPT09ICI+IikgewogICAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIj0iKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0dURSwgdmFsdWU6ICI+PSIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0dULCB2YWx1ZTogIj4iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0aW5nQ2hhciA9PT0gIj0iKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiPSIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfRVEsIHZhbHVlOiAiPT0iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBfY29uc3VtZUxpdGVyYWw6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgIHZhciBtYXhMZW5ndGggPSBzdHJlYW0ubGVuZ3RoOwogICAgICAgICAgICB2YXIgbGl0ZXJhbDsKICAgICAgICAgICAgd2hpbGUoc3RyZWFtW3RoaXMuX2N1cnJlbnRdICE9PSAiYCIgJiYgdGhpcy5fY3VycmVudCA8IG1heExlbmd0aCkgewogICAgICAgICAgICAgICAgLy8gWW91IGNhbiBlc2NhcGUgYSBsaXRlcmFsIGNoYXIgb3IgeW91IGNhbiBlc2NhcGUgdGhlIGVzY2FwZS4KICAgICAgICAgICAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bY3VycmVudF0gPT09ICJcXCIgJiYgKHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICJcXCIgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICJgIikpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50ICs9IDI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQgPSBjdXJyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBsaXRlcmFsU3RyaW5nID0gdHJpbUxlZnQoc3RyZWFtLnNsaWNlKHN0YXJ0LCB0aGlzLl9jdXJyZW50KSk7CiAgICAgICAgICAgIGxpdGVyYWxTdHJpbmcgPSBsaXRlcmFsU3RyaW5nLnJlcGxhY2UoIlxcYCIsICJgIik7CiAgICAgICAgICAgIGlmICh0aGlzLl9sb29rc0xpa2VKU09OKGxpdGVyYWxTdHJpbmcpKSB7CiAgICAgICAgICAgICAgICBsaXRlcmFsID0gSlNPTi5wYXJzZShsaXRlcmFsU3RyaW5nKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFRyeSB0byBKU09OIHBhcnNlIGl0IGFzICI8bGl0ZXJhbD4iCiAgICAgICAgICAgICAgICBsaXRlcmFsID0gSlNPTi5wYXJzZSgiXCIiICsgbGl0ZXJhbFN0cmluZyArICJcIiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vICsxIGdldHMgdXMgdG8gdGhlIGVuZGluZyAiYCIsICsxIHRvIG1vdmUgb24gdG8gdGhlIG5leHQgY2hhci4KICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICByZXR1cm4gbGl0ZXJhbDsKICAgICAgICB9LAogIAogICAgICAgIF9sb29rc0xpa2VKU09OOiBmdW5jdGlvbihsaXRlcmFsU3RyaW5nKSB7CiAgICAgICAgICAgIHZhciBzdGFydGluZ0NoYXJzID0gIlt7XCIiOwogICAgICAgICAgICB2YXIganNvbkxpdGVyYWxzID0gWyJ0cnVlIiwgImZhbHNlIiwgIm51bGwiXTsKICAgICAgICAgICAgdmFyIG51bWJlckxvb2tpbmcgPSAiLTAxMjM0NTY3ODkiOwogIAogICAgICAgICAgICBpZiAobGl0ZXJhbFN0cmluZyA9PT0gIiIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFydGluZ0NoYXJzLmluZGV4T2YobGl0ZXJhbFN0cmluZ1swXSkgPj0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoanNvbkxpdGVyYWxzLmluZGV4T2YobGl0ZXJhbFN0cmluZykgPj0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobnVtYmVyTG9va2luZy5pbmRleE9mKGxpdGVyYWxTdHJpbmdbMF0pID49IDApIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgSlNPTi5wYXJzZShsaXRlcmFsU3RyaW5nKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAKICAgICAgICB2YXIgYmluZGluZ1Bvd2VyID0ge307CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19FT0ZdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX1VOUVVPVEVESURFTlRJRklFUl0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfUVVPVEVESURFTlRJRklFUl0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfUkJSQUNLRVRdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX1JQQVJFTl0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfQ09NTUFdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX1JCUkFDRV0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfTlVNQkVSXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19DVVJSRU5UXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19FWFBSRUZdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX1BJUEVdID0gMTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX09SXSA9IDI7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19BTkRdID0gMzsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0VRXSA9IDU7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19HVF0gPSA1OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfTFRdID0gNTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0dURV0gPSA1OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfTFRFXSA9IDU7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19ORV0gPSA1OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfRkxBVFRFTl0gPSA5OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfU1RBUl0gPSAyMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0ZJTFRFUl0gPSAyMTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0RPVF0gPSA0MDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX05PVF0gPSA0NTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0xCUkFDRV0gPSA1MDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0xCUkFDS0VUXSA9IDU1OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfTFBBUkVOXSA9IDYwOwogIAogICAgZnVuY3Rpb24gUGFyc2VyKCkgewogICAgfQogIAogICAgUGFyc2VyLnByb3RvdHlwZSA9IHsKICAgICAgICBwYXJzZTogZnVuY3Rpb24oZXhwcmVzc2lvbikgewogICAgICAgICAgICB0aGlzLl9sb2FkVG9rZW5zKGV4cHJlc3Npb24pOwogICAgICAgICAgICB0aGlzLmluZGV4ID0gMDsKICAgICAgICAgICAgdmFyIGFzdCA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSAhPT0gVE9LX0VPRikgewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigKICAgICAgICAgICAgICAgICAgICAiVW5leHBlY3RlZCB0b2tlbiB0eXBlOiAiICsgdC50eXBlICsgIiwgdmFsdWU6ICIgKyB0LnZhbHVlKTsKICAgICAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiUGFyc2VyRXJyb3IiOwogICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFzdDsKICAgICAgICB9LAogIAogICAgICAgIF9sb2FkVG9rZW5zOiBmdW5jdGlvbihleHByZXNzaW9uKSB7CiAgICAgICAgICAgIHZhciBsZXhlciA9IG5ldyBMZXhlcigpOwogICAgICAgICAgICB2YXIgdG9rZW5zID0gbGV4ZXIudG9rZW5pemUoZXhwcmVzc2lvbik7CiAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfRU9GLCB2YWx1ZTogIiIsIHN0YXJ0OiBleHByZXNzaW9uLmxlbmd0aH0pOwogICAgICAgICAgICB0aGlzLnRva2VucyA9IHRva2VuczsKICAgICAgICB9LAogIAogICAgICAgIGV4cHJlc3Npb246IGZ1bmN0aW9uKHJicCkgewogICAgICAgICAgICB2YXIgbGVmdFRva2VuID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgdmFyIGxlZnQgPSB0aGlzLm51ZChsZWZ0VG9rZW4pOwogICAgICAgICAgICB2YXIgY3VycmVudFRva2VuID0gdGhpcy5fbG9va2FoZWFkKDApOwogICAgICAgICAgICB3aGlsZSAocmJwIDwgYmluZGluZ1Bvd2VyW2N1cnJlbnRUb2tlbl0pIHsKICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgIGxlZnQgPSB0aGlzLmxlZChjdXJyZW50VG9rZW4sIGxlZnQpOwogICAgICAgICAgICAgICAgY3VycmVudFRva2VuID0gdGhpcy5fbG9va2FoZWFkKDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgIH0sCiAgCiAgICAgICAgX2xvb2thaGVhZDogZnVuY3Rpb24obnVtYmVyKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRva2Vuc1t0aGlzLmluZGV4ICsgbnVtYmVyXS50eXBlOwogICAgICAgIH0sCiAgCiAgICAgICAgX2xvb2thaGVhZFRva2VuOiBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudG9rZW5zW3RoaXMuaW5kZXggKyBudW1iZXJdOwogICAgICAgIH0sCiAgCiAgICAgICAgX2FkdmFuY2U6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmluZGV4Kys7CiAgICAgICAgfSwKICAKICAgICAgICBudWQ6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgICB2YXIgbGVmdDsKICAgICAgICAgIHZhciByaWdodDsKICAgICAgICAgIHZhciBleHByZXNzaW9uOwogICAgICAgICAgc3dpdGNoICh0b2tlbi50eXBlKSB7CiAgICAgICAgICAgIGNhc2UgVE9LX0xJVEVSQUw6CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiTGl0ZXJhbCIsIHZhbHVlOiB0b2tlbi52YWx1ZX07CiAgICAgICAgICAgIGNhc2UgVE9LX1VOUVVPVEVESURFTlRJRklFUjoKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJGaWVsZCIsIG5hbWU6IHRva2VuLnZhbHVlfTsKICAgICAgICAgICAgY2FzZSBUT0tfUVVPVEVESURFTlRJRklFUjoKICAgICAgICAgICAgICB2YXIgbm9kZSA9IHt0eXBlOiAiRmllbGQiLCBuYW1lOiB0b2tlbi52YWx1ZX07CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0xQQVJFTikgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlF1b3RlZCBpZGVudGlmaWVyIG5vdCBhbGxvd2VkIGZvciBmdW5jdGlvbiBuYW1lcy4iKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVE9LX05PVDoKICAgICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihiaW5kaW5nUG93ZXIuTm90KTsKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJOb3RFeHByZXNzaW9uIiwgY2hpbGRyZW46IFtyaWdodF19OwogICAgICAgICAgICBjYXNlIFRPS19TVEFSOgogICAgICAgICAgICAgIGxlZnQgPSB7dHlwZTogIklkZW50aXR5In07CiAgICAgICAgICAgICAgcmlnaHQgPSBudWxsOwogICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19SQlJBQ0tFVCkgewogICAgICAgICAgICAgICAgICAvLyBUaGlzIGNhbiBoYXBwZW4gaW4gYSBtdWx0aXNlbGVjdCwKICAgICAgICAgICAgICAgICAgLy8gW2EsIGIsICpdCiAgICAgICAgICAgICAgICAgIHJpZ2h0ID0ge3R5cGU6ICJJZGVudGl0eSJ9OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5TdGFyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiVmFsdWVQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICBjYXNlIFRPS19GSUxURVI6CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubGVkKHRva2VuLnR5cGUsIHt0eXBlOiAiSWRlbnRpdHkifSk7CiAgICAgICAgICAgIGNhc2UgVE9LX0xCUkFDRToKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VNdWx0aXNlbGVjdEhhc2goKTsKICAgICAgICAgICAgY2FzZSBUT0tfRkxBVFRFTjoKICAgICAgICAgICAgICBsZWZ0ID0ge3R5cGU6IFRPS19GTEFUVEVOLCBjaGlsZHJlbjogW3t0eXBlOiAiSWRlbnRpdHkifV19OwogICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5GbGF0dGVuKTsKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICBjYXNlIFRPS19MQlJBQ0tFVDoKICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfTlVNQkVSIHx8IHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NPTE9OKSB7CiAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VJbmRleEV4cHJlc3Npb24oKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Byb2plY3RJZlNsaWNlKHt0eXBlOiAiSWRlbnRpdHkifSwgcmlnaHQpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfU1RBUiAmJgogICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9va2FoZWFkKDEpID09PSBUT0tfUkJSQUNLRVQpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5TdGFyKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiUHJvamVjdGlvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFt7dHlwZTogIklkZW50aXR5In0sIHJpZ2h0XX07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlTXVsdGlzZWxlY3RMaXN0KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRPS19DVVJSRU5UOgogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0NVUlJFTlR9OwogICAgICAgICAgICBjYXNlIFRPS19FWFBSRUY6CiAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHRoaXMuZXhwcmVzc2lvbihiaW5kaW5nUG93ZXIuRXhwcmVmKTsKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJFeHByZXNzaW9uUmVmZXJlbmNlIiwgY2hpbGRyZW46IFtleHByZXNzaW9uXX07CiAgICAgICAgICAgIGNhc2UgVE9LX0xQQVJFTjoKICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICAgIHdoaWxlICh0aGlzLl9sb29rYWhlYWQoMCkgIT09IFRPS19SUEFSRU4pIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DVVJSRU5UKSB7CiAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB7dHlwZTogVE9LX0NVUlJFTlR9OwogICAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBleHByZXNzaW9uID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXJncy5wdXNoKGV4cHJlc3Npb24pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUlBBUkVOKTsKICAgICAgICAgICAgICByZXR1cm4gYXJnc1swXTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aGlzLl9lcnJvclRva2VuKHRva2VuKTsKICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIGxlZDogZnVuY3Rpb24odG9rZW5OYW1lLCBsZWZ0KSB7CiAgICAgICAgICB2YXIgcmlnaHQ7CiAgICAgICAgICBzd2l0Y2godG9rZW5OYW1lKSB7CiAgICAgICAgICAgIGNhc2UgVE9LX0RPVDoKICAgICAgICAgICAgICB2YXIgcmJwID0gYmluZGluZ1Bvd2VyLkRvdDsKICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApICE9PSBUT0tfU1RBUikgewogICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlRG90UkhTKHJicCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlN1YmV4cHJlc3Npb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgLy8gQ3JlYXRpbmcgYSBwcm9qZWN0aW9uLgogICAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKHJicCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlZhbHVlUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVE9LX1BJUEU6CiAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyLlBpcGUpOwogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX1BJUEUsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgY2FzZSBUT0tfT1I6CiAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyLk9yKTsKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJPckV4cHJlc3Npb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgIGNhc2UgVE9LX0FORDoKICAgICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihiaW5kaW5nUG93ZXIuQW5kKTsKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJBbmRFeHByZXNzaW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICBjYXNlIFRPS19MUEFSRU46CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBsZWZ0Lm5hbWU7CiAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgICB2YXIgZXhwcmVzc2lvbiwgbm9kZTsKICAgICAgICAgICAgICB3aGlsZSAodGhpcy5fbG9va2FoZWFkKDApICE9PSBUT0tfUlBBUkVOKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ1VSUkVOVCkgewogICAgICAgICAgICAgICAgICBleHByZXNzaW9uID0ge3R5cGU6IFRPS19DVVJSRU5UfTsKICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DT01NQSkgewogICAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfQ09NTUEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXJncy5wdXNoKGV4cHJlc3Npb24pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUlBBUkVOKTsKICAgICAgICAgICAgICBub2RlID0ge3R5cGU6ICJGdW5jdGlvbiIsIG5hbWU6IG5hbWUsIGNoaWxkcmVuOiBhcmdzfTsKICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgY2FzZSBUT0tfRklMVEVSOgogICAgICAgICAgICAgIHZhciBjb25kaXRpb24gPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDS0VUKTsKICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfRkxBVFRFTikgewogICAgICAgICAgICAgICAgcmlnaHQgPSB7dHlwZTogIklkZW50aXR5In07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5GaWx0ZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJGaWx0ZXJQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodCwgY29uZGl0aW9uXX07CiAgICAgICAgICAgIGNhc2UgVE9LX0ZMQVRURU46CiAgICAgICAgICAgICAgdmFyIGxlZnROb2RlID0ge3R5cGU6IFRPS19GTEFUVEVOLCBjaGlsZHJlbjogW2xlZnRdfTsKICAgICAgICAgICAgICB2YXIgcmlnaHROb2RlID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5GbGF0dGVuKTsKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0Tm9kZSwgcmlnaHROb2RlXX07CiAgICAgICAgICAgIGNhc2UgVE9LX0VROgogICAgICAgICAgICBjYXNlIFRPS19ORToKICAgICAgICAgICAgY2FzZSBUT0tfR1Q6CiAgICAgICAgICAgIGNhc2UgVE9LX0dURToKICAgICAgICAgICAgY2FzZSBUT0tfTFQ6CiAgICAgICAgICAgIGNhc2UgVE9LX0xURToKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VDb21wYXJhdG9yKGxlZnQsIHRva2VuTmFtZSk7CiAgICAgICAgICAgIGNhc2UgVE9LX0xCUkFDS0VUOgogICAgICAgICAgICAgIHZhciB0b2tlbiA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgICAgIGlmICh0b2tlbi50eXBlID09PSBUT0tfTlVNQkVSIHx8IHRva2VuLnR5cGUgPT09IFRPS19DT0xPTikgewogICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlSW5kZXhFeHByZXNzaW9uKCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wcm9qZWN0SWZTbGljZShsZWZ0LCByaWdodCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1NUQVIpOwogICAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNLRVQpOwogICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuU3Rhcik7CiAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRoaXMuX2Vycm9yVG9rZW4odGhpcy5fbG9va2FoZWFkVG9rZW4oMCkpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgX21hdGNoOiBmdW5jdGlvbih0b2tlblR5cGUpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gdG9rZW5UeXBlKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJFeHBlY3RlZCAiICsgdG9rZW5UeXBlICsgIiwgZ290OiAiICsgdC50eXBlKTsKICAgICAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiUGFyc2VyRXJyb3IiOwogICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIF9lcnJvclRva2VuOiBmdW5jdGlvbih0b2tlbikgewogICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIkludmFsaWQgdG9rZW4gKCIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW4udHlwZSArICIpOiBcIiIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW4udmFsdWUgKyAiXCIiKTsKICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJQYXJzZXJFcnJvciI7CiAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgIH0sCiAgCiAgCiAgICAgICAgX3BhcnNlSW5kZXhFeHByZXNzaW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NPTE9OIHx8IHRoaXMuX2xvb2thaGVhZCgxKSA9PT0gVE9LX0NPTE9OKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VTbGljZUV4cHJlc3Npb24oKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBub2RlID0gewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJJbmRleCIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHRoaXMuX2xvb2thaGVhZFRva2VuKDApLnZhbHVlfTsKICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0tFVCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgX3Byb2plY3RJZlNsaWNlOiBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgICAgICB2YXIgaW5kZXhFeHByID0ge3R5cGU6ICJJbmRleEV4cHJlc3Npb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgIGlmIChyaWdodC50eXBlID09PSAiU2xpY2UiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJQcm9qZWN0aW9uIiwKICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogW2luZGV4RXhwciwgdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5TdGFyKV0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaW5kZXhFeHByOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBfcGFyc2VTbGljZUV4cHJlc3Npb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyBbc3RhcnQ6ZW5kOnN0ZXBdIHdoZXJlIGVhY2ggcGFydCBpcyBvcHRpb25hbCwgYXMgd2VsbCBhcyB0aGUgbGFzdAogICAgICAgICAgICAvLyBjb2xvbi4KICAgICAgICAgICAgdmFyIHBhcnRzID0gW251bGwsIG51bGwsIG51bGxdOwogICAgICAgICAgICB2YXIgaW5kZXggPSAwOwogICAgICAgICAgICB2YXIgY3VycmVudFRva2VuID0gdGhpcy5fbG9va2FoZWFkKDApOwogICAgICAgICAgICB3aGlsZSAoY3VycmVudFRva2VuICE9PSBUT0tfUkJSQUNLRVQgJiYgaW5kZXggPCAzKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFRva2VuID09PSBUT0tfQ09MT04pIHsKICAgICAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY3VycmVudFRva2VuID09PSBUT0tfTlVNQkVSKSB7CiAgICAgICAgICAgICAgICAgICAgcGFydHNbaW5kZXhdID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCkudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIlN5bnRheCBlcnJvciwgdW5leHBlY3RlZCB0b2tlbjogIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQudmFsdWUgKyAiKCIgKyB0LnR5cGUgKyAiKSIpOwogICAgICAgICAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiUGFyc2VyZXJyb3IiOwogICAgICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudFRva2VuID0gdGhpcy5fbG9va2FoZWFkKDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0tFVCk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICB0eXBlOiAiU2xpY2UiLAogICAgICAgICAgICAgICAgY2hpbGRyZW46IHBhcnRzCiAgICAgICAgICAgIH07CiAgICAgICAgfSwKICAKICAgICAgICBfcGFyc2VDb21wYXJhdG9yOiBmdW5jdGlvbihsZWZ0LCBjb21wYXJhdG9yKSB7CiAgICAgICAgICB2YXIgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyW2NvbXBhcmF0b3JdKTsKICAgICAgICAgIHJldHVybiB7dHlwZTogIkNvbXBhcmF0b3IiLCBuYW1lOiBjb21wYXJhdG9yLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgfSwKICAKICAgICAgICBfcGFyc2VEb3RSSFM6IGZ1bmN0aW9uKHJicCkgewogICAgICAgICAgICB2YXIgbG9va2FoZWFkID0gdGhpcy5fbG9va2FoZWFkKDApOwogICAgICAgICAgICB2YXIgZXhwclRva2VucyA9IFtUT0tfVU5RVU9URURJREVOVElGSUVSLCBUT0tfUVVPVEVESURFTlRJRklFUiwgVE9LX1NUQVJdOwogICAgICAgICAgICBpZiAoZXhwclRva2Vucy5pbmRleE9mKGxvb2thaGVhZCkgPj0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXhwcmVzc2lvbihyYnApOwogICAgICAgICAgICB9IGVsc2UgaWYgKGxvb2thaGVhZCA9PT0gVE9LX0xCUkFDS0VUKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfTEJSQUNLRVQpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlTXVsdGlzZWxlY3RMaXN0KCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobG9va2FoZWFkID09PSBUT0tfTEJSQUNFKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfTEJSQUNFKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZU11bHRpc2VsZWN0SGFzaCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBfcGFyc2VQcm9qZWN0aW9uUkhTOiBmdW5jdGlvbihyYnApIHsKICAgICAgICAgICAgdmFyIHJpZ2h0OwogICAgICAgICAgICBpZiAoYmluZGluZ1Bvd2VyW3RoaXMuX2xvb2thaGVhZCgwKV0gPCAxMCkgewogICAgICAgICAgICAgICAgcmlnaHQgPSB7dHlwZTogIklkZW50aXR5In07CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfTEJSQUNLRVQpIHsKICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKHJicCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfRklMVEVSKSB7CiAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihyYnApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0RPVCkgewogICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0RPVCk7CiAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlRG90UkhTKHJicCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJTeXRhbnggZXJyb3IsIHVuZXhwZWN0ZWQgdG9rZW46ICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQudmFsdWUgKyAiKCIgKyB0LnR5cGUgKyAiKSIpOwogICAgICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJQYXJzZXJFcnJvciI7CiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmlnaHQ7CiAgICAgICAgfSwKICAKICAgICAgICBfcGFyc2VNdWx0aXNlbGVjdExpc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgZXhwcmVzc2lvbnMgPSBbXTsKICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2xvb2thaGVhZCgwKSAhPT0gVE9LX1JCUkFDS0VUKSB7CiAgICAgICAgICAgICAgICB2YXIgZXhwcmVzc2lvbiA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgICAgICAgIGV4cHJlc3Npb25zLnB1c2goZXhwcmVzc2lvbik7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ09NTUEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfQ09NTUEpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19SQlJBQ0tFVCkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIHRva2VuIFJicmFja2V0Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0tFVCk7CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogIk11bHRpU2VsZWN0TGlzdCIsIGNoaWxkcmVuOiBleHByZXNzaW9uc307CiAgICAgICAgfSwKICAKICAgICAgICBfcGFyc2VNdWx0aXNlbGVjdEhhc2g6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHBhaXJzID0gW107CiAgICAgICAgICB2YXIgaWRlbnRpZmllclR5cGVzID0gW1RPS19VTlFVT1RFRElERU5USUZJRVIsIFRPS19RVU9URURJREVOVElGSUVSXTsKICAgICAgICAgIHZhciBrZXlUb2tlbiwga2V5TmFtZSwgdmFsdWUsIG5vZGU7CiAgICAgICAgICBmb3IgKDs7KSB7CiAgICAgICAgICAgIGtleVRva2VuID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICAgIGlmIChpZGVudGlmaWVyVHlwZXMuaW5kZXhPZihrZXlUb2tlbi50eXBlKSA8IDApIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGluZyBhbiBpZGVudGlmaWVyIHRva2VuLCBnb3Q6ICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXlUb2tlbi50eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBrZXlOYW1lID0ga2V5VG9rZW4udmFsdWU7CiAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0NPTE9OKTsKICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgIG5vZGUgPSB7dHlwZTogIktleVZhbHVlUGFpciIsIG5hbWU6IGtleU5hbWUsIHZhbHVlOiB2YWx1ZX07CiAgICAgICAgICAgIHBhaXJzLnB1c2gobm9kZSk7CiAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DT01NQSkgewogICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19DT01NQSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfUkJSQUNFKSB7CiAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDRSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB7dHlwZTogIk11bHRpU2VsZWN0SGFzaCIsIGNoaWxkcmVuOiBwYWlyc307CiAgICAgICAgfQogICAgfTsKICAKICAKICAgIGZ1bmN0aW9uIFRyZWVJbnRlcnByZXRlcihydW50aW1lKSB7CiAgICAgIHRoaXMucnVudGltZSA9IHJ1bnRpbWU7CiAgICB9CiAgCiAgICBUcmVlSW50ZXJwcmV0ZXIucHJvdG90eXBlID0gewogICAgICAgIHNlYXJjaDogZnVuY3Rpb24obm9kZSwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudmlzaXQobm9kZSwgdmFsdWUpOwogICAgICAgIH0sCiAgCiAgICAgICAgdmlzaXQ6IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBtYXRjaGVkLCBjdXJyZW50LCByZXN1bHQsIGZpcnN0LCBzZWNvbmQsIGZpZWxkLCBsZWZ0LCByaWdodCwgY29sbGVjdGVkLCBpOwogICAgICAgICAgICBzd2l0Y2ggKG5vZGUudHlwZSkgewogICAgICAgICAgICAgIGNhc2UgIkZpZWxkIjoKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgZmllbGQgPSB2YWx1ZVtub2RlLm5hbWVdOwogICAgICAgICAgICAgICAgICAgIGlmIChmaWVsZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWVsZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgIlN1YmV4cHJlc3Npb24iOgogICAgICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgcmVzdWx0KTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgICAgY2FzZSAiSW5kZXhFeHByZXNzaW9uIjoKICAgICAgICAgICAgICAgIGxlZnQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCBsZWZ0KTsKICAgICAgICAgICAgICAgIHJldHVybiByaWdodDsKICAgICAgICAgICAgICBjYXNlICJJbmRleCI6CiAgICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gbm9kZS52YWx1ZTsKICAgICAgICAgICAgICAgIGlmIChpbmRleCA8IDApIHsKICAgICAgICAgICAgICAgICAgaW5kZXggPSB2YWx1ZS5sZW5ndGggKyBpbmRleDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlc3VsdCA9IHZhbHVlW2luZGV4XTsKICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICByZXN1bHQgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICBjYXNlICJTbGljZSI6CiAgICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHNsaWNlUGFyYW1zID0gbm9kZS5jaGlsZHJlbi5zbGljZSgwKTsKICAgICAgICAgICAgICAgIHZhciBjb21wdXRlZCA9IHRoaXMuY29tcHV0ZVNsaWNlUGFyYW1zKHZhbHVlLmxlbmd0aCwgc2xpY2VQYXJhbXMpOwogICAgICAgICAgICAgICAgdmFyIHN0YXJ0ID0gY29tcHV0ZWRbMF07CiAgICAgICAgICAgICAgICB2YXIgc3RvcCA9IGNvbXB1dGVkWzFdOwogICAgICAgICAgICAgICAgdmFyIHN0ZXAgPSBjb21wdXRlZFsyXTsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgICAgICAgICAgaWYgKHN0ZXAgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gc3RhcnQ7IGkgPCBzdG9wOyBpICs9IHN0ZXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godmFsdWVbaV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gc3RhcnQ7IGkgPiBzdG9wOyBpICs9IHN0ZXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godmFsdWVbaV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgICAgY2FzZSAiUHJvamVjdGlvbiI6CiAgICAgICAgICAgICAgICAvLyBFdmFsdWF0ZSBsZWZ0IGNoaWxkLgogICAgICAgICAgICAgICAgdmFyIGJhc2UgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIGlmICghaXNBcnJheShiYXNlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbGxlY3RlZCA9IFtdOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGJhc2UubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgYmFzZVtpXSk7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29sbGVjdGVkLnB1c2goY3VycmVudCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBjb2xsZWN0ZWQ7CiAgICAgICAgICAgICAgY2FzZSAiVmFsdWVQcm9qZWN0aW9uIjoKICAgICAgICAgICAgICAgIC8vIEV2YWx1YXRlIGxlZnQgY2hpbGQuCiAgICAgICAgICAgICAgICBiYXNlID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBpZiAoIWlzT2JqZWN0KGJhc2UpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29sbGVjdGVkID0gW107CiAgICAgICAgICAgICAgICB2YXIgdmFsdWVzID0gb2JqVmFsdWVzKGJhc2UpOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBjdXJyZW50ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCB2YWx1ZXNbaV0pOwogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbGxlY3RlZC5wdXNoKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gY29sbGVjdGVkOwogICAgICAgICAgICAgIGNhc2UgIkZpbHRlclByb2plY3Rpb24iOgogICAgICAgICAgICAgICAgYmFzZSA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KGJhc2UpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGZpbHRlcmVkID0gW107CiAgICAgICAgICAgICAgICB2YXIgZmluYWxSZXN1bHRzID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYmFzZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBtYXRjaGVkID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzJdLCBiYXNlW2ldKTsKICAgICAgICAgICAgICAgICAgaWYgKCFpc0ZhbHNlKG1hdGNoZWQpKSB7CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyZWQucHVzaChiYXNlW2ldKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBmaWx0ZXJlZC5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgICBjdXJyZW50ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCBmaWx0ZXJlZFtqXSk7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZmluYWxSZXN1bHRzLnB1c2goY3VycmVudCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBmaW5hbFJlc3VsdHM7CiAgICAgICAgICAgICAgY2FzZSAiQ29tcGFyYXRvciI6CiAgICAgICAgICAgICAgICBmaXJzdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgc2Vjb25kID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBzd2l0Y2gobm9kZS5uYW1lKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgVE9LX0VROgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHN0cmljdERlZXBFcXVhbChmaXJzdCwgc2Vjb25kKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBUT0tfTkU6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gIXN0cmljdERlZXBFcXVhbChmaXJzdCwgc2Vjb25kKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBUT0tfR1Q6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZmlyc3QgPiBzZWNvbmQ7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgVE9LX0dURToKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBmaXJzdCA+PSBzZWNvbmQ7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgVE9LX0xUOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZpcnN0IDwgc2Vjb25kOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIFRPS19MVEU6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZmlyc3QgPD0gc2Vjb25kOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBjb21wYXJhdG9yOiAiICsgbm9kZS5uYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgICAgY2FzZSBUT0tfRkxBVFRFTjoKICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KG9yaWdpbmFsKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBtZXJnZWQgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBvcmlnaW5hbC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBjdXJyZW50ID0gb3JpZ2luYWxbaV07CiAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KGN1cnJlbnQpKSB7CiAgICAgICAgICAgICAgICAgICAgbWVyZ2VkLnB1c2guYXBwbHkobWVyZ2VkLCBjdXJyZW50KTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtZXJnZWQucHVzaChjdXJyZW50KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG1lcmdlZDsKICAgICAgICAgICAgICBjYXNlICJJZGVudGl0eSI6CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgY2FzZSAiTXVsdGlTZWxlY3RMaXN0IjoKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbGxlY3RlZCA9IFtdOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjb2xsZWN0ZWQucHVzaCh0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5baV0sIHZhbHVlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gY29sbGVjdGVkOwogICAgICAgICAgICAgIGNhc2UgIk11bHRpU2VsZWN0SGFzaCI6CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb2xsZWN0ZWQgPSB7fTsKICAgICAgICAgICAgICAgIHZhciBjaGlsZDsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGNoaWxkID0gbm9kZS5jaGlsZHJlbltpXTsKICAgICAgICAgICAgICAgICAgY29sbGVjdGVkW2NoaWxkLm5hbWVdID0gdGhpcy52aXNpdChjaGlsZC52YWx1ZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3RlZDsKICAgICAgICAgICAgICBjYXNlICJPckV4cHJlc3Npb24iOgogICAgICAgICAgICAgICAgbWF0Y2hlZCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKGlzRmFsc2UobWF0Y2hlZCkpIHsKICAgICAgICAgICAgICAgICAgICBtYXRjaGVkID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbWF0Y2hlZDsKICAgICAgICAgICAgICBjYXNlICJBbmRFeHByZXNzaW9uIjoKICAgICAgICAgICAgICAgIGZpcnN0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgCiAgICAgICAgICAgICAgICBpZiAoaXNGYWxzZShmaXJzdCkgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpcnN0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgdmFsdWUpOwogICAgICAgICAgICAgIGNhc2UgIk5vdEV4cHJlc3Npb24iOgogICAgICAgICAgICAgICAgZmlyc3QgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIHJldHVybiBpc0ZhbHNlKGZpcnN0KTsKICAgICAgICAgICAgICBjYXNlICJMaXRlcmFsIjoKICAgICAgICAgICAgICAgIHJldHVybiBub2RlLnZhbHVlOwogICAgICAgICAgICAgIGNhc2UgVE9LX1BJUEU6CiAgICAgICAgICAgICAgICBsZWZ0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCBsZWZ0KTsKICAgICAgICAgICAgICBjYXNlIFRPS19DVVJSRU5UOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgIGNhc2UgIkZ1bmN0aW9uIjoKICAgICAgICAgICAgICAgIHZhciByZXNvbHZlZEFyZ3MgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRBcmdzLnB1c2godGhpcy52aXNpdChub2RlLmNoaWxkcmVuW2ldLCB2YWx1ZSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucnVudGltZS5jYWxsRnVuY3Rpb24obm9kZS5uYW1lLCByZXNvbHZlZEFyZ3MpOwogICAgICAgICAgICAgIGNhc2UgIkV4cHJlc3Npb25SZWZlcmVuY2UiOgogICAgICAgICAgICAgICAgdmFyIHJlZk5vZGUgPSBub2RlLmNoaWxkcmVuWzBdOwogICAgICAgICAgICAgICAgLy8gVGFnIHRoZSBub2RlIHdpdGggYSBzcGVjaWZpYyBhdHRyaWJ1dGUgc28gdGhlIHR5cGUKICAgICAgICAgICAgICAgIC8vIGNoZWNrZXIgdmVyaWZ5IHRoZSB0eXBlLgogICAgICAgICAgICAgICAgcmVmTm9kZS5qbWVzcGF0aFR5cGUgPSBUT0tfRVhQUkVGOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlZk5vZGU7CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBub2RlIHR5cGU6ICIgKyBub2RlLnR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBjb21wdXRlU2xpY2VQYXJhbXM6IGZ1bmN0aW9uKGFycmF5TGVuZ3RoLCBzbGljZVBhcmFtcykgewogICAgICAgICAgdmFyIHN0YXJ0ID0gc2xpY2VQYXJhbXNbMF07CiAgICAgICAgICB2YXIgc3RvcCA9IHNsaWNlUGFyYW1zWzFdOwogICAgICAgICAgdmFyIHN0ZXAgPSBzbGljZVBhcmFtc1syXTsKICAgICAgICAgIHZhciBjb21wdXRlZCA9IFtudWxsLCBudWxsLCBudWxsXTsKICAgICAgICAgIGlmIChzdGVwID09PSBudWxsKSB7CiAgICAgICAgICAgIHN0ZXAgPSAxOwogICAgICAgICAgfSBlbHNlIGlmIChzdGVwID09PSAwKSB7CiAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiSW52YWxpZCBzbGljZSwgc3RlcCBjYW5ub3QgYmUgMCIpOwogICAgICAgICAgICBlcnJvci5uYW1lID0gIlJ1bnRpbWVFcnJvciI7CiAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHN0ZXBWYWx1ZU5lZ2F0aXZlID0gc3RlcCA8IDAgPyB0cnVlIDogZmFsc2U7CiAgCiAgICAgICAgICBpZiAoc3RhcnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICBzdGFydCA9IHN0ZXBWYWx1ZU5lZ2F0aXZlID8gYXJyYXlMZW5ndGggLSAxIDogMDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLmNhcFNsaWNlUmFuZ2UoYXJyYXlMZW5ndGgsIHN0YXJ0LCBzdGVwKTsKICAgICAgICAgIH0KICAKICAgICAgICAgIGlmIChzdG9wID09PSBudWxsKSB7CiAgICAgICAgICAgICAgc3RvcCA9IHN0ZXBWYWx1ZU5lZ2F0aXZlID8gLTEgOiBhcnJheUxlbmd0aDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RvcCA9IHRoaXMuY2FwU2xpY2VSYW5nZShhcnJheUxlbmd0aCwgc3RvcCwgc3RlcCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb21wdXRlZFswXSA9IHN0YXJ0OwogICAgICAgICAgY29tcHV0ZWRbMV0gPSBzdG9wOwogICAgICAgICAgY29tcHV0ZWRbMl0gPSBzdGVwOwogICAgICAgICAgcmV0dXJuIGNvbXB1dGVkOwogICAgICAgIH0sCiAgCiAgICAgICAgY2FwU2xpY2VSYW5nZTogZnVuY3Rpb24oYXJyYXlMZW5ndGgsIGFjdHVhbFZhbHVlLCBzdGVwKSB7CiAgICAgICAgICAgIGlmIChhY3R1YWxWYWx1ZSA8IDApIHsKICAgICAgICAgICAgICAgIGFjdHVhbFZhbHVlICs9IGFycmF5TGVuZ3RoOwogICAgICAgICAgICAgICAgaWYgKGFjdHVhbFZhbHVlIDwgMCkgewogICAgICAgICAgICAgICAgICAgIGFjdHVhbFZhbHVlID0gc3RlcCA8IDAgPyAtMSA6IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0dWFsVmFsdWUgPj0gYXJyYXlMZW5ndGgpIHsKICAgICAgICAgICAgICAgIGFjdHVhbFZhbHVlID0gc3RlcCA8IDAgPyBhcnJheUxlbmd0aCAtIDEgOiBhcnJheUxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYWN0dWFsVmFsdWU7CiAgICAgICAgfQogIAogICAgfTsKICAKICAgIGZ1bmN0aW9uIFJ1bnRpbWUoaW50ZXJwcmV0ZXIpIHsKICAgICAgdGhpcy5faW50ZXJwcmV0ZXIgPSBpbnRlcnByZXRlcjsKICAgICAgdGhpcy5mdW5jdGlvblRhYmxlID0gewogICAgICAgICAgLy8gbmFtZTogW2Z1bmN0aW9uLCA8c2lnbmF0dXJlPl0KICAgICAgICAgIC8vIFRoZSA8c2lnbmF0dXJlPiBjYW4gYmU6CiAgICAgICAgICAvLwogICAgICAgICAgLy8gewogICAgICAgICAgLy8gICBhcmdzOiBbW3R5cGUxLCB0eXBlMl0sIFt0eXBlMSwgdHlwZTJdXSwKICAgICAgICAgIC8vICAgdmFyaWFkaWM6IHRydWV8ZmFsc2UKICAgICAgICAgIC8vIH0KICAgICAgICAgIC8vCiAgICAgICAgICAvLyBFYWNoIGFyZyBpbiB0aGUgYXJnIGxpc3QgaXMgYSBsaXN0IG9mIHZhbGlkIHR5cGVzCiAgICAgICAgICAvLyAoaWYgdGhlIGZ1bmN0aW9uIGlzIG92ZXJsb2FkZWQgYW5kIHN1cHBvcnRzIG11bHRpcGxlCiAgICAgICAgICAvLyB0eXBlcy4gIElmIHRoZSB0eXBlIGlzICJhbnkiIHRoZW4gbm8gdHlwZSBjaGVja2luZwogICAgICAgICAgLy8gb2NjdXJzIG9uIHRoZSBhcmd1bWVudC4gIFZhcmlhZGljIGlzIG9wdGlvbmFsCiAgICAgICAgICAvLyBhbmQgaWYgbm90IHByb3ZpZGVkIGlzIGFzc3VtZWQgdG8gYmUgZmFsc2UuCiAgICAgICAgICBhYnM6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25BYnMsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX05VTUJFUl19XX0sCiAgICAgICAgICBhdmc6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25BdmcsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZX05VTUJFUl19XX0sCiAgICAgICAgICBjZWlsOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uQ2VpbCwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfTlVNQkVSXX1dfSwKICAgICAgICAgIGNvbnRhaW5zOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uQ29udGFpbnMsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfU1RSSU5HLCBUWVBFX0FSUkFZXX0sCiAgICAgICAgICAgICAgICAgICAgICAgICAge3R5cGVzOiBbVFlQRV9BTlldfV19LAogICAgICAgICAgImVuZHNfd2l0aCI6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25FbmRzV2l0aCwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9TVFJJTkddfSwge3R5cGVzOiBbVFlQRV9TVFJJTkddfV19LAogICAgICAgICAgZmxvb3I6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25GbG9vciwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfTlVNQkVSXX1dfSwKICAgICAgICAgIGxlbmd0aDogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbkxlbmd0aCwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9TVFJJTkcsIFRZUEVfQVJSQVksIFRZUEVfT0JKRUNUXX1dfSwKICAgICAgICAgIG1hcDogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1hcCwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9FWFBSRUZdfSwge3R5cGVzOiBbVFlQRV9BUlJBWV19XX0sCiAgICAgICAgICBtYXg6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NYXgsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVlfTlVNQkVSLCBUWVBFX0FSUkFZX1NUUklOR119XX0sCiAgICAgICAgICAibWVyZ2UiOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWVyZ2UsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfT0JKRUNUXSwgdmFyaWFkaWM6IHRydWV9XQogICAgICAgICAgfSwKICAgICAgICAgICJtYXhfYnkiOiB7CiAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1heEJ5LAogICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV19LCB7dHlwZXM6IFtUWVBFX0VYUFJFRl19XQogICAgICAgICAgfSwKICAgICAgICAgIHN1bToge19mdW5jOiB0aGlzLl9mdW5jdGlvblN1bSwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVlfTlVNQkVSXX1dfSwKICAgICAgICAgICJzdGFydHNfd2l0aCI6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25TdGFydHNXaXRoLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX1NUUklOR119LCB7dHlwZXM6IFtUWVBFX1NUUklOR119XX0sCiAgICAgICAgICBtaW46IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NaW4sCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVlfTlVNQkVSLCBUWVBFX0FSUkFZX1NUUklOR119XX0sCiAgICAgICAgICAibWluX2J5IjogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NaW5CeSwKICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVldfSwge3R5cGVzOiBbVFlQRV9FWFBSRUZdfV0KICAgICAgICAgIH0sCiAgICAgICAgICB0eXBlOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uVHlwZSwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQU5ZXX1dfSwKICAgICAgICAgIGtleXM6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25LZXlzLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9PQkpFQ1RdfV19LAogICAgICAgICAgdmFsdWVzOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uVmFsdWVzLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9PQkpFQ1RdfV19LAogICAgICAgICAgc29ydDoge19mdW5jOiB0aGlzLl9mdW5jdGlvblNvcnQsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZX1NUUklORywgVFlQRV9BUlJBWV9OVU1CRVJdfV19LAogICAgICAgICAgInNvcnRfYnkiOiB7CiAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvblNvcnRCeSwKICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVldfSwge3R5cGVzOiBbVFlQRV9FWFBSRUZdfV0KICAgICAgICAgIH0sCiAgICAgICAgICBqb2luOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uSm9pbiwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbCiAgICAgICAgICAgICAgICAgIHt0eXBlczogW1RZUEVfU1RSSU5HXX0sCiAgICAgICAgICAgICAgICAgIHt0eXBlczogW1RZUEVfQVJSQVlfU1RSSU5HXX0KICAgICAgICAgICAgICBdCiAgICAgICAgICB9LAogICAgICAgICAgcmV2ZXJzZTogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvblJldmVyc2UsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfU1RSSU5HLCBUWVBFX0FSUkFZXX1dfSwKICAgICAgICAgICJ0b19hcnJheSI6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25Ub0FycmF5LCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BTlldfV19LAogICAgICAgICAgInRvX3N0cmluZyI6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25Ub1N0cmluZywgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQU5ZXX1dfSwKICAgICAgICAgICJ0b19udW1iZXIiOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uVG9OdW1iZXIsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FOWV19XX0sCiAgICAgICAgICAibm90X251bGwiOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTm90TnVsbCwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BTlldLCB2YXJpYWRpYzogdHJ1ZX1dCiAgICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgCiAgICBSdW50aW1lLnByb3RvdHlwZSA9IHsKICAgICAgY2FsbEZ1bmN0aW9uOiBmdW5jdGlvbihuYW1lLCByZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgZnVuY3Rpb25FbnRyeSA9IHRoaXMuZnVuY3Rpb25UYWJsZVtuYW1lXTsKICAgICAgICBpZiAoZnVuY3Rpb25FbnRyeSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBmdW5jdGlvbjogIiArIG5hbWUgKyAiKCkiKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fdmFsaWRhdGVBcmdzKG5hbWUsIHJlc29sdmVkQXJncywgZnVuY3Rpb25FbnRyeS5fc2lnbmF0dXJlKTsKICAgICAgICByZXR1cm4gZnVuY3Rpb25FbnRyeS5fZnVuYy5jYWxsKHRoaXMsIHJlc29sdmVkQXJncyk7CiAgICAgIH0sCiAgCiAgICAgIF92YWxpZGF0ZUFyZ3M6IGZ1bmN0aW9uKG5hbWUsIGFyZ3MsIHNpZ25hdHVyZSkgewogICAgICAgICAgLy8gVmFsaWRhdGluZyB0aGUgYXJncyByZXF1aXJlcyB2YWxpZGF0aW5nCiAgICAgICAgICAvLyB0aGUgY29ycmVjdCBhcml0eSBhbmQgdGhlIGNvcnJlY3QgdHlwZSBvZiBlYWNoIGFyZy4KICAgICAgICAgIC8vIElmIHRoZSBsYXN0IGFyZ3VtZW50IGlzIGRlY2xhcmVkIGFzIHZhcmlhZGljLCB0aGVuIHdlIG5lZWQKICAgICAgICAgIC8vIGEgbWluaW11bSBudW1iZXIgb2YgYXJncyB0byBiZSByZXF1aXJlZC4gIE90aGVyd2lzZSBpdCBoYXMgdG8KICAgICAgICAgIC8vIGJlIGFuIGV4YWN0IGFtb3VudC4KICAgICAgICAgIHZhciBwbHVyYWxpemVkOwogICAgICAgICAgaWYgKHNpZ25hdHVyZVtzaWduYXR1cmUubGVuZ3RoIC0gMV0udmFyaWFkaWMpIHsKICAgICAgICAgICAgICBpZiAoYXJncy5sZW5ndGggPCBzaWduYXR1cmUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHBsdXJhbGl6ZWQgPSBzaWduYXR1cmUubGVuZ3RoID09PSAxID8gIiBhcmd1bWVudCIgOiAiIGFyZ3VtZW50cyI7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQXJndW1lbnRFcnJvcjogIiArIG5hbWUgKyAiKCkgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGFrZXMgYXQgbGVhc3QiICsgc2lnbmF0dXJlLmxlbmd0aCArIHBsdXJhbGl6ZWQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBidXQgcmVjZWl2ZWQgIiArIGFyZ3MubGVuZ3RoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGFyZ3MubGVuZ3RoICE9PSBzaWduYXR1cmUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgcGx1cmFsaXplZCA9IHNpZ25hdHVyZS5sZW5ndGggPT09IDEgPyAiIGFyZ3VtZW50IiA6ICIgYXJndW1lbnRzIjsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFyZ3VtZW50RXJyb3I6ICIgKyBuYW1lICsgIigpICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGFrZXMgIiArIHNpZ25hdHVyZS5sZW5ndGggKyBwbHVyYWxpemVkICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBidXQgcmVjZWl2ZWQgIiArIGFyZ3MubGVuZ3RoKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50U3BlYzsKICAgICAgICAgIHZhciBhY3R1YWxUeXBlOwogICAgICAgICAgdmFyIHR5cGVNYXRjaGVkOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzaWduYXR1cmUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB0eXBlTWF0Y2hlZCA9IGZhbHNlOwogICAgICAgICAgICAgIGN1cnJlbnRTcGVjID0gc2lnbmF0dXJlW2ldLnR5cGVzOwogICAgICAgICAgICAgIGFjdHVhbFR5cGUgPSB0aGlzLl9nZXRUeXBlTmFtZShhcmdzW2ldKTsKICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGN1cnJlbnRTcGVjLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl90eXBlTWF0Y2hlcyhhY3R1YWxUeXBlLCBjdXJyZW50U3BlY1tqXSwgYXJnc1tpXSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGVNYXRjaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghdHlwZU1hdGNoZWQpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUeXBlRXJyb3I6ICIgKyBuYW1lICsgIigpICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImV4cGVjdGVkIGFyZ3VtZW50ICIgKyAoaSArIDEpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgdG8gYmUgdHlwZSAiICsgY3VycmVudFNwZWMgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBidXQgcmVjZWl2ZWQgdHlwZSAiICsgYWN0dWFsVHlwZSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9LAogIAogICAgICBfdHlwZU1hdGNoZXM6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIGFyZ1ZhbHVlKSB7CiAgICAgICAgICBpZiAoZXhwZWN0ZWQgPT09IFRZUEVfQU5ZKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXhwZWN0ZWQgPT09IFRZUEVfQVJSQVlfU1RSSU5HIHx8CiAgICAgICAgICAgICAgZXhwZWN0ZWQgPT09IFRZUEVfQVJSQVlfTlVNQkVSIHx8CiAgICAgICAgICAgICAgZXhwZWN0ZWQgPT09IFRZUEVfQVJSQVkpIHsKICAgICAgICAgICAgICAvLyBUaGUgZXhwZWN0ZWQgdHlwZSBjYW4gZWl0aGVyIGp1c3QgYmUgYXJyYXksCiAgICAgICAgICAgICAgLy8gb3IgaXQgY2FuIHJlcXVpcmUgYSBzcGVjaWZpYyBzdWJ0eXBlIChhcnJheSBvZiBudW1iZXJzKS4KICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgIC8vIFRoZSBzaW1wbGVzdCBjYXNlIGlzIGlmICJhcnJheSIgd2l0aCBubyBzdWJ0eXBlIGlzIHNwZWNpZmllZC4KICAgICAgICAgICAgICBpZiAoZXhwZWN0ZWQgPT09IFRZUEVfQVJSQVkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjdHVhbCA9PT0gVFlQRV9BUlJBWTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFjdHVhbCA9PT0gVFlQRV9BUlJBWSkgewogICAgICAgICAgICAgICAgICAvLyBPdGhlcndpc2Ugd2UgbmVlZCB0byBjaGVjayBzdWJ0eXBlcy4KICAgICAgICAgICAgICAgICAgLy8gSSB0aGluayB0aGlzIGhhcyBwb3RlbnRpYWwgdG8gYmUgaW1wcm92ZWQuCiAgICAgICAgICAgICAgICAgIHZhciBzdWJ0eXBlOwogICAgICAgICAgICAgICAgICBpZiAoZXhwZWN0ZWQgPT09IFRZUEVfQVJSQVlfTlVNQkVSKSB7CiAgICAgICAgICAgICAgICAgICAgc3VidHlwZSA9IFRZUEVfTlVNQkVSOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FSUkFZX1NUUklORykgewogICAgICAgICAgICAgICAgICAgIHN1YnR5cGUgPSBUWVBFX1NUUklORzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ1ZhbHVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX3R5cGVNYXRjaGVzKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9nZXRUeXBlTmFtZShhcmdWYWx1ZVtpXSksIHN1YnR5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnVmFsdWVbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIGFjdHVhbCA9PT0gZXhwZWN0ZWQ7CiAgICAgICAgICB9CiAgICAgIH0sCiAgICAgIF9nZXRUeXBlTmFtZTogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICBzd2l0Y2ggKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopKSB7CiAgICAgICAgICAgICAgY2FzZSAiW29iamVjdCBTdHJpbmddIjoKICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX1NUUklORzsKICAgICAgICAgICAgICBjYXNlICJbb2JqZWN0IE51bWJlcl0iOgogICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfTlVNQkVSOwogICAgICAgICAgICAgIGNhc2UgIltvYmplY3QgQXJyYXldIjoKICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX0FSUkFZOwogICAgICAgICAgICAgIGNhc2UgIltvYmplY3QgQm9vbGVhbl0iOgogICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfQk9PTEVBTjsKICAgICAgICAgICAgICBjYXNlICJbb2JqZWN0IE51bGxdIjoKICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX05VTEw7CiAgICAgICAgICAgICAgY2FzZSAiW29iamVjdCBPYmplY3RdIjoKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGl0J3MgYW4gZXhwcmVmLiAgSWYgaXQgaGFzLCBpdCdzIGJlZW4KICAgICAgICAgICAgICAgIC8vIHRhZ2dlZCB3aXRoIGEgam1lc3BhdGhUeXBlIGF0dHIgb2YgJ0V4cHJlZic7CiAgICAgICAgICAgICAgICBpZiAob2JqLmptZXNwYXRoVHlwZSA9PT0gVE9LX0VYUFJFRikgewogICAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9FWFBSRUY7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9PQkpFQ1Q7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblN0YXJ0c1dpdGg6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXS5sYXN0SW5kZXhPZihyZXNvbHZlZEFyZ3NbMV0pID09PSAwOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25FbmRzV2l0aDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICB2YXIgc2VhcmNoU3RyID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgdmFyIHN1ZmZpeCA9IHJlc29sdmVkQXJnc1sxXTsKICAgICAgICAgIHJldHVybiBzZWFyY2hTdHIuaW5kZXhPZihzdWZmaXgsIHNlYXJjaFN0ci5sZW5ndGggLSBzdWZmaXgubGVuZ3RoKSAhPT0gLTE7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblJldmVyc2U6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIHR5cGVOYW1lID0gdGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgICAgIGlmICh0eXBlTmFtZSA9PT0gVFlQRV9TVFJJTkcpIHsKICAgICAgICAgICAgdmFyIG9yaWdpbmFsU3RyID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgICB2YXIgcmV2ZXJzZWRTdHIgPSAiIjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IG9yaWdpbmFsU3RyLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICByZXZlcnNlZFN0ciArPSBvcmlnaW5hbFN0cltpXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmV2ZXJzZWRTdHI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcmV2ZXJzZWRBcnJheSA9IHJlc29sdmVkQXJnc1swXS5zbGljZSgwKTsKICAgICAgICAgICAgcmV2ZXJzZWRBcnJheS5yZXZlcnNlKCk7CiAgICAgICAgICAgIHJldHVybiByZXZlcnNlZEFycmF5OwogICAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25BYnM6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHJldHVybiBNYXRoLmFicyhyZXNvbHZlZEFyZ3NbMF0pOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25DZWlsOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHJldHVybiBNYXRoLmNlaWwocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uQXZnOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciBzdW0gPSAwOwogICAgICAgICAgdmFyIGlucHV0QXJyYXkgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGlucHV0QXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBzdW0gKz0gaW5wdXRBcnJheVtpXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzdW0gLyBpbnB1dEFycmF5Lmxlbmd0aDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uQ29udGFpbnM6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXS5pbmRleE9mKHJlc29sdmVkQXJnc1sxXSkgPj0gMDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uRmxvb3I6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTGVuZ3RoOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgaWYgKCFpc09iamVjdChyZXNvbHZlZEFyZ3NbMF0pKSB7CiAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXS5sZW5ndGg7CiAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgLy8gQXMgZmFyIGFzIEkgY2FuIHRlbGwsIHRoZXJlJ3Mgbm8gd2F5IHRvIGdldCB0aGUgbGVuZ3RoCiAgICAgICAgICAgLy8gb2YgYW4gb2JqZWN0IHdpdGhvdXQgTyhuKSBpdGVyYXRpb24gdGhyb3VnaCB0aGUgb2JqZWN0LgogICAgICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhyZXNvbHZlZEFyZ3NbMF0pLmxlbmd0aDsKICAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25NYXA6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBtYXBwZWQgPSBbXTsKICAgICAgICB2YXIgaW50ZXJwcmV0ZXIgPSB0aGlzLl9pbnRlcnByZXRlcjsKICAgICAgICB2YXIgZXhwcmVmTm9kZSA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICB2YXIgZWxlbWVudHMgPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBtYXBwZWQucHVzaChpbnRlcnByZXRlci52aXNpdChleHByZWZOb2RlLCBlbGVtZW50c1tpXSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbWFwcGVkOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25NZXJnZTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIG1lcmdlZCA9IHt9OwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzb2x2ZWRBcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgY3VycmVudCA9IHJlc29sdmVkQXJnc1tpXTsKICAgICAgICAgIGZvciAodmFyIGtleSBpbiBjdXJyZW50KSB7CiAgICAgICAgICAgIG1lcmdlZFtrZXldID0gY3VycmVudFtrZXldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbWVyZ2VkOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25NYXg6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIGlmIChyZXNvbHZlZEFyZ3NbMF0ubGVuZ3RoID4gMCkgewogICAgICAgICAgdmFyIHR5cGVOYW1lID0gdGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdWzBdKTsKICAgICAgICAgIGlmICh0eXBlTmFtZSA9PT0gVFlQRV9OVU1CRVIpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGgubWF4LmFwcGx5KE1hdGgsIHJlc29sdmVkQXJnc1swXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZWxlbWVudHMgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICAgIHZhciBtYXhFbGVtZW50ID0gZWxlbWVudHNbMF07CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChtYXhFbGVtZW50LmxvY2FsZUNvbXBhcmUoZWxlbWVudHNbaV0pIDwgMCkgewogICAgICAgICAgICAgICAgICAgIG1heEVsZW1lbnQgPSBlbGVtZW50c1tpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWF4RWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbk1pbjogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgaWYgKHJlc29sdmVkQXJnc1swXS5sZW5ndGggPiAwKSB7CiAgICAgICAgICB2YXIgdHlwZU5hbWUgPSB0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF1bMF0pOwogICAgICAgICAgaWYgKHR5cGVOYW1lID09PSBUWVBFX05VTUJFUikgewogICAgICAgICAgICByZXR1cm4gTWF0aC5taW4uYXBwbHkoTWF0aCwgcmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50cyA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgICAgdmFyIG1pbkVsZW1lbnQgPSBlbGVtZW50c1swXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnRzW2ldLmxvY2FsZUNvbXBhcmUobWluRWxlbWVudCkgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgbWluRWxlbWVudCA9IGVsZW1lbnRzW2ldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtaW5FbGVtZW50OwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblN1bTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIHN1bSA9IDA7CiAgICAgICAgdmFyIGxpc3RUb1N1bSA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3RUb1N1bS5sZW5ndGg7IGkrKykgewogICAgICAgICAgc3VtICs9IGxpc3RUb1N1bVtpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN1bTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uVHlwZTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICBzd2l0Y2ggKHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXSkpIHsKICAgICAgICAgICAgY2FzZSBUWVBFX05VTUJFUjoKICAgICAgICAgICAgICByZXR1cm4gIm51bWJlciI7CiAgICAgICAgICAgIGNhc2UgVFlQRV9TVFJJTkc6CiAgICAgICAgICAgICAgcmV0dXJuICJzdHJpbmciOwogICAgICAgICAgICBjYXNlIFRZUEVfQVJSQVk6CiAgICAgICAgICAgICAgcmV0dXJuICJhcnJheSI7CiAgICAgICAgICAgIGNhc2UgVFlQRV9PQkpFQ1Q6CiAgICAgICAgICAgICAgcmV0dXJuICJvYmplY3QiOwogICAgICAgICAgICBjYXNlIFRZUEVfQk9PTEVBTjoKICAgICAgICAgICAgICByZXR1cm4gImJvb2xlYW4iOwogICAgICAgICAgICBjYXNlIFRZUEVfRVhQUkVGOgogICAgICAgICAgICAgIHJldHVybiAiZXhwcmVmIjsKICAgICAgICAgICAgY2FzZSBUWVBFX05VTEw6CiAgICAgICAgICAgICAgcmV0dXJuICJudWxsIjsKICAgICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uS2V5czogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uVmFsdWVzOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciBvYmogPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKG9iaik7CiAgICAgICAgICB2YXIgdmFsdWVzID0gW107CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YWx1ZXMucHVzaChvYmpba2V5c1tpXV0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uSm9pbjogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICB2YXIgam9pbkNoYXIgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICB2YXIgbGlzdEpvaW4gPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgICAgICByZXR1cm4gbGlzdEpvaW4uam9pbihqb2luQ2hhcik7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblRvQXJyYXk6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgaWYgKHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXSkgPT09IFRZUEVfQVJSQVkpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gW3Jlc29sdmVkQXJnc1swXV07CiAgICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblRvU3RyaW5nOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIGlmICh0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF0pID09PSBUWVBFX1NUUklORykgewogICAgICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShyZXNvbHZlZEFyZ3NbMF0pOwogICAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Ub051bWJlcjogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICB2YXIgdHlwZU5hbWUgPSB0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF0pOwogICAgICAgICAgdmFyIGNvbnZlcnRlZFZhbHVlOwogICAgICAgICAgaWYgKHR5cGVOYW1lID09PSBUWVBFX05VTUJFUikgewogICAgICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVOYW1lID09PSBUWVBFX1NUUklORykgewogICAgICAgICAgICAgIGNvbnZlcnRlZFZhbHVlID0gK3Jlc29sdmVkQXJnc1swXTsKICAgICAgICAgICAgICBpZiAoIWlzTmFOKGNvbnZlcnRlZFZhbHVlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udmVydGVkVmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbk5vdE51bGw6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvbHZlZEFyZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBpZiAodGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzW2ldKSAhPT0gVFlQRV9OVUxMKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbaV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblNvcnQ6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIHNvcnRlZEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdLnNsaWNlKDApOwogICAgICAgICAgc29ydGVkQXJyYXkuc29ydCgpOwogICAgICAgICAgcmV0dXJuIHNvcnRlZEFycmF5OwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Tb3J0Qnk6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIHNvcnRlZEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdLnNsaWNlKDApOwogICAgICAgICAgaWYgKHNvcnRlZEFycmF5Lmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgIHJldHVybiBzb3J0ZWRBcnJheTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnRlcnByZXRlciA9IHRoaXMuX2ludGVycHJldGVyOwogICAgICAgICAgdmFyIGV4cHJlZk5vZGUgPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgICAgICB2YXIgcmVxdWlyZWRUeXBlID0gdGhpcy5fZ2V0VHlwZU5hbWUoCiAgICAgICAgICAgICAgaW50ZXJwcmV0ZXIudmlzaXQoZXhwcmVmTm9kZSwgc29ydGVkQXJyYXlbMF0pKTsKICAgICAgICAgIGlmIChbVFlQRV9OVU1CRVIsIFRZUEVfU1RSSU5HXS5pbmRleE9mKHJlcXVpcmVkVHlwZSkgPCAwKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUeXBlRXJyb3IiKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgIC8vIEluIG9yZGVyIHRvIGdldCBhIHN0YWJsZSBzb3J0IG91dCBvZiBhbiB1bnN0YWJsZQogICAgICAgICAgLy8gc29ydCBhbGdvcml0aG0sIHdlIGRlY29yYXRlL3NvcnQvdW5kZWNvcmF0ZSAoRFNVKQogICAgICAgICAgLy8gYnkgY3JlYXRpbmcgYSBuZXcgbGlzdCBvZiBbaW5kZXgsIGVsZW1lbnRdIHBhaXJzLgogICAgICAgICAgLy8gSW4gdGhlIGNtcCBmdW5jdGlvbiwgaWYgdGhlIGV2YWx1YXRlZCBlbGVtZW50cyBhcmUKICAgICAgICAgIC8vIGVxdWFsLCB0aGVuIHRoZSBpbmRleCB3aWxsIGJlIHVzZWQgYXMgdGhlIHRpZWJyZWFrZXIuCiAgICAgICAgICAvLyBBZnRlciB0aGUgZGVjb3JhdGVkIGxpc3QgaGFzIGJlZW4gc29ydGVkLCBpdCB3aWxsIGJlCiAgICAgICAgICAvLyB1bmRlY29yYXRlZCB0byBleHRyYWN0IHRoZSBvcmlnaW5hbCBlbGVtZW50cy4KICAgICAgICAgIHZhciBkZWNvcmF0ZWQgPSBbXTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc29ydGVkQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgZGVjb3JhdGVkLnB1c2goW2ksIHNvcnRlZEFycmF5W2ldXSk7CiAgICAgICAgICB9CiAgICAgICAgICBkZWNvcmF0ZWQuc29ydChmdW5jdGlvbihhLCBiKSB7CiAgICAgICAgICAgIHZhciBleHByQSA9IGludGVycHJldGVyLnZpc2l0KGV4cHJlZk5vZGUsIGFbMV0pOwogICAgICAgICAgICB2YXIgZXhwckIgPSBpbnRlcnByZXRlci52aXNpdChleHByZWZOb2RlLCBiWzFdKTsKICAgICAgICAgICAgaWYgKHRoYXQuX2dldFR5cGVOYW1lKGV4cHJBKSAhPT0gcmVxdWlyZWRUeXBlKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgICAgICAgICAgIlR5cGVFcnJvcjogZXhwZWN0ZWQgIiArIHJlcXVpcmVkVHlwZSArICIsIHJlY2VpdmVkICIgKwogICAgICAgICAgICAgICAgICAgIHRoYXQuX2dldFR5cGVOYW1lKGV4cHJBKSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhhdC5fZ2V0VHlwZU5hbWUoZXhwckIpICE9PSByZXF1aXJlZFR5cGUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAgICAgICAiVHlwZUVycm9yOiBleHBlY3RlZCAiICsgcmVxdWlyZWRUeXBlICsgIiwgcmVjZWl2ZWQgIiArCiAgICAgICAgICAgICAgICAgICAgdGhhdC5fZ2V0VHlwZU5hbWUoZXhwckIpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXhwckEgPiBleHByQikgewogICAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cHJBIDwgZXhwckIpIHsKICAgICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gSWYgdGhleSdyZSBlcXVhbCBjb21wYXJlIHRoZSBpdGVtcyBieSB0aGVpcgogICAgICAgICAgICAgIC8vIG9yZGVyIHRvIG1haW50YWluIHJlbGF0aXZlIG9yZGVyIG9mIGVxdWFsIGtleXMKICAgICAgICAgICAgICAvLyAoaS5lLiB0byBnZXQgYSBzdGFibGUgc29ydCkuCiAgICAgICAgICAgICAgcmV0dXJuIGFbMF0gLSBiWzBdOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIC8vIFVuZGVjb3JhdGU6IGV4dHJhY3Qgb3V0IHRoZSBvcmlnaW5hbCBsaXN0IGVsZW1lbnRzLgogICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBkZWNvcmF0ZWQubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgc29ydGVkQXJyYXlbal0gPSBkZWNvcmF0ZWRbal1bMV07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc29ydGVkQXJyYXk7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbk1heEJ5OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgZXhwcmVmTm9kZSA9IHJlc29sdmVkQXJnc1sxXTsKICAgICAgICB2YXIgcmVzb2x2ZWRBcnJheSA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICB2YXIga2V5RnVuY3Rpb24gPSB0aGlzLmNyZWF0ZUtleUZ1bmN0aW9uKGV4cHJlZk5vZGUsIFtUWVBFX05VTUJFUiwgVFlQRV9TVFJJTkddKTsKICAgICAgICB2YXIgbWF4TnVtYmVyID0gLUluZmluaXR5OwogICAgICAgIHZhciBtYXhSZWNvcmQ7CiAgICAgICAgdmFyIGN1cnJlbnQ7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvbHZlZEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjdXJyZW50ID0ga2V5RnVuY3Rpb24ocmVzb2x2ZWRBcnJheVtpXSk7CiAgICAgICAgICBpZiAoY3VycmVudCA+IG1heE51bWJlcikgewogICAgICAgICAgICBtYXhOdW1iZXIgPSBjdXJyZW50OwogICAgICAgICAgICBtYXhSZWNvcmQgPSByZXNvbHZlZEFycmF5W2ldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbWF4UmVjb3JkOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25NaW5CeTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIGV4cHJlZk5vZGUgPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgICAgdmFyIHJlc29sdmVkQXJyYXkgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgdmFyIGtleUZ1bmN0aW9uID0gdGhpcy5jcmVhdGVLZXlGdW5jdGlvbihleHByZWZOb2RlLCBbVFlQRV9OVU1CRVIsIFRZUEVfU1RSSU5HXSk7CiAgICAgICAgdmFyIG1pbk51bWJlciA9IEluZmluaXR5OwogICAgICAgIHZhciBtaW5SZWNvcmQ7CiAgICAgICAgdmFyIGN1cnJlbnQ7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvbHZlZEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjdXJyZW50ID0ga2V5RnVuY3Rpb24ocmVzb2x2ZWRBcnJheVtpXSk7CiAgICAgICAgICBpZiAoY3VycmVudCA8IG1pbk51bWJlcikgewogICAgICAgICAgICBtaW5OdW1iZXIgPSBjdXJyZW50OwogICAgICAgICAgICBtaW5SZWNvcmQgPSByZXNvbHZlZEFycmF5W2ldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbWluUmVjb3JkOwogICAgICB9LAogIAogICAgICBjcmVhdGVLZXlGdW5jdGlvbjogZnVuY3Rpb24oZXhwcmVmTm9kZSwgYWxsb3dlZFR5cGVzKSB7CiAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgIHZhciBpbnRlcnByZXRlciA9IHRoaXMuX2ludGVycHJldGVyOwogICAgICAgIHZhciBrZXlGdW5jID0gZnVuY3Rpb24oeCkgewogICAgICAgICAgdmFyIGN1cnJlbnQgPSBpbnRlcnByZXRlci52aXNpdChleHByZWZOb2RlLCB4KTsKICAgICAgICAgIGlmIChhbGxvd2VkVHlwZXMuaW5kZXhPZih0aGF0Ll9nZXRUeXBlTmFtZShjdXJyZW50KSkgPCAwKSB7CiAgICAgICAgICAgIHZhciBtc2cgPSAiVHlwZUVycm9yOiBleHBlY3RlZCBvbmUgb2YgIiArIGFsbG93ZWRUeXBlcyArCiAgICAgICAgICAgICAgICAgICAgICAiLCByZWNlaXZlZCAiICsgdGhhdC5fZ2V0VHlwZU5hbWUoY3VycmVudCk7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihtc2cpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGN1cnJlbnQ7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4ga2V5RnVuYzsKICAgICAgfQogIAogICAgfTsKICAKICAgIGZ1bmN0aW9uIGNvbXBpbGUoc3RyZWFtKSB7CiAgICAgIHZhciBwYXJzZXIgPSBuZXcgUGFyc2VyKCk7CiAgICAgIHZhciBhc3QgPSBwYXJzZXIucGFyc2Uoc3RyZWFtKTsKICAgICAgcmV0dXJuIGFzdDsKICAgIH0KICAKICAgIGZ1bmN0aW9uIHRva2VuaXplKHN0cmVhbSkgewogICAgICAgIHZhciBsZXhlciA9IG5ldyBMZXhlcigpOwogICAgICAgIHJldHVybiBsZXhlci50b2tlbml6ZShzdHJlYW0pOwogICAgfQogIAogICAgZnVuY3Rpb24gc2VhcmNoKGRhdGEsIGV4cHJlc3Npb24pIHsKICAgICAgICB2YXIgcGFyc2VyID0gbmV3IFBhcnNlcigpOwogICAgICAgIC8vIFRoaXMgbmVlZHMgdG8gYmUgaW1wcm92ZWQuICBCb3RoIHRoZSBpbnRlcnByZXRlciBhbmQgcnVudGltZSBkZXBlbmQgb24KICAgICAgICAvLyBlYWNoIG90aGVyLiAgVGhlIHJ1bnRpbWUgbmVlZHMgdGhlIGludGVycHJldGVyIHRvIHN1cHBvcnQgZXhwcmVmcy4KICAgICAgICAvLyBUaGVyZSdzIGxpa2VseSBhIGNsZWFuIHdheSB0byBhdm9pZCB0aGUgY3ljbGljIGRlcGVuZGVuY3kuCiAgICAgICAgdmFyIHJ1bnRpbWUgPSBuZXcgUnVudGltZSgpOwogICAgICAgIHZhciBpbnRlcnByZXRlciA9IG5ldyBUcmVlSW50ZXJwcmV0ZXIocnVudGltZSk7CiAgICAgICAgcnVudGltZS5faW50ZXJwcmV0ZXIgPSBpbnRlcnByZXRlcjsKICAgICAgICB2YXIgbm9kZSA9IHBhcnNlci5wYXJzZShleHByZXNzaW9uKTsKICAgICAgICByZXR1cm4gaW50ZXJwcmV0ZXIuc2VhcmNoKG5vZGUsIGRhdGEpOwogICAgfQogIAogICAgZXhwb3J0cy50b2tlbml6ZSA9IHRva2VuaXplOwogICAgZXhwb3J0cy5jb21waWxlID0gY29tcGlsZTsKICAgIGV4cG9ydHMuc2VhcmNoID0gc2VhcmNoOwogICAgZXhwb3J0cy5zdHJpY3REZWVwRXF1YWwgPSBzdHJpY3REZWVwRXF1YWw7CiAgfSkodHlwZW9mIGV4cG9ydHMgPT09ICJ1bmRlZmluZWQiID8gdGhpcy5qbWVzcGF0aCA9IHt9IDogZXhwb3J0cyk7CiAgCiAgfSx7fV0sODY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIHNoaW0gZm9yIHVzaW5nIHByb2Nlc3MgaW4gYnJvd3NlcgogIHZhciBwcm9jZXNzID0gbW9kdWxlLmV4cG9ydHMgPSB7fTsKICAKICAvLyBjYWNoZWQgZnJvbSB3aGF0ZXZlciBnbG9iYWwgaXMgcHJlc2VudCBzbyB0aGF0IHRlc3QgcnVubmVycyB0aGF0IHN0dWIgaXQKICAvLyBkb24ndCBicmVhayB0aGluZ3MuICBCdXQgd2UgbmVlZCB0byB3cmFwIGl0IGluIGEgdHJ5IGNhdGNoIGluIGNhc2UgaXQgaXMKICAvLyB3cmFwcGVkIGluIHN0cmljdCBtb2RlIGNvZGUgd2hpY2ggZG9lc24ndCBkZWZpbmUgYW55IGdsb2JhbHMuICBJdCdzIGluc2lkZSBhCiAgLy8gZnVuY3Rpb24gYmVjYXVzZSB0cnkvY2F0Y2hlcyBkZW9wdGltaXplIGluIGNlcnRhaW4gZW5naW5lcy4KICAKICB2YXIgY2FjaGVkU2V0VGltZW91dDsKICB2YXIgY2FjaGVkQ2xlYXJUaW1lb3V0OwogIAogIGZ1bmN0aW9uIGRlZmF1bHRTZXRUaW1vdXQoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignc2V0VGltZW91dCBoYXMgbm90IGJlZW4gZGVmaW5lZCcpOwogIH0KICBmdW5jdGlvbiBkZWZhdWx0Q2xlYXJUaW1lb3V0ICgpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdjbGVhclRpbWVvdXQgaGFzIG5vdCBiZWVuIGRlZmluZWQnKTsKICB9CiAgKGZ1bmN0aW9uICgpIHsKICAgICAgdHJ5IHsKICAgICAgICAgIGlmICh0eXBlb2Ygc2V0VGltZW91dCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgIGNhY2hlZFNldFRpbWVvdXQgPSBzZXRUaW1lb3V0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjYWNoZWRTZXRUaW1lb3V0ID0gZGVmYXVsdFNldFRpbW91dDsKICAgICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY2FjaGVkU2V0VGltZW91dCA9IGRlZmF1bHRTZXRUaW1vdXQ7CiAgICAgIH0KICAgICAgdHJ5IHsKICAgICAgICAgIGlmICh0eXBlb2YgY2xlYXJUaW1lb3V0ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgY2FjaGVkQ2xlYXJUaW1lb3V0ID0gY2xlYXJUaW1lb3V0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjYWNoZWRDbGVhclRpbWVvdXQgPSBkZWZhdWx0Q2xlYXJUaW1lb3V0OwogICAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjYWNoZWRDbGVhclRpbWVvdXQgPSBkZWZhdWx0Q2xlYXJUaW1lb3V0OwogICAgICB9CiAgfSAoKSkKICBmdW5jdGlvbiBydW5UaW1lb3V0KGZ1bikgewogICAgICBpZiAoY2FjaGVkU2V0VGltZW91dCA9PT0gc2V0VGltZW91dCkgewogICAgICAgICAgLy9ub3JtYWwgZW52aXJvbWVudHMgaW4gc2FuZSBzaXR1YXRpb25zCiAgICAgICAgICByZXR1cm4gc2V0VGltZW91dChmdW4sIDApOwogICAgICB9CiAgICAgIC8vIGlmIHNldFRpbWVvdXQgd2Fzbid0IGF2YWlsYWJsZSBidXQgd2FzIGxhdHRlciBkZWZpbmVkCiAgICAgIGlmICgoY2FjaGVkU2V0VGltZW91dCA9PT0gZGVmYXVsdFNldFRpbW91dCB8fCAhY2FjaGVkU2V0VGltZW91dCkgJiYgc2V0VGltZW91dCkgewogICAgICAgICAgY2FjaGVkU2V0VGltZW91dCA9IHNldFRpbWVvdXQ7CiAgICAgICAgICByZXR1cm4gc2V0VGltZW91dChmdW4sIDApOwogICAgICB9CiAgICAgIHRyeSB7CiAgICAgICAgICAvLyB3aGVuIHdoZW4gc29tZWJvZHkgaGFzIHNjcmV3ZWQgd2l0aCBzZXRUaW1lb3V0IGJ1dCBubyBJLkUuIG1hZGRuZXNzCiAgICAgICAgICByZXR1cm4gY2FjaGVkU2V0VGltZW91dChmdW4sIDApOwogICAgICB9IGNhdGNoKGUpewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAvLyBXaGVuIHdlIGFyZSBpbiBJLkUuIGJ1dCB0aGUgc2NyaXB0IGhhcyBiZWVuIGV2YWxlZCBzbyBJLkUuIGRvZXNuJ3QgdHJ1c3QgdGhlIGdsb2JhbCBvYmplY3Qgd2hlbiBjYWxsZWQgbm9ybWFsbHkKICAgICAgICAgICAgICByZXR1cm4gY2FjaGVkU2V0VGltZW91dC5jYWxsKG51bGwsIGZ1biwgMCk7CiAgICAgICAgICB9IGNhdGNoKGUpewogICAgICAgICAgICAgIC8vIHNhbWUgYXMgYWJvdmUgYnV0IHdoZW4gaXQncyBhIHZlcnNpb24gb2YgSS5FLiB0aGF0IG11c3QgaGF2ZSB0aGUgZ2xvYmFsIG9iamVjdCBmb3IgJ3RoaXMnLCBob3BmdWxseSBvdXIgY29udGV4dCBjb3JyZWN0IG90aGVyd2lzZSBpdCB3aWxsIHRocm93IGEgZ2xvYmFsIGVycm9yCiAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlZFNldFRpbWVvdXQuY2FsbCh0aGlzLCBmdW4sIDApOwogICAgICAgICAgfQogICAgICB9CiAgCiAgCiAgfQogIGZ1bmN0aW9uIHJ1bkNsZWFyVGltZW91dChtYXJrZXIpIHsKICAgICAgaWYgKGNhY2hlZENsZWFyVGltZW91dCA9PT0gY2xlYXJUaW1lb3V0KSB7CiAgICAgICAgICAvL25vcm1hbCBlbnZpcm9tZW50cyBpbiBzYW5lIHNpdHVhdGlvbnMKICAgICAgICAgIHJldHVybiBjbGVhclRpbWVvdXQobWFya2VyKTsKICAgICAgfQogICAgICAvLyBpZiBjbGVhclRpbWVvdXQgd2Fzbid0IGF2YWlsYWJsZSBidXQgd2FzIGxhdHRlciBkZWZpbmVkCiAgICAgIGlmICgoY2FjaGVkQ2xlYXJUaW1lb3V0ID09PSBkZWZhdWx0Q2xlYXJUaW1lb3V0IHx8ICFjYWNoZWRDbGVhclRpbWVvdXQpICYmIGNsZWFyVGltZW91dCkgewogICAgICAgICAgY2FjaGVkQ2xlYXJUaW1lb3V0ID0gY2xlYXJUaW1lb3V0OwogICAgICAgICAgcmV0dXJuIGNsZWFyVGltZW91dChtYXJrZXIpOwogICAgICB9CiAgICAgIHRyeSB7CiAgICAgICAgICAvLyB3aGVuIHdoZW4gc29tZWJvZHkgaGFzIHNjcmV3ZWQgd2l0aCBzZXRUaW1lb3V0IGJ1dCBubyBJLkUuIG1hZGRuZXNzCiAgICAgICAgICByZXR1cm4gY2FjaGVkQ2xlYXJUaW1lb3V0KG1hcmtlcik7CiAgICAgIH0gY2F0Y2ggKGUpewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAvLyBXaGVuIHdlIGFyZSBpbiBJLkUuIGJ1dCB0aGUgc2NyaXB0IGhhcyBiZWVuIGV2YWxlZCBzbyBJLkUuIGRvZXNuJ3QgIHRydXN0IHRoZSBnbG9iYWwgb2JqZWN0IHdoZW4gY2FsbGVkIG5vcm1hbGx5CiAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlZENsZWFyVGltZW91dC5jYWxsKG51bGwsIG1hcmtlcik7CiAgICAgICAgICB9IGNhdGNoIChlKXsKICAgICAgICAgICAgICAvLyBzYW1lIGFzIGFib3ZlIGJ1dCB3aGVuIGl0J3MgYSB2ZXJzaW9uIG9mIEkuRS4gdGhhdCBtdXN0IGhhdmUgdGhlIGdsb2JhbCBvYmplY3QgZm9yICd0aGlzJywgaG9wZnVsbHkgb3VyIGNvbnRleHQgY29ycmVjdCBvdGhlcndpc2UgaXQgd2lsbCB0aHJvdyBhIGdsb2JhbCBlcnJvci4KICAgICAgICAgICAgICAvLyBTb21lIHZlcnNpb25zIG9mIEkuRS4gaGF2ZSBkaWZmZXJlbnQgcnVsZXMgZm9yIGNsZWFyVGltZW91dCB2cyBzZXRUaW1lb3V0CiAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlZENsZWFyVGltZW91dC5jYWxsKHRoaXMsIG1hcmtlcik7CiAgICAgICAgICB9CiAgICAgIH0KICAKICAKICAKICB9CiAgdmFyIHF1ZXVlID0gW107CiAgdmFyIGRyYWluaW5nID0gZmFsc2U7CiAgdmFyIGN1cnJlbnRRdWV1ZTsKICB2YXIgcXVldWVJbmRleCA9IC0xOwogIAogIGZ1bmN0aW9uIGNsZWFuVXBOZXh0VGljaygpIHsKICAgICAgaWYgKCFkcmFpbmluZyB8fCAhY3VycmVudFF1ZXVlKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgZHJhaW5pbmcgPSBmYWxzZTsKICAgICAgaWYgKGN1cnJlbnRRdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgIHF1ZXVlID0gY3VycmVudFF1ZXVlLmNvbmNhdChxdWV1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgICBxdWV1ZUluZGV4ID0gLTE7CiAgICAgIH0KICAgICAgaWYgKHF1ZXVlLmxlbmd0aCkgewogICAgICAgICAgZHJhaW5RdWV1ZSgpOwogICAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGRyYWluUXVldWUoKSB7CiAgICAgIGlmIChkcmFpbmluZykgewogICAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciB0aW1lb3V0ID0gcnVuVGltZW91dChjbGVhblVwTmV4dFRpY2spOwogICAgICBkcmFpbmluZyA9IHRydWU7CiAgCiAgICAgIHZhciBsZW4gPSBxdWV1ZS5sZW5ndGg7CiAgICAgIHdoaWxlKGxlbikgewogICAgICAgICAgY3VycmVudFF1ZXVlID0gcXVldWU7CiAgICAgICAgICBxdWV1ZSA9IFtdOwogICAgICAgICAgd2hpbGUgKCsrcXVldWVJbmRleCA8IGxlbikgewogICAgICAgICAgICAgIGlmIChjdXJyZW50UXVldWUpIHsKICAgICAgICAgICAgICAgICAgY3VycmVudFF1ZXVlW3F1ZXVlSW5kZXhdLnJ1bigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlSW5kZXggPSAtMTsKICAgICAgICAgIGxlbiA9IHF1ZXVlLmxlbmd0aDsKICAgICAgfQogICAgICBjdXJyZW50UXVldWUgPSBudWxsOwogICAgICBkcmFpbmluZyA9IGZhbHNlOwogICAgICBydW5DbGVhclRpbWVvdXQodGltZW91dCk7CiAgfQogIAogIHByb2Nlc3MubmV4dFRpY2sgPSBmdW5jdGlvbiAoZnVuKSB7CiAgICAgIHZhciBhcmdzID0gbmV3IEFycmF5KGFyZ3VtZW50cy5sZW5ndGggLSAxKTsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGFyZ3NbaSAtIDFdID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHF1ZXVlLnB1c2gobmV3IEl0ZW0oZnVuLCBhcmdzKSk7CiAgICAgIGlmIChxdWV1ZS5sZW5ndGggPT09IDEgJiYgIWRyYWluaW5nKSB7CiAgICAgICAgICBydW5UaW1lb3V0KGRyYWluUXVldWUpOwogICAgICB9CiAgfTsKICAKICAvLyB2OCBsaWtlcyBwcmVkaWN0aWJsZSBvYmplY3RzCiAgZnVuY3Rpb24gSXRlbShmdW4sIGFycmF5KSB7CiAgICAgIHRoaXMuZnVuID0gZnVuOwogICAgICB0aGlzLmFycmF5ID0gYXJyYXk7CiAgfQogIEl0ZW0ucHJvdG90eXBlLnJ1biA9IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5mdW4uYXBwbHkobnVsbCwgdGhpcy5hcnJheSk7CiAgfTsKICBwcm9jZXNzLnRpdGxlID0gJ2Jyb3dzZXInOwogIHByb2Nlc3MuYnJvd3NlciA9IHRydWU7CiAgcHJvY2Vzcy5lbnYgPSB7fTsKICBwcm9jZXNzLmFyZ3YgPSBbXTsKICBwcm9jZXNzLnZlcnNpb24gPSAnJzsgLy8gZW1wdHkgc3RyaW5nIHRvIGF2b2lkIHJlZ2V4cCBpc3N1ZXMKICBwcm9jZXNzLnZlcnNpb25zID0ge307CiAgCiAgZnVuY3Rpb24gbm9vcCgpIHt9CiAgCiAgcHJvY2Vzcy5vbiA9IG5vb3A7CiAgcHJvY2Vzcy5hZGRMaXN0ZW5lciA9IG5vb3A7CiAgcHJvY2Vzcy5vbmNlID0gbm9vcDsKICBwcm9jZXNzLm9mZiA9IG5vb3A7CiAgcHJvY2Vzcy5yZW1vdmVMaXN0ZW5lciA9IG5vb3A7CiAgcHJvY2Vzcy5yZW1vdmVBbGxMaXN0ZW5lcnMgPSBub29wOwogIHByb2Nlc3MuZW1pdCA9IG5vb3A7CiAgcHJvY2Vzcy5wcmVwZW5kTGlzdGVuZXIgPSBub29wOwogIHByb2Nlc3MucHJlcGVuZE9uY2VMaXN0ZW5lciA9IG5vb3A7CiAgCiAgcHJvY2Vzcy5saXN0ZW5lcnMgPSBmdW5jdGlvbiAobmFtZSkgeyByZXR1cm4gW10gfQogIAogIHByb2Nlc3MuYmluZGluZyA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigncHJvY2Vzcy5iaW5kaW5nIGlzIG5vdCBzdXBwb3J0ZWQnKTsKICB9OwogIAogIHByb2Nlc3MuY3dkID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gJy8nIH07CiAgcHJvY2Vzcy5jaGRpciA9IGZ1bmN0aW9uIChkaXIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdwcm9jZXNzLmNoZGlyIGlzIG5vdCBzdXBwb3J0ZWQnKTsKICB9OwogIHByb2Nlc3MudW1hc2sgPSBmdW5jdGlvbigpIHsgcmV0dXJuIDA7IH07CiAgCiAgfSx7fV0sODc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgogIC8vCiAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKICAvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiAgLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwogIC8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKICAvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CiAgLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCiAgLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgLy8KICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAogIC8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogIC8vCiAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICAvLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiAgLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgogIC8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAogIC8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgogIC8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKICAvLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogIAogICd1c2Ugc3RyaWN0JzsKICAKICAvLyBJZiBvYmouaGFzT3duUHJvcGVydHkgaGFzIGJlZW4gb3ZlcnJpZGRlbiwgdGhlbiBjYWxsaW5nCiAgLy8gb2JqLmhhc093blByb3BlcnR5KHByb3ApIHdpbGwgYnJlYWsuCiAgLy8gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vam95ZW50L25vZGUvaXNzdWVzLzE3MDcKICBmdW5jdGlvbiBoYXNPd25Qcm9wZXJ0eShvYmosIHByb3ApIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBwcm9wKTsKICB9CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihxcywgc2VwLCBlcSwgb3B0aW9ucykgewogICAgc2VwID0gc2VwIHx8ICcmJzsKICAgIGVxID0gZXEgfHwgJz0nOwogICAgdmFyIG9iaiA9IHt9OwogIAogICAgaWYgKHR5cGVvZiBxcyAhPT0gJ3N0cmluZycgfHwgcXMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBvYmo7CiAgICB9CiAgCiAgICB2YXIgcmVnZXhwID0gL1wrL2c7CiAgICBxcyA9IHFzLnNwbGl0KHNlcCk7CiAgCiAgICB2YXIgbWF4S2V5cyA9IDEwMDA7CiAgICBpZiAob3B0aW9ucyAmJiB0eXBlb2Ygb3B0aW9ucy5tYXhLZXlzID09PSAnbnVtYmVyJykgewogICAgICBtYXhLZXlzID0gb3B0aW9ucy5tYXhLZXlzOwogICAgfQogIAogICAgdmFyIGxlbiA9IHFzLmxlbmd0aDsKICAgIC8vIG1heEtleXMgPD0gMCBtZWFucyB0aGF0IHdlIHNob3VsZCBub3QgbGltaXQga2V5cyBjb3VudAogICAgaWYgKG1heEtleXMgPiAwICYmIGxlbiA+IG1heEtleXMpIHsKICAgICAgbGVuID0gbWF4S2V5czsKICAgIH0KICAKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgICAgdmFyIHggPSBxc1tpXS5yZXBsYWNlKHJlZ2V4cCwgJyUyMCcpLAogICAgICAgICAgaWR4ID0geC5pbmRleE9mKGVxKSwKICAgICAgICAgIGtzdHIsIHZzdHIsIGssIHY7CiAgCiAgICAgIGlmIChpZHggPj0gMCkgewogICAgICAgIGtzdHIgPSB4LnN1YnN0cigwLCBpZHgpOwogICAgICAgIHZzdHIgPSB4LnN1YnN0cihpZHggKyAxKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBrc3RyID0geDsKICAgICAgICB2c3RyID0gJyc7CiAgICAgIH0KICAKICAgICAgayA9IGRlY29kZVVSSUNvbXBvbmVudChrc3RyKTsKICAgICAgdiA9IGRlY29kZVVSSUNvbXBvbmVudCh2c3RyKTsKICAKICAgICAgaWYgKCFoYXNPd25Qcm9wZXJ0eShvYmosIGspKSB7CiAgICAgICAgb2JqW2tdID0gdjsKICAgICAgfSBlbHNlIGlmIChpc0FycmF5KG9ialtrXSkpIHsKICAgICAgICBvYmpba10ucHVzaCh2KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvYmpba10gPSBbb2JqW2tdLCB2XTsKICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIG9iajsKICB9OwogIAogIHZhciBpc0FycmF5ID0gQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiAoeHMpIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoeHMpID09PSAnW29iamVjdCBBcnJheV0nOwogIH07CiAgCiAgfSx7fV0sODg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgogIC8vCiAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKICAvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiAgLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwogIC8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKICAvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CiAgLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCiAgLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgLy8KICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAogIC8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogIC8vCiAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICAvLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiAgLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgogIC8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAogIC8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgogIC8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKICAvLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogIAogICd1c2Ugc3RyaWN0JzsKICAKICB2YXIgc3RyaW5naWZ5UHJpbWl0aXZlID0gZnVuY3Rpb24odikgewogICAgc3dpdGNoICh0eXBlb2YgdikgewogICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgIHJldHVybiB2OwogIAogICAgICBjYXNlICdib29sZWFuJzoKICAgICAgICByZXR1cm4gdiA/ICd0cnVlJyA6ICdmYWxzZSc7CiAgCiAgICAgIGNhc2UgJ251bWJlcic6CiAgICAgICAgcmV0dXJuIGlzRmluaXRlKHYpID8gdiA6ICcnOwogIAogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiAnJzsKICAgIH0KICB9OwogIAogIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ob2JqLCBzZXAsIGVxLCBuYW1lKSB7CiAgICBzZXAgPSBzZXAgfHwgJyYnOwogICAgZXEgPSBlcSB8fCAnPSc7CiAgICBpZiAob2JqID09PSBudWxsKSB7CiAgICAgIG9iaiA9IHVuZGVmaW5lZDsKICAgIH0KICAKICAgIGlmICh0eXBlb2Ygb2JqID09PSAnb2JqZWN0JykgewogICAgICByZXR1cm4gbWFwKG9iamVjdEtleXMob2JqKSwgZnVuY3Rpb24oaykgewogICAgICAgIHZhciBrcyA9IGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUoaykpICsgZXE7CiAgICAgICAgaWYgKGlzQXJyYXkob2JqW2tdKSkgewogICAgICAgICAgcmV0dXJuIG1hcChvYmpba10sIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgcmV0dXJuIGtzICsgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZSh2KSk7CiAgICAgICAgICB9KS5qb2luKHNlcCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBrcyArIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUob2JqW2tdKSk7CiAgICAgICAgfQogICAgICB9KS5qb2luKHNlcCk7CiAgCiAgICB9CiAgCiAgICBpZiAoIW5hbWUpIHJldHVybiAnJzsKICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG5hbWUpKSArIGVxICsKICAgICAgICAgICBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG9iaikpOwogIH07CiAgCiAgdmFyIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5IHx8IGZ1bmN0aW9uICh4cykgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh4cykgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKICAKICBmdW5jdGlvbiBtYXAgKHhzLCBmKSB7CiAgICBpZiAoeHMubWFwKSByZXR1cm4geHMubWFwKGYpOwogICAgdmFyIHJlcyA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB4cy5sZW5ndGg7IGkrKykgewogICAgICByZXMucHVzaChmKHhzW2ldLCBpKSk7CiAgICB9CiAgICByZXR1cm4gcmVzOwogIH0KICAKICB2YXIgb2JqZWN0S2V5cyA9IE9iamVjdC5rZXlzIHx8IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciByZXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHJlcy5wdXNoKGtleSk7CiAgICB9CiAgICByZXR1cm4gcmVzOwogIH07CiAgCiAgfSx7fV0sODk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogICd1c2Ugc3RyaWN0JzsKICAKICBleHBvcnRzLmRlY29kZSA9IGV4cG9ydHMucGFyc2UgPSByZXF1aXJlKCcuL2RlY29kZScpOwogIGV4cG9ydHMuZW5jb2RlID0gZXhwb3J0cy5zdHJpbmdpZnkgPSByZXF1aXJlKCcuL2VuY29kZScpOwogIAogIH0seyIuL2RlY29kZSI6ODcsIi4vZW5jb2RlIjo4OH1dLDkwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KICAvLwogIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCiAgLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQogIC8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKICAvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCiAgLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAogIC8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQogIC8vIGZvbGxvd2luZyBjb25kaXRpb25zOgogIC8vCiAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKICAvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAvLwogIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAgLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogIC8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KICAvLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKICAvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKICAvLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCiAgLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICAKICAndXNlIHN0cmljdCc7CiAgCiAgLy8gSWYgb2JqLmhhc093blByb3BlcnR5IGhhcyBiZWVuIG92ZXJyaWRkZW4sIHRoZW4gY2FsbGluZwogIC8vIG9iai5oYXNPd25Qcm9wZXJ0eShwcm9wKSB3aWxsIGJyZWFrLgogIC8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2pveWVudC9ub2RlL2lzc3Vlcy8xNzA3CiAgZnVuY3Rpb24gaGFzT3duUHJvcGVydHkob2JqLCBwcm9wKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCk7CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ocXMsIHNlcCwgZXEsIG9wdGlvbnMpIHsKICAgIHNlcCA9IHNlcCB8fCAnJic7CiAgICBlcSA9IGVxIHx8ICc9JzsKICAgIHZhciBvYmogPSB7fTsKICAKICAgIGlmICh0eXBlb2YgcXMgIT09ICdzdHJpbmcnIHx8IHFzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gb2JqOwogICAgfQogIAogICAgdmFyIHJlZ2V4cCA9IC9cKy9nOwogICAgcXMgPSBxcy5zcGxpdChzZXApOwogIAogICAgdmFyIG1heEtleXMgPSAxMDAwOwogICAgaWYgKG9wdGlvbnMgJiYgdHlwZW9mIG9wdGlvbnMubWF4S2V5cyA9PT0gJ251bWJlcicpIHsKICAgICAgbWF4S2V5cyA9IG9wdGlvbnMubWF4S2V5czsKICAgIH0KICAKICAgIHZhciBsZW4gPSBxcy5sZW5ndGg7CiAgICAvLyBtYXhLZXlzIDw9IDAgbWVhbnMgdGhhdCB3ZSBzaG91bGQgbm90IGxpbWl0IGtleXMgY291bnQKICAgIGlmIChtYXhLZXlzID4gMCAmJiBsZW4gPiBtYXhLZXlzKSB7CiAgICAgIGxlbiA9IG1heEtleXM7CiAgICB9CiAgCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIHZhciB4ID0gcXNbaV0ucmVwbGFjZShyZWdleHAsICclMjAnKSwKICAgICAgICAgIGlkeCA9IHguaW5kZXhPZihlcSksCiAgICAgICAgICBrc3RyLCB2c3RyLCBrLCB2OwogIAogICAgICBpZiAoaWR4ID49IDApIHsKICAgICAgICBrc3RyID0geC5zdWJzdHIoMCwgaWR4KTsKICAgICAgICB2c3RyID0geC5zdWJzdHIoaWR4ICsgMSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAga3N0ciA9IHg7CiAgICAgICAgdnN0ciA9ICcnOwogICAgICB9CiAgCiAgICAgIGsgPSBkZWNvZGVVUklDb21wb25lbnQoa3N0cik7CiAgICAgIHYgPSBkZWNvZGVVUklDb21wb25lbnQodnN0cik7CiAgCiAgICAgIGlmICghaGFzT3duUHJvcGVydHkob2JqLCBrKSkgewogICAgICAgIG9ialtrXSA9IHY7CiAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShvYmpba10pKSB7CiAgICAgICAgb2JqW2tdLnB1c2godik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb2JqW2tdID0gW29ialtrXSwgdl07CiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiBvYmo7CiAgfTsKICAKICB9LHt9XSw5MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCiAgLy8KICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQogIC8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKICAvLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCiAgLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAogIC8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKICAvLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKICAvLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAvLwogIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCiAgLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgLy8KICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwogIC8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICAvLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCiAgLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCiAgLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCiAgLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQogIC8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiAgCiAgJ3VzZSBzdHJpY3QnOwogIAogIHZhciBzdHJpbmdpZnlQcmltaXRpdmUgPSBmdW5jdGlvbih2KSB7CiAgICBzd2l0Y2ggKHR5cGVvZiB2KSB7CiAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgcmV0dXJuIHY7CiAgCiAgICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICAgIHJldHVybiB2ID8gJ3RydWUnIDogJ2ZhbHNlJzsKICAKICAgICAgY2FzZSAnbnVtYmVyJzoKICAgICAgICByZXR1cm4gaXNGaW5pdGUodikgPyB2IDogJyc7CiAgCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuICcnOwogICAgfQogIH07CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihvYmosIHNlcCwgZXEsIG5hbWUpIHsKICAgIHNlcCA9IHNlcCB8fCAnJic7CiAgICBlcSA9IGVxIHx8ICc9JzsKICAgIGlmIChvYmogPT09IG51bGwpIHsKICAgICAgb2JqID0gdW5kZWZpbmVkOwogICAgfQogIAogICAgaWYgKHR5cGVvZiBvYmogPT09ICdvYmplY3QnKSB7CiAgICAgIHJldHVybiBPYmplY3Qua2V5cyhvYmopLm1hcChmdW5jdGlvbihrKSB7CiAgICAgICAgdmFyIGtzID0gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShrKSkgKyBlcTsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShvYmpba10pKSB7CiAgICAgICAgICByZXR1cm4gb2JqW2tdLm1hcChmdW5jdGlvbih2KSB7CiAgICAgICAgICAgIHJldHVybiBrcyArIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUodikpOwogICAgICAgICAgfSkuam9pbihzZXApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4ga3MgKyBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG9ialtrXSkpOwogICAgICAgIH0KICAgICAgfSkuam9pbihzZXApOwogIAogICAgfQogIAogICAgaWYgKCFuYW1lKSByZXR1cm4gJyc7CiAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShuYW1lKSkgKyBlcSArCiAgICAgICAgICAgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShvYmopKTsKICB9OwogIAogIH0se31dLDkyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBhcmd1bWVudHNbNF1bODldWzBdLmFwcGx5KGV4cG9ydHMsYXJndW1lbnRzKQogIH0seyIuL2RlY29kZSI6OTAsIi4vZW5jb2RlIjo5MSwiZHVwIjo4OX1dLDkzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKHNldEltbWVkaWF0ZSxjbGVhckltbWVkaWF0ZSl7KGZ1bmN0aW9uICgpewogIHZhciBuZXh0VGljayA9IHJlcXVpcmUoJ3Byb2Nlc3MvYnJvd3Nlci5qcycpLm5leHRUaWNrOwogIHZhciBhcHBseSA9IEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseTsKICB2YXIgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CiAgdmFyIGltbWVkaWF0ZUlkcyA9IHt9OwogIHZhciBuZXh0SW1tZWRpYXRlSWQgPSAwOwogIAogIC8vIERPTSBBUElzLCBmb3IgY29tcGxldGVuZXNzCiAgCiAgZXhwb3J0cy5zZXRUaW1lb3V0ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbmV3IFRpbWVvdXQoYXBwbHkuY2FsbChzZXRUaW1lb3V0LCB3aW5kb3csIGFyZ3VtZW50cyksIGNsZWFyVGltZW91dCk7CiAgfTsKICBleHBvcnRzLnNldEludGVydmFsID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbmV3IFRpbWVvdXQoYXBwbHkuY2FsbChzZXRJbnRlcnZhbCwgd2luZG93LCBhcmd1bWVudHMpLCBjbGVhckludGVydmFsKTsKICB9OwogIGV4cG9ydHMuY2xlYXJUaW1lb3V0ID0KICBleHBvcnRzLmNsZWFySW50ZXJ2YWwgPSBmdW5jdGlvbih0aW1lb3V0KSB7IHRpbWVvdXQuY2xvc2UoKTsgfTsKICAKICBmdW5jdGlvbiBUaW1lb3V0KGlkLCBjbGVhckZuKSB7CiAgICB0aGlzLl9pZCA9IGlkOwogICAgdGhpcy5fY2xlYXJGbiA9IGNsZWFyRm47CiAgfQogIFRpbWVvdXQucHJvdG90eXBlLnVucmVmID0gVGltZW91dC5wcm90b3R5cGUucmVmID0gZnVuY3Rpb24oKSB7fTsKICBUaW1lb3V0LnByb3RvdHlwZS5jbG9zZSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fY2xlYXJGbi5jYWxsKHdpbmRvdywgdGhpcy5faWQpOwogIH07CiAgCiAgLy8gRG9lcyBub3Qgc3RhcnQgdGhlIHRpbWUsIGp1c3Qgc2V0cyB1cCB0aGUgbWVtYmVycyBuZWVkZWQuCiAgZXhwb3J0cy5lbnJvbGwgPSBmdW5jdGlvbihpdGVtLCBtc2VjcykgewogICAgY2xlYXJUaW1lb3V0KGl0ZW0uX2lkbGVUaW1lb3V0SWQpOwogICAgaXRlbS5faWRsZVRpbWVvdXQgPSBtc2VjczsKICB9OwogIAogIGV4cG9ydHMudW5lbnJvbGwgPSBmdW5jdGlvbihpdGVtKSB7CiAgICBjbGVhclRpbWVvdXQoaXRlbS5faWRsZVRpbWVvdXRJZCk7CiAgICBpdGVtLl9pZGxlVGltZW91dCA9IC0xOwogIH07CiAgCiAgZXhwb3J0cy5fdW5yZWZBY3RpdmUgPSBleHBvcnRzLmFjdGl2ZSA9IGZ1bmN0aW9uKGl0ZW0pIHsKICAgIGNsZWFyVGltZW91dChpdGVtLl9pZGxlVGltZW91dElkKTsKICAKICAgIHZhciBtc2VjcyA9IGl0ZW0uX2lkbGVUaW1lb3V0OwogICAgaWYgKG1zZWNzID49IDApIHsKICAgICAgaXRlbS5faWRsZVRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gb25UaW1lb3V0KCkgewogICAgICAgIGlmIChpdGVtLl9vblRpbWVvdXQpCiAgICAgICAgICBpdGVtLl9vblRpbWVvdXQoKTsKICAgICAgfSwgbXNlY3MpOwogICAgfQogIH07CiAgCiAgLy8gVGhhdCdzIG5vdCBob3cgbm9kZS5qcyBpbXBsZW1lbnRzIGl0IGJ1dCB0aGUgZXhwb3NlZCBhcGkgaXMgdGhlIHNhbWUuCiAgZXhwb3J0cy5zZXRJbW1lZGlhdGUgPSB0eXBlb2Ygc2V0SW1tZWRpYXRlID09PSAiZnVuY3Rpb24iID8gc2V0SW1tZWRpYXRlIDogZnVuY3Rpb24oZm4pIHsKICAgIHZhciBpZCA9IG5leHRJbW1lZGlhdGVJZCsrOwogICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMubGVuZ3RoIDwgMiA/IGZhbHNlIDogc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogIAogICAgaW1tZWRpYXRlSWRzW2lkXSA9IHRydWU7CiAgCiAgICBuZXh0VGljayhmdW5jdGlvbiBvbk5leHRUaWNrKCkgewogICAgICBpZiAoaW1tZWRpYXRlSWRzW2lkXSkgewogICAgICAgIC8vIGZuLmNhbGwoKSBpcyBmYXN0ZXIgc28gd2Ugb3B0aW1pemUgZm9yIHRoZSBjb21tb24gdXNlLWNhc2UKICAgICAgICAvLyBAc2VlIGh0dHA6Ly9qc3BlcmYuY29tL2NhbGwtYXBwbHktc2VndQogICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICBmbi5hcHBseShudWxsLCBhcmdzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm4uY2FsbChudWxsKTsKICAgICAgICB9CiAgICAgICAgLy8gUHJldmVudCBpZHMgZnJvbSBsZWFraW5nCiAgICAgICAgZXhwb3J0cy5jbGVhckltbWVkaWF0ZShpZCk7CiAgICAgIH0KICAgIH0pOwogIAogICAgcmV0dXJuIGlkOwogIH07CiAgCiAgZXhwb3J0cy5jbGVhckltbWVkaWF0ZSA9IHR5cGVvZiBjbGVhckltbWVkaWF0ZSA9PT0gImZ1bmN0aW9uIiA/IGNsZWFySW1tZWRpYXRlIDogZnVuY3Rpb24oaWQpIHsKICAgIGRlbGV0ZSBpbW1lZGlhdGVJZHNbaWRdOwogIH07CiAgfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCJ0aW1lcnMiKS5zZXRJbW1lZGlhdGUscmVxdWlyZSgidGltZXJzIikuY2xlYXJJbW1lZGlhdGUpCiAgfSx7InByb2Nlc3MvYnJvd3Nlci5qcyI6ODYsInRpbWVycyI6OTN9XSw5NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCiAgLy8KICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQogIC8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKICAvLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCiAgLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAogIC8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKICAvLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKICAvLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAvLwogIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCiAgLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgLy8KICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwogIC8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICAvLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCiAgLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCiAgLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCiAgLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQogIC8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiAgCiAgdmFyIHB1bnljb2RlID0gcmVxdWlyZSgncHVueWNvZGUnKTsKICAKICBleHBvcnRzLnBhcnNlID0gdXJsUGFyc2U7CiAgZXhwb3J0cy5yZXNvbHZlID0gdXJsUmVzb2x2ZTsKICBleHBvcnRzLnJlc29sdmVPYmplY3QgPSB1cmxSZXNvbHZlT2JqZWN0OwogIGV4cG9ydHMuZm9ybWF0ID0gdXJsRm9ybWF0OwogIAogIGV4cG9ydHMuVXJsID0gVXJsOwogIAogIGZ1bmN0aW9uIFVybCgpIHsKICAgIHRoaXMucHJvdG9jb2wgPSBudWxsOwogICAgdGhpcy5zbGFzaGVzID0gbnVsbDsKICAgIHRoaXMuYXV0aCA9IG51bGw7CiAgICB0aGlzLmhvc3QgPSBudWxsOwogICAgdGhpcy5wb3J0ID0gbnVsbDsKICAgIHRoaXMuaG9zdG5hbWUgPSBudWxsOwogICAgdGhpcy5oYXNoID0gbnVsbDsKICAgIHRoaXMuc2VhcmNoID0gbnVsbDsKICAgIHRoaXMucXVlcnkgPSBudWxsOwogICAgdGhpcy5wYXRobmFtZSA9IG51bGw7CiAgICB0aGlzLnBhdGggPSBudWxsOwogICAgdGhpcy5ocmVmID0gbnVsbDsKICB9CiAgCiAgLy8gUmVmZXJlbmNlOiBSRkMgMzk4NiwgUkZDIDE4MDgsIFJGQyAyMzk2CiAgCiAgLy8gZGVmaW5lIHRoZXNlIGhlcmUgc28gYXQgbGVhc3QgdGhleSBvbmx5IGhhdmUgdG8gYmUKICAvLyBjb21waWxlZCBvbmNlIG9uIHRoZSBmaXJzdCBtb2R1bGUgbG9hZC4KICB2YXIgcHJvdG9jb2xQYXR0ZXJuID0gL14oW2EtejAtOS4rLV0rOikvaSwKICAgICAgcG9ydFBhdHRlcm4gPSAvOlswLTldKiQvLAogIAogICAgICAvLyBSRkMgMjM5NjogY2hhcmFjdGVycyByZXNlcnZlZCBmb3IgZGVsaW1pdGluZyBVUkxzLgogICAgICAvLyBXZSBhY3R1YWxseSBqdXN0IGF1dG8tZXNjYXBlIHRoZXNlLgogICAgICBkZWxpbXMgPSBbJzwnLCAnPicsICciJywgJ2AnLCAnICcsICdccicsICdcbicsICdcdCddLAogIAogICAgICAvLyBSRkMgMjM5NjogY2hhcmFjdGVycyBub3QgYWxsb3dlZCBmb3IgdmFyaW91cyByZWFzb25zLgogICAgICB1bndpc2UgPSBbJ3snLCAnfScsICd8JywgJ1xcJywgJ14nLCAnYCddLmNvbmNhdChkZWxpbXMpLAogIAogICAgICAvLyBBbGxvd2VkIGJ5IFJGQ3MsIGJ1dCBjYXVzZSBvZiBYU1MgYXR0YWNrcy4gIEFsd2F5cyBlc2NhcGUgdGhlc2UuCiAgICAgIGF1dG9Fc2NhcGUgPSBbJ1wnJ10uY29uY2F0KHVud2lzZSksCiAgICAgIC8vIENoYXJhY3RlcnMgdGhhdCBhcmUgbmV2ZXIgZXZlciBhbGxvd2VkIGluIGEgaG9zdG5hbWUuCiAgICAgIC8vIE5vdGUgdGhhdCBhbnkgaW52YWxpZCBjaGFycyBhcmUgYWxzbyBoYW5kbGVkLCBidXQgdGhlc2UKICAgICAgLy8gYXJlIHRoZSBvbmVzIHRoYXQgYXJlICpleHBlY3RlZCogdG8gYmUgc2Vlbiwgc28gd2UgZmFzdC1wYXRoCiAgICAgIC8vIHRoZW0uCiAgICAgIG5vbkhvc3RDaGFycyA9IFsnJScsICcvJywgJz8nLCAnOycsICcjJ10uY29uY2F0KGF1dG9Fc2NhcGUpLAogICAgICBob3N0RW5kaW5nQ2hhcnMgPSBbJy8nLCAnPycsICcjJ10sCiAgICAgIGhvc3RuYW1lTWF4TGVuID0gMjU1LAogICAgICBob3N0bmFtZVBhcnRQYXR0ZXJuID0gL15bYS16MC05QS1aXy1dezAsNjN9JC8sCiAgICAgIGhvc3RuYW1lUGFydFN0YXJ0ID0gL14oW2EtejAtOUEtWl8tXXswLDYzfSkoLiopJC8sCiAgICAgIC8vIHByb3RvY29scyB0aGF0IGNhbiBhbGxvdyAidW5zYWZlIiBhbmQgInVud2lzZSIgY2hhcnMuCiAgICAgIHVuc2FmZVByb3RvY29sID0gewogICAgICAgICdqYXZhc2NyaXB0JzogdHJ1ZSwKICAgICAgICAnamF2YXNjcmlwdDonOiB0cnVlCiAgICAgIH0sCiAgICAgIC8vIHByb3RvY29scyB0aGF0IG5ldmVyIGhhdmUgYSBob3N0bmFtZS4KICAgICAgaG9zdGxlc3NQcm90b2NvbCA9IHsKICAgICAgICAnamF2YXNjcmlwdCc6IHRydWUsCiAgICAgICAgJ2phdmFzY3JpcHQ6JzogdHJ1ZQogICAgICB9LAogICAgICAvLyBwcm90b2NvbHMgdGhhdCBhbHdheXMgY29udGFpbiBhIC8vIGJpdC4KICAgICAgc2xhc2hlZFByb3RvY29sID0gewogICAgICAgICdodHRwJzogdHJ1ZSwKICAgICAgICAnaHR0cHMnOiB0cnVlLAogICAgICAgICdmdHAnOiB0cnVlLAogICAgICAgICdnb3BoZXInOiB0cnVlLAogICAgICAgICdmaWxlJzogdHJ1ZSwKICAgICAgICAnaHR0cDonOiB0cnVlLAogICAgICAgICdodHRwczonOiB0cnVlLAogICAgICAgICdmdHA6JzogdHJ1ZSwKICAgICAgICAnZ29waGVyOic6IHRydWUsCiAgICAgICAgJ2ZpbGU6JzogdHJ1ZQogICAgICB9LAogICAgICBxdWVyeXN0cmluZyA9IHJlcXVpcmUoJ3F1ZXJ5c3RyaW5nJyk7CiAgCiAgZnVuY3Rpb24gdXJsUGFyc2UodXJsLCBwYXJzZVF1ZXJ5U3RyaW5nLCBzbGFzaGVzRGVub3RlSG9zdCkgewogICAgaWYgKHVybCAmJiBpc09iamVjdCh1cmwpICYmIHVybCBpbnN0YW5jZW9mIFVybCkgcmV0dXJuIHVybDsKICAKICAgIHZhciB1ID0gbmV3IFVybDsKICAgIHUucGFyc2UodXJsLCBwYXJzZVF1ZXJ5U3RyaW5nLCBzbGFzaGVzRGVub3RlSG9zdCk7CiAgICByZXR1cm4gdTsKICB9CiAgCiAgVXJsLnByb3RvdHlwZS5wYXJzZSA9IGZ1bmN0aW9uKHVybCwgcGFyc2VRdWVyeVN0cmluZywgc2xhc2hlc0Rlbm90ZUhvc3QpIHsKICAgIGlmICghaXNTdHJpbmcodXJsKSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJQYXJhbWV0ZXIgJ3VybCcgbXVzdCBiZSBhIHN0cmluZywgbm90ICIgKyB0eXBlb2YgdXJsKTsKICAgIH0KICAKICAgIHZhciByZXN0ID0gdXJsOwogIAogICAgLy8gdHJpbSBiZWZvcmUgcHJvY2VlZGluZy4KICAgIC8vIFRoaXMgaXMgdG8gc3VwcG9ydCBwYXJzZSBzdHVmZiBsaWtlICIgIGh0dHA6Ly9mb28uY29tICBcbiIKICAgIHJlc3QgPSByZXN0LnRyaW0oKTsKICAKICAgIHZhciBwcm90byA9IHByb3RvY29sUGF0dGVybi5leGVjKHJlc3QpOwogICAgaWYgKHByb3RvKSB7CiAgICAgIHByb3RvID0gcHJvdG9bMF07CiAgICAgIHZhciBsb3dlclByb3RvID0gcHJvdG8udG9Mb3dlckNhc2UoKTsKICAgICAgdGhpcy5wcm90b2NvbCA9IGxvd2VyUHJvdG87CiAgICAgIHJlc3QgPSByZXN0LnN1YnN0cihwcm90by5sZW5ndGgpOwogICAgfQogIAogICAgLy8gZmlndXJlIG91dCBpZiBpdCdzIGdvdCBhIGhvc3QKICAgIC8vIHVzZXJAc2VydmVyIGlzICphbHdheXMqIGludGVycHJldGVkIGFzIGEgaG9zdG5hbWUsIGFuZCB1cmwKICAgIC8vIHJlc29sdXRpb24gd2lsbCB0cmVhdCAvL2Zvby9iYXIgYXMgaG9zdD1mb28scGF0aD1iYXIgYmVjYXVzZSB0aGF0J3MKICAgIC8vIGhvdyB0aGUgYnJvd3NlciByZXNvbHZlcyByZWxhdGl2ZSBVUkxzLgogICAgaWYgKHNsYXNoZXNEZW5vdGVIb3N0IHx8IHByb3RvIHx8IHJlc3QubWF0Y2goL15cL1wvW15AXC9dK0BbXkBcL10rLykpIHsKICAgICAgdmFyIHNsYXNoZXMgPSByZXN0LnN1YnN0cigwLCAyKSA9PT0gJy8vJzsKICAgICAgaWYgKHNsYXNoZXMgJiYgIShwcm90byAmJiBob3N0bGVzc1Byb3RvY29sW3Byb3RvXSkpIHsKICAgICAgICByZXN0ID0gcmVzdC5zdWJzdHIoMik7CiAgICAgICAgdGhpcy5zbGFzaGVzID0gdHJ1ZTsKICAgICAgfQogICAgfQogIAogICAgaWYgKCFob3N0bGVzc1Byb3RvY29sW3Byb3RvXSAmJgogICAgICAgIChzbGFzaGVzIHx8IChwcm90byAmJiAhc2xhc2hlZFByb3RvY29sW3Byb3RvXSkpKSB7CiAgCiAgICAgIC8vIHRoZXJlJ3MgYSBob3N0bmFtZS4KICAgICAgLy8gdGhlIGZpcnN0IGluc3RhbmNlIG9mIC8sID8sIDssIG9yICMgZW5kcyB0aGUgaG9zdC4KICAgICAgLy8KICAgICAgLy8gSWYgdGhlcmUgaXMgYW4gQCBpbiB0aGUgaG9zdG5hbWUsIHRoZW4gbm9uLWhvc3QgY2hhcnMgKmFyZSogYWxsb3dlZAogICAgICAvLyB0byB0aGUgbGVmdCBvZiB0aGUgbGFzdCBAIHNpZ24sIHVubGVzcyBzb21lIGhvc3QtZW5kaW5nIGNoYXJhY3RlcgogICAgICAvLyBjb21lcyAqYmVmb3JlKiB0aGUgQC1zaWduLgogICAgICAvLyBVUkxzIGFyZSBvYm5veGlvdXMuCiAgICAgIC8vCiAgICAgIC8vIGV4OgogICAgICAvLyBodHRwOi8vYUBiQGMvID0+IHVzZXI6YUBiIGhvc3Q6YwogICAgICAvLyBodHRwOi8vYUBiP0BjID0+IHVzZXI6YSBob3N0OmMgcGF0aDovP0BjCiAgCiAgICAgIC8vIHYwLjEyIFRPRE8oaXNhYWNzKTogVGhpcyBpcyBub3QgcXVpdGUgaG93IENocm9tZSBkb2VzIHRoaW5ncy4KICAgICAgLy8gUmV2aWV3IG91ciB0ZXN0IGNhc2UgYWdhaW5zdCBicm93c2VycyBtb3JlIGNvbXByZWhlbnNpdmVseS4KICAKICAgICAgLy8gZmluZCB0aGUgZmlyc3QgaW5zdGFuY2Ugb2YgYW55IGhvc3RFbmRpbmdDaGFycwogICAgICB2YXIgaG9zdEVuZCA9IC0xOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhvc3RFbmRpbmdDaGFycy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBoZWMgPSByZXN0LmluZGV4T2YoaG9zdEVuZGluZ0NoYXJzW2ldKTsKICAgICAgICBpZiAoaGVjICE9PSAtMSAmJiAoaG9zdEVuZCA9PT0gLTEgfHwgaGVjIDwgaG9zdEVuZCkpCiAgICAgICAgICBob3N0RW5kID0gaGVjOwogICAgICB9CiAgCiAgICAgIC8vIGF0IHRoaXMgcG9pbnQsIGVpdGhlciB3ZSBoYXZlIGFuIGV4cGxpY2l0IHBvaW50IHdoZXJlIHRoZQogICAgICAvLyBhdXRoIHBvcnRpb24gY2Fubm90IGdvIHBhc3QsIG9yIHRoZSBsYXN0IEAgY2hhciBpcyB0aGUgZGVjaWRlci4KICAgICAgdmFyIGF1dGgsIGF0U2lnbjsKICAgICAgaWYgKGhvc3RFbmQgPT09IC0xKSB7CiAgICAgICAgLy8gYXRTaWduIGNhbiBiZSBhbnl3aGVyZS4KICAgICAgICBhdFNpZ24gPSByZXN0Lmxhc3RJbmRleE9mKCdAJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gYXRTaWduIG11c3QgYmUgaW4gYXV0aCBwb3J0aW9uLgogICAgICAgIC8vIGh0dHA6Ly9hQGIvY0BkID0+IGhvc3Q6YiBhdXRoOmEgcGF0aDovY0BkCiAgICAgICAgYXRTaWduID0gcmVzdC5sYXN0SW5kZXhPZignQCcsIGhvc3RFbmQpOwogICAgICB9CiAgCiAgICAgIC8vIE5vdyB3ZSBoYXZlIGEgcG9ydGlvbiB3aGljaCBpcyBkZWZpbml0ZWx5IHRoZSBhdXRoLgogICAgICAvLyBQdWxsIHRoYXQgb2ZmLgogICAgICBpZiAoYXRTaWduICE9PSAtMSkgewogICAgICAgIGF1dGggPSByZXN0LnNsaWNlKDAsIGF0U2lnbik7CiAgICAgICAgcmVzdCA9IHJlc3Quc2xpY2UoYXRTaWduICsgMSk7CiAgICAgICAgdGhpcy5hdXRoID0gZGVjb2RlVVJJQ29tcG9uZW50KGF1dGgpOwogICAgICB9CiAgCiAgICAgIC8vIHRoZSBob3N0IGlzIHRoZSByZW1haW5pbmcgdG8gdGhlIGxlZnQgb2YgdGhlIGZpcnN0IG5vbi1ob3N0IGNoYXIKICAgICAgaG9zdEVuZCA9IC0xOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vbkhvc3RDaGFycy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBoZWMgPSByZXN0LmluZGV4T2Yobm9uSG9zdENoYXJzW2ldKTsKICAgICAgICBpZiAoaGVjICE9PSAtMSAmJiAoaG9zdEVuZCA9PT0gLTEgfHwgaGVjIDwgaG9zdEVuZCkpCiAgICAgICAgICBob3N0RW5kID0gaGVjOwogICAgICB9CiAgICAgIC8vIGlmIHdlIHN0aWxsIGhhdmUgbm90IGhpdCBpdCwgdGhlbiB0aGUgZW50aXJlIHRoaW5nIGlzIGEgaG9zdC4KICAgICAgaWYgKGhvc3RFbmQgPT09IC0xKQogICAgICAgIGhvc3RFbmQgPSByZXN0Lmxlbmd0aDsKICAKICAgICAgdGhpcy5ob3N0ID0gcmVzdC5zbGljZSgwLCBob3N0RW5kKTsKICAgICAgcmVzdCA9IHJlc3Quc2xpY2UoaG9zdEVuZCk7CiAgCiAgICAgIC8vIHB1bGwgb3V0IHBvcnQuCiAgICAgIHRoaXMucGFyc2VIb3N0KCk7CiAgCiAgICAgIC8vIHdlJ3ZlIGluZGljYXRlZCB0aGF0IHRoZXJlIGlzIGEgaG9zdG5hbWUsCiAgICAgIC8vIHNvIGV2ZW4gaWYgaXQncyBlbXB0eSwgaXQgaGFzIHRvIGJlIHByZXNlbnQuCiAgICAgIHRoaXMuaG9zdG5hbWUgPSB0aGlzLmhvc3RuYW1lIHx8ICcnOwogIAogICAgICAvLyBpZiBob3N0bmFtZSBiZWdpbnMgd2l0aCBbIGFuZCBlbmRzIHdpdGggXQogICAgICAvLyBhc3N1bWUgdGhhdCBpdCdzIGFuIElQdjYgYWRkcmVzcy4KICAgICAgdmFyIGlwdjZIb3N0bmFtZSA9IHRoaXMuaG9zdG5hbWVbMF0gPT09ICdbJyAmJgogICAgICAgICAgdGhpcy5ob3N0bmFtZVt0aGlzLmhvc3RuYW1lLmxlbmd0aCAtIDFdID09PSAnXSc7CiAgCiAgICAgIC8vIHZhbGlkYXRlIGEgbGl0dGxlLgogICAgICBpZiAoIWlwdjZIb3N0bmFtZSkgewogICAgICAgIHZhciBob3N0cGFydHMgPSB0aGlzLmhvc3RuYW1lLnNwbGl0KC9cLi8pOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gaG9zdHBhcnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdmFyIHBhcnQgPSBob3N0cGFydHNbaV07CiAgICAgICAgICBpZiAoIXBhcnQpIGNvbnRpbnVlOwogICAgICAgICAgaWYgKCFwYXJ0Lm1hdGNoKGhvc3RuYW1lUGFydFBhdHRlcm4pKSB7CiAgICAgICAgICAgIHZhciBuZXdwYXJ0ID0gJyc7CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBrID0gcGFydC5sZW5ndGg7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgICBpZiAocGFydC5jaGFyQ29kZUF0KGopID4gMTI3KSB7CiAgICAgICAgICAgICAgICAvLyB3ZSByZXBsYWNlIG5vbi1BU0NJSSBjaGFyIHdpdGggYSB0ZW1wb3JhcnkgcGxhY2Vob2xkZXIKICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgdGhpcyB0byBtYWtlIHN1cmUgc2l6ZSBvZiBob3N0bmFtZSBpcyBub3QKICAgICAgICAgICAgICAgIC8vIGJyb2tlbiBieSByZXBsYWNpbmcgbm9uLUFTQ0lJIGJ5IG5vdGhpbmcKICAgICAgICAgICAgICAgIG5ld3BhcnQgKz0gJ3gnOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXdwYXJ0ICs9IHBhcnRbal07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHdlIHRlc3QgYWdhaW4gd2l0aCBBU0NJSSBjaGFyIG9ubHkKICAgICAgICAgICAgaWYgKCFuZXdwYXJ0Lm1hdGNoKGhvc3RuYW1lUGFydFBhdHRlcm4pKSB7CiAgICAgICAgICAgICAgdmFyIHZhbGlkUGFydHMgPSBob3N0cGFydHMuc2xpY2UoMCwgaSk7CiAgICAgICAgICAgICAgdmFyIG5vdEhvc3QgPSBob3N0cGFydHMuc2xpY2UoaSArIDEpOwogICAgICAgICAgICAgIHZhciBiaXQgPSBwYXJ0Lm1hdGNoKGhvc3RuYW1lUGFydFN0YXJ0KTsKICAgICAgICAgICAgICBpZiAoYml0KSB7CiAgICAgICAgICAgICAgICB2YWxpZFBhcnRzLnB1c2goYml0WzFdKTsKICAgICAgICAgICAgICAgIG5vdEhvc3QudW5zaGlmdChiaXRbMl0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm90SG9zdC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHJlc3QgPSAnLycgKyBub3RIb3N0LmpvaW4oJy4nKSArIHJlc3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuaG9zdG5hbWUgPSB2YWxpZFBhcnRzLmpvaW4oJy4nKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogIAogICAgICBpZiAodGhpcy5ob3N0bmFtZS5sZW5ndGggPiBob3N0bmFtZU1heExlbikgewogICAgICAgIHRoaXMuaG9zdG5hbWUgPSAnJzsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBob3N0bmFtZXMgYXJlIGFsd2F5cyBsb3dlciBjYXNlLgogICAgICAgIHRoaXMuaG9zdG5hbWUgPSB0aGlzLmhvc3RuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgIH0KICAKICAgICAgaWYgKCFpcHY2SG9zdG5hbWUpIHsKICAgICAgICAvLyBJRE5BIFN1cHBvcnQ6IFJldHVybnMgYSBwdW55IGNvZGVkIHJlcHJlc2VudGF0aW9uIG9mICJkb21haW4iLgogICAgICAgIC8vIEl0IG9ubHkgY29udmVydHMgdGhlIHBhcnQgb2YgdGhlIGRvbWFpbiBuYW1lIHRoYXQKICAgICAgICAvLyBoYXMgbm9uIEFTQ0lJIGNoYXJhY3RlcnMuIEkuZS4gaXQgZG9zZW50IG1hdHRlciBpZgogICAgICAgIC8vIHlvdSBjYWxsIGl0IHdpdGggYSBkb21haW4gdGhhdCBhbHJlYWR5IGlzIGluIEFTQ0lJLgogICAgICAgIHZhciBkb21haW5BcnJheSA9IHRoaXMuaG9zdG5hbWUuc3BsaXQoJy4nKTsKICAgICAgICB2YXIgbmV3T3V0ID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkb21haW5BcnJheS5sZW5ndGg7ICsraSkgewogICAgICAgICAgdmFyIHMgPSBkb21haW5BcnJheVtpXTsKICAgICAgICAgIG5ld091dC5wdXNoKHMubWF0Y2goL1teQS1aYS16MC05Xy1dLykgPwogICAgICAgICAgICAgICd4bi0tJyArIHB1bnljb2RlLmVuY29kZShzKSA6IHMpOwogICAgICAgIH0KICAgICAgICB0aGlzLmhvc3RuYW1lID0gbmV3T3V0LmpvaW4oJy4nKTsKICAgICAgfQogIAogICAgICB2YXIgcCA9IHRoaXMucG9ydCA/ICc6JyArIHRoaXMucG9ydCA6ICcnOwogICAgICB2YXIgaCA9IHRoaXMuaG9zdG5hbWUgfHwgJyc7CiAgICAgIHRoaXMuaG9zdCA9IGggKyBwOwogICAgICB0aGlzLmhyZWYgKz0gdGhpcy5ob3N0OwogIAogICAgICAvLyBzdHJpcCBbIGFuZCBdIGZyb20gdGhlIGhvc3RuYW1lCiAgICAgIC8vIHRoZSBob3N0IGZpZWxkIHN0aWxsIHJldGFpbnMgdGhlbSwgdGhvdWdoCiAgICAgIGlmIChpcHY2SG9zdG5hbWUpIHsKICAgICAgICB0aGlzLmhvc3RuYW1lID0gdGhpcy5ob3N0bmFtZS5zdWJzdHIoMSwgdGhpcy5ob3N0bmFtZS5sZW5ndGggLSAyKTsKICAgICAgICBpZiAocmVzdFswXSAhPT0gJy8nKSB7CiAgICAgICAgICByZXN0ID0gJy8nICsgcmVzdDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAKICAgIC8vIG5vdyByZXN0IGlzIHNldCB0byB0aGUgcG9zdC1ob3N0IHN0dWZmLgogICAgLy8gY2hvcCBvZmYgYW55IGRlbGltIGNoYXJzLgogICAgaWYgKCF1bnNhZmVQcm90b2NvbFtsb3dlclByb3RvXSkgewogIAogICAgICAvLyBGaXJzdCwgbWFrZSAxMDAlIHN1cmUgdGhhdCBhbnkgImF1dG9Fc2NhcGUiIGNoYXJzIGdldAogICAgICAvLyBlc2NhcGVkLCBldmVuIGlmIGVuY29kZVVSSUNvbXBvbmVudCBkb2Vzbid0IHRoaW5rIHRoZXkKICAgICAgLy8gbmVlZCB0byBiZS4KICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBhdXRvRXNjYXBlLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHZhciBhZSA9IGF1dG9Fc2NhcGVbaV07CiAgICAgICAgdmFyIGVzYyA9IGVuY29kZVVSSUNvbXBvbmVudChhZSk7CiAgICAgICAgaWYgKGVzYyA9PT0gYWUpIHsKICAgICAgICAgIGVzYyA9IGVzY2FwZShhZSk7CiAgICAgICAgfQogICAgICAgIHJlc3QgPSByZXN0LnNwbGl0KGFlKS5qb2luKGVzYyk7CiAgICAgIH0KICAgIH0KICAKICAKICAgIC8vIGNob3Agb2ZmIGZyb20gdGhlIHRhaWwgZmlyc3QuCiAgICB2YXIgaGFzaCA9IHJlc3QuaW5kZXhPZignIycpOwogICAgaWYgKGhhc2ggIT09IC0xKSB7CiAgICAgIC8vIGdvdCBhIGZyYWdtZW50IHN0cmluZy4KICAgICAgdGhpcy5oYXNoID0gcmVzdC5zdWJzdHIoaGFzaCk7CiAgICAgIHJlc3QgPSByZXN0LnNsaWNlKDAsIGhhc2gpOwogICAgfQogICAgdmFyIHFtID0gcmVzdC5pbmRleE9mKCc/Jyk7CiAgICBpZiAocW0gIT09IC0xKSB7CiAgICAgIHRoaXMuc2VhcmNoID0gcmVzdC5zdWJzdHIocW0pOwogICAgICB0aGlzLnF1ZXJ5ID0gcmVzdC5zdWJzdHIocW0gKyAxKTsKICAgICAgaWYgKHBhcnNlUXVlcnlTdHJpbmcpIHsKICAgICAgICB0aGlzLnF1ZXJ5ID0gcXVlcnlzdHJpbmcucGFyc2UodGhpcy5xdWVyeSk7CiAgICAgIH0KICAgICAgcmVzdCA9IHJlc3Quc2xpY2UoMCwgcW0pOwogICAgfSBlbHNlIGlmIChwYXJzZVF1ZXJ5U3RyaW5nKSB7CiAgICAgIC8vIG5vIHF1ZXJ5IHN0cmluZywgYnV0IHBhcnNlUXVlcnlTdHJpbmcgc3RpbGwgcmVxdWVzdGVkCiAgICAgIHRoaXMuc2VhcmNoID0gJyc7CiAgICAgIHRoaXMucXVlcnkgPSB7fTsKICAgIH0KICAgIGlmIChyZXN0KSB0aGlzLnBhdGhuYW1lID0gcmVzdDsKICAgIGlmIChzbGFzaGVkUHJvdG9jb2xbbG93ZXJQcm90b10gJiYKICAgICAgICB0aGlzLmhvc3RuYW1lICYmICF0aGlzLnBhdGhuYW1lKSB7CiAgICAgIHRoaXMucGF0aG5hbWUgPSAnLyc7CiAgICB9CiAgCiAgICAvL3RvIHN1cHBvcnQgaHR0cC5yZXF1ZXN0CiAgICBpZiAodGhpcy5wYXRobmFtZSB8fCB0aGlzLnNlYXJjaCkgewogICAgICB2YXIgcCA9IHRoaXMucGF0aG5hbWUgfHwgJyc7CiAgICAgIHZhciBzID0gdGhpcy5zZWFyY2ggfHwgJyc7CiAgICAgIHRoaXMucGF0aCA9IHAgKyBzOwogICAgfQogIAogICAgLy8gZmluYWxseSwgcmVjb25zdHJ1Y3QgdGhlIGhyZWYgYmFzZWQgb24gd2hhdCBoYXMgYmVlbiB2YWxpZGF0ZWQuCiAgICB0aGlzLmhyZWYgPSB0aGlzLmZvcm1hdCgpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICAvLyBmb3JtYXQgYSBwYXJzZWQgb2JqZWN0IGludG8gYSB1cmwgc3RyaW5nCiAgZnVuY3Rpb24gdXJsRm9ybWF0KG9iaikgewogICAgLy8gZW5zdXJlIGl0J3MgYW4gb2JqZWN0LCBhbmQgbm90IGEgc3RyaW5nIHVybC4KICAgIC8vIElmIGl0J3MgYW4gb2JqLCB0aGlzIGlzIGEgbm8tb3AuCiAgICAvLyB0aGlzIHdheSwgeW91IGNhbiBjYWxsIHVybF9mb3JtYXQoKSBvbiBzdHJpbmdzCiAgICAvLyB0byBjbGVhbiB1cCBwb3RlbnRpYWxseSB3b25reSB1cmxzLgogICAgaWYgKGlzU3RyaW5nKG9iaikpIG9iaiA9IHVybFBhcnNlKG9iaik7CiAgICBpZiAoIShvYmogaW5zdGFuY2VvZiBVcmwpKSByZXR1cm4gVXJsLnByb3RvdHlwZS5mb3JtYXQuY2FsbChvYmopOwogICAgcmV0dXJuIG9iai5mb3JtYXQoKTsKICB9CiAgCiAgVXJsLnByb3RvdHlwZS5mb3JtYXQgPSBmdW5jdGlvbigpIHsKICAgIHZhciBhdXRoID0gdGhpcy5hdXRoIHx8ICcnOwogICAgaWYgKGF1dGgpIHsKICAgICAgYXV0aCA9IGVuY29kZVVSSUNvbXBvbmVudChhdXRoKTsKICAgICAgYXV0aCA9IGF1dGgucmVwbGFjZSgvJTNBL2ksICc6Jyk7CiAgICAgIGF1dGggKz0gJ0AnOwogICAgfQogIAogICAgdmFyIHByb3RvY29sID0gdGhpcy5wcm90b2NvbCB8fCAnJywKICAgICAgICBwYXRobmFtZSA9IHRoaXMucGF0aG5hbWUgfHwgJycsCiAgICAgICAgaGFzaCA9IHRoaXMuaGFzaCB8fCAnJywKICAgICAgICBob3N0ID0gZmFsc2UsCiAgICAgICAgcXVlcnkgPSAnJzsKICAKICAgIGlmICh0aGlzLmhvc3QpIHsKICAgICAgaG9zdCA9IGF1dGggKyB0aGlzLmhvc3Q7CiAgICB9IGVsc2UgaWYgKHRoaXMuaG9zdG5hbWUpIHsKICAgICAgaG9zdCA9IGF1dGggKyAodGhpcy5ob3N0bmFtZS5pbmRleE9mKCc6JykgPT09IC0xID8KICAgICAgICAgIHRoaXMuaG9zdG5hbWUgOgogICAgICAgICAgJ1snICsgdGhpcy5ob3N0bmFtZSArICddJyk7CiAgICAgIGlmICh0aGlzLnBvcnQpIHsKICAgICAgICBob3N0ICs9ICc6JyArIHRoaXMucG9ydDsKICAgICAgfQogICAgfQogIAogICAgaWYgKHRoaXMucXVlcnkgJiYKICAgICAgICBpc09iamVjdCh0aGlzLnF1ZXJ5KSAmJgogICAgICAgIE9iamVjdC5rZXlzKHRoaXMucXVlcnkpLmxlbmd0aCkgewogICAgICBxdWVyeSA9IHF1ZXJ5c3RyaW5nLnN0cmluZ2lmeSh0aGlzLnF1ZXJ5KTsKICAgIH0KICAKICAgIHZhciBzZWFyY2ggPSB0aGlzLnNlYXJjaCB8fCAocXVlcnkgJiYgKCc/JyArIHF1ZXJ5KSkgfHwgJyc7CiAgCiAgICBpZiAocHJvdG9jb2wgJiYgcHJvdG9jb2wuc3Vic3RyKC0xKSAhPT0gJzonKSBwcm90b2NvbCArPSAnOic7CiAgCiAgICAvLyBvbmx5IHRoZSBzbGFzaGVkUHJvdG9jb2xzIGdldCB0aGUgLy8uICBOb3QgbWFpbHRvOiwgeG1wcDosIGV0Yy4KICAgIC8vIHVubGVzcyB0aGV5IGhhZCB0aGVtIHRvIGJlZ2luIHdpdGguCiAgICBpZiAodGhpcy5zbGFzaGVzIHx8CiAgICAgICAgKCFwcm90b2NvbCB8fCBzbGFzaGVkUHJvdG9jb2xbcHJvdG9jb2xdKSAmJiBob3N0ICE9PSBmYWxzZSkgewogICAgICBob3N0ID0gJy8vJyArIChob3N0IHx8ICcnKTsKICAgICAgaWYgKHBhdGhuYW1lICYmIHBhdGhuYW1lLmNoYXJBdCgwKSAhPT0gJy8nKSBwYXRobmFtZSA9ICcvJyArIHBhdGhuYW1lOwogICAgfSBlbHNlIGlmICghaG9zdCkgewogICAgICBob3N0ID0gJyc7CiAgICB9CiAgCiAgICBpZiAoaGFzaCAmJiBoYXNoLmNoYXJBdCgwKSAhPT0gJyMnKSBoYXNoID0gJyMnICsgaGFzaDsKICAgIGlmIChzZWFyY2ggJiYgc2VhcmNoLmNoYXJBdCgwKSAhPT0gJz8nKSBzZWFyY2ggPSAnPycgKyBzZWFyY2g7CiAgCiAgICBwYXRobmFtZSA9IHBhdGhuYW1lLnJlcGxhY2UoL1s/I10vZywgZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChtYXRjaCk7CiAgICB9KTsKICAgIHNlYXJjaCA9IHNlYXJjaC5yZXBsYWNlKCcjJywgJyUyMycpOwogIAogICAgcmV0dXJuIHByb3RvY29sICsgaG9zdCArIHBhdGhuYW1lICsgc2VhcmNoICsgaGFzaDsKICB9OwogIAogIGZ1bmN0aW9uIHVybFJlc29sdmUoc291cmNlLCByZWxhdGl2ZSkgewogICAgcmV0dXJuIHVybFBhcnNlKHNvdXJjZSwgZmFsc2UsIHRydWUpLnJlc29sdmUocmVsYXRpdmUpOwogIH0KICAKICBVcmwucHJvdG90eXBlLnJlc29sdmUgPSBmdW5jdGlvbihyZWxhdGl2ZSkgewogICAgcmV0dXJuIHRoaXMucmVzb2x2ZU9iamVjdCh1cmxQYXJzZShyZWxhdGl2ZSwgZmFsc2UsIHRydWUpKS5mb3JtYXQoKTsKICB9OwogIAogIGZ1bmN0aW9uIHVybFJlc29sdmVPYmplY3Qoc291cmNlLCByZWxhdGl2ZSkgewogICAgaWYgKCFzb3VyY2UpIHJldHVybiByZWxhdGl2ZTsKICAgIHJldHVybiB1cmxQYXJzZShzb3VyY2UsIGZhbHNlLCB0cnVlKS5yZXNvbHZlT2JqZWN0KHJlbGF0aXZlKTsKICB9CiAgCiAgVXJsLnByb3RvdHlwZS5yZXNvbHZlT2JqZWN0ID0gZnVuY3Rpb24ocmVsYXRpdmUpIHsKICAgIGlmIChpc1N0cmluZyhyZWxhdGl2ZSkpIHsKICAgICAgdmFyIHJlbCA9IG5ldyBVcmwoKTsKICAgICAgcmVsLnBhcnNlKHJlbGF0aXZlLCBmYWxzZSwgdHJ1ZSk7CiAgICAgIHJlbGF0aXZlID0gcmVsOwogICAgfQogIAogICAgdmFyIHJlc3VsdCA9IG5ldyBVcmwoKTsKICAgIE9iamVjdC5rZXlzKHRoaXMpLmZvckVhY2goZnVuY3Rpb24oaykgewogICAgICByZXN1bHRba10gPSB0aGlzW2tdOwogICAgfSwgdGhpcyk7CiAgCiAgICAvLyBoYXNoIGlzIGFsd2F5cyBvdmVycmlkZGVuLCBubyBtYXR0ZXIgd2hhdC4KICAgIC8vIGV2ZW4gaHJlZj0iIiB3aWxsIHJlbW92ZSBpdC4KICAgIHJlc3VsdC5oYXNoID0gcmVsYXRpdmUuaGFzaDsKICAKICAgIC8vIGlmIHRoZSByZWxhdGl2ZSB1cmwgaXMgZW1wdHksIHRoZW4gdGhlcmUncyBub3RoaW5nIGxlZnQgdG8gZG8gaGVyZS4KICAgIGlmIChyZWxhdGl2ZS5ocmVmID09PSAnJykgewogICAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAKICAgIC8vIGhyZWZzIGxpa2UgLy9mb28vYmFyIGFsd2F5cyBjdXQgdG8gdGhlIHByb3RvY29sLgogICAgaWYgKHJlbGF0aXZlLnNsYXNoZXMgJiYgIXJlbGF0aXZlLnByb3RvY29sKSB7CiAgICAgIC8vIHRha2UgZXZlcnl0aGluZyBleGNlcHQgdGhlIHByb3RvY29sIGZyb20gcmVsYXRpdmUKICAgICAgT2JqZWN0LmtleXMocmVsYXRpdmUpLmZvckVhY2goZnVuY3Rpb24oaykgewogICAgICAgIGlmIChrICE9PSAncHJvdG9jb2wnKQogICAgICAgICAgcmVzdWx0W2tdID0gcmVsYXRpdmVba107CiAgICAgIH0pOwogIAogICAgICAvL3VybFBhcnNlIGFwcGVuZHMgdHJhaWxpbmcgLyB0byB1cmxzIGxpa2UgaHR0cDovL3d3dy5leGFtcGxlLmNvbQogICAgICBpZiAoc2xhc2hlZFByb3RvY29sW3Jlc3VsdC5wcm90b2NvbF0gJiYKICAgICAgICAgIHJlc3VsdC5ob3N0bmFtZSAmJiAhcmVzdWx0LnBhdGhuYW1lKSB7CiAgICAgICAgcmVzdWx0LnBhdGggPSByZXN1bHQucGF0aG5hbWUgPSAnLyc7CiAgICAgIH0KICAKICAgICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgCiAgICBpZiAocmVsYXRpdmUucHJvdG9jb2wgJiYgcmVsYXRpdmUucHJvdG9jb2wgIT09IHJlc3VsdC5wcm90b2NvbCkgewogICAgICAvLyBpZiBpdCdzIGEga25vd24gdXJsIHByb3RvY29sLCB0aGVuIGNoYW5naW5nCiAgICAgIC8vIHRoZSBwcm90b2NvbCBkb2VzIHdlaXJkIHRoaW5ncwogICAgICAvLyBmaXJzdCwgaWYgaXQncyBub3QgZmlsZTosIHRoZW4gd2UgTVVTVCBoYXZlIGEgaG9zdCwKICAgICAgLy8gYW5kIGlmIHRoZXJlIHdhcyBhIHBhdGgKICAgICAgLy8gdG8gYmVnaW4gd2l0aCwgdGhlbiB3ZSBNVVNUIGhhdmUgYSBwYXRoLgogICAgICAvLyBpZiBpdCBpcyBmaWxlOiwgdGhlbiB0aGUgaG9zdCBpcyBkcm9wcGVkLAogICAgICAvLyBiZWNhdXNlIHRoYXQncyBrbm93biB0byBiZSBob3N0bGVzcy4KICAgICAgLy8gYW55dGhpbmcgZWxzZSBpcyBhc3N1bWVkIHRvIGJlIGFic29sdXRlLgogICAgICBpZiAoIXNsYXNoZWRQcm90b2NvbFtyZWxhdGl2ZS5wcm90b2NvbF0pIHsKICAgICAgICBPYmplY3Qua2V5cyhyZWxhdGl2ZSkuZm9yRWFjaChmdW5jdGlvbihrKSB7CiAgICAgICAgICByZXN1bHRba10gPSByZWxhdGl2ZVtrXTsKICAgICAgICB9KTsKICAgICAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgCiAgICAgIHJlc3VsdC5wcm90b2NvbCA9IHJlbGF0aXZlLnByb3RvY29sOwogICAgICBpZiAoIXJlbGF0aXZlLmhvc3QgJiYgIWhvc3RsZXNzUHJvdG9jb2xbcmVsYXRpdmUucHJvdG9jb2xdKSB7CiAgICAgICAgdmFyIHJlbFBhdGggPSAocmVsYXRpdmUucGF0aG5hbWUgfHwgJycpLnNwbGl0KCcvJyk7CiAgICAgICAgd2hpbGUgKHJlbFBhdGgubGVuZ3RoICYmICEocmVsYXRpdmUuaG9zdCA9IHJlbFBhdGguc2hpZnQoKSkpOwogICAgICAgIGlmICghcmVsYXRpdmUuaG9zdCkgcmVsYXRpdmUuaG9zdCA9ICcnOwogICAgICAgIGlmICghcmVsYXRpdmUuaG9zdG5hbWUpIHJlbGF0aXZlLmhvc3RuYW1lID0gJyc7CiAgICAgICAgaWYgKHJlbFBhdGhbMF0gIT09ICcnKSByZWxQYXRoLnVuc2hpZnQoJycpOwogICAgICAgIGlmIChyZWxQYXRoLmxlbmd0aCA8IDIpIHJlbFBhdGgudW5zaGlmdCgnJyk7CiAgICAgICAgcmVzdWx0LnBhdGhuYW1lID0gcmVsUGF0aC5qb2luKCcvJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0LnBhdGhuYW1lID0gcmVsYXRpdmUucGF0aG5hbWU7CiAgICAgIH0KICAgICAgcmVzdWx0LnNlYXJjaCA9IHJlbGF0aXZlLnNlYXJjaDsKICAgICAgcmVzdWx0LnF1ZXJ5ID0gcmVsYXRpdmUucXVlcnk7CiAgICAgIHJlc3VsdC5ob3N0ID0gcmVsYXRpdmUuaG9zdCB8fCAnJzsKICAgICAgcmVzdWx0LmF1dGggPSByZWxhdGl2ZS5hdXRoOwogICAgICByZXN1bHQuaG9zdG5hbWUgPSByZWxhdGl2ZS5ob3N0bmFtZSB8fCByZWxhdGl2ZS5ob3N0OwogICAgICByZXN1bHQucG9ydCA9IHJlbGF0aXZlLnBvcnQ7CiAgICAgIC8vIHRvIHN1cHBvcnQgaHR0cC5yZXF1ZXN0CiAgICAgIGlmIChyZXN1bHQucGF0aG5hbWUgfHwgcmVzdWx0LnNlYXJjaCkgewogICAgICAgIHZhciBwID0gcmVzdWx0LnBhdGhuYW1lIHx8ICcnOwogICAgICAgIHZhciBzID0gcmVzdWx0LnNlYXJjaCB8fCAnJzsKICAgICAgICByZXN1bHQucGF0aCA9IHAgKyBzOwogICAgICB9CiAgICAgIHJlc3VsdC5zbGFzaGVzID0gcmVzdWx0LnNsYXNoZXMgfHwgcmVsYXRpdmUuc2xhc2hlczsKICAgICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgCiAgICB2YXIgaXNTb3VyY2VBYnMgPSAocmVzdWx0LnBhdGhuYW1lICYmIHJlc3VsdC5wYXRobmFtZS5jaGFyQXQoMCkgPT09ICcvJyksCiAgICAgICAgaXNSZWxBYnMgPSAoCiAgICAgICAgICAgIHJlbGF0aXZlLmhvc3QgfHwKICAgICAgICAgICAgcmVsYXRpdmUucGF0aG5hbWUgJiYgcmVsYXRpdmUucGF0aG5hbWUuY2hhckF0KDApID09PSAnLycKICAgICAgICApLAogICAgICAgIG11c3RFbmRBYnMgPSAoaXNSZWxBYnMgfHwgaXNTb3VyY2VBYnMgfHwKICAgICAgICAgICAgICAgICAgICAgIChyZXN1bHQuaG9zdCAmJiByZWxhdGl2ZS5wYXRobmFtZSkpLAogICAgICAgIHJlbW92ZUFsbERvdHMgPSBtdXN0RW5kQWJzLAogICAgICAgIHNyY1BhdGggPSByZXN1bHQucGF0aG5hbWUgJiYgcmVzdWx0LnBhdGhuYW1lLnNwbGl0KCcvJykgfHwgW10sCiAgICAgICAgcmVsUGF0aCA9IHJlbGF0aXZlLnBhdGhuYW1lICYmIHJlbGF0aXZlLnBhdGhuYW1lLnNwbGl0KCcvJykgfHwgW10sCiAgICAgICAgcHN5Y2hvdGljID0gcmVzdWx0LnByb3RvY29sICYmICFzbGFzaGVkUHJvdG9jb2xbcmVzdWx0LnByb3RvY29sXTsKICAKICAgIC8vIGlmIHRoZSB1cmwgaXMgYSBub24tc2xhc2hlZCB1cmwsIHRoZW4gcmVsYXRpdmUKICAgIC8vIGxpbmtzIGxpa2UgLi4vLi4gc2hvdWxkIGJlIGFibGUKICAgIC8vIHRvIGNyYXdsIHVwIHRvIHRoZSBob3N0bmFtZSwgYXMgd2VsbC4gIFRoaXMgaXMgc3RyYW5nZS4KICAgIC8vIHJlc3VsdC5wcm90b2NvbCBoYXMgYWxyZWFkeSBiZWVuIHNldCBieSBub3cuCiAgICAvLyBMYXRlciBvbiwgcHV0IHRoZSBmaXJzdCBwYXRoIHBhcnQgaW50byB0aGUgaG9zdCBmaWVsZC4KICAgIGlmIChwc3ljaG90aWMpIHsKICAgICAgcmVzdWx0Lmhvc3RuYW1lID0gJyc7CiAgICAgIHJlc3VsdC5wb3J0ID0gbnVsbDsKICAgICAgaWYgKHJlc3VsdC5ob3N0KSB7CiAgICAgICAgaWYgKHNyY1BhdGhbMF0gPT09ICcnKSBzcmNQYXRoWzBdID0gcmVzdWx0Lmhvc3Q7CiAgICAgICAgZWxzZSBzcmNQYXRoLnVuc2hpZnQocmVzdWx0Lmhvc3QpOwogICAgICB9CiAgICAgIHJlc3VsdC5ob3N0ID0gJyc7CiAgICAgIGlmIChyZWxhdGl2ZS5wcm90b2NvbCkgewogICAgICAgIHJlbGF0aXZlLmhvc3RuYW1lID0gbnVsbDsKICAgICAgICByZWxhdGl2ZS5wb3J0ID0gbnVsbDsKICAgICAgICBpZiAocmVsYXRpdmUuaG9zdCkgewogICAgICAgICAgaWYgKHJlbFBhdGhbMF0gPT09ICcnKSByZWxQYXRoWzBdID0gcmVsYXRpdmUuaG9zdDsKICAgICAgICAgIGVsc2UgcmVsUGF0aC51bnNoaWZ0KHJlbGF0aXZlLmhvc3QpOwogICAgICAgIH0KICAgICAgICByZWxhdGl2ZS5ob3N0ID0gbnVsbDsKICAgICAgfQogICAgICBtdXN0RW5kQWJzID0gbXVzdEVuZEFicyAmJiAocmVsUGF0aFswXSA9PT0gJycgfHwgc3JjUGF0aFswXSA9PT0gJycpOwogICAgfQogIAogICAgaWYgKGlzUmVsQWJzKSB7CiAgICAgIC8vIGl0J3MgYWJzb2x1dGUuCiAgICAgIHJlc3VsdC5ob3N0ID0gKHJlbGF0aXZlLmhvc3QgfHwgcmVsYXRpdmUuaG9zdCA9PT0gJycpID8KICAgICAgICAgICAgICAgICAgICByZWxhdGl2ZS5ob3N0IDogcmVzdWx0Lmhvc3Q7CiAgICAgIHJlc3VsdC5ob3N0bmFtZSA9IChyZWxhdGl2ZS5ob3N0bmFtZSB8fCByZWxhdGl2ZS5ob3N0bmFtZSA9PT0gJycpID8KICAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRpdmUuaG9zdG5hbWUgOiByZXN1bHQuaG9zdG5hbWU7CiAgICAgIHJlc3VsdC5zZWFyY2ggPSByZWxhdGl2ZS5zZWFyY2g7CiAgICAgIHJlc3VsdC5xdWVyeSA9IHJlbGF0aXZlLnF1ZXJ5OwogICAgICBzcmNQYXRoID0gcmVsUGF0aDsKICAgICAgLy8gZmFsbCB0aHJvdWdoIHRvIHRoZSBkb3QtaGFuZGxpbmcgYmVsb3cuCiAgICB9IGVsc2UgaWYgKHJlbFBhdGgubGVuZ3RoKSB7CiAgICAgIC8vIGl0J3MgcmVsYXRpdmUKICAgICAgLy8gdGhyb3cgYXdheSB0aGUgZXhpc3RpbmcgZmlsZSwgYW5kIHRha2UgdGhlIG5ldyBwYXRoIGluc3RlYWQuCiAgICAgIGlmICghc3JjUGF0aCkgc3JjUGF0aCA9IFtdOwogICAgICBzcmNQYXRoLnBvcCgpOwogICAgICBzcmNQYXRoID0gc3JjUGF0aC5jb25jYXQocmVsUGF0aCk7CiAgICAgIHJlc3VsdC5zZWFyY2ggPSByZWxhdGl2ZS5zZWFyY2g7CiAgICAgIHJlc3VsdC5xdWVyeSA9IHJlbGF0aXZlLnF1ZXJ5OwogICAgfSBlbHNlIGlmICghaXNOdWxsT3JVbmRlZmluZWQocmVsYXRpdmUuc2VhcmNoKSkgewogICAgICAvLyBqdXN0IHB1bGwgb3V0IHRoZSBzZWFyY2guCiAgICAgIC8vIGxpa2UgaHJlZj0nP2ZvbycuCiAgICAgIC8vIFB1dCB0aGlzIGFmdGVyIHRoZSBvdGhlciB0d28gY2FzZXMgYmVjYXVzZSBpdCBzaW1wbGlmaWVzIHRoZSBib29sZWFucwogICAgICBpZiAocHN5Y2hvdGljKSB7CiAgICAgICAgcmVzdWx0Lmhvc3RuYW1lID0gcmVzdWx0Lmhvc3QgPSBzcmNQYXRoLnNoaWZ0KCk7CiAgICAgICAgLy9vY2NhdGlvbmFseSB0aGUgYXV0aCBjYW4gZ2V0IHN0dWNrIG9ubHkgaW4gaG9zdAogICAgICAgIC8vdGhpcyBlc3BlY2lhbHkgaGFwcGVucyBpbiBjYXNlcyBsaWtlCiAgICAgICAgLy91cmwucmVzb2x2ZU9iamVjdCgnbWFpbHRvOmxvY2FsMUBkb21haW4xJywgJ2xvY2FsMkBkb21haW4yJykKICAgICAgICB2YXIgYXV0aEluSG9zdCA9IHJlc3VsdC5ob3N0ICYmIHJlc3VsdC5ob3N0LmluZGV4T2YoJ0AnKSA+IDAgPwogICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lmhvc3Quc3BsaXQoJ0AnKSA6IGZhbHNlOwogICAgICAgIGlmIChhdXRoSW5Ib3N0KSB7CiAgICAgICAgICByZXN1bHQuYXV0aCA9IGF1dGhJbkhvc3Quc2hpZnQoKTsKICAgICAgICAgIHJlc3VsdC5ob3N0ID0gcmVzdWx0Lmhvc3RuYW1lID0gYXV0aEluSG9zdC5zaGlmdCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXN1bHQuc2VhcmNoID0gcmVsYXRpdmUuc2VhcmNoOwogICAgICByZXN1bHQucXVlcnkgPSByZWxhdGl2ZS5xdWVyeTsKICAgICAgLy90byBzdXBwb3J0IGh0dHAucmVxdWVzdAogICAgICBpZiAoIWlzTnVsbChyZXN1bHQucGF0aG5hbWUpIHx8ICFpc051bGwocmVzdWx0LnNlYXJjaCkpIHsKICAgICAgICByZXN1bHQucGF0aCA9IChyZXN1bHQucGF0aG5hbWUgPyByZXN1bHQucGF0aG5hbWUgOiAnJykgKwogICAgICAgICAgICAgICAgICAgICAgKHJlc3VsdC5zZWFyY2ggPyByZXN1bHQuc2VhcmNoIDogJycpOwogICAgICB9CiAgICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIAogICAgaWYgKCFzcmNQYXRoLmxlbmd0aCkgewogICAgICAvLyBubyBwYXRoIGF0IGFsbC4gIGVhc3kuCiAgICAgIC8vIHdlJ3ZlIGFscmVhZHkgaGFuZGxlZCB0aGUgb3RoZXIgc3R1ZmYgYWJvdmUuCiAgICAgIHJlc3VsdC5wYXRobmFtZSA9IG51bGw7CiAgICAgIC8vdG8gc3VwcG9ydCBodHRwLnJlcXVlc3QKICAgICAgaWYgKHJlc3VsdC5zZWFyY2gpIHsKICAgICAgICByZXN1bHQucGF0aCA9ICcvJyArIHJlc3VsdC5zZWFyY2g7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0LnBhdGggPSBudWxsOwogICAgICB9CiAgICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIAogICAgLy8gaWYgYSB1cmwgRU5EcyBpbiAuIG9yIC4uLCB0aGVuIGl0IG11c3QgZ2V0IGEgdHJhaWxpbmcgc2xhc2guCiAgICAvLyBob3dldmVyLCBpZiBpdCBlbmRzIGluIGFueXRoaW5nIGVsc2Ugbm9uLXNsYXNoeSwKICAgIC8vIHRoZW4gaXQgbXVzdCBOT1QgZ2V0IGEgdHJhaWxpbmcgc2xhc2guCiAgICB2YXIgbGFzdCA9IHNyY1BhdGguc2xpY2UoLTEpWzBdOwogICAgdmFyIGhhc1RyYWlsaW5nU2xhc2ggPSAoCiAgICAgICAgKHJlc3VsdC5ob3N0IHx8IHJlbGF0aXZlLmhvc3QpICYmIChsYXN0ID09PSAnLicgfHwgbGFzdCA9PT0gJy4uJykgfHwKICAgICAgICBsYXN0ID09PSAnJyk7CiAgCiAgICAvLyBzdHJpcCBzaW5nbGUgZG90cywgcmVzb2x2ZSBkb3VibGUgZG90cyB0byBwYXJlbnQgZGlyCiAgICAvLyBpZiB0aGUgcGF0aCB0cmllcyB0byBnbyBhYm92ZSB0aGUgcm9vdCwgYHVwYCBlbmRzIHVwID4gMAogICAgdmFyIHVwID0gMDsKICAgIGZvciAodmFyIGkgPSBzcmNQYXRoLmxlbmd0aDsgaSA+PSAwOyBpLS0pIHsKICAgICAgbGFzdCA9IHNyY1BhdGhbaV07CiAgICAgIGlmIChsYXN0ID09ICcuJykgewogICAgICAgIHNyY1BhdGguc3BsaWNlKGksIDEpOwogICAgICB9IGVsc2UgaWYgKGxhc3QgPT09ICcuLicpIHsKICAgICAgICBzcmNQYXRoLnNwbGljZShpLCAxKTsKICAgICAgICB1cCsrOwogICAgICB9IGVsc2UgaWYgKHVwKSB7CiAgICAgICAgc3JjUGF0aC5zcGxpY2UoaSwgMSk7CiAgICAgICAgdXAtLTsKICAgICAgfQogICAgfQogIAogICAgLy8gaWYgdGhlIHBhdGggaXMgYWxsb3dlZCB0byBnbyBhYm92ZSB0aGUgcm9vdCwgcmVzdG9yZSBsZWFkaW5nIC4ucwogICAgaWYgKCFtdXN0RW5kQWJzICYmICFyZW1vdmVBbGxEb3RzKSB7CiAgICAgIGZvciAoOyB1cC0tOyB1cCkgewogICAgICAgIHNyY1BhdGgudW5zaGlmdCgnLi4nKTsKICAgICAgfQogICAgfQogIAogICAgaWYgKG11c3RFbmRBYnMgJiYgc3JjUGF0aFswXSAhPT0gJycgJiYKICAgICAgICAoIXNyY1BhdGhbMF0gfHwgc3JjUGF0aFswXS5jaGFyQXQoMCkgIT09ICcvJykpIHsKICAgICAgc3JjUGF0aC51bnNoaWZ0KCcnKTsKICAgIH0KICAKICAgIGlmIChoYXNUcmFpbGluZ1NsYXNoICYmIChzcmNQYXRoLmpvaW4oJy8nKS5zdWJzdHIoLTEpICE9PSAnLycpKSB7CiAgICAgIHNyY1BhdGgucHVzaCgnJyk7CiAgICB9CiAgCiAgICB2YXIgaXNBYnNvbHV0ZSA9IHNyY1BhdGhbMF0gPT09ICcnIHx8CiAgICAgICAgKHNyY1BhdGhbMF0gJiYgc3JjUGF0aFswXS5jaGFyQXQoMCkgPT09ICcvJyk7CiAgCiAgICAvLyBwdXQgdGhlIGhvc3QgYmFjawogICAgaWYgKHBzeWNob3RpYykgewogICAgICByZXN1bHQuaG9zdG5hbWUgPSByZXN1bHQuaG9zdCA9IGlzQWJzb2x1dGUgPyAnJyA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjUGF0aC5sZW5ndGggPyBzcmNQYXRoLnNoaWZ0KCkgOiAnJzsKICAgICAgLy9vY2NhdGlvbmFseSB0aGUgYXV0aCBjYW4gZ2V0IHN0dWNrIG9ubHkgaW4gaG9zdAogICAgICAvL3RoaXMgZXNwZWNpYWx5IGhhcHBlbnMgaW4gY2FzZXMgbGlrZQogICAgICAvL3VybC5yZXNvbHZlT2JqZWN0KCdtYWlsdG86bG9jYWwxQGRvbWFpbjEnLCAnbG9jYWwyQGRvbWFpbjInKQogICAgICB2YXIgYXV0aEluSG9zdCA9IHJlc3VsdC5ob3N0ICYmIHJlc3VsdC5ob3N0LmluZGV4T2YoJ0AnKSA+IDAgPwogICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5ob3N0LnNwbGl0KCdAJykgOiBmYWxzZTsKICAgICAgaWYgKGF1dGhJbkhvc3QpIHsKICAgICAgICByZXN1bHQuYXV0aCA9IGF1dGhJbkhvc3Quc2hpZnQoKTsKICAgICAgICByZXN1bHQuaG9zdCA9IHJlc3VsdC5ob3N0bmFtZSA9IGF1dGhJbkhvc3Quc2hpZnQoKTsKICAgICAgfQogICAgfQogIAogICAgbXVzdEVuZEFicyA9IG11c3RFbmRBYnMgfHwgKHJlc3VsdC5ob3N0ICYmIHNyY1BhdGgubGVuZ3RoKTsKICAKICAgIGlmIChtdXN0RW5kQWJzICYmICFpc0Fic29sdXRlKSB7CiAgICAgIHNyY1BhdGgudW5zaGlmdCgnJyk7CiAgICB9CiAgCiAgICBpZiAoIXNyY1BhdGgubGVuZ3RoKSB7CiAgICAgIHJlc3VsdC5wYXRobmFtZSA9IG51bGw7CiAgICAgIHJlc3VsdC5wYXRoID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdC5wYXRobmFtZSA9IHNyY1BhdGguam9pbignLycpOwogICAgfQogIAogICAgLy90byBzdXBwb3J0IHJlcXVlc3QuaHR0cAogICAgaWYgKCFpc051bGwocmVzdWx0LnBhdGhuYW1lKSB8fCAhaXNOdWxsKHJlc3VsdC5zZWFyY2gpKSB7CiAgICAgIHJlc3VsdC5wYXRoID0gKHJlc3VsdC5wYXRobmFtZSA/IHJlc3VsdC5wYXRobmFtZSA6ICcnKSArCiAgICAgICAgICAgICAgICAgICAgKHJlc3VsdC5zZWFyY2ggPyByZXN1bHQuc2VhcmNoIDogJycpOwogICAgfQogICAgcmVzdWx0LmF1dGggPSByZWxhdGl2ZS5hdXRoIHx8IHJlc3VsdC5hdXRoOwogICAgcmVzdWx0LnNsYXNoZXMgPSByZXN1bHQuc2xhc2hlcyB8fCByZWxhdGl2ZS5zbGFzaGVzOwogICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CiAgCiAgVXJsLnByb3RvdHlwZS5wYXJzZUhvc3QgPSBmdW5jdGlvbigpIHsKICAgIHZhciBob3N0ID0gdGhpcy5ob3N0OwogICAgdmFyIHBvcnQgPSBwb3J0UGF0dGVybi5leGVjKGhvc3QpOwogICAgaWYgKHBvcnQpIHsKICAgICAgcG9ydCA9IHBvcnRbMF07CiAgICAgIGlmIChwb3J0ICE9PSAnOicpIHsKICAgICAgICB0aGlzLnBvcnQgPSBwb3J0LnN1YnN0cigxKTsKICAgICAgfQogICAgICBob3N0ID0gaG9zdC5zdWJzdHIoMCwgaG9zdC5sZW5ndGggLSBwb3J0Lmxlbmd0aCk7CiAgICB9CiAgICBpZiAoaG9zdCkgdGhpcy5ob3N0bmFtZSA9IGhvc3Q7CiAgfTsKICAKICBmdW5jdGlvbiBpc1N0cmluZyhhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAic3RyaW5nIjsKICB9CiAgCiAgZnVuY3Rpb24gaXNPYmplY3QoYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcgJiYgYXJnICE9PSBudWxsOwogIH0KICAKICBmdW5jdGlvbiBpc051bGwoYXJnKSB7CiAgICByZXR1cm4gYXJnID09PSBudWxsOwogIH0KICBmdW5jdGlvbiBpc051bGxPclVuZGVmaW5lZChhcmcpIHsKICAgIHJldHVybiAgYXJnID09IG51bGw7CiAgfQogIAogIH0seyJwdW55Y29kZSI6ODAsInF1ZXJ5c3RyaW5nIjo4OX1dLDk1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBpZiAodHlwZW9mIE9iamVjdC5jcmVhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgIC8vIGltcGxlbWVudGF0aW9uIGZyb20gc3RhbmRhcmQgbm9kZS5qcyAndXRpbCcgbW9kdWxlCiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGluaGVyaXRzKGN0b3IsIHN1cGVyQ3RvcikgewogICAgICBjdG9yLnN1cGVyXyA9IHN1cGVyQ3RvcgogICAgICBjdG9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDdG9yLnByb3RvdHlwZSwgewogICAgICAgIGNvbnN0cnVjdG9yOiB7CiAgICAgICAgICB2YWx1ZTogY3RvciwKICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKICB9IGVsc2UgewogICAgLy8gb2xkIHNjaG9vbCBzaGltIGZvciBvbGQgYnJvd3NlcnMKICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gaW5oZXJpdHMoY3Rvciwgc3VwZXJDdG9yKSB7CiAgICAgIGN0b3Iuc3VwZXJfID0gc3VwZXJDdG9yCiAgICAgIHZhciBUZW1wQ3RvciA9IGZ1bmN0aW9uICgpIHt9CiAgICAgIFRlbXBDdG9yLnByb3RvdHlwZSA9IHN1cGVyQ3Rvci5wcm90b3R5cGUKICAgICAgY3Rvci5wcm90b3R5cGUgPSBuZXcgVGVtcEN0b3IoKQogICAgICBjdG9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGN0b3IKICAgIH0KICB9CiAgCiAgfSx7fV0sOTY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gaXNCdWZmZXIoYXJnKSB7CiAgICByZXR1cm4gYXJnICYmIHR5cGVvZiBhcmcgPT09ICdvYmplY3QnCiAgICAgICYmIHR5cGVvZiBhcmcuY29weSA9PT0gJ2Z1bmN0aW9uJwogICAgICAmJiB0eXBlb2YgYXJnLmZpbGwgPT09ICdmdW5jdGlvbicKICAgICAgJiYgdHlwZW9mIGFyZy5yZWFkVUludDggPT09ICdmdW5jdGlvbic7CiAgfQogIH0se31dLDk3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKHByb2Nlc3MsZ2xvYmFsKXsoZnVuY3Rpb24gKCl7CiAgLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCiAgLy8KICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQogIC8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKICAvLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCiAgLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAogIC8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKICAvLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKICAvLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAvLwogIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCiAgLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgLy8KICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwogIC8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICAvLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCiAgLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCiAgLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCiAgLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQogIC8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiAgCiAgdmFyIGZvcm1hdFJlZ0V4cCA9IC8lW3NkaiVdL2c7CiAgZXhwb3J0cy5mb3JtYXQgPSBmdW5jdGlvbihmKSB7CiAgICBpZiAoIWlzU3RyaW5nKGYpKSB7CiAgICAgIHZhciBvYmplY3RzID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgb2JqZWN0cy5wdXNoKGluc3BlY3QoYXJndW1lbnRzW2ldKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIG9iamVjdHMuam9pbignICcpOwogICAgfQogIAogICAgdmFyIGkgPSAxOwogICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICB2YXIgbGVuID0gYXJncy5sZW5ndGg7CiAgICB2YXIgc3RyID0gU3RyaW5nKGYpLnJlcGxhY2UoZm9ybWF0UmVnRXhwLCBmdW5jdGlvbih4KSB7CiAgICAgIGlmICh4ID09PSAnJSUnKSByZXR1cm4gJyUnOwogICAgICBpZiAoaSA+PSBsZW4pIHJldHVybiB4OwogICAgICBzd2l0Y2ggKHgpIHsKICAgICAgICBjYXNlICclcyc6IHJldHVybiBTdHJpbmcoYXJnc1tpKytdKTsKICAgICAgICBjYXNlICclZCc6IHJldHVybiBOdW1iZXIoYXJnc1tpKytdKTsKICAgICAgICBjYXNlICclaic6CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoYXJnc1tpKytdKTsKICAgICAgICAgIH0gY2F0Y2ggKF8pIHsKICAgICAgICAgICAgcmV0dXJuICdbQ2lyY3VsYXJdJzsKICAgICAgICAgIH0KICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIHg7CiAgICAgIH0KICAgIH0pOwogICAgZm9yICh2YXIgeCA9IGFyZ3NbaV07IGkgPCBsZW47IHggPSBhcmdzWysraV0pIHsKICAgICAgaWYgKGlzTnVsbCh4KSB8fCAhaXNPYmplY3QoeCkpIHsKICAgICAgICBzdHIgKz0gJyAnICsgeDsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdHIgKz0gJyAnICsgaW5zcGVjdCh4KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHN0cjsKICB9OwogIAogIAogIC8vIE1hcmsgdGhhdCBhIG1ldGhvZCBzaG91bGQgbm90IGJlIHVzZWQuCiAgLy8gUmV0dXJucyBhIG1vZGlmaWVkIGZ1bmN0aW9uIHdoaWNoIHdhcm5zIG9uY2UgYnkgZGVmYXVsdC4KICAvLyBJZiAtLW5vLWRlcHJlY2F0aW9uIGlzIHNldCwgdGhlbiBpdCBpcyBhIG5vLW9wLgogIGV4cG9ydHMuZGVwcmVjYXRlID0gZnVuY3Rpb24oZm4sIG1zZykgewogICAgLy8gQWxsb3cgZm9yIGRlcHJlY2F0aW5nIHRoaW5ncyBpbiB0aGUgcHJvY2VzcyBvZiBzdGFydGluZyB1cC4KICAgIGlmIChpc1VuZGVmaW5lZChnbG9iYWwucHJvY2VzcykpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBleHBvcnRzLmRlcHJlY2F0ZShmbiwgbXNnKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQogIAogICAgaWYgKHByb2Nlc3Mubm9EZXByZWNhdGlvbiA9PT0gdHJ1ZSkgewogICAgICByZXR1cm4gZm47CiAgICB9CiAgCiAgICB2YXIgd2FybmVkID0gZmFsc2U7CiAgICBmdW5jdGlvbiBkZXByZWNhdGVkKCkgewogICAgICBpZiAoIXdhcm5lZCkgewogICAgICAgIGlmIChwcm9jZXNzLnRocm93RGVwcmVjYXRpb24pIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihtc2cpOwogICAgICAgIH0gZWxzZSBpZiAocHJvY2Vzcy50cmFjZURlcHJlY2F0aW9uKSB7CiAgICAgICAgICBjb25zb2xlLnRyYWNlKG1zZyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IobXNnKTsKICAgICAgICB9CiAgICAgICAgd2FybmVkID0gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICAKICAgIHJldHVybiBkZXByZWNhdGVkOwogIH07CiAgCiAgCiAgdmFyIGRlYnVncyA9IHt9OwogIHZhciBkZWJ1Z0Vudmlyb247CiAgZXhwb3J0cy5kZWJ1Z2xvZyA9IGZ1bmN0aW9uKHNldCkgewogICAgaWYgKGlzVW5kZWZpbmVkKGRlYnVnRW52aXJvbikpCiAgICAgIGRlYnVnRW52aXJvbiA9IHByb2Nlc3MuZW52Lk5PREVfREVCVUcgfHwgJyc7CiAgICBzZXQgPSBzZXQudG9VcHBlckNhc2UoKTsKICAgIGlmICghZGVidWdzW3NldF0pIHsKICAgICAgaWYgKG5ldyBSZWdFeHAoJ1xcYicgKyBzZXQgKyAnXFxiJywgJ2knKS50ZXN0KGRlYnVnRW52aXJvbikpIHsKICAgICAgICB2YXIgcGlkID0gcHJvY2Vzcy5waWQ7CiAgICAgICAgZGVidWdzW3NldF0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBtc2cgPSBleHBvcnRzLmZvcm1hdC5hcHBseShleHBvcnRzLCBhcmd1bWVudHMpOwogICAgICAgICAgY29uc29sZS5lcnJvcignJXMgJWQ6ICVzJywgc2V0LCBwaWQsIG1zZyk7CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkZWJ1Z3Nbc2V0XSA9IGZ1bmN0aW9uKCkge307CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBkZWJ1Z3Nbc2V0XTsKICB9OwogIAogIAogIC8qKgogICAqIEVjaG9zIHRoZSB2YWx1ZSBvZiBhIHZhbHVlLiBUcnlzIHRvIHByaW50IHRoZSB2YWx1ZSBvdXQKICAgKiBpbiB0aGUgYmVzdCB3YXkgcG9zc2libGUgZ2l2ZW4gdGhlIGRpZmZlcmVudCB0eXBlcy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmogVGhlIG9iamVjdCB0byBwcmludCBvdXQuCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdHMgT3B0aW9uYWwgb3B0aW9ucyBvYmplY3QgdGhhdCBhbHRlcnMgdGhlIG91dHB1dC4KICAgKi8KICAvKiBsZWdhY3k6IG9iaiwgc2hvd0hpZGRlbiwgZGVwdGgsIGNvbG9ycyovCiAgZnVuY3Rpb24gaW5zcGVjdChvYmosIG9wdHMpIHsKICAgIC8vIGRlZmF1bHQgb3B0aW9ucwogICAgdmFyIGN0eCA9IHsKICAgICAgc2VlbjogW10sCiAgICAgIHN0eWxpemU6IHN0eWxpemVOb0NvbG9yCiAgICB9OwogICAgLy8gbGVnYWN5Li4uCiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+PSAzKSBjdHguZGVwdGggPSBhcmd1bWVudHNbMl07CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+PSA0KSBjdHguY29sb3JzID0gYXJndW1lbnRzWzNdOwogICAgaWYgKGlzQm9vbGVhbihvcHRzKSkgewogICAgICAvLyBsZWdhY3kuLi4KICAgICAgY3R4LnNob3dIaWRkZW4gPSBvcHRzOwogICAgfSBlbHNlIGlmIChvcHRzKSB7CiAgICAgIC8vIGdvdCBhbiAib3B0aW9ucyIgb2JqZWN0CiAgICAgIGV4cG9ydHMuX2V4dGVuZChjdHgsIG9wdHMpOwogICAgfQogICAgLy8gc2V0IGRlZmF1bHQgb3B0aW9ucwogICAgaWYgKGlzVW5kZWZpbmVkKGN0eC5zaG93SGlkZGVuKSkgY3R4LnNob3dIaWRkZW4gPSBmYWxzZTsKICAgIGlmIChpc1VuZGVmaW5lZChjdHguZGVwdGgpKSBjdHguZGVwdGggPSAyOwogICAgaWYgKGlzVW5kZWZpbmVkKGN0eC5jb2xvcnMpKSBjdHguY29sb3JzID0gZmFsc2U7CiAgICBpZiAoaXNVbmRlZmluZWQoY3R4LmN1c3RvbUluc3BlY3QpKSBjdHguY3VzdG9tSW5zcGVjdCA9IHRydWU7CiAgICBpZiAoY3R4LmNvbG9ycykgY3R4LnN0eWxpemUgPSBzdHlsaXplV2l0aENvbG9yOwogICAgcmV0dXJuIGZvcm1hdFZhbHVlKGN0eCwgb2JqLCBjdHguZGVwdGgpOwogIH0KICBleHBvcnRzLmluc3BlY3QgPSBpbnNwZWN0OwogIAogIAogIC8vIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQU5TSV9lc2NhcGVfY29kZSNncmFwaGljcwogIGluc3BlY3QuY29sb3JzID0gewogICAgJ2JvbGQnIDogWzEsIDIyXSwKICAgICdpdGFsaWMnIDogWzMsIDIzXSwKICAgICd1bmRlcmxpbmUnIDogWzQsIDI0XSwKICAgICdpbnZlcnNlJyA6IFs3LCAyN10sCiAgICAnd2hpdGUnIDogWzM3LCAzOV0sCiAgICAnZ3JleScgOiBbOTAsIDM5XSwKICAgICdibGFjaycgOiBbMzAsIDM5XSwKICAgICdibHVlJyA6IFszNCwgMzldLAogICAgJ2N5YW4nIDogWzM2LCAzOV0sCiAgICAnZ3JlZW4nIDogWzMyLCAzOV0sCiAgICAnbWFnZW50YScgOiBbMzUsIDM5XSwKICAgICdyZWQnIDogWzMxLCAzOV0sCiAgICAneWVsbG93JyA6IFszMywgMzldCiAgfTsKICAKICAvLyBEb24ndCB1c2UgJ2JsdWUnIG5vdCB2aXNpYmxlIG9uIGNtZC5leGUKICBpbnNwZWN0LnN0eWxlcyA9IHsKICAgICdzcGVjaWFsJzogJ2N5YW4nLAogICAgJ251bWJlcic6ICd5ZWxsb3cnLAogICAgJ2Jvb2xlYW4nOiAneWVsbG93JywKICAgICd1bmRlZmluZWQnOiAnZ3JleScsCiAgICAnbnVsbCc6ICdib2xkJywKICAgICdzdHJpbmcnOiAnZ3JlZW4nLAogICAgJ2RhdGUnOiAnbWFnZW50YScsCiAgICAvLyAibmFtZSI6IGludGVudGlvbmFsbHkgbm90IHN0eWxpbmcKICAgICdyZWdleHAnOiAncmVkJwogIH07CiAgCiAgCiAgZnVuY3Rpb24gc3R5bGl6ZVdpdGhDb2xvcihzdHIsIHN0eWxlVHlwZSkgewogICAgdmFyIHN0eWxlID0gaW5zcGVjdC5zdHlsZXNbc3R5bGVUeXBlXTsKICAKICAgIGlmIChzdHlsZSkgewogICAgICByZXR1cm4gJ1x1MDAxYlsnICsgaW5zcGVjdC5jb2xvcnNbc3R5bGVdWzBdICsgJ20nICsgc3RyICsKICAgICAgICAgICAgICdcdTAwMWJbJyArIGluc3BlY3QuY29sb3JzW3N0eWxlXVsxXSArICdtJzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBzdHI7CiAgICB9CiAgfQogIAogIAogIGZ1bmN0aW9uIHN0eWxpemVOb0NvbG9yKHN0ciwgc3R5bGVUeXBlKSB7CiAgICByZXR1cm4gc3RyOwogIH0KICAKICAKICBmdW5jdGlvbiBhcnJheVRvSGFzaChhcnJheSkgewogICAgdmFyIGhhc2ggPSB7fTsKICAKICAgIGFycmF5LmZvckVhY2goZnVuY3Rpb24odmFsLCBpZHgpIHsKICAgICAgaGFzaFt2YWxdID0gdHJ1ZTsKICAgIH0pOwogIAogICAgcmV0dXJuIGhhc2g7CiAgfQogIAogIAogIGZ1bmN0aW9uIGZvcm1hdFZhbHVlKGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcykgewogICAgLy8gUHJvdmlkZSBhIGhvb2sgZm9yIHVzZXItc3BlY2lmaWVkIGluc3BlY3QgZnVuY3Rpb25zLgogICAgLy8gQ2hlY2sgdGhhdCB2YWx1ZSBpcyBhbiBvYmplY3Qgd2l0aCBhbiBpbnNwZWN0IGZ1bmN0aW9uIG9uIGl0CiAgICBpZiAoY3R4LmN1c3RvbUluc3BlY3QgJiYKICAgICAgICB2YWx1ZSAmJgogICAgICAgIGlzRnVuY3Rpb24odmFsdWUuaW5zcGVjdCkgJiYKICAgICAgICAvLyBGaWx0ZXIgb3V0IHRoZSB1dGlsIG1vZHVsZSwgaXQncyBpbnNwZWN0IGZ1bmN0aW9uIGlzIHNwZWNpYWwKICAgICAgICB2YWx1ZS5pbnNwZWN0ICE9PSBleHBvcnRzLmluc3BlY3QgJiYKICAgICAgICAvLyBBbHNvIGZpbHRlciBvdXQgYW55IHByb3RvdHlwZSBvYmplY3RzIHVzaW5nIHRoZSBjaXJjdWxhciBjaGVjay4KICAgICAgICAhKHZhbHVlLmNvbnN0cnVjdG9yICYmIHZhbHVlLmNvbnN0cnVjdG9yLnByb3RvdHlwZSA9PT0gdmFsdWUpKSB7CiAgICAgIHZhciByZXQgPSB2YWx1ZS5pbnNwZWN0KHJlY3Vyc2VUaW1lcywgY3R4KTsKICAgICAgaWYgKCFpc1N0cmluZyhyZXQpKSB7CiAgICAgICAgcmV0ID0gZm9ybWF0VmFsdWUoY3R4LCByZXQsIHJlY3Vyc2VUaW1lcyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJldDsKICAgIH0KICAKICAgIC8vIFByaW1pdGl2ZSB0eXBlcyBjYW5ub3QgaGF2ZSBwcm9wZXJ0aWVzCiAgICB2YXIgcHJpbWl0aXZlID0gZm9ybWF0UHJpbWl0aXZlKGN0eCwgdmFsdWUpOwogICAgaWYgKHByaW1pdGl2ZSkgewogICAgICByZXR1cm4gcHJpbWl0aXZlOwogICAgfQogIAogICAgLy8gTG9vayB1cCB0aGUga2V5cyBvZiB0aGUgb2JqZWN0LgogICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7CiAgICB2YXIgdmlzaWJsZUtleXMgPSBhcnJheVRvSGFzaChrZXlzKTsKICAKICAgIGlmIChjdHguc2hvd0hpZGRlbikgewogICAgICBrZXlzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXModmFsdWUpOwogICAgfQogIAogICAgLy8gSUUgZG9lc24ndCBtYWtlIGVycm9yIGZpZWxkcyBub24tZW51bWVyYWJsZQogICAgLy8gaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L2llL2R3dzUyc2J0KHY9dnMuOTQpLmFzcHgKICAgIGlmIChpc0Vycm9yKHZhbHVlKQogICAgICAgICYmIChrZXlzLmluZGV4T2YoJ21lc3NhZ2UnKSA+PSAwIHx8IGtleXMuaW5kZXhPZignZGVzY3JpcHRpb24nKSA+PSAwKSkgewogICAgICByZXR1cm4gZm9ybWF0RXJyb3IodmFsdWUpOwogICAgfQogIAogICAgLy8gU29tZSB0eXBlIG9mIG9iamVjdCB3aXRob3V0IHByb3BlcnRpZXMgY2FuIGJlIHNob3J0Y3V0dGVkLgogICAgaWYgKGtleXMubGVuZ3RoID09PSAwKSB7CiAgICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgIHZhciBuYW1lID0gdmFsdWUubmFtZSA/ICc6ICcgKyB2YWx1ZS5uYW1lIDogJyc7CiAgICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKCdbRnVuY3Rpb24nICsgbmFtZSArICddJywgJ3NwZWNpYWwnKTsKICAgICAgfQogICAgICBpZiAoaXNSZWdFeHAodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKFJlZ0V4cC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSksICdyZWdleHAnKTsKICAgICAgfQogICAgICBpZiAoaXNEYXRlKHZhbHVlKSkgewogICAgICAgIHJldHVybiBjdHguc3R5bGl6ZShEYXRlLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSwgJ2RhdGUnKTsKICAgICAgfQogICAgICBpZiAoaXNFcnJvcih2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gZm9ybWF0RXJyb3IodmFsdWUpOwogICAgICB9CiAgICB9CiAgCiAgICB2YXIgYmFzZSA9ICcnLCBhcnJheSA9IGZhbHNlLCBicmFjZXMgPSBbJ3snLCAnfSddOwogIAogICAgLy8gTWFrZSBBcnJheSBzYXkgdGhhdCB0aGV5IGFyZSBBcnJheQogICAgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgIGFycmF5ID0gdHJ1ZTsKICAgICAgYnJhY2VzID0gWydbJywgJ10nXTsKICAgIH0KICAKICAgIC8vIE1ha2UgZnVuY3Rpb25zIHNheSB0aGF0IHRoZXkgYXJlIGZ1bmN0aW9ucwogICAgaWYgKGlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgIHZhciBuID0gdmFsdWUubmFtZSA/ICc6ICcgKyB2YWx1ZS5uYW1lIDogJyc7CiAgICAgIGJhc2UgPSAnIFtGdW5jdGlvbicgKyBuICsgJ10nOwogICAgfQogIAogICAgLy8gTWFrZSBSZWdFeHBzIHNheSB0aGF0IHRoZXkgYXJlIFJlZ0V4cHMKICAgIGlmIChpc1JlZ0V4cCh2YWx1ZSkpIHsKICAgICAgYmFzZSA9ICcgJyArIFJlZ0V4cC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSk7CiAgICB9CiAgCiAgICAvLyBNYWtlIGRhdGVzIHdpdGggcHJvcGVydGllcyBmaXJzdCBzYXkgdGhlIGRhdGUKICAgIGlmIChpc0RhdGUodmFsdWUpKSB7CiAgICAgIGJhc2UgPSAnICcgKyBEYXRlLnByb3RvdHlwZS50b1VUQ1N0cmluZy5jYWxsKHZhbHVlKTsKICAgIH0KICAKICAgIC8vIE1ha2UgZXJyb3Igd2l0aCBtZXNzYWdlIGZpcnN0IHNheSB0aGUgZXJyb3IKICAgIGlmIChpc0Vycm9yKHZhbHVlKSkgewogICAgICBiYXNlID0gJyAnICsgZm9ybWF0RXJyb3IodmFsdWUpOwogICAgfQogIAogICAgaWYgKGtleXMubGVuZ3RoID09PSAwICYmICghYXJyYXkgfHwgdmFsdWUubGVuZ3RoID09IDApKSB7CiAgICAgIHJldHVybiBicmFjZXNbMF0gKyBiYXNlICsgYnJhY2VzWzFdOwogICAgfQogIAogICAgaWYgKHJlY3Vyc2VUaW1lcyA8IDApIHsKICAgICAgaWYgKGlzUmVnRXhwKHZhbHVlKSkgewogICAgICAgIHJldHVybiBjdHguc3R5bGl6ZShSZWdFeHAucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpLCAncmVnZXhwJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKCdbT2JqZWN0XScsICdzcGVjaWFsJyk7CiAgICAgIH0KICAgIH0KICAKICAgIGN0eC5zZWVuLnB1c2godmFsdWUpOwogIAogICAgdmFyIG91dHB1dDsKICAgIGlmIChhcnJheSkgewogICAgICBvdXRwdXQgPSBmb3JtYXRBcnJheShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLCBrZXlzKTsKICAgIH0gZWxzZSB7CiAgICAgIG91dHB1dCA9IGtleXMubWFwKGZ1bmN0aW9uKGtleSkgewogICAgICAgIHJldHVybiBmb3JtYXRQcm9wZXJ0eShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLCBrZXksIGFycmF5KTsKICAgICAgfSk7CiAgICB9CiAgCiAgICBjdHguc2Vlbi5wb3AoKTsKICAKICAgIHJldHVybiByZWR1Y2VUb1NpbmdsZVN0cmluZyhvdXRwdXQsIGJhc2UsIGJyYWNlcyk7CiAgfQogIAogIAogIGZ1bmN0aW9uIGZvcm1hdFByaW1pdGl2ZShjdHgsIHZhbHVlKSB7CiAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKQogICAgICByZXR1cm4gY3R4LnN0eWxpemUoJ3VuZGVmaW5lZCcsICd1bmRlZmluZWQnKTsKICAgIGlmIChpc1N0cmluZyh2YWx1ZSkpIHsKICAgICAgdmFyIHNpbXBsZSA9ICdcJycgKyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkucmVwbGFjZSgvXiJ8IiQvZywgJycpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoLycvZywgIlxcJyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcIi9nLCAnIicpICsgJ1wnJzsKICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKHNpbXBsZSwgJ3N0cmluZycpOwogICAgfQogICAgaWYgKGlzTnVtYmVyKHZhbHVlKSkKICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKCcnICsgdmFsdWUsICdudW1iZXInKTsKICAgIGlmIChpc0Jvb2xlYW4odmFsdWUpKQogICAgICByZXR1cm4gY3R4LnN0eWxpemUoJycgKyB2YWx1ZSwgJ2Jvb2xlYW4nKTsKICAgIC8vIEZvciBzb21lIHJlYXNvbiB0eXBlb2YgbnVsbCBpcyAib2JqZWN0Iiwgc28gc3BlY2lhbCBjYXNlIGhlcmUuCiAgICBpZiAoaXNOdWxsKHZhbHVlKSkKICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKCdudWxsJywgJ251bGwnKTsKICB9CiAgCiAgCiAgZnVuY3Rpb24gZm9ybWF0RXJyb3IodmFsdWUpIHsKICAgIHJldHVybiAnWycgKyBFcnJvci5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSkgKyAnXSc7CiAgfQogIAogIAogIGZ1bmN0aW9uIGZvcm1hdEFycmF5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsIGtleXMpIHsKICAgIHZhciBvdXRwdXQgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gdmFsdWUubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eSh2YWx1ZSwgU3RyaW5nKGkpKSkgewogICAgICAgIG91dHB1dC5wdXNoKGZvcm1hdFByb3BlcnR5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsCiAgICAgICAgICAgIFN0cmluZyhpKSwgdHJ1ZSkpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dHB1dC5wdXNoKCcnKTsKICAgICAgfQogICAgfQogICAga2V5cy5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgICBpZiAoIWtleS5tYXRjaCgvXlxkKyQvKSkgewogICAgICAgIG91dHB1dC5wdXNoKGZvcm1hdFByb3BlcnR5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsCiAgICAgICAgICAgIGtleSwgdHJ1ZSkpOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBvdXRwdXQ7CiAgfQogIAogIAogIGZ1bmN0aW9uIGZvcm1hdFByb3BlcnR5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsIGtleSwgYXJyYXkpIHsKICAgIHZhciBuYW1lLCBzdHIsIGRlc2M7CiAgICBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih2YWx1ZSwga2V5KSB8fCB7IHZhbHVlOiB2YWx1ZVtrZXldIH07CiAgICBpZiAoZGVzYy5nZXQpIHsKICAgICAgaWYgKGRlc2Muc2V0KSB7CiAgICAgICAgc3RyID0gY3R4LnN0eWxpemUoJ1tHZXR0ZXIvU2V0dGVyXScsICdzcGVjaWFsJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RyID0gY3R4LnN0eWxpemUoJ1tHZXR0ZXJdJywgJ3NwZWNpYWwnKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGRlc2Muc2V0KSB7CiAgICAgICAgc3RyID0gY3R4LnN0eWxpemUoJ1tTZXR0ZXJdJywgJ3NwZWNpYWwnKTsKICAgICAgfQogICAgfQogICAgaWYgKCFoYXNPd25Qcm9wZXJ0eSh2aXNpYmxlS2V5cywga2V5KSkgewogICAgICBuYW1lID0gJ1snICsga2V5ICsgJ10nOwogICAgfQogICAgaWYgKCFzdHIpIHsKICAgICAgaWYgKGN0eC5zZWVuLmluZGV4T2YoZGVzYy52YWx1ZSkgPCAwKSB7CiAgICAgICAgaWYgKGlzTnVsbChyZWN1cnNlVGltZXMpKSB7CiAgICAgICAgICBzdHIgPSBmb3JtYXRWYWx1ZShjdHgsIGRlc2MudmFsdWUsIG51bGwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdHIgPSBmb3JtYXRWYWx1ZShjdHgsIGRlc2MudmFsdWUsIHJlY3Vyc2VUaW1lcyAtIDEpOwogICAgICAgIH0KICAgICAgICBpZiAoc3RyLmluZGV4T2YoJ1xuJykgPiAtMSkgewogICAgICAgICAgaWYgKGFycmF5KSB7CiAgICAgICAgICAgIHN0ciA9IHN0ci5zcGxpdCgnXG4nKS5tYXAoZnVuY3Rpb24obGluZSkgewogICAgICAgICAgICAgIHJldHVybiAnICAnICsgbGluZTsKICAgICAgICAgICAgfSkuam9pbignXG4nKS5zdWJzdHIoMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdHIgPSAnXG4nICsgc3RyLnNwbGl0KCdcbicpLm1hcChmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICcgICAnICsgbGluZTsKICAgICAgICAgICAgfSkuam9pbignXG4nKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RyID0gY3R4LnN0eWxpemUoJ1tDaXJjdWxhcl0nLCAnc3BlY2lhbCcpOwogICAgICB9CiAgICB9CiAgICBpZiAoaXNVbmRlZmluZWQobmFtZSkpIHsKICAgICAgaWYgKGFycmF5ICYmIGtleS5tYXRjaCgvXlxkKyQvKSkgewogICAgICAgIHJldHVybiBzdHI7CiAgICAgIH0KICAgICAgbmFtZSA9IEpTT04uc3RyaW5naWZ5KCcnICsga2V5KTsKICAgICAgaWYgKG5hbWUubWF0Y2goL14iKFthLXpBLVpfXVthLXpBLVpfMC05XSopIiQvKSkgewogICAgICAgIG5hbWUgPSBuYW1lLnN1YnN0cigxLCBuYW1lLmxlbmd0aCAtIDIpOwogICAgICAgIG5hbWUgPSBjdHguc3R5bGl6ZShuYW1lLCAnbmFtZScpOwogICAgICB9IGVsc2UgewogICAgICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UoLycvZywgIlxcJyIpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFwiL2csICciJykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8oXiJ8IiQpL2csICInIik7CiAgICAgICAgbmFtZSA9IGN0eC5zdHlsaXplKG5hbWUsICdzdHJpbmcnKTsKICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIG5hbWUgKyAnOiAnICsgc3RyOwogIH0KICAKICAKICBmdW5jdGlvbiByZWR1Y2VUb1NpbmdsZVN0cmluZyhvdXRwdXQsIGJhc2UsIGJyYWNlcykgewogICAgdmFyIG51bUxpbmVzRXN0ID0gMDsKICAgIHZhciBsZW5ndGggPSBvdXRwdXQucmVkdWNlKGZ1bmN0aW9uKHByZXYsIGN1cikgewogICAgICBudW1MaW5lc0VzdCsrOwogICAgICBpZiAoY3VyLmluZGV4T2YoJ1xuJykgPj0gMCkgbnVtTGluZXNFc3QrKzsKICAgICAgcmV0dXJuIHByZXYgKyBjdXIucmVwbGFjZSgvXHUwMDFiXFtcZFxkP20vZywgJycpLmxlbmd0aCArIDE7CiAgICB9LCAwKTsKICAKICAgIGlmIChsZW5ndGggPiA2MCkgewogICAgICByZXR1cm4gYnJhY2VzWzBdICsKICAgICAgICAgICAgIChiYXNlID09PSAnJyA/ICcnIDogYmFzZSArICdcbiAnKSArCiAgICAgICAgICAgICAnICcgKwogICAgICAgICAgICAgb3V0cHV0LmpvaW4oJyxcbiAgJykgKwogICAgICAgICAgICAgJyAnICsKICAgICAgICAgICAgIGJyYWNlc1sxXTsKICAgIH0KICAKICAgIHJldHVybiBicmFjZXNbMF0gKyBiYXNlICsgJyAnICsgb3V0cHV0LmpvaW4oJywgJykgKyAnICcgKyBicmFjZXNbMV07CiAgfQogIAogIAogIC8vIE5PVEU6IFRoZXNlIHR5cGUgY2hlY2tpbmcgZnVuY3Rpb25zIGludGVudGlvbmFsbHkgZG9uJ3QgdXNlIGBpbnN0YW5jZW9mYAogIC8vIGJlY2F1c2UgaXQgaXMgZnJhZ2lsZSBhbmQgY2FuIGJlIGVhc2lseSBmYWtlZCB3aXRoIGBPYmplY3QuY3JlYXRlKClgLgogIGZ1bmN0aW9uIGlzQXJyYXkoYXIpIHsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KGFyKTsKICB9CiAgZXhwb3J0cy5pc0FycmF5ID0gaXNBcnJheTsKICAKICBmdW5jdGlvbiBpc0Jvb2xlYW4oYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ2Jvb2xlYW4nOwogIH0KICBleHBvcnRzLmlzQm9vbGVhbiA9IGlzQm9vbGVhbjsKICAKICBmdW5jdGlvbiBpc051bGwoYXJnKSB7CiAgICByZXR1cm4gYXJnID09PSBudWxsOwogIH0KICBleHBvcnRzLmlzTnVsbCA9IGlzTnVsbDsKICAKICBmdW5jdGlvbiBpc051bGxPclVuZGVmaW5lZChhcmcpIHsKICAgIHJldHVybiBhcmcgPT0gbnVsbDsKICB9CiAgZXhwb3J0cy5pc051bGxPclVuZGVmaW5lZCA9IGlzTnVsbE9yVW5kZWZpbmVkOwogIAogIGZ1bmN0aW9uIGlzTnVtYmVyKGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdudW1iZXInOwogIH0KICBleHBvcnRzLmlzTnVtYmVyID0gaXNOdW1iZXI7CiAgCiAgZnVuY3Rpb24gaXNTdHJpbmcoYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ3N0cmluZyc7CiAgfQogIGV4cG9ydHMuaXNTdHJpbmcgPSBpc1N0cmluZzsKICAKICBmdW5jdGlvbiBpc1N5bWJvbChhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnc3ltYm9sJzsKICB9CiAgZXhwb3J0cy5pc1N5bWJvbCA9IGlzU3ltYm9sOwogIAogIGZ1bmN0aW9uIGlzVW5kZWZpbmVkKGFyZykgewogICAgcmV0dXJuIGFyZyA9PT0gdm9pZCAwOwogIH0KICBleHBvcnRzLmlzVW5kZWZpbmVkID0gaXNVbmRlZmluZWQ7CiAgCiAgZnVuY3Rpb24gaXNSZWdFeHAocmUpIHsKICAgIHJldHVybiBpc09iamVjdChyZSkgJiYgb2JqZWN0VG9TdHJpbmcocmUpID09PSAnW29iamVjdCBSZWdFeHBdJzsKICB9CiAgZXhwb3J0cy5pc1JlZ0V4cCA9IGlzUmVnRXhwOwogIAogIGZ1bmN0aW9uIGlzT2JqZWN0KGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdvYmplY3QnICYmIGFyZyAhPT0gbnVsbDsKICB9CiAgZXhwb3J0cy5pc09iamVjdCA9IGlzT2JqZWN0OwogIAogIGZ1bmN0aW9uIGlzRGF0ZShkKSB7CiAgICByZXR1cm4gaXNPYmplY3QoZCkgJiYgb2JqZWN0VG9TdHJpbmcoZCkgPT09ICdbb2JqZWN0IERhdGVdJzsKICB9CiAgZXhwb3J0cy5pc0RhdGUgPSBpc0RhdGU7CiAgCiAgZnVuY3Rpb24gaXNFcnJvcihlKSB7CiAgICByZXR1cm4gaXNPYmplY3QoZSkgJiYKICAgICAgICAob2JqZWN0VG9TdHJpbmcoZSkgPT09ICdbb2JqZWN0IEVycm9yXScgfHwgZSBpbnN0YW5jZW9mIEVycm9yKTsKICB9CiAgZXhwb3J0cy5pc0Vycm9yID0gaXNFcnJvcjsKICAKICBmdW5jdGlvbiBpc0Z1bmN0aW9uKGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdmdW5jdGlvbic7CiAgfQogIGV4cG9ydHMuaXNGdW5jdGlvbiA9IGlzRnVuY3Rpb247CiAgCiAgZnVuY3Rpb24gaXNQcmltaXRpdmUoYXJnKSB7CiAgICByZXR1cm4gYXJnID09PSBudWxsIHx8CiAgICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ2Jvb2xlYW4nIHx8CiAgICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ251bWJlcicgfHwKICAgICAgICAgICB0eXBlb2YgYXJnID09PSAnc3RyaW5nJyB8fAogICAgICAgICAgIHR5cGVvZiBhcmcgPT09ICdzeW1ib2wnIHx8ICAvLyBFUzYgc3ltYm9sCiAgICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ3VuZGVmaW5lZCc7CiAgfQogIGV4cG9ydHMuaXNQcmltaXRpdmUgPSBpc1ByaW1pdGl2ZTsKICAKICBleHBvcnRzLmlzQnVmZmVyID0gcmVxdWlyZSgnLi9zdXBwb3J0L2lzQnVmZmVyJyk7CiAgCiAgZnVuY3Rpb24gb2JqZWN0VG9TdHJpbmcobykgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvKTsKICB9CiAgCiAgCiAgZnVuY3Rpb24gcGFkKG4pIHsKICAgIHJldHVybiBuIDwgMTAgPyAnMCcgKyBuLnRvU3RyaW5nKDEwKSA6IG4udG9TdHJpbmcoMTApOwogIH0KICAKICAKICB2YXIgbW9udGhzID0gWydKYW4nLCAnRmViJywgJ01hcicsICdBcHInLCAnTWF5JywgJ0p1bicsICdKdWwnLCAnQXVnJywgJ1NlcCcsCiAgICAgICAgICAgICAgICAnT2N0JywgJ05vdicsICdEZWMnXTsKICAKICAvLyAyNiBGZWIgMTY6MTk6MzQKICBmdW5jdGlvbiB0aW1lc3RhbXAoKSB7CiAgICB2YXIgZCA9IG5ldyBEYXRlKCk7CiAgICB2YXIgdGltZSA9IFtwYWQoZC5nZXRIb3VycygpKSwKICAgICAgICAgICAgICAgIHBhZChkLmdldE1pbnV0ZXMoKSksCiAgICAgICAgICAgICAgICBwYWQoZC5nZXRTZWNvbmRzKCkpXS5qb2luKCc6Jyk7CiAgICByZXR1cm4gW2QuZ2V0RGF0ZSgpLCBtb250aHNbZC5nZXRNb250aCgpXSwgdGltZV0uam9pbignICcpOwogIH0KICAKICAKICAvLyBsb2cgaXMganVzdCBhIHRoaW4gd3JhcHBlciB0byBjb25zb2xlLmxvZyB0aGF0IHByZXBlbmRzIGEgdGltZXN0YW1wCiAgZXhwb3J0cy5sb2cgPSBmdW5jdGlvbigpIHsKICAgIGNvbnNvbGUubG9nKCclcyAtICVzJywgdGltZXN0YW1wKCksIGV4cG9ydHMuZm9ybWF0LmFwcGx5KGV4cG9ydHMsIGFyZ3VtZW50cykpOwogIH07CiAgCiAgCiAgLyoqCiAgICogSW5oZXJpdCB0aGUgcHJvdG90eXBlIG1ldGhvZHMgZnJvbSBvbmUgY29uc3RydWN0b3IgaW50byBhbm90aGVyLgogICAqCiAgICogVGhlIEZ1bmN0aW9uLnByb3RvdHlwZS5pbmhlcml0cyBmcm9tIGxhbmcuanMgcmV3cml0dGVuIGFzIGEgc3RhbmRhbG9uZQogICAqIGZ1bmN0aW9uIChub3Qgb24gRnVuY3Rpb24ucHJvdG90eXBlKS4gTk9URTogSWYgdGhpcyBmaWxlIGlzIHRvIGJlIGxvYWRlZAogICAqIGR1cmluZyBib290c3RyYXBwaW5nIHRoaXMgZnVuY3Rpb24gbmVlZHMgdG8gYmUgcmV3cml0dGVuIHVzaW5nIHNvbWUgbmF0aXZlCiAgICogZnVuY3Rpb25zIGFzIHByb3RvdHlwZSBzZXR1cCB1c2luZyBub3JtYWwgSmF2YVNjcmlwdCBkb2VzIG5vdCB3b3JrIGFzCiAgICogZXhwZWN0ZWQgZHVyaW5nIGJvb3RzdHJhcHBpbmcgKHNlZSBtaXJyb3IuanMgaW4gcjExNDkwMykuCiAgICoKICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjdG9yIENvbnN0cnVjdG9yIGZ1bmN0aW9uIHdoaWNoIG5lZWRzIHRvIGluaGVyaXQgdGhlCiAgICogICAgIHByb3RvdHlwZS4KICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBzdXBlckN0b3IgQ29uc3RydWN0b3IgZnVuY3Rpb24gdG8gaW5oZXJpdCBwcm90b3R5cGUgZnJvbS4KICAgKi8KICBleHBvcnRzLmluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKICAKICBleHBvcnRzLl9leHRlbmQgPSBmdW5jdGlvbihvcmlnaW4sIGFkZCkgewogICAgLy8gRG9uJ3QgZG8gYW55dGhpbmcgaWYgYWRkIGlzbid0IGFuIG9iamVjdAogICAgaWYgKCFhZGQgfHwgIWlzT2JqZWN0KGFkZCkpIHJldHVybiBvcmlnaW47CiAgCiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGFkZCk7CiAgICB2YXIgaSA9IGtleXMubGVuZ3RoOwogICAgd2hpbGUgKGktLSkgewogICAgICBvcmlnaW5ba2V5c1tpXV0gPSBhZGRba2V5c1tpXV07CiAgICB9CiAgICByZXR1cm4gb3JpZ2luOwogIH07CiAgCiAgZnVuY3Rpb24gaGFzT3duUHJvcGVydHkob2JqLCBwcm9wKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCk7CiAgfQogIAogIH0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSx0eXBlb2YgX193ZWJwYWNrX3JlcXVpcmVfXy5nICE9PSAidW5kZWZpbmVkIiA/IF9fd2VicGFja19yZXF1aXJlX18uZyA6IHR5cGVvZiBzZWxmICE9PSAidW5kZWZpbmVkIiA/IHNlbGYgOiB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiA/IHdpbmRvdyA6IHt9KQogIH0seyIuL3N1cHBvcnQvaXNCdWZmZXIiOjk2LCJfcHJvY2VzcyI6ODYsImluaGVyaXRzIjo5NX1dLDk4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdjEgPSByZXF1aXJlKCcuL3YxJyk7CiAgdmFyIHY0ID0gcmVxdWlyZSgnLi92NCcpOwogIAogIHZhciB1dWlkID0gdjQ7CiAgdXVpZC52MSA9IHYxOwogIHV1aWQudjQgPSB2NDsKICAKICBtb2R1bGUuZXhwb3J0cyA9IHV1aWQ7CiAgCiAgfSx7Ii4vdjEiOjEwMSwiLi92NCI6MTAyfV0sOTk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8qKgogICAqIENvbnZlcnQgYXJyYXkgb2YgMTYgYnl0ZSB2YWx1ZXMgdG8gVVVJRCBzdHJpbmcgZm9ybWF0IG9mIHRoZSBmb3JtOgogICAqIFhYWFhYWFhYLVhYWFgtWFhYWC1YWFhYLVhYWFhYWFhYWFhYWAogICAqLwogIHZhciBieXRlVG9IZXggPSBbXTsKICBmb3IgKHZhciBpID0gMDsgaSA8IDI1NjsgKytpKSB7CiAgICBieXRlVG9IZXhbaV0gPSAoaSArIDB4MTAwKS50b1N0cmluZygxNikuc3Vic3RyKDEpOwogIH0KICAKICBmdW5jdGlvbiBieXRlc1RvVXVpZChidWYsIG9mZnNldCkgewogICAgdmFyIGkgPSBvZmZzZXQgfHwgMDsKICAgIHZhciBidGggPSBieXRlVG9IZXg7CiAgICAvLyBqb2luIHVzZWQgdG8gZml4IG1lbW9yeSBpc3N1ZSBjYXVzZWQgYnkgY29uY2F0ZW5hdGlvbjogaHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL3Y4L2lzc3Vlcy9kZXRhaWw/aWQ9MzE3NSNjNAogICAgcmV0dXJuIChbYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgCiAgICBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLCAnLScsCiAgICBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLCAnLScsCiAgICBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLCAnLScsCiAgICBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLCAnLScsCiAgICBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwKICAgIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV1dKS5qb2luKCcnKTsKICB9CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSBieXRlc1RvVXVpZDsKICAKICB9LHt9XSwxMDA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIFVuaXF1ZSBJRCBjcmVhdGlvbiByZXF1aXJlcyBhIGhpZ2ggcXVhbGl0eSByYW5kb20gIyBnZW5lcmF0b3IuICBJbiB0aGUKICAvLyBicm93c2VyIHRoaXMgaXMgYSBsaXR0bGUgY29tcGxpY2F0ZWQgZHVlIHRvIHVua25vd24gcXVhbGl0eSBvZiBNYXRoLnJhbmRvbSgpCiAgLy8gYW5kIGluY29uc2lzdGVudCBzdXBwb3J0IGZvciB0aGUgYGNyeXB0b2AgQVBJLiAgV2UgZG8gdGhlIGJlc3Qgd2UgY2FuIHZpYQogIC8vIGZlYXR1cmUtZGV0ZWN0aW9uCiAgCiAgLy8gZ2V0UmFuZG9tVmFsdWVzIG5lZWRzIHRvIGJlIGludm9rZWQgaW4gYSBjb250ZXh0IHdoZXJlICJ0aGlzIiBpcyBhIENyeXB0bwogIC8vIGltcGxlbWVudGF0aW9uLiBBbHNvLCBmaW5kIHRoZSBjb21wbGV0ZSBpbXBsZW1lbnRhdGlvbiBvZiBjcnlwdG8gb24gSUUxMS4KICB2YXIgZ2V0UmFuZG9tVmFsdWVzID0gKHR5cGVvZihjcnlwdG8pICE9ICd1bmRlZmluZWQnICYmIGNyeXB0by5nZXRSYW5kb21WYWx1ZXMgJiYgY3J5cHRvLmdldFJhbmRvbVZhbHVlcy5iaW5kKGNyeXB0bykpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICh0eXBlb2YobXNDcnlwdG8pICE9ICd1bmRlZmluZWQnICYmIHR5cGVvZiB3aW5kb3cubXNDcnlwdG8uZ2V0UmFuZG9tVmFsdWVzID09ICdmdW5jdGlvbicgJiYgbXNDcnlwdG8uZ2V0UmFuZG9tVmFsdWVzLmJpbmQobXNDcnlwdG8pKTsKICAKICBpZiAoZ2V0UmFuZG9tVmFsdWVzKSB7CiAgICAvLyBXSEFUV0cgY3J5cHRvIFJORyAtIGh0dHA6Ly93aWtpLndoYXR3Zy5vcmcvd2lraS9DcnlwdG8KICAgIHZhciBybmRzOCA9IG5ldyBVaW50OEFycmF5KDE2KTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby11bmRlZgogIAogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiB3aGF0d2dSTkcoKSB7CiAgICAgIGdldFJhbmRvbVZhbHVlcyhybmRzOCk7CiAgICAgIHJldHVybiBybmRzODsKICAgIH07CiAgfSBlbHNlIHsKICAgIC8vIE1hdGgucmFuZG9tKCktYmFzZWQgKFJORykKICAgIC8vCiAgICAvLyBJZiBhbGwgZWxzZSBmYWlscywgdXNlIE1hdGgucmFuZG9tKCkuICBJdCdzIGZhc3QsIGJ1dCBpcyBvZiB1bnNwZWNpZmllZAogICAgLy8gcXVhbGl0eS4KICAgIHZhciBybmRzID0gbmV3IEFycmF5KDE2KTsKICAKICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gbWF0aFJORygpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIHI7IGkgPCAxNjsgaSsrKSB7CiAgICAgICAgaWYgKChpICYgMHgwMykgPT09IDApIHIgPSBNYXRoLnJhbmRvbSgpICogMHgxMDAwMDAwMDA7CiAgICAgICAgcm5kc1tpXSA9IHIgPj4+ICgoaSAmIDB4MDMpIDw8IDMpICYgMHhmZjsKICAgICAgfQogIAogICAgICByZXR1cm4gcm5kczsKICAgIH07CiAgfQogIAogIH0se31dLDEwMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHJuZyA9IHJlcXVpcmUoJy4vbGliL3JuZycpOwogIHZhciBieXRlc1RvVXVpZCA9IHJlcXVpcmUoJy4vbGliL2J5dGVzVG9VdWlkJyk7CiAgCiAgLy8gKipgdjEoKWAgLSBHZW5lcmF0ZSB0aW1lLWJhc2VkIFVVSUQqKgogIC8vCiAgLy8gSW5zcGlyZWQgYnkgaHR0cHM6Ly9naXRodWIuY29tL0xpb3NLL1VVSUQuanMKICAvLyBhbmQgaHR0cDovL2RvY3MucHl0aG9uLm9yZy9saWJyYXJ5L3V1aWQuaHRtbAogIAogIHZhciBfbm9kZUlkOwogIHZhciBfY2xvY2tzZXE7CiAgCiAgLy8gUHJldmlvdXMgdXVpZCBjcmVhdGlvbiB0aW1lCiAgdmFyIF9sYXN0TVNlY3MgPSAwOwogIHZhciBfbGFzdE5TZWNzID0gMDsKICAKICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2Jyb29mYS9ub2RlLXV1aWQgZm9yIEFQSSBkZXRhaWxzCiAgZnVuY3Rpb24gdjEob3B0aW9ucywgYnVmLCBvZmZzZXQpIHsKICAgIHZhciBpID0gYnVmICYmIG9mZnNldCB8fCAwOwogICAgdmFyIGIgPSBidWYgfHwgW107CiAgCiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHZhciBub2RlID0gb3B0aW9ucy5ub2RlIHx8IF9ub2RlSWQ7CiAgICB2YXIgY2xvY2tzZXEgPSBvcHRpb25zLmNsb2Nrc2VxICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNsb2Nrc2VxIDogX2Nsb2Nrc2VxOwogIAogICAgLy8gbm9kZSBhbmQgY2xvY2tzZXEgbmVlZCB0byBiZSBpbml0aWFsaXplZCB0byByYW5kb20gdmFsdWVzIGlmIHRoZXkncmUgbm90CiAgICAvLyBzcGVjaWZpZWQuICBXZSBkbyB0aGlzIGxhemlseSB0byBtaW5pbWl6ZSBpc3N1ZXMgcmVsYXRlZCB0byBpbnN1ZmZpY2llbnQKICAgIC8vIHN5c3RlbSBlbnRyb3B5LiAgU2VlICMxODkKICAgIGlmIChub2RlID09IG51bGwgfHwgY2xvY2tzZXEgPT0gbnVsbCkgewogICAgICB2YXIgc2VlZEJ5dGVzID0gcm5nKCk7CiAgICAgIGlmIChub2RlID09IG51bGwpIHsKICAgICAgICAvLyBQZXIgNC41LCBjcmVhdGUgYW5kIDQ4LWJpdCBub2RlIGlkLCAoNDcgcmFuZG9tIGJpdHMgKyBtdWx0aWNhc3QgYml0ID0gMSkKICAgICAgICBub2RlID0gX25vZGVJZCA9IFsKICAgICAgICAgIHNlZWRCeXRlc1swXSB8IDB4MDEsCiAgICAgICAgICBzZWVkQnl0ZXNbMV0sIHNlZWRCeXRlc1syXSwgc2VlZEJ5dGVzWzNdLCBzZWVkQnl0ZXNbNF0sIHNlZWRCeXRlc1s1XQogICAgICAgIF07CiAgICAgIH0KICAgICAgaWYgKGNsb2Nrc2VxID09IG51bGwpIHsKICAgICAgICAvLyBQZXIgNC4yLjIsIHJhbmRvbWl6ZSAoMTQgYml0KSBjbG9ja3NlcQogICAgICAgIGNsb2Nrc2VxID0gX2Nsb2Nrc2VxID0gKHNlZWRCeXRlc1s2XSA8PCA4IHwgc2VlZEJ5dGVzWzddKSAmIDB4M2ZmZjsKICAgICAgfQogICAgfQogIAogICAgLy8gVVVJRCB0aW1lc3RhbXBzIGFyZSAxMDAgbmFuby1zZWNvbmQgdW5pdHMgc2luY2UgdGhlIEdyZWdvcmlhbiBlcG9jaCwKICAgIC8vICgxNTgyLTEwLTE1IDAwOjAwKS4gIEpTTnVtYmVycyBhcmVuJ3QgcHJlY2lzZSBlbm91Z2ggZm9yIHRoaXMsIHNvCiAgICAvLyB0aW1lIGlzIGhhbmRsZWQgaW50ZXJuYWxseSBhcyAnbXNlY3MnIChpbnRlZ2VyIG1pbGxpc2Vjb25kcykgYW5kICduc2VjcycKICAgIC8vICgxMDAtbmFub3NlY29uZHMgb2Zmc2V0IGZyb20gbXNlY3MpIHNpbmNlIHVuaXggZXBvY2gsIDE5NzAtMDEtMDEgMDA6MDAuCiAgICB2YXIgbXNlY3MgPSBvcHRpb25zLm1zZWNzICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLm1zZWNzIDogbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgCiAgICAvLyBQZXIgNC4yLjEuMiwgdXNlIGNvdW50IG9mIHV1aWQncyBnZW5lcmF0ZWQgZHVyaW5nIHRoZSBjdXJyZW50IGNsb2NrCiAgICAvLyBjeWNsZSB0byBzaW11bGF0ZSBoaWdoZXIgcmVzb2x1dGlvbiBjbG9jawogICAgdmFyIG5zZWNzID0gb3B0aW9ucy5uc2VjcyAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5uc2VjcyA6IF9sYXN0TlNlY3MgKyAxOwogIAogICAgLy8gVGltZSBzaW5jZSBsYXN0IHV1aWQgY3JlYXRpb24gKGluIG1zZWNzKQogICAgdmFyIGR0ID0gKG1zZWNzIC0gX2xhc3RNU2VjcykgKyAobnNlY3MgLSBfbGFzdE5TZWNzKS8xMDAwMDsKICAKICAgIC8vIFBlciA0LjIuMS4yLCBCdW1wIGNsb2Nrc2VxIG9uIGNsb2NrIHJlZ3Jlc3Npb24KICAgIGlmIChkdCA8IDAgJiYgb3B0aW9ucy5jbG9ja3NlcSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGNsb2Nrc2VxID0gY2xvY2tzZXEgKyAxICYgMHgzZmZmOwogICAgfQogIAogICAgLy8gUmVzZXQgbnNlY3MgaWYgY2xvY2sgcmVncmVzc2VzIChuZXcgY2xvY2tzZXEpIG9yIHdlJ3ZlIG1vdmVkIG9udG8gYSBuZXcKICAgIC8vIHRpbWUgaW50ZXJ2YWwKICAgIGlmICgoZHQgPCAwIHx8IG1zZWNzID4gX2xhc3RNU2VjcykgJiYgb3B0aW9ucy5uc2VjcyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIG5zZWNzID0gMDsKICAgIH0KICAKICAgIC8vIFBlciA0LjIuMS4yIFRocm93IGVycm9yIGlmIHRvbyBtYW55IHV1aWRzIGFyZSByZXF1ZXN0ZWQKICAgIGlmIChuc2VjcyA+PSAxMDAwMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ3V1aWQudjEoKTogQ2FuXCd0IGNyZWF0ZSBtb3JlIHRoYW4gMTBNIHV1aWRzL3NlYycpOwogICAgfQogIAogICAgX2xhc3RNU2VjcyA9IG1zZWNzOwogICAgX2xhc3ROU2VjcyA9IG5zZWNzOwogICAgX2Nsb2Nrc2VxID0gY2xvY2tzZXE7CiAgCiAgICAvLyBQZXIgNC4xLjQgLSBDb252ZXJ0IGZyb20gdW5peCBlcG9jaCB0byBHcmVnb3JpYW4gZXBvY2gKICAgIG1zZWNzICs9IDEyMjE5MjkyODAwMDAwOwogIAogICAgLy8gYHRpbWVfbG93YAogICAgdmFyIHRsID0gKChtc2VjcyAmIDB4ZmZmZmZmZikgKiAxMDAwMCArIG5zZWNzKSAlIDB4MTAwMDAwMDAwOwogICAgYltpKytdID0gdGwgPj4+IDI0ICYgMHhmZjsKICAgIGJbaSsrXSA9IHRsID4+PiAxNiAmIDB4ZmY7CiAgICBiW2krK10gPSB0bCA+Pj4gOCAmIDB4ZmY7CiAgICBiW2krK10gPSB0bCAmIDB4ZmY7CiAgCiAgICAvLyBgdGltZV9taWRgCiAgICB2YXIgdG1oID0gKG1zZWNzIC8gMHgxMDAwMDAwMDAgKiAxMDAwMCkgJiAweGZmZmZmZmY7CiAgICBiW2krK10gPSB0bWggPj4+IDggJiAweGZmOwogICAgYltpKytdID0gdG1oICYgMHhmZjsKICAKICAgIC8vIGB0aW1lX2hpZ2hfYW5kX3ZlcnNpb25gCiAgICBiW2krK10gPSB0bWggPj4+IDI0ICYgMHhmIHwgMHgxMDsgLy8gaW5jbHVkZSB2ZXJzaW9uCiAgICBiW2krK10gPSB0bWggPj4+IDE2ICYgMHhmZjsKICAKICAgIC8vIGBjbG9ja19zZXFfaGlfYW5kX3Jlc2VydmVkYCAoUGVyIDQuMi4yIC0gaW5jbHVkZSB2YXJpYW50KQogICAgYltpKytdID0gY2xvY2tzZXEgPj4+IDggfCAweDgwOwogIAogICAgLy8gYGNsb2NrX3NlcV9sb3dgCiAgICBiW2krK10gPSBjbG9ja3NlcSAmIDB4ZmY7CiAgCiAgICAvLyBgbm9kZWAKICAgIGZvciAodmFyIG4gPSAwOyBuIDwgNjsgKytuKSB7CiAgICAgIGJbaSArIG5dID0gbm9kZVtuXTsKICAgIH0KICAKICAgIHJldHVybiBidWYgPyBidWYgOiBieXRlc1RvVXVpZChiKTsKICB9CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSB2MTsKICAKICB9LHsiLi9saWIvYnl0ZXNUb1V1aWQiOjk5LCIuL2xpYi9ybmciOjEwMH1dLDEwMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHJuZyA9IHJlcXVpcmUoJy4vbGliL3JuZycpOwogIHZhciBieXRlc1RvVXVpZCA9IHJlcXVpcmUoJy4vbGliL2J5dGVzVG9VdWlkJyk7CiAgCiAgZnVuY3Rpb24gdjQob3B0aW9ucywgYnVmLCBvZmZzZXQpIHsKICAgIHZhciBpID0gYnVmICYmIG9mZnNldCB8fCAwOwogIAogICAgaWYgKHR5cGVvZihvcHRpb25zKSA9PSAnc3RyaW5nJykgewogICAgICBidWYgPSBvcHRpb25zID09PSAnYmluYXJ5JyA/IG5ldyBBcnJheSgxNikgOiBudWxsOwogICAgICBvcHRpb25zID0gbnVsbDsKICAgIH0KICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIAogICAgdmFyIHJuZHMgPSBvcHRpb25zLnJhbmRvbSB8fCAob3B0aW9ucy5ybmcgfHwgcm5nKSgpOwogIAogICAgLy8gUGVyIDQuNCwgc2V0IGJpdHMgZm9yIHZlcnNpb24gYW5kIGBjbG9ja19zZXFfaGlfYW5kX3Jlc2VydmVkYAogICAgcm5kc1s2XSA9IChybmRzWzZdICYgMHgwZikgfCAweDQwOwogICAgcm5kc1s4XSA9IChybmRzWzhdICYgMHgzZikgfCAweDgwOwogIAogICAgLy8gQ29weSBieXRlcyB0byBidWZmZXIsIGlmIHByb3ZpZGVkCiAgICBpZiAoYnVmKSB7CiAgICAgIGZvciAodmFyIGlpID0gMDsgaWkgPCAxNjsgKytpaSkgewogICAgICAgIGJ1ZltpICsgaWldID0gcm5kc1tpaV07CiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiBidWYgfHwgYnl0ZXNUb1V1aWQocm5kcyk7CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gdjQ7CiAgCiAgfSx7Ii4vbGliL2J5dGVzVG9VdWlkIjo5OSwiLi9saWIvcm5nIjoxMDB9XSwxMDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogICJ1c2Ugc3RyaWN0IjsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOwogIHZhciBMUlVfMSA9IHJlcXVpcmUoIi4vdXRpbHMvTFJVIik7CiAgdmFyIENBQ0hFX1NJWkUgPSAxMDAwOwogIC8qKgogICAqIEluc3BpcmVkIG5vZGUtbHJ1LWNhY2hlW2h0dHBzOi8vZ2l0aHViLmNvbS9pc2FhY3Mvbm9kZS1scnUtY2FjaGVdCiAgICovCiAgdmFyIEVuZHBvaW50Q2FjaGUgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7CiAgICAgIGZ1bmN0aW9uIEVuZHBvaW50Q2FjaGUobWF4U2l6ZSkgewogICAgICAgICAgaWYgKG1heFNpemUgPT09IHZvaWQgMCkgeyBtYXhTaXplID0gQ0FDSEVfU0laRTsgfQogICAgICAgICAgdGhpcy5tYXhTaXplID0gbWF4U2l6ZTsKICAgICAgICAgIHRoaXMuY2FjaGUgPSBuZXcgTFJVXzEuTFJVQ2FjaGUobWF4U2l6ZSk7CiAgICAgIH0KICAgICAgOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUsICJzaXplIiwgewogICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2FjaGUubGVuZ3RoOwogICAgICAgICAgfSwKICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgfSk7CiAgICAgIEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLnB1dCA9IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgdmFyIGtleVN0cmluZyA9IHR5cGVvZiBrZXkgIT09ICdzdHJpbmcnID8gRW5kcG9pbnRDYWNoZS5nZXRLZXlTdHJpbmcoa2V5KSA6IGtleTsKICAgICAgICAgIHZhciBlbmRwb2ludFJlY29yZCA9IHRoaXMucG9wdWxhdGVWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICB0aGlzLmNhY2hlLnB1dChrZXlTdHJpbmcsIGVuZHBvaW50UmVjb3JkKTsKICAgICAgfTsKICAgICAgRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKGtleSkgewogICAgICAgIHZhciBrZXlTdHJpbmcgPSB0eXBlb2Yga2V5ICE9PSAnc3RyaW5nJyA/IEVuZHBvaW50Q2FjaGUuZ2V0S2V5U3RyaW5nKGtleSkgOiBrZXk7CiAgICAgICAgICB2YXIgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgICAgIHZhciByZWNvcmRzID0gdGhpcy5jYWNoZS5nZXQoa2V5U3RyaW5nKTsKICAgICAgICAgIGlmIChyZWNvcmRzKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWNvcmRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHZhciByZWNvcmQgPSByZWNvcmRzW2ldOwogICAgICAgICAgICAgICAgICBpZiAocmVjb3JkLkV4cGlyZSA8IG5vdykgewogICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYWNoZS5yZW1vdmUoa2V5U3RyaW5nKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVjb3JkczsKICAgICAgfTsKICAgICAgRW5kcG9pbnRDYWNoZS5nZXRLZXlTdHJpbmcgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICB2YXIgaWRlbnRpZmllcnMgPSBbXTsKICAgICAgICAgIHZhciBpZGVudGlmaWVyTmFtZXMgPSBPYmplY3Qua2V5cyhrZXkpLnNvcnQoKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaWRlbnRpZmllck5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGlkZW50aWZpZXJOYW1lID0gaWRlbnRpZmllck5hbWVzW2ldOwogICAgICAgICAgICAgIGlmIChrZXlbaWRlbnRpZmllck5hbWVdID09PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIGlkZW50aWZpZXJzLnB1c2goa2V5W2lkZW50aWZpZXJOYW1lXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaWRlbnRpZmllcnMuam9pbignICcpOwogICAgICB9OwogICAgICBFbmRwb2ludENhY2hlLnByb3RvdHlwZS5wb3B1bGF0ZVZhbHVlID0gZnVuY3Rpb24gKGVuZHBvaW50cykgewogICAgICAgICAgdmFyIG5vdyA9IERhdGUubm93KCk7CiAgICAgICAgICByZXR1cm4gZW5kcG9pbnRzLm1hcChmdW5jdGlvbiAoZW5kcG9pbnQpIHsgcmV0dXJuICh7CiAgICAgICAgICAgICAgQWRkcmVzczogZW5kcG9pbnQuQWRkcmVzcyB8fCAnJywKICAgICAgICAgICAgICBFeHBpcmU6IG5vdyArIChlbmRwb2ludC5DYWNoZVBlcmlvZEluTWludXRlcyB8fCAxKSAqIDYwICogMTAwMAogICAgICAgICAgfSk7IH0pOwogICAgICB9OwogICAgICBFbmRwb2ludENhY2hlLnByb3RvdHlwZS5lbXB0eSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHRoaXMuY2FjaGUuZW1wdHkoKTsKICAgICAgfTsKICAgICAgRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUucmVtb3ZlID0gZnVuY3Rpb24gKGtleSkgewogICAgICAgIHZhciBrZXlTdHJpbmcgPSB0eXBlb2Yga2V5ICE9PSAnc3RyaW5nJyA/IEVuZHBvaW50Q2FjaGUuZ2V0S2V5U3RyaW5nKGtleSkgOiBrZXk7CiAgICAgICAgICB0aGlzLmNhY2hlLnJlbW92ZShrZXlTdHJpbmcpOwogICAgICB9OwogICAgICByZXR1cm4gRW5kcG9pbnRDYWNoZTsKICB9KCkpOwogIGV4cG9ydHMuRW5kcG9pbnRDYWNoZSA9IEVuZHBvaW50Q2FjaGU7CiAgfSx7Ii4vdXRpbHMvTFJVIjoxMDR9XSwxMDQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogICJ1c2Ugc3RyaWN0IjsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOwogIHZhciBMaW5rZWRMaXN0Tm9kZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsKICAgICAgZnVuY3Rpb24gTGlua2VkTGlzdE5vZGUoa2V5LCB2YWx1ZSkgewogICAgICAgICAgdGhpcy5rZXkgPSBrZXk7CiAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIExpbmtlZExpc3ROb2RlOwogIH0oKSk7CiAgdmFyIExSVUNhY2hlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgewogICAgICBmdW5jdGlvbiBMUlVDYWNoZShzaXplKSB7CiAgICAgICAgICB0aGlzLm5vZGVNYXAgPSB7fTsKICAgICAgICAgIHRoaXMuc2l6ZSA9IDA7CiAgICAgICAgICBpZiAodHlwZW9mIHNpemUgIT09ICdudW1iZXInIHx8IHNpemUgPCAxKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYWNoZSBzaXplIGNhbiBvbmx5IGJlIHBvc2l0aXZlIG51bWJlcicpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5zaXplTGltaXQgPSBzaXplOwogICAgICB9CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShMUlVDYWNoZS5wcm90b3R5cGUsICJsZW5ndGgiLCB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zaXplOwogICAgICAgICAgfSwKICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgfSk7CiAgICAgIExSVUNhY2hlLnByb3RvdHlwZS5wcmVwZW5kVG9MaXN0ID0gZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICAgIGlmICghdGhpcy5oZWFkZXJOb2RlKSB7CiAgICAgICAgICAgICAgdGhpcy50YWlsTm9kZSA9IG5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLmhlYWRlck5vZGUucHJldiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZS5uZXh0ID0gdGhpcy5oZWFkZXJOb2RlOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5oZWFkZXJOb2RlID0gbm9kZTsKICAgICAgICAgIHRoaXMuc2l6ZSsrOwogICAgICB9OwogICAgICBMUlVDYWNoZS5wcm90b3R5cGUucmVtb3ZlRnJvbVRhaWwgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoIXRoaXMudGFpbE5vZGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5vZGUgPSB0aGlzLnRhaWxOb2RlOwogICAgICAgICAgdmFyIHByZXZOb2RlID0gbm9kZS5wcmV2OwogICAgICAgICAgaWYgKHByZXZOb2RlKSB7CiAgICAgICAgICAgICAgcHJldk5vZGUubmV4dCA9IHVuZGVmaW5lZDsKICAgICAgICAgIH0KICAgICAgICAgIG5vZGUucHJldiA9IHVuZGVmaW5lZDsKICAgICAgICAgIHRoaXMudGFpbE5vZGUgPSBwcmV2Tm9kZTsKICAgICAgICAgIHRoaXMuc2l6ZS0tOwogICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgIH07CiAgICAgIExSVUNhY2hlLnByb3RvdHlwZS5kZXRhY2hGcm9tTGlzdCA9IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICBpZiAodGhpcy5oZWFkZXJOb2RlID09PSBub2RlKSB7CiAgICAgICAgICAgICAgdGhpcy5oZWFkZXJOb2RlID0gbm9kZS5uZXh0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMudGFpbE5vZGUgPT09IG5vZGUpIHsKICAgICAgICAgICAgICB0aGlzLnRhaWxOb2RlID0gbm9kZS5wcmV2OwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vZGUucHJldikgewogICAgICAgICAgICAgIG5vZGUucHJldi5uZXh0ID0gbm9kZS5uZXh0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vZGUubmV4dCkgewogICAgICAgICAgICAgIG5vZGUubmV4dC5wcmV2ID0gbm9kZS5wcmV2OwogICAgICAgICAgfQogICAgICAgICAgbm9kZS5uZXh0ID0gdW5kZWZpbmVkOwogICAgICAgICAgbm9kZS5wcmV2ID0gdW5kZWZpbmVkOwogICAgICAgICAgdGhpcy5zaXplLS07CiAgICAgIH07CiAgICAgIExSVUNhY2hlLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICBpZiAodGhpcy5ub2RlTWFwW2tleV0pIHsKICAgICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXMubm9kZU1hcFtrZXldOwogICAgICAgICAgICAgIHRoaXMuZGV0YWNoRnJvbUxpc3Qobm9kZSk7CiAgICAgICAgICAgICAgdGhpcy5wcmVwZW5kVG9MaXN0KG5vZGUpOwogICAgICAgICAgICAgIHJldHVybiBub2RlLnZhbHVlOwogICAgICAgICAgfQogICAgICB9OwogICAgICBMUlVDYWNoZS5wcm90b3R5cGUucmVtb3ZlID0gZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgaWYgKHRoaXMubm9kZU1hcFtrZXldKSB7CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzLm5vZGVNYXBba2V5XTsKICAgICAgICAgICAgICB0aGlzLmRldGFjaEZyb21MaXN0KG5vZGUpOwogICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm5vZGVNYXBba2V5XTsKICAgICAgICAgIH0KICAgICAgfTsKICAgICAgTFJVQ2FjaGUucHJvdG90eXBlLnB1dCA9IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgICBpZiAodGhpcy5ub2RlTWFwW2tleV0pIHsKICAgICAgICAgICAgICB0aGlzLnJlbW92ZShrZXkpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAodGhpcy5zaXplID09PSB0aGlzLnNpemVMaW1pdCkgewogICAgICAgICAgICAgIHZhciB0YWlsTm9kZSA9IHRoaXMucmVtb3ZlRnJvbVRhaWwoKTsKICAgICAgICAgICAgICB2YXIga2V5XzEgPSB0YWlsTm9kZS5rZXk7CiAgICAgICAgICAgICAgZGVsZXRlIHRoaXMubm9kZU1hcFtrZXlfMV07CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Tm9kZSA9IG5ldyBMaW5rZWRMaXN0Tm9kZShrZXksIHZhbHVlKTsKICAgICAgICAgIHRoaXMubm9kZU1hcFtrZXldID0gbmV3Tm9kZTsKICAgICAgICAgIHRoaXMucHJlcGVuZFRvTGlzdChuZXdOb2RlKTsKICAgICAgfTsKICAgICAgTFJVQ2FjaGUucHJvdG90eXBlLmVtcHR5ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh0aGlzLm5vZGVNYXApOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzLm5vZGVNYXBba2V5XTsKICAgICAgICAgICAgICB0aGlzLmRldGFjaEZyb21MaXN0KG5vZGUpOwogICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm5vZGVNYXBba2V5XTsKICAgICAgICAgIH0KICAgICAgfTsKICAgICAgcmV0dXJuIExSVUNhY2hlOwogIH0oKSk7CiAgZXhwb3J0cy5MUlVDYWNoZSA9IExSVUNhY2hlOwogIH0se31dLDEwNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gQVdTIFNESyBmb3IgSmF2YVNjcmlwdCB2Mi41NTMuMAogIC8vIENvcHlyaWdodCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogIC8vIExpY2Vuc2UgYXQgaHR0cHM6Ly9zZGsuYW1hem9uYXdzLmNvbS9qcy9CVU5ETEVfTElDRU5TRS50eHQKICByZXF1aXJlKCcuL2Jyb3dzZXJfbG9hZGVyJyk7CiAgCiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIAogIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgd2luZG93LkFXUyA9IEFXUzsKICBpZiAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgLyoqCiAgICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICAgKi8KICAgICAgbW9kdWxlLmV4cG9ydHMgPSBBV1M7CiAgfQogIGlmICh0eXBlb2Ygc2VsZiAhPT0gJ3VuZGVmaW5lZCcpIHNlbGYuQVdTID0gQVdTOwogIAogIC8qKgogICAqIEBwcml2YXRlCiAgICogRE8gTk9UIFJFTU9WRQogICAqIGJyb3dzZXIgYnVpbGRlciB3aWxsIHN0cmlwIG91dCB0aGlzIGxpbmUgaWYgc2VydmljZXMgYXJlIHN1cHBsaWVkIG9uIHRoZSBjb21tYW5kIGxpbmUuCiAgICovaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoQVdTLCAnQ29ubmVjdCcpKSB7CiAgICBBV1MuYXBpTG9hZGVyLnNlcnZpY2VzWydjb25uZWN0J10gPSB7fTsKICAgIEFXUy5Db25uZWN0ID0gQVdTLlNlcnZpY2UuZGVmaW5lU2VydmljZSgnY29ubmVjdCcsIFsgJzIwMTctMDItMTUnIF0pOwogIH0KICBBV1MuYXBpTG9hZGVyLnNlcnZpY2VzWydjb25uZWN0J11bJzIwMTctMDItMTUnXSA9IHJlcXVpcmUoJy4uL2FwaXMvY29ubmVjdC0yMDE3LTAyLTE1Lm1pbicpOwogIAogIGlmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKEFXUywgJ1NUUycpKSB7CiAgICBBV1MuYXBpTG9hZGVyLnNlcnZpY2VzWydzdHMnXSA9IHt9OwogICAgQVdTLlNUUyA9IEFXUy5TZXJ2aWNlLmRlZmluZVNlcnZpY2UoJ3N0cycsIFsgJzIwMTEtMDYtMTUnIF0pOwogICAgcmVxdWlyZSgnLi9zZXJ2aWNlcy9zdHMnKTsKICB9CiAgQVdTLmFwaUxvYWRlci5zZXJ2aWNlc1snc3RzJ11bJzIwMTEtMDYtMTUnXSA9IHJlcXVpcmUoJy4uL2FwaXMvc3RzLTIwMTEtMDYtMTUubWluJyk7CiAgCiAgCiAgfSx7Ii4uL2FwaXMvY29ubmVjdC0yMDE3LTAyLTE1Lm1pbiI6MywiLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5taW4iOjUsIi4vYnJvd3Nlcl9sb2FkZXIiOjE2LCIuL2NvcmUiOjE4LCIuL3NlcnZpY2VzL3N0cyI6NjF9XX0se30sWzEwNV0pOwogIAogIAoKLyoqKi8gfSksCgovKioqLyA3NTQ6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24oKSB7CiAgIHZhciBnbG9iYWwgPSB0aGlzOwogICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGVudW0gQ2xpZW50TWV0aG9kcwogICAgKi8KICAgY29ubmVjdC5DbGllbnRNZXRob2RzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAgICAgICdnZXRBZ2VudFNuYXBzaG90JywKICAgICAgICAgJ3B1dEFnZW50U3RhdGUnLAogICAgICAgICAnZ2V0QWdlbnRTdGF0ZXMnLAogICAgICAgICAnZ2V0RGlhbGFibGVDb3VudHJ5Q29kZXMnLAogICAgICAgICAnZ2V0Um91dGluZ1Byb2ZpbGVRdWV1ZXMnLAogICAgICAgICAnZ2V0QWdlbnRQZXJtaXNzaW9ucycsCiAgICAgICAgICdnZXRBZ2VudENvbmZpZ3VyYXRpb24nLAogICAgICAgICAndXBkYXRlQWdlbnRDb25maWd1cmF0aW9uJywKICAgICAgICAgJ2FjY2VwdENvbnRhY3QnLAogICAgICAgICAnY3JlYXRlT3V0Ym91bmRDb250YWN0JywKICAgICAgICAgJ2NyZWF0ZVRhc2tDb250YWN0JywKICAgICAgICAgJ2NsZWFyQ29udGFjdCcsCiAgICAgICAgICdjb21wbGV0ZUNvbnRhY3QnLAogICAgICAgICAnZGVzdHJveUNvbnRhY3QnLAogICAgICAgICAncmVqZWN0Q29udGFjdCcsCiAgICAgICAgICdub3RpZnlDb250YWN0SXNzdWUnLAogICAgICAgICAndXBkYXRlQ29udGFjdEF0dHJpYnV0ZXMnLAogICAgICAgICAnY3JlYXRlQWRkaXRpb25hbENvbm5lY3Rpb24nLAogICAgICAgICAnZGVzdHJveUNvbm5lY3Rpb24nLAogICAgICAgICAnaG9sZENvbm5lY3Rpb24nLAogICAgICAgICAncmVzdW1lQ29ubmVjdGlvbicsCiAgICAgICAgICd0b2dnbGVBY3RpdmVDb25uZWN0aW9ucycsCiAgICAgICAgICdjb25mZXJlbmNlQ29ubmVjdGlvbnMnLAogICAgICAgICAnc2VuZENsaWVudExvZ3MnLAogICAgICAgICAnc2VuZERpZ2l0cycsCiAgICAgICAgICdzZW5kU29mdHBob25lQ2FsbFJlcG9ydCcsCiAgICAgICAgICdzZW5kU29mdHBob25lQ2FsbE1ldHJpY3MnLAogICAgICAgICAnZ2V0RW5kcG9pbnRzJywKICAgICAgICAgJ2dldE5ld0F1dGhUb2tlbicsCiAgICAgICAgICdjcmVhdGVUcmFuc3BvcnQnLAogICAgICAgICAnbXV0ZVBhcnRpY2lwYW50JywKICAgICAgICAgJ3VubXV0ZVBhcnRpY2lwYW50JwogICBdKTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBlbnVtIEFnZW50QXBwQ2xpZW50TWV0aG9kcwogICAgKi8KICAgY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMgPSB7CiAgICAgIEdFVF9DT05UQUNUOiAiQWdlbnRBcHBTZXJ2aWNlLkxjbXMuZ2V0Q29udGFjdCIsCiAgICAgIERFTEVURV9TUEVBS0VSOiAiQWdlbnRBcHBTZXJ2aWNlLlZvaWNlSWQuZGVsZXRlU3BlYWtlciIsCiAgICAgIEVOUk9MTF9CWV9TRVNTSU9OOiAiQWdlbnRBcHBTZXJ2aWNlLlZvaWNlSWQuZW5yb2xsQnlTZXNzaW9uIiwKICAgICAgRVZBTFVBVEVfU0VTU0lPTjogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLmV2YWx1YXRlU2Vzc2lvbiIsCiAgICAgIERFU0NSSUJFX1NQRUFLRVI6ICJBZ2VudEFwcFNlcnZpY2UuVm9pY2VJZC5kZXNjcmliZVNwZWFrZXIiLAogICAgICBPUFRfT1VUX1NQRUFLRVI6ICJBZ2VudEFwcFNlcnZpY2UuVm9pY2VJZC5vcHRPdXRTcGVha2VyIiwKICAgICAgVVBEQVRFX1ZPSUNFX0lEX0RBVEE6ICJBZ2VudEFwcFNlcnZpY2UuTGNtcy51cGRhdGVWb2ljZUlkRGF0YSIsCiAgICAgIERFU0NSSUJFX1NFU1NJT046ICJBZ2VudEFwcFNlcnZpY2UuVm9pY2VJZC5kZXNjcmliZVNlc3Npb24iLAogICAgICBVUERBVEVfU0VTU0lPTjogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLnVwZGF0ZVNlc3Npb24iLAogICAgICBTVEFSVF9WT0lDRV9JRF9TRVNTSU9OOiAiQWdlbnRBcHBTZXJ2aWNlLk5hc2Euc3RhcnRWb2ljZUlkU2Vzc2lvbiIsCiAgICAgIExJU1RfSU5URUdSQVRJT05fQVNTT0NJQVRJT05TOiAiQWdlbnRBcHBTZXJ2aWNlLkFjcy5saXN0SW50ZWdyYXRpb25Bc3NvY2lhdGlvbnMiCiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogZW51bSBNYXN0ZXJNZXRob2RzCiAgICAqLwogICBjb25uZWN0Lk1hc3Rlck1ldGhvZHMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICAgICAgJ2JlY29tZU1hc3RlcicsCiAgICAgICAgICdjaGVja01hc3RlcicKICAgXSk7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogYWJzdHJhY3QgY2xhc3MgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIENsaWVudEJhc2UgPSBmdW5jdGlvbigpIHt9OwogICBDbGllbnRCYXNlLkVNUFRZX0NBTExCQUNLUyA9IHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24oKSB7IH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uKCkgeyB9CiAgIH07CgogICBDbGllbnRCYXNlLnByb3RvdHlwZS5jYWxsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXNJbiwgY2FsbGJhY2tzSW4pIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKG1ldGhvZCwgJ21ldGhvZCcpOwogICAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICAgIHZhciBjYWxsYmFja3MgPSBjYWxsYmFja3NJbiB8fCBDbGllbnRCYXNlLkVNUFRZX0NBTExCQUNLUzsKICAgICAgdGhpcy5fY2FsbEltcGwobWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcyk7CiAgIH07CgogICBDbGllbnRCYXNlLnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IoKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBOdWxsQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIE51bGxDbGllbnQgPSBmdW5jdGlvbigpIHsKICAgICAgQ2xpZW50QmFzZS5jYWxsKHRoaXMpOwogICB9OwogICBOdWxsQ2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ2xpZW50QmFzZS5wcm90b3R5cGUpOwogICBOdWxsQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IE51bGxDbGllbnQ7CgogICBOdWxsQ2xpZW50LnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CiAgICAgIGlmIChjYWxsYmFja3MgJiYgY2FsbGJhY2tzLmZhaWx1cmUpIHsKICAgICAgICAgdmFyIG1lc3NhZ2UgPSBjb25uZWN0LnNwcmludGYoJ05vIHN1Y2ggbWV0aG9kIGV4aXN0cyBvbiBOVUxMIGNsaWVudDogJXMnLCBtZXRob2QpOwogICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShuZXcgY29ubmVjdC5WYWx1ZUVycm9yKG1lc3NhZ2UpLCB7bWVzc2FnZTogbWVzc2FnZX0pOwogICAgICB9CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogYWJzdHJhY3QgY2xhc3MgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZSBleHRlbmRzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlID0gZnVuY3Rpb24oY29uZHVpdCwgcmVxdWVzdEV2ZW50LCByZXNwb25zZUV2ZW50KSB7CiAgICAgIENsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5jb25kdWl0ID0gY29uZHVpdDsKICAgICAgdGhpcy5yZXF1ZXN0RXZlbnQgPSByZXF1ZXN0RXZlbnQ7CiAgICAgIHRoaXMucmVzcG9uc2VFdmVudCA9IHJlc3BvbnNlRXZlbnQ7CiAgICAgIHRoaXMuX3JlcXVlc3RJZENhbGxiYWNrc01hcCA9IHt9OwoKICAgICAgdGhpcy5jb25kdWl0Lm9uVXBzdHJlYW0ocmVzcG9uc2VFdmVudCwgY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLl9oYW5kbGVSZXNwb25zZSkpOwogICB9OwoKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlOwoKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgICB2YXIgcmVxdWVzdCA9IGNvbm5lY3QuRXZlbnRGYWN0b3J5LmNyZWF0ZVJlcXVlc3QodGhpcy5yZXF1ZXN0RXZlbnQsIG1ldGhvZCwgcGFyYW1zKTsKICAgICAgdGhpcy5fcmVxdWVzdElkQ2FsbGJhY2tzTWFwW3JlcXVlc3QucmVxdWVzdElkXSA9IGNhbGxiYWNrczsKICAgICAgdGhpcy5jb25kdWl0LnNlbmRVcHN0cmVhbShyZXF1ZXN0LmV2ZW50LCByZXF1ZXN0KTsKICAgfTsKCiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlLl9nZXRDYWxsYmFja3NGb3JSZXF1ZXN0ID0gZnVuY3Rpb24ocmVxdWVzdElkKSB7CiAgICAgIHZhciBjYWxsYmFja3MgPSB0aGlzLl9yZXF1ZXN0SWRDYWxsYmFja3NNYXBbcmVxdWVzdElkXSB8fCBudWxsOwoKICAgICAgaWYgKGNhbGxiYWNrcyAhPSBudWxsKSB7CiAgICAgICAgIGRlbGV0ZSB0aGlzLl9yZXF1ZXN0SWRDYWxsYmFja3NNYXBbcmVxdWVzdElkXTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNhbGxiYWNrczsKICAgfTsKCiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlLl9oYW5kbGVSZXNwb25zZSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgdmFyIGNhbGxiYWNrcyA9IHRoaXMuX2dldENhbGxiYWNrc0ZvclJlcXVlc3QoZGF0YS5yZXF1ZXN0SWQpOwogICAgICBpZiAoY2FsbGJhY2tzID09IG51bGwpIHsKICAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoZGF0YS5lcnIgJiYgY2FsbGJhY2tzLmZhaWx1cmUpIHsKICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZGF0YS5lcnIsIGRhdGEuZGF0YSk7CgogICAgICB9IGVsc2UgaWYgKGNhbGxiYWNrcy5zdWNjZXNzKSB7CiAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEuZGF0YSk7CiAgICAgIH0KICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBVcHN0cmVhbUNvbmR1aXRDbGllbnQgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICAqLwogICB2YXIgVXBzdHJlYW1Db25kdWl0Q2xpZW50ID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLmNhbGwodGhpcywgY29uZHVpdCwgY29ubmVjdC5FdmVudFR5cGUuQVBJX1JFUVVFU1QsIGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9SRVNQT05TRSk7CiAgIH07CiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFVwc3RyZWFtQ29uZHVpdENsaWVudDsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBVcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICAqLwogICB2YXIgVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50ID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLmNhbGwodGhpcywgY29uZHVpdCwgY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFUVVFU1QsIGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVNQT05TRSk7CiAgIH07CiAgIFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudDsKICAgCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIEFnZW50QXBwQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAqLwogICB2YXIgQWdlbnRBcHBDbGllbnQgPSBmdW5jdGlvbihhdXRoQ29va2llTmFtZSwgYXV0aFRva2VuLCBlbmRwb2ludCkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoYXV0aENvb2tpZU5hbWUsICdhdXRoQ29va2llTmFtZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoYXV0aFRva2VuLCAnYXV0aFRva2VuJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChlbmRwb2ludCwgJ2VuZHBvaW50Jyk7CiAgICAgIENsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5lbmRwb2ludFVybCA9IGNvbm5lY3QuZ2V0VXJsV2l0aFByb3RvY29sKGVuZHBvaW50KTsKICAgICAgdGhpcy5hdXRoVG9rZW4gPSBhdXRoVG9rZW47CiAgICAgIHRoaXMuYXV0aENvb2tpZU5hbWUgPSBhdXRoQ29va2llTmFtZQogICB9OwoKICAgQWdlbnRBcHBDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIEFnZW50QXBwQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEFnZW50QXBwQ2xpZW50OwoKICAgQWdlbnRBcHBDbGllbnQucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgYmVhciA9IHt9OwogICAgICBiZWFyW3NlbGYuYXV0aENvb2tpZU5hbWVdID0gc2VsZi5hdXRoVG9rZW47CiAgICAgIHZhciBvcHRpb25zID0gewogICAgICAgICBtZXRob2Q6ICdwb3N0JywKICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocGFyYW1zIHx8IHt9KSwKICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nLAogICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLAogICAgICAgICAgICAgICAnWC1BbXotdGFyZ2V0JzogbWV0aG9kLAogICAgICAgICAgICAgICAnWC1BbXotQmVhcmVyJzogSlNPTi5zdHJpbmdpZnkoYmVhcikKICAgICAgICAgfQogICAgICB9OwogICAgICBjb25uZWN0LmZldGNoKHNlbGYuZW5kcG9pbnRVcmwsIG9wdGlvbnMpLnRoZW4oZnVuY3Rpb24ocmVzKXsKICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MocmVzKTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgY29uc3QgcmVhZGVyID0gZXJyLmJvZHkuZ2V0UmVhZGVyKCk7CiAgICAgICAgIGxldCBib2R5ID0gJyc7CiAgICAgICAgIGNvbnN0IGRlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTsKICAgICAgICAgcmVhZGVyLnJlYWQoKS50aGVuKGZ1bmN0aW9uIHByb2Nlc3NUZXh0KHsgZG9uZSwgdmFsdWUgfSkgewogICAgICAgICAgICBpZiAoZG9uZSkgewogICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBKU09OLnBhcnNlKGJvZHkpOwogICAgICAgICAgICAgICBlcnJvci5zdGF0dXMgPSBlcnIuc3RhdHVzOwogICAgICAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvcik7CiAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBib2R5ICs9IGRlY29kZXIuZGVjb2RlKHZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIHJlYWRlci5yZWFkKCkudGhlbihwcm9jZXNzVGV4dCk7CiAgICAgICAgIH0pOwogICAgICB9KQogICB9OwogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgQVdTQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIEFXU0NsaWVudCA9IGZ1bmN0aW9uKGF1dGhUb2tlbiwgcmVnaW9uLCBlbmRwb2ludEluKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChhdXRoVG9rZW4sICdhdXRoVG9rZW4nKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJlZ2lvbiwgJ3JlZ2lvbicpOwogICAgICBDbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgICAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKHt9KTsKICAgICAgQVdTLmNvbmZpZy5yZWdpb24gPSByZWdpb247CiAgICAgIHRoaXMuYXV0aFRva2VuID0gYXV0aFRva2VuOwogICAgICB2YXIgYmFzZVVybCA9IGNvbm5lY3QuZ2V0QmFzZVVybCgpOwogICAgICB2YXIgZW5kcG9pbnRVcmwgPSBlbmRwb2ludEluIHx8ICggCiAgICAgICAgIGJhc2VVcmwuaW5jbHVkZXMoIi5hd3NhcHBzLmNvbSIpCiAgICAgICAgICAgID8gYmFzZVVybCArICcvY29ubmVjdC9hcGknCiAgICAgICAgICAgIDogYmFzZVVybCArICcvYXBpJwogICAgICApOwogICAgICB2YXIgZW5kcG9pbnQgPSBuZXcgQVdTLkVuZHBvaW50KGVuZHBvaW50VXJsKTsKICAgICAgdGhpcy5jbGllbnQgPSBuZXcgQVdTLkNvbm5lY3Qoe2VuZHBvaW50OiBlbmRwb2ludH0pOwogICB9OwogICBBV1NDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIEFXU0NsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBBV1NDbGllbnQ7CgogICBBV1NDbGllbnQucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgbG9nID0gY29ubmVjdC5nZXRMb2coKTsKCiAgICAgIGlmICghIGNvbm5lY3QuY29udGFpbnModGhpcy5jbGllbnQsIG1ldGhvZCkpIHsKICAgICAgICAgdmFyIG1lc3NhZ2UgPSBjb25uZWN0LnNwcmludGYoJ05vIHN1Y2ggbWV0aG9kIGV4aXN0cyBvbiBBV1MgY2xpZW50OiAlcycsIG1ldGhvZCk7CiAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKG5ldyBjb25uZWN0LlZhbHVlRXJyb3IobWVzc2FnZSksIHttZXNzYWdlOiBtZXNzYWdlfSk7CgogICAgICB9IGVsc2UgewogICAgICAgICBwYXJhbXMgPSB0aGlzLl90cmFuc2xhdGVQYXJhbXMobWV0aG9kLCBwYXJhbXMpOwoKICAgICAgICAgbG9nLnRyYWNlKCJBV1NDbGllbnQ6IC0tPiBDYWxsaW5nIG9wZXJhdGlvbiAnJXMnIiwgbWV0aG9kKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgICAgdGhpcy5jbGllbnRbbWV0aG9kXShwYXJhbXMpCiAgICAgICAgICAgIC5vbignYnVpbGQnLCBmdW5jdGlvbihyZXF1ZXN0KSB7CiAgICAgICAgICAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snWC1BbXotQmVhcmVyJ10gPSBzZWxmLmF1dGhUb2tlbjsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgaWYgKGVyci5jb2RlID09PSBjb25uZWN0LkNUSUV4Y2VwdGlvbnMuVU5BVVRIT1JJWkVEX0VYQ0VQVElPTikgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3MuYXV0aEZhaWx1cmUoKTsKICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjYWxsYmFja3MuYWNjZXNzRGVuaWVkICYmIChlcnIuY29kZSA9PT0gY29ubmVjdC5DVElFeGNlcHRpb25zLkFDQ0VTU19ERU5JRURfRVhDRVBUSU9OIHx8IGVyci5zdGF0dXNDb2RlID09PSA0MDMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5hY2Nlc3NEZW5pZWQoKTsKICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FuJ3QgcGFzcyBlcnIgZGlyZWN0bHkgdG8gcG9zdE1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcG9zdE1lc3NhZ2UoKSB0cmllcyB0byBjbG9uZSB0aGUgZXJyIG9iamVjdCBhbmQgZmFpbGVkLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZWZlciB0byBodHRwczovL2dpdGh1Yi5jb20vZ29hdHNsYWNrZXIvYWx0LWRldnRvb2wvaXNzdWVzLzUKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLnR5cGUgPSBlcnIuY29kZTsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IubWVzc2FnZSA9IGVyci5tZXNzYWdlOwogICAgICAgICAgICAgICAgICAgICAgICBlcnJvci5zdGFjayA9IGVyci5zdGFjayA/IGVyci5zdGFjay5zcGxpdCgnXG4nKSA6IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvciwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgIGxvZy50cmFjZSgiQVdTQ2xpZW50OiA8LS0gT3BlcmF0aW9uICclcycgZmFpbGVkOiAlcyIsIG1ldGhvZCwgSlNPTi5zdHJpbmdpZnkoZXJyKSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgIGxvZy50cmFjZSgiQVdTQ2xpZW50OiA8LS0gT3BlcmF0aW9uICclcycgc3VjY2VlZGVkLiIsIG1ldGhvZCkud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBoYW5kbGUgQVdTIEFQSSByZXF1ZXN0IGZvciBtZXRob2QgJXMiLCBtZXRob2QpCiAgICAgICAgICAgICAgICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgIH0KICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3JlcXVpcmVzQXV0aGVudGljYXRpb25QYXJhbSA9IGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgcmV0dXJuIG1ldGhvZCAhPT0gY29ubmVjdC5DbGllbnRNZXRob2RzLkNPTVBMRVRFX0NPTlRBQ1QgJiYKICAgICAgICAgbWV0aG9kICE9PSBjb25uZWN0LkNsaWVudE1ldGhvZHMuQ0xFQVJfQ09OVEFDVCAmJgogICAgICAgICBtZXRob2QgIT09IGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5SRUpFQ1RfQ09OVEFDVCAmJgogICAgICAgICBtZXRob2QgIT09IGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfVEFTS19DT05UQUNUOwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlUGFyYW1zID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMpIHsKICAgICAgc3dpdGNoIChtZXRob2QpIHsKICAgICAgICAgY2FzZSBjb25uZWN0LkNsaWVudE1ldGhvZHMuVVBEQVRFX0FHRU5UX0NPTkZJR1VSQVRJT046CiAgICAgICAgICAgIHBhcmFtcy5jb25maWd1cmF0aW9uID0gdGhpcy5fdHJhbnNsYXRlQWdlbnRDb25maWd1cmF0aW9uKHBhcmFtcy5jb25maWd1cmF0aW9uKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICBjYXNlIGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX1NPRlRQSE9ORV9DQUxMX01FVFJJQ1M6CiAgICAgICAgICAgIHBhcmFtcy5zb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzID0gdGhpcy5fdHJhbnNsYXRlU29mdHBob25lU3RyZWFtU3RhdGlzdGljcygKICAgICAgICAgICAgICAgICAgcGFyYW1zLnNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgIGNhc2UgY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfU09GVFBIT05FX0NBTExfUkVQT1JUOgogICAgICAgICAgICBwYXJhbXMucmVwb3J0ID0gdGhpcy5fdHJhbnNsYXRlU29mdHBob25lQ2FsbFJlcG9ydChwYXJhbXMucmVwb3J0KTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBicmVhazsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuX3JlcXVpcmVzQXV0aGVudGljYXRpb25QYXJhbShtZXRob2QpKSB7CiAgICAgICAgIHBhcmFtcy5hdXRoZW50aWNhdGlvbiA9IHsKICAgICAgICAgICAgYXV0aFRva2VuOiB0aGlzLmF1dGhUb2tlbgogICAgICAgICB9OwogICAgICB9CgogICAgICByZXR1cm4gcGFyYW1zOwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlQWdlbnRDb25maWd1cmF0aW9uID0gZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgIG5hbWU6IGNvbmZpZy5uYW1lLAogICAgICAgICBzb2Z0cGhvbmVFbmFibGVkOiBjb25maWcuc29mdHBob25lRW5hYmxlZCwKICAgICAgICAgc29mdHBob25lQXV0b0FjY2VwdDogY29uZmlnLnNvZnRwaG9uZUF1dG9BY2NlcHQsCiAgICAgICAgIGV4dGVuc2lvbjogY29uZmlnLmV4dGVuc2lvbiwKICAgICAgICAgcm91dGluZ1Byb2ZpbGU6IHRoaXMuX3RyYW5zbGF0ZVJvdXRpbmdQcm9maWxlKGNvbmZpZy5yb3V0aW5nUHJvZmlsZSksCiAgICAgICAgIGFnZW50UHJlZmVyZW5jZXM6IGNvbmZpZy5hZ2VudFByZWZlcmVuY2VzCiAgICAgIH07CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVSb3V0aW5nUHJvZmlsZSA9IGZ1bmN0aW9uKHByb2ZpbGUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAgbmFtZTogcHJvZmlsZS5uYW1lLAogICAgICAgICByb3V0aW5nUHJvZmlsZUFSTjogcHJvZmlsZS5yb3V0aW5nUHJvZmlsZUFSTiwKICAgICAgICAgZGVmYXVsdE91dGJvdW5kUXVldWU6IHRoaXMuX3RyYW5zbGF0ZVF1ZXVlKHByb2ZpbGUuZGVmYXVsdE91dGJvdW5kUXVldWUpCiAgICAgIH07CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVRdWV1ZSA9IGZ1bmN0aW9uKHF1ZXVlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgIHF1ZXVlQVJOOiAgIHF1ZXVlLnF1ZXVlQVJOLAogICAgICAgICBuYW1lOiAgICAgICBxdWV1ZS5uYW1lCiAgICAgIH07CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVTb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzID0gZnVuY3Rpb24oc3RhdHMpIHsKICAgICAgc3RhdHMuZm9yRWFjaChmdW5jdGlvbihzdGF0KSB7CiAgICAgICAgIGlmICgncGFja2V0c0NvdW50JyBpbiBzdGF0KSB7CiAgICAgICAgICAgIHN0YXQucGFja2V0Q291bnQgPSBzdGF0LnBhY2tldHNDb3VudDsKICAgICAgICAgICAgZGVsZXRlIHN0YXQucGFja2V0c0NvdW50OwogICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIHN0YXRzOwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlU29mdHBob25lQ2FsbFJlcG9ydCA9IGZ1bmN0aW9uKHJlcG9ydCkgewogICAgICBpZiAoJ2hhbmRzaGFraW5nVGltZU1pbGxpcycgaW4gcmVwb3J0KSB7CiAgICAgICAgIHJlcG9ydC5oYW5kc2hha2VUaW1lTWlsbGlzID0gcmVwb3J0LmhhbmRzaGFraW5nVGltZU1pbGxpczsKICAgICAgICAgZGVsZXRlIHJlcG9ydC5oYW5kc2hha2luZ1RpbWVNaWxsaXM7CiAgICAgIH0KCiAgICAgIGlmICgncHJlVGFsa2luZ1RpbWVNaWxsaXMnIGluIHJlcG9ydCkgewogICAgICAgICByZXBvcnQucHJlVGFsa1RpbWVNaWxsaXMgPSByZXBvcnQucHJlVGFsa2luZ1RpbWVNaWxsaXM7CiAgICAgICAgIGRlbGV0ZSByZXBvcnQucHJlVGFsa2luZ1RpbWVNaWxsaXM7CiAgICAgIH0KCiAgICAgIGlmICgnaGFuZHNoYWtpbmdGYWlsdXJlJyBpbiByZXBvcnQpIHsKICAgICAgICAgcmVwb3J0LmhhbmRzaGFrZUZhaWx1cmUgPSByZXBvcnQuaGFuZHNoYWtpbmdGYWlsdXJlOwogICAgICAgICBkZWxldGUgcmVwb3J0LmhhbmRzaGFraW5nRmFpbHVyZTsKICAgICAgfQoKICAgICAgaWYgKCd0YWxraW5nVGltZU1pbGxpcycgaW4gcmVwb3J0KSB7CiAgICAgICAgIHJlcG9ydC50YWxrVGltZU1pbGxpcyA9IHJlcG9ydC50YWxraW5nVGltZU1pbGxpczsKICAgICAgICAgZGVsZXRlIHJlcG9ydC50YWxraW5nVGltZU1pbGxpczsKICAgICAgfQoKICAgICAgcmVwb3J0LnNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MgPSB0aGlzLl90cmFuc2xhdGVTb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzKAogICAgICAgICAgICByZXBvcnQuc29mdHBob25lU3RyZWFtU3RhdGlzdGljcyk7CgogICAgICByZXR1cm4gcmVwb3J0OwogICB9OwoKICAgY29ubmVjdC5DbGllbnRCYXNlID0gQ2xpZW50QmFzZTsKICAgY29ubmVjdC5OdWxsQ2xpZW50ID0gTnVsbENsaWVudDsKICAgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRDbGllbnQgPSBVcHN0cmVhbUNvbmR1aXRDbGllbnQ7CiAgIGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50ID0gVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50OwogICBjb25uZWN0LkFXU0NsaWVudCA9IEFXU0NsaWVudDsKICAgY29ubmVjdC5BZ2VudEFwcENsaWVudCA9IEFnZW50QXBwQ2xpZW50OwoKfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDg5NToKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogIGNvbm5lY3QuY29yZSA9IHt9OwogIGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCA9IGZhbHNlOwogIGNvbm5lY3QudmVyc2lvbiA9ICJTVFJFQU1TX1ZFUlNJT04iOwogIGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFID0gNTAwOwogCiAgdmFyIENDUF9TWU5fVElNRU9VVCA9IDEwMDA7IC8vIDEgc2VjCiAgdmFyIENDUF9BQ0tfVElNRU9VVCA9IDMwMDA7IC8vIDMgc2VjCiAgdmFyIENDUF9MT0FEX1RJTUVPVVQgPSA1MDAwOyAvLyA1IHNlYwogIHZhciBDQ1BfSUZSQU1FX1JFRlJFU0hfSU5URVJWQUwgPSA1MDAwOyAvLyA1IHNlYwogIHZhciBDQ1BfRFJfSUZSQU1FX1JFRlJFU0hfSU5URVJWQUwgPSAxMDAwMDsgLy8xMCBzCiAgdmFyIENDUF9JRlJBTUVfUkVGUkVTSF9MSU1JVCA9IDY7IC8vIDYgYXR0ZW1wdHMKICB2YXIgQ0NQX0lGUkFNRV9OQU1FID0gJ0FtYXpvbiBDb25uZWN0IENDUCc7CiAKICB2YXIgTEVHQUNZX0xPR0lOX1VSTF9QQVRURVJOID0gImh0dHBzOi8ve2FsaWFzfS5hd3NhcHBzLmNvbS9hdXRoLz9jbGllbnRfaWQ9e2NsaWVudF9pZH0mcmVkaXJlY3RfdXJpPXtyZWRpcmVjdH0iOwogIHZhciBDTElFTlRfSURfTUFQID0gewogICAgInVzLWVhc3QtMSI6ICIwNjkxOWY0ZmQ4ZWQzMjRlIgogIH07CiAKICB2YXIgQVVUSE9SSVpFX0VORFBPSU5UID0gIi9hdXRoL2F1dGhvcml6ZSI7CiAgdmFyIExFR0FDWV9BVVRIT1JJWkVfRU5EUE9JTlQgPSAiL2Nvbm5lY3QvYXV0aC9hdXRob3JpemUiOwogIHZhciBBVVRIT1JJWkVfUkVUUllfSU5URVJWQUwgPSAyMDAwOwogIHZhciBBVVRIT1JJWkVfTUFYX1JFVFJZID0gNTsKIAogIHZhciBMRUdBQ1lfV0hJVEVMSVNURURfT1JJR0lOU19FTkRQT0lOVCA9ICIvY29ubmVjdC93aGl0ZWxpc3RlZC1vcmlnaW5zIjsKICB2YXIgV0hJVEVMSVNURURfT1JJR0lOU19FTkRQT0lOVCA9ICIvd2hpdGVsaXN0ZWQtb3JpZ2lucyI7CiAgdmFyIFdISVRFTElTVEVEX09SSUdJTlNfUkVUUllfSU5URVJWQUwgPSAyMDAwOwogIHZhciBXSElURUxJU1RFRF9PUklHSU5TX01BWF9SRVRSWSA9IDU7CgogIGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzID0gMDsKCiAgLyoqCiAgICogQGRlcHJlY2F0ZWQKICAgKiBUaGlzIGZ1bmN0aW9uIHdhcyBvbmx5IG1lYW50IGZvciBpbnRlcm5hbCB1c2UuIAogICAqIFRoZSBuYW1lIGlzIG1pc2xlYWRpbmcgZm9yIHdoYXQgaXQgc2hvdWxkIGRvLgogICAqIEludGVybmFsbHkgd2UgaGF2ZSByZXBsYWNlZCBpdHMgdXNhZ2Ugd2l0aCBgZ2V0TG9naW5VcmxgLgogICAqLwogIHZhciBjcmVhdGVMb2dpblVybCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIHZhciByZWRpcmVjdCA9ICJodHRwczovL2xpbHkudXMtZWFzdC0xLmFtYXpvbmF3cy5jb20vdGF3L2F1dGgvY29kZSI7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmVkaXJlY3QpOwogCiAgICBpZiAocGFyYW1zLmxvZ2luVXJsKSB7CiAgICAgIHJldHVybiBwYXJhbXMubG9naW5VcmwKICAgIH0gZWxzZSBpZiAocGFyYW1zLmFsaWFzKSB7CiAgICAgIGxvZy53YXJuKCJUaGUgYGFsaWFzYCBwYXJhbSBpcyBkZXByZWNhdGVkIGFuZCBzaG91bGQgbm90IGJlIGV4cGVjdGVkIHRvIGZ1bmN0aW9uIHByb3Blcmx5LiBQbGVhc2UgdXNlIGBjY3BVcmxgIG9yIGBsb2dpblVybGAuIFNlZSBodHRwczovL2dpdGh1Yi5jb20vYW1hem9uLWNvbm5lY3QvYW1hem9uLWNvbm5lY3Qtc3RyZWFtcy9ibG9iL21hc3Rlci9SRUFETUUubWQjY29ubmVjdGNvcmVpbml0Y2NwIGZvciB2YWxpZCBwYXJhbWV0ZXJzLiIpOwogICAgICByZXR1cm4gTEVHQUNZX0xPR0lOX1VSTF9QQVRURVJOCiAgICAgICAgLnJlcGxhY2UoInthbGlhc30iLCBwYXJhbXMuYWxpYXMpCiAgICAgICAgLnJlcGxhY2UoIntjbGllbnRfaWR9IiwgQ0xJRU5UX0lEX01BUFsidXMtZWFzdC0xIl0pCiAgICAgICAgLnJlcGxhY2UoIntyZWRpcmVjdH0iLCBnbG9iYWwuZW5jb2RlVVJJQ29tcG9uZW50KAogICAgICAgICAgcmVkaXJlY3QpKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBwYXJhbXMuY2NwVXJsOwogICAgfQogIH07CgogIC8qKgogICAqIFJlcGxhY2VzIGBjcmVhdGVMb2dpblVybGAsIGFzIHRoYXQgZnVuY3Rpb24ncyBuYW1lIHdhcyBtaXNsZWFkaW5nLgogICAqIFRoZSBgcGFyYW1zLmFsaWFzYCBwYXJhbWV0ZXIgaXMgZGVwcmVjYXRlZC4gUGxlYXNlIHJlZnJhaW4gZnJvbSB1c2luZyBpdC4KICAgKi8KICB2YXIgZ2V0TG9naW5VcmwgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICB2YXIgcmVkaXJlY3QgPSAiaHR0cHM6Ly9saWx5LnVzLWVhc3QtMS5hbWF6b25hd3MuY29tL3Rhdy9hdXRoL2NvZGUiOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJlZGlyZWN0KTsKICAgIGlmIChwYXJhbXMubG9naW5VcmwpIHsKICAgICAgcmV0dXJuIHBhcmFtcy5sb2dpblVybAogICAgfSBlbHNlIGlmIChwYXJhbXMuYWxpYXMpIHsKICAgICAgbG9nLndhcm4oIlRoZSBgYWxpYXNgIHBhcmFtIGlzIGRlcHJlY2F0ZWQgYW5kIHNob3VsZCBub3QgYmUgZXhwZWN0ZWQgdG8gZnVuY3Rpb24gcHJvcGVybHkuIFBsZWFzZSB1c2UgYGNjcFVybGAgb3IgYGxvZ2luVXJsYC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hbWF6b24tY29ubmVjdC9hbWF6b24tY29ubmVjdC1zdHJlYW1zL2Jsb2IvbWFzdGVyL1JFQURNRS5tZCNjb25uZWN0Y29yZWluaXRjY3AgZm9yIHZhbGlkIHBhcmFtZXRlcnMuIik7CiAgICAgIHJldHVybiBMRUdBQ1lfTE9HSU5fVVJMX1BBVFRFUk4KICAgICAgICAucmVwbGFjZSgie2FsaWFzfSIsIHBhcmFtcy5hbGlhcykKICAgICAgICAucmVwbGFjZSgie2NsaWVudF9pZH0iLCBDTElFTlRfSURfTUFQWyJ1cy1lYXN0LTEiXSkKICAgICAgICAucmVwbGFjZSgie3JlZGlyZWN0fSIsIGdsb2JhbC5lbmNvZGVVUklDb21wb25lbnQoCiAgICAgICAgICByZWRpcmVjdCkpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHBhcmFtcy5jY3BVcmw7CiAgICB9CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIFJldHVybnMgc2NoZW1lOi8vaG9zdDpwb3J0IGZvciBhIGdpdmVuIHVybAogICovCiAgZnVuY3Rpb24gc2FuaXRpemVEb21haW4odXJsKSB7CiAgICB2YXIgZG9tYWluID0gdXJsLm1hdGNoKC9eKD86aHR0cHM/OlwvXC8pPyg/OlteQFxuXStAKT8oPzp3d3dcLik/KFteOlwvXG4/XSspL2lnKTsKICAgIHJldHVybiBkb21haW4ubGVuZ3RoID8gZG9tYWluWzBdIDogIiI7CiAgfQogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBQcmludCBhIHdhcm5pbmcgbWVzc2FnZSBpZiB0aGUgQ29ubmVjdCBjb3JlIGlzIG5vdCBpbml0aWFsaXplZC4KICAgICovCiAgY29ubmVjdC5jb3JlLmNoZWNrTm90SW5pdGlhbGl6ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoY29ubmVjdC5jb3JlLmluaXRpYWxpemVkKSB7CiAgICAgIHZhciBsb2cgPSBjb25uZWN0LmdldExvZygpOwogICAgICBsb2cud2FybigiQ29ubmVjdCBjb3JlIGFscmVhZHkgaW5pdGlhbGl6ZWQsIG9ubHkgbmVlZHMgdG8gYmUgaW5pdGlhbGl6ZWQgb25jZS4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH07CiAKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIERJU0FTVEVSIFJFQ09WRVJZIAogICovCiAgCiAgdmFyIG1ha2VBZ2VudE9mZmxpbmUgPSBmdW5jdGlvbihhZ2VudCwgY2FsbGJhY2tzKSB7CiAgICB2YXIgb2ZmbGluZVN0YXRlID0gYWdlbnQuZ2V0QWdlbnRTdGF0ZXMoKS5maW5kKGZ1bmN0aW9uIChzdGF0ZSkgewogICAgICByZXR1cm4gc3RhdGUudHlwZSA9PT0gY29ubmVjdC5BZ2VudFN0YXRlVHlwZS5PRkZMSU5FOwogICAgfSk7CiAgICBhZ2VudC5zZXRTdGF0ZShvZmZsaW5lU3RhdGUsIGNhbGxiYWNrcyk7ICAgCiAgfQogCiAgLy8gU3VwcHJlc3MgQ29udGFjdHMgZnVuY3Rpb24gCiAgLy8gVGhpcyBpcyB1c2VkIGJ5IERpc2FzdGVyIFJlY292ZXJ5IGFzIGEgc2FmZWd1YXJkIHRvIG5vdCBzdXJmYWNlIGluY29taW5nIGNhbGxzL2NoYXRzIHRvIFVJCiAgLy8gCiAgdmFyIHN1cHByZXNzQ29udGFjdHMgPSBmdW5jdGlvbiAoaXNTdXBwcmVzc2VkKSB7CiAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gU2lnbmFsIHNoYXJlZHdvcmtlciB0byBzZXQgY29udGFjdHMgc3VwcHJlc3NvciB0byAlcyBmb3IgaW5zdGFuY2UgJXMuIiwgCiAgICAgIGlzU3VwcHJlc3NlZCwgY29ubmVjdC5jb3JlLnJlZ2lvbgogICAgKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5TVVBQUkVTUywgewogICAgICBzdXBwcmVzczogaXNTdXBwcmVzc2VkCiAgICB9KTsKICB9CiAKICB2YXIgc2V0Rm9yY2VPZmZsaW5lVXBzdHJlYW0gPSBmdW5jdGlvbihvZmZsaW5lKSB7CiAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltESVNBU1RFUiBSRUNPVkVSWV0gU2lnbmFsIHNoYXJlZHdvcmtlciB0byBzZXQgZm9yY2VPZmZsaW5lIHRvICVzIGZvciBpbnN0YW5jZSAlcy4iLCAKICAgICAgb2ZmbGluZSwgY29ubmVjdC5jb3JlLnJlZ2lvbgogICAgKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GT1JDRV9PRkZMSU5FLCB7CiAgICAgIG9mZmxpbmU6IG9mZmxpbmUKICAgIH0pOwogIH0KIAogIC8vIEZvcmNlIHRoZSBpbnN0YW5jZSB0byBiZSBvZmZsaW5lLiAKICAvLyBUaGlzIHRyaWVzIHRvIGRpc2Nvbm5lY3QgYWxsIGNvbnRhY3RzIChIYXJkIHN0b3ApCiAgLy8gaWYgZHVlIHRvIGEgZmFpbHVyZSAodGhlIGJhY2tlbmQgaXMgbm90IHJlYWNoYWJsZSksIHNpZ25hbCB0aGUgc2hhcmVkIHdvcmtlciB0byBmb3JjZV9vZmZsaW5lIHdoZW4gaXQgd2FrZXMgdXAgYWdhaW4KICAvLyBUaGlzIGZ1bmN0aW9uIHNob3VsZCBvbmx5IGJlIHJhbiBmcm9tIG5hdGl2ZSBDQ1AgZm9yIGRpc2Nvbm5lY3RpbmcgY2hhdHMuCiAgdmFyIGZvcmNlT2ZmbGluZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGxvZyA9IGNvbm5lY3QuZ2V0TG9nKCk7CiAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBBdHRlbXB0aW5nIHRvIGZvcmNlIGluc3RhbmNlICVzIG9mZmxpbmUiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbihhZ2VudCkgewogICAgICB2YXIgY29udGFjdENsb3NlZCA9IDA7CiAgICAgIHZhciBjb250YWN0cyA9IGFnZW50LmdldENvbnRhY3RzKCk7CiAgICAgIGlmIChjb250YWN0cy5sZW5ndGgpIHsKICAgICAgICBjb250YWN0cy5mb3JFYWNoKGZ1bmN0aW9uKGNvbnRhY3QpIAogICAgICAgICAgewogICAgICAgICAgICBjb250YWN0LmdldEFnZW50Q29ubmVjdGlvbigpLmRlc3Ryb3koewogICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgLy8gY2hlY2sgaWYgYWxsIGFjdGl2ZSBjb250YWN0cyBhcmUgY2xvc2VkCiAgICAgICAgICAgICAgICBpZiAoKytjb250YWN0Q2xvc2VkID09PSBjb250YWN0cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgc2V0Rm9yY2VPZmZsaW5lVXBzdHJlYW0oZmFsc2UpOwogICAgICAgICAgICAgICAgICAvLyBJdCdzIG9rIGlmIHdlJ3JlIG5vdCBhYmxlIHRvIHB1dCB0aGUgYWdlbnQgb2ZmbGluZS4gCiAgICAgICAgICAgICAgICAgIC8vIHNpbmNlIHdlJ3JlIHN1cHByZXNzaW5nIHRoZSBhZ2VudHMgY29udGFjdHMgYWxyZWFkeS4gCiAgICAgICAgICAgICAgICAgIG1ha2VBZ2VudE9mZmxpbmUoYWdlbnQpOwogICAgICAgICAgICAgICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBJbnN0YW5jZSAlcyBpcyBub3cgb2ZmbGluZSIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICAgIGxvZy53YXJuKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIEFuIGVycm9yIG9jY3VyZWQgd2hpbGUgYXR0ZW1wdGluZyB0byBmb3JjZSB0aGlzIGluc3RhbmNlIHRvIG9mZmxpbmUgaW4gcmVnaW9uICVzIiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIGxvZy53YXJuKGVycikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIC8vIHNpZ25hbCB0aGUgc2hhcmVkd29ya2VyIHRvIGNhbGwgZm9yY2VPZmZsaW5lIGFnYWluIHdoZW4gbmV0d29yayBjb25uZWN0aW9uIAogICAgICAgICAgICAgICAgLy8gaGFzIGJlZW4gcmUtZXN0YWJsaXNoZWQgKHRoaXMgaGFwcGVucyBpbiBjYXNlIG9mIG5ldHdvcmsgb3IgYmFja2VuZCBmYWlsdXJlcykKICAgICAgICAgICAgICAgIHNldEZvcmNlT2ZmbGluZVVwc3RyZWFtKHRydWUpOwogICAgICAgICAgICB9fSk7CiAgICAgICAgICB9CiAgICAgICAgKSAgICAgICAgCiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0Rm9yY2VPZmZsaW5lVXBzdHJlYW0oZmFsc2UpOwogICAgICAgIG1ha2VBZ2VudE9mZmxpbmUoYWdlbnQpOwogICAgICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIEluc3RhbmNlICVzIGlzIG5vdyBvZmZsaW5lIiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfSk7CiAgfQogCiAgLy9Jbml0aWF0ZSBEaXNhc3RlciBSZWNvdmVyeSAoVGhpcyBzaG91bGQgb25seSBiZSBjYWxsZWQgZnJvbSBjdXN0b21DQ1AgdGhhdCBhcmUgRFIgZW5hYmxlZCkKICBjb25uZWN0LmNvcmUuaW5pdERpc2FzdGVyUmVjb3ZlcnkgPSBmdW5jdGlvbihwYXJhbXMpIHsKICAgIHZhciBsb2cgPSBjb25uZWN0LmdldExvZygpOwogICAgY29ubmVjdC5jb3JlLnJlZ2lvbiA9IHBhcmFtcy5yZWdpb247CiAgICBjb25uZWN0LmNvcmUuc3VwcHJlc3NDb250YWN0cyA9IHN1cHByZXNzQ29udGFjdHM7ICAKICAgIGNvbm5lY3QuY29yZS5mb3JjZU9mZmxpbmUgPSBmb3JjZU9mZmxpbmU7CgogICAgLy9SZWdpc3RlciBpZnJhbWUgbGlzdG5lciB0byBzZXQgbmF0aXZlIENDUCBvZmZsaW5lCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vbkRvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLlNFVF9PRkZMSU5FLCBmdW5jdGlvbigpIHsKICAgICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSgpOwogICAgfSk7CiAKICAgIC8vIFJlZ2lzdGVyIEV2ZW50IGxpc3RuZXIgdG8gRm9yY2UgdGhlIEFnZW50IHRvIGJlIG9mZmxpbmUgd2hlbiBzaGFyZWQgd29ya2VyIHJlY292ZXJzIGZyb20gbmV0d29yayBmYWlsdXJlCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GT1JDRV9PRkZMSU5FLCBmdW5jdGlvbigpIHsKICAgICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSgpOwogICAgfSk7CgogICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUsIAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBJbml0aWFsaXppbmcgcmVnaW9uICVzIGFzIHBhcnQgb2YgYSBEaXNhc3RlciBSZWNvdmVyeSBmbGVldCIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0sIAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSAlcyBhbHJlYWR5IHBhcnQgb2YgYSBEaXNhc3RlciBSZWNvdmVyeSBmbGVldCIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0pOwoKICAgIGlmICghcGFyYW1zLmlzUHJpbWFyeSkgewogICAgICBjb25uZWN0LmNvcmUuc3VwcHJlc3NDb250YWN0cyh0cnVlKTsKICAgICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSgpOwogICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSAlcyBpbnN0YW5jZSBpcyBzZXQgdG8gc3RhbmQtYnkiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfSBlbHNlIHsKICAgICAgY29ubmVjdC5jb3JlLnN1cHByZXNzQ29udGFjdHMoZmFsc2UpOwogICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSAlcyBpbnN0YW5jZSBpcyBzZXQgdG8gcHJpbWFyeSIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfQogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEJhc2ljIENvbm5lY3QgY2xpZW50IGluaXRpYWxpemF0aW9uLgogICAqIFNob3VsZCBiZSB1c2VkIG9ubHkgYnkgdGhlIEFQSSBTaGFyZWQgV29ya2VyLgogICAqLwogIGNvbm5lY3QuY29yZS5pbml0ID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5jb3JlLmV2ZW50QnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoKTsKICAgIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlciA9IG5ldyBBZ2VudERhdGFQcm92aWRlcihjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKSk7CiAgICBjb25uZWN0LmNvcmUuaW5pdENsaWVudChwYXJhbXMpOwogICAgY29ubmVjdC5jb3JlLmluaXRBZ2VudEFwcENsaWVudChwYXJhbXMpOwogICAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gdHJ1ZTsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEluaXRpYWxpemVkIEFXUyBjbGllbnQKICAgKiBTaG91bGQgYmUgdXNlZCBieSBTaGFyZWQgV29ya2VyIHRvIHVwZGF0ZSBBV1MgY2xpZW50IHdpdGggbmV3IGNyZWRlbnRpYWxzCiAgICogYWZ0ZXIgcmVmcmVzaGVkIGF1dGhlbnRpY2F0aW9uLgogICAqLwogIGNvbm5lY3QuY29yZS5pbml0Q2xpZW50ID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcywgJ3BhcmFtcycpOwogICAgCiAgICB2YXIgYXV0aFRva2VuID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5hdXRoVG9rZW4sICdwYXJhbXMuYXV0aFRva2VuJyk7CiAgICB2YXIgcmVnaW9uID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5yZWdpb24sICdwYXJhbXMucmVnaW9uJyk7CiAgICB2YXIgZW5kcG9pbnQgPSBwYXJhbXMuZW5kcG9pbnQgfHwgbnVsbDsKIAogICAgY29ubmVjdC5jb3JlLmNsaWVudCA9IG5ldyBjb25uZWN0LkFXU0NsaWVudChhdXRoVG9rZW4sIHJlZ2lvbiwgZW5kcG9pbnQpOwogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJbml0aWFsaXplZCBBZ2VudEFwcCBjbGllbnQKICAgKiBTaG91bGQgYmUgdXNlZCBieSBTaGFyZWQgV29ya2VyIHRvIHVwZGF0ZSBBZ2VudEFwcCBjbGllbnQgd2l0aCBuZXcgY3JlZGVudGlhbHMKICAgKiBhZnRlciByZWZyZXNoZWQgYXV0aGVudGljYXRpb24uCiAgICovCiAgY29ubmVjdC5jb3JlLmluaXRBZ2VudEFwcENsaWVudCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMsICdwYXJhbXMnKTsgICAgCiAgICB2YXIgYXV0aFRva2VuID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5hdXRoVG9rZW4sICdwYXJhbXMuYXV0aFRva2VuJyk7CiAgICB2YXIgYXV0aENvb2tpZU5hbWUgPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmF1dGhDb29raWVOYW1lLCAncGFyYW1zLmF1dGhDb29raWVOYW1lJyk7CiAgICB2YXIgZW5kcG9pbnQgPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmFnZW50QXBwRW5kcG9pbnQsICdwYXJhbXMuYWdlbnRBcHBFbmRwb2ludCcpOwogICAgCiAgICBjb25uZWN0LmNvcmUuYWdlbnRBcHBDbGllbnQgPSBuZXcgY29ubmVjdC5BZ2VudEFwcENsaWVudChhdXRoQ29va2llTmFtZSwgYXV0aFRva2VuLCBlbmRwb2ludCk7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBVbmluaXRpYWxpemUgQ29ubmVjdC4KICAgKi8KICBjb25uZWN0LmNvcmUudGVybWluYXRlID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5jb3JlLmNsaWVudCA9IG5ldyBjb25uZWN0Lk51bGxDbGllbnQoKTsKICAgIGNvbm5lY3QuY29yZS5hZ2VudEFwcENsaWVudCA9IG5ldyBjb25uZWN0Lk51bGxDbGllbnQoKTsKICAgIGNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQgPSBuZXcgY29ubmVjdC5OdWxsQ2xpZW50KCk7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBpZiAoYnVzKSBidXMudW5zdWJzY3JpYmVBbGwoKTsKICAgIGNvbm5lY3QuY29yZS5idXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cygpOwogICAgY29ubmVjdC5jb3JlLmFnZW50RGF0YVByb3ZpZGVyID0gbnVsbDsKICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyID0gbnVsbDsKICAgIGNvbm5lY3QuY29yZS51cHN0cmVhbSA9IG51bGw7CiAgICBjb25uZWN0LmNvcmUua2VlcGFsaXZlTWFuYWdlciA9IG51bGw7CiAgICBjb25uZWN0LmFnZW50LmluaXRpYWxpemVkID0gZmFsc2U7CiAgICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSBmYWxzZTsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIFNldHVwIHRoZSBTb2Z0cGhvbmVNYW5hZ2VyIHRvIGJlIGluaXRpYWxpemVkIHdoZW4gdGhlIGFnZW50CiAgICogaXMgZGV0ZXJtaW5lZCB0byBoYXZlIHNvZnRwaG9uZSBlbmFibGVkLgogICAqLwogIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0gPSBudWxsOwogCiAgY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuc29mdHBob25lVXNlck1lZGlhU3RyZWFtOwogIH07CiAKICBjb25uZWN0LmNvcmUuc2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtID0gZnVuY3Rpb24gKHN0cmVhbSkgewogICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSA9IHN0cmVhbTsKICB9OwogCiAgY29ubmVjdC5jb3JlLmluaXRSaW5ndG9uZUVuZ2luZXMgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAicGFyYW1zIik7CiAKICAgIHZhciBzZXR1cFJpbmd0b25lRW5naW5lcyA9IGZ1bmN0aW9uIChyaW5ndG9uZVNldHRpbmdzKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChyaW5ndG9uZVNldHRpbmdzLCAicmluZ3RvbmVTZXR0aW5ncyIpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmluZ3RvbmVTZXR0aW5ncy52b2ljZSwgInJpbmd0b25lU2V0dGluZ3Mudm9pY2UiKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKHJpbmd0b25lU2V0dGluZ3Mudm9pY2UucmluZ3RvbmVVcmwgfHwgcmluZ3RvbmVTZXR0aW5ncy52b2ljZS5kaXNhYmxlZCwgInJpbmd0b25lU2V0dGluZ3Mudm9pY2UucmluZ3RvbmVVcmwgbXVzdCBiZSBwcm92aWRlZCBvciByaW5ndG9uZVNldHRpbmdzLnZvaWNlLmRpc2FibGVkIG11c3QgYmUgdHJ1ZSIpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjaywgInJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2siKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2sucmluZ3RvbmVVcmwgfHwgcmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjay5kaXNhYmxlZCwgInJpbmd0b25lU2V0dGluZ3Mudm9pY2UucmluZ3RvbmVVcmwgbXVzdCBiZSBwcm92aWRlZCBvciByaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrLmRpc2FibGVkIG11c3QgYmUgdHJ1ZSIpOwogCiAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMgPSB7fTsKIAogICAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uIChhZ2VudCkgewogICAgICAgIGFnZW50Lm9uUmVmcmVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlJJTkdUT05FLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICghcmluZ3RvbmVTZXR0aW5ncy52b2ljZS5kaXNhYmxlZCAmJiAhY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy52b2ljZSkgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMudm9pY2UgPQogICAgICAgICAgICAgICAgbmV3IGNvbm5lY3QuVm9pY2VSaW5ndG9uZUVuZ2luZShyaW5ndG9uZVNldHRpbmdzLnZvaWNlKTsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlZvaWNlUmluZ3RvbmVFbmdpbmUgaW5pdGlhbGl6ZWQuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQogCiAgICAgICAgICAgIGlmICghcmluZ3RvbmVTZXR0aW5ncy5jaGF0LmRpc2FibGVkICYmICFjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLmNoYXQpIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLmNoYXQgPQogICAgICAgICAgICAgICAgbmV3IGNvbm5lY3QuQ2hhdFJpbmd0b25lRW5naW5lKHJpbmd0b25lU2V0dGluZ3MuY2hhdCk7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJDaGF0UmluZ3RvbmVFbmdpbmUgaW5pdGlhbGl6ZWQuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQogCiAgICAgICAgICAgIGlmICghcmluZ3RvbmVTZXR0aW5ncy50YXNrLmRpc2FibGVkICYmICFjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnRhc2spIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnRhc2sgPQogICAgICAgICAgICAgICAgbmV3IGNvbm5lY3QuVGFza1Jpbmd0b25lRW5naW5lKHJpbmd0b25lU2V0dGluZ3MudGFzayk7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlRhc2tSaW5ndG9uZUVuZ2luZSBpbml0aWFsaXplZC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB9CiAKICAgICAgICAgICAgaWYgKCFyaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrLmRpc2FibGVkICYmICFjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnF1ZXVlX2NhbGxiYWNrKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5xdWV1ZV9jYWxsYmFjayA9CiAgICAgICAgICAgICAgICBuZXcgY29ubmVjdC5RdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUocmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjayk7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUgaW5pdGlhbGl6ZWQuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgICAgaGFuZGxlUmluZ2VyRGV2aWNlQ2hhbmdlKCk7CiAgICB9OwogCiAgICB2YXIgbWVyZ2VQYXJhbXMgPSBmdW5jdGlvbiAocGFyYW1zLCBvdGhlclBhcmFtcykgewogICAgICAvLyBGb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHk6IHN1cHBvcnQgcHVsbGluZyBkaXNhYmxlZCBmbGFnIGFuZCByaW5ndG9uZVVybAogICAgICAvLyBmcm9tIHNvZnRwaG9uZSBjb25maWcgaWYgaXQgZXhpc3RzIGZyb20gZG93bnN0cmVhbSBpbnRvIHRoZSByaW5ndG9uZSBjb25maWcuCiAgICAgIHBhcmFtcy5yaW5ndG9uZSA9IHBhcmFtcy5yaW5ndG9uZSB8fCB7fTsKICAgICAgcGFyYW1zLnJpbmd0b25lLnZvaWNlID0gcGFyYW1zLnJpbmd0b25lLnZvaWNlIHx8IHt9OwogICAgICBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2sgPSBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2sgfHwge307CiAgICAgIHBhcmFtcy5yaW5ndG9uZS5jaGF0ID0gcGFyYW1zLnJpbmd0b25lLmNoYXQgfHwgeyBkaXNhYmxlZDogdHJ1ZSB9OwogICAgICBwYXJhbXMucmluZ3RvbmUudGFzayA9IHBhcmFtcy5yaW5ndG9uZS50YXNrIHx8IHsgZGlzYWJsZWQ6IHRydWUgfTsKIAogICAgICBpZiAob3RoZXJQYXJhbXMuc29mdHBob25lKSB7CiAgICAgICAgaWYgKG90aGVyUGFyYW1zLnNvZnRwaG9uZS5kaXNhYmxlUmluZ3RvbmUpIHsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS52b2ljZS5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2suZGlzYWJsZWQgPSB0cnVlOwogICAgICAgIH0KIAogICAgICAgIGlmIChvdGhlclBhcmFtcy5zb2Z0cGhvbmUucmluZ3RvbmVVcmwpIHsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS52b2ljZS5yaW5ndG9uZVVybCA9IG90aGVyUGFyYW1zLnNvZnRwaG9uZS5yaW5ndG9uZVVybDsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS5xdWV1ZV9jYWxsYmFjay5yaW5ndG9uZVVybCA9IG90aGVyUGFyYW1zLnNvZnRwaG9uZS5yaW5ndG9uZVVybDsKICAgICAgICB9CiAgICAgIH0KIAogICAgICBpZiAob3RoZXJQYXJhbXMuY2hhdCkgewogICAgICAgIGlmIChvdGhlclBhcmFtcy5jaGF0LmRpc2FibGVSaW5ndG9uZSkgewogICAgICAgICAgcGFyYW1zLnJpbmd0b25lLmNoYXQuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgIH0KIAogICAgICAgIGlmIChvdGhlclBhcmFtcy5jaGF0LnJpbmd0b25lVXJsKSB7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUuY2hhdC5yaW5ndG9uZVVybCA9IG90aGVyUGFyYW1zLmNoYXQucmluZ3RvbmVVcmw7CiAgICAgICAgfQogICAgICB9CiAKICAgICAgLy8gTWVyZ2UgaW4gcmluZ3RvbmUgc2V0dGluZ3MgZnJvbSBkb3duc3RyZWFtLgogICAgICBpZiAob3RoZXJQYXJhbXMucmluZ3RvbmUpIHsKICAgICAgICBwYXJhbXMucmluZ3RvbmUudm9pY2UgPSBjb25uZWN0Lm1lcmdlKHBhcmFtcy5yaW5ndG9uZS52b2ljZSwKICAgICAgICAgIG90aGVyUGFyYW1zLnJpbmd0b25lLnZvaWNlIHx8IHt9KTsKICAgICAgICBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2sgPSBjb25uZWN0Lm1lcmdlKHBhcmFtcy5yaW5ndG9uZS5xdWV1ZV9jYWxsYmFjaywKICAgICAgICAgIG90aGVyUGFyYW1zLnJpbmd0b25lLnZvaWNlIHx8IHt9KTsKICAgICAgICBwYXJhbXMucmluZ3RvbmUuY2hhdCA9IGNvbm5lY3QubWVyZ2UocGFyYW1zLnJpbmd0b25lLmNoYXQsCiAgICAgICAgICBvdGhlclBhcmFtcy5yaW5ndG9uZS5jaGF0IHx8IHt9KTsKICAgICAgfQogICAgfTsKIAogICAgLy8gTWVyZ2UgcGFyYW1zIGZyb20gcGFyYW1zLnNvZnRwaG9uZSBhbmQgcGFyYW1zLmNoYXQgaW50byBwYXJhbXMucmluZ3RvbmUKICAgIC8vIGZvciBlbWJlZGRlZCBhbmQgbm9uLWVtYmVkZGVkIHVzZSBjYXNlcyBzbyB0aGF0IGRlZmF1bHRzIGFyZSBwaWNrZWQgdXAuCiAgICBtZXJnZVBhcmFtcyhwYXJhbXMsIHBhcmFtcyk7CiAKICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkpIHsKICAgICAgLy8gSWYgdGhlIENDUCBpcyBpbiBhIGZyYW1lLCB3YWl0IGZvciBjb25maWd1cmF0aW9uIGZyb20gZG93bnN0cmVhbS4KICAgICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgLy8gTWVyZ2UgYWxsIHBhcmFtcyBmcm9tIGRhdGEgaW50byBwYXJhbXMgZm9yIGFueSBvdmVycmlkZGVuCiAgICAgICAgLy8gdmFsdWVzIGluIGVpdGhlciBsZWdhY3kgInNvZnRwaG9uZSIgb3IgInJpbmd0b25lIiBzZXR0aW5ncy4KICAgICAgICBtZXJnZVBhcmFtcyhwYXJhbXMsIGRhdGEpOwogICAgICAgIHNldHVwUmluZ3RvbmVFbmdpbmVzKHBhcmFtcy5yaW5ndG9uZSk7CiAgICAgIH0pOwogCiAgICB9IGVsc2UgewogICAgICBzZXR1cFJpbmd0b25lRW5naW5lcyhwYXJhbXMucmluZ3RvbmUpOwogICAgfQogIH07CgogIHZhciBoYW5kbGVSaW5nZXJEZXZpY2VDaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9SSU5HRVJfREVWSUNFLCBzZXRSaW5nZXJEZXZpY2UpOwogIH0KCiAgdmFyIHNldFJpbmdlckRldmljZSA9IGZ1bmN0aW9uIChkYXRhKXsKICAgIGlmKGNvbm5lY3Qua2V5cyhjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzKS5sZW5ndGggPT09IDAgfHwgIWRhdGEgfHwgIWRhdGEuZGV2aWNlSWQpewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgZGV2aWNlSWQgPSBkYXRhLmRldmljZUlkOwogICAgZm9yICh2YXIgcmluZ3RvbmVUeXBlIGluIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMpIHsKICAgICAgY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lc1tyaW5ndG9uZVR5cGVdLnNldE91dHB1dERldmljZShkZXZpY2VJZCk7CiAgICB9CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlJJTkdFUl9ERVZJQ0VfQ0hBTkdFRCwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfQoKICBjb25uZWN0LmNvcmUuaW5pdFNvZnRwaG9uZU1hbmFnZXIgPSBmdW5jdGlvbiAocGFyYW1zSW4pIHsKICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW1NvZnRwaG9uZSBNYW5hZ2VyXSBpbml0U29mdHBob25lTWFuYWdlciBzdGFydGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKIAogICAgdmFyIGNvbXBldGVGb3JNYXN0ZXJPbkFnZW50VXBkYXRlID0gZnVuY3Rpb24gKHNvZnRwaG9uZVBhcmFtc0luKSB7CiAgICAgIHZhciBzb2Z0cGhvbmVQYXJhbXMgPSBjb25uZWN0Lm1lcmdlKHBhcmFtcy5zb2Z0cGhvbmUgfHwge30sIHNvZnRwaG9uZVBhcmFtc0luKTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbU29mdHBob25lIE1hbmFnZXJdIGNvbXBldGVGb3JNYXN0ZXJPbkFnZW50VXBkYXRlIGV4ZWN1dGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbiAoYWdlbnQpIHsKICAgICAgICBpZiAoIWFnZW50LmdldENoYW5uZWxDb25jdXJyZW5jeShjb25uZWN0LkNoYW5uZWxUeXBlLlZPSUNFKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBhZ2VudC5vblJlZnJlc2goZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIHN1YiA9IHRoaXM7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gYWdlbnQgcmVmcmVzaCBoYW5kbGVyIGV4ZWN1dGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKIAogICAgICAgICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbU29mdHBob25lIE1hbmFnZXJdIGNvbmZpcm1lZCBhcyBzb2Z0cGhvbmUgbWFzdGVyIHRvcGljIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgaWYgKCFjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciAmJiBhZ2VudC5pc1NvZnRwaG9uZUVuYWJsZWQoKSkgewogICAgICAgICAgICAgIC8vIEJlY29tZSBtYXN0ZXIgdG8gc2VuZCBsb2dzLCBzaW5jZSB3ZSBuZWVkIGxvZ3MgZnJvbSBzb2Z0cGhvbmUgdGFiLgogICAgICAgICAgICAgIGNvbm5lY3QuYmVjb21lTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNFTkRfTE9HUyk7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIgPSBuZXcgY29ubmVjdC5Tb2Z0cGhvbmVNYW5hZ2VyKHNvZnRwaG9uZVBhcmFtcyk7CiAgICAgICAgICAgICAgc3ViLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH07CiAKICAgIC8qKgogICAgICogSWYgdGhlIHdpbmRvdyBpcyBmcmFtZWQsIHdlIG5lZWQgdG8gd2FpdCBmb3IgYSBDT05GSUdVUkUgbWVzc2FnZSBmcm9tCiAgICAgKiBkb3duc3RyZWFtIGJlZm9yZSB3ZSB0cnkgdG8gaW5pdGlhbGl6ZSwgdW5sZXNzIHBhcmFtcy5hbGxvd0ZyYW1lZFNvZnRwaG9uZSBpcyB0cnVlLgogICAgICovCiAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpICYmICFwYXJhbXMuYWxsb3dGcmFtZWRTb2Z0cGhvbmUpIHsKICAgICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gQ29uZmlndXJlIGV2ZW50IGhhbmRsZXIgZXhlY3V0ZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGlmIChkYXRhLnNvZnRwaG9uZSAmJiBkYXRhLnNvZnRwaG9uZS5hbGxvd0ZyYW1lZFNvZnRwaG9uZSkgewogICAgICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwogICAgICAgICAgY29tcGV0ZUZvck1hc3Rlck9uQWdlbnRVcGRhdGUoZGF0YS5zb2Z0cGhvbmUpOwogICAgICAgICAgCiAgICAgICAgfQogICAgICAgIHNldHVwRXZlbnRMaXN0ZW5lcnNGb3JNdWx0aVRhYlVzZUluRmlyZWZveChkYXRhLnNvZnRwaG9uZSk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgY29tcGV0ZUZvck1hc3Rlck9uQWdlbnRVcGRhdGUocGFyYW1zKTsKICAgICAgc2V0dXBFdmVudExpc3RlbmVyc0Zvck11bHRpVGFiVXNlSW5GaXJlZm94KHBhcmFtcyk7CiAgICB9CiAKICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24gKGFnZW50KSB7CiAgICAgIC8vIFN5bmMgbXV0ZSBhY3Jvc3MgYWxsIHRhYnMgCiAgICAgIGlmIChhZ2VudC5pc1NvZnRwaG9uZUVuYWJsZWQoKSAmJiBhZ2VudC5nZXRDaGFubmVsQ29uY3VycmVuY3koY29ubmVjdC5DaGFubmVsVHlwZS5WT0lDRSkpIHsKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULAogICAgICAgICAgewogICAgICAgICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuTVVURQogICAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwoKICAgIGZ1bmN0aW9uIHNldHVwRXZlbnRMaXN0ZW5lcnNGb3JNdWx0aVRhYlVzZUluRmlyZWZveChzb2Z0cGhvbmVQYXJhbXNJbikgewogICAgICB2YXIgc29mdHBob25lUGFyYW1zID0gY29ubmVjdC5tZXJnZShwYXJhbXMuc29mdHBob25lIHx8IHt9LCBzb2Z0cGhvbmVQYXJhbXNJbik7CgogICAgICAvLyBrZWVwIHRoZSBzb2Z0cGhvbmUgcGFyYW1zIGZvciBleHRlcm5hbCB1c2UKICAgICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZVBhcmFtcyA9IHNvZnRwaG9uZVBhcmFtczsKCiAgICAgIGlmIChjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIoKSkgewogICAgICAgIC8vIEluIEZpcmVmb3gsIHdoZW4gYSB0YWIgdGFrZXMgb3ZlciBhbm90aGVyIHRhYidzIHNvZnRwaG9uZSBwcmltYXJ5LAogICAgICAgIC8vIHRoZSBwcmV2aW91cyBwcmltYXJ5IHRhYiBzaG91bGQgZGVsZXRlIHNvZnBob25lIG1hbmFnZXIgYW5kIHN0b3AgbWljcm9waG9uZQogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFU1BPTlNFLCBmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgICBpZiAocmVzLmRhdGEgJiYgcmVzLmRhdGEudG9waWMgPT09IGNvbm5lY3QuTWFzdGVyVG9waWNzLlNPRlRQSE9ORSAmJiByZXMuZGF0YS50YWtlT3ZlciAmJiAocmVzLmRhdGEubWFzdGVySWQgIT09IGNvbm5lY3QuY29yZS5wb3J0U3RyZWFtSWQpKSB7CiAgICAgICAgICAgIGlmIChjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlcikgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyLm9uSW5pdENvbnRhY3RTdWIudW5zdWJzY3JpYmUoKTsKICAgICAgICAgICAgICBkZWxldGUgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHVzZXJNZWRpYVN0cmVhbSA9IGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0oKTsKICAgICAgICAgICAgaWYgKHVzZXJNZWRpYVN0cmVhbSkgewogICAgICAgICAgICAgIHVzZXJNZWRpYVN0cmVhbS5nZXRUcmFja3MoKS5mb3JFYWNoKGZ1bmN0aW9uKHRyYWNrKSB7IHRyYWNrLnN0b3AoKTsgfSk7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnNldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyBJbiBGaXJlZm94LCB3aGVuIG11bHRpcGxlIHRhYnMgYXJlIG9wZW4sCiAgICAgICAgLy8gd2VicnRjIHNlc3Npb24gaXMgbm90IHN0YXJ0ZWQgdW50aWwgUkVBRFlfVE9fU1RBUlRfU0VTU0lPTiBldmVudCBpcyB0cmlnZ2VyZWQKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlJFQURZX1RPX1NUQVJUX1NFU1NJT04sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU09GVFBIT05FLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmIChjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlcikgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyLnN0YXJ0U2Vzc2lvbigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGNvbm5lY3QuYmVjb21lTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNPRlRQSE9ORSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24gKGFnZW50KSB7CiAgICAgICAgICAgICAgICBpZiAoIWNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyICYmIGFnZW50LmlzU29mdHBob25lRW5hYmxlZCgpKSB7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuYmVjb21lTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNFTkRfTE9HUyk7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyID0gbmV3IGNvbm5lY3QuU29mdHBob25lTWFuYWdlcihzb2Z0cGhvbmVQYXJhbXMpOwogICAgICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlci5zdGFydFNlc3Npb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gaGFuZGxpbmcgb3V0Ym91bmQtY2FsbCBhbmQgYXV0by1hY2NlcHQgY2FzZXMgZm9yIHBlbmRpbmcgc2Vzc2lvbgogICAgICAgIGNvbm5lY3QuY29udGFjdChmdW5jdGlvbiAoYykgewogICAgICAgICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbiAoYWdlbnQpIHsKICAgICAgICAgICAgYy5vblJlZnJlc2goZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICBjb25uZWN0Lmhhc090aGVyQ29ubmVjdGVkQ0NQcygpICYmCiAgICAgICAgICAgICAgICBkb2N1bWVudC52aXNpYmlsaXR5U3RhdGUgPT09ICd2aXNpYmxlJyAmJgogICAgICAgICAgICAgICAgKGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5DT05ORUNUSU5HIHx8IGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5JTkNPTUlORykKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHZhciBpc091dEJvdW5kQ2FsbCA9IGNvbnRhY3QuaXNTb2Z0cGhvbmVDYWxsKCkgJiYgIWNvbnRhY3QuaXNJbmJvdW5kKCk7CiAgICAgICAgICAgICAgICB2YXIgaXNBdXRvQWNjZXB0RW5hYmxlZCA9IGNvbnRhY3QuaXNTb2Z0cGhvbmVDYWxsKCkgJiYgYWdlbnQuZ2V0Q29uZmlndXJhdGlvbigpLnNvZnRwaG9uZUF1dG9BY2NlcHQ7CiAgICAgICAgICAgICAgICB2YXIgaXNRdWV1ZWRDYWxsYmFjayA9IGNvbnRhY3QuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLlFVRVVFX0NBTExCQUNLOwogICAgICAgICAgICAgICAgaWYgKGlzT3V0Qm91bmRDYWxsIHx8IGlzQXV0b0FjY2VwdEVuYWJsZWQgfHwgaXNRdWV1ZWRDYWxsYmFjaykgewogICAgICAgICAgICAgICAgICBjb25uZWN0LmNvcmUudHJpZ2dlclJlYWR5VG9TdGFydFNlc3Npb25FdmVudCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH07CgogIC8vIHRyaWdnZXIgUkVBRFlfVE9fU1RBUlRfU0VTU0lPTiBldmVudCBpbiBhIGNvbnRleHQgd2l0aCBTb2Z0cGhvbmUgTWFuYWdlcgogIC8vIGludGVybmFsIHVzZSBvbmx5CiAgY29ubmVjdC5jb3JlLnRyaWdnZXJSZWFkeVRvU3RhcnRTZXNzaW9uRXZlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYWxsb3dGcmFtZWRTb2Z0cGhvbmUgPSBjb25uZWN0LmNvcmUuc29mdHBob25lUGFyYW1zICYmIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVQYXJhbXMuYWxsb3dGcmFtZWRTb2Z0cGhvbmU7CiAgICBpZiAoY29ubmVjdC5pc0NDUCgpKSB7CiAgICAgIGlmIChhbGxvd0ZyYW1lZFNvZnRwaG9uZSkgewogICAgICAgIC8vIHRoZSBldmVudCBpcyB0cmlnZ2VyZWQgaW4gdGhpcyBpZnJhbWVkIENDUCBjb250ZXh0CiAgICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuUkVBRFlfVE9fU1RBUlRfU0VTU0lPTik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSkgewogICAgICAgICAgLy8gaWYgdGhpcyBpcyBhbiBpZnJhbWVkIENDUCwgdGhlIGV2ZW50IGlzIHNlbmQgdG8gZG93bnN0cmVhbSAoQ1JNKQogICAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZERvd25zdHJlYW0oY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlJFQURZX1RPX1NUQVJUX1NFU1NJT04pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBpZiB0aGlzIGlzIGEgc3RhbmRhbG9uZSBDQ1AsIHRyaWdnZXIgdGhpcyBldmVudCBpbiB0aGlzIENDUCBjb250ZXh0CiAgICAgICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5SRUFEWV9UT19TVEFSVF9TRVNTSU9OKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChhbGxvd0ZyYW1lZFNvZnRwaG9uZSkgewogICAgICAgIC8vIHRoZSBldmVudCBpcyBzZW5kIHRvIHRoZSB1cHN0cmVhbSAoaWZyYW1lZCBDQ1ApCiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5SRUFEWV9UT19TVEFSVF9TRVNTSU9OKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyB0aGUgZXZlbnQgaXMgdHJpZ2dlcmVkIGluIHRoaXMgQ1JNIGNvbnRleHQKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5SRUFEWV9UT19TVEFSVF9TRVNTSU9OKTsKICAgICAgfQogICAgfQogIH07CgogIGNvbm5lY3QuY29yZS5pbml0UGFnZU9wdGlvbnMgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAicGFyYW1zIik7CiAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpKSB7CiAgICAgIC8vIElmIHRoZSBDQ1AgaXMgaW4gYSBmcmFtZSwgd2FpdCBmb3IgY29uZmlndXJhdGlvbiBmcm9tIGRvd25zdHJlYW0uCiAgICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwKICAgICAgICAgIHsKICAgICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5DT05GSUdVUkUsCiAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgIH0pOwogICAgICB9KTsKICAgICAgLy8gTGlzdGVuIGZvciBpZnJhbWUgbWVkaWEgZGV2aWNlcyByZXF1ZXN0IGZyb20gQ1JNCiAgICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuTUVESUFfREVWSUNFX1JFUVVFU1QsIGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBzZW5kRGV2aWNlcyhkZXZpY2VzKSB7CiAgICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5NRURJQV9ERVZJQ0VfUkVTUE9OU0UsIGRldmljZXMpOwogICAgICAgIH0KICAgICAgICBpZiAobmF2aWdhdG9yICYmIG5hdmlnYXRvci5tZWRpYURldmljZXMpIHsKICAgICAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZW51bWVyYXRlRGV2aWNlcygpCiAgICAgICAgICAudGhlbihmdW5jdGlvbiAoZGV2aWNlc0luKSB7CiAgICAgICAgICAgIGRldmljZXMgPSBkZXZpY2VzSW4gfHwgW107CiAgICAgICAgICAgIGRldmljZXMgPSBkZXZpY2VzLm1hcChmdW5jdGlvbihkKSB7IHJldHVybiBkLnRvSlNPTigpIH0pOwogICAgICAgICAgICBzZW5kRGV2aWNlcyhkZXZpY2VzKTsKICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICBzZW5kRGV2aWNlcyh7ZXJyb3I6IGVyci5tZXNzYWdlfSk7CiAgICAgICAgICB9KTsgCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbmREZXZpY2VzKHtlcnJvcjogIk5vIG5hdmlnYXRvciBvciBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzIG9iamVjdCBmb3VuZCJ9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBHZXQgdGhlIGxpc3Qgb2YgbWVkaWEgZGV2aWNlcyBmcm9tIGlmcmFtZWQgQ0NQCiAgICogVGltZW91dCBmb3IgdGhlIHJlcXVlc3QgaXMgcGFzc2VkIGFuIGFuIG9wdGlvbmFsIGFyZ3VtZW50CiAgICogVGhlIGRlZmF1bHQgdGltZW91dCBpcyAxMDAwbXMKICAgKi8KICBjb25uZWN0LmNvcmUuZ2V0RnJhbWVNZWRpYURldmljZXMgPSBmdW5jdGlvbiAodGltZW91dEluKSB7CiAgICB2YXIgc3ViID0gbnVsbDsKICAgIHZhciB0aW1lb3V0ID0gdGltZW91dEluIHx8IDEwMDA7CiAgICB2YXIgdGltZW91dFByb21pc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyAKICAgICAgICByZWplY3QobmV3IEVycm9yKCJUaW1lb3V0IGV4Y2VlZGVkIikpOyAKICAgICAgfSwgdGltZW91dCk7CiAgICB9KTsKICAgIHZhciBtZWRpYURldmljZXNQcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgeyAKICAgICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSB8fCBjb25uZWN0LmlzQ0NQKCkpIHsKICAgICAgICBpZiAobmF2aWdhdG9yICYmIG5hdmlnYXRvci5tZWRpYURldmljZXMpIHsKICAgICAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZW51bWVyYXRlRGV2aWNlcygpCiAgICAgICAgICAudGhlbihmdW5jdGlvbiAoZGV2aWNlc0luKSB7CiAgICAgICAgICAgIGRldmljZXMgPSBkZXZpY2VzSW4gfHwgW107CiAgICAgICAgICAgIGRldmljZXMgPSBkZXZpY2VzLm1hcChmdW5jdGlvbiAoZCkgeyByZXR1cm4gZC50b0pTT04oKSB9KTsKICAgICAgICAgICAgcmVzb2x2ZShkZXZpY2VzKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZWplY3QobmV3IEVycm9yKCJObyBuYXZpZ2F0b3Igb3IgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcyBvYmplY3QgZm91bmQiKSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgICAgICBzdWIgPSBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLk1FRElBX0RFVklDRV9SRVNQT05TRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLmVycm9yKSB7CiAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoZGF0YS5lcnJvcikpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTUVESUFfREVWSUNFX1JFUVVFU1QpOwogICAgICB9CiAgICB9KQogICAgcmV0dXJuIFByb21pc2UucmFjZShbbWVkaWFEZXZpY2VzUHJvbWlzZSwgdGltZW91dFByb21pc2VdKQogICAgLmZpbmFsbHkoZnVuY3Rpb24gKCkgewogICAgICBpZiAoc3ViKSB7CiAgICAgICAgc3ViLnVuc3Vic2NyaWJlKCk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgLy9JbnRlcm5hbCB1c2Ugb25seS4KICBjb25uZWN0LmNvcmUuYXV0aG9yaXplID0gZnVuY3Rpb24gKGVuZHBvaW50KSB7CiAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgY3JlZGVudGlhbHM6ICdpbmNsdWRlJwogICAgfTsKCiAgICB2YXIgYXV0aG9yaXplRW5kcG9pbnQgPSBlbmRwb2ludDsKICAgIGlmICghYXV0aG9yaXplRW5kcG9pbnQpIHsKICAgICAgYXV0aG9yaXplRW5kcG9pbnQgPSBjb25uZWN0LmNvcmUuaXNMZWdhY3lEb21haW4oKQogICAgICAgID8gTEVHQUNZX0FVVEhPUklaRV9FTkRQT0lOVAogICAgICAgIDogQVVUSE9SSVpFX0VORFBPSU5UOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuZmV0Y2goYXV0aG9yaXplRW5kcG9pbnQsIG9wdGlvbnMsIEFVVEhPUklaRV9SRVRSWV9JTlRFUlZBTCwgQVVUSE9SSVpFX01BWF9SRVRSWSk7CiAgfTsKIAogIC8qKgogICAqIEBkZXByZWNhdGVkCiAgICogVGhpcyB1c2VkIHRvIGJlIHVzZWQgaW50ZXJuYWxseSwgYnV0IGlzIG5vIGxvbmdlciBuZWVkZWQuCiAgICovCiAgY29ubmVjdC5jb3JlLnZlcmlmeURvbWFpbkFjY2VzcyA9IGZ1bmN0aW9uIChhdXRoVG9rZW4sIGVuZHBvaW50KSB7CiAgICBjb25uZWN0LmdldExvZygpLndhcm4oIlRoaXMgQVBJIHdpbGwgYmUgZGVwcmVjYXRlZCBpbiB0aGUgbmV4dCBtYWpvciB2ZXJzaW9uIHJlbGVhc2UiKTsKICAgIGlmICghY29ubmVjdC5pc0ZyYW1lZCgpKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTsKICAgIH0KICAgIHZhciBvcHRpb25zID0gewogICAgICBoZWFkZXJzOiB7CiAgICAgICAgJ1gtQW16LUJlYXJlcic6IGF1dGhUb2tlbgogICAgICB9CiAgICB9OwogICAgdmFyIHdoaXRlbGlzdGVkT3JpZ2luc0VuZHBvaW50ID0gbnVsbDsKICAgIGlmIChlbmRwb2ludCl7CiAgICAgIHdoaXRlbGlzdGVkT3JpZ2luc0VuZHBvaW50ID0gZW5kcG9pbnQ7CiAgICB9CiAgICBlbHNlIHsKICAgICAgd2hpdGVsaXN0ZWRPcmlnaW5zRW5kcG9pbnQgPSBjb25uZWN0LmNvcmUuaXNMZWdhY3lEb21haW4oKSAKICAgICAgICA/IExFR0FDWV9XSElURUxJU1RFRF9PUklHSU5TX0VORFBPSU5UCiAgICAgICAgOiBXSElURUxJU1RFRF9PUklHSU5TX0VORFBPSU5UOwogICAgfQogICAgCiAgICByZXR1cm4gY29ubmVjdC5mZXRjaCh3aGl0ZWxpc3RlZE9yaWdpbnNFbmRwb2ludCwgb3B0aW9ucywgV0hJVEVMSVNURURfT1JJR0lOU19SRVRSWV9JTlRFUlZBTCwgV0hJVEVMSVNURURfT1JJR0lOU19NQVhfUkVUUlkpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIHZhciB0b3BEb21haW4gPSBzYW5pdGl6ZURvbWFpbih3aW5kb3cuZG9jdW1lbnQucmVmZXJyZXIpOwogICAgICB2YXIgaXNBbGxvd2VkID0gcmVzcG9uc2Uud2hpdGVsaXN0ZWRPcmlnaW5zLnNvbWUoZnVuY3Rpb24gKG9yaWdpbikgewogICAgICAgIHJldHVybiB0b3BEb21haW4gPT09IHNhbml0aXplRG9tYWluKG9yaWdpbik7CiAgICAgIH0pOwogICAgICByZXR1cm4gaXNBbGxvd2VkID8gUHJvbWlzZS5yZXNvbHZlKCkgOiBQcm9taXNlLnJlamVjdCgpOwogICAgfSk7CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIFJldHVybnMgdHJ1ZSBpZiB0aGlzIHdpbmRvdydzIGhyZWYgaXMgb24gdGhlIGxlZ2FjeSBjb25uZWN0IGRvbWFpbi4gCiAgICogT25seSB1c2VmdWwgZm9yIGludGVybmFsIHVzZS4gCiAgICovCiAgY29ubmVjdC5jb3JlLmlzTGVnYWN5RG9tYWluID0gZnVuY3Rpb24odXJsKSB7CiAgICB1cmwgPSB1cmwgfHwgd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgICByZXR1cm4gdXJsLmluY2x1ZGVzKCcuYXdzYXBwcy5jb20nKTsKICB9CiAKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEluaXRpYWxpemVzIENvbm5lY3QgYnkgY3JlYXRpbmcgb3IgY29ubmVjdGluZyB0byB0aGUgQVBJIFNoYXJlZCBXb3JrZXIuCiAgICogVXNlZCBvbmx5IGJ5IHRoZSBDQ1AKICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdFNoYXJlZFdvcmtlciA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIGNvbm5lY3QuY29yZS5jaGVja05vdEluaXRpYWxpemVkKCk7CiAgICBpZiAoY29ubmVjdC5jb3JlLmluaXRpYWxpemVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMsICdwYXJhbXMnKTsKIAogICAgdmFyIHNoYXJlZFdvcmtlclVybCA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuc2hhcmVkV29ya2VyVXJsLCAncGFyYW1zLnNoYXJlZFdvcmtlclVybCcpOwogICAgdmFyIGF1dGhUb2tlbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuYXV0aFRva2VuLCAncGFyYW1zLmF1dGhUb2tlbicpOwogICAgdmFyIHJlZnJlc2hUb2tlbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMucmVmcmVzaFRva2VuLCAncGFyYW1zLnJlZnJlc2hUb2tlbicpOwogICAgdmFyIGF1dGhUb2tlbkV4cGlyYXRpb24gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmF1dGhUb2tlbkV4cGlyYXRpb24sICdwYXJhbXMuYXV0aFRva2VuRXhwaXJhdGlvbicpOwogICAgdmFyIHJlZ2lvbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMucmVnaW9uLCAncGFyYW1zLnJlZ2lvbicpOwogICAgdmFyIGVuZHBvaW50ID0gcGFyYW1zLmVuZHBvaW50IHx8IG51bGw7CiAgICB2YXIgYXV0aG9yaXplRW5kcG9pbnQgPSBwYXJhbXMuYXV0aG9yaXplRW5kcG9pbnQ7CiAgICBpZiAoIWF1dGhvcml6ZUVuZHBvaW50KSB7CiAgICAgIGF1dGhvcml6ZUVuZHBvaW50ID0gY29ubmVjdC5jb3JlLmlzTGVnYWN5RG9tYWluKCkKICAgICAgICA/IExFR0FDWV9BVVRIT1JJWkVfRU5EUE9JTlQKICAgICAgICA6IEFVVEhPUklaRV9FTkRQT0lOVDsKICAgIH0KICAgIHZhciBhZ2VudEFwcEVuZHBvaW50ID0gcGFyYW1zLmFnZW50QXBwRW5kcG9pbnQgfHwgbnVsbDsKICAgIHZhciBhdXRoQ29va2llTmFtZSA9IHBhcmFtcy5hdXRoQ29va2llTmFtZSB8fCBudWxsOwogCiAgICB0cnkgewogICAgICAvLyBJbml0aWFsaXplIHRoZSBldmVudCBidXMgYW5kIGFnZW50IGRhdGEgcHJvdmlkZXJzLgogICAgICBjb25uZWN0LmNvcmUuZXZlbnRCdXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cyh7IGxvZ0V2ZW50czogdHJ1ZSB9KTsKICAgICAgY29ubmVjdC5jb3JlLmFnZW50RGF0YVByb3ZpZGVyID0gbmV3IEFnZW50RGF0YVByb3ZpZGVyKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpKTsKICAgICAgY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeSA9IG5ldyBjb25uZWN0Lk1lZGlhRmFjdG9yeShwYXJhbXMpOwogICAgICAKICAgICAgLy8gQ3JlYXRlIHRoZSBzaGFyZWQgd29ya2VyIGFuZCB1cHN0cmVhbSBjb25kdWl0LgogICAgICB2YXIgd29ya2VyID0gbmV3IFNoYXJlZFdvcmtlcihzaGFyZWRXb3JrZXJVcmwsICJDb25uZWN0U2hhcmVkV29ya2VyIik7CiAgICAgIHZhciBjb25kdWl0ID0gbmV3IGNvbm5lY3QuQ29uZHVpdCgiQ29ubmVjdFNoYXJlZFdvcmtlckNvbmR1aXQiLAogICAgICAgIG5ldyBjb25uZWN0LlBvcnRTdHJlYW0od29ya2VyLnBvcnQpLAogICAgICAgIG5ldyBjb25uZWN0LldpbmRvd0lPU3RyZWFtKHdpbmRvdywgcGFyZW50KSk7CiAKICAgICAgLy8gU2V0IHRoZSBnbG9iYWwgdXBzdHJlYW0gY29uZHVpdCBmb3IgZXh0ZXJuYWwgdXNlLgogICAgICBjb25uZWN0LmNvcmUudXBzdHJlYW0gPSBjb25kdWl0OwogICAgICBjb25uZWN0LmNvcmUud2ViU29ja2V0UHJvdmlkZXIgPSBuZXcgV2ViU29ja2V0UHJvdmlkZXIoKTsKIAogICAgICAvLyBDbG9zZSBvdXIgcG9ydCB0byB0aGUgc2hhcmVkIHdvcmtlciBiZWZvcmUgdGhlIHdpbmRvdyBjbG9zZXMuCiAgICAgIGdsb2JhbC5vbnVubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5DTE9TRSk7CiAgICAgICAgd29ya2VyLnBvcnQuY2xvc2UoKTsKICAgICAgfTsKIAogICAgICBjb25uZWN0LmdldExvZygpLnNjaGVkdWxlVXBzdHJlYW1Mb2dQdXNoKGNvbmR1aXQpOwogICAgICBjb25uZWN0LmdldExvZygpLnNjaGVkdWxlRG93bnN0cmVhbUNsaWVudFNpZGVMb2dzUHVzaCgpOwogICAgICAvLyBCcmlkZ2UgYWxsIHVwc3RyZWFtIG1lc3NhZ2VzIGludG8gdGhlIGV2ZW50IGJ1cy4KICAgICAgY29uZHVpdC5vbkFsbFVwc3RyZWFtKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLmJyaWRnZSgpKTsKICAgICAgLy8gUGFzcyBhbGwgdXBzdHJlYW0gbWVzc2FnZXMgKGZyb20gc2hhcmVkIHdvcmtlcikgZG93bnN0cmVhbSAodG8gQ0NQIGNvbnN1bWVyKS4KICAgICAgY29uZHVpdC5vbkFsbFVwc3RyZWFtKGNvbmR1aXQucGFzc0Rvd25zdHJlYW0oKSk7CgogICAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpKSB7CiAgICAgICAgLy8gQnJpZGdlIGFsbCBkb3duc3RyZWFtIG1lc3NhZ2VzIGludG8gdGhlIGV2ZW50IGJ1cy4KICAgICAgICBjb25kdWl0Lm9uQWxsRG93bnN0cmVhbShjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5icmlkZ2UoKSk7CiAgICAgICAgLy8gUGFzcyBhbGwgZG93bnN0cmVhbSBtZXNzYWdlcyAoZnJvbSBDQ1AgY29uc3VtZXIpIHVwc3RyZWFtICh0byBzaGFyZWQgd29ya2VyKS4KICAgICAgICBjb25kdWl0Lm9uQWxsRG93bnN0cmVhbShjb25kdWl0LnBhc3NVcHN0cmVhbSgpKTsKICAgICAgfQogICAgICAvLyBTZW5kIGNvbmZpZ3VyYXRpb24gdXAgdG8gdGhlIHNoYXJlZCB3b3JrZXIuCiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgewogICAgICAgIGF1dGhUb2tlbjogYXV0aFRva2VuLAogICAgICAgIGF1dGhUb2tlbkV4cGlyYXRpb246IGF1dGhUb2tlbkV4cGlyYXRpb24sCiAgICAgICAgZW5kcG9pbnQ6IGVuZHBvaW50LAogICAgICAgIHJlZnJlc2hUb2tlbjogcmVmcmVzaFRva2VuLAogICAgICAgIHJlZ2lvbjogcmVnaW9uLAogICAgICAgIGF1dGhvcml6ZUVuZHBvaW50OiBhdXRob3JpemVFbmRwb2ludCwKICAgICAgICBhZ2VudEFwcEVuZHBvaW50OiBhZ2VudEFwcEVuZHBvaW50LAogICAgICAgIGF1dGhDb29raWVOYW1lOiBhdXRoQ29va2llTmFtZQogICAgICB9KTsKIAogICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJBY2tub3dsZWRnZWQgYnkgdGhlIENvbm5lY3RTaGFyZWRXb3JrZXIhIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICAgIGNvbm5lY3QuY29yZS5wb3J0U3RyZWFtSWQgPSBkYXRhLmlkOwogICAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKICAgICAgfSk7CiAgICAgIC8vIEFkZCBhbGwgdXBzdHJlYW0gbG9nIGVudHJpZXMgdG8gb3VyIG93biBsb2dnZXIuCiAgICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgICAgIGlmIChsb2dFbnRyeS5sb2dnZXJJZCAhPT0gY29ubmVjdC5nZXRMb2coKS5nZXRMb2dnZXJJZCgpKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmFkZExvZ0VudHJ5KGNvbm5lY3QuTG9nRW50cnkuZnJvbU9iamVjdChsb2dFbnRyeSkpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIC8vIEdldCB3b3JrZXIgbG9ncwogICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU0VSVkVSX0JPVU5EX0lOVEVSTkFMX0xPRywgZnVuY3Rpb24gKGxvZ0VudHJ5KSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5zZW5kSW50ZXJuYWxMb2dFbnRyeVRvU2VydmVyKGNvbm5lY3QuTG9nRW50cnkuZnJvbU9iamVjdChsb2dFbnRyeSkpOwogICAgICB9KTsKICAgICAgLy8gR2V0IG91dGVyIGNvbnRleHQgbG9ncwogICAgICBjb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TRVJWRVJfQk9VTkRfSU5URVJOQUxfTE9HLCBmdW5jdGlvbiAobG9ncykgewogICAgICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkgJiYgQXJyYXkuaXNBcnJheShsb2dzKSkgewogICAgICAgICAgbG9ncy5mb3JFYWNoKGZ1bmN0aW9uIChsb2cpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5zZW5kSW50ZXJuYWxMb2dFbnRyeVRvU2VydmVyKGNvbm5lY3QuTG9nRW50cnkuZnJvbU9iamVjdChsb2cpKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIC8vIEdldCBsb2cgZnJvbSBvdXRlciBjb250ZXh0CiAgICAgIGNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgZnVuY3Rpb24gKGxvZykgewogICAgICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkgJiYgbG9nLmxvZ2dlcklkICE9PSBjb25uZWN0LmdldExvZygpLmdldExvZ2dlcklkKCkpIHsgCiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmFkZExvZ0VudHJ5KGNvbm5lY3QuTG9nRW50cnkuZnJvbU9iamVjdChsb2cpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAvLyBSZWxvYWQgdGhlIHBhZ2UgaWYgdGhlIHNoYXJlZCB3b3JrZXIgZGV0ZWN0cyBhbiBBUEkgYXV0aCBmYWlsdXJlLgogICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVVUSF9GQUlMLCBmdW5jdGlvbiAobG9nRW50cnkpIHsKICAgICAgICBsb2NhdGlvbi5yZWxvYWQoKTsKICAgICAgfSk7CgogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlVzZXIgQWdlbnQ6ICIgKyBuYXZpZ2F0b3IudXNlckFnZW50KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImlzQ0NQdjI6ICIgKyB0cnVlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImlzRnJhbWVkOiAiICsgY29ubmVjdC5pc0ZyYW1lZCgpKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjb25uZWN0LmNvcmUudXBzdHJlYW0ub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLk9VVEVSX0NPTlRFWFRfSU5GTywgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICB2YXIgc3RyZWFtc1ZlcnNpb24gPSBkYXRhLnN0cmVhbXNWZXJzaW9uOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiU3RyZWFtc0pTIFZlcnNpb246ICIgKyBzdHJlYW1zVmVyc2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSk7CgogICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVVBEQVRFX0NPTk5FQ1RFRF9DQ1BTLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiTnVtYmVyIG9mIGNvbm5lY3RlZCBDQ1BzIHVwZGF0ZWQ6ICIgKyBkYXRhLmxlbmd0aCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQcyA9IGRhdGEubGVuZ3RoOwogICAgICB9KTsKCiAgICAgIGNvbm5lY3QuY29yZS5jbGllbnQgPSBuZXcgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRDbGllbnQoY29uZHVpdCk7CiAgICAgIGNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQgPSBuZXcgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQoY29uZHVpdCk7CiAKICAgICAgLy8gUGFzcyB0aGUgVEVSTUlOQVRFIHJlcXVlc3QgdXBzdHJlYW0gdG8gdGhlIHNoYXJlZCB3b3JrZXIuCiAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5URVJNSU5BVEUsCiAgICAgICAgY29uZHVpdC5wYXNzVXBzdHJlYW0oKSk7CiAKICAgICAgLy8gUmVmcmVzaCB0aGUgcGFnZSB3aGVuIHdlIHJlY2VpdmUgdGhlIFRFUk1JTkFURUQgcmVzcG9uc2UgZnJvbSB0aGUKICAgICAgLy8gc2hhcmVkIHdvcmtlci4KICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURUQsIGZ1bmN0aW9uICgpIHsKICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVsb2FkKHRydWUpOwogICAgICB9KTsKIAogICAgICB3b3JrZXIucG9ydC5zdGFydCgpOwoKICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuVm9pY2VJZEV2ZW50cy5VUERBVEVfRE9NQUlOX0lELCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGlmIChkYXRhICYmIGRhdGEuZG9tYWluSWQpIHsKICAgICAgICAgIGNvbm5lY3QuY29yZS52b2ljZUlkRG9tYWluSWQgPSBkYXRhLmRvbWFpbklkOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICAvLyB0cnkgZmV0Y2hpbmcgdm9pY2VJZCdzIGRvbWFpbklkIG9uY2UgdGhlIGFnZW50IGlzIGluaXRpYWxpemVkCiAgICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB2b2ljZUlkID0gbmV3IGNvbm5lY3QuVm9pY2VJZCgpOwogICAgICAgIHZvaWNlSWQuZ2V0RG9tYWluSWQoKQogICAgICAgICAgLnRoZW4oZnVuY3Rpb24oZG9tYWluSWQpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJ2b2ljZUlkIGRvbWFpbklkIHN1Y2Nlc3NmdWxseSBmZXRjaGVkIGF0IGFnZW50IGluaXRpYWxpemF0aW9uOiAiICsgZG9tYWluSWQpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInZvaWNlSWQgZG9tYWluSWQgbm90IGZldGNoZWQgYXQgYWdlbnQgaW5pdGlhbGl6YXRpb24iKS53aXRoT2JqZWN0KHsgZXJyOiBlcnIgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIH0pOwogICAgICB9KTsKIAogICAgICAvLyBBdHRlbXB0IHRvIGdldCBwZXJtaXNzaW9uIHRvIHNob3cgbm90aWZpY2F0aW9ucy4KICAgICAgdmFyIG5tID0gY29ubmVjdC5jb3JlLmdldE5vdGlmaWNhdGlvbk1hbmFnZXIoKTsKICAgICAgbm0ucmVxdWVzdFBlcm1pc3Npb24oKTsKIAogICAgICBjb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuSU5JVF9ESVNBU1RFUl9SRUNPVkVSWSwgZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmluaXREaXNhc3RlclJlY292ZXJ5KHBhcmFtcyk7CiAgICAgIH0pCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBpbml0aWFsaXplIHRoZSBBUEkgc2hhcmVkIHdvcmtlciwgd2UncmUgZGVhZCEiKQogICAgICAgIC53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJbml0aWFsaXplcyBDb25uZWN0IGJ5IGNyZWF0aW5nIG9yIGNvbm5lY3RpbmcgdG8gdGhlIEFQSSBTaGFyZWQgV29ya2VyLgogICAqIEluaXRpYWxpemVzIENvbm5lY3QgYnkgbG9hZGluZyB0aGUgQ0NQIGluIGFuIGlmcmFtZSBhbmQgY29ubmVjdGluZyB0byBpdC4KICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdENDUCA9IGZ1bmN0aW9uIChjb250YWluZXJEaXYsIHBhcmFtc0luKSB7CiAgICBjb25uZWN0LmNvcmUuY2hlY2tOb3RJbml0aWFsaXplZCgpOwogICAgaWYgKGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICAvLyBDaGVjayBpZiBDQ1AgaWZyYW1lIGhhcyBhbHJlYWR5IGJlZW4gaW5pdGlhbGl6ZWQgdGhyb3VnaCBpbml0Q0NQCiAgICB0cnkgewogICAgICBpZiAoY29ubmVjdC5jb3JlLl9nZXRDQ1BJZnJhbWUoKSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcignQXR0ZW1wdGVkIHRvIGNhbGwgaW5pdENDUCB3aGVuIGFuIGlmcmFtZSBnZW5lcmF0ZWQgYnkgaW5pdENDUCBhbHJlYWR5IGV4aXN0cycpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgfSBjYXRjaChlKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoJ0Vycm9yIHdoaWxlIGNoZWNraW5nIGlmIGluaXRDQ1AgaGFzIGFscmVhZHkgYmVlbiBjYWxsZWQnKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAKICAgIC8vIEZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSwgd2hlbiBpbnN0ZWFkIG9mIHRha2luZyBhIHBhcmFtcyBvYmplY3QKICAgIC8vIGFzIGlucHV0IHdlIG9ubHkgYWNjZXB0ZWQgY2NwVXJsLgogICAgdmFyIHBhcmFtcyA9IHt9OwogICAgaWYgKHR5cGVvZiAocGFyYW1zSW4pID09PSAnc3RyaW5nJykgewogICAgICBwYXJhbXMuY2NwVXJsID0gcGFyYW1zSW47CiAgICB9IGVsc2UgewogICAgICBwYXJhbXMgPSBwYXJhbXNJbjsKICAgIH0KIAogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbnRhaW5lckRpdiwgJ2NvbnRhaW5lckRpdicpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5jY3BVcmwsICdwYXJhbXMuY2NwVXJsJyk7CiAKICAgIC8vIENyZWF0ZSB0aGUgQ0NQIGlmcmFtZSBhbmQgYXBwZW5kIGl0IHRvIHRoZSBjb250YWluZXIgZGl2LgogICAgdmFyIGlmcmFtZSA9IGNvbm5lY3QuY29yZS5fY3JlYXRlQ0NQSWZyYW1lKGNvbnRhaW5lckRpdiwgcGFyYW1zKTsKCiAgICAvLyBJbml0aWFsaXplIHRoZSBldmVudCBidXMgYW5kIGFnZW50IGRhdGEgcHJvdmlkZXJzLgogICAgLy8gTk9URTogU2V0dGluZyBsb2dFdmVudHMgaGVyZSB0byBGQUxTRSBpbiBvcmRlciB0byBhdm9pZCBkdXBsaWNhdGluZwogICAgLy8gZXZlbnRzIHdoaWNoIGFyZSBsb2dnZWQgaW4gQ0NQLgogICAgY29ubmVjdC5jb3JlLmV2ZW50QnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoeyBsb2dFdmVudHM6IGZhbHNlIH0pOwogICAgY29ubmVjdC5jb3JlLmFnZW50RGF0YVByb3ZpZGVyID0gbmV3IEFnZW50RGF0YVByb3ZpZGVyKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpKTsKICAgIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkgPSBuZXcgY29ubmVjdC5NZWRpYUZhY3RvcnkocGFyYW1zKTsKIAogICAgLy8gQnVpbGQgdGhlIHVwc3RyZWFtIGNvbmR1aXQgY29tbXVuaWNhdGluZyB3aXRoIHRoZSBDQ1AgaWZyYW1lLgogICAgdmFyIGNvbmR1aXQgPSBuZXcgY29ubmVjdC5JRnJhbWVDb25kdWl0KHBhcmFtcy5jY3BVcmwsIHdpbmRvdywgaWZyYW1lKTsKIAogICAgLy8gTGV0IENDUCBrbm93IGlmIGlmcmFtZSBpcyB2aXNpYmxlCiAgICBjb25uZWN0LmNvcmUuX3NlbmRJZnJhbWVTdHlsZURhdGFVcHN0cmVhbUFmdGVyUmVhc29uYWJsZVdhaXRUaW1lKGlmcmFtZSwgY29uZHVpdCk7CiAKICAgIC8vIFNldCB0aGUgZ2xvYmFsIHVwc3RyZWFtIGNvbmR1aXQgZm9yIGV4dGVybmFsIHVzZS4KICAgIGNvbm5lY3QuY29yZS51cHN0cmVhbSA9IGNvbmR1aXQ7CiAKICAgIC8vIEluaXQgd2ViU29ja2V0UHJvdmlkZXIKICAgIGNvbm5lY3QuY29yZS53ZWJTb2NrZXRQcm92aWRlciA9IG5ldyBXZWJTb2NrZXRQcm92aWRlcigpOwogCiAgICBjb25kdWl0Lm9uQWxsVXBzdHJlYW0oY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuYnJpZGdlKCkpOwogCiAgICAvLyBJbml0aWFsaXplIHRoZSBrZWVwYWxpdmUgbWFuYWdlci4KICAgIGNvbm5lY3QuY29yZS5rZWVwYWxpdmVNYW5hZ2VyID0gbmV3IEtlZXBhbGl2ZU1hbmFnZXIoY29uZHVpdCwKICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCksCiAgICAgIHBhcmFtcy5jY3BTeW5UaW1lb3V0IHx8IENDUF9TWU5fVElNRU9VVCwKICAgICAgcGFyYW1zLmNjcEFja1RpbWVvdXQgfHwgQ0NQX0FDS19USU1FT1VUKQogICAgICA7CiAgICBjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaFRpbWVvdXQgPSBudWxsOwogCiAgICAvLyBBbGxvdyA1IHNlYyAoZGVmYXVsdCkgYmVmb3JlIHJlY2VpdmluZyB0aGUgZmlyc3QgQUNLIGZyb20gdGhlIENDUC4KICAgIGNvbm5lY3QuY29yZS5jY3BMb2FkVGltZW91dEluc3RhbmNlID0gZ2xvYmFsLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICBjb25uZWN0LmNvcmUuY2NwTG9hZFRpbWVvdXRJbnN0YW5jZSA9IG51bGw7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuQUNLX1RJTUVPVVQpOwogICAgfSwgcGFyYW1zLmNjcExvYWRUaW1lb3V0IHx8IENDUF9MT0FEX1RJTUVPVVQpOwoKICAgIGNvbm5lY3QuZ2V0TG9nKCkuc2NoZWR1bGVVcHN0cmVhbU91dGVyQ29udGV4dENDUExvZ3NQdXNoKGNvbmR1aXQpOwogICAgY29ubmVjdC5nZXRMb2coKS5zY2hlZHVsZVVwc3RyZWFtT3V0ZXJDb250ZXh0Q0NQc2VydmVyQm91bmRMb2dzUHVzaChjb25kdWl0KTsKIAogICAgLy8gT25jZSB3ZSByZWNlaXZlIHRoZSBmaXJzdCBBQ0ssIHNldHVwIG91ciB1cHN0cmVhbSBBUEkgY2xpZW50IGFuZCBlc3RhYmxpc2gKICAgIC8vIHRoZSBTWU4vQUNLIHJlZnJlc2ggZmxvdy4KICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJBY2tub3dsZWRnZWQgYnkgdGhlIENDUCEiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjb25uZWN0LmNvcmUuY2xpZW50ID0gbmV3IGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0Q2xpZW50KGNvbmR1aXQpOwogICAgICBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50ID0gbmV3IGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50KGNvbmR1aXQpOwogICAgICBjb25uZWN0LmNvcmUucG9ydFN0cmVhbUlkID0gZGF0YS5pZDsKCiAgICAgIGlmIChwYXJhbXMuc29mdHBob25lIHx8IHBhcmFtcy5jaGF0IHx8IHBhcmFtcy5wYWdlT3B0aW9ucykgewogICAgICAgIC8vIFNlbmQgY29uZmlndXJhdGlvbiB1cCB0byB0aGUgQ0NQLgogICAgICAgIC8vc2V0IGl0IHRvIGZhbHNlIGlmIHNlY29uZGFyeQogICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgewogICAgICAgICAgc29mdHBob25lOiBwYXJhbXMuc29mdHBob25lLAogICAgICAgICAgY2hhdDogcGFyYW1zLmNoYXQsCiAgICAgICAgICBwYWdlT3B0aW9uczogcGFyYW1zLnBhZ2VPcHRpb25zCiAgICAgICAgfSk7CiAgICAgIH0KIAogICAgICAvLyBJZiBEUiBlbmFibGVkLCBzZXQgdGhpcyBDQ1AgaW5zdGFuY2UgYXMgcGFydCBvZiBhIERpc2FzdGVyIFJlY292ZXJ5IGZsZWV0CiAgICAgIGlmIChwYXJhbXMuZGlzYXN0ZXJSZWNvdmVyeU9uKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLnJlZ2lvbiA9IHBhcmFtcy5yZWdpb247CiAgICAgICAgY29ubmVjdC5jb3JlLnN1cHByZXNzQ29udGFjdHMgPSBzdXBwcmVzc0NvbnRhY3RzOwogICAgICAgIGNvbm5lY3QuY29yZS5mb3JjZU9mZmxpbmUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5TRVRfT0ZGTElORSk7CiAgICAgICAgfSAgICAgICAKICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuSU5JVF9ESVNBU1RFUl9SRUNPVkVSWSwgcGFyYW1zKTsKICAgICAgfQogCiAgICAgIGlmIChjb25uZWN0LmNvcmUuY2NwTG9hZFRpbWVvdXRJbnN0YW5jZSkgewogICAgICAgIGdsb2JhbC5jbGVhclRpbWVvdXQoY29ubmVjdC5jb3JlLmNjcExvYWRUaW1lb3V0SW5zdGFuY2UpOwogICAgICAgIGNvbm5lY3QuY29yZS5jY3BMb2FkVGltZW91dEluc3RhbmNlID0gbnVsbDsKICAgICAgfQoKICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuT1VURVJfQ09OVEVYVF9JTkZPLCB7IHN0cmVhbXNWZXJzaW9uOiBjb25uZWN0LnZlcnNpb24gfSk7CiAKICAgICAgY29ubmVjdC5jb3JlLmtlZXBhbGl2ZU1hbmFnZXIuc3RhcnQoKTsKICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwoKICAgICAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5JTklUKTsKICAgIH0pOwogCiAgICAvLyBBZGQgYW55IGxvZ3MgZnJvbSB0aGUgdXBzdHJlYW0gdG8gb3VyIG93biBsb2dnZXIuCiAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTE9HLCBmdW5jdGlvbiAobG9nRW50cnkpIHsKICAgICAgaWYgKGxvZ0VudHJ5LmxvZ2dlcklkICE9PSBjb25uZWN0LmdldExvZygpLmdldExvZ2dlcklkKCkpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmFkZExvZ0VudHJ5KGNvbm5lY3QuTG9nRW50cnkuZnJvbU9iamVjdChsb2dFbnRyeSkpOwogICAgICB9CiAgICB9KTsKIAogICAgLy8gUG9wIGEgbG9naW4gcGFnZSB3aGVuIHdlIGVuY291bnRlciBhbiBBQ0sgdGltZW91dC4KICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5BQ0tfVElNRU9VVCwgZnVuY3Rpb24gKCkgewogICAgICAvLyBsb2dpblBvcHVwIGlzIHRydWUgYnkgZGVmYXVsdCwgb25seSBmYWxzZSBpZiBleHBsaWNpdGx5IHNldCB0byBmYWxzZS4KICAgICAgaWYgKHBhcmFtcy5sb2dpblBvcHVwICE9PSBmYWxzZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgbG9naW5VcmwgPSBnZXRMb2dpblVybChwYXJhbXMpOwogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJBQ0tfVElNRU9VVCBvY2N1cnJlZCwgYXR0ZW1wdGluZyB0byBwb3AgdGhlIGxvZ2luIHBhZ2UgaWYgbm90IGFscmVhZHkgb3Blbi4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgLy8gY2xlYXIgb3V0IGxhc3Qgb3BlbmVkIHRpbWVzdGFtcCBmb3IgU0FNTCBhdXRoZW50aWNhdGlvbiB3aGVuIHRoZXJlIGlzIEFDS19USU1FT1VUCiAgICAgICAgICBpZiAocGFyYW1zLmxvZ2luVXJsKSB7CiAgICAgICAgICAgIGNvbm5lY3QuY29yZS5nZXRQb3B1cE1hbmFnZXIoKS5jbGVhcihjb25uZWN0Lk1hc3RlclRvcGljcy5MT0dJTl9QT1BVUCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25uZWN0LmNvcmUubG9naW5XaW5kb3cgPSBjb25uZWN0LmNvcmUuZ2V0UG9wdXBNYW5hZ2VyKCkub3Blbihsb2dpblVybCwgY29ubmVjdC5NYXN0ZXJUb3BpY3MuTE9HSU5fUE9QVVAsIHBhcmFtcy5sb2dpbk9wdGlvbnMpOwogCiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiQUNLX1RJTUVPVVQgb2NjdXJyZWQgYnV0IHdlIGFyZSB1bmFibGUgdG8gb3BlbiB0aGUgbG9naW4gcG9wdXAuIikud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoVGltZW91dCA9PSBudWxsKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgICAgIGdsb2JhbC5jbGVhclRpbWVvdXQoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hUaW1lb3V0KTsKICAgICAgICAgICAgY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hUaW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgY29ubmVjdC5jb3JlLmdldFBvcHVwTWFuYWdlcigpLmNsZWFyKGNvbm5lY3QuTWFzdGVyVG9waWNzLkxPR0lOX1BPUFVQKTsKICAgICAgICAgICAgaWYgKChwYXJhbXMubG9naW5Qb3B1cEF1dG9DbG9zZSB8fCAocGFyYW1zLmxvZ2luT3B0aW9ucyAmJiBwYXJhbXMubG9naW5PcHRpb25zLmF1dG9DbG9zZSkpICYmIGNvbm5lY3QuY29yZS5sb2dpbldpbmRvdykgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5sb2dpbldpbmRvdy5jbG9zZSgpOwogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5sb2dpbldpbmRvdyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgY29ubmVjdC5jb3JlLl9yZWZyZXNoSWZyYW1lT25UaW1lb3V0KHBhcmFtcywgY29udGFpbmVyRGl2KTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJFcnJvciBvY2N1cnJlZCB3aGlsZSByZWZyZXNoaW5nIGlmcmFtZSIpLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogCiAgICBpZiAocGFyYW1zLm9uVmlld0NvbnRhY3QpIHsKICAgICAgY29ubmVjdC5jb3JlLm9uVmlld0NvbnRhY3QocGFyYW1zLm9uVmlld0NvbnRhY3QpOwogICAgfQoKICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5VUERBVEVfQ09OTkVDVEVEX0NDUFMsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzID0gZGF0YS5sZW5ndGg7CiAgICB9KTsKCiAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5Wb2ljZUlkRXZlbnRzLlVQREFURV9ET01BSU5fSUQsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGlmIChkYXRhICYmIGRhdGEuZG9tYWluSWQpIHsKICAgICAgICBjb25uZWN0LmNvcmUudm9pY2VJZERvbWFpbklkID0gZGF0YS5kb21haW5JZDsKICAgICAgfQogICAgfSk7CgogICAgLy8ga2VlcCB0aGUgc29mdHBob25lIHBhcmFtcyBmb3IgZXh0ZXJuYWwgdXNlCiAgICBjb25uZWN0LmNvcmUuc29mdHBob25lUGFyYW1zID0gcGFyYW1zLnNvZnRwaG9uZTsKICB9OwoKICBjb25uZWN0LmNvcmUub25JZnJhbWVSZXRyaWVzRXhoYXVzdGVkID0gZnVuY3Rpb24oZikgewogICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLklGUkFNRV9SRVRSSUVTX0VYSEFVU1RFRCwgZik7CiAgfQoKICBjb25uZWN0LmNvcmUuX3JlZnJlc2hJZnJhbWVPblRpbWVvdXQgPSBmdW5jdGlvbihpbml0Q0NQUGFyYW1zLCBjb250YWluZXJEaXYpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChpbml0Q0NQUGFyYW1zLCAnaW5pdENDUFBhcmFtcycpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbnRhaW5lckRpdiwgJ2NvbnRhaW5lckRpdicpOwogICAgdmFyIGNjcElmcmFtZVJlZnJlc2hJbnRlcnZhbCA9IChpbml0Q0NQUGFyYW1zLmRpc2FzdGVyUmVjb3ZlcnlPbikgPyBDQ1BfRFJfSUZSQU1FX1JFRlJFU0hfSU5URVJWQUwgOiBDQ1BfSUZSQU1FX1JFRlJFU0hfSU5URVJWQUw7CiAgICB2YXIgcmV0cnlEZWxheSA9IEFXUy51dGlsLmNhbGN1bGF0ZVJldHJ5RGVsYXkoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hBdHRlbXB0IHx8IDAsIHsgYmFzZTogMjAwMCB9KTsKICAgIHZhciB0aW1lb3V0ID0gY2NwSWZyYW1lUmVmcmVzaEludGVydmFsICsgcmV0cnlEZWxheTsKICAgIGdsb2JhbC5jbGVhclRpbWVvdXQoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hUaW1lb3V0KTsKICAgIGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoVGltZW91dCA9IGdsb2JhbC5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICBjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEF0dGVtcHQgPSAoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hBdHRlbXB0IHx8IDApICsgMTsKICAgICAgaWYgKGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoQXR0ZW1wdCA8PSBDQ1BfSUZSQU1FX1JFRlJFU0hfTElNSVQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIGlmcmFtZSA9IGNvbm5lY3QuY29yZS5fZ2V0Q0NQSWZyYW1lKCk7CiAgICAgICAgICBpZiAoaWZyYW1lKSB7CiAgICAgICAgICAgIGlmcmFtZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGlmcmFtZSk7IC8vIFRoZSBvbmx5IHdheSB0byBmb3JjZSBhIHN5bmNocm9ub3VzIHJlbG9hZCBvZiB0aGUgaWZyYW1lIHdpdGhvdXQgdGhlIG9sZCBpZnJhbWUgY29udGludWluZyB0byBmdW5jdGlvbiBpcyB0byByZW1vdmUgdGhlIG9sZCBpZnJhbWUgZW50aXJlbHkuCiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3SWZyYW1lID0gY29ubmVjdC5jb3JlLl9jcmVhdGVDQ1BJZnJhbWUoY29udGFpbmVyRGl2LCBpbml0Q0NQUGFyYW1zKTsKICAgICAgICAgIGNvbm5lY3QuY29yZS51cHN0cmVhbS51cHN0cmVhbS5vdXRwdXQgPSBuZXdJZnJhbWUuY29udGVudFdpbmRvdzsgLy9yZXBsYWNlcyB0aGUgb3V0cHV0IHdpbmRvdyAob2xkIGlmcmFtZSdzIGNvbnRlbnRXaW5kb3cpIG9mIHRoZSBXaW5kb3dJT1N0cmVhbSAod2l0aGluIHRoZSBJRnJhbWVDb25kdWl0KSB3aXRoIHRoZSBuZXcgaWZyYW1lJ3MgY29udGVudFdpbmRvdy4KICAgICAgICAgIGNvbm5lY3QuY29yZS5fc2VuZElmcmFtZVN0eWxlRGF0YVVwc3RyZWFtQWZ0ZXJSZWFzb25hYmxlV2FpdFRpbWUobmV3SWZyYW1lLCBjb25uZWN0LmNvcmUudXBzdHJlYW0pOwogICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcignRXJyb3Igd2hpbGUgY2hlY2tpbmcgZm9yLCBhbmQgcmVjcmVhdGluZywgdGhlIENDUCBJRnJhbWUnKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfQogICAgICAgIGNvbm5lY3QuY29yZS5fcmVmcmVzaElmcmFtZU9uVGltZW91dChpbml0Q0NQUGFyYW1zLCBjb250YWluZXJEaXYpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuSUZSQU1FX1JFVFJJRVNfRVhIQVVTVEVEKTsKICAgICAgICBnbG9iYWwuY2xlYXJUaW1lb3V0KGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoVGltZW91dCk7CiAgICAgIH0KICAgIH0sIHRpbWVvdXQpOwogIH0KCgogIGNvbm5lY3QuY29yZS5fZ2V0Q0NQSWZyYW1lID0gZnVuY3Rpb24oKSB7CiAgICBmb3IgKHZhciBpZnJhbWUgb2Ygd2luZG93LmRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpZnJhbWUnKSkgewogICAgICBpZiAoaWZyYW1lLm5hbWUgPT09IENDUF9JRlJBTUVfTkFNRSkgewogICAgICAgIHJldHVybiBpZnJhbWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KCiAgY29ubmVjdC5jb3JlLl9jcmVhdGVDQ1BJZnJhbWUgPSBmdW5jdGlvbihjb250YWluZXJEaXYsIGluaXRDQ1BQYXJhbXMpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChpbml0Q0NQUGFyYW1zLCAnaW5pdENDUFBhcmFtcycpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbnRhaW5lckRpdiwgJ2NvbnRhaW5lckRpdicpOwogICAgdmFyIGlmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lmcmFtZScpOwogICAgaWZyYW1lLnNyYyA9IGluaXRDQ1BQYXJhbXMuY2NwVXJsOwogICAgaWZyYW1lLmFsbG93ID0gIm1pY3JvcGhvbmU7IGF1dG9wbGF5IjsKICAgIGlmcmFtZS5zdHlsZSA9ICJ3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlIjsKICAgIGlmcmFtZS50aXRsZSA9IGluaXRDQ1BQYXJhbXMuaWZyYW1lVGl0bGUgfHwgQ0NQX0lGUkFNRV9OQU1FOwogICAgaWZyYW1lLm5hbWUgPSBDQ1BfSUZSQU1FX05BTUU7CiAgICBjb250YWluZXJEaXYuYXBwZW5kQ2hpbGQoaWZyYW1lKTsKICAgIHJldHVybiBpZnJhbWU7CiAgfQoKICBjb25uZWN0LmNvcmUuX3NlbmRJZnJhbWVTdHlsZURhdGFVcHN0cmVhbUFmdGVyUmVhc29uYWJsZVdhaXRUaW1lID0gZnVuY3Rpb24oaWZyYW1lLCBjb25kdWl0KSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoaWZyYW1lLCAnaWZyYW1lJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY29uZHVpdCwgJ2NvbmR1aXQnKTsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGlmcmFtZSwgbnVsbCk7CiAgICAgIHZhciBkYXRhID0gewogICAgICAgIGRpc3BsYXk6IHN0eWxlLmRpc3BsYXksCiAgICAgICAgb2Zmc2V0V2lkdGg6IGlmcmFtZS5vZmZzZXRXaWR0aCwKICAgICAgICBvZmZzZXRIZWlnaHQ6IGlmcmFtZS5vZmZzZXRIZWlnaHQsCiAgICAgICAgY2xpZW50UmVjdHNMZW5ndGg6IGlmcmFtZS5nZXRDbGllbnRSZWN0cygpLmxlbmd0aAogICAgICB9OwogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5JRlJBTUVfU1RZTEUsIGRhdGEpOwogICAgfSwgMTAwMDApOwogIH0KIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICB2YXIgS2VlcGFsaXZlTWFuYWdlciA9IGZ1bmN0aW9uIChjb25kdWl0LCBldmVudEJ1cywgc3luVGltZW91dCwgYWNrVGltZW91dCkgewogICAgdGhpcy5jb25kdWl0ID0gY29uZHVpdDsKICAgIHRoaXMuZXZlbnRCdXMgPSBldmVudEJ1czsKICAgIHRoaXMuc3luVGltZW91dCA9IHN5blRpbWVvdXQ7CiAgICB0aGlzLmFja1RpbWVvdXQgPSBhY2tUaW1lb3V0OwogICAgdGhpcy5hY2tUaW1lciA9IG51bGw7CiAgICB0aGlzLnN5blRpbWVyID0gbnVsbDsKICAgIHRoaXMuYWNrU3ViID0gbnVsbDsKICB9OwogCiAgS2VlcGFsaXZlTWFuYWdlci5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAKICAgIHRoaXMuY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU1lOQ0hST05JWkUpOwogICAgdGhpcy5hY2tTdWIgPSB0aGlzLmNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSwgZnVuY3Rpb24gKCkgewogICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgIGdsb2JhbC5jbGVhclRpbWVvdXQoc2VsZi5hY2tUaW1lcik7CiAgICAgIHNlbGYuX2RlZmVyU3RhcnQoKTsKICAgIH0pOwogICAgdGhpcy5hY2tUaW1lciA9IGdsb2JhbC5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgc2VsZi5hY2tTdWIudW5zdWJzY3JpYmUoKTsKICAgICAgc2VsZi5ldmVudEJ1cy50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLkFDS19USU1FT1VUKTsKICAgICAgc2VsZi5fZGVmZXJTdGFydCgpOwogICAgfSwgdGhpcy5hY2tUaW1lb3V0KTsKICB9OwoKICAvL0ZpeGVzIHRoZSBrZWVwYWxpdmVtYW5hZ2VyLgogIEtlZXBhbGl2ZU1hbmFnZXIucHJvdG90eXBlLl9kZWZlclN0YXJ0ID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5zeW5UaW1lciA9IGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5zdGFydCksIHRoaXMuc3luVGltZW91dCk7CiAgfTsKCiAgLy8gRm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IG9ubHksIGluIGNhc2UgY3VzdG9tZXJzIGFyZSB1c2luZyB0aGlzIHRvIHN0YXJ0IHRoZSBrZWVwYWxpdmVtYW5hZ2VyIGZvciBzb21lIHJlYXNvbi4KICBLZWVwYWxpdmVNYW5hZ2VyLnByb3RvdHlwZS5kZWZlclN0YXJ0ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMuc3luVGltZXIgPT0gbnVsbCkgewogICAgICB0aGlzLnN5blRpbWVyID0gZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnN0YXJ0KSwgdGhpcy5zeW5UaW1lb3V0KTsKICAgIH0KICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogCiAgdmFyIFdlYlNvY2tldFByb3ZpZGVyID0gZnVuY3Rpb24gKCkgewogCiAgICB2YXIgY2FsbGJhY2tzID0gewogICAgICBpbml0RmFpbHVyZTogbmV3IFNldCgpLAogICAgICBzdWJzY3JpcHRpb25VcGRhdGU6IG5ldyBTZXQoKSwKICAgICAgc3Vic2NyaXB0aW9uRmFpbHVyZTogbmV3IFNldCgpLAogICAgICB0b3BpYzogbmV3IE1hcCgpLAogICAgICBhbGxNZXNzYWdlOiBuZXcgU2V0KCksCiAgICAgIGNvbm5lY3Rpb25HYWluOiBuZXcgU2V0KCksCiAgICAgIGNvbm5lY3Rpb25Mb3N0OiBuZXcgU2V0KCksCiAgICAgIGNvbm5lY3Rpb25PcGVuOiBuZXcgU2V0KCksCiAgICAgIGNvbm5lY3Rpb25DbG9zZTogbmV3IFNldCgpCiAgICB9OwogCiAgICB2YXIgaW52b2tlQ2FsbGJhY2tzID0gZnVuY3Rpb24gKGNhbGxiYWNrcywgcmVzcG9uc2UpIHsKICAgICAgY2FsbGJhY2tzLmZvckVhY2goZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2socmVzcG9uc2UpOwogICAgICB9KTsKICAgIH07CiAKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuSU5JVF9GQUlMVVJFLCBmdW5jdGlvbiAoKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuaW5pdEZhaWx1cmUpOwogICAgfSk7CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX09QRU4sIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmNvbm5lY3Rpb25PcGVuLCByZXNwb25zZSk7CiAgICB9KTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fQ0xPU0UsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmNvbm5lY3Rpb25DbG9zZSwgcmVzcG9uc2UpOwogICAgfSk7CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0dBSU4sIGZ1bmN0aW9uICgpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5jb25uZWN0aW9uR2Fpbik7CiAgICB9KTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fTE9TVCwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuY29ubmVjdGlvbkxvc3QsIHJlc3BvbnNlKTsKICAgIH0pOwogCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNVQlNDUklQVElPTl9VUERBVEUsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLnN1YnNjcmlwdGlvblVwZGF0ZSwgcmVzcG9uc2UpOwogICAgfSk7CiAKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSVBUSU9OX0ZBSUxVUkUsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLnN1YnNjcmlwdGlvbkZhaWx1cmUsIHJlc3BvbnNlKTsKICAgIH0pOwogCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkFMTF9NRVNTQUdFLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5hbGxNZXNzYWdlLCByZXNwb25zZSk7CiAgICAgIGlmIChjYWxsYmFja3MudG9waWMuaGFzKHJlc3BvbnNlLnRvcGljKSkgewogICAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MudG9waWMuZ2V0KHJlc3BvbnNlLnRvcGljKSwgcmVzcG9uc2UpOwogICAgICB9CiAgICB9KTsKIAogICAgdGhpcy5zZW5kTWVzc2FnZSA9IGZ1bmN0aW9uICh3ZWJTb2NrZXRQYXlsb2FkKSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TRU5ELCB3ZWJTb2NrZXRQYXlsb2FkKTsKICAgIH07CiAKICAgIHRoaXMub25Jbml0RmFpbHVyZSA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmluaXRGYWlsdXJlLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5pbml0RmFpbHVyZS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKCiAgICB0aGlzLm9uQ29ubmVjdGlvbk9wZW4gPSBmdW5jdGlvbihjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmNvbm5lY3Rpb25PcGVuLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5jb25uZWN0aW9uT3Blbi5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKCiAgICB0aGlzLm9uQ29ubmVjdGlvbkNsb3NlID0gZnVuY3Rpb24oY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5jb25uZWN0aW9uQ2xvc2UuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmNvbm5lY3Rpb25DbG9zZS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKCiAgICB0aGlzLm9uQ29ubmVjdGlvbkdhaW4gPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5jb25uZWN0aW9uR2Fpbi5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuY29ubmVjdGlvbkdhaW4uZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICAgIHRoaXMub25Db25uZWN0aW9uTG9zdCA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmNvbm5lY3Rpb25Mb3N0LmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5jb25uZWN0aW9uTG9zdC5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogICAgdGhpcy5vblN1YnNjcmlwdGlvblVwZGF0ZSA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLnN1YnNjcmlwdGlvblVwZGF0ZS5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3Muc3Vic2NyaXB0aW9uVXBkYXRlLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgICB0aGlzLm9uU3Vic2NyaXB0aW9uRmFpbHVyZSA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLnN1YnNjcmlwdGlvbkZhaWx1cmUuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLnN1YnNjcmlwdGlvbkZhaWx1cmUuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICAgIHRoaXMuc3Vic2NyaWJlVG9waWNzID0gZnVuY3Rpb24gKHRvcGljcykgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWNzLCAndG9waWNzJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzQXJyYXkodG9waWNzKSwgJ3RvcGljcyBtdXN0IGJlIGEgYXJyYXknKTsKICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNVQlNDUklCRSwgdG9waWNzKTsKICAgIH07CiAKICAgIHRoaXMub25NZXNzYWdlID0gZnVuY3Rpb24gKHRvcGljTmFtZSwgY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljTmFtZSwgJ3RvcGljTmFtZScpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgaWYgKGNhbGxiYWNrcy50b3BpYy5oYXModG9waWNOYW1lKSkgewogICAgICAgIGNhbGxiYWNrcy50b3BpYy5nZXQodG9waWNOYW1lKS5hZGQoY2IpOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrcy50b3BpYy5zZXQodG9waWNOYW1lLCBuZXcgU2V0KFtjYl0pKTsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MudG9waWMuZ2V0KHRvcGljTmFtZSkuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICAgIHRoaXMub25BbGxNZXNzYWdlID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuYWxsTWVzc2FnZS5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuYWxsTWVzc2FnZS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgdmFyIEFnZW50RGF0YVByb3ZpZGVyID0gZnVuY3Rpb24gKGJ1cykgewogICAgdmFyIGFnZW50RGF0YSA9IG51bGw7CiAgICB0aGlzLmJ1cyA9IGJ1czsKICAgIHRoaXMuYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLlVQREFURSwgY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnVwZGF0ZUFnZW50RGF0YSkpOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUudXBkYXRlQWdlbnREYXRhID0gZnVuY3Rpb24gKGFnZW50RGF0YSkgewogICAgdmFyIG9sZEFnZW50RGF0YSA9IHRoaXMuYWdlbnREYXRhOwogICAgdGhpcy5hZ2VudERhdGEgPSBhZ2VudERhdGE7CiAKICAgIGlmIChvbGRBZ2VudERhdGEgPT0gbnVsbCkgewogICAgICBjb25uZWN0LmFnZW50LmluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgdGhpcy5idXMudHJpZ2dlcihjb25uZWN0LkFnZW50RXZlbnRzLklOSVQsIG5ldyBjb25uZWN0LkFnZW50KCkpOwogICAgfQogCiAgICB0aGlzLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQWdlbnRFdmVudHMuUkVGUkVTSCwgbmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAKICAgIHRoaXMuX2ZpcmVBZ2VudFVwZGF0ZUV2ZW50cyhvbGRBZ2VudERhdGEpOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuZ2V0QWdlbnREYXRhID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMuYWdlbnREYXRhID09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignTm8gYWdlbnQgZGF0YSBpcyBhdmFpbGFibGUgeWV0IScpOwogICAgfQogCiAgICByZXR1cm4gdGhpcy5hZ2VudERhdGE7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5nZXRDb250YWN0RGF0YSA9IGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgIHZhciBhZ2VudERhdGEgPSB0aGlzLmdldEFnZW50RGF0YSgpOwogICAgdmFyIGNvbnRhY3REYXRhID0gY29ubmVjdC5maW5kKGFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGN0ZGF0YSkgewogICAgICByZXR1cm4gY3RkYXRhLmNvbnRhY3RJZCA9PT0gY29udGFjdElkOwogICAgfSk7CiAKICAgIGlmIChjb250YWN0RGF0YSA9PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ0NvbnRhY3QgJXMgbm8gbG9uZ2VyIGV4aXN0cy4nLCBjb250YWN0SWQpOwogICAgfQogCiAgICByZXR1cm4gY29udGFjdERhdGE7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5nZXRDb25uZWN0aW9uRGF0YSA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgdmFyIGNvbnRhY3REYXRhID0gdGhpcy5nZXRDb250YWN0RGF0YShjb250YWN0SWQpOwogICAgdmFyIGNvbm5lY3Rpb25EYXRhID0gY29ubmVjdC5maW5kKGNvbnRhY3REYXRhLmNvbm5lY3Rpb25zLCBmdW5jdGlvbiAoY2RhdGEpIHsKICAgICAgcmV0dXJuIGNkYXRhLmNvbm5lY3Rpb25JZCA9PT0gY29ubmVjdGlvbklkOwogICAgfSk7CiAKICAgIGlmIChjb25uZWN0aW9uRGF0YSA9PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ0Nvbm5lY3Rpb24gJXMgZm9yIGNvbnRhY3QgJXMgbm8gbG9uZ2VyIGV4aXN0cy4nLCBjb25uZWN0aW9uSWQsIGNvbnRhY3RJZCk7CiAgICB9CiAKICAgIHJldHVybiBjb25uZWN0aW9uRGF0YTsKICB9OwoKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuZ2V0SW5zdGFuY2VJZCA9IGZ1bmN0aW9uKCl7CiAgICByZXR1cm4gdGhpcy5nZXRBZ2VudERhdGEoKS5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnJvdXRpbmdQcm9maWxlSWQubWF0Y2goL2luc3RhbmNlXC8oWzAtOWEtZkEtRnwtXSspXC8vKVsxXTsKICB9CgogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5nZXRBV1NBY2NvdW50SWQgPSBmdW5jdGlvbigpewogICAgcmV0dXJuIHRoaXMuZ2V0QWdlbnREYXRhKCkuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5yb3V0aW5nUHJvZmlsZUlkLm1hdGNoKC86KFswLTldKyk6aW5zdGFuY2UvKVsxXTsKICB9CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuX2RpZmZDb250YWN0cyA9IGZ1bmN0aW9uIChvbGRBZ2VudERhdGEpIHsKICAgIHZhciBkaWZmID0gewogICAgICBhZGRlZDoge30sCiAgICAgIHJlbW92ZWQ6IHt9LAogICAgICBjb21tb246IHt9LAogICAgICBvbGRNYXA6IGNvbm5lY3QuaW5kZXgob2xkQWdlbnREYXRhID09IG51bGwgPyBbXSA6IG9sZEFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGNvbnRhY3QpIHsgcmV0dXJuIGNvbnRhY3QuY29udGFjdElkOyB9KSwKICAgICAgbmV3TWFwOiBjb25uZWN0LmluZGV4KHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LmNvbnRhY3RzLCBmdW5jdGlvbiAoY29udGFjdCkgeyByZXR1cm4gY29udGFjdC5jb250YWN0SWQ7IH0pCiAgICB9OwogCiAgICBjb25uZWN0LmtleXMoZGlmZi5vbGRNYXApLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgICBpZiAoY29ubmVjdC5jb250YWlucyhkaWZmLm5ld01hcCwgY29udGFjdElkKSkgewogICAgICAgIGRpZmYuY29tbW9uW2NvbnRhY3RJZF0gPSBkaWZmLm5ld01hcFtjb250YWN0SWRdOwogICAgICB9IGVsc2UgewogICAgICAgIGRpZmYucmVtb3ZlZFtjb250YWN0SWRdID0gZGlmZi5vbGRNYXBbY29udGFjdElkXTsKICAgICAgfQogICAgfSk7CiAKICAgIGNvbm5lY3Qua2V5cyhkaWZmLm5ld01hcCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICAgIGlmICghY29ubmVjdC5jb250YWlucyhkaWZmLm9sZE1hcCwgY29udGFjdElkKSkgewogICAgICAgIGRpZmYuYWRkZWRbY29udGFjdElkXSA9IGRpZmYubmV3TWFwW2NvbnRhY3RJZF07CiAgICAgIH0KICAgIH0pOwogCiAgICByZXR1cm4gZGlmZjsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLl9maXJlQWdlbnRVcGRhdGVFdmVudHMgPSBmdW5jdGlvbiAob2xkQWdlbnREYXRhKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgZGlmZiA9IG51bGw7CiAgICB2YXIgb2xkQWdlbnRTdGF0ZSA9IG9sZEFnZW50RGF0YSA9PSBudWxsID8gY29ubmVjdC5BZ2VudEF2YWlsU3RhdGVzLklOSVQgOiBvbGRBZ2VudERhdGEuc25hcHNob3Quc3RhdGUubmFtZTsKICAgIHZhciBuZXdBZ2VudFN0YXRlID0gdGhpcy5hZ2VudERhdGEuc25hcHNob3Quc3RhdGUubmFtZTsKICAgIHZhciBvbGRSb3V0aW5nU3RhdGUgPSBvbGRBZ2VudERhdGEgPT0gbnVsbCA/IGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUuSU5JVCA6IG9sZEFnZW50RGF0YS5zbmFwc2hvdC5zdGF0ZS50eXBlOwogICAgdmFyIG5ld1JvdXRpbmdTdGF0ZSA9IHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LnN0YXRlLnR5cGU7CiAKICAgIGlmIChvbGRSb3V0aW5nU3RhdGUgIT09IG5ld1JvdXRpbmdTdGF0ZSkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRSb3V0aW5nRXZlbnRHcmFwaCgpLmdldEFzc29jaWF0aW9ucyh0aGlzLCBvbGRSb3V0aW5nU3RhdGUsIG5ld1JvdXRpbmdTdGF0ZSkuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBzZWxmLmJ1cy50cmlnZ2VyKGV2ZW50LCBuZXcgY29ubmVjdC5BZ2VudCgpKTsKICAgICAgfSk7CiAgICB9CiAKICAgIGlmIChvbGRBZ2VudFN0YXRlICE9PSBuZXdBZ2VudFN0YXRlKSB7CiAgICAgIHRoaXMuYnVzLnRyaWdnZXIoY29ubmVjdC5BZ2VudEV2ZW50cy5TVEFURV9DSEFOR0UsIHsKICAgICAgICBhZ2VudDogbmV3IGNvbm5lY3QuQWdlbnQoKSwKICAgICAgICBvbGRTdGF0ZTogb2xkQWdlbnRTdGF0ZSwKICAgICAgICBuZXdTdGF0ZTogbmV3QWdlbnRTdGF0ZQogCiAgICAgIH0pOwogICAgICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRTdGF0ZUV2ZW50R3JhcGgoKS5nZXRBc3NvY2lhdGlvbnModGhpcywgb2xkQWdlbnRTdGF0ZSwgbmV3QWdlbnRTdGF0ZSkuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBzZWxmLmJ1cy50cmlnZ2VyKGV2ZW50LCBuZXcgY29ubmVjdC5BZ2VudCgpKTsKICAgICAgfSk7CiAgICB9CgogICAgdmFyIG9sZE5leHRTdGF0ZSA9IG9sZEFnZW50RGF0YSAmJiBvbGRBZ2VudERhdGEuc25hcHNob3QubmV4dFN0YXRlID8gb2xkQWdlbnREYXRhLnNuYXBzaG90Lm5leHRTdGF0ZS5uYW1lIDogbnVsbDsKICAgIHZhciBuZXdOZXh0U3RhdGUgPSB0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5uZXh0U3RhdGUgPyB0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5uZXh0U3RhdGUubmFtZSA6IG51bGw7CiAgICBpZiAob2xkTmV4dFN0YXRlICE9PSBuZXdOZXh0U3RhdGUgJiYgbmV3TmV4dFN0YXRlKSB7CiAgICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5BZ2VudEV2ZW50cy5FTlFVRVVFRF9ORVhUX1NUQVRFLCBuZXcgY29ubmVjdC5BZ2VudCgpKTsKICAgIH0KCiAgICBpZiAob2xkQWdlbnREYXRhICE9PSBudWxsKSB7CiAgICAgIGRpZmYgPSB0aGlzLl9kaWZmQ29udGFjdHMob2xkQWdlbnREYXRhKTsKIAogICAgfSBlbHNlIHsKICAgICAgZGlmZiA9IHsKICAgICAgICBhZGRlZDogY29ubmVjdC5pbmRleCh0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGNvbnRhY3QpIHsgcmV0dXJuIGNvbnRhY3QuY29udGFjdElkOyB9KSwKICAgICAgICByZW1vdmVkOiB7fSwKICAgICAgICBjb21tb246IHt9LAogICAgICAgIG9sZE1hcDoge30sCiAgICAgICAgbmV3TWFwOiBjb25uZWN0LmluZGV4KHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LmNvbnRhY3RzLCBmdW5jdGlvbiAoY29udGFjdCkgeyByZXR1cm4gY29udGFjdC5jb250YWN0SWQ7IH0pCiAgICAgIH07CiAgICB9CiAKICAgIGNvbm5lY3QudmFsdWVzKGRpZmYuYWRkZWQpLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5Db250YWN0RXZlbnRzLklOSVQsIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdERhdGEuY29udGFjdElkKSk7CiAgICAgIHNlbGYuX2ZpcmVDb250YWN0VXBkYXRlRXZlbnRzKGNvbnRhY3REYXRhLmNvbnRhY3RJZCwgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLklOSVQsIGNvbnRhY3REYXRhLnN0YXRlLnR5cGUpOwogICAgfSk7CiAKICAgIGNvbm5lY3QudmFsdWVzKGRpZmYucmVtb3ZlZCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LkNvbnRhY3RFdmVudHMuREVTVFJPWUVELCBuZXcgY29ubmVjdC5Db250YWN0U25hcHNob3QoY29udGFjdERhdGEpKTsKICAgICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuREVTVFJPWUVELCBjb250YWN0RGF0YS5jb250YWN0SWQpLCBuZXcgY29ubmVjdC5Db250YWN0U25hcHNob3QoY29udGFjdERhdGEpKTsKICAgICAgc2VsZi5fdW5zdWJBbGxDb250YWN0RXZlbnRzRm9yQ29udGFjdChjb250YWN0RGF0YS5jb250YWN0SWQpOwogICAgfSk7CiAKICAgIGNvbm5lY3Qua2V5cyhkaWZmLmNvbW1vbikuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICAgIHNlbGYuX2ZpcmVDb250YWN0VXBkYXRlRXZlbnRzKGNvbnRhY3RJZCwgZGlmZi5vbGRNYXBbY29udGFjdElkXS5zdGF0ZS50eXBlLCBkaWZmLm5ld01hcFtjb250YWN0SWRdLnN0YXRlLnR5cGUpOwogICAgfSk7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5fZmlyZUNvbnRhY3RVcGRhdGVFdmVudHMgPSBmdW5jdGlvbiAoY29udGFjdElkLCBvbGRDb250YWN0U3RhdGUsIG5ld0NvbnRhY3RTdGF0ZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYgKG9sZENvbnRhY3RTdGF0ZSAhPT0gbmV3Q29udGFjdFN0YXRlKSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnRHcmFwaCgpLmdldEFzc29jaWF0aW9ucyh0aGlzLCBvbGRDb250YWN0U3RhdGUsIG5ld0NvbnRhY3RTdGF0ZSkuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBzZWxmLmJ1cy50cmlnZ2VyKGV2ZW50LCBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkpOwogICAgICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUoZXZlbnQsIGNvbnRhY3RJZCksIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKSk7CiAgICAgIH0pOwogICAgfQoKICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5Db250YWN0RXZlbnRzLlJFRlJFU0gsIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKSk7CiAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5SRUZSRVNILCBjb250YWN0SWQpLCBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkpOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuX3Vuc3ViQWxsQ29udGFjdEV2ZW50c0ZvckNvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBjb25uZWN0LnZhbHVlcyhjb25uZWN0LkNvbnRhY3RFdmVudHMpLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgICBzZWxmLmJ1cy5nZXRTdWJzY3JpcHRpb25zKGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGV2ZW50TmFtZSwgY29udGFjdElkKSkKICAgICAgICAubWFwKGZ1bmN0aW9uIChzdWIpIHsgc3ViLnVuc3Vic2NyaWJlKCk7IH0pOwogICAgfSk7CiAgfTsKIAogIC8qKiAtLS0tLSBtaW5pbWFsIHZpZXcgbGF5ZXIgZXZlbnQgaGFuZGxpbmcgKiovCiAKICBjb25uZWN0LmNvcmUub25WaWV3Q29udGFjdCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5WSUVXLCBmKTsKICB9OwogCiAgLyoqCiAgICogVXNlZCBvZiBhZ2VudCBpbnRlcmZhY2UgY29udHJvbC4gCiAgICogY29ubmVjdC5jb3JlLnZpZXdDb250YWN0KCJjb250YWN0SWQiKSAtPiAgdGhpcyBpcyBjdXJlbnRseSBwcm9ncmFtbWVkIHRvIGdldCB0aGUgY29udGFjdCBpbnRvIHZpZXcuCiAgICovCiAgY29ubmVjdC5jb3JlLnZpZXdDb250YWN0ID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db250YWN0RXZlbnRzLlZJRVcsCiAgICAgIGRhdGE6IHsKICAgICAgICBjb250YWN0SWQ6IGNvbnRhY3RJZAogICAgICB9CiAgICB9KTsKICB9OwoKICAvKiogLS0tLS0gbWluaW1hbCB2aWV3IGxheWVyIGV2ZW50IGhhbmRsaW5nICoqLwogCiAgY29ubmVjdC5jb3JlLm9uQWN0aXZhdGVDaGFubmVsV2l0aFZpZXdUeXBlID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5DaGFubmVsVmlld0V2ZW50cy5BQ1RJVkFURV9DSEFOTkVMX1dJVEhfVklFV19UWVBFLCBmKTsKICB9OwogCiAgLyoqCiAgICogVXNlZCBvZiBhZ2VudCBpbnRlcmZhY2UgY29udHJvbC4gCiAgICogY29ubmVjdC5jb3JlLmFjdGl2YXRlQ2hhbm5lbFdpdGhWaWV3VHlwZSgpIC0+ICB0aGlzIGlzIGN1cmVudGx5IHByb2dyYW1tZWQgdG8gZ2V0IGVpdGhlciB0aGUgbnVtYmVyIHBhZCwgcXVpY2sgY29ubmVjdHMsIG9yIGNyZWF0ZSB0YXNrIGludG8gdmlldy4KICAgKiB0aGUgdmFsaWQgY29tYmluYXRpb25zIGFyZSAoImNyZWF0ZV90YXNrIiwgInRhc2siKSwgKCJudW1iZXJfcGFkIiwgInNvZnRwaG9uZSIpLCAoImNyZWF0ZV90YXNrIiwgInNvZnRwaG9uZSIpLCAoInF1aWNrX2Nvbm5lY3RzIiwgInNvZnRwaG9uZSIpCiAgICogdGhlIHNvZnRwaG9uZSB3aXRoIGNyZWF0ZV90YXNrIGNvbWJvIGlzIGEgc3BlY2lhbCBjYXNlIGluIHRoZSBjaGFubmVsIHZpZXcgdG8gYWxsb3cgYWxsIHRocmVlIHZpZXcgdHlwZSBidXR0b25zIHRvIGFwcGVhciBvbiB0aGUgc29mdHBob25lIHNjcmVlbgogICAqCiAgICogVGhlICdzb3VyY2UnIGlzIGFuIG9wdGlvbmFsIHBhcmFtZXRlciB3aGljaCBpbmRpY2F0ZXMgdGhlIHJlcXVlc3Rlci4gRm9yIGV4YW1wbGUsIGlmIGludm9rZWQgd2l0aCAoImNyZWF0ZV90YXNrIiwgInRhc2siLCAiYWdlbnRhcHAiKSB3ZSB3b3VsZCBrbm93IGFnZW50YXBwIHJlcXVlc3RlZCBvcGVuIHRhc2sgdmlldy4KICAgKi8KICBjb25uZWN0LmNvcmUuYWN0aXZhdGVDaGFubmVsV2l0aFZpZXdUeXBlID0gZnVuY3Rpb24gKHZpZXdUeXBlLCBtZWRpYVR5cGUsIHNvdXJjZSkgewogICAgY29uc3QgZGF0YSA9IHsgdmlld1R5cGUsIG1lZGlhVHlwZSB9OwogICAgaWYgKHNvdXJjZSkgewogICAgICBkYXRhLnNvdXJjZSA9IHNvdXJjZTsKICAgIH0KICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ2hhbm5lbFZpZXdFdmVudHMuQUNUSVZBVEVfQ0hBTk5FTF9XSVRIX1ZJRVdfVFlQRSwKICAgICAgZGF0YQogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogVXNlZCB0byBwdWJsaXNoICd0YXNrIGNyZWF0ZWQnIGV2ZW50CiAgICovCiAgY29ubmVjdC5jb3JlLnRyaWdnZXJUYXNrQ3JlYXRlZCA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS51cHN0cmVhbUJ1cy50cmlnZ2VyKGNvbm5lY3QuVGFza0V2ZW50cy5DUkVBVEVELCBkYXRhKTsKICB9OwoKICAvKiogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwogCiAgLyoqCiAgKiBUaGlzIHdpbGwgYmUgaGVscGZ1bCBmb3IgdGhlIGN1c3RvbSBhbmQgZW1iZWRkZWQgQ0NQcyAKICAqIHRvIGhhbmRsZSB0aGUgYWNjZXNzIGRlbmllZCB1c2UgY2FzZS4gCiAgKi8KICBjb25uZWN0LmNvcmUub25BY2Nlc3NEZW5pZWQgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0NFU1NfREVOSUVELCBmKTsKICB9OwogCiAgLyoqCiAgKiBUaGlzIHdpbGwgYmUgaGVscGZ1bCBmb3IgU0FNTCB1c2UgY2FzZXMgdG8gaGFuZGxlIHRoZSBjdXN0b20gbG9naW5zLiAKICAqLwogIGNvbm5lY3QuY29yZS5vbkF1dGhGYWlsID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVVUSF9GQUlMLCBmKTsKICB9OwogCiAgLyoqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KIAogIC8qKgogICAqIFVzZWQgZm9yIGhhbmRsaW5nIHRoZSBydGMgc2Vzc2lvbiBzdGF0cy4KICAgKiBVc2FnZQogICAqIGNvbm5lY3QuY29yZS5vblNvZnRwaG9uZVNlc3Npb25Jbml0KGZ1bmN0aW9uKHsgY29ubmVjdGlvbklkIH0pIHsKICAgKiAgICAgdmFyIHNvZnRwaG9uZU1hbmFnZXIgPSBjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lTWFuYWdlcigpOwogICAqICAgICBpZihzb2Z0cGhvbmVNYW5hZ2VyKXsKICAgKiAgICAgICAgLy8gYWNjZXNzIHNlc3Npb24KICAgKiAgICAgICAgdmFyIHNlc3Npb24gPSBzb2Z0cGhvbmVNYW5hZ2VyLmdldFNlc3Npb24oY29ubmVjdGlvbklkKTsgCiAgICogICAgICB9CiAgICogfSk7CiAgICovCiAKICBjb25uZWN0LmNvcmUub25Tb2Z0cGhvbmVTZXNzaW9uSW5pdCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5TRVNTSU9OX0lOSVQsIGYpOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLm9uQ29uZmlndXJlID0gZnVuY3Rpb24oZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuQ09ORklHVVJFLCBmKTsKICB9CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgIGNvbm5lY3QuY29yZS5vbkluaXRpYWxpemVkID0gZnVuY3Rpb24oZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5JTklULCBmKTsKICB9CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZSA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGNvbnRhY3RJZCkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbnRhY3RJZCwgJ2NvbnRhY3RJZCcpOwogICAgaWYgKCFjb25uZWN0LmNvbnRhaW5zKGNvbm5lY3QudmFsdWVzKGNvbm5lY3QuQ29udGFjdEV2ZW50cyksIGV2ZW50TmFtZSkpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuVmFsdWVFcnJvcignJXMgaXMgbm90IGEgdmFsaWQgY29udGFjdCBldmVudC4nLCBldmVudE5hbWUpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3Quc3ByaW50ZignJXM6OiVzJywgZXZlbnROYW1lLCBjb250YWN0SWQpOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5ldmVudEJ1czsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRXZWJTb2NrZXRNYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS53ZWJTb2NrZXRQcm92aWRlcjsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuYWdlbnREYXRhUHJvdmlkZXI7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0TG9jYWxUaW1lc3RhbXAgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0QWdlbnREYXRhKCkuc25hcHNob3QubG9jYWxUaW1lc3RhbXA7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0U2tldyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBZ2VudERhdGEoKS5zbmFwc2hvdC5za2V3OwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldEFnZW50Um91dGluZ0V2ZW50R3JhcGggPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmFnZW50Um91dGluZ0V2ZW50R3JhcGg7CiAgfTsKICBjb25uZWN0LmNvcmUuYWdlbnRSb3V0aW5nRXZlbnRHcmFwaCA9IG5ldyBjb25uZWN0LkV2ZW50R3JhcGgoKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUuUk9VVEFCTEUsCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuUk9VVEFCTEUpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwgY29ubmVjdC5BZ2VudFN0YXRlVHlwZS5OT1RfUk9VVEFCTEUsCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuTk9UX1JPVVRBQkxFKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUuT0ZGTElORSwKICAgICAgY29ubmVjdC5BZ2VudEV2ZW50cy5PRkZMSU5FKTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRTdGF0ZUV2ZW50R3JhcGggPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmFnZW50U3RhdGVFdmVudEdyYXBoOwogIH07CiAgY29ubmVjdC5jb3JlLmFnZW50U3RhdGVFdmVudEdyYXBoID0gbmV3IGNvbm5lY3QuRXZlbnRHcmFwaCgpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC52YWx1ZXMoY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzKSwKICAgICAgY29ubmVjdC5BZ2VudEV2ZW50cy5FUlJPUikKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLCBjb25uZWN0LkFnZW50QXZhaWxTdGF0ZXMuQUZURVJfQ0FMTF9XT1JLLAogICAgICBjb25uZWN0LkFnZW50RXZlbnRzLkFDVyk7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudEdyYXBoID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5jb250YWN0RXZlbnRHcmFwaDsKICB9OwogCiAgY29ubmVjdC5jb3JlLmNvbnRhY3RFdmVudEdyYXBoID0gbmV3IGNvbm5lY3QuRXZlbnRHcmFwaCgpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLklOQ09NSU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuSU5DT01JTkcpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLlBFTkRJTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5QRU5ESU5HKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5DT05ORUNUSU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuQ09OTkVDVElORykKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuQ09OTkVDVEVELAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuQ09OTkVDVEVEKQogICAgLmFzc29jKGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5DT05ORUNUSU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuRVJST1IsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpCiAgICAuYXNzb2MoY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLklOQ09NSU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuRVJST1IsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkVOREVELAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNXKQogICAgLmFzc29jKGNvbm5lY3QudmFsdWVzKGNvbm5lY3QuQ09OVEFDVF9BQ1RJVkVfU1RBVEVTKSwKICAgICAgY29ubmVjdC52YWx1ZXMoY29ubmVjdC5yZWxhdGl2ZUNvbXBsZW1lbnQoY29ubmVjdC5DT05UQUNUX0FDVElWRV9TVEFURVMsIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZSkpLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuRU5ERUQpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkVSUk9SLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuRVJST1IpCiAgICAuYXNzb2MoY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkNPTk5FQ1RJTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5NSVNTRUQsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldENsaWVudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLmNsaWVudCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdUaGUgY29ubmVjdCBjb3JlIGhhcyBub3QgYmVlbiBpbml0aWFsaXplZCEnKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmNvcmUuY2xpZW50OwogIH07CiAgY29ubmVjdC5jb3JlLmNsaWVudCA9IG51bGw7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRBcHBDbGllbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS5hZ2VudEFwcENsaWVudCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdUaGUgY29ubmVjdCBBZ2VudEFwcCBDbGllbnQgaGFzIG5vdCBiZWVuIGluaXRpYWxpemVkIScpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5hZ2VudEFwcENsaWVudDsKICB9OwogIGNvbm5lY3QuY29yZS5hZ2VudEFwcENsaWVudCA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldE1hc3RlckNsaWVudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdUaGUgY29ubmVjdCBtYXN0ZXIgY2xpZW50IGhhcyBub3QgYmVlbiBpbml0aWFsaXplZCEnKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50OwogIH07CiAgY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZU1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXI7CiAgfTsKICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldE5vdGlmaWNhdGlvbk1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS5ub3RpZmljYXRpb25NYW5hZ2VyKSB7CiAgICAgIGNvbm5lY3QuY29yZS5ub3RpZmljYXRpb25NYW5hZ2VyID0gbmV3IGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlcigpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5ub3RpZmljYXRpb25NYW5hZ2VyOwogIH07CiAgY29ubmVjdC5jb3JlLm5vdGlmaWNhdGlvbk1hbmFnZXIgPSBudWxsOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRQb3B1cE1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLnBvcHVwTWFuYWdlcjsKICB9OwogIGNvbm5lY3QuY29yZS5wb3B1cE1hbmFnZXIgPSBuZXcgY29ubmVjdC5Qb3B1cE1hbmFnZXIoKTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0gPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS51cHN0cmVhbSkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdUaGVyZSBpcyBubyB1cHN0cmVhbSBjb25kdWl0IScpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS51cHN0cmVhbTsKICB9OwogIGNvbm5lY3QuY29yZS51cHN0cmVhbSA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLkFnZW50RGF0YVByb3ZpZGVyID0gQWdlbnREYXRhUHJvdmlkZXI7CiAKfSkoKTsKCi8qKiovIH0pLAoKLyoqKi8gNTkyOgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwoKICB2YXIgQUxMX0VWRU5UUyA9ICc8PGFsbD4+JzsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBFdmVudFR5cGUKICAgKi8KICB2YXIgRXZlbnRUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnYWNrbm93bGVkZ2UnLAogICAgJ2Fja190aW1lb3V0JywKICAgICdpbml0JywKICAgICdhcGlfcmVxdWVzdCcsCiAgICAnYXBpX3Jlc3BvbnNlJywKICAgICdhdXRoX2ZhaWwnLAogICAgJ2FjY2Vzc19kZW5pZWQnLAogICAgJ2Nsb3NlJywKICAgICdjb25maWd1cmUnLAogICAgJ2xvZycsCiAgICAnbWFzdGVyX3JlcXVlc3QnLAogICAgJ21hc3Rlcl9yZXNwb25zZScsCiAgICAnc3luY2hyb25pemUnLAogICAgJ3Rlcm1pbmF0ZScsCiAgICAndGVybWluYXRlZCcsCiAgICAnc2VuZF9sb2dzJywKICAgICdyZWxvYWRfYWdlbnRfY29uZmlndXJhdGlvbicsCiAgICAnYnJvYWRjYXN0JywKICAgICdhcGlfbWV0cmljJywKICAgICdjbGllbnRfbWV0cmljJywKICAgICdzb2Z0cGhvbmVfc3RhdHMnLAogICAgJ3NvZnRwaG9uZV9yZXBvcnQnLAogICAgJ2NsaWVudF9zaWRlX2xvZ3MnLAogICAgJ3NlcnZlcl9ib3VuZF9pbnRlcm5hbF9sb2cnLAogICAgJ211dGUnLAogICAgImlmcmFtZV9zdHlsZSIsCiAgICAiaWZyYW1lX3JldHJpZXNfZXhoYXVzdGVkIiwKICAgICJ1cGRhdGVfY29ubmVjdGVkX2NjcHMiLAogICAgIm91dGVyX2NvbnRleHRfaW5mbyIsCiAgICAibWVkaWFfZGV2aWNlX3JlcXVlc3QiLAogICAgIm1lZGlhX2RldmljZV9yZXNwb25zZSIKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBNYXN0ZXJUb3BpY3MKICAgKi8KICB2YXIgTWFzdGVyVG9waWNzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2Nvbm5lY3QnLCBbCiAgICAnbG9naW5Qb3B1cCcsCiAgICAnc2VuZExvZ3MnLAogICAgJ3NvZnRwaG9uZScsCiAgICAncmluZ3RvbmUnLAogICAgJ21ldHJpY3MnCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQWdlbnRFdmVudHMKICAgKi8KICB2YXIgQWdlbnRFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnYWdlbnQnLCBbCiAgICAnaW5pdCcsCiAgICAndXBkYXRlJywKICAgICdyZWZyZXNoJywKICAgICdyb3V0YWJsZScsCiAgICAnbm90X3JvdXRhYmxlJywKICAgICdwZW5kaW5nJywKICAgICdjb250YWN0X3BlbmRpbmcnLAogICAgJ29mZmxpbmUnLAogICAgJ2Vycm9yJywKICAgICdzb2Z0cGhvbmVfZXJyb3InLAogICAgJ3dlYnNvY2tldF9jb25uZWN0aW9uX2xvc3QnLAogICAgJ3dlYnNvY2tldF9jb25uZWN0aW9uX2dhaW5lZCcsCiAgICAnc3RhdGVfY2hhbmdlJywKICAgICdhY3cnLAogICAgJ211dGVfdG9nZ2xlJywKICAgICdsb2NhbF9tZWRpYV9zdHJlYW1fY3JlYXRlZCcsCiAgICAnZW5xdWV1ZWRfbmV4dF9zdGF0ZScKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBlbnVtIFdlYlNvY2tldEV2ZW50cwogICovCiAgdmFyIFdlYlNvY2tldEV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCd3ZWJTb2NrZXQnLCBbCiAgICAnaW5pdF9mYWlsdXJlJywKICAgICdjb25uZWN0aW9uX29wZW4nLAogICAgJ2Nvbm5lY3Rpb25fY2xvc2UnLAogICAgJ2Nvbm5lY3Rpb25fZXJyb3InLAogICAgJ2Nvbm5lY3Rpb25fZ2FpbicsCiAgICAnY29ubmVjdGlvbl9sb3N0JywKICAgICdzdWJzY3JpcHRpb25fdXBkYXRlJywKICAgICdzdWJzY3JpcHRpb25fZmFpbHVyZScsCiAgICAnYWxsX21lc3NhZ2UnLAogICAgJ3NlbmQnLAogICAgJ3N1YnNjcmliZScKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGVudW0gQ29udGFjdEV2ZW50cwogICAgKi8KICB2YXIgQ29udGFjdEV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdjb250YWN0JywgWwogICAgJ2luaXQnLAogICAgJ3JlZnJlc2gnLAogICAgJ2Rlc3Ryb3llZCcsCiAgICAnaW5jb21pbmcnLAogICAgJ3BlbmRpbmcnLAogICAgJ2Nvbm5lY3RpbmcnLAogICAgJ2Nvbm5lY3RlZCcsCiAgICAnbWlzc2VkJywKICAgICdhY3cnLAogICAgJ3ZpZXcnLAogICAgJ2VuZGVkJywKICAgICdlcnJvcicsCiAgICAnYWNjZXB0ZWQnCiAgXSk7CgogIHZhciBDaGFubmVsVmlld0V2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCd0YXNrTGlzdCcsIFsKICAgICdhY3RpdmF0ZV9jaGFubmVsX3dpdGhfdmlld190eXBlJwogIF0pOwogIAogIHZhciBUYXNrRXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ3Rhc2snLCBbCiAgICAgICdjcmVhdGVkJwogIF0pOwoKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBlbnVtIENvbm5lY3Rpb25FdmVudHMKICAqLwogIHZhciBDb25uZWN0aW9uRXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2Nvbm5lY3Rpb24nLCBbCiAgICAnc2Vzc2lvbl9pbml0JywKICAgICdyZWFkeV90b19zdGFydF9zZXNzaW9uJwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIENvbmZpZ3VyYXRpb24gRXZlbnRzCiAgICovCiAgdmFyIENvbmZpZ3VyYXRpb25FdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnY29uZmlndXJhdGlvbicsIFsKICAgICdjb25maWd1cmUnLAogICAgJ3NldF9zcGVha2VyX2RldmljZScsCiAgICAnc2V0X21pY3JvcGhvbmVfZGV2aWNlJywKICAgICdzZXRfcmluZ2VyX2RldmljZScsCiAgICAnc3BlYWtlcl9kZXZpY2VfY2hhbmdlZCcsCiAgICAnbWljcm9waG9uZV9kZXZpY2VfY2hhbmdlZCcsCiAgICAncmluZ2VyX2RldmljZV9jaGFuZ2VkJwogIF0pOwoKICB2YXIgRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdkaXNhc3RlclJlY292ZXJ5JywgWwogICAgJ3N1cHByZXNzJywKICAgICdmb3JjZV9vZmZsaW5lJywgLy8gbGV0dGluZyB0aGUgc2hhcmVkd29ya2VyIGtub3cgdG8gZm9yY2Ugb2ZmbGluZSAKICAgICdzZXRfb2ZmbGluZScsIC8vIGlmcmFtZSBsZXR0aW5nIHRoZSBuYXRpdmUgY2NwIHRvIHNldCBvZmZsaW5lCiAgICAnaW5pdF9kaXNhc3Rlcl9yZWNvdmVyeScsCiAgICAnZmFpbG92ZXInIC8vIHVzZWQgdG8gcHJvcGFnYXRlIGZhaWxvdmVyIHN0YXRlIHRvIG90aGVyIHdpbmRvd3MKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBDb25maWd1cmF0aW9uIEV2ZW50cwogICAqLwogIHZhciBDb25maWd1cmF0aW9uRXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2NvbmZpZ3VyYXRpb24nLCBbCiAgICAnY29uZmlndXJlJywKICAgICdzZXRfc3BlYWtlcl9kZXZpY2UnLAogICAgJ3NldF9taWNyb3Bob25lX2RldmljZScsCiAgICAnc2V0X3Jpbmdlcl9kZXZpY2UnLAogICAgJ3NwZWFrZXJfZGV2aWNlX2NoYW5nZWQnLAogICAgJ21pY3JvcGhvbmVfZGV2aWNlX2NoYW5nZWQnLAogICAgJ3Jpbmdlcl9kZXZpY2VfY2hhbmdlZCcKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBWb2ljZUlkIEV2ZW50cwogICAqLwogICB2YXIgVm9pY2VJZEV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCd2b2ljZUlkJywgWwogICAgJ3VwZGF0ZV9kb21haW5faWQnCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIEV2ZW50RmFjdG9yeQogICAqLwogIHZhciBFdmVudEZhY3RvcnkgPSBmdW5jdGlvbiAoKSB7IH07CiAgRXZlbnRGYWN0b3J5LmNyZWF0ZVJlcXVlc3QgPSBmdW5jdGlvbiAodHlwZSwgbWV0aG9kLCBwYXJhbXMpIHsKICAgIHJldHVybiB7CiAgICAgIGV2ZW50OiB0eXBlLAogICAgICByZXF1ZXN0SWQ6IGNvbm5lY3QucmFuZG9tSWQoKSwKICAgICAgbWV0aG9kOiBtZXRob2QsCiAgICAgIHBhcmFtczogcGFyYW1zCiAgICB9OwogIH07CgogIEV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZSA9IGZ1bmN0aW9uICh0eXBlLCByZXF1ZXN0LCBkYXRhLCBlcnIpIHsKICAgIHJldHVybiB7CiAgICAgIGV2ZW50OiB0eXBlLAogICAgICByZXF1ZXN0SWQ6IHJlcXVlc3QucmVxdWVzdElkLAogICAgICBkYXRhOiBkYXRhLAogICAgICBlcnI6IGVyciB8fCBudWxsCiAgICB9OwogIH07CgogIC8qKgogICAqIEFuIG9iamVjdCByZXByZXNlbnRpbmcgYW4gZXZlbnQgc3Vic2NyaXB0aW9uIGluIGFuIEV2ZW50QnVzLgogICAqLwogIHZhciBTdWJzY3JpcHRpb24gPSBmdW5jdGlvbiAoc3ViTWFwLCBldmVudE5hbWUsIGYpIHsKICAgIHRoaXMuc3ViTWFwID0gc3ViTWFwOwogICAgdGhpcy5pZCA9IGNvbm5lY3QucmFuZG9tSWQoKTsKICAgIHRoaXMuZXZlbnROYW1lID0gZXZlbnROYW1lOwogICAgdGhpcy5mID0gZjsKICB9OwoKICAvKioKICAgKiBVbnN1YnNjcmliZSB0aGUgaGFuZGxlciBvZiB0aGlzIHN1YnNjcmlwdGlvbiBmcm9tIHRoZSBFdmVudEJ1cwogICAqIGZyb20gd2hpY2ggaXQgd2FzIGNyZWF0ZWQuCiAgICovCiAgU3Vic2NyaXB0aW9uLnByb3RvdHlwZS51bnN1YnNjcmliZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuc3ViTWFwLnVuc3Vic2NyaWJlKHRoaXMuZXZlbnROYW1lLCB0aGlzLmlkKTsKICB9OwoKICAvKioKICAgKiBBIG1hcCBvZiBldmVudCBzdWJzY3JpcHRpb25zLCB1c2VkIGJ5IHRoZSBFdmVudEJ1cy4KICAgKi8KICB2YXIgU3Vic2NyaXB0aW9uTWFwID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5zdWJJZE1hcCA9IHt9OwogICAgdGhpcy5zdWJFdmVudE5hbWVNYXAgPSB7fTsKICB9OwoKICAvKioKICAgKiBBZGQgYSBzdWJzY3JpcHRpb24gZm9yIHRoZSBuYW1lZCBldmVudC4gIENyZWF0ZXMgYSBuZXcgU3Vic2NyaXB0aW9uCiAgICogb2JqZWN0IGFuZCByZXR1cm5zIGl0LiAgVGhpcyBvYmplY3QgY2FuIGJlIHVzZWQgdG8gdW5zdWJzY3JpYmUuCiAgICovCiAgU3Vic2NyaXB0aW9uTWFwLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBmKSB7CiAgICB2YXIgc3ViID0gbmV3IFN1YnNjcmlwdGlvbih0aGlzLCBldmVudE5hbWUsIGYpOwoKICAgIHRoaXMuc3ViSWRNYXBbc3ViLmlkXSA9IHN1YjsKICAgIHZhciBzdWJMaXN0ID0gdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXSB8fCBbXTsKICAgIHN1Ykxpc3QucHVzaChzdWIpOwogICAgdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXSA9IHN1Ykxpc3Q7CiAgICByZXR1cm4gc3ViOwogIH07CgogIC8qKgogICAqIFVuc3Vic2NyaWJlIGEgc3Vic2NyaXB0aW9uIG1hdGNoaW5nIHRoZSBnaXZlbiBldmVudCBuYW1lIGFuZCBpZC4KICAgKi8KICBTdWJzY3JpcHRpb25NYXAucHJvdG90eXBlLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgc3ViSWQpIHsKICAgIGlmIChjb25uZWN0LmNvbnRhaW5zKHRoaXMuc3ViRXZlbnROYW1lTWFwLCBldmVudE5hbWUpKSB7CiAgICAgIHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0gPSB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdLmZpbHRlcihmdW5jdGlvbiAocykgeyByZXR1cm4gcy5pZCAhPT0gc3ViSWQ7IH0pOwoKICAgICAgaWYgKHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0ubGVuZ3RoIDwgMSkgewogICAgICAgIGRlbGV0ZSB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdOwogICAgICB9CiAgICB9CgogICAgaWYgKGNvbm5lY3QuY29udGFpbnModGhpcy5zdWJJZE1hcCwgc3ViSWQpKSB7CiAgICAgIGRlbGV0ZSB0aGlzLnN1YklkTWFwW3N1YklkXTsKICAgIH0KICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIGFsbCBzdWJzY3JpcHRpb25zIGluIHRoZSBzdWJzY3JpcHRpb24gbWFwLgogICAqLwogIFN1YnNjcmlwdGlvbk1hcC5wcm90b3R5cGUuZ2V0QWxsU3Vic2NyaXB0aW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LnZhbHVlcyh0aGlzLnN1YkV2ZW50TmFtZU1hcCkucmVkdWNlKGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgIHJldHVybiBhLmNvbmNhdChiKTsKICAgIH0sIFtdKTsKICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIHN1YnNjcmlwdGlvbnMgZm9yIHRoZSBnaXZlbiBldmVudCBuYW1lLCBvciBhbiBlbXB0eQogICAqIGxpc3QgaWYgdGhlcmUgYXJlIG5vIHN1YnNjcmlwdGlvbnMuCiAgICovCiAgU3Vic2NyaXB0aW9uTWFwLnByb3RvdHlwZS5nZXRTdWJzY3JpcHRpb25zID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgcmV0dXJuIHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0gfHwgW107CiAgfTsKCiAgLyoqCiAgICogQW4gb2JqZWN0IHdoaWNoIG1haW50YWlucyBhIG1hcCBvZiBzdWJzY3JpcHRpb25zIGFuZCBzZXJ2ZXMgYXMgdGhlCiAgICogbWVjaGFuaXNtIGZvciB0cmlnZ2VyaW5nIGV2ZW50cyB0byBiZSBoYW5kbGVkIGJ5IHN1YnNjcmliZXJzLgogICAqLwogIHZhciBFdmVudEJ1cyA9IGZ1bmN0aW9uIChwYXJhbXNJbikgewogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwoKICAgIHRoaXMuc3ViTWFwID0gbmV3IFN1YnNjcmlwdGlvbk1hcCgpOwogICAgdGhpcy5sb2dFdmVudHMgPSBwYXJhbXMubG9nRXZlbnRzIHx8IGZhbHNlOwogIH07CgogIC8qKgogICAqIFN1YnNjcmliZSB0byB0aGUgbmFtZWQgZXZlbnQuICBSZXR1cm5zIGEgbmV3IFN1YnNjcmlwdGlvbiBvYmplY3QKICAgKiB3aGljaCBjYW4gYmUgdXNlZCB0byB1bnN1YnNjcmliZS4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgZikgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgIHJldHVybiB0aGlzLnN1Yk1hcC5zdWJzY3JpYmUoZXZlbnROYW1lLCBmKTsKICB9OwoKICAvKioKICAgKiBTdWJzY3JpYmUgYSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgb24gYWxsIGV2ZW50cy4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuc3Vic2NyaWJlQWxsID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICByZXR1cm4gdGhpcy5zdWJNYXAuc3Vic2NyaWJlKEFMTF9FVkVOVFMsIGYpOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2Ygc3Vic2NyaXB0aW9ucyBmb3IgdGhlIGdpdmVuIGV2ZW50IG5hbWUsIG9yIGFuIGVtcHR5CiAgICogbGlzdCBpZiB0aGVyZSBhcmUgbm8gc3Vic2NyaXB0aW9ucy4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuZ2V0U3Vic2NyaXB0aW9ucyA9IGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgIHJldHVybiB0aGlzLnN1Yk1hcC5nZXRTdWJzY3JpcHRpb25zKGV2ZW50TmFtZSk7CiAgfTsKCiAgLyoqCiAgICogVHJpZ2dlciB0aGUgZ2l2ZW4gZXZlbnQgd2l0aCB0aGUgZ2l2ZW4gZGF0YS4gIEFsbCBtZXRob2RzIHN1YnNjcmliZWQKICAgKiB0byB0aGlzIGV2ZW50IHdpbGwgYmUgY2FsbGVkIGFuZCBhcmUgcHJvdmlkZWQgd2l0aCB0aGUgZ2l2ZW4gYXJiaXRyYXJ5CiAgICogZGF0YSBvYmplY3QgYW5kIHRoZSBuYW1lIG9mIHRoZSBldmVudCwgaW4gdGhhdCBvcmRlci4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUudHJpZ2dlciA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGRhdGEpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBhbGxFdmVudFN1YnMgPSB0aGlzLnN1Yk1hcC5nZXRTdWJzY3JpcHRpb25zKEFMTF9FVkVOVFMpOwogICAgdmFyIGV2ZW50U3VicyA9IHRoaXMuc3ViTWFwLmdldFN1YnNjcmlwdGlvbnMoZXZlbnROYW1lKTsKCiAgICBpZiAodGhpcy5sb2dFdmVudHMgJiYKICAgICAgICBldmVudE5hbWUgIT09IGNvbm5lY3QuRXZlbnRUeXBlLkxPRyAmJgogICAgICAgIGV2ZW50TmFtZSAhPT0gY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFU1BPTlNFICYmCiAgICAgICAgZXZlbnROYW1lICE9PSBjb25uZWN0LkV2ZW50VHlwZS5BUElfTUVUUklDICYmCiAgICAgICAgZXZlbnROYW1lICE9PSBjb25uZWN0LkV2ZW50VHlwZS5TRVJWRVJfQk9VTkRfSU5URVJOQUxfTE9HCiAgICApIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiUHVibGlzaGluZyBldmVudDogJXMiLCBldmVudE5hbWUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CgogICAgaWYgKAogICAgICBldmVudE5hbWUuc3RhcnRzV2l0aChjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQpICYmCiAgICAgIGRhdGEgJiYKICAgICAgZGF0YS5jb250YWN0SWQgJiYKICAgICAgIShkYXRhIGluc3RhbmNlb2YgY29ubmVjdC5Db250YWN0KQogICAgKSB7CiAgICAgIGRhdGEgPSBuZXcgY29ubmVjdC5Db250YWN0KGRhdGEuY29udGFjdElkKTsKICAgIH0KCiAgICBhbGxFdmVudFN1YnMuY29uY2F0KGV2ZW50U3VicykuZm9yRWFjaChmdW5jdGlvbiAoc3ViKSB7CiAgICAgIHRyeSB7CiAgICAgICAgc3ViLmYoZGF0YSB8fCBudWxsLCBldmVudE5hbWUsIHNlbGYpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiJyVzJyBldmVudCBoYW5kbGVyIGZhaWxlZC4iLCBldmVudE5hbWUpLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogUmV0dXJucyBhIGNsb3N1cmUgd2hpY2ggYnJpZGdlcyBhbiBldmVudCBmcm9tIGFub3RoZXIgRXZlbnRCdXMgdG8gdGhpcyBidXMuCiAgICoKICAgKiBVc2FnZToKICAgKiBjb25kdWl0Lm9uVXBzdHJlYW0oIk15RXZlbnQiLCBidXMuYnJpZGdlKCkpOwogICAqLwogIEV2ZW50QnVzLnByb3RvdHlwZS5icmlkZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICByZXR1cm4gZnVuY3Rpb24gKGRhdGEsIGV2ZW50KSB7CiAgICAgIHNlbGYudHJpZ2dlcihldmVudCwgZGF0YSk7CiAgICB9OwogIH07CgogIC8qKgogICAqIFVuc3Vic2NyaWJlIGFsbCBldmVudHMgaW4gdGhlIGV2ZW50IGJ1cy4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUudW5zdWJzY3JpYmVBbGwgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnN1Yk1hcC5nZXRBbGxTdWJzY3JpcHRpb25zKCkuZm9yRWFjaChmdW5jdGlvbiAoc3ViKSB7CiAgICAgIHN1Yi51bnN1YnNjcmliZSgpOwogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5FdmVudEJ1cyA9IEV2ZW50QnVzOwogIGNvbm5lY3QuRXZlbnRGYWN0b3J5ID0gRXZlbnRGYWN0b3J5OwogIGNvbm5lY3QuRXZlbnRUeXBlID0gRXZlbnRUeXBlOwogIGNvbm5lY3QuQWdlbnRFdmVudHMgPSBBZ2VudEV2ZW50czsKICBjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMgPSBDb25maWd1cmF0aW9uRXZlbnRzOwogIGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cyA9IENvbm5lY3Rpb25FdmVudHM7CiAgY29ubmVjdC5Db25ubmVjdGlvbkV2ZW50cyA9IENvbm5lY3Rpb25FdmVudHM7IC8vZGVwcmVjYXRlIG9uIG5leHQgbWFqb3IgdmVyc2lvbiByZWxlYXNlLgogIGNvbm5lY3QuQ29udGFjdEV2ZW50cyA9IENvbnRhY3RFdmVudHM7CiAgY29ubmVjdC5DaGFubmVsVmlld0V2ZW50cyA9IENoYW5uZWxWaWV3RXZlbnRzOwogIGNvbm5lY3QuVGFza0V2ZW50cyA9IFRhc2tFdmVudHM7CiAgY29ubmVjdC5Wb2ljZUlkRXZlbnRzID0gVm9pY2VJZEV2ZW50czsKICBjb25uZWN0LldlYlNvY2tldEV2ZW50cyA9IFdlYlNvY2tldEV2ZW50czsKICBjb25uZWN0Lk1hc3RlclRvcGljcyA9IE1hc3RlclRvcGljczsKICBjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMgPSBEaXNhc3RlclJlY292ZXJ5RXZlbnRzOwp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gMjg2OgovKioqLyAoKCkgPT4gewoKIWZ1bmN0aW9uKGUpe3ZhciBuPXt9O2Z1bmN0aW9uIHQobyl7aWYobltvXSlyZXR1cm4gbltvXS5leHBvcnRzO3ZhciByPW5bb109e2k6byxsOiExLGV4cG9ydHM6e319O3JldHVybiBlW29dLmNhbGwoci5leHBvcnRzLHIsci5leHBvcnRzLHQpLHIubD0hMCxyLmV4cG9ydHN9dC5tPWUsdC5jPW4sdC5kPWZ1bmN0aW9uKGUsbixvKXt0Lm8oZSxuKXx8T2JqZWN0LmRlZmluZVByb3BlcnR5KGUsbix7ZW51bWVyYWJsZTohMCxnZXQ6b30pfSx0LnI9ZnVuY3Rpb24oZSl7InVuZGVmaW5lZCIhPXR5cGVvZiBTeW1ib2wmJlN5bWJvbC50b1N0cmluZ1RhZyYmT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsU3ltYm9sLnRvU3RyaW5nVGFnLHt2YWx1ZToiTW9kdWxlIn0pLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KX0sdC50PWZ1bmN0aW9uKGUsbil7aWYoMSZuJiYoZT10KGUpKSw4Jm4pcmV0dXJuIGU7aWYoNCZuJiYib2JqZWN0Ij09dHlwZW9mIGUmJmUmJmUuX19lc01vZHVsZSlyZXR1cm4gZTt2YXIgbz1PYmplY3QuY3JlYXRlKG51bGwpO2lmKHQucihvKSxPYmplY3QuZGVmaW5lUHJvcGVydHkobywiZGVmYXVsdCIse2VudW1lcmFibGU6ITAsdmFsdWU6ZX0pLDImbiYmInN0cmluZyIhPXR5cGVvZiBlKWZvcih2YXIgciBpbiBlKXQuZChvLHIsZnVuY3Rpb24obil7cmV0dXJuIGVbbl19LmJpbmQobnVsbCxyKSk7cmV0dXJuIG99LHQubj1mdW5jdGlvbihlKXt2YXIgbj1lJiZlLl9fZXNNb2R1bGU/ZnVuY3Rpb24oKXtyZXR1cm4gZS5kZWZhdWx0fTpmdW5jdGlvbigpe3JldHVybiBlfTtyZXR1cm4gdC5kKG4sImEiLG4pLG59LHQubz1mdW5jdGlvbihlLG4pe3JldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoZSxuKX0sdC5wPSIiLHQodC5zPTIpfShbZnVuY3Rpb24oZSxuLHQpeyJ1c2Ugc3RyaWN0Ijt2YXIgbz10KDEpLHI9Ik5VTEwiLGk9IkNMSUVOVF9MT0dHRVIiLGM9IkRFQlVHIixzPTJlMyxhPSJhd3Mvc3Vic2NyaWJlIix1PSJhd3MvdW5zdWJzY3JpYmUiLGw9ImF3cy9oZWFydGJlYXQiLGY9ImNvbm5lY3RlZCIscD0iZGlzY29ubmVjdGVkIjtmdW5jdGlvbiBkKGUpe3JldHVybihkPSJmdW5jdGlvbiI9PXR5cGVvZiBTeW1ib2wmJiJzeW1ib2wiPT10eXBlb2YgU3ltYm9sLml0ZXJhdG9yP2Z1bmN0aW9uKGUpe3JldHVybiB0eXBlb2YgZX06ZnVuY3Rpb24oZSl7cmV0dXJuIGUmJiJmdW5jdGlvbiI9PXR5cGVvZiBTeW1ib2wmJmUuY29uc3RydWN0b3I9PT1TeW1ib2wmJmUhPT1TeW1ib2wucHJvdG90eXBlPyJzeW1ib2wiOnR5cGVvZiBlfSkoZSl9dmFyIGI9e2Fzc2VydFRydWU6ZnVuY3Rpb24oZSxuKXtpZighZSl0aHJvdyBuZXcgRXJyb3Iobil9LGFzc2VydE5vdE51bGw6ZnVuY3Rpb24oZSxuKXtyZXR1cm4gYi5hc3NlcnRUcnVlKG51bGwhPT1lJiZ2b2lkIDAhPT1kKGUpLE9iamVjdChvLnNwcmludGYpKCIlcyBtdXN0IGJlIHByb3ZpZGVkIixufHwiQSB2YWx1ZSIpKSxlfSxpc05vbkVtcHR5U3RyaW5nOmZ1bmN0aW9uKGUpe3JldHVybiJzdHJpbmciPT10eXBlb2YgZSYmZS5sZW5ndGg+MH0sYXNzZXJ0SXNMaXN0OmZ1bmN0aW9uKGUsbil7aWYoIUFycmF5LmlzQXJyYXkoZSkpdGhyb3cgbmV3IEVycm9yKG4rIiBpcyBub3QgYW4gYXJyYXkiKX0saXNGdW5jdGlvbjpmdW5jdGlvbihlKXtyZXR1cm4hIShlJiZlLmNvbnN0cnVjdG9yJiZlLmNhbGwmJmUuYXBwbHkpfSxpc09iamVjdDpmdW5jdGlvbihlKXtyZXR1cm4hKCJvYmplY3QiIT09ZChlKXx8bnVsbD09PWUpfSxpc1N0cmluZzpmdW5jdGlvbihlKXtyZXR1cm4ic3RyaW5nIj09dHlwZW9mIGV9LGlzTnVtYmVyOmZ1bmN0aW9uKGUpe3JldHVybiJudW1iZXIiPT10eXBlb2YgZX19LGc9bmV3IFJlZ0V4cCgiXih3c3M6Ly8pXFx3KiIpO2IudmFsaWRXU1VybD1mdW5jdGlvbihlKXtyZXR1cm4gZy50ZXN0KGUpfSxiLmdldFN1YnNjcmlwdGlvblJlc3BvbnNlPWZ1bmN0aW9uKGUsbix0KXtyZXR1cm57dG9waWM6ZSxjb250ZW50OntzdGF0dXM6bj8ic3VjY2VzcyI6ImZhaWx1cmUiLHRvcGljczp0fX19LGIuYXNzZXJ0SXNPYmplY3Q9ZnVuY3Rpb24oZSxuKXtpZighYi5pc09iamVjdChlKSl0aHJvdyBuZXcgRXJyb3IobisiIGlzIG5vdCBhbiBvYmplY3QhIil9LGIuYWRkSml0dGVyPWZ1bmN0aW9uKGUpe3ZhciBuPWFyZ3VtZW50cy5sZW5ndGg+MSYmdm9pZCAwIT09YXJndW1lbnRzWzFdP2FyZ3VtZW50c1sxXToxO249TWF0aC5taW4obiwxKTt2YXIgdD1NYXRoLnJhbmRvbSgpPi41PzE6LTE7cmV0dXJuIE1hdGguZmxvb3IoZSt0KmUqTWF0aC5yYW5kb20oKSpuKX0sYi5pc05ldHdvcmtPbmxpbmU9ZnVuY3Rpb24oKXtyZXR1cm4gbmF2aWdhdG9yLm9uTGluZX0sYi5pc05ldHdvcmtGYWlsdXJlPWZ1bmN0aW9uKGUpe3JldHVybiEoIWUuX2RlYnVnfHwhZS5fZGVidWcudHlwZSkmJiJOZXR3b3JraW5nRXJyb3IiPT09ZS5fZGVidWcudHlwZX07dmFyIHk9YjtmdW5jdGlvbiBtKGUpe3JldHVybihtPSJmdW5jdGlvbiI9PXR5cGVvZiBTeW1ib2wmJiJzeW1ib2wiPT10eXBlb2YgU3ltYm9sLml0ZXJhdG9yP2Z1bmN0aW9uKGUpe3JldHVybiB0eXBlb2YgZX06ZnVuY3Rpb24oZSl7cmV0dXJuIGUmJiJmdW5jdGlvbiI9PXR5cGVvZiBTeW1ib2wmJmUuY29uc3RydWN0b3I9PT1TeW1ib2wmJmUhPT1TeW1ib2wucHJvdG90eXBlPyJzeW1ib2wiOnR5cGVvZiBlfSkoZSl9ZnVuY3Rpb24gUyhlLG4pe3JldHVybiFufHwib2JqZWN0IiE9PW0obikmJiJmdW5jdGlvbiIhPXR5cGVvZiBuP2Z1bmN0aW9uKGUpe2lmKHZvaWQgMD09PWUpdGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCJ0aGlzIGhhc24ndCBiZWVuIGluaXRpYWxpc2VkIC0gc3VwZXIoKSBoYXNuJ3QgYmVlbiBjYWxsZWQiKTtyZXR1cm4gZX0oZSk6bn1mdW5jdGlvbiBrKGUpe3JldHVybihrPU9iamVjdC5zZXRQcm90b3R5cGVPZj9PYmplY3QuZ2V0UHJvdG90eXBlT2Y6ZnVuY3Rpb24oZSl7cmV0dXJuIGUuX19wcm90b19ffHxPYmplY3QuZ2V0UHJvdG90eXBlT2YoZSl9KShlKX1mdW5jdGlvbiBoKGUsbil7cmV0dXJuKGg9T2JqZWN0LnNldFByb3RvdHlwZU9mfHxmdW5jdGlvbihlLG4pe3JldHVybiBlLl9fcHJvdG9fXz1uLGV9KShlLG4pfWZ1bmN0aW9uIHYoZSxuKXtpZighKGUgaW5zdGFuY2VvZiBuKSl0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKX1mdW5jdGlvbiB3KGUsbil7Zm9yKHZhciB0PTA7dDxuLmxlbmd0aDt0Kyspe3ZhciBvPW5bdF07by5lbnVtZXJhYmxlPW8uZW51bWVyYWJsZXx8ITEsby5jb25maWd1cmFibGU9ITAsInZhbHVlImluIG8mJihvLndyaXRhYmxlPSEwKSxPYmplY3QuZGVmaW5lUHJvcGVydHkoZSxvLmtleSxvKX19ZnVuY3Rpb24gQyhlLG4sdCl7cmV0dXJuIG4mJncoZS5wcm90b3R5cGUsbiksdCYmdyhlLHQpLGV9dmFyIFQ9ZnVuY3Rpb24oKXtmdW5jdGlvbiBlKCl7dih0aGlzLGUpfXJldHVybiBDKGUsW3trZXk6ImRlYnVnIix2YWx1ZTpmdW5jdGlvbihlKXt9fSx7a2V5OiJpbmZvIix2YWx1ZTpmdW5jdGlvbihlKXt9fSx7a2V5OiJ3YXJuIix2YWx1ZTpmdW5jdGlvbihlKXt9fSx7a2V5OiJlcnJvciIsdmFsdWU6ZnVuY3Rpb24oZSl7fX1dKSxlfSgpLE89e0RFQlVHOjEwLElORk86MjAsV0FSTjozMCxFUlJPUjo0MH0sST1mdW5jdGlvbigpe2Z1bmN0aW9uIGUoKXt2KHRoaXMsZSksdGhpcy51cGRhdGVMb2dnZXJDb25maWcoKSx0aGlzLmNvbnNvbGVMb2dnZXJXcmFwcGVyPV8oKX1yZXR1cm4gQyhlLFt7a2V5OiJ3cml0ZVRvQ2xpZW50TG9nZ2VyIix2YWx1ZTpmdW5jdGlvbihlLG4pe2lmKHRoaXMuaGFzQ2xpZW50TG9nZ2VyKCkpc3dpdGNoKGUpe2Nhc2UgTy5ERUJVRzpyZXR1cm4gdGhpcy5fY2xpZW50TG9nZ2VyLmRlYnVnKG4pO2Nhc2UgTy5JTkZPOnJldHVybiB0aGlzLl9jbGllbnRMb2dnZXIuaW5mbyhuKTtjYXNlIE8uV0FSTjpyZXR1cm4gdGhpcy5fY2xpZW50TG9nZ2VyLndhcm4obik7Y2FzZSBPLkVSUk9SOnJldHVybiB0aGlzLl9jbGllbnRMb2dnZXIuZXJyb3Iobil9fX0se2tleToiaXNMZXZlbEVuYWJsZWQiLHZhbHVlOmZ1bmN0aW9uKGUpe3JldHVybiBlPj10aGlzLl9sZXZlbH19LHtrZXk6Imhhc0NsaWVudExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oKXtyZXR1cm4gbnVsbCE9PXRoaXMuX2NsaWVudExvZ2dlcn19LHtrZXk6ImdldExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oZSl7dmFyIG49ZS5wcmVmaXh8fCIiO3JldHVybiB0aGlzLl9sb2dzRGVzdGluYXRpb249PT1jP3RoaXMuY29uc29sZUxvZ2dlcldyYXBwZXI6bmV3IE4obil9fSx7a2V5OiJ1cGRhdGVMb2dnZXJDb25maWciLHZhbHVlOmZ1bmN0aW9uKGUpe3ZhciBuPWV8fHt9O3RoaXMuX2xldmVsPW4ubGV2ZWx8fE8uREVCVUcsdGhpcy5fY2xpZW50TG9nZ2VyPW4ubG9nZ2VyfHxudWxsLHRoaXMuX2xvZ3NEZXN0aW5hdGlvbj1yLG4uZGVidWcmJih0aGlzLl9sb2dzRGVzdGluYXRpb249Yyksbi5sb2dnZXImJih0aGlzLl9sb2dzRGVzdGluYXRpb249aSl9fV0pLGV9KCksVz1mdW5jdGlvbigpe2Z1bmN0aW9uIGUoKXt2KHRoaXMsZSl9cmV0dXJuIEMoZSxbe2tleToiZGVidWciLHZhbHVlOmZ1bmN0aW9uKCl7fX0se2tleToiaW5mbyIsdmFsdWU6ZnVuY3Rpb24oKXt9fSx7a2V5OiJ3YXJuIix2YWx1ZTpmdW5jdGlvbigpe319LHtrZXk6ImVycm9yIix2YWx1ZTpmdW5jdGlvbigpe319XSksZX0oKSxOPWZ1bmN0aW9uKGUpe2Z1bmN0aW9uIG4oZSl7dmFyIHQ7cmV0dXJuIHYodGhpcyxuKSwodD1TKHRoaXMsayhuKS5jYWxsKHRoaXMpKSkucHJlZml4PWV8fCIiLHR9cmV0dXJuIGZ1bmN0aW9uKGUsbil7aWYoImZ1bmN0aW9uIiE9dHlwZW9mIG4mJm51bGwhPT1uKXRocm93IG5ldyBUeXBlRXJyb3IoIlN1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uIik7ZS5wcm90b3R5cGU9T2JqZWN0LmNyZWF0ZShuJiZuLnByb3RvdHlwZSx7Y29uc3RydWN0b3I6e3ZhbHVlOmUsd3JpdGFibGU6ITAsY29uZmlndXJhYmxlOiEwfX0pLG4mJmgoZSxuKX0obixXKSxDKG4sW3trZXk6ImRlYnVnIix2YWx1ZTpmdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiB0aGlzLl9sb2coTy5ERUJVRyxuKX19LHtrZXk6ImluZm8iLHZhbHVlOmZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07cmV0dXJuIHRoaXMuX2xvZyhPLklORk8sbil9fSx7a2V5OiJ3YXJuIix2YWx1ZTpmdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiB0aGlzLl9sb2coTy5XQVJOLG4pfX0se2tleToiZXJyb3IiLHZhbHVlOmZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07cmV0dXJuIHRoaXMuX2xvZyhPLkVSUk9SLG4pfX0se2tleToiX3Nob3VsZExvZyIsdmFsdWU6ZnVuY3Rpb24oZSl7cmV0dXJuIEUuaGFzQ2xpZW50TG9nZ2VyKCkmJkUuaXNMZXZlbEVuYWJsZWQoZSl9fSx7a2V5OiJfd3JpdGVUb0NsaWVudExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oZSxuKXtyZXR1cm4gRS53cml0ZVRvQ2xpZW50TG9nZ2VyKGUsbil9fSx7a2V5OiJfbG9nIix2YWx1ZTpmdW5jdGlvbihlLG4pe2lmKHRoaXMuX3Nob3VsZExvZyhlKSl7dmFyIHQ9dGhpcy5fY29udmVydFRvU2luZ2xlU3RhdGVtZW50KG4pO3JldHVybiB0aGlzLl93cml0ZVRvQ2xpZW50TG9nZ2VyKGUsdCl9fX0se2tleToiX2NvbnZlcnRUb1NpbmdsZVN0YXRlbWVudCIsdmFsdWU6ZnVuY3Rpb24oZSl7dmFyIG49IiI7dGhpcy5wcmVmaXgmJihuKz10aGlzLnByZWZpeCsiICIpO2Zvcih2YXIgdD0wO3Q8ZS5sZW5ndGg7dCsrKXt2YXIgbz1lW3RdO24rPXRoaXMuX2NvbnZlcnRUb1N0cmluZyhvKSsiICJ9cmV0dXJuIG59fSx7a2V5OiJfY29udmVydFRvU3RyaW5nIix2YWx1ZTpmdW5jdGlvbihlKXt0cnl7aWYoIWUpcmV0dXJuIiI7aWYoeS5pc1N0cmluZyhlKSlyZXR1cm4gZTtpZih5LmlzT2JqZWN0KGUpJiZ5LmlzRnVuY3Rpb24oZS50b1N0cmluZykpe3ZhciBuPWUudG9TdHJpbmcoKTtpZigiW29iamVjdCBPYmplY3RdIiE9PW4pcmV0dXJuIG59cmV0dXJuIEpTT04uc3RyaW5naWZ5KGUpfWNhdGNoKG4pe3JldHVybiBjb25zb2xlLmVycm9yKCJFcnJvciB3aGlsZSBjb252ZXJ0aW5nIGFyZ3VtZW50IHRvIHN0cmluZyIsZSxuKSwiIn19fV0pLG59KCksXz1mdW5jdGlvbigpe3ZhciBlPW5ldyBXO3JldHVybiBlLmRlYnVnPWNvbnNvbGUuZGVidWcsZS5pbmZvPWNvbnNvbGUuaW5mbyxlLndhcm49Y29uc29sZS53YXJuLGUuZXJyb3I9Y29uc29sZS5lcnJvcixlfSxFPW5ldyBJO2Z1bmN0aW9uIEYoZSxuKXtmb3IodmFyIHQ9MDt0PG4ubGVuZ3RoO3QrKyl7dmFyIG89blt0XTtvLmVudW1lcmFibGU9by5lbnVtZXJhYmxlfHwhMSxvLmNvbmZpZ3VyYWJsZT0hMCwidmFsdWUiaW4gbyYmKG8ud3JpdGFibGU9ITApLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLG8ua2V5LG8pfX12YXIgTD1mdW5jdGlvbigpe2Z1bmN0aW9uIGUobil7dmFyIHQ9YXJndW1lbnRzLmxlbmd0aD4xJiZ2b2lkIDAhPT1hcmd1bWVudHNbMV0/YXJndW1lbnRzWzFdOnM7IWZ1bmN0aW9uKGUsbil7aWYoIShlIGluc3RhbmNlb2YgbikpdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIil9KHRoaXMsZSksdGhpcy5udW1BdHRlbXB0cz0wLHRoaXMuZXhlY3V0b3I9bix0aGlzLmhhc0FjdGl2ZVJlY29ubmVjdGlvbj0hMSx0aGlzLmRlZmF1bHRSZXRyeT10fXZhciBuLHQsbztyZXR1cm4gbj1lLCh0PVt7a2V5OiJyZXRyeSIsdmFsdWU6ZnVuY3Rpb24oKXt2YXIgZT10aGlzO3RoaXMuaGFzQWN0aXZlUmVjb25uZWN0aW9ufHwodGhpcy5oYXNBY3RpdmVSZWNvbm5lY3Rpb249ITAsc2V0VGltZW91dChmdW5jdGlvbigpe2UuX2V4ZWN1dGUoKX0sdGhpcy5fZ2V0RGVsYXkoKSkpfX0se2tleToiX2V4ZWN1dGUiLHZhbHVlOmZ1bmN0aW9uKCl7dGhpcy5oYXNBY3RpdmVSZWNvbm5lY3Rpb249ITEsdGhpcy5leGVjdXRvcigpLHRoaXMubnVtQXR0ZW1wdHMrK319LHtrZXk6ImNvbm5lY3RlZCIsdmFsdWU6ZnVuY3Rpb24oKXt0aGlzLm51bUF0dGVtcHRzPTB9fSx7a2V5OiJfZ2V0RGVsYXkiLHZhbHVlOmZ1bmN0aW9uKCl7dmFyIGU9TWF0aC5wb3coMix0aGlzLm51bUF0dGVtcHRzKSp0aGlzLmRlZmF1bHRSZXRyeTtyZXR1cm4gZTw9M2U0P2U6M2U0fX1dKSYmRihuLnByb3RvdHlwZSx0KSxvJiZGKG4sbyksZX0oKTt0LmQobiwiYSIsZnVuY3Rpb24oKXtyZXR1cm4gUn0pO3ZhciB4PWZ1bmN0aW9uKCl7dmFyIGU9RS5nZXRMb2dnZXIoe30pLG49eS5pc05ldHdvcmtPbmxpbmUoKSx0PXtwcmltYXJ5Om51bGwsc2Vjb25kYXJ5Om51bGx9LG89e3JlY29ubmVjdFdlYlNvY2tldDohMCx3ZWJzb2NrZXRJbml0RmFpbGVkOiExLGV4cG9uZW50aWFsQmFja09mZlRpbWU6MWUzLGV4cG9uZW50aWFsVGltZW91dEhhbmRsZTpudWxsLGxpZmVUaW1lVGltZW91dEhhbmRsZTpudWxsLHdlYlNvY2tldEluaXRDaGVja2VyVGltZW91dElkOm51bGwsY29ublN0YXRlOm51bGx9LHI9e2Nvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50OjAsY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU6bnVsbCxub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcDpudWxsfSxpPXtwZW5kaW5nUmVzcG9uc2U6ITEsaW50ZXJ2YWxIYW5kbGU6bnVsbH0sYz17aW5pdEZhaWx1cmU6bmV3IFNldCxnZXRXZWJTb2NrZXRUcmFuc3BvcnQ6bnVsbCxzdWJzY3JpcHRpb25VcGRhdGU6bmV3IFNldCxzdWJzY3JpcHRpb25GYWlsdXJlOm5ldyBTZXQsdG9waWM6bmV3IE1hcCxhbGxNZXNzYWdlOm5ldyBTZXQsY29ubmVjdGlvbkdhaW46bmV3IFNldCxjb25uZWN0aW9uTG9zdDpuZXcgU2V0LGNvbm5lY3Rpb25PcGVuOm5ldyBTZXQsY29ubmVjdGlvbkNsb3NlOm5ldyBTZXR9LHM9e2Nvbm5Db25maWc6bnVsbCxwcm9taXNlSGFuZGxlOm51bGwscHJvbWlzZUNvbXBsZXRlZDohMH0sZD17c3Vic2NyaWJlZDpuZXcgU2V0LHBlbmRpbmc6bmV3IFNldCxzdWJzY3JpcHRpb25IaXN0b3J5Om5ldyBTZXR9LGI9e3Jlc3BvbnNlQ2hlY2tJbnRlcnZhbElkOm51bGwscmVxdWVzdENvbXBsZXRlZDohMCxyZVN1YnNjcmliZUludGVydmFsSWQ6bnVsbCxjb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzOjAsY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdDowfSxnPW5ldyBMKGZ1bmN0aW9uKCl7VSgpfSksbT1uZXcgU2V0KFthLHUsbF0pLFM9c2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXtpZihuIT09eS5pc05ldHdvcmtPbmxpbmUoKSl7aWYoIShuPXkuaXNOZXR3b3JrT25saW5lKCkpKXJldHVybiB2b2lkIEooZS5pbmZvKCJOZXR3b3JrIG9mZmxpbmUiKSk7dmFyIHQ9TygpO24mJighdHx8dyh0LFdlYlNvY2tldC5DTE9TSU5HKXx8dyh0LFdlYlNvY2tldC5DTE9TRUQpKSYmKEooZS5pbmZvKCJOZXR3b3JrIG9ubGluZSwgY29ubmVjdGluZyB0byBXZWJTb2NrZXQgc2VydmVyIikpLFUoKSl9fSwyNTApLGs9ZnVuY3Rpb24obix0KXtuLmZvckVhY2goZnVuY3Rpb24obil7dHJ5e24odCl9Y2F0Y2gobil7SihlLmVycm9yKCJFcnJvciBleGVjdXRpbmcgY2FsbGJhY2siLG4pKX19KX0saD1mdW5jdGlvbihlKXtpZihudWxsPT09ZSlyZXR1cm4iTlVMTCI7c3dpdGNoKGUucmVhZHlTdGF0ZSl7Y2FzZSBXZWJTb2NrZXQuQ09OTkVDVElORzpyZXR1cm4iQ09OTkVDVElORyI7Y2FzZSBXZWJTb2NrZXQuT1BFTjpyZXR1cm4iT1BFTiI7Y2FzZSBXZWJTb2NrZXQuQ0xPU0lORzpyZXR1cm4iQ0xPU0lORyI7Y2FzZSBXZWJTb2NrZXQuQ0xPU0VEOnJldHVybiJDTE9TRUQiO2RlZmF1bHQ6cmV0dXJuIlVOREVGSU5FRCJ9fSx2PWZ1bmN0aW9uKCl7dmFyIG49YXJndW1lbnRzLmxlbmd0aD4wJiZ2b2lkIDAhPT1hcmd1bWVudHNbMF0/YXJndW1lbnRzWzBdOiIiO0ooZS5kZWJ1ZygiWyIrbisiXSBQcmltYXJ5IFdlYlNvY2tldDogIitoKHQucHJpbWFyeSkrIiB8IFNlY29uZGFyeSBXZWJTb2NrZXQ6ICIraCh0LnNlY29uZGFyeSkpKX0sdz1mdW5jdGlvbihlLG4pe3JldHVybiBlJiZlLnJlYWR5U3RhdGU9PT1ufSxDPWZ1bmN0aW9uKGUpe3JldHVybiB3KGUsV2ViU29ja2V0Lk9QRU4pfSxUPWZ1bmN0aW9uKGUpe3JldHVybiBudWxsPT09ZXx8dm9pZCAwPT09ZS5yZWFkeVN0YXRlfHx3KGUsV2ViU29ja2V0LkNMT1NFRCl9LE89ZnVuY3Rpb24oKXtyZXR1cm4gbnVsbCE9PXQuc2Vjb25kYXJ5P3Quc2Vjb25kYXJ5OnQucHJpbWFyeX0sST1mdW5jdGlvbigpe3JldHVybiBDKE8oKSl9LFc9ZnVuY3Rpb24oKXtpZihpLnBlbmRpbmdSZXNwb25zZSlyZXR1cm4gSihlLndhcm4oIkhlYXJ0YmVhdCByZXNwb25zZSBub3QgcmVjZWl2ZWQiKSksY2xlYXJJbnRlcnZhbChpLmludGVydmFsSGFuZGxlKSxpLnBlbmRpbmdSZXNwb25zZT0hMSx2b2lkIFUoKTtJKCk/KEooZS5kZWJ1ZygiU2VuZGluZyBoZWFydGJlYXQiKSksTygpLnNlbmQoRyhsKSksaS5wZW5kaW5nUmVzcG9uc2U9ITApOihKKGUud2FybigiRmFpbGVkIHRvIHNlbmQgaGVhcnRiZWF0IHNpbmNlIFdlYlNvY2tldCBpcyBub3Qgb3BlbiIpKSx2KCJzZW5kSGVhcnRCZWF0IiksVSgpKX0sTj1mdW5jdGlvbigpe28uZXhwb25lbnRpYWxCYWNrT2ZmVGltZT0xZTMsaS5wZW5kaW5nUmVzcG9uc2U9ITEsby5yZWNvbm5lY3RXZWJTb2NrZXQ9ITAsY2xlYXJUaW1lb3V0KG8ubGlmZVRpbWVUaW1lb3V0SGFuZGxlKSxjbGVhckludGVydmFsKGkuaW50ZXJ2YWxIYW5kbGUpLGNsZWFyVGltZW91dChvLmV4cG9uZW50aWFsVGltZW91dEhhbmRsZSksY2xlYXJUaW1lb3V0KG8ud2ViU29ja2V0SW5pdENoZWNrZXJUaW1lb3V0SWQpfSxfPWZ1bmN0aW9uKCl7Yi5jb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzPTAsYi5jb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0PTAsY2xlYXJJbnRlcnZhbChiLnJlc3BvbnNlQ2hlY2tJbnRlcnZhbElkKSxjbGVhckludGVydmFsKGIucmVTdWJzY3JpYmVJbnRlcnZhbElkKX0sRj1mdW5jdGlvbigpe3IuY29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQ9MCxyLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lPW51bGwsci5ub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcD1udWxsfSx4PWZ1bmN0aW9uKCl7dHJ5e0ooZS5pbmZvKCJXZWJTb2NrZXQgY29ubmVjdGlvbiBlc3RhYmxpc2hlZCEiKSksdigid2ViU29ja2V0T25PcGVuIiksbnVsbCE9PW8uY29ublN0YXRlJiZvLmNvbm5TdGF0ZSE9PXB8fGsoYy5jb25uZWN0aW9uR2Fpbiksby5jb25uU3RhdGU9Zjt2YXIgbj1EYXRlLm5vdygpO2soYy5jb25uZWN0aW9uT3Blbix7Y29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQ6ci5jb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudCxjb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZTpyLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lLG5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wOnIubm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXAsY29ubmVjdGlvbkVzdGFibGlzaGVkVGltZTpuLHRpbWVUb0Nvbm5lY3Q6bi1yLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lLHRpbWVXaXRob3V0Q29ubmVjdGlvbjpyLm5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wP24tci5ub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcDpudWxsfSksRigpLE4oKSxPKCkub3BlblRpbWVzdGFtcD1EYXRlLm5vdygpLDA9PT1kLnN1YnNjcmliZWQuc2l6ZSYmQyh0LnNlY29uZGFyeSkmJkQodC5wcmltYXJ5LCJbUHJpbWFyeSBXZWJTb2NrZXRdIENsb3NpbmcgV2ViU29ja2V0IiksKGQuc3Vic2NyaWJlZC5zaXplPjB8fGQucGVuZGluZy5zaXplPjApJiYoQyh0LnNlY29uZGFyeSkmJkooZS5pbmZvKCJTdWJzY3JpYmluZyBzZWNvbmRhcnkgd2Vic29ja2V0IHRvIHRvcGljcyBvZiBwcmltYXJ5IHdlYnNvY2tldCIpKSxkLnN1YnNjcmliZWQuZm9yRWFjaChmdW5jdGlvbihlKXtkLnN1YnNjcmlwdGlvbkhpc3RvcnkuYWRkKGUpLGQucGVuZGluZy5hZGQoZSl9KSxkLnN1YnNjcmliZWQuY2xlYXIoKSxBKCkpLFcoKSxpLmludGVydmFsSGFuZGxlPXNldEludGVydmFsKFcsMWU0KTt2YXIgYT0xZTMqcy5jb25uQ29uZmlnLndlYlNvY2tldFRyYW5zcG9ydC50cmFuc3BvcnRMaWZlVGltZUluU2Vjb25kcztKKGUuZGVidWcoIlNjaGVkdWxpbmcgV2ViU29ja2V0IG1hbmFnZXIgcmVjb25uZWN0aW9uLCBhZnRlciBkZWxheSAiK2ErIiBtcyIpKSxvLmxpZmVUaW1lVGltZW91dEhhbmRsZT1zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7SihlLmRlYnVnKCJTdGFydGluZyBzY2hlZHVsZWQgV2ViU29ja2V0IG1hbmFnZXIgcmVjb25uZWN0aW9uIikpLFUoKX0sYSl9Y2F0Y2gobil7SihlLmVycm9yKCJFcnJvciBhZnRlciBlc3RhYmxpc2hpbmcgV2ViU29ja2V0IGNvbm5lY3Rpb24iLG4pKX19LFI9ZnVuY3Rpb24obil7digid2ViU29ja2V0T25FcnJvciIpLEooZS5lcnJvcigiV2ViU29ja2V0TWFuYWdlciBFcnJvciwgZXJyb3JfZXZlbnQ6ICIsSlNPTi5zdHJpbmdpZnkobikpKSxVKCl9LGo9ZnVuY3Rpb24obil7dmFyIG89SlNPTi5wYXJzZShuLmRhdGEpO3N3aXRjaChvLnRvcGljKXtjYXNlIGE6aWYoSihlLmRlYnVnKCJTdWJzY3JpcHRpb24gTWVzc2FnZSByZWNlaXZlZCBmcm9tIHdlYlNvY2tldCBzZXJ2ZXIiLG4uZGF0YSkpLGIucmVxdWVzdENvbXBsZXRlZD0hMCxiLmNvbnNlY3V0aXZlTm9SZXNwb25zZVJlcXVlc3Q9MCwic3VjY2VzcyI9PT1vLmNvbnRlbnQuc3RhdHVzKWIuY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0cz0wLG8uY29udGVudC50b3BpY3MuZm9yRWFjaChmdW5jdGlvbihlKXtkLnN1YnNjcmlwdGlvbkhpc3RvcnkuZGVsZXRlKGUpLGQucGVuZGluZy5kZWxldGUoZSksZC5zdWJzY3JpYmVkLmFkZChlKX0pLDA9PT1kLnN1YnNjcmlwdGlvbkhpc3Rvcnkuc2l6ZT9DKHQuc2Vjb25kYXJ5KSYmKEooZS5pbmZvKCJTdWNjZXNzZnVsbHkgc3Vic2NyaWJlZCBzZWNvbmRhcnkgd2Vic29ja2V0IHRvIGFsbCB0b3BpY3Mgb2YgcHJpbWFyeSB3ZWJzb2NrZXQiKSksRCh0LnByaW1hcnksIltQcmltYXJ5IFdlYlNvY2tldF0gQ2xvc2luZyBXZWJTb2NrZXQiKSk6QSgpLGsoYy5zdWJzY3JpcHRpb25VcGRhdGUsbyk7ZWxzZXtpZihjbGVhckludGVydmFsKGIucmVTdWJzY3JpYmVJbnRlcnZhbElkKSwrK2IuY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0cyw1PT09Yi5jb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzKXJldHVybiBrKGMuc3Vic2NyaXB0aW9uRmFpbHVyZSxvKSx2b2lkKGIuY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0cz0wKTtiLnJlU3Vic2NyaWJlSW50ZXJ2YWxJZD1zZXRJbnRlcnZhbChmdW5jdGlvbigpe0EoKX0sNTAwKX1icmVhaztjYXNlIGw6SihlLmRlYnVnKCJIZWFydGJlYXQgcmVzcG9uc2UgcmVjZWl2ZWQiKSksaS5wZW5kaW5nUmVzcG9uc2U9ITE7YnJlYWs7ZGVmYXVsdDppZihvLnRvcGljKXtpZihKKGUuZGVidWcoIk1lc3NhZ2UgcmVjZWl2ZWQgZm9yIHRvcGljICIrby50b3BpYykpLEModC5wcmltYXJ5KSYmQyh0LnNlY29uZGFyeSkmJjA9PT1kLnN1YnNjcmlwdGlvbkhpc3Rvcnkuc2l6ZSYmdGhpcz09PXQucHJpbWFyeSlyZXR1cm4gdm9pZCBKKGUud2FybigiSWdub3JpbmcgTWVzc2FnZSBmb3IgVG9waWMgIitvLnRvcGljKyIsIHRvIGF2b2lkIGR1cGxpY2F0ZXMiKSk7aWYoMD09PWMuYWxsTWVzc2FnZS5zaXplJiYwPT09Yy50b3BpYy5zaXplKXJldHVybiB2b2lkIEooZS53YXJuKCJObyByZWdpc3RlcmVkIGNhbGxiYWNrIGxpc3RlbmVyIGZvciBUb3BpYyIsby50b3BpYykpO2soYy5hbGxNZXNzYWdlLG8pLGMudG9waWMuaGFzKG8udG9waWMpJiZrKGMudG9waWMuZ2V0KG8udG9waWMpLG8pfWVsc2Ugby5tZXNzYWdlP0ooZS53YXJuKCJXZWJTb2NrZXRNYW5hZ2VyIE1lc3NhZ2UgRXJyb3IiLG8pKTpKKGUud2FybigiSW52YWxpZCBpbmNvbWluZyBtZXNzYWdlIixvKSl9fSxBPWZ1bmN0aW9uIG4oKXtpZihiLmNvbnNlY3V0aXZlTm9SZXNwb25zZVJlcXVlc3Q+MylyZXR1cm4gSihlLndhcm4oIklnbm9yaW5nIHN1YnNjcmliZVBlbmRpbmdUb3BpY3Mgc2luY2Ugd2UgaGF2ZSBleGhhdXN0ZWQgbWF4IHN1YnNjcmlwdGlvbiByZXRyaWVzIHdpdGggbm8gcmVzcG9uc2UiKSksdm9pZCBrKGMuc3Vic2NyaXB0aW9uRmFpbHVyZSx5LmdldFN1YnNjcmlwdGlvblJlc3BvbnNlKGEsITEsQXJyYXkuZnJvbShkLnBlbmRpbmcpKSk7SSgpPyhjbGVhckludGVydmFsKGIucmVzcG9uc2VDaGVja0ludGVydmFsSWQpLE8oKS5zZW5kKEcoYSx7dG9waWNzOkFycmF5LmZyb20oZC5wZW5kaW5nKX0pKSxiLnJlcXVlc3RDb21wbGV0ZWQ9ITEsYi5yZXNwb25zZUNoZWNrSW50ZXJ2YWxJZD1zZXRJbnRlcnZhbChmdW5jdGlvbigpe2IucmVxdWVzdENvbXBsZXRlZHx8KCsrYi5jb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0LG4oKSl9LDFlMykpOkooZS53YXJuKCJJZ25vcmluZyBzdWJzY3JpYmVQZW5kaW5nVG9waWNzIGNhbGwgc2luY2UgRGVmYXVsdCBXZWJTb2NrZXQgaXMgbm90IG9wZW4iKSl9LEQ9ZnVuY3Rpb24obix0KXt3KG4sV2ViU29ja2V0LkNPTk5FQ1RJTkcpfHx3KG4sV2ViU29ja2V0Lk9QRU4pP24uY2xvc2UoMWUzLHQpOkooZS53YXJuKCJJZ25vcmluZyBXZWJTb2NrZXQgQ2xvc2UgcmVxdWVzdCwgV2ViU29ja2V0IFN0YXRlOiAiK2gobikpKX0sTT1mdW5jdGlvbihlKXtEKHQucHJpbWFyeSwiW1ByaW1hcnldIFdlYlNvY2tldCAiK2UpLEQodC5zZWNvbmRhcnksIltTZWNvbmRhcnldIFdlYlNvY2tldCAiK2UpfSxQPWZ1bmN0aW9uKCl7ci5jb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudCsrO3ZhciBuPXkuYWRkSml0dGVyKG8uZXhwb25lbnRpYWxCYWNrT2ZmVGltZSwuMyk7RGF0ZS5ub3coKStuPD1zLmNvbm5Db25maWcudXJsQ29ublZhbGlkVGltZT8oSihlLmRlYnVnKCJTY2hlZHVsaW5nIFdlYlNvY2tldCByZWluaXRpYWxpemF0aW9uLCBhZnRlciBkZWxheSAiK24rIiBtcyIpKSxvLmV4cG9uZW50aWFsVGltZW91dEhhbmRsZT1zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7cmV0dXJuIHEoKX0sbiksby5leHBvbmVudGlhbEJhY2tPZmZUaW1lKj0yKTooSihlLndhcm4oIldlYlNvY2tldCBVUkwgY2Fubm90IGJlIHVzZWQgdG8gZXN0YWJsaXNoIGNvbm5lY3Rpb24iKSksVSgpKX0sSD1mdW5jdGlvbihuKXtOKCksXygpLEooZS5lcnJvcigiV2ViU29ja2V0IEluaXRpYWxpemF0aW9uIGZhaWxlZCIpKSxvLndlYnNvY2tldEluaXRGYWlsZWQ9ITAsTSgiVGVybWluYXRpbmcgV2ViU29ja2V0IE1hbmFnZXIiKSxjbGVhckludGVydmFsKFMpLGsoYy5pbml0RmFpbHVyZSx7Y29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQ6ci5jb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudCxjb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZTpyLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lLHJlYXNvbjpufSksRigpfSxHPWZ1bmN0aW9uKGUsbil7cmV0dXJuIEpTT04uc3RyaW5naWZ5KHt0b3BpYzplLGNvbnRlbnQ6bn0pfSx6PWZ1bmN0aW9uKG4pe3JldHVybiEhKHkuaXNPYmplY3QobikmJnkuaXNPYmplY3Qobi53ZWJTb2NrZXRUcmFuc3BvcnQpJiZ5LmlzTm9uRW1wdHlTdHJpbmcobi53ZWJTb2NrZXRUcmFuc3BvcnQudXJsKSYmeS52YWxpZFdTVXJsKG4ud2ViU29ja2V0VHJhbnNwb3J0LnVybCkmJjFlMypuLndlYlNvY2tldFRyYW5zcG9ydC50cmFuc3BvcnRMaWZlVGltZUluU2Vjb25kcz49M2U1KXx8KEooZS5lcnJvcigiSW52YWxpZCBXZWJTb2NrZXQgQ29ubmVjdGlvbiBDb25maWd1cmF0aW9uIixuKSksITEpfSxVPWZ1bmN0aW9uKCl7aWYoeS5pc05ldHdvcmtPbmxpbmUoKSlpZihvLndlYnNvY2tldEluaXRGYWlsZWQpSihlLmRlYnVnKCJXZWJTb2NrZXQgSW5pdCBoYWQgZmFpbGVkLCBpZ25vcmluZyB0aGlzIGdldFdlYlNvY2tldENvbm5Db25maWcgcmVxdWVzdCIpKTtlbHNle2lmKHMucHJvbWlzZUNvbXBsZXRlZClyZXR1cm4gTigpLEooZS5pbmZvKCJGZXRjaGluZyBuZXcgV2ViU29ja2V0IGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbiIpKSxyLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lPXIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWV8fERhdGUubm93KCkscy5wcm9taXNlQ29tcGxldGVkPSExLHMucHJvbWlzZUhhbmRsZT1jLmdldFdlYlNvY2tldFRyYW5zcG9ydCgpLHMucHJvbWlzZUhhbmRsZS50aGVuKGZ1bmN0aW9uKG4pe3JldHVybiBzLnByb21pc2VDb21wbGV0ZWQ9ITAsSihlLmRlYnVnKCJTdWNjZXNzZnVsbHkgZmV0Y2hlZCB3ZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uIixuKSkseihuKT8ocy5jb25uQ29uZmlnPW4scy5jb25uQ29uZmlnLnVybENvbm5WYWxpZFRpbWU9RGF0ZS5ub3coKSs4NWUzLGcuY29ubmVjdGVkKCkscSgpKTooSCgiSW52YWxpZCBXZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uOiAiK24pLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfSl9LGZ1bmN0aW9uKG4pe3JldHVybiBzLnByb21pc2VDb21wbGV0ZWQ9ITAsSihlLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggd2ViU29ja2V0IGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbiIsbikpLHkuaXNOZXR3b3JrRmFpbHVyZShuKT8oSihlLmluZm8oIlJldHJ5aW5nIGZldGNoaW5nIG5ldyBXZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uIikpLGcucmV0cnkoKSk6SCgiRmFpbGVkIHRvIGZldGNoIHdlYlNvY2tldCBjb25uZWN0aW9uIGNvbmZpZ3VyYXRpb246ICIrSlNPTi5zdHJpbmdpZnkobikpLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfX0pO0ooZS5kZWJ1ZygiVGhlcmUgaXMgYW4gb25nb2luZyBnZXRXZWJTb2NrZXRDb25uQ29uZmlnIHJlcXVlc3QsIHRoaXMgcmVxdWVzdCB3aWxsIGJlIGlnbm9yZWQiKSl9ZWxzZSBKKGUuaW5mbygiTmV0d29yayBvZmZsaW5lLCBpZ25vcmluZyB0aGlzIGdldFdlYlNvY2tldENvbm5Db25maWcgcmVxdWVzdCIpKX0scT1mdW5jdGlvbigpe2lmKG8ud2Vic29ja2V0SW5pdEZhaWxlZClyZXR1cm4gSihlLmluZm8oIndlYi1zb2NrZXQgaW5pdGlhbGl6aW5nIGhhZCBmYWlsZWQsIGFib3J0aW5nIHJlLWluaXQiKSkse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITB9O2lmKCF5LmlzTmV0d29ya09ubGluZSgpKXJldHVybiBKKGUud2FybigiU3lzdGVtIGlzIG9mZmxpbmUgYWJvcnRpbmcgd2ViLXNvY2tldCBpbml0IikpLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfTtKKGUuaW5mbygiSW5pdGlhbGl6aW5nIFdlYnNvY2tldCBNYW5hZ2VyIikpLHYoImluaXRXZWJTb2NrZXQiKTt0cnl7aWYoeihzLmNvbm5Db25maWcpKXt2YXIgbj1udWxsO3JldHVybiBDKHQucHJpbWFyeSk/KEooZS5kZWJ1ZygiUHJpbWFyeSBTb2NrZXQgY29ubmVjdGlvbiBpcyBhbHJlYWR5IG9wZW4iKSksdyh0LnNlY29uZGFyeSxXZWJTb2NrZXQuQ09OTkVDVElORyl8fChKKGUuZGVidWcoIkVzdGFibGlzaGluZyBhIHNlY29uZGFyeSB3ZWItc29ja2V0IGNvbm5lY3Rpb24iKSksdC5zZWNvbmRhcnk9QigpKSxuPXQuc2Vjb25kYXJ5KToodyh0LnByaW1hcnksV2ViU29ja2V0LkNPTk5FQ1RJTkcpfHwoSihlLmRlYnVnKCJFc3RhYmxpc2hpbmcgYSBwcmltYXJ5IHdlYi1zb2NrZXQgY29ubmVjdGlvbiIpKSx0LnByaW1hcnk9QigpKSxuPXQucHJpbWFyeSksby53ZWJTb2NrZXRJbml0Q2hlY2tlclRpbWVvdXRJZD1zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7QyhuKXx8UCgpfSwxZTMpLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiExfX19Y2F0Y2gobil7cmV0dXJuIEooZS5lcnJvcigiRXJyb3IgSW5pdGlhbGl6aW5nIHdlYi1zb2NrZXQtbWFuYWdlciIsbikpLEgoIkZhaWxlZCB0byBpbml0aWFsaXplIG5ldyBXZWJTb2NrZXQ6ICIrbi5tZXNzYWdlKSx7d2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZDohMH19fSxCPWZ1bmN0aW9uKCl7dmFyIG49bmV3IFdlYlNvY2tldChzLmNvbm5Db25maWcud2ViU29ja2V0VHJhbnNwb3J0LnVybCk7cmV0dXJuIG4uYWRkRXZlbnRMaXN0ZW5lcigib3BlbiIseCksbi5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIixqKSxuLmFkZEV2ZW50TGlzdGVuZXIoImVycm9yIixSKSxuLmFkZEV2ZW50TGlzdGVuZXIoImNsb3NlIixmdW5jdGlvbihpKXtyZXR1cm4gZnVuY3Rpb24obixpKXtKKGUuaW5mbygiU29ja2V0IGNvbm5lY3Rpb24gaXMgY2xvc2VkIixuKSksdigid2ViU29ja2V0T25DbG9zZSBiZWZvcmUtY2xlYW51cCIpLGsoYy5jb25uZWN0aW9uQ2xvc2Use29wZW5UaW1lc3RhbXA6aS5vcGVuVGltZXN0YW1wLGNsb3NlVGltZXN0YW1wOkRhdGUubm93KCksY29ubmVjdGlvbkR1cmF0aW9uOkRhdGUubm93KCktaS5vcGVuVGltZXN0YW1wLGNvZGU6bi5jb2RlLHJlYXNvbjpuLnJlYXNvbn0pLFQodC5wcmltYXJ5KSYmKHQucHJpbWFyeT1udWxsKSxUKHQuc2Vjb25kYXJ5KSYmKHQuc2Vjb25kYXJ5PW51bGwpLG8ucmVjb25uZWN0V2ViU29ja2V0JiYoQyh0LnByaW1hcnkpfHxDKHQuc2Vjb25kYXJ5KT9UKHQucHJpbWFyeSkmJkModC5zZWNvbmRhcnkpJiYoSihlLmluZm8oIltQcmltYXJ5XSBXZWJTb2NrZXQgQ2xlYW5seSBDbG9zZWQiKSksdC5wcmltYXJ5PXQuc2Vjb25kYXJ5LHQuc2Vjb25kYXJ5PW51bGwpOihKKGUud2FybigiTmVpdGhlciBwcmltYXJ5IHdlYnNvY2tldCBhbmQgbm9yIHNlY29uZGFyeSB3ZWJzb2NrZXQgaGF2ZSBvcGVuIGNvbm5lY3Rpb25zLCBhdHRlbXB0aW5nIHRvIHJlLWVzdGFibGlzaCBjb25uZWN0aW9uIikpLG8uY29ublN0YXRlPT09cD9KKGUuaW5mbygiSWdub3JpbmcgY29ubmVjdGlvbkxvc3QgY2FsbGJhY2sgaW52b2NhdGlvbiIpKTooayhjLmNvbm5lY3Rpb25Mb3N0LHtvcGVuVGltZXN0YW1wOmkub3BlblRpbWVzdGFtcCxjbG9zZVRpbWVzdGFtcDpEYXRlLm5vdygpLGNvbm5lY3Rpb25EdXJhdGlvbjpEYXRlLm5vdygpLWkub3BlblRpbWVzdGFtcCxjb2RlOm4uY29kZSxyZWFzb246bi5yZWFzb259KSxyLm5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wPURhdGUubm93KCkpLG8uY29ublN0YXRlPXAsVSgpKSx2KCJ3ZWJTb2NrZXRPbkNsb3NlIGFmdGVyLWNsZWFudXAiKSl9KGksbil9KSxufSxKPWZ1bmN0aW9uKGUpe3JldHVybiBlJiYiZnVuY3Rpb24iPT10eXBlb2YgZS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlciYmZS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpLGV9O3RoaXMuaW5pdD1mdW5jdGlvbihuKXtpZih5LmFzc2VydFRydWUoeS5pc0Z1bmN0aW9uKG4pLCJ0cmFuc3BvcnRIYW5kbGUgbXVzdCBiZSBhIGZ1bmN0aW9uIiksbnVsbD09PWMuZ2V0V2ViU29ja2V0VHJhbnNwb3J0KXJldHVybiBjLmdldFdlYlNvY2tldFRyYW5zcG9ydD1uLFUoKTtKKGUud2FybigiV2ViIFNvY2tldCBNYW5hZ2VyIHdhcyBhbHJlYWR5IGluaXRpYWxpemVkIikpfSx0aGlzLm9uSW5pdEZhaWx1cmU9ZnVuY3Rpb24oZSl7cmV0dXJuIHkuYXNzZXJ0VHJ1ZSh5LmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuaW5pdEZhaWx1cmUuYWRkKGUpLG8ud2Vic29ja2V0SW5pdEZhaWxlZCYmZSgpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuaW5pdEZhaWx1cmUuZGVsZXRlKGUpfX0sdGhpcy5vbkNvbm5lY3Rpb25PcGVuPWZ1bmN0aW9uKGUpe3JldHVybiB5LmFzc2VydFRydWUoeS5pc0Z1bmN0aW9uKGUpLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmNvbm5lY3Rpb25PcGVuLmFkZChlKSxmdW5jdGlvbigpe3JldHVybiBjLmNvbm5lY3Rpb25PcGVuLmRlbGV0ZShlKX19LHRoaXMub25Db25uZWN0aW9uQ2xvc2U9ZnVuY3Rpb24oZSl7cmV0dXJuIHkuYXNzZXJ0VHJ1ZSh5LmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuY29ubmVjdGlvbkNsb3NlLmFkZChlKSxmdW5jdGlvbigpe3JldHVybiBjLmNvbm5lY3Rpb25DbG9zZS5kZWxldGUoZSl9fSx0aGlzLm9uQ29ubmVjdGlvbkdhaW49ZnVuY3Rpb24oZSl7cmV0dXJuIHkuYXNzZXJ0VHJ1ZSh5LmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuY29ubmVjdGlvbkdhaW4uYWRkKGUpLEkoKSYmZSgpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuY29ubmVjdGlvbkdhaW4uZGVsZXRlKGUpfX0sdGhpcy5vbkNvbm5lY3Rpb25Mb3N0PWZ1bmN0aW9uKGUpe3JldHVybiB5LmFzc2VydFRydWUoeS5pc0Z1bmN0aW9uKGUpLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmNvbm5lY3Rpb25Mb3N0LmFkZChlKSxvLmNvbm5TdGF0ZT09PXAmJmUoKSxmdW5jdGlvbigpe3JldHVybiBjLmNvbm5lY3Rpb25Mb3N0LmRlbGV0ZShlKX19LHRoaXMub25TdWJzY3JpcHRpb25VcGRhdGU9ZnVuY3Rpb24oZSl7cmV0dXJuIHkuYXNzZXJ0VHJ1ZSh5LmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuc3Vic2NyaXB0aW9uVXBkYXRlLmFkZChlKSxmdW5jdGlvbigpe3JldHVybiBjLnN1YnNjcmlwdGlvblVwZGF0ZS5kZWxldGUoZSl9fSx0aGlzLm9uU3Vic2NyaXB0aW9uRmFpbHVyZT1mdW5jdGlvbihlKXtyZXR1cm4geS5hc3NlcnRUcnVlKHkuaXNGdW5jdGlvbihlKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5zdWJzY3JpcHRpb25GYWlsdXJlLmFkZChlKSxmdW5jdGlvbigpe3JldHVybiBjLnN1YnNjcmlwdGlvbkZhaWx1cmUuZGVsZXRlKGUpfX0sdGhpcy5vbk1lc3NhZ2U9ZnVuY3Rpb24oZSxuKXtyZXR1cm4geS5hc3NlcnROb3ROdWxsKGUsInRvcGljTmFtZSIpLHkuYXNzZXJ0VHJ1ZSh5LmlzRnVuY3Rpb24obiksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMudG9waWMuaGFzKGUpP2MudG9waWMuZ2V0KGUpLmFkZChuKTpjLnRvcGljLnNldChlLG5ldyBTZXQoW25dKSksZnVuY3Rpb24oKXtyZXR1cm4gYy50b3BpYy5nZXQoZSkuZGVsZXRlKG4pfX0sdGhpcy5vbkFsbE1lc3NhZ2U9ZnVuY3Rpb24oZSl7cmV0dXJuIHkuYXNzZXJ0VHJ1ZSh5LmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuYWxsTWVzc2FnZS5hZGQoZSksZnVuY3Rpb24oKXtyZXR1cm4gYy5hbGxNZXNzYWdlLmRlbGV0ZShlKX19LHRoaXMuc3Vic2NyaWJlVG9waWNzPWZ1bmN0aW9uKGUpe3kuYXNzZXJ0Tm90TnVsbChlLCJ0b3BpY3MiKSx5LmFzc2VydElzTGlzdChlKSxlLmZvckVhY2goZnVuY3Rpb24oZSl7ZC5zdWJzY3JpYmVkLmhhcyhlKXx8ZC5wZW5kaW5nLmFkZChlKX0pLGIuY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdD0wLEEoKX0sdGhpcy5zZW5kTWVzc2FnZT1mdW5jdGlvbihuKXtpZih5LmFzc2VydElzT2JqZWN0KG4sInBheWxvYWQiKSx2b2lkIDA9PT1uLnRvcGljfHxtLmhhcyhuLnRvcGljKSlKKGUud2FybigiQ2Fubm90IHNlbmQgbWVzc2FnZSwgSW52YWxpZCB0b3BpYyIsbikpO2Vsc2V7dHJ5e249SlNPTi5zdHJpbmdpZnkobil9Y2F0Y2godCl7cmV0dXJuIHZvaWQgSihlLndhcm4oIkVycm9yIHN0cmluZ2lmeSBtZXNzYWdlIixuKSl9SSgpP08oKS5zZW5kKG4pOkooZS53YXJuKCJDYW5ub3Qgc2VuZCBtZXNzYWdlLCB3ZWIgc29ja2V0IGNvbm5lY3Rpb24gaXMgbm90IG9wZW4iKSl9fSx0aGlzLmNsb3NlV2ViU29ja2V0PWZ1bmN0aW9uKCl7TigpLF8oKSxvLnJlY29ubmVjdFdlYlNvY2tldD0hMSxjbGVhckludGVydmFsKFMpLE0oIlVzZXIgcmVxdWVzdCB0byBjbG9zZSBXZWJTb2NrZXQiKX0sdGhpcy50ZXJtaW5hdGVXZWJTb2NrZXRNYW5hZ2VyPUh9LFI9e2NyZWF0ZTpmdW5jdGlvbigpe3JldHVybiBuZXcgeH0sc2V0R2xvYmFsQ29uZmlnOmZ1bmN0aW9uKGUpe3ZhciBuPWUubG9nZ2VyQ29uZmlnO0UudXBkYXRlTG9nZ2VyQ29uZmlnKG4pfSxMb2dMZXZlbDpPLExvZ2dlcjpUfX0sZnVuY3Rpb24oZSxuLHQpe3ZhciBvOyFmdW5jdGlvbigpeyJ1c2Ugc3RyaWN0Ijt2YXIgcj17bm90X3N0cmluZzovW15zXS8sbm90X2Jvb2w6L1tedF0vLG5vdF90eXBlOi9bXlRdLyxub3RfcHJpbWl0aXZlOi9bXnZdLyxudW1iZXI6L1tkaWVmZ10vLG51bWVyaWNfYXJnOi9bYmNkaWVmZ3V4WF0vLGpzb246L1tqXS8sbm90X2pzb246L1teal0vLHRleHQ6L15bXlx4MjVdKy8sbW9kdWxvOi9eXHgyNXsyfS8scGxhY2Vob2xkZXI6L15ceDI1KD86KFsxLTldXGQqKVwkfFwoKFteKV0rKVwpKT8oXCspPygwfCdbXiRdKT8oLSk/KFxkKyk/KD86XC4oXGQrKSk/KFtiLWdpam9zdFR1dnhYXSkvLGtleTovXihbYS16X11bYS16X1xkXSopL2ksa2V5X2FjY2VzczovXlwuKFthLXpfXVthLXpfXGRdKikvaSxpbmRleF9hY2Nlc3M6L15cWyhcZCspXF0vLHNpZ246L15bKy1dL307ZnVuY3Rpb24gaShlKXtyZXR1cm4gZnVuY3Rpb24oZSxuKXt2YXIgdCxvLGMscyxhLHUsbCxmLHAsZD0xLGI9ZS5sZW5ndGgsZz0iIjtmb3Iobz0wO288YjtvKyspaWYoInN0cmluZyI9PXR5cGVvZiBlW29dKWcrPWVbb107ZWxzZSBpZigib2JqZWN0Ij09dHlwZW9mIGVbb10pe2lmKChzPWVbb10pLmtleXMpZm9yKHQ9bltkXSxjPTA7YzxzLmtleXMubGVuZ3RoO2MrKyl7aWYobnVsbD09dCl0aHJvdyBuZXcgRXJyb3IoaSgnW3NwcmludGZdIENhbm5vdCBhY2Nlc3MgcHJvcGVydHkgIiVzIiBvZiB1bmRlZmluZWQgdmFsdWUgIiVzIicscy5rZXlzW2NdLHMua2V5c1tjLTFdKSk7dD10W3Mua2V5c1tjXV19ZWxzZSB0PXMucGFyYW1fbm8/bltzLnBhcmFtX25vXTpuW2QrK107aWYoci5ub3RfdHlwZS50ZXN0KHMudHlwZSkmJnIubm90X3ByaW1pdGl2ZS50ZXN0KHMudHlwZSkmJnQgaW5zdGFuY2VvZiBGdW5jdGlvbiYmKHQ9dCgpKSxyLm51bWVyaWNfYXJnLnRlc3Qocy50eXBlKSYmIm51bWJlciIhPXR5cGVvZiB0JiZpc05hTih0KSl0aHJvdyBuZXcgVHlwZUVycm9yKGkoIltzcHJpbnRmXSBleHBlY3RpbmcgbnVtYmVyIGJ1dCBmb3VuZCAlVCIsdCkpO3N3aXRjaChyLm51bWJlci50ZXN0KHMudHlwZSkmJihmPXQ+PTApLHMudHlwZSl7Y2FzZSJiIjp0PXBhcnNlSW50KHQsMTApLnRvU3RyaW5nKDIpO2JyZWFrO2Nhc2UiYyI6dD1TdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KHQsMTApKTticmVhaztjYXNlImQiOmNhc2UiaSI6dD1wYXJzZUludCh0LDEwKTticmVhaztjYXNlImoiOnQ9SlNPTi5zdHJpbmdpZnkodCxudWxsLHMud2lkdGg/cGFyc2VJbnQocy53aWR0aCk6MCk7YnJlYWs7Y2FzZSJlIjp0PXMucHJlY2lzaW9uP3BhcnNlRmxvYXQodCkudG9FeHBvbmVudGlhbChzLnByZWNpc2lvbik6cGFyc2VGbG9hdCh0KS50b0V4cG9uZW50aWFsKCk7YnJlYWs7Y2FzZSJmIjp0PXMucHJlY2lzaW9uP3BhcnNlRmxvYXQodCkudG9GaXhlZChzLnByZWNpc2lvbik6cGFyc2VGbG9hdCh0KTticmVhaztjYXNlImciOnQ9cy5wcmVjaXNpb24/U3RyaW5nKE51bWJlcih0LnRvUHJlY2lzaW9uKHMucHJlY2lzaW9uKSkpOnBhcnNlRmxvYXQodCk7YnJlYWs7Y2FzZSJvIjp0PShwYXJzZUludCh0LDEwKT4+PjApLnRvU3RyaW5nKDgpO2JyZWFrO2Nhc2UicyI6dD1TdHJpbmcodCksdD1zLnByZWNpc2lvbj90LnN1YnN0cmluZygwLHMucHJlY2lzaW9uKTp0O2JyZWFrO2Nhc2UidCI6dD1TdHJpbmcoISF0KSx0PXMucHJlY2lzaW9uP3Quc3Vic3RyaW5nKDAscy5wcmVjaXNpb24pOnQ7YnJlYWs7Y2FzZSJUIjp0PU9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh0KS5zbGljZSg4LC0xKS50b0xvd2VyQ2FzZSgpLHQ9cy5wcmVjaXNpb24/dC5zdWJzdHJpbmcoMCxzLnByZWNpc2lvbik6dDticmVhaztjYXNlInUiOnQ9cGFyc2VJbnQodCwxMCk+Pj4wO2JyZWFrO2Nhc2UidiI6dD10LnZhbHVlT2YoKSx0PXMucHJlY2lzaW9uP3Quc3Vic3RyaW5nKDAscy5wcmVjaXNpb24pOnQ7YnJlYWs7Y2FzZSJ4Ijp0PShwYXJzZUludCh0LDEwKT4+PjApLnRvU3RyaW5nKDE2KTticmVhaztjYXNlIlgiOnQ9KHBhcnNlSW50KHQsMTApPj4+MCkudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCl9ci5qc29uLnRlc3Qocy50eXBlKT9nKz10Oighci5udW1iZXIudGVzdChzLnR5cGUpfHxmJiYhcy5zaWduP3A9IiI6KHA9Zj8iKyI6Ii0iLHQ9dC50b1N0cmluZygpLnJlcGxhY2Uoci5zaWduLCIiKSksdT1zLnBhZF9jaGFyPyIwIj09PXMucGFkX2NoYXI/IjAiOnMucGFkX2NoYXIuY2hhckF0KDEpOiIgIixsPXMud2lkdGgtKHArdCkubGVuZ3RoLGE9cy53aWR0aCYmbD4wP3UucmVwZWF0KGwpOiIiLGcrPXMuYWxpZ24/cCt0K2E6IjAiPT09dT9wK2ErdDphK3ArdCl9cmV0dXJuIGd9KGZ1bmN0aW9uKGUpe2lmKHNbZV0pcmV0dXJuIHNbZV07dmFyIG4sdD1lLG89W10saT0wO2Zvcig7dDspe2lmKG51bGwhPT0obj1yLnRleHQuZXhlYyh0KSkpby5wdXNoKG5bMF0pO2Vsc2UgaWYobnVsbCE9PShuPXIubW9kdWxvLmV4ZWModCkpKW8ucHVzaCgiJSIpO2Vsc2V7aWYobnVsbD09PShuPXIucGxhY2Vob2xkZXIuZXhlYyh0KSkpdGhyb3cgbmV3IFN5bnRheEVycm9yKCJbc3ByaW50Zl0gdW5leHBlY3RlZCBwbGFjZWhvbGRlciIpO2lmKG5bMl0pe2l8PTE7dmFyIGM9W10sYT1uWzJdLHU9W107aWYobnVsbD09PSh1PXIua2V5LmV4ZWMoYSkpKXRocm93IG5ldyBTeW50YXhFcnJvcigiW3NwcmludGZdIGZhaWxlZCB0byBwYXJzZSBuYW1lZCBhcmd1bWVudCBrZXkiKTtmb3IoYy5wdXNoKHVbMV0pOyIiIT09KGE9YS5zdWJzdHJpbmcodVswXS5sZW5ndGgpKTspaWYobnVsbCE9PSh1PXIua2V5X2FjY2Vzcy5leGVjKGEpKSljLnB1c2godVsxXSk7ZWxzZXtpZihudWxsPT09KHU9ci5pbmRleF9hY2Nlc3MuZXhlYyhhKSkpdGhyb3cgbmV3IFN5bnRheEVycm9yKCJbc3ByaW50Zl0gZmFpbGVkIHRvIHBhcnNlIG5hbWVkIGFyZ3VtZW50IGtleSIpO2MucHVzaCh1WzFdKX1uWzJdPWN9ZWxzZSBpfD0yO2lmKDM9PT1pKXRocm93IG5ldyBFcnJvcigiW3NwcmludGZdIG1peGluZyBwb3NpdGlvbmFsIGFuZCBuYW1lZCBwbGFjZWhvbGRlcnMgaXMgbm90ICh5ZXQpIHN1cHBvcnRlZCIpO28ucHVzaCh7cGxhY2Vob2xkZXI6blswXSxwYXJhbV9ubzpuWzFdLGtleXM6blsyXSxzaWduOm5bM10scGFkX2NoYXI6bls0XSxhbGlnbjpuWzVdLHdpZHRoOm5bNl0scHJlY2lzaW9uOm5bN10sdHlwZTpuWzhdfSl9dD10LnN1YnN0cmluZyhuWzBdLmxlbmd0aCl9cmV0dXJuIHNbZV09b30oZSksYXJndW1lbnRzKX1mdW5jdGlvbiBjKGUsbil7cmV0dXJuIGkuYXBwbHkobnVsbCxbZV0uY29uY2F0KG58fFtdKSl9dmFyIHM9T2JqZWN0LmNyZWF0ZShudWxsKTtuLnNwcmludGY9aSxuLnZzcHJpbnRmPWMsInVuZGVmaW5lZCIhPXR5cGVvZiB3aW5kb3cmJih3aW5kb3cuc3ByaW50Zj1pLHdpbmRvdy52c3ByaW50Zj1jLHZvaWQgMD09PShvPWZ1bmN0aW9uKCl7cmV0dXJue3NwcmludGY6aSx2c3ByaW50ZjpjfX0uY2FsbChuLHQsbixlKSl8fChlLmV4cG9ydHM9bykpfSgpfSxmdW5jdGlvbihlLG4sdCl7InVzZSBzdHJpY3QiO3QucihuKSxmdW5jdGlvbihlKXt0LmQobiwiV2ViU29ja2V0TWFuYWdlciIsZnVuY3Rpb24oKXtyZXR1cm4gcn0pO3ZhciBvPXQoMCk7ZS5jb25uZWN0PWUuY29ubmVjdHx8e30sY29ubmVjdC5XZWJTb2NrZXRNYW5hZ2VyPW8uYTt2YXIgcj1vLmF9LmNhbGwodGhpcyx0KDMpKX0sZnVuY3Rpb24oZSxuKXt2YXIgdDt0PWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXN9KCk7dHJ5e3Q9dHx8bmV3IEZ1bmN0aW9uKCJyZXR1cm4gdGhpcyIpKCl9Y2F0Y2goZSl7Im9iamVjdCI9PXR5cGVvZiB3aW5kb3cmJih0PXdpbmRvdyl9ZS5leHBvcnRzPXR9XSk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPWFtYXpvbi1jb25uZWN0LXdlYnNvY2tldC1tYW5hZ2VyLmpzLm1hcAoKCi8qKiovIH0pLAoKLyoqKi8gMTUxOgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgLy8gSG93IGZyZXF1ZW50bHkgc29mdHBob25lIGxvZ3Mgc2hvdWxkIGJlIGNvbGxlY3RlZCBhbmQgcmVwb3J0ZWQgdG8gc2hhcmVkIHdvcmtlci4KICB2YXIgU09GVFBIT05FX0xPR19SRVBPUlRfSU5URVJWQUxfTUlMTElTID0gNTAwMDsKCiAgLy8gSG93IGZyZXF1ZW50bHkgbG9ncyBzaG91bGQgYmUgY29sbGVjdGVkIGFuZCBzZW50IGRvd25zdHJlYW0KICB2YXIgTE9HU19SRVBPUlRfSU5URVJWQUxfTUlMTElTID0gNTAwMDsKCiAgLy8gVGhlIGRlZmF1bHQgbG9nIHJvbGwgaW50ZXJ2YWwgKDMwbWluKQogIHZhciBERUZBVUxUX0xPR19ST0xMX0lOVEVSVkFMID0gMTgwMDAwMDsKCiAgLyoqCiAgICogQW4gZW51bWVyYXRpb24gb2YgY29tbW9uIGxvZ2dpbmcgbGV2ZWxzLgogICAqLwogIHZhciBMb2dMZXZlbCA9IHsKICAgIFRFU1Q6ICJURVNUIiwKICAgIFRSQUNFOiAiVFJBQ0UiLAogICAgREVCVUc6ICJERUJVRyIsCiAgICBJTkZPOiAiSU5GTyIsCiAgICBMT0c6ICJMT0ciLAogICAgV0FSTjogIldBUk4iLAogICAgRVJST1I6ICJFUlJPUiIsCiAgICBDUklUSUNBTDogIkNSSVRJQ0FMIgogIH07CgogIC8qKgogICAqIEFuIGVudW1lcmF0aW9uIG9mIGNvbW1vbiBsb2dnaW5nIGNvbXBvbmVudHMuCiAgICovCiAgdmFyIExvZ0NvbXBvbmVudCA9IHsKICAgIENDUDogImNjcCIsCiAgICBTT0ZUUEhPTkU6ICJzb2Z0cGhvbmUiLAogICAgQ0hBVDogImNoYXQiLAogICAgVEFTSzogInRhc2siCiAgfTsKCiAgLyoqCiAgICogVGhlIG51bWVyaWMgb3JkZXIgb2YgdGhlIGxvZ2dpbmcgbGV2ZWxzIGFib3ZlLgogICAqIFRoZXkgYXJlIHNwYWNlZCB0byBhbGxvdyB0aGUgYWRkaXRpb24gb2Ygb3RoZXIgbG9nCiAgICogbGV2ZWxzIGF0IGEgbGF0ZXIgdGltZS4KICAgKi8KICB2YXIgTG9nTGV2ZWxPcmRlciA9IHsKICAgIFRFU1Q6IDAsCiAgICBUUkFDRTogMTAsCiAgICBERUJVRzogMjAsCiAgICBJTkZPOiAzMCwKICAgIExPRzogNDAsCiAgICBXQVJOOiA1MCwKICAgIEVSUk9SOiAxMDAsCiAgICBDUklUSUNBTDogMjAwCgogIH07CgogIC8qKgogICAqIEEgbWFwIGZyb20gbG9nIGxldmVsIHRvIGNvbnNvbGUgbG9nZ2VyIGZ1bmN0aW9uLgogICAqLwogIHZhciBDT05TT0xFX0xPR0dFUl9NQVAgPSB7CiAgICBUUkFDRTogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5pbmZvKHRleHQpOyB9LAogICAgREVCVUc6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuaW5mbyh0ZXh0KTsgfSwKICAgIElORk86IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuaW5mbyh0ZXh0KTsgfSwKICAgIExPRzogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5sb2codGV4dCk7IH0sCiAgICBURVNUOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmxvZyh0ZXh0KTsgfSwKICAgIFdBUk46IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUud2Fybih0ZXh0KTsgfSwKICAgIEVSUk9SOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmVycm9yKHRleHQpOyB9LAogICAgQ1JJVElDQUw6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuZXJyb3IodGV4dCk7IH0KICB9OwoKICAvKioKICAqIENoZWNrcyBpZiBpdCBpcyBhIHZhbGlkIGxvZyBjb21wb25lbnQgZW51bQogICovCgogIHZhciBpc1ZhbGlkTG9nQ29tcG9uZW50ID0gZnVuY3Rpb24gKGNvbXBvbmVudCkgewogICAgcmV0dXJuIE9iamVjdC52YWx1ZXMoTG9nQ29tcG9uZW50KS5pbmRleE9mKGNvbXBvbmVudCkgIT09IC0xOwogIH07CgogIC8qKgogICogRXh0cmFjdCB0aGUgY3VzdG9tIGFyZ3VtZW50cyBhcyByZXF1aXJlZCBieSB0aGUgbG9nZ2VyCiAgKi8KICB2YXIgZXh0cmFjdExvZ2dlckFyZ3MgPSBmdW5jdGlvbiAobG9nZ2VyQXJncykgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChsb2dnZXJBcmdzLCAwKTsKICAgIHZhciBmaXJzdEFyZyA9IGFyZ3Muc2hpZnQoKTsKICAgIHZhciBmb3JtYXQ7CiAgICB2YXIgY29tcG9uZW50OwoKICAgIGlmIChpc1ZhbGlkTG9nQ29tcG9uZW50KGZpcnN0QXJnKSkgewogICAgICBjb21wb25lbnQgPSBmaXJzdEFyZzsKICAgICAgZm9ybWF0ID0gYXJncy5zaGlmdCgpOwogICAgfSBlbHNlIHsKICAgICAgLy9kZWZhdWx0IHRvIENDUCBjb21wb25lbnQKICAgICAgZm9ybWF0ID0gZmlyc3RBcmc7CiAgICAgIGNvbXBvbmVudCA9IExvZ0NvbXBvbmVudC5DQ1A7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgZm9ybWF0OiBmb3JtYXQsCiAgICAgIGNvbXBvbmVudDogY29tcG9uZW50LAogICAgICBhcmdzOiBhcmdzCiAgICB9OwogIH07CgogIC8qKgogICAqIEEgbG9nIGVudHJ5LgogICAqCiAgICogQHBhcmFtIGNvbXBvbmVudCBUaGUgbG9nZ2luZyBjb21wb25lbnQuCiAgICogQHBhcmFtIGxldmVsIFRoZSBsb2cgbGV2ZWwgb2YgdGhpcyBsb2cgZW50cnkuCiAgICogQHBhcmFtIHRleHQgVGhlIHRleHQgY29udGFpbmVkIGluIHRoZSBsb2cgZW50cnkuCiAgICogQHBhcmFtIGxvZ2dlcklkIFRoZSByb290IGxvZ2dlciBpZC4KICAgKgogICAqIExvZyBlbnRyaWVzIGFyZSBhd2FyZSBvZiB0aGVpciB0aW1lc3RhbXAsIG9yZGVyLAogICAqIGFuZCBjYW4gY29udGFpbiBvYmplY3RzIGFuZCBleGNlcHRpb24gc3RhY2sgdHJhY2VzLgogICAqLwogIHZhciBMb2dFbnRyeSA9IGZ1bmN0aW9uIChjb21wb25lbnQsIGxldmVsLCB0ZXh0LCBsb2dnZXJJZCkgewogICAgdGhpcy5jb21wb25lbnQgPSBjb21wb25lbnQ7CiAgICB0aGlzLmxldmVsID0gbGV2ZWw7CiAgICB0aGlzLnRleHQgPSB0ZXh0OwogICAgdGhpcy50aW1lID0gbmV3IERhdGUoKTsKICAgIHRoaXMuZXhjZXB0aW9uID0gbnVsbDsKICAgIHRoaXMub2JqZWN0cyA9IFtdOwogICAgdGhpcy5saW5lID0gMDsKICAgIHRoaXMuYWdlbnRSZXNvdXJjZUlkID0gbnVsbDsKICAgIHRyeSB7CiAgICAgIGlmIChjb25uZWN0LmFnZW50LmluaXRpYWxpemVkKXsKICAgICAgICB0aGlzLmFnZW50UmVzb3VyY2VJZCA9IG5ldyBjb25uZWN0LkFnZW50KCkuX2dldFJlc291cmNlSWQoKTsKICAgICAgfQogICAgfSBjYXRjaChlKSB7CiAgICAgIGNvbnNvbGUubG9nKCJJc3N1ZSBmaW5kaW5nIGFnZW50UmVzb3VyY2VJZDogIiwgZSk7IC8vY2FuJ3QgdXNlIG91ciBsb2dnZXIgaGVyZSBhcyB3ZSBtaWdodCBpbmZpbml0ZWx5IGF0dGVtcHQgdG8gbG9nIHRoaXMgZXJyb3IuCiAgICB9CiAgICB0aGlzLmxvZ2dlcklkID0gbG9nZ2VySWQ7CiAgfTsKCiAgTG9nRW50cnkuZnJvbU9iamVjdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBlbnRyeSA9IG5ldyBMb2dFbnRyeShMb2dDb21wb25lbnQuQ0NQLCBvYmoubGV2ZWwsIG9iai50ZXh0LCBvYmoubG9nZ2VySWQpOwoKICAgIC8vIFJlcXVpcmVkIHRvIGNoZWNrIGZvciBEYXRlIG9iamVjdHMgc2VudCBhY3Jvc3MgZnJhbWUgYm91bmRhcmllcwogICAgaWYgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmoudGltZSkgPT09ICdbb2JqZWN0IERhdGVdJykgewogICAgICBlbnRyeS50aW1lID0gbmV3IERhdGUob2JqLnRpbWUuZ2V0VGltZSgpKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iai50aW1lID09PSAnbnVtYmVyJykgewogICAgICBlbnRyeS50aW1lID0gbmV3IERhdGUob2JqLnRpbWUpOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygb2JqLnRpbWUgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVudHJ5LnRpbWUgPSBEYXRlLnBhcnNlKG9iai50aW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIGVudHJ5LnRpbWUgPSBuZXcgRGF0ZSgpOwogICAgfQogICAgZW50cnkuZXhjZXB0aW9uID0gb2JqLmV4Y2VwdGlvbjsKICAgIGVudHJ5Lm9iamVjdHMgPSBvYmoub2JqZWN0czsKICAgIHJldHVybiBlbnRyeTsKICB9OwoKICAvKioKICAgKiBQcml2YXRlIG1ldGhvZCB0byByZW1vdmUgc2Vuc2l0aXZlIGluZm8gZnJvbSBjbGllbnQgbG9nCiAgICovCiAgdmFyIHJlZGFjdFNlbnNpdGl2ZUluZm8gPSBmdW5jdGlvbihkYXRhKSB7CiAgICB2YXIgcmVnZXggPSAvQXV0aFRva2VuLipcPS9nOwogICAgaWYoZGF0YSAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcpIHsKICAgICAgT2JqZWN0LmtleXMoZGF0YSkuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAgICBpZiAodHlwZW9mIGRhdGFba2V5XSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgIHJlZGFjdFNlbnNpdGl2ZUluZm8oZGF0YVtrZXldKQogICAgICAgIH0gZWxzZSBpZih0eXBlb2YgZGF0YVtrZXldID09PSAnc3RyaW5nJykgewogICAgICAgICAgaWYgKGtleSA9PT0gInVybCIgfHwga2V5ID09PSAidGV4dCIpIHsKICAgICAgICAgICAgZGF0YVtrZXldID0gZGF0YVtrZXldLnJlcGxhY2UocmVnZXgsICJbcmVkYWN0ZWRdIik7CiAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PT0gInF1aWNrQ29ubmVjdE5hbWUiKSB7CiAgICAgICAgICAgIGRhdGFba2V5XSA9ICJbcmVkYWN0ZWRdIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOyAKICAgIH0KICB9CgogIC8qKgogICAqIFB1bGxzIHRoZSB0eXBlLCBtZXNzYWdlLCBhbmQgc3RhY2sgdHJhY2UKICAgKiBvdXQgb2YgdGhlIGdpdmVuIGV4Y2VwdGlvbiBmb3IgSlNPTiBzZXJpYWxpemF0aW9uLgogICAqLwogIHZhciBMb2dnZWRFeGNlcHRpb24gPSBmdW5jdGlvbiAoZSkgewogICAgdGhpcy50eXBlID0gKGUgaW5zdGFuY2VvZiBFcnJvcikgPyBlLm5hbWUgOiBlLmNvZGUgfHwgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGUpOwogICAgdGhpcy5tZXNzYWdlID0gZS5tZXNzYWdlOwogICAgdGhpcy5zdGFjayA9IGUuc3RhY2sgPyBlLnN0YWNrLnNwbGl0KCdcbicpIDogW107CiAgfTsKCiAgLyoqCiAgICogTWluaW1hbGx5IHN0cmluZ2lmeSB0aGlzIGxvZyBlbnRyeSBmb3IgcHJpbnRpbmcKICAgKiB0byB0aGUgY29uc29sZS4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5zcHJpbnRmKCJbJXNdIFslc10gWyVzXTogJXMiLAogICAgICB0aGlzLmdldFRpbWUoKSAmJiB0aGlzLmdldFRpbWUoKS50b0lTT1N0cmluZyA/IHRoaXMuZ2V0VGltZSgpLnRvSVNPU3RyaW5nKCkgOiAiPz8/IiwKICAgICAgdGhpcy5nZXRMZXZlbCgpLAogICAgICB0aGlzLmdldEFnZW50UmVzb3VyY2VJZCgpLAogICAgICB0aGlzLmdldFRleHQoKSk7CiAgfTsKCiAgLyoqCiAgICogR2V0IHRoZSBsb2cgZW50cnkgdGltZXN0YW1wLgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS5nZXRUaW1lID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMudGltZTsKICB9OwoKICBMb2dFbnRyeS5wcm90b3R5cGUuZ2V0QWdlbnRSZXNvdXJjZUlkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuYWdlbnRSZXNvdXJjZUlkOwogIH0KCiAgLyoqCiAgICogR2V0IHRoZSBsZXZlbCBvZiB0aGUgbG9nIGVudHJ5LgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS5nZXRMZXZlbCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmxldmVsOwogIH07CgogIC8qKgogICAqIEdldCB0aGUgbG9nIGVudHJ5IHRleHQuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLmdldFRleHQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy50ZXh0OwogIH07CgogIC8qKgogICAqIEdldCB0aGUgbG9nIGVudHJ5IGNvbXBvbmVudC4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUuZ2V0Q29tcG9uZW50ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29tcG9uZW50OwogIH07CgogIC8qKgogICAqIEFkZCBhbiBleGNlcHRpb24gc3RhY2sgdHJhY2UgdG8gdGhpcyBsb2cgZW50cnkuCiAgICogQSBsb2cgZW50cnkgbWF5IGNvbnRhaW4gb25seSBvbmUgZXhjZXB0aW9uIHN0YWNrIHRyYWNlLgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS53aXRoRXhjZXB0aW9uID0gZnVuY3Rpb24gKGUpIHsKICAgIHRoaXMuZXhjZXB0aW9uID0gbmV3IExvZ2dlZEV4Y2VwdGlvbihlKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8qKgogICAqIEFkZCBhbiBhcmJpdHJhcnkgb2JqZWN0IHRvIHRoZSBsb2cgZW50cnkuICBBIGxvZyBlbnRyeQogICAqIG1heSBjb250YWluIGFueSBudW1iZXIgb2Ygb2JqZWN0cy4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUud2l0aE9iamVjdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBjb3BpZWRPYmogPSBjb25uZWN0LmRlZXBjb3B5KG9iaik7CiAgICByZWRhY3RTZW5zaXRpdmVJbmZvKGNvcGllZE9iaik7CiAgICB0aGlzLm9iamVjdHMucHVzaChjb3BpZWRPYmopOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLyoqCiAgICogQWRkIGEgY3Jvc3Mgb3JpZ2luIGV2ZW50IG9iamVjdCB0byB0aGUgbG9nIGVudHJ5LiAgQSBsb2cgZW50cnkKICAgKiBtYXkgY29udGFpbiBhbnkgbnVtYmVyIG9mIG9iamVjdHMuCiAgICovCiAgIExvZ0VudHJ5LnByb3RvdHlwZS53aXRoQ3Jvc3NPcmlnaW5FdmVudE9iamVjdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBjb3BpZWRPYmogPSBjb25uZWN0LmRlZXBjb3B5Q3Jvc3NPcmlnaW5FdmVudChvYmopOwogICAgcmVkYWN0U2Vuc2l0aXZlSW5mbyhjb3BpZWRPYmopOwogICAgdGhpcy5vYmplY3RzLnB1c2goY29waWVkT2JqKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8qKgogICAqIEluZGljYXRlIHRoYXQgdGhpcyBsb2cgZW50cnkgc2hvdWxkIGJlIHNlbnQgdG8gdGhlIHNlcnZlcgogICAqIE5PVEU6IFRoaXMgc2hvdWxkIGJlIHVzZWQgZm9yIGludGVybmFsIGxvZ3Mgb25seQogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlciA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3QuZ2V0TG9nKCkuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLnB1c2godGhpcyk7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvKioKICAgKiBUaGUgbG9nZ2VyIGluc3RhbmNlLgogICAqLwogIHZhciBMb2dnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLl9sb2dzID0gW107CiAgICB0aGlzLl9yb2xsZWRMb2dzID0gW107CiAgICB0aGlzLl9sb2dzVG9QdXNoID0gW107CiAgICB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncyA9IFtdOwogICAgdGhpcy5fZWNob0xldmVsID0gTG9nTGV2ZWxPcmRlci5JTkZPOwogICAgdGhpcy5fbG9nTGV2ZWwgPSBMb2dMZXZlbE9yZGVyLklORk87CiAgICB0aGlzLl9saW5lQ291bnQgPSAwOwogICAgdGhpcy5fbG9nUm9sbEludGVydmFsID0gMDsKICAgIHRoaXMuX2xvZ1JvbGxUaW1lciA9IG51bGw7CiAgICB0aGlzLl9sb2dnZXJJZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpICsgIi0iICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMik7CiAgICB0aGlzLnNldExvZ1JvbGxJbnRlcnZhbChERUZBVUxUX0xPR19ST0xMX0lOVEVSVkFMKTsKICAgIHRoaXMuX3N0YXJ0TG9nSW5kZXhUb1B1c2ggPSAwOwogIH07CgogIC8qKgogICAqIFNldHMgdGhlIGludGVydmFsIGluIG1pbGxpc2Vjb25kcyB0aGF0IHRoZSBsb2dzIHdpbGwgYmUgcm90YXRlZC4KICAgKiBMb2dzIGFyZSByb3RhdGVkIG91dCBjb21wbGV0ZWx5IGF0IHRoZSBlbmQgb2YgdGhlIHNlY29uZCByb2xsCiAgICogYW5kIHdpbGwgZXZlbnR1YWxseSBiZSBnYXJiYWdlIGNvbGxlY3RlZC4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLnNldExvZ1JvbGxJbnRlcnZhbCA9IGZ1bmN0aW9uIChpbnRlcnZhbCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIGlmICghKHRoaXMuX2xvZ1JvbGxUaW1lcikgfHwgaW50ZXJ2YWwgIT09IHRoaXMuX2xvZ1JvbGxJbnRlcnZhbCkgewogICAgICBpZiAodGhpcy5fbG9nUm9sbFRpbWVyKSB7CiAgICAgICAgZ2xvYmFsLmNsZWFySW50ZXJ2YWwodGhpcy5fbG9nUm9sbFRpbWVyKTsKICAgICAgfQogICAgICB0aGlzLl9sb2dSb2xsSW50ZXJ2YWwgPSBpbnRlcnZhbDsKICAgICAgdGhpcy5fbG9nUm9sbFRpbWVyID0gZ2xvYmFsLnNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGlzLl9yb2xsZWRMb2dzID0gdGhpcy5fbG9nczsKICAgICAgICB0aGlzLl9sb2dzID0gW107CiAgICAgICAgdGhpcy5fc3RhcnRMb2dJbmRleFRvUHVzaCA9IDA7CiAgICAgICAgc2VsZi5pbmZvKCJMb2cgcm9sbCBpbnRlcnZhbCBvY2N1cnJlZC4iKTsKICAgICAgfSwgdGhpcy5fbG9nUm9sbEludGVydmFsKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMud2FybigiTG9nZ2VyIGlzIGFscmVhZHkgc2V0IHRvIHRoZSBnaXZlbiBpbnRlcnZhbDogJWQiLCB0aGlzLl9sb2dSb2xsSW50ZXJ2YWwpOwogICAgfQogIH07CgogIC8qKgogICAqIFNldCB0aGUgbG9nIGxldmVsLiAgVGhpcyBpcyB0aGUgbWluaW11bSBsZXZlbCBhdCB3aGljaCBsb2dzIHdpbGwKICAgKiBiZSBrZXB0IGZvciBsYXRlciBhcmNoaXZpbmcuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5zZXRMb2dMZXZlbCA9IGZ1bmN0aW9uIChsZXZlbCkgewogICAgaWYgKGxldmVsIGluIExvZ0xldmVsT3JkZXIpIHsKICAgICAgdGhpcy5fbG9nTGV2ZWwgPSBMb2dMZXZlbE9yZGVyW2xldmVsXTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBsb2dnaW5nIGxldmVsOiAiICsgbGV2ZWwpOwogICAgfQogIH07CgogIC8qKgogICAqIFNldCB0aGUgZWNobyBsZXZlbC4gIFRoaXMgaXMgdGhlIG1pbmltdW0gbGV2ZWwgYXQgd2hpY2ggbG9ncyB3aWxsCiAgICogYmUgcHJpbnRlZCB0byB0aGUgamF2YXNjcmlwdCBjb25zb2xlLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUuc2V0RWNob0xldmVsID0gZnVuY3Rpb24gKGxldmVsKSB7CiAgICBpZiAobGV2ZWwgaW4gTG9nTGV2ZWxPcmRlcikgewogICAgICB0aGlzLl9lY2hvTGV2ZWwgPSBMb2dMZXZlbE9yZGVyW2xldmVsXTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBsb2dnaW5nIGxldmVsOiAiICsgbGV2ZWwpOwogICAgfQogIH07CgogIC8qKgogICAqIFdyaXRlIGEgcGFydGljdWxhciBsb2cgZW50cnkuCiAgICoKICAgKiBAcGFyYW0gbGV2ZWwgVGhlIGxvZ2dpbmcgbGV2ZWwgb2YgdGhlIGVudHJ5LgogICAqIEBwYXJhbSB0ZXh0IFRoZSB0ZXh0IGNvbnRlbnRzIG9mIHRoZSBlbnRyeS4KICAgKgogICAqIEByZXR1cm5zIFRoZSBuZXcgbG9nIGVudHJ5LgogICAqLwogIExvZ2dlci5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbiAoY29tcG9uZW50LCBsZXZlbCwgdGV4dCkgewogICAgdmFyIGxvZ0VudHJ5ID0gbmV3IExvZ0VudHJ5KGNvbXBvbmVudCwgbGV2ZWwsIHRleHQsIHRoaXMuZ2V0TG9nZ2VySWQoKSk7CiAgICByZWRhY3RTZW5zaXRpdmVJbmZvKGxvZ0VudHJ5KTsKICAgIHRoaXMuYWRkTG9nRW50cnkobG9nRW50cnkpOwogICAgcmV0dXJuIGxvZ0VudHJ5OwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuYWRkTG9nRW50cnkgPSBmdW5jdGlvbiAobG9nRW50cnkpIHsKICAgIC8vIENhbGwgdGhpcyBzZWNvbmQgdGltZSBhcyBpbiBzb21lIHBsYWNlcyB0aGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCBkaXJlY3RseQogICAgcmVkYWN0U2Vuc2l0aXZlSW5mbyhsb2dFbnRyeSk7CiAgICB0aGlzLl9sb2dzLnB1c2gobG9nRW50cnkpOwoKICAgIC8vRm9yIG5vdyBvbmx5IHNlbmQgc29mdHBob25lIGxvZ3Mgb25seS4KICAgIC8vVE9ETyBhZGQgQ0NQIGxvZ3Mgb25jZSB3ZSBhcmUgc3VyZSB0aGF0IG5vIHNlbnNpdGl2ZSBkYXRhIGlzIGJlaW5nIGxvZ2dlZC4KICAgIGlmIChMb2dDb21wb25lbnQuU09GVFBIT05FID09PSBsb2dFbnRyeS5jb21wb25lbnQpIHsKICAgICAgdGhpcy5fbG9nc1RvUHVzaC5wdXNoKGxvZ0VudHJ5KTsKICAgIH0KCiAgICBpZiAobG9nRW50cnkubGV2ZWwgaW4gTG9nTGV2ZWxPcmRlciAmJgogICAgICBMb2dMZXZlbE9yZGVyW2xvZ0VudHJ5LmxldmVsXSA+PSB0aGlzLl9sb2dMZXZlbCkgewoKICAgICAgaWYgKExvZ0xldmVsT3JkZXJbbG9nRW50cnkubGV2ZWxdID49IHRoaXMuX2VjaG9MZXZlbCkgewogICAgICAgIENPTlNPTEVfTE9HR0VSX01BUFtsb2dFbnRyeS5nZXRMZXZlbCgpXShsb2dFbnRyeS50b1N0cmluZygpKTsKICAgICAgfQoKICAgICAgbG9nRW50cnkubGluZSA9IHRoaXMuX2xpbmVDb3VudCsrOwogICAgfQogIH07CgogIExvZ2dlci5wcm90b3R5cGUuc2VuZEludGVybmFsTG9nRW50cnlUb1NlcnZlciA9IGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MucHVzaChsb2dFbnRyeSk7CgogICAgaWYgKGxvZ0VudHJ5LmxldmVsIGluIExvZ0xldmVsT3JkZXIgJiYKICAgICAgTG9nTGV2ZWxPcmRlcltsb2dFbnRyeS5sZXZlbF0gPj0gdGhpcy5fbG9nTGV2ZWwpIHsKCiAgICAgIGlmIChMb2dMZXZlbE9yZGVyW2xvZ0VudHJ5LmxldmVsXSA+PSB0aGlzLl9lY2hvTGV2ZWwpIHsKICAgICAgICBDT05TT0xFX0xPR0dFUl9NQVBbbG9nRW50cnkuZ2V0TGV2ZWwoKV0obG9nRW50cnkudG9TdHJpbmcoKSk7CiAgICAgIH0KCiAgICAgIGxvZ0VudHJ5LmxpbmUgPSB0aGlzLl9saW5lQ291bnQrKzsKICAgIH0KICB9OwoKICAvKioKICAgKiBSZW1vdmUgYWxsIG9iamVjdHMgZnJvbSBhbGwgbG9nIGVudHJpZXMuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5jbGVhck9iamVjdHMgPSBmdW5jdGlvbiAoKSB7CiAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHRoaXMuX2xvZ3MubGVuZ3RoOyB4KyspIHsKICAgICAgaWYgKHRoaXMuX2xvZ3NbeF0ub2JqZWN0cykgewogICAgICAgIGRlbGV0ZSB0aGlzLl9sb2dzW3hdLm9iamVjdHM7CiAgICAgIH0KICAgIH0KICB9OwoKICAvKioKICAgKiBSZW1vdmUgYWxsIGV4Y2VwdGlvbiBzdGFjayB0cmFjZXMgZnJvbSB0aGUgbG9nIGVudHJpZXMuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5jbGVhckV4Y2VwdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHRoaXMuX2xvZ3MubGVuZ3RoOyB4KyspIHsKICAgICAgaWYgKHRoaXMuX2xvZ3NbeF0uZXhjZXB0aW9uKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2xvZ3NbeF0uZXhjZXB0aW9uOwogICAgICB9CiAgICB9CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS50cmFjZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5UUkFDRSwgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5kZWJ1ZyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5ERUJVRywgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5pbmZvID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLklORk8sIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUubG9nID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLkxPRywgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS50ZXN0ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLlRFU1QsIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUud2FybiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5XQVJOLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmVycm9yID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLkVSUk9SLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmNyaXRpY2FsID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLkVSUk9SLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICAvKioKICAgKiBDcmVhdGUgYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGxvZ2dlciBjb250ZW50cy4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxpbmVzID0gW107CiAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHRoaXMuX2xvZ3MubGVuZ3RoOyB4KyspIHsKICAgICAgbGluZXMucHVzaCh0aGlzLl9sb2dzW3hdLnRvU3RyaW5nKCkpOwogICAgfQoKICAgIHJldHVybiBsaW5lcy5qb2luKCJcbiIpOwogIH07CiAgCiAgLyoqCiAgICogRG93bmxvYWQvQXJjaGl2ZSBsb2dzIHRvIGEgZmlsZSwgCiAgICogQnkgZGVmYXVsdCwgaXQgcmV0dXJucyBhbGwgbG9ncy4KICAgKiBUbyBmaWx0ZXIgbG9ncyBieSB0aGUgbWluaW11bSBsb2cgbGV2ZWwgc2V0IGJ5IHNldExvZ0xldmVsIG9yIHRoZSBkZWZhdWx0IHNldCBpbiBfbG9nTGV2ZWwsIAogICAqIHBhc3MgaW4gZmlsdGVyQnlMb2dMZXZlbCB0byB0cnVlIGluIG9wdGlvbnMKICAgKiAKICAgKiBAcGFyYW0gb3B0aW9ucyBkb3dubG9hZCBvcHRpb25zIFtPYmplY3R8U3RyaW5nXS4gCiAgICogLSBvZiB0eXBlIE9iamVjdDogCiAgICogICB7IGxvZ05hbWU6ICdteS1sb2ctbmFtZScsCiAgICogICAgIGZpbHRlckJ5TG9nTGV2ZWw6IGZhbHNlLCAvL2Rvd25sb2FkIGFsbCBsb2dzCiAgICogICB9CiAgICogLSBvZiB0eXBlIFN0cmluZyAoZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkpLCB0aGUgZmlsZSdzIG5hbWUKICAgKi8KICBMb2dnZXIucHJvdG90eXBlLmRvd25sb2FkID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdmFyIGxvZ05hbWUgPSAnYWdlbnQtbG9nJzsKICAgIHZhciBmaWx0ZXJCeUxvZ0xldmVsID0gZmFsc2U7CgogICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnb2JqZWN0JykgewogICAgICBsb2dOYW1lID0gb3B0aW9ucy5sb2dOYW1lIHx8IGxvZ05hbWU7CiAgICAgIGZpbHRlckJ5TG9nTGV2ZWwgPSBvcHRpb25zLmZpbHRlckJ5TG9nTGV2ZWwgfHwgZmlsdGVyQnlMb2dMZXZlbDsKICAgIH0KICAgIGVsc2UgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJykgewogICAgICBsb2dOYW1lID0gb3B0aW9ucyB8fCBsb2dOYW1lOwogICAgfQoKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBsb2dzID0gdGhpcy5fcm9sbGVkTG9ncy5jb25jYXQodGhpcy5fbG9ncyk7CiAgICBpZiAoZmlsdGVyQnlMb2dMZXZlbCkgewogICAgICBsb2dzID0gbG9ncy5maWx0ZXIoZnVuY3Rpb24oZW50cnkpIHsKICAgICAgICByZXR1cm4gTG9nTGV2ZWxPcmRlcltlbnRyeS5sZXZlbF0gPj0gc2VsZi5fbG9nTGV2ZWw7CiAgICAgIH0pOwogICAgfQoKICAgIHZhciBsb2dCbG9iID0gbmV3IGdsb2JhbC5CbG9iKFtKU09OLnN0cmluZ2lmeShsb2dzLCB1bmRlZmluZWQsIDQpXSwgWyd0ZXh0L3BsYWluJ10pOwogICAgdmFyIGRvd25sb2FkTGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgIHZhciBsb2dOYW1lID0gbG9nTmFtZSB8fCAnYWdlbnQtbG9nJzsKICAgIGRvd25sb2FkTGluay5ocmVmID0gZ2xvYmFsLlVSTC5jcmVhdGVPYmplY3RVUkwobG9nQmxvYik7CiAgICBkb3dubG9hZExpbmsuZG93bmxvYWQgPSBsb2dOYW1lICsgJy50eHQnOwogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChkb3dubG9hZExpbmspOwogICAgZG93bmxvYWRMaW5rLmNsaWNrKCk7CiAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGRvd25sb2FkTGluayk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5zY2hlZHVsZVVwc3RyZWFtTG9nUHVzaCA9IGZ1bmN0aW9uIChjb25kdWl0KSB7CiAgICBpZiAoIWNvbm5lY3QudXBzdHJlYW1Mb2dQdXNoU2NoZWR1bGVkKSB7CiAgICAgIGNvbm5lY3QudXBzdHJlYW1Mb2dQdXNoU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgLyoqIFNjaGVkdWxlIHB1c2hpbmcgbG9ncyBmcmVxdWVudGx5IHRvIHNoYXJlZHdvcmtlciB1cHN0cmVhbSwgc2hhcmVkd29ya2VyIHdpbGwgcmVwb3J0IHRvIExBUlMqLwogICAgICBnbG9iYWwuc2V0SW50ZXJ2YWwoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnJlcG9ydE1hc3RlckxvZ3NVcFN0cmVhbSwgY29uZHVpdCksIFNPRlRQSE9ORV9MT0dfUkVQT1JUX0lOVEVSVkFMX01JTExJUyk7CiAgICB9CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5yZXBvcnRNYXN0ZXJMb2dzVXBTdHJlYW0gPSBmdW5jdGlvbiAoY29uZHVpdCkgewogICAgdmFyIGxvZ3NUb1B1c2ggPSB0aGlzLl9sb2dzVG9QdXNoLnNsaWNlKCk7CiAgICB0aGlzLl9sb2dzVG9QdXNoID0gW107CiAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNFTkRfTE9HUywgZnVuY3Rpb24gKCkgewogICAgICBpZiAobG9nc1RvUHVzaC5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU0VORF9MT0dTLCBsb2dzVG9QdXNoKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5zY2hlZHVsZVVwc3RyZWFtT3V0ZXJDb250ZXh0Q0NQc2VydmVyQm91bmRMb2dzUHVzaCA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMucHVzaE91dGVyQ29udGV4dENDUHNlcnZlckJvdW5kTG9nc1Vwc3RyZWFtLCBjb25kdWl0KSwgMTAwMCk7CiAgfQoKICBMb2dnZXIucHJvdG90eXBlLnNjaGVkdWxlVXBzdHJlYW1PdXRlckNvbnRleHRDQ1BMb2dzUHVzaCA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMucHVzaE91dGVyQ29udGV4dENDUExvZ3NVcHN0cmVhbSwgY29uZHVpdCksIDEwMDApOwogIH0KCiAgTG9nZ2VyLnByb3RvdHlwZS5wdXNoT3V0ZXJDb250ZXh0Q0NQc2VydmVyQm91bmRMb2dzVXBzdHJlYW0gPSBmdW5jdGlvbihjb25kdWl0KSB7CiAgICBpZiAodGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MubGVuZ3RoID4gMCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3NbaV0udGV4dCA9IHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzW2ldLnRleHQ7CiAgICAgIH0KCiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNFUlZFUl9CT1VORF9JTlRFUk5BTF9MT0csIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzKTsKICAgICAgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MgPSBbXTsKICAgIH0KICB9CgogIExvZ2dlci5wcm90b3R5cGUucHVzaE91dGVyQ29udGV4dENDUExvZ3NVcHN0cmVhbSA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgIGZvciAodmFyIGkgPSB0aGlzLl9zdGFydExvZ0luZGV4VG9QdXNoOyBpIDwgdGhpcy5fbG9ncy5sZW5ndGg7IGkrKykgewogICAgICBpZiAodGhpcy5fbG9nc1tpXS5sb2dnZXJJZCAhPT0gdGhpcy5fbG9nZ2VySWQpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIHRoaXMuX2xvZ3NbaV0pOwogICAgfQogICAgdGhpcy5fc3RhcnRMb2dJbmRleFRvUHVzaCA9IHRoaXMuX2xvZ3MubGVuZ3RoOwogIH0KCiAgTG9nZ2VyLnByb3RvdHlwZS5nZXRMb2dnZXJJZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9sb2dnZXJJZDsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnNjaGVkdWxlRG93bnN0cmVhbUNsaWVudFNpZGVMb2dzUHVzaCA9IGZ1bmN0aW9uICgpIHsKICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMucHVzaENsaWVudFNpZGVMb2dzRG93bnN0cmVhbSksIExPR1NfUkVQT1JUX0lOVEVSVkFMX01JTExJUyk7CiAgfQoKICBMb2dnZXIucHJvdG90eXBlLnB1c2hDbGllbnRTaWRlTG9nc0Rvd25zdHJlYW0gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9ncyA9IFtdOwoKICAgIC8vIFdlIGRvIG5vdCBzZW5kIGEgcmVxdWVzdCBpZiB3ZSBoYXZlIGxlc3MgdGhhbiA1MCByZWNvcmRzIHNvIHRoYXQgd2UgbWluaW1pemUgdGhlIG51bWJlciBvZgogICAgLy8gcmVxdWVzdHMgcGVyIHNlY29uZC4gCiAgICAvLyA1MDAgaXMgdGhlIG1heCB3ZSBhY2NlcHQgb24gdGhlIHNlcnZlci4gCiAgICAvLyBXZSBjaG9zZSA1MDAgYmVjYXVzZSB0aGlzIGlzIHRoZSBsaW1pdCBpbXBvc2VkIGJ5IEZpcmVob3NlIGZvciBhIHB1dCBiYXRjaCByZXF1ZXN0CiAgICBpZiAodGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MubGVuZ3RoIDwgNTApIHsKICAgICAgcmV0dXJuOwogICAgfSBlbHNlIGlmICh0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5sZW5ndGggPiA1MDApIHsKICAgICAgbG9ncyA9IHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLnNwbGljZSgwLCA1MDApOwogICAgfSBlbHNlIHsKICAgICAgbG9ncyA9IHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzOwogICAgICB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncyA9IFtdOwogICAgfQoKICAgIGNvbm5lY3QucHVibGlzaENsaWVudFNpZGVMb2dzKGxvZ3MpOwogIH0KCiAgdmFyIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyID0gZnVuY3Rpb24gKGNvbmR1aXQpIHsKICAgIExvZ2dlci5jYWxsKHRoaXMpOwogICAgdGhpcy5jb25kdWl0ID0gY29uZHVpdDsKICAgIAogICAgZ2xvYmFsLnNldEludGVydmFsKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5fcHVzaExvZ3NEb3duc3RyZWFtKSwKICAgICAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIuTE9HX1BVU0hfSU5URVJWQUwpOwoKICAgIC8vIERpc2FibGUgbG9nIHJvbGxpbmcsIHdlIHdpbGwgcHVyZ2Ugb3VyIG93biBsb2dzIG9uY2UgdGhleSBoYXZlCiAgICAvLyBiZWVuIHB1c2hlZCBkb3duc3RyZWFtLgogICAgZ2xvYmFsLmNsZWFySW50ZXJ2YWwodGhpcy5fbG9nUm9sbFRpbWVyKTsKICAgIHRoaXMuX2xvZ1JvbGxUaW1lciA9IG51bGw7CiAgfTsKICAvLyBIb3cgZnJlcXVlbnRseSBsb2dzIHNob3VsZCBiZSBjb2xsZWN0ZWQgYW5kIGRlbGl2ZXJlZCBkb3duc3RyZWFtLgogIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLkxPR19QVVNIX0lOVEVSVkFMID0gMTAwMDsKICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKExvZ2dlci5wcm90b3R5cGUpOwogIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IERvd25zdHJlYW1Db25kdWl0TG9nZ2VyOwoKICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5wcm90b3R5cGUucHVzaExvZ3NEb3duc3RyZWFtID0gZnVuY3Rpb24gKGxvZ3MpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGxvZ3MuZm9yRWFjaChmdW5jdGlvbiAobG9nKSB7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIGxvZyk7CiAgICB9KTsKICB9OwoKICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5wcm90b3R5cGUuX3B1c2hMb2dzRG93bnN0cmVhbSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIAogICAgdGhpcy5fbG9ncy5mb3JFYWNoKGZ1bmN0aW9uIChsb2cpIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgbG9nKTsKICAgIH0pOwogICAgdGhpcy5fbG9ncyA9IFtdOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgdGhpcy5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNFUlZFUl9CT1VORF9JTlRFUk5BTF9MT0csIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzW2ldKTsKICAgIH0KCiAgICB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncyA9IFtdOwogIH07CgogIC8qKgogICAqIFdyYXAgYSBmdW5jdGlvbiB3aXRoIHRyeSBjYXRjaCBibG9jawogICAqLwogIHZhciB0cnlDYXRjaFdyYXBwZXJNZXRob2QgPSBmdW5jdGlvbiAoZm4pIHsKICAgIHZhciB3cmFwcGVkZnVuY3Rpb24gPSBmdW5jdGlvbigpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIC8vIFNpbmNlIHRoaXMgd3JhcHMgTG9nZ2VyIGNsYXNzLCB3ZSBjYW4gb25seSBwcmludCBpdCBpbiB0aGUgY29uc29sZSBhbmQgZWF0IGl0LgogICAgICAgIENPTlNPTEVfTE9HR0VSX01BUC5FUlJPUihlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHdyYXBwZWRmdW5jdGlvbjsKICB9CiAgLyoqCiAgICogVGhpcyBpcyBhIHdyYXBwZXIgbWV0aG9kIHRvIHdyYXAgZWFjaCBmdW5jdGlvbgogICAqIGluIGFuIG9iamVjdCB3aXRoIHRyeSBjYXRjaCBibG9jay4KICAgKi8KICB2YXIgdHJ5Q2F0Y2hXcmFwcGVyT2JqZWN0ID0gZnVuY3Rpb24gKG9iaikgewogICAgZm9yICh2YXIgbWV0aG9kIGluIG9iaikgewogICAgICBpZiAodHlwZW9mKG9ialttZXRob2RdKSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIG9ialttZXRob2RdID0gdHJ5Q2F0Y2hXcmFwcGVyTWV0aG9kKG9ialttZXRob2RdKTsKICAgICAgfQogICAgfQogIH0KCiAgLyoqIENyZWF0ZSB0aGUgc2luZ2xldG9uIGxvZ2dlciBpbnN0YW5jZS4gKi8KICBjb25uZWN0LnJvb3RMb2dnZXIgPSBuZXcgTG9nZ2VyKCk7CiAgdHJ5Q2F0Y2hXcmFwcGVyT2JqZWN0KGNvbm5lY3Qucm9vdExvZ2dlcik7CgoKICAvKiogRmV0Y2ggdGhlIHNpbmdsZXRvbiBsb2dnZXIgaW5zdGFuY2UuICovCiAgdmFyIGdldExvZyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LnJvb3RMb2dnZXI7CiAgfTsKCiAgY29ubmVjdCA9IGNvbm5lY3QgfHwge307CiAgY29ubmVjdC5nZXRMb2cgPSBnZXRMb2c7CiAgY29ubmVjdC5Mb2dFbnRyeSA9IExvZ0VudHJ5OwogIGNvbm5lY3QuTG9nZ2VyID0gTG9nZ2VyOwogIGNvbm5lY3QuTG9nTGV2ZWwgPSBMb2dMZXZlbDsKICBjb25uZWN0LkxvZ0NvbXBvbmVudCA9IExvZ0NvbXBvbmVudDsKICBjb25uZWN0LkRvd25zdHJlYW1Db25kdWl0TG9nZ2VyID0gRG93bnN0cmVhbUNvbmR1aXRMb2dnZXI7Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA0Mzk6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBbWF6b24gU29mdHdhcmUgTGljZW5zZSAodGhlICJMaWNlbnNlIikuIFlvdSBtYXkgbm90IHVzZQogKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzCiAqIGxvY2F0ZWQgYXQKICoKICogICAgaHR0cDovL2F3cy5hbWF6b24uY29tL2FzbC8KICoKICogb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZAogKiBvbiBhbiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcwogKiBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMKICogYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKi8KCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKCiAgY29ubmVjdC5DaGF0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKG1lZGlhSW5mbywgbWV0YWRhdGEpIHsKICAgIHZhciBsb2dnZXIgPSBjb25uZWN0LmdldExvZygpOwogICAgdmFyIGxvZ0NvbXBvbmVudCA9IGNvbm5lY3QuTG9nQ29tcG9uZW50LkNIQVQ7CgogICAgdmFyIGNyZWF0ZU1lZGlhSW5zdGFuY2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBtZWRpYSBjb250cm9sbGVyIGluaXQiLCBtZWRpYUluZm8uY29udGFjdElkKTsKICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAiQ2hhdCBtZWRpYSBjb250cm9sbGVyIGluaXQiKQogICAgICAgIC53aXRoT2JqZWN0KG1lZGlhSW5mbykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICAgIGNvbm5lY3QuQ2hhdFNlc3Npb24uc2V0R2xvYmFsQ29uZmlnKHsKICAgICAgICBsb2dnZXJDb25maWc6IHsKICAgICAgICAgIGxvZ2dlcjogbG9nZ2VyCiAgICAgICAgfSwKICAgICAgICByZWdpb246IG1ldGFkYXRhLnJlZ2lvbgogICAgICB9KTsKCiAgICAgIC8qKiBDb3VsZCBiZSBhbHNvIENVU1RPTUVSIC0gIEZvciBub3cgd2UgYXJlIGNyZWF0aW5nIG9ubHkgQWdlbnQgY29ubmVjdGlvbiBtZWRpYSBvYmplY3QgKi8KICAgICAgdmFyIGNvbnRyb2xsZXIgPSBjb25uZWN0LkNoYXRTZXNzaW9uLmNyZWF0ZSh7CiAgICAgICAgY2hhdERldGFpbHM6IG1lZGlhSW5mbywKICAgICAgICB0eXBlOiAiQUdFTlQiLAogICAgICAgIHdlYnNvY2tldE1hbmFnZXI6IGNvbm5lY3QuY29yZS5nZXRXZWJTb2NrZXRNYW5hZ2VyKCkKICAgICAgfSk7CiAgICAgIAogICAgICB0cmFja0NoYXRDb25uZWN0aW9uU3RhdHVzKGNvbnRyb2xsZXIpOwogICAgICByZXR1cm4gY29udHJvbGxlcgogICAgICAgIC5jb25uZWN0KCkKICAgICAgICAudGhlbihmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAiQ2hhdCBTZXNzaW9uIFN1Y2Nlc3NmdWxseSBlc3RhYmxpc2hlZCBmb3IgY29udGFjdElkICVzIiwgbWVkaWFJbmZvLmNvbnRhY3RJZCkKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgU2Vzc2lvbiBTdWNjZXNzZnVsbHkgZXN0YWJsaXNoZWQiLCBtZWRpYUluZm8uY29udGFjdElkKTsKICAgICAgICAgIHJldHVybiBjb250cm9sbGVyOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgbG9nZ2VyLmVycm9yKGxvZ0NvbXBvbmVudCwgIkNoYXQgU2Vzc2lvbiBlc3RhYmxpc2hlbWVudCBmYWlsZWQgZm9yIGNvbnRhY3QgJXMiLCBtZWRpYUluZm8uY29udGFjdElkKQogICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlcnJvcikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBTZXNzaW9uIGVzdGFibGlzaGVtZW50IGZhaWxlZCIsIG1lZGlhSW5mby5jb250YWN0SWQsIGVycm9yKTsKICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgIH0pOwogICAgfTsKCiAgICB2YXIgcHVibGlzaFRlbGVtZXRyeUV2ZW50ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgZGF0YSkgewogICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgIG5hbWU6IGV2ZW50TmFtZSwKICAgICAgICBjb250YWN0SWQ6IG1lZGlhSW5mby5jb250YWN0SWQsCiAgICAgICAgZGF0YTogZGF0YSB8fCBtZWRpYUluZm8KICAgICAgfSk7CiAgICB9OwoKICAgIHZhciB0cmFja0NoYXRDb25uZWN0aW9uU3RhdHVzID0gZnVuY3Rpb24gKGNvbnRyb2xsZXIpIHsKICAgICAgY29udHJvbGxlci5vbkNvbm5lY3Rpb25Ccm9rZW4oZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBsb2dnZXIuZXJyb3IobG9nQ29tcG9uZW50LCAiQ2hhdCBTZXNzaW9uIGNvbm5lY3Rpb24gYnJva2VuIikKICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDaGF0IFNlc3Npb24gY29ubmVjdGlvbiBicm9rZW4iLCBkYXRhKTsKICAgICAgfSk7CgogICAgICBjb250cm9sbGVyLm9uQ29ubmVjdGlvbkVzdGFibGlzaGVkKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAiQ2hhdCBTZXNzaW9uIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQiKQogICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgU2Vzc2lvbiBjb25uZWN0aW9uIGVzdGFibGlzaGVkIiwgZGF0YSk7CiAgICAgIH0pOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjcmVhdGVNZWRpYUluc3RhbmNlKCk7CiAgICAgIH0KICAgIH0KICB9Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyAyNzk6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBbWF6b24gU29mdHdhcmUgTGljZW5zZSAodGhlICJMaWNlbnNlIikuIFlvdSBtYXkgbm90IHVzZQogKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzCiAqIGxvY2F0ZWQgYXQKICoKICogICAgaHR0cDovL2F3cy5hbWF6b24uY29tL2FzbC8KICoKICogb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZAogKiBvbiBhbiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcwogKiBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMKICogYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKi8KCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKCiAgY29ubmVjdC5NZWRpYUZhY3RvcnkgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICAvKiogY29udHJvbGxlciBob2xkZXIgKi8KICAgIHZhciBtZWRpYUNvbnRyb2xsZXJzID0ge307CiAgICB2YXIgdG9CZURlc3Ryb3llZCA9IG5ldyBTZXQoKTsKCiAgICB2YXIgbG9nZ2VyID0gY29ubmVjdC5nZXRMb2coKTsKICAgIHZhciBsb2dDb21wb25lbnQgPSBjb25uZWN0LkxvZ0NvbXBvbmVudC5DSEFUOwoKICAgIHZhciBtZXRhZGF0YSA9IGNvbm5lY3QubWVyZ2Uoe30sIHBhcmFtcykgfHwge307CiAgICBtZXRhZGF0YS5yZWdpb24gPSAgbWV0YWRhdGEucmVnaW9uIHx8ICJ1cy13ZXN0LTIiOyAvLyBEZWZhdWx0IGl0IHRvIHVzLXdlc3QtMgoKICAgIHZhciBnZXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoY29ubmVjdGlvbk9iaikgewogICAgICB2YXIgY29ubmVjdGlvbklkID0gY29ubmVjdGlvbk9iai5nZXRDb25uZWN0aW9uSWQoKTsKICAgICAgdmFyIG1lZGlhSW5mbyA9IGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFJbmZvKCk7CiAgICAgIC8qKiBpZiB3ZSBkbyBub3QgaGF2ZSB0aGUgbWVkaWEgaW5mbyB0aGVuIGp1c3QgcmVqZWN0IHRoZSByZXF1ZXN0ICovCiAgICAgIGlmICghbWVkaWFJbmZvKSB7CiAgICAgICAgbG9nZ2VyLmVycm9yKGxvZ0NvbXBvbmVudCwgIk1lZGlhIGluZm8gZG9lcyBub3QgZXhpc3QgZm9yIGEgbWVkaWEgdHlwZSAlcyIsIGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFUeXBlKCkpCiAgICAgICAgICAud2l0aE9iamVjdChjb25uZWN0aW9uT2JqKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgiTWVkaWEgaW5mbyBkb2VzIG5vdCBleGlzdCBmb3IgdGhpcyBjb25uZWN0aW9uIik7CiAgICAgIH0KCiAgICAgIGlmICghbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdKSB7CiAgICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAibWVkaWEgY29udHJvbGxlciBvZiB0eXBlICVzIGluaXQiLCBjb25uZWN0aW9uT2JqLmdldE1lZGlhVHlwZSgpKQogICAgICAgICAgLndpdGhPYmplY3QoY29ubmVjdGlvbk9iaikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBzd2l0Y2ggKGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFUeXBlKCkpIHsKICAgICAgICAgIGNhc2UgY29ubmVjdC5NZWRpYVR5cGUuQ0hBVDoKICAgICAgICAgICAgcmV0dXJuIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXSA9IG5ldyBjb25uZWN0LkNoYXRNZWRpYUNvbnRyb2xsZXIoY29ubmVjdGlvbk9iai5nZXRNZWRpYUluZm8oKSwgbWV0YWRhdGEpLmdldCgpOwogICAgICAgICAgY2FzZSBjb25uZWN0Lk1lZGlhVHlwZS5TT0ZUUEhPTkU6CiAgICAgICAgICAgIHJldHVybiBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0gPSBuZXcgY29ubmVjdC5Tb2Z0cGhvbmVNZWRpYUNvbnRyb2xsZXIoY29ubmVjdGlvbk9iai5nZXRNZWRpYUluZm8oKSkuZ2V0KCk7CiAgICAgICAgICBjYXNlIGNvbm5lY3QuTWVkaWFUeXBlLlRBU0s6CiAgICAgICAgICAgIHJldHVybiBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0gPSBuZXcgY29ubmVjdC5UYXNrTWVkaWFDb250cm9sbGVyKGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFJbmZvKCkpLmdldCgpOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGxvZ0NvbXBvbmVudCwgIlVucmVjb2duaXplZCBtZWRpYSB0eXBlICVzICIsIGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFUeXBlKCkpCiAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdOwogICAgICB9CiAgICB9OwoKICAgIC8qKiBDaGVjayBhbGwgdGhlIGFjdGl2ZSBzdGF0ZXMgZm9yIHRoZSBjb25uZWN0aW9uICovCiAgICB2YXIgaWZDb25uZWN0aW9uQWN0aXZlID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25PYmopIHsKICAgICAgcmV0dXJuIGNvbm5lY3Rpb25PYmouaXNBY3RpdmUoKTsKICAgIH07CgogICAgdmFyIGdldCA9IGZ1bmN0aW9uIChjb25uZWN0aW9uT2JqKSB7CiAgICAgIGlmIChpZkNvbm5lY3Rpb25BY3RpdmUoY29ubmVjdGlvbk9iaikpIHsKICAgICAgICByZXR1cm4gZ2V0TWVkaWFDb250cm9sbGVyKGNvbm5lY3Rpb25PYmopOwogICAgICB9IGVsc2UgewogICAgICAgIGRlc3Ryb3koY29ubmVjdGlvbk9iai5nZXRDb25uZWN0aW9uSWQoKSk7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJNZWRpYSBDb250cm9sbGVyIGlzIG5vIGxvbmdlciBhdmFpbGFibGUgZm9yIHRoaXMgY29ubmVjdGlvbiIpOwogICAgICB9CiAgICB9OwoKICAgIHZhciBkZXN0cm95ID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25JZCkgewogICAgICBpZiAobWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdICYmICF0b0JlRGVzdHJveWVkLmhhcyhjb25uZWN0aW9uSWQpKSB7CiAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICBsb2dDb21wb25lbnQsCiAgICAgICAgICAiRGVzdHJveWluZyBtZWRpYUNvbnRyb2xsZXIgZm9yICVzIiwKICAgICAgICAgIGNvbm5lY3Rpb25JZAogICAgICAgICk7CiAgICAgICAgdG9CZURlc3Ryb3llZC5hZGQoY29ubmVjdGlvbklkKTsKICAgICAgICBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0KICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRyb2xsZXIuY2xlYW5VcCA9PT0gImZ1bmN0aW9uIikgY29udHJvbGxlci5jbGVhblVwKCk7CiAgICAgICAgICAgIGRlbGV0ZSBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF07CiAgICAgICAgICAgIHRvQmVEZXN0cm95ZWQuZGVsZXRlKGNvbm5lY3Rpb25JZCk7CiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBkZWxldGUgbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdOwogICAgICAgICAgICB0b0JlRGVzdHJveWVkLmRlbGV0ZShjb25uZWN0aW9uSWQpOwogICAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIHsKICAgICAgZ2V0OiBnZXQsCiAgICAgIGRlc3Ryb3k6IGRlc3Ryb3kKICAgIH07CiAgfQp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gNDE4OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQW1hem9uIFNvZnR3YXJlIExpY2Vuc2UgKHRoZSAiTGljZW5zZSIpLiBZb3UgbWF5IG5vdCB1c2UKICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcwogKiBsb2NhdGVkIGF0CiAqCiAqICAgIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hc2wvCiAqCiAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQKICogb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3MKICogb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zCiAqIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIC8vIFRPRE8gbW92ZSBzb2Z0cGhvbmUgaW1wbGVtZW50YXRpb25zIGhlcmUgLSBXaWwgZG8gdGhpcyBmb3IgR0EKICBjb25uZWN0LlNvZnRwaG9uZU1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uIChtZWRpYUluZm8pIHsKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobWVkaWFJbmZvKQogICAgICB9CiAgICB9CiAgfQp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gMTg3OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQW1hem9uIFNvZnR3YXJlIExpY2Vuc2UgKHRoZSAiTGljZW5zZSIpLiBZb3UgbWF5IG5vdCB1c2UKICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcwogKiBsb2NhdGVkIGF0CiAqCiAqICAgIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hc2wvCiAqCiAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQKICogb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3MKICogb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zCiAqIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIGNvbm5lY3QuVGFza01lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uIChtZWRpYUluZm8pIHsKICAgIHZhciBsb2dnZXIgPSBjb25uZWN0LmdldExvZygpOwogICAgdmFyIGxvZ0NvbXBvbmVudCA9IGNvbm5lY3QuTG9nQ29tcG9uZW50LlRBU0s7CgogICAgdmFyIGNyZWF0ZU1lZGlhSW5zdGFuY2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiVGFzayBtZWRpYSBjb250cm9sbGVyIGluaXQiLCBtZWRpYUluZm8uY29udGFjdElkKTsKICAgICAgbG9nZ2VyCiAgICAgICAgLmluZm8obG9nQ29tcG9uZW50LCAiVGFzayBtZWRpYSBjb250cm9sbGVyIGluaXQiKQogICAgICAgIC53aXRoT2JqZWN0KG1lZGlhSW5mbyk7CgogICAgICB2YXIgY29udHJvbGxlciA9IGNvbm5lY3QuVGFza1Nlc3Npb24uY3JlYXRlKHsKICAgICAgICBjb250YWN0SWQ6IG1lZGlhSW5mby5jb250YWN0SWQsCiAgICAgICAgaW5pdGlhbENvbnRhY3RJZDogbWVkaWFJbmZvLmluaXRpYWxDb250YWN0SWQsCiAgICAgICAgd2Vic29ja2V0TWFuYWdlcjogY29ubmVjdC5jb3JlLmdldFdlYlNvY2tldE1hbmFnZXIoKSwKICAgICAgfSk7CgogICAgICB0cmFja1Rhc2tDb25uZWN0aW9uU3RhdHVzKGNvbnRyb2xsZXIpOwoKICAgICAgcmV0dXJuIGNvbnRyb2xsZXIKICAgICAgICAuY29ubmVjdCgpCiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICAgIGxvZ0NvbXBvbmVudCwKICAgICAgICAgICAgIlRhc2sgU2Vzc2lvbiBTdWNjZXNzZnVsbHkgZXN0YWJsaXNoZWQgZm9yIGNvbnRhY3RJZCAlcyIsCiAgICAgICAgICAgIG1lZGlhSW5mby5jb250YWN0SWQKICAgICAgICAgICk7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoCiAgICAgICAgICAgICJUYXNrIFNlc3Npb24gU3VjY2Vzc2Z1bGx5IGVzdGFibGlzaGVkIiwKICAgICAgICAgICAgbWVkaWFJbmZvLmNvbnRhY3RJZAogICAgICAgICAgKTsKICAgICAgICAgIHJldHVybiBjb250cm9sbGVyOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgbG9nZ2VyCiAgICAgICAgICAgIC5lcnJvcigKICAgICAgICAgICAgICBsb2dDb21wb25lbnQsCiAgICAgICAgICAgICAgIlRhc2sgU2Vzc2lvbiBlc3RhYmxpc2hlbWVudCBmYWlsZWQgZm9yIGNvbnRhY3QgJXMiLAogICAgICAgICAgICAgIG1lZGlhSW5mby5jb250YWN0SWQKICAgICAgICAgICAgKQogICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlcnJvcik7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoCiAgICAgICAgICAgICJDaGF0IFNlc3Npb24gZXN0YWJsaXNoZW1lbnQgZmFpbGVkIiwKICAgICAgICAgICAgbWVkaWFJbmZvLmNvbnRhY3RJZCwKICAgICAgICAgICAgZXJyb3IKICAgICAgICAgICk7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9KTsKICAgIH07CgogICAgdmFyIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGRhdGEpIHsKICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICBuYW1lOiBldmVudE5hbWUsCiAgICAgICAgY29udGFjdElkOiBtZWRpYUluZm8uY29udGFjdElkLAogICAgICAgIGRhdGE6IGRhdGEgfHwgbWVkaWFJbmZvLAogICAgICB9KTsKICAgIH07CgogICAgdmFyIHRyYWNrVGFza0Nvbm5lY3Rpb25TdGF0dXMgPSBmdW5jdGlvbiAoY29udHJvbGxlcikgewogICAgICBjb250cm9sbGVyLm9uQ29ubmVjdGlvbkJyb2tlbihmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGxvZ2dlcgogICAgICAgICAgLmVycm9yKGxvZ0NvbXBvbmVudCwgIlRhc2sgU2Vzc2lvbiBjb25uZWN0aW9uIGJyb2tlbiIpCiAgICAgICAgICAud2l0aEV4Y2VwdGlvbihkYXRhKTsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlRhc2sgU2Vzc2lvbiBjb25uZWN0aW9uIGJyb2tlbiIsIGRhdGEpOwogICAgICB9KTsKCiAgICAgIGNvbnRyb2xsZXIub25Db25uZWN0aW9uRXN0YWJsaXNoZWQoZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBsb2dnZXIKICAgICAgICAgIC5pbmZvKGxvZ0NvbXBvbmVudCwgIlRhc2sgU2Vzc2lvbiBjb25uZWN0aW9uIGVzdGFibGlzaGVkIikKICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpOwogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiVGFzayBTZXNzaW9uIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQiLCBkYXRhKTsKICAgICAgfSk7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjcmVhdGVNZWRpYUluc3RhbmNlKCk7CiAgICAgIH0sCiAgICB9OwogIH07Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA3NDM6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgdmFyIFJpbmd0b25lRW5naW5lQmFzZSA9IGZ1bmN0aW9uIChyaW5ndG9uZUNvbmZpZykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdGhpcy5fcHJldkNvbnRhY3RJZCA9IG51bGw7CgogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJpbmd0b25lQ29uZmlnLCAicmluZ3RvbmVDb25maWciKTsKICAgIGlmICghcmluZ3RvbmVDb25maWcucmluZ3RvbmVVcmwpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJyaW5ndG9uZVVybCBpcyByZXF1aXJlZCEiKTsKICAgIH0KCiAgICBpZiAoZ2xvYmFsLkF1ZGlvICYmIHR5cGVvZiBnbG9iYWwuUHJvbWlzZSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgdGhpcy5fcGxheWFibGVBdWRpb1Byb21pc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgc2VsZi5fYXVkaW8gPSBuZXcgQXVkaW8ocmluZ3RvbmVDb25maWcucmluZ3RvbmVVcmwpOwogICAgICAgIHNlbGYuX2F1ZGlvLmxvb3AgPSB0cnVlOwogICAgICAgIHNlbGYuX2F1ZGlvLmFkZEV2ZW50TGlzdGVuZXIoImNhbnBsYXkiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBzZWxmLl9hdWRpb1BsYXlhYmxlID0gdHJ1ZTsKICAgICAgICAgIHJlc29sdmUoc2VsZi5fYXVkaW8pOwogICAgICAgIH0pOwogICAgICB9KTsKCiAgICB9IGVsc2UgewogICAgICB0aGlzLl9hdWRpbyA9IG51bGw7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIlVuYWJsZSB0byBwcm92aWRlIGEgcmluZ3RvbmUuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KCiAgICBzZWxmLl9kcml2ZVJpbmd0b25lKCk7CiAgfTsKCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5fZHJpdmVSaW5ndG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRocm93IG5ldyBFcnJvcigiTm90IGltcGxlbWVudGVkLiIpOwogIH07CgogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuX3N0YXJ0UmluZ3RvbmUgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYgKHRoaXMuX2F1ZGlvKSB7CiAgICAgIHRoaXMuX2F1ZGlvLnBsYXkoKQogICAgICAgIC5jYXRjaChmdW5jdGlvbihlKSB7CiAgICAgICAgICBzZWxmLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlJpbmd0b25lIFBsYXliYWNrIEZhaWx1cmUiLCBjb250YWN0KTsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIlJpbmd0b25lIFBsYXliYWNrIEZhaWx1cmUiKS53aXRoT2JqZWN0KGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfSk7CiAgICAgIHNlbGYuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiUmluZ3RvbmUgU3RhcnQiLCBjb250YWN0KTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJSaW5ndG9uZSBTdGFydCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5fc3RvcFJpbmd0b25lID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIGlmICh0aGlzLl9hdWRpbykgewogICAgICB0aGlzLl9hdWRpby5wYXVzZSgpOwogICAgICB0aGlzLl9hdWRpby5jdXJyZW50VGltZSA9IDA7CiAgICAgIHRoaXMuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiUmluZ3RvbmUgU3RvcCIsIGNvbnRhY3QpOwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlJpbmd0b25lIFN0b3AiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH07CgogIC8qKgogICAqIFN0b3AgcmluZ3RvbmUuCiAgICovCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5zdG9wUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLl9zdG9wUmluZ3RvbmUoKTsKICB9OwoKICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLl9yaW5ndG9uZVNldHVwID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuUklOR1RPTkUsIGZ1bmN0aW9uICgpIHsKICAgICAgc2VsZi5fc3RhcnRSaW5ndG9uZShjb250YWN0KTsKICAgICAgc2VsZi5fcHJldkNvbnRhY3RJZCA9IGNvbnRhY3QuZ2V0Q29udGFjdElkKCk7CgogICAgICBjb250YWN0Lm9uQ29ubmVjdGVkKGxpbHkuaGl0Y2goc2VsZiwgc2VsZi5fc3RvcFJpbmd0b25lKSk7CiAgICAgIGNvbnRhY3Qub25BY2NlcHRlZChsaWx5LmhpdGNoKHNlbGYsIHNlbGYuX3N0b3BSaW5ndG9uZSkpOwogICAgICBjb250YWN0Lm9uRW5kZWQobGlseS5oaXRjaChzZWxmLCBzZWxmLl9zdG9wUmluZ3RvbmUpKTsKICAgICAgLy8gSnVzdCB0byBtYWtlIHN1cmUgdG8gc3RvcCB0aGUgcmluZ3RvbmUgaW4gY2FzZSBvZiB0aGUgZmFpbHVyZXMgb2Ygc3BlY2lmaWMgY2FsbGJhY2tzKG9uQWNjZXB0ZWQsb25Db25uZWN0ZWQpOwogICAgICBjb250YWN0Lm9uUmVmcmVzaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgIGlmIChjb250YWN0LmdldFN0YXR1cygpLnR5cGUgIT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuQ09OTkVDVElORyAmJgogICAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlICE9PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLklOQ09NSU5HKSB7CiAgICAgICAgICBzZWxmLl9zdG9wUmluZ3RvbmUoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5fcHVibGlzaFRlbGVtZXRyeUV2ZW50ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgY29udGFjdCkgewogICAgaWYgKGNvbnRhY3QgJiYgY29udGFjdC5nZXRDb250YWN0SWQoKSkgewogICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgIG5hbWU6IGV2ZW50TmFtZSwKICAgICAgICBjb250YWN0SWQ6IGNvbnRhY3QuZ2V0Q29udGFjdElkKCkKICAgICAgfSk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQ2hhbmdlIHRoZSBhdWRpbyBkZXZpY2UgdXNlZCB0byBwbGF5IHJpbmd0b25lLgogICAqIElmIGF1ZGlvIGVsZW1lbnQgaXMgbm90IGZ1bGx5IGluaXRpYWxpemVkLCB0aGUgQVBJIHdpbGwgd2FpdCBfYXVkaW9QbGF5YWJsZVByb21pc2UgZm9yIDMgc2Vjb25kcyBhbmQgZmFpbCBvbiB0aW1lb3V0LgogICAqIFRoaXMgQVBJIGlzIHN1cHBvcnRlZCBvbmx5IGJ5IGJyb3dzZXJzIHRoYXQgaW1wbGVtZW50ZWQgRVM2IFByb21pc2UgYW5kIGh0dHA6Ly93d3cudzMub3JnL1RSL2F1ZGlvLW91dHB1dC8KICAgKiBSZXR1cm4gYSBQcm9taXNlIHRoYXQgaW5kaWNhdGVzIHRoZSByZXN1bHQgb2YgY2hhbmdpbmcgb3V0cHV0IGRldmljZS4KICAgKi8KICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLnNldE91dHB1dERldmljZSA9IGZ1bmN0aW9uIChkZXZpY2VJZCkgewogICAgaWYgKHRoaXMuX3BsYXlhYmxlQXVkaW9Qcm9taXNlKSB7CiAgICAgIHZhciBwbGF5YWJsZUF1ZGlvV2l0aFRpbWVvdXQgPSBQcm9taXNlLnJhY2UoWwogICAgICAgIHRoaXMuX3BsYXlhYmxlQXVkaW9Qcm9taXNlLAogICAgICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgcmVqZWN0KCJUaW1lZCBvdXQgd2FpdGluZyBmb3IgcGxheWFibGUgYXVkaW8iKTsgfSwgMzAwMC8qbXMqLyk7CiAgICAgICAgfSkKICAgICAgXSk7CiAgICAgIHJldHVybiBwbGF5YWJsZUF1ZGlvV2l0aFRpbWVvdXQudGhlbihmdW5jdGlvbiAoYXVkaW8pIHsKICAgICAgICBpZiAoYXVkaW8pIHsKICAgICAgICAgIGlmIChhdWRpby5zZXRTaW5rSWQpIHsKICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShhdWRpby5zZXRTaW5rSWQoZGV2aWNlSWQpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgiTm90IHN1cHBvcnRlZCIpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoIk5vIGF1ZGlvIGZvdW5kIik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBpZiAoZ2xvYmFsLlByb21pc2UpIHsKICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJOb3QgZWxpZ2libGUgcmluZ3RvbmUgb3duZXIiKTsKICAgIH0KICB9OwoKICB2YXIgVm9pY2VSaW5ndG9uZUVuZ2luZSA9IGZ1bmN0aW9uIChyaW5ndG9uZUNvbmZpZykgewogICAgUmluZ3RvbmVFbmdpbmVCYXNlLmNhbGwodGhpcywgcmluZ3RvbmVDb25maWcpOwogIH07CiAgVm9pY2VSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUpOwogIFZvaWNlUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVm9pY2VSaW5ndG9uZUVuZ2luZTsKCiAgVm9pY2VSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdmFyIG9uQ29udGFjdENvbm5lY3QgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBpZiAoY29udGFjdC5nZXRUeXBlKCkgPT09IGxpbHkuQ29udGFjdFR5cGUuVk9JQ0UgJiYKICAgICAgICBjb250YWN0LmlzU29mdHBob25lQ2FsbCgpICYmIGNvbnRhY3QuaXNJbmJvdW5kKCkpIHsKICAgICAgICBzZWxmLl9yaW5ndG9uZVNldHVwKGNvbnRhY3QpOwogICAgICAgIHNlbGYuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiUmluZ3RvbmUgQ29ubmVjdGluZyIsIGNvbnRhY3QpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiUmluZ3RvbmUgQ29ubmVjdGluZyIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH07CgogICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGNvbnRhY3Qub25Db25uZWN0aW5nKG9uQ29udGFjdENvbm5lY3QpOwogICAgfSk7CgogICAgbmV3IGNvbm5lY3QuQWdlbnQoKS5nZXRDb250YWN0cygpLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgaWYgKGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5DT05ORUNUSU5HKSB7CiAgICAgICAgb25Db250YWN0Q29ubmVjdChjb250YWN0KTsKICAgICAgfQogICAgfSk7CiAgfTsKCgogIHZhciBDaGF0UmluZ3RvbmVFbmdpbmUgPSBmdW5jdGlvbiAocmluZ3RvbmVDb25maWcpIHsKICAgIFJpbmd0b25lRW5naW5lQmFzZS5jYWxsKHRoaXMsIHJpbmd0b25lQ29uZmlnKTsKICB9OwogIENoYXRSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUpOwogIENoYXRSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBDaGF0UmluZ3RvbmVFbmdpbmU7CgogIENoYXRSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdmFyIG9uQ29udGFjdENvbm5lY3QgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBpZiAoY29udGFjdC5nZXRUeXBlKCkgPT09IGxpbHkuQ29udGFjdFR5cGUuQ0hBVCAmJiBjb250YWN0LmlzSW5ib3VuZCgpKSB7CiAgICAgICAgc2VsZi5fcmluZ3RvbmVTZXR1cChjb250YWN0KTsKICAgICAgICBzZWxmLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgUmluZ3RvbmUgQ29ubmVjdGluZyIsIGNvbnRhY3QpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQ2hhdCBSaW5ndG9uZSBDb25uZWN0aW5nIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfTsKCiAgICBjb25uZWN0LmNvbnRhY3QoZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgY29udGFjdC5vbkNvbm5lY3Rpbmcob25Db250YWN0Q29ubmVjdCk7CiAgICB9KTsKICB9OwoKICB2YXIgVGFza1Jpbmd0b25lRW5naW5lID0gZnVuY3Rpb24gKHJpbmd0b25lQ29uZmlnKSB7CiAgICBSaW5ndG9uZUVuZ2luZUJhc2UuY2FsbCh0aGlzLCByaW5ndG9uZUNvbmZpZyk7CiAgfTsKICBUYXNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlKTsKICBUYXNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVGFza1Jpbmd0b25lRW5naW5lOwoKICBUYXNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLl9kcml2ZVJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHZhciBvbkNvbnRhY3RDb25uZWN0ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgaWYgKGNvbnRhY3QuZ2V0VHlwZSgpID09PSBsaWx5LkNvbnRhY3RUeXBlLlRBU0sgJiYgY29udGFjdC5pc0luYm91bmQoKSkgewogICAgICAgIHNlbGYuX3Jpbmd0b25lU2V0dXAoY29udGFjdCk7CiAgICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJUYXNrIFJpbmd0b25lIENvbm5lY3RpbmciLCBjb250YWN0KTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlRhc2sgUmluZ3RvbmUgQ29ubmVjdGluZyIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH07CgogICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGNvbnRhY3Qub25Db25uZWN0aW5nKG9uQ29udGFjdENvbm5lY3QpOwogICAgfSk7CiAgfTsKCgogIHZhciBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUgPSBmdW5jdGlvbiAocmluZ3RvbmVDb25maWcpIHsKICAgIFJpbmd0b25lRW5naW5lQmFzZS5jYWxsKHRoaXMsIHJpbmd0b25lQ29uZmlnKTsKICB9OwogIFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUpOwogIFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmU7CgogIFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGNvbnRhY3Qub25JbmNvbWluZyhmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKGNvbnRhY3QuZ2V0VHlwZSgpID09PSBsaWx5LkNvbnRhY3RUeXBlLlFVRVVFX0NBTExCQUNLKSB7CiAgICAgICAgICBzZWxmLl9yaW5ndG9uZVNldHVwKGNvbnRhY3QpOwogICAgICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDYWxsYmFjayBSaW5ndG9uZSBDb25uZWN0aW5nIiwgY29udGFjdCk7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkNhbGxiYWNrIFJpbmd0b25lIENvbm5lY3RpbmciKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICAvKiBleHBvcnQgY29ubmVjdC5SaW5ndG9uZUVuZ2luZSAqLwogIGNvbm5lY3QuVm9pY2VSaW5ndG9uZUVuZ2luZSA9IFZvaWNlUmluZ3RvbmVFbmdpbmU7CiAgY29ubmVjdC5DaGF0UmluZ3RvbmVFbmdpbmUgPSBDaGF0UmluZ3RvbmVFbmdpbmU7CiAgY29ubmVjdC5UYXNrUmluZ3RvbmVFbmdpbmUgPSBUYXNrUmluZ3RvbmVFbmdpbmU7CiAgY29ubmVjdC5RdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUgPSBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmU7Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA2NDI6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwogIGdsb2JhbC5jY3BWZXJzaW9uID0gIlYyIjsKCiAgdmFyIFJUUEpvYkludGVydmFsTXMgPSAxMDAwOwogIHZhciBzdGF0c1JlcG9ydGluZ0pvYkludGVydmFsTXMgPSAzMDAwMDsKICB2YXIgY29ubmVjdGl2aXR5Q2hlY2tKb2JJbnRlcnZhbE1zID0gMzAwMDA7CiAgdmFyIGNvbm5lY3Rpdml0eUNoZWNrSm9iUGF1c2VkID0gZmFsc2U7CiAgdmFyIHN0cmVhbUJ1ZmZlclNpemUgPSA1MDA7CiAgdmFyIENhbGxUeXBlTWFwID0ge307CiAgQ2FsbFR5cGVNYXBbY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZS5BVURJT19PTkxZXSA9ICdBdWRpbyc7CiAgQ2FsbFR5cGVNYXBbY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZS5WSURFT19PTkxZXSA9ICdWaWRlbyc7CiAgQ2FsbFR5cGVNYXBbY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZS5BVURJT19WSURFT10gPSAnQXVkaW9WaWRlbyc7CiAgQ2FsbFR5cGVNYXBbY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZS5OT05FXSA9ICdOb25lJzsKICB2YXIgQVVESU9fSU5QVVQgPSAnYXVkaW9faW5wdXQnOwogIHZhciBBVURJT19PVVRQVVQgPSAnYXVkaW9fb3V0cHV0JzsKCiAgdmFyIE1lZGlhVHlwZU1hcCA9IHt9OwogIE1lZGlhVHlwZU1hcFtjb25uZWN0LkNvbnRhY3RUeXBlLlZPSUNFXSA9ICJWb2ljZSI7CiAgdmFyIFVOS05PV05fTUVESUFfVFlQRSA9ICJVbmtub3duIjsKCiAgdmFyIHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlciA9IFtdOwogIHZhciBhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHMgPSB7fTsKICB2YXIgYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHMgPSB7fTsKICB2YXIgcnRwU3RhdHNKb2IgPSBudWxsOwogIHZhciByZXBvcnRTdGF0c0pvYiA9IG51bGw7CiAgLy9Mb2dnZXIgc3BlY2lmaWMgdG8gc29mdHBob25lLgogIHZhciBsb2dnZXIgPSBudWxsOwogIHZhciBTb2Z0cGhvbmVFcnJvclR5cGVzID0gY29ubmVjdC5Tb2Z0cGhvbmVFcnJvclR5cGVzOwogIHZhciBIQU5HX1VQX01VTFRJUExFX1NFU1NJT05TX0VWRU5UID0gIk11bHRpU2Vzc2lvbkhhbmdVcCI7CiAgdmFyIE1VTFRJUExFX1NFU1NJT05TX0VWRU5UID0gIk11bHRpU2Vzc2lvbnMiOwogIHZhciBtZWRpYUVuZHBvaW50ID0gbnVsbDsKCiAgdmFyIGxvY2FsTWVkaWFTdHJlYW0gPSB7fTsKCiAgdmFyIHNvZnRwaG9uZUNsaWVudElkID0gY29ubmVjdC5yYW5kb21JZCgpOwoKICB2YXIgcmVxdWVzdEljZUFjY2VzcyA9IGZ1bmN0aW9uICh0cmFuc3BvcnQpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKS5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfVFJBTlNQT1JULCB0cmFuc3BvcnQsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgcmVzb2x2ZShkYXRhLnNvZnRwaG9uZVRyYW5zcG9ydC5zb2Z0cGhvbmVNZWRpYUNvbm5lY3Rpb25zKTsKICAgICAgICAgIHRyeXsKICAgICAgICAgICAgbWVkaWFFbmRwb2ludCA9IGRhdGEuc29mdHBob25lVHJhbnNwb3J0LnNvZnRwaG9uZU1lZGlhQ29ubmVjdGlvbnNbMF0udXJsc1swXTsKICAgICAgICAgIH1jYXRjaChlKXsKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJGYWlsZWQgaW4gcmV0cmlldmluZyBtZWRpYUVuZHBvaW50IiArIGUpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgaWYgKHJlYXNvbi5tZXNzYWdlICYmIHJlYXNvbi5tZXNzYWdlLmluY2x1ZGVzKCJTb2Z0cGhvbmVDb25uZWN0aW9uTGltaXRCcmVhY2hlZEV4Y2VwdGlvbiIpKSB7CiAgICAgICAgICAgIHB1Ymxpc2hFcnJvcigibXVsdGlwbGVfc29mdHBob25lX2FjdGl2ZV9zZXNzaW9ucyIsICJOdW1iZXIgb2YgYWN0aXZlIHNlc3Npb25zIGFyZSBtb3JlIHRoZW4gYWxsb3dlZCBsaW1pdC4iLCAiIik7CiAgICAgICAgICB9CiAgICAgICAgICByZWplY3QoRXJyb3IoInJlcXVlc3RJY2VBY2Nlc3MgZmFpbGVkIikpOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJlamVjdChFcnJvcigiQXV0aGVudGljYXRpb24gZmFpbGVkIHdoaWxlIHJlcXVlc3RJY2VBY2Nlc3MiKSk7CiAgICAgICAgfSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJlamVjdChFcnJvcigiQWNjZXNzIERlbmllZCB3aGlsZSByZXF1ZXN0SWNlQWNjZXNzIikpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICB2YXIgU29mdHBob25lTWFuYWdlciA9IGZ1bmN0aW9uIChzb2Z0cGhvbmVQYXJhbXMpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGxvZ2dlciA9IG5ldyBTb2Z0cGhvbmVMb2dnZXIoY29ubmVjdC5nZXRMb2coKSk7CiAgICBsb2dnZXIuaW5mbygiW1NvZnRwaG9uZSBNYW5hZ2VyXSBzb2Z0cGhvbmUgbWFuYWdlciBpbml0aWFsaXphdGlvbiBoYXMgYmVndW4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgdmFyIHJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeTsKICAgIGlmIChjb25uZWN0LlJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeSkgewogICAgICBydGNQZWVyQ29ubmVjdGlvbkZhY3RvcnkgPSBuZXcgY29ubmVjdC5SdGNQZWVyQ29ubmVjdGlvbkZhY3RvcnkobG9nZ2VyLAogICAgICAgIGNvbm5lY3QuY29yZS5nZXRXZWJTb2NrZXRNYW5hZ2VyKCksCiAgICAgICAgc29mdHBob25lQ2xpZW50SWQsCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCByZXF1ZXN0SWNlQWNjZXNzLCB7CiAgICAgICAgICB0cmFuc3BvcnRUeXBlOiAic29mdHBob25lIiwKICAgICAgICAgIHNvZnRwaG9uZUNsaWVudElkOiBzb2Z0cGhvbmVDbGllbnRJZAogICAgICAgIH0pLAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgcHVibGlzaEVycm9yKSk7CiAgICB9CiAgICBpZiAoIWlzQnJvd3NlclNvZnRQaG9uZVN1cHBvcnRlZCgpKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLlVOU1VQUE9SVEVEX0JST1dTRVIsCiAgICAgICAgIkNvbm5lY3QgZG9lcyBub3Qgc3VwcG9ydCB0aGlzIGJyb3dzZXIuIFNvbWUgZnVuY3Rpb25hbGl0eSBtYXkgbm90IHdvcmsuICIsCiAgICAgICAgIiIpOwogICAgfQogICAgdmFyIGd1bVByb21pc2UgPSBmZXRjaFVzZXJNZWRpYSh7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChzdHJlYW0pIHsKICAgICAgICBjb25uZWN0LmNvcmUuc2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtKHN0cmVhbSk7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDb25uZWN0aXZpdHlDaGVja1Jlc3VsdCIsIG51bGwsIAogICAgICAgIHsKICAgICAgICAgIGNvbm5lY3Rpdml0eUNoZWNrVHlwZTogIk1pY3JvcGhvbmVQZXJtaXNzaW9uIiwKICAgICAgICAgIHN0YXR1czogImdyYW50ZWQiCiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICBwdWJsaXNoRXJyb3IoZXJyLCAiWW91ciBtaWNyb3Bob25lIGlzIG5vdCBlbmFibGVkIGluIHlvdXIgYnJvd3Nlci4gIiwgIiIpOwogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ29ubmVjdGl2aXR5Q2hlY2tSZXN1bHQiLCBudWxsLCAKICAgICAgICB7CiAgICAgICAgICBjb25uZWN0aXZpdHlDaGVja1R5cGU6ICJNaWNyb3Bob25lUGVybWlzc2lvbiIsCiAgICAgICAgICBzdGF0dXM6ICJkZW5pZWQiCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgCiAgICBoYW5kbGVTb2Z0UGhvbmVNdXRlVG9nZ2xlKCk7CiAgICBoYW5kbGVTcGVha2VyRGV2aWNlQ2hhbmdlKCk7CiAgICBoYW5kbGVNaWNyb3Bob25lRGV2aWNlQ2hhbmdlKCk7CiAgICBtb25pdG9yTWljcm9waG9uZVBlcm1pc3Npb24oKTsKICAgIG1vbml0b3JTb2Z0cGhvbmVDb25uZWN0aXZpdHkoKTsKCiAgICB0aGlzLnJpbmd0b25lRW5naW5lID0gbnVsbDsKICAgIHZhciBydGNTZXNzaW9ucyA9IHt9OwogICAgLy8gVHJhY2tzIHRoZSBhZ2VudCBjb25uZWN0aW9uIElELCBzbyB0aGF0IGlmIHRoZSBzYW1lIGNvbnRhY3QgZ2V0cyByZS1yb3V0ZWQgdG8gdGhlIHNhbWUgYWdlbnQsIGl0J2xsIHN0aWxsIHNldCB1cCBzb2Z0cGhvbmUKICAgIHZhciBjYWxsc0RldGVjdGVkID0ge307CiAgICB0aGlzLm9uSW5pdENvbnRhY3RTdWIgPSB7fTsKICAgIHRoaXMub25Jbml0Q29udGFjdFN1Yi51bnN1YnNjcmliZSA9IGZ1bmN0aW9uKCkge307CgogICAgLy8gdmFyaWFibGVzIGZvciBmaXJlZm94IG11bHRpdGFiCiAgICB2YXIgaXNTZXNzaW9uUGVuZGluZyA9IGZhbHNlOwogICAgdmFyIHBlbmRpbmdDb250YWN0ID0gbnVsbDsKICAgIHZhciBwZW5kaW5nQWdlbnRDb25uZWN0aW9uSWQgPSBudWxsOwogICAgdmFyIHBvc3Rwb25lU3RhcnRpbmdTZXNzaW9uID0gZnVuY3Rpb24gKGNvbnRhY3QsIGFnZW50Q29ubmVjdGlvbklkKSB7CiAgICAgIGlzU2Vzc2lvblBlbmRpbmcgPSB0cnVlOwogICAgICBwZW5kaW5nQ29udGFjdCA9IGNvbnRhY3Q7CiAgICAgIHBlbmRpbmdBZ2VudENvbm5lY3Rpb25JZCA9IGFnZW50Q29ubmVjdGlvbklkOwogICAgfQogICAgdmFyIGNhbmNlbFBlbmRpbmdTZXNzaW9uID0gZnVuY3Rpb24gKCkgewogICAgICBpc1Nlc3Npb25QZW5kaW5nID0gZmFsc2U7CiAgICAgIHBlbmRpbmdDb250YWN0ID0gbnVsbDsKICAgICAgcGVuZGluZ0FnZW50Q29ubmVjdGlvbklkID0gbnVsbDsKICAgIH0KCiAgICAvLyBoZWxwZXIgbWV0aG9kIHRvIHByb3ZpZGUgYWNjZXNzIHRvIHJ0YyBzZXNzaW9ucwogICAgdGhpcy5nZXRTZXNzaW9uID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25JZCkgewogICAgICByZXR1cm4gcnRjU2Vzc2lvbnNbY29ubmVjdGlvbklkXTsKICAgIH0KCiAgICB0aGlzLnJlcGxhY2VMb2NhbE1lZGlhVHJhY2sgPSBmdW5jdGlvbihjb25uZWN0aW9uSWQsIHRyYWNrKSB7CiAgICAgIHZhciBzdHJlYW0gPSBsb2NhbE1lZGlhU3RyZWFtW2Nvbm5lY3Rpb25JZF0uc3RyZWFtOwogICAgICBpZihzdHJlYW0pewogICAgICAgIHZhciBvbGRUcmFjayA9IHN0cmVhbS5nZXRBdWRpb1RyYWNrcygpWzBdOwogICAgICAgIHRyYWNrLmVuYWJsZWQgPSBvbGRUcmFjay5lbmFibGVkOwogICAgICAgIG9sZFRyYWNrLmVuYWJsZWQgPSBmYWxzZTsKICAgICAgICBzdHJlYW0ucmVtb3ZlVHJhY2sob2xkVHJhY2spOwogICAgICAgIHN0cmVhbS5hZGRUcmFjayh0cmFjayk7CiAgICAgIH0KICAgIH07CgogICAgdmFyIGlzQ29udGFjdFRlcm1pbmF0ZWQgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICByZXR1cm4gY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkVOREVEIHx8CiAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkVSUk9SIHx8CiAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLk1JU1NFRDsKICAgIH07CgogICAgdmFyIGRlc3Ryb3lTZXNzaW9uID0gZnVuY3Rpb24gKGFnZW50Q29ubmVjdGlvbklkKSB7CiAgICAgIGlmIChydGNTZXNzaW9ucy5oYXNPd25Qcm9wZXJ0eShhZ2VudENvbm5lY3Rpb25JZCkpIHsKICAgICAgICB2YXIgc2Vzc2lvbiA9IHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICAvLyBDdXJyZW50bHkgdGhlIGFzc3VtcHRpb24gaXMgaXQgd2lsbCB0aHJvdyBhbiBleGNlcHRpb24gb25seSBhbmQgaWYgb25seSBpdCBhbHJlYWR5IGhhcyBiZWVuIGh1bmcgdXAuCiAgICAgICAgLy8gVE9ETzogVXBkYXRlIG9uY2UgdGhlIGhhbmd1cCBBUEkgZG9lcyBub3QgdGhyb3cgZXhjZXB0aW9ucwogICAgICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIGRlbGV0ZSBydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgICBkZWxldGUgY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgICBzZXNzaW9uLmhhbmd1cCgpOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgIGxpbHkuZ2V0TG9nKCkud2FybigiQ2xlYW4gdXAgdGhlIHNlc3Npb24gbG9jYWxseSAiICsgYWdlbnRDb25uZWN0aW9uSWQsIGVyci5tZXNzYWdlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwoKICAgIC8vIFdoZW4gbXVsdGlwbGUgUlRDIHNlc3Npb25zIGRldGVjdGVkLCBpZ25vcmUgdGhlIG5ldyBjYWxsIGFuZCBoYW5nIHVwIHRoZSBwcmV2aW91cyBzZXNzaW9ucy4KICAgIC8vIFRPRE86IFVwZGF0ZSB3aGVuIGNvbm5lY3QtcnRjIGV4cG9zZXMgYW4gQVBJIHRvIGRldGVjdCBzZXNzaW9uIHN0YXR1cy4KICAgIHZhciBzYW5pdHlDaGVja0FjdGl2ZVNlc3Npb25zID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb25zKSB7CiAgICAgIGlmIChPYmplY3Qua2V5cyhydGNTZXNzaW9ucykubGVuZ3RoID4gMCkgewogICAgICAgIC8vIEVycm9yISBvdXIgc3RhdGUgZG9lc24ndCBtYXRjaCwgdGVhciBpdCBhbGwgZG93bi4KICAgICAgICBmb3IgKHZhciBjb25uZWN0aW9uSWQgaW4gcnRjU2Vzc2lvbnMpIHsKICAgICAgICAgIGlmIChydGNTZXNzaW9ucy5oYXNPd25Qcm9wZXJ0eShjb25uZWN0aW9uSWQpKSB7CiAgICAgICAgICAgIC8vIExvZyBhbiBlcnJvciBmb3IgdGhlIHNlc3Npb24gd2UgYXJlIGFib3V0IHRvIGVuZC4KICAgICAgICAgICAgcHVibGlzaE11bHRpcGxlU2Vzc2lvbnNFdmVudChIQU5HX1VQX01VTFRJUExFX1NFU1NJT05TX0VWRU5ULCBydGNTZXNzaW9uc1tjb25uZWN0aW9uSWRdLmNhbGxJZCwgY29ubmVjdGlvbklkKTsKICAgICAgICAgICAgZGVzdHJveVNlc3Npb24oY29ubmVjdGlvbklkKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJkdXBsaWNhdGUgc2Vzc2lvbiBkZXRlY3RlZCwgcmVmdXNpbmcgdG8gc2V0dXAgbmV3IGNvbm5lY3Rpb24iKTsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLnN0YXJ0U2Vzc2lvbiA9IGZ1bmN0aW9uIChfY29udGFjdCwgX2FnZW50Q29ubmVjdGlvbklkKSB7CiAgICAgIHZhciBjb250YWN0ID0gaXNTZXNzaW9uUGVuZGluZyA/IHBlbmRpbmdDb250YWN0IDogX2NvbnRhY3Q7CiAgICAgIHZhciBhZ2VudENvbm5lY3Rpb25JZCA9IGlzU2Vzc2lvblBlbmRpbmcgPyBwZW5kaW5nQWdlbnRDb25uZWN0aW9uSWQgOiBfYWdlbnRDb25uZWN0aW9uSWQ7CiAgICAgIGlmICghY29udGFjdCB8fCAhYWdlbnRDb25uZWN0aW9uSWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY2FuY2VsUGVuZGluZ1Nlc3Npb24oKTsKICAgICAgCiAgICAgIC8vIFNldCB0byB0cnVlLCB0aGlzIHdpbGwgYmxvY2sgc3Vic2VxdWVudCBpbnZva2VzIGZyb20gZW50ZXJpbmcuCiAgICAgIGNhbGxzRGV0ZWN0ZWRbYWdlbnRDb25uZWN0aW9uSWRdID0gdHJ1ZTsKICAgICAgbG9nZ2VyLmluZm8oIlNvZnRwaG9uZSBjYWxsIGRldGVjdGVkOiIsICJjb250YWN0SWQgIiArIGNvbnRhY3QuZ2V0Q29udGFjdElkKCksICJhZ2VudCBjb25uZWN0aW9uSWQgIiArIGFnZW50Q29ubmVjdGlvbklkKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgLy8gRW5zdXJlIG91ciBzZXNzaW9uIHN0YXRlIG1hdGNoZXMgb3VyIGNvbnRhY3Qgc3RhdGUgdG8gcHJldmVudCBpc3N1ZXMgc2hvdWxkIHdlIGxvc2UgdHJhY2sgb2YgYSBjb250YWN0LgogICAgICBzYW5pdHlDaGVja0FjdGl2ZVNlc3Npb25zKHJ0Y1Nlc3Npb25zKTsKCiAgICAgIGlmIChjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuQ09OTkVDVElORykgewogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiU29mdHBob25lIENvbm5lY3RpbmciLCBjb250YWN0LmdldENvbnRhY3RJZCgpKTsKICAgICAgfQoKICAgICAgaW5pdGlhbGl6ZVBhcmFtcygpOwogICAgICB2YXIgc29mdHBob25lSW5mbyA9IGNvbnRhY3QuZ2V0QWdlbnRDb25uZWN0aW9uKCkuZ2V0U29mdHBob25lTWVkaWFJbmZvKCk7CiAgICAgIHZhciBjYWxsQ29uZmlnID0gcGFyc2VDYWxsQ29uZmlnKHNvZnRwaG9uZUluZm8uY2FsbENvbmZpZ0pzb24pOwogICAgICB2YXIgd2ViU29ja2V0UHJvdmlkZXI7CiAgICAgIGlmIChjYWxsQ29uZmlnLnVzZVdlYlNvY2tldFByb3ZpZGVyKSB7CiAgICAgICAgd2ViU29ja2V0UHJvdmlkZXIgPSBjb25uZWN0LmNvcmUuZ2V0V2ViU29ja2V0TWFuYWdlcigpOwogICAgICB9CiAgICAgIHZhciBzZXNzaW9uID0gbmV3IGNvbm5lY3QuUlRDU2Vzc2lvbigKICAgICAgICBjYWxsQ29uZmlnLnNpZ25hbGluZ0VuZHBvaW50LAogICAgICAgIGNhbGxDb25maWcuaWNlU2VydmVycywKICAgICAgICBzb2Z0cGhvbmVJbmZvLmNhbGxDb250ZXh0VG9rZW4sCiAgICAgICAgbG9nZ2VyLAogICAgICAgIGNvbnRhY3QuZ2V0Q29udGFjdElkKCksCiAgICAgICAgYWdlbnRDb25uZWN0aW9uSWQsCiAgICAgICAgd2ViU29ja2V0UHJvdmlkZXIpOwoKICAgICAgcnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdID0gc2Vzc2lvbjsKCiAgICAgIGlmIChjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtKCkpIHsKICAgICAgICBzZXNzaW9uLm1lZGlhU3RyZWFtID0gY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSgpOwogICAgICB9CgogICAgICAvLyBDdXN0b20gRXZlbnQgdG8gaW5kaWNhdGUgdGhlIHNlc3Npb24gaW5pdCBvcGVyYXRpb25zCiAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgICBldmVudDogY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlNFU1NJT05fSU5JVCwKICAgICAgICBkYXRhOiB7CiAgICAgICAgICBjb25uZWN0aW9uSWQ6IGFnZW50Q29ubmVjdGlvbklkCiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHNlc3Npb24ub25TZXNzaW9uRmFpbGVkID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24sIHJlYXNvbikgewogICAgICAgIGRlbGV0ZSBydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgZGVsZXRlIGNhbGxzRGV0ZWN0ZWRbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgIHB1Ymxpc2hTb2Z0cGhvbmVGYWlsdXJlTG9ncyhydGNTZXNzaW9uLCByZWFzb24pOwogICAgICAgIHB1Ymxpc2hTZXNzaW9uRmFpbHVyZVRlbGVtZXRyeUV2ZW50KGNvbnRhY3QuZ2V0Q29udGFjdElkKCksIHJlYXNvbik7CiAgICAgICAgc3RvcEpvYnNBbmRSZXBvcnQoY29udGFjdCwgcnRjU2Vzc2lvbi5zZXNzaW9uUmVwb3J0KTsKICAgICAgICBjb25uZWN0aXZpdHlDaGVja0pvYlBhdXNlZCA9IGZhbHNlOwogICAgICB9OwogICAgICBzZXNzaW9uLm9uU2Vzc2lvbkNvbm5lY3RlZCA9IGZ1bmN0aW9uIChydGNTZXNzaW9uKSB7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJTb2Z0cGhvbmUgU2Vzc2lvbiBDb25uZWN0ZWQiLCBjb250YWN0LmdldENvbnRhY3RJZCgpKTsKICAgICAgICAvLyBCZWNvbWUgbWFzdGVyIHRvIHNlbmQgbG9ncywgc2luY2Ugd2UgbmVlZCBsb2dzIGZyb20gc29mdHBob25lIHRhYi4KICAgICAgICBjb25uZWN0LmJlY29tZU1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TRU5EX0xPR1MpOwogICAgICAgIC8vc3RhcnQgc3RhdHMgY29sbGVjdGlvbiBhbmQgcmVwb3J0aW5nIGpvYnMKICAgICAgICBzdGFydFN0YXRzQ29sbGVjdGlvbkpvYihydGNTZXNzaW9uKTsKICAgICAgICBzdGFydFN0YXRzUmVwb3J0aW5nSm9iKGNvbnRhY3QpOwogICAgICAgIGZpcmVDb250YWN0QWNjZXB0ZWRFdmVudChjb250YWN0KTsKICAgICAgICBjb25uZWN0aXZpdHlDaGVja0pvYlBhdXNlZCA9IHRydWU7CiAgICAgIH07CgogICAgICBzZXNzaW9uLm9uU2Vzc2lvbkNvbXBsZXRlZCA9IGZ1bmN0aW9uIChydGNTZXNzaW9uKSB7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJTb2Z0cGhvbmUgU2Vzc2lvbiBDb21wbGV0ZWQiLCBjb250YWN0LmdldENvbnRhY3RJZCgpKTsKCiAgICAgICAgZGVsZXRlIHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICBkZWxldGUgY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgLy8gU3RvcCBhbGwgam9icyBhbmQgcGVyZm9ybSBvbmUgbGFzdCBqb2IuCiAgICAgICAgc3RvcEpvYnNBbmRSZXBvcnQoY29udGFjdCwgcnRjU2Vzc2lvbi5zZXNzaW9uUmVwb3J0KTsKCiAgICAgICAgLy8gQ2xlYW51cCB0aGUgY2FjaGVkIHN0cmVhbXMKICAgICAgICBkZWxldGVMb2NhbE1lZGlhU3RyZWFtKGFnZW50Q29ubmVjdGlvbklkKTsKICAgICAgICBjb25uZWN0aXZpdHlDaGVja0pvYlBhdXNlZCA9IGZhbHNlOwogICAgICB9OwoKICAgICAgc2Vzc2lvbi5vbkxvY2FsU3RyZWFtQWRkZWQgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbiwgc3RyZWFtKSB7CiAgICAgICAgLy8gQ2FjaGUgdGhlIHN0cmVhbXMgZm9yIG11dGUvdW5tdXRlCiAgICAgICAgbG9jYWxNZWRpYVN0cmVhbVthZ2VudENvbm5lY3Rpb25JZF0gPSB7CiAgICAgICAgICBzdHJlYW06IHN0cmVhbQogICAgICAgIH07CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuQWdlbnRFdmVudHMuTE9DQUxfTUVESUFfU1RSRUFNX0NSRUFURUQsCiAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgIGNvbm5lY3Rpb25JZDogYWdlbnRDb25uZWN0aW9uSWQKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfTsKCiAgICAgIHNlc3Npb24ucmVtb3RlQXVkaW9FbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlbW90ZS1hdWRpbycpOwogICAgICBpZiAocnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5KSB7CiAgICAgICAgc2Vzc2lvbi5jb25uZWN0KHJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeS5nZXQoY2FsbENvbmZpZy5pY2VTZXJ2ZXJzKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2Vzc2lvbi5jb25uZWN0KCk7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgb25SZWZyZXNoQ29udGFjdCA9IGZ1bmN0aW9uIChjb250YWN0LCBhZ2VudENvbm5lY3Rpb25JZCkgewogICAgICBpZiAocnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdICYmIGlzQ29udGFjdFRlcm1pbmF0ZWQoY29udGFjdCkpIHsKICAgICAgICBkZXN0cm95U2Vzc2lvbihhZ2VudENvbm5lY3Rpb25JZCk7CiAgICAgICAgY2FuY2VsUGVuZGluZ1Nlc3Npb24oKTsKICAgICAgfQogICAgICBpZiAoY29udGFjdC5pc1NvZnRwaG9uZUNhbGwoKSAmJiAhY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF0gJiYgKAogICAgICAgIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5DT05ORUNUSU5HIHx8CiAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLklOQ09NSU5HKSkgewogICAgICAgICAgaWYgKGNvbm5lY3QuaXNGaXJlZm94QnJvd3NlcigpICYmIGNvbm5lY3QuaGFzT3RoZXJDb25uZWN0ZWRDQ1BzKCkpIHsKICAgICAgICAgICAgcG9zdHBvbmVTdGFydGluZ1Nlc3Npb24oY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZi5zdGFydFNlc3Npb24oY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIHZhciBvbkluaXRDb250YWN0ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgdmFyIGFnZW50Q29ubmVjdGlvbklkID0gY29udGFjdC5nZXRBZ2VudENvbm5lY3Rpb24oKS5jb25uZWN0aW9uSWQ7CiAgICAgIGxvZ2dlci5pbmZvKCJDb250YWN0IGRldGVjdGVkOiIsICJjb250YWN0SWQgIiArIGNvbnRhY3QuZ2V0Q29udGFjdElkKCksICJhZ2VudCBjb25uZWN0aW9uSWQgIiArIGFnZW50Q29ubmVjdGlvbklkKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgaWYgKCFjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXSkgewogICAgICAgIGNvbnRhY3Qub25SZWZyZXNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIG9uUmVmcmVzaENvbnRhY3QoY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwoKICAgIHNlbGYub25Jbml0Q29udGFjdFN1YiA9IGNvbm5lY3QuY29udGFjdChvbkluaXRDb250YWN0KTsKCiAgICAvLyBDb250YWN0IGFscmVhZHkgaW4gY29ubmVjdGluZyBzdGF0ZSBzY2VuYXJpbyAtIEluIHRoaXMgY2FzZSBjb250YWN0IElOSVQgaXMgbWlzc2VkIGhlbmNlIHRoZSBPblJlZnJlc2ggY2FsbGJhY2sgaXMgbWlzc2VkLiAKICAgIG5ldyBjb25uZWN0LkFnZW50KCkuZ2V0Q29udGFjdHMoKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIHZhciBhZ2VudENvbm5lY3Rpb25JZCA9IGNvbnRhY3QuZ2V0QWdlbnRDb25uZWN0aW9uKCkuY29ubmVjdGlvbklkOwogICAgICBsb2dnZXIuaW5mbygiQ29udGFjdCBleGlzdCBpbiB0aGUgc25hcHNob3QuIFJlaW5pdGlhdGUgdGhlIENvbnRhY3QgYW5kIFJUQyBzZXNzaW9uIGNyZWF0aW9uIGZvciBjb250YWN0SWQiICsgY29udGFjdC5nZXRDb250YWN0SWQoKSwgImFnZW50IGNvbm5lY3Rpb25JZCAiICsgYWdlbnRDb25uZWN0aW9uSWQpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIG9uSW5pdENvbnRhY3QoY29udGFjdCk7CiAgICAgIG9uUmVmcmVzaENvbnRhY3QoY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpOwogICAgfSk7CiAgfTsKCiAgdmFyIGZpcmVDb250YWN0QWNjZXB0ZWRFdmVudCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICB2YXIgY29uZHVpdCA9IGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpOwogICAgdmFyIGFnZW50Q29ubmVjdGlvbiA9IGNvbnRhY3QuZ2V0QWdlbnRDb25uZWN0aW9uKCk7CiAgICBpZiAoIWFnZW50Q29ubmVjdGlvbikgewogICAgICBsb2dnZXIuaW5mbygiTm90IGFibGUgdG8gcmV0cmlldmUgdGhlIGF1dG8tYWNjZXB0IHNldHRpbmcgZnJvbSBudWxsIEFnZW50Q29ubmVjdGlvbiwgaWdub3JpbmcgZXZlbnQgcHVibGlzaC4uIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHNvZnRwaG9uZU1lZGlhSW5mbyA9IGFnZW50Q29ubmVjdGlvbi5nZXRTb2Z0cGhvbmVNZWRpYUluZm8oKTsKICAgIGlmICghc29mdHBob25lTWVkaWFJbmZvKSB7CiAgICAgIGxvZ2dlci5pbmZvKCJOb3QgYWJsZSB0byByZXRyaWV2ZSB0aGUgYXV0by1hY2NlcHQgc2V0dGluZyBmcm9tIG51bGwgU29mdHBob25lTWVkaWFJbmZvLCBpZ25vcmluZyBldmVudCBwdWJsaXNoLi4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoc29mdHBob25lTWVkaWFJbmZvLmF1dG9BY2NlcHQgPT09IHRydWUpIHsKICAgICAgbG9nZ2VyLmluZm8oIkF1dG8tYWNjZXB0IGlzIGVuYWJsZWQsIHNlbmRpbmcgb3V0IEFjY2VwdGVkIGV2ZW50IHRvIHN0b3AgcmluZ3RvbmUuLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgIGV2ZW50OiBjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQsCiAgICAgICAgZGF0YTogbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0LmNvbnRhY3RJZCkKICAgICAgfSk7CiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgIGV2ZW50OiBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQsIGNvbnRhY3QuY29udGFjdElkKSwKICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3QuY29udGFjdElkKQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGxvZ2dlci5pbmZvKCJBdXRvLWFjY2VwdCBpcyBkaXNhYmxlZCwgcmluZ3RvbmUgd2lsbCBiZSBzdG9wcGVkIGJ5IHVzZXIgYWN0aW9uLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgLy8gQmluZCBldmVudHMgZm9yIG11dGUKICB2YXIgaGFuZGxlU29mdFBob25lTXV0ZVRvZ2dsZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuTVVURSwgbXV0ZVRvZ2dsZSk7CiAgfTsKCiAgdmFyIGhhbmRsZVNwZWFrZXJEZXZpY2VDaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9TUEVBS0VSX0RFVklDRSwgc2V0U3BlYWtlckRldmljZSk7CiAgfQoKICB2YXIgaGFuZGxlTWljcm9waG9uZURldmljZUNoYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9NSUNST1BIT05FX0RFVklDRSwgc2V0TWljcm9waG9uZURldmljZSk7CiAgfQoKICB2YXIgbW9uaXRvck1pY3JvcGhvbmVQZXJtaXNzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdHJ5IHsKICAgICAgaWYgKGNvbm5lY3QuaXNDaHJvbWVCcm93c2VyKCkgJiYgY29ubmVjdC5nZXRDaHJvbWVCcm93c2VyVmVyc2lvbigpID4gNDMpewogICAgICAgIG5hdmlnYXRvci5wZXJtaXNzaW9ucy5xdWVyeSh7bmFtZTogJ21pY3JvcGhvbmUnfSkKICAgICAgICAudGhlbihmdW5jdGlvbihwZXJtaXNzaW9uU3RhdHVzKXsKICAgICAgICAgIHBlcm1pc3Npb25TdGF0dXMub25jaGFuZ2UgPSBmdW5jdGlvbigpewogICAgICAgICAgICBsb2dnZXIuaW5mbygiTWljcm9waG9uZSBQZXJtaXNzaW9uOiAiICsgcGVybWlzc2lvblN0YXR1cy5zdGF0ZSk7CiAgICAgICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ29ubmVjdGl2aXR5Q2hlY2tSZXN1bHQiLCBudWxsLCAKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNvbm5lY3Rpdml0eUNoZWNrVHlwZTogIk1pY3JvcGhvbmVQZXJtaXNzaW9uIiwKICAgICAgICAgICAgICBzdGF0dXM6IHBlcm1pc3Npb25TdGF0dXMuc3RhdGUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHBlcm1pc3Npb25TdGF0dXMuc3RhdGUgPT09ICdkZW5pZWQnKXsKICAgICAgICAgICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5NSUNST1BIT05FX05PVF9TSEFSRUQsCiAgICAgICAgICAgICAgICAiWW91ciBtaWNyb3Bob25lIGlzIG5vdCBlbmFibGVkIGluIHlvdXIgYnJvd3Nlci4gIiwKICAgICAgICAgICAgICAgICIiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgbG9nZ2VyLmVycm9yKCJGYWlsZWQgaW4gZGV0ZWN0aW5nIG1pY3JvcGhvbmUgcGVybWlzc2lvbiBzdGF0dXM6ICIgKyBlKTsKICAgIH0KICB9CgogIHZhciBtb25pdG9yU29mdHBob25lQ29ubmVjdGl2aXR5ID0gZnVuY3Rpb24gKCkgewogICAgd2luZG93LnNldEludGVydmFsKGZ1bmN0aW9uKCl7CiAgICAgIHZhciBwcm9taXNlID0gbnVsbDsKICAgICAgaWYoIWNvbm5lY3Rpdml0eUNoZWNrSm9iUGF1c2VkICYmIG1lZGlhRW5kcG9pbnQpewogICAgICAgIHRyeXsKICAgICAgICAgIGNvbm5lY3Rpdml0eUNoZWNrSm9iUGF1c2VkID0gdHJ1ZTsKICAgICAgICAgIHByb21pc2UgPSBjb25uZWN0LmNoZWNrTWVkaWFFbmRwb2ludENvbm5lY3Rpb24obWVkaWFFbmRwb2ludCk7CiAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKGNvbm5lY3Rpdml0eUNoZWNrUmVzdWx0KSB7CiAgICAgICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ29ubmVjdGl2aXR5Q2hlY2tSZXN1bHQiLCBudWxsLCAKICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHt9LGNvbm5lY3Rpdml0eUNoZWNrUmVzdWx0LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBjb25uZWN0aXZpdHlDaGVja1R5cGU6ICJNZWRpYUVuZHBvaW50Q2hlY2siLAogICAgICAgICAgICAgICAgICBzdGF0dXM6IGNvbm5lY3Rpdml0eUNoZWNrUmVzdWx0LnN1Y2Nlc3MKICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgY29ubmVjdGl2aXR5Q2hlY2tKb2JQYXVzZWQgPSBmYWxzZTsKICAgICAgICAgIH0pOyAKICAgICAgICB9Y2F0Y2goZSl7CiAgICAgICAgICBsb2dnZXIuZXJyb3IoIkZhaWxlZCBpbiBjaGVja2luZyBtZWRpYSBlbmRwb2ludCBjb25uZWN0aW9uOiAiICsgZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LGNvbm5lY3Rpdml0eUNoZWNrSm9iSW50ZXJ2YWxNcyk7CiAgfQoKICAvLyBNYWtlIHN1cmUgb25jZSB3ZSBkaXNjb25uZWN0ZWQgd2UgZ2V0IHRoZSBtdXRlIHN0YXRlIGJhY2sgdG8gbm9ybWFsCiAgdmFyIGRlbGV0ZUxvY2FsTWVkaWFTdHJlYW0gPSBmdW5jdGlvbiAoY29ubmVjdGlvbklkKSB7CiAgICBkZWxldGUgbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdOwogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5BZ2VudEV2ZW50cy5NVVRFX1RPR0dMRSwKICAgICAgZGF0YTogeyBtdXRlZDogZmFsc2UgfQogICAgfSk7CiAgfTsKCiAgLy8gQ2hlY2sgZm9yIHRoZSBsb2NhbCBzdHJlYW1zIGlmIGV4aXN0cyAgLSAgcmV2ZXJ0IGl0CiAgLy8gQW5kIGluZm9ybSBvdGhlciBjbGllbnRzIGFib3V0IHRoZSBjaGFuZ2UgCiAgdmFyIG11dGVUb2dnbGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgdmFyIHN0YXR1czsKICAgIGlmIChjb25uZWN0LmtleXMobG9jYWxNZWRpYVN0cmVhbSkubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoZGF0YSAmJiBkYXRhLm11dGUgIT09IHVuZGVmaW5lZCkgewogICAgICBzdGF0dXMgPSBkYXRhLm11dGU7CiAgICB9CgogICAgZm9yICh2YXIgY29ubmVjdGlvbklkIGluIGxvY2FsTWVkaWFTdHJlYW0pIHsKICAgICAgaWYgKGxvY2FsTWVkaWFTdHJlYW0uaGFzT3duUHJvcGVydHkoY29ubmVjdGlvbklkKSkgewogICAgICAgIHZhciBsb2NhbE1lZGlhID0gbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLnN0cmVhbTsKICAgICAgICBpZiAobG9jYWxNZWRpYSkgewogICAgICAgICAgdmFyIGF1ZGlvVHJhY2tzID0gbG9jYWxNZWRpYS5nZXRBdWRpb1RyYWNrcygpWzBdOwogICAgICAgICAgaWYgKHN0YXR1cyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGF1ZGlvVHJhY2tzLmVuYWJsZWQgPSAhc3RhdHVzOwogICAgICAgICAgICBsb2NhbE1lZGlhU3RyZWFtW2Nvbm5lY3Rpb25JZF0ubXV0ZWQgPSBzdGF0dXM7CgogICAgICAgICAgICBpZiAoc3RhdHVzKSB7CiAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkFnZW50IGhhcyBtdXRlZCB0aGUgY29udGFjdCwgY29ubmVjdGlvbklkIC0gICIgKyBjb25uZWN0aW9uSWQpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkFnZW50IGhhcyB1bm11dGVkIHRoZSBjb250YWN0LCBjb25uZWN0aW9uSWQgLSAiICsgY29ubmVjdGlvbklkKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB9CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdHVzID0gbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLm11dGVkIHx8IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQWdlbnRFdmVudHMuTVVURV9UT0dHTEUsCiAgICAgIGRhdGE6IHsgbXV0ZWQ6IHN0YXR1cyB9CiAgICB9KTsKICB9OwoKICB2YXIgc2V0U3BlYWtlckRldmljZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICBpZiAoY29ubmVjdC5rZXlzKGxvY2FsTWVkaWFTdHJlYW0pLmxlbmd0aCA9PT0gMCB8fCAhZGF0YSB8fCAhZGF0YS5kZXZpY2VJZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgZGV2aWNlSWQgPSBkYXRhLmRldmljZUlkOwogICAgdmFyIHJlbW90ZUF1ZGlvRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZW1vdGUtYXVkaW8nKTsKICAgIHRyeSB7CiAgICAgIGxvZ2dlci5pbmZvKCJUcnlpbmcgdG8gc2V0IHNwZWFrZXIgdG8gZGV2aWNlICIgKyBkZXZpY2VJZCk7CiAgICAgIGlmIChyZW1vdGVBdWRpb0VsZW1lbnQgJiYgdHlwZW9mIHJlbW90ZUF1ZGlvRWxlbWVudC5zZXRTaW5rSWQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZW1vdGVBdWRpb0VsZW1lbnQuc2V0U2lua0lkKGRldmljZUlkKTsKICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBsb2dnZXIuZXJyb3IoIkZhaWxlZCB0byBzZXQgc3BlYWtlciB0byBkZXZpY2UgIiArIGRldmljZUlkKTsKICAgIH0KCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuU1BFQUtFUl9ERVZJQ0VfQ0hBTkdFRCwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfQoKICB2YXIgc2V0TWljcm9waG9uZURldmljZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICBpZiAoY29ubmVjdC5rZXlzKGxvY2FsTWVkaWFTdHJlYW0pLmxlbmd0aCA9PT0gMCAgfHwgIWRhdGEgfHwgIWRhdGEuZGV2aWNlSWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGRldmljZUlkID0gZGF0YS5kZXZpY2VJZDsKICAgIHZhciBzb2Z0cGhvbmVNYW5hZ2VyID0gY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZU1hbmFnZXIoKTsKICAgIHRyeSB7CiAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKHsgYXVkaW86IHsgZGV2aWNlSWQ6IHsgZXhhY3Q6IGRldmljZUlkIH0gfSB9KQogICAgICAgIC50aGVuKGZ1bmN0aW9uIChuZXdNaWNyb3Bob25lU3RyZWFtKSB7CiAgICAgICAgICB2YXIgbmV3TWljcm9waG9uZVRyYWNrID0gbmV3TWljcm9waG9uZVN0cmVhbS5nZXRBdWRpb1RyYWNrcygpWzBdOwogICAgICAgICAgZm9yICh2YXIgY29ubmVjdGlvbklkIGluIGxvY2FsTWVkaWFTdHJlYW0pIHsKICAgICAgICAgICAgaWYgKGxvY2FsTWVkaWFTdHJlYW0uaGFzT3duUHJvcGVydHkoY29ubmVjdGlvbklkKSkgewogICAgICAgICAgICAgIHZhciBsb2NhbE1lZGlhID0gbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLnN0cmVhbTsKICAgICAgICAgICAgICB2YXIgc2Vzc2lvbiA9IHNvZnRwaG9uZU1hbmFnZXIuZ2V0U2Vzc2lvbihjb25uZWN0aW9uSWQpOwogICAgICAgICAgICAgIC8vUmVwbGFjZSB0aGUgYXVkaW8gdHJhY2sgaW4gdGhlIFJ0Y1BlZXJDb25uZWN0aW9uCiAgICAgICAgICAgICAgc2Vzc2lvbi5fcGMuZ2V0U2VuZGVycygpWzBdLnJlcGxhY2VUcmFjayhuZXdNaWNyb3Bob25lVHJhY2spLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgLy9SZXBsYWNlIHRoZSBhdWRpbyB0cmFjayBpbiB0aGUgbG9jYWwgbWVkaWEgc3RyZWFtIChmb3IgbXV0ZSAvIHVubXV0ZSkKICAgICAgICAgICAgICAgIHNvZnRwaG9uZU1hbmFnZXIucmVwbGFjZUxvY2FsTWVkaWFUcmFjayhjb25uZWN0aW9uSWQsIG5ld01pY3JvcGhvbmVUcmFjayk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0gY2F0Y2goZSkgewogICAgICBsb2dnZXIuZXJyb3IoIkZhaWxlZCB0byBzZXQgbWljcm9waG9uZSBkZXZpY2UgIiArIGRldmljZUlkKTsKICAgIH0KCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuTUlDUk9QSE9ORV9ERVZJQ0VfQ0hBTkdFRCwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfQoKICB2YXIgcHVibGlzaFNvZnRwaG9uZUZhaWx1cmVMb2dzID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24sIHJlYXNvbikgewogICAgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuSUNFX0NPTExFQ1RJT05fVElNRU9VVCkgewogICAgICB2YXIgZW5kUG9pbnRVcmwgPSAiXG4iOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJ0Y1Nlc3Npb24uX2ljZVNlcnZlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJ0Y1Nlc3Npb24uX2ljZVNlcnZlcnNbaV0udXJscy5sZW5ndGg7IGorKykgewogICAgICAgICAgZW5kUG9pbnRVcmwgPSBlbmRQb2ludFVybCArIHJ0Y1Nlc3Npb24uX2ljZVNlcnZlcnNbaV0udXJsc1tqXSArICJcbiI7CiAgICAgICAgfQogICAgICB9CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLklDRV9DT0xMRUNUSU9OX1RJTUVPVVQsICJJY2UgY29sbGVjdGlvbiB0aW1lZG91dC4gIiwgZW5kUG9pbnRVcmwpOwogICAgfSBlbHNlIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLlVTRVJfQlVTWSkgewogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5VU0VSX0JVU1lfRVJST1IsCiAgICAgICAgIlNvZnRwaG9uZSBjYWxsIFVzZXJCdXN5IGVycm9yLiAiLAogICAgICAgICIiKTsKICAgIH0gZWxzZSBpZiAocmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5TSUdOQUxMSU5HX0hBTkRTSEFLRV9GQUlMVVJFKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLlNJR05BTExJTkdfSEFORFNIQUtFX0ZBSUxVUkUsCiAgICAgICAgIkhhbmRzaGFraW5nIHdpdGggU2lnbmFsbGluZyBTZXJ2ZXIgIiArIHJ0Y1Nlc3Npb24uX3NpZ25hbGluZ1VyaSArICIgZmFpbGVkLiAiLAogICAgICAgIHJ0Y1Nlc3Npb24uX3NpZ25hbGluZ1VyaSk7CiAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuR1VNX1RJTUVPVVRfRkFJTFVSRSB8fCByZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLkdVTV9PVEhFUl9GQUlMVVJFKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLk1JQ1JPUEhPTkVfTk9UX1NIQVJFRCwKICAgICAgICAiWW91ciBtaWNyb3Bob25lIGlzIG5vdCBlbmFibGVkIGluIHlvdXIgYnJvd3Nlci4gIiwKICAgICAgICAiIik7CiAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuU0lHTkFMTElOR19DT05ORUNUSU9OX0ZBSUxVUkUpIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuU0lHTkFMTElOR19DT05ORUNUSU9OX0ZBSUxVUkUsCiAgICAgICAgIlVSTCAiICsgcnRjU2Vzc2lvbi5fc2lnbmFsaW5nVXJpICsgIiBjYW5ub3QgYmUgcmVhY2hlZC4gIiwKICAgICAgICBydGNTZXNzaW9uLl9zaWduYWxpbmdVcmkpOwogICAgfSBlbHNlIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLkNBTExfTk9UX0ZPVU5EKSB7CiAgICAgIC8vIE5vIG5lZWQgdG8gcHVibGlzaCBhbnkgc29mdHBob25lIGVycm9yIGZvciB0aGlzIGNhc2UuIENDUCBVWCB3aWxsIGhhbmRsZSB0aGlzIGNhc2UuCiAgICAgIGxvZ2dlci5lcnJvcigiU29mdHBob25lIGNhbGwgZmFpbGVkIGR1ZSB0byBDYWxsTm90Rm91bmRFeGNlcHRpb24uIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0gZWxzZSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLldFQlJUQ19FUlJPUiwKICAgICAgICAid2VicnRjIHN5c3RlbSBlcnJvci4gIiwKICAgICAgICAiIik7CiAgICB9CiAgfTsKCiAgLyoqIFBhcnNlIHRoZSBKU09OIGVuY29kZWQgd2ViIGNhbGwgY29uZmlnIGludG8gdGhlIGRhdGEgaXQgcmVwcmVzZW50cy4gKi8KICB2YXIgcGFyc2VDYWxsQ29uZmlnID0gZnVuY3Rpb24gKHNlcmlhbGl6ZWRDb25maWcpIHsKICAgIC8vIE91ciB1bmRlcnNjb3JlIGlzIHRvbyBvbGQgZm9yIHVuZXNjYXBlCiAgICAvLyBodHRwczovL2lzc3Vlcy5hbWF6b24uY29tL2lzc3Vlcy9DU1dGLTE0NjcKICAgIHZhciBkZWNvZGVkSlNPTiA9IHNlcmlhbGl6ZWRDb25maWcucmVwbGFjZSgvJnF1b3Q7L2csICciJyk7CiAgICByZXR1cm4gSlNPTi5wYXJzZShkZWNvZGVkSlNPTik7CiAgfTsKCiAgdmFyIGZldGNoVXNlck1lZGlhID0gZnVuY3Rpb24gKGNhbGxiYWNrc0luKSB7CiAgICB2YXIgY2FsbGJhY2tzID0gY2FsbGJhY2tzSW4gfHwge307CiAgICBjYWxsYmFja3Muc3VjY2VzcyA9IGNhbGxiYWNrcy5zdWNjZXNzIHx8IGZ1bmN0aW9uICgpIHsgfTsKICAgIGNhbGxiYWNrcy5mYWlsdXJlID0gY2FsbGJhY2tzLmZhaWx1cmUgfHwgZnVuY3Rpb24gKCkgeyB9OwoKICAgIHZhciBDT05TVFJBSU5UID0gewogICAgICBhdWRpbzogdHJ1ZQogICAgfTsKCiAgICB2YXIgcHJvbWlzZSA9IG51bGw7CgogICAgaWYgKHR5cGVvZiBQcm9taXNlICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKFNvZnRwaG9uZUVycm9yVHlwZXMuVU5TVVBQT1JURURfQlJPV1NFUik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAodHlwZW9mIG5hdmlnYXRvci5tZWRpYURldmljZXMgPT09ICJvYmplY3QiICYmIHR5cGVvZiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSA9PT0gImZ1bmN0aW9uIikgewogICAgICBwcm9taXNlID0gbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEoQ09OU1RSQUlOVCk7CgogICAgfSBlbHNlIGlmICh0eXBlb2YgbmF2aWdhdG9yLndlYmtpdEdldFVzZXJNZWRpYSA9PT0gImZ1bmN0aW9uIikgewogICAgICBwcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIG5hdmlnYXRvci53ZWJraXRHZXRVc2VyTWVkaWEoQ09OU1RSQUlOVCwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgfSk7CgogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoU29mdHBob25lRXJyb3JUeXBlcy5VTlNVUFBPUlRFRF9CUk9XU0VSKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAoc3RyZWFtKSB7CiAgICAgIHZhciBhdWRpb1RyYWNrcyA9IHN0cmVhbS5nZXRBdWRpb1RyYWNrcygpOwogICAgICBpZiAoYXVkaW9UcmFja3MgJiYgYXVkaW9UcmFja3MubGVuZ3RoID4gMCkgewogICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKHN0cmVhbSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoU29mdHBob25lRXJyb3JUeXBlcy5NSUNST1BIT05FX05PVF9TSEFSRUQpOwogICAgICB9CiAgICB9LCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKFNvZnRwaG9uZUVycm9yVHlwZXMuTUlDUk9QSE9ORV9OT1RfU0hBUkVEKTsKICAgIH0pOwogICAgcmV0dXJuIHByb21pc2U7CiAgfTsKCiAgdmFyIHB1Ymxpc2hFcnJvciA9IGZ1bmN0aW9uIChlcnJvclR5cGUsIG1lc3NhZ2UsIGVuZFBvaW50VXJsKSB7CiAgICBsb2dnZXIuZXJyb3IoIlNvZnRwaG9uZSBlcnJvciBvY2N1cnJlZCA6ICIsIGVycm9yVHlwZSwKICAgICAgbWVzc2FnZSB8fCAiIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkFnZW50RXZlbnRzLlNPRlRQSE9ORV9FUlJPUiwKICAgICAgZGF0YTogbmV3IGNvbm5lY3QuU29mdHBob25lRXJyb3IoZXJyb3JUeXBlLCBtZXNzYWdlLCBlbmRQb2ludFVybCkKICAgIH0pOwogIH07CgogIHZhciBwdWJsaXNoU2Vzc2lvbkZhaWx1cmVUZWxlbWV0cnlFdmVudCA9IGZ1bmN0aW9uIChjb250YWN0SWQsIHJlYXNvbikgewogICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJTb2Z0cGhvbmUgU2Vzc2lvbiBGYWlsZWQiLCBjb250YWN0SWQsIHsKICAgICAgZmFpbGVkUmVhc29uOiByZWFzb24KICAgIH0pOwogIH07CgogIHZhciBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBjb250YWN0SWQsIGRhdGEpIHsKICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgIG5hbWU6IGV2ZW50TmFtZSwKICAgICAgY29udGFjdElkOiBjb250YWN0SWQsCiAgICAgIGRhdGE6IGRhdGEKICAgIH0pOwogIH07CgogIC8vIFB1Ymxpc2ggdGhlIGNvbnRhY3QgYW5kIGFnZW50IGluZm9ybWF0aW9uIGluIGEgbXVsdGlwbGUgc2Vzc2lvbnMgc2NlbmFyaW9zCiAgdmFyIHB1Ymxpc2hNdWx0aXBsZVNlc3Npb25zRXZlbnQgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBjb250YWN0SWQsIGFnZW50Q29ubmVjdGlvbklkKSB7CiAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoZXZlbnROYW1lLCBjb250YWN0SWQsIFt7CiAgICAgIG5hbWU6ICJBZ2VudENvbm5lY3Rpb25JZCIsCiAgICAgIHZhbHVlOiBhZ2VudENvbm5lY3Rpb25JZAogICAgfV0pOwogICAgbG9nZ2VyLmluZm8oIlB1Ymxpc2ggbXVsdGlwbGUgc2Vzc2lvbiBlcnJvciBtZXRyaWNzIiwgZXZlbnROYW1lLCAiY29udGFjdElkICIgKyBjb250YWN0SWQsICJhZ2VudCBjb25uZWN0aW9uSWQgIiArIGFnZW50Q29ubmVjdGlvbklkKQogICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICB9OwoKICB2YXIgaXNCcm93c2VyU29mdFBob25lU3VwcG9ydGVkID0gZnVuY3Rpb24gKCkgewogICAgLy8gSW4gT3BlcmEsIHRoZSB0cnVlIHZlcnNpb24gaXMgYWZ0ZXIgIk9wZXJhIiBvciBhZnRlciAiVmVyc2lvbiIKICAgIGlmIChjb25uZWN0LmlzT3BlcmFCcm93c2VyKCkgJiYgY29ubmVjdC5nZXRPcGVyYUJyb3dzZXJWZXJzaW9uKCkgPiAxNykgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8vIEluIENocm9tZSwgdGhlIHRydWUgdmVyc2lvbiBpcyBhZnRlciAiQ2hyb21lIgogICAgZWxzZSBpZiAoY29ubmVjdC5pc0Nocm9tZUJyb3dzZXIoKSAmJiBjb25uZWN0LmdldENocm9tZUJyb3dzZXJWZXJzaW9uKCkgPiAyMikgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8vIEluIEZpcmVmb3gsIHRoZSB0cnVlIHZlcnNpb24gaXMgYWZ0ZXIgIkZpcmVmb3giCiAgICBlbHNlIGlmIChjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIoKSAmJiBjb25uZWN0LmdldEZpcmVmb3hCcm93c2VyVmVyc2lvbigpID4gMjEpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfTsKCiAgdmFyIHNlbmRTb2Z0cGhvbmVNZXRyaWNzID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIHZhciBzdHJlYW1TdGF0cyA9IHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlci5zbGljZSgpOwogICAgdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyID0gW107CiAgICBpZiAoc3RyZWFtU3RhdHMubGVuZ3RoID4gMCkgewogICAgICBjb250YWN0LnNlbmRTb2Z0cGhvbmVNZXRyaWNzKHN0cmVhbVN0YXRzLCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKCkgewogICAgICAgICAgbG9nZ2VyLmluZm8oInNlbmRTb2Z0cGhvbmVNZXRyaWNzIHN1Y2Nlc3MiICsgSlNPTi5zdHJpbmdpZnkoc3RyZWFtU3RhdHMpKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBsb2dnZXIuZXJyb3IoInNlbmRTb2Z0cGhvbmVNZXRyaWNzIGZhaWxlZC4iKQogICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH07CgogIHZhciBzZW5kU29mdHBob25lUmVwb3J0ID0gZnVuY3Rpb24gKGNvbnRhY3QsIHJlcG9ydCwgdXNlckF1ZGlvU3RhdHMsIHJlbW90ZUF1ZGlvU3RhdHMpIHsKICAgIHJlcG9ydC5zdHJlYW1TdGF0cyA9IFthZGRTdHJlYW1UeXBlVG9TdGF0cyh1c2VyQXVkaW9TdGF0cywgQVVESU9fSU5QVVQpLAogICAgYWRkU3RyZWFtVHlwZVRvU3RhdHMocmVtb3RlQXVkaW9TdGF0cywgQVVESU9fT1VUUFVUKV07CiAgICB2YXIgY2FsbFJlcG9ydCA9IHsKICAgICAgY2FsbFN0YXJ0VGltZTogcmVwb3J0LnNlc3Npb25TdGFydFRpbWUsCiAgICAgIGNhbGxFbmRUaW1lOiByZXBvcnQuc2Vzc2lvbkVuZFRpbWUsCiAgICAgIGd1bVRpbWVNaWxsaXM6IHJlcG9ydC5ndW1UaW1lTWlsbGlzLAogICAgICBpbml0aWFsaXphdGlvblRpbWVNaWxsaXM6IHJlcG9ydC5pbml0aWFsaXphdGlvblRpbWVNaWxsaXMsCiAgICAgIGljZUNvbGxlY3Rpb25UaW1lTWlsbGlzOiByZXBvcnQuaWNlQ29sbGVjdGlvblRpbWVNaWxsaXMsCiAgICAgIHNpZ25hbGxpbmdDb25uZWN0VGltZU1pbGxpczogcmVwb3J0LnNpZ25hbGxpbmdDb25uZWN0VGltZU1pbGxpcywKICAgICAgaGFuZHNoYWtpbmdUaW1lTWlsbGlzOiByZXBvcnQuaGFuZHNoYWtpbmdUaW1lTWlsbGlzLAogICAgICBwcmVUYWxraW5nVGltZU1pbGxpczogcmVwb3J0LnByZVRhbGtpbmdUaW1lTWlsbGlzLAogICAgICB0YWxraW5nVGltZU1pbGxpczogcmVwb3J0LnRhbGtpbmdUaW1lTWlsbGlzLAogICAgICBjbGVhbnVwVGltZU1pbGxpczogcmVwb3J0LmNsZWFudXBUaW1lTWlsbGlzLAogICAgICBpY2VDb2xsZWN0aW9uRmFpbHVyZTogcmVwb3J0LmljZUNvbGxlY3Rpb25GYWlsdXJlLAogICAgICBzaWduYWxsaW5nQ29ubmVjdGlvbkZhaWx1cmU6IHJlcG9ydC5zaWduYWxsaW5nQ29ubmVjdGlvbkZhaWx1cmUsCiAgICAgIGhhbmRzaGFraW5nRmFpbHVyZTogcmVwb3J0LmhhbmRzaGFraW5nRmFpbHVyZSwKICAgICAgZ3VtT3RoZXJGYWlsdXJlOiByZXBvcnQuZ3VtT3RoZXJGYWlsdXJlLAogICAgICBndW1UaW1lb3V0RmFpbHVyZTogcmVwb3J0Lmd1bVRpbWVvdXRGYWlsdXJlLAogICAgICBjcmVhdGVPZmZlckZhaWx1cmU6IHJlcG9ydC5jcmVhdGVPZmZlckZhaWx1cmUsCiAgICAgIHNldExvY2FsRGVzY3JpcHRpb25GYWlsdXJlOiByZXBvcnQuc2V0TG9jYWxEZXNjcmlwdGlvbkZhaWx1cmUsCiAgICAgIHVzZXJCdXN5RmFpbHVyZTogcmVwb3J0LnVzZXJCdXN5RmFpbHVyZSwKICAgICAgaW52YWxpZFJlbW90ZVNEUEZhaWx1cmU6IHJlcG9ydC5pbnZhbGlkUmVtb3RlU0RQRmFpbHVyZSwKICAgICAgbm9SZW1vdGVJY2VDYW5kaWRhdGVGYWlsdXJlOiByZXBvcnQubm9SZW1vdGVJY2VDYW5kaWRhdGVGYWlsdXJlLAogICAgICBzZXRSZW1vdGVEZXNjcmlwdGlvbkZhaWx1cmU6IHJlcG9ydC5zZXRSZW1vdGVEZXNjcmlwdGlvbkZhaWx1cmUsCiAgICAgIHNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3M6IHJlcG9ydC5zdHJlYW1TdGF0cwogICAgfTsKICAgIGNvbnRhY3Quc2VuZFNvZnRwaG9uZVJlcG9ydChjYWxsUmVwb3J0LCB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uICgpIHsKICAgICAgICBsb2dnZXIuaW5mbygic2VuZFNvZnRwaG9uZVJlcG9ydCBzdWNjZXNzIiArIEpTT04uc3RyaW5naWZ5KGNhbGxSZXBvcnQpKQogICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgbG9nZ2VyLmVycm9yKCJzZW5kU29mdHBob25lUmVwb3J0IGZhaWxlZC4iKQogICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkKICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9CiAgICB9KTsKICB9OwoKICB2YXIgc3RhcnRTdGF0c0NvbGxlY3Rpb25Kb2IgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbikgewogICAgcnRwU3RhdHNKb2IgPSB3aW5kb3cuc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICBydGNTZXNzaW9uLmdldFVzZXJBdWRpb1N0YXRzKCkudGhlbihmdW5jdGlvbiAoc3RhdHMpIHsKICAgICAgICB2YXIgcHJldmlvdXNVc2VyU3RhdHMgPSBhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHM7CiAgICAgICAgYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzID0gc3RhdHM7CiAgICAgICAgdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyLnB1c2goZ2V0VGltZVNlcmllc1N0YXRzKGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cywgcHJldmlvdXNVc2VyU3RhdHMsIEFVRElPX0lOUFVUKSk7CiAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgIGxvZ2dlci5kZWJ1ZygiRmFpbGVkIHRvIGdldCB1c2VyIGF1ZGlvIHN0YXRzLiIsIGVycm9yKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9KTsKICAgICAgcnRjU2Vzc2lvbi5nZXRSZW1vdGVBdWRpb1N0YXRzKCkudGhlbihmdW5jdGlvbiAoc3RhdHMpIHsKICAgICAgICB2YXIgcHJldmlvdXNSZW1vdGVTdGF0cyA9IGFnZ3JlZ2F0ZWRSZW1vdGVBdWRpb1N0YXRzOwogICAgICAgIGFnZ3JlZ2F0ZWRSZW1vdGVBdWRpb1N0YXRzID0gc3RhdHM7CiAgICAgICAgdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyLnB1c2goZ2V0VGltZVNlcmllc1N0YXRzKGFnZ3JlZ2F0ZWRSZW1vdGVBdWRpb1N0YXRzLCBwcmV2aW91c1JlbW90ZVN0YXRzLCBBVURJT19PVVRQVVQpKTsKICAgICAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgbG9nZ2VyLmRlYnVnKCJGYWlsZWQgdG8gZ2V0IHJlbW90ZSBhdWRpbyBzdGF0cy4iLCBlcnJvcikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSk7CiAgICB9LCAxMDAwKTsKICB9OwoKICB2YXIgc3RhcnRTdGF0c1JlcG9ydGluZ0pvYiA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICByZXBvcnRTdGF0c0pvYiA9IHdpbmRvdy5zZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgIHNlbmRTb2Z0cGhvbmVNZXRyaWNzKGNvbnRhY3QpOwogICAgfSwgc3RhdHNSZXBvcnRpbmdKb2JJbnRlcnZhbE1zKTsKICB9OwoKICB2YXIgaW5pdGlhbGl6ZVBhcmFtcyA9IGZ1bmN0aW9uICgpIHsKICAgIGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cyA9IG51bGw7CiAgICBhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cyA9IG51bGw7CiAgICB0aW1lU2VyaWVzU3RyZWFtU3RhdHNCdWZmZXIgPSBbXTsKICAgIHJ0cFN0YXRzSm9iID0gbnVsbDsKICAgIHJlcG9ydFN0YXRzSm9iID0gbnVsbDsKICB9OwoKICB2YXIgZ2V0VGltZVNlcmllc1N0YXRzID0gZnVuY3Rpb24gKGN1cnJlbnRTdGF0cywgcHJldmlvdXNTdGF0cywgc3RyZWFtVHlwZSkgewogICAgaWYgKHByZXZpb3VzU3RhdHMgJiYgY3VycmVudFN0YXRzKSB7CiAgICAgIHZhciBwYWNrZXRzTG9zdCA9IGN1cnJlbnRTdGF0cy5wYWNrZXRzTG9zdCA+IHByZXZpb3VzU3RhdHMucGFja2V0c0xvc3QgPyBjdXJyZW50U3RhdHMucGFja2V0c0xvc3QgLSBwcmV2aW91c1N0YXRzLnBhY2tldHNMb3N0IDogMDsKICAgICAgdmFyIHBhY2tldHNDb3VudCA9IGN1cnJlbnRTdGF0cy5wYWNrZXRzQ291bnQgPiBwcmV2aW91c1N0YXRzLnBhY2tldHNDb3VudCA/IGN1cnJlbnRTdGF0cy5wYWNrZXRzQ291bnQgLSBwcmV2aW91c1N0YXRzLnBhY2tldHNDb3VudCA6IDA7CiAgICAgIHJldHVybiBuZXcgUlRQU3RyZWFtU3RhdHMoY3VycmVudFN0YXRzLnRpbWVzdGFtcCwKICAgICAgICBwYWNrZXRzTG9zdCwKICAgICAgICBwYWNrZXRzQ291bnQsCiAgICAgICAgc3RyZWFtVHlwZSwKICAgICAgICBjdXJyZW50U3RhdHMuYXVkaW9MZXZlbCwKICAgICAgICBjdXJyZW50U3RhdHMuamJNaWxsaXNlY29uZHMsCiAgICAgICAgY3VycmVudFN0YXRzLnJ0dE1pbGxpc2Vjb25kcyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmV3IFJUUFN0cmVhbVN0YXRzKGN1cnJlbnRTdGF0cy50aW1lc3RhbXAsCiAgICAgICAgY3VycmVudFN0YXRzLnBhY2tldHNMb3N0LAogICAgICAgIGN1cnJlbnRTdGF0cy5wYWNrZXRzQ291bnQsCiAgICAgICAgc3RyZWFtVHlwZSwKICAgICAgICBjdXJyZW50U3RhdHMuYXVkaW9MZXZlbCwKICAgICAgICBjdXJyZW50U3RhdHMuamJNaWxsaXNlY29uZHMsCiAgICAgICAgY3VycmVudFN0YXRzLnJ0dE1pbGxpc2Vjb25kcyk7CiAgICB9CiAgfTsKCiAgdmFyIHN0b3BKb2IgPSBmdW5jdGlvbiAodGFzaykgewogICAgaWYgKHRhc2sgIT09IG51bGwpIHsKICAgICAgd2luZG93LmNsZWFySW50ZXJ2YWwodGFzayk7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9OwoKICB2YXIgc3RvcEpvYnNBbmRSZXBvcnQgPSBmdW5jdGlvbiAoY29udGFjdCwgc2Vzc2lvblJlcG9ydCkgewogICAgcnRwU3RhdHNKb2IgPSBzdG9wSm9iKHJ0cFN0YXRzSm9iKTsKICAgIHJlcG9ydFN0YXRzSm9iID0gc3RvcEpvYihyZXBvcnRTdGF0c0pvYik7CiAgICBzZW5kU29mdHBob25lUmVwb3J0KGNvbnRhY3QsIHNlc3Npb25SZXBvcnQsIGFkZFN0cmVhbVR5cGVUb1N0YXRzKGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cywgQVVESU9fSU5QVVQpLCBhZGRTdHJlYW1UeXBlVG9TdGF0cyhhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cywgQVVESU9fT1VUUFVUKSk7CiAgICBzZW5kU29mdHBob25lTWV0cmljcyhjb250YWN0KTsKICB9OwoKICAvKioKICAqICAgQWRkaW5nIHN0cmVhbXR5cGUgcGFyYW1ldGVyIG9uIHRvcCBvZiBSVENKUyBSVFN0YXRzIG9iamVjdC4KICAqLwogIHZhciBSVFBTdHJlYW1TdGF0cyA9IGZ1bmN0aW9uICh0aW1lc3RhbXAsIHBhY2tldHNMb3N0LCBwYWNrZXRzQ291bnQsIHN0cmVhbVR5cGUsIGF1ZGlvTGV2ZWwsIGppdHRlckJ1ZmZlck1pbGxpcywgcm91bmRUcmlwVGltZU1pbGxpcykgewogICAgdGhpcy5zb2Z0cGhvbmVTdHJlYW1UeXBlID0gc3RyZWFtVHlwZTsKICAgIHRoaXMudGltZXN0YW1wID0gdGltZXN0YW1wOwogICAgdGhpcy5wYWNrZXRzTG9zdCA9IHBhY2tldHNMb3N0OwogICAgdGhpcy5wYWNrZXRzQ291bnQgPSBwYWNrZXRzQ291bnQ7CiAgICB0aGlzLmF1ZGlvTGV2ZWwgPSBhdWRpb0xldmVsOwogICAgdGhpcy5qaXR0ZXJCdWZmZXJNaWxsaXMgPSBqaXR0ZXJCdWZmZXJNaWxsaXM7CiAgICB0aGlzLnJvdW5kVHJpcFRpbWVNaWxsaXMgPSByb3VuZFRyaXBUaW1lTWlsbGlzOwogIH07CgogIHZhciBhZGRTdHJlYW1UeXBlVG9TdGF0cyA9IGZ1bmN0aW9uIChzdGF0cywgc3RyZWFtVHlwZSkgewogICAgc3RhdHMgPSBzdGF0cyB8fCB7fTsKICAgIHJldHVybiBuZXcgUlRQU3RyZWFtU3RhdHMoc3RhdHMudGltZXN0YW1wLCBzdGF0cy5wYWNrZXRzTG9zdCwgc3RhdHMucGFja2V0c0NvdW50LCBzdHJlYW1UeXBlLCBzdGF0cy5hdWRpb0xldmVsKTsKICB9OwoKICB2YXIgU29mdHBob25lTG9nZ2VyID0gZnVuY3Rpb24gKGxvZ2dlcikgewogICAgdGhpcy5fb3JpZ2luYWxMb2dnZXIgPSBsb2dnZXI7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0aGlzLl90ZWUgPSBmdW5jdGlvbiAobGV2ZWwsIG1ldGhvZCkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIC8vIGNhbGwgdGhlIG9yaWdpbmFsIGxvZ2dlciBvYmplY3QgdG8gb3V0cHV0IHRvIGJyb3dzZXIKICAgICAgICAvL0Nvbm5lY3QgbG9nZ2VyIGZvbGxvd3MgJXMgZm9ybWF0IHRvIHByaW50IG9iamVjdHMgdG8gY29uc29sZS4KICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50c1swXSk7CiAgICAgICAgdmFyIGZvcm1hdCA9ICIiOwogICAgICAgIGFyZ3MuZm9yRWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBmb3JtYXQgPSBmb3JtYXQgKyAiICVzIjsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gbWV0aG9kLmFwcGx5KHNlbGYuX29yaWdpbmFsTG9nZ2VyLCBbY29ubmVjdC5Mb2dDb21wb25lbnQuU09GVFBIT05FLCBmb3JtYXRdLmNvbmNhdChhcmdzKSk7CiAgICAgIH07CiAgICB9OwogIH07CgogIFNvZnRwaG9uZUxvZ2dlci5wcm90b3R5cGUuZGVidWcgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fdGVlKDEsIHRoaXMuX29yaWdpbmFsTG9nZ2VyLmRlYnVnKShhcmd1bWVudHMpOwogIH07CiAgU29mdHBob25lTG9nZ2VyLnByb3RvdHlwZS5pbmZvID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX3RlZSgyLCB0aGlzLl9vcmlnaW5hbExvZ2dlci5pbmZvKShhcmd1bWVudHMpOwogIH07CiAgU29mdHBob25lTG9nZ2VyLnByb3RvdHlwZS5sb2cgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fdGVlKDMsIHRoaXMuX29yaWdpbmFsTG9nZ2VyLmxvZykoYXJndW1lbnRzKTsKICB9OwogIFNvZnRwaG9uZUxvZ2dlci5wcm90b3R5cGUud2FybiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl90ZWUoNCwgdGhpcy5fb3JpZ2luYWxMb2dnZXIud2FybikoYXJndW1lbnRzKTsKICB9OwogIFNvZnRwaG9uZUxvZ2dlci5wcm90b3R5cGUuZXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fdGVlKDUsIHRoaXMuX29yaWdpbmFsTG9nZ2VyLmVycm9yKShhcmd1bWVudHMpOwogIH07CgogIGNvbm5lY3QuU29mdHBob25lTWFuYWdlciA9IFNvZnRwaG9uZU1hbmFnZXI7Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA5NDQ6Ci8qKiovICgoKSA9PiB7CgovKiEgQGxpY2Vuc2Ugc3ByaW50Zi5qcyB8IENvcHlyaWdodCAoYykgMjAwNy0yMDEzIEFsZXhhbmRydSBNYXJhc3RlYW51IDxoZWxsbyBhdCBhbGV4ZWkgZG90IHJvPiB8IDMgY2xhdXNlIEJTRCBsaWNlbnNlICovCgooZnVuY3Rpb24oKSB7CiAgIHZhciBjdHggPSB0aGlzOwoKCXZhciBzcHJpbnRmID0gZnVuY3Rpb24oKSB7CgkJaWYgKCFzcHJpbnRmLmNhY2hlLmhhc093blByb3BlcnR5KGFyZ3VtZW50c1swXSkpIHsKCQkJc3ByaW50Zi5jYWNoZVthcmd1bWVudHNbMF1dID0gc3ByaW50Zi5wYXJzZShhcmd1bWVudHNbMF0pOwoJCX0KCQlyZXR1cm4gc3ByaW50Zi5mb3JtYXQuY2FsbChudWxsLCBzcHJpbnRmLmNhY2hlW2FyZ3VtZW50c1swXV0sIGFyZ3VtZW50cyk7Cgl9OwoKCXNwcmludGYuZm9ybWF0ID0gZnVuY3Rpb24ocGFyc2VfdHJlZSwgYXJndikgewoJCXZhciBjdXJzb3IgPSAxLCB0cmVlX2xlbmd0aCA9IHBhcnNlX3RyZWUubGVuZ3RoLCBub2RlX3R5cGUgPSAnJywgYXJnLCBvdXRwdXQgPSBbXSwgaSwgaywgbWF0Y2gsIHBhZCwgcGFkX2NoYXJhY3RlciwgcGFkX2xlbmd0aDsKCQlmb3IgKGkgPSAwOyBpIDwgdHJlZV9sZW5ndGg7IGkrKykgewoJCQlub2RlX3R5cGUgPSBnZXRfdHlwZShwYXJzZV90cmVlW2ldKTsKCQkJaWYgKG5vZGVfdHlwZSA9PT0gJ3N0cmluZycpIHsKCQkJCW91dHB1dC5wdXNoKHBhcnNlX3RyZWVbaV0pOwoJCQl9CgkJCWVsc2UgaWYgKG5vZGVfdHlwZSA9PT0gJ2FycmF5JykgewoJCQkJbWF0Y2ggPSBwYXJzZV90cmVlW2ldOyAvLyBjb252ZW5pZW5jZSBwdXJwb3NlcyBvbmx5CgkJCQlpZiAobWF0Y2hbMl0pIHsgLy8ga2V5d29yZCBhcmd1bWVudAoJCQkJCWFyZyA9IGFyZ3ZbY3Vyc29yXTsKCQkJCQlmb3IgKGsgPSAwOyBrIDwgbWF0Y2hbMl0ubGVuZ3RoOyBrKyspIHsKCQkJCQkJaWYgKCFhcmcuaGFzT3duUHJvcGVydHkobWF0Y2hbMl1ba10pKSB7CgkJCQkJCQl0aHJvdyhzcHJpbnRmKCdbc3ByaW50Zl0gcHJvcGVydHkgIiVzIiBkb2VzIG5vdCBleGlzdCcsIG1hdGNoWzJdW2tdKSk7CgkJCQkJCX0KCQkJCQkJYXJnID0gYXJnW21hdGNoWzJdW2tdXTsKCQkJCQl9CgkJCQl9CgkJCQllbHNlIGlmIChtYXRjaFsxXSkgeyAvLyBwb3NpdGlvbmFsIGFyZ3VtZW50IChleHBsaWNpdCkKCQkJCQlhcmcgPSBhcmd2W21hdGNoWzFdXTsKCQkJCX0KCQkJCWVsc2UgeyAvLyBwb3NpdGlvbmFsIGFyZ3VtZW50IChpbXBsaWNpdCkKCQkJCQlhcmcgPSBhcmd2W2N1cnNvcisrXTsKCQkJCX0KCgkJCQlpZiAoL1tec10vLnRlc3QobWF0Y2hbOF0pICYmIChnZXRfdHlwZShhcmcpICE9ICdudW1iZXInKSkgewoJCQkJCXRocm93KHNwcmludGYoJ1tzcHJpbnRmXSBleHBlY3RpbmcgbnVtYmVyIGJ1dCBmb3VuZCAlcycsIGdldF90eXBlKGFyZykpKTsKCQkJCX0KCQkJCXN3aXRjaCAobWF0Y2hbOF0pIHsKCQkJCQljYXNlICdiJzogYXJnID0gYXJnLnRvU3RyaW5nKDIpOyBicmVhazsKCQkJCQljYXNlICdjJzogYXJnID0gU3RyaW5nLmZyb21DaGFyQ29kZShhcmcpOyBicmVhazsKCQkJCQljYXNlICdkJzogYXJnID0gcGFyc2VJbnQoYXJnLCAxMCk7IGJyZWFrOwoJCQkJCWNhc2UgJ2UnOiBhcmcgPSBtYXRjaFs3XSA/IGFyZy50b0V4cG9uZW50aWFsKG1hdGNoWzddKSA6IGFyZy50b0V4cG9uZW50aWFsKCk7IGJyZWFrOwoJCQkJCWNhc2UgJ2YnOiBhcmcgPSBtYXRjaFs3XSA/IHBhcnNlRmxvYXQoYXJnKS50b0ZpeGVkKG1hdGNoWzddKSA6IHBhcnNlRmxvYXQoYXJnKTsgYnJlYWs7CgkJCQkJY2FzZSAnbyc6IGFyZyA9IGFyZy50b1N0cmluZyg4KTsgYnJlYWs7CgkJCQkJY2FzZSAncyc6IGFyZyA9ICgoYXJnID0gU3RyaW5nKGFyZykpICYmIG1hdGNoWzddID8gYXJnLnN1YnN0cmluZygwLCBtYXRjaFs3XSkgOiBhcmcpOyBicmVhazsKCQkJCQljYXNlICd1JzogYXJnID0gYXJnID4+PiAwOyBicmVhazsKCQkJCQljYXNlICd4JzogYXJnID0gYXJnLnRvU3RyaW5nKDE2KTsgYnJlYWs7CgkJCQkJY2FzZSAnWCc6IGFyZyA9IGFyZy50b1N0cmluZygxNikudG9VcHBlckNhc2UoKTsgYnJlYWs7CgkJCQl9CgkJCQlhcmcgPSAoL1tkZWZdLy50ZXN0KG1hdGNoWzhdKSAmJiBtYXRjaFszXSAmJiBhcmcgPj0gMCA/ICcrJysgYXJnIDogYXJnKTsKCQkJCXBhZF9jaGFyYWN0ZXIgPSBtYXRjaFs0XSA/IG1hdGNoWzRdID09ICcwJyA/ICcwJyA6IG1hdGNoWzRdLmNoYXJBdCgxKSA6ICcgJzsKCQkJCXBhZF9sZW5ndGggPSBtYXRjaFs2XSAtIFN0cmluZyhhcmcpLmxlbmd0aDsKCQkJCXBhZCA9IG1hdGNoWzZdID8gc3RyX3JlcGVhdChwYWRfY2hhcmFjdGVyLCBwYWRfbGVuZ3RoKSA6ICcnOwoJCQkJb3V0cHV0LnB1c2gobWF0Y2hbNV0gPyBhcmcgKyBwYWQgOiBwYWQgKyBhcmcpOwoJCQl9CgkJfQoJCXJldHVybiBvdXRwdXQuam9pbignJyk7Cgl9OwoKCXNwcmludGYuY2FjaGUgPSB7fTsKCglzcHJpbnRmLnBhcnNlID0gZnVuY3Rpb24oZm10KSB7CgkJdmFyIF9mbXQgPSBmbXQsIG1hdGNoID0gW10sIHBhcnNlX3RyZWUgPSBbXSwgYXJnX25hbWVzID0gMDsKCQl3aGlsZSAoX2ZtdCkgewoJCQlpZiAoKG1hdGNoID0gL15bXlx4MjVdKy8uZXhlYyhfZm10KSkgIT09IG51bGwpIHsKCQkJCXBhcnNlX3RyZWUucHVzaChtYXRjaFswXSk7CgkJCX0KCQkJZWxzZSBpZiAoKG1hdGNoID0gL15ceDI1ezJ9Ly5leGVjKF9mbXQpKSAhPT0gbnVsbCkgewoJCQkJcGFyc2VfdHJlZS5wdXNoKCclJyk7CgkJCX0KCQkJZWxzZSBpZiAoKG1hdGNoID0gL15ceDI1KD86KFsxLTldXGQqKVwkfFwoKFteXCldKylcKSk/KFwrKT8oMHwnW14kXSk/KC0pPyhcZCspPyg/OlwuKFxkKykpPyhbYi1mb3N1eFhdKS8uZXhlYyhfZm10KSkgIT09IG51bGwpIHsKCQkJCWlmIChtYXRjaFsyXSkgewoJCQkJCWFyZ19uYW1lcyB8PSAxOwoJCQkJCXZhciBmaWVsZF9saXN0ID0gW10sIHJlcGxhY2VtZW50X2ZpZWxkID0gbWF0Y2hbMl0sIGZpZWxkX21hdGNoID0gW107CgkJCQkJaWYgKChmaWVsZF9tYXRjaCA9IC9eKFthLXpfXVthLXpfXGRdKikvaS5leGVjKHJlcGxhY2VtZW50X2ZpZWxkKSkgIT09IG51bGwpIHsKCQkJCQkJZmllbGRfbGlzdC5wdXNoKGZpZWxkX21hdGNoWzFdKTsKCQkJCQkJd2hpbGUgKChyZXBsYWNlbWVudF9maWVsZCA9IHJlcGxhY2VtZW50X2ZpZWxkLnN1YnN0cmluZyhmaWVsZF9tYXRjaFswXS5sZW5ndGgpKSAhPT0gJycpIHsKCQkJCQkJCWlmICgoZmllbGRfbWF0Y2ggPSAvXlwuKFthLXpfXVthLXpfXGRdKikvaS5leGVjKHJlcGxhY2VtZW50X2ZpZWxkKSkgIT09IG51bGwpIHsKCQkJCQkJCQlmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwoJCQkJCQkJfQoJCQkJCQkJZWxzZSBpZiAoKGZpZWxkX21hdGNoID0gL15cWyhcZCspXF0vLmV4ZWMocmVwbGFjZW1lbnRfZmllbGQpKSAhPT0gbnVsbCkgewoJCQkJCQkJCWZpZWxkX2xpc3QucHVzaChmaWVsZF9tYXRjaFsxXSk7CgkJCQkJCQl9CgkJCQkJCQllbHNlIHsKCQkJCQkJCQl0aHJvdygnW3NwcmludGZdIGh1aD8nKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCQllbHNlIHsKCQkJCQkJdGhyb3coJ1tzcHJpbnRmXSBodWg/Jyk7CgkJCQkJfQoJCQkJCW1hdGNoWzJdID0gZmllbGRfbGlzdDsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCWFyZ19uYW1lcyB8PSAyOwoJCQkJfQoJCQkJaWYgKGFyZ19uYW1lcyA9PT0gMykgewoJCQkJCXRocm93KCdbc3ByaW50Zl0gbWl4aW5nIHBvc2l0aW9uYWwgYW5kIG5hbWVkIHBsYWNlaG9sZGVycyBpcyBub3QgKHlldCkgc3VwcG9ydGVkJyk7CgkJCQl9CgkJCQlwYXJzZV90cmVlLnB1c2gobWF0Y2gpOwoJCQl9CgkJCWVsc2UgewoJCQkJdGhyb3coJ1tzcHJpbnRmXSBodWg/Jyk7CgkJCX0KCQkJX2ZtdCA9IF9mbXQuc3Vic3RyaW5nKG1hdGNoWzBdLmxlbmd0aCk7CgkJfQoJCXJldHVybiBwYXJzZV90cmVlOwoJfTsKCgl2YXIgdnNwcmludGYgPSBmdW5jdGlvbihmbXQsIGFyZ3YsIF9hcmd2KSB7CgkJX2FyZ3YgPSBhcmd2LnNsaWNlKDApOwoJCV9hcmd2LnNwbGljZSgwLCAwLCBmbXQpOwoJCXJldHVybiBzcHJpbnRmLmFwcGx5KG51bGwsIF9hcmd2KTsKCX07CgoJLyoqCgkgKiBoZWxwZXJzCgkgKi8KCWZ1bmN0aW9uIGdldF90eXBlKHZhcmlhYmxlKSB7CgkJcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YXJpYWJsZSkuc2xpY2UoOCwgLTEpLnRvTG93ZXJDYXNlKCk7Cgl9CgoJZnVuY3Rpb24gc3RyX3JlcGVhdChpbnB1dCwgbXVsdGlwbGllcikgewoJCWZvciAodmFyIG91dHB1dCA9IFtdOyBtdWx0aXBsaWVyID4gMDsgb3V0cHV0Wy0tbXVsdGlwbGllcl0gPSBpbnB1dCkgey8qIGRvIG5vdGhpbmcgKi99CgkJcmV0dXJuIG91dHB1dC5qb2luKCcnKTsKCX0KCgkvKioKCSAqIGV4cG9ydCB0byBlaXRoZXIgYnJvd3NlciBvciBub2RlLmpzCgkgKi8KCWN0eC5zcHJpbnRmID0gc3ByaW50ZjsKCWN0eC52c3ByaW50ZiA9IHZzcHJpbnRmOwp9KSgpOwoKCgovKioqLyB9KSwKCi8qKiovIDgyOgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uKCkgewogICB2YXIgZ2xvYmFsID0gdGhpczsKICAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBTdHJlYW0KICAgICoKICAgICogUmVwcmVzZW50cyBhbiBvYmplY3QgZnJvbSB3aGljaCBtZXNzYWdlcyBjYW4gYmUgcmVhZCBhbmQgdG8gd2hpY2gKICAgICogbWVzc2FnZXMgY2FuIGJlIHNlbnQuCiAgICAqLwogICB2YXIgU3RyZWFtID0gZnVuY3Rpb24oKSB7fTsKCiAgIC8qKgogICAgKiBTZW5kIGEgbWVzc2FnZSB0byB0aGUgc3RyZWFtLiAgVGhpcyBtZXRob2QgbXVzdCBiZSBpbXBsZW1lbnRlZCBieSBzdWJjbGFzc2VzLgogICAgKi8KICAgU3RyZWFtLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7CiAgIH07CgogICAvKioKICAgICogUHJvdmlkZSBhIG1ldGhvZCB0byBiZSBjYWxsZWQgd2hlbiBtZXNzYWdlcyBhcmUgcmVjZWl2ZWQgZnJvbSB0aGlzIHN0cmVhbS4KICAgICogVGhpcyBtZXRob2QgbXVzdCBiZSBpbXBsZW1lbnRlZCBieSBzdWJjbGFzc2VzLgogICAgKi8KICAgU3RyZWFtLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IoKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBOdWxsU3RyZWFtIGV4dGVuZHMgU3RyZWFtCiAgICAqCiAgICAqIEEgbnVsbCBzdHJlYW0gd2hpY2ggcHJvdmlkZXMgbm8gbWVzc2FnZSBzZW5kaW5nIG9yIHJlY2VpdmluZyBmYWNpbGl0aWVzLgogICAgKi8KICAgdmFyIE51bGxTdHJlYW0gPSBmdW5jdGlvbigpIHsKICAgICAgU3RyZWFtLmNhbGwodGhpcyk7CiAgIH07CiAgIE51bGxTdHJlYW0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdHJlYW0ucHJvdG90eXBlKTsKICAgTnVsbFN0cmVhbS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBOdWxsU3RyZWFtOwoKICAgTnVsbFN0cmVhbS5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikge307CiAgIE51bGxTdHJlYW0ucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7fTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBXaW5kb3dTdHJlYW0gZXh0ZW5kcyBTdHJlYW0KICAgICoKICAgICogQSBzdHJlYW0gZm9yIGNvbW11bmljYXRpbmcgd2l0aCBhIHdpbmRvdyBvYmplY3QuICBUaGUgZG9tYWluIHByb3ZpZGVkCiAgICAqIG11c3QgbWF0Y2ggdGhlIGFsbG93ZWQgbWVzc2FnZSBkb21haW5zIG9mIHRoZSBkb3duc3RyZWFtIHJlY2VpdmVyCiAgICAqIG9yIG1lc3NhZ2VzIHdpbGwgYmUgcmVqZWN0ZWQsIHNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvV2luZG93L3Bvc3RNZXNzYWdlCiAgICAqIGZvciBtb3JlIGluZm8uCiAgICAqLwogICB2YXIgV2luZG93U3RyZWFtID0gZnVuY3Rpb24od2luLCBkb21haW4pIHsKICAgICAgU3RyZWFtLmNhbGwodGhpcyk7CiAgICAgIHRoaXMud2luZG93ID0gd2luOwogICAgICB0aGlzLmRvbWFpbiA9IGRvbWFpbiB8fCAnKic7CiAgIH07CiAgIFdpbmRvd1N0cmVhbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUpOwogICBXaW5kb3dTdHJlYW0ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gV2luZG93U3RyZWFtOwoKICAgV2luZG93U3RyZWFtLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aGlzLndpbmRvdy5wb3N0TWVzc2FnZShtZXNzYWdlLCB0aGlzLmRvbWFpbik7CiAgIH07CgogICBXaW5kb3dTdHJlYW0ucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgdGhpcy53aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIGYpOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFdpbmRvd0lPU3RyZWFtIGV4dGVuZHMgU3RyZWFtCiAgICAqCiAgICAqIEEgc3RyZWFtIHVzZWQgYnkgSUZyYW1lL3BvcHVwIHdpbmRvd3MgdG8gY29tbXVuaWNhdGUgd2l0aCB0aGVpciBwYXJlbnRzCiAgICAqIGFuZCB2aXNlIHZlcnNhLgogICAgKgogICAgKiBUaGlzIG9iamVjdCBlbmNhcHN1bGF0ZXMgdGhlIGZhY3QgdGhhdCBpbmNvbWluZyBhbmQgb3V0Z29pbmcgbWVzc2FnZXMKICAgICogYXJyaXZlIG9uIGRpZmZlcmVudCB3aW5kb3dzIGFuZCBhbGxvd3MgdGhpcyB0byBiZSBtYW5hZ2VkIGFzIGEgc2luZ2xlCiAgICAqIFN0cmVhbSBvYmplY3QuCiAgICAqLwogICB2YXIgV2luZG93SU9TdHJlYW0gPSBmdW5jdGlvbihpbnB1dHdpbiwgb3V0cHV0d2luLCBkb21haW4pIHsKICAgICAgU3RyZWFtLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuaW5wdXQgPSBpbnB1dHdpbjsKICAgICAgdGhpcy5vdXRwdXQgPSBvdXRwdXR3aW47CiAgICAgIHRoaXMuZG9tYWluID0gZG9tYWluIHx8ICcqJzsKICAgfTsKICAgV2luZG93SU9TdHJlYW0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdHJlYW0ucHJvdG90eXBlKTsKICAgV2luZG93SU9TdHJlYW0ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gV2luZG93SU9TdHJlYW07CgogICBXaW5kb3dJT1N0cmVhbS5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgdGhpcy5vdXRwdXQucG9zdE1lc3NhZ2UobWVzc2FnZSwgdGhpcy5kb21haW4pOwogICB9OwoKICAgV2luZG93SU9TdHJlYW0ucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgdGhpcy5pbnB1dC5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgKG1lc3NhZ2UpID0+IHsKICAgICAgICAgaWYgKG1lc3NhZ2Uuc291cmNlID09PSB0aGlzLm91dHB1dCkgewogICAgICAgICAgICBmKG1lc3NhZ2UpOwogICAgICAgICB9CiAgICAgIH0pOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFBvcnRTdHJlYW0gZXh0ZW5kcyBTdHJlYW0KICAgICoKICAgICogQSBzdHJlYW0gd3JhcHBpbmcgYW4gSFRNTDUgV29ya2VyIHBvcnQuICBUaGlzIGNvdWxkIGJlIHRoZSBwb3J0CiAgICAqIHVzZWQgdG8gY29ubmVjdCB0byBhIFdvcmtlciBvciBvbmUgb2YgdGhlIG11bHRpdHVkZSBvZiBwb3J0cwogICAgKiBtYWRlIGF2YWlsYWJsZSB0byBhIFNoYXJlZFdvcmtlciBmb3IgY29tbXVuaWNhdGlvbiBiYWNrIHRvCiAgICAqIGl0cyBjb25uZWN0ZWQgY2xpZW50cy4KICAgICovCiAgIHZhciBQb3J0U3RyZWFtID0gZnVuY3Rpb24ocG9ydCkgewogICAgICBTdHJlYW0uY2FsbCh0aGlzKTsKICAgICAgdGhpcy5wb3J0ID0gcG9ydDsKICAgICAgdGhpcy5pZCA9IGNvbm5lY3QucmFuZG9tSWQoKTsKICAgfTsKICAgUG9ydFN0cmVhbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUpOwogICBQb3J0U3RyZWFtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBvcnRTdHJlYW07CgogICBQb3J0U3RyZWFtLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aGlzLnBvcnQucG9zdE1lc3NhZ2UobWVzc2FnZSk7CiAgIH07CgogICBQb3J0U3RyZWFtLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7CiAgICAgIHRoaXMucG9ydC5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgZik7CiAgIH07CgogICBQb3J0U3RyZWFtLnByb3RvdHlwZS5nZXRJZCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5pZDsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBTdHJlYW1NdWx0aXBsZXhlciBleHRlbmRzIFN0cmVhbQogICAgKgogICAgKiBBIHdyYXBwZXIgZm9yIG11bHRpcGxleGVkIGRvd25zdHJlYW0gY29tbXVuaWNhdGlvbiB3aXRoCiAgICAqIG11bHRpcGxlIHN0cmVhbXMgYXQgb25jZS4gIE1haW5seSB1c2VmdWwgZm9yIHRoZSBTaGFyZWRXb3JrZXIgdG8KICAgICogYnJvYWRjYXN0IGV2ZW50cyB0byBtYW55IFBvcnRTdHJlYW0gb2JqZWN0cyBhdCBvbmNlLgogICAgKi8KICAgdmFyIFN0cmVhbU11bHRpcGxleGVyID0gZnVuY3Rpb24oc3RyZWFtcykgewogICAgICBTdHJlYW0uY2FsbCh0aGlzKTsKICAgICAgdGhpcy5zdHJlYW1NYXAgPSBzdHJlYW1zID8KICAgICAgICAgY29ubmVjdC5pbmRleChzdHJlYW1zLCBmdW5jdGlvbihzKSB7IHJldHVybiBzLmdldElkKCk7IH0pIDoge307CiAgICAgIHRoaXMubWVzc2FnZUxpc3RlbmVycyA9IFtdOwogICB9OwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUpOwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBTdHJlYW1NdWx0aXBsZXhlcjsKCiAgIC8qKgogICAgKiBTZW5kIGEgbWVzc2FnZSB0byBhbGwgcG9ydHMgaW4gdGhlIG11bHRpcGxleGVyLgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgIHRoaXMuZ2V0U3RyZWFtcygpLmZvckVhY2goZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHN0cmVhbS5zZW5kKG1lc3NhZ2UpOwoKICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAvLyBDb3VsZG4ndCBzZW5kIG1lc3NhZ2UgdG8gb25lIG9mIHRoZSBkb3duc3RyZWFtcyBmb3Igc29tZSByZWFzb24uLi4KICAgICAgICAgICAgLy8gTm8gcmVsaWFibGUgbG9nZ2luZyBwb3NzaWJsZSB3aXRob3V0IGZ1cnRoZXIgZmFpbHVyZXMsCiAgICAgICAgICAgIC8vIG5vIHJlY292ZXJ5LCBqdXN0IGVhdCBpdC4KICAgICAgICAgfQogICAgICB9KTsKICAgfTsKCiAgIC8qKgogICAgKiBSZWdpc3RlciBhIG1ldGhvZCB3aGljaCB3aWxsIGJlIGNhbGxlZCB3aGVuIGEgbWVzc2FnZSBpcyByZWNlaXZlZCBmcm9tCiAgICAqIGFueSBvZiB0aGUgZG93bnN0cmVhbXMuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikgewogICAgICB0aGlzLm1lc3NhZ2VMaXN0ZW5lcnMucHVzaChmKTsKCiAgICAgIC8vIFVwZGF0ZSBleGlzdGluZyBzdHJlYW1zIHdpdGggdGhlIG5ldyBsaXN0ZW5lci4KICAgICAgdGhpcy5nZXRTdHJlYW1zKCkuZm9yRWFjaChmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgc3RyZWFtLm9uTWVzc2FnZShmKTsKICAgICAgfSk7CiAgIH07CgogICAvKioKICAgICogQWRkIGEgc3RyZWFtIHRvIHRoZSBtdWx0aXBsZXhlci4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5hZGRTdHJlYW0gPSBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB0aGlzLnN0cmVhbU1hcFtzdHJlYW0uZ2V0SWQoKV0gPSBzdHJlYW07CgogICAgICAvLyBVcGRhdGUgc3RyZWFtIHdpdGggZXhpc3RpbmcgbGlzdGVuZXJzLgogICAgICB0aGlzLm1lc3NhZ2VMaXN0ZW5lcnMuZm9yRWFjaChmdW5jdGlvbihtZXNzYWdlTGlzdGVuZXIpIHsKICAgICAgICAgc3RyZWFtLm9uTWVzc2FnZShtZXNzYWdlTGlzdGVuZXIpOwogICAgICB9KTsKICAgfTsKCiAgIC8qKgogICAgKiBSZW1vdmUgdGhlIGdpdmVuIGRvd25zdHJlYW0uICBUaGlzIGlzIHR5cGljYWxseSB1c2VkIGluIHJlc3BvbnNlCiAgICAqIHRvIHRoZSBTaGFyZWRXb3JrZXIncyBvbmNsb3NlIGV2ZW50LCBpbmRpY2F0aW5nIHRoYXQgYSBjb25zdW1lcgogICAgKiB0YWIgaGFzIGJlZW4gY2xvc2VkLgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLnJlbW92ZVN0cmVhbSA9IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICBkZWxldGUgdGhpcy5zdHJlYW1NYXBbc3RyZWFtLmdldElkKCldOwogICB9OwoKICAgLyoqCiAgICAqIEdldCBhIGxpc3Qgb2Ygc3RyZWFtcyBpbiB0aGUgbXVsdGlwbGV4ZXIuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUuZ2V0U3RyZWFtcyA9IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICByZXR1cm4gY29ubmVjdC52YWx1ZXModGhpcy5zdHJlYW1NYXApOwogICB9OwoKICAgLyoqCiAgICAqIEdldCB0aGUgc3RyZWFtIG1hdGNoaW5nIHRoZSBnaXZlbiBwb3J0LgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLmdldFN0cmVhbUZvclBvcnQgPSBmdW5jdGlvbihwb3J0KSB7CiAgICAgIHJldHVybiBjb25uZWN0LmZpbmQodGhpcy5nZXRTdHJlYW1zKCksIGZ1bmN0aW9uKHMpIHsKICAgICAgICAgcmV0dXJuIHMucG9ydCA9PT0gcG9ydDsKICAgICAgfSk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgQ29uZHVpdAogICAgKgogICAgKiBBbiBvYmplY3Qgd2hpY2ggYnJpZGdlcyBhbiB1cHN0cmVhbSBhbmQgYSBkb3duc3RyZWFtLCBhbGxvd2luZyBtZXNzYWdlcwogICAgKiB0byBiZSBwYXNzZWQgdG8gYW5kIGZyb20gZWFjaCBhbmQgcHJvdmlkaW5nIGFuIGV2ZW50IGJ1cyBmb3IgZXZlbnQKICAgICogc3Vic2NyaXB0aW9ucyB0byBiZSBtYWRlIHVwc3RyZWFtIGFuZCBkb3duc3RyZWFtLgogICAgKi8KICAgdmFyIENvbmR1aXQgPSBmdW5jdGlvbihuYW1lLCB1cHN0cmVhbSwgZG93bnN0cmVhbSkgewogICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICB0aGlzLnVwc3RyZWFtID0gdXBzdHJlYW0gfHwgbmV3IE51bGxTdHJlYW0oKTsKICAgICAgdGhpcy5kb3duc3RyZWFtID0gZG93bnN0cmVhbSB8fCBuZXcgTnVsbFN0cmVhbSgpOwogICAgICB0aGlzLmRvd25zdHJlYW1CdXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cygpOwogICAgICB0aGlzLnVwc3RyZWFtQnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoKTsKCiAgICAgIHRoaXMudXBzdHJlYW0ub25NZXNzYWdlKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5fZGlzcGF0Y2hFdmVudCwgdGhpcy51cHN0cmVhbUJ1cykpOwogICAgICB0aGlzLmRvd25zdHJlYW0ub25NZXNzYWdlKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5fZGlzcGF0Y2hFdmVudCwgdGhpcy5kb3duc3RyZWFtQnVzKSk7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5vblVwc3RyZWFtID0gZnVuY3Rpb24oZXZlbnROYW1lLCBmKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICByZXR1cm4gdGhpcy51cHN0cmVhbUJ1cy5zdWJzY3JpYmUoZXZlbnROYW1lLCBmKTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLm9uQWxsVXBzdHJlYW0gPSBmdW5jdGlvbihmKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgcmV0dXJuIHRoaXMudXBzdHJlYW1CdXMuc3Vic2NyaWJlQWxsKGYpOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUub25Eb3duc3RyZWFtID0gZnVuY3Rpb24oZXZlbnROYW1lLCBmKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICByZXR1cm4gdGhpcy5kb3duc3RyZWFtQnVzLnN1YnNjcmliZShldmVudE5hbWUsIGYpOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUub25BbGxEb3duc3RyZWFtID0gZnVuY3Rpb24oZikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZiwgJ2YnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIHJldHVybiB0aGlzLmRvd25zdHJlYW1CdXMuc3Vic2NyaWJlQWxsKGYpOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUuc2VuZFVwc3RyZWFtID0gZnVuY3Rpb24oZXZlbnROYW1lLCBkYXRhKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgICAgdGhpcy51cHN0cmVhbS5zZW5kKHtldmVudDogZXZlbnROYW1lLCBkYXRhOiBkYXRhfSk7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5zZW5kRG93bnN0cmVhbSA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZGF0YSkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICAgIHRoaXMuZG93bnN0cmVhbS5zZW5kKHtldmVudDogZXZlbnROYW1lLCBkYXRhOiBkYXRhfSk7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5fZGlzcGF0Y2hFdmVudCA9IGZ1bmN0aW9uKGJ1cywgbWVzc2FnZUV2ZW50KSB7CiAgICAgIHZhciBtZXNzYWdlID0gbWVzc2FnZUV2ZW50LmRhdGE7CiAgICAgIGlmIChtZXNzYWdlLmV2ZW50KSB7CiAgICAgICAgIGJ1cy50cmlnZ2VyKG1lc3NhZ2UuZXZlbnQsIG1lc3NhZ2UuZGF0YSk7CiAgICAgIH0KICAgfTsKCiAgIC8qKgogICAgKiBSZXR1cm5zIGEgY2xvc3VyZSB3aGljaCBwYXNzZXMgZXZlbnRzIHVwc3RyZWFtLgogICAgKgogICAgKiBVc2FnZToKICAgICogY29uZHVpdC5vbkRvd25zdHJlYW0oIk15RXZlbnQiLCBjb25kdWl0LnBhc3NVcHN0cmVhbSgpKTsKICAgICovCiAgIENvbmR1aXQucHJvdG90eXBlLnBhc3NVcHN0cmVhbSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHJldHVybiBmdW5jdGlvbihkYXRhLCBldmVudE5hbWUpIHsKICAgICAgICAgc2VsZi51cHN0cmVhbS5zZW5kKHtldmVudDogZXZlbnROYW1lLCBkYXRhOiBkYXRhfSk7CiAgICAgIH07CiAgIH07CgogICAvKioKICAgICogUmV0dXJucyBhIGNsb3N1cmUgd2hpY2ggcGFzc2VzIGV2ZW50cyBkb3duc3RyZWFtLgogICAgKgogICAgKiBVc2FnZToKICAgICogY29uZHVpdC5vblVwc3RyZWFtKCJNeUV2ZW50IiwgY29uZHVpdC5wYXNzRG93bnN0cmVhbSgpKTsKICAgICovCiAgIENvbmR1aXQucHJvdG90eXBlLnBhc3NEb3duc3RyZWFtID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGRhdGEsIGV2ZW50TmFtZSkgewogICAgICAgICBzZWxmLmRvd25zdHJlYW0uc2VuZCh7ZXZlbnQ6IGV2ZW50TmFtZSwgZGF0YTogZGF0YX0pOwogICAgICB9OwogICB9OwoKICAgLyoqCiAgICAqIFNodXRkb3duIHRoZSBjb25kdWl0J3MgZXZlbnQgYnVzc2VzIGFuZCByZW1vdmUgYWxsIHN1YnNjcmlwdGlvbnMuCiAgICAqLwogICBDb25kdWl0LnByb3RvdHlwZS5zaHV0ZG93biA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnVwc3RyZWFtQnVzLnVuc3Vic2NyaWJlQWxsKCk7CiAgICAgIHRoaXMuZG93bnN0cmVhbUJ1cy51bnN1YnNjcmliZUFsbCgpOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIElGcmFtZUNvbmR1aXQgZXh0ZW5kcyBDb25kdWl0CiAgICAqCiAgICAqIENyZWF0ZXMgYSBjb25kdWl0IGZvciB0aGUgZ2l2ZW4gSUZyYW1lIGVsZW1lbnQuCiAgICAqLwogICB2YXIgSUZyYW1lQ29uZHVpdCA9IGZ1bmN0aW9uKG5hbWUsIHdpbmRvdywgaWZyYW1lLCBkb21haW4pIHsKICAgICAgQ29uZHVpdC5jYWxsKHRoaXMsIG5hbWUsIG5ldyBXaW5kb3dJT1N0cmVhbSh3aW5kb3csIGlmcmFtZS5jb250ZW50V2luZG93LCBkb21haW4gfHwgJyonKSwgbnVsbCk7CiAgIH07CiAgIElGcmFtZUNvbmR1aXQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb25kdWl0LnByb3RvdHlwZSk7CiAgIElGcmFtZUNvbmR1aXQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gSUZyYW1lQ29uZHVpdDsKCiAgIGNvbm5lY3QuU3RyZWFtID0gU3RyZWFtOwogICBjb25uZWN0Lk51bGxTdHJlYW0gPSBOdWxsU3RyZWFtOwogICBjb25uZWN0LldpbmRvd1N0cmVhbSA9IFdpbmRvd1N0cmVhbTsKICAgY29ubmVjdC5XaW5kb3dJT1N0cmVhbSA9IFdpbmRvd0lPU3RyZWFtOwogICBjb25uZWN0LlBvcnRTdHJlYW0gPSBQb3J0U3RyZWFtOwogICBjb25uZWN0LlN0cmVhbU11bHRpcGxleGVyID0gU3RyZWFtTXVsdGlwbGV4ZXI7CiAgIGNvbm5lY3QuQ29uZHVpdCA9IENvbmR1aXQ7CiAgIGNvbm5lY3QuSUZyYW1lQ29uZHVpdCA9IElGcmFtZUNvbmR1aXQ7Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA4MzM6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24oKSB7CiAgIHZhciBnbG9iYWwgPSB0aGlzOwogICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBHcmFwaExpbmsgPDxhYnN0cmFjdCBjbGFzcz4+CiAgICAqCiAgICAqIFJlcHJlc2VudHMgdGhlIGFzc29jaWF0aW9uIG9mIG9uZSBvciBtb3JlIGF0dHJpYnV0ZXMgdG8gYSBzdGF0ZSB0cmFuc2l0aW9uLgogICAgKi8KICAgdmFyIEdyYXBoTGluayA9IGZ1bmN0aW9uKGZyb21TdGF0ZSwgdG9TdGF0ZSkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZnJvbVN0YXRlLCAnZnJvbVN0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b1N0YXRlLCAndG9TdGF0ZScpOwogICAgICB0aGlzLmZyb21TdGF0ZSA9IGZyb21TdGF0ZTsKICAgICAgdGhpcy50b1N0YXRlID0gdG9TdGF0ZTsKICAgfTsKCiAgIEdyYXBoTGluay5wcm90b3R5cGUuZ2V0QXNzb2NpYXRpb25zID0gZnVuY3Rpb24oY29udGV4dCkgewogICAgICB0aHJvdyBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IoKTsKICAgfTsKCiAgIEdyYXBoTGluay5wcm90b3R5cGUuZ2V0RnJvbVN0YXRlID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmZyb21TdGF0ZTsKICAgfTsKCiAgIEdyYXBoTGluay5wcm90b3R5cGUuZ2V0VG9TdGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy50b1N0YXRlOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBEaXJlY3RHcmFwaExpbmsgPDxjb25jcmV0ZSBjbGFzcz4+IGV4dGVuZHMgR3JhcGhMaW5rCiAgICAqCiAgICAqIFJlcHJlc2VudHMgdGhlIGJ5LXZhbHVlIHJlcHJlc2VudGF0aW9uIG9mIG9uZSBvciBtb3JlIGF0dHJpYnV0ZXMgdG8gYQogICAgKiBzdGF0ZSB0cmFuc2l0aW9uLgogICAgKi8KICAgdmFyIERpcmVjdEdyYXBoTGluayA9IGZ1bmN0aW9uKGZyb21TdGF0ZSwgdG9TdGF0ZSwgYXNzb2NpYXRpb25zKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmcm9tU3RhdGUsICdmcm9tU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvU3RhdGUsICd0b1N0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChhc3NvY2lhdGlvbnMsICdhc3NvY2lhdGlvbnMnKTsKICAgICAgR3JhcGhMaW5rLmNhbGwodGhpcywgZnJvbVN0YXRlLCB0b1N0YXRlKTsKICAgICAgdGhpcy5hc3NvY2lhdGlvbnMgPSBhc3NvY2lhdGlvbnM7CiAgIH07CiAgIERpcmVjdEdyYXBoTGluay5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEdyYXBoTGluay5wcm90b3R5cGUpOwogICBEaXJlY3RHcmFwaExpbmsucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRGlyZWN0R3JhcGhMaW5rOwoKICAgRGlyZWN0R3JhcGhMaW5rLnByb3RvdHlwZS5nZXRBc3NvY2lhdGlvbnMgPSBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgIHJldHVybiB0aGlzLmFzc29jaWF0aW9uczsKICAgfTsKCiAgIC8qKgogICAgKiBGdW5jdGlvbmFsR3JhcGhMaW5rIDw8Y29uY3JldGUgY2xhc3M+PiBleHRlbmRzIEdyYXBoTGluawogICAgKgogICAgKiBSZXByZXNlbnRzIGEgZnVuY3Rpb25hbCBhc3NvY2lhdGlvbiBvZiBvbmUgb3IgbW9yZSBhdHRyaWJ1dGVzIHRvIGEKICAgICogc3RhdGUgdHJhbnNpdGlvbi4KICAgICovCiAgIHZhciBGdW5jdGlvbmFsR3JhcGhMaW5rID0gZnVuY3Rpb24oZnJvbVN0YXRlLCB0b1N0YXRlLCBjbG9zdXJlKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmcm9tU3RhdGUsICdmcm9tU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvU3RhdGUsICd0b1N0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChjbG9zdXJlLCAnY2xvc3VyZScpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNsb3N1cmUpLCAnY2xvc3VyZSBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgR3JhcGhMaW5rLmNhbGwodGhpcywgZnJvbVN0YXRlLCB0b1N0YXRlKTsKICAgICAgdGhpcy5jbG9zdXJlID0gY2xvc3VyZTsKICAgfTsKICAgRnVuY3Rpb25hbEdyYXBoTGluay5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEdyYXBoTGluay5wcm90b3R5cGUpOwogICBGdW5jdGlvbmFsR3JhcGhMaW5rLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEZ1bmN0aW9uYWxHcmFwaExpbms7CgogICBGdW5jdGlvbmFsR3JhcGhMaW5rLnByb3RvdHlwZS5nZXRBc3NvY2lhdGlvbnMgPSBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgIHJldHVybiB0aGlzLmNsb3N1cmUoY29udGV4dCwgdGhpcy5nZXRGcm9tU3RhdGUoKSwgdGhpcy5nZXRUb1N0YXRlKCkpOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBFdmVudEdyYXBoIDw8Y2xhc3M+PgogICAgKgogICAgKiBCdWlsZHMgYSBtYXAgb2YgYXNzb2NpYXRpb25zIGZyb20gb25lIHN0YXRlIHRvIGFub3RoZXIgaW4gY29udGV4dCBvZiBhCiAgICAqIHBhcnRpY3VsYXIgb2JqZWN0LiAgVGhlIGFzc29jaWF0aW9ucyBjYW4gYmUgZGlyZWN0IChvbmUgb3IgbW9yZSB2YWx1ZXMpCiAgICAqIG9yIGZ1bmN0aW9uYWwgKGEgbWV0aG9kIHJldHVybmluZyBvbmUgb3IgbW9yZSB2YWx1ZXMpLCBhbmQgYXJlIHVzZWQgdG8KICAgICogcHJvdmlkZSBhZGRpdGlvbmFsIGNvbnRleHR1YWwgZXZlbnQgaG9va3MgZm9yIHRoZSBVSSB0byBjb25zdW1lLgogICAgKi8KICAgdmFyIEV2ZW50R3JhcGggPSBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5mcm9tTWFwID0ge307CiAgIH07CiAgIEV2ZW50R3JhcGguQU5ZID0gIjw8YW55Pj4iOwoKICAgRXZlbnRHcmFwaC5wcm90b3R5cGUuYXNzb2MgPSBmdW5jdGlvbihmcm9tU3RhdGVPYmosIHRvU3RhdGVPYmosIGFzc29jT2JqKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIGlmICghIGZyb21TdGF0ZU9iaikgewogICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImZyb21TdGF0ZU9iaiBpcyBub3QgZGVmaW5lZC4iKTsKICAgICAgfQoKICAgICAgaWYgKCEgdG9TdGF0ZU9iaikgewogICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInRvU3RhdGVPYmogaXMgbm90IGRlZmluZWQuIik7CiAgICAgIH0KCiAgICAgIGlmICghIGFzc29jT2JqKSB7CiAgICAgICAgIHRocm93IG5ldyBFcnJvcigiYXNzb2NPYmogaXMgbm90IGRlZmluZWQuIik7CiAgICAgIH0KCiAgICAgIGlmIChmcm9tU3RhdGVPYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICBmcm9tU3RhdGVPYmouZm9yRWFjaChmdW5jdGlvbihmcm9tU3RhdGUpIHsKICAgICAgICAgICAgc2VsZi5hc3NvYyhmcm9tU3RhdGUsIHRvU3RhdGVPYmosIGFzc29jT2JqKTsKICAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAodG9TdGF0ZU9iaiBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgIHRvU3RhdGVPYmouZm9yRWFjaChmdW5jdGlvbih0b1N0YXRlKSB7CiAgICAgICAgICAgIHNlbGYuYXNzb2MoZnJvbVN0YXRlT2JqLCB0b1N0YXRlLCBhc3NvY09iaik7CiAgICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgICBpZiAodHlwZW9mIGFzc29jT2JqID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRoaXMuX2FkZEFzc29jaWF0aW9uKG5ldyBGdW5jdGlvbmFsR3JhcGhMaW5rKGZyb21TdGF0ZU9iaiwgdG9TdGF0ZU9iaiwgYXNzb2NPYmopKTsKICAgICAgICAgfSBlbHNlIGlmIChhc3NvY09iaiBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgIHRoaXMuX2FkZEFzc29jaWF0aW9uKG5ldyBEaXJlY3RHcmFwaExpbmsoZnJvbVN0YXRlT2JqLCB0b1N0YXRlT2JqLCBhc3NvY09iaikpOwogICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9hZGRBc3NvY2lhdGlvbihuZXcgRGlyZWN0R3JhcGhMaW5rKGZyb21TdGF0ZU9iaiwgdG9TdGF0ZU9iaiwgW2Fzc29jT2JqXSkpOwogICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgIH07CgogICBFdmVudEdyYXBoLnByb3RvdHlwZS5nZXRBc3NvY2lhdGlvbnMgPSBmdW5jdGlvbihjb250ZXh0LCBmcm9tU3RhdGUsIHRvU3RhdGUpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGZyb21TdGF0ZSwgJ2Zyb21TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9TdGF0ZSwgJ3RvU3RhdGUnKTsKICAgICAgdmFyIGFzc29jaWF0aW9ucyA9IFtdOwoKICAgICAgdmFyIHRvTWFwRnJvbUFueSA9IHRoaXMuZnJvbU1hcFtFdmVudEdyYXBoLkFOWV0gfHwge307CiAgICAgIHZhciB0b01hcCA9IHRoaXMuZnJvbU1hcFtmcm9tU3RhdGVdIHx8IHt9OwoKICAgICAgYXNzb2NpYXRpb25zID0gYXNzb2NpYXRpb25zLmNvbmNhdCh0aGlzLl9nZXRBc3NvY2lhdGlvbnNGcm9tTWFwKAogICAgICAgICAgICAgICB0b01hcEZyb21BbnksIGNvbnRleHQsIGZyb21TdGF0ZSwgdG9TdGF0ZSkpOwogICAgICBhc3NvY2lhdGlvbnMgPSBhc3NvY2lhdGlvbnMuY29uY2F0KHRoaXMuX2dldEFzc29jaWF0aW9uc0Zyb21NYXAoCiAgICAgICAgICAgICAgIHRvTWFwLCBjb250ZXh0LCBmcm9tU3RhdGUsIHRvU3RhdGUpKTsKCiAgICAgIHJldHVybiBhc3NvY2lhdGlvbnM7CiAgIH07CgogICBFdmVudEdyYXBoLnByb3RvdHlwZS5fYWRkQXNzb2NpYXRpb24gPSBmdW5jdGlvbihhc3NvYykgewogICAgICB2YXIgdG9NYXAgPSB0aGlzLmZyb21NYXBbYXNzb2MuZ2V0RnJvbVN0YXRlKCldOwoKICAgICAgaWYgKCEgdG9NYXApIHsKICAgICAgICAgdG9NYXAgPSB0aGlzLmZyb21NYXBbYXNzb2MuZ2V0RnJvbVN0YXRlKCldID0ge307CiAgICAgIH0KCiAgICAgIHZhciBhc3NvY0xpc3QgPSB0b01hcFthc3NvYy5nZXRUb1N0YXRlKCldOwoKICAgICAgaWYgKCEgYXNzb2NMaXN0KSB7CiAgICAgICAgIGFzc29jTGlzdCA9IHRvTWFwW2Fzc29jLmdldFRvU3RhdGUoKV0gPSBbXTsKICAgICAgfQoKICAgICAgYXNzb2NMaXN0LnB1c2goYXNzb2MpOwogICB9OwoKICAgRXZlbnRHcmFwaC5wcm90b3R5cGUuX2dldEFzc29jaWF0aW9uc0Zyb21NYXAgPSBmdW5jdGlvbihtYXAsIGNvbnRleHQsIGZyb21TdGF0ZSwgdG9TdGF0ZSkgewogICAgICB2YXIgYXNzb2NMaXN0ID0gKG1hcFtFdmVudEdyYXBoLkFOWV0gfHwgW10pLmNvbmNhdChtYXBbdG9TdGF0ZV0gfHwgW10pOwogICAgICByZXR1cm4gYXNzb2NMaXN0LnJlZHVjZShmdW5jdGlvbihwcmV2LCBhc3NvYykgewogICAgICAgICByZXR1cm4gcHJldi5jb25jYXQoYXNzb2MuZ2V0QXNzb2NpYXRpb25zKGNvbnRleHQpKTsKICAgICAgfSwgW10pOwogICB9OwoKICAgY29ubmVjdC5FdmVudEdyYXBoID0gRXZlbnRHcmFwaDsKCn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA4OTE6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICB2YXIgdXNlckFnZW50ID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKICB2YXIgT05FX0RBWV9NSUxMSVMgPSAyNCAqIDYwICogNjAgKiAxMDAwOwogIHZhciBERUZBVUxUX1BPUFVQX0hFSUdIVCA9IDU3ODsKICB2YXIgREVGQVVMVF9QT1BVUF9XSURUSCA9IDQzMzsKICB2YXIgQ09QWUFCTEVfRVZFTlRfRklFTERTID0gWyJidWJibGVzIiwgImNhbmNlbEJ1YmJsZSIsICJjYW5jZWxhYmxlIiwgImNvbXBvc2VkIiwgImRhdGEiLCAiZGVmYXVsdFByZXZlbnRlZCIsICJldmVudFBoYXNlIiwgImlzVHJ1c3RlZCIsICJsYXN0RXZlbnRJZCIsICJvcmlnaW4iLCAicmV0dXJuVmFsdWUiLCAidGltZVN0YW1wIiwgInR5cGUiXTsKCiAgLyoqCiAgICogVW5wb2xsdXRlIHNwcmludGYgZnVuY3Rpb25zIGZyb20gdGhlIGdsb2JhbCBuYW1lc3BhY2UuCiAgICovCiAgY29ubmVjdC5zcHJpbnRmID0gZ2xvYmFsLnNwcmludGY7CiAgY29ubmVjdC52c3ByaW50ZiA9IGdsb2JhbC52c3ByaW50ZjsKICBkZWxldGUgZ2xvYmFsLnNwcmludGY7CiAgZGVsZXRlIGdsb2JhbC52c3ByaW50ZjsKCiAgY29ubmVjdC5IVFRQX1NUQVRVU19DT0RFUyA9IHsKICAgIFNVQ0NFU1M6IDIwMCwKICAgIFRPT19NQU5ZX1JFUVVFU1RTOiA0MjksCiAgICBJTlRFUk5BTF9TRVJWRVJfRVJST1I6IDUwMAogIH07CgogIGNvbm5lY3QuVFJBTlNQT1JUX1RZUEVTID0gewogICAgQ0hBVF9UT0tFTjogImNoYXRfdG9rZW4iLAogICAgV0VCX1NPQ0tFVDogIndlYl9zb2NrZXQiCiAgfTsKCiAgLyoqCiAgICogQmluZHMgdGhlIGdpdmVuIGluc3RhbmNlIG9iamVjdCBhcyB0aGUgY29udGV4dCBmb3IKICAgKiB0aGUgbWV0aG9kIHByb3ZpZGVkLgogICAqCiAgICogQHBhcmFtIHNjb3BlIFRoZSBpbnN0YW5jZSBvYmplY3QgdG8gYmUgc2V0IGFzIHRoZSBzY29wZQogICAqICAgIG9mIHRoZSBmdW5jdGlvbi4KICAgKiBAcGFyYW0gbWV0aG9kIFRoZSBtZXRob2QgdG8gYmUgZW5jYXBzdWxhdGVkLgogICAqCiAgICogQWxsIG90aGVyIGFyZ3VtZW50cywgaWYgYW55LCBhcmUgYm91bmQgdG8gdGhlIG1ldGhvZAogICAqIGludm9jYXRpb24gaW5zaWRlIHRoZSBjbG9zdXJlLgogICAqCiAgICogQHJldHVybiBBIGNsb3N1cmUgZW5jYXBzdWxhdGluZyB0aGUgaW52b2NhdGlvbiBvZiB0aGUKICAgKiAgICBtZXRob2QgcHJvdmlkZWQgaW4gY29udGV4dCBvZiB0aGUgZ2l2ZW4gaW5zdGFuY2UuCiAgICovCiAgY29ubmVjdC5oaXRjaCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgIHZhciBzY29wZSA9IGFyZ3Muc2hpZnQoKTsKICAgIHZhciBtZXRob2QgPSBhcmdzLnNoaWZ0KCk7CgogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHNjb3BlLCAnc2NvcGUnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChtZXRob2QsICdtZXRob2QnKTsKICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24obWV0aG9kKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKCiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICB2YXIgY2xvc3VyZUFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICByZXR1cm4gbWV0aG9kLmFwcGx5KHNjb3BlLCBhcmdzLmNvbmNhdChjbG9zdXJlQXJncykpOwogICAgfTsKICB9OwoKICAvKioKICAgKiBEZXRlcm1pbmUgaWYgdGhlIGdpdmVuIHZhbHVlIGlzIGEgY2FsbGFibGUgZnVuY3Rpb24gdHlwZS4KICAgKiBCb3Jyb3dlZCBmcm9tIFVuZGVyc2NvcmUuanMuCiAgICovCiAgY29ubmVjdC5pc0Z1bmN0aW9uID0gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuICEhKG9iaiAmJiBvYmouY29uc3RydWN0b3IgJiYgb2JqLmNhbGwgJiYgb2JqLmFwcGx5KTsKICB9OwoKICAvKioKICAgKiBEZXRlcm1pbmUgaWYgdGhlIGdpdmVuIHZhbHVlIGlzIGFuIGFycmF5LgogICAqLwogIGNvbm5lY3QuaXNBcnJheSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgQXJyYXldJzsKICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIGtleXMgZnJvbSBhIEphdmFzY3JpcHQgb2JqZWN0IHVzZWQKICAgKiBhcyBhIGhhc2ggbWFwLgogICAqLwogIGNvbm5lY3Qua2V5cyA9IGZ1bmN0aW9uIChtYXApIHsKICAgIHZhciBrZXlzID0gW107CgogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKG1hcCwgJ21hcCcpOwoKICAgIGZvciAodmFyIGsgaW4gbWFwKSB7CiAgICAgIGtleXMucHVzaChrKTsKICAgIH0KCiAgICByZXR1cm4ga2V5czsKICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIHZhbHVlcyBmcm9tIGEgSmF2YXNjcmlwdCBvYmplY3QgdXNlZAogICAqIGFzIGEgaGFzaCBtYXAuCiAgICovCiAgY29ubmVjdC52YWx1ZXMgPSBmdW5jdGlvbiAobWFwKSB7CiAgICB2YXIgdmFsdWVzID0gW107CgogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKG1hcCwgJ21hcCcpOwoKICAgIGZvciAodmFyIGsgaW4gbWFwKSB7CiAgICAgIHZhbHVlcy5wdXNoKG1hcFtrXSk7CiAgICB9CgogICAgcmV0dXJuIHZhbHVlczsKICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIGtleS92YWx1ZSBwYWlycyBmcm9tIHRoZSBnaXZlbiBtYXAuCiAgICovCiAgY29ubmVjdC5lbnRyaWVzID0gZnVuY3Rpb24gKG1hcCkgewogICAgdmFyIGVudHJpZXMgPSBbXTsKCiAgICBmb3IgKHZhciBrIGluIG1hcCkgewogICAgICBlbnRyaWVzLnB1c2goeyBrZXk6IGssIHZhbHVlOiBtYXBba10gfSk7CiAgICB9CgogICAgcmV0dXJuIGVudHJpZXM7CiAgfTsKCiAgLyoqCiAgICogTWVyZ2UgdHdvIG9yIG1vcmUgbWFwcyB0b2dldGhlciBpbnRvIGEgbmV3IG1hcCwKICAgKiBvciBzaW1wbHkgY29weSBhIHNpbmdsZSBtYXAuCiAgICovCiAgY29ubmVjdC5tZXJnZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhcmdNYXBzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgIHZhciByZXN1bHRNYXAgPSB7fTsKCiAgICBhcmdNYXBzLmZvckVhY2goZnVuY3Rpb24gKG1hcCkgewogICAgICBjb25uZWN0LmVudHJpZXMobWFwKS5mb3JFYWNoKGZ1bmN0aW9uIChrdikgewogICAgICAgIHJlc3VsdE1hcFtrdi5rZXldID0ga3YudmFsdWU7CiAgICAgIH0pOwogICAgfSk7CgogICAgcmV0dXJuIHJlc3VsdE1hcDsKICB9OwoKICBjb25uZWN0Lm5vdyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICB9OwoKICBjb25uZWN0LmZpbmQgPSBmdW5jdGlvbiAoYXJyYXksIHByZWRpY2F0ZSkgewogICAgZm9yICh2YXIgeCA9IDA7IHggPCBhcnJheS5sZW5ndGg7IHgrKykgewogICAgICBpZiAocHJlZGljYXRlKGFycmF5W3hdKSkgewogICAgICAgIHJldHVybiBhcnJheVt4XTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBudWxsOwogIH07CgogIGNvbm5lY3QuY29udGFpbnMgPSBmdW5jdGlvbiAob2JqLCB2YWx1ZSkgewogICAgaWYgKG9iaiBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgIHJldHVybiBjb25uZWN0LmZpbmQob2JqLCBmdW5jdGlvbiAodikgeyByZXR1cm4gdiA9PT0gdmFsdWU7IH0pICE9IG51bGw7CgogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICh2YWx1ZSBpbiBvYmopOwogICAgfQogIH07CgogIGNvbm5lY3QuY29udGFpbnNWYWx1ZSA9IGZ1bmN0aW9uIChvYmosIHZhbHVlKSB7CiAgICBpZiAob2JqIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgcmV0dXJuIGNvbm5lY3QuZmluZChvYmosIGZ1bmN0aW9uICh2KSB7IHJldHVybiB2ID09PSB2YWx1ZTsgfSkgIT0gbnVsbDsKCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gY29ubmVjdC5maW5kKGNvbm5lY3QudmFsdWVzKG9iaiksIGZ1bmN0aW9uICh2KSB7IHJldHVybiB2ID09PSB2YWx1ZTsgfSkgIT0gbnVsbDsKICAgIH0KICB9OwoKICAvKioKICAgKiBHZW5lcmF0ZSBhIHJhbmRvbSBJRCBjb25zaXN0aW5nIG9mIHRoZSBjdXJyZW50IHRpbWVzdGFtcAogICAqIGFuZCBhIHJhbmRvbSBiYXNlLTM2IG51bWJlciBiYXNlZCBvbiBNYXRoLnJhbmRvbSgpLgogICAqLwogIGNvbm5lY3QucmFuZG9tSWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5zcHJpbnRmKCIlcy0lcyIsIGNvbm5lY3Qubm93KCksIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpKTsKICB9OwoKICAvKioKICAgKiBHZW5lcmF0ZSBhbiBlbnVtIGZyb20gdGhlIGdpdmVuIGxpc3Qgb2YgbG93ZXItY2FzZSBlbnVtIHZhbHVlcywKICAgKiB3aGVyZSB0aGUgZW51bSBrZXlzIHdpbGwgYmUgdXBwZXIgY2FzZS4KICAgKgogICAqIENvbnZlcnNpb24gZnJvbSBwYXNjYWwgY2FzZSBiYXNlZCBvbiBjb2RlIGZyb20gaGVyZToKICAgKiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzMwNTIxMjI0CiAgICovCiAgY29ubmVjdC5tYWtlRW51bSA9IGZ1bmN0aW9uICh2YWx1ZXMpIHsKICAgIHZhciBlbnVtT2JqID0ge307CgogICAgdmFsdWVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHZhciBrZXkgPSB2YWx1ZS5yZXBsYWNlKC9cLj8oW2Etel0rKV8/L2csIGZ1bmN0aW9uICh4LCB5KSB7IHJldHVybiB5LnRvVXBwZXJDYXNlKCkgKyAiXyI7IH0pCiAgICAgICAgLnJlcGxhY2UoL18kLywgIiIpOwoKICAgICAgZW51bU9ialtrZXldID0gdmFsdWU7CiAgICB9KTsKCiAgICByZXR1cm4gZW51bU9iajsKICB9OwoKICBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSA9IGZ1bmN0aW9uIChwcmVmaXgsIHZhbHVlcykgewogICAgdmFyIGVudW1PYmogPSBjb25uZWN0Lm1ha2VFbnVtKHZhbHVlcyk7CiAgICBjb25uZWN0LmtleXMoZW51bU9iaikuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIGVudW1PYmpba2V5XSA9IGNvbm5lY3Quc3ByaW50ZigiJXM6OiVzIiwgcHJlZml4LCBlbnVtT2JqW2tleV0pOwogICAgfSk7CiAgICByZXR1cm4gZW51bU9iajsKICB9OwoKICBjb25uZWN0Lm1ha2VHZW5lcmljTmFtZXNwYWNlZEVudW0gPSBmdW5jdGlvbiAocHJlZml4LCB2YWx1ZXMsIGRlbGltaXRlcikgewogICAgdmFyIGVudW1PYmogPSBjb25uZWN0Lm1ha2VFbnVtKHZhbHVlcyk7CiAgICBjb25uZWN0LmtleXMoZW51bU9iaikuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIGVudW1PYmpba2V5XSA9IGNvbm5lY3Quc3ByaW50ZigiJXMiK2RlbGltaXRlcisiJXMiLCBwcmVmaXgsIGVudW1PYmpba2V5XSk7CiAgICB9KTsKICAgIHJldHVybiBlbnVtT2JqOwogIH07CgogIC8qKgogICogTWV0aG9kcyB0byBkZXRlcm1pbmUgYnJvd3NlciB0eXBlIGFuZCB2ZXJzaW9ucywgdXNlZCBmb3Igc29mdHBob25lIGluaXRpYWxpemF0aW9uLgogICovCiAgY29ubmVjdC5pc0Nocm9tZUJyb3dzZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdXNlckFnZW50LmluZGV4T2YoIkNocm9tZSIpICE9PSAtMTsKICB9OwoKICBjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdXNlckFnZW50LmluZGV4T2YoIkZpcmVmb3giKSAhPT0gLTE7CiAgfTsKCiAgY29ubmVjdC5pc09wZXJhQnJvd3NlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB1c2VyQWdlbnQuaW5kZXhPZigiT3BlcmEiKSAhPT0gLTE7CiAgfTsKCiAgY29ubmVjdC5nZXRDaHJvbWVCcm93c2VyVmVyc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBjaHJvbWVWZXJzaW9uID0gdXNlckFnZW50LnN1YnN0cmluZyh1c2VyQWdlbnQuaW5kZXhPZigiQ2hyb21lIikgKyA3KTsKICAgIGlmIChjaHJvbWVWZXJzaW9uKSB7CiAgICAgIHJldHVybiBwYXJzZUZsb2F0KGNocm9tZVZlcnNpb24pOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIC0xOwogICAgfQogIH07CgogIGNvbm5lY3QuZ2V0RmlyZWZveEJyb3dzZXJWZXJzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGZpcmVmb3hWZXJzaW9uID0gdXNlckFnZW50LnN1YnN0cmluZyh1c2VyQWdlbnQuaW5kZXhPZigiRmlyZWZveCIpICsgOCk7CiAgICBpZiAoZmlyZWZveFZlcnNpb24pIHsKICAgICAgcmV0dXJuIHBhcnNlRmxvYXQoZmlyZWZveFZlcnNpb24pOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIC0xOwogICAgfQogIH07CgogIGNvbm5lY3QuaXNWYWxpZExvY2FsZSA9IGZ1bmN0aW9uIChsb2NhbGUpIHsKICAgIHZhciBsYW5ndWFnZXMgPSBbCiAgICAgIHsKICAgICAgICBpZDogJ2VuX1VTJywKICAgICAgICBsYWJlbDogJ0VuZ2xpc2gnCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ2RlX0RFJywKICAgICAgICBsYWJlbDogJ0RldXRzY2gnCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ2VzX0VTJywKICAgICAgICBsYWJlbDogJ0VzcGHDsW9sJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICdmcl9GUicsCiAgICAgICAgbGFiZWw6ICdGcmFuw6dhaXMnCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ2phX0pQJywKICAgICAgICBsYWJlbDogJ+aXpeacrOiqnicKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnaXRfSVQnLAogICAgICAgIGxhYmVsOiAnSXRhbGlhbm8nCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ2tvX0tSJywKICAgICAgICBsYWJlbDogJ+2VnOq1reyWtCcKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAncHRfQlInLAogICAgICAgIGxhYmVsOiAnUG9ydHVndcOqcycKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnemhfQ04nLAogICAgICAgIGxhYmVsOiAn5Lit5paHKOeugOS9kyknCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ3poX1RXJywKICAgICAgICBsYWJlbDogJ+S4reaWhyjnuYHpq5QpJwogICAgICB9CiAgICBdOwogICAgcmV0dXJuIGxhbmd1YWdlcy5tYXAoZnVuY3Rpb24obGFuZ3VhZ2UpeyByZXR1cm4gbGFuZ3VhZ2UuaWR9KS5pbmNsdWRlcyhsb2NhbGUpOwogIH0KCiAgY29ubmVjdC5nZXRPcGVyYUJyb3dzZXJWZXJzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHZlcnNpb25PZmZzZXQgPSB1c2VyQWdlbnQuaW5kZXhPZigiT3BlcmEiKTsKICAgIHZhciBvcGVyYVZlcnNpb24gPSAodXNlckFnZW50LmluZGV4T2YoIlZlcnNpb24iKSAhPT0gLTEpID8gdXNlckFnZW50LnN1YnN0cmluZyh2ZXJzaW9uT2Zmc2V0ICsgOCkgOiB1c2VyQWdlbnQuc3Vic3RyaW5nKHZlcnNpb25PZmZzZXQgKyA2KTsKICAgIGlmIChvcGVyYVZlcnNpb24pIHsKICAgICAgcmV0dXJuIHBhcnNlRmxvYXQob3BlcmFWZXJzaW9uKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAtMTsKICAgIH0KICB9OwoKICAvKioKICAgKiBSZXR1cm4gYSBtYXAgb2YgaXRlbXMgaW4gdGhlIGdpdmVuIGxpc3QgaW5kZXhlZCBieQogICAqIGtleXMgZGV0ZXJtaW5lZCBieSB0aGUgY2xvc3VyZSBwcm92aWRlZC4KICAgKgogICAqIEBwYXJhbSBpdGVyYWJsZSBBIGxpc3QtbGlrZSBvYmplY3QuCiAgICogQHBhcmFtIGNsb3N1cmUgQSBjbG9zdXJlIHRvIGRldGVybWluZSB0aGUgaW5kZXggZm9yIHRoZQogICAqICAgIGl0ZW1zIGluIHRoZSBpdGVyYWJsZS4KICAgKiBAcmV0dXJuIEEgbWFwIGZyb20gaW5kZXggdG8gaXRlbSBmb3IgZWFjaCBpdGVtIGluIHRoZSBpdGVyYWJsZS4KICAgKi8KICBjb25uZWN0LmluZGV4ID0gZnVuY3Rpb24gKGl0ZXJhYmxlLCBjbG9zdXJlKSB7CiAgICB2YXIgbWFwID0ge307CgogICAgaXRlcmFibGUuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgewogICAgICBtYXBbY2xvc3VyZShpdGVtKV0gPSBpdGVtOwogICAgfSk7CgogICAgcmV0dXJuIG1hcDsKICB9OwoKICAvKioKICAgKiBDb252ZXJ0cyB0aGUgZ2l2ZW4gYXJyYXkgaW50byBhIG1hcCBhcyBhIHNldCwKICAgKiB3aGVyZSBlbGVtZW50cyBpbiB0aGUgYXJyYXkgYXJlIG1hcHBlZCB0byAxLgogICAqLwogIGNvbm5lY3Quc2V0ID0gZnVuY3Rpb24gKGFycmF5SW4pIHsKICAgIHZhciBzZXRNYXAgPSB7fTsKCiAgICBhcnJheUluLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICBzZXRNYXBba2V5XSA9IDE7CiAgICB9KTsKCiAgICByZXR1cm4gc2V0TWFwOwogIH07CgogIC8qKgogICAqIFJldHVybnMgYSBtYXAgZm9yIGVhY2gga2V5IGluIG1hcEIgd2hpY2gKICAgKiBpcyBOT1QgaW4gbWFwQS4KICAgKi8KICBjb25uZWN0LnJlbGF0aXZlQ29tcGxlbWVudCA9IGZ1bmN0aW9uIChtYXBBLCBtYXBCKSB7CiAgICB2YXIgY29tcE1hcCA9IHt9OwoKICAgIGNvbm5lY3Qua2V5cyhtYXBCKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgaWYgKCEoa2V5IGluIG1hcEEpKSB7CiAgICAgICAgY29tcE1hcFtrZXldID0gbWFwQltrZXldOwogICAgICB9CiAgICB9KTsKCiAgICByZXR1cm4gY29tcE1hcDsKICB9OwoKICAvKioKICAgKiBBc3NlcnRzIHRoYXQgYSBwcmVtaXNlIGlzIHRydWUuCiAgICovCiAgY29ubmVjdC5hc3NlcnRUcnVlID0gZnVuY3Rpb24gKHByZW1pc2UsIG1lc3NhZ2UpIHsKICAgIGlmICghcHJlbWlzZSkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5WYWx1ZUVycm9yKG1lc3NhZ2UpOwogICAgfQogIH07CgogIC8qKgogICAqIEFzc2VydHMgdGhhdCBhIHZhbHVlIGlzIG5vdCBudWxsIG9yIHVuZGVmaW5lZC4KICAgKi8KICBjb25uZWN0LmFzc2VydE5vdE51bGwgPSBmdW5jdGlvbiAodmFsdWUsIG5hbWUpIHsKICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZSh2YWx1ZSAhPSBudWxsICYmIHR5cGVvZiB2YWx1ZSAhPT0gdW5kZWZpbmVkLAogICAgICBjb25uZWN0LnNwcmludGYoIiVzIG11c3QgYmUgcHJvdmlkZWQiLCBuYW1lIHx8ICdBIHZhbHVlJykpOwogICAgcmV0dXJuIHZhbHVlOwogIH07CgogIGNvbm5lY3QuZGVlcGNvcHkgPSBmdW5jdGlvbiAoc3JjKSB7CiAgICByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShzcmMpKTsKICB9OwoKICBjb25uZWN0LmRlZXBjb3B5Q3Jvc3NPcmlnaW5FdmVudCA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICBjb25zdCBvYmogPSB7fTsKICAgIGNvbnN0IGxpc3RPZkFjY2VwdGFibGVLZXlzID0gQ09QWUFCTEVfRVZFTlRfRklFTERTOwogICAgbGlzdE9mQWNjZXB0YWJsZUtleXMuZm9yRWFjaCgoa2V5KSA9PiB7CiAgICAgIHRyeSB7CiAgICAgICAgb2JqW2tleV0gPSBldmVudFtrZXldOwogICAgICB9CiAgICAgIGNhdGNoKGUpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImRlZXBjb3B5Q3Jvc3NPcmlnaW5FdmVudCBmYWlsZWQgb24ga2V5OiAiLCBrZXkpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIGNvbm5lY3QuZGVlcGNvcHkob2JqKTsKICB9CgogIC8qKgogICAqIEdldCB0aGUgY3VycmVudCBiYXNlIHVybCBvZiB0aGUgb3BlbiBwYWdlLCBlLmcuIGlmIHRoZSBwYWdlIGlzCiAgICogaHR0cHM6Ly9leGFtcGxlLmNvbTo5NDk0L29yYW5nZXMsIHRoaXMgd2lsbCBiZSAiaHR0cHM6Ly9leGFtcGxlLmNvbTo5NDk0Ii4KICAgKi8KICBjb25uZWN0LmdldEJhc2VVcmwgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9jYXRpb24gPSBnbG9iYWwubG9jYXRpb247CiAgICByZXR1cm4gY29ubmVjdC5zcHJpbnRmKCIlcy8vJXM6JXMiLCBsb2NhdGlvbi5wcm90b2NvbCwgbG9jYXRpb24uaG9zdG5hbWUsIGxvY2F0aW9uLnBvcnQpOwogIH07CgogIGNvbm5lY3QuZ2V0VXJsV2l0aFByb3RvY29sID0gZnVuY3Rpb24odXJsKSB7CiAgICB2YXIgcHJvdG9jb2wgPSBnbG9iYWwubG9jYXRpb24ucHJvdG9jb2w7CiAgICBpZiAodXJsLnN1YnN0cigwLCBwcm90b2NvbC5sZW5ndGgpICE9PSBwcm90b2NvbCkgewogICAgICByZXR1cm4gY29ubmVjdC5zcHJpbnRmKCIlcy8vJXMiLCBwcm90b2NvbCwgdXJsKTsKICAgIH0KICAgIHJldHVybiB1cmw7CiAgfQoKICAvKioKICAgKiBEZXRlcm1pbmUgaWYgdGhlIGN1cnJlbnQgd2luZG93IGlzIGluIGFuIGlmcmFtZS4KICAgKiBDb3VydGVzeTogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8zMjYwNjkvCiAgICovCiAgY29ubmVjdC5pc0ZyYW1lZCA9IGZ1bmN0aW9uICgpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiB3aW5kb3cuc2VsZiAhPT0gd2luZG93LnRvcDsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5oYXNPdGhlckNvbm5lY3RlZENDUHMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHMgPiAxOwogIH0KCiAgY29ubmVjdC5mZXRjaCA9IGZ1bmN0aW9uIChlbmRwb2ludCwgb3B0aW9ucywgbWlsbGlJbnRlcnZhbCwgbWF4UmV0cnkpIHsKICAgIG1heFJldHJ5ID0gbWF4UmV0cnkgfHwgNTsKICAgIG1pbGxpSW50ZXJ2YWwgPSBtaWxsaUludGVydmFsIHx8IDEwMDA7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGZ1bmN0aW9uIGZldGNoRGF0YShtYXhSZXRyeSkgewogICAgICAgIGZldGNoKGVuZHBvaW50LCBvcHRpb25zKS50aGVuKGZ1bmN0aW9uIChyZXMpIHsKICAgICAgICAgIGlmIChyZXMuc3RhdHVzID09PSBjb25uZWN0LkhUVFBfU1RBVFVTX0NPREVTLlNVQ0NFU1MpIHsKICAgICAgICAgICAgcmVzLmpzb24oKS50aGVuKGpzb24gPT4gcmVzb2x2ZShqc29uKSkuY2F0Y2goKCkgPT4gcmVzb2x2ZSh7fSkpOwogICAgICAgICAgfSBlbHNlIGlmIChtYXhSZXRyeSAhPT0gMSAmJiAocmVzLnN0YXR1cyA+PSBjb25uZWN0LkhUVFBfU1RBVFVTX0NPREVTLklOVEVSTkFMX1NFUlZFUl9FUlJPUiB8fCByZXMuc3RhdHVzID09PSBjb25uZWN0LkhUVFBfU1RBVFVTX0NPREVTLlRPT19NQU5ZX1JFUVVFU1RTKSkgewogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBmZXRjaERhdGEoLS1tYXhSZXRyeSk7CiAgICAgICAgICAgIH0sIG1pbGxpSW50ZXJ2YWwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVqZWN0KHJlcyk7CiAgICAgICAgICB9CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGUpIHsKICAgICAgICAgIHJlamVjdChlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBmZXRjaERhdGEobWF4UmV0cnkpOwogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogQ2FsbGluZyBhIGZ1bmN0aW9uIHdpdGggZXhwb25lbnRpYWwgYmFja29mZiB3aXRoIGZ1bGwgaml0dGVyIHJldHJ5IHN0cmF0ZWd5CiAgICogSXQgd2lsbCByZXRyeSBjYWxsaW5nIHRoZSBmdW5jdGlvbiBmb3IgbWF4aW11bSBtYXhSZXRyeSB0aW1lcyBpZiBpdCBmYWlscy4KICAgKiBTdWNjZXNzIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBmdW5jdGlvbiBzdWNjZWVkZWQuCiAgICogRmFpbHVyZSBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBvbmx5IGlmIHRoZSBsYXN0IHRyeSBmYWlsZWQuCiAgICovCiAgY29ubmVjdC5iYWNrb2ZmID0gZnVuY3Rpb24gKGZ1bmMsIG1pbGxpSW50ZXJ2YWwsIG1heFJldHJ5LCBjYWxsYmFja3MpIHsKICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZnVuYyksICJmdW5jIG11c3QgYmUgYSBGdW5jdGlvbiIpOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHJhdGlvID0gMjsKCiAgICBmdW5jKHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5zdWNjZXNzKSB7CiAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICBpZiAobWF4UmV0cnkgPiAwKSB7CiAgICAgICAgICB2YXIgaW50ZXJ2YWwgPSBtaWxsaUludGVydmFsICogMiAqIE1hdGgucmFuZG9tKCk7CiAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHNlbGYuYmFja29mZihmdW5jLCBpbnRlcnZhbCAqIHJhdGlvLCAtLW1heFJldHJ5LCBjYWxsYmFja3MpOwogICAgICAgICAgfSwgaW50ZXJ2YWwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVyciwgZGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9OwoKICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMgPSBmdW5jdGlvbiAobWV0cmljRGF0YSkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuQ0xJRU5UX01FVFJJQywKICAgICAgZGF0YTogbWV0cmljRGF0YQogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5wdWJsaXNoU29mdHBob25lU3RhdHMgPSBmdW5jdGlvbihzdGF0cykgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuU09GVFBIT05FX1NUQVRTLAogICAgICBkYXRhOiBzdGF0cwogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5wdWJsaXNoU29mdHBob25lUmVwb3J0ID0gZnVuY3Rpb24ocmVwb3J0KSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5TT0ZUUEhPTkVfUkVQT1JULAogICAgICBkYXRhOiByZXBvcnQKICAgIH0pOwogIH07CgogIGNvbm5lY3QucHVibGlzaENsaWVudFNpZGVMb2dzID0gZnVuY3Rpb24obG9ncykgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuQ0xJRU5UX1NJREVfTE9HUywgbG9ncyk7CiAgfTsKCiAgLyoqCiAgICogQSB3cmFwcGVyIGFyb3VuZCBXaW5kb3cub3BlbigpIGZvciBtYW5hZ2luZyBzaW5nbGUgaW5zdGFuY2UgcG9wdXBzLgogICAqLwogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyID0gZnVuY3Rpb24gKCkgeyB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUub3BlbiA9IGZ1bmN0aW9uICh1cmwsIG5hbWUsIG9wdGlvbnMpIHsKICAgIHZhciB0aGVuID0gdGhpcy5fZ2V0TGFzdE9wZW5lZFRpbWVzdGFtcChuYW1lKTsKICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIHZhciB3aW4gPSBudWxsOwogICAgaWYgKG5vdyAtIHRoZW4gPiBPTkVfREFZX01JTExJUykgewogICAgICBpZiAob3B0aW9ucykgewogICAgICAgIC8vIGRlZmF1bHQgdmFsdWVzIGFyZSBjaG9zZW4gdG8gcHJvdmlkZSBhIG1pbmltdW0gaGVpZ2h0IHdpdGhvdXQgc2Nyb2xsaW5nCiAgICAgICAgLy8gYW5kIGEgdW5pZm9ybSBtYXJnaW4gYmFzZWQgb24gdGhlIGNzcyBvZiB0aGUgY2NwIGxvZ2luIHBhZ2UKICAgICAgICB2YXIgaGVpZ2h0ID0gb3B0aW9ucy5oZWlnaHQgfHwgREVGQVVMVF9QT1BVUF9IRUlHSFQ7CiAgICAgICAgdmFyIHdpZHRoID0gb3B0aW9ucy53aWR0aCB8fCBERUZBVUxUX1BPUFVQX1dJRFRIOwogICAgICAgIHZhciB0b3AgPSBvcHRpb25zLnRvcCB8fCAwOwogICAgICAgIHZhciBsZWZ0ID0gb3B0aW9ucy5sZWZ0IHx8IDA7CiAgICAgICAgd2luID0gd2luZG93Lm9wZW4oJycsIG5hbWUsICJ3aWR0aD0iK3dpZHRoKyIsIGhlaWdodD0iK2hlaWdodCsiLCB0b3A9Iit0b3ArIiwgbGVmdD0iK2xlZnQpOwogICAgICAgIGlmICh3aW4ubG9jYXRpb24gIT09IHVybCkgewogICAgICAgICAgd2luID0gd2luZG93Lm9wZW4odXJsLCBuYW1lLCAid2lkdGg9Iit3aWR0aCsiLCBoZWlnaHQ9IitoZWlnaHQrIiwgdG9wPSIrdG9wKyIsIGxlZnQ9IitsZWZ0KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2luID0gd2luZG93Lm9wZW4oJycsIG5hbWUpOwogICAgICAgIGlmICh3aW4ubG9jYXRpb24gIT09IHVybCkgewogICAgICAgICAgd2luID0gd2luZG93Lm9wZW4odXJsLCBuYW1lKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5fc2V0TGFzdE9wZW5lZFRpbWVzdGFtcChuYW1lLCBub3cpOwogICAgfQogICAgcmV0dXJuIHdpbjsKICB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAobmFtZSkgewogICAgdmFyIGtleSA9IHRoaXMuX2dldExvY2FsU3RvcmFnZUtleShuYW1lKTsKICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShrZXkpOwogIH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5fZ2V0TGFzdE9wZW5lZFRpbWVzdGFtcCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICB2YXIga2V5ID0gdGhpcy5fZ2V0TG9jYWxTdG9yYWdlS2V5KG5hbWUpOwogICAgdmFyIHZhbHVlID0gZ2xvYmFsLmxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSk7CgogICAgaWYgKHZhbHVlKSB7CiAgICAgIHJldHVybiBwYXJzZUludCh2YWx1ZSwgMTApOwoKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAwOwogICAgfQogIH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5fc2V0TGFzdE9wZW5lZFRpbWVzdGFtcCA9IGZ1bmN0aW9uIChuYW1lLCB0cykgewogICAgdmFyIGtleSA9IHRoaXMuX2dldExvY2FsU3RvcmFnZUtleShuYW1lKTsKICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXksICcnICsgdHMpOwogIH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5fZ2V0TG9jYWxTdG9yYWdlS2V5ID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgIHJldHVybiAiY29ubmVjdFBvcHVwTWFuYWdlcjo6IiArIG5hbWU7CiAgfTsKCiAgLyoqCiAgICogQW4gZW51bWVyYXRpb24gb2YgdGhlIEhUTUw1IG5vdGlmaWNhdGlvbiBwZXJtaXNzaW9uIHZhbHVlcy4KICAgKi8KICB2YXIgTm90aWZpY2F0aW9uUGVybWlzc2lvbiA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2dyYW50ZWQnLAogICAgJ2RlbmllZCcsCiAgICAnZGVmYXVsdCcKICBdKTsKCiAgLyoqCiAgICogQSBzaW1wbGUgZW5naW5lIGZvciBzaG93aW5nIG5vdGlmaWNhdGlvbiBwb3B1cHMuCiAgICovCiAgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5xdWV1ZSA9IFtdOwogICAgdGhpcy5wZXJtaXNzaW9uID0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5ERUZBVUxUOwogIH07CgogIGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlci5wcm90b3R5cGUucmVxdWVzdFBlcm1pc3Npb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZiAoISgiTm90aWZpY2F0aW9uIiBpbiBnbG9iYWwpKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiVGhpcyBicm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBub3RpZmljYXRpb25zLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHRoaXMucGVybWlzc2lvbiA9IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uREVOSUVEOwoKICAgIH0gZWxzZSBpZiAoZ2xvYmFsLk5vdGlmaWNhdGlvbi5wZXJtaXNzaW9uID09PSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkRFTklFRCkgewogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIlRoZSB1c2VyIGhhcyByZXF1ZXN0ZWQgdG8gbm90IHJlY2VpdmUgbm90aWZpY2F0aW9ucy4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB0aGlzLnBlcm1pc3Npb24gPSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkRFTklFRDsKCiAgICB9IGVsc2UgaWYgKHRoaXMucGVybWlzc2lvbiAhPT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5HUkFOVEVEKSB7CiAgICAgIGdsb2JhbC5Ob3RpZmljYXRpb24ucmVxdWVzdFBlcm1pc3Npb24oKS50aGVuKGZ1bmN0aW9uIChwZXJtaXNzaW9uKSB7CiAgICAgICAgc2VsZi5wZXJtaXNzaW9uID0gcGVybWlzc2lvbjsKICAgICAgICBpZiAocGVybWlzc2lvbiA9PT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5HUkFOVEVEKSB7CiAgICAgICAgICBzZWxmLl9zaG93UXVldWVkKCk7CgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxmLnF1ZXVlID0gW107CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwoKICBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIucHJvdG90eXBlLnNob3cgPSBmdW5jdGlvbiAodGl0bGUsIG9wdGlvbnMpIHsKICAgIGlmICh0aGlzLnBlcm1pc3Npb24gPT09IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uR1JBTlRFRCkgewogICAgICByZXR1cm4gdGhpcy5fc2hvd0ltcGwoeyB0aXRsZTogdGl0bGUsIG9wdGlvbnM6IG9wdGlvbnMgfSk7CgogICAgfSBlbHNlIGlmICh0aGlzLnBlcm1pc3Npb24gPT09IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uREVOSUVEKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiVW5hYmxlIHRvIHNob3cgbm90aWZpY2F0aW9uLiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICB0aXRsZTogdGl0bGUsCiAgICAgICAgICBvcHRpb25zOiBvcHRpb25zCiAgICAgICAgfSk7CgogICAgfSBlbHNlIHsKICAgICAgdmFyIHBhcmFtcyA9IHsgdGl0bGU6IHRpdGxlLCBvcHRpb25zOiBvcHRpb25zIH07CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiRGVmZXJyaW5nIG5vdGlmaWNhdGlvbiB1bnRpbCB1c2VyIGRlY2lkZXMgdG8gYWxsb3cgb3IgZGVueS4iKQogICAgICAgIC53aXRoT2JqZWN0KHBhcmFtcykKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgdGhpcy5xdWV1ZS5wdXNoKHBhcmFtcyk7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyLnByb3RvdHlwZS5fc2hvd1F1ZXVlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBub3RpZmljYXRpb25zID0gdGhpcy5xdWV1ZS5tYXAoZnVuY3Rpb24gKHBhcmFtcykgewogICAgICByZXR1cm4gc2VsZi5fc2hvd0ltcGwocGFyYW1zKTsKICAgIH0pOwogICAgdGhpcy5xdWV1ZSA9IFtdOwogICAgcmV0dXJuIG5vdGlmaWNhdGlvbnM7CiAgfTsKCiAgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyLnByb3RvdHlwZS5fc2hvd0ltcGwgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICB2YXIgbm90aWZpY2F0aW9uID0gbmV3IGdsb2JhbC5Ob3RpZmljYXRpb24ocGFyYW1zLnRpdGxlLCBwYXJhbXMub3B0aW9ucyk7CiAgICBpZiAocGFyYW1zLm9wdGlvbnMuY2xpY2tlZCkgewogICAgICBub3RpZmljYXRpb24ub25jbGljayA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBwYXJhbXMub3B0aW9ucy5jbGlja2VkLmNhbGwobm90aWZpY2F0aW9uKTsKICAgICAgfTsKICAgIH0KICAgIHJldHVybiBub3RpZmljYXRpb247CiAgfTsKCiAgY29ubmVjdC5CYXNlRXJyb3IgPSBmdW5jdGlvbiAoZm9ybWF0LCBhcmdzKSB7CiAgICBnbG9iYWwuRXJyb3IuY2FsbCh0aGlzLCBjb25uZWN0LnZzcHJpbnRmKGZvcm1hdCwgYXJncykpOwogIH07CiAgY29ubmVjdC5CYXNlRXJyb3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShFcnJvci5wcm90b3R5cGUpOwogIGNvbm5lY3QuQmFzZUVycm9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGNvbm5lY3QuQmFzZUVycm9yOwoKICBjb25uZWN0LlZhbHVlRXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICB2YXIgZm9ybWF0ID0gYXJncy5zaGlmdCgpOwogICAgY29ubmVjdC5CYXNlRXJyb3IuY2FsbCh0aGlzLCBmb3JtYXQsIGFyZ3MpOwogIH07CiAgY29ubmVjdC5WYWx1ZUVycm9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoY29ubmVjdC5CYXNlRXJyb3IucHJvdG90eXBlKTsKICBjb25uZWN0LlZhbHVlRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gY29ubmVjdC5WYWx1ZUVycm9yOwoKICBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICB2YXIgZm9ybWF0ID0gYXJncy5zaGlmdCgpOwogICAgY29ubmVjdC5CYXNlRXJyb3IuY2FsbCh0aGlzLCBmb3JtYXQsIGFyZ3MpOwogIH07CiAgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoY29ubmVjdC5CYXNlRXJyb3IucHJvdG90eXBlKTsKICBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yOwoKICBjb25uZWN0LlN0YXRlRXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICB2YXIgZm9ybWF0ID0gYXJncy5zaGlmdCgpOwogICAgY29ubmVjdC5CYXNlRXJyb3IuY2FsbCh0aGlzLCBmb3JtYXQsIGFyZ3MpOwogIH07CiAgY29ubmVjdC5TdGF0ZUVycm9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoY29ubmVjdC5CYXNlRXJyb3IucHJvdG90eXBlKTsKICBjb25uZWN0LlN0YXRlRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gY29ubmVjdC5TdGF0ZUVycm9yOwoKICBjb25uZWN0LlZvaWNlSWRFcnJvciA9IGZ1bmN0aW9uKHR5cGUsIG1lc3NhZ2UsIGVycil7CiAgICB2YXIgZXJyb3IgPSB7fTsKICAgIGVycm9yLnR5cGUgPSB0eXBlOwogICAgZXJyb3IubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICBlcnJvci5zdGFjayA9IEVycm9yKG1lc3NhZ2UpLnN0YWNrOwogICAgZXJyb3IuZXJyID0gZXJyOwogICAgcmV0dXJuIGVycm9yOwogIH0KCiAgLy8gaW50ZXJuYWwgdXNlIG9ubHkKICBjb25uZWN0LmlzQ0NQID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgIHJldHVybiBjb25kdWl0Lm5hbWUgPT09ICdDb25uZWN0U2hhcmVkV29ya2VyQ29uZHVpdCc7CiAgfQp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gNzM2OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgY29ubmVjdC53b3JrZXIgPSB7fTsKCiAgdmFyIEdFVF9BR0VOVF9USU1FT1VUX01TID0gMzAwMDA7CiAgdmFyIEdFVF9BR0VOVF9SRUNPVkVSWV9USU1FT1VUX01TID0gNTAwMDsKICB2YXIgR0VUX0FHRU5UX1NVQ0NFU1NfVElNRU9VVF9NUyA9IDEwMDsKICB2YXIgTE9HX0JVRkZFUl9DQVBfU0laRSA9IDQwMDsKCiAgdmFyIENIRUNLX0FVVEhfVE9LRU5fSU5URVJWQUxfTVMgPSAzMDAwMDA7IC8vIDUgbWludXRzCiAgdmFyIFJFRlJFU0hfQVVUSF9UT0tFTl9JTlRFUlZBTF9NUyA9IDEwMDAwOyAvLyAxMCBzZWNvbmRzCiAgdmFyIFJFRlJFU0hfQVVUSF9UT0tFTl9NQVhfVFJZID0gNDsKCiAgdmFyIEdFVF9BR0VOVF9DT05GSUdVUkFUSU9OX0lOVEVSVkFMX01TID0gMzAwMDA7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICB2YXIgTWFzdGVyVG9waWNDb29yZGluYXRvciA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMudG9waWNNYXN0ZXJNYXAgPSB7fTsKICB9OwoKICBNYXN0ZXJUb3BpY0Nvb3JkaW5hdG9yLnByb3RvdHlwZS5nZXRNYXN0ZXIgPSBmdW5jdGlvbiAodG9waWMpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b3BpYywgJ3RvcGljJyk7CiAgICByZXR1cm4gdGhpcy50b3BpY01hc3Rlck1hcFt0b3BpY10gfHwgbnVsbDsKICB9OwoKICBNYXN0ZXJUb3BpY0Nvb3JkaW5hdG9yLnByb3RvdHlwZS5zZXRNYXN0ZXIgPSBmdW5jdGlvbiAodG9waWMsIGlkKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWMsICd0b3BpYycpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGlkLCAnaWQnKTsKICAgIHRoaXMudG9waWNNYXN0ZXJNYXBbdG9waWNdID0gaWQ7CiAgfTsKCiAgTWFzdGVyVG9waWNDb29yZGluYXRvci5wcm90b3R5cGUucmVtb3ZlTWFzdGVyID0gZnVuY3Rpb24gKGlkKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoaWQsICdpZCcpOwogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIGNvbm5lY3QuZW50cmllcyh0aGlzLnRvcGljTWFzdGVyTWFwKS5maWx0ZXIoZnVuY3Rpb24gKGVudHJ5KSB7CiAgICAgIHJldHVybiBlbnRyeS52YWx1ZSA9PT0gaWQ7CiAgICB9KS5mb3JFYWNoKGZ1bmN0aW9uIChlbnRyeSkgewogICAgICBkZWxldGUgc2VsZi50b3BpY01hc3Rlck1hcFtlbnRyeS5rZXldOwogICAgfSk7CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgV29ya2VyQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAqLwogIHZhciBXb3JrZXJDbGllbnQgPSBmdW5jdGlvbiAoY29uZHVpdCkgewogICAgY29ubmVjdC5DbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgICB0aGlzLmNvbmR1aXQgPSBjb25kdWl0OwogIH07CiAgV29ya2VyQ2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoY29ubmVjdC5DbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgV29ya2VyQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFdvcmtlckNsaWVudDsKCiAgV29ya2VyQ2xpZW50LnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbiAobWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHJlcXVlc3Rfc3RhcnQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIGlmKGNvbm5lY3QuY29udGFpbnNWYWx1ZShjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcywgbWV0aG9kKSkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRBcHBDbGllbnQoKS5fY2FsbEltcGwobWV0aG9kLCBwYXJhbXMsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQpOwogICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgIHNlbGYuX3JlY29yZEFQSUxhdGVuY3kobWV0aG9kLCByZXF1ZXN0X3N0YXJ0LCBlcnJvcik7CiAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvcik7CiAgICAgICAgfQogICAgICB9KQogICAgfSBlbHNlIHsKICAgICAgY29ubmVjdC5jb3JlLmdldENsaWVudCgpLl9jYWxsSW1wbChtZXRob2QsIHBhcmFtcywgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCk7CiAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnJvciwgZGF0YSkgewogICAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQsIGVycm9yKTsKICAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVycm9yLCBkYXRhKTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCk7CiAgICAgICAgICBjYWxsYmFja3MuYXV0aEZhaWx1cmUoKTsKICAgICAgICB9LAogICAgICAgIGFjY2Vzc0RlbmllZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgY2FsbGJhY2tzLmFjY2Vzc0RlbmllZCAmJiBjYWxsYmFja3MuYWNjZXNzRGVuaWVkKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIAogIH07CgogIFdvcmtlckNsaWVudC5wcm90b3R5cGUuX3JlY29yZEFQSUxhdGVuY3kgPSBmdW5jdGlvbiAobWV0aG9kLCByZXF1ZXN0X3N0YXJ0LCBlcnIpIHsKICAgIHZhciByZXF1ZXN0X2VuZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgdmFyIHJlcXVlc3RfdGltZSA9IHJlcXVlc3RfZW5kIC0gcmVxdWVzdF9zdGFydDsKICAgIHRoaXMuX3NlbmRBUElNZXRyaWNzKG1ldGhvZCwgcmVxdWVzdF90aW1lLCBlcnIpOwogIH07CgogIFdvcmtlckNsaWVudC5wcm90b3R5cGUuX3NlbmRBUElNZXRyaWNzID0gZnVuY3Rpb24gKG1ldGhvZCwgdGltZSwgZXJyKSB7CiAgICB0aGlzLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVBJX01FVFJJQywgewogICAgICBuYW1lOiBtZXRob2QsCiAgICAgIHRpbWU6IHRpbWUsCiAgICAgIGRpbWVuc2lvbnM6IFsKICAgICAgICB7CiAgICAgICAgICBuYW1lOiAiQ2F0ZWdvcnkiLAogICAgICAgICAgdmFsdWU6ICJBUEkiCiAgICAgICAgfQogICAgICBdLAogICAgICBlcnJvcjogZXJyCiAgICB9KTsKICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogVGhlIG9iamVjdCByZXNwb25zaWJsZSBmb3IgcG9sbGluZyBhbmQgcGFzc2luZyBkYXRhIGRvd25zdHJlYW0gdG8gYWxsCiAgICogY29uc3VtZXIgcG9ydHMuCiAgICovCiAgdmFyIENsaWVudEVuZ2luZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB0aGlzLm11bHRpcGxleGVyID0gbmV3IGNvbm5lY3QuU3RyZWFtTXVsdGlwbGV4ZXIoKTsKICAgIHRoaXMuY29uZHVpdCA9IG5ldyBjb25uZWN0LkNvbmR1aXQoIkFtYXpvbkNvbm5lY3RTaGFyZWRXb3JrZXIiLCBudWxsLCB0aGlzLm11bHRpcGxleGVyKTsKICAgIHRoaXMuY2xpZW50ID0gbmV3IFdvcmtlckNsaWVudCh0aGlzLmNvbmR1aXQpOwogICAgdGhpcy50aW1lb3V0ID0gbnVsbDsKICAgIHRoaXMuYWdlbnQgPSBudWxsOwogICAgdGhpcy5uZXh0VG9rZW4gPSBudWxsOwogICAgdGhpcy5pbml0RGF0YSA9IHt9OwogICAgdGhpcy5wb3J0Q29uZHVpdE1hcCA9IHt9OwogICAgdGhpcy5tYXN0ZXJDb29yZCA9IG5ldyBNYXN0ZXJUb3BpY0Nvb3JkaW5hdG9yKCk7CiAgICB0aGlzLmxvZ3NCdWZmZXIgPSBbXTsKICAgIHRoaXMuc3VwcHJlc3MgPSBmYWxzZTsKICAgIHRoaXMuZm9yY2VPZmZsaW5lID0gZmFsc2U7CgogICAgdmFyIHdlYlNvY2tldE1hbmFnZXIgPSBudWxsOwoKICAgIGNvbm5lY3Qucm9vdExvZ2dlciA9IG5ldyBjb25uZWN0LkRvd25zdHJlYW1Db25kdWl0TG9nZ2VyKHRoaXMuY29uZHVpdCk7CgogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TRU5EX0xPR1MsIGZ1bmN0aW9uIChsb2dzVG9VcGxvYWQpIHsKICAgICAgLy8gQWRkIHNvZnRwaG9uZSBsb2dzIGRvd25zdHJlYW0KICAgICAgY29ubmVjdC5nZXRMb2coKS5wdXNoTG9nc0Rvd25zdHJlYW0obG9nc1RvVXBsb2FkKTsKCiAgICAgIHNlbGYubG9nc0J1ZmZlciA9IHNlbGYubG9nc0J1ZmZlci5jb25jYXQobG9nc1RvVXBsb2FkKTsKICAgICAgLy9vbmx5IGNhbGwgQVBJIHRvIHNlbmQgbG9ncyBpZiBidWZmZXIgcmVhY2hlZCBjYXAKICAgICAgaWYgKHNlbGYubG9nc0J1ZmZlci5sZW5ndGggPiBMT0dfQlVGRkVSX0NBUF9TSVpFKSB7CiAgICAgICAgc2VsZi5oYW5kbGVTZW5kTG9nc1JlcXVlc3Qoc2VsZi5sb2dzQnVmZmVyKTsKICAgICAgfQogICAgfSk7CgogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuU1VQUFJFU1MsIGZ1bmN0aW9uIChkYXRhKXsKICAgICAgY29ubmVjdC5nZXRMb2coKS5kZWJ1ZygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBTZXR0aW5nIFN1cHByZXNzIHRvICVzIiwgZGF0YS5zdXBwcmVzcykKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgc2VsZi5zdXBwcmVzcyA9IGRhdGEuc3VwcHJlc3MgfHwgZmFsc2U7CiAgICAgIC8vc2lnbmFsIG90aGVyIHdpbmRvd3MgdGhhdCBhIGZhaWxvdmVyIGhhcHBlbmVkCiAgICAgIGlmIChzZWxmLm1hc3RlckNvb3JkLmdldE1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUpKSB7CiAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GQUlMT1ZFUiwgewogICAgICAgICAgaXNQcmltYXJ5OiAhc2VsZi5zdXBwcmVzcwogICAgICAgIH0pOyAgICAgIAogICAgICB9CiAgICB9KTsKCiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GT1JDRV9PRkZMSU5FLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBjb25uZWN0LmdldExvZygpLmRlYnVnKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIFNldHRpbmcgRk9SQ0VfT0ZGTElORSB0byAlcyIsIGRhdGEub2ZmbGluZSkKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgc2VsZi5mb3JjZU9mZmxpbmUgPSBkYXRhLm9mZmxpbmUgfHwgZmFsc2U7CiAgICB9KTsKCiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgaWYgKGRhdGEuYXV0aFRva2VuICYmIGRhdGEuYXV0aFRva2VuICE9PSBzZWxmLmluaXREYXRhLmF1dGhUb2tlbikgewogICAgICAgIHNlbGYuaW5pdERhdGEgPSBkYXRhOwogICAgICAgIGNvbm5lY3QuY29yZS5pbml0KGRhdGEpOwogICAgICAgIC8vIGluaXQgb25seSBvbmNlLgogICAgICAgIGlmICghd2ViU29ja2V0TWFuYWdlcikgewoKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQ3JlYXRpbmcgYSBuZXcgV2Vic29ja2V0IGNvbm5lY3Rpb24gZm9yIENDUCIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgICAgIGNvbm5lY3QuV2ViU29ja2V0TWFuYWdlci5zZXRHbG9iYWxDb25maWcoewogICAgICAgICAgICBsb2dnZXJDb25maWc6IHsgbG9nZ2VyOiBjb25uZWN0LmdldExvZygpIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIgPSBjb25uZWN0LldlYlNvY2tldE1hbmFnZXIuY3JlYXRlKCk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkluaXRGYWlsdXJlKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLklOSVRfRkFJTFVSRSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uQ29ubmVjdGlvbk9wZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX09QRU4sIHJlc3BvbnNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25Db25uZWN0aW9uQ2xvc2UoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0NMT1NFLCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uQ29ubmVjdGlvbkdhaW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5BZ2VudEV2ZW50cy5XRUJTT0NLRVRfQ09OTkVDVElPTl9HQUlORUQpOwogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9HQUlOKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25Db25uZWN0aW9uTG9zdChmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuQWdlbnRFdmVudHMuV0VCU09DS0VUX0NPTk5FQ1RJT05fTE9TVCwgcmVzcG9uc2UpOwogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9MT1NULCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uU3Vic2NyaXB0aW9uVXBkYXRlKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSVBUSU9OX1VQREFURSwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vblN1YnNjcmlwdGlvbkZhaWx1cmUoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJUFRJT05fRkFJTFVSRSwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkFsbE1lc3NhZ2UoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5BTExfTUVTU0FHRSwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgc2VsZi5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TRU5ELCBmdW5jdGlvbiAobWVzc2FnZSkgewogICAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLnNlbmRNZXNzYWdlKG1lc3NhZ2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgc2VsZi5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJQkUsIGZ1bmN0aW9uICh0b3BpY3MpIHsKICAgICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5zdWJzY3JpYmVUb3BpY3ModG9waWNzKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIuaW5pdChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuZ2V0V2ViU29ja2V0VXJsKSkudGhlbihmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGlmIChyZXNwb25zZSAmJiAhcmVzcG9uc2Uud2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZCkgewogICAgICAgICAgICAgICAgLy8gU3RhcnQgcG9sbGluZyBmb3IgYWdlbnQgZGF0YS4KICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiS2lja2luZyBvZmYgYWdlbnQgcG9sbGluZyIpCiAgICAgICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnQoKTsKICAKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiS2lja2luZyBvZmYgY29uZmlnIHBvbGxpbmciKQogICAgICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHNlbGYucG9sbEZvckFnZW50Q29uZmlndXJhdGlvbih7IHJlcGVhdEZvcmV2ZXI6IHRydWUgfSk7CiAgCiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIktpY2tpbmcgb2ZmIGF1dGggdG9rZW4gcG9sbGluZyIpCiAgICAgICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgZ2xvYmFsLnNldEludGVydmFsKGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5jaGVja0F1dGhUb2tlbiksIENIRUNLX0FVVEhfVE9LRU5fSU5URVJWQUxfTVMpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWNvbm5lY3Qud2ViU29ja2V0SW5pdEZhaWxlZCkgewogICAgICAgICAgICAgICAgICBjb25zdCBldmVudCA9IGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLklOSVRfRkFJTFVSRTsKICAgICAgICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGV2ZW50KTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC53ZWJTb2NrZXRJbml0RmFpbGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGV2ZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJXZWJTb2NrZXQgZmFpbGVkIHRvIGluaXRpYWxpemUiKQogICAgICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZSkKICAgICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJOb3QgSW5pdGlhbGl6aW5nIGEgbmV3IFdlYnNvY2tldE1hbmFnZXIgaW5zdGFuY2UsIHNpbmNlIG9uZSBhbHJlYWR5IGV4aXN0cyIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURSwgZnVuY3Rpb24gKCkgewogICAgICAvL3VwbG9hZCBwZW5kaW5nIGxvZ3MgYmVmb3JlIHRlcm1pbmF0aW5nLgogICAgICBzZWxmLmhhbmRsZVNlbmRMb2dzUmVxdWVzdChzZWxmLmxvZ3NCdWZmZXIpOwogICAgICBjb25uZWN0LmNvcmUudGVybWluYXRlKCk7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5URVJNSU5BVEVEKTsKICAgIH0pOwogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TWU5DSFJPTklaRSwgZnVuY3Rpb24gKCkgewogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UpOwogICAgfSk7CiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGRhdGEuZXZlbnQsIGRhdGEuZGF0YSk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIENhbGxlZCB3aGVuIGEgY29uc3VtZXIgcG9ydCBjb25uZWN0cyB0byB0aGlzIFNoYXJlZFdvcmtlci4KICAgICAqIExldCdzIGFkZCB0aGVtIHRvIG91ciBtdWx0aXBsZXhlci4KICAgICAqLwogICAgZ2xvYmFsLm9uY29ubmVjdCA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICB2YXIgcG9ydCA9IGV2ZW50LnBvcnRzWzBdOwogICAgICB2YXIgc3RyZWFtID0gbmV3IGNvbm5lY3QuUG9ydFN0cmVhbShwb3J0KTsKICAgICAgc2VsZi5tdWx0aXBsZXhlci5hZGRTdHJlYW0oc3RyZWFtKTsKICAgICAgcG9ydC5zdGFydCgpOwoKICAgICAgdmFyIHBvcnRDb25kdWl0ID0gbmV3IGNvbm5lY3QuQ29uZHVpdChzdHJlYW0uZ2V0SWQoKSwgbnVsbCwgc3RyZWFtKTsKICAgICAgcG9ydENvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsIHsgaWQ6IHN0cmVhbS5nZXRJZCgpIH0pOwoKICAgICAgc2VsZi5wb3J0Q29uZHVpdE1hcFtzdHJlYW0uZ2V0SWQoKV0gPSBwb3J0Q29uZHVpdDsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlVQREFURV9DT05ORUNURURfQ0NQUywgeyBsZW5ndGg6IE9iamVjdC5rZXlzKHNlbGYucG9ydENvbmR1aXRNYXApLmxlbmd0aCB9KTsKCiAgICAgIGlmIChzZWxmLmFnZW50ICE9PSBudWxsKSB7CiAgICAgICAgc2VsZi51cGRhdGVBZ2VudCgpOwogICAgICB9CgogICAgICBwb3J0Q29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVBJX1JFUVVFU1QsCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFQSVJlcXVlc3QsIHBvcnRDb25kdWl0KSk7CiAgICAgIHBvcnRDb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVRVUVTVCwKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlTWFzdGVyUmVxdWVzdCwgcG9ydENvbmR1aXQsIHN0cmVhbS5nZXRJZCgpKSk7CiAgICAgIHBvcnRDb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5SRUxPQURfQUdFTlRfQ09ORklHVVJBVElPTiwKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYucG9sbEZvckFnZW50Q29uZmlndXJhdGlvbikpOwogICAgICBwb3J0Q29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQ0xPU0UsIGZ1bmN0aW9uICgpIHsKICAgICAgICBzZWxmLm11bHRpcGxleGVyLnJlbW92ZVN0cmVhbShzdHJlYW0pOwogICAgICAgIGRlbGV0ZSBzZWxmLnBvcnRDb25kdWl0TWFwW3N0cmVhbS5nZXRJZCgpXTsKICAgICAgICBzZWxmLm1hc3RlckNvb3JkLnJlbW92ZU1hc3RlcihzdHJlYW0uZ2V0SWQoKSk7CiAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlVQREFURV9DT05ORUNURURfQ0NQUywgeyBsZW5ndGg6IE9iamVjdC5rZXlzKHNlbGYucG9ydENvbmR1aXRNYXApLmxlbmd0aCB9KTsKICAgICAgfSk7CiAgICB9OwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvckFnZW50ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIG9uQXV0aEZhaWwgPSBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9BR0VOVF9TTkFQU0hPVCwgewogICAgICBuZXh0VG9rZW46IHNlbGYubmV4dFRva2VuLAogICAgICB0aW1lb3V0OiBHRVRfQUdFTlRfVElNRU9VVF9NUwogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZWxmLmFnZW50ID0gc2VsZi5hZ2VudCB8fCB7fTsKICAgICAgICAgICAgc2VsZi5hZ2VudC5zbmFwc2hvdCA9IGRhdGEuc25hcHNob3Q7CiAgICAgICAgICAgIHNlbGYuYWdlbnQuc25hcHNob3QubG9jYWxUaW1lc3RhbXAgPSBjb25uZWN0Lm5vdygpOwogICAgICAgICAgICBzZWxmLmFnZW50LnNuYXBzaG90LnNrZXcgPSBzZWxmLmFnZW50LnNuYXBzaG90LnNuYXBzaG90VGltZXN0YW1wIC0gc2VsZi5hZ2VudC5zbmFwc2hvdC5sb2NhbFRpbWVzdGFtcDsKICAgICAgICAgICAgc2VsZi5uZXh0VG9rZW4gPSBkYXRhLm5leHRUb2tlbjsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiR0VUX0FHRU5UX1NOQVBTSE9UIHN1Y2NlZWRlZC4iKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpCiAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHNlbGYudXBkYXRlQWdlbnQoKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiTG9uZyBwb2xsIGZhaWxlZCB0byB1cGRhdGUgYWdlbnQuIikKICAgICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKQogICAgICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGUpCiAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYucG9sbEZvckFnZW50KSwgR0VUX0FHRU5UX1NVQ0NFU1NfVElNRU9VVF9NUyk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZ2V0IGFnZW50IGRhdGEuIikKICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5wb2xsRm9yQWdlbnQpLCBHRVRfQUdFTlRfUkVDT1ZFUllfVElNRU9VVF9NUyk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgb25BdXRoRmFpbCgpOwogICAgICAgIH0sCiAgICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQoKICAgICAgfSk7CgogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvckFnZW50Q29uZmlndXJhdGlvbiA9IGZ1bmN0aW9uIChwYXJhbXNJbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgdmFyIG9uQXV0aEZhaWwgPSBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9BR0VOVF9DT05GSUdVUkFUSU9OLCB7fSwgewogICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIHZhciBjb25maWd1cmF0aW9uID0gZGF0YS5jb25maWd1cmF0aW9uOwogICAgICAgIHNlbGYucG9sbEZvckFnZW50UGVybWlzc2lvbnMoY29uZmlndXJhdGlvbik7CiAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnRTdGF0ZXMoY29uZmlndXJhdGlvbik7CiAgICAgICAgc2VsZi5wb2xsRm9yRGlhbGFibGVDb3VudHJ5Q29kZXMoY29uZmlndXJhdGlvbik7CiAgICAgICAgc2VsZi5wb2xsRm9yUm91dGluZ1Byb2ZpbGVRdWV1ZXMoY29uZmlndXJhdGlvbik7CiAgICAgICAgaWYgKHBhcmFtcy5yZXBlYXRGb3JldmVyKSB7CiAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYucG9sbEZvckFnZW50Q29uZmlndXJhdGlvbiwgcGFyYW1zKSwKICAgICAgICAgICAgR0VUX0FHRU5UX0NPTkZJR1VSQVRJT05fSU5URVJWQUxfTVMpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggYWdlbnQgY29uZmlndXJhdGlvbiBkYXRhLiIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpZiAocGFyYW1zLnJlcGVhdEZvcmV2ZXIpIHsKICAgICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLnBvbGxGb3JBZ2VudENvbmZpZ3VyYXRpb24pLAogICAgICAgICAgICAgIEdFVF9BR0VOVF9DT05GSUdVUkFUSU9OX0lOVEVSVkFMX01TLCBwYXJhbXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgYXV0aEZhaWx1cmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICBvbkF1dGhGYWlsKCk7CiAgICAgIH0sCiAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvckFnZW50U3RhdGVzID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24sIHBhcmFtc0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICBwYXJhbXMubWF4UmVzdWx0cyA9IHBhcmFtcy5tYXhSZXN1bHRzIHx8IGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9BR0VOVF9TVEFURVMsIHsKICAgICAgbmV4dFRva2VuOiBwYXJhbXMubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCgogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnRTdGF0ZXMoY29uZmlndXJhdGlvbiwgewogICAgICAgICAgICAgIHN0YXRlczogKHBhcmFtcy5zdGF0ZXMgfHwgW10pLmNvbmNhdChkYXRhLnN0YXRlcyksCiAgICAgICAgICAgICAgbmV4dFRva2VuOiBkYXRhLm5leHRUb2tlbiwKICAgICAgICAgICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgICAgICAgICB9KTsKCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25maWd1cmF0aW9uLmFnZW50U3RhdGVzID0gKHBhcmFtcy5zdGF0ZXMgfHwgW10pLmNvbmNhdChkYXRhLnN0YXRlcyk7CiAgICAgICAgICAgIHNlbGYudXBkYXRlQWdlbnRDb25maWd1cmF0aW9uKGNvbmZpZ3VyYXRpb24pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIGFnZW50IHN0YXRlcyBsaXN0LiIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCksCiAgICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQogICAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JBZ2VudFBlcm1pc3Npb25zID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24sIHBhcmFtc0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICBwYXJhbXMubWF4UmVzdWx0cyA9IHBhcmFtcy5tYXhSZXN1bHRzIHx8IGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9BR0VOVF9QRVJNSVNTSU9OUywgewogICAgICBuZXh0VG9rZW46IHBhcmFtcy5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLm5leHRUb2tlbikgewogICAgICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudFBlcm1pc3Npb25zKGNvbmZpZ3VyYXRpb24sIHsKICAgICAgICAgICAgICBwZXJtaXNzaW9uczogKHBhcmFtcy5wZXJtaXNzaW9ucyB8fCBbXSkuY29uY2F0KGRhdGEucGVybWlzc2lvbnMpLAogICAgICAgICAgICAgIG5leHRUb2tlbjogZGF0YS5uZXh0VG9rZW4sCiAgICAgICAgICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgICAgICAgICAgfSk7CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uZmlndXJhdGlvbi5wZXJtaXNzaW9ucyA9IChwYXJhbXMucGVybWlzc2lvbnMgfHwgW10pLmNvbmNhdChkYXRhLnBlcm1pc3Npb25zKTsKICAgICAgICAgICAgc2VsZi51cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24oY29uZmlndXJhdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggYWdlbnQgcGVybWlzc2lvbnMgbGlzdC4iKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpLAogICAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKICAgICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yRGlhbGFibGVDb3VudHJ5Q29kZXMgPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgcGFyYW1zSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHBhcmFtcy5tYXhSZXN1bHRzID0gcGFyYW1zLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0RJQUxBQkxFX0NPVU5UUllfQ09ERVMsIHsKICAgICAgbmV4dFRva2VuOiBwYXJhbXMubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLm5leHRUb2tlbikgewogICAgICAgICAgICBzZWxmLnBvbGxGb3JEaWFsYWJsZUNvdW50cnlDb2Rlcyhjb25maWd1cmF0aW9uLCB7CiAgICAgICAgICAgICAgY291bnRyeUNvZGVzOiAocGFyYW1zLmNvdW50cnlDb2RlcyB8fCBbXSkuY29uY2F0KGRhdGEuY291bnRyeUNvZGVzKSwKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24uZGlhbGFibGVDb3VudHJpZXMgPSAocGFyYW1zLmNvdW50cnlDb2RlcyB8fCBbXSkuY29uY2F0KGRhdGEuY291bnRyeUNvZGVzKTsKICAgICAgICAgICAgc2VsZi51cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24oY29uZmlndXJhdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggZGlhbGFibGUgY291bnRyeSBjb2RlcyBsaXN0LiIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCksCiAgICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQogICAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JSb3V0aW5nUHJvZmlsZVF1ZXVlcyA9IGZ1bmN0aW9uIChjb25maWd1cmF0aW9uLCBwYXJhbXNJbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgcGFyYW1zLm1heFJlc3VsdHMgPSBwYXJhbXMubWF4UmVzdWx0cyB8fCBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfUk9VVElOR19QUk9GSUxFX1FVRVVFUywgewogICAgICByb3V0aW5nUHJvZmlsZUFSTjogY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5yb3V0aW5nUHJvZmlsZUFSTiwKICAgICAgbmV4dFRva2VuOiBwYXJhbXMubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLm5leHRUb2tlbikgewogICAgICAgICAgICBzZWxmLnBvbGxGb3JSb3V0aW5nUHJvZmlsZVF1ZXVlcyhjb25maWd1cmF0aW9uLCB7CiAgICAgICAgICAgICAgY291bnRyeUNvZGVzOiAocGFyYW1zLnF1ZXVlcyB8fCBbXSkuY29uY2F0KGRhdGEucXVldWVzKSwKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucXVldWVzID0gKHBhcmFtcy5xdWV1ZXMgfHwgW10pLmNvbmNhdChkYXRhLnF1ZXVlcyk7CiAgICAgICAgICAgIHNlbGYudXBkYXRlQWdlbnRDb25maWd1cmF0aW9uKGNvbmZpZ3VyYXRpb24pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIHJvdXRpbmcgcHJvZmlsZSBxdWV1ZXMgbGlzdC4iKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpLAogICAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKICAgICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVBUElSZXF1ZXN0ID0gZnVuY3Rpb24gKHBvcnRDb25kdWl0LCByZXF1ZXN0KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdGhpcy5jbGllbnQuY2FsbChyZXF1ZXN0Lm1ldGhvZCwgcmVxdWVzdC5wYXJhbXMsIHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICB2YXIgcmVzcG9uc2UgPSBjb25uZWN0LkV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZShjb25uZWN0LkV2ZW50VHlwZS5BUElfUkVTUE9OU0UsIHJlcXVlc3QsIGRhdGEpOwogICAgICAgIHBvcnRDb25kdWl0LnNlbmREb3duc3RyZWFtKHJlc3BvbnNlLmV2ZW50LCByZXNwb25zZSk7CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICB2YXIgcmVzcG9uc2UgPSBjb25uZWN0LkV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZShjb25uZWN0LkV2ZW50VHlwZS5BUElfUkVTUE9OU0UsIHJlcXVlc3QsIGRhdGEsIEpTT04uc3RyaW5naWZ5KGVycikpOwogICAgICAgIHBvcnRDb25kdWl0LnNlbmREb3duc3RyZWFtKHJlc3BvbnNlLmV2ZW50LCByZXNwb25zZSk7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiJyVzJyBBUEkgcmVxdWVzdCBmYWlsZWQiLCByZXF1ZXN0Lm1ldGhvZCkKICAgICAgICAgIC53aXRoT2JqZWN0KHsgcmVxdWVzdDogc2VsZi5maWx0ZXJBdXRoVG9rZW4ocmVxdWVzdCksIHJlc3BvbnNlOiByZXNwb25zZSB9KQogICAgICAgICAgLndpdGhFeGNlcHRpb24oZXJyKQogICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0sCiAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpCiAgICB9KTsKICB9OwoKICAvKioKICAgKiBIYW5kbGUgaW5jb21pbmcgbWFzdGVyIHF1ZXJ5IG9yIG1vZGlmaWNhdGlvbiByZXF1ZXN0cyBmcm9tIGNvbm5lY3RlZCB0YWIgcG9ydHMuCiAgICovCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVNYXN0ZXJSZXF1ZXN0ID0gZnVuY3Rpb24gKHBvcnRDb25kdWl0LCBwb3J0SWQsIHJlcXVlc3QpIHsKICAgIHZhciBtdWx0aXBsZXhlckNvbmR1aXQgPSB0aGlzLmNvbmR1aXQ7CiAgICB2YXIgcmVzcG9uc2UgPSBudWxsOwoKICAgIHN3aXRjaCAocmVxdWVzdC5tZXRob2QpIHsKICAgICAgY2FzZSBjb25uZWN0Lk1hc3Rlck1ldGhvZHMuQkVDT01FX01BU1RFUjoKICAgICAgICB2YXIgbWFzdGVySWQgPSB0aGlzLm1hc3RlckNvb3JkLmdldE1hc3RlcihyZXF1ZXN0LnBhcmFtcy50b3BpYyk7CiAgICAgICAgdmFyIHRha2VPdmVyID0gQm9vbGVhbihtYXN0ZXJJZCkgJiYgbWFzdGVySWQgIT09IHBvcnRJZDsKICAgICAgICB0aGlzLm1hc3RlckNvb3JkLnNldE1hc3RlcihyZXF1ZXN0LnBhcmFtcy50b3BpYywgcG9ydElkKTsKICAgICAgICByZXNwb25zZSA9IGNvbm5lY3QuRXZlbnRGYWN0b3J5LmNyZWF0ZVJlc3BvbnNlKGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVNQT05TRSwgcmVxdWVzdCwgewogICAgICAgICAgbWFzdGVySWQ6IHBvcnRJZCwKICAgICAgICAgIHRha2VPdmVyOiB0YWtlT3ZlciwKICAgICAgICAgIHRvcGljOiByZXF1ZXN0LnBhcmFtcy50b3BpYwogICAgICAgIH0pOwogICAgICAgIGlmICh0YWtlT3ZlcikgewogICAgICAgICAgbXVsdGlwbGV4ZXJDb25kdWl0LnNlbmREb3duc3RyZWFtKHJlc3BvbnNlLmV2ZW50LCByZXNwb25zZSk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSBjb25uZWN0Lk1hc3Rlck1ldGhvZHMuQ0hFQ0tfTUFTVEVSOgogICAgICAgIHZhciBtYXN0ZXJJZCA9IHRoaXMubWFzdGVyQ29vcmQuZ2V0TWFzdGVyKHJlcXVlc3QucGFyYW1zLnRvcGljKTsKICAgICAgICBpZiAoIW1hc3RlcklkICYmICFyZXF1ZXN0LnBhcmFtcy5zaG91bGROb3RCZWNvbWVNYXN0ZXJJZk5vbmUpIHsKICAgICAgICAgIHRoaXMubWFzdGVyQ29vcmQuc2V0TWFzdGVyKHJlcXVlc3QucGFyYW1zLnRvcGljLCBwb3J0SWQpOwogICAgICAgICAgbWFzdGVySWQgPSBwb3J0SWQ7CiAgICAgICAgfQogICAgICAgIHJlc3BvbnNlID0gY29ubmVjdC5FdmVudEZhY3RvcnkuY3JlYXRlUmVzcG9uc2UoY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFU1BPTlNFLCByZXF1ZXN0LCB7CiAgICAgICAgICBtYXN0ZXJJZDogbWFzdGVySWQsCiAgICAgICAgICBpc01hc3RlcjogcG9ydElkID09PSBtYXN0ZXJJZCwKICAgICAgICAgIHRvcGljOiByZXF1ZXN0LnBhcmFtcy50b3BpYwogICAgICAgIH0pOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gbWFzdGVyIG1ldGhvZDogIiArIHJlcXVlc3QubWV0aG9kKTsKICAgIH0KCiAgICBwb3J0Q29uZHVpdC5zZW5kRG93bnN0cmVhbShyZXNwb25zZS5ldmVudCwgcmVzcG9uc2UpOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUudXBkYXRlQWdlbnRDb25maWd1cmF0aW9uID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24pIHsKICAgIGlmIChjb25maWd1cmF0aW9uLnBlcm1pc3Npb25zICYmCiAgICAgIGNvbmZpZ3VyYXRpb24uZGlhbGFibGVDb3VudHJpZXMgJiYKICAgICAgY29uZmlndXJhdGlvbi5hZ2VudFN0YXRlcyAmJgogICAgICBjb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnF1ZXVlcykgewoKICAgICAgdGhpcy5hZ2VudCA9IHRoaXMuYWdlbnQgfHwge307CiAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247CiAgICAgIHRoaXMudXBkYXRlQWdlbnQoKTsKCiAgICB9IGVsc2UgewogICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJXYWl0aW5nIHRvIHVwZGF0ZSBhZ2VudCBjb25maWd1cmF0aW9uIHVudGlsIGFsbCBjb25maWcgZGF0YSBoYXMgYmVlbiBmZXRjaGVkLiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS51cGRhdGVBZ2VudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghdGhpcy5hZ2VudCkgewogICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJXYWl0aW5nIHRvIHVwZGF0ZSBhZ2VudCB1bnRpbCB0aGUgYWdlbnQgaGFzIGJlZW4gZnVsbHkgY29uc3RydWN0ZWQuIikKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICB9IGVsc2UgaWYgKCF0aGlzLmFnZW50LnNuYXBzaG90KSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIldhaXRpbmcgdG8gdXBkYXRlIGFnZW50IHVudGlsIHRoZSBhZ2VudCBzbmFwc2hvdCBpcyBhdmFpbGFibGUuIikKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICB9IGVsc2UgaWYgKCF0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24pIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiV2FpdGluZyB0byB1cGRhdGUgYWdlbnQgdW50aWwgdGhlIGFnZW50IGNvbmZpZ3VyYXRpb24gaXMgYXZhaWxhYmxlLiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgfSBlbHNlIHsKICAgICAgLy8gQWxpYXMgc29tZSBvZiB0aGUgcHJvcGVydGllcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCiAgICAgIHRoaXMuYWdlbnQuc25hcHNob3Quc3RhdHVzID0gdGhpcy5hZ2VudC5zdGF0ZTsKCiAgICAgIC8vIFNvcnQgdGhlIGNvbnRhY3RzIG9uIHRoZSB0aW1lc3RhbXAKICAgICAgaWYgKHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMgJiYgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cy5sZW5ndGggPiAxKSB7CiAgICAgICAgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cy5zb3J0KGZ1bmN0aW9uIChjb250YWN0QSwgY29udGFjdEIpIHsKICAgICAgICAgIHJldHVybiBjb250YWN0QS5zdGF0ZS50aW1lc3RhbXAuZ2V0VGltZSgpIC0gY29udGFjdEIuc3RhdGUudGltZXN0YW1wLmdldFRpbWUoKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cy5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgICAgY29udGFjdC5zdGF0dXMgPSBjb250YWN0LnN0YXRlOwoKICAgICAgICBjb250YWN0LmNvbm5lY3Rpb25zLmZvckVhY2goZnVuY3Rpb24gKGNvbm5lY3Rpb24pIHsKICAgICAgICAgIGNvbm5lY3Rpb24uYWRkcmVzcyA9IGNvbm5lY3Rpb24uZW5kcG9pbnQ7CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLmRlZmF1bHRPdXRib3VuZFF1ZXVlLnF1ZXVlSWQgPQogICAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5kZWZhdWx0T3V0Ym91bmRRdWV1ZS5xdWV1ZUFSTjsKICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnF1ZXVlcy5mb3JFYWNoKGZ1bmN0aW9uIChxdWV1ZSkgewogICAgICAgIHF1ZXVlLnF1ZXVlSWQgPSBxdWV1ZS5xdWV1ZUFSTjsKICAgICAgfSk7CiAgICAgIHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgIC8vY29udGFjdC5xdWV1ZSBpcyBudWxsIHdoZW4gbW9uaXRvcmluZwogICAgICAgIGlmIChjb250YWN0LnF1ZXVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGNvbnRhY3QucXVldWUucXVldWVJZCA9IGNvbnRhY3QucXVldWUucXVldWVBUk47CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnJvdXRpbmdQcm9maWxlSWQgPQogICAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5yb3V0aW5nUHJvZmlsZUFSTjsKICAgICAgCiAgICAgIGlmICh0aGlzLnN1cHByZXNzKSB7CiAgICAgICAgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cyA9IHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMuZmlsdGVyKGZ1bmN0aW9uKGNvbnRhY3QpewogICAgICAgICAgcmV0dXJuIChjb250YWN0LnN0YXRlLnR5cGUgPT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkhPTEQgfHwgY29udGFjdC5zdGF0ZS50eXBlID09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNURUQpOwogICAgICAgIH0pOwogICAgICAgIGlmICh0aGlzLmZvcmNlT2ZmbGluZSkgewogICAgICAgICAgdGhpcy5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GT1JDRV9PRkZMSU5FKTsKICAgICAgICB9CiAgICAgIH0gCiAgICAgIHRoaXMuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkFnZW50RXZlbnRzLlVQREFURSwgdGhpcy5hZ2VudCk7CiAgICB9CiAgfTsKCi8qKgogKiBQcm92aWRlcyBhIHdlYnNvY2tldCB1cmwgdGhyb3VnaCB0aGUgY3JlYXRlX3RyYW5zcG9ydCBBUEkuCiAqIEByZXR1cm5zIGEgcHJvbWlzZSB3aGljaCwgdXBvbiBzdWNjZXNzLCByZXR1cm5zIHRoZSByZXNwb25zZSBmcm9tIHRoZSBjcmVhdGVUcmFuc3BvcnQgQVBJLgogKi8KICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmdldFdlYlNvY2tldFVybCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgb25BdXRoRmFpbCA9IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCk7CiAgICB2YXIgb25BY2Nlc3NEZW5pZWQgPSBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfVFJBTlNQT1JULCB7IHRyYW5zcG9ydFR5cGU6IGNvbm5lY3QuVFJBTlNQT1JUX1RZUEVTLldFQl9TT0NLRVQgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImdldFdlYlNvY2tldFVybCBzdWNjZWVkZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldFdlYlNvY2tldFVybCBmYWlsZWQiKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgIHJlamVjdCh7CiAgICAgICAgICAgIHJlYXNvbjogJ2dldFdlYlNvY2tldFVybCBmYWlsZWQnLCAKICAgICAgICAgICAgX2RlYnVnOiBlcnIKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldFdlYlNvY2tldFVybCBBdXRoIEZhaWx1cmUiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJBdXRoZW50aWNhdGlvbiBmYWlsZWQgd2hpbGUgZ2V0dGluZyBnZXRXZWJTb2NrZXRVcmwiKSk7CiAgICAgICAgICBvbkF1dGhGYWlsKCk7CiAgICAgICAgfSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldFdlYlNvY2tldFVybCBBY2Nlc3MgRGVuaWVkIEZhaWx1cmUiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJBY2Nlc3MgRGVuaWVkIEZhaWx1cmUgd2hpbGUgZ2V0dGluZyBnZXRXZWJTb2NrZXRVcmwiKSk7CiAgICAgICAgICBvbkFjY2Vzc0RlbmllZCgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKCiAgLyoqCiAgICAqIFNlbmQgYSBtZXNzYWdlIGRvd25zdHJlYW0gdG8gYWxsIGNvbnN1bWVycyB3aGVuIHdlIGRldGVjdCB0aGF0IGF1dGhlbnRpY2F0aW9uCiAgICAqIGFnYWluc3Qgb25lIG9mIG91ciBBUElzIGhhcyBmYWlsZWQuCiAgICAqLwogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlU2VuZExvZ3NSZXF1ZXN0ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGxvZ0V2ZW50cyA9IFtdOwogICAgdmFyIGxvZ3NUb1NlbmQgPSBzZWxmLmxvZ3NCdWZmZXIuc2xpY2UoKTsKICAgIHNlbGYubG9nc0J1ZmZlciA9IFtdOwogICAgbG9nc1RvU2VuZC5mb3JFYWNoKGZ1bmN0aW9uIChsb2cpIHsKICAgICAgbG9nRXZlbnRzLnB1c2goewogICAgICAgIHRpbWVzdGFtcDogbG9nLnRpbWUsCiAgICAgICAgY29tcG9uZW50OiBsb2cuY29tcG9uZW50LAogICAgICAgIG1lc3NhZ2U6IGxvZy50ZXh0CiAgICAgIH0pOwogICAgfSk7CiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX0NMSUVOVF9MT0dTLCB7IGxvZ0V2ZW50czogbG9nRXZlbnRzIH0sIHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlNlbmRMb2dzIHJlcXVlc3Qgc3VjY2VlZGVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJTZW5kTG9ncyByZXF1ZXN0IGZhaWxlZC4iKQogICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkud2l0aEV4Y2VwdGlvbihlcnIpCiAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSwKICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCkKICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlQXV0aEZhaWwgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVVUSF9GQUlMKTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZUFjY2Vzc0RlbmllZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0NFU1NfREVOSUVEKTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmNoZWNrQXV0aFRva2VuID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGV4cGlyYXRpb25EYXRlID0gbmV3IERhdGUoc2VsZi5pbml0RGF0YS5hdXRoVG9rZW5FeHBpcmF0aW9uKTsKICAgIHZhciBjdXJyZW50VGltZVN0YW1wID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICB2YXIgdGhpcnR5TWlucyA9IDMwICogNjAgKiAxMDAwOwoKICAgIC8vIHJlZnJlc2ggdG9rZW4gMzAgbWludXRlcyBiZWZvcmUgZXhwaXJhdGlvbgogICAgaWYgKGV4cGlyYXRpb25EYXRlLmdldFRpbWUoKSA8IChjdXJyZW50VGltZVN0YW1wICsgdGhpcnR5TWlucykpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJBdXRoIHRva2VuIGV4cGlyZXMgYXQgIiArIGV4cGlyYXRpb25EYXRlICsgIiBTdGFydCByZWZyZXNoaW5nIHRva2VuIHdpdGggcmV0cnkuIikKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29ubmVjdC5iYWNrb2ZmKGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5hdXRob3JpemUpLCBSRUZSRVNIX0FVVEhfVE9LRU5fSU5URVJWQUxfTVMsIFJFRlJFU0hfQVVUSF9UT0tFTl9NQVhfVFJZKTsKICAgIH0KICB9OwoKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5hdXRob3JpemUgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBjb25uZWN0LmNvcmUuYXV0aG9yaXplKHRoaXMuaW5pdERhdGEuYXV0aG9yaXplRW5kcG9pbnQpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIHZhciBleHBpcmF0aW9uID0gbmV3IERhdGUocmVzcG9uc2UuZXhwaXJhdGlvbik7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQXV0aG9yaXphdGlvbiBzdWNjZWVkZWQgYW5kIHRoZSB0b2tlbiBleHBpcmVzIGF0ICVzIiwgZXhwaXJhdGlvbikKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgc2VsZi5pbml0RGF0YS5hdXRoVG9rZW4gPSByZXNwb25zZS5hY2Nlc3NUb2tlbjsKICAgICAgc2VsZi5pbml0RGF0YS5hdXRoVG9rZW5FeHBpcmF0aW9uID0gZXhwaXJhdGlvbjsKICAgICAgY29ubmVjdC5jb3JlLmluaXRDbGllbnQoc2VsZi5pbml0RGF0YSk7CiAgICAgIGNvbm5lY3QuY29yZS5pbml0QWdlbnRBcHBDbGllbnQoc2VsZi5pbml0RGF0YSk7CiAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKCk7CiAgICB9KS5jYXRjaChmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiQXV0aG9yaXphdGlvbiBmYWlsZWQgd2l0aCBjb2RlICVzIiwgcmVzcG9uc2Uuc3RhdHVzKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSA0MDEpIHsKICAgICAgICBzZWxmLmhhbmRsZUF1dGhGYWlsKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogRmlsdGVyIHRoZSAnYXV0aGVudGljYXRpb24nIGZpZWxkIG9mIHRoZSByZXF1ZXN0IHBhcmFtcyBmcm9tIHRoZSBnaXZlbiBBUElfUkVRVUVTVCBldmVudC4KICAgKi8KICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmZpbHRlckF1dGhUb2tlbiA9IGZ1bmN0aW9uIChyZXF1ZXN0KSB7CiAgICB2YXIgbmV3X3JlcXVlc3QgPSB7fTsKCiAgICBmb3IgKHZhciBrZXlBIGluIHJlcXVlc3QpIHsKICAgICAgaWYgKGtleUEgPT09ICdwYXJhbXMnKSB7CiAgICAgICAgdmFyIG5ld19wYXJhbXMgPSB7fTsKICAgICAgICBmb3IgKHZhciBrZXlCIGluIHJlcXVlc3QucGFyYW1zKSB7CiAgICAgICAgICBpZiAoa2V5QiAhPT0gJ2F1dGhlbnRpY2F0aW9uJykgewogICAgICAgICAgICBuZXdfcGFyYW1zW2tleUJdID0gcmVxdWVzdC5wYXJhbXNba2V5Ql07CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBuZXdfcmVxdWVzdC5wYXJhbXMgPSBuZXdfcGFyYW1zOwogICAgICB9IGVsc2UgewogICAgICAgIG5ld19yZXF1ZXN0W2tleUFdID0gcmVxdWVzdFtrZXlBXTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBuZXdfcmVxdWVzdDsKICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC53b3JrZXIubWFpbiA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3Qud29ya2VyLmNsaWVudEVuZ2luZSA9IG5ldyBDbGllbnRFbmdpbmUoKTsKICB9OwoKfSkoKTsKCi8qKiovIH0pCgovKioqKioqLyAJfSk7Ci8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCi8qKioqKiovIAkvLyBUaGUgbW9kdWxlIGNhY2hlCi8qKioqKiovIAl2YXIgX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fID0ge307Ci8qKioqKiovIAkKLyoqKioqKi8gCS8vIFRoZSByZXF1aXJlIGZ1bmN0aW9uCi8qKioqKiovIAlmdW5jdGlvbiBfX3dlYnBhY2tfcmVxdWlyZV9fKG1vZHVsZUlkKSB7Ci8qKioqKiovIAkJLy8gQ2hlY2sgaWYgbW9kdWxlIGlzIGluIGNhY2hlCi8qKioqKiovIAkJdmFyIGNhY2hlZE1vZHVsZSA9IF9fd2VicGFja19tb2R1bGVfY2FjaGVfX1ttb2R1bGVJZF07Ci8qKioqKiovIAkJaWYgKGNhY2hlZE1vZHVsZSAhPT0gdW5kZWZpbmVkKSB7Ci8qKioqKiovIAkJCXJldHVybiBjYWNoZWRNb2R1bGUuZXhwb3J0czsKLyoqKioqKi8gCQl9Ci8qKioqKiovIAkJLy8gQ3JlYXRlIGEgbmV3IG1vZHVsZSAoYW5kIHB1dCBpdCBpbnRvIHRoZSBjYWNoZSkKLyoqKioqKi8gCQl2YXIgbW9kdWxlID0gX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fW21vZHVsZUlkXSA9IHsKLyoqKioqKi8gCQkJLy8gbm8gbW9kdWxlLmlkIG5lZWRlZAovKioqKioqLyAJCQkvLyBubyBtb2R1bGUubG9hZGVkIG5lZWRlZAovKioqKioqLyAJCQlleHBvcnRzOiB7fQovKioqKioqLyAJCX07Ci8qKioqKiovIAkKLyoqKioqKi8gCQkvLyBFeGVjdXRlIHRoZSBtb2R1bGUgZnVuY3Rpb24KLyoqKioqKi8gCQlfX3dlYnBhY2tfbW9kdWxlc19fW21vZHVsZUlkXShtb2R1bGUsIG1vZHVsZS5leHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKTsKLyoqKioqKi8gCQovKioqKioqLyAJCS8vIFJldHVybiB0aGUgZXhwb3J0cyBvZiB0aGUgbW9kdWxlCi8qKioqKiovIAkJcmV0dXJuIG1vZHVsZS5leHBvcnRzOwovKioqKioqLyAJfQovKioqKioqLyAJCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCi8qKioqKiovIAkvKiB3ZWJwYWNrL3J1bnRpbWUvZ2xvYmFsICovCi8qKioqKiovIAkoKCkgPT4gewovKioqKioqLyAJCV9fd2VicGFja19yZXF1aXJlX18uZyA9IChmdW5jdGlvbigpIHsKLyoqKioqKi8gCQkJaWYgKHR5cGVvZiBnbG9iYWxUaGlzID09PSAnb2JqZWN0JykgcmV0dXJuIGdsb2JhbFRoaXM7Ci8qKioqKiovIAkJCXRyeSB7Ci8qKioqKiovIAkJCQlyZXR1cm4gdGhpcyB8fCBuZXcgRnVuY3Rpb24oJ3JldHVybiB0aGlzJykoKTsKLyoqKioqKi8gCQkJfSBjYXRjaCAoZSkgewovKioqKioqLyAJCQkJaWYgKHR5cGVvZiB3aW5kb3cgPT09ICdvYmplY3QnKSByZXR1cm4gd2luZG93OwovKioqKioqLyAJCQl9Ci8qKioqKiovIAkJfSkoKTsKLyoqKioqKi8gCX0pKCk7Ci8qKioqKiovIAkKLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KLyoqKioqKi8gCQovKioqKioqLyAJLy8gc3RhcnR1cAovKioqKioqLyAJLy8gTG9hZCBlbnRyeSBtb2R1bGUgYW5kIHJldHVybiBleHBvcnRzCi8qKioqKiovIAkvLyBUaGlzIGVudHJ5IG1vZHVsZSB1c2VkICdtb2R1bGUnIHNvIGl0IGNhbid0IGJlIGlubGluZWQKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oODI3KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oOTQ0KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oMTUxKTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oODkxKTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oNTkyKTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oODIpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg3NTQpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg4MzMpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg5NjUpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXygyODYpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg4OTUpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg3NDMpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg2NDIpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg3MzYpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg0MzkpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXygyNzkpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg0MTgpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXygxODcpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg4MjEpOwovKioqKioqLyAJdmFyIF9fd2VicGFja19leHBvcnRzX18gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUwMCk7Ci8qKioqKiovIAkKLyoqKioqKi8gfSkoKQo7"),C=function(I){this.region=I.region,this.id=this.region.replace(/-/g,"_"),this.height=I.height,this.style=I.iframe_style,this.ccp=this._createFramedCcp(JSON.stringify(I))};C.prototype._createFramedCcp=function(I){var g=g||"microphone; autoplay",C=this.style||"margin: 0; border: 0; padding: 0px; width: 0px; height: 0px",A=document.createElement("iframe");return A.srcdoc=this.getContent(I),A.allow=g,A.id=this.id,A.style=C,A.scrolling="no",A},C.prototype.getContent=function(I){return["<!DOCTYPE html>","<meta charset='UTF-8'>","<html>","<head>","<script type='text/javascript'>",g,"<\/script>","</head>","<body onload='init()'>","<div id=containerDiv style='width: 100%;height: "+this.height+"'></div>","<script type='text/javascript'>","function init() {","connect.core.initCCP(containerDiv,"+I+");","}","<\/script>","</body>","</html>"].join("")},globalConnect.Container=C}(),function(){var I=this;connect=I.connect||{},globalConnect=I.globalConnect||{},I.connect=connect,I.globalConnect=globalConnect,I.lily=connect,connect.core={},globalConnect.core={regions:{}};var g="465px",C=!0,A=function(I){var g=window.getComputedStyle(I);return{height:g.getPropertyValue("height"),width:g.getPropertyValue("width"),display:g.getPropertyValue("display")}},Z=function(I,g){if(connect.assertTrue("string"==typeof I,"Region provided "+I+" is not a valid string"),!(g||globalConnect.core.regions).hasOwnProperty(I)){var C="Region provided "+I+" is not found!";throw new connect.ValueError(C)}};globalConnect.core.initCCP=function(I,G){connect.assertNotNull(G.getPrimaryRegion,"getPrimaryRegion"),connect.assertTrue(connect.isFunction(G.getPrimaryRegion),"getPrimaryRegion must be a function");var d=G.getPrimaryRegion;delete G.getPrimaryRegion;var c=function(I,Z){connect.assertNotNull(Z.standByRegion,"ccpBackupResource"),connect.assertNotNull(Z.standByRegion.ccpUrl,"ccpUrl"),connect.assertNotNull(Z.standByRegion.loginUrl,"loginUrl"),connect.assertNotNull(Z.standByRegion.region,"region");var l=Z,b=Object.assign({},Z,{ccpUrl:Z.standByRegion.ccpUrl,loginUrl:Z.standByRegion.loginUrl,region:Z.standByRegion.region}),G=A(I);return"none"==G.display&&(C=!1),parseInt(G.height)<=0&&(I.style.height=g,G.height=g),[l,b].map((function(I){return connect.assertNotNull(I.ccpUrl,"ccpUrl"),connect.assertNotNull(I.loginUrl,"loginUrl"),connect.assertNotNull(I.region,"region"),delete I.standByRegion,I.loginPopup=!1,I.disasterRecoveryOn=!0,I.iframe_style="margin: 0; border: 0; padding:0px;width: 0px;height: 0px",I.height=G.height,I}))}(I,G);d((function(g){return new Promise((A=>{var G=c.reduce((function(I,g){return I[g.region]=null,I}),{});Z(g,G);var d=c.map((function(I){return I.region===g&&(I.isPrimary=!0),new globalConnect.Container(I)})),V=d.map((function(I){return I.ccp.outerHTML})),W=document.createElement("iframe");W.style="margin: 0; border: 0; padding:0px;width: 100%;height: 100%",W.id="globalCCP",W.scrolling="no",W.onload=function(){if(C){var I=Object.keys(G).find((function(I){return I!=g}));b(g,W.id),l(I,W.id)}d.map((function(A){globalConnect.core.regions[A.region]=W.contentDocument.getElementById(A.id).contentWindow.connect;var Z=globalConnect.core.regions[A.region];Z.core.getUpstream().onUpstream(Z.DisasterRecoveryEvents.FAILOVER,(function(A){A.isPrimary?(connect=Z,g=connect.core.region,C&&b(g,W.id)):C&&(I=Z.core.region,l(I,W.id))}))})),connect=globalConnect.core.regions[g],A()},W.srcdoc=V.join(""),I.appendChild(W)}))}),(function(I){console.error("[Disaster Recovery] An error occured, while attempting to retrieve your primary region;"),I()}))};var l=function(I,g){I=I.replace(/-/g,"_"),document.getElementById(g).contentDocument.getElementById(I).style="height: 0; width: 0; border: 0px"},b=function(I,g){I=I.replace(/-/g,"_"),document.getElementById(g).contentDocument.getElementById(I).style="height:800px;width:100%;border:0px"},G=function(I){return I=I||connect.core.region,Object.keys(globalConnect.core.regions).find((function(g){return g!==I}))};globalConnect.core.failover=function(){globalConnect.core.failoverTo(G())},globalConnect.core.failoverTo=function(I){Z(I);var g=G(I);d(g),c(I),connect=globalConnect.core.regions[I]};var d=function(I){var g=globalConnect.core.regions[I];g.getLog().info("[Disaster Recovery] Deactivating %s region.",g.core.region).sendInternalLogToServer(),g.core.suppressContacts(!0),g.core.forceOffline()},c=function(I){var g=globalConnect.core.regions[I];g.getLog().info("[Disaster Recovery] Activating %s region.",g.core.region).sendInternalLogToServer(),g.core.suppressContacts(!1)};connect.core.initCCP=globalConnect.core.initCCP}();